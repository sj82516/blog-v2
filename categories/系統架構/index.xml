<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ç³»çµ±æ¶æ§‹ on Yuanchieh</title><link>https://yuanchieh.page/categories/%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B/</link><description>Recent content in ç³»çµ±æ¶æ§‹ on Yuanchieh</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Tue, 03 Nov 2020 08:21:40 +0000</lastBuildDate><atom:link href="https://yuanchieh.page/categories/%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B/index.xml" rel="self" type="application/rss+xml"/><item><title>Raft æ¼”ç®—æ³•ä»‹ç´¹èˆ‡ã€ŠIn Search of an Understandable Consensus Algorithmã€‹æ‘˜è¦</title><link>https://yuanchieh.page/posts/2020/2020-11-03-raft-%E6%BC%94%E7%AE%97%E6%B3%95%E4%BB%8B%E7%B4%B9%E8%88%87in-search-of-an-understandable-consensus-algorithm%E6%91%98%E8%A6%81/</link><pubDate>Tue, 03 Nov 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-11-03-raft-%E6%BC%94%E7%AE%97%E6%B3%95%E4%BB%8B%E7%B4%B9%E8%88%87in-search-of-an-understandable-consensus-algorithm%E6%91%98%E8%A6%81/</guid><description>&lt;p>å…±è­˜æ¼”ç®—æ³•ä¸»è¦æ‡‰ç”¨æ–¼åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œä¸€å€‹é›†ç¾¤ä¸­æœ‰å¤šå€‹ç¯€é»çµ„æˆï¼Œè®“æ¯å€‹ç¯€é»éƒ½ç¶­è­·ç›¸åŒçš„ç‹€æ…‹ï¼Œä¾‹å¦‚èªªåœ¨å¤šç¨®ç³»çµ±ä¸­éƒ½éœ€è¦é›†ç¾¤æœ‰å–®ä¸€å€‹ Leader å­˜åœ¨ï¼Œæ‰€æœ‰ç¯€é»éƒ½å¿…é ˆæ‰¿èªé€™ä¸€å€‹ Leaderï¼Œå¦å‰‡å¤šå€‹ Leader å¯èƒ½æœƒå°è‡´ Split brain ç­‰è³‡æ–™ä¸ä¸€è‡´ç­‰å•é¡Œï¼›&lt;br>
ä½†å¦‚ä½•è®“ç¯€é»ç‹€æ…‹ä¸€è‡´æ˜¯ä¸€ä»¶ä¸ç°¡å–®çš„äº‹æƒ…ï¼Œè¦è€ƒæ…®åˆ°ç¯€é»å¯èƒ½å¤±æ•— / ç¶²è·¯å°åŒ…å»¶é²ç­‰ç­‰&lt;/p>
&lt;p>Raft æ¼”ç®—æ³•æ˜¯ç”±å²ä¸¹ä½›å¤§å­¸çš„æ•™æˆæ‰€æå‡ºï¼Œä»–åœ¨å½±ç‰‡ä¸­æåˆ°éå¾€çš„å…±è­˜æ¼”ç®—æ³• Paxos éæ–¼è¤‡é›œï¼Œä¸–ç•Œä¸ŠçœŸæ­£äº†è§£çš„äººæ²’æœ‰å¹¾å€‹ï¼Œå¸‚é¢ä¸Šçš„å¯¦ä½œä¹Ÿåˆ†æ­§å‡ºéå¸¸å¤šçš„å¯¦ä½œç‰ˆæœ¬ï¼Œç†è«–å¤ªéè‰±æ·±å°è‡´å¯¦å‹™ä¸Šæœ‰å¾ˆå¤§çš„è½å·®&lt;/p>
&lt;p>æ‰€ä»¥ä»–åœ¨è¨­è¨ˆ Raft çš„ä¸€å€‹æ ¸å¿ƒç†å¿µæ˜¯&lt;code>å¥½æ‡‚&lt;/code>ï¼Œä»–åœ¨ Conference ä¸Šä¹Ÿåƒ…ç”¨ç´„ 10 åˆ†é˜å°±å¤§è‡´ä»‹ç´¹å®Œ Raft çš„åŸç†ï¼Œæ•´ä»½è«–æ–‡ä¹Ÿæ‰ 16 é &lt;/p>
&lt;p>ä»¥ä¸‹å°‡æ•´ç†å½±ç‰‡ä»‹ç´¹èˆ‡è«–æ–‡æ‘˜è¦ï¼Œæ¢è¨ Raft å¦‚ä½•åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­è®“&lt;code>å¤šç¯€é»åœ¨å®¹å¿éŒ¯èª¤ä¸‹é”åˆ°å¼·ä¸€è‡´æ€§&lt;/code>&lt;/p>
&lt;h2 id="å½±ç‰‡ä»‹ç´¹">å½±ç‰‡ä»‹ç´¹&lt;/h2>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/no5Im1daS-o"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>å…ˆå¾åœ¨ Conf ä¸Šçš„ä»‹ç´¹å½±ç‰‡å¿«é€Ÿç†è§£ï¼ŒRaft ç”±ä¸‰å€‹éƒ¨åˆ†çµ„æˆ&lt;/p>
&lt;ol>
&lt;li>&lt;code>Leader Election&lt;/code>:&lt;br>
æ•´å€‹é›†ç¾¤ä¸­ç¥¨é¸å‡ºä¸€ä½ Leader&lt;/li>
&lt;li>&lt;code>Log Replication&lt;/code>:&lt;br>
Leader è² è²¬æ¥æ”¶ Client çš„æŒ‡ä»¤ï¼Œä¸¦æŠŠç‹€æ…‹åŒæ­¥åˆ°å¤šæ•¸ç¯€é»ä¸Š&lt;/li>
&lt;li>&lt;code>Safety&lt;/code>:&lt;br>
ç•¶ Leader è¦é‡æ–°ç¥¨é¸æ™‚ï¼Œç¢ºä¿æ“æœ‰æœ€æ–°è³‡æ–™çš„ç¯€é»æ‰èƒ½ç•¶ä¸Š Leaderï¼Œé¿å…ç¢ºèªé(commited)çš„è³‡æ–™è¢«å–æ¶ˆ&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹å°‡æ‘˜è¦è«–æ–‡ &lt;a class="link" href="https://raft.github.io/raft.pdf" target="_blank" rel="noopener"
>ã€ŠIn Search of an Understandable Consensus Algorithm (Extended Version)ã€‹&lt;/a>éƒ¨åˆ†å…§å®¹&lt;/p>
&lt;h1 id="è«–æ–‡æ‘˜è¦">è«–æ–‡æ‘˜è¦&lt;/h1>
&lt;p>Raft æ˜¯ä¸€ç¨®ç”¨æ–¼ç®¡ç†å‰¯æœ¬ç´€éŒ„çš„å…±è­˜æ¼”ç®—æ³•ï¼Œæ•ˆæœé¡ä¼¼æ–¼ Paxosï¼Œä½†çµæ§‹ä¸Šå®Œå…¨ä¸åŒï¼Œé€™ä¹Ÿä½¿å¾— Raft ç›¸è¼ƒæ–¼ Paxos æ›´å®¹æ˜“äº†è§£&lt;br>
ç‚ºäº†å¢åŠ å¯è®€æ€§ï¼ŒRaft è§£æ§‹å‡ºå¹¾å€‹å…±è­˜æ¼”ç®—æ³•ä¸­é—œéµçš„å…ƒç´ ï¼Œåƒæ˜¯ Leader Election / Log replication / Safetyï¼Œä¸¦é€éæ¸›å°‘ç‹€æ…‹é”åˆ°æ›´å¼·çš„å‡èšæ€§ (æ„æŒ‡ç¯€é»å¯ä»¥è®ŠåŒ–çš„ç‹€æ…‹å°‘ï¼Œå°±æ›´å®¹æ˜“é”åˆ°ä¸€è‡´)&lt;/p>
&lt;h2 id="1-introduction">1. Introduction&lt;/h2>
&lt;p>å…±è­˜æ¼”ç®—æ³• (Consensus) æä¾›ç”±æ©Ÿå™¨çµ„æˆçš„é›†åˆå¯ä»¥é‹ä½œé¡ä¼¼åŒä¸€é«”ä¸¦èƒ½å¤ å®¹å¿éƒ¨åˆ†æˆå“¡å‡ºéŒ¯ï¼Œä¹Ÿé€™æ˜¯é€™äº›ç‰¹æ€§ï¼Œå…±è­˜æ¼”ç®—æ³•åœ¨å»ºæ§‹å¤§å‹è»Ÿé«”ç³»çµ±æ˜¯å¾ˆé—œéµçš„è§’è‰²&lt;/p>
&lt;p>Paxos ä¸»å®°é€™ä¸€å¡Šè¿‘åå¹´ï¼Œä½†ä¸å¹¸çš„æ˜¯ Paxos å¾ˆé›£æ‡‚ï¼ŒåŒæ™‚åœ¨å¯¦å‹™ä¸Šéœ€è¦æœ‰å¾ˆè² è²¬çš„è¨­è¨ˆæ‰èƒ½å¤ ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸è«–æ˜¯å­¸ç”Ÿé‚„æ˜¯ç³»çµ±å·¥ç¨‹å¸«éƒ½ååˆ†å›°æ“¾&lt;/p>
&lt;p>æ‰€ä»¥ä½œè€…é–‹å§‹æƒ³è¦è¨­è¨ˆä¸€é–€è¶³å¤ å¥½ç†è§£ã€åŒæ™‚å°æ–¼ç³»çµ±å·¥ç¨‹å¸«ä¹Ÿå®¹æ˜“å¯¦è¸çš„å…±è­˜æ¼”ç®—æ³•&lt;/p>
&lt;blockquote>
&lt;p>our primary goal was &lt;code>understandability&lt;/code>: could we define a consensus algorithm for
practical systems and describe it in a way that is significantly easier to learn than Paxos&lt;/p>
&lt;/blockquote>
&lt;p>é€éè§£æ§‹å‡ºç¨ä»¶ä»¥åŠæ¸›å°‘æ©Ÿå™¨åœ¨ä¸ä¸€è‡´ç‹€æ…‹çš„å¯èƒ½æ€§ï¼Œè®“æ•´å€‹æ¼”ç®—æ³•æ›´å®¹æ˜“ç†è§£&lt;/p>
&lt;p>Raft æœ‰ä»¥ä¸‹å¹¾å€‹ç‰¹é»&lt;/p>
&lt;ol>
&lt;li>Strong Leader:&lt;br>
Log çš„å¯«å…¥å¿…é ˆç¶“ç”± Leader å†åˆ°å…¶ä»–ç¯€é»ä¸Šï¼Œé€™æ¨£å¯ä»¥ç°¡åŒ–å¾ˆå¤šä¸å¿…è¦çš„è¤‡é›œæ€§&lt;/li>
&lt;li>Leader Election:&lt;br>
åœ¨é¸èˆ‰æ™‚ï¼ŒRaft åˆ©ç”¨éš¨æ©Ÿå»¶é²(randomized timers)æ–¹å¼å¿«é€Ÿä¸”æœ‰æ•ˆè§£æ±ºå¯èƒ½çš„è¡çª (é¿å…å¤§å®¶åœ¨åŒä¸€å€‹æ™‚åˆ»æƒ³è¦è®Šæˆ Leader)&lt;/li>
&lt;li>èº«ä»½æ”¹è®Š&lt;br>
åœ¨æ”¹è®Šç¯€é»çš„è¨­å®šæª”æ™‚ï¼Œå¯ä»¥å°‡å‰å¾Œå…©ç¨®è¨­å®šæª”ä»¥è¯é›†æ–¹å¼åˆä½µ(joint consensus)ï¼Œåœ¨æ›´æ”¹è¨­å®šåŒæ™‚é‚„èƒ½ç¶­æŒæœå‹™&lt;/li>
&lt;/ol>
&lt;p>ä½œè€…èªç‚º Raft æ˜¯å€‹å„ªç•°çš„å…±è­˜æ¼”ç®—æ³•ï¼Œå°±è®“æˆ‘å€‘ç¹¼çºŒå¾€ä¸‹çœ‹&lt;/p>
&lt;h2 id="2-replicated-state-machines">2. Replicated state machines&lt;/h2>
&lt;p>Replicated state machines æ˜¯æŒ‡ä¸€ç¾¤æ©Ÿå™¨çš„é›†åˆï¼Œå¯ä»¥é‹ç®—å‡ºç›¸åŒçš„ç‹€æ…‹ï¼Œä¸¦åœ¨å°‘æ•¸ç¯€é»å¤±æ•—æ™‚é‚„èƒ½æ­£å¸¸é‹è¡Œï¼Œä¸»è¦ç”¨ä¾†è§£æ±ºåˆ†æ•£å¼ç³»çµ±ä¸­å„ç¨®éŒ¯èª¤å®¹å¿æ€§çš„å•é¡Œï¼Œä¾‹å¦‚ GFS / HDFS / RAMCloudï¼Œåœ¨é€™äº›ç³»çµ±ä¸­æœ‰ç¨ç«‹çš„ Replicated state machine æŒç®¡ Leader Election / ä¿å­˜ Configï¼Œåœ¨ Leader crash æƒ…æ³ä¸‹é‚„èƒ½ç¹¼çºŒé‹ä½œï¼›
Replicated state machine çš„å¯¦éš›æ¡ˆä¾‹æœ‰ Chubby / ZooKeeper&lt;/p>
&lt;p>Replicated state machine é€šå¸¸æ˜¯ç”±è¤‡è£½ Log æ‰€å¯¦è¸ï¼Œå¦‚ä¸‹åœ–ï¼Œæ¯å€‹ Server éƒ½æœ‰ä¸€ä»½ logï¼Œä¾ç…§ç›¸åŒé †åºç´€éŒ„è‘—ç›¸åŒçš„æŒ‡ä»¤ï¼Œé‹ç®—æ•´ä»½ log å°±èƒ½å¾—åˆ°ç›¸åŒçš„ç‹€æ…‹æ©Ÿ (state machine)&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201103/stateMachine.png"
loading="lazy"
alt="stateMachine"
>&lt;/p>
&lt;p>å¾ client æ”¶åˆ°æŒ‡ä»¤å¾Œï¼Œ&lt;code>å¦‚ä½•ä¿æŒé †åºè¤‡è£½ç›¸åŒçš„æŒ‡ä»¤åˆ°æ¯å°æ©Ÿå™¨ä¸Šï¼Œå°±æ˜¯å…±è­˜æ¼”ç®—æ³•çš„ä»»å‹™&lt;/code>ï¼Œå…±è­˜æ¼”ç®—æ³•å…·é«”æä¾›ä¸‹åˆ—ä¿è­‰&lt;/p>
&lt;ol>
&lt;li>Safety:&lt;br>
åœ¨éæ‹œå åº­æƒ…æ³ä¸‹ï¼Œç³»çµ±å³ä½¿é­é‡ç¶²è·¯å»¶é²ã€ç¶²è·¯åˆ†éš” (partition)ã€å°åŒ…éºå¤±ã€æŒ‡ä»¤é‡è¤‡ç™¼é€ã€ç™¼é€é †åºæ”¹è®Šç­‰å•é¡Œï¼Œéƒ½ä¸å½±éŸ¿çµæœ&lt;/li>
&lt;li>åªè¦å¤šæ•¸ç¯€é»å­˜æ´»å°±èƒ½å¤ æ­£å¸¸é‹è¡Œï¼Œä¾‹å¦‚ 5 å€‹ç¯€é» 3 å€‹é‚„æ´»è‘—å°±å¯ä»¥ï¼Œä¸¦ä¸”å¤±æ•—çš„ç¯€é»å¯ä»¥åœ¨å¾Œé¢é‡æ–°åŠ å›é›†ç¾¤ä¸­&lt;/li>
&lt;li>ä¸ä¾è³´æ™‚é–“ç•¶ä½œåˆ¤æ–·ï¼Œåœ¨åˆ†æ•£å¼ç³»çµ±ä¸­æ™‚é–“æ˜¯ä¸å¯ä¿¡çš„(é™¤éå­¸ Google ç”¨åŸå­é˜è‡ªå¹¹å‡º &lt;a class="link" href="https://cloud.google.com/spanner/docs/true-time-external-consistency" target="_blank" rel="noopener"
>TrueTime&lt;/a> )ï¼Œæ¯å€‹ç³»çµ±éƒ½å­˜åœ¨è‘—æ™‚é˜æ²’å°é½Šçš„å¯èƒ½&lt;/li>
&lt;li>å¤šæ•¸ç¯€é»æœ‰å›æ‡‰æ”¶åˆ°å‰¯æœ¬å°±ç®—æˆåŠŸï¼Œå°‘æ•¸ç¯€é»æ™šå›è¦†ä¸æœƒé€ æˆæ€§èƒ½å½±éŸ¿&lt;/li>
&lt;/ol>
&lt;h2 id="3-whats-wrong-with-paxos">3. Whatâ€™s wrong with Paxos?&lt;/h2>
&lt;p>é€™ä¸€ç« ç¯€ä¸»è¦åœ¨æç¹ª Paxos çš„èƒŒæ™¯èˆ‡æœ‰å¤šé›£ç†è§£çš„åŸå› ï¼Œä½†å› ç‚ºä¹‹å‰æ²’æœ‰å­¸é Paxosï¼Œå°±å…ˆç•¥éé€™ç« &lt;/p>
&lt;h2 id="4-designing-for-understandability">4. Designing for understandability&lt;/h2>
&lt;p>é€™ä¸€ç« ç¯€ä¸»è¦æ˜¯ä½œè€…ä¸æ–·å¼·èª¿ &lt;code>understandability&lt;/code> æ˜¯ä»–å€‘çš„æ ¸å¿ƒç†å¿µï¼Œç•¶é‡åˆ°è¨­è¨ˆæœ‰å¤šç¨®æ–¹æ¡ˆé¸æ“‡æ™‚ï¼Œä»–å€‘æœƒé¸æ“‡æœ€å¥½è§£é‡‹çµ¦åˆ¥äººè½çš„é‚£ä¸€å€‹ï¼Œå°æ–¼ä»–å€‘ä¾†èªªå¯è®€æ€§æ˜¯æ ¸å¿ƒç†å¿µ&lt;/p>
&lt;p>å…·é«”ä¸Šï¼Œé€é &lt;code>decomposition æ‹†åˆ†ç¨ç«‹æ¨¡çµ„&lt;/code>ä»¥åŠ&lt;code>æ¸›å°‘ä¸ç¢ºå®šæ€§èˆ‡ç‹€æ…‹å¯èƒ½æ€§&lt;/code> é”æˆç›®çš„ï¼Œä½†åœ¨æŸä¸€äº›éƒ¨åˆ†é‚„æ˜¯æœ‰ç”¨ä¸Šéš¨æ©Ÿæ€§ï¼Œå› ç‚ºé€™è®“æ¼”ç®—æ³•æ›´å¥½ç†è§£&lt;/p>
&lt;h2 id="5-the-raft-consensus-algorithm">5. The Raft consensus algorithm&lt;/h2>
&lt;p>Raft åœ¨å¯¦ä½œä¸Šæœƒå…ˆé¸å‡ºä¸€å Leader ï¼Œç”± Leader ç®¡ç† log çš„è¤‡è£½åˆ°å…¶ä»–ç¯€é»çš„ç‹€æ…‹æ©Ÿä¸Šï¼Œé€é Leader çš„å¥½è™•æ˜¯ä¸éœ€è¦å…¶ä»–ç¯€é»åŒæ„ Leader èƒ½ç¨è‡ªæ±ºå®šæ–°çš„ log è¦å„²æ”¾çš„ä½ç½®ï¼›&lt;br>
å¦‚æœ Leader å¤±æ•—äº†å¯ä»¥å†é¸æ–°çš„ Leader å‡ºä¾†&lt;/p>
&lt;h3 id="51-raft-basics">5.1 Raft basics&lt;/h3>
&lt;p>é€šå¸¸ Raft é›†ç¾¤æœƒç”±äº”å€‹ç¯€é»çµ„æˆï¼Œå¯ä»¥å®¹å¿å…©å€‹ç¯€é»å¤±æ•—ï¼Œè€Œæ¯å€‹ç¯€é»æœ‰ä¸‰ç¨®ç‹€æ…‹ &lt;code>leader / follower / candidate&lt;/code>ï¼Œé€šå¸¸æƒ…æ³ä¸‹æ˜¯ä¸€å€‹ leader å…¶ä»–äººéƒ½æ˜¯ follower&lt;/p>
&lt;ol>
&lt;li>follower: è¢«å‹•çš„è™•ç†ä¾†è‡ª leader æˆ– candidate çš„è«‹æ±‚&lt;/li>
&lt;li>leader: è² è²¬æ‰€æœ‰ client çš„ requestï¼Œä¸¦è¤‡è£½æŒ‡ä»¤åˆ° follower ä¸­&lt;/li>
&lt;li>candidate: follower ç™¼ç¾æ²’æœ‰ leaderï¼Œè¨­ä¸€å€‹éš¨æ©Ÿ timeout åˆ‡æ›æˆ candidate æ¨¡å¼ï¼Œæº–å‚™è¦é¸æ–° leader&lt;/li>
&lt;/ol>
&lt;p>ä¸‹åœ–ç‚ºç‹€æ…‹æ©Ÿç¤ºæ„åœ–
&lt;img src="https://yuanchieh.page/post/img/20201103/state.png"
loading="lazy"
alt="state-machine"
>&lt;/p>
&lt;p>Raft å°‡æ™‚é–“åˆ‡å‰²æˆ &lt;code>å›åˆ (term)&lt;/code>ï¼Œæ¯ä¸€å€‹å›åˆä»£è¡¨è‘—ä¸€æ¬¡çš„é¸èˆ‰ï¼Œä¹Ÿå°±æ˜¯ candidate å»ç«¶é¸ leader çš„éç¨‹ï¼Œå¦‚æœæˆåŠŸæ¨é¸å‡º leader å¾Œï¼Œå‰‡æ¯å€‹ç¯€é»ç´€éŒ„é€™ä¸€å€‹å›åˆæ•¸ï¼›å¦‚æœé¸èˆ‰å¤±æ•—ï¼Œå‰‡é–‹å•Ÿæ–°çš„å›åˆç›´åˆ°æœ‰äººæˆç‚º leader&lt;/p>
&lt;p>ä»¥ä¸‹ç‚ºæ¦‚å¿µåœ–
&lt;img src="https://yuanchieh.page/post/img/20201103/term.png"
loading="lazy"
alt="term"
>&lt;/p>
&lt;p>å›åˆæœ¬èº«æ˜¯ä¸€å€‹éå¢æ•¸å€¼ï¼Œç”¨ä¾†è¡¨ç¤ºé‚è¼¯ä¸Šçš„æ™‚é–“æ¦‚å¿µï¼Œæœ‰å¯èƒ½ç¯€é»è§€å¯Ÿåˆ°çš„å›åˆè·Ÿå…¶ä»–ç¯€é»ä¸åŒï¼Œå¦‚æœå›åˆæ•¸å°å‰‡ä»£è¡¨è‡ªèº«çš„è³‡æ–™éæ™‚ï¼Œä»–å¿…é ˆæ›´æ–°è‡ªå·±çš„å›åˆæ•¸ï¼›&lt;br>
ä¾‹å¦‚èªªåŸæœ¬çš„ leader å¯èƒ½æ–·ç·šï¼Œå…¶ä»–ç¯€é»æ¨é¸å‡ºæ–°çš„ leader å‰‡æœƒé€²åˆ°ä¸‹ä¸€å€‹å›åˆæ•¸ï¼Œ&lt;code>åŸæœ¬çš„ leader å›æ­¸å¾Œç™¼ç¾è‡ªå·±çš„å›åˆæ•¸æ¯”è¼ƒå°ï¼Œå‰‡æœƒä¸»å‹•è®Šæˆ follower&lt;/code>ï¼›&lt;br>
å¦‚æœç¯€é»æ”¶åˆ°è«‹æ±‚æ™‚ï¼Œç™¼ç¾å›åˆæ•¸æ¯”è‡ªå·±å°ï¼Œå‰‡ä»£è¡¨è«‹æ±‚éæœŸï¼Œç›´æ¥æ‹‹æ£„è©²è«‹æ±‚&lt;/p>
&lt;h3 id="52-leader-election">5.2 Leader election&lt;/h3>
&lt;p>Raft é€é &lt;code>heartbeat&lt;/code> è§¸ç™¼ leader é¸èˆ‰ï¼Œç•¶ leader é¸ä¸Šæ™‚ï¼Œæœƒåœ¨å›ºå®šæ™‚é–“å…§ç™¼&lt;code>å…§å®¹ç‚ºç©ºçš„ AppendEntries RPC ç•¶ä½œå¿ƒè·³åŒ…&lt;/code>ï¼Œå¦‚æœ follower è¶…é election timeout æ²’æœ‰æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œå‰‡é€²å…¥é¸èˆ‰éšæ®µ&lt;/p>
&lt;p>folower æœƒå°‡ç¾ä»Šçš„å›åˆæ•¸åŠ ä¸€ä¾¿è½‰ç‚º candidateï¼Œä¸¦è«‹æ±‚å…¶ä»– follower æŠ•ç¥¨çµ¦ä»– &lt;code>RequestVote RPC&lt;/code>ï¼Œé‡åˆ°ä»¥ä¸‹æƒ…æ³ candidate æ‰æœƒæ”¹è®Šç‹€æ…‹&lt;/p>
&lt;ol>
&lt;li>è´å¾—é¸èˆ‰&lt;/li>
&lt;li>å…¶ä»–ç¯€é»æˆç‚º leader&lt;/li>
&lt;li>è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º leader&lt;/li>
&lt;/ol>
&lt;h4 id="è´å¾—é¸èˆ‰">è´å¾—é¸èˆ‰&lt;/h4>
&lt;p>å¦‚æœ candidate æ‹¿ä¸‹éåŠçš„ç¥¨æ•¸ï¼Œå‰‡æˆç‚ºæ–°çš„ leaderï¼Œæ¯ä¸€å€‹ follower &lt;code>åœ¨åŒä¸€å€‹å›åˆæ•¸ä¸‹åªæœƒæŠ•ç¥¨çµ¦è«‹æ±‚å…ˆåˆ°çš„ candidate&lt;/code>ï¼Œé€™é¿å…ç„¡æ•ˆé¸èˆ‰çš„ç™¼ç”Ÿ&lt;br>
å¦‚æœ candidate æˆç‚º leaderï¼Œå‰‡é–‹å§‹ç™¼é€å¿ƒè·³åŒ…&lt;/p>
&lt;h4 id="ç™¼ç¾æœ‰å…¶ä»–-leader">ç™¼ç¾æœ‰å…¶ä»– leader&lt;/h4>
&lt;p>å¦‚æœåœ¨ candidate éšæ®µæ”¶åˆ°å¿ƒè·³åŒ…(AppendEntries)ï¼Œå‰‡ä»£è¡¨æœ‰å…¶ä»– leader ç”¢ç”Ÿï¼Œcandidate æœƒå»æ¯”å°å›åˆæ•¸è‡³å°‘è¦å¤§æ–¼ç­‰æ–¼ä»–è‡ªèº«çš„å›åˆæ•¸ï¼Œå¦‚æœæ˜¯å‰‡è½‰æˆ followerï¼›&lt;br>
åä¹‹å‰‡ç¹¼çºŒç¶­æŒ candidate&lt;/p>
&lt;h4 id="è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º-leader">è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º leader&lt;/h4>
&lt;p>è¶…éä¸€å®šæ™‚é–“é‚„æ˜¯æ²’æœ‰é¸å‡ºä¾†çš„è©±ï¼Œtimeout å¾Œé–‹å§‹ä¸‹ä¸€è¼ªæ–°çš„é¸èˆ‰&lt;/p>
&lt;p>Raft é€éåœ¨ä¸€å®šæ™‚é–“å…§éš¨æ©Ÿ timeout (150-300ms)ï¼Œé¿å…æ‰€æœ‰çš„ follower åŒæ™‚é€²å…¥é¸èˆ‰éšæ®µï¼Œé€™æ¨£èƒ½åŠ é€Ÿ leader çš„æ¨é¸ï¼Œå¾ŒçºŒæœƒæœ‰æ›´è¿‘ä¸€æ­¥çš„èªªæ˜&lt;/p>
&lt;p>åœ¨è¨­è¨ˆéç¨‹ï¼Œä½œè€…æ›¾è€ƒæ…®åŠ å…¥ rank ï¼Œrank è¼ƒé«˜è€…æ›´æœ‰æ©Ÿæœƒæˆç‚º leaderï¼Œä½†ç™¼ç¾é€™æœƒå°è‡´æ¼”ç®—æ³•è¨­è¨ˆæ›´åŠ è¤‡é›œï¼Œä¸”æœ‰å¯ç”¨æ€§çš„å•é¡Œï¼Œä¾‹å¦‚é«˜é †ä½ candidate ç™¼ç”Ÿç‹€æ³ï¼Œå‰‡ä½é †ä½ candidate è¦å¤šä¸€æ¬¡ timeout æ‰èƒ½ç•¶ä¸Š leader ç­‰å•é¡Œ&lt;/p>
&lt;h3 id="53-log-replication">5.3 Log replication&lt;/h3>
&lt;p>Leader æœƒé€é AppendEntries RPC å°‡æŒ‡ä»¤åŒæ­¥åˆ° follower ä¸¦å›å‚³åŸ·è¡Œçµæœçµ¦ clientï¼Œå¦‚æœ follower æ­¤æ™‚ crash ç­‰ï¼Œleader æœƒæŒçºŒé€ç›´åˆ° follower ç‹€æ…‹åŒæ­¥&lt;/p>
&lt;p>Log æ˜¯ä»¥ &lt;code>å›åˆæ•¸ + æŒ‡ä»¤&lt;/code> çš„æ–¹å¼ä¾åºå„²å­˜ï¼Œä¸»è¦æ˜¯æª¢è¦–æ˜¯å¦æœ‰ä¸ä¸€è‡´çš„ç‹€æ³ç”¢ç”Ÿ&lt;/p>
&lt;p>æ¯å€‹ç¯€é»éƒ½æœƒä¿å­˜ç¾ä»Šæœ€å¾Œä¸€å€‹ commited log çš„ç´¢å¼• (&lt;code>commitIndex&lt;/code>)ï¼ŒLeader åœ¨åŒæ­¥ log æ™‚ï¼Œæœƒç´€éŒ„ log è¦å¯«å…¥çš„ä½ç½® (commitIndex + 1)ï¼Œä¸¦åŒæ™‚ç™¼é€çµ¦ follower (leaderCommit)ï¼Œç­‰åˆ°å¤šæ•¸çš„ follower éƒ½å¯«å…¥ log å¾Œæ‰æ¨™è¨˜æˆ &lt;code>commited&lt;/code>ï¼ŒRaft ä¿è­‰ commited log æ˜¯å·²ç¶“æŒä¹…åŒ–ä¸”æœ€çµ‚æ¯å€‹ follower éƒ½æœƒé”åˆ°ä¸€è‡´æ€§&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/log.png"
loading="lazy"
alt="log"
>&lt;/p>
&lt;p>å› æ­¤ Raft ä¿è­‰ Logs æœ‰ä»¥ä¸‹ç‰¹æ€§&lt;/p>
&lt;ol>
&lt;li>å¦‚æœä»»æ„å…©å€‹ç¯€é»çš„ log æœ‰è‘—ç›¸åŒçš„ index èˆ‡å›åˆæ•¸ï¼Œå‰‡ä»–å€‘å¿…å®šå„²å­˜ç›¸åŒçš„æŒ‡ä»¤&lt;/li>
&lt;li>å¦‚æœä»»æ„å…©å€‹ç¯€é»çš„ log æœ‰è‘—ç›¸åŒçš„ index èˆ‡å›åˆæ•¸ï¼Œå‰‡è©²æŒ‡ä»¤å…ˆå‰çš„ log ç´€éŒ„éƒ½å¿…å®šç›¸åŒ&lt;/li>
&lt;/ol>
&lt;p>ç¬¬ä¸€é»ä¿è­‰ç¯€é»å„²å­˜ log å¾Œå°±ä¸æœƒå†è¢«æ”¹è®Šï¼Œç¬¬äºŒé»å‰‡ç¢ºä¿ç•¶ follower ç™¼ç¾è‡ªå·±çš„ log è·Ÿ leader ä¸åŒæ™‚ï¼Œå¯ä»¥ä¾æ­¤é‡æ–°è·Ÿ leader åŒæ­¥ç´€éŒ„&lt;/p>
&lt;p>Leader æœƒé‡å°æ¯ä¸€å€‹ follower ç¶­è­·æŒ‡é‡ &lt;code>nextIndex&lt;/code>ï¼Œç”¨ä¾†è¨˜éŒ„ follower ç›®å‰éœ€è¦åŒæ­¥çš„ log ç´¢å¼•ï¼Œleader åœ¨ç™¼é€ AppendEntries æŒ‡ä»¤æ™‚ï¼Œæœƒå¤¾å¸¶æœ€æ–° committed log çš„å›åˆæ•¸èˆ‡ indexï¼Œè®“ follower å¯ä»¥æ¯”å° log æ˜¯å¦åŒæ­¥ï¼Œå¦‚æœ follower åœ¨è‡ªå·±çš„ logs ä¸­æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„ç´€éŒ„ï¼Œå‰‡ä»£è¡¨å…©è€…éåŒæ­¥ï¼Œå›å‚³å¤±æ•—ï¼Œæ¥è‘— &lt;code>Leader ä¸æ–·éæ¸› nextIndex ç›´åˆ° follower æ‰¾åˆ°å…©è€…æœ€è¿‘ä¸€æ¬¡åŒæ­¥çš„ç´€éŒ„&lt;/code>ï¼Œæ¥è‘—é–‹å§‹ä¸€æ­¥æ­¥åŒæ­¥ç´€éŒ„&lt;/p>
&lt;blockquote>
&lt;p>leader èˆ‡ follower æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡åŒæ­¥ç´€éŒ„çš„æ–¹å¼ï¼Œå¯ä»¥å„ªåŒ–æˆ follower å›å‚³é€™ä¸€å€‹å›åˆæ•¸ä¸‹ä»–æ‰€ä»¥ç´€éŒ„çš„ç´¢å¼•ï¼Œleader ç›´æ¥å€’å›é€™å€‹å›åˆé–‹å§‹åŒæ­¥ï¼›&lt;br>
ä½†ä½œè€…èªç‚ºä¸ä¸€è‡´ç‹€æ…‹æ‡‰è©²å¾ˆå°‘ç™¼ç”Ÿï¼Œå„ªåŒ–çš„æ•ˆç›Šä¸å¤§&lt;/p>
&lt;/blockquote>
&lt;p>é€éé€™æ¨£çš„ log åŒæ­¥è¨­è¨ˆï¼ŒLeader åœ¨å‰›å•Ÿå‹•æ™‚ä¸ç”¨æ“”å¿ƒå¤ªå¤šåŒæ­¥çš„å•é¡Œï¼Œåˆ©ç”¨ AppendEntries çš„æˆåŠŸèˆ‡å¤±æ•—å»èª¿é… follower å„²å­˜çš„ç´€éŒ„ï¼Œleader ä¹Ÿä¸ç”¨å»åˆªé™¤æˆ–æ›´æ–°è‡ªèº«çš„ logï¼Œè®“æ•´å€‹åŒæ­¥çš„éç¨‹æ›´åŠ çš„ç°¡å–®&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/AppendEntries.png"
loading="lazy"
alt="AppendEntries"
>&lt;/p>
&lt;h3 id="54-safety">5.4 Safety&lt;/h3>
&lt;p>å…ˆå‰ä»‹ç´¹äº† leader election å’Œ relicate logï¼Œä½†åƒ…æœ‰é€™æ¨£çš„æ©Ÿåˆ¶æ˜¯ä¸å¤ çš„ï¼Œè©¦æƒ³å¦‚æœ leader ç™¼ç”ŸéŒ¯èª¤ï¼Œä»Šå¤©æœ‰ä¸€å€‹ follower åƒ…åŒ…å«éƒ¨åˆ†çš„ commited logï¼Œé¸ä¸Š leader å¾Œä¾¿æœƒè¤‡å¯«åŸæœ¬å…¶ä»–å·²ç¶“ commited çš„ logï¼Œé€™æ¨£å°±ä¸èƒ½ä¿è­‰ä¸€è‡´æ€§èˆ‡æŒä¹…åŒ–&lt;/p>
&lt;p>é€™ä¸€ç« ä»‹ç´¹ Raft åœ¨ leader election åŠ ä¸Šé™åˆ¶å¾Œï¼Œå¦‚ä½•é”åˆ°&lt;code>ç¢ºä¿æ¯ä¸€å°ç‹€æ…‹æ©Ÿéƒ½ä»¥ç›¸åŒé †åºä¿å­˜ç›¸åŒçš„æŒ‡ä»¤&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/safety.png"
loading="lazy"
alt="safety"
>&lt;/p>
&lt;p>Raft æœƒç¢ºä¿ä»»ä½•æ™‚å€™é›†ç¾¤éƒ½ç¬¦åˆä¸Šè¿°æ¢ä»¶&lt;/p>
&lt;ol>
&lt;li>Election Safety: æ¯ä¸€è¼ªé¸èˆ‰è‡³å¤šåªé¸å‡ºä¸€ä½ leader&lt;/li>
&lt;li>Leader Append-Only: leader å¾ä¸åˆªé™¤æˆ–æ”¹å¯«è‡ªå·±çš„ logï¼Œåªæœƒä¸€ç›´å¢åŠ &lt;/li>
&lt;li>Log Matching: ä»»å…©ä»½ logs åœ¨åŒä¸€å€‹ term åŒä¸€å€‹ index ä¸Šï¼Œå‰‡ log å…§å®¹å¿…å®šç›¸åŒï¼Œä¸”å…ˆå‰çš„ log ä¹Ÿéƒ½ç›¸åŒ&lt;/li>
&lt;li>Leader Completeness: æŸå€‹ log åœ¨ä»»ä¸€ä¸€å€‹ term ä¸­èªå®š commitedï¼Œå‰‡å¾ŒçºŒ term ä¸­çš„ leader éƒ½å¿…é ˆæœ‰è©²ä»½ log&lt;/li>
&lt;li>State Machine Safety: å¦‚æœæŸå€‹ server åœ¨æŸ index ä¸Šçš„ log å¥—ç”¨è‡³ç‹€æ…‹æ©Ÿï¼Œå‰‡ä¸æœƒæœ‰å…¶ä»–çš„ server åœ¨åŒä¸€å€‹ index ä¸Šå¥—ç”¨ä¸åŒçš„ log&lt;/li>
&lt;/ol>
&lt;h4 id="541-election-restriction">5.4.1 Election restriction&lt;/h4>
&lt;p>åœ¨ leader-based çš„å…±è­˜æ¼”ç®—æ³•ä¸­ï¼Œleader æœ€çµ‚æœƒå„²å­˜æ‰€æœ‰çš„ commited logï¼Œåœ¨æŸäº›æ¼”ç®—æ³•ä¸­ï¼Œleader åœ¨æ²’æœ‰ä¿å­˜æ‰€æœ‰ commited log æƒ…æ³ä¸‹ä¹Ÿèƒ½å¤ æª”é¸ï¼Œä¸¦é€éé¡å¤–çš„æ©Ÿåˆ¶å»å›è£œé€™äº›æœªåŒæ­¥çš„ logï¼Œé€™å¢åŠ äº†è »å¤šçš„è¤‡é›œæ€§&lt;/p>
&lt;p>Raft ç¢ºä¿ leader å¿…é ˆæ˜¯ç”± &lt;code>æ“æœ‰å¤§å¤šæ•¸ç¯€é»åŒæ„çš„æœ€æ–° committed log çš„ candidate&lt;/code> æ‰èƒ½ç•¶é¸ï¼Œç¢ºä¿ leader ä¸€å®šæ˜¯æ“æœ‰æœ€æ–° log çš„ç¯€é»ï¼Œåªè² è²¬å¢åŠ æ–°çš„ logï¼Œè®“è³‡æ–™æµåªæœ‰ä¸€å€‹æ–¹å‘ï¼Œçœå»å…¶ä»–çš„éº»ç…©&lt;/p>
&lt;p>åœ¨ RequestVote RPC ä¸­å¢åŠ äº†é™åˆ¶ï¼ŒRPC ä¸­å¤¾å¸¶ candidate æœ€å¾Œä¸€å€‹ log ä¸­çš„å›åˆæ•¸èˆ‡ç´¢å¼•æ•¸ï¼Œå¦‚æœ follower ç™¼ç¾ candidate çš„ç´€éŒ„æ¯”è‡ªå·±èˆŠï¼Œå‰‡å›å‚³å¤±æ•—&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/RequestVote.png"
loading="lazy"
alt="RequestVote"
>&lt;/p>
&lt;h4 id="542-committing-entries-from-previous-terms">5.4.2 Committing entries from previous terms&lt;/h4>
&lt;p>å…ˆå‰æåˆ°ï¼ŒLeader æœƒç­‰å¤šæ•¸çš„ç¯€é»å„²å­˜ log æ‰æ¨™è¨˜æˆ commitedï¼Œ ä½†å¦‚æœ leader å°‡ log å¯«åˆ°å¤šå€‹ follower å¾Œï¼Œé‚„ä¾†ä¸åŠæ”¶åˆ° commited å°± crash äº†&lt;br>
æ­¤æ™‚&lt;code>æ–°çš„ leader æœƒæŒçºŒåŒæ­¥ logï¼Œä½†ç„¡æ³•ç¢ºèªå…ˆå‰çš„ log æ˜¯ä¸æ˜¯è¢« commit&lt;/code> äº†ï¼Œå› ç‚ºåªæœ‰å…ˆå‰çš„ leader æ‰èƒ½ç¢ºèª log å·²ç¶“è¢«å¤šæ•¸çš„ç¯€é»æ‰€ä¿å­˜&lt;/p>
&lt;p>å¦‚ä»¥ä¸‹åœ–ç¤º
&lt;img src="https://yuanchieh.page/post/img/20201103/commit.png"
loading="lazy"
alt="commit"
>&lt;/p>
&lt;ol>
&lt;li>S1 ä¸€é–‹å§‹æ˜¯ leaderï¼ŒåŒæ­¥ term2 åˆ° S2 å°± crash&lt;/li>
&lt;li>S5 æ¥è‘—ç•¶ leader (S3,S4 å¯ä»¥æŠ•çµ¦ä»–) é–‹å§‹äº† term 3ï¼Œæ­¤æ™‚ç™¼ç”Ÿ crash&lt;/li>
&lt;li>S1 åˆå›ä¾†ç•¶ leaderï¼Œå°‡ term2 çš„ log åŒæ­¥åˆ° S3 å¾Œï¼Œæ­¤æ™‚åˆ crash&lt;/li>
&lt;/ol>
&lt;p>æ¥è‘—æ‹†å…©ç¨®æƒ…æ³&lt;br>
d. S1 ä¾†ä¸åŠåŒæ­¥ term4 è³‡æ–™ï¼Œå‰‡ S5 æœ‰æ©Ÿæœƒç•¶å…¥ leaderï¼Œä¸¦ç”¨ term3 è¤‡å¯«æ‰å…¶ä»–è³‡æ–™&lt;br>
e. S1 åŒæ­¥ term4 è³‡æ–™åˆ°å¤§å¤šæ•¸ç¯€é»ä¸Šï¼Œå‰‡ S5 ç„¡æ³•ç•¶ä¸Š leader&lt;/p>
&lt;p>&lt;code>åœ¨ leader é‚„æ²’æ”¶åˆ° commited æƒ…æ³ä¸‹ï¼Œå³ä½¿å¤šæ•¸çš„ç¯€é»å·²ç¶“åŒæ­¥ logï¼Œä½†æ–°çš„ leader æœ‰æ©Ÿæœƒè¤‡å¯«&lt;/code>&lt;/p>
&lt;p>ç‚ºäº†æ¸›å°‘é€™æ¨£çš„æƒ…æ³ï¼ŒRaft ä¸å»è¨ˆç®—å…ˆå‰ log æ‰€åŒæ­¥çš„å‰¯æœ¬æ•¸å»åˆ¤å®šæ˜¯å¦ commitedï¼Œ&lt;code>åªæœ‰ leader ç•¶ä¸‹çš„å›åˆæ•¸æ˜¯é€éå‰¯æœ¬çš„è¨ˆç®—ä¾†æ±ºå®š log æ˜¯å¦è¢« commitedï¼Œå¦‚æœ commit å¾Œï¼Œå‰‡å…ˆå‰çš„æ‰€æœ‰ log éƒ½è¢«è¦–ç‚º commited&lt;/code>ï¼Œé™ä½è¨ˆç®—ä¸Šçš„è¤‡é›œæ€§ï¼Œä¸¦å› ç‚ºä¹‹å‰çš„ log ç‰¹æ€§ä¿è­‰ï¼Œå…ˆå‰çš„ log ä¸€å®šä¹Ÿéƒ½è¢«è¤‡è£½åˆ°å…¶ä»–å‰¯æœ¬ä¸Š&lt;/p>
&lt;h4 id="543-safety-argument">5.4.3 Safety argument&lt;/h4>
&lt;p>æ›´é€²ä¸€æ­¥è§£é‡‹ &lt;code>Leader Completeness&lt;/code>ï¼Œé€éåè­‰æ³•ï¼Œæ‰¾å‡ºé›†ç¾¤ç„¡æ³•ä¸éµå®ˆ Leader Completeness&lt;/p>
&lt;p>å‡è¨­ leaderT ä»£è¡¨åœ¨ term T çš„ leaderï¼Œleader U å‰‡æ˜¯ term Uï¼Œä¸” U ä»£è¡¨æ˜¯ T çš„ä¸‹ä¸€ä½ï¼Œä¸” leaderT æ‰€èªå®šçš„ commited log (logT) åœ¨ leader U ä¸å­˜åœ¨ (é•å Leader Completeness)&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/leader-completeness.png"
loading="lazy"
alt="leader-completeness"
>&lt;/p>
&lt;ol>
&lt;li>leaderU åœ¨ç•¶ follower æ™‚ä¸¦ä¿å­˜æ²’æœ‰ logT&lt;/li>
&lt;li>leaderT å°‡ logT åŒæ­¥åˆ°å¤šæ•¸ç¯€é»ä¸Šï¼Œè€Œ leaderU åœ¨é¸èˆ‰æ™‚ç²å¾—å¤šæ•¸åŒæ„ï¼Œä¹Ÿå°±æ˜¯è‡³å°‘æœ‰ä¸€ä½æŠ•ç¥¨ç¯€é» (voter) æ”¶åˆ° logT åŒæ™‚åˆæŠ•ç¥¨çµ¦ leaderU&lt;/li>
&lt;li>voter å¿…é ˆå…ˆä¿å­˜ logTï¼Œæ‰åˆæŠ•ç¥¨çµ¦ leaderUï¼Œåéä¾†å°±ä¸æœƒæœ‰è¡çª (term U &amp;gt; term T æ‰€ä»¥ logT å¾Œåˆ°æœƒè¢«ä¸Ÿæ£„)&lt;/li>
&lt;li>voter ä¾ç„¶ä¿å­˜ logTï¼Œå› ç‚º leader å¾ä¸æ”¹è®Šæ—¢å®š logï¼Œè€Œ follower ä¹Ÿåªæœ‰èˆ‡ leader è¡çªæ™‚æ‰æœƒè¤‡å¯«&lt;/li>
&lt;/ol>
&lt;p>è£½é€ å‡ºå ´æ™¯å¾Œï¼Œè®“æˆ‘å€‘ä¾†çœ‹ç‚ºä»€éº¼ Raft ä¸å¯èƒ½é”åˆ°é€™æ¨£çš„ç‹€æ³&lt;br>
5. ä¾æ“šå…ˆå‰è¦å®šï¼Œ follower åªæœƒæŠ•çµ¦ log ä¿ç•™æ¯”è‡ªå·±æ›´å¤šçš„ candidate&lt;br>
6. å¦‚æœ voter èˆ‡ leaderU æœ€æ–°ä¸€å€‹ term éƒ½æ˜¯ T çš„è©±ï¼Œå‰‡ leaderU çš„ log æ•¸æ‡‰è©²èˆ‡ voter ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ leaderU è‡³å°‘æ“æœ‰ voter æ‰€æ“æœ‰çš„ log&lt;br>
7. åä¹‹ï¼Œå¦‚æœ leaderU çš„æœ€æ–° log term å¤§æ–¼ voter çš„è©±ï¼Œç‚ºäº†è¦ç¬¦åˆæ—©æ–¼ leaderU çš„ leader æ‰€æœ‰ commited log éƒ½æ‡‰è©²è¢«ä¿ç•™åˆ° leaderU ä¸­ï¼Œå› æ­¤æ ¹æ“š &lt;code>Log Matching&lt;/code> å‰‡ leaderU æ‡‰è©²è¦å„²å­˜é€™äº› log&lt;/p>
&lt;p>åœ¨ç„¡æ³•é”æˆçš„æƒ…æ³ï¼Œè­‰æ˜äº† Raft æ»¿è¶³ Leader Completeness æ¢ä»¶ï¼Œç¢ºä¿ leader å¦‚æœæœ€æ–°çš„ log term &amp;gt; Tï¼Œå‰‡ leader å¿…å®šæ“æœ‰ term T æ‰€ commited çš„ä¸€åˆ‡ log&lt;/p>
&lt;blockquote>
&lt;p>Thus, the leaders of all terms greater than T must contain all entries from term T that are committed in term T&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰äº† Leader Completeness å±¬æ€§ï¼Œå°±èƒ½é€²ä¸€æ­¥è­‰æ˜ &lt;code>State Machine Safety&lt;/code>ï¼Œå¦‚æœæŸä¸€æ©Ÿå™¨åœ¨æŸä¸€ index å¥—ç”¨æŒ‡ä»¤åˆ°ç‹€æ…‹æ©Ÿä¸­ï¼Œå‰‡å…¶ä»–æ©Ÿå™¨åœ¨ç›¸åŒ index ä¸‹ä¸¦ç„¶å¥—ç”¨ç›¸åŒçš„æŒ‡ä»¤ï¼Œå› ç‚ºèƒ½å¤ è¢«å¥—ç”¨çš„ log ä¸€å®šæ˜¯ leader commited å¾Œçš„ logï¼Œä¸”å› ç‚º Log
Completenessï¼Œæ‰€æœ‰æ›´æ–°çš„ leader ä¹Ÿéƒ½ä¿ç•™è¢« commited å¾Œçš„ logï¼Œå› æ­¤èƒ½&lt;code>ç¢ºä¿æ‰€æœ‰çš„ç¯€é»çµ‚å°‡ä»¥ç›¸åŒçš„é †åºå¥—ç”¨ç›¸åŒçš„æŒ‡ä»¤åˆ°ç‹€æ…‹æ©Ÿä¸Š&lt;/code>&lt;/p>
&lt;h3 id="55-follower-and-candidate-crashes">5.5 Follower and candidate crashes&lt;/h3>
&lt;p>å…ˆå‰éƒ½æ˜¯è¨è«– leader crashed å¾Œçš„è™•ç½®ï¼Œè‡³æ–¼ follower èˆ‡ candidate å‰‡å–®ç´”å¾ˆå¤šï¼Œå› ç‚º Raft çš„ RPC æŒ‡ä»¤éƒ½æ˜¯ &lt;code>idempotent&lt;/code>ï¼Œleader å¯ä»¥æŒçºŒçš„é€æŒ‡ä»¤ç›´åˆ°æˆåŠŸï¼Œfollower è·Ÿ candidate å¤±æ•—å¾Œé‡å•Ÿå°±é‡æ–°æ¥æ”¶æŒ‡ä»¤å°±å¥½&lt;/p>
&lt;h3 id="56-timing-and-availability">5.6 Timing and availability&lt;/h3>
&lt;p>Raft Safety å»ºç«‹åœ¨ä¸ä¾è³´ timingï¼Œç³»çµ±ä¸æœƒå› ç‚ºè¨Šæ¯ç™¼é€çš„å¿«æ…¢è€Œå¾—åˆ°ä¸é æœŸçš„çµæœï¼›&lt;br>
ä½†æ•´é«”ç³»çµ±çš„å¯ç”¨æ€§å»é‚„æ˜¯è·Ÿæ™‚é–“æœ‰ä¸€äº›é—œè¯ï¼Œä¾‹å¦‚èªª server ä¸èƒ½å† election timeout æœŸé–“å…§ç¥¨é¸å‡º leaderï¼Œè€Œ Raft åœ¨æ²’æœ‰ leader çš„æƒ…æ³ä¸‹å°±ä¸å¯ç”¨&lt;/p>
&lt;p>æ‰€ä»¥æ•´é«”ä¸Šè¦ç¬¦åˆä»¥ä¸‹ä¸ç­‰å¼ Raft æ‰èƒ½é‹ä½œæ­£å¸¸&lt;/p>
&lt;blockquote>
&lt;p>broadcastTime â‰ª electionTimeout â‰ª MTBF&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>&lt;code>broadcastTime&lt;/code> ä»£è¡¨ RPC å®Œæ•´ request / response æ‰€è€—è²»çš„æ™‚é–“ï¼Œé ˆå°æ–¼ electionTimeout ä¸€å€‹é‡ç´šï¼Œé€šå¸¸åœ¨ 0.5ms ~ 20msï¼›&lt;/li>
&lt;li>&lt;code>electionTimeout&lt;/code> å‰‡æ˜¯ follower ç­‰å¾…å¤šä¹…å¾Œæœƒè§¸ç™¼é¸èˆ‰ï¼Œé€™æ˜¯å¯ä»¥ä¸»å‹•å»è¨­å®šçš„ï¼Œé€šå¸¸åœ¨ 100ms ~ 500msï¼›&lt;/li>
&lt;li>&lt;code>MTBF&lt;/code> å‰‡ä»£è¡¨ server é€²å…¥éŒ¯èª¤ç‹€æ…‹çš„å€é–“ï¼Œé€šå¸¸æ˜¯æ•¸å¤©è‡³æ•¸å€‹æœˆ&lt;/li>
&lt;/ol>
&lt;p>è©¦æƒ³å¦‚æœ broadcastTime &amp;gt; electionTimeoutï¼Œå‰‡æ¯ä¸€æ¬¡é¸èˆ‰åœ¨é‚„æ²’æ”¶åˆ°æŠ•ç¥¨çµæœåˆé–‹å§‹ä¸‹ä¸€è¼ªé¸èˆ‰ï¼Œå‰‡æ°¸é é¸ä¸å®Œï¼›&lt;br>
å¦‚æœ electionTimeout &amp;gt; MTBFï¼Œå‰‡é¸èˆ‰é‚„æ²’çµæŸ server åˆ crashï¼Œé‚£ä¹Ÿä¸€æ¨£æœƒæœ‰ leader ç„¡æ³•ç”¢ç”Ÿçš„å•é¡Œ&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å¾ŒçºŒé‚„æœ‰ Cluster membership changes / Log compaction / Client interaction é€²éšæ¢è¨ï¼Œå°±å…ˆæš«æ™‚ç•¥éï¼Œåƒ…ç†è§£å‰åŠéƒ¨æ¼”ç®—æ³•çš„æ ¸å¿ƒè¨­è¨ˆ&lt;/p>
&lt;p>åˆ†æ•£å¼ç³»çµ±çš„è¿·äººä¹‹è™•åœ¨æ–¼&lt;code>è¤‡é›œ&lt;/code>ï¼Œéœ€è¦é¢å°ç¶²è·¯å»¶é² / æ™‚é–“ä¸ä¸€è‡´(time skewed) / æ©Ÿå™¨å¤±æ•—ç­‰ä¸ç©©å®šçš„å› å­ï¼Œã€Œå†ä¸ç©©å®šçš„æ¢ä»¶ä¸‹æ¶æ§‹å‡ºå¯å®¹éŒ¯/é«˜å¯ç”¨/ä¸€è‡´æ€§çš„ç©©å®šç³»çµ±ã€ï¼Œçœ‹ä¼¼è’è¬¬å»å¯ä»¥é€éæ¼”ç®—æ³•çš„è¨­è¨ˆé”æˆç›®çš„(æˆ–æ˜¯èªªæ›´è²¼è¿‘)ï¼Œå¯¦åœ¨ä»¤äººè®šå˜†é€™äº›è¨­è¨ˆæ¼”ç®—æ³•çš„å°ˆå®¶å€‘&lt;/p>
&lt;p>Raft é€éç”± Leader ä¸»å° Log çš„åŒæ­¥ï¼Œä¸¦åŠ å…¥é¸èˆ‰æ™‚çš„æ¢ä»¶é™åˆ¶ï¼Œç¢ºä¿ commited log ä¸æœƒè¢«æ”¹å¯«é”åˆ° &lt;code>å¼·ä¸€è‡´æ€§&lt;/code>ï¼›å¦‚æœ Leade å¤±æ•—ï¼Œä¹Ÿä¸ç”¨æ“”å¿ƒ log ç™¼ç”Ÿå•é¡Œï¼Œç­‰ä¸‹ä¸€ä½ Leader è¢«æ¨é¸å‡ºä¾†åˆèƒ½å¤ ç¹¼çºŒç¶­æŒç³»çµ±é‹ä½œ&lt;/p>
&lt;p>æ•´ä»½è«–æ–‡è®€èµ·ä¾†é‚„ç®—è »å¥½ç†è§£çš„ï¼Œç¢ºå¯¦ç¬¦åˆä½œè€…ä¸æ–·å¼·èª¿å¯è®€æ€§çš„é‡è¦&lt;/p></description></item><item><title>Gossip Protocol ä»‹ç´¹ (ä¸‹) - ã€ŠEfficient Reconciliation and Flow Control for Anti-Entropy Protocolsã€‹è«–æ–‡æ‘˜è¦</title><link>https://yuanchieh.page/posts/2020/2020-10-28-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8B-efficient-reconciliation-and-flow-control-for-anti-entropy-protocols%E8%AB%96%E6%96%87%E6%91%98%E8%A6%81/</link><pubDate>Wed, 28 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-28-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8B-efficient-reconciliation-and-flow-control-for-anti-entropy-protocols%E8%AB%96%E6%96%87%E6%91%98%E8%A6%81/</guid><description>&lt;h1 id="gossip-protocol">Gossip Protocol&lt;/h1>
&lt;p>Gossip Protocol æ˜¯ä¸€ç¨®é€šè¨Šæ©Ÿåˆ¶ï¼Œæ‡‰ç”¨æ–¼åŒä¸€ç¶²è·¯å…§æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“äº¤æ›è¨Šæ¯ä½¿ç”¨ï¼ŒåŸç†é¡ä¼¼æ–¼è¾¦å…¬å®¤å‚³è¬ è¨€ä¸€æ¨£ï¼Œä¸€å€‹å‚³ä¸€å€‹ï¼Œæœ€çµ‚æ¯ä¸€å€‹æ©Ÿå™¨éƒ½æ“æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œåˆç¨± Epidemic Protocol&lt;/p>
&lt;p>ä¸Šä¸€ç¯‡åˆ†äº«åˆ° &lt;a class="link" href="https://yuanchieh.page/post/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9%E4%B8%8A/" target="_blank" rel="noopener"
>Cassandra å…§éƒ¨å¦‚ä½•ä½¿ç”¨ Gossip Protocol&lt;/a>ï¼Œå½±ç‰‡ä¸­æœ‰æ¨è–¦ &lt;a class="link" href="https://www.cs.cornell.edu/home/rvr/papers/flowgossip.pdf" target="_blank" rel="noopener"
>Efficient Reconciliation and Flow Control for Anti-Entropy Protocols&lt;/a>ï¼Œä»¥ä¸‹æ‘˜è¦æ­¤ç¯‡è«–æ–‡æ‰€æ¢è¨çš„å…§å®¹&lt;/p>
&lt;p>å»ºè­°å¯ä»¥å…ˆè®€ä¸Šç¯‡ï¼Œæœ‰å€‹æ¦‚ç•¥èªè­˜å¾Œåœ¨çœ‹ç†è«–æœƒæ¯”è¼ƒå¥½æ‡‚äº›&lt;/p>
&lt;h2 id="efficient-reconciliation-and-flow-control-for-anti-entropy-protocols-æ‘˜è¦">ã€ŠEfficient Reconciliation and Flow Control for Anti-Entropy Protocolsã€‹ æ‘˜è¦&lt;/h2>
&lt;p>anti-entropyï¼Œåˆæˆ–ç¨±ä½œ gossipï¼Œç”¨æ–¼ä¸éœ€è¦å¼·ä¸€è‡´æ€§çš„ç‹€æ…‹åŒæ­¥ï¼Œåœ¨ä¸€äº›é™åˆ¶ä¸‹ï¼Œæ™‚é–“è¤‡é›œåº¦æ˜¯ log(N) (N ç‚ºç¾¤é«”æ•¸é‡) ä¸”åœ¨ host é­é‡éŒ¯èª¤æˆ–æ˜¯è¨Šæ¯ä¸Ÿå¤±éƒ½ä¸å½±éŸ¿&lt;/p>
&lt;p>gossip å¸Œæœ›ç›¡é‡åœ¨å¯æ§åˆ¶çš„å›åˆå…§å®ŒæˆåŒæ­¥ï¼Œä½†å¦‚åŒå…¶ä»–åŒæ­¥æ“ä½œï¼Œé€™æœƒä»°è³´ CPU è³‡æºèˆ‡ Network æµé‡ï¼Œåœ¨é«˜è² è¼‰ä¸‹ CPU å¯èƒ½ä¾†ä¸åŠé‹ç®—è¦æ›´æ–°çš„ç‹€æ…‹æˆ–æ˜¯ç¶²è·¯æµé‡ä¸å¤ å¿«å°è‡´å»¶é²å°åŒ…&lt;/p>
&lt;p>é€™ä»½è«–æ–‡ä¸»è¦æä¾›å…©å€‹åƒ¹å€¼ï¼Œ&lt;/p>
&lt;ol>
&lt;li>åœ¨é™å®š CPU / Network ä¸‹å„ªåŒ– gossip protocol å‚³è¼¸æ•ˆç‡&lt;/li>
&lt;li>åˆ†æ gossip protocol çš„æµé‡ç®¡åˆ¶&lt;/li>
&lt;/ol>
&lt;p>gossip protocol ä¸»è¦æœ‰å…©ç¨®é¡å‹&lt;/p>
&lt;ol>
&lt;li>anti-entropy: æŒçºŒå‚³é€ gossip information ç›´åˆ°å…¨éƒ¨è³‡æ–™éƒ½æ›´æ–°å®Œæˆ&lt;/li>
&lt;li>rumormongering: é¸å®šä¸€å€‹è¶³å¤ æœ‰æ•ˆçš„æ™‚é–“æŒçºŒé€ gossip informationï¼Œå¤§æ¦‚ç‡ç¯€é»éƒ½æœƒæ‹¿åˆ°æœ€æ–°è³‡è¨Š&lt;/li>
&lt;/ol>
&lt;p>å‡è¨­ç›®å‰çš„é›†ç¾¤ {p,q &amp;hellip;}ï¼Œæ¯å€‹åƒèˆ‡è€…éƒ½éœ€è¦ç¶­è­·ä¸€ä»½åˆ—è¡¨ï¼Œé€™å€‹åˆ—è¡¨æ˜¯ç”± key -&amp;gt; (value + version) çµ„æˆï¼Œä¹Ÿå°±æ˜¯ Cassandra å…§çš„ ApplicationState&lt;/p>
&lt;blockquote>
&lt;p>Ïƒ âˆˆ S = K â†’ (V Ã— N ) // Ïƒ ä»£è¡¨å–ç‹€æ…‹
Ïƒ(k) = (v, n) ï¼Œè¡¨ç¤º key æ­¤æ™‚å°æ‡‰çš„ value v è·Ÿ version n&lt;/p>
&lt;/blockquote>
&lt;p>åˆ—è¡¨åŒ…å« key -&amp;gt; value -&amp;gt; versionï¼Œå¦‚æœæ˜¯é€™å€‹ key çš„æœ€æ–°è³‡æ–™ï¼Œå‰‡ä»–çš„ version æœƒå¤§æ–¼èˆŠçš„ version&lt;/p>
&lt;blockquote>
&lt;p>Ïƒ1(k) = (v1, n1), Ïƒ2(k) = (v2, n2) // Ïƒ1(k) ä»£è¡¨é€™ä¸€å€‹ç¯€é»å–ä»–çš„ keyï¼Œè¿”å› (v1, n1) ä»£è¡¨ value ç‚º v1 ä¸” version n1ï¼›
Ïƒ(k) è¡¨ç¤ºå– Ïƒ1 èˆ‡ Ïƒ2 å– XORï¼Œä¸¦é‡åˆ°ç›¸åŒ key æ™‚å– verson è¼ƒå¤§è€…ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ n1 &amp;gt; n2 å‰‡ Ïƒ(k) = (v1, n1)&lt;/p>
&lt;/blockquote>
&lt;p>æ“ä½œæµç¨‹å¤§è‡´æ˜¯&lt;/p>
&lt;ol>
&lt;li>å¾é›†ç¾¤ä¸­éš¨æ©ŸæŒ‘ä¸€å€‹ host å‚³é€è¨Šæ¯ï¼Œè¨Šæ¯å…§å®¹æ˜¯è‡ªå·±æ‰€ç¶­è­·çš„åˆ—è¡¨&lt;/li>
&lt;li>æ”¶åˆ°è¨Šæ¯å¾Œé‹ç®—ï¼Œæ­¤å‹•ä½œç¨±ç‚º merge æˆ–ç¨±ç‚º reconciliation ï¼Œä¹Ÿå°±æ˜¯æ”¶åˆ°è¨Šæ¯æ™‚æœƒå»é‹ç®—åˆ—è¡¨çš„å·®ç•°ï¼Œä¸¦ä¿ç•™å·®ç•°ä¸­ version è¼ƒé«˜çš„ key -&amp;gt; value&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>âˆ€r : Âµq (r) = Âµq (r) âŠ• Âµp(r) // q çœŸæ­£è¦æ›´æ–°çš„æ˜¯ p å‚³ä¾†çš„è¨Šæ¯èˆ‡ q è‡ªèº«ç¾åœ¨çš„è¨Šæ¯å– XOR æ‰¾å‡ºå·®ç•°è™•&lt;/p>
&lt;/blockquote>
&lt;p>å‚³é€è¨Šæ¯æœ‰ä¸‰ç¨®æ ¼å¼&lt;/p>
&lt;ol>
&lt;li>push: ç¯€é» p å‚³é€æ•´ä»½åˆ—è¡¨ï¼Œç¯€é» q æ”¶åˆ°å‰‡è¨ˆç®— merge å¾Œåˆä½µå…¥è‡ªå·±çš„åˆ—è¡¨&lt;/li>
&lt;li>pull: ç¯€é» p å‚³é€ key -&amp;gt; version è€Œæ²’æœ‰ valueï¼Œç¯€é» q å›å‚³ç¯€é» p é ˆè¦æ›´æ–°çš„éµå€¼ï¼Œè®Šå…å¤šé¤˜çš„å€¼å‚³é€&lt;/li>
&lt;li>push-pull: å°±åƒ pushï¼Œç¯€é» p å‚³é€å®Œæ•´åˆ—è¡¨ï¼Œç¯€é» q æœƒå›å‚³ p éæœŸé ˆè¦æ›´æ–°çš„éµå€¼ ( pull å¾ŒåŠæ®µï¼Œ&lt;code>push-pull æ˜¯æœ€æœ‰æ•ˆç‡çš„åšæ³•&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæŸå€‹ key ä¸å†æ›´æ–°ï¼Œé‚£åœ¨ä¸€å®šçš„æ™‚é–“å…§å¾ˆé«˜çš„æ©Ÿç‡å¤§å®¶éƒ½æœƒåŒæ­¥ç›¸åŒçš„ valueï¼Œå¦‚æœé›†ç¾¤éš¨æ©ŸæŒ‘é¸ç¯€é»çš„æ¼”ç®—æ³• &lt;code>(Fp âŠ† P âˆ’ {p})&lt;/code> å¤ éš¨æ©Ÿçš„è©±ï¼Œå³ä½¿é‡åˆ° message loss æˆ–æ˜¯ host çŸ­æš« failedï¼Œä¹Ÿåƒ…åƒ…æ˜¯ç¨å¾®å»¶é²åŒæ­¥çš„æ™‚é–“&lt;/p>
&lt;p>å‡è¨­ update key çš„æ™‚é–“æ˜¯å›ºå®šçš„ï¼Œé‚£éš¨è‘—é›†ç¾¤æ•¸é‡ç·šæ€§å¢é•· Nï¼Œå‰‡é”æˆåŒæ­¥æ‰€éœ€è¦çš„æ™‚é–“æœƒæˆ log(N) å¢é•·ã€‚&lt;/p>
&lt;p>ä½†å¯¦å‹™ä¸Šå¿…é ˆè€ƒé‡åˆ° CPU / Network ä»¥åŠæ›´æ–°çš„é »ç‡ï¼Œå¦‚æœæ›´æ–°çš„é »ç‡å¤ªé«˜ï¼Œå› ç‚ºè³‡æºå—é™å‰‡åŒæ­¥çš„å»¶é²å¯èƒ½æœƒç„¡é™çš„å¢é•·ï¼Œå¯¦éš›ä¸Šæ‡‰ç”¨ç¨‹å¼åœ¨æ„çš„ä¸æ˜¯å¤šå¸¸æ›´æ–°ï¼Œè€Œæ˜¯è³‡æ–™æ˜¯ä¸æ˜¯æŠµé”åŒæ­¥&lt;/p>
&lt;p>æ¥è‘—è¦æ¢è¨å¦‚æœæˆ‘å€‘é™å®š gossip message ä¸èƒ½è¶…é MTU(Maximum Transmission Unit)ï¼Œé‚£æˆ‘å€‘è©²æ€éº¼æ±ºå®šè¦æ›´æ–°å“ªäº› key æ‰èƒ½æœ€æœ‰æ•ˆè®“æ‰€æœ‰ç¯€é»ç‹€æ…‹ä¸€è‡´&lt;/p>
&lt;h2 id="reconciliation">RECONCILIATION&lt;/h2>
&lt;p>å…ˆå‰æåˆ° p è·Ÿ q ä¾†å›é€šä¿¡éƒ½åªé€å…©è€…ç‹€æ…‹çš„ deltaï¼Œå¦‚æœè¶…é MTU å‰‡å¿…é ˆæœ‰ä¸€å€‹å„ªå…ˆåºæ±ºå®šå“ªäº›éµå€¼è¦å…ˆæ›´æ–°( &lt;code>&amp;lt;Ï€&lt;/code> ä»£è¡¨æ­¤æ’åºæ¼”ç®—æ³•)ï¼Œä½œè€…ä»‹ç´¹äº†å…©ç¨®ï¼Œä¸€ç¨®æ˜¯ &lt;code>precise reconciliation&lt;/code> æœ€ç‚ºåŸºæº–ç·šï¼Œå°æ¯”å¦ä¸€å€‹ä½œè€…æå‡ºçš„ &lt;code>Scuttlebutt&lt;/code> æ›´æ–°æ©Ÿåˆ¶&lt;/p>
&lt;h3 id="precise-reconciliation">precise reconciliation&lt;/h3>
&lt;p>æ ¹æ“šæ›´æ–°æ™‚é–“åºæ±ºå®šå“ªäº› key è¦å…ˆé€å‡ºå»ï¼Œåœ¨å¯¦å‹™ä¸Š precise reconciliation æ¯”è¼ƒéº»ç…©äº›ï¼Œå¦‚å…ˆå‰èªªå¿…é ˆè¦å…ˆé€ state çµ¦å°æ–¹åšæ¯”è¼ƒæ‰èƒ½ç®—å‡º deltaï¼Œé€™æœƒæ¶ˆè€—é »å¯¬ä»¥åŠ CPU cycle&lt;/p>
&lt;p>ä¾æ“šæ™‚é–“åºåˆå¯ä»¥ç´°åˆ†æˆ &lt;code>precise-oldest&lt;/code>: åœ¨ MTU é™åˆ¶ä¸‹å…ˆé€é‚£äº›å¾ˆä¹…æ²’æœ‰æ›´æ–°çš„ key / &lt;code>precise-newest&lt;/code>: å…ˆé€æœ€è¿‘æ‰è¢«æ›´æ–°çš„ keyï¼Œå¾Œè€…è¦ç•™æ„æœƒæœ‰ starvation å•é¡Œï¼Œåœ¨å¯¦ä½œä¸Šç¯€é»å¿…é ˆåŒæ­¥æ™‚é–“ï¼Œæ‰èƒ½ä½œç‚ºåˆ¤æ–·çš„ä¾æ“š&lt;/p>
&lt;blockquote>
&lt;p>Note that, if implemented, both these orderings would require a synchronized clock among the members and that all
updates be timestamped with this clock.&lt;/p>
&lt;/blockquote>
&lt;h3 id="scuttlebutt-reconciliation">Scuttlebutt Reconciliation&lt;/h3>
&lt;p>ä½œè€…æåŠå¦ä¸€ç¨®è§£æ³•ï¼Œä¹Ÿæ˜¯ Cassandra æ¡ç´çš„åšæ³•ï¼Œåˆå§‹åŒ–æ™‚ version å›ºå®šæ˜¯æœ€å°çš„æ•¸å­—ï¼Œæ¯æ¬¡æ›´æ–°éµå€¼æ™‚ï¼Œè¦æŠŠ version è¨­å®šå¤§æ–¼æˆç›®å‰ä»»æ„éµå€¼å°æ‡‰çš„æœ€é«˜ç‰ˆè™Ÿ&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>{(r, max(Âµp(r))) | r âˆˆ P}&lt;/code> // æ­¤å…¬å¼è¡¨ç¤º r æ˜¯å±¬æ–¼ç¯€é» P çš„å±¬æ€§ï¼Œæ‰¾å‡º r ä»¥åŠç•¶ä¸‹ P ä¸­ r æœ€å¤§çš„ç‰ˆè™Ÿï¼›&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚èªªç›®å‰ Participant p çš„åˆ—è¡¨æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">key &lt;span class="p">|&lt;/span> value &lt;span class="p">|&lt;/span> version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a &lt;span class="p">|&lt;/span> a1 &lt;span class="p">|&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">b &lt;span class="p">|&lt;/span> b1 &lt;span class="p">|&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c &lt;span class="p">|&lt;/span> c1 &lt;span class="p">|&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ­¤æ™‚ a è¦æ›´æ–°ï¼Œå‰‡ç‰ˆè™Ÿè‡³å°‘è¦æ‹‰åˆ° 4ï¼Œè€Œä¸”ä¸åƒ precise-conciliation æœƒä¸€æ¬¡é€å¤šçµ„é–“å€¼æ›´æ–°ï¼ŒScuttlebutt å…è¨±ä¸€æ¬¡å¯ä»¥é€ä¸€å€‹éµå€¼ï¼Œä½†å¿…é ˆæŒ‰ç…§ version å¤§å°é€ä¸€é€
æ•´å€‹æ¶æ§‹å¿…é ˆç¬¦åˆä»¥ä¸‹ç‹€æ…‹
&lt;img src="https://yuanchieh.page/post/img/20201028/gossip_equation.png"
loading="lazy"
>&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯èªªåœ¨æ•´å€‹é›†ç¾¤ä¸‹ï¼Œä»»ä¸€éµå€¼ k åœ¨ç¯€é» p / ç¯€é» q å¿…é ˆæ»¿è¶³ä»¥ä¸‹ä»»ä¸€æ¢ä»¶&lt;/p>
&lt;ol>
&lt;li>åœ¨ç¯€é» p è·Ÿç¯€é» q ä¸­åŒä¸€å€‹ key version æ˜¯ä¸€æ¨£ï¼Œä»£è¡¨&lt;code>è³‡æ–™å·²ç¶“åŒæ­¥&lt;/code>&lt;/li>
&lt;li>å¦‚æœç¯€é» p çš„ key version è·Ÿç¯€é» q ä¸åŒï¼Œå‰‡æ­¤ version å¿…é ˆæ¯”æ˜¯ç¯€é»q ä¸­ä»»æ„æœ€å¤§çš„ç‰ˆè™Ÿé‚„è¦å¤§&lt;/li>
&lt;/ol>
&lt;p>ç¬¬äºŒé»éå¸¸é‡è¦ï¼Œé€™æ˜¯ä¿æŒæ¯æ¬¡æ›´æ–°ä¸éœ€è¦æ•´åŒ…é€ï¼Œå…ˆå¾ç‰ˆæœ¬åˆ¤æ–·å°±èƒ½åˆ¤æ–·å“ªäº›æ¬„ä½çœŸçš„éœ€è¦æ›´æ–°çš„ä¾æ“š&lt;/p>
&lt;p>ä¾†çœ‹ä¸€å€‹å¯¦éš›æ¡ˆä¾‹ï¼Œç›®å‰æœ‰ä¸‰å€‹ç¯€é» r,p,qï¼Œå…±æœ‰ 3 å€‹ key a,b,cï¼Œå¯ä»¥çœ‹åˆ° t1 æ™‚ r çš„ä¸‰å€‹ key éƒ½è¢«æ›´æ–°éï¼Œç‰ˆè™Ÿåˆ†åˆ¥æ˜¯ 21/22/23ï¼›&lt;br>
æ­¤æ™‚ r è¦å‘ p,q ç™¼é€ gossip messageï¼Œä»–å¿…é ˆå…ˆå¾ a é–‹å§‹ï¼Œå› ç‚ºé€™æ˜¯ a,b,c ä¸‰è€…ä¸­ç‰ˆè™Ÿæœ€å°ï¼Œä¸”å¤§æ–¼&lt;code> Âµq(p) / Âµp(p)&lt;/code> ï¼Œé€™æ„å‘³è‘—ç¯€é» p å’Œ ç¯€é»q éƒ½è¦æ›´æ–°ï¼Œæ‰€ä»¥ r æœƒåŒæ™‚é€è¨Šæ¯çµ¦ p , qï¼Œåœ¨ t2 æ™‚åªæœ‰ key a å…ˆè¢«æ›´æ–°&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201028/example.png"
loading="lazy"
>&lt;/p>
&lt;blockquote>
&lt;p>å¯ä»¥å›å»çœ‹ Gossip ä»‹ç´¹(ä¸Š)çš„ GossipDigestSynMessage éƒ¨åˆ†&lt;/p>
&lt;/blockquote>
&lt;p>é›–ç„¶èªªä¸€æ¬¡åªæ›´æ–°ä¸€å€‹éµå€¼æ•ˆç‡å¥½åƒå¾ˆä½ï¼Œä½†å„ªé»æ˜¯ r ä¸éœ€è¦é€å·²ç¶“æ›´æ–°éçš„å€¼ï¼Œæ¸›å°‘é‡è¤‡ï¼Œåœ¨é »å¯¬æœ‰é™æƒ…æ³ä¸‹ï¼ŒScuttlebutt ä¹Ÿå¿…é ˆæ±ºå®š gossip message å‚³é€çš„å„ªå…ˆåºï¼Œé€™è£¡æœ‰å…©ç¨®åšæ³•&lt;/p>
&lt;ol>
&lt;li>&lt;code>scuttle-breadth&lt;/code>: åœ¨åŒä¸€å€‹ participant ä¸­ï¼Œå°‡ delta ç”¨ version å¾å°åˆ°å¤§æ’åºï¼Œå¦‚æœå…©å€‹ä¸åŒ delta çš„ version ç›¸åŒï¼Œå‰‡éš¨æ©ŸæŠ½ participant ç™¼é€&lt;/li>
&lt;li>&lt;code>scuttle-depth&lt;/code>: åœ¨ participant ä¸­ï¼Œåªæœ‰éµå€¼æœ‰è½å·®å°±ç®—ä¸€å€‹ deltaï¼Œå¾ delta æœ€å¤šçš„ participant é–‹å§‹é€ï¼Œæ‰€ä»¥æœ‰å¯èƒ½éƒ½é€çµ¦åŒä¸€å€‹ participant&lt;/li>
&lt;/ol>
&lt;h4 id="å¯¦é©—çµæœ">å¯¦é©—çµæœ&lt;/h4>
&lt;p>ç¸½å…± 128 participants èˆ‡ 64 çµ„ key/ valueï¼Œæ¯ç§’æ¯å€‹ participant gossip ä¸€æ¬¡ï¼›
å‰ 15 sec æš–æ©Ÿï¼Œä¸¦é–‹å§‹é™ç¸®é »å¯¬ / 25 ç§’é–‹å§‹åŠ å€æ›´æ–°é »ç‡ / 75 ç§’æ›´æ–°é »ç‡å›æ­¸æ­£å¸¸ / 120 sec åœæ­¢æ›´æ–°ï¼Œä¸­é–“ 25~75 åŠ å¤§æµé‡ä¸»è¦æ˜¯æƒ³è¦çœ‹æ¼”ç®—æ³•åœ¨é«˜è² è¼‰ä¸‹çš„è¡¨ç¾ï¼Œä»¥åŠé«˜å³°éå»å¾Œçš„æ¢å¾©é€Ÿåº¦&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201028/gossip.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>ç¬¬ä¸€å¼µåœ–è¡¨ä»£è¡¨é€™ä¸€å€‹æ™‚é–“ä¸Šï¼Œè©²éµå€¼è‡ªå¾ä¸Šæ¬¡è¢«æ›´æ–°å¾Œéš”äº†å¤šä¹…æ‰æ”¶åˆ°æœ€æ–°è³‡è¨Šï¼Œè¶Šä½è€…è¶Šå¥½&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>staleness of such a mapping Âµq (p)(k) is the amount of time that has lapsed since Âµq(p)(k) was last updated&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>ç¬¬äºŒå¼µåœ–è¡¨ä»£è¡¨é€™ä¸€å€‹æ™‚é–“æœ‰å¤šå°‘å€‹éµå€¼æ˜¯éæœŸçš„ ï¼Œè¶Šä½è€…è¶Šå¥½&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>reports the number of stale mappings as a function of time&lt;/p>
&lt;/blockquote>
&lt;p>äº¤å‰æ¯”å°æœ‰ä»¥ä¸‹çµè«–&lt;/p>
&lt;ol>
&lt;li>&lt;code>Scuttle-depth è¡¨ç¾å„ªç•°&lt;/code>&lt;/li>
&lt;li>Precise-newest å¯ä»¥çœ‹å‡ºæœ‰ starvation ç‹€æ³ï¼Œä¹Ÿå°±æ˜¯æœ‰éµå€¼å¾ˆä¹…æ²’æœ‰è¢«æ›´æ–° (åœ–ä¸€ä»–æœ€é«˜)ï¼Œä½†æ˜¯çœŸæ­£å½±éŸ¿åˆ°çš„éµå€¼å…¶å¯¦æ˜¯å°‘æ•¸ (åŒä¸€æ™‚é–“é»å…¶å¯¦éæœŸçš„éµå€¼æ•¸ä¸å¤š)ï¼Œä½†æ˜¯é«˜å³°éå»æ”¶æ–‚å¾ˆå¿«&lt;/li>
&lt;li>å…¶é¤˜å…©è€…è¡¨ç¾æ™®æ™®&lt;/li>
&lt;/ol>
&lt;h2 id="flow-control">Flow Control&lt;/h2>
&lt;p>åœ¨ä¸€äº›æƒ…æ³ä¸‹ï¼Œparticipant äº¤æ›è¨Šæ¯æ™‚æ›´æ–°é »ç‡å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æœƒéœ€è¦ä¸€å€‹æµé‡æ§åˆ¶çš„æ¼”ç®—æ³•ï¼Œå»å¹³è¡¡ä¸€å€‹ participant æƒ³è¦å¢åŠ æ›´æ–°é »ç‡è€Œå¦ä¸€å€‹æƒ³è¦é™ä½é »ç‡çš„å¯èƒ½ï¼Œè¦è£½é€ å‡ºé€™æ¨£çš„ä¸åŒæ›´æ–°é »ç‡ï¼Œä½†åŒæ™‚ç³»çµ±å¿…é ˆç¶­æŒç›¸åŒçš„æœ€å¤§äº¤æ›é »ç‡ä¸Šé™&lt;br>
åœ¨ participant äº¤æ› gossip æ™‚ï¼Œæœƒé€£å¸¶äº¤æ›å½¼æ­¤é è¨­æ›´æ–°çš„é »ç‡ (Ïp , Ïq)ä»¥åŠæœ€å¤§å€¼ (Ï„p,Ï„q )ï¼Œç•¶å…©å€‹ participant åœ¨äº¤æ›æ™‚æœƒé †ä¾¿äº¤æ›&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201028/flow1.png"
loading="lazy"
>&lt;/p>
&lt;p>æ©Ÿåˆ¶æœ‰é»é¡ä¼¼æ–¼ TCP çš„ Additive Increase Multiplicative Decrease (AIMD)ï¼Œé€æ¼¸å¢åŠ ç™¼é€çš„é »ç‡ä½†é‡åˆ°éŒ¯èª¤æ™‚å¿«é€Ÿæ¸›å°‘ï¼›&lt;br>
å¦‚æœè¦ç™¼é€çš„ delta æ•¸é‡é«˜æ–¼ MTUï¼Œå‰‡ç·šæ€§å¢åŠ ï¼Œåä¹‹ï¼Œå‰‡å€æ•¸æ¸›å°‘&lt;/p>
&lt;p>å¯¦é©—éç¨‹æ˜¯åœ¨ t = 90 æ™‚é™ç¸® mtu å¾ 100 é™åˆ° 50ï¼Œå¯ä»¥çœ‹åˆ° 90 ä¹‹å¾Œ max out of date å¤§å¹…å¢åŠ ï¼Œä¹‹å¾Œæ‰æ…¢æ…¢æ”¶æ–‚ï¼Œå…¶ä¸­ scuttle-depth åœ¨è¡¨ç¾ä¸Šæ¯”è¼ƒç©©å®š &lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201028/exp2.png"
loading="lazy"
>&lt;/p>
&lt;p>é€™ä¸€ç« ç¯€æ¯”è¼ƒä¸ç¢ºå®šï¼Œå¦‚æœæœ‰ä»€éº¼éŒ¯èª¤éº»ç…©æŒ‡æ•™ ğŸ™&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>æœ¬ç¯‡æå‡ºå…©å€‹é‡é»&lt;/p>
&lt;ol>
&lt;li>æ–°çš„ reconciliation æ©Ÿåˆ¶ï¼ŒåŠ é€ŸåŒæ­¥çš„æ•ˆç‡ï¼ŒåŒæ™‚é¿å… starvation&lt;/li>
&lt;li>å¼•å…¥ flow control æ©Ÿåˆ¶ï¼Œè®“ participant å¯ä»¥ç”¨åˆç†çš„é€Ÿåº¦æ›´æ–°&lt;/li>
&lt;/ol>
&lt;h2 id="å¯¦ä½œé¢">å¯¦ä½œé¢&lt;/h2>
&lt;p>ç¶²è·¯ä¸Šæ‰¾äº†ä¸€å€‹ nodejs ç‰ˆæœ¬çš„ gossip protocol å¯¦ä½œ &lt;a class="link" href="https://github.com/bpot/node-gossip" target="_blank" rel="noopener"
>node-gossip&lt;/a>ï¼Œçœ‹èµ·ä¾†æ˜¯ä½¿ç”¨ scuttle-depth å”è­°æ©Ÿåˆ¶
è¨ˆç®—èˆ‡ peer ä¸­çš„ delta æœ€å¤šçš„ï¼Œæ¥è‘—å…ˆæŒ‰ç…§ peer ä¸­æœ€èˆŠçš„ version é–‹å§‹æ’åº&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Sort by peers with most deltas
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">deltas_with_peer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">deltas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nx">deltas_with_peer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">peer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">deltas_with_peer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">peer_deltas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">peer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deltas&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Sort deltas by version number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// console.log(peer_deltas);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">j&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">delta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">delta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">unshift&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">peer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">peer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delta&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Gossip Protocol ä»‹ç´¹ (ä¸Š) - å¾ Cassandra å…§éƒ¨å¯¦ä½œèªè­˜ Gossip Protocol çš„ä½¿ç”¨</title><link>https://yuanchieh.page/posts/2020/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8A-%E5%BE%9E-cassandra-%E5%85%A7%E9%83%A8%E5%AF%A6%E4%BD%9C%E8%AA%8D%E8%AD%98-gossip-protocol-%E7%9A%84%E4%BD%BF%E7%94%A8/</link><pubDate>Mon, 26 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8A-%E5%BE%9E-cassandra-%E5%85%A7%E9%83%A8%E5%AF%A6%E4%BD%9C%E8%AA%8D%E8%AD%98-gossip-protocol-%E7%9A%84%E4%BD%BF%E7%94%A8/</guid><description>&lt;p>Gossip Protocol æ˜¯ä¸€ç¨®é€šè¨Šæ©Ÿåˆ¶ï¼Œæ‡‰ç”¨æ–¼åŒä¸€ç¶²è·¯å…§æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“äº¤æ›è¨Šæ¯ï¼ŒåŸç†é¡ä¼¼æ–¼è¾¦å…¬å®¤å‚³è¬ è¨€ä¸€æ¨£ï¼Œä¸€å€‹å‚³ä¸€å€‹ï¼Œæœ€çµ‚æ¯ä¸€å€‹æ©Ÿå™¨éƒ½æ“æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œåˆç¨± &lt;code>Epidemic Protocol&lt;/code>&lt;/p>
&lt;p>å¯¦å‹™ä¸Šæœ‰å¹¾å€‹å¥½è™•&lt;/p>
&lt;ol>
&lt;li>å»ä¸­å¿ƒåŒ–:&lt;br>
æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“ç›´æ¥æºé€š (peer to peer)&lt;/li>
&lt;li>å®¹éŒ¯ç‡é«˜:&lt;br>
å³ä¾¿ç¯€é»èˆ‡ç¯€é»ä¹‹é–“ç„¡æ³•ç›´æ¥ç›¸é€£ï¼Œåªæœ‰æœ‰å…¶ä»– ç¯€é» å¯ä»¥å‚³éç‹€æ…‹ï¼Œä¹Ÿå¯ä»¥ç¶­æŒä¸€è‡´çš„ç‹€æ…‹&lt;/li>
&lt;li>æ•ˆç‡é«˜ä¸”å¯é &lt;/li>
&lt;/ol>
&lt;p>Gossip Protocol è¢«å»£æ³›æ¡ç´ï¼Œå¦‚Cassandra / Redis Cluster / Consul ç­‰é›†ç¾¤æ¶æ§‹ï¼Œä»¥ä¸‹å°‡å¾ Cassandra çš„å¯¦ä½œä¾†ç†è§£ Gossip Protocol&lt;/p>
&lt;h2 id="apple-inc-cassandra-internals--understanding-gossip">Apple Inc.: Cassandra Internals â€” Understanding Gossip&lt;/h2>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/FuP1Fvrv6ZQ"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>å…ˆå¾å¯¦å‹™é¢ä¾†çœ‹ï¼ŒGossip Protocol åœ¨ Cassandra ä¸­ä¸»è¦ç”¨æ–¼åŒæ­¥ ç¯€é» çš„ Metadataï¼ŒåŒ…å«&lt;/p>
&lt;ol>
&lt;li>cluster membership&lt;/li>
&lt;li>heartbeat&lt;/li>
&lt;li>node status&lt;br>
åŒæ™‚æ¯å€‹ç¯€é»éƒ½æœƒä¿å­˜ä¸€ä»½å…¶ä»–ç¯€é»ç‹€æ…‹çš„ Mapping Table&lt;/li>
&lt;/ol>
&lt;p>æ›´å…·é«”ä¾†çœ‹ç¯€é»ç‹€æ…‹æ‰€ä¿å­˜çš„è³‡æ–™æ ¼å¼&lt;/p>
&lt;ol>
&lt;li>HeartbeatState:&lt;br>
æ¯ä¸€å€‹ç¯€é»æœƒæœ‰ä¸€å€‹ HeartbeatStateï¼Œç´€éŒ„ generation / versionï¼Œ&lt;code>generation&lt;/code> æ˜¯ç¯€é»å•Ÿå‹•æ™‚çš„ timestampï¼Œç”¨ä¾†å€åˆ†æ©Ÿå™¨æ˜¯å¦é‡æ–°å•Ÿå‹•éï¼›&lt;code>version&lt;/code> å‰‡æ˜¯éå¢æ•¸å€¼ï¼Œæ¯æ¬¡ ApplicationState æœ‰å€¼æ›´æ–°æ™‚å°±æœƒéå¢&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>æ‰€ä»¥åŒä¸€å€‹ç¯€é»å…§çš„ ApplicationState version ä¸æœƒé‡è¤‡ï¼Œä¸” version æ¯”è¼ƒå¤§ä¸€å®šä»£è¡¨é€™å€‹éµå€¼æ¯”è¼ƒæ–°&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>ApplicationState: ä¸€å€‹ç”±&lt;code>{enum_name, value, version}&lt;/code>å»ºç«‹çš„ tupleï¼Œenum_name ä»£è¡¨å›ºå®šçš„ key åç¨±ï¼Œversion å‰‡è¡¨ç¤º value çš„ç‰ˆæœ¬è™Ÿç¢¼ï¼Œè™Ÿç¢¼å¤§è€…å‰‡ä»£è¡¨è³‡æ–™è¼ƒæ–°&lt;/li>
&lt;li>EndpointState: ç´€éŒ„æŸä¸€å€‹ç¯€é»ä¸‹æ‰€æœ‰çš„ ApplicationState&lt;/li>
&lt;li>EndpointStateMapping: ä¸€å€‹ç¯€é»æœƒæœ‰ä¸€å¼µé‡å°å·²çŸ¥çš„ç¯€é»æ‰€ç´€éŒ„çš„ EndpointStateï¼ŒåŒæ™‚æœƒåŒ…å«è‡ªå·±çš„ç‹€æ…‹&lt;/li>
&lt;/ol>
&lt;p>å¦‚ä¸‹åœ–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259909635, version &lt;span class="m">325&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version &lt;span class="m">45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">87&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259911052, version &lt;span class="m">61&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 2.7, generation 1259911052, version &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">31&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šå¯ä»¥çœ‹åˆ°ç¯€é» 10.0.0.1 æ‰€ä¿å­˜çš„ &lt;code>EndPointStateMap&lt;/code> æœ‰å…©ç­† EndPointStateï¼Œå…¶ä¸­ 10.0.0.1 çš„ HeartBeatState æ˜¯ &lt;code>generation 1259909635, version 325&lt;/code>ï¼Œé€™ä»£è¡¨ 10.0.0.1 æ˜¯åœ¨ 1259909635 æ™‚å•Ÿå‹•çš„ï¼Œä¸¦ä¸”ä»–ç›®å‰ä¿å­˜æ¬„ä½ä¸­æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ 325ï¼›&lt;br>
æ¥è‘—çœ‹ &lt;code>ApplicationState &amp;quot;load-information&amp;quot;: 5.2, generation 1259909635, version 45&lt;/code>ï¼Œé€™ä»£è¡¨ç¯€é»å…§ &amp;ldquo;load-information&amp;rdquo; é€™å€‹ Key å°æ‡‰çš„å€¼æ˜¯ 5.2 ä»¥åŠç•¶æ™‚æ”¶åˆ°çš„ generation èˆ‡ versionï¼Œå¾Œå…©è€…ç”¨ä¾†æ±ºå®š &lt;code>é€™å€‹ key æ”¶åˆ°è¨Šæ¯å¾Œè¦ä¸è¦æ›´æ–°çš„ä¾æ“š&lt;/code>&lt;/p>
&lt;h3 id="gossip-messaging">Gossip Messaging&lt;/h3>
&lt;p>æ¥è‘—ä¾†çœ‹æ¯æ¬¡ Gossip çš„å¯¦ä½œæµç¨‹ï¼Œæ¯å€‹ç¯€é»æœƒåœ¨æ¯ä¸€ç§’å•Ÿå‹•ä¸€å€‹æ–°çš„ gossip å›åˆ&lt;/p>
&lt;ol>
&lt;li>æŒ‘å‡º &lt;code>1~3&lt;/code> çš„ç¯€é»ï¼Œå„ªå…ˆé¸æ“‡ live ç‹€æ…‹çš„ç¯€é»ï¼Œæ¥è‘—æœƒæ©Ÿç‡æ€§é¸æ“‡ Seed ç¯€é» / å…ˆå‰åˆ¤å®šå·²ç¶“é›¢ç¶«çš„ç¯€é»&lt;/li>
&lt;li>å‚³éè¨Šæ¯çš„æµç¨‹æ˜¯ SYN / ACK / ACK2 (é¡ä¼¼æ–¼ TCP çš„3æ¬¡äº¤æ¡)&lt;/li>
&lt;/ol>
&lt;p>å‡è¨­ç¾åœ¨æ˜¯ç¯€é» A è¦å‚³è¨Šæ¯çµ¦ ç¯€é» B é—œæ–¼ç¯€é» C çš„ Gossip&lt;/p>
&lt;ol>
&lt;li>&lt;strong>GossipDigestSynMessage&lt;/strong> :&lt;br>
ç¯€é» A è¦ç™¼é€çš„ SYN è¨Šæ¯åŒ…å« &lt;code>{ipAddr, generation, heartbeat}&lt;/code>ï¼Œéœ€æ³¨æ„æ­¤æ™‚åªè¦é€ HeartbeatStateï¼Œè€Œæ²’æœ‰é€è©³ç´°çš„ ApplicationStateï¼Œé¿å…å¤šé¤˜çš„è³‡æ–™å‚³è¼¸&lt;/li>
&lt;li>&lt;strong>GossipDigestAckMessage&lt;/strong> :&lt;br>
ç¯€é» B æ”¶åˆ°å¾Œï¼Œæœƒå»æ¯”å°ä»–è‡ªå·±æš«å­˜ç¯€é» C çš„ç‹€æ…‹ï¼Œé‹ç®—å…©è€…å·®ç•° &lt;br>
a. ç¯€é» A çš„è³‡æ–™æ¯”è¼ƒæ–°ï¼Œå‰‡ç¯€é» B æœƒæº–å‚™è·Ÿç¯€é» A è¦æ–°çš„è³‡æ–™&lt;br>
b. ç¯€é» B çš„è³‡æ–™æ¯”è¼ƒæ–°ï¼Œæ‰“åŒ…è¦æ›´æ–°çš„ ApplicationState å›å‚³ &lt;code>ACK&lt;/code> é€šçŸ¥ç¯€é» A&lt;/li>
&lt;li>&lt;strong>GossipDigestAck2Message&lt;/strong> :&lt;br>
ç¯€é» A æ”¶åˆ° ACK å¾Œï¼Œæ›´æ–°è‡ªå·±æš«å­˜çš„è³‡æ–™ï¼Œä¸¦ä¸”æ ¹æ“š (2.a) ä¸­ç¯€é» B æ‰€éœ€è¦çš„ ApplicationStateï¼Œå›å‚³ &lt;code>ACK2&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æœƒå¤šä¸€å€‹ &lt;code>ACK2&lt;/code> æ˜¯ç‚ºäº†è®“é€šè¨Šæ›´ç©©å®šï¼Œé”åˆ°æ›´å¿«æ”¶æ–‚çš„ä½œç”¨ï¼Œä½†é€™é‚Šå¦‚æœ ç¯€é» B æ²’æ”¶åˆ° ACK2 æ˜¯å¦æœƒé‡è©¦ç­‰å¦‚åŒ TCP ä½œæ³•å°±æ²’æœ‰æåŠ&lt;/p>
&lt;blockquote>
&lt;p>ç¸½çµä¾†çœ‹å‚³é€è¨Šæ¯çš„éç¨‹ï¼Œåœ¨ Cluster æ²’æœ‰ç¯€é»ç‹€æ…‹ç•°å‹•ä¸‹ï¼Œå‚³é€çš„è¨Šæ¯é‡æ˜¯å›ºå®šçš„ï¼Œä¸æœƒæœ‰ &lt;code>Gossip Storm&lt;/code> ç¶²è·¯å°åŒ…çªç„¶çˆ†é‡çš„æƒ…æ³ï¼› &lt;br>
é™¤éæ˜¯æœ‰ç¯€é» æ–°åŠ å…¥ï¼Œå¤šå€‹ç¯€é» å¸Œæœ›åŒæ­¥è³‡è¨Šæ‰æœ‰å¯èƒ½&lt;/p>
&lt;/blockquote>
&lt;p>ä¾†çœ‹å¯¦éš›æ¡ˆä¾‹ï¼Œå‡è¨­
ç›®å‰æœ‰ç¯€é»A (10.0.0.1)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259909635, version &lt;span class="m">325&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version &lt;span class="m">45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">87&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259911052, version &lt;span class="m">61&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 2.7, generation 1259911052, version &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">31&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259912238, version &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 12.0, generation 1259912238, version &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259912942, version &lt;span class="m">18&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 6.7, generation 1259912942, version &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bj05IVc0lvRXw2xH, generation 1259912942, version &lt;span class="m">7&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥åŠç¯€é»B (10.0.0.2)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259909635, version &lt;span class="m">324&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version &lt;span class="m">45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">87&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259911052, version &lt;span class="m">63&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 2.7, generation 1259911052, version &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">31&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">62&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259812143, version &lt;span class="m">2142&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 16.0, generation 1259812143, version &lt;span class="m">1803&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: W2U1XYUC3wMppcY7, generation 1259812143, version &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="ç¯€é»a-æ±ºå®šå‘ç¯€é»b-ç™¼èµ·-gossip">ç¯€é»A æ±ºå®šå‘ç¯€é»B ç™¼èµ· Gossip&lt;/h4>
&lt;p>ç”¢ç”Ÿçš„ GossipDigestSynMessage æœƒæ˜¯é¡ä¼¼æ–¼ &lt;code>10.0.0.1:1259909635:325 10.0.0.2:1259911052:61 10.0.0.3:1259912238:5 10.0.0.4:1259912942:18&lt;/code>ï¼Œä¸»è¦æ˜¯å‚³é€ &lt;code>Node IP:generation:version&lt;/code>&lt;/p>
&lt;h4 id="ç¯€é»b-æ”¶åˆ°-gossipdigestsynmessage">ç¯€é»B æ”¶åˆ° GossipDigestSynMessage&lt;/h4>
&lt;p>æœƒæœ‰ä»¥ä¸‹æµç¨‹&lt;/p>
&lt;ol>
&lt;li>è·Ÿè‡ªå·±çš„ç‹€æ…‹æ¯”è¼ƒï¼Œå¾å·®ç•°æœ€å¤šçš„éæ¸›æ’åºï¼Œé€™æ„å‘³è‘—å„ªå…ˆè™•ç†å·®ç•°æœ€å¤šçš„ç¯€é»è³‡è¨Š&lt;/li>
&lt;li>æ¥è‘—æª¢é©—æ¯ä¸€å€‹ç¯€é»çš„è³‡æ–™
-ç¯€é»A æ‰€ä¿å­˜çš„ &lt;code>10.0.0.1:1259909635:325&lt;/code> æœƒå¤§æ–¼ç¯€é»B æ‰€ä¿å­˜çš„&lt;code>10.0.0.1:1259909635:324&lt;/code>ï¼Œgeneration ä¸€æ¨£æ‰€ä»¥ç•¥éï¼Œä½†æ˜¯ version 325 &amp;gt; 324ï¼Œå‰‡ä»£è¡¨ç¯€é»B éœ€è¦å‘ç¯€é» A ç´¢å– 10.0.0.1 åœ¨ ApplicationState åœ¨ç‰ˆæœ¬ 324 ä¹‹å¾Œçš„è³‡æ–™
&lt;ul>
&lt;li>&lt;code>10.0.0.2:1259911052:61&lt;/code> æ¯”ç¯€é»B ä¿å­˜çš„ç‰ˆæœ¬é‚„è¦å°ï¼Œæ‰€ä»¥åˆ°æ™‚å€™æœƒæ‰“åŒ…è³‡æ–™çµ¦ç¯€é»A&lt;/li>
&lt;li>&lt;code>10.0.0.3:1259912238:5&lt;/code> éƒ¨åˆ†ç¯€é»B generation æ¯”è¼ƒå°ï¼Œé€™æ„å‘³è‘— 10.0.0.3 æœ‰ reboot éï¼Œæ‰€ä»¥ç¯€é»B éœ€è¦æ›´æ–°å…¨éƒ¨çš„è³‡æ–™&lt;/li>
&lt;li>&lt;code>10.0.0.4:1259912942:18&lt;/code>ç¯€é»B æ ¹æœ¬æ²’æœ‰ 10.0.0.4 çš„è³‡æ–™ï¼Œæ‰€ä»¥éœ€è¦å…¨éƒ¨çš„è³‡æ–™&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>çµ„åˆä»¥ä¸Šçµæœ GossipDigestAckMessageçš„å…§å®¹æœƒæ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">10.0.0.1:1259909635:324
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.3:1259912238:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.4:1259912942:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.2:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version 62&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState, generation 1259911052, version 63&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™ä»£è¡¨è‘—&lt;/p>
&lt;ul>
&lt;li>è«‹çµ¦æˆ‘ 10.0.0.1 åœ¨ generation 1259909635 ä¸­ version 324 ä»¥å¾Œçš„æ›´æ–°è³‡æ–™&lt;/li>
&lt;li>è«‹çµ¦æˆ‘ 10.0.0.3 åœ¨ generation 1259912238 å…¨éƒ¨è³‡æ–™ (version:0)&lt;/li>
&lt;li>10.0.0.4 åŒä¸Š&lt;/li>
&lt;li>é€™æ˜¯ä½ éœ€è¦æ›´æ–°é—œæ–¼ 10.0.0.2 çš„ ApplicationState è³‡æ–™&lt;/li>
&lt;/ul>
&lt;h4 id="ç¯€é»a-å›è¦†-gossipdigestack2message">ç¯€é»A å›è¦† GossipDigestAck2Message&lt;/h4>
&lt;p>ç¯€é»A æ”¶åˆ°å¾Œï¼Œæ›´æ–°å®Œ 10.0.0.2 çš„è³‡è¨Šå¾Œï¼Œæ¥è‘—å›è¦†ç¯€é»B æ‰€è¦çš„è³‡æ–™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">10.0.0.1:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version 45&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version 56&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version 87&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState, generation 1259909635, version 325&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.3:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 12.0, generation 1259912238, version 3&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState, generation 1259912238, version 3&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.4:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 6.7, generation 1259912942, version 3&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bj05IVc0lvRXw2xH, generation 1259912942, version 7&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState: generation 1259912942, version 18&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£å°±å®Œæˆä¸€è¼ªçš„ Gossip äº†&lt;/p>
&lt;blockquote>
&lt;p>å¯ä»¥çœ‹å‡ºç‚ºä»€éº¼ HeartbeatState çš„ version æœƒèˆ‡ ApplicationState å…±äº«ï¼Œé€™é‚Šçš„å…±äº«æŒ‡çš„æ˜¯åœ¨&lt;code>åŒä¸€å€‹ç¯€é»ä¸‹ ApplicationState çš„ version å¿…é ˆæ˜¯ç¨ä¸€ç„¡äºŒä¸”éå¢&lt;/code>ï¼Œé€™æ¨£æ‰èƒ½åœ¨ SYN æ™‚åªå‚³é€ HeartbeatState ç›´æ¥åˆ¤æ–·æœ‰å“ªäº›æ¬„ä½éœ€è¦æ›´æ–°&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥ä¸Šç¯„ä¾‹æ•´ç†è‡ª &lt;a class="link" href="https://cwiki.apache.org/confluence/display/CASSANDRA2/ArchitectureGossip" target="_blank" rel="noopener"
>ArchitectureGossip&lt;/a>&lt;/p>
&lt;h2 id="å…¶ä»–é›†ç¾¤ä¸Šçš„ç®¡ç†">å…¶ä»–é›†ç¾¤ä¸Šçš„ç®¡ç†&lt;/h2>
&lt;p>é›†ç¾¤ç®¡ç†ä¸Šï¼Œé™¤äº†é€é Gossip Protocol åŒæ­¥è³‡è¨Šå¤–ï¼Œé‚„æœ‰å¹¾å€‹å•é¡Œè¦è§£æ±º&lt;/p>
&lt;ol>
&lt;li>èª°åœ¨ Cluster ç•¶ä¸­&lt;/li>
&lt;li>å¦‚ä½•æ±ºå®šç¯€é»çš„ç‹€æ…‹æ˜¯ Up / Downï¼Œé€™åˆæœƒå¸¶ä¾†ä»€éº¼å½±éŸ¿&lt;/li>
&lt;li>ä½•æ™‚è¦çµ‚æ­¢è·ŸæŸç¯€é»çš„é€šè¨Š&lt;/li>
&lt;li>æ‡‰è©²è¦åå¥½èˆ‡å“ªå€‹ç¯€é»é€šè¨“&lt;/li>
&lt;li>å¢åŠ /ç§»é™¤/åˆªé™¤/å–ä»£ç¯€é»æ™‚å¦‚ä½•å¯¦ä½œ&lt;/li>
&lt;/ol>
&lt;h3 id="èª°åœ¨-cluster-ç•¶ä¸­">èª°åœ¨ Cluster ç•¶ä¸­&lt;/h3>
&lt;p>ç•¶ä¸€å€‹æ–°çš„ç¯€é»è¦å•Ÿå‹•æ™‚ï¼Œä»–å¿…é ˆè¦çŸ¥é“é›†ç¾¤ä¸­æœ‰å“ªäº›ç¯€é»å» Gossipï¼Œåœ¨ Cassandra çš„è¨­å®šæª”ä¸­å¯ä»¥æŒ‡å®š &lt;code>Seed&lt;/code>ï¼Œæœ‰ä¸åŒçš„ä½œæ³•å¯ä»¥æŒ‡å®šï¼Œå¸¸è¦‹æ˜¯å¯«æ­»æŸä¸€äº›ç¯€é»çš„ ip addrï¼Œç¯€é»å•Ÿå‹•å¾Œå°±è·Ÿ Seed ç¯€é»æºé€šï¼Œå¾ŒçºŒå°±é€é Gossip Protocol å–å¾—æ‰€æœ‰ç¯€é»çš„ç‹€æ…‹èˆ‡ IP&lt;/p>
&lt;blockquote>
&lt;p>åœ¨ Consul ä¸­ï¼Œæœƒè‡ªå·±é€éå»£æ’­åœ¨ LAN è£¡é¢è‡ªå‹•ç™¼ç¾æœ‰æ²’æœ‰å…¶ä»–ç¯€é»ï¼Œåœ¨ EC2 ä¸Šé‚„å¯ä»¥æŒ‡å®š EC2 Tag å»æ‰¾å‡ºå…¶ä»–ç¯€é»&lt;/p>
&lt;/blockquote>
&lt;h3 id="failure-detection-æ±ºå®šç¯€é»æ˜¯-up-æˆ–-down">Failure Detection: æ±ºå®šç¯€é»æ˜¯ Up æˆ– Down&lt;/h3>
&lt;p>åœ¨ Cassandra ä¸­ï¼ŒéŒ¯èª¤åµæ¸¬æ˜¯è©²ç¯€é»åœ¨æœ¬åœ°ç«¯æ±ºå®šæŸç¯€é»çš„ç‹€æ…‹ï¼Œè€Œé€™å€‹ç‹€æ…‹ä¸æœƒéš¨è‘— Gossip æ‰€å‚³é€&lt;/p>
&lt;blockquote>
&lt;p>ex.ç¯€é»A è¦ºå¾—ç¯€é»B æ˜¯ Downï¼Œç•¶ç¯€é»A è·Ÿç¯€é»C Gossip æ™‚ï¼Œç¯€é»C ä¸æœƒå› ç‚ºç¯€é»A è€ŒæŠŠç¯€é»B åˆ¤æ–·æˆ Downï¼Œç¯€é» C æœƒè‡ªè¡Œåˆ¤æ–·&lt;/p>
&lt;/blockquote>
&lt;p>åµæ¸¬çš„æ–¹å¼é€é Heartbeatï¼ŒHeartbeat å¯ä»¥æ˜¯ç¯€é»è·Ÿç¯€é»ç›´æ¥ç”¨ Gossip é€šè¨Šï¼Œä¹Ÿå¯ä»¥æ˜¯å¾å…¶ä»–ç¯€é»é–“æ¥å–å¾— Gossipï¼›&lt;br>
ç¯€é»æœƒè¨ˆç®—æ¯æ¬¡ Heartbeat çš„é–“éš”ï¼Œç•¶è¶…é &lt;code>phi_convict_threshold&lt;/code> å‰‡åˆ¤å®šç‚º Downï¼Œç³»çµ±éœ€è¦å› æ‡‰ç¡¬é«”ç‹€æ…‹/ç¶²è·¯ç’°å¢ƒå»èª¿æ•´é–¥å€¼ï¼Œé¿å…å¤ªæ•æ„Ÿèª¤åˆ¤æˆ–æ˜¯å¤ªé²éˆè€Œåæ‡‰ä¸åŠç­‰ç‹€æ³&lt;/p>
&lt;p>åœ¨ç¯€é»æ–·ç·šçš„æ™‚å€™ï¼Œå…¶ä»–ç¯€é»éƒ¨åˆ†çš„å¯«å…¥å¯èƒ½å› æ­¤æ²’æœ‰æ”¶åˆ° ACK å›è¦†ï¼Œæ­¤æ™‚æœƒæš«å­˜åœ¨æœ¬åœ°ç•¶ä½œ Hintï¼Œå¦‚æœç¯€é»åœ¨ä¸€å®šæ™‚é–“å…§æ¢å¾©ï¼Œå‰‡æœƒé€é Hint é‡æ–°å‚³é€å¯«å…¥ï¼Œä¿®å¾©æ‰è³‡æ–™çš„å¯èƒ½&lt;/p>
&lt;p>å¦‚æœç¯€é»é‡æ–°æ¢å¾©æ™‚ï¼Œå…¶ä»–ç¯€é»æœƒå®šæœŸé‡é€ Gossip çµ¦ Offline ç¯€é»ï¼Œå±†æ™‚å°±èƒ½æŠŠ Down èª¿æ•´å› Up&lt;/p>
&lt;h3 id="ç¯€é»åå¥½">ç¯€é»åå¥½&lt;/h3>
&lt;p>é™¤äº†éŒ¯èª¤åµæ¸¬å¤–ï¼ŒCassandra å…§éƒ¨æœ‰æ¨¡çµ„ Dynamic Snitch å°ˆé–€åšç¯€é»é–“çš„é€šè¨Šå“è³ªåµæ¸¬ï¼Œæ¯ 100 msè¨ˆç®—èˆ‡å…¶ä»–ç¯€é»çš„å»¶é²ï¼Œè—‰æ­¤æ‰¾å‡ºè¡¨ç¾è¼ƒå¥½çš„ç¯€é»ï¼›&lt;br>
ç‚ºäº†é¿å…ä¸€æ™‚ç¶²è·¯æ³¢å‹•ï¼Œæ¯ 10 åˆ†é˜å°±æœƒé‡æ–°è¨ˆç®—&lt;/p>
&lt;p>å…¶é¤˜çš„ç¯€é»ç®¡ç†å°±æš«æ™‚ç•¥éï¼Œå°æ–¼ç†è§£ Gossip Protocol ä¸å¤§&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œç¯€é»çš„ç‹€æ…‹åŒæ­¥ååˆ†åŸºç¤ä¸”é‡è¦ï¼Œè€Œ Gossip Protocol ç›®å‰æ˜¯è¢«å»£æ³›æ‡‰ç”¨çš„è§£æ³•ï¼Œæ¨¡æ“¬äººé¡å‚³é€å…«å¦çš„æ–¹å¼ï¼Œæƒ³ä¸åˆ°åœ¨æ©Ÿå™¨ä¹Ÿä¸€æ¨£é©ç”¨&lt;br>
æ•´é«”æœ€æœ‰è¶£çš„è¨­è¨ˆæ‡‰è©²åœ¨æ–¼ &lt;code>generation / version&lt;/code> çš„å¯¦ä½œï¼Œé€é generation å¯ä»¥çŸ¥é“æ©Ÿå™¨é‡å•Ÿéå¾Œè¦ä¸è¦é‡æ–°è¦è³‡æ–™ï¼›é€é version å¯ä»¥å¿«é€Ÿ diff åƒ…æœ‰å“ªäº›è³‡æ–™è¦æ›´æ–°ï¼Œé¿å…é¡å¤–çš„å‚³è¼¸æµªè²»ï¼Œä¸‹ä¸€ç¯‡å°‡å¾ç†è«–ä¸Šå»åˆ†æ Gossip Protocol&lt;/p></description></item><item><title>ä½¿ç”¨ Redis ç•¶ä½œ API Rate limit çš„ä¸‰ç¨®æ–¹æ³•</title><link>https://yuanchieh.page/posts/2020/2020-10-18-%E4%BD%BF%E7%94%A8-redis-%E7%95%B6%E4%BD%9C-api-rate-limit-%E7%9A%84%E4%B8%89%E7%A8%AE%E6%96%B9%E6%B3%95/</link><pubDate>Sun, 18 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-18-%E4%BD%BF%E7%94%A8-redis-%E7%95%B6%E4%BD%9C-api-rate-limit-%E7%9A%84%E4%B8%89%E7%A8%AE%E6%96%B9%E6%B3%95/</guid><description>&lt;p>æœ€è¿‘å…¬å¸ API æœå‹™è¢« Client ä¸é æœŸçš„é«˜é »å­˜å–ï¼Œé€ æˆå¾Œç«¯ DB å¾ˆå¤§çš„è² æ“”ï¼Œé–‹å§‹è©•ä¼°å„ç¨® API Rate Limit çš„æ–¹æ¡ˆï¼Œå…¶ä¸­ä¸€å€‹æœ€å¸¸è¦‹çš„ä½œæ³•å°±æ˜¯é  Redisï¼Œä½†å…·é«”çš„æ–¹æ¡ˆå…¶å¯¦æœ‰è »å¤šç¨®ï¼Œåƒè€ƒä»¥ä¸‹å½±ç‰‡æ•´ç†ä¸‰ç¨®ä½œæ³•&lt;/p>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/HnSb8DFU5UA"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>é †ä¾¿æ¨è–¦ä¸€ä¸‹ RedisLabs æ‰€æ¨å‡ºçš„ GUI ç®¡ç†å·¥å…· &lt;code>RedisInsights&lt;/code>ï¼Œå¯ä»¥å¿«é€Ÿåˆ†æ Redis ä¸­ Key Space çš„ä½¿ç”¨ / Profiling ä¸€æ®µæ™‚é–“å…§å“ªäº› Key è¢«å¤§é‡å­˜å–ç­‰ç­‰ï¼ŒåŸºæœ¬çš„ Redis CLI æ“ä½œå°±æ›´ä¸ç”¨æäº†ï¼Œå°æ¯”ä¹‹å‰ç”¨çš„ &lt;code>medis&lt;/code> åŠŸèƒ½å¼·åŒ–ä¸å°‘ï¼Œå°¤å…¶æ˜¯&lt;code>ç®¡ç†/ç›£æ§é€™ä¸€å¡Šçš„åŠŸèƒ½&lt;/code>&lt;br>
ç›®å‰æ˜¯å…è²»çš„ï¼Œæ”¯æ´ Cluster Modeï¼Œé€£æ¥ AWS ElasticCache ä¹Ÿæ²’å•é¡Œï¼Œååˆ†æ¨è–¦&lt;/p>
&lt;h2 id="rate-limit-å…¨è§€">Rate Limit å…¨è§€&lt;/h2>
&lt;p>è¦è¨­è¨ˆ Rate Limit æ©Ÿåˆ¶æ™‚éœ€è¦è€ƒé‡å¹¾å€‹é¢å‘&lt;/p>
&lt;h3 id="who">Who&lt;/h3>
&lt;p>è©²å¦‚ä½•è­˜åˆ¥è¦é™åˆ¶çš„å°è±¡ï¼Ÿ&lt;br>
æœ€ç›´è¦ºæ˜¯é€é IPï¼Œä½†æ˜¯ä½¿ç”¨ IP æœ€å¤§çš„é¢¨éšªæ˜¯ å¦‚æœæ˜¯å¤§å®¢æˆ¶ï¼Œä»–ä¸€å€‹äººçš„æµé‡é è¶…éå…¶ä»–å°å®¢æˆ¶ï¼Œå°å…¬å¸çš„åƒ¹å€¼é¡¯ç„¶ä¹Ÿæ˜¯é é é‡è¦ï¼Œå¦‚æœç”¨ IP å¾ˆå®¹æ˜“æœ‰èª¤æ®ºçš„æƒ…æ³ï¼ŒæŠŠæœ‰åƒ¹å€¼çš„ç”¨æˆ¶é˜»æ“‹åœ¨å¤–&lt;/p>
&lt;p>å…¶ä»–çš„ä½œæ³•å¯ä»¥ç”¨ JWT Token / API Key ç­‰å€‹åˆ¥ç”¨æˆ¶è­˜åˆ¥çš„æ–¹å¼ï¼Œéœ€è¦é‡å°è‡ªå®¶çš„æ¥­å‹™å ´æ™¯å»åˆ¤æ–·&lt;/p>
&lt;h3 id="how">How&lt;/h3>
&lt;p>è©²ä½¿ç”¨æ€æ¨£çš„æ–¹å¼è¨ˆç®—é™åˆ¶çš„æ–¹å¼ï¼Ÿ&lt;br>
é€šå¸¸æ˜¯åœ¨æŸå€‹æ™‚é–“å€æ®µå…§ï¼Œé™åˆ¶åªèƒ½å­˜å–å¤šå°‘æ¬¡çš„è¨ˆç®—æ¨¡å¼ï¼Œæœ‰ä¸‰ç¨®æ–¹å¼å¯ä»¥åƒè€ƒ&lt;/p>
&lt;h3 id="static-time-window---å›ºå®šæ™‚é–“å€æ®µ">static time window - å›ºå®šæ™‚é–“å€æ®µ&lt;/h3>
&lt;p>ä¾‹å¦‚èªªæ¯ä¸€åˆ†é˜ç‚ºä¸€å€‹å–®ä½ï¼Œé€™ä¸€åˆ†é˜å…§åªèƒ½å­˜å–äº”æ¬¡&lt;br>
é€™æ¨£çš„æ–¹å¼ååˆ†ç°¡å–®ï¼Œä½†å¯èƒ½æœƒæœ‰çŸ­æ™‚é–“å…§è¶…é‡çš„å•é¡Œï¼Œä¾‹å¦‚èªª 0:59 å­˜å– 4 æ¬¡ï¼Œæ¥è‘— 1:01 å­˜å–4 æ¬¡ï¼Œåˆ†é–‹åœ¨å…©å€‹æ™‚é–“å€æ®µéƒ½æ˜¯åˆæ³•ï¼Œä½†æ˜¯æ‰éš”å…©ç§’å°±å­˜å– 8 æ¬¡ï¼Œé€™å¯èƒ½ä¸æœƒæ˜¯å¸Œæœ›çš„çµæœ&lt;/p>
&lt;p>å¯¦ä½œæ–¹å¼ï¼Œä»¥ç›®å‰æ¯é€± 160 k ä¸‹è¼‰çš„ &lt;code>express-rate-limit&lt;/code> ä¸­ redis ç‰ˆæœ¬ &lt;a class="link" href="https://www.npmjs.com/package/rate-limit-redis" target="_blank" rel="noopener"
>rate-limit-redis&lt;/a> æ˜¯ä»¥ä¸‹åšæ³•&lt;/p>
&lt;ol>
&lt;li>å…ˆè¨ˆç®—å‡ºè©²æ™‚é–“æ®µçš„éµå€¼ï¼Œä¾‹å¦‚ 01:00 ~ 01:59 çš„éµå€¼éƒ½æ˜¯ &lt;code>01&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">expiryMs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">expiry&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>å¢åŠ  key ä¸¦æ›´æ–° ttl æ™‚é–“ï¼Œincr æœƒå›å‚³ç•¶ä¸‹å¢åŠ å¾Œçš„å€¼ï¼Œè—‰æ­¤åˆ¤æ–·æ˜¯å¦è¶…éé™åˆ¶&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">multi&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">incr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rdskey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">pttl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rdskey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">exec&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å› ç‚ºæœ‰ ttlï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒ key çš„åˆªé™¤ï¼Œé€™å€‹æ–¹æ³•ç°¡å–®ç›´è¦ºå„²å­˜æˆæœ¬ä¹Ÿå¾ˆä½&lt;/p>
&lt;p>ç‚ºäº†åš´æ ¼é™åˆ¶&lt;code>ä»»æ„æ™‚é–“å€æ®µå…§çš„æœ€å¤§å­˜å–æ•¸é‡&lt;/code>ï¼Œåƒè€ƒä»¥ä¸‹æ–‡ç« æåŠå…©ç¨®åšæ³• &lt;a class="link" href="https://engineering.classdojo.com/blog/2015/02/06/rolling-rate-limiter/" target="_blank" rel="noopener"
>Better Rate Limiting With Redis Sorted Sets
&lt;/a>&lt;/p>
&lt;h3 id="token-bucket">token bucket&lt;/h3>
&lt;p>æ¯ä¸€å€‹ç”¨æˆ¶éƒ½æœ‰ä¸€å€‹å°æ‡‰çš„ bucketï¼Œåªæœ‰ token è¶³å¤ æ™‚å¯ä»¥é€²è¡Œæ“ä½œï¼Œæ¯éš”ä¸€æ®µæ™‚é–“æœƒå›è£œ token æ•¸é‡ï¼Œå¥½è™•æ˜¯å¯ä»¥åˆ¶å®šå¤šç¨®æ“ä½œçš„ token éœ€è¦æ•¸é‡ï¼Œåƒæ˜¯æ›´ç¹é›œçš„æ“ä½œéœ€è¦æ¶ˆè€—æ›´å¤šçš„ token ï¼Œæ›´æœ‰å½ˆæ€§æ‡‰å°ä¸åŒçš„é™åˆ¶æ–¹æ¡ˆ&lt;/p>
&lt;p>è³‡æ–™çµæ§‹ä½¿ç”¨ Redis çš„ &lt;code>Hash&lt;/code>ï¼Œæ¼”ç®—æ³•å¤§è‡´å¦‚ä¸‹&lt;/p>
&lt;ol>
&lt;li>ç”¨æˆ¶è¦æ“ä½œçš„æ™‚å€™ï¼Œå¦‚æœæ­¤æ™‚æ²’æœ‰ç´€éŒ„ï¼Œå…ˆæ’å…¥ä¸€ç­† Hash &lt;code>user: ç•¶ä¸‹ çš„ timestamp =&amp;gt; token åˆå§‹åŒ–æ•¸é‡&lt;/code>&lt;/li>
&lt;li>å¾ŒçºŒæ“ä½œæ™‚ï¼Œå–å‡ºä¸Šä¸€æ¬¡æ“ä½œçš„ timestampï¼Œæ¥è‘—å›è£œé€™ä¸€æ®µæ™‚é–“éœ€è¦è£œå……çš„ Token æ•¸é‡&lt;/li>
&lt;li>æ¥è‘—æ‰£é™¤æ“ä½œæ‰€éœ€çš„ Token æ•¸ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç¬¦åˆé™åˆ¶&lt;/li>
&lt;/ol>
&lt;p>éœ€æ³¨æ„é€™ç¨®åšæ³•æœƒæœ‰ &lt;code>Race Condition&lt;/code> å•é¡Œï¼Œå¦‚æœä¸€å€‹ç”¨æˆ¶åŒæ™‚æœ‰å…©å€‹æ“ä½œï¼Œåœ¨ç¬¬ä¸‰æ­¥é©Ÿæª¢æŸ¥æ™‚ï¼Œæœƒèª¤ä»¥ç‚ºè‡ªå·±éƒ½æœ‰è¶³å¤ çš„ tokenï¼Œé™¤éä½¿ç”¨ &lt;code>Lua script&lt;/code>ï¼ŒRedis æ‰æœƒå°‡&lt;code>å¤šå€‹æ“ä½œè¦–ç‚º atomic é¿å… Race Condition&lt;/code>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/BitMEX/node-redis-token-bucket-ratelimiter" target="_blank" rel="noopener"
>node-redis-token-bucket-ratelimiter&lt;/a> ä¾¿æ˜¯æ¡ç”¨ Lua script ä½œæ³•ï¼Œè®“æˆ‘å€‘ä¾†æ¬£è³ä¸€ä¸‹&lt;/p>
&lt;ol>
&lt;li>å–å¾—åƒæ•¸ï¼Œä¸¦æŒ‡å®š &lt;code>redis.replicate_commands()&lt;/code>ï¼Œé€™æ˜¯åœ¨èª¿ç”¨ &lt;code>$ redis eval&lt;/code> æ™‚è¦ç”¢ç”Ÿéš¨æ©Ÿ IO æ™‚éœ€è¦æå‰åŸ·è¡Œçš„æŒ‡ä»¤ &lt;a class="link" href="https://redis.io/commands/eval" target="_blank" rel="noopener"
>Redis - EVAL script numkeys key&lt;/a>ï¼Œé€™ä¸€ç¯‡æœ‰æ˜“æ‡‚çš„è§£é‡‹ &lt;a class="link" href="http://mysql.taobao.org/monthly/2019/01/06/" target="_blank" rel="noopener"
>Redis Â· å¼•æ“ç‰¹æ€§ Â· Luaè„šæœ¬æ–°å§¿åŠ¿&lt;/a>ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ç‚ºäº†ç¬¦åˆ Redis åœ¨æŒä¹…åŒ–ä»¥åŠå‰¯æœ¬è³‡æ–™æ™‚çš„åŠŸèƒ½ï¼Œåœ¨ 5.0 ä»¥å¾Œæ˜¯é»˜èªé¸é …ï¼› &lt;br>
æ¥è‘—å°±æ˜¯åˆ†åˆ¥è¨ˆç®—ä¸Šä¸€æ¬¡æ›´æ–°æ™‚é–“ &lt;code>initialUpdateMS&lt;/code> / æ®˜ç•™çš„ token æ•¸ &lt;code>prevTokens&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- valueKey timestampKey | limit intervalMS nowMS [amount]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">valueKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">-- &amp;#34;limit:1:V&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">timestampKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">-- &amp;#34;limit:1:T&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">limit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tonumber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">intervalMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tonumber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">amount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tonumber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]),&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">force&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">lastUpdateMS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">prevTokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Use effects replication, not script replication;; this allows us to call &amp;#39;TIME&amp;#39; which is non-deterministic&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">redis.replicate_commands&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;TIME&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">nowMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.floor&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">initialTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;GET&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">valueKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">initialTokens&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- If we found no record, we temporarily rewind the clock to refill&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- via addTokens below&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">prevTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nowMS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">intervalMS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">prevTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">initialTokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;GET&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">timestampKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- this is a corruption&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- å¦‚æœè³‡æ–™æœ‰å•é¡Œï¼Œéœ€è¦å›æ¨ lastUpdateMS æ™‚é–“ï¼Œä¹Ÿå°±æ˜¯ç”¨ç¾åœ¨æ™‚é–“å›æ¨æ®˜å­˜ Token æ•¸é‡çš„å›è£œæ™‚é–“&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nowMS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">prevTokens&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">initialUpdateMS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>æ¥è‘—è¨ˆç®—ä¸Šä¸€æ¬¡åˆ°ç¾åœ¨éœ€è¦å›è£œçš„ Token &lt;code>addTokens&lt;/code> / é€™ä¸€æ¬¡é‹ç®—é…é¡å¤ ä¸å¤  &lt;code>netTokens&lt;/code> / å¦‚æœä¸‹ä¸€æ¬¡è¦å˜—è©¦éœ€è¦ç­‰å¤šä¹…çš„æ™‚é–“ &lt;code>retryDelta&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">addTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.max&lt;/span>&lt;span class="p">(((&lt;/span>&lt;span class="n">nowMS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">lastUpdateMS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- calculated token balance coming into this transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">grossTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prevTokens&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">addTokens&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- token balance after trying this transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">grossTokens&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- time to fill enough to retry this amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">retryDelta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">rejected&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">forced&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- we used more than we have&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">force&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">forced&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c1">-- drain the swamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rejected&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">grossTokens&lt;/span> &lt;span class="c1">-- rejection doesn&amp;#39;t eat tokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- == percentage of `intervalMS` required before you have `amount` tokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">retryDelta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.ceil&lt;/span>&lt;span class="p">(((&lt;/span>&lt;span class="n">amount&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">netTokens&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span> &lt;span class="c1">-- polite transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- nextNet == pretend we did this again...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">nextNet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">nextNet&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- ...we would need to wait to repeat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- == percentage of `invervalMS` required before you would have `amount` tokens again&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">retryDelta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.ceil&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">math.abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nextNet&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>å¦‚æœæˆåŠŸæ“ä½œ ( rejected == false )ï¼Œå‰‡å»¶é•· key çš„éæœŸæ™‚é–“&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">rejected&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PSETEX&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">valueKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">intervalMS&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">netTokens&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">addTokens&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- we filled some tokens, so update our timestamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PSETEX&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">timestampKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">intervalMS&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">nowMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- we didn&amp;#39;t fill any tokens, so just renew the timestamp so it survives with the value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PEXPIRE&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">timestampKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="sliding-time-window---æ»‘å‹•æ™‚é–“å€æ®µ">sliding time window - æ»‘å‹•æ™‚é–“å€æ®µ&lt;/h3>
&lt;p>æœ€å¾Œä¸€å€‹æ˜¯ä½¿ç”¨ sorted setï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>$ redis.multi&lt;/code> å°‡å¤šå€‹ sorted set çš„æŒ‡ä»¤ä¸²å†ä¸€èµ· Atomic åŸ·è¡Œæ‰€ä»¥èƒ½å¤ é¿å… Race Condition ç‹€æ³&lt;br>
å…·é«”æƒ³æ³•æ˜¯&lt;/p>
&lt;ol>
&lt;li>ç”¨ä¸€å€‹ sorted set å„²å­˜æ‰€æœ‰çš„ timestamp&lt;/li>
&lt;li>request é€²ä¾†å¾Œï¼Œå…ˆç”¨ &lt;code>ZREMRANGEBYSCORE&lt;/code> æ¨æ£„ time window ä»¥å¤–çš„ key&lt;/li>
&lt;li>å–å¾— sorted set å‰©é¤˜çš„æ‰€æœ‰å…ƒç´  &lt;code>ZRANGE(0, -1)&lt;/code>&lt;/li>
&lt;li>åŠ ä¸Šé€™ä¸€æ¬¡çš„æ“ä½œ &lt;code>ZADD&lt;/code>ï¼Œä¸¦å»¶é•· sorted set çš„ ttl&lt;/li>
&lt;li>æ¥è‘—ç®—æ•´å€‹ sorted set çš„å…ƒç´ é‡ï¼Œå°±çŸ¥é“å­˜å–å¹¾æ¬¡äº†&lt;/li>
&lt;/ol>
&lt;p>éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Œé€™é‚Šå¦‚æœç¬¬äº”æ­¥åˆ¤æ–·å¤±æ•—ä¹Ÿæœƒè¢«è¨ˆç®—åœ¨ limit ç•¶ä¸­ï¼Œå› ç‚ºç¬¬å››æ­¥å·²ç¶“å…ˆåŠ ä¸Šå»äº†ï¼Œå¦‚æœ&lt;code>åœ¨ç¬¬ä¸‰æ­¥å…ˆåˆ¤æ–·æ•¸é‡å¤ ä¸å¤ å†å»æ›´æ–° sorted setï¼Œä¸­é–“çš„æ™‚é–“å·®å°±æœ‰å¯èƒ½ç™¼ç”Ÿ Race Condition&lt;/code>ï¼Œæ‰€ä»¥è¦åš´æ ¼é™åˆ¶å¿…é ˆè¦é€™éº¼åšï¼Œé™¤éåˆè¦åŒ…æˆ lua script&lt;/p>
&lt;p>é€™æœƒå°è‡´ä¸€å€‹é¢¨éšªï¼Œå¦‚æœ Client çœŸçš„å¤±æ§ä¸€ç›´æ‰“ï¼Œé‚£ä»–æœƒç„¡æ­¢ç›¡çš„å¤±æ•—ï¼Œå› ç‚ºæ¯ä¸€æ¬¡çš„å¤±æ•—æ“ä½œéƒ½æœƒè¢«åŠ å…¥ sorted set ç•¶ä¸­ï¼Œä½†å…¶å¯¦éƒ½æ²’æœ‰çœŸçš„åŸ·è¡Œåˆ°&lt;/p>
&lt;p>æ¨¡çµ„è«‹åƒè€ƒ &lt;a class="link" href="https://github.com/peterkhayes/rolling-rate-limiter" target="_blank" rel="noopener"
>rolling-rate-limiter&lt;/a>ï¼Œç¨‹å¼ç¢¼åœ¨é€™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">batch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">multi&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">zremrangebyscore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">clearBefore&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">addNewTimestamp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">zadd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">uuid&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">zrange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;WITHSCORES&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">expire&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ttl&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reject&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exec&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">reject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åŠ å®Œå¾Œæ‰ä¾†è¨ˆç®—æ˜¯ä¸æ˜¯æ‰£æ‰“è¶³å¤ 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">zRangeOutput&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">addNewTimestamp&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="nx">as&lt;/span> &lt;span class="nb">Array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">unknown&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">zRangeResult&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getZRangeResult&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">zRangeOutput&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">timestamps&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">extractTimestampsFromZRangeResult&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">zRangeResult&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timestamps&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµè«–">çµè«–&lt;/h2>
&lt;p>Rate Limit çœ‹ä¼¼ç°¡å–®ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘çš„çœ‰è§’è¦å»è€ƒé‡ï¼Œä¹‹å‰ä¸€ç›´éƒ½æ²’æœ‰å®¢è£½ Redis ä¸­ lua script çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯è »æœ‰è¶£çš„&lt;/p></description></item><item><title>HTTPSä¸ä»£è¡¨å®‰å…¨ï¼šCloudflare SSL ç ”ç©¶å¾Serveråˆ°Cloudflare</title><link>https://yuanchieh.page/posts/2018/2018-07-11-https%E4%B8%8D%E4%BB%A3%E8%A1%A8%E5%AE%89%E5%85%A8cloudflare-ssl-%E7%A0%94%E7%A9%B6%E5%BE%9Eserver%E5%88%B0cloudflare/</link><pubDate>Wed, 11 Jul 2018 01:37:07 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-07-11-https%E4%B8%8D%E4%BB%A3%E8%A1%A8%E5%AE%89%E5%85%A8cloudflare-ssl-%E7%A0%94%E7%A9%B6%E5%BE%9Eserver%E5%88%B0cloudflare/</guid><description>&lt;p>ç¶²é ç€è¦½æ™‚å‡ºç¾HTTPSçš„ç¶ è‰²é–çœ‹äº†ä»¤äººæ”¾å¿ƒï¼Œé€™ä¼¼ä¹ä»£è¡¨è‘—æˆ‘å€‘åœ¨ç¶²ç«™ç€è¦½çš„è³‡æ–™æœ‰å—åˆ°ã€Œå®Œæ•´çš„åŠ å¯†ä¿è­·ã€ï¼Œä¸ç”¨æ“”å¿ƒè³‡æ–™è¢«å·çªºèˆ‡è¢«èª¿åŒ…ç­‰ç­‰MitMä¸­é–“äººæ”»æ“Šçš„é¢¨éšªï¼Œä½†äº‹å¯¦ç•¶ç„¶æ²’æœ‰é€™éº¼ç°¡å–®ã€‚&lt;/p>
&lt;p>åœ¨ç”³è«‹SSLæ†‘è­‰æ™‚æ˜¯ç¶å®šåŸŸåç”³è«‹ï¼Œç†è«–ä¸Š DNSè§£æåŸŸåå¾Œç›´æ¥æŒ‡å‘Serveræ‰€åœ¨IPï¼Œä¹Ÿå°±æ˜¯Clienté€éHTTPSåœ¨ç´¢å–æ†‘è­‰ã€é©—è­‰æ†‘è­‰ã€èˆ‡ Serverå…±åŒç”Ÿæˆå°ç¨±åŠ å¯†é‡‘é‘°å¾Œï¼Œå¯¦éš›å°‡è³‡æ–™åŠ å¯†å‚³è¼¸åˆ°Serverçš„æ•´æ®µç¶²è·¯éç¨‹æ˜¯å—åˆ°å®Œæ•´çš„ä¿è­·ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ç¾åœ¨å¾ˆå¤šç¶²ç«™ç‚ºäº†æ•ˆèƒ½ä¸Šèˆ‡å®‰å…¨æ€§ä¸Šçš„è€ƒé‡ï¼Œæ¡ç”¨äº†å‘ Cloudflareé€™æ¨£çš„ DNSä»£ç®¡ / CDNæœå‹™ï¼›&lt;br>
&lt;code>Client â† â†’ Cloudflare â† â†’ Server&lt;/code>&lt;/p>
&lt;p>Cloudflareåœ¨å…¨çƒå„å¤§æ´²éƒ¨ç½²å¤šå€‹è³‡æ–™ä¸­å¿ƒï¼Œæœƒè‡ªå‹•å°‡DNS / Cachedè³‡æ–™æ•£ä½ˆåˆ°å¤šç¯€é»ä¸Šï¼Œä¸¦æä¾›å¤šé …å„ªè³ªæœå‹™ï¼Œå¦‚&lt;/p>
&lt;ol>
&lt;li>å¾åœ°ç†ä½ç½®æœ€è¿‘çš„ç¯€é»å›è¦† Clientæ‰€éœ€è³‡æ–™ï¼Œä¹‹å‰æ›¾çœ‹éå¯¦æ¸¬å¤šå®¶DNS/CDNæœå‹™å•†çš„è³‡æ–™ï¼ŒCloudflareå›æ‡‰é€Ÿåº¦æ˜¯æœ€å¥½çš„ï¼›&lt;/li>
&lt;li>åœ¨Cloudflareå¾Œå°è§€å¯Ÿåˆ°ç¶²ç«™æœ‰è¿‘å…«æˆçš„æµé‡æ˜¯å‘½ä¸­Cacheå¾ Cloudflareç›´æ¥å›è¦† Clientï¼Œé™ä½Server è² æ“”èˆ‡æµé‡ï¼Œå†Serverä»¥æµé‡è¨ˆè²»çš„ä¸»æ©Ÿè¨—ç®¡ä¸‹ç¯€çœå¾ˆå¤§çš„æˆæœ¬ã€‚&lt;/li>
&lt;li>DDosé˜²è­·èˆ‡ç™½/é»‘ipåå–®å»ºç«‹&lt;/li>
&lt;/ol>
&lt;p>ä½†æ˜¯æ¡ç”¨ Cloudflareæœ‰äº›è³‡å®‰ä¸Šçš„ç–‘æ…®ï¼Œä¹Ÿæ˜¯æ­¤æ¬¡ç­†è¨˜çš„å…§å®¹&lt;br>
ä¸»è¦ç´€éŒ„&lt;br>
1. æ¡ç”¨Cloudflareé¢¨éšªåœ¨å“ª&lt;br>
2. ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬&lt;/p>
&lt;h3 id="æ¡ç”¨cloudflareé¢¨éšªåœ¨å“ª">æ¡ç”¨Cloudflareé¢¨éšªåœ¨å“ª&lt;/h3>
&lt;h4 id="client--cloudflare">Client â†â†’ Cloudflare&lt;/h4>
&lt;p>å…ˆå‰æåˆ°Cloudflareæœƒæ“‹åœ¨ Clientèˆ‡ Serverä¹‹é–“ï¼Œå¦‚æœ&lt;code>å•Ÿç”¨CDNæœå‹™ç‚ºäº†è§£æç·©å­˜è³‡æ–™&lt;/code>ï¼ŒCloudflare æœƒéœ€è¦åœ¨ä»–é€™å±¤ç›´æ¥è§£å¯†ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ç”¨å…è²»ç‰ˆ Cloudflareæœƒæä¾› Universal (shared)çš„æ†‘è­‰ï¼Œé€™æ˜¯ç°½ç™¼æ–¼ Cloudflareæ©Ÿæ§‹åº•ä¸‹ï¼›&lt;br>
å¦‚æœè¦ç”¨è‡ªå·±åŸŸåç°½ç™¼çš„æ†‘è­‰ï¼Œå¿…é ˆ&lt;code>é€éCloudflareè³¼è²·&lt;/code>æˆ–æ˜¯&lt;code>ä¸Šå‚³è‡ªå·±è³¼è²·çš„æ†‘è­‰èˆ‡ç§é‘°&lt;/code> ï¼Œé€™å…©é …éƒ½å¿…é ˆæ¡ç”¨ä»˜è²»æ–¹æ¡ˆï¼›&lt;/p>
&lt;p>ä½†é€™æ¨£çœ‹ä¾† Cloudflare å°±æ˜¯æ¸¾ç„¶å¤©æˆçš„ MitMä¸­çš„ä¸­é–“äººï¼Œä½†æ˜¯æˆ‘å€‘é¸æ“‡ç›¸ä¿¡ä»–ï¼Œæœ‰çœ‹åˆ°ä¸€äº›è¬ è¨€æ˜¯èªª CloudflareèƒŒå¾Œæœ‰ç¾åœ‹çš„ NSAåœ‹å®¶å®‰å…¨å±€æŠŠæŒï¼Œæ‰€ä»¥è³‡æ–™å¯èƒ½æœ‰æ´©æ¼çš„ç–‘æ…®ï¼Œç•¢ç«Ÿ Cloudflareå¯ä»¥çœ‹åˆ°æ‰€æœ‰è§£å¯†å¾Œçš„è³‡æ–™ã€‚&lt;br>
çœ‹åˆ°ä¸€äº›è¨è«–æ˜¯åŠä¿¡åŠç–‘ï¼ŒæŠ€è¡“æ€§ä¸Šä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æµé‡éƒ½æœƒå°å‘ç¾åœ‹çš„æœå‹™å™¨ï¼Œä½†é‚„æ˜¯æœ‰å¿…è¦ç•™å€‹å¿ƒçœ¼ï¼Œç•¢ç«Ÿå…ˆå‰ä¹Ÿæ˜¯æœ‰ FBIè¦æ±‚ Apple è§£é–Iphoneçš„ç¶“æ­·ï¼Œåœ‹å®¶æ©Ÿå™¨å†è™•ç†é€™ç¨®æ³•å¾‹ã€è³‡å®‰ã€å€‹è³‡ç­‰è­°é¡Œç¢ºå¯¦è »æ™æ‰çš„ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://www.theguardian.com/technology/2016/feb/22/tim-cook-apple-refusal-unlock-iphone-fbi-civil-liberties" target="_blank" rel="noopener"
>&lt;strong>Tim Cook says Apple&amp;rsquo;s refusal to unlock iPhone for FBI is a &amp;lsquo;civil liberties&amp;rsquo; issue&lt;/strong>&lt;/a>&lt;/p>
&lt;p>(é›–ç„¶Apple åœ¨ä¸­åœ‹ä¹Ÿæœè»Ÿäº†Â :/)&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœè¦æœ‰ç·©å­˜æ©Ÿåˆ¶ä¸”éå¸¸åœ¨æ„ Client â†’ Server å¿…é ˆå…¨ç¨‹èµ°HTTPSä¸”ä½¿ç”¨è‡ªå®¶æ†‘è­‰ä¸è¢«ä»»ä½•äººåœ¨ä¸­é€”è§£å¯†è³‡æ–™ï¼Œå°±é©åˆè‡ªå»ºCache Server ä¸é©åˆç”¨Cloudflareã€‚&lt;/p>
&lt;h4 id="cloudflare-server">Cloudflare â†â†’Â Server&lt;/h4>
&lt;p>å¾Cloudflareåˆ°Serveré€™æ®µæœ‰ä¸åŒå±¤ç´šçš„è¨­å®šï¼Œå¯ä»¥æ–¼å¾Œå°è¨­å®š&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__by4l7dHy5wi__pWEzz0cl9w.jpeg"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>Offï¼š&lt;br>
å…¨éƒ¨èµ°HTTP&lt;/li>
&lt;li>Flexibleï¼š&lt;br>
Client â†’ Cloudflare èµ°HTTPSï¼Œè€ŒCloudflare â†’ Server èµ°HTTP&lt;/li>
&lt;li>Fullï¼š&lt;br>
Cloudflare â†’ Server èµ°HTTPSï¼Œä½†æ˜¯ Cloudflareä¸æœƒé©—è­‰æ†‘è­‰ã€‚&lt;br>
Serveréœ€è¦é–‹å•Ÿ443 port æ‰èƒ½è™•ç†ã€‚&lt;/li>
&lt;li>Full(strict)ï¼š&lt;br>
å‘ˆä¸Šï¼Œä½†æ˜¯Cloudflareæœƒå‘CAé©—è­‰æ†‘è­‰çš„æ­£ç¢ºæ€§ï¼Œé€™éƒ¨åˆ†éœ€è¦æ­é…è¨­å®š &lt;code>Origin Certificates&lt;/code> ï¼Œå¯ä»¥ç”± Cloudflare ç”¢ç”Ÿæˆ–æ˜¯è‡ªå·±ç”¢ç”Ÿå¾Œä¸Šå‚³ã€‚&lt;br>
Cloudflareæœ¬èº«ä¹Ÿæ˜¯åˆæ ¼çš„CAï¼Œæ‰€ä»¥å¾€å¥½è™•æƒ³æ˜¯ä¸Šå‚³æ†‘è­‰æ˜¯å¯ä»¥è¢«ä¿¡ä»»çš„ï¼Œä½†åŒæ¨£çš„é›è›‹éƒ½åœ¨åŒä¸€å€‹ç±ƒå­è£¡æœ¬èº«å°±æ˜¯å€‹é¢¨éšªï¼Œç®—æ˜¯ä¸€é«”å…©é¢ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬">ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬&lt;/h3>
&lt;p>æ‰€ä»¥é™¤äº†Clientè¦æœ‰HTTPSä¿è­·ï¼Œåœ¨Serveré€™æ®µä¹Ÿå»ºè­°è¦é–‹å•Ÿ Fullä»¥ä¸Šçš„é˜²è­·æªæ–½ï¼ŒServeréƒ¨åˆ†ç”¨ Letâ€™s Encrypt å…è²»ç°½ç½²ï¼Œä¸¦åŒæ™‚é–‹å•Ÿ 80 / 443 portï¼Œä¾†èª¿æ•´å°æ‡‰Cloudflareçš„SSLä¿è­·æªæ–½ã€‚&lt;/p>
&lt;h4 id="1-åƒ…é–‹å•Ÿ-cloudflare-dns">1. åƒ…é–‹å•Ÿ Cloudflare DNSï¼š&lt;/h4>
&lt;p>é€™æ™‚å€™æ‰“ &lt;a class="link" href="https://domain.com" target="_blank" rel="noopener"
>https://domain.com&lt;/a> æœƒå‡ºç¾è‡ªå·±ç°½ç™¼çš„æ†‘è­‰ï¼Œåƒæˆ‘æ˜¯ç”¨ Letâ€™s Encrypt ç°½ç½²çš„æ†‘è­‰&lt;/p>
&lt;h4 id="2-é–‹å•Ÿ-cloudflare-cdnæœå‹™">2. é–‹å•Ÿ Cloudflare CDNæœå‹™ï¼š&lt;/h4>
&lt;p>é€™æ™‚å€™åŒæ¨£çš„ &lt;a class="link" href="https://domain.com" target="_blank" rel="noopener"
>https://domain.com&lt;/a> æœƒè‡ªå‹•è®Šæˆ Cloudflare Universal æ†‘è­‰&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__DhAfWG__CN45Me0tMhpyb9Q.png"
loading="lazy"
>&lt;/p>
&lt;p>ä»¥ä¸Šæ˜¯ Client &amp;lt;&amp;ndash;&amp;gt; Cloudflareé€™æ®µ&lt;/p>
&lt;p>ä»¥ä¸‹ç”¨ &lt;code>&amp;gt; sudo tcpdump -nn -i eth0 'tcp and (not port 22)'&lt;/code> æŸ¥çœ‹å°åŒ…ï¼Œæ’é™¤port 22 ä¸»è¦æ˜¯é¿å… ssh å°åŒ…å¹²æ“¾è§€å¯Ÿ&lt;/p>
&lt;h4 id="3-ssl-è¨­ç‚ºflexible">3. SSL è¨­ç‚ºÂ Flexible&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__Rg8Jz3FZZx8adrfbYt0heA.png"
loading="lazy"
>&lt;/p>
&lt;p>å¾ Cloudflare(ç”¨ whois 172.68.47.149æŸ¥è©¢å¾Œç¢ºèª) åˆ° Serveræ˜¯èµ° 80 port&lt;/p>
&lt;h4 id="4-ssl-è¨­ç‚º-full--fullstrict">4. SSL è¨­ç‚º Full / FullÂ (strict)&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__5MvJS8IszULHOhDNeGlKbw.png"
loading="lazy"
>&lt;/p>
&lt;p>å¾Œå°è¨­å®šåˆ‡æ›å¾Œç­‰å€‹ä¸‰ã€äº”ç§’å°±ç«‹å³æ”¹èµ° port 443&lt;/p>
&lt;h4 id="5-æ¸¬è©¦æ†‘è­‰æª¢æŸ¥">5. æ¸¬è©¦æ†‘è­‰æª¢æŸ¥&lt;/h4>
&lt;p>Full (strict)å·®åˆ¥åœ¨æ–¼æœƒæª¢æŸ¥æ†‘è­‰æ˜¯å¦ç‚ºå…¬é–‹çš„ç¬¬ä¸‰æ–¹CAé ’å¸ƒçš„åˆæ³•æ†‘è­‰ï¼Œé‚£å°±ä¾†ç¢ºèªä¸€ä¸‹æª¢æŸ¥çš„æ©Ÿåˆ¶æ˜¯å¦OKã€‚&lt;/p>
&lt;p>a. åœ¨ Full ç‹€æ…‹ä¸‹æ”¹ç”¨å…¶ä»–ç¶²åŸŸçš„SSLæ†‘è­‰ =&amp;gt; å¯ä»¥!&lt;br>
b. åœ¨ Full (strict) ç‹€æ…‹ä¸‹æ”¹ç”¨å…¶ä»–ç¶²åŸŸçš„SSLæ†‘è­‰ =&amp;gt; ä¸è¡Œï¼Œæœƒæª¢æŸ¥&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__6JOG8bEc9kDeqexWERRBbA.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å¦‚æœæ˜¯è‡ªç°½æ†‘è­‰ï¼Œè¨˜å¾—è¦ä¸Šå‚³ CSRåˆ°Cloudflareï¼Œä¸ç„¶ä¸€æ¨£æœƒå‡ºéŒ¯ã€‚&lt;/p>
&lt;h3 id="çµè«–">çµè«–&lt;/h3>
&lt;ol>
&lt;li>åƒ…ä½¿ç”¨ Cloudflare DNSæœå‹™ï¼ŒClientæœƒçœ‹åˆ°è‡ªå®¶æä¾›çš„æ†‘è­‰&lt;/li>
&lt;li>é–‹å•Ÿ Cloudflare CDNæœå‹™ï¼Œå…è²»ç‰ˆè½‰ç‚º Cloudflare Universal SSLæ†‘è­‰ï¼›&lt;br>
å¦‚è¦æ›¿æ›ç‚ºè‡ªå·±Domainç°½ç½²çš„æ†‘è­‰ï¼Œéœ€è¦ä»˜è²»æ–¹æ¡ˆ&lt;/li>
&lt;li>é–‹å•Ÿ Cloudflare CDNï¼Œæœƒè®“ Cloudflareæˆç‚ºä¸­é–“äººï¼Œè³‡æ–™æœ‰è¢«å¤–éœ²çš„ç–‘æ…®&lt;/li>
&lt;li>è¨˜å¾—é–‹å•Ÿ SSL ç‚º Full(strict)ï¼Œä¿è­· Cloudflare åˆ° Serveré€™æ®µ&lt;/li>
&lt;/ol></description></item><item><title>The Twelve-Factor App é–±è®€ç­†è¨˜</title><link>https://yuanchieh.page/posts/2018/2018-05-19-the-twelve-factor-app-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/</link><pubDate>Sat, 19 May 2018 07:02:08 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-05-19-the-twelve-factor-app-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/</guid><description>&lt;p>&lt;a class="link" href="https://12factor.net" target="_blank" rel="noopener"
>&lt;strong>The Twelve-Factor App&lt;/strong>&lt;/a> æ˜¯ç”±ä¸€ç¾¤æœ‰è±å¯Œç¶“é©—çš„å·¥ç¨‹å¸«ï¼Œæ•´ç†é–‹ç™¼ä¸€å€‹Webæ‡‰ç”¨ç¨‹å¼(æˆ–æ˜¯æ‰€è¬‚çš„SAAS software-as-a-service)é–‹ç™¼æ–¹é‡ï¼ŒåŸºæ–¼ä»¥ä¸‹å¹¾å€‹æ–¹å‘&lt;/p>
&lt;ol>
&lt;li>è¨­å®šæ˜ç¢ºï¼Œé™ä½æ–°äººåŠ å…¥å°ˆæ¡ˆçš„ä¸Šæ‰‹æˆæœ¬&lt;/li>
&lt;li>æœ€å¤§åŒ–å¯ç§»æ¤æ€§&lt;/li>
&lt;li>é©åˆéƒ¨ç½²åˆ°é›²ç«¯å¹³å°&lt;/li>
&lt;li>é™ä½é–‹ç™¼èˆ‡éƒ¨ç½²çš„å·®ç•°æ€§ï¼Œå¢åŠ æŒçºŒéƒ¨ç½²çš„æ•æ·&lt;/li>
&lt;li>å®¹æ˜“æ“´å±•(scale up)&lt;/li>
&lt;/ol>
&lt;p>åŸºæ–¼ä¸Šè¿°å¹¾å€‹è¦é»ï¼Œæ•´ç†æˆ12é …è¦ç´ ï¼Œè€Œç¬¦åˆé€™ 12è¦ç´ çš„æ‡‰ç”¨ç¨‹å¼å‰‡ç¨±ç‚º&lt;strong>twelve-factor app (å¾Œæ–‡æœƒæ¡ç”¨æ­¤åè©)&lt;/strong>ï¼Œç€è¦½éå¾Œè »æœ‰è¶£çš„ï¼Œç¨å¾®æ‘˜è¦ä¸¦æå‡ºè‡ªå·±åœ¨å¯¦è¸ä¸Šçš„æƒ³æ³•(ä¸»è¦æ˜¯Nodejsï¼Œä½œè€…çœ‹ä¾†æ¯”è¼ƒæ„›ç”¨Pythonç•¶ç¯„ä¾‹)ã€‚&lt;/p>
&lt;p>ç‚ºé¿å…æ­§ç¾©æˆ–è‹±æ–‡æ°´æº–ä¸ä½³ï¼Œæœ‰äº›é—œéµå­—æœƒä¸­è‹±å¤¾é›œï¼Œæˆ–æ˜¯ç›´æ¥é¡¯ç¤ºè‹±æ–‡å–®å­—ã€‚&lt;/p>
&lt;h2 id="1-codebase">1. Codebase&lt;/h2>
&lt;h4 id="ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ä¸€ä»½codebaseä½†å¯ä»¥æœ‰å¤šä»½éƒ¨ç½²-one-codebase-tracked-in-revision-control-manydeploys">ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ä¸€ä»½Codebaseï¼Œä½†å¯ä»¥æœ‰å¤šä»½éƒ¨ç½² (One codebase tracked in revision control, manyÂ deploys)&lt;/h4>
&lt;p>åŸå§‹ç¢¼å¿…é ˆä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œå¦‚ &lt;a class="link" href="http://git-scm.com/" target="_blank" rel="noopener"
>Git&lt;/a> / &lt;a class="link" href="http://subversion.apache.org/" target="_blank" rel="noopener"
>Subversion&lt;/a> / &lt;a class="link" href="https://www.mercurial-scm.org/" target="_blank" rel="noopener"
>Mercurial&lt;/a>ï¼Œæ¯ä»½APPåªèƒ½æœ‰ä¸€å€‹Code Repoï¼Œä½†å¯ä»¥æœ‰ä¸€ä»½Code Repoå¯ä»¥åŸ·è¡Œå¤šä»½ä¸”ç‰ˆæœ¬ä¸ä¸€æ¨£çš„éƒ¨ç½² Deployï¼›&lt;/p>
&lt;h2 id="2-dependencies">2. Dependencies&lt;/h2>
&lt;h4 id="å‘½ç¢ºå®šç¾©èˆ‡éš”é›¢ç›¸ä¾explicitly-declare-and-isolate-dependencies">å‘½ç¢ºå®šç¾©èˆ‡éš”é›¢ç›¸ä¾(Explicitly declare and isolate dependencies)&lt;/h4>
&lt;p>è¨±å¤šèªè¨€ç¨‹å¼éƒ½æœ‰å°æ‡‰çš„å‡½å¼åº«(library)ç®¡ç†å·¥å…·ï¼Œä¾‹å¦‚Rubyæœ‰Rubygemsã€Perlæœ‰CPANã€NodeJSæœ‰NPM(æˆ–Yarn)ï¼Œåœ¨å®‰è£ä¸Šæœ‰ç³»çµ±å±¤ç´šæˆ–æ˜¯è¢«ä¾·é™æ–¼å°ˆæ¡ˆç›®éŒ„ä¸‹(åˆç¨± bundling / Vendoring)&lt;/p>
&lt;p>ä¸€å€‹æ­£ç¢ºçš„æ‡‰ç”¨ç¨‹å¼ã€Œä¸æ‡‰è©²ä¾è³´ç³»çµ±å±¤ç´šçš„å‡½å¼åº«ã€ï¼Œæ‡‰è©²è¦åœ¨å®£å‘Šæ–‡ä»¶æ˜ç¢ºçš„å®£å‘Šæ‰€æœ‰ä¾è³´çš„å‡½å¼åº«ï¼›&lt;br>
ä¸¦ç¢ºä¿å‡½å¼åº«ä¸æœƒå½±éŸ¿å…¨åŸŸç’°å¢ƒï¼Œä¸¦ç¶­æŒéš”é›¢ã€‚ä¾‹å¦‚NPMåœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ &lt;code>package.json&lt;/code> ï¼Œé è¨­å®‰è£ä¹Ÿæ˜¯åœ¨è©²å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ &lt;code>node_modules&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>æ˜ç¢ºå®šç¾©çš„å¥½è™•æ˜¯å°æ–°äººå‹å–„ï¼Œåªè¦ç€è¦½å®£å‘Šæ–‡ä»¶å°±å¯ä»¥å¾—çŸ¥æ‰€æœ‰ç›¸ä¾çš„å‡½å¼åº«ï¼Œè€Œä¸”é€šå¸¸å‡½å¼åº«ç®¡ç†å·¥å…·éƒ½æœ‰è‡ªå‹•å®‰è£çš„æŒ‡ä»¤ï¼Œå¦‚ &lt;code>npm install&lt;/code>&lt;/p>
&lt;p>å¦å¤–å°ˆæ¡ˆä¹Ÿä¸éš±å¼ä¾è³´ç³»çµ±å·¥å…·ï¼Œä¾‹å¦‚ &lt;code>curl&lt;/code> ã€&lt;code>ImageMagick&lt;/code> ç­‰ï¼Œå› çˆ²å³ä¾¿é€™äº›å·¥å…·åœ¨å¤§å¤šç³»çµ±éƒ½å­˜åœ¨ï¼Œä½†ä¸èƒ½ä¿è­‰æ‡‰ç”¨ç¨‹å¼é‹è¡Œçš„ç’°å¢ƒæœ‰å®‰è£ï¼›&lt;br>
å¦‚æœéœ€è¦ï¼Œå‰‡è€ƒæ…®å°‡ç³»çµ±å·¥å…·ä¹Ÿæ‰“åŒ…é€²æ‡‰ç”¨ç¨‹å¼ä¸­ã€‚&lt;/p>
&lt;h2 id="3-config">3. Config&lt;/h2>
&lt;h4 id="å°‡è¨­å®šå„²å­˜æ–¼ç’°å¢ƒä¸­store-config-in-the-environment">å°‡è¨­å®šå„²å­˜æ–¼ç’°å¢ƒä¸­(Store config in the environment)&lt;/h4>
&lt;p>configæ˜¯é‚£äº›æœƒä¾æ“šéƒ¨ç½²ç’°å¢ƒè€Œæœ‰æ‰€ä¸åŒçš„è³‡æ–™ï¼Œä¾‹å¦‚è³‡æ–™åº«é€£ç·šè³‡æ–™/ AmazonS3ç­‰å¤–éƒ¨æœå‹™çš„æ©Ÿæ•è³‡æ–™ / hostnameç­‰ï¼Œæ‰€ä»¥ä¹Ÿä¸æœƒæ”¾å…¥ç‰ˆæœ¬æ§åˆ¶å·¥å…·è¿½è¹¤ã€‚&lt;/p>
&lt;p>å¿…é ˆæ³¨æ„ï¼Œç¨‹å¼ç¢¼èˆ‡è¨­å®šæª”ã€Œ**å¿…é ˆåš´æ ¼åˆ†é›¢ã€ï¼Œ**ç¨‹å¼ç¢¼æ˜¯æ‰€æœ‰éƒ¨ç½²éƒ½åŒä¸€ä»½ï¼Œä¸¦ä¸”ä¸æ‡‰è©²åŒ…å«ä»»ä½•æ©Ÿæ•è³‡æ–™ã€‚&lt;/p>
&lt;p>è¨±å¤šç¨‹å¼èªè¨€æœ¬èº«æœ‰åå¥½çš„è¨­å®šæ–‡ä»¶æ ¼å¼ï¼Œå¦‚ xml / yml / json ç­‰ï¼Œç‚ºäº†æ–¹ä¾¿æœ€å¥½æ˜¯ä½¿ç”¨å„²å­˜æ–¼ç’°å¢ƒè®Šæ•¸ä¸­ã€‚&lt;/p>
&lt;p>æ­¤å¤–ï¼Œç’°å¢ƒè®Šæ•¸æ‡‰è©²æ˜¯æ¯å€‹ç’°å¢ƒç¨ç«‹æ–¼å½¼æ­¤ï¼Œæ‰€ä»¥ä¸éœ€è¦åƒ Railsç”¨ â€œproductionâ€ / â€œtestâ€/ â€œdevelopmentâ€ åœ¨ç´°æ‹†å®šç¾©ç’°å¢ƒè®Šæ•¸ã€‚&lt;/p>
&lt;p>&amp;gt;&amp;gt; ä½†é€™è£æ¯”è¼ƒtrickyçš„æ˜¯å…¬å¸å°ˆæ¡ˆ stage / prodéƒ½æ˜¯è·‘åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šï¼Œæ²’è¾¦æ³•ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œéƒ½æ˜¯æ¡ç”¨ config.js ç•¶ä½œè¨­å®šæ–‡ä»¶&lt;/p>
&lt;h2 id="4-backingservices">4. BackingÂ services&lt;/h2>
&lt;h4 id="å°‡æ”¯æ´æœå‹™ç•¶ä½œé™„åŠ çš„è³‡æºtreat-backing-services-as-attached-resources">å°‡æ”¯æ´æœå‹™ç•¶ä½œé™„åŠ çš„è³‡æº(Treat backing services as attached resources)&lt;/h4>
&lt;p>é€™è£¡çš„Backing servicesæ³›æŒ‡æ‡‰ç”¨ç¨‹å¼ç›¸ä¾çš„å¤–éƒ¨æœå‹™ï¼Œä¾‹å¦‚è³‡æ–™åº«ã€å¯„ä¿¡æœå‹™å•†ã€å¿«å–è³‡æ–™åº«ç­‰&lt;/p>
&lt;p>&lt;strong>twelve-factor app&lt;/strong> æ‡‰è©²æ˜¯å¯ä»¥åœ¨æŠ½æ›å¤–éƒ¨æ”¯æ´æœå‹™è€Œä¸éœ€è¦æ›´å‹•ç¨‹å¼ç¢¼ï¼Œåªéœ€è¦æ”¹è®Šè¨­å®šæª”ä¸¦é‡å•Ÿè€Œå·²ï¼›&lt;br>
ä¾‹å¦‚èªªå°‡è³‡æ–™åº«å¾æœ¬æ©Ÿç«¯çš„MySQLæ›¿æ›æˆé›²ç«¯ Amazon RDSã€‚&lt;/p>
&lt;h2 id="5-build-releaserun">5. Build, release,Â run&lt;/h2>
&lt;h4 id="åš´æ ¼å€åˆ†å»ºåˆ¶èˆ‡åŸ·è¡Œæ­¥é©Ÿstrictly-separate-build-and-runstages">åš´æ ¼å€åˆ†å»ºåˆ¶èˆ‡åŸ·è¡Œæ­¥é©Ÿ(Strictly separate build and runÂ stages)&lt;/h4>
&lt;p>ç•¶åŸå§‹ç¢¼è¦è½‰æ›æˆéƒ¨ç½²çš„ç¨‹åºæ™‚ï¼Œæœƒç¶“éä¸‰å€‹æ­¥é©Ÿ&lt;br>
1. å»ºç½® buildï¼š&lt;br>
Â å°‡ç¨‹å¼ç¢¼è½‰æ›æˆå¯åŸ·è¡Œçš„åŒ…è£¹(Bundle)ï¼Œé€™æ­¥é©ŸæœƒæŠ“å–å¤–éƒ¨ç›¸ä¾çš„å‡½å¼åº«ä¸¦ç·¨è­¯äºŒé€²åˆ¶æª”æ¡ˆç­‰ã€‚&lt;br>
2. ç™¼å¸ƒ releaseï¼š&lt;br>
å°‡buildå¥½çš„å¯åŸ·è¡ŒåŒ…è£¹ï¼Œä¸¦çµåˆè©²éƒ¨ç½²ç’°å¢ƒçš„è¨­å®šæª”&lt;br>
3. åŸ·è¡Œ runï¼š&lt;br>
åŸ·è¡Œreleaseéšæ®µæ‰“åŒ…å¥½çš„ç¨‹å¼ã€‚&lt;/p>
&lt;p>æ¯ä»½releaseéƒ½å¿…é ˆæœ‰ç‰¹å®šçš„ç·¨è™Ÿï¼Œä¸è«–æ˜¯æ—¥æœŸæ ¼å¼ &lt;code>2011â€“04â€“06â€“20:32:17&lt;/code> æŠ‘æˆ–æ˜¯éå¢ç‰ˆå¥½ &lt;code>v100&lt;/code> ï¼Œæ–¹ä¾¿å¾ŒçºŒæœ‰å•é¡Œå¯ä»¥å›æ»¾ã€‚&lt;br>
æ­¤å¤–ç•¶ç™¼å¸ƒreleaseå¾Œä¸èƒ½æœ‰ä»»ä½•æ›´å‹•ï¼Œåªèƒ½é€éç™¼å¸ƒæ–°çš„releaseã€‚&lt;/p>
&lt;p>&lt;code>å»ºç½®éšæ®µ&lt;/code>é€šå¸¸æ˜¯ç•¶å·¥ç¨‹å¸«è¦ºå¾—æœ‰æ–°çš„ç¨‹å¼ç¢¼æ›´å‹•éœ€è¦éƒ¨ç½²ï¼Œå‰‡ä¸»å‹•è§¸ç™¼çš„ï¼Œæ‰€ä»¥åœ¨å»ºç½®éšæ®µå¯ä»¥åŸ·è¡Œç›¸å°è¤‡é›œçš„æŒ‡ä»¤èˆ‡æ“ä½œï¼Œç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚é‚„å¯ä»¥æœ‰å·¥ç¨‹å¸«æ‰‹å‹•ä¿®å¾©ï¼›&lt;br>
ä½†ç›¸å°åœ¨&lt;code>åŸ·è¡Œéšæ®µ&lt;/code>ï¼Œå¯èƒ½æ˜¯è‡ªå‹•åŒ–åŸ·è¡Œå¦‚æ‡‰ç”¨å´©æ½°å¾Œè‡ªå‹•é‡å•Ÿï¼Œæ‰€ä»¥åœ¨åŸ·è¡Œéšæ®µæ‡‰è©²è¦è¶Šç°¡æ½”è¶Šå¥½ã€‚&lt;/p>
&lt;h2 id="6-processes">6. Processes&lt;/h2>
&lt;h4 id="åŸ·è¡Œç„¡ç‹€æ…‹çš„å–®åŸ·è¡Œç·’æˆ–å¤šåŸ·è¡Œç·’execute-the-app-as-one-or-more-stateless-processes">åŸ·è¡Œç„¡ç‹€æ…‹çš„å–®åŸ·è¡Œç·’æˆ–å¤šåŸ·è¡Œç·’(Execute the app as one or more stateless processes)&lt;/h4>
&lt;p>ä¸€å€‹æ‡‰ç”¨ç¨‹å¼å¯èƒ½æœ‰å–®å€‹æˆ–å¤šå€‹åŸ·è¡Œç·’ï¼Œ&lt;strong>twelve-factor app&lt;/strong> æ‡‰è©²æ˜¯&lt;code>stateless&lt;/code>ä¸” &lt;code>share-nothing&lt;/code> ï¼Œéœ€è¦é•·æœŸä¿å­˜çš„è³‡æ–™å¯ä»¥æ”¾åœ¨å¤–éƒ¨æœå‹™å¦‚è³‡æ–™åº«æˆ–CDNä¸­&lt;/p>
&lt;p>ç¨‹åºçš„è¨˜æ†¶é«”æˆ–æ˜¯æª”æ¡ˆç³»çµ±åªèƒ½ç•¶ä½œæš«æ™‚çš„æ“ä½œç©ºé–“ï¼Œä¾‹å¦‚ä¸‹è¼‰æª”æ¡ˆã€æ“ä½œã€æ¥è‘—å°‡çµæœå„²å­˜æ–¼è³‡æ–™åº«ä¸­ï¼Œæ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç¢ºä¿è¢«æš«å­˜åœ¨å¿«å–èˆ‡æª”æ¡ˆç³»çµ±çš„è³‡æ–™åœ¨æœªä¾†ä¸æœƒè¢«ç”¨ä¸Šï¼›&lt;br>
å› ç‚ºåœ¨å¤šåŸ·è¡Œç·’ä¸‹ï¼ŒæœªçŸ¥çš„è«‹æ±‚å¯èƒ½è¢«ä¸åŒçš„åŸ·è¡Œç·’æ‰€åŸ·è¡Œï¼Œå³ä½¿æ˜¯å–®åŸ·è¡Œç·’ç¨‹å¼ç•¶ç³»çµ±å´©æ½°æ™‚å¿«å–è·Ÿæª”æ¡ˆç³»çµ±çš„è³‡æ–™éƒ½å¯èƒ½æ¶ˆå¤±ã€‚&lt;/p>
&lt;p>æœ‰äº›æ‡‰ç”¨ç¨‹å¼æœƒæ¡ç”¨ &lt;code>sticky-session&lt;/code> ç¢ºä¿åŒä¸€å€‹ç”¨æˆ¶è¢«åŒä¸€å€‹åŸ·è¡Œç·’æ‰€æœå‹™ï¼Œé€™æ˜¯é•åè¦ç¯„çš„ã€‚&lt;br>
æœ‰æ™‚æ•ˆæ€§çš„æš«å­˜ç‹€æ…‹è³‡æ–™(å¦‚session)å¯ä»¥æ”¾åœ¨åƒRedis / Memcachedé€™é¡çš„è³‡æ–™åº«ä¸­ã€‚&lt;/p>
&lt;h2 id="7-portbinding">7. PortÂ binding&lt;/h2>
&lt;h4 id="é€éç¶å®šåŸ å£å°å¤–é–‹æ”¾æœå‹™export-services-via-portbinding">é€éç¶å®šåŸ å£å°å¤–é–‹æ”¾æœå‹™(Export services via portÂ binding)&lt;/h4>
&lt;p>æ‡‰ç”¨ç¨‹å¼æœ‰äº›æ™‚å€™è¢«åŸ·è¡Œåœ¨å…¶ä»–å®¹å™¨ä¸­ï¼Œä¾‹å¦‚ PHPæœå‹™å¯èƒ½åŸ·è¡Œæ–¼ &lt;a class="link" href="http://httpd.apache.org/" target="_blank" rel="noopener"
>Apache HTTPD&lt;/a> / Javaæœå‹™ åŸ·è¡Œæ–¼ &lt;a class="link" href="http://tomcat.apache.org/" target="_blank" rel="noopener"
>Tomcat&lt;/a>ä¸‹ï¼Œä½†æ˜¯ &lt;strong>twelve-factor app&lt;/strong> æ‡‰è©²æ˜¯æœå‹™ç›´æ¥ç¶å®šåŸ å£ä¸¦è™•ç†è«‹æ±‚ã€‚&lt;/p>
&lt;p>é€™é€šå¸¸éƒ½æœ‰å‡½ç¤ºåº«å¯ä»¥æ”¯æ´ï¼Œä¾‹å¦‚ pythonçš„ &lt;a class="link" href="http://www.tornadoweb.org/" target="_blank" rel="noopener"
>Tornado&lt;/a> / Ruby çš„ &lt;a class="link" href="http://code.macournoyer.com/thin/" target="_blank" rel="noopener"
>Thin&lt;/a> ç­‰ï¼Œé€™ä½¿å¾—æ•´ä»½æ‡‰ç”¨ç¨‹å¼éƒ½æ˜¯åœ¨ user-spaceåŸ·è¡Œï¼Œä¸”å…¨éƒ¨åŒ…å«åœ¨åŸå§‹ç¢¼ä¸­ã€‚&lt;/p>
&lt;p>HTTPåªæ˜¯å…¶ä¸­ä¸€å€‹å¯ä»¥ç¶å®šåŸ å£çš„å”å®šï¼Œå…¶ä»–åƒæ˜¯ XMPP / Redis Protocol ç­‰æœå‹™éƒ½éœ€åƒç…§æ­¤è¦ç¯„ã€‚&lt;/p>
&lt;h2 id="8-concurrency">8. Concurrency&lt;/h2>
&lt;h4 id="é€éåŸ·è¡Œç·’æ¨¡å‹æ“´å±•scale-out-via-the-processmodel">é€éåŸ·è¡Œç·’æ¨¡å‹æ“´å±•(Scale out via the processÂ model)&lt;/h4>
&lt;p>æ‡‰ç”¨ç¨‹å¼åœ¨åŸ·è¡Œç·’ç®¡ç†ä¸Šæœ‰å¤šç¨®æ–¹å¼ï¼Œä¾‹å¦‚ Apache æœƒåœ¨æ”¶åˆ°è«‹æ±‚æ™‚é–‹ä¸€éš»æ–°çš„å­åŸ·è¡Œç·’(Process)è·‘ phpæ‡‰ç”¨ï¼Œè€ŒJavaå‰‡æ˜¯é€éJVMå…ˆä¿ç•™ä¸€å¤§å¡ŠCPU/Memoryè³‡æºæ¥è‘—é€éå…§éƒ¨åˆ†é…ç·šç¨‹(Thread)é”åˆ°ä¸¦è¡Œæ•ˆæœã€‚&lt;/p>
&lt;p>åœ¨ &lt;strong>twelve-factor app&lt;/strong> ä¸­ï¼ŒåŸ·è¡Œç·’æ˜¯ç¬¬ä¸€å…¬æ°‘ï¼Œé–‹ç™¼è€…å¯ä»¥æ±ºå®šç”±å“ªä¸€å€‹åŸ·è¡Œç·’è·‘ä»»å‹™ï¼Œä¾‹å¦‚ HTTPè«‹æ±‚åŸ·è¡Œåœ¨ WebåŸ·è¡Œç·’ä¸Š / èƒŒæ™¯æœå‹™å‰‡è·‘åœ¨ WorkeråŸ·è¡Œç·’ä¸Š&lt;/p>
&lt;p>çœ‹èªªæ˜ä½œè€…èˆ‰ &lt;a class="link" href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html" target="_blank" rel="noopener"
>Foreman&lt;/a> ç•¶åšä¾‹å­(ä¸‹åœ–è¼”åŠ©èªªæ˜)ï¼Œé€™æ¨£çš„å¥½è™•æ˜¯é‡è¦çš„ä»»å‹™å¯ä»¥åˆ†é…è¼ƒå¤šçš„è³‡æº&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__jvIkj4Cf__DgPZRRt.png"
loading="lazy"
>&lt;/p>
&lt;p>ä½†é€™ä¸¦ä¸æ’é™¤åŸ·è¡Œç·’å…§éƒ¨å¤šå·¥è™•ç†ã€VMå…§éƒ¨è™•ç†ç·šç¨‹åˆ†é…ã€åˆæˆ–æ˜¯åƒ éåŒæ­¥/äº‹ä»¶è§¸ç™¼çš„NodeJSï¼Œä½†æ˜¯å–®ä¸€VMèƒ½å¤ å®¹é‡æœ‰é™ï¼Œæ‡‰ç”¨ç¨‹å¼é ˆå¯æ‹“å±•å¤šå€‹åŸ·è¡Œç·’åˆ°å¤šå°å¯¦é«”ä¸»æ©Ÿä¸Šã€‚&lt;/p>
&lt;p>é€™æ¨£çš„è¨­è¨ˆåœ¨éœ€è¦æ°´å¹³æ“´å±•æ™‚æœƒå¤§æ”¾ç•°å½©ï¼Œshare-nothing / å¯æ°´å¹³æ‹†åˆ†çš„åŸ·è¡Œç·’åœ¨å¢åŠ æ›´å¤šä¸¦è¡Œ(Concurrency)æ™‚ååˆ†åœ°ç°¡å–®ã€‚&lt;br>
åœ¨ &lt;code>pm2&lt;/code> åŒæ¨£å¯ä»¥åšåˆ°åŒæ¨£çš„äº‹æƒ…ã€‚&lt;/p>
&lt;p>æœ€å¾Œä¸€æ®µæåˆ°ï¼Œ&lt;strong>twelve-factor app&lt;/strong> &lt;a class="link" href="http://dustin.github.com/2010/02/28/running-processes.html" target="_blank" rel="noopener"
>should never daemonize&lt;/a> or write PID files. Instead, rely on the operating systemâ€™s process manager (such as &lt;a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/" target="_blank" rel="noopener"
>systemd&lt;/a>, a distributed process manager on a cloud platform, or a tool like &lt;a class="link" href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html" target="_blank" rel="noopener"
>Foreman&lt;/a> in development)&lt;/p>
&lt;p>æŠ€è¡“åè©å¤ªå¤šç›´æ¥è²¼åŸæ–‡ï¼Œè¿½è¹¤å®Œç›¸é—œå…§æ–‡é€£çµå¤§è‡´ä¸Šæƒ³è¦èªªæ˜ã€Œæ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç®¡å¥½é–‹ç™¼æ‡‰ç”¨ç¨‹å¼å°±å¥½ï¼Œå…¶é¤˜çš„åŸ·è¡Œäº¤çµ¦å·¥å…·å³å¯ã€&lt;br>
ä¹Ÿå°±æ˜¯ &lt;code>KISS(Keep it simple, stupid)&lt;/code> çš„è¨­è¨ˆç†å¿µã€‚&lt;/p>
&lt;p>daemonæ˜¯è™•æ–¼èƒŒæ™¯ã€ä¸äºˆç”¨æˆ¶äº’å‹•çš„åŸ·è¡Œç¨‹å¼ï¼Œå…¶çˆ¶é€²ç¨‹ç‚º init (åœ¨ linux ä¸­ç‚ºç³»çµ±å•Ÿå‹•å¾Œç¬¬ä¸€å€‹é€²ç¨‹ï¼ŒPIDç·¨è™Ÿç‚º1)ï¼Œinitæœƒä¸€ç›´å­˜åœ¨åˆ°é›»è…¦é—œæ©Ÿç‚ºæ­¢ï¼›&lt;br>
ç•¶æœ‰ä»»ä½•çˆ¶é€²ç¨‹å…ˆè¡Œé—œé–‰è€Œå­é€²ç¨‹ä»ç„¶åŸ·è¡Œæ™‚ï¼Œinitæœƒè½‰ç‚ºé€™äº›å­é€²ç¨‹çš„çˆ¶é€²ç¨‹ï¼Œæ‰€ä»¥å¸¸è¦‹å•Ÿå‹•daemonä½œæ³•ä¹Ÿéƒ½æ˜¯åœ¨çˆ¶é€²ç¨‹ forkå‡ºå­é€²ç¨‹å¾Œé€€å‡ºï¼Œæ­¤æ™‚å­é€²ç¨‹å°±æ˜¯daemon processäº†ã€‚&lt;/p>
&lt;p>åƒè€ƒ Nodejs Daemon å‡½å¼åº«å°±æ˜¯æ­¤ä½œæ³•ï¼Œç”¨ child_process.spawn é—œé–‰ stdin ä¸¦é‡å° stdout / stderr èˆ‡å…¶ä»–è¨­å®šï¼Œå¦é–‹æ–°çš„é€²ç¨‹ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/indexzero/daemon.node/blob/master/index.js" target="_blank" rel="noopener"
>&lt;strong>indexzero/daemon.node&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="9-disposability">9. Disposability&lt;/h2>
&lt;h4 id="å¿«é€Ÿå•Ÿå‹•å„ªé›…é—œé–‰å¢å¼·ç¨‹å¼å¯é æ€§-maximize-robustness-with-fast-startup-and-graceful-shutdown">å¿«é€Ÿå•Ÿå‹•+å„ªé›…é—œé–‰=&amp;gt;å¢å¼·ç¨‹å¼å¯é æ€§ (Maximize robustness with fast startup and graceful shutdown)&lt;/h4>
&lt;p>æ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç›¡å¯èƒ½é™ä½å•Ÿå‹•æ™‚é–“ï¼Œé€™æ¨£æ‰å¯ä»¥åœ¨å¿«é€Ÿæ“´å±• / ä¿®æ”¹è¨­å®šæ™‚å¿«é€Ÿå•Ÿç”¨æœå‹™ï¼›&lt;br>
ç•¶æ‡‰ç”¨ç¨‹å¼æ”¶åˆ°&lt;a class="link" href="http://en.wikipedia.org/wiki/SIGTERM" target="_blank" rel="noopener"
>&lt;strong>SIGTERM&lt;/strong>&lt;/a>è¨Šè™Ÿæ™‚ï¼Œæ‡‰ç•¶å„ªé›…çš„é—œé–‰ï¼Œä¹Ÿå°±æ˜¯åœæ­¢è™•ç†æ–°çš„è«‹æ±‚ä¸¦å°‡ç¾æœ‰çš„è«‹æ±‚è™•ç†å®Œæˆæ‰é€€å‡ºã€‚&lt;/p>
&lt;p>æ‡‰ç”¨ç¨‹å¼éœ€è¦è™•ç†éé è­¦çš„é—œé–‰ï¼Œä¾‹å¦‚ç¡¬é«”å£æ‰ç­‰ï¼Œé€™æ™‚å€™æœ€å¥½æœ‰å¯é çš„queueing backend ä¾‹å¦‚Beanstalkdï¼Œç•¶æ‡‰ç”¨ç¨‹å¼çµ‚æ­¢æˆ–è¶…æ™‚å¯ä»¥è‡ªå‹•å°‡ä»»å‹™é‡æ–°è¿”å› queueä¸­ã€‚&lt;/p>
&lt;h2 id="10-devprodparity">10. Dev/prodÂ parity&lt;/h2>
&lt;h4 id="ç›¡å¯èƒ½ä¿æŒç’°å¢ƒä¸€è‡´-keep-development-staging-and-production-as-similar-as-possible">ç›¡å¯èƒ½ä¿æŒç’°å¢ƒä¸€è‡´ (Keep development, staging, and production as similar as possible)&lt;/h4>
&lt;p>å› ç‚ºä¸€äº›æ­·å²ç·£ç”±ï¼Œé–‹ç™¼ç’°å¢ƒèˆ‡æ­£å¼ç’°å¢ƒå¯èƒ½æœ‰å¹¾ç¨®å·®ç•°å­˜åœ¨&lt;br>
1. æ™‚é–“ï¼šé–‹ç™¼ç’°å¢ƒå¯èƒ½æŒçºŒé–‹ç™¼äº†æ•¸å¤©åˆ°æ•¸å€‹æœˆæ‰åŒæ­¥åˆ°æ­£å¼ç’°å¢ƒ&lt;br>
2. äººï¼šé–‹ç™¼å·¥ç¨‹å¸«è² è²¬é–‹ç™¼ï¼Œè€Œç¶­é‹å·¥ç¨‹å¸«éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ&lt;br>
3. å·¥å…·ï¼šæœ¬åœ°ç«¯å¯èƒ½ç”¨SQLite è€Œ æ­£å¼ç’°å¢ƒå‰‡ç”¨ MySQL&lt;/p>
&lt;p>&lt;strong>twelve-factor app&lt;/strong> å‰‡æ˜¯è¦ç¸®çŸ­ä¸Šé¢çš„å·®è·&lt;br>
1. ç¸®çŸ­æ™‚é–“ï¼šé–‹ç™¼åˆ°éƒ¨ç½²åœ¨æ•¸å°æ™‚ç”šè‡³æ•¸åˆ†é˜ä¹‹é–“&lt;br>
2. äººï¼šé–‹ç™¼è€…æ‡‰è©²ç·Šå¯†çš„åƒèˆ‡æ­£å¼ç’°å¢ƒéƒ¨ç½²&lt;br>
3. å·¥å…·ï¼šç›¡å¯èƒ½ç”¨åŒæ¨£çš„å·¥å…·éŠ&lt;/p>
&lt;p>ç’°å¢ƒå®£å‘Šå·¥å…·å¦‚ &lt;a class="link" href="http://www.opscode.com/chef/" target="_blank" rel="noopener"
>Chef&lt;/a> / &lt;a class="link" href="http://docs.puppetlabs.com/" target="_blank" rel="noopener"
>Puppet&lt;/a> çµåˆè¼•é‡çš„è™›æ“¬åŒ–ç’°å¢ƒå·¥å…·å¦‚ &lt;a class="link" href="https://www.docker.com/" target="_blank" rel="noopener"
>Docker&lt;/a> / &lt;a class="link" href="http://vagrantup.com/" target="_blank" rel="noopener"
>Vagrant&lt;/a> å¯ä»¥å¤§å¹…åŒæ­¥é–‹ç™¼èˆ‡æ­£å¼ç’°å¢ƒã€‚&lt;/p>
&lt;h2 id="11-logs">11. Logs&lt;/h2>
&lt;h4 id="ç”¨ä¸²æµè™•ç†log-treat-logs-as-eventstreams">ç”¨ä¸²æµè™•ç†Log( Treat logs as eventÂ streams)&lt;/h4>
&lt;p>&lt;strong>twelve-factor app&lt;/strong> æœ¬èº«ä¸æ‡‰è©²å»ç®¡ç†æˆ–ç…©æƒ± Logæ‡‰è©²è¦å„²å­˜åœ¨å“ªè£¡ï¼ŒåŸ·è¡Œä¸­çš„ç¨‹å¼æ‡‰ç•¶ç›´æ¥è¼¸å‡ºåˆ° &lt;code>stdout&lt;/code> ï¼Œåœ¨æœ¬åœ°é–‹ç™¼ä¸Šå·¥ç¨‹å¸«å¯ä»¥ç›´æ¥åœ¨çµ‚ç«¯æ©Ÿä»‹é¢çœ‹åˆ°æ‰€æœ‰çš„æ‰“å°è¨Šæ¯ï¼›&lt;br>
è€Œåœ¨æ­£å¼ç’°å¢ƒä¸Šï¼ŒLogæ‡‰è©²è¢«åŸ·è¡Œç’°å¢ƒè™•ç†ï¼Œå½™æ•´æ‰€æœ‰çš„Logåˆ°ä¸åŒçš„åœ°æ–¹å„²å­˜æˆ–æ˜¯åˆ°&lt;a class="link" href="http://hive.apache.org/" target="_blank" rel="noopener"
>Hadoop/Hive&lt;/a> åšæ›´é€²ä¸€æ­¥çš„è³‡æ–™è™•ç†ï¼Œæœ‰é–‹æºå·¥å…·å¯ä»¥ä½¿ç”¨å¦‚ &lt;a class="link" href="https://github.com/heroku/logplex" target="_blank" rel="noopener"
>Logplex&lt;/a> / &lt;a class="link" href="https://github.com/fluent/fluentd" target="_blank" rel="noopener"
>Fluentd&lt;/a>ï¼Œå€¼å¾—æ³¨æ„æ˜¯æ‡‰ç”¨ç¨‹å¼æœ¬èº«ä¸çŸ¥é“Logå…¶ä»–è¨­å®šã€‚&lt;/p>
&lt;p>åœ¨Nodejsé–‹ç™¼ä¸­ï¼Œ&lt;code>pm2&lt;/code> æœ‰æä¾›åŸºæœ¬çš„Logï¼Œä½†å¦‚æœè¦æ›´é€²éšçš„è™•ç†å°±é‚„æ˜¯è¦ç”¨ &lt;code>bunyan&lt;/code> / &lt;code>winston&lt;/code> Log å‡½å¼åº«ï¼Œä½†é€™å°±æœƒé•ååŸå‰‡ï¼Œå› ç‚ºè®Šæˆæ˜¯æ‡‰ç”¨ç¨‹å¼è¦è‡ªå·±è™•ç†Logçš„éƒ¨åˆ†ã€‚&lt;br>
é™¤éè‡ªå·±å¦å¤–é–‹ç™¼ä¸€å¥—ç›´æ¥æ¥ stdout / stderr çš„ä¸²æµå·¥å…·(å¥½åƒå¯ä»¥è©¦è©¦çœ‹?!)ã€‚&lt;/p>
&lt;h2 id="12-admin-processes">12. Admin processes&lt;/h2>
&lt;h4 id="åŸ·è¡Œä¸€æ¬¡æ€§ç®¡ç†ä»»å‹™-run-adminmanagement-tasks-as-one-off-processes">åŸ·è¡Œä¸€æ¬¡æ€§ç®¡ç†ä»»å‹™ (Run admin/management tasks as one-off processes)&lt;/h4>
&lt;p>ä¸€æ¬¡æ€§çš„ç®¡ç†ä»»å‹™å¦‚ è³‡æ–™åº«Schemaæ›´å‹• / ç‰¹å®šä»»å‹™è…³æœ¬ / ä½¿ç”¨REPLåŸ·è¡Œä»»æ„çš„ç¨‹å¼ç¢¼ç­‰ï¼Œé€™äº›ä¸€æ¬¡æ€§çš„ç®¡ç†ä»»å‹™æ‡‰ç•¶ä¸€åŒæ”¾å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸¦èˆ‡æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ç›¸åŒçš„å·¥å…·éŠèˆ‡è¨­å®šæª”ã€‚&lt;/p>
&lt;p>==========&lt;/p>
&lt;p>ä»¥ä¸Šåªæ˜¯å€‹äººçš„æ¿ƒç¸®ç¸½çµï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹åŸè³‡æ–™ç¶²ç«™ã€‚&lt;/p></description></item></channel></rss>