<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Coturn 是知名的 open source STUN/TURN server，本篇分享如何在 AWS 上架設與遇到的坑，以及設定檔的撰寫等"><meta name=keywords content="Coturn,WebRTC"><title>Coturn Server 架設教學 - on AWS</title><link rel=canonical href=https://yuanchieh.page/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/><link rel=stylesheet href=/scss/style.min.ff300df33b80e2ac49809c825614392ed1c7b27591d65d3c4043602cd162e25f.css><meta property="og:title" content="Coturn Server 架設教學 - on AWS"><meta property="og:description" content="Coturn 是知名的 open source STUN/TURN server，本篇分享如何在 AWS 上架設與遇到的坑，以及設定檔的撰寫等"><meta property="og:url" content="https://yuanchieh.page/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/"><meta property="og:site_name" content="Yuanchieh"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2020-09-21T08:21:40+00:00"><meta property="article:modified_time" content="2020-09-21T08:21:40+00:00"><meta name=twitter:title content="Coturn Server 架設教學 - on AWS"><meta name=twitter:description content="Coturn 是知名的 open source STUN/TURN server，本篇分享如何在 AWS 上架設與遇到的坑，以及設定檔的撰寫等"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-82837682-4","auto"),ga("send","pageview"))</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82837682-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-82837682-4")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars0.githubusercontent.com/u/6858460?s=460&amp;v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Yuanchieh</a></h1><h2 class=site-description>生命是長期而持續的累積</h2></div></header><ol class=social-menu><li><a href=https://github.com/sj82516 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#coturn-於-aws-上的架設>Coturn 於 AWS 上的架設</a><ol><li><a href=#啟動-turnserver>啟動 turnserver</a><ol><li><a href=#1-使用-coturn-自帶的-test-tool>1. 使用 Coturn 自帶的 test tool</a></li><li><a href=#2-用瀏覽器開啟-webrtc-samples-trickle-ice>2. 用瀏覽器開啟 WebRTC samples Trickle ICE</a></li></ol></li></ol></li><li><a href=#設定檔>設定檔</a><ol><li><a href=#驗證>驗證</a><ol><li><a href=#long-term-credential>long term credential</a></li><li><a href=#short-term-credential>short term credential</a></li></ol></li><li><a href=#網路設定>網路設定</a></li></ol></li><li><a href=#sample-code>Sample Code</a></li><li><a href=#go-to-production>Go To Production</a><ol><li><a href=#監控>監控</a></li><li><a href=#可用性>可用性</a></li></ol></li><li><a href=#nat-介紹與-stunturn-使用>NAT 介紹與 STUN/TURN 使用</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E9%9B%B2%E7%AB%AF%E8%88%87%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B/>雲端與系統架構</a>
<a href=/categories/webrtc/>WebRTC</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/>Coturn Server 架設教學 - on AWS</a></h2><h3 class=article-subtitle>Coturn 是知名的 open source STUN/TURN server，本篇分享如何在 AWS 上架設與遇到的坑，以及設定檔的撰寫等</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 21, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>公司 P2P 通信採用 WebRTC tech stack，近日希望自建 STUN/TURN Server，決定採用 <a class=link href=https://github.com/coturn/coturn target=_blank rel=noopener>Coturn</a> 這套知名的解決方案，在 AWS 架設過程遇到一些坑，決定分享如何架設，並分享設定檔如何設定與操作<br>以下包含</p><ol><li>Coturn 於 AWS 上的架設與測試</li><li>介紹設定檔內容</li><li>上 Production 的考量</li><li>補充 NAT 與 STUN/TURN 關係</li></ol><p>如果想知道更詳細的協定介紹，請參考</p><ol><li><a class=link href=https://yuanchieh.page/post/2020-09-22_rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/ target=_blank rel=noopener>RFC 5398 - STUN</a></li></ol><p>如果想要用 Container 架設，可以參考我用 docker-compose 架設的方式 <a class=link href=https://github.com/sj82516/coturn-with-prometheus-grafana-on-docker target=_blank rel=noopener>Running Coturn + Promethes + Grafana in Docker</a></p><h2 id=coturn-於-aws-上的架設>Coturn 於 AWS 上的架設</h2><p>使用 Ubuntu 18.04 非常簡單，只要以下指令就能啟動 Coturn</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo apt-get -y update 
</span></span><span class=line><span class=cl>$ sudo apt-get -y install coturn
</span></span></code></pre></td></tr></table></div></div><blockquote><p>強烈建議使用 <code>Ubuntu 18.04</code> 而不要用 <code>Amazon Linux 2</code>，Amazon Linux 2 要自己處理各種套件的相依性，架設過程花了半天還沒架起來</p></blockquote><blockquote><p>用 apt-get install 的話，會被限制版本，如果有其他需求，例如支援除了 SQLite 以外的 DB，或是要安裝 Prometheus，建議從 source code build 起，可以參考另一篇文章</p></blockquote><p>安裝後會有幾個 command 能夠使用</p><ol><li>turnserver<br>啟動 STUN/TURN server instance</li><li>turnadmin<br>介面管理後台<br>其餘都是測試用工具</li><li>turnutils_peer<br>UDP-only echo server，檢測連線使用</li><li>turnutils_stunclient<br>呼叫 STUN server 並取得回應</li><li>turnutils_uclient<br>可以模擬多人連線 TURN server 並取得回應</li></ol><p>上一步安裝後預設會自行啟動 Coturn，但為了後續的實驗，先把 turn service 關閉</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo service coturn status
</span></span><span class=line><span class=cl>// 如果有在運行，先關閉
</span></span><span class=line><span class=cl>$ sudo service coturn stop
</span></span></code></pre></td></tr></table></div></div><p>接著啟動 turnserver</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo turnserver
</span></span></code></pre></td></tr></table></div></div><p>稍微看一下 command line 跳出的訊息，大致說明</p><ol><li>file descriptor 上限，這會影響最大連線數，可以透過 <code>$ sudo ulimit -n {number}</code>去調整</li><li>支援的通訊協定，預設 STUN 支援 UDP / TCP / DTLS，但因為目前沒有指定憑證，所以 DTLS 不支援</li><li>採用的 Database，預設使用 SQLite，主要用來儲存 admin 資訊 / turn 連線資訊等，同時支援 MySQL / Redis / PostgreSQL / MongoDB，可以自由替換；<br>根據 Spec <code>STUN/TURN Server 處理連線是 State-less</code>，意即 Database 不是用來儲存連線資料，所以不用擔心會是 bottleneck (如果 Coturn 遵守 Spec 的話)</li></ol><p>看一下有沒有什麼錯誤，cli-password 錯誤可以先忽略</p><h3 id=啟動-turnserver>啟動 turnserver</h3><p>要測試之前，我們需要先設定 AWS security group，開放以下的 port</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>3478: UDP+TCP // TURN Server 接收 request 的 port 
</span></span><span class=line><span class=cl>5394: UDP+TCP  // TURN Server 接收 TLS request 的 port 
</span></span><span class=line><span class=cl>49152-65536: UDP+TCP  // 實際連線的 Socket Port range
</span></span></code></pre></td></tr></table></div></div><p>以上三個都能夠調整，但就先採用預設</p><p>接著啟動 turnserver</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo turnserver -v --lt-cred-mech --user hello:world --realm &lt;your domain name&gt; --external-ip &lt;your instance public-ip&gt;
</span></span></code></pre></td></tr></table></div></div><p>以上的參數代表</p><ol><li><code>-v</code>: 顯示詳細的 log</li><li><code>--lt-cred-mech</code>: 指定為 long term credential，稍後解釋</li><li><code>--user {username}:{password}</code>: 搭配 long term credential，指定 username / password</li><li><code>--realm</code>: 指定 TURN server 對應的 domain name，提示 client 要採用對應的驗證方式</li><li><code>--external-ip</code>: 指定 external ip，在 Coturn 文件寫到，如果是在 AWS EC2 上架設 external-ip 只要指定 public ic</li></ol><p>記得要去將綁定 domain name A record 指向 AWS instance</p><p>接著，有幾種測試方法</p><h4 id=1-使用-coturn-自帶的-test-tool>1. 使用 Coturn 自帶的 test tool</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ turnutils_uclient -T &lt;server ip&gt;
</span></span><span class=line><span class=cl>$ turnutils_stunclient &lt;server ip&gt;
</span></span></code></pre></td></tr></table></div></div><p>第一個會嘗試傳送封包，可以看 packet 的 loss rate 是否為 0 /<br>第二個會回傳主機 public ip (如果前面沒有 NAT 的話)，也就是 STUN 最主要的功用</p><h4 id=2-用瀏覽器開啟-webrtc-samples-trickle-ice>2. 用瀏覽器開啟 WebRTC samples Trickle ICE</h4><p><img src=/post/img/20200922/trickle-ice.png loading=lazy><br>輸入 server domain 時記得要加 <code>turn:{domain name}</code>，就可以成功拿到 STUN (srflx) / TURN (relay) 的紀錄</p><p>測試了一下，Chrome / Firefox 不支援 no auth 設定，Chrome 不支援 ip based 的 server</p><p>這樣就完成第一步的設定與測試，接著看 Coturn 的完整介紹與設定</p><h2 id=設定檔>設定檔</h2><p>設定檔的預設路徑為 <code>/etc/turnserver.conf</code>，也就是等等會修改的文件，可以放在其他地方用 cmd 指定<br>也可以從網路上看到官方的預設設定檔 <a class=link href=https://raw.githubusercontent.com/coturn/coturn/master/examples/etc/turnserver.conf target=_blank rel=noopener># Coturn TURN SERVER configuration file</a></p><h3 id=驗證>驗證</h3><p>STUN 的費用很便宜，只有簡單的 request / response，但是 TURN 就非常貴，因為要回放(Relay) P2P 的 media stream，所以 Bandwidth 相當驚人，這時候就需要加上帳號密碼的檢查</p><p>TURN 支援兩種模式，建議是兩者選其中一者</p><h4 id=long-term-credential>long term credential</h4><p>長期憑證屬於靜態類型，也就是 Client / Server 共用固定的帳號密碼，例如上述的 hello:world<br>在設定檔中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lt-cred-mech
</span></span><span class=line><span class=cl><span class=nv>user</span><span class=o>=</span>hello:world
</span></span><span class=line><span class=cl><span class=nv>user</span><span class=o>=</span>hello2:world2
</span></span><span class=line><span class=cl>....
</span></span></code></pre></td></tr></table></div></div><h4 id=short-term-credential>short term credential</h4><p>如果希望發給 Client 短期的憑證，或是希望多一層授權的流程例如從 API Server 給予等等，可以使用短期憑證</p><p>TURN 實作的方式是 Client / Server 共享一個固定的 secret key，接著使用 <code>HMAC_SHA1 將 username hashed</code>，username 的前半段是 unix timestamp<br>所以 TURN server 收到後，從 username 可以看出過期時間，透過 HMAC_SHA1 可以確保是由合法的 Client 所送出<br>設定檔寫法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>use-auth-secret
</span></span><span class=line><span class=cl>static-auth-secret<span class=o>={</span>secret<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nodejs 版本的產生規則如下，參考自 <a class=link href=https://stackoverflow.com/questions/35766382/coturn-how-to-use-turn-rest-api/35767224#35767224 target=_blank rel=noopener>CoTURN: How to use TURN REST API?</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>crypto</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;crypto&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// name 隨便填沒有關係
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>getTURNCredentials</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>secret</span><span class=p>){</span>    
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>unixTimeStamp</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=o>/</span><span class=mi>1000</span><span class=p>)</span> <span class=o>+</span> <span class=mi>24</span><span class=o>*</span><span class=mi>3600</span><span class=p>,</span>   <span class=c1>// this credential would be valid for the next 24 hours
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>username</span> <span class=o>=</span> <span class=p>[</span><span class=nx>unixTimeStamp</span><span class=p>,</span> <span class=nx>name</span><span class=p>].</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>hmac</span> <span class=o>=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>createHmac</span><span class=p>(</span><span class=s1>&#39;sha1&#39;</span><span class=p>,</span> <span class=nx>secret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>hmac</span><span class=p>.</span><span class=nx>setEncoding</span><span class=p>(</span><span class=s1>&#39;base64&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>hmac</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>hmac</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span> <span class=o>=</span> <span class=nx>hmac</span><span class=p>.</span><span class=nx>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>password</span><span class=o>:</span> <span class=nx>password</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=網路設定>網路設定</h3><p>網路設定就放在一塊看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>external-ip<span class=o>=</span>&lt;public ip&gt;
</span></span><span class=line><span class=cl>fingerprint
</span></span><span class=line><span class=cl><span class=nv>realm</span><span class=o>=</span>turn.yuanchieh.page
</span></span></code></pre></td></tr></table></div></div><p>以上是必須設定的參數</p><ol><li>external-ip:<br>TURN server 的 public ip，看文件完整的設定是 <code>external-ip=&lt;public ip>/&lt;private ip></code>，但因為在 AWS 上 EC2 處於 NAT 之後，所以只能放 public ip</li><li>fingerprint:<br>主要是 TURN Server 用來區分 packet，後續的 Spec 會有更詳細介紹</li><li>realm:<br>設定為自己指向 TURN Server 的 domain name，文件表示 TURN Server 可以指定多個 realm，每個 realm 有各自的 user 權限管理，Client 表明所屬的 realm 就能用對應的 user 檢查</li></ol><p>其餘還有非常多的設定，例如說</p><ol><li>是否要開放 UDP / TCP / DTLS / stun-only</li><li>設定不同的 port / port ranage</li><li>指定的 DB / Log 等等</li><li>每次連線 session 的時長 / 每個 user 的連線 quota 等等<br>這些細部的設定可以在慢慢看或是保留預設即可</li></ol><p>以下是我測試過成功的設定檔</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>external-ip<span class=o>=</span>52.72.33.185
</span></span><span class=line><span class=cl>verbose
</span></span><span class=line><span class=cl>fingerprint
</span></span><span class=line><span class=cl>use-auth-secret
</span></span><span class=line><span class=cl>static-auth-secret<span class=o>=</span>north
</span></span><span class=line><span class=cl><span class=nv>realm</span><span class=o>=</span>turn.yuanchieh.page
</span></span></code></pre></td></tr></table></div></div><p>啟動 turnserver 時透過 <code>-c</code> 指定 turnserver.conf 的位置，完成後建議在使用測試工具測試過</p><h2 id=sample-code>Sample Code</h2><p>為了更方便測試 TURN Server，自己寫了一個 Sample Code <a class=link href=https://github.com/sj82516/webrtc-turn-server-test target=_blank rel=noopener>Connection through self-hosted TURN server</a>，或是直接看 Demo Page <a class=link href=https://webrtc-turn-server-test.vercel.app/ target=_blank rel=noopener>https://webrtc-turn-server-test.vercel.app/</a>，輸入對應的帳號密碼，會主動生成對應的 iceServers</p><h2 id=go-to-production>Go To Production</h2><p>準備上正式環境時，還有監控以及可用性的調整</p><h3 id=監控>監控</h3><p>2020/12/04更新：目前 4.5.2 可以支援 <code>prometheus</code> 囉，可是只有支援 Debian，其他平台尚未支援，另外要注意直接用 <code>apt-get install coturn 版本目前是不支援 prometheus，需要自己手動編譯喔</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Version 4.5.2 <span class=s1>&#39;dan Eider&#39;</span>:
</span></span><span class=line><span class=cl>	- fix null pointer dereference in <span class=k>case</span> of out of memory. <span class=o>(</span>thanks to Thomas Moeller <span class=k>for</span> the report<span class=o>)</span>
</span></span><span class=line><span class=cl>    - merge PR <span class=c1>#517 (by wolmi)</span>
</span></span><span class=line><span class=cl>		* add prometheus metrics
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Warning: 撰文時開啟 prometheus 會有記憶體問題，建議先不要使用喔，詳見 github issue <a class=link href=https://github.com/coturn/coturn/issues/666 target=_blank rel=noopener>https://github.com/coturn/coturn/issues/666</a></p></blockquote><p><del>看到文件的範例以及設定檔支援 <code>prometheus</code> 這套開源的監控工具，但可惜實測下來暫時無法使用(4.5.1.2)，雖然說有相關的 branch 已經 merged 但是 Issue 還是開著 <a class=link href=https://github.com/coturn/coturn/issues/474 target=_blank rel=noopener>support export metrics to prometheus #474</a></del></p><h3 id=可用性>可用性</h3><p>如果只有單台 TURN server 掛掉導致服務中斷就很慘了，官方有幾個可用性/Load Balance 作法</p><ol><li>TCP Level LB Proxy:<br>需注意如果有使用 TURN 功能，必須確保同一個 Client 持續連到同一台 TURN Server，否則普通的 TCP LB 即可</li><li>DNS:<br>透過 DNS Round-Robin 紀錄，讓 Client 連到對應的 TURN Server</li><li>內建的 ALTERNATE-SERVER:<br>需要在所有的 TURN Server 之前建一台 LB，這台 LB 按照流量回給 Client ALTERNATE-SERVER 的錯誤，Client 就會按照指定的 Server 去走，達到 LB 的效果</li></ol><p>看來看去，採用 DNS 比較方便，AWS Route53 支援定期檢查 Server 狀態，只會回傳健康的 Server，同時能採用 Latency based 或是 Region based 的 DNS 紀錄，讓全球部署更加方便</p><h2 id=nat-介紹與-stunturn-使用>NAT 介紹與 STUN/TURN 使用</h2><p>先前有提到因為 NAT 關係，所以要建立 P2P 連線會需要 STUN Server 的幫助，但有一種 NAT 是必須透過 TURN Server，以下解釋這部分的狀況</p><p><a class=link href=https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2 target=_blank rel=noopener>Wiki NAT 網路位址轉換</a><br><a class=link href=https://blog.csdn.net/eydwyz/article/details/87364157 target=_blank rel=noopener>NAT的四种类型</a></p><p>簡單整理上面文中的重點</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ClientA <span class=o>(</span>192.168.9.1:3000<span class=o>)</span> ---&gt; NAT <span class=o>(</span>8.8.8.8:800<span class=o>)</span> ---&gt; Server1 <span class=o>(</span>1.1.1.1:1000<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ClientA 預先與 Server1 取得連線，此時假設 Server2 (2.2.2.2) 想要從 (8.8.8.8:800) 送資料給 ClientB</p><ol><li>完全圓錐型NAT<br>允許</li><li>受限圓錐型NAT<br>必須 ClientA 也送過請求給 Server2 (2.2.2.2)才可以</li><li>埠受限圓錐型NAT<br>必須 ClientA 也送過請求給 Server2 (2.2.2.2:1000)才可以，相較於上者 Port 必須固定</li><li>對稱NAT<br>不允許</li></ol><p>所以在 WebRTC 下，如果 Client 在完全圓錐型NAT，任一方發請連線都可以；<br>如果是在二、三種，則 Client 必須雙方同時發送請求，才符合 NAT 轉發條件；<br>第四種則不允許直接的 P2P</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/2021/2021-05-30-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-webrtc/><div class=article-details><h2 class=article-title>深入理解 WebRTC</h2></div></a></article><article><a href=/posts/2021/2021-01-21-%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E5%AE%89%E5%85%A8%E7%9A%84-production-ready-node.js-docker-image/><div class=article-details><h2 class=article-title>如何打造安全的 production ready Node.js Docker Image</h2></div></a></article><article><a href=/posts/2020/2020-09-22-rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/><div class=article-details><h2 class=article-title>RFC 5389 - STUN 協定介紹</h2></div></a></article><article><a href=/posts/2020/2020-04-23-vault-%E6%95%99%E5%AD%B8-%E9%9B%86%E4%B8%AD%E5%8C%96%E7%AE%A1%E7%90%86%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99%E4%B8%8A/><div class=article-details><h2 class=article-title>Vault 教學-集中化管理機敏資料(上)</h2></div></a></article><article><a href=/posts/2020/2020-04-15-packer%E6%95%99%E5%AD%B8-%E6%89%93%E9%80%A0-image%E8%88%87%E5%AF%A6%E9%9A%9B%E4%BD%BF%E7%94%A8%E7%B6%93%E9%A9%97/><div class=article-details><h2 class=article-title>Packer教學-打造 Image與實際使用經驗</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//yuanchieh.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Yuanchieh</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.17.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>