[{"content":"å½¼å¾—åŸç†æ˜¯å½¼å¾—åšå£«è§€å¯Ÿçœ¾å¤šä½æ•ˆçµ„ç¹”æ‰€å¾—å‡ºçš„çµè«– 1\nåªæœ‰å‡é·çš„æ©Ÿæœƒå¤ å¤šå¤ é »ç¹ï¼Œæœ€çµ‚äººå€‘éƒ½æœƒæŠµå¾—ä¸é©ä»»çš„è·ä½\né€™äº›ä¸é©ä»»çš„äººåšå‡ºä¸æ°ç•¶çš„æ±ºç­–ï¼Œå°è‡´æ•´å€‹çµ„ç¹”çš„æ•ˆèƒ½èˆ‡ç”¢å‡ºååˆ†ä½è½ï¼Œä½†æœ‰è¶£çš„æ˜¯é€™äº›ä¸é©ä»»çš„äººä¸æ˜¯åˆ»æ„æ“ºçˆ›ï¼Œç”šè‡³åœ¨ä»–å€‘å‡è·ä¹‹å‰éƒ½æ˜¯å„ªç§€ä¸”é©ä»»çš„å“¡å·¥2ï¼Œåˆ°åº•ç™¼ç”Ÿæ‰æœƒç”¢ç”Ÿé€™æ¨£çš„æ‚²åŠ‡ï¼Ÿæˆ‘å€‘åˆè©²å¦‚ä½•é¿å…é€™æ¨£çš„æ‚²åŠ‡ç™¼ç”Ÿå‘¢ï¼Ÿ\né€ æˆå½¼å¾—åŸç†çš„åŸå›  ä¸»è¦æœ‰å…©å€‹\næ‰¾å·¥ä½œçš„æŠ€èƒ½èˆ‡å¯¦éš›å·¥ä½œçš„æŠ€èƒ½ç„¡é—œ3\nç•¶ä¸»ç®¡è·ä½ç©ºç¼ºæ™‚ï¼Œåº•ä¸‹æœ‰ä¸€æ‰¹å·¥ç¨‹å¸«ï¼Œé€™æ™‚å€™æœƒæ€éº¼å¾ä¸­é¸æ‹”å‡ºé©åˆçš„äººé¸ç•¶ä½œä¸»ç®¡ï¼Ÿæ˜¯é€éå¹´è³‡ã€è³‡æ­·é‚„æ˜¯èº«ç‚ºå·¥ç¨‹å¸«çš„å·¥ä½œèƒ½åŠ› ?!\nä¸»ç®¡å¿…é ˆæœ‰è‰¯å¥½çš„æºé€šèˆ‡ç®¡ç†èƒ½åŠ›ï¼Œå¦‚æœç”¨ä¸Šè¿°çš„å¹¾ç¨®æ–¹å¼éƒ½å¯èƒ½é¸å‡ºä¸é©ä»»çš„ä¸»ç®¡ï¼Œä¾‹å¦‚å¯«ç¨‹å¼é€Ÿåº¦å¾ˆå¿«çš„å·¥ç¨‹å¸«å‡ä¸Šä¸»ç®¡å¾Œä¾ç„¶è¦ªåŠ›è¦ªç‚ºï¼Œä¸æ‡‚çš„ç®¡ç†èˆ‡åˆ†é…å·¥ä½œï¼Œæ•´é«”çš„ç”¢èƒ½åªæœƒä¸‹é™\næ‰€ä»¥ç•¶ææ‹”çš„è©•ä¼°æ–¹å¼èˆ‡å¯¦éš›å·¥ä½œçš„æŠ€èƒ½è„«é‰¤ï¼Œå°±å®¹æ˜“æœ‰ä¸é©ä»»çš„ç‹€æ³ å½¼å¾—è‹¦æ¨‚è«–4\nå¦‚æœæŸç¨®è¡Œç‚ºå¸¶ä¾†æ­£é¢å›é¥‹ï¼Œé‚£æœªä¾†è©²è¡Œç‚ºå°±æœƒæŒçºŒç™¼ç”Ÿï¼Œå¾å‹•ç‰©å¯¦é©—(å¦‚å¤å…¸åˆ¶ç´„)ï¼Œåˆ°äººé¡çš„ç¤¾æœƒåŒ–éç¨‹éƒ½æ˜¯å¦‚æ­¤ æˆ‘å€‘å¾å°å°±è¢«çŒè¼¸æˆç¸¾ã€é‡‘éŒ¢èˆ‡åœ°ä½çš„é‡è¦ï¼Œé€æ¼¸å…§åŒ–æˆæˆ‘å€‘çš„åƒ¹å€¼è§€å°±æ˜¯è¦ä¸æ–·çš„å¾€éšå±¤ä¸Šçˆ¬ï¼Œå¦‚æœä¸å¾€ä¸Šçˆ¬åè€Œæœƒè¢«å’è²¬\nè¡ç”Ÿçš„å•é¡Œæ˜¯ã€Œç•¶æˆ‘å€‘å‡é·å¾Œç™¼ç¾ä¸é©ä»»ï¼Œé€šå¸¸ä¸æœƒæœ‰å¾€å¾Œé€€çš„æƒ³æ³•ã€ï¼Œåªèƒ½ç„¡é™çš„ä¸Šæ”€ç›´åˆ°ä¸é©ä»»ç‚ºæ­¢ å½¼å¾—åŸç†çœ‹ä¼¼ä¾‹å¤–ä½†å…¶å¯¦ä¸æ˜¯ä¾‹å¤– æœ‰æ²’æœ‰é•åå½¼å¾—åŸç†çš„å­˜åœ¨ï¼Ÿä¹Ÿå°±æ˜¯èªªã€Œäººé€£çºŒç²å¾—ææ‹”ä½†é‚„æ˜¯ä¾ç„¶é©ç”¨çš„éšæ®µã€ï¼Œä½œè€…æå‡ºå¹¾å€‹å¾ˆæœ‰è¶£çœ‹ä¼¼ä¾‹å¤–ä½†ä¸æ˜¯ä¾‹å¤–çš„æ¡ˆä¾‹5\né›è‚‹å‡é·\næœ‰æ™‚å€™æœƒçœ‹åˆ°æŸäº›èƒ½åŠ›ä¸è¶³çš„äººä¾ç„¶å¯ä»¥ç²å¾—ã€Œå‡é·ã€ï¼Œä½†é€™ç¨®å±¬æ–¼æ˜å‡æš—é™ï¼Œæ›å€‹æ›´å¥½çš„é ­éŠœä½†å…¶å¯¦æ‹”é™¤å¯¦è³ªçš„è² é¢å½±éŸ¿åŠ› å€’ç½®å½¼å¾—ï¼šé‡è¦–ç¨‹åºå‹éæ–¼çµæœ\nå¸¸è¦‹æ–¼è¡Œæ”¿äººå“¡ï¼Œç˜‹ç‹‚çš„å¡«å¯«å„ç¨®è¡¨æ ¼å»ä¸æ€è€ƒé€™å°æ–¼çµæœæ˜¯å¦æœ‰å¹«åŠ©ï¼Œé€™èˆ‡çµ„ç¹”çš„æ–‡åŒ–æœ‰é—œï¼Œå¦‚æœçµ„ç¹”åœ¨æ„å“¡å·¥çš„ç©©å®šæ€§å‹éæ–¼èƒ½åŠ›ï¼Œé‚£å°±æœƒé€ æˆé€™å€‹æƒ…æ³åŠ£åŒ– é©ä»»é«˜å³°ï¼šåœ¨è‡ªå·±ä½ç½®ç™¼æ®å“è¶Šçš„äººå¯èƒ½åªæ˜¯é”åˆ°é ‚å³°æ²’æœ‰ä½ç½®å¯ä»¥å‡é·\nåœ¨æŸäº›é ˜åŸŸæœ‰äº›äººçˆ¬åˆ°é ‚å³°ä¾ç„¶é©ä»»ï¼Œä½†å¯èƒ½ä¸å®‰ä»½è·¨è¶³å…¶ä»–é ˜åŸŸè®“è‡ªå·±æœ€çµ‚ä¸é©ä»»ï¼Œä¾‹å¦‚å¸Œç‰¹å‹’æ˜¯å¥½çš„æ”¿æ²»å®¶ï¼Œä½†ä¸æ˜¯å¥½çš„å…ƒå¸¥ éšç´šå»è§’è³ªï¼šç•¶è¡¨ç¾å¤ªå¥½åè€Œæœ‰å¯èƒ½è¢«èªç‚ºä¸é©ä»»ï¼Œå› ç‚ºå¯¦åŠ›å¥½åˆ°è¶³ä»¥æ“¾äº‚æ•´å€‹éšå±¤çš„ç©©å®š å­æ‰¿çˆ¶æ¥­ å½¼å¾—åŸç†çœ‹å©šå§»11 ç¤¾æœƒåƒ¹å€¼å°è‡´å…©æ€§å°æ–¼å½¼æ­¤çš„æœŸå¾…éé«˜ï¼Œå°è‡´è‡ªå·±æˆç‚ºä¸é©ä»»çš„ä¼´ä¾¶ï¼Œé€²è€Œå°è‡´ä¸å¹¸ç¦çš„å©šå§»\nç°å§‘å¨˜é›–ç„¶é€éé­”æ³•è®Šæ¼‚äº®å«çµ¦ç‹å­ï¼Œä½†æœ‰æ²’æœ‰å¯èƒ½å› ç‚ºå®¶ä¸–èƒŒæ™¯ä¸åŒï¼Œç‹å­å¾ˆå¿«å°±å—ä¸äº†ç°å§‘å¨˜ä¸æ‡‚ç¦®ä¿—èˆ‡ä¸Šæµæ–‡åŒ– ?! åè€Œä½¿å¾—é€™å ´å©šå§»ä»¥æ‚²åŠ‡æ”¶å ´\nç—‡ç‹€ æœ€å¾Œç•¶äººæŠµé”ä¸é©ä»»è·ä½æ™‚ï¼Œç¨±ç‚ºã€Œæœ€çµ‚è·ä½ç—‡å€™ç¾¤ã€ï¼Œä»¥ä¸‹ä¾†çœ‹å„ç¨®ç›¸é—œçš„ç—‡ç‹€\nå¤–é¡¯çš„ç—‡ç‹€ é–‹å§‹ç”¨ä¸€äº›å¤–åœ¨ã€è™›ç„¡ç¸¹ç·²çš„äº‹æƒ…ä¾†æ©é£¾è‡ªå·±çš„ç„¡èƒ½ï¼Œæ¢åˆ—å¹¾å€‹è »æœ‰è¶£ä¸”å¸¸è¦‹çš„ç—‡ç‹€6\nè®Šæ…‹è¾¦å…¬æ¡Œï¼šå·¨å¤§åŒ–è¾¦å…¬æ¡Œã€æª”æ¡ˆç™– é¡§å½±è‡ªæ†ï¼šå–œæ­¡å›æ†¶ç•¶å¹´ (é‚„åœ¨é©ä»»éšæ®µ) åœ–è¡¨ç‹‚ç†± åè¦†ç„¡å¸¸ ç”¨å¤–è¡¨è©•æ–·äº‹æƒ… å£è‹¥æ‡¸æ²³ä¸çŸ¥æ‰€äº‘ è‡ªå‰µåè©è‡ªæˆ‘è§£é‡‹ ~ä½ çš„ä¸»ç®¡åˆä¸­äº†å¹¾é …å‘¢~\nå…§åœ¨ç—‡ç‹€ èƒƒæ½°ç˜ã€é«˜è¡€å£“ã€ä¾¿ç§˜ã€è…¹ç€‰ç­‰å£“åŠ›é€ æˆçš„æ–‡æ˜ç—…ï¼Œå¸¸å‡ºç¾åœ¨æ‰€è¬‚çš„ã€ŒæˆåŠŸäººå£«ã€èº«ä¸Šï¼Œé€™æ™‚å€™å¯èƒ½æœƒæ¡ç”¨æ²»æ¨™ä¸æ²»æœ¬çš„æ–¹å¼ï¼Œä¾‹å¦‚è½‰ç§»ç„¦é»åŸ¹é¤Šæ–°çš„èˆˆè¶£ç­‰ï¼Œä½†çœŸæ­£å•é¡Œæ˜¯ã€Œä¸é©ä»»ã€å°è‡´çš„å£“åŠ›éå¤§\nPansci æœ€è¿‘çš„å½±ç‰‡ ç§‘å­¸å¯¦è­‰ã€Œå¿ƒæƒ…ä¸ä½³çœŸçš„æœƒé€ æˆæ¶ˆåŒ–ã€çš®è†šç™¼ç‚ã€å¿ƒè¡€ç®¡å¥åº·å•é¡Œã€ï¼Œä½†ç‚ºä»€éº¼ï¼Ÿä½è­‰äº†å¿ƒæƒ…èˆ‡èº«é«”ç–¾ç—…çš„é—œè¯\nå¦‚ä½•é¿å…ä¸é©ä»»çš„ç‹€æ³ ä¸»è¦åˆ†æˆå…©å€‹é¢å‘ï¼Œä¸€å€‹æ˜¯ã€Œå€‹äººè¦èªæ¸…ä¸æ‡‰è©²ç„¡ç¶«å¾€ä¸Šæ”€çˆ¬éšå±¤ã€ä»¥åŠã€Œç®¡ç†è€…æ‡‰è©²é¿å…å‡é·ä¸é©ä»»äººé¸ã€\nå€‹äººç¯‡ å‰é¢æåˆ°å½¼å¾—è‹¦æ¨‚è«–ï¼Œäººè¢«ç¤¾æœƒåŸ¹é¤Šæˆåªèƒ½å¾å¤–åœ¨ç²å¾—å‹•æ©Ÿèˆ‡å¿«æ¨‚ï¼Œä½†æœ€é«˜å±¤æ¬¡æ‡‰è©²æ˜¯è¦ã€Œè‡ªæˆ‘è‚¯å®šã€ï¼Œé€™èƒŒå¾Œéœ€è¦æœ‰æ˜ç¢ºçš„å€‹äººç›®æ¨™ã€æ¸…æ™°çš„è¨ˆç•«é‚å‘ç›®æ¨™ã€æœ‰å¯é‡åŒ–çš„æŒ‡æ¨™æ™‚åˆ»æ³¨æ„é›¢ç›®æ¨™çš„è·é›¢ï¼Œæœ€çµ‚é€éè‡ªæˆ‘çš„æª¢è¦–ä¾†è‚¯å®šè‡ªå·±7\næ“ºè„«å¤–åœ¨çš„åƒ¹å€¼è§€æ‰èƒ½å¸¶ä¾†çœŸæ­£çš„å¿«æ¨‚ï¼Œä¹Ÿå°±é¿å…æ‰ç„¡è¬‚çš„æ”€æ¯”èˆ‡ä¸é©ä»»çš„æ©Ÿæœƒ\nå¦‚ä½•è®“äººç”Ÿä¿æŒå¿«æ¨‚æ˜¯å€‹å¤§å“‰å•ï¼Œã€Šå½¼å¾—è™•æ–¹ã€‹åœ¨å€‹äººç¯‡åªæœ‰ç¨å¾®é»å‡ºä¸€äº›å¸¸è¦‹çš„ä½œæ³•ï¼Œä¾‹å¦‚é‹å‹•ã€éœå¿ƒã€ç›¤é»è‡ªå·±ç†±æ„›çš„äº‹æƒ…ã€è¨­å®šå€‹äººç›®æ¨™ç­‰\nå¯¦éš›é¢å°å‡é·æ™‚ï¼Œå¯ä»¥ç”¨å…©ç¨®å½¼å¾—é é˜²æ€§æ²»ç™‚ä¾†æ€è€ƒ\nè² é¢æ€è€ƒ8\nä½¿ç”¨ã€Œæƒ³æƒ³æœªä¾†è¦è·Ÿä¸»ç®¡çš„ä¸»ç®¡å…±äº‹ã€å‡é·å¾Œçš„å·¥ä½œèˆ‡ç”Ÿæ´»å‹æ…‹æ˜¯å¦æƒ³è¦ï¼Ÿç•¶æœ‰äº†æ›´å¤šçš„éŒ¢æƒ³è¦åšä»€éº¼ï¼ŸçœŸçš„éœ€è¦å‡é·æˆ–æ›´å¤šçš„éŒ¢å—ï¼Ÿã€æ±ºå®šæ˜¯å¦è¦å‡é· å‡æ€§ä¸é©ä»»9\nåœ¨ä¸€äº›ç„¡æå°ˆæ¥­èƒ½åŠ›çš„å°æ¯›ç—…çŠ¯éŒ¯ï¼Œè®“åˆ¥äººèª¤ä»¥ç‚ºå·²ç¶“åˆ°é”ä¸é©ä»»ï¼Œé¿é–‹å‡é·æ©Ÿæœƒï¼Œåˆ‡è¨˜ä¸å¯ä»¥ç›´æ¥å›çµ•å‡é·é€™æœƒè®“äººè¦ºå¾—æ²’æœ‰ä¸Šé€²å¿ƒç­‰è² é¢è§€æ„Ÿï¼Œè¦ç”¨æ¯”è¼ƒè¿‚è¿´çš„æ‰‹æ®µé”åˆ°ä¸å‡é·çš„ç›®çš„ å¦‚æœå·²ç¶“å‡é·åˆ°ä¸é©ä»»éšç´šï¼Œå¯ä»¥ç”¨å½¼å¾—å®‰æ…°åŠ‘ä¾†ç·©è§£ç—‡ç‹€\næ°¸ç„¡æ­¢ç›¡çš„æº–å‚™ï¼šé€ƒé¿å¯¦éš›åŸ·è¡Œ å°ˆç²¾æå¾®æœ«ç¯€çš„å°äº‹ ä»¥å½¢è±¡è“‹éå·¥ä½œè¡¨ç¾ åšè·Ÿå·¥ä½œå®Œå…¨ç„¡é—œçš„äº‹æƒ… æˆç‚ºè·å‹™ä»£ç†äººï¼šé¿å…äº†åŸæœ¬ä¸é©ä»»çš„è·ä½ï¼Œä¹Ÿä¸ç”¨æ‰¿æ“”ç¾æœ‰ä»£ç†è·ä½çš„è²¬ä»» ç®¡ç†è€…ç¯‡ ç®¡ç†è€…é¦–è¦ä¹‹é‡æ˜¯æ˜å®šç›®æ¨™èˆ‡è·ä½æ‰€éœ€çš„èƒ½åŠ›ï¼Œæ‰èƒ½ä¾æ­¤ä¾†è©•æ–·äººé¸æ˜¯å¦é©åˆï¼Œå¯ä»¥é€éè©¦è¡Œå‡é·ã€æš—ä¸­è€ƒæ ¸ã€æå‰åŸ¹é¤Šèƒ½åŠ›ç­‰æ–¹å¼ï¼Œå…ˆç¢ºä¿äººé¸æœ‰è¶³å¤ èƒ½åŠ›æ‰å‡é·9\nå¾€å¾Œé€€ä¸€æ­¥ï¼Œå‡é·åªæ˜¯ç®¡ç†è€…æ¿€å‹µå“¡å·¥çš„ä¸€ç¨®æ–¹å¼ï¼Œé€™é‚Šéœ€è¦äº†è§£åˆ°å“¡å·¥å·¥ä½œçš„å‹•æ©Ÿå› ç´ ï¼Œé€™é»åœ¨ã€Šä½ å¦‚ä½•è¡¡é‡ä½ çš„äººç”Ÿã€‹æ›¸ä¸­æœ‰ç‰¹åˆ¥è‘—é‡ é›™å› ç´ ç†è«– 12\né›™å› ç´ ç†è«–ï¼šè–ªæ°´åªæ˜¯ã€Œä¿å¥å› ç´ ã€ï¼Œå……å…¶é‡è®“ä½ ä¸è¨å­å·¥ä½œè€Œã€Œå…§åœ¨å‹•æ©Ÿã€æ‰æœƒè®“å·¥ä½œæ›´å¿«æ¨‚\næ›´è¿‘ä¸€æ­¥ä¾†èªªï¼Œæ¶ˆæ»…ä¸å¿«æ¨‚ä¸æœƒä½¿ä½ å¿«æ¨‚!ï¼Œé€™æ˜¯ä¸€å€‹è »æœ‰è¶£çš„è§€å¿µï¼Œæ›´é€²ä¸€æ­¥èªªæ˜å¯ä»¥åƒè€ƒ äººç”ŸçœŸæ­£çš„å¿«æ¨‚æ˜¯ä»€éº¼ï¼Ÿå¤§å¤šæ•¸äººéƒ½ç†è§£éŒ¯äº†\u0026hellip; â–º è½è½å“ˆä½›æ•™æˆæ€éº¼èªª - Dr. Arthur Brooks é˜¿ç‘ŸÂ·å¸ƒé­¯å…‹æ–¯\næ”¤é–‹æ‰€æœ‰çš„çå‹µè¾¦æ³•ï¼ŒåŒ…å«è–ªæ°´ã€å‡é·ã€æå‡åœ°ä½ã€ç¸¾æ•ˆè€ƒæ ¸ã€å“¡å·¥åˆ†æ½¤å¤–ï¼Œé‚„æœ‰è®šç¾ã€æˆæ¬Šã€å¼·åŒ–å“¡å·¥èƒ½åŠ›ç­‰æ–¹å¼10ï¼Œéœ€è¦å¦¥å–„ä¾ç…§å“¡å·¥èƒ½åŠ›èˆ‡éšæ®µçµ¦èˆ‡å°æ‡‰çš„çå‹µå¦‚ æƒ…å¢ƒå¼é ˜å°ï¼Œå–®ç´”ç”¨è–ªè³‡æˆ–å‡é·ä¸æ˜¯è‰¯å¥½çš„æ¿€å‹µè¾¦æ³•\nç¸½çµ å½¼å¾—åšå£«åœ¨æ›¸ä¸­ç”¨æ¯”è¼ƒè«·åˆºè¾›è¾£çš„å£å»åœ¨æè¿°ï¼Œä¸¦å‰µé€ ä¸€å †å½¼å¾—å‰ç¶´çš„è©å½™ä¾†è«·åˆºç¾è±¡ï¼Œè®€èµ·ä¾†è »æœ‰è¶£çš„ï¼Œçœ‹åˆ°æŸä¸€äº›äººç‰©è¨­å®šèˆ‡å ´æ™¯è·Ÿä»¥å‰çš„å·¥ä½œç¶“é©—å»åˆä¸å…æœƒå¿ƒä¸€ç¬‘ï¼Œä½†çœ‹çœ‹åˆ¥äººæƒ³æƒ³è‡ªå·±ï¼Œä¹Ÿåœ¨æ€è€ƒè‡ªå·±æ˜¯å¦ä¸€ç›´è¢«å¤–åœ¨æ‰€é©…å‹•ï¼ŒæŠ‘æˆ–æ˜¯è‡ªå·±å·²ç¶“æˆç‚ºå½¼å¾—è€Œä¸è‡ªçŸ¥ (å¸Œæœ›é‚„æ²’)\næ•´ç†ä¸Šé€™å…©æœ¬æ›¸è »å€¼å¾—ä¸€èµ·çœ‹ï¼Œã€Šå½¼å¾—è™•æ–¹ã€‹é€™æœ¬æ›¸å…§å®¹å€‹äººè¦ºå¾—æ¯”è¼ƒå–®è–„ï¼Œåªèƒ½èªªèœ»èœ“é»æ°´å¼æŠŠå¸¸è¦‹çš„ä½œæ³•æé»å‡ºä¾†ï¼Œä½†å…§å®¹æ¯”è¼ƒå°‘éœ€è¦å†å¾€ä¸‹é‘½ç ”\né™„éŒ„ ç›®å‰å˜—è©¦ç”¨å¡ç‰‡ç›’ç­†è¨˜ heptabaseã€Šå½¼å¾—åŸç†ã€‹èˆ‡ã€Šå½¼å¾—è™•æ–¹ã€‹ç­†è¨˜ï¼Œç›¡é‡æœƒæŠŠæ‘˜è¦å…§å®¹å°æ‡‰çš„æ›¸é é™„ä¸Šï¼Œæ–¹ä¾¿å›é ­æŸ¥é–±\nã€Šå½¼å¾—åŸç†ã€‹p42 ã€Šå½¼å¾—åŸç†ã€‹p48 ã€Šå½¼å¾—åŸç†ã€‹p7 ã€Šå½¼å¾—è™•æ–¹ã€‹p104 ã€Šå½¼å¾—åŸç†ã€‹p54 ã€Šå½¼å¾—åŸç†ã€‹p162 ã€Šå½¼å¾—è™•æ–¹ã€‹p75 ã€Šå½¼å¾—åŸç†ã€‹p219 ã€Šå½¼å¾—è™•æ–¹ã€‹p189 ã€Šå½¼å¾—è™•æ–¹ã€‹p213 ã€Šå½¼å¾—è™•æ–¹ã€‹p30 ã€Šä½ å¦‚ä½•è¡¡é‡ä½ çš„äººç”Ÿã€‹p54 ","date":"2023-05-17T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-05-17-%E5%BD%BC%E5%BE%97%E5%8E%9F%E7%90%86%E8%88%87%E5%BD%BC%E5%BE%97%E8%99%95%E6%96%B9%E5%BF%83%E5%BE%97%E5%88%86%E4%BA%AB/","title":"ã€Šå½¼å¾—åŸç†ã€‹èˆ‡ã€Šå½¼å¾—è™•æ–¹ã€‹å¿ƒå¾—åˆ†äº«"},{"content":"ä¹‹å‰å°æ–¼éœ²ç‡Ÿè»Šé‡ç‡Ÿä¸€ç›´å……æ»¿è‘—æƒ³åƒï¼Œæƒ³åƒè‡ªå·±å¯ä»¥å¾ˆè²¼è¿‘å¤§è‡ªç„¶ï¼Œç¡é†’æ‰“é–‹è»Šé–€å°±å¯ä»¥æ²ˆæµ¸åœ¨æµ·è²ã€å±±æ—ä¹‹ä¸­ï¼Œæœ€è¿‘æ’å‡ºä¸‰å¤©å…©å¤œç§Ÿå€Ÿ GoodGoodVanï¼Œç°¡å–®åˆ†äº«ä¸€äº›å¿ƒå¾—èˆ‡å„ªåŠ£ï¼Œä»¥åŠç°¡æ˜“çš„è¡Œç¨‹è¡¨ä¾›å¤§å®¶åƒè€ƒ ä¸»è¦æƒ³ä¸€å¤©çœ‹æµ·ä¸€å¤©çœ‹å±±ï¼Œæ‰€ä»¥ç¬¬ä¸€å¤©æŒ‘æˆ°è»Šæ³Šå¤–æ¾³è»Šç«™ï¼Œç¬¬äºŒå¤©å®šéœ²ç‡Ÿåœ° å¤è«¾ç‡Ÿç‡Ÿåœ°\nå„ªé» è²¼è¿‘å¤§è‡ªç„¶\næˆ‘å€‘ç¬¬ä¸€å¤©åœåœ¨å¤–æ¾³è»Šç«™å°é¢çš„åœè»Šä½ï¼Œä¸€æ—©æ‰“é–‹å°±çœŸçš„æ˜¯çœ‹æµ·è½æµªè²ï¼Œåœ¨å¤è«¾ç‡Ÿç‡Ÿåœ°æ™šä¸Šå¯ä»¥çœ‹å¤œæ™¯ã€æ—©ä¸Šå°±æ˜¯çœ‹çœ‹æ²³æ™¯ï¼Œéå¸¸è¿·äºº é‹ªä¸Šç‡ˆå…·æ°£æ°›æ»¿åˆ†\nç¬¬ä¸€å¤©æ™šä¸Šæœ‰åˆ°å¤–æ¾³æ²™ç˜ä¸Šååï¼Œé‹ªä¸Šç‡ˆå…·æ•ˆæœåè¶³ï¼Œå¹è‘—æµ·é¢¨è²¼è‘—éŸ³æ¨‚ååˆ†æ„œæ„ è»Šå­æœƒä¸æœƒä¸å¥½é–‹ èº«ç‚ºä¸€å€‹æœˆé ‚å¤šåªé–‹ä¸€æ¬¡ iRent çš„é–‹è»Šå°ç™½ï¼Œä¸€é–‹å§‹ç§Ÿè»Šæœ‰é»æ€• Veryca (GoodGoodVan è»Šå‹)æœƒä¸æœƒå¤ªå¤§å°ä¸å¥½é–‹ï¼Œä½†å¯¦éš›é–‹äº†ä¸‰å¤©è¦ºå¾—æ²’ä»€éº¼å•é¡Œï¼Œé™¤äº†ç¢ºå¯¦è»Šèº«æ¯”è¼ƒé•·æ‰€ä»¥å€’è»Šæ¯”è¼ƒå›°é›£ï¼Œä½†å…¶é¤˜ä¸Šè·¯ã€åœè»Šéƒ½æ²’æœ‰å•é¡Œ\nç”šè‡³æˆ‘è¦ºå¾—æ²¹é–€è¸©èµ·ä¾†æ¯” Toyota çš„ Yaris æœ‰åŠ› ğŸ˜† è€Œä¸”è»Šèº«æ¯”è¼ƒé«˜è¦–é‡è·Ÿåå§¿ä¹Ÿæ¯”è¼ƒèˆ’æœä¸€äº›ï¼Œåªæ˜¯åœ¨è½‰å½æ™‚é›¢å¿ƒåŠ›æœ‰é»æ˜é¡¯ç¨å¾®ä¸ç©©ï¼Œå…¶é¤˜ç‹€æ³éƒ½å¾ˆ OKï¼Œé–‹ä¸Šé«˜é€Ÿå…¬è·¯ä¹Ÿéƒ½æ²’ä»€éº¼ç‹€æ³\nç¼ºé» èªªå®Œå„ªé»ä¾†è¬›ä¸€äº›ç§Ÿè»Šå‰æ²’æ³¨æ„åˆ°çš„ç¼ºé»\néš±è”½æ€§è¼ƒå·®ï¼Œæ·ºçœ è€…å®¹æ˜“æœƒè¢«åµé†’\nç¬¬ä¸€å¤©æ˜¯è»Šæ³Šå¤–æ¾³è»Šç«™ï¼Œå‰›å¥½é‚£é‚Šæœ‰é…’å§é–‹æ¯”è¼ƒæ™šï¼Œæ‰€ä»¥éƒ½æœƒæœ‰äººè²è·Ÿèµ°å‹•è²ï¼Œå¾…åœ¨è»Šå…§å› ç‚ºéš”éŸ³ä¹Ÿæ²’æœ‰å¾ˆå¥½ï¼Œæ‰€ä»¥åªè¦æœ‰äººèµ°å‹•å°±æœƒè¢«åµé†’ä¸€ä¸‹ï¼Œç¡çœ å“è³ªä¸å¤ªå¥½ï¼›\nç¬¬äºŒå¤©åˆ°å¤è«¾ç‡Ÿç‡Ÿåœ°å‰›å¥½ç•¶å¤©åªæœ‰æˆ‘å€‘ä¸€çµ„å®¢äººï¼Œå¾ˆå®‰éœæ‰€ä»¥ç¡ä¸å¾—éŒ¯ï¼Œä½†å¦‚æœæœ‰å…¶ä»–çµ„ä¸€èµ·éœ²ç‡Ÿå°±ä¸ç¢ºå®šç¡çœ å“è³ªäº†\nè»Šå…§ç©ºæ°£ä¸æµé€š GoodGoodVan å¾Œåº§åªæœ‰ä¸€æ‰‡å¯ä»¥å¤–æ¨çš„å°å¤–çª—ï¼Œå…¶é¤˜å¹¾é¢éƒ½ä¸èƒ½é–‹ï¼Œæ‰€ä»¥ç©ºæ°£å¾ˆä¸æµé€šï¼Œåœ¨å±±ä¸Šé‚„å¥½å¹³åœ°æ™šä¸Šå°±æœ‰é»æ‚¶ç†±\nå®¤å…§å†·æ°£éå¸¸åµåŸºæœ¬ä¸èƒ½ç”¨ å®¤å…§å†·æ°£å¿…é ˆæ¥é›»æ‰èƒ½å•Ÿå‹•ï¼Œä½†éå¸¸åµæˆ‘è¦ºå¾—ç¡è¦ºè¦é–‹æ ¹æœ¬ç¡ä¸è‘—ï¼Œç›´æ¥çœ‹å½±ç‰‡æ¯”è¼ƒå¯¦éš› å¾Œåº§çš„åºŠä¸å¥½ç¡\nåºŠæ˜¯å¾Œåº§æ‰“å¹³ç›´æ¥ç¡ï¼Œä½†å¾Œåº§ä¸æ˜¯å®Œå…¨å¹³æ•´ï¼Œæ‰€ä»¥ç¡èµ·ä¾†è…°çš„éƒ¨åˆ†ç°ç©ºå…¶å¯¦ä¸å¤ªå¥½ç¡ï¼Œå¾Œä¾†æœ‰é‹ªå€‹ç¡è¢‹æ‰ç¨å¾®å¥½ä¸€äº›\næœ‰çœ‹ä¸€äº›æ¯”è¼ƒå¥½çš„éœ²ç‡Ÿè»Šè»Šæ¬¾æœƒæœ‰é¡å¤–çš„åºŠæ¿è·Ÿç¡å¢Šï¼Œé€™æ¨£æ¯”è¼ƒå¹³æ•´æ‡‰è©²æ‰æœƒæ¯”è¼ƒå¥½ç¡ï¼›åºŠçš„å°ºå¯¸å¤§æ¦‚å…©å€‹æˆäºº (170 cm) å‰›å‰›å¥½ï¼Œåœ¨é«˜ä¸€é»è…³å°±æœƒæ‡¸ç©ºäº†\nå¦‚æœæœ‰å¸¸åœ¨éœ²ç‡Ÿçš„ï¼Œç¼ºé»1 æ‡‰è©²ä¸æ˜¯å•é¡Œ / è‡³æ–¼ç¼ºé»2ã€3é–‹åˆ°å±±å€æ¯”è¼ƒæ¶¼çˆ½çš„åœ°æ–¹ä¹Ÿä¸æ˜¯å•é¡Œï¼Œç¼ºé»4 å°±è¦è‡ªå·±æº–å‚™ç¡å¢Šæˆ–æœ¬èº«æ˜“ç¡é«”è³ªæ‰èƒ½å¤ å…‹æœ\nå…¶ä»–é›œè¨˜ è¡Œç¨‹ç°¡æ˜“æµæ°´å¸³ Day1\n10 é»åœ¨æ·¡æ°´ç«™å–è»Š å…ˆå›å®¶è¼‰è¡Œæï¼Œç›´æ¥åˆ°å®œè˜­ å±‹å°æ‹‰éºµ å·æ¹¯æ³¡ Spa åŠ è‡ªåŠ©æ™šé¤ï¼ŒSpa æœ‰å¤šç¨®å£å‘³çš„æº«æ³‰è »å¥‡ç‰¹ï¼Œæ™šé¤é‚„ç®—ä¸éŒ¯ å¤œå®¿å¤–æ¾³è»Šç«™å°é¢åœè»Šå ´ï¼Œæœ‰é»ç†±æœ‰é»åµï¼Œå»ºè­°åœéå»ä¸€é»çš„å…¬å»æ¯”è¼ƒå®‰éœä¸€äº› Day2\né‡‘è»Šç”ŸæŠ€é¤Šæ®–ä¸­å¿ƒçœ‹ä¸€äº›æµ·æ´‹ç”Ÿç‰©é‚„ä¸éŒ¯ æ¨‚è‰²å±± çœ‹ç©æœ¨ä½œå“ï¼Œå ´é¤¨ä¸å¤§ä½†è »æœ‰è¶£çš„ï¼Œè »å¤šæœ‰è¶£çš„æ”¶è—è·Ÿä½œå“ å—æ–¹æ¾³æ¼æ¸¯ åƒåˆé¤è·Ÿè²·æ™šä¸Šé£Ÿæï¼Œå¤§æ¨ç”Ÿè¦ååˆ†çš„ç”œç¾ï¼Œé †ä¾¿è²·äº†è›¤è £å’Œå°ç« é­šï¼Œéå¸¸åˆ’ç®— å¤è«¾ç‡Ÿç‡Ÿåœ°ä¸Šå±±çš„è·¯æœ‰é»å°æœ‰é»æŠ–ï¼Œä½†å±±ä¸Šçš„é¢¨æ™¯å¾ˆä¸éŒ¯ï¼Œç‡Ÿåœ°ä¹Ÿå¾ˆä¹¾æ·¨ Day3 ç°¡å–®è²·å€‹ä¼´æ‰‹ç¦®å°±å›ç¨‹\næ©˜ä¹‹é„‰ æ½­é…µå¤© åœ¨æ—é‚Šçš„é¾æ½­å®¢æ£§åƒåˆé¤é‚„ä¸éŒ¯ äº‹å‰æº–å‚™ éœ²ç‡Ÿè³‡è¨Š åœ¨å°ç£ä¸€è¬›åˆ°éœ²ç‡Ÿå°±å¿…é ˆæåˆ° è»ŠåºŠå¤©åœ°ï¼Œå‡ºç™¼å‰åœ¨ä¸Šé¢æ±æ‰¾æ‰¾è¥¿æ‰¾æ‰¾æ‰æ‰¾åˆ°ç›®å‰çš„ä½ç½® éœ²ç‡Ÿåœ°ç§Ÿå€Ÿæ˜¯é€ééœ²ç‡Ÿæ¨‚ï¼Œä¸éé —å°·å°¬çš„å¹³å°ä¹‹å‰æœ‰ç™¼ç”Ÿéå€‹è³‡å¤–æ´©æˆ‘è€å©†æœ‰é‡åˆ°è©é¨™\u0026hellip; ä½†å› ç‚ºé‚„ç®—æ–¹ä¾¿æ‰€ä»¥æˆ‘å€‘é€™æ¬¡ä¹Ÿé‚„æ˜¯ç”¨é€™å€‹å¹³å°è¨‚è³¼ Youtube é »é“ æ†‚å¨˜é§•é§›Outdoorï¼Œç•¶åˆæœƒæœ‰è»Šæ³Šçš„æƒ³æ³•ä¹Ÿæ˜¯å› ç‚ºçœ‹åˆ°é€™éƒ¨å½±ç‰‡ï¼Œæ‰æƒ³èªªæ‰¾å€‹åœ°é»è»Šæ³Šçœ‹çœ‹ è»Šæ³Šï¼šç›´æ¥ç¡è»Šä¸Šï¼Œåœåœ¨åœè»Šå ´ä¹‹é¡çš„åœ°æ–¹ï¼Œé€šå¸¸é™„è¿‘åªæœƒæœ‰å»æ‰€è€Œä¸æœƒæœ‰æ·‹æµ´çš„åœ°æ–¹\nGoodGoodVan ç›¸é—œ ç§Ÿå€Ÿä¸‰å¤©å…©å¤œè²»ç”¨æ˜¯å‡æ—¥ 5800 + å¹³æ—¥ 4800 - çºŒå€Ÿå„ªæƒ  1000 å…± 9600ï¼Œå¦å¤– 5000 å…ƒæŠ¼é‡‘ï¼›\nå–é‚„è»Šåœ°é»æ˜¯åœ¨é—œæ¸¡æ·é‹ç«™ï¼Œæ¯”è¼ƒå‹å–„æ˜¯ 10:00 a.m. ç§Ÿå€Ÿå¯ä»¥ç¬¬ä¸‰å¤© 10:00 p.m. å›è»Š (ç•¶å¤©ä¸‹è¨‚çš„å„ªæƒ )ï¼Œé€™æ¨£ç¬¬ä¸‰å¤©å°±ä¸æœƒå¤ªè¶•å¯ä»¥æ…¢æ…¢å›ç¨‹\næ•´é«”ç§Ÿå€Ÿé‚„ç®—æ»¿æ„ï¼Œæœ‰é™„è´ˆè—ç‰™å–‡å­ã€æ°£æ°›ç‡ˆå…·ã€é‹å…·å¡å¼çˆï¼Œåªè¦è‡ªå·±åœ¨æº–å‚™ç¢—ç­·ã€é£Ÿæå³å¯ï¼Œä½†ä»–å€‘çš„é‹å…·æœ‰é»è€èˆŠå¯ä»¥çš„è©±å»ºè­°è‡ªå‚™ ä¹‹å‰çœ‹ä»–å€‘æœ‰ä¸Šç¯€ç›®åˆ†äº«ï¼ŒIG ç¶“ç‡Ÿçš„ä¹Ÿä¸éŒ¯\nç¸½çµ èº«ç‚ºéœ²ç‡Ÿå°ç™½ï¼Œä¸‰å¤©å…©å¤œçš„è»Šéœ²é«”é©—è¦ºå¾—é‚„ä¸è³´ï¼Œæ™‚é–“å†é•·å¯èƒ½å°±è®Šæˆä¸€ç¨®æŠ˜ç£¨ XD åŒæ™‚ä¹Ÿè§£é–ä¸€å€‹æˆå°±ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†ä¾†ç§Ÿå…¶ä»–æ›´å¥½çš„éœ²ç‡Ÿè»Šé«”é©—çœ‹çœ‹\n","date":"2023-05-15T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-05-15-%E6%96%B0%E6%89%8B%E7%A7%9F%E5%80%9F%E9%9C%B2%E7%87%9F%E8%BB%8A%E8%88%87%E4%B8%89%E5%A4%A9%E5%85%A9%E5%A4%9C%E4%B9%8B%E6%97%85/","title":"æ–°æ‰‹ç§Ÿå€Ÿéœ²ç‡Ÿè»Šèˆ‡ä¸‰å¤©å…©å¤œä¹‹æ—…"},{"content":"æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡å¾ˆä¸éŒ¯çš„æ–‡ç« MongoDB internal Architectureï¼Œä¸»è¦åœ¨æè¿° MongoDB Storage Engine çš„æ¼”é€²\nå…¶ä¸­åœ¨ 5.3 æ¯”è¼ƒå¤§çš„æ”¹è®Šæ˜¯å¼•å…¥äº† Clustered Collection èª¿æ•´äº† Storage Engine å„²å­˜çš„æ©Ÿåˆ¶ï¼Œé€™ä¹Ÿé€£å¸¶å½±éŸ¿ MongoDB åœ¨ Collection ä¸Šçš„æ•ˆèƒ½è¡¨ç¾ï¼Œä»¥ä¸‹å¾æ–‡ç« ä¸­æ‘˜è¦ Storage Engine æ¼”é€²ï¼Œä¸¦é€é Benchmark å»é©—è­‰çœ‹çœ‹å¯¦éš›çš„è¡¨ç¾\nMongoDB Storage Engine æ¼”é€² MMAPv1 æœ€ä¸€é–‹å§‹ MongoDB çš„ Storage Engine æ˜¯ MMAPv1ï¼Œæ¡ç”¨ B+Tree æ¶æ§‹ä»¥ _id ç‚º primary keyï¼Œleaf node å„²å­˜ DiskLoc ç›´æ¥æŒ‡å‘å„²å­˜æ–¼ç¡¬ç¢Ÿä¸Šçš„ä½ç½®(é€é file name + offset) MMAPv1 çš„å„ªé»æ˜¯æŸ¥è©¢é€Ÿåº¦å¾ˆå¿«ï¼Œåªéœ€è¦ O(logN) åœ¨ B+Tree æ‰¾åˆ° leaf node + O(1) å»ç¡¬ç¢Ÿè®€å–è³‡æ–™å³å¯\nä½†æœ‰å¹¾å€‹é‡å¤§ç¼ºé»\nå› ç‚ºæ˜¯å„²å­˜å¯¦éš› Disk ä½ç½®ï¼Œæ‰€ä»¥ç•¶ document å› ç‚º insert / update / delete è€Œæ”¹è®Š Disk ä½ç½® æ™‚ï¼Œå°±éœ€è¦å¤§è¦æ¨¡çš„æ”¹å¯« DiskLoc é€ æˆæ•ˆèƒ½çš„å½±éŸ¿ å„²å­˜æ™‚æ²’æœ‰å£“ç¸® ä¸€é–‹å§‹åªæä¾› database level / collection level çš„ lockï¼Œé€™ä¹Ÿå°è‡´åœ¨ parallel åŸ·è¡Œä¸Šæ•ˆç‡ä¸é«˜ æœ€çµ‚åœ¨ MongoDB v4.2 å°±å…¨é¢ç§»é™¤äº†\nWiredTiger MongoDB åœ¨ 2014 å¹´æ”¶è³¼äº† WiredTiger é€™å€‹ Storage Engineï¼Œä¸¦æ–¼ 3.0 åŠ å…¥æ–¼ 3.2 è®Šæˆé è¨­çš„ Storage Engine\nåœ¨å„²å­˜ä¸ŠåŒæ¨£æ˜¯æ¡ç”¨ B+Tree çµæ§‹ï¼Œä½†é€™æ™‚å€™ _id ä¸æ˜¯ Clustered Index Key è€Œæ˜¯åœ¨å…§éƒ¨ WiredTiger æœƒè‡ªå‹•ç‚ºæ¯å€‹ document è¨­å®š recordId ç•¶ä½œå„²å­˜æ’åºçš„ä¾æ“š\næ‰€ä»¥ _id è·Ÿå…¶ä»– secondary index ç›¸åŒï¼Œéƒ½æ˜¯å…ˆåœ¨è‡ªå·±çš„ B+Tree ä¸ŠæŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°æ‡‰çš„ recordId å¾Œå†å» recordId Clustered Index æœå°‹\nä¹Ÿå› æ­¤ WiredTiger çš„ç¼ºé»æ˜¯æŸ¥è©¢è®Šæ…¢ä¸€äº›ï¼Œå› ç‚ºéœ€è¦æœå°‹å…©æ¬¡ B+Tree æ‰èƒ½å» Disk æ’ˆè³‡æ–™\nä½†æœ‰å¹¾é …å„ªé»\nInsertã€Updateã€Delete æ•ˆèƒ½æ¯” MMAPv1 ç©©å®š æä¾› document level lockï¼Œå¤§å¹…æ”¹å–„ parallel æ•ˆèƒ½ å£“ç¸® BSON åœ¨å„²å­˜ï¼Œæ¸›å°‘ Disk ç”¨é‡ä»£è¡¨å¯æ”¾é€² buffer pool çš„è³‡æ–™ç­†æ•¸ä¹Ÿå¢åŠ  æ ¹æ“šé€™ç¯‡æ–‡ç«  Linkbench for MySQL \u0026amp; MongoDB with a cached database çš„å¯¦é©—å¯ä»¥çœ‹åˆ° MongoDB WiredTiger åœ¨æŸ¥è©¢èˆ‡å¯«å…¥éƒ½åŠæ‰“å…¶ä»–çš„ Storage Engine æœ‰è¶£çš„æ˜¯ MySQL å¯«å…¥ã€æŸ¥è©¢åŠæ‰“ MongoDB XD\nåœ¨å–®æ©Ÿçš„ç’°å¢ƒä¸‹çœ‹èµ·ä¾†è€ç‰Œ RDBMS æ¯”è¼ƒå²å®³ï¼Œåªæ˜¯å¯¦éš›é¸æ“‡é‚„éœ€è¦å†è€ƒé‡åˆ° scalability ç­‰ç‹€æ³\nWiredTiger Clustered Collection åŸç† æ¥è‘—åˆ°äº† MongoDB 5.3 çš„ Clustered Collectionï¼Œå‰›å‰›æœ‰æåˆ°å¯¦éš›å…§éƒ¨å„²å­˜ä¾æ“šæ˜¯ç”¨ recordId æ’åºï¼Œé‚£å¦‚æœç›´æ¥æ‹¿ _id ç•¶ä½œ Clustered Index çš„ key æ˜¯ä¸æ˜¯å°±èƒ½æ›´åŠ é€Ÿå¯«å…¥è·ŸæŸ¥è©¢çš„æ•ˆç‡ï¼Ÿé€™æ­£æ˜¯ Clustered Collection æ‰€æ¡ç”¨çš„æ–¹å¼ï¼Œç›´æ¥æ‹¿ _id ç•¶ä½œ Clustered Index\næ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼Œåœ¨å»ºç«‹ Clustered Collection å°±å¿…é ˆæŒ‡å®šç”¨ _id å»ºç«‹ï¼ŒåŒæ™‚å¿…é ˆæ˜¯ unique\n1 2 3 4 5 6 client[\u0026#34;collection\u0026#34;].create({ :clustered_index =\u0026gt; { :key =\u0026gt; { :_id =\u0026gt; 1 }, :unique =\u0026gt; true, } }) æ ¹æ“šæ–‡ä»¶ Clustered Collectionsæ‰€è¿°æœ‰å¹¾å€‹å„ªé»\nå¤§å¹…åº¦å¢åŠ  _id æœå°‹é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯ range scan ä¸Šï¼Œå› ç‚ºå°‘äº†ä¸€æ¬¡å»æŸ¥æ‰¾ recordId index Faster queries on clustered collections without needing a secondary index, such as queries with range scans and equality comparisons on the clustered index key.\nå¢åŠ  CRUD çš„æ•ˆèƒ½ Clustered collections have additional performance improvements for inserts, updates, deletes, and queries.\nä½†ä¹Ÿä¸æ˜¯å…¨ç„¶æ²’æœ‰å£è™•\nSecondary Index leaf node æœƒå„²å­˜ Clustered Index çš„ keyï¼Œè€Œå› ç‚ºå‰é¢æåˆ°åŸæœ¬ collection Clustered Index æ˜¯ç”¨ recordId(8byte)ï¼Œè€Œ _id é è¨­æ˜¯ 12byteï¼Œæ‰€ä»¥å°±ç›´æ¥å½±éŸ¿äº† Secondary Index çš„ size (å¢åŠ ç´„ 20%) _id æ˜¯ç”¨æˆ¶å¯ä»¥é è¨­ï¼Œå¦‚æœè¨­éŒ¯å¯èƒ½æœƒè®“æ•ˆèƒ½è®Šå·® æ•´é«”ä¾†èªªç›®å‰ MongoDB Clustered Collection å„²å­˜æ–¹å¼æœ‰é»æ¥è¿‘ MySQLï¼ŒåŒæ¨£éƒ½æ˜¯\næŒ‡å®š Primary Key ç•¶ä½œ Clustered Index å½±éŸ¿å¯¦éš›å„²å­˜çš„æ–¹å¼ Secondary Index leaf node æŒ‡å‘ Clsutered Index åŒæ¨£çš„å¦‚æœ _id æ˜¯æ¡ç”¨ UUID ç­‰äº‚åºï¼Œä¹ŸåŒæ¨£æœƒæœ‰æ•ˆèƒ½ä¸Šçš„å½±éŸ¿ï¼Œé€™éƒ¨åˆ†å¯ä»¥åƒè€ƒ UUIDs are Popular, but Bad for Performance â€” Letâ€™s Discussï¼Œé€™é»å¾ŒçºŒ benchmark æœƒé©—è­‰\nBenchmark é€éä»¥ä¸‹å¹¾å€‹å¯¦é©—ä¾†å¯¦éš›æª¢é©—ä¸€ä¸‹ MongoDB v6.0.5 Clustered Collection çš„æ•ˆèƒ½\næ¯”å° CRUD åœ¨ Clustered Collection vs ä¸€èˆ¬ Collection å·®ç•°\né æœŸ CRUD åœ¨ Clustered Collection æ‡‰è©²è¦è¼ƒå¥½ é‡å° Secondary Indexï¼Œæ¯”è¼ƒå¯¦éš›å¤§å°èˆ‡æ•ˆèƒ½\né æœŸ Secondary Index åœ¨ Clustered Collection å„²å­˜ç©ºé–“è¦æ¯”è¼ƒå¤§ï¼Œå¦‚æœå°ºå¯¸æ²’æœ‰å¤§åˆ°è¨˜æ†¶é«”å¡ä¸ä¸‹çš„ç‹€æ³ï¼Œæ•ˆèƒ½éƒ¨åˆ†é æœŸæ˜¯å·®ä¸å¤š _id æ”¹ç”¨ UUID å°æ–¼å¯«å…¥æ•ˆèƒ½çš„å½±éŸ¿\né æœŸ Clustered Collection æœƒæœ‰æ¯”è¼ƒå·®çš„è¡¨ç¾ï¼Œå› ç‚ºåº•å±¤å„²å­˜çµæ§‹çš„é—œä¿‚ ç›¸é—œç¨‹å¼ç¢¼åœ¨ sj82516/mongodb-bm-cluster-collection\nInsert æ¯”è¼ƒ å¯¦é©—æ¯å€‹ iteration æº–å‚™ 100 è¬ç­†è³‡æ–™ä¸¦ç”¨ insert_many æ‰¹æ¬¡å¯«å…¥ 1000 ç­†ï¼Œç¸½å…±æ’å…¥ 2000 è¬ç­†ï¼›å¯¦é©—çµ„æ˜¯ clustered collection ä½†å°ç…§çµ„ä¸æ˜¯\nå¾åœ–è¡¨ä¾†çœ‹ Clustered Collection æœ‰ç¨å¾®æ¯”è¼ƒå¥½ä½†æ²’æœ‰åˆ°éå¸¸æ˜é¡¯çš„è®ŠåŒ–\nSearch æ¯”è¼ƒ æ¸¬è©¦éç¨‹æœ‰ç™¼ç¾ä¸€å€‹ MongoDB çš„ bug Performance Issue about Clustered Collection : where there are more than one _id search condition, the search would fallback to COLLSCANï¼Œä¸»è¦æ˜¯ find æ¢ä»¶ä¸­æœ‰å¤šå€‹ _id æ™‚ index æœƒæ²’æœ‰åƒåˆ° clustered index å°è‡´æŸ¥è©¢éå¸¸æ…¢\nä½†æœ‰è¶£çš„æ˜¯ secondary index ç›®å‰æ¸¬è©¦æ˜¯æ²’æœ‰é€™å€‹å•é¡Œçš„\n1 2 3 4 5 6 user system total real cluster search 1.011011 0.095830 1.106841 ( 27.275139) normal search 0.405232 0.034662 0.439894 ( 0.449653) user system total real cluster email search 0.417697 0.035939 0.453636 ( 0.556692) normal email search 0.407986 0.027175 0.435161 ( 0.487835) å¯ä»¥çœ‹åˆ° cluster search æ…¢åˆ°çˆ†ï¼Œdelete_many æœ‰åŒæ¨£çš„ issue\næœ¬ä¾†ä»¥ç‚ºæ˜¯ä¸æ˜¯ driver å•é¡Œï¼Œä½†å¯¦éš›ç”¨ Mongo Compass å®˜æ–¹ GUI tool å»åˆ†ææŸ¥è©¢ï¼Œç¢ºå¯¦ç™¼ç¾åªè¦ $in è£¡é¢çš„æ¢ä»¶è¶…éä¸€ç­†å°±æœƒè®Šæˆ COLLSCAN\nSecondary Index å¤§å° å¯ä»¥çœ‹å‡ºåŒæ¨£çš„ documents ä¸‹ Secondary Index åœ¨ Clustered Index ç¢ºå¯¦è®Šå¤§å¿« 25%\nUUID å¯«å…¥çš„å½±éŸ¿ å¯¦é©—æ¯å€‹ iteration æº–å‚™ 100 è¬ç­†è³‡æ–™ä¸¦ç”¨ insert_many æ‰¹æ¬¡å¯«å…¥ 1000 ç­†ï¼Œå…©å€‹ collection éƒ½æ˜¯ clustered collectionï¼Œå¯¦é©—çµ„ _id è¨­å®šç‚º UUID\nå¯ä»¥çœ‹åˆ° UUID å°æ–¼æ•ˆèƒ½çš„è² é¢å½±éŸ¿ååˆ†å·¨å¤§\nå»¶ä¼¸é–±è®€ ä»¥ä¸‹æ˜¯æˆ‘åœ¨é–±è®€æ™‚æƒ³åˆ°çš„ä¸€äº›é¡å¤–å•é¡Œï¼Œè¦ºå¾—è »æœ‰è¶£ä¹Ÿé †ä¾¿è¨˜éŒ„ä¸€ä¸‹\nç‚ºä»€éº¼ WiredTiger ä¸€é–‹å§‹ä¸æ”¯æ´ Clustered Index æ—¢ç„¶æœ‰é€™éº¼å¤§çš„å¥½è™•ï¼Œç‚ºä»€éº¼ä¸€é–‹å§‹ä¸æ”¯æ´å‘¢ï¼Ÿåœ¨é€™å€‹ google group discuss æœ‰ç¨å¾®å¸¶åˆ° Purpose of a separate index storage for primary id for MongoDB\nç†è§£èµ·ä¾†æ¯”è¼ƒåƒæŠ€è¡“å‚µï¼Œä¸€é–‹å§‹ MMAPv1 æ˜¯ä½¿ç”¨ DiscLocï¼Œå¾Œä¾† WiredTiger æ”¹æˆç”¨ RecordId è€Œä¸æ˜¯ç›´æ¥ç¶æ­» Disk ä½ç½®\nthe origin of this decision was the MMAPv1 storage engine. There, indexes would map keys to 'DiskLoc' values, containing a pair of 32-bit integers representing the file number in the database and offset in that file. Since then we have replaced DiskLoc by a RecordId that does not represent a physical location, but rather a logical document number.\nå¦å¤–å°±æ˜¯ MongoDB å°æ–¼ Primary Key ä½¿ç”¨æœ‰é¡å¤–çš„ç”¨é€”ï¼ŒåŒ…å« Shardingï¼Œæ‰€ä»¥å¯¦ä½œæ¯”æƒ³åƒä¸­è¤‡é›œ å¦å¤–ä¹Ÿæœ‰æåˆ°å³ä½¿æœ‰æ•ˆèƒ½ä¸Šçš„æå‡ä½†å°æ–¼ Secondary Index æ˜¯æœ‰è² é¢å½±éŸ¿\nwe could gain efficiency (both time and space) by using the primary key directly to index the data. However, as MongoDB puts few restrictions on the primary key, it is common for these primary keys to have a non-trivial size. This in turn means that all secondary indexes become less efficient. Some users have many indexes, so they'd be negatively affected by such a change. \u0026hellip;\u0026hellip;\nçµèª æ•´é«”ä¾†èªª Clustered Collection å¯«å…¥æ•ˆèƒ½ç¢ºå¯¦æœ‰å¥½ä¸Šä¸€äº›ï¼Œæœå°‹éƒ¨åˆ†å› ç‚ºæœ‰ bug æš«æ™‚é‚„ä¸ç¢ºå®šï¼Œè€Œ Secondary Index é«”ç©æœƒæœ‰æ„Ÿçš„è®Šå¤§ï¼›ç›®å‰æ•´é¡Œè©•ä¼°ä¸‹ä¾†ä¸å»ºè­°æ¡ç”¨ Clustered Collectionï¼Œäº›å¾®çš„æ•ˆç›Šæ¯”ä¸ä¸Šé€™äº›é¢¨éšªèˆ‡å‰¯ä½œç”¨\n","date":"2023-05-05T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-05-05-mongodb-clustered-collection-%E8%88%87-benchmark-%E5%AF%A6%E9%A9%97/","title":"MongoDB Clustered Collection èˆ‡ Benchmark å¯¦é©—"},{"content":"Golang æœ¬èº«ä¸æ”¯æ´ç¹¼æ‰¿ï¼ŒåŸå› åœ¨å®˜æ–¹çš„ QnA æœ‰å›ç­”ï¼Œèˆ‡å…¶å°ˆæ³¨åœ¨ type æœ¬èº«çš„é—œä¿‚ï¼Œé‚„ä¸å¦‚æ³¨é‡åœ¨ interface èƒ½å¦æ»¿è¶³ç‰¹å®šçš„è¡Œç‚º\nTypes can satisfy many interfaces at once, without the complexities of traditional multiple inheritance.\nè€ŒåŠé–“å¤§å¤šçš„ Golang ç¹¼æ‰¿å¯¦ä½œéƒ½æ˜¯é€é embedded struct é€é composition æ¨¡æ“¬ inheritanceï¼Œå¦‚é€™ç¯‡ ç§’æ‡‚ go è¯­è¨€çš„ç»§æ‰¿ æˆ–é€™ä¸€ç¯‡ Inheritance in GoLang\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // åŠ¨ç‰©ç±» class Animal { public String name; public String subject; void eat(String food) { System.out.println(name + \u0026#34;å–œæ¬¢åƒï¼š\u0026#34; + food + \u0026#34;,å®ƒå±äºï¼š\u0026#34; + subject); } } // çŒ«ç±»ã€‚ çŒ«ç±»ç»§æ‰¿åŠ¨ç‰©ç±» class Cat extends Animal{ // çŒ«è‡ªå·±çš„å±æ€§å’Œæ–¹æ³• public int age; void sleep() { System.out.println(name + \u0026#34;ä»Šå¹´\u0026#34; + age + \u0026#34;å²äº†ï¼Œç‰¹åˆ«å–œæ¬¢ç¡è§‰\u0026#34;); } } public class Test{ public static void main(String[] args){ // åˆ›å»ºä¸€ä¸ªåŠ¨ç‰©å®ä¾‹ Animal a = new Animal(); a.name = \u0026#34;åŠ¨ç‰©\u0026#34;; a.subject = \u0026#34;åŠ¨ç‰©ç§‘\u0026#34;; a.eat(\u0026#34;è‚‰\u0026#34;); // åˆ›å»ºä¸€ä¸ªçŒ«å®ä¾‹ Cat cat = new Cat(); cat.name = \u0026#34;å’ªå’ª\u0026#34;; cat.subject = \u0026#34;çŒ«ç§‘\u0026#34;; cat.age = 1; cat.eat(\u0026#34;é±¼\u0026#34;); cat.sleep(); } } â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” åŸæ–‡ä½œè€…ï¼špureyb è½¬è‡ªé“¾æ¥ï¼šhttps://learnku.com/articles/32295 ç‰ˆæƒå£°æ˜ï¼šè‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·ä¿ç•™ä»¥ä¸Šä½œè€…ä¿¡æ¯å’ŒåŸæ–‡é“¾æ¥ã€‚ å¯¦ä½œä¸Š subclass (cat) å°‡ superclass (animal) embeddedï¼Œç•¶ subclass å‘¼å«æ²’æœ‰å®šç¾©çš„ method æ™‚ï¼Œæœƒå»èª¿ç”¨ superclass çš„ methodï¼Œä¾‹å¦‚ä¸Šé¢æ¡ˆä¾‹ä¸­ cat.eat æ˜¯èª¿ç”¨ animal.eat\nä½†é€™æ¨£å°±çœŸçš„æ»¿è¶³ç¹¼æ‰¿çš„æ¢ä»¶äº†å—ï¼Ÿ\nç‚ºä»€éº¼æˆ‘å€‘æœƒéœ€è¦ç¹¼æ‰¿ å›æ­¸åŸé»ï¼Œæˆ‘å€‘æœƒåœ¨ä»€éº¼æ™‚å€™åå¥½ç¹¼æ‰¿å¤§éæ–¼çµ„åˆé€™æ¨£çš„å¯¦ä½œæ–¹å¼ ?\nå°±æˆ‘è‡ªå·±çš„ç¿’æ…£æ˜¯\nå‹åˆ¥ä¹‹é–“æœ‰å¾ˆæ˜ç¢º is-a çš„é—œè¯ å¯¦ä½œä¸Šå¤§å¤šçš„è¡Œç‚ºç›¸åŒï¼Œåªæœ‰éƒ¨åˆ†çš„è¡Œç‚ºä¸åŒï¼Œæœƒéœ€è¦å¥—ç”¨ æ¨£æ¿æ–¹æ³• Template Method æ™‚ ä¾‹å¦‚æ±½è»Šã€æ©Ÿè»Šéƒ½æ˜¯äº¤é€šå·¥å…·ï¼Œä»–å€‘éƒ½å¯ä»¥æä¾›å¾ A ç§»å‹•åˆ° B çš„æœå‹™ï¼Œä½†ä»–å€‘é¨ä¹˜çš„æ–¹å¼ä¸åŒ\nå¦å¤–åœ¨å¯¦ä½œç¹¼æ‰¿æ™‚ï¼Œåˆ¥å¿˜äº† SOLID åŸå‰‡ä¸­çš„ Liskov æ›¿æ›åŸå‰‡ï¼Œè¡Œç‚ºä¸Š subclass æ‡‰è©²è¦èƒ½å¤ æ›¿æ› superclass æ‰€å‡ºç¾çš„åœ°æ–¹\næ›´å…·é«”æè¿°ç¹¼æ‰¿åœ¨å¯¦ä½œä¸Šçš„éœ€æ±‚\nLiskov æ›¿æ›åŸå‰‡ï¼šsubclass æ›¿æ› suplerclass ä¸æ‡‰è©²æœ‰å‹åˆ¥ä¸Šçš„éŒ¯èª¤ æ¨£æ¿æ–¹æ³•ï¼šsuperclass å®šç¾©å‘¼å«æµç¨‹ï¼Œè€Œ subclass å¯ä»¥è¤‡å¯«éƒ¨åˆ†æ–¹æ³• method propagateï¼šç•¶å‘¼å« subclass ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œæœƒå¾€ superclass å»æŸ¥æ‰¾ æˆ‘å€‘ä¾†æª¢è¦–ä¸Šé¢çš„ä½œæ³•ä»¥ä¸Šéœ€æ±‚\nå‡è¨­ Animal æœ‰ä¸€å€‹ method æ˜¯ wakeUpï¼ŒwakeUp å›ºå®šæœƒ yell \u0026amp; eatï¼Œä½†ä¸åŒçš„å‹•ç‰©æœ‰ä¸åŒçš„ yell æ–¹å¼èˆ‡ eat å…§å®¹\ngo playground\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 // You can edit this code! // Click here and start typing. package main import \u0026#34;fmt\u0026#34; type Animal struct { Name string } func (a *Animal) Wakeup() { a.yell() a.eat() } func (a *Animal) yell() { fmt.Println(\u0026#34;default yell\u0026#34;) } func (a *Animal) eat() { fmt.Println(\u0026#34;default eat\u0026#34;) } type Cat struct { Animal } func (c *Cat) yell() { fmt.Println(\u0026#34;meow meow\u0026#34;) } func (c *Cat) eat() { fmt.Println(\u0026#34;cat eat meat\u0026#34;) } func main() { cat := \u0026amp;Cat{ Animal{ Name: \u0026#34;BigCat\u0026#34;, }, } cat.Wakeup() } // output // default yell // default eat å’¦?! è¼¸å‡ºç«Ÿç„¶ä¸æ˜¯å‘¼å« cat.yell() å’Œ cat.eat()ï¼Œåè€Œæ˜¯å‘¼å«åˆ° animal.yell() / animal.eat()ï¼Œå°æ¯” Ruby çš„åŸ·è¡Œçµæœ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 class Animal def wakeup yell eat end def yell puts \u0026#34;default yell\u0026#34; end def eat puts \u0026#34;default eat\u0026#34; end end class Cat \u0026lt; Animal def yell puts \u0026#34;meow meow\u0026#34; end def eat puts \u0026#34;cat eat meat\u0026#34; end end cat = Cat.new cat.wakeup # meow meow # cat eat meat ç©¶ç«Ÿæ˜¯å“ªè£¡å‡ºéŒ¯äº† ?!\næ³¨æ„ Golang embedded struct åŸ·è¡Œçš„è§’è‰² æ›´å…·é«”çš„æè¿°å¯ä»¥åƒè€ƒæ­¤ç¯‡ Type embedding: Golang\u0026rsquo;s fake inheritanceï¼Œç•¶æˆ‘å€‘åˆ©ç”¨ method propagate æ‰¾åˆ° superclass å®šç¾©çš„æ–¹æ³•æ™‚ï¼Œè¦æ³¨æ„ æ­¤æ™‚åŸ·è¡Œçš„è§’è‰²æ˜¯ superclass è€Œä¸æ˜¯ subclass!\nä¾‹å¦‚ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œwakeup æ˜¯å®šç¾©åœ¨ Animal ç•¶ä¸­ï¼ŒCat å‘¼å« wakeup æœ€å¾Œæ˜¯ç”¨ Animal å»åŸ·è¡Œï¼Œè€Œç•¶ Animal åŸ·è¡Œ wakeup æ™‚å°±æ˜¯å‘¼å« Animal.yell / Animal.eat é€é Interface èˆ‡é‡æ–°èª¿æ•´ Embedded æ–¹å‘ å…ˆä¸Šçµè«–ï¼Œå°‡ subclass è¦å€‹åˆ¥å¯¦ä½œçš„æ–¹æ³•æŠ½æˆ interfaceï¼Œä¸¦æ”¹å°‡ subclass embedded åˆ° superclass ä¸­ï¼Œåƒè€ƒ go playground\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 // You can edit this code! // Click here and start typing. package main import \u0026#34;fmt\u0026#34; type ISubClass interface { Temp1() Temp2() } type SuperClass struct { sub ISubClass } func (s *SuperClass) Method() { s.sub.Temp1() s.sub.Temp2() } type SubClass1 struct{} func (s *SubClass1) Temp1() { s.temp3() fmt.Println(\u0026#34;temp1 from SubClass1\u0026#34;) } func (s *SubClass1) Temp2() { fmt.Println(\u0026#34;temp2 from SubClass1\u0026#34;) } type SubClass2 struct{} func (s *SubClass2) Temp1() { fmt.Println(\u0026#34;temp1 from SubClass2\u0026#34;) } func (s *SubClass2) Temp2() { fmt.Println(\u0026#34;temp2 from SubClass2\u0026#34;) } func main() { cls1 := \u0026amp;SuperClass{ sub: \u0026amp;SubClass1{}, } cls2 := \u0026amp;SuperClass{ sub: \u0026amp;SubClass2{}, } cls1.Method() cls2.Method() } é€™æ¨£åšå°±æ»¿è¶³äº†\nLiskov æ›¿æ›åŸå‰‡ï¼šä¸åŒçš„ subclass éƒ½ä¾é™„åœ¨ SuperClassï¼Œæ‰€ä»¥ç›´æ¥æ›¿æ›æ²’å•é¡Œ Template methodï¼šSuperclass é€é interface å‘¼å« subclass method method propagateï¼šé€™å€‹æ¯”è¼ƒ trickyï¼Œå› ç‚ºæ˜¯ç›´æ¥å‘¼å« Superclassï¼Œæ‰€ä»¥ä¹Ÿæ²’æœ‰ method propagate çš„å•é¡Œ ä»¥ä¸Šæ»¿è¶³æˆ‘å€‘å‰é¢ä¸€é–‹å§‹å°æ–¼ç¹¼æ‰¿çš„å®šç¾©ï¼Œä½†æœ‰å¹¾å€‹ä¾·é™\nå› ç‚ºæˆ‘å€‘åè½‰ embedded struct çš„ä½ç½®ï¼Œæ‰€ä»¥ subclass ä¸èƒ½å‘¼å« superclass ä»»ä½•çš„æ–¹æ³•æˆ–åƒæ•¸ï¼Œåªèƒ½å¾ superclass å‘¼å« subclassï¼Œé€™é»æˆ‘è¦ºå¾—æ¯”è¼ƒé‚„å¥½ï¼Œå¦‚æœå‘¼å«æ–¹å‘äº¤éŒ¯åè€Œå¾ˆäº‚ subclass çš„å‹åˆ¥ä¸æ˜ç¢ºï¼Œå› ç‚ºéƒ½æ›åœ¨ superclass ä¸‹ï¼Œå¦‚æœè¦åˆ¤æ–·å‹åˆ¥éœ€è¦é¡å¤–è™•ç† subclass ä¸èƒ½æœ‰å®¢è£½åŒ–çš„ Public Methodï¼Œæœƒè¢« interface ä¾·é™ï¼Œä¾‹å¦‚æˆ‘åªæœ‰ SubClass1 æƒ³è¦æœ‰ Temp3 çš„ public methodï¼Œè®Šæˆ interface ä¹Ÿè¦å¢åŠ å¦å‰‡ç„¡æ³•å‘¼å« 1 2 3 4 5 6 7 8 9 10 11 type ISubClass interface { .... Temp3() } func (s *SubClass1) Temp3() { fmt.Println(\u0026#34;temp3 from SubClass1\u0026#34;) } func (s *SubClass2) Temp3() { // SubClass2 è¢«è¿«ä¹Ÿè¦å¢åŠ ï¼Œåå‰‡ç„¡æ³•æ»¿è¶³ interface } å¦‚æœ subclass æƒ³è¦å‘¼å« superclass æ–¹æ³• ä¾·é™ç¬¬ä¸€é»æåˆ°å› ç‚º embedded ç›®å‰æ˜¯æ›åœ¨ superclass ä¸‹ï¼Œåéä¾†å°±æ˜¯ subclass ç„¡æ³•å‘¼å« superclassï¼Œå¦‚æœå¸Œæœ› subclass å‘¼å« superclass çš„æ–¹æ³•ï¼Œå°±éœ€è¦åƒ Template Method ç”± superclass ä¸»å‹•å‘¼å«ï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 type SuperClass struct { SubClass Name string } type SubClass struct {} func (s *SubClass) ShowName() { // æƒ³è¦å–å¾— SuperClass Name å±¬æ€§ // ç„¡æ³•é€™æ¨£å­˜å–!! \u0026#34;prefix\u0026#34; + s.Name } ////// èª¿æ•´åšæ³• ///////// type SuperClass struct { SubClass Name string } // æ”¹å¾ superclass è™•ç†ï¼ŒæŠŠ name pass çµ¦ subclass func (s *SuperClass) ShowName() { pfxName := s.ParseName(s.Name) } type SubClass struct {} func (s *SubClass) ParseName(name string) { // æƒ³è¦å–å¾— SuperClass Name å±¬æ€§ // ç„¡æ³•é€™æ¨£å­˜å–!! name } çµèª ä»¥ä¸Šæä¾›ä¸åŒçš„æ€è·¯ï¼Œé€éæ”¹è®Š embedded struct çš„ä¸åŒå±¤ç´šï¼Œæœƒæœ‰ä¸åŒçš„æ•ˆæœ\nsubclass embedded superclassï¼šsubclass å¯ä»¥ä»»æ„å®šç¾© public methodï¼Œä½†ç„¡æ³•å¯¦ä½œ Template method superclass embedded subclassï¼šå¯ä»¥å¯¦ä½œ Template methodï¼Œä½† subclass ç„¡æ³•æœ‰é¡å¤–çš„ public methodï¼Œé™¤éæ“´å…… interface å†ä»”ç´°æƒ³æƒ³æ–¹æ³•äºŒï¼Œåœ¨å…¶ä»– OOP language ä¸­ï¼Œå¥—ç”¨ Template method æ™‚ subclass å®šç¾©çš„ method å¯ä»¥ç›´æ¥å­˜å– superclass å®šç¾©çš„åƒæ•¸ï¼Œä½†æ˜¯åœ¨ Golang ä¸­æ˜¯ç„¡æ³•åšåˆ°çš„\næ‰€ä»¥åœ¨ Golang ä¸­è¦ä»¿é€  Template method åè€Œæœƒæ¯”è¼ƒåƒ Strategy patternï¼Œsuperclass éœ€è¦æŠ½æ›æŸäº›è¡Œç‚º (ç­–ç•¥)ï¼Œé‚£å°±é€éä¸åŒçš„ç­–ç•¥è¨­è¨ˆä¸¦åœ¨åˆå§‹åŒ–æ™‚å¸¶å…¥\næ•´é«”å¯¦ä½œé‚„æ˜¯ç”¨ çµ„åˆä¾†ä»£æ›¿ç¹¼æ‰¿ï¼Œåœ¨ä½¿ç”¨ Golang ä¸Šå»ºè­°é‚„æ˜¯ä¸è¦ç”¨ç¹¼æ‰¿çš„æ¦‚å¿µå»æ€è€ƒæœƒè®“å¯¦ä½œæ¯”è¼ƒé †\n","date":"2023-04-27T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-04-27-%E6%8E%A2%E8%A8%8E-golang-%E5%AF%A6%E4%BD%9C%E9%A1%9E%E4%BC%BC%E7%B9%BC%E6%89%BF%E7%9A%84%E4%B8%8D%E5%90%8C%E5%81%9A%E6%B3%95/","title":"æ¢è¨ Golang å¯¦ä½œé¡ä¼¼ç¹¼æ‰¿çš„ä¸åŒåšæ³•"},{"content":" ç•¶æˆ‘å€‘å¸Œæœ›æ‰“é€ ä¸€å€‹åŸºæ–¼èªæ„ç›¸ä¼¼çš„æ–‡å­—æœå°‹æ™‚ï¼Œä¸€èˆ¬çš„ä½œæ³•æ˜¯å°‡æ–‡å­—é€é AI model è½‰æˆ embeddeding vectorï¼Œé€éè¨ˆç®— vector distance (cosine distancing) æ‰¾å‡ºè·é›¢æœ€ç›¸è¿‘çš„æ–‡å­— kNN (k nearest neighbors)ï¼Œä¾‹å¦‚ OpenAI çš„ demo codeï¼šSemantic_text_search_using_embeddings\nç•¶è³‡æ–™é‡å°çš„æ™‚å€™ï¼Œé€™æ¨£åšä¸æœƒæœ‰ä»€éº¼å•é¡Œï¼Œä½†ä»”ç´°çœ‹ç›®å‰çš„æ¯”å°æ–¹å¼æ˜¯æŠŠè¼¸å…¥è·Ÿè³‡æ–™é›†çš„è³‡æ–™æ¯ä¸€ç­† vector éƒ½åš distance è¨ˆç®—ï¼Œæ‰€ä»¥è¤‡é›œåº¦æœƒæ˜¯ O(N)ï¼ŒN æ˜¯è³‡æ–™é›†æ•¸é‡ï¼Œå¦‚æœè³‡æ–™é‡ä¸€å¤§ï¼Œé€™å‹¢å¿…æœƒæ˜¯é€ æˆç“¶é ¸\nVector DB å°±æ˜¯è¦è§£æ±ºé€™æ¨£çš„å•é¡Œï¼Œä¸»è¦é€é\næ”¹ç”¨ ANN (approximate nearest neighbors) å–ä»£ kNNï¼Œç”¨ç›¸ä¼¼åº¦æŸ¥è©¢æ›å–åŸ·è¡Œé€Ÿåº¦ æä¾› database åŠŸèƒ½ï¼ŒåŒ…å«æŒä¹…åŒ–ä¿å­˜ã€æ°´å¹³æ“´å±• (sharding)ã€é«˜å¯ç”¨æ€§ã€API å°è£ç­‰åŠŸèƒ½ ç›®å‰æœå°‹å¸‚é¢ä¸Šæœ‰å¹¾å€‹å¸¸è¦‹çš„é¸æ“‡\nPineconeï¼šé–‰æºå°ˆæ¡ˆï¼Œå°±å…ˆç•¥éä¸ç”¨ Milvusï¼šç´” vector DBï¼Œçœ‹èµ·ä¾†åœ¨åŸºç¤å»ºè¨­ (scalingã€availability) ç­‰åšå¾—æ¯”è¼ƒå®Œæ•´ Weaviateï¼šæœ‰ module å¯ä»¥æ”¯æ´ AI model æ•´åˆï¼Œä¹Ÿæ”¯æ´ç´” vector DB ä½¿ç”¨ Chromaï¼šFireship demo ç”¨ é€™æ¬¡ Demo é¸æ“‡ç”¨ Weaviateï¼Œä¸»è¦æ˜¯æœ‰æ”¯æ´ module ç›´æ¥æ•´åˆ AI modelï¼Œé€™æ¨£æˆ‘å°±ä¸ç”¨å¦å¤–æƒ³ embedding vector è©²å¦‚ä½•ç”¢ç”Ÿ\nWeaviate DB åŸºæœ¬ä»‹ç´¹ Weaviate DB æœ‰ä»¥ä¸‹å¹¾å€‹ç‰¹è‰²\nä¾¿åˆ©æ€§ï¼š\nmodule æ”¯æ´å¸¸è¦‹çš„ AI modelï¼ŒåŒ…å« transformerã€openai ç­‰ï¼Œé€éåƒæ•¸å¯ä»¥ç›´æ¥èª¿æ•´ï¼Œä½†æœ‰äº› AI model éƒ¨åˆ†éœ€è¦è‡ªå·±æ¶è¨­ serverï¼ŒWeaviate DB æ ¸å¿ƒä¸¦ä¸åŒ…å« AI modelï¼Œåªæ˜¯æœƒç›´æ¥é€é interface èª¿ç”¨ æœå°‹èˆ‡éæ¿¾ï¼š\né™¤äº† vector æœå°‹å¤–ï¼Œåœ¨æ–‡å­—ä¸Šæœƒçµåˆ inverted index å¢åŠ æœå°‹çš„ç²¾æº–åº¦èˆ‡æ•ˆç‡ï¼Œä¸¦æä¾› filter å¯ä»¥é€éå±¬æ€§ç¯©é¸ API æ¥å£æ”¯æ´ REST èˆ‡ GraphQL æ“´å……æ€§ï¼š æœƒæä¾› Sharding èˆ‡ High Availability (å¾Œè€…é‚„åœ¨é–‹ç™¼ä¸­) å„²å­˜æ¦‚å¿µ ä»¥ Class ç‚ºç®¡ç†å–®ä½ï¼Œå¯ä»¥ç†è§£æˆ table æˆ– collection çš„æ¦‚å¿µï¼Œæ¯å€‹ class æœ‰è‡ªå·± vectorize çš„æ©Ÿåˆ¶ã€sharding è¨­å®šç­‰ï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 { \u0026#34;class\u0026#34;: \u0026#34;string\u0026#34;, // The name of the class in string format \u0026#34;description\u0026#34;: \u0026#34;string\u0026#34;, // A description for your reference \u0026#34;vectorIndexType\u0026#34;: \u0026#34;hnsw\u0026#34;, // Defaults to hnsw, can be omitted in schema definition since this is the only available type for now \u0026#34;vectorIndexConfig\u0026#34;: { ... // Vector index type specific settings, including distance metric }, \u0026#34;vectorizer\u0026#34;: \u0026#34;text2vec-contextionary\u0026#34;, // Vectorizer to use for data objects added to this class \u0026#34;moduleConfig\u0026#34;: { \u0026#34;text2vec-contextionary\u0026#34;: { \u0026#34;vectorizeClassName\u0026#34;: true // Include the class name in vector calculation (default true) } }, \u0026#34;properties\u0026#34;: [ // An array of the properties you are adding, same as a Property Object { \u0026#34;name\u0026#34;: \u0026#34;string\u0026#34;, // The name of the property \u0026#34;description\u0026#34;: \u0026#34;string\u0026#34;, // A description for your reference \u0026#34;dataType\u0026#34;: [ // The data type of the object as described above. When creating cross-references, a property can have multiple data types, hence the array syntax. \u0026#34;string\u0026#34; ], \u0026#34;moduleConfig\u0026#34;: { // Module-specific settings \u0026#34;text2vec-contextionary\u0026#34;: { \u0026#34;skip\u0026#34;: true, // If true, the whole property will NOT be included in vectorization. Default is false, meaning that the object will be NOT be skipped. \u0026#34;vectorizePropertyName\u0026#34;: true, // Whether the name of the property is used in the calculation for the vector position of data objects. Default false. } }, \u0026#34;indexInverted\u0026#34;: true // Optional, default is true. By default each property is fully indexed both for full-text, as well as vector search. You can ignore properties in searches by explicitly setting index to false. } ], \u0026#34;invertedIndexConfig\u0026#34;: { ... }, \u0026#34;shardingConfig\u0026#34;: { ... // Optional, controls behavior of class in a multi-node setting, see section below } } æ¯å€‹ Class å…§åŒ…å«å¤šå€‹ Object ä»¥ json æ ¼å¼å„²å­˜ï¼ŒObject å…§çš„å±¬æ€§ (Property) æ”¯æ´å¤šç¨®æ ¼å¼ï¼Œé¡å¤–æœ‰æä¾›åœ°ç†ä½ç½®ã€æ—¥æœŸã€é›»è©±è™Ÿç¢¼(æœ‰é»ä¸è§£?!)ï¼Œå…¶ä¸­åœ°ç†ä½ç½®åœ¨æŸ¥è©¢ä¸Šé‚„æ”¯æ´æ–¹åœ“å…§çš„ç¯©é¸\nClass schema æ˜¯éœæ…‹çš„ï¼Œå¦‚æœè¦å¢æ¸›æ¬„ä½éœ€è¦é€é API ä¿®æ”¹ï¼Œè€Œä¸åƒæŸäº› NoSQL æ˜¯å‹•æ…‹å¯«å…¥çš„\nç‰©ç†å„²å­˜ä»¥ Shard ç‚ºå–®ä½ ä¸€å€‹ Class åœ¨ç‰©ç†å„²å­˜ä¸Šæœ‰å¤šå€‹ Shardï¼Œæ¯å€‹ Shard æœƒåŒ…å« vector index / object store / inverted indexï¼Œå…¶ä¸­ vecotr index ç›®å‰æ˜¯ç”¨ HNSWï¼Œå…¶é¤˜å…©å€‹æ˜¯ç”¨ LSMTree å„²å­˜\nDemo - æ‰“é€ ç°¡æ˜“çš„æ–‡å­—æŸ¥è©¢ ç¨‹å¼ç¢¼åœ¨ sj82516/weaviate-db-demoï¼Œåœ¨æœ¬åœ°ç«¯å•Ÿå‹• Weaviate DB ä¸¦åšç°¡æ˜“çš„æ–‡å­—æŸ¥è©¢\né€é docker-compose å•Ÿå‹• é€™é‚Šæˆ‘å€‘åªåšæ–‡å­—æœå°‹çš„éƒ¨åˆ†ï¼Œé¸ç”¨ transformer ç•¶ä½œ AI modelï¼Œå¯ä»¥æŸ¥çœ‹ä¸åŒçš„ modules\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 version: \u0026#39;3.4\u0026#39; services: weaviate: image: semitechnologies/weaviate:1.18.3 ports: - \u0026#34;8080:8080\u0026#34; environment: QUERY_DEFAULTS_LIMIT: 20 AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: \u0026#39;true\u0026#39; PERSISTENCE_DATA_PATH: \u0026#34;./data\u0026#34; DEFAULT_VECTORIZER_MODULE: text2vec-transformers ENABLE_MODULES: text2vec-transformers TRANSFORMERS_INFERENCE_API: http://t2v-transformers:8080 CLUSTER_HOSTNAME: \u0026#39;node1\u0026#39; t2v-transformers: image: semitechnologies/transformers-inference:sentence-transformers-multi-qa-MiniLM-L6-cos-v1 environment: ENABLE_CUDA: 0 # set to 1 to enable # NVIDIA_VISIBLE_DEVICES: all # enable if running with CUDA å»ºç«‹ Class èˆ‡åŒ¯å…¥è³‡æ–™ Class schema å¯ä»¥ä¸»å‹•å®£å‘Šï¼Œæˆ–æ˜¯è®“ Weaviate DB è‡ªå‹•å¹«å¿™å»ºç«‹ (æœ‰é»åƒ Elasticsearch)ï¼Œé€™é‚Šå»ºç«‹äº†ä¸€å€‹ Class ä¸¦æŒ‡å®š module ç”¨ text-transformer\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 client.Schema().ClassCreator().WithClass(\u0026amp;models.Class{ Class: className, Description: \u0026#34;all books I have\u0026#34;, Vectorizer: \u0026#34;text2vec-transformers\u0026#34;, ModuleConfig: map[string]interface{}{ \u0026#34;text2vec-transformers\u0026#34;: map[string]interface{}{}, }, Properties: []*models.Property{ { Name: \u0026#34;title\u0026#34;, DataType: []string{\u0026#34;text\u0026#34;}, }, }, }) åŒ¯å…¥è³‡æ–™å¯ä»¥æ‰¹æ¬¡åŒ¯å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 objects := []*models.Object{ { Class: className, Properties: map[string]interface{}{ \u0026#34;title\u0026#34;: \u0026#34;Hello World Blue\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;program\u0026#34;, }, }, { Class: className, Properties: map[string]interface{}{ \u0026#34;title\u0026#34;: \u0026#34;Hello World Red\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;program\u0026#34;, }, }, { Class: className, Properties: map[string]interface{}{ \u0026#34;title\u0026#34;: \u0026#34;Hello World Yellow\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;science\u0026#34;, }, }, } client.Batch().ObjectsBatcher(). WithObjects(objects...). WithConsistencyLevel(replication.ConsistencyLevel.ALL). Do(context.Background()) æœå°‹èˆ‡ç¯©é¸ å®Œæ•´æŸ¥è©¢æœ‰ä¸‰å€‹éƒ¨åˆ† æœå°‹ + ç¯©é¸ + æ¬„ä½éæ¿¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 // æ–‡å­—æœå°‹ nearText := client.GraphQL().NearTextArgBuilder(). // æœå°‹çš„é—œéµå­— WithConcepts(concepts). // è®“å‘é‡å¾€æŸå€‹æ–¹å‘é è¿‘ WithMoveTo(\u0026amp;graphql.MoveParameters{ Force: 0.5, Concepts: []string{ \u0026#34;Yellow\u0026#34;, }, }) // ç¯©é¸æ©Ÿåˆ¶ where := filters.Where(). WithPath([]string{\u0026#34;type\u0026#34;}). WithOperator(filters.Equal). WithValueText(\u0026#34;program\u0026#34;) // é¸æ“‡æ¬„ä½å›å‚³ fields := []graphql.Field{ {Name: \u0026#34;title\u0026#34;}, // é¡å¤–çš„æ¬„ä½ï¼Œç®—æ˜¯ metadata {Name: \u0026#34;_additional\u0026#34;, Fields: []graphql.Field{ {Name: \u0026#34;id\u0026#34;}, {Name: \u0026#34;distance\u0026#34;}, }}, } // GraphQL Request result, err := client.GraphQL().Get(). WithClassName(className). WithNearText(nearText). WithWhere(where). WithFields(fields...). Do(context.Background()) if result.Errors != nil { for _, err := range result.Errors { fmt.Println(err.Message) } return } r := result.Data[\u0026#34;Get\u0026#34;].(map[string]interface{})[className].([]interface{}) jsonbody, err := json.Marshal(r) if err != nil { // do error check fmt.Println(err) return } books := []Book{} if err := json.Unmarshal(jsonbody, \u0026amp;books); err != nil { // do error check fmt.Println(err) return } for _, book := range books { fmt.Println(book) } åœ¨ searching æœå°‹ä¸­ï¼Œå¦‚æœæ˜¯ text Weaviate DB æœƒç”¨ inverted index èˆ‡ vector æœå°‹ WithNearTextï¼Œæ‰¾å‡ºçš„çµæœæœƒçµ¦å‡ºå°æ‡‰çš„ distance\n1 2 3 4 5 6 7 8 nearText := client.GraphQL().NearTextArgBuilder(). WithConcepts(concepts). WithMoveTo(\u0026amp;graphql.MoveParameters{ Force: 0.5, Concepts: []string{ \u0026#34;Yellow\u0026#34;, }, }) concepts æœå°‹çš„æ–‡å­—é™£åˆ— WithMoveTo é¡å¤–æŒ‡å®šæœå°‹è¦ç‰¹åˆ¥æ¥è¿‘å“ªäº›é—œéµå­—\nåƒæ•¸å¯åƒè€ƒ Vector search parameters ä¹Ÿå¯ä»¥é‡å°å±¬æ€§åšç¯©é¸ï¼Œä¾‹å¦‚æˆ‘åªè¦ object ä¸­ type = program çš„è³‡æ–™\n1 2 3 4 where := filters.Where(). WithPath([]string{\u0026#34;type\u0026#34;}). WithOperator(filters.Equal). WithValueText(\u0026#34;program\u0026#34;) æœå°‹çš„çµæœå¤§æ¦‚æ˜¯ (Yellow è¢«ç¯©é¸æ‰)\n{Hello World Blue {b9f93a34-6cbd-45b3-afc3-f82e9d1d0da8 0.54240143}}\n{Hello World Red {6575290e-53cc-4ab9-8d39-330e5a47b0d1 0.55338395}}\nANN æ¼”ç®—æ³•ï¼šHNSW ä»‹ç´¹ HNSW (Hierarchical Navigable Small World) æ˜¯ä¸€ç¨® ANN æ¼”ç®—æ³•ï¼Œä¸»è¦æ˜¯å€Ÿé¡ å€Ÿé¡ probability skip listï¼Œé€éåˆ†å±¤æŸ¥è©¢ï¼Œå…ˆå¾æœ€ä¸Šå±¤æœ€ç¨€ç–çš„ layer é–‹å§‹æ‰¾æœ€ç›¸è¿‘çš„é„°å±…ï¼Œæ¥è‘—å¾€ä¸‹ä¸€å±¤æ‰¾è©²é„°å±…çš„æœ€ç›¸è¿‘é„°å±…ï¼Œä¸€ç›´åˆ°æœ€åº•å±¤ (layer 0)\næŸ¥è©¢è¤‡é›œåº¦é™è‡³ log (N)\né€™éƒ¨åˆ†æœ‰å…©å€‹åƒæ•¸å¯ä»¥æ³¨æ„\nefConstruction: æ±ºå®šæ¯æ¬¡æŸ¥è©¢å›å‚³çš„é„°å±…æ•¸é‡ï¼Œæ•¸é‡è¶Šå¤šæŸ¥è©¢è¶Šç²¾æº–ï¼Œä½†æ˜¯æ•ˆç‡è¶Šå·® maxConnections: æ±ºå®šæ¯å€‹ point å¯ä»¥é€£æ¥çš„ edge æ•¸é‡ï¼ŒåŒæ¨£æ˜¯æ•¸é‡è¶Šå¤šè¶Šç²¾æº– å¦‚ä½•æ±ºå®š point è¦æ’å…¥å“ªä¸€å±¤ é€™éƒ¨åˆ†ä¾¿æ˜¯é€éæ©Ÿç‡æ‰€æ±ºå®šï¼Œè¶Šä¸Šå±¤æ©Ÿç‡è¶Šä½ çµèª å¿«é€Ÿç­è§£äº†ä¸€ä¸‹ Vector DBï¼Œæœªä¾†å¦‚æœæœ‰éœ€è¦åšå‘é‡æŸ¥è©¢ä½¿ç”¨ä¸Šæ‡‰è©²æœƒè »æ–¹ä¾¿çš„ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒåœ¨è©•ä¼°ä¸€ä¸‹ Milvusï¼Œçœ‹èµ·ä¾†åŸºç¤å»ºè¨­æ¯” Weaviate DB æ›´å®Œå–„ã€Github ä¸Šç†±åº¦ä¹Ÿæ›´é«˜ã€ä¹Ÿæ”¯æ´æ›´å¤šçš„ ANN æ¼”ç®—æ³•\nå¦å¤– Elasticsearch åœ¨ 8.0 ä¹Ÿæœ‰æ”¯æ´ vector searchï¼Œå¦‚æœä»¥ç¶“æœ‰åœ¨ç”¨ ES ä¹Ÿå¯ä»¥ç›´æ¥ç•¶ä½œ Vector DB ä½¿ç”¨\n","date":"2023-04-24T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-04-24-vector-db-%E5%88%9D%E6%8E%A2%E8%88%87-weaviate-db-%E6%95%99%E5%AD%B8/","title":"Vector DB åˆæ¢èˆ‡ Weaviate DB æ•™å­¸"},{"content":"åœ¨å¥—ç”¨ Clean Architecture (å¾ŒçºŒç°¡ç¨± CA)éç¨‹ï¼Œæœ€å¸¸è¨è«–çš„å•é¡Œè«éæ–¼ã€ŒTransaction å¦‚æœè·¨å¤šå€‹ repositoryï¼Œè©²æ€éº¼è™•ç†ï¼Ÿå¦‚æœ Transaction ç”± Use Case æ§åˆ¶æœƒä¸æœƒé•å CA åŸå‰‡ï¼Ÿå¦‚æœæ”¾åˆ° Repository é‚£æœ‰ä¸€äº›åˆ¤æ–·çš„é‚è¼¯æ˜¯ä¸æ˜¯ä¹Ÿæ··é›œé€²å»ï¼Ÿã€\né€™å€‹å•é¡Œç¢ºå¯¦æœ‰é»æ£˜æ‰‹ï¼Œç¶²è·¯ä¸Šä¹Ÿå¸¸çœ‹åˆ°å„ç¨®ä¸åŒçš„ä½œæ³•ï¼Œæ±ºå®šä»Šå¤©é‡æ–°æ•´ç†ä¸€ä¸‹ï¼Œæª¢è¦–ä¸åŒçš„ä½œæ³•èˆ‡è€ƒé‡ï¼Œä¸¦é€éå¯¦éš›çš„æ¡ˆä¾‹å»é©—è­‰ä¸åŒä½œæ³•çš„å„ªåŠ£ï¼Œä½¿ç”¨å‹•æ…‹èªè¨€ Ruby / éœæ…‹èªè¨€ Golang ç¢ºä¿å¯¦ä½œæ˜¯çœŸå¯¦å¯è¡Œ\nç›®å‰æƒ³åˆ°çš„é©—è­‰å ´æ™¯ç‚º\nã€Œç”¨æˆ¶ã€å¸³è™Ÿæœ‰é»æ•¸ï¼Œé€éé»æ•¸è³¼è²·ã€Œå•†å“ã€ä¸¦æˆç«‹å°æ‡‰çš„ã€Œè¨‚å–®ã€ å•†å“å¿…é ˆæœ‰è¶³å¤ æ•¸é‡ã€ç”¨æˆ¶é»æ•¸å¿…é ˆæœ‰è¶³å¤ çš„é»æ•¸æ‰å¯ä»¥æˆç«‹è¨‚å–® ä»¥ä¸Šè¡Œç‚ºå¿…é ˆåŒ…å«åœ¨ä¸€å€‹ transaction ä¸­\nå¤–éƒ¨çš„å¹¾ç¨®åšæ³• 1. ç”± UseCase æ§åˆ¶ï¼Œå› ç‚º Usecase æ‰çŸ¥é“æ‰€æœ‰çš„ Context é€™éƒ¨åˆ†èªªæ³•æ˜¯å¾ã€ŠClean Architecture å¯¦ä½œç¯‡ã€‹ç¬¬ 84 é æ‰€æˆªå–çš„å…§å®¹ï¼Œä½œè€…æåˆ°åªæœ‰ Usecase æœ‰è¶³å¤ çš„ä¸Šä¸‹æ–‡å»åˆ¤æ–·é€™å¹¾å€‹ repository æ“ä½œæ˜¯å¦è©²æ”¾åˆ°åŒä¸€å€‹ transactionï¼Œç¯„ä¾‹ code å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 @UseCase @Transactional public class SendMoneyService implements SendMoneyUseCase { @Override public boolean sendMoney(SendMoneyCommand command) { .... AccountId sourceAccountId = sourceAccount.getId() .orElseThrow(() -\u0026gt; new IllegalStateException(\u0026#34;expected source account ID not to be empty\u0026#34;)); AccountId targetAccountId = targetAccount.getId() .orElseThrow(() -\u0026gt; new IllegalStateException(\u0026#34;expected target account ID not to be empty\u0026#34;)); accountLock.lockAccount(sourceAccountId); if (!sourceAccount.withdraw(command.getMoney(), targetAccountId)) { accountLock.releaseAccount(sourceAccountId); return false; } accountLock.lockAccount(targetAccountId); if (!targetAccount.deposit(command.getMoney(), sourceAccountId)) { accountLock.releaseAccount(sourceAccountId); accountLock.releaseAccount(targetAccountId); return false; } ..... } } ä½œè€…ç›´æ¥ä½¿ç”¨ framework æä¾›çš„ annotation @Transaction æŠŠæ‰€æœ‰çš„æ“ä½œéƒ½æ”¾åˆ°åŒä¸€å€‹ Transaction ä¸­\n2. æ‡‰è©²æ”¾åˆ° repository ä¸­ï¼Œæœ‰å…¶ä»–çš„éœ€æ±‚ç”¨ callback function è£œå…… é€™æ˜¯æˆ‘åœ¨ Coscup è½åˆ°çš„ golang ç‰ˆæœ¬ CA å¯¦ä½œï¼Œä½œè€…ä¸€é–‹å§‹æƒ³è¦çš„è§£æ³•æ˜¯usecase æ§åˆ¶ lockï¼Œrepository æ§åˆ¶ transaction\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func (s *BarterService) ExchangeGoods(ctx context.Context, param ExchangeGoodsParam) common.Error { // 1. Claim an event to exchange goods X and Y s.lockServer.claim(X, Y, ttl) // 2. Check ownership of request good // 3. Check the target good exist or not // 4. Exchange ownership of two goods // ....... // 5. Disclaim the event s.lockServer.disclaim(X, Y) return nil } func (r *PostgresRepository) CheckOwnerIDsAndUpdateGoods(ctx context.Context, param CheckOwnerIDsAndUpdateGoodsParam) (updatedGoods []barter.Good, err common.Error) { tx, err := r.beginTx() if err != nil { return nil, err } defer func() { err = r.finishTx(err, tx) }() // 1. Get goods again if _, err = r.getGoodByIDandOwnerID(ctx, tx, param.G1.ID, param.G1.OnwerID); err != nil { // ...} if _, err = r.getGoodByIDandOwnerID(ctx, tx, param.G2.ID, param.G2.OnwerID); err != nil { // ...} // 2. Update Goods for i := range goods { updatedGood, err := r.updateGood(ctx, tx, param.updateGoods[i]) if err != nil { return nil, err } updatedGoods = append(updatedGoods, *updatedGood) } return updatedGoods, nil } ä½†åœ¨é€™å€‹ issue ä¸­æœ‰äººè£œå……ä¸åŒçš„ä½œæ³• Is there a race condition bug?ï¼Œå¦ä¸€å€‹äººæåˆ° lock æ¯”è¼ƒä¸åƒå•†å‹™é‚è¼¯ï¼Œæ¯”è¼ƒåƒå¯¦ä½œçš„ç´°ç¯€ï¼Œæ‰€ä»¥ä»–æœƒæƒ³è¦æ”¾åˆ° repository ä¸­ï¼Œè€Œå•†å‹™é‚è¼¯å°±ç”¨ callback function æ–¹å¼å‚³å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func (s *BarterService) ExchangeGoods(ctx context.Context, param ExchangeGoodsParam) common.Error { g1, g2, err := s.goodRepo.UpdateTwoGoods(ctx, param.G1, param.G2, func(g1, g2 barter.Good) common.Error { // 1. Check ownership of request good // ...... // 2. Check the target good exist or not // ...... // 3. Exchange ownership of two goods // ...... return nil }) return err } func (r *PostgresRepository) UpdateTwoGoods( ctx context.Context, id, id2 string, updateFn func(*barter.Good, *barter.Good) (*barter.Good, *barter.Good, common.Error), ) (barter.Good, barter.Good, err common.Error) { tx, err := r.beginTx() if err != nil { return nil, err } defer func() { err = r.finishTx(err, tx) }() // 1. Fetch required data if g1, err = r.getGoodByID(ctx, tx, id); err != nil { // ... } if g2, err = r.getGoodByID(ctx, tx, id2); err != nil { // ... } // 2. Apply business logic (usecase) if g1, g2, err = updateFn(g1, g2); err != nil { // ... } return g1, g2, nil } é‡æ–°æ€è€ƒ é‡æ–°æŠ½è±¡åŒ–ä¸€ä¸‹é‡åˆ°çš„å›°å¢ƒ\n1 2 3 4 5 usecase 1. å¾ repo è®€å–ï¼ŒåŒæ™‚è¦ lock 2. é‡å°è®€å–çš„æ•¸å€¼åˆ¤æ–· 3. æ ¹æ“šåˆ¤æ–·ï¼Œå°‡çµæœå¯«å› repo 4. ä»¥ä¸Šä¸‰æ­¥è¦åœ¨åŒä¸€å€‹ transaction é‡æ–°å¯©æ€ CA çš„æ¢ä»¶ï¼Œæœ‰å¹¾é»è¦å‰‡æˆ‘å€‘æ‡‰è©²è¦éµå®ˆ\nrepository æ‡‰è©²åªåŒ…å«å„²å­˜å±¤çš„æ“ä½œï¼Œä¸æ‡‰è©²æœ‰å•†å‹™é‚è¼¯ usecase ä¸æ‡‰è©²çŸ¥é“å¤ªå¤š repository ç´°ç¯€ï¼Œæˆ–æ›å€‹è§’åº¦ï¼Œç•¶æŠ½æ› repository æ™‚æ‡‰è©²è¦å¾ˆå®¹æ˜“ï¼Œä¸æ”¹è®Š usecase çš„å¯¦ä½œ æ ¹æ“šä»¥ä¸Šçš„æ¢ä»¶ï¼Œä¾†æ¸¬è©¦å…©ç¨®æ–¹å¼\nusecase æ§åˆ¶ lock èˆ‡ transaction repository ç”¨ callback function æ³¨å…¥å•†å‹™é‚è¼¯ å…©è€…å¯¦ä½œèµ·ä¾†çš„æ„Ÿè¦º å¯¦ä½œæ¯”è¼ƒ åƒè€ƒç¨‹å¼ç¢¼ clean-architecture-transaction-issue\næ–¹æ³•ä¸€ï¼šuse case æ§åˆ¶ transaction èˆ‡ lock é¦–å…ˆåœ¨ usecase ä¸­æ§åˆ¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 def run(user_id, product_id, count) user_repository.transaction() user = user_repository.find_by_id_with_lock(user_id) product = product_repository.find_by_id_with_lock(product_id) total = product.price * count return unless user.can_purchase?(total) return unless product.can_purchase?(count) # to test race condition sleep 1 user.points -= total product.stock -= count order = Order.new(user, product, count) user_repository.save(user) product_repository.save(product) order_repository.create(order) user_repository.commit() end é€™é‚Šæš´éœ²äº†è »å¤šé—œæ–¼ DB çš„ç´°ç¯€ï¼ŒåŒ…å« transaction / lock / commitï¼Œä½†æ‰€æœ‰çš„å•†æ¥­é‚è¼¯ä¹Ÿéƒ½åœ¨ usecase ä¸­ï¼›\nä½†æ•´é«”å‚·å®³æ‡‰è©²ä¸ç®—åˆ°å¤ªåš´é‡ï¼Œä¸»è¦æ˜¯ä¹Ÿæ²’æœ‰ç›´æ¥è·Ÿ DB è€¦åˆï¼Œå¦‚æœæŠ½æ›æˆå…¶ä»– NoSQL é ‚å¤š transaction / commit method ç•™ç©ºï¼Œä¸æœƒç›´æ¥é•å CA ä¾è³´æ–¹å‘çš„åŸå‰‡\næ–¹æ³•äºŒï¼šç”± repository æ§åˆ¶ transaction ç”± repository æ§åˆ¶ transactionï¼Œå•†å‹™é‚è¼¯ç”¨ block æ–¹å¼å‚³å…¥ï¼Œå…¶é¤˜çš„é‚è¼¯éƒ½åœ¨ repository ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # usecase def run_in_repo(user_id, product_id, count) aggregate_root_repository.purchase_product(user_id, product_id, count) do |user, product| total = product.price * count next false unless user.can_purchase?(total) next false unless product.can_purchase?(count) true end end # repository class AggregateRootRepository \u0026lt; Repository def purchase_product(user_id, product_id, count) transaction result = client.prepare(\u0026#34;SELECT * FROM users WHERE id = ? FOR UPDATE\u0026#34;) .execute(user_id) .first user = User.new(result[\u0026#39;id\u0026#39;], result[\u0026#39;points\u0026#39;]) result = client.prepare(\u0026#34;SELECT * FROM products WHERE id = ? FOR UPDATE\u0026#34;) .execute(product_id) .first product = Product.new(result[\u0026#39;id\u0026#39;], result[\u0026#39;price\u0026#39;], result[\u0026#39;stock\u0026#39;]) is_pass = yield(user, product, count) return unless is_pass client.prepare(\u0026#34;INSERT INTO orders (user_id, product_id, count) VALUES (?, ?, ?)\u0026#34;) .execute(user.id, product.id, count) total = product.price * count client.prepare(\u0026#34;UPDATE users SET points = ? WHERE id = ?\u0026#34;) .execute(user.points - total, user.id) client.prepare(\u0026#34;UPDATE products SET stock = ? WHERE id = ?\u0026#34;) .execute(product.stock - count, product.id) commit end end é€™é‚Šçš„å•†å‹™é‚è¼¯åªæœ‰åˆ¤æ–·æ˜¯å¦å¯ä»¥è³¼è²·ï¼Œå…¶é¤˜çš„ DB æ“ä½œå°è£åœ¨ repository ä¸­ï¼Œé€™é‚Šå–åå«åš Aggregate Root æ˜¯æƒ³å‘¼æ‡‰ DDD è£¡é¢çš„æƒ³æ³•ã€Œç”± Aggregate Root æ“ä½œä¿è­‰åº•ä¸‹å¤šå€‹ Aggregate çš„ä¸€è‡´æ€§ã€ï¼Œéˆæ„Ÿæ˜¯ä¾†è‡ªä¹‹å‰ä¸Š Teddy çš„èª²ç¨‹èˆ‡ FB è¨è«–\næ¯”è¼ƒå…©è€…å·®ç•° usecase ä¹¾æ·¨ç¨‹åº¦(æ–¹æ³•äºŒå‹)ï¼š\nè »æ˜é¡¯ä½œæ³•å¾ˆä¹¾æ·¨ï¼ŒæŠŠæ‰€æœ‰çš„ DB lock / transaction éƒ½å°è£å¾—ä¸€ä¹¾äºŒå‡ˆï¼Œè€Œå•†å‹™é‚è¼¯é‚„æ˜¯ä¿ç•™åœ¨ usecase ä¸­å‘¼å« æ“´å……æ€§(æ–¹æ³•ä¸€å‹)ï¼š\nå¦‚æœæœªä¾†å•†å‹™é‚è¼¯è®Šå¾—æ›´è¤‡é›œï¼Œæœ‰å¯èƒ½ DB æŸ¥å®Œè³‡æ–™è¦å¢åŠ æ–°çš„æ¯”å°ï¼Œä¾‹å¦‚ã€Œé«˜ç´šæœƒå“¡æœ‰æ›´å¤šçš„æŠ˜åƒ¹ã€ã€ã€Œç‰¹æ®Šå•†å“è²· 10 é€ 1ã€ç­‰ç­‰ï¼Œæ–¹æ³•äºŒéœ€è¦ä¸æ–·çš„å¢åŠ  function å‚³å…¥ï¼Œè€Œæ–¹æ³•ä¸€å› ç‚ºéƒ½æ˜¯åœ¨ usecase æ“ä½œï¼Œæ‰€ä»¥ç›´æ¥å¢åŠ å°±å¥½ï¼Œç›¸å°å¥½æ“´å…… å¯æ¸¬è©¦æ€§(æ–¹æ³•ä¸€å‹)ï¼š æˆ‘è¦ºå¾—å…©å€‹ä½œæ³•æœ€å¤§çš„å·®ç•°æ˜¯å¯æ¸¬è©¦æ€§ï¼Œæ¸¬è©¦å¯ä»¥ç”¨ integration test é€£ DB ä¸€èµ·æ¸¬ / æˆ–æ˜¯ unit test æŠŠå…¶ä»–ç›¸ä¾çš„ç‰©ä»¶ mock æ‰ï¼› integration æ¸¬è©¦éƒ¨åˆ†å…©è€…æ²’å¤ªå¤šå·®ç•° (åƒè€ƒ main_spec.rb)ï¼›\nä½†æ˜¯ unit test å°±æœ‰å¾ˆå¤§çš„å·®ç•° (åƒè€ƒ usecase.rb)ï¼Œå› ç‚ºæ–¹æ³•ä¸€çš„ repository æ–¹æ³•éƒ½æ˜¯ public è®“ usecase å‘¼å«ï¼Œæ‰€ä»¥å¾ˆå¥½ mockï¼Œä½†æ–¹æ³•äºŒç›®å‰æˆ‘æƒ³ä¸åˆ°æ¯”è¼ƒå¥½çš„æ–¹æ³•æ¸¬è©¦ï¼Œå› ç‚º callback function (block) æ˜¯åœ¨ repo ä¸­å‘¼å«ï¼Œé‚£æˆ‘ç›´æ¥ mock æ‰ä¸å°±ä»€éº¼éƒ½æ¸¬ä¸äº†äº† ?!! çµè«– å³ä½¿ usecase æœƒæ¯”è¼ƒæ··äº‚ä¸€äº›ï¼Œæˆ‘é‚„æ˜¯é¸æ“‡æ–¹æ³•ä¸€\n(golang ç‰ˆæœ¬å¾…è£œ)\n","date":"2023-04-21T02:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-04-21-%E5%9C%A8-clean-architecture-%E4%B8%8B-transaction-%E8%A9%B2%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C%E7%9A%84%E5%95%8F%E9%A1%8C%E7%99%BC%E6%83%B3-golang-%E8%88%87-ruby-%E5%AF%A6%E4%BD%9C/","title":"åœ¨ Clean Architecture ä¸‹ transaction è©²å¦‚ä½•å¯¦ä½œçš„å•é¡Œç™¼æƒ³ (Golang èˆ‡ Ruby å¯¦ä½œ)"},{"content":"æœ‰å¥½ä¸€é™£å­è¦ºå¾—è‡ªå·±èŠ±äº†è »å¤šæ™‚é–“åœ¨å­¸ç¿’ä¸Šï¼Œå‡æ—¥ä¹Ÿæœƒè¦åŠƒè®€æ›¸å¯«ç¨‹å¼ï¼Œä½†ç¸½è¦ºå¾—è‡ªå·±ä¸¦æ²’æœ‰çœŸæ­£ç©ç´¯æˆ–å¾ˆå·¨å¹…çš„æˆé•·ï¼Œé€™äº›åŠªåŠ›èˆ‡ä»˜å‡ºå¥½åƒæ˜¯åœ¨æ»¿è¶³è‡ªå·±çš„ç„¦æ…®ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„ç”¢ç”Ÿæ”¹è®Šèˆ‡æˆå°±\nç›´åˆ°çœ‹äº†ã€Šæœ€æœ‰ç”Ÿç”¢åŠ›çš„ä¸€å¹´ã€‹ï¼Œæ‰ç™¼ç¾è‡ªå·±ä¹‹å‰åœ¨å®‰æ’å­¸ç¿’é …ç›®èˆ‡è¦åŠƒä¸Šï¼Œæœ‰äº†æ€ç¶­ä¸Šçš„èª¤å·®ï¼Œè©¦è‘—å¥—ç”¨æ›¸ä¸­çš„ä½œæ³•ï¼Œé€æ­¥èª¿æ•´å‡ºè‡ªå·±å¯¦è¸çš„æ–¹å¼ï¼Œè¦ºå¾—ç”Ÿç”¢åŠ›ä¸Šé–‹å§‹æœ‰ä¸€äº›æ­£å‘çš„è®ŠåŒ–\nä»¥ä¸‹åˆ†äº«æ›¸ä¸­çš„ä¸€äº›è§€å¿µèˆ‡åšæ³•ï¼Œä¸¦åˆ†äº«è‡ªå·±å¦‚ä½•å¯¦è¸èˆ‡ä¸€äº›æ„Ÿæƒ³\nä¸‰å€‹è§€å¿µ è§€å¿µä¸€ï¼šç”Ÿç”¢åŠ›çš„é‡é»æ˜¯ã€Œæˆå°±ã€ï¼Œè€Œä¸æ˜¯å®Œæˆå¤šå°‘äº‹ ä½œè€…åˆ†äº«åˆ°ä¸€æåˆ°ç”Ÿç”¢åŠ›å¤§å®¶é—œæ³¨çš„å¾€å¾€æ˜¯æˆ‘å¦‚ä½•åœ¨ä¸€å®šçš„æ™‚é–“å®Œæˆå¤šå°‘äº‹ï¼Œä½†çœŸæ­£é‡è¦çš„æ˜¯ã€Œä½ å®Œæˆçš„å¤šå°‘çš„æˆå°±ã€ (p19)\næˆå°±èˆ‡ä¸€èˆ¬äº‹é …çš„å€åˆ†åœ¨æ–¼æˆå°±æ˜¯ç”¢ç”Ÿé‡å¤§æ”¹è®Šèˆ‡æ„ç¾©çš„äº‹æƒ…ï¼Œå°±å¥½æ¯”èªªæ€¥è¿«æ€§èˆ‡é‡è¦æ€§çŸ©é™£ï¼Œå¦‚æœä½ ä¸€ç›´åœ¨è™•ç†ç·Šæ€¥å»ä¸é‡è¦çš„é›œäº‹ï¼Œä¾‹å¦‚å›å› Email ã€åƒåŠ ä¸å¿…è¦çš„æœƒè­°ï¼Œçœ‹èµ·ä¾†å®Œæˆå¾ˆå¤šäº‹ä½†çœŸæ­£é‡è¦çš„äº‹æƒ…éƒ½æ²’æœ‰è¢«è™•ç†ï¼Œæ‰€ä»¥ä½œè€…æåˆ°é‡é»è¦æ”¾åœ¨ã€Œæˆå°±ã€è€Œéå®Œæˆäº‹é …çš„æ•¸é‡\nå¿…é ˆæ„è­˜åˆ°ï¼šä¸æ˜¯æ¯ä»¶äº‹éƒ½åŒç­‰çš„é‡è¦\nè§€å¿µäºŒï¼šæˆå°±æ˜¯è¦é€£çµè‡ªå·±çš„åƒ¹å€¼è§€ï¼Œæ‰¾å‡ºé‡è¦ä¸”æœ‰å‹•åŠ›çš„äº‹é … å»¶çºŒæˆå°±çš„å®šç¾©ï¼Œé€™æœƒä¾ç…§æ¯å€‹äººçš„åƒ¹å€¼è§€è€Œæœ‰æ‰€ä¸åŒï¼Œè€Œæ‰¾å‡ºè‡ªå·±äººç”Ÿçš„åƒ¹å€¼è§€æ˜¯ä¸€ä»¶å¾ˆé‡è¦ä½†æˆ‘è¦ºå¾—ä¸æ˜¯é€™éº¼ç°¡å–®ã€å…·é«”çš„äº‹æƒ…\nä½œè€…é€™é‚Šæä¾›ä¸€å€‹æœ‰è¶£çš„æ€è€ƒæ–¹å¼ã€Œæƒ³åƒè‡ªå·±çªç„¶æ¯å¤©å¤šäº†å…©å°æ™‚ï¼Œä½ æœƒæ‹¿ä¾†åšä»€éº¼ï¼Ÿã€ æé«˜ç”Ÿç”¢åŠ›ç„¡éæ˜¯æƒ³ç‚ºè‡ªå·±è³ºåˆ°æ›´å¤šçš„æ™‚é–“èˆ‡ç²¾åŠ›ï¼Œé‚£é€™å¤šå‡ºä¾†çš„æ™‚é–“æ€éº¼é‹ç”¨ï¼Œå°±æœƒåæ˜ è‡ªå·±çš„åƒ¹å€¼è§€èˆ‡æ’åºæ–¹å¼ (p33)\nå¦ä¸€å€‹å»ºè­°æ˜¯å¯ä»¥å±…é«˜è‡¨ä¸‹ï¼Œå¾ç”Ÿæ´»çš„ä¸åŒé¢å‘å»åæ€ï¼Œå¦‚é ­è…¦(å­¸ç¿’)ã€èº«é«”ç‹€æ…‹ã€æƒ…æ„Ÿã€è·æ¶¯ã€è²¡å‹™ã€äººéš›é—œä¿‚ã€ä¼‘é–’æ¨‚è¶£ (p208)ï¼Œé€™é‚Šå‘¼æ‡‰åˆ°å¦ä¸€ç¯‡å¯«æ—¥è¨˜çš„æ–¹å¼ æœ±é¨-å¯«æ—¥è¨˜çš„ç­–ç•¥ 1 : æ—¥è¨˜åˆ°åº•è¦å¯«å“ªäº›å…§å®¹ï¼Ÿï¼Œç”¨å®Œæ•´çš„è§’åº¦å»æª¢è¦–æ¯”è¼ƒä¸æœƒæœ‰éºæ¼\nè§€å¿µä¸‰ï¼šçµ‚çµæ™‚é–“ç®¡ç†ï¼Œç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›æ‰æ˜¯é‡é» ä½œè€…æåˆ°æ™‚é–“ç¶“æ¿Ÿæ˜¯å› ç‚ºå·¥å» çš„èˆˆèµ·ï¼Œäººå€‘çš„æ”¶å…¥ç›´æ¥èˆ‡å·¥ä½œæ™‚é–“æ›é‰¤ï¼Œåšå¤šå°‘æ™‚é–“æ‹¿å¤šå°‘å ±é…¬\nä½†ç¾åœ¨çš„ç¤¾æœƒæ˜¯æ³¨é‡ç”¢å‡ºï¼Œèƒ½å¤ ä¸€å€‹å°æ™‚å®Œæˆçš„æˆå°±ç‚ºä»€éº¼è¦ç”¨å…©å€‹å°æ™‚ ?!ï¼Œè€Œè¦åœ¨æ›´çŸ­çš„æ™‚é–“åšåˆ°ç›¸åŒçš„æˆå°±ï¼Œå°±éœ€è¦é«˜åº¦çš„ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›çš„æŠ•å…¥ï¼Œé€™æ­£ä¹Ÿæ˜¯æˆ‘å€‘æ‰€èƒ½æ§åˆ¶çš„\nä½œè€…æ›¾ç¶“å¯¦é©—éä¸€é€±å·¥ä½œ 90 å°æ™‚ vs ä¸€é€±å·¥ä½œ 20 å°æ™‚ï¼Œç™¼ç¾ 90 å°æ™‚çš„ç”¢å‡ºåªæ¯” 20 å°æ™‚å¤šä¸€äº›ï¼ŒåŸå› æœ‰å¹¾å€‹\næ™‚é–“å¤ªé•·ç”Ÿç”¢åŠ›æœƒåš´é‡ä¸‹æ»‘ å˜—è©¦å£“ç¸®ç›®æ¨™æ™‚é–“ï¼Œåè€Œæœƒè®“è‡ªå·±ç”¨æ›´é«˜çš„å°ˆæ³¨åŠ›å®Œæˆ åˆ‡è¨˜ï¼Œå¿™ç¢Œä¸ç­‰æ–¼æœ‰æ•ˆç‡\nä¹‹å‰çš„æˆ‘æœ‰é»è¸©åˆ°è‘—å€‹å‘ï¼Œåªé—œæ³¨åˆ°è‡ªå·±èŠ±å¾ˆå¤šæ™‚é–“ï¼Œå»æ²’æ„è­˜åˆ°è‡ªå·±å°ˆæ³¨åŠ›èˆ‡ç”Ÿç”¢åŠ›ï¼Œå°è‡´åœ¨çå¿™\nä¸‰å€‹å¯¦è¸æ–¹å¼ ä½œè€…åˆ†äº«äº† 20 å¤šå€‹æ”¹å–„ç”Ÿç”¢åŠ›å¯¦é©—ï¼Œé€™é‚Šæˆ‘æŒ‘ 3 å€‹è¦ºå¾—æœ€æœ‰æ•ˆæœçš„\nå¯¦è¸ä¸€ï¼šæ‰¾å‡ºç”Ÿç†é»ƒé‡‘æ™‚æ®µ å»¶çºŒè§€å¿µä¸‰ï¼Œé…åˆå€‹äººçš„ä½œæ¯ï¼Œäººæ¯å¤©çš„ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›åœ¨ä¸åŒçš„æ™‚é–“é»éƒ½æœƒæœ‰ä¸åŒçš„è¡¨ç¾ï¼Œæ‰€ä»¥è¦æ‰¾å‡ºè‡ªå·±çš„ é»ƒé‡‘æ™‚æ®µï¼Œå°‡æœ€é‡è¦çš„äº‹æƒ…åœ¨æœ€ä½³çš„æ™‚æ®µè™•ç†ï¼Œé€™å°±æ˜¯æ‰€è¬‚çš„ç®¡ç†ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›\nä½œè€…æ˜¯å»ºè­°èŠ±ä¸€é€±çš„æ™‚é–“ï¼Œæ¯å€‹å°æ™‚å°±ç´€éŒ„ 1) ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›çš„ç‹€æ…‹ 2) å®Œæˆçš„äº‹é … 3) æ˜¯å¦æœ‰æ‹–å»¶çš„ç‹€æ³ (p67) è¿½è¹¤ä¸€æ®µæ™‚é–“ï¼Œå°±èƒ½æŒæ¡è‡ªå·±çš„ç”Ÿç†ç‹€æ³\nå¦å¤–æœ‰å¹¾å€‹æ–¹æ³•å¯ä»¥æ”¹å–„è‡ªå·±çš„ç”Ÿç†ç‹€æ³ï¼Œä¾‹å¦‚ ç¡åˆ°è‡ªç„¶é†’ / æˆ’ç³– / é‹å‹• / å†¥æƒ³ç­‰ï¼Œé€™éƒ¨åˆ†æ¯”è¼ƒç‚ºäººç†ŸçŸ¥å°±ä¸å¦å¤–è´…è¿°\nå¯¦è¸äºŒï¼šå®‰æ’æœ€é‡è¦çš„ä¸‰ä»¶äº‹ æ¯å¤©ä¸è¦å®‰æ’å¤ªå¤šçš„äº‹æƒ…ï¼Œåªè¦å®‰æ’3~5 ä»¶é‡è¦çš„äº‹å°±å¥½ï¼Œé€™å€‹æ•¸é‡çš„äº‹é …å¯ä»¥è¨˜åœ¨è…¦ä¸­ï¼Œå°±ä¸ç”¨é¡å¤–çš„ä»»å‹™ç®¡ç†å·¥å…· (p51)\né€™é»å€‹äººä¹Ÿéå¸¸æœ‰æ„Ÿï¼Œä¹‹å‰æ›¾ç¶“è©¦è‘—ç”¨ trello / asana / google calendar æƒ³è¦å»ç®¡ç†å€‹äººå·¥ä½œäº‹é …ï¼Œç™¼ç¾åˆ°é ­ä¾†èŠ±åœ¨ä»»å‹™äº‹é …è¦åŠƒçš„ç²¾åŠ›é é«˜æ–¼å¯¦éš›åŸ·è¡Œçš„æŠ•å…¥ï¼Œé€™é»ä¹Ÿå›å‘¼åˆ°è§€å¿µä¸€ï¼Œæˆ‘çœŸæ­£è¦æˆå°±çš„æ‡‰è©²æ˜¯å·¥ä½œé …ç›®ï¼Œè€Œä¸æ˜¯è¦åŠƒå·¥ä½œé …ç›®æœ¬èº«\nå¯¦è¸ä¸‰ï¼šå€åˆ†æ™‚é–“ç®¡ç† - å‰µä½œè€…èˆ‡ç®¡ç†è€… è§€å¿µä¸‰æåˆ°æ™‚é–“ç®¡ç†ç›¸å°ä¸æ˜¯é€™éº¼é‡è¦ï¼Œå¿ƒä¸­å¯èƒ½æœƒæœ‰å€‹ç–‘æƒ‘ã€Œæˆ‘åœ¨å…¬å¸å°±æœ‰å¾ˆå¤šæœƒè­°è¦é–‹ï¼ŒçœŸçš„ä¸éœ€è¦æ™‚é–“ç®¡ç†å—ï¼Ÿã€é€™é‚Šä½œè€…å¼•è¿° YC å‰µè¾¦äºº Paul Graham çš„æ™‚é–“ç®¡ç†æ–¹å¼ manager\u0026rsquo;s schedule and the maker\u0026rsquo;s scheduleï¼Œä»–å°‡æ™‚é–“ç®¡ç†åˆ†æˆå…©ç¨®æ¨¡å¼ ç®¡ç†è€…æ¨¡å¼èˆ‡å‰µä½œè€…æ¨¡å¼\nç®¡ç†è€…æ¨¡å¼ï¼šéœ€è¦èˆ‡ä»–äººæ™‚å¸¸é–‹æœƒã€å›è¦† Email çš„ç®¡ç†é¡å‹äº‹é …ï¼Œé€šå¸¸æœƒä»¥ä¸€å€‹å°æ™‚ç‚ºå–®ä½åˆ‡åˆ†ï¼Œä¸¦æ’å…¥ä¸åŒçš„è­°ç¨‹ å‰µä½œè€…æ¨¡å¼ï¼šå°ˆæ³¨æ–¼è‡ªå·±çš„ç”¢å‡ºï¼Œä¾‹å¦‚ä½œå®¶æˆ–ç¨‹åºå“¡ï¼Œé€šå¸¸æœƒä»¥æ›´å¤§çš„æ™‚é–“å€æ®µ (ä¸€å€‹ä¸Šåˆæˆ–ä¸‹åˆ) å®‰æ’è‡ªå·±çš„å·¥ä½œ è¦å…ˆè­˜åˆ¥è‡ªå·±å±¬æ–¼å“ªç¨®é¡å‹çš„å·¥ä½œè€…ï¼Œæ¥è‘—ç”¨å°æ‡‰çš„æ–¹å¼å®‰æ’å·¥ä½œé …ç›®ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ··åˆæ¨¡å¼ï¼Œä¾‹å¦‚ä½œè€…åˆ†äº«ä»–æ—©ä¸Šæ˜¯å‰µä½œè€…æ¨¡å¼ï¼Œä¸‹åˆæ¡ç”¨ç®¡ç†è€…æ¨¡å¼\né€™é‚Šå»¶ä¼¸è¨è«– Paul Graham åŸæ–‡ ä¸­å¹¾å€‹æœ‰è¶£çš„è«–é»\nèº«ç‚ºå‰µä½œè€…ï¼Œä¸è¦å°çœ‹ä¸€å€‹å°å°çš„æœƒè­°æ€éº¼æ‰“æ–·ä½ çš„å·¥ä½œæµï¼Œè©¦è‘—æƒ³æƒ³ç•¶æŸä¸€å¤©éƒ½æ²’æœ‰é–‹æœƒé‚£ç”Ÿç”¢åŠ›æ˜¯å¤šéº¼é©šäºº I find one meeting can sometimes affect a whole day. A meeting commonly blows at least half a day, by breaking up a morning or afternoon. (\u0026hellip;..) Don\u0026rsquo;t your spirits rise at the thought of having an entire day free to work, with no appointments at all?\nå¦‚æœä½ æ˜¯ç®¡ç†è€…è¦å¸¶é ˜ä¸€ç¾¤å‰µä½œè€…ï¼Œè¦å°å¿ƒè‡ªå·±çš„å®‰æ’æœƒè­°çš„æ–¹å¼æ˜¯ä¸æ˜¯æ°ç•¶çš„ Each type of schedule works fine by itself. Problems arise when they meet. Since most powerful people operate on the manager\u0026rsquo;s schedule, they\u0026rsquo;re in a position to make everyone resonate at their frequency if they want to.\nPaul Graham åœ¨ç®¡ç† YC æŠ•è³‡çš„åœ˜éšŠï¼Œæ˜¯é€é office hour æä¾›æŠ•è³‡çš„åœ˜éšŠä¸»å‹•é ç´„æ™‚æ®µï¼Œé€™æ¨£åœ˜éšŠå¯ä»¥ä¸»å‹•é¸æ“‡é©åˆçš„æ™‚é–“ (maker style)ï¼Œè€Œä¸æ˜¯è¢«å‹•çš„æ¥å—é ç´„ (manager style)ï¼›\nå°æ–¼ Paul Graham æœ¬äººä¾†èªªï¼Œä»–æŠŠæ‰€æœ‰çš„ office hour éƒ½æ’åœ¨è‡ªå·±å·¥ä½œæ—¥çš„æœ€å¾Œï¼Œåˆ‡åˆ†å‡ºè‡ªå·±çš„ç®¡ç†è€…èˆ‡å‰µä½œè€…æ™‚é–“ By using the classic device for simulating the manager\u0026rsquo;s schedule within the maker\u0026rsquo;s: office hours. \u0026hellip;. These chunks of time are at the end of my working day. (\u0026hellip;..) Because they come at the end of my day these meetings are never an interruption.\nè‡ªæˆ‘å¯¦è¸ ä»¥ä¸‹åˆ†äº«æˆ‘è‡ªå·±çš„ç”Ÿç”¢åŠ›ç®¡ç†æ–¹å¼ï¼Œä¸»è¦é€é Heptabase é€™å¥—ç­†è¨˜è»Ÿé«”ï¼Œä½¿ç”¨ Heptabase çš„å¥½è™•æ˜¯ï¼Œæˆ‘å¯ä»¥ç”¨åœ–å½¢åŒ–çš„æ–¹å¼ä¸€ç›®ç­ç„¶ç›¸é—œçš„ç´€éŒ„\næˆ‘ä¸»è¦æœƒåˆ†æˆ å¹´ / å­£ / æœˆ / é€± / æ—¥ï¼Œæˆ‘æœƒå¸Œæœ›å››è€…çš„ç›®æ¨™æ˜¯ç’°ç’°ç›¸æ‰£ï¼Œç•¶æˆ‘åœ¨å®‰æ’æ¯æ—¥å·¥ä½œäº‹é …ï¼Œæœƒæƒ³è¦çŸ¥é“é€™æœ‰æ²’æœ‰ç·Šæ‰£æˆ‘æ¯é€±çš„ç›®æ¨™ï¼Œè€Œæ¯é€±çš„ç›®æ¨™åˆ¶è¨‚æ™‚è¦ç·Šæ‰£æ¯æœˆçš„ç›®æ¨™ï¼Œä»¥æ­¤é¡æ¨\nç›®æ¨™ç®¡ç† åœ¨åˆ¶å®šæ¯å¹´çš„ç›®æ¨™ä¸Šï¼Œå»å¹´æˆ‘è·Ÿè€å©†èŠ±äº†ä¸€å¤©çš„æ™‚é–“ï¼Œæ¡ç”¨ Year Compassæ¨¡æ¿ï¼Œæˆ‘è¦ºå¾—è »ä¸éŒ¯çš„ï¼Œè¦†è“‹çš„ç¯„åœè »å®Œæ•´\nåœ¨åˆ¶å®šå¹´åº¦ç›®æ¨™æˆ‘ç›®å‰é‚„æ²’æœ‰å¾ˆæ¸…æ™°çš„ç•«é¢ï¼Œä½†æœƒè©¦è‘—ç”¨æ¯”è¼ƒå…·é«”çš„æè¿°å»è£œå……ï¼Œä¾‹å¦‚èªªä»Šå¹´å¹´åº¦ç›®æ¨™æœ‰ä¸€å€‹æ˜¯ã€Œé›¢é–‹ç¾åœ¨çš„å…¬å¸ï¼Œå»æ›´æœ‰åˆ¶åº¦çš„åœ°æ–¹ã€ï¼Œç•¶åˆè¨­ç«‹æ™‚æˆ‘å¿ƒä¸­æ²’æœ‰ä¸€å€‹æ˜ç¢ºçš„å¤¢æƒ³å…¬å¸ï¼Œåªç”¨æ›´æœ‰åˆ¶åº¦å»æ¶µè“‹ï¼Œä½†æˆ‘æœ‰è£œå……å¹¾å€‹ç´°é …å»æç¹ªï¼ŒåŒ…å«\nç”¢å“ç™¼å±•çš„åˆ¶åº¦ï¼Œæ˜¯å¦æœ‰æ¸…æ¥šçš„ product roadmapã€åœ¨ç”¢å“çš„åŠŸèƒ½é–‹ç™¼é€±æœŸæ˜¯å¦å®Œæ•´ å°ˆæ¡ˆç®¡ç†æµç¨‹ï¼Œæ˜¯å¦ä¸€å †éš•çŸ³è·Ÿ BDD (Boss Driven Design) é‡å°æ¯æ—¥ä»»å‹™ä¸Šï¼Œæˆ‘æ˜¯ç›´æ¥ç”¨ Heptabase æœ€è¿‘æ”¯æ´çš„ Journal card å»è¦åŠƒ æ‹†æˆå…©å€‹æ™‚æ®µå·¥ä½œå‰èˆ‡å·¥ä½œä¸­ï¼Œå„å®‰æ’ 3 ~ 5 å€‹é …ç›® æå‰å±•é–‹æœªä¾†å¹¾å¤©çš„å¡ç‰‡ï¼Œæƒ³åˆ°å°±å…ˆå¯«æˆå…·é«”çš„åŸ·è¡Œé …ç›®ï¼Œä¸è¦ç•¶å¤©è¦åŸ·è¡Œæ™‚æ‰æƒ³å¯¦ä½œçš„ç´°ç¯€\nä¾‹å¦‚èªªä»Šå¤©å®‰æ’åˆ·é¡Œï¼Œå¯ä»¥çš„è©±å‰ä¸€å¤©å°±æŠŠé¡Œç›®æŒ‘å‡ºä¾† / å¦‚æœä»Šå¤©è¦çœ‹æ›¸ï¼Œå°±å…ˆæŠŠæ›¸çš„é ç¢¼æˆ–ç« ç¯€æ¨™è¨˜å‡ºä¾†ï¼Œæœ‰å…·é«”çš„é …ç›®è®“åŸ·è¡Œæ™‚æœƒæ›´é †æš¢ æŠŠå¡ç‰‡æ”¤é–‹ï¼Œç•¶ç™¼ç¾è‡ªå·±æœ‰é»ç™¼æ•£æ™‚æé†’è‡ªå·±å›ä¾†çœ‹å¡ç‰‡çš„å…§å®¹ æ¯å¤© reviewï¼Œç°¡å–®ç´€éŒ„è‡ªå·±åŸ·è¡Œç‹€æ³ï¼Œä»¥åŠèŠ±è²»åœ¨æ¯å€‹ä»»å‹™ä¸Šçš„æ™‚é–“ ä»£è¾¦äº‹é …ç®¡ç† è”¡åŠ å°¼å…‹æ•ˆæ‡‰(Zeigarnik effect) : ä¸å®Œæ•´æˆ–è¢«ä¸­æ–·çš„ä»»å‹™ï¼Œæœƒå¸¶çµ¦æˆ‘å€‘å¾ˆå¤§çš„å¿ƒç†å£“åŠ›\né€™æ˜¯å€‹è »æœ‰è¶£çš„å¿ƒç†å¯¦é©—ï¼Œè”¡åŠ å°¼å…‹ç™¼ç¾é¤å»³æœå‹™ç”Ÿå°æ–¼æœªçµå¸³çš„è¨‚å–®æœ‰å¾ˆå¥½çš„è¨˜æ†¶ï¼Œä½†åªè¦è¨‚å–®ä¸€çµå¸³å®Œæˆï¼Œå°±æœƒå¾ˆé›£å›æƒ³èµ·\nä½œè€…æåˆ°ç•¶å¿ƒä¸­æœ‰ä¸€å€‹æƒ³æ³•æˆ–ä»£è¾¦äº‹é …æ™‚ï¼Œäººå€‘æœƒå¾ˆæ€•å¿˜è¨˜ï¼Œæ‰€ä»¥æœƒä¸€ç›´çµ¦è‡ªå·±å¿ƒç†å£“åŠ›ï¼Œå°è‡´å¤§è…¦çš„æ€ç·’ä¹Ÿå—åˆ°å½±éŸ¿ï¼Œæ­¤æ™‚æœ€å¥½çš„æ–¹å¼æ˜¯å¯«ä¸‹ä¾†ï¼Œç•¶å¤§è…¦æ„è­˜åˆ°é€™ä»¶äº‹å·²ç¶“è¢«ç´€éŒ„ï¼Œå°±æœƒé‡‹æ”¾å¿ƒç†å£“åŠ›ï¼Œæ›´å°ˆæ³¨åœ¨å…¶ä»–äº‹æƒ…ä¸Š\né€™å€‹ç†è«–åœ¨ã€Šå¡ç‰‡ç›’ç­†è¨˜ã€‹ä¹Ÿæœ‰æèµ·ï¼Œæˆ‘ç›®å‰çš„åšæ³•æ˜¯ç•¶ç ”ç©¶æŸå€‹ä¸»é¡Œå‡ºç¾æœ‰è¶£çš„åˆ†æ”¯æ™‚ï¼Œå…ˆé–‹æˆå¡ç‰‡æ¨™è¨˜æˆ todoï¼Œæ¥è‘—å…ˆå°ˆæ³¨åœ¨åŸæœ¬çš„ä¸»é¡Œç ”ç©¶ï¼Œé¿å…å¤ªéæ–¼ç™¼æ•£\nè€Œé€™å€‹ todo æ¸…å–®å°±æœƒè®Šæˆæˆ‘å®‰æ’å·¥ä½œæ™‚å¯ä»¥æª¢ç´¢çš„é …ç›®ï¼ŒHeptabase æœ‰ tag çš„åŠŸèƒ½ (å¤§éƒ¨åˆ†çš„ç­†è¨˜è»Ÿé«”æ‡‰è©²éƒ½æœƒæœ‰) å¦å¤–æ¨è–¦ tag çš„ç”¨æ³•ï¼Œæˆ‘æ˜¯åƒè€ƒ é›»è…¦ç©ç‰© - 2021è¦†ç›¤ï¼šå¦‚ä½•ç”¨æ¨™ç±¤ç®¡ç†ä¸Šè¬å‰‡ç­†è¨˜ï¼ŸEvernote, Notion, obsidian éƒ½é©ç”¨ï¼Œtag æ‡‰è©²æ˜¯ä»¥åŠŸèƒ½æ€§ç‚ºå°å‘è€Œéå…§å®¹ï¼Œtodo å°±æ˜¯ä¸€ç¨®åŠŸèƒ½æ€§ï¼Œä»£è¡¨å°šæœªå®Œæˆçš„ä»£æ’äº‹é …\né™¤äº†æ‰“ä¸Š todo tagï¼Œæˆ‘æœƒå¦å¤–æ¨™è¨˜ä»»å‹™çš„é¡å‹èˆ‡é›£æ˜“åº¦ï¼Œä¸»è¦æ˜¯æˆ‘æœƒå¸Œæœ›å‡è¡¡çš„åŸ·è¡Œï¼Œæˆ‘ä¸å¸Œæœ›æŸå€‹ç¦®æ‹œéƒ½åœ¨é–±è®€è€Œæ²’æœ‰ç”¢å‡ºã€æˆ–æ˜¯éƒ½æŒ‘ç°¡å–®çš„ä»»å‹™è€Œæ²’æœ‰é«˜é›£åº¦çš„ä»»å‹™åŸ·è¡Œ\nå¯¦è¸å¾Œçš„åæ€ ä¸è¦é«˜ä¼°ä¸€å¤©æ‰€èƒ½é”åˆ°çš„æˆå°±ï¼Œä¹Ÿä¸è¦ä½ä¼°ä¸€å¹´æ‰€èƒ½ç´¯ç©çš„æ•ˆæœã€‚\nåœ¨å¥—ç”¨ä»»å‹™è¦åŠƒçš„é€™æ®µæ™‚é–“ï¼Œåˆåœ¨é‡æ–°é«”æœƒäº†é€™å¥è©±ï¼Œæˆ‘ç™¼ç¾æˆ‘åœ¨åˆ¶å®šå¹´ã€å­£çš„ç›®æ¨™æ™‚æœƒè¨‚çš„å¤ªå°ï¼Œè€Œåœ¨æœˆã€é€±ã€æ—¥åˆä¼åœ–ä¸€æ¬¡åšåˆ°å¤ªå¤šäº‹ï¼Œå°¤å…¶æ˜¯ä¸€é–‹å§‹æ¯æ—¥ä»»å‹™éƒ½é–‹å¤ªå¤§ï¼Œå°è‡´ä¸æ–·åœ°å»¶æœŸ\nç›®å‰è©¦è·‘äº†ä¸‰é€±ï¼Œé è¨ˆæœƒèª¿æ•´äº†å¹¾å€‹æ–¹å‘\nç›®æ¨™åŠ ä¸Šé ä¼°æ™‚é–“èˆ‡å¯¦éš›èŠ±è²»æ™‚é–“ï¼Œå»æ”¶æ–‚è‡ªå·±å¯ä»¥å®Œæˆçš„é …ç›® ä¿ç•™å½ˆæ€§ï¼Œé™¤äº†å®‰æ’ä¸€æ•´å¤©éƒ½ä¸è¦å·¥ä½œå¤–ï¼Œå†æ’å¦ä¸€å¤©ä¸è¦é å…ˆè¦åŠƒé …ç›®ï¼Œä¿ç•™å½ˆæ€§çµ¦è‡ªå·±æ¶ˆåŒ–å»¶é²çš„é …ç›® è‡ªæˆ‘ retroï¼Œå¢åŠ è‡ªå·±å–œæ­¡ / ä¸å–œæ­¡ / æƒ³è¦ / ä¸æƒ³è¦çš„ç’°ç¯€ï¼Œå»æ›´è¿‘ä¸€æ­¥çŸ¥é“è‡ªå·±é©åˆçš„é …ç›® ã€Œæ‹‰é«˜è‡ªå·±çš„æ ¼å±€ï¼Œç‚ºè‡ªå·±è¨­å®šé©åˆçš„å¹´åº¦èˆ‡å­£åº¦ç›®æ¨™ã€é€™ä»¶äº‹æˆ‘é‚„åœ¨æ‘¸ç´¢ï¼Œç›®å‰é‚„æ˜¯ä»¥è‡ªå·±ä¸è¶³çš„çŸ¥è­˜æ¼æ´å»åŠ å¼·ç‚ºä¸»ï¼Œå¸Œæœ›é€éæŒçºŒçš„ retro å¯ä»¥æ”¶æ–‚å‡ºé©åˆè‡ªå·±çš„é•·é ç›®æ¨™\nç¸½çµ å„ªåŒ–è‡ªå·±çš„ç”Ÿç”¢åŠ›æœƒæ˜¯ä¸€å€‹æŒçºŒçš„éç¨‹ï¼Œã€Šæœ€æœ‰ç”Ÿç”¢åŠ›çš„ä¸€å¹´ã€‹é€™æœ¬æ›¸æˆ‘è¦ºå¾—æä¾›ä¸€å€‹å¾ˆå¥½çš„åŸºåº•ï¼Œå¯ä»¥åœ¨é€™ä¹‹ä¸Šæ‰“é€ å‡ºå±¬æ–¼è‡ªå·±çš„ç”Ÿç”¢åŠ›æµç¨‹ï¼Œæœªä¾†æœƒæŒçºŒçš„å„ªåŒ–ï¼Œæœ‰ä»€éº¼æœ‰è¶£çš„ç™¼ç¾æœƒæŒçºŒçš„è¿­ä»£ï¼Œå¦‚æœæœ‰ä¸åŒçš„åšæ³•æˆ–æ˜¯å·¥å…·çš„æ¨è–¦ï¼Œä¹Ÿæ­¡è¿ç•™è¨€~\n","date":"2023-04-01T02:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-04-01-%E6%9C%80%E6%9C%89%E7%94%9F%E7%94%A2%E5%8A%9B%E7%9A%84%E4%B8%80%E5%B9%B4%E8%AE%80%E6%9B%B8%E5%BF%83%E5%BE%97%E8%88%87%E5%80%8B%E4%BA%BA%E5%AF%A6%E8%B8%90/","title":"ã€Šæœ€æœ‰ç”Ÿç”¢åŠ›çš„ä¸€å¹´ã€‹è®€æ›¸å¿ƒå¾—èˆ‡å€‹äººå¯¦è¸"},{"content":"å‰è¨€ å…¬å¸ç•¶å‰æ˜¯é€é GitOps ArgoCD é€™å¥—å·¥å…·ä¾†ç®¡ç†æŒçºŒéƒ¨ç½²çš„æµç¨‹ï¼ŒArgoCD æœ‰å€‹æ–¹ä¾¿çš„ hook æ©Ÿåˆ¶ pre sync å’Œ post syncï¼Œå¯ä»¥åœ¨æ©Ÿå™¨éƒ¨ç½²å‰èˆ‡éƒ¨ç½²å¾ŒåŸ·è¡Œå°æ‡‰çš„è…³æœ¬\nåœ¨æˆ‘å€‘åŸæœ¬çš„ Rails éƒ¨ç½²æ©Ÿåˆ¶ï¼Œæœƒæ–¼ pre sync éšæ®µåŸ·è¡Œ\ndb:migrationï¼šè² è²¬ DB schema æ”¹å‹• data:migrationï¼šdata-migrate è² è²¬è·‘ä¸€äº› Rails script å›è£œè³‡æ–™ç­‰ é¿å… API server ä¸Šç·šå› ç‚ºæœ‰é«’è³‡æ–™æˆ–éŒ¯èª¤çš„ DB schema è€ŒåŸ·è¡ŒéŒ¯èª¤ 1 2 3 4 . â””â”€â”€ db/ â”œâ”€â”€ data =\u0026gt; data migration at presync â””â”€â”€ migrate =\u0026gt; schema change ä½†æœ‰æ™‚å€™æˆ‘å€‘æœƒéœ€è¦åœ¨æ©Ÿå™¨éƒ¨ç½²å®Œæˆå¾Œè§¸ç™¼ scriptï¼Œä¾‹å¦‚èªªç•¶æˆ‘å€‘æ–°å¢äº† sidekiq job éœ€è¦è§¸ç™¼æ™‚ï¼Œå¿…é ˆç­‰åˆ° sidekiq server éƒ½æ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬æ‰å¯ä»¥è§¸ç™¼ï¼Œå¦å‰‡æœƒ sidekiq server æœƒèªä¸å¾—æ–°çš„ job\nç°¡è€Œè¨€ä¹‹ï¼Œæˆ‘å€‘æœƒéœ€è¦åœ¨ pre sync æœ‰ä¸€å¥— data-migrationï¼Œåœ¨ post sync ä¹Ÿéœ€è¦åœ¨ä¸€å¥— data-migrationï¼Œä½†åŒä¸€å¥— data-migration æ˜¯ä¸èƒ½ç›´æ¥ç”¨åœ¨å…©å€‹è§¸ç™¼é»ï¼ŒåŸ·è¡Œæ™‚æœƒç„¡æ³•å€åˆ†å“ªäº› migration script è©²åœ¨ä»€éº¼æ™‚é–“é»è§¸ç™¼\nåŒ–æˆå…·é«”çš„éœ€æ±‚æ˜¯æä¾›ä¸€å¥—åŸºæ–¼ data-migration çš„ post sync è§¸ç™¼æ©Ÿåˆ¶ï¼Œå¸Œæœ›å°è£å‡ºé¡ä¼¼æ–¼ data-migration çš„æ•ˆæœ\né€éæŒ‡ä»¤å¯ä»¥ç°¡å–®ç”¢ç”Ÿ migration script template $ $ bin/rails generate post_sync hello_post_sync åŸ·è¡ŒæŒ‡ä»¤ $ bin/rake post_sync:migrate ç´€éŒ„åœ¨ DB ä¸­é¿å… script åè¦†åŸ·è¡Œ ä¸å½±éŸ¿ç¾æœ‰çš„ pre sync æ©Ÿåˆ¶ 1 2 3 4 5 . â””â”€â”€ db/ â”œâ”€â”€ data =\u0026gt; data migration at presync â”œâ”€â”€ migrate =\u0026gt; schema change â””â”€â”€ post_sync =\u0026gt; data migration at post sync ä»¥ä¸‹å°‡ä»‹ç´¹é€é rails generator ç°¡å–®é­”æ”¹é”åˆ°æˆ‘å€‘è¦çš„æ•ˆæœ\nå¯¦ä½œ 1. é€é Generator ç”¢ç”Ÿ migration script template é€é Rails Generator åŸºæ–¼æ¨¡æ¿ç”¢ç”Ÿå°æ‡‰çš„æª”æ¡ˆï¼Œé€é generator ç”¢ç”Ÿ generator $ bin/rails generate generator initializer\nåœ¨ generator ä¸­å¯ä»¥å®šç¾©ç”¢ç”Ÿæª”æ¡ˆçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å¾ CLI åƒä¸åŒçš„åƒæ•¸\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class InitializerGenerator \u0026lt; Rails::Generators::NamedBase source_root File.expand_path(\u0026#39;templates\u0026#39;, __dir__) def copy_initializer_file copy_file \u0026#34;initializer.rb\u0026#34;, \u0026#34;config/initializers/#{file_name}.rb\u0026#34; end def create_helper_file create_file \u0026#34;app/helpers/#{file_name}_helper.rb\u0026#34;, \u0026lt;\u0026lt;-FILE module #{class_name}Helper attr_reader :#{plural_name}, :#{plural_name.singularize} end FILE end end file_name æ˜¯å¾ Rails::Generators::NamedBase ç¹¼æ‰¿è€Œä¾†ï¼Œå¾ CLI è®€å–ï¼Œä¾‹å¦‚ $ bin/rails generate initializer core_extensions file_name å°±æ˜¯ core_extensions copy_file è¤‡è£½æª”æ¡ˆ create_file ç›´æ¥è¼¸å…¥æª”æ¡ˆå…§å®¹ å…¶ä»–æ›´å¤šæœ‰è¶£çš„ method 10 Generator methods Generator å¯¦ä½œ ç›®æ¨™æ˜¯æ‰“é€ ä¸€å€‹é¡ä¼¼ data-migrate çš„ generatorï¼Œå„²å­˜åœ¨ç¨ç«‹çš„ folder ä¸‹ï¼Œä¸¦æœ‰è‘— timestamp çµå°¾çš„æª”æ¡ˆ\nåœ¨é–±è®€ data-migrate åŸå§‹ç¢¼æ™‚ï¼Œçœ‹åˆ°å¯ä»¥é‡å° data_migrations script çš„ folder é€²è¡Œèª¿æ•´\n1 @data_migrations_path = \u0026#34;db/data/\u0026#34; æ‰€ä»¥éˆæ©Ÿä¸€å‹•å°±æƒ³èªªåœ¨ generator ä¸­å¦‚æœå¯ä»¥å‹•æ…‹ç½®æ›ï¼Œä¸¦è§¸ç™¼ data-migrate å°±å¯ä»¥ç”¢ç”Ÿæ–°çš„æª”æ¡ˆåˆ°å°æ‡‰çš„è³‡æ–™å¤¾ä¸‹ï¼Œè€Œä¸æœƒæ±¡æŸ“æ–¼æœ¬çš„ data-migrate\n1 2 3 4 5 6 7 8 9 10 # lib/generators/post_sync_generator.rb class post syncGenerator \u0026lt; Rails::Generators::NamedBase def copy_initializer_file DataMigrate.configure do |config| config.data_migrations_path = POST_SYNC_PATH end Rails::Generators.invoke(\u0026#34;data_migration\u0026#34;, [file_name]) end end data-migrate æœ¬èº«å°±æœ‰æä¾› data_migration çš„ generatorï¼Œè€Œä¸”å¯ä»¥ç›´æ¥åœ¨ generator ä¸­è§¸ç™¼å¦ä¸€å€‹ generatorï¼Œå†åŠ ä¸Š file_name å¯ä»¥å¾ CLI è®€å–ï¼Œé€™æ¨£å°±å¯ä»¥ä¸²èµ·ä¾†\næˆæœæ˜¯è¼¸å…¥ $ rails generate post_sync xxxx_xxxï¼Œæœƒåœ¨æŒ‡å®šçš„è·¯å¾‘ä¸‹ç”¢ç”Ÿ\n1 2 3 4 5 6 7 . â””â”€â”€ rails/ â””â”€â”€ db/ â”œâ”€â”€ data/ â”‚ â””â”€â”€ 20210408091311_migration.rb â””â”€â”€ post_sync/ â””â”€â”€ 20210429100009_post_sync.rb 2. è¨»å†Š Rake æŒ‡ä»¤ ç•¶æˆ‘å€‘å¸Œæœ›é€é CLI è§¸ç™¼ç‰¹å®šæŒ‡ä»¤æ™‚ï¼Œå¯ä»¥é€é Rakeï¼Œè™•ç†ä»»å‹™èˆ‡ä»»å‹™é–“ç›¸ä¾æ€§çš„ gem å¥—ä»¶\né€™é‚Šçš„ç”¨æ³•ç›¸ç•¶ç°¡å–®ï¼ŒåŒæ¨£å»æ”¹ migrations_pathï¼Œä¸¦è§¸ç™¼åŸæœ¬ data migrate çš„ Rake task å³å¯\n1 2 3 4 5 6 7 8 9 10 11 # lib/tasks/post_sync.rake namespace :post_sync do task :migrate do DataMigrate.configure do |config| config.data_migrations_path = POST_SYNC_PATH end Rake::Task[\u0026#39;data:migrate\u0026#39;].invoke end end 3. é¿å… timestamp collision å‰é¢æˆ‘å€‘é€é generator èˆ‡ rake æˆåŠŸç”¢ç”Ÿ migration script template èˆ‡åŸ·è¡Œ post syncï¼Œä¸¦ä¸”åœ¨æª”æ¡ˆè·¯å¾‘ä¸Šèˆ‡åŸæœ¬çš„ data migration åˆ†é–‹\nä½†ç›®å‰é‚„æœ‰å€‹å•é¡Œæ˜¯æœ€å¾Œ data-migrate ç´€éŒ„ script æ˜¯å¦æ›¾ç¶“è·‘éé‚„æ˜¯åœ¨åŒä¸€å¼µ DB table ä¸­ï¼Œé€™é‚Šæ²’æœ‰ config å¯ä»¥ç›´æ¥èª¿æ•´\nå¾Œä¾†è·ŸåŒäº‹è¨è«–å¾Œï¼Œæ±ºå®šæ‰‹å¯«ä¸€å€‹æª¢æŸ¥åœ¨ CI åŸ·è¡Œæ™‚ç¢ºèª db/data è·Ÿ db/post_sync ä¸‹çš„ timestamp æ²’æœ‰é‡è¤‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 class post syncChecker CHECK_FOLDER = [ DataMigrate.config.data_migrations_path, POST_SYNC_PATH ] class \u0026lt;\u0026lt; self def is_collision? (pre sync_versions, post sync_versions) = CHECK_FOLDER.map do |path| list_migration_versions(path: File.join(Rails.root, path)) end puts pre sync_versions (pre sync_versions \u0026amp; post sync_versions).present? end def list_migration_versions(path:) Dir.entries(path) .map { |filename| parse_version(filename: filename) } .compact end # ref: https://github.com/ilyakatz/data-migrate/blob/2dd90c495b4d57e4dc700e3f9be149c7e2b93b57/lib/data_migrate/data_migrator_five.rb#L44 def parse_version(filename:) result = /(\\d{14})_(.+)\\.rb$/.match(filename) return unless result.present? result[1] end end end å¤¾åœ¨æ¸¬è©¦ä¸­åŸ·è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # spec/unit/lib/post_sync_checker_spec.rb require \u0026#39;rails_helper\u0026#39; describe \u0026#34;post syncChecker\u0026#34; do let(:version) { 12345678901234 } let(:file_paths) { ::post syncChecker::CHECK_FOLDER.map do |path| File.join(Rails.root, path, \u0026#34;#{version}_test.rb\u0026#34;) end } context \u0026#34;when there are two file with same version\u0026#34; do before do file_paths.each do |file_path| File.new(file_path, File::CREAT) end end after do file_paths.each do |file_path| File.delete(file_path) end end it \u0026#39;should failed\u0026#39; do expect(::post syncChecker.is_collision?).to eq(true) end end it \u0026#34;check when running test\u0026#34; do expect(::post syncChecker.is_collision?).to eq(false) end ç¸½çµ é€™æ˜¯ä¸€å€‹å°å°çš„å·¥å…·ï¼Œä¸éåœ¨å°æ–¼æ•´å€‹éƒ¨ç½²æµç¨‹æœ‰é‚„ä¸éŒ¯çš„å¹«åŠ©\n","date":"2023-03-28T02:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-03-28-rails-%E9%83%A8%E7%BD%B2%E5%84%AA%E5%8C%96-%E9%AD%94%E6%94%B9-data-migration-%E5%AF%A6%E4%BD%9C-post-sync-%E6%A9%9F%E5%88%B6/","title":"Rails éƒ¨ç½²å„ªåŒ–: é­”æ”¹ data-migration å¯¦ä½œ post sync æ©Ÿåˆ¶"},{"content":"å‰è¨€ Elasticsearch æ˜¯å¸¸ç”¨ä¾†åšå…¨æ–‡æœå°‹çš„ NoSQL Databaseï¼Œå…¬å¸åœ¨ä½¿ç”¨ä¸Šæœ‰è‡ªæ¶ä¹Ÿæœ‰ç”¨ AWS Opensearch è¨—ç®¡æœå‹™ è¦ç‰¹åˆ¥ç•™æ„çš„æ˜¯ Opensearch æ˜¯ AWS è‡ªå·± fork ç¶­è­·ï¼Œå…©è€…ä¸å®Œå…¨å…¼å®¹ï¼Œè‡³å°‘åœ¨ client sdk é€£ç·šæ˜¯ä¸å…¼å®¹çš„! åŸæœ¬ä½¿ç”¨ Golang Elasticsearch å®˜æ–¹ SDK v7.17 è¦é€£ç·š Opensearch å›ç›´æ¥æ‹‹éŒ¯\nerror: the client noticed that the server is not a supported distribution of Elasticsearch\nä¸€äº›ç›¸é—œçš„æ–‡ç«  [Elasticsearch] The Server Is Not A Supported Distribution Of Elasticsearch\nSince the AWS Elasticsearch Service has incompatible APIs with Elasticsearch itself, either by missing APIs or has incompatible format, we do not support it.\nBeef æ‡‰è©²å¯ä»¥å¾€å‰è¿½æº¯å¹¾å¹´å‰ Elasticsearch è¦ºå¾— AWS åœ¨ç™½å«–é–‹æºç¤¾ç¾¤é€²è€Œæ›´æ”¹æˆæ¬Šï¼Œä½¿å¾— AWS æ±ºå®šè‡ªå·±ç¶­è­· Opensearch (æ–°è AWSåˆ†å‰Elasticsearché‡æ–°å‘½åç‚ºOpenSearch)\nä½†æœ‰è¶£çš„æ˜¯æˆ‘æ¸¬è©¦äº†ä¸€äº›å ´æ™¯ï¼ŒAWS Opensearch client SDK å¯ä»¥é€£ç·š Elasticsearch (ä»¥ä¸‹ç°¡ç¨± ES) èˆ‡ Opensearch serverï¼Œæ‰€ä»¥ä»¥ä¸‹å°±ç”¨ Opensearch cliend SDK æ“ä½œ ESï¼Œå¾ŒçºŒä¸æœƒé‡å° ES æœ¬èº«æœ‰å¤ªå¤šä»‹ç´¹ï¼Œå¯ä»¥åƒè€ƒä¹‹å‰çš„å¹¾ç¯‡æ–‡ç«  Elasticsearch æ•™å­¸ - API æ“ä½œ å’Œ Elasticsearch ç³»çµ±ä»‹ç´¹èˆ‡è©•ä¼°\nClient SDK ä½¿ç”¨ ä»¥ä¸‹ä½¿ç”¨æœƒè¦†è“‹å¹¾å€‹å ´æ™¯\nå»ºç«‹ Client é€£ç·š å»ºç«‹ Index æ’å…¥ Document æœå°‹ Document å»ºç«‹ Mapping åˆªé™¤ Index å®Œæ•´åŸå§‹ç¢¼åƒè€ƒ https://github.com/sj82516/elasticsearch-golangï¼Œæˆ–æ˜¯åƒè€ƒ Opensearch å®˜æ–¹æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 func main() { // connect to elasticsearch client, _ := opensearch.NewClient(opensearch.Config{ Addresses: []string{ \u0026#34;http://localhost:9200\u0026#34;, }, }) // create index res, _ := client.Indices.Create(index) fmt.Println(res) // create document createThenSearch(res, client) // refresh client.Indices.Refresh() } func createThenSearch(res *opensearchapi.Response, client *opensearch.Client) { // create document createDocument(res, client, `{\u0026#34;key\u0026#34;: \u0026#34;key1\u0026#34;, \u0026#34;title\u0026#34;:\u0026#34;Test my first document\u0026#34;, \u0026#34;number\u0026#34;: 5}`) createDocument(res, client, `{\u0026#34;key\u0026#34;: \u0026#34;key1.child\u0026#34;, \u0026#34;title\u0026#34;:\u0026#34;Test my first document\u0026#34;, \u0026#34;number\u0026#34;: 5}`) // refresh client.Indices.Refresh() // search document by text field r := search(res, client, \u0026#34;title\u0026#34;, \u0026#34;document\u0026#34;) fmt.Println(\u0026#34;search by title:\u0026#34;, r) r = search(res, client, \u0026#34;key\u0026#34;, \u0026#34;key1\u0026#34;) fmt.Println(\u0026#34;search by key:\u0026#34;, r) r = search(res, client, \u0026#34;key\u0026#34;, \u0026#34;child\u0026#34;) fmt.Println(\u0026#34;search by key:\u0026#34;, r) } func createDocument(res *opensearchapi.Response, client *opensearch.Client, document string) { req := opensearchapi.IndexRequest{ Index: index, Body: strings.NewReader(document), } res, _ = req.Do(context.Background(), client.Transport) } type searchResponse struct { Hits struct { Total struct { Value int `json:\u0026#34;value\u0026#34;` } `json:\u0026#34;total\u0026#34;` Hits []struct { Score float64 `json:\u0026#34;_score\u0026#34;` Source struct { Key string `json:\u0026#34;key\u0026#34;` Title string `json:\u0026#34;title\u0026#34;` Number int `json:\u0026#34;number\u0026#34;` } `json:\u0026#34;_source\u0026#34;` } `json:\u0026#34;hits\u0026#34;` } `json:\u0026#34;hits\u0026#34;` } func search(res *opensearchapi.Response, client *opensearch.Client, key string, value string) searchResponse { s := map[string]interface{}{ \u0026#34;query\u0026#34;: map[string]interface{}{ \u0026#34;match\u0026#34;: map[string]interface{}{ key: value, }, }, } body, _ := json.Marshal(s) searchReq := opensearchapi.SearchRequest{ Index: []string{index}, Body: bytes.NewReader(body), } res, _ = searchReq.Do(context.Background(), client.Transport) var r searchResponse json.NewDecoder(res.Body).Decode(\u0026amp;r) return r } ä»¥ä¸Šæ˜¯å¤§è‡´çš„ API æ“ä½œï¼Œå‘¼å«èµ·ä¾†ä¸å¤ªéº»ç…©ï¼Œåªæ˜¯æ–‡ä»¶æœ‰é»ç°¡é™‹éœ€è¦ä¸åœçš„æŸ¥æ‰¾ï¼Œå»ºè­°å¯ä»¥é–‹è‘— Kibana çš„å¾Œå°å°æ‡‰æŸ¥è©¢èˆ‡å›æ‡‰ï¼Œæœ‰ hint è »æ–¹ä¾¿çš„ æœ‰å…©å€‹åœ°æ–¹éœ€è¦ç‰¹åˆ¥ç•™æ„\nå¦‚æœæ˜¯æœ¬åœ°ç«¯æ¸¬è©¦ï¼Œè¨˜å¾—åœ¨ create document å¾Œ client.Indices.Refresh() å¼·åˆ¶ refresh indexï¼Œå› ç‚º ES æ”¶åˆ°å»ºç«‹è«‹æ±‚å¾Œéœ€è¦ä¸€æ®µæ™‚é–“è™•ç†æ‰èƒ½å¤ æŸ¥è©¢ï¼Œæ‰€ä»¥è¦å¼·åˆ¶ refresh æ‰èƒ½ç›´æ¥æŸ¥! é è¨­ ES çš„ string è¼¸å…¥éƒ½æœƒæ˜¯ text å‹åˆ¥ï¼Œè€Œ text å‹åˆ¥æœƒç¶“é tokenize ã€analyzer åŠ å·¥å¾Œæ”¯æ´å…¨æ–‡æœå°‹ï¼Œé€™å…¶ä¸­çš„è™•ç†åŒ…å«äº†å»é™¤å†—è©è´…å­—ã€æ–·è©ç­‰ç­‰ï¼›\næ‰€ä»¥åƒæ˜¯æˆ‘åŸæœ¬é æœŸ key é€™å€‹æ¬„ä½æ˜¯å®Œå…¨åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯æŸ¥è©¢æ™‚è¦å®Œæ•´çš„å‘½ä¸­ï¼Œä½†å› ç‚ºé è¨­æ˜¯å…¨æ–‡æœå°‹ï¼Œæ‰€ä»¥æœƒæŠŠæ²’æœ‰å®Œå…¨åŒ¹é…çš„çµæœä¹Ÿå›å‚³ï¼Œå¦‚åœ–ä¸‹æˆ‘æŸ¥è©¢ \u0026ldquo;key\u0026rdquo;=\u0026ldquo;key1\u0026rdquo;ï¼Œçµæœé€£ \u0026ldquo;key1.child\u0026rdquo; éƒ½å›å‚³äº† å¦‚æœè¦è§£æ±ºé€™å€‹å•é¡Œçš„è©±ï¼Œéœ€è¦åœ¨ Index å»ºç«‹å¾Œå¢åŠ  Mappingï¼ŒMapping æ˜¯æŒ‡å®š Index æ¯å€‹æ¬„ä½çš„è™•ç†æ–¹å¼ï¼Œå¯ä»¥åˆ‡æ›ä¸åŒçš„å‹åˆ¥ã€æŒ‡å®šæ˜¯å¦è¦è¢« indexing ç­‰\n1 2 3 4 5 6 7 8 9 10 func createMapping(res *opensearchapi.Response, client *opensearch.Client) *opensearchapi.Response { mapping := `{\u0026#34;properties\u0026#34;:{\u0026#34;key\u0026#34;:{\u0026#34;type\u0026#34;:\u0026#34;keyword\u0026#34;}}}` res, _ = client.Indices.Create(index) req := opensearchapi.IndicesPutMappingRequest{ Index: []string{index}, Body: bytes.NewReader([]byte(mapping)), } res, _ = req.Do(context.Background(), client.Transport) return res } éœ€è¦ç‰¹åˆ¥ç•™æ„ Mapping å¿…é ˆè¦åœ¨ Index ç‚ºç©ºçš„æƒ…æ³ä¸‹æ‰èƒ½ç”Ÿæ•ˆï¼Œå¦‚æœå·²ç¶“æœ‰ document å°±ä¸è¡Œï¼Œéœ€è¦é‡æ–°å»ºç«‹\nä»¥ä¸‹æŸ¥è©¢ \u0026ldquo;key\u0026rdquo;=\u0026ldquo;key1\u0026rdquo; æˆåŠŸå›å‚³ä¸€ç­†è³‡æ–™ ","date":"2023-03-17T02:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-03-17-elasticsearch-%E6%93%8D%E4%BD%9C-golang-opensearch-sdk-%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/","title":"Elasticsearch æ“ä½œï¼š Golang Opensearch SDK ä½¿ç”¨ç­†è¨˜"},{"content":"ä¸Šä¸€ç¯‡ é©—è­‰èˆ‡æˆæ¬Šçš„å·®åˆ¥ï¼Œæ·ºè«‡ OAuth 2.0 èˆ‡ OpenID Connect æ·ºè«‡åˆ° OAuth 2.0 èˆ‡ OIDC çš„å·®ç•°ï¼Œæˆ‘å€‘æ˜¯ä»¥ Client çš„è§’åº¦å»ç†è§£å¦‚æœåƒç¬¬ä¸‰æ–¹å–å¾—é©—è­‰èˆ‡æˆæ¬Šï¼Œä½†å¦‚æœä»Šå¤©æˆ‘å€‘è¦ Google ä¸€æ¨£è‡ªå·±è™•ç†æˆæ¬Šçš„è¨­è¨ˆï¼Œæ€è€ƒçš„æ–¹å¼å°±æœƒæœ‰æ‰€ä¸åŒ\nåƒè€ƒä»¥ä¸‹çš„æ–‡ç« ï¼Œåˆ†äº«é€™å¹¾å¤©ç ”ç©¶å¾®æœå‹™ä¸‹è©²å¦‚ä½•è¨­è¨ˆé©—è­‰çš„æ©Ÿåˆ¶\nBest Practices for Authorization in Microservices Zanzibar: Googleâ€™s Consistent, Global Authorization System How Netflix Is Solving Authorization Across Their Cloud [I] - Manish Mehta \u0026amp; Torin Sandall, Netflix Open Policy Agent çœ‹åˆ°ç¶²è·¯ä¸Šæœ‰æ™‚æœƒç¸®å¯« (Authentication -\u0026gt; AuthN / Authorization -\u0026gt; AuthZ)ï¼Œä»¥ä¸‹ä¹Ÿæœƒç”¨æ­¤ç¸®å¯«\nä¸€. æ‰€è¬‚çš„æˆæ¬Šé©—è­‰ Authorization å…·é«”ä¾†èªªï¼Œæˆæ¬Šè¨­å®šä¸»è¦æ˜¯åˆ¤æ–·\n{æŸäºº} æ˜¯å¦å¯ä»¥é‡å° {æŸè³‡æº} åŸ·è¡Œ {æŸæ“ä½œ}\nç¾ä»Šæœ‰ä¸‰ç¨®ä¸»æµç®¡ç†æˆæ¬Šçš„æ–¹å¼\nRBAC ABAC ReBAC 1. RBAC åˆ¶å®š Role ä¸¦ç¶å®šå°æ‡‰çš„æ¬Šé™ï¼Œä¾‹å¦‚ AWS IAMï¼Œæ¡ˆä¾‹å¦‚ â€œå¦‚æœç”¨æˆ¶æ˜¯ Admin æ¬Šé™æ‰å¯ä»¥ç€è¦½æ­¤é é¢â€œ\nä½†æ˜¯æ¬Šé™å°±ç›´æ¥ç¶æ­» Roleï¼Œå¦‚æœåŒå€‹ Role ä¸‹çªç„¶æƒ³è¦åœ¨æ‹†åˆ†æ›´ç´°çš„æ§åˆ¶ï¼Œå°±è¦å¢åŠ æ–°çš„ Role\n2. ABAC é€é Attribute ç¶å®šå°æ‡‰çš„æ¬Šé™ï¼Œä¾‹å¦‚ â€œå¦‚æœç”¨æˆ¶æ˜¯ 10 æœˆä»¥å‰è¨»å†Šï¼Œå¯ä»¥äº«æœ‰ xxx å„ªæƒ â€œï¼ŒAttribute åˆ¶å®šç›¸å°å°±å½ˆæ€§è¨±å¤šï¼ŒAWS IAM ä¹Ÿå¯ä»¥ç”¨ ABAC è¨­å®š\n3. ReBAC ç•¶è§’è‰²æˆ–è³‡æºæ˜¯æœ‰å±¤ç‹€çš„ç¹¼æ‰¿é—œä¿‚æ™‚ï¼Œå¯ä»¥é€éæè¿° Relation æ–¹å¼ä¾†åˆ¶å®šæ¬Šé™ï¼Œä¾‹å¦‚ â€œGroup A åŒ…å« Group Bï¼Œå°æ˜æ˜¯ Group B æˆå“¡ï¼ŒæŸå€‹æª”æ¡ˆæ˜¯ Group A æ‰€æœ‰æˆå“¡éƒ½å¯ä»¥è®€å–ï¼Œå‰‡å°æ˜ä¹Ÿæ‡‰è©²è¦å¯ä»¥è®€å–â€œ\näºŒ. å¾®æœå‹™ä¸‹çš„é©—è­‰æ¶æ§‹ åœ¨ monolithic æ¶æ§‹ä¸‹ï¼Œå› ç‚º DB éƒ½åœ¨ä¸€å¡Šï¼Œæ‰€ä»¥ authorization å¯ä»¥ç›´æ¥ query æª¢æŸ¥å³å¯ï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 # å¦‚æœç”¨æˆ¶æ˜¯ admin if user.is_admin // xxxx end # å¦‚æœç”¨æˆ¶æ˜¯è³‡æºæ“æœ‰è€… if user.id == document.onwer_id // xxxx end é©—è­‰è®Šæˆæ˜¯å•†æ¥­é‚è¼¯çš„ä¸€éƒ¨åˆ†\nä½†å¦‚æœä»Šå¤©æ˜¯åœ¨ microservice æƒ…æ³ä¸‹ï¼Œè©²å¦‚ä½•åˆ¤æ–·ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™å¯ä»¥æ“ä½œå‘¢ï¼Ÿ å¤§è‡´æœ‰ä»¥ä¸‹ä¸‰ç¨®æ–¹æ³•\n1. å°‡è³‡æ–™æ”¾åœ¨åŸä½ï¼Œé€é API å‘¼å« å‡è¨­ä»Šå¤©ç¨ç«‹ä¸€å€‹ document serviceï¼Œæ¯å€‹ document éš¸å±¬æ–¼æŸå€‹çµ„ç¹” org ä¸‹ï¼Œè€Œ org ç®¡ç†æ˜¯å±¬æ–¼ user service çš„ç¯„ç–‡ å‰‡ user service å¯ä»¥é–‹ä¸€æ¢ API å°ˆé–€æŸ¥è©¢ user æ‰€éš¸å±¬çš„ org é€™æ˜¯æœ€ç°¡å–®ä¸”æœ‰æ•ˆçš„æ–¹å¼ï¼Œä½†å¦‚æœæœå‹™è¶Šè®Šè¶Šå¤šï¼Œå‰‡æœƒæœ‰å¹¾å€‹å•é¡Œ\næœå‹™é–“åˆ¤ç«¯å¯èƒ½æœ‰é‡è¤‡å‘¼å« (ä¾‹å¦‚ document å¾€ä¸Šå¤šä¸€å±¤ folderï¼Œè®Šæˆè¦åˆ¤æ–· user æ˜¯å¦æœ‰æ¬Šé™æ“ä½œ document èˆ‡ folder) API å‘¼å«æœƒæœ‰å»¶é² å¦‚æœé©—è­‰æ–¹å¼æ”¹è®Šï¼Œå¤šå€‹ service ä¹Ÿè¦è·Ÿè‘—æ”¹å‹• (ä¾‹å¦‚ service A / service B éƒ½æ˜¯ç”¨ org é©—è­‰ï¼Œä½†ä¹‹å¾Œçªç„¶è®Šæˆè¦ç”¨ user æœ¬èº«é©—è­‰) 2. åœ¨ Gateway æ³¨å…¥æˆæ¬Šé©—è­‰æ‰€éœ€çš„è³‡æ–™ æ—¢ç„¶æœå‹™éƒ½éœ€è¦ user org é€™å€‹è³‡è¨Šï¼Œé‚£æˆ‘å€‘åœ¨ request è¿‘ä¾†æ™‚å°±é€é gateway æŠŠ user è³‡è¨Šå¡å¥½å¡æ»¿ï¼Œå¥½è™•æœ‰\næ¸›å°‘å¤šé¤˜ requestï¼Œæ‰€æœ‰ä¸‹æ¸¸çš„ service éƒ½èƒ½è®€å–åˆ° user org åƒæ•¸ å¦‚æœæˆæ¬Šçš„åƒæ•¸å¾ˆæœ‰é™ï¼Œä¾‹å¦‚åªæœ‰åˆ‡åˆ†å¹¾ç¨® roleï¼Œé‚£ gateway æœƒæ˜¯æœ€æ–¹ä¾¿çš„ ç¼ºé»æ˜¯ Gateway æœƒéœ€è¦çŸ¥é“æ‰€æœ‰ service éœ€è¦çš„è³‡æ–™ï¼Œå¦‚æœä»Šå¤©é©—è­‰æ–¹å¼æ”¹è®Š Gateway ä¹Ÿè¦è·Ÿè‘—æ”¹è®Š\n3. ç¨ç«‹çš„æˆæ¬Šé©—è­‰æœå‹™ æœ‰ä¸€å€‹ç¨ç«‹çš„ AuthZ serviceï¼Œå…¶ä»– service æ”¶åˆ° request éƒ½ç›´æ¥å‘ AuthZ service é©—è­‰æˆæ¬Šï¼Œå°‡é©—è­‰èˆ‡å•†æ¥­é‚è¼¯æ‹†é–‹ä¸¦é›†ä¸­ç®¡ç†æˆæ¬Šé‚è¼¯\nç‰¹åˆ¥é©ç”¨æ–¼å¾®æœå‹™çœ¾å¤šä¸”éœ€è¦äº’ç›¸æºé€šçš„æƒ…æ³ / æœ‰ç¬¬ä¸‰æ–¹å» å•†è¦åˆ†äº«è³‡æ–™æ™‚ï¼Œä¾‹å¦‚ Google / Airbnb / Netflix\nç¼ºé»æ˜¯\nAuthZ service èˆ‡å…¶é¤˜ Service çš„å…§å®¹è€¦åˆï¼Œå› ç‚º AuthZ service ä¸¦é ˆçŸ¥é“æ‰€æœ‰çš„ resourceï¼Œæ‰èƒ½å°æ‡‰è¨­å®šæ¬Šé™ï¼Œä¾‹å¦‚ document / folder ç­‰ å¤šä¸€çµ„æœå‹™è¦ç¶­è­· å¤§éƒ¨åˆ†çš„å…¬å¸æ‡‰è©²éƒ½ä¸éœ€è¦å¦‚æ­¤è¤‡é›œï¼Œé€šå¸¸ä¹Ÿæ²’æœ‰ç¨ç«‹çš„åœ˜éšŠåœ¨ç¶­è­·é©—è­‰æˆæ¬Šï¼Œä½†å¯ä»¥å€Ÿé¡ Google è¨­è¨ˆçš„ Zanzibar èˆ‡ CNCF çš„é–‹æºå°ˆæ¡ˆ Open Policy Agent (OPA) ä¾†çœ‹å¤§å‹è»Ÿé«”æ¡ç”¨çš„æˆæ¬Šæª¢æŸ¥æ–¹æ³•\nä¸‰. Google ä¸­å¿ƒåŒ– AuthZ æœå‹™ - Zanzibar Zanzibar æ˜¯ä¸­å¿ƒåŒ–çš„ AuthZ æœå‹™ï¼Œæä¾›çµ±ä¸€çš„ data model èˆ‡ config language (æè¿° ReBAC çš„è¦å‰‡)ï¼Œä»–æœ‰ä»¥ä¸‹çš„è¡¨ç¾\næ•ˆèƒ½ï¼šå»¶é² p95 \u0026lt; 10ms è¦æ¨¡ï¼šæ•¸åå„„çš„è¦å‰‡ / æ¯ç§’ç™¾è¬ç­‰ç´š requestï¼Œå›Šæ‹¬ Calendar, Cloud, Drive, Maps, Doc ç­‰ å¯ç”¨æ€§ï¼š99.999% å¯¦éš›è¨­å®šå¯èƒ½åƒä»¥ä¸‹åœ–ç¤º (é google å®˜æ–¹ï¼Œåƒè€ƒè‡ª zanzibar.academy) ç‚ºä»€éº¼éœ€è¦ä¸­å¿ƒåŒ–çš„ AuthZ æœå‹™ æä¾›çµ±ä¸€çš„èªæ„å’Œç”¨æˆ¶é«”é©— ç•¶å¤šå€‹æ‡‰ç”¨ç¨‹å¼äº’äº¤ç›¸éŒ¯æ™‚ï¼Œæ›´å®¹æ˜“å¯¦ä½œ ä¾‹å¦‚ç™¼é€ Gmail æ™‚æœƒå¹«ä½ æª¢æŸ¥é™„ä»¶ä¸­çš„ Google Doc æ”¶ä»¶äººæ˜¯å¦æœ‰æ¬Šé™è®€å–\nTuple: æè¿°ã€Œç‰©ä»¶èˆ‡ç‰©ä»¶çš„é—œä¿‚ã€æˆ–ã€Œç‰©ä»¶èˆ‡ç”¨æˆ¶çš„é—œä¿‚ã€ Zanzinbar æœ‰è‡ªå·±ä¸€å¥—æè¿°è¦å‰‡çš„èªè¨€ï¼Œæ¯æ¢è¦å‰‡ç¨±ç‚ºä¸€å€‹ tupleï¼Œå¯ä»¥æè¿°\nuser U has relation R to object O set of users S has relation R to object O ä»¥ä¸‹æ˜¯è«–æ–‡çš„æ¡ˆä¾‹\ndoc:readme#owner@10 User 10 is an owner of doc:readme group:eng#member@11 User 11 is a member of group:eng\ndoc:readme#viewer@group:eng#member Members of group:eng are viewers of doc:readme\ndoc:readme#parent@folder:A#... doc:readme is in folder:A\nå¾ŒçºŒ Client å°±å¯ä»¥é€é check API æŒ‡å®š user + operation + object è«‹æ±‚é©—è­‰\nä¸€äº›å¯¦ä½œçš„å›°é›£èˆ‡å…‹æœæ–¹å¼ é€šç¯‡è«–æ–‡ä¸»è¦åœ¨è¬›è¨­è¨ˆ Zanzibar çš„æŒ‘æˆ°ï¼Œå› ç‚ºé©—è­‰æœå‹™éœ€è¦æ»¿è¶³\nFlexibility è®“å¤šç¨®æœå‹™éƒ½èƒ½è¨­è¨ˆè‡ªå·±çš„é©—è­‰è¦å‰‡ Correctness é©—è­‰æ˜¯æ ¸å¿ƒçš„ç”¨æˆ¶éš±ç§ä¿è­·æ‰€ä»¥åˆ¤æ–·çµæœä¸€å®šè¦æ­£ç¢º Low Latency å› ç‚ºå¤§å¤šæ•¸çš„ Request éƒ½éœ€è¦é©—è­‰ Scale å› ç‚º Request æœƒéå¸¸é »ç¹ (è«‹æ±‚æ¯ç§’ç™¾è¬ä¸”æ©«è·¨æ•´å€‹åœ°çƒ) High Availability å› ç‚ºæ¯å€‹æœå‹™éƒ½æœƒä¾è³´é©—è­‰æœå‹™ ä»¥ä¸‹æå¹¾é»æ¯”è¼ƒæœ‰è¶£çš„å›°é›£èˆ‡å…‹æœæ–¹å¼\n1. è¨­å®šçš„æœ€çµ‚ä¸€è‡´æ€§ ç•¶ ACL (Access Control List) ç™¼ç”Ÿæ”¹è®Šæ™‚ï¼Œæ“ä½œçš„é †åºå¿…é ˆåš´æ ¼éµå®ˆï¼Œå¦å‰‡æœƒä¸å°å¿ƒæŠŠèˆŠçš„ ACL å¥—ç”¨åˆ°æ–°çš„ç‰©ä»¶ä¸Š / èˆŠ ACL å½±éŸ¿åˆ°æ–°çš„å…§å®¹ (åŒç‰©ä»¶)ï¼Œå¦å‰‡æœƒæœ‰ä»¥ä¸‹éŒ¯èª¤\nex1. Alice ç§»é™¤ Bob æ¬Šé™ (1)ï¼Œæ­¤æ™‚æ–°å¢ç‰©ä»¶ O (2) ç¹¼æ‰¿ä¸Šå±¤æ¬Šé™ï¼Œå‰‡ Bob ä¸æ‡‰è©²æ“æœ‰ O çš„æ¬Šé™ (3) å¦‚æœ 2 æ¯” 1 å…ˆå¥—ç”¨ï¼Œå‰‡ Bob å°±ä¸å°å¿ƒæœ‰äº† O çš„æ¬Šé™ (2 \u0026gt; 1) ex2. Alice ç§»é™¤ Bob æ¬Šé™ (1)ï¼Œæ­¤æ™‚ç‰©ä»¶ O æ–°å¢å…§å®¹ (2)ï¼Œå‰‡ Bob ä¸æ‡‰è©²çœ‹åˆ°æ–°çš„å…§å®¹ (3) å¦‚æœ 2 æ¯” 1 å…ˆå¥—ç”¨ï¼Œä¸” Bob åœ¨ 1 ä¹‹å‰è®€å–åˆ°æ–°çš„å…§å®¹ (å¥—ç”¨é †åºï¼š2 \u0026gt; 3 \u0026gt; 1)ï¼Œä½†ç†è«–ä¸Šä»–ä¸æ‡‰è©²çœ‹åˆ°æ–°çš„å…§å®¹ ä»¥ä¸Šå•é¡Œç¨±ç‚º new enemy problemï¼ŒZanzibar é€é external consistency èˆ‡ snapshot reads with bounded staleness è§£æ±ºæ­¤å•é¡Œ\nexternal consistency\nç•¶æ“ä½œ Tx åœ¨æ“ä½œ Ty ä¹‹å‰ï¼Œå‰‡ç•¶ T æ™‚çœ‹åˆ° Ty ç”Ÿæ•ˆæ™‚ï¼Œå‰‡ Tx å¿…å®šç”Ÿæ•ˆï¼ŒZanzibar æ˜¯é€é Google Spanner å„²å­˜ï¼Œä»°è³´ data storage çš„ç‰¹æ€§ä¿è­‰ snapshot reads with bounded staleness\nç•¶ç‰©ä»¶æ›´æ–°æ™‚ (ex2-2)ï¼Œç•¶ä¸‹ç‰ˆæœ¬æœƒå°æ‡‰ä¸€å€‹ç¨±ç‚º zookie token ä¸¦è¨˜éŒ„ç•¶ä¸‹çš„æ™‚é–“ï¼›ä¹‹å¾Œ client request éƒ½å¿…é ˆå¸¶ä¸Š zookieï¼Œåªè¦è®€å–çš„æ™‚å€™æ¯”å° zookie æ™‚é–“å°æ–¼ç­‰æ–¼å„²å­˜å±¤æ›´æ–°çš„æ™‚é–“ (ex2-3)ï¼Œå‰‡ä»£è¡¨æ›´æ–°å…ˆå‰çš„ ACL (ex2-1)éƒ½å·²ç¶“è¢«å¥—ç”¨ 2. Leopard Indexing å› ç‚ºæ¬Šé™åˆ¤å®šå¯èƒ½æ˜¯åµŒå¥—å¾ˆå¤šå±¤ (Group A åŒ…å« Group B åŒ…å« Group C \u0026hellip;.)ï¼Œé€™æ¨£åœ¨åˆ¤æ–·ä¸Šæœƒæœ‰éœ€è¦ traverse å¾ˆå¤šç¯€é» (åœ–å­¸å•é¡Œ)ï¼ŒZanzibar è¨­è¨ˆ Leopard Indexingï¼Œå°‡ group å±¤ç´šæ”¤å¹³ä¸¦å„²å­˜åœ¨ memory ä¸­ï¼Œé€™æ¨£é™ä½äº†æœå°‹çš„è¤‡é›œåº¦\n3. æŠŠè¼ƒæ…¢çš„è«‹æ±‚ç™¼çµ¦ä¸åŒçš„ server (Request Hedging) Zanzibar æœƒæœ‰ä¸€å€‹é–¥å€¼ï¼Œç•¶ç™¼ç¾è«‹æ±‚æ¯”è¼ƒæ…¢æ™‚ï¼Œæœƒç™¼é€çµ¦å…¶ä»–å›æ‡‰é€Ÿåº¦æ¯”è¼ƒå¿«çš„ serverï¼Œå„ªåŒ–ç‰¹åˆ¥æ…¢çš„è«‹æ±‚ (é€šå¸¸ä¹Ÿä»£è¡¨ç‰¹åˆ¥è¤‡é›œ)\nå…¶ä»–é‚„åŒ…å«ä¸€äº› Cache è¨­è¨ˆ / æ•´é«”æ¶æ§‹ / å°å¤–é–‹æ”¾ API ç­‰ï¼Œé€™é‚Šå°±å…ˆä¸è´…è¿°ï¼Œä¾†çœ‹ä¸€ä¸‹ç¬¬ä¸‰æ–¹æä¾›çš„ Zanzibar like é›²ç«¯æœå‹™ï¼Œéƒ¨è½æ ¼è·Ÿæ•™å­¸å¯«å¾—éƒ½å¾ˆå¥½\nauthzed-A managed permissions database for everyone auth0ï¼Œé‚„åœ¨ preview éšæ®µï¼Œä½†ä»–å€‘çš„æ•™å­¸ä¸éŒ¯ oso å››. é‡å° cloud native çš„ solution - Open Policy Agent ç•¶æˆ‘å€‘æŠŠç›®å…‰å¾æ‡‰ç”¨ç¨‹å¼ç§»é–‹ï¼Œæ•´å€‹ç³»çµ±æ¶æ§‹è™•è™•éƒ½éœ€è¦é©—è­‰çš„æœå‹™\næŸå€‹ç¶²åŸŸçš„æµé‡æ˜¯å¦å¯ä»¥é€²ä¾† / å‡ºå» æŸå°æ©Ÿå™¨é–‹ç™¼è€…æ˜¯ä¸æ˜¯å¯ä»¥ ssh DB æ˜¯ä¸æ˜¯å¯ä»¥è¢«ç¬¬ä¸‰æ–¹å» å•† access Open Policy Agent (ç°¡ç¨± OPA) é‡å° cloud native æ¶æ§‹è¨­è¨ˆé©—è­‰è¦å‰‡çš„è§£æ³•ï¼Œä¸­å¿ƒåŒ–ç®¡ç†é©—è­‰è¦å‰‡èˆ‡å…¶ä»–é‚è¼¯è§£è€¦ï¼Œæ•´å€‹æ¶æ§‹çµ±ä¸€ä¸€å¥—é©—è­‰è¦å‰‡èªè¨€ï¼Œæ”¯æ´ Kubernetes / Envoy / Terraform (æ±ºå®šç”¨æˆ¶æ˜¯å¦èƒ½ç”¨ tf èª¿æ•´æŸç¨®è³‡æº) / Kafka ç­‰ï¼Œä¹Ÿé–‹æ”¾ HTTP API æ‰€ä»¥æ‡‰ç”¨ç¨‹å¼å±¤ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¦å¤–ä¹Ÿæœ‰æä¾› Golang Libary èˆ‡ WASM å¯ä»¥æ•´åˆ\næµç¨‹å¤§æ¦‚æ˜¯ Client ç™¼å‡ºè«‹æ±‚ OPA agent æ ¹æ“šè«‹æ±‚æ‰¾åˆ°å°æ‡‰çš„ policy (ç”¨ rego èªè¨€æ’°å¯«)ï¼Œçµåˆ data åˆ¤æ–· client æ˜¯å¦æœ‰è¶³å¤ æ¬Šé™ å¯¦éš›çš„ policy åˆ¶å®šå¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package httpapi.authz # bob is alice\u0026#39;s manager, and betty is charlie\u0026#39;s. subordinates := {\u0026#34;alice\u0026#34;: [], \u0026#34;charlie\u0026#34;: [], \u0026#34;bob\u0026#34;: [\u0026#34;alice\u0026#34;], \u0026#34;betty\u0026#34;: [\u0026#34;charlie\u0026#34;]} default allow := false # Allow users to get their own salaries. allow { input.method == \u0026#34;GET\u0026#34; input.path == [\u0026#34;finance\u0026#34;, \u0026#34;salary\u0026#34;, input.user] } # Allow managers to get their subordinates\u0026#39; salaries. allow { some username input.method == \u0026#34;GET\u0026#34; input.path = [\u0026#34;finance\u0026#34;, \u0026#34;salary\u0026#34;, username] subordinates[input.user][_] == username } è«‹æ±‚é¡ä¼¼æ–¼\n1 2 3 4 5 6 7 8 9 10 11 input_dict = { # create input to hand to OPA \u0026#34;input\u0026#34;: { \u0026#34;user\u0026#34;: http_api_user, \u0026#34;path\u0026#34;: http_api_path_list, # Ex: [\u0026#34;finance\u0026#34;, \u0026#34;salary\u0026#34;, \u0026#34;alice\u0026#34;] \u0026#34;method\u0026#34;: request.method # HTTP verb, e.g. GET, POST, PUT, ... } } # ask OPA for a policy decision # (in reality OPA URL would be constructed from environment) rsp = requests.post(\u0026#34;http://127.0.0.1:8181/v1/data/httpapi/authz\u0026#34;, json=input_dict) if rsp.json()[\u0026#34;allow\u0026#34;]: data éƒ¨ä»½ä¸ä¸€å®šè¦å¯«æ­»ï¼Œè€Œæ˜¯å¯ä»¥å¾å¤–éƒ¨çš„ DB æ’ˆå–æˆ–æ˜¯æ“·å– request ä¸­çš„ jwt tokenï¼Œåƒè€ƒ External Dataï¼Œç®—æ˜¯è »æœ‰å½ˆæ€§çš„\nä»¥ä¸Šçš„æ©Ÿåˆ¶æ˜¯è½åˆ° Netflix çš„åˆ†äº« How Netflix Is Solving Authorization Across Their Cloud [I] - Manish Mehta \u0026amp; Torin Sandall, Netflix\nç¸½çµ é©—è­‰æ¯”æˆ‘æƒ³åƒä¸­çš„è¤‡é›œè¨±å¤šï¼ŒGoogle è¨­è¨ˆäº† Zanzibar / Netflix éƒ¨åˆ†æ¡ç”¨çš„ Open Policy Agent æ©Ÿåˆ¶ï¼Œå‰è€…é‡å°è² è²¬çš„å·¢ç‹€è¦å‰‡èˆ‡æ¥µå¤§è¦æ¨¡çš„é©—è­‰éœ€æ±‚ã€å¾Œè€…å‰‡é‡å° Cloud Native ç’°å¢ƒçµ±ä¸€äº†æ¶æ§‹å±¤çš„é©—è­‰è¦å‰‡\n","date":"2023-01-28T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-01-28-%E7%A0%94%E7%A9%B6%E5%BE%AE%E6%9C%8D%E5%8B%99%E4%B8%8B%E7%9A%84%E6%8E%88%E6%AC%8A%E8%A8%AD%E8%A8%88-google-zanzibar-%E8%88%87-open-policy-agent/","title":"ç ”ç©¶å¾®æœå‹™ä¸‹çš„æˆæ¬Šè¨­è¨ˆ - Google Zanzibar èˆ‡ Open Policy Agent"},{"content":"é©—è­‰ - ç¢ºèªä½¿ç”¨è€…èº«ä»½ã€æˆæ¬Š - å…è¨±æŸäººé‡å°æŸäº›è³‡æºæ“ä½œæŸäº›è¡Œç‚ºï¼Œå…©è€…åœ¨å°æ–¼è‡ªå»ºç¶²ç«™å¯èƒ½æ˜¯ç­‰åŒä¸€ä»¶äº‹ï¼Œç•¶æˆ‘è®“ user A ç™»å…¥é€šéé©—è­‰ï¼Œé‚£ä¹Ÿå°±ç­‰åŒæˆæ¬Š user A å¯ä»¥æ“ä½œä»–è‡ªå·±çš„è³‡æº\nä½†ä»Šå¤©å¦‚æœé©—è­‰çš„æœå‹™ã€ç®¡ç†è³‡æºçš„æœå‹™ã€ä»£æ›¿ç”¨æˆ¶æ“ä½œè³‡æºçš„ç¬¬ä¸‰æ–¹æœå‹™éƒ½æ˜¯ç¨ç«‹æ™‚ï¼Œé©—è­‰èˆ‡æˆæ¬Šå°±æœ‰å¾ˆå¤§çš„å€åˆ¥ï¼Œä»¥ä¸‹å…§å®¹èˆ‡æˆªåœ–åƒè€ƒè‡ª\nOAuth 2.0 and OpenID Connect (in plain English) ID Tokens vs Access Tokens - Do you know the difference?! é—œæ–¼ç™»å…¥èˆ‡ OAuth 2.0 æœ€é™½æ˜¥çš„ç™»å…¥æ©Ÿåˆ¶è«éæ–¼ client æä¾› account / password çµ¦ serverï¼Œserver é€²å»è³‡æ–™åº«æ¯”å°ï¼ŒæˆåŠŸå‰‡è¨­å®š cookie or session é€™æ¨£çš„æŠ€è¡“æœ‰å¹¾å€‹ç¼ºé»\nå®‰å…¨æ€§ï¼šå¦‚æœç”¨æˆ¶å¤šå€‹ç¶²ç«™éƒ½ç”¨ç›¸åŒçš„å¸³å¯†ï¼Œå‰‡ä¸€å€‹ç¶²ç«™è¢«æ”»ç ´å‰‡æ¯å€‹ç¶²ç«™éƒ½å¯èƒ½é­æ®ƒ ç¶­è­·æ€§ï¼šæ¯å€‹ç¶²ç«™éƒ½éœ€è¦ç¶­è­·ç”¨æˆ¶çš„è³‡æ–™ ç¬¬äºŒå€‹å•é¡Œæ˜¯å¦‚æœæŸæœå‹™å¸Œæœ›ä»£æ›¿ç”¨æˆ¶æ“ä½œå¦ä¸€å€‹æœå‹™ (Delegated authorization)ï¼Œå¦‚æœé€éå¸³å¯†éå¸¸å±éšªï¼Œä¹Ÿæ²’æœ‰æ¬Šé™çš„é™åˆ¶ï¼Œä¾‹å¦‚ Yelp æ›¾ç¶“è·Ÿç”¨æˆ¶è¦å¸³å¯†å»ç™»å…¥ Email OAuth 2.0 ä¹Ÿå°±æ˜¯åœ¨é€™æ¨£çš„æ™‚ç©ºèƒŒæ™¯èª•ç”Ÿ\nOAuth 2.0 ç°¡å–®ä»‹ç´¹ Authorization server èˆ‡ Resource server æœ‰ä¸€å¥—é©—è­‰èˆ‡æˆæ¬Šç¯„åœç®¡ç†çš„æ©Ÿåˆ¶ï¼ŒClient app å–å¾— Resource Owner (user æœ¬äºº) çš„æˆæ¬Šå¾Œï¼Œå°±å¯ç”¨ Access token ä»£ç‚ºå‘ Resource server ç™¼èµ·æ“ä½œ\nä¸»è¦æœ‰å››ç¨®æµç¨‹\nAuthorization Code flow implicit flow account / password flow client credential flow ä»¥ä¸‹åƒ…ä»‹ç´¹ç¬¬ä¸€ç¨®\nAuthorization Code flow åŸºæœ¬æµç¨‹ç‚º\nUser é€é Client App æŒ‡å®šè¦é€éç¬¬ä¸‰æ–¹ç™»å…¥ ç¬¬ä¸‰æ–¹ Auth Server é¡¯ç¤ºæˆæ¬Šé é¢ User åŒæ„æˆæ¬Šå¾Œï¼ŒAuth Server å¤¾å¸¶ code è½‰å°åˆ° Client App Client App é€é code + client å°ˆå±¬è³‡è¨Šå‘ Auth Server æ› access token Client App æ‹¿åˆ° access tokenï¼Œå°±å¯ä»¥å‘ Resource Server ç™¼èµ·æ“ä½œ ç‰¹åˆ¥æ³¨æ„åˆ° channel çš„æ¦‚å¿µï¼Œé€™é‚Šåˆ†æˆ\nfront channel back channel front channel æŒ‡çš„æ˜¯åœ¨å‰ç«¯ï¼Œå› ç‚ºé€™éƒ¨åˆ†çš„æµç¨‹æš´éœ²åœ¨å®¢æˆ¶ç«¯ï¼Œå®‰å…¨æ€§ç›¸å°è¼ƒä½ï¼Œä¾‹å¦‚ç€è¦½å™¨æ’ä»¶çš„å´éŒ„ç­‰ï¼› back channel æŒ‡çš„æ˜¯å¾Œç«¯ï¼Œå› ç‚º server æ˜¯åœ¨æˆ‘å€‘æŒæ§æ‰€ä»¥å®‰å…¨æ€§ç›¸å°é«˜\næ‰€ä»¥ä»»ä½•æ±è¥¿å¾ front channel è½‰åˆ° back channel éƒ½éœ€è¦å†æ¬¡é©—è­‰ï¼Œä¾‹å¦‚ front å›å‚³ codeï¼Œæ­¤æ™‚ code å¿…é ˆåœ¨ back channel è·Ÿ Authorization server æ› access token\nå¦‚æœ front channel ç›´æ¥å›å‚³ access tokenï¼Œå‰‡æœ‰å¯èƒ½è¢«æ›¿æ›çš„é¢¨éšª\nOAuth 2.0 èˆ‡ OpenID Connect åœ¨ä¸€é–‹å§‹æˆ‘å€‘éƒ½æœƒç”¨ OAuth 2.0 é©—è­‰èˆ‡æˆæ¬Šä¸€ä¸¦è™•ç†ï¼Œä¾‹å¦‚ Google OAuth 2.0 å¯ä»¥æŒ‡å®š Scope https://www.googleapis.com/auth/userinfo.profile\tï¼Œä½†éš¨è‘—é©—è­‰çš„éœ€æ±‚è¶Šä¾†è¶Šæ˜ç¢ºï¼ŒåŒ…å«æ‰‹æ©Ÿé©—è­‰ç™»å…¥ç­‰ï¼Œæ‰€ä»¥å°±åˆåŸºæ–¼ OAuth 2.0 æ“´å±•æ¨å‡ºäº† OpenID Connect\nOpenID Connect User é€é Client App æŒ‡å®šè¦é€éç¬¬ä¸‰æ–¹ç™»å…¥ ç¬¬ä¸‰æ–¹ Auth Server é¡¯ç¤ºæˆæ¬Šé é¢ User åŒæ„æˆæ¬Šå¾Œï¼ŒAuth Server å¤¾å¸¶ id token å›åˆ° Client App Client App é©—è­‰ id token å¾Œå°±å¯ä»¥æ‹¿åˆ°ç”¨æˆ¶åŸºæœ¬è³‡æ–™ å¦‚æœ‰é¡å¤–éœ€è¦ï¼ŒClient App å¯ä»¥ç”¨ id token å‘¼å« Auth Server API (/userinfo å¦‚ Google https://openidconnect.googleapis.com/v1/userinfoã€ Line https://api.line.me/oauth2/v2.1/userinfo) æ‹¿é¡å¤–çš„ç”¨æˆ¶è³‡è¨Š ä¹çœ‹ä¹‹ä¸‹ OpenID Connect è·Ÿ OAuth 2.0 æµç¨‹å¾ˆåƒï¼Œä½†æœ‰å€‹æœ€å·¨å¤§çš„å·®ç•°\nOpenID Connect æ‹¿åˆ°çš„ id token å¯ä»¥ç›´æ¥è§£æä¸¦è®€å–ç”¨æˆ¶è³‡è¨Šï¼› è€Œ OAuth 2.0 æ‹¿åˆ°çš„ access token ä¸¦ä¸æ˜¯ Client App è¦è§£è®€ï¼Œè€Œæ˜¯å–®ç´”é€çµ¦ Resource Server é©—è­‰\næ‰€ä»¥å¾é©—è­‰è§’åº¦ï¼ŒServer é€é OpenID Connect å¯ä»¥ç›´æ¥è§£æ id tokenï¼Œè€Œä¸ç”¨å¤šæ‰“ä¸€æ¬¡ Api å»è¦ç”¨æˆ¶çš„è³‡æ–™\næ‰€ä»¥ OpenID Connect æœ‰æ˜æ–‡è¦å®š token å¿…é ˆæ˜¯ jwt æ ¼å¼ï¼ŒClient App æ”¶åˆ°å¾Œè¦æ‹¿ Auth Server public key æª¢æŸ¥æ ¸ç™¼å–®ä½æ˜¯å¦æ­£ç¢º (æ•¸ä½ç°½ç« çš„æ¦‚å¿µ)\nè€Œ OAuth 2.0 ç”¨çš„ access token ä¸ä¸€å®šè¦æ˜¯ jwtï¼Œä»»æ„çš„ string éƒ½å¯ä»¥ï¼Œåªè¦ Auth Server è·Ÿ Resource Server èªå¾—å°±å¥½\nç‚ºä»€éº¼ä¸æ‹¿ id token ç•¶ä½œ access token OAuth 2.0 æœ‰è¦ç¯„ sender contraintï¼Œé™å®š client å¯ä»¥ç™¼é€ access tokenï¼Œå¦‚æœæœ‰å¯¦ä½œé‚£å³ä½¿ token è¢« hacker å·èµ°ä¹Ÿæ²’é—œä¿‚ï¼Œå› ç‚ºç™¼é€åˆ° Resource server æœƒè¢«æ“‹ä¸‹ä¾† Access Token æœ‰æ›´å¤šçš„æª¢æŸ¥ï¼ŒåŒ…å« scope (ID token æ²’æœ‰) / Aud / token format validation ç‚ºä»€éº¼ä¸æ‹¿ access token ç•¶ä½œ id token access token ä¸æ˜¯è¦çµ¦ client è§£æï¼Œè€Œæ˜¯çµ¦ resource serverï¼Œclient æœ€å¥½æŠŠ access token ç•¶ä½œä»»æ„å­—ä¸² ä¸¦æ²’æœ‰çµ±ä¸€æ¨™æº–å–å¾—ç”¨æˆ¶è³‡è¨Š ä½¿ç”¨ JWT çš„ä¸€äº›è³‡å®‰è€ƒé‡ å› ç‚º Token æ˜¯æ¡ç”¨ JWTï¼Œåœ¨æ ¸ç™¼èˆ‡é©—è­‰ä¸Šè¦ç‰¹åˆ¥æ³¨æ„ï¼Œå¦å‰‡æœƒæœ‰è³‡å®‰ä¸Šçš„æ¼æ´\n1. å‹™å¿…æª¢æŸ¥ iss / aud / exp ç­‰åŸºæœ¬è¨Šæ¯ RFC 7591 ä¸­çš„ payload ä¿ç•™å­—æ®µé€šå¸¸éƒ½æ˜¯éœ€è¦é©—è­‰çš„ï¼ŒåŒ…å«\niss (issuer)ï¼šèª°æ ¸ç™¼çš„ token aud (audience)ï¼šèª°æ‡‰è©²æ”¶åˆ°æ­¤ token sub (subject)ï¼štoken æ ¸ç™¼çš„ç›®çš„ exp (expiration)ï¼štoken ä½•æ™‚éæœŸ nbf (Not Before)ï¼štoken ä½•æ™‚é–‹å§‹ç”Ÿæ•ˆ iat (issued at)ï¼štoken æ ¸ç™¼çš„æ™‚é–“ jti (JWT id)ï¼šjwt IDï¼Œåªæœ‰åœ¨å¯èƒ½ç™¼ç”Ÿç¢°æ’æ‰éœ€è¦ 2. å‹™å¿…ç§»é™¤ alg: none æ”¯æ´ JWT çš„åˆæ³•æ€§éœ€è¦é€é signature å»é©—è­‰ï¼Œè€Œ Hacker å¯èƒ½æŒ‡å®š alg: \u0026ldquo;none\u0026rdquo; è·³éé©—è­‰ï¼Œå¦‚æœå¯¦ä½œæ²’å¯«å¥½å°±æœƒçœŸçš„è¢«è·³éï¼› çœ‹äº†ä¸€ä¸‹ Ruby å¯¦ä½œæ²’æœ‰é€™å€‹å•é¡Œï¼Œæœƒå»æª¢æŸ¥ alg æœ‰æ²’æœ‰åœ¨æŒ‡å®šçš„ç¯„åœå…§\n1 2 3 def valid_alg_in_header? allowed_algorithms.any? { |alg| alg.valid_alg?(alg_in_header) } end 3. å°å¿ƒ alg è¢«èª¿æ•´ åŒæ¨£æ˜¯ alg è¢«èª¿æ•´ï¼Œå¦‚æœå¾éå°ç¨±åŠ å¯†è¢«æ”¹æˆå°ç¨±åŠ å¯†ï¼Œå¯¦ä½œä¸æ°ç•¶å¯èƒ½å°±æœƒè¢«ç¹éï¼Œè¨˜å¾—è¦åˆ†æ¸…æ¥šéå°ç¨±åŠ å¯†çš„ key èˆ‡å°ç¨±åŠ å¯†çš„ key\nSingle Sign On (SSO) èˆ‡ OAuth 2.0 / OpenID Connect é—œä¿‚ æˆ‘å€‘å¸¸æœƒçœ‹åˆ° SSO èˆ‡ OAuth 2.0 / OIDC å‡ºç¾ï¼ŒSSO ä¸»è¦æ˜¯æè¿°ä¸€ç¨®æ¦‚å¿µï¼Œç”¨æˆ¶åªéœ€è¦ä¸€çµ„å¸³å¯†ç™»å…¥é©—è­‰æ©Ÿæ§‹ï¼Œå¤šå€‹æœå‹™éƒ½ç”¨æ­¤é©—è­‰æ©Ÿæ§‹é©—æ˜èº«ä»½\nauthentication method that enables users to securely authenticate with multiple applications and websites by using just one set of credentials.\næ‰€ä»¥ OAuth 2.0 / OpenID Connect éƒ½æ˜¯ SSO çš„ä¸€ç¨®å¯¦ä½œï¼Œå…¶ä»–å¸¸è¦‹åšæ³•åŒ…å« SAML / LDAP ç­‰\nåƒè€ƒè‡ª How Does Single Sign-On Work?\n","date":"2023-01-20T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2023/2023-01-20-%E9%A9%97%E8%AD%89%E8%88%87%E6%8E%88%E6%AC%8A%E7%9A%84%E5%B7%AE%E5%88%A5%E6%B7%BA%E8%AB%87-oauth-2.0-%E8%88%87-openid-connect/","title":"é©—è­‰èˆ‡æˆæ¬Šçš„å·®åˆ¥ï¼Œæ·ºè«‡ OAuth 2.0 èˆ‡ OpenID Connect"},{"content":"æœ€è¿‘å·¥ä½œé‡å¿ƒè½‰å¾€ Golang èˆ‡ gRPC server é–‹ç™¼ï¼Œæœ€è®“æˆ‘æ„Ÿåˆ°ç¥å¥‡çš„æ˜¯é€é proto å®£å‘Šä¸­çš„ optionsï¼Œæ­é…ä¸åŒçš„ protobuf plugin å¯ä»¥ gen å‡ºå°æ‡‰çš„æª”æ¡ˆï¼ŒåŒ…å« OpenAPI Doc / ä¸åŒç¨‹å¼ç¢¼èªè¨€å¯¦ä½œçš„ gRPC server / JSON æª”ï¼Œä¸ç¦è®“æˆ‘å¥½å¥‡é€™äº›ç¥ç§˜çš„ Protobuf options èˆ‡èƒŒå¾Œç”¢ç”Ÿæª”æ¡ˆçš„ Protobuf plugin åˆ°åº•æ˜¯æ€éº¼é‹ä½œ ?!\nä»¥ä¸‹æ–‡ç« å°‡æœƒé€éä¸€å€‹ç°¡å–®æ¡ˆä¾‹ - protoc-gen-http-client åˆ©ç”¨ proto ç”¢ç”Ÿå°æ‡‰ Golang http client request çš„ç¨‹å¼ç¢¼ï¼Œæœƒæ¶µè“‹\nprotobuf èˆ‡ plugin çš„äº’å‹•æ©Ÿåˆ¶ å¦‚ä½•å¾ command è®€å–åˆ° plugin è¨­å®š å¦‚ä½•è¨­è¨ˆ protobuf extension ä»¥ä¸‹å…§å®¹ä¸»è¦åƒè€ƒè‡ª\nCreating a protoc plugin to generate Go code with protogen 1. Protobuf èˆ‡ plugin çš„äº’å‹•æ©Ÿåˆ¶ prerequisite é¦–å…ˆæˆ‘å€‘è¦å®‰è£ protoc ä»¥åŠ protoc-gen-go\nå®‰è£ protoc https://grpc.io/docs/protoc-installation/ å®‰è£ protoc-gen-go æ–¹ä¾¿é–‹ç™¼ plugin https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen#GeneratedFile $ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28 å‰è€…æ˜¯ protobuf çš„ compilerï¼Œå¾Œè€…æ˜¯ protobuf golang plugin è² è²¬å¾ protobuf ç”¢å‡ºå°æ‡‰çš„ golang code\nç¢ºä¿ terminal å¯ä»¥åŸ·è¡Œ $ protoc / $ protoc-gen-go\näº’å‹•æ©Ÿåˆ¶ ä¸€èˆ¬æˆ‘å€‘åœ¨ä½¿ç”¨ protoc ç”¢ç”Ÿæª”æ¡ˆæŒ‡ä»¤æ˜¯\n$ protoc \u0026ndash;go_out=paths=source_relative:. \u0026ndash;proto_path=. example/proto/*.proto\næŒ‡å®š protoc å»è¼‰å…¥å‘¼å«å°æ‡‰çš„ plugin ï¼Œplugin å¿…é ˆæ˜¯\nshell å¯ä»¥åŸ·è¡Œçš„ binary file å‘½åæ ¼å¼å›ºå®šæ˜¯ proto-gen-${plugin name} protoc æŒ‡ä»¤æœ‰å¹¾å€‹åƒæ•¸\n${plugin name}_out è§£æè¦åŸ·è¡Œçš„ pluginï¼Œå¦‚é€é --go_out æŒ‡å®šäº† proto-gen-go çš„åŸ·è¡Œï¼Œä¸¦æŒ‡å®šè¼¸å‡ºçš„è³‡æ–™å¤¾ä½ç½® ${plugin name}_opt plugin åƒæ•¸ --proto-path= æŒ‡å®š input proto çš„è³‡æ–™å¤¾ä½ç½® å¦‚æœ plugin name æœ‰å¤šå€‹å­—æ¯ï¼Œå¯ä»¥ç”¨ - åˆ†éš”å¦‚ protoc-gen-grpc-gateway å¦‚æ­¤å‘½å\nå»ºç«‹å°ˆæ¡ˆ protoc-gen-http-client åƒè€ƒç¨‹å¼ç¢¼ï¼šphase1\nç¬¬ä¸€æ­¥ï¼Œç”¢ç”Ÿ protoc plugin ä¸¦æˆåŠŸç”¢ç”Ÿç©ºæ®¼æª”æ¡ˆï¼Œåƒè€ƒç›®éŒ„\n1 2 3 4 5 6 7 8 protoc-gen-go-http-client â”œâ”€â”€ main.go // plugin code â”œâ”€â”€ example // ç¯„ä¾‹ proto â”‚ â””â”€â”€ proto â”‚ â”œâ”€â”€ test.proto â”‚ â”œâ”€â”€ test.pb.go // protoc-gen-go ç”¢ç”Ÿçš„ â”‚ â””â”€â”€ test_http.go // è‡ªè£½ plugin ç”¢ç”Ÿçš„ â””â”€â”€ go.mod // è¨˜å¾— module å‘½åå¿…é ˆæ˜¯ protoc-gen-xxxx åœ¨é–‹ç™¼ä¸Šæˆ‘å€‘ä¸»è¦é€é golang programï¼Œä¸¦æ¡ç”¨ protobuf golang package å”åŠ©é–‹ç™¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package main import \u0026#34;google.golang.org/protobuf/compiler/protogen\u0026#34; func main() { protogen.Options{}.Run(func(gen *protogen.Plugin) error { for _, f := range gen.Files { if !f.Generate { continue } generateFile(gen, f) } return nil }) } // generateFile generates a _http.pb.go file containing gRPC service definitions. func generateFile(gen *protogen.Plugin, file *protogen.File) { filename := file.GeneratedFilenamePrefix + \u0026#34;_http.pb.go\u0026#34; g := gen.NewGeneratedFile(filename, file.GoImportPath) g.P(\u0026#34;// Code generated by protoc-gen-go-http-client. DO NOT EDIT.\u0026#34;) g.P() g.P(\u0026#34;package \u0026#34;, file.GoPackageName) g.P() g.P(\u0026#34;func main() {\u0026#34;) for _, srv := range file.Services { for _, method := range srv.Methods { if method.GoName == \u0026#34;Get\u0026#34; { g.P(\u0026#34;// it\u0026#39;s get\u0026#34;) } } } g.P() g.P(\u0026#34;}\u0026#34;) } ç°¡å–®å¸¶éç¨‹å¼ç¢¼\nL7 æœƒæ‹¿åˆ°è¼¸å…¥çš„ proto fileï¼Œæˆ‘å€‘å¯ä»¥ä¸€å€‹ä¸€å€‹æª”æ¡ˆè™•ç† L19~L20 æ˜¯ç”¢ç”Ÿè¼¸å…¥æª”æ¡ˆ L27,28 æ˜¯é‡å° proto è£¡é¢çš„ service / message è¼ªè©¢ é€é g.P() æˆ–æ˜¯ stdout fmt.Println éƒ½æœƒæŠŠ string å…§å®¹å¯«å…¥è¼¸å‡ºçš„æª”æ¡ˆä¸­ å®‰è£ä¸¦æ¸¬è©¦ é–‹ç™¼å¾Œå¯ä»¥ç›´æ¥åœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹å®‰è£\n$ go install\næ­¤æ™‚å°æ‡‰åœ¨ $GOBIN æ‡‰è©²æœƒæœ‰å°æ‡‰çš„ binary fileï¼Œå¦‚æœ shell $PATH æœ‰æ­£ç¢ºæŒ‡å®šé‚£ $ protoc-gen-http-client å¯ä»¥æ­£ç¢ºåŸ·è¡Œ\næ­¤æ™‚ protoc å°±å¯ä»¥è¼‰å…¥ http-client çš„ pluginï¼Œçœ‹åˆ° .go file ç”¢ç”Ÿ\n$ protoc \u0026ndash;go-http-client_out=. \u0026ndash;go-http-client_opt=\u0026ldquo;paths=source_relative\u0026rdquo; \u0026ndash;go_out=. \u0026ndash;go_opt=paths=source_relative example/proto/*.proto\n2. å¦‚ä½•å¾ command è®€å–åˆ° plugin è¨­å®š åƒè€ƒç¨‹å¼ç¢¼ï¼šphase2\nè®“æˆ‘å€‘åœ¨åŸ·è¡Œ protoc æŒ‡ä»¤æ™‚ï¼Œé †ä¾¿å¸¶ä¸ŠæŒ‡å®šåƒæ•¸ä¾†è¨­å®š http client request çš„ url base-url\nä¸»è¦ç¨‹å¼ç¢¼æ”¹å‹•é€é flag å–å¾—åƒæ•¸\n1 2 3 4 5 var flags flag.FlagSet baseUrl := flags.String(\u0026#34;base_url\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;flags from command\u0026#34;) opts := \u0026amp;protogen.Options{ ParamFunc: flags.Set, } $ protoc \u0026ndash;go-http-client_out=. \u0026ndash;go-http-client_opt=paths=source_relative,base_url=api.com example/*.proto\nåœ¨ protoc-gen-go ä¸­ï¼Œå¯ä»¥æŒ‡å®š paths åƒæ•¸ï¼ŒæŒ‡å®šè¼¸å‡ºçš„è³‡æ–™å¤¾ä½ç½® (èˆ‡ go_out ä¸€èµ·å½±éŸ¿)ï¼Œåƒè€ƒ Compiler Invocation\n3. å¦‚ä½•è¨­è¨ˆ Protobuf extension åƒè€ƒç¨‹å¼ç¢¼ï¼šphase3\næ¥è‘—æˆ‘å€‘è¦ä¾†å¢åŠ  plugin çš„ Protobuf extensionï¼Œåœ¨ proto file ä¸­æŒ‡å®š options è®“ plugin ç”¢ç”Ÿå°æ‡‰è¡Œç‚º\næˆ‘å€‘ä¸»è¦åœ¨\nservice ä¸­å¢åŠ  method / path çš„æŒ‡å®š message ä¸­å¢åŠ  field default value æŒ‡å®š 3-1 å¢åŠ  proto extension é¦–å…ˆè¦é‡å° protobuf ä¸åŒçš„çµæ§‹å» extendï¼Œå¾ä¸Šåˆ°ä¸‹æœ‰ file \u0026gt; service / message \u0026gt; method/field\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // options.proto // package name è¦æŒ‡å‘ proto æ‰€åœ¨ä½ç½®ï¼Œè€Œä¸æ˜¯ golang å°ˆæ¡ˆç›®éŒ„ option go_package=\u0026#34;github.com/sj82516/protoc-gen-go-http-client/protos\u0026#34;; message HttpClientMethodOptions { string method = 1; string path = 2; } // extend google.protobuf.MethodOptions { HttpClientMethodOptions method_opts = 2050; } // extend google.protobuf.FileOptions { HttpClientFileOptions file_opts = 2048; } æ¥è‘—åœ¨ example ä¸­å°±å¯ä»¥ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // test.proto import \u0026#34;example/http-client/options.proto\u0026#34;; message User { int64 id = 1[(field_opts).default=\u0026#34;1\u0026#34;]; } service HelloService { rpc GetUser(Hello) returns (User) { option (method_opts).method=\u0026#34;get\u0026#34;; option (method_opts).path=\u0026#34;/user\u0026#34;; }; } é€™é‚Šæœ‰å¹¾é»æ¯”è¼ƒ tricky\nprotobuf import è·Ÿ golang package åˆ†é–‹ï¼Œè½èµ·ä¾†å¾ˆç›´è¦ºä½†æˆ‘ä¸€é–‹å§‹ææ··äº†æ‰€ä»¥å¡å¾ˆä¹…ï¼Œå°¤å…¶æ˜¯è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ protobuf extension è¦æ‰‹å‹•ä¸‹è¼‰ proto file åˆ°è‡ªå·±çš„è³‡æ–™å¤¾ä¸­ï¼Œåƒè€ƒ gRPC gatewate æ–‡ä»¶ï¼šwe need to copy some dependencies into our proto file structure. å¦‚æœæœ‰ç”¨ä¸Š protoc-go-gen å‰‡å°æ‡‰çš„ proto extension åŒè·¯å¾‘è¦æœ‰ compiled .pb.go æª”æ¡ˆå¦å‰‡æœƒå‡ºéŒ¯ è³‡æ–™å¤¾çµæ§‹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 protoc-gen-go-http-client â”œâ”€â”€ example â”‚ â”œâ”€â”€ http-client // ä»»ä½•ç¬¬ä¸‰æ–¹çš„ proto extension éƒ½éœ€è¦è‡ªå·±è¤‡è£½ â”‚ â”‚ â””â”€â”€ options.proto â”‚ â””â”€â”€ proto â”‚ â”œâ”€â”€ test.proto â”‚ â””â”€â”€ test.pb.go â””â”€â”€ protos â”œâ”€â”€ options.proto â””â”€â”€ options.pb.go // éœ€è¦ compiled å‡º .pb.goï¼Œå¦å‰‡ åªæ˜¯å‰›å¥½æˆ‘çš„ protobuf plugin è·Ÿ example æ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾ä¸‹ï¼Œä½†å¦‚æœå…©è€…æ˜¯åˆ†é–‹çš„å°ˆæ¡ˆä¹Ÿè¦æŒ‰ç…§ç›¸åŒçš„æ–¹å¼\nå¯ä»¥åƒè€ƒ protoc-gen-openapiv2\n3-2 èª¿æ•´ plugin è®€å– options 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // parse option options := method.Desc.Options().(*descriptorpb.MethodOptions) if options == nil { } v := proto.GetExtension(options, customProto.E_MethodOpts) if v == nil { } // wrap as client opts, _ := v.(*customProto.HttpClientMethodOptions) if opts.Method == \u0026#34;get\u0026#34; { g.P(fmt.Sprintf(\u0026#34;func %s() {\u0026#34;, method.GoName)) g.P(fmt.Sprintf(\u0026#34;res, err := http.Get(\\\u0026#34;https://%s%s\\\u0026#34;)\\n\u0026#34;, *baseURL, opts.Path)) g.P(fmt.Sprintf(\u0026#34;target := %s{}\u0026#34;, method.Output.Desc.Name())) ... } æˆªå–éƒ¨åˆ†ç¨‹å¼ç¢¼ï¼Œä¸»è¦æ˜¯é€é protogen package å°±å¯ä»¥å–å¾—å€‹åˆ¥ proto çµæ§‹ä¸­çš„ options\nç¸½çµ é€é protoc plugin è®“ proto file å¯ä»¥èº«å…¼å¤šè·ï¼Œç•¶ä½œæ•´å€‹å°ˆæ¡ˆçš„æ ¸å¿ƒå®šç¾©æª”ï¼Œå¦‚æ¶èµ· gRPC server åŒæ™‚èƒ½é †ä¾¿ç”¢å‡ºå°æ‡‰çš„ api docï¼Œé€éè‡ªå·±æ’°å¯«å€‹å° demo æ›´ç†è§£å…¶ä¸­çš„åŸç†é‚„è »æœ‰è¶£çš„\n","date":"2022-11-26T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-11-26-%E9%96%8B%E7%99%BC%E7%B0%A1%E6%98%93%E7%9A%84-protobuf-plugin/","title":"é–‹ç™¼ç°¡æ˜“çš„ Protobuf plugin"},{"content":"åœ¨ä¸€æœˆåˆæ™‚ä¸Š Teddy çš„ DDD èª²ç¨‹æ™‚ï¼Œç¬¬ä¸€æ¬¡è¦‹è­˜åˆ° DDD çµåˆ Clean Architectureï¼Œå¯ä»¥å°‡è¨­è¨ˆè·Ÿå¯¦ä½œå®Œç¾çš„çµåˆï¼Œæ‰“é€ å‡ºå½ˆæ€§ã€æ˜“æ‡‚ã€å¥½ç¶­è­·çš„ç¨‹å¼ç¢¼ï¼Œå°±ä¸€ç›´å° Clean Architecture å¾ˆæ„Ÿèˆˆè¶£ (èª²ç¨‹ ezKanban åŸå§‹ç¢¼)ï¼›\nå¾Œä¾†åœ¨ 2022 Coscup ä¸Šè½åˆ°å¼·è€… Jalex åˆ†äº« Clean Architecture in Go: The Crescendo Way æä¾›äº†å¦ä¸€ç¨®å¯¦ä½œçš„æ–¹å¼ï¼›\næœ€å¾Œåœ¨çœ‹ã€Clean Architecture å¯¦ä½œç¯‡ã€‘æ™‚ï¼Œä½œè€…åˆæä¾›å¦ä¸€ç¨®æ–¹å¼ä»¥å…­è§’æ¶æ§‹ç‚ºåŸºåº•çš„å¯¦ä½œ\nåœ¨çœ‹äº†é€™å¹¾ç¨®ä¸åŒå¯¦ä½œçš„è§’åº¦å¾Œï¼Œæ•´ç†ä¸€ä¸‹å¯¦ä½œ Clean Architecture ä¸­ä¸åŒå±¤è½‰æ›çš„å–æ¨\nClean Architecture çš„è§£è®€ ã€Clean Architectureã€‘ä¸€æ›¸è«‡äº†éå¸¸å¤šçš„è§€å¿µï¼Œæ•´ç†å¾Œè‡ªå·±çš„è§£è®€æ˜¯ æ¶æ§‹æ˜¯ç‚ºäº†é™ä½å¾ŒçºŒçš„é–‹ç™¼ã€ç¶­é‹æˆæœ¬ä¸¦æœ€å¤§åŒ–å·¥ç¨‹å¸«çš„ç”¢èƒ½ï¼Œè€Œåœ¨é€™æ¨£çš„åŸå‰‡ä¸‹æå‡ºäº†ä»¥ä¸‹çš„ä¾è³´åŸå‰‡\né›¢ IO è¶Šé çš„å…ƒä»¶è¶Šæ˜¯æ ¸å¿ƒï¼Œè€Œæ ¸å¿ƒä¸æ‡‰è©²å› ç‚ºå¤–å±¤çš„æ”¹è®Šè€Œå—åˆ°å½±éŸ¿ï¼Œå°±å¥½æ¯”èªªç”¨æˆ¶ä¸æœƒåœ¨æ„è³‡æ–™åº«æ˜¯ç”¨ MySQL é‚„æ˜¯ MongoDB (IO)ï¼Œä»–åªæœƒåœ¨æ„ä»–è³¼è²·çš„å“é …èˆ‡æŠ˜æ‰£å°ä¸å° (æ¥­å‹™è¦å‰‡) ä¾è³´çš„ç‰©ä»¶ä¸å¯ä»¥è·¨å±¤ï¼Œæ‰€ä»¥ Adapter ä¸èƒ½ç›´æ¥å­˜å– Entity æ‰€ä»¥å¾å…§è€Œå¤–ï¼Œå¯ä»¥åˆ†æˆ Entity (Domain Object) / Use Case / Adapter (Controller, Gateway, Repository - å¸¸æŒ‡ DB å„²å­˜å±¤) ç­‰\nå…­è§’æ¶æ§‹ ç”± Alistair Cockburn æå‡ºçš„å…­è§’æ¶æ§‹ï¼Œå‰›å¥½èˆ‡ Clean Architecture è§€é»å‘¼æ‡‰ï¼Œå¤–éƒ¨ IO (Adapter) å¦‚æœè¦èˆ‡å…§å±¤ (Entity / Use Case) äº’å‹•å¿…é ˆé€šé Portï¼Œé€™äº› Port æœƒé€éä¾è³´åè½‰ç•¶ä½œéš”é›¢å±¤ï¼Œé¿å…å…§å±¤è¢«å¤–å±¤çš„è®Šå‹•è€Œæ”¹è®Š\nPort æ–¹å‘ä¾ç…§æ ¸å¿ƒçš„å°æ‡‰æœ‰å…©ç¨®\nIn å¾å¤–å±¤å‘¼å«æ ¸å¿ƒ Out æ ¸å¿ƒå‘¼å«å¤–å±¤ (é€é interface) è·¨å±¤çš„æºé€šåŸå‰‡ åœ¨ã€Clean Architectureã€‘ä¸€æ›¸ä¸­ï¼Œæåˆ°å¦‚æœè·¨å±¤çš„è©±å…§å±¤çš„ç‰©ä»¶æ˜¯ä¸å¯ä»¥ç›´æ¥è¢«è¼¸å‡ºåˆ°æ›´å¤–å±¤ï¼Œä¾‹å¦‚ Entity åªèƒ½åœ¨ Use Case ä½¿ç”¨ï¼Œå¦‚æœè¦å‚³åˆ° Controller , Gatewayï¼Œå¿…é ˆå†è½‰ä¸€å±¤ DTO (data to object)ï¼Œåä¹‹å¾å¤–å±¤å¾€å…§å‚³ä¹Ÿæ˜¯ï¼Œé€™æ˜¯ç‚ºäº†ç¬¦åˆ SRP å–®ä¸€è·è²¬\nä¾‹å¦‚ä¸€èˆ¬çš„ web requestï¼Œæœƒå¾ Controller å–å¾—åƒæ•¸ -\u0026gt; Use Case + Entity è™•ç†æ¥­å‹™é‚è¼¯ -\u0026gt; Controller å›å‚³çµæœï¼Œæ­¤æ™‚å¦‚æœ Controller åœ¨é¡¯ç¤ºçµæœç›´æ¥ä¾è³´æ–¼ Entityï¼Œé‚£ Entity å°±æœƒå¯èƒ½å› ç‚º API è¦å¤šå›å‚³æŸå€‹æ¬„ä½è€Œå—åˆ°æ”¹å‹•ï¼Œé•åæœ€ä¸€é–‹å§‹çš„åŸå‰‡\nä½†æ˜¯å¦‚æœæ¯ä¸€å±¤ä¹‹é–“éƒ½éœ€è¦ DTO è½‰æ›ï¼Œé‚£ç¨‹å¼ç¢¼æœƒå¾ˆå¤šé‡è¤‡å®£å‘Šï¼Œå› ç‚ºæˆ‘å€‘é€éé‡è¤‡å–ä»£è€¦åˆï¼Œåœ¨ã€Clean Architecture å¯¦ä½œç¯‡ã€‘æœ‰æ•´ç†å¹¾ç¨®æ–¹å¼ï¼Œä¾›å¤§å®¶å–æ¨\n1. No Mapping è·¨å±¤ä¸è½‰æ› å…ˆçœ‹è·¨å±¤å®Œå…¨ä¸è½‰æ›çš„æ–¹å¼ï¼Œåƒè€ƒæˆ‘ç”¨ golang å¯¦ä½œçš„ç‰ˆæœ¬ github/no-mappingï¼Œé€™é‚Šæˆ‘çš„ Entity å®£å‘Šæ··é›œäº† Controller çš„ json tag èˆ‡ ORM çš„ tag\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // Entity type Order struct { gorm.Model ID int `json:\u0026#34;id\u0026#34; gorm:\u0026#34;autoincrement\u0026#34;` Price int `json:\u0026#34;price\u0026#34;` Count int `json:\u0026#34;count\u0026#34;` Total float64 CreatedAt time.Time } // Use Case func (s CreateOrderService) Action(o *domain.Order) *domain.Order { withTax := 1.1 o.Total = float64(o.Count*o.Price) * withTax o.CreatedAt = now() s.saveOrder.SaveOrder(o) return o } åœ¨å¾ŒçºŒçš„ Controller / Gateway ä¸­ï¼Œå°±ç›´æ¥ä½¿ç”¨ Entity\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Repo å„²å­˜è³‡æ–™ func (r OrderRepository) SaveOrder(o *domain.Order) { result := r.db.Create(\u0026amp;o) fmt.Println(result.Error) } // Controller ç›´æ¥ç”¨ Entity å–å¾— API request å…§å®¹ // ä¸¦å‚³å…¥ UseCase ä¸­ func (c *OrderController) CreateOrder(ctx *gin.Context) { var srv = service.NewCreateOrder(c.repo) var order domain.Order if err := ctx.ShouldBindJSON(\u0026amp;order); err != nil { ctx.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err}) return } srv.Action(\u0026amp;order) ctx.JSON(http.StatusOK, gin.H{\u0026#34;total\u0026#34;: order.Total}) } å„ªç¼ºé» å¦‚æœæ˜¯å¾ˆå–®ç´”çš„ CRUDï¼ŒAPI / DB çš„è³‡æ–™æ ¼å¼éƒ½ä¸€æ¨¡ä¸€æ¨£æ‰æœƒä½¿ç”¨ï¼Œæ¸›å°‘ä¸å¿…è¦çš„è·¨å±¤è½‰æ›ï¼›\nä½†ç¼ºé»æ˜¯å¦‚æœ API / DB æ ¼å¼é–‹å§‹åˆ†æ­§ï¼ŒEntity å°±æœƒå—åˆ°æ±¡æŸ“ï¼Œå‡ºç¾éƒ¨åˆ†æ¬„ä½åªæœ‰åœ¨ç‰¹å®šç”¨é€”ä½¿ç”¨ï¼Œè€Œä¸æ˜¯è·Ÿæ¥­å‹™é‚è¼¯æœ‰é—œï¼Œå°±åƒæ˜¯ CreatedAt æ¬„ä½åªæ˜¯ç‚ºäº† DB ç´€éŒ„ï¼Œå»å‡ºç¾åœ¨æ¥­å‹™é‚è¼¯ä¸Šä¸å¤ªåˆç†ï¼›\nå†åŠ ä¸Šå¦‚æœæœªä¾†ä¸ç”¨ json è€Œèµ° gRPCï¼Œé‚£ Entity å°±è¦é‡æ–°æ”¹ tagï¼Œå› ç‚º IO è®ŠåŒ–è€Œæ”¹å‹• Entity é•åäº† Clean Architecture åŸå‰‡\næ‰€ä»¥å»ºè­°é‚„æ˜¯å°‘ç”¨\n2. Two way mapping github/two-way mapping å‰‡æ˜¯ Controller / Gateway ç¨ç«‹å®£å‘Šè‡ªå·±çš„ç‰©ä»¶ï¼Œå»ºç«‹å‡º Entityå¾Œå†å‚³å…¥ Use Case ä¸­\n1 2 3 4 5 6 type Order struct { ID int Price int Count int Total float64 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // Repo ç¨ç«‹ DAO å®šç¾© type OrderDAO struct { Id int `gorm:\u0026#34;autoincrement\u0026#34;` Price int Count int Total float64 CreatedAt time.Time } func (r OrderRepository) SaveOrder(o *domain.Order) { // ç”¨ Entity å»è½‰æ› DAO orderDao := OrderDAO{ Price: o.Price, Count: o.Count, Total: o.Total, } result := r.db.Create(\u0026amp;orderDao) fmt.Println(result.Error) } // Controller ç¨ç«‹ Request Object func (c *OrderController) CreateOrder(ctx *gin.Context) { var srv = service.NewCreateOrder(c.repo) // ç¨ç«‹ DTO type CreateOrderRequest struct { Price int `json:\u0026#34;price\u0026#34;` Count int `json:\u0026#34;count\u0026#34;` } var o CreateOrderRequest if err := ctx.ShouldBindJSON(\u0026amp;o); err != nil { ctx.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err}) return } // DTO é‡å»º Entity order := domain.Order{Price: o.Price, Count: o.Count} srv.Action(\u0026amp;order) ctx.JSON(http.StatusOK, gin.H{\u0026#34;total\u0026#34;: order.Total}) } å¯ä»¥çœ‹åˆ° Entity è®Šå¾—å¾ˆä¹¾æ·¨ï¼Œè€Œ Controller / Gateway è¦è‡ªå·±è² è²¬ DTO çš„è½‰æ›ï¼Œè®“è·è²¬è®Šå¾—æ›´æ˜ç¢º\nå„ªç¼ºé» é€™ç®—æ˜¯è »å¹³è¡¡çš„è¨­è¨ˆæ–¹å¼ï¼Œé©åˆç”¨åœ¨ Use Case -\u0026gt; Adapter é€™ä¸€å±¤ï¼Œå¯ä»¥çœ‹åˆ° Jalex å¤§å¤§åœ¨ DB å„²å­˜å±¤æ˜¯ç”¨ Two way mapping çš„æ–¹å¼ go-clean-arch\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // DAO å¦å¤–å®šç¾© type repoGood struct { ID int `db:\u0026#34;id\u0026#34;` Name string `db:\u0026#34;name\u0026#34;` OwnerID int `db:\u0026#34;owner_id\u0026#34;` CreatedAt time.Time `db:\u0026#34;created_at\u0026#34;` UpdatedAt time.Time `db:\u0026#34;updated_at\u0026#34;` } // ç›´æ¥æ‹¿ Good (Entity) ç•¶ä½œåƒæ•¸ func (r *PostgresRepository) updateGood(ctx context.Context, db sqlContextGetter, good barter.Good) (*barter.Good, common.Error) { where := sq.And{ sq.Eq{repoColumnGood.ID: good.ID}, } update := map[string]interface{}{ repoColumnGood.Name: good.Name, repoColumnGood.OwnerID: good.OwnerID, repoColumnGood.UpdatedAt: time.Now(), } // build SQL query ..... // execute SQL query ..... updatedGood := barter.Good(row) return \u0026amp;updatedGood, nil } 3. Full Mapping github/full-mapping é€™æ¬¡åš´æ ¼éµå®ˆ Clean Architectureï¼Œåœ¨ two-mapping ä¸Šå¢åŠ è·¨å±¤éƒ½è¦æœ‰ DTO çš„è½‰æ›ï¼Œæ‰€ä»¥ Controller -\u0026gt; Use Case ä¸èƒ½ç›´æ¥ç”¨ Entityï¼Œå¤šå®£å‘Šä¸€å€‹ Command Object\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // CreateOrder Use Case æ”¹åƒ CreateOrderCommand ç•¶ä½œåƒæ•¸è€Œé Entity type CreateOrder interface { Action(command *CreateOrderCommand) *domain.Order } type CreateOrderCommand struct { Price int Count int } // New Command å¯ä»¥è² è²¬é©—è­‰åƒæ•¸ func NewCreateOrderCommand(price int, count int) (CreateOrderCommand, error) { if price \u0026lt; 0 || count \u0026lt; 0 { return CreateOrderCommand{}, errors.New(\u0026#34;params error\u0026#34;) } return CreateOrderCommand{ Price: price, Count: count, }, nil } func (s CreateOrderService) Action(command *in.CreateOrderCommand) *in.CreateOrderOutput { o := domain.Order{ Price: command.Price, Count: command.Count, } withTax := 1.1 o.Total = float64(o.Count*o.Price) * withTax // èˆ‡ Adapter äº’å‹•ä¹Ÿæ˜¯é€é cmd è€Œéç›´æ¥å‚³å…¥ Entity cmd := out.NewSaveOrderCommand(o.Price, o.Count, o.Total, now()) s.saveOrder.SaveOrder(\u0026amp;cmd) output := in.NewCreateOrderOutput(o.Total) return \u0026amp;output } å¤–éƒ¨ä½¿ç”¨ä¸Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // Controller å‘¼å« Command Object func (c *OrderController) CreateOrder(ctx *gin.Context) { var srv = service.NewCreateOrder(c.repo) type CreateOrderRequest struct { Price int `json:\u0026#34;price\u0026#34;` Count int `json:\u0026#34;count\u0026#34;` } var o CreateOrderRequest if err := ctx.ShouldBindJSON(\u0026amp;o); err != nil { ctx.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err}) return } // é€é new cmd å»äº’å‹• cmd, _ := in.NewCreateOrderCommand(o.Price, o.Count) output := srv.Action(\u0026amp;cmd) ctx.JSON(http.StatusOK, gin.H{\u0026#34;total\u0026#34;: output.Total}) } // Adapter éƒ¨åˆ† type OrderDAO struct { Id int `gorm:\u0026#34;autoincrement\u0026#34;` Price int Count int Total float64 CreatedAt time.Time } func (r OrderRepository) SaveOrder(cmd *out.SaveOrderCommand) { orderDao := OrderDAO{ Price: cmd.Price, Count: cmd.Count, Total: cmd.Total, } result := r.db.Create(\u0026amp;orderDao) fmt.Println(result.Error) } å„ªç¼ºé» å¤šäº†ä¸€å€‹ CreateOrderCommand æœ€å¤§å¥½è™•æ˜¯å¯ä»¥é€²ä¸€æ­¥åˆ†æ•£è·è²¬ï¼Œç”± Port ç‰©ä»¶å”åŠ©é©—è­‰è³‡æ–™ï¼Œé€™æ¨£ Use Case å¯ä»¥å°ˆå¿ƒé©—è­‰æ¥­å‹™è¦å‰‡ï¼Œè€ŒåŸºæœ¬çš„è³‡æ–™é©—è­‰å¯ä»¥ç”± Port (ä¹Ÿå°±æ˜¯ CreateOrderCommand) è² è²¬\nå…¶ä»–åœ°æ–¹é©—è­‰è³‡æ–™çš„è€ƒé‡é»\nUse Case: è¦é©—è­‰è³‡æ–™åŒæ™‚é©—è­‰æ¥­å‹™è¦å‰‡ï¼Œé€™æ¨£æœƒæ¯”è¼ƒè¤‡é›œï¼Œè®“ Use Case å°ˆæ³¨æ¥­å‹™è¦å‰‡æœƒæ¯”è¼ƒå¥½ Controller: ä¸é©åˆé©—è­‰è³‡æ–™ï¼Œå¦‚æœæœ‰å…¶ä»–åœ°æ–¹è¦å‘¼å« Use Case é‚£é©—è­‰è¦å‰‡è¦åœ¨é‡è¤‡å¯«ä¸€æ¬¡ è³‡æ–™é©—è­‰ vs æ¥­å‹™è¦å‰‡\næ¥­å‹™è¦å‰‡é€šå¸¸æŒ‡çš„æ˜¯èˆ‡ Entity æœ¬èº«ç‹€æ…‹æœ‰é—œï¼Œä¾‹å¦‚ è½‰å¸³é¤˜é¡ä¸å¯ç‚ºç©ºï¼Œè‡³æ–¼è³‡æ–™é©—è­‰æ¯”è¼ƒæ˜¯ä¸€èˆ¬æ€§çš„è¦å‰‡æª¢æŸ¥ä¾‹å¦‚ Email æ ¼å¼ã€é‡‘é¡ä¸å¯å°æ–¼é›¶ç­‰\nç¼ºé»å°±æ˜¯å¦‚æœæ˜¯ CRUD çš„è©± DTO æœƒå¯«èµ·ä¾†å¾ˆç‘£ç¢ï¼Œå»ºè­°æ˜¯åœ¨ Controller -\u0026gt; Use Case é€™ä¸€å±¤ä½¿ç”¨\nå°ä½œå¼Š ä¸Šè¿°çš„æ¡ˆä¾‹æˆ‘å€‘åªæœ‰ç®¡è¼¸å…¥ï¼Œç•¶ Controller è¦å‘¼å« Use Case æ™‚ è¼¸å…¥åƒæ•¸ç”¨ç¨ç«‹çš„ Command Object\nä½†æ˜¯ Use Case å›å‚³å€¼é‚„æ˜¯ç”¨ Entityï¼Œé€™é‚„æ˜¯é•åäº† Clean Architecture ç‰©ä»¶ä¸å¯è·¨å±¤åŸå‰‡ï¼Œé€™é‚Šä¸»è¦æ˜¯æ–¹ä¾¿ä½¿ç”¨ï¼Œé€™ä¹Ÿæ˜¯ã€Clean Architecture å¯¦ä½œç¯‡ã€‘ä½œè€…åœ¨ p. 112 å»ºè­°çš„åšæ³•\nå¦‚æœ in / out port çš„è¼¸å…¥è¼¸å‡ºéƒ½è¦æœ‰ DTOï¼Œå»ºè­°åƒè€ƒ Teddy çš„å¯¦åš dddcleankanban\n1 2 3 4 5 6 7 8 // åœ¨ Use Case ä¸­å›å‚³ output è€Œé Entity output.setBoardId(input.getBoardId()) .setBoardMemberDtos(boardMemberDtos) .setWorkflowDtos(workflowDtos) .setCommittedWorkflowDtos(committedWorkflowDtos) .setCardDtos(cardDtosInBoard); return output ç¸½çµ ç¸½çµæ•´é«”æ¶æ§‹å¤§è‡´æ˜¯\nController æœ‰ç¨ç«‹çš„ Request / Response Object Controller æœƒå»å»ºç«‹ In Port Commandï¼Œä¸¦å‘¼å« Use Case Use Case å¯¦ä½œ In Port Interfaceï¼Œå¤–ç•Œæ˜¯èˆ‡ Interface ç›¸ä¾ é€é Out Port èˆ‡ Repository æºé€š Repository å®šç¾© DAO å„²å­˜è³‡æ–™åˆ° DB å› ç‚º return éƒ½å·æ‡¶ç”¨ Entityï¼Œæ‰€ä»¥å¤§å®¶éƒ½èˆ‡ Entity ç›¸ä¾ æ¡ç”¨ Clean Architecture å¯ä»¥è®“æ¯ä¸€å±¤è®Šå¾—æ›´ç¨ç«‹ã€æ›´å¥½æ¸¬è©¦ï¼Œé–‹ç™¼çš„æ¨¡å¼ä¹Ÿå¯ä»¥æ›´å›ºå®šï¼Œåœ¨åœ˜éšŠå¢åŠ äººæ•¸æ™‚ä¹Ÿæ›´å¥½ä¸Šæ‰‹ï¼Œå¢åŠ ç”Ÿç”¢åŠ›\nå‰›å¥½å…¬å¸çš„å°ˆæ¡ˆä¸€é‚Šæ˜¯ Railsï¼Œæ¡†æ¶æœ¬èº«å°±å¸¶æœ‰å¾ˆå¼·çƒˆçš„æ¶æ§‹é¢¨æ ¼ï¼›å¦ä¸€é‚Šå¾®æœå‹™ç”¨ Golang å¯¦ä½œ Clean Architecture è©¦è‘—è®“æ¡†æ¶èˆ‡æ¶æ§‹è§£è€¦ï¼Œç®—æ˜¯è »æœ‰è¶£çš„è¡çªèˆ‡ç›¸äº’å°è­‰\n","date":"2022-09-11T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-09-11-%E6%B7%BA%E8%AB%87-clean-architecture-%E5%AF%A6%E4%BD%9C-port-mapping-%E6%96%B9%E5%BC%8F/","title":"æ·ºè«‡ Clean Architecture å¯¦ä½œ - Port Mapping æ–¹å¼"},{"content":"å¹³æ—¥åœ¨å…¬å¸ä½¿ç”¨ RoR é–‹ç™¼ï¼Œéå¾€ code base åœ¨è·¨ class æ™‚ç‚ºäº†æ–¹ä¾¿æœƒæŠ½å‡ºä¸€å€‹åç‚º XXFunction::SharedMethod çš„ moduleï¼Œè®“å¤šå€‹ class ç›´æ¥ include ä½¿ç”¨ï¼Œä½†å¾ŒçºŒåœ¨é–±è®€æ™‚ç™¼ç¾ module èˆ‡ class è·è²¬ä¸æ¸…æ¥šï¼Œå°è‡´é–±è®€æ™‚è¦ä¸æ–·åœ°å¤šå€‹æª”æ¡ˆåˆ‡æ›ï¼Œæœ€å¯æ€•æ˜¯ instance variable åœ¨ module / class éƒ½æœƒè®€å¯«ï¼Œå¼·è€¦åˆçš„æƒ…æ³ä¸‹ä»»æ„çš„æ”¹å‹•éƒ½æœ‰å¯èƒ½ç ´å£åŸæœ¬çš„è¨­è¨ˆ\nå› æ­¤æœ‰äº†é€™ç¯‡çš„æ–‡ç« èª•ç”Ÿï¼Œæ¢è¨ Module åœ¨ RoR ä¸­è©²å¦‚ä½•æ­£ç¢ºåœ°ä½¿ç”¨ï¼Œæ‰å¯ä»¥å†äº«æœ‰ code reuse çš„ä¾¿åˆ©å»ä¸é€ æˆå¯è®€æ€§ / ç¶­è­·æ€§ä¸Šçš„å›°æ“¾\nä»¥ä¸‹æ–‡ç« å¤§é‡åƒè€ƒ\nGitlab ä¸Šçš„è¨è«– Rails module using instance variable is harmful Good Module or Bad Module When To Be Concerned About Concerns Module ç°¡ä»‹ Module åœ¨ Rudy ä¸­æ˜¯ä¸€å€‹é¡ä¼¼ class çš„å­˜åœ¨ï¼Œæ˜¯ class / method / constant çš„é›†åˆä½†ä¸å¯ä»¥è¢« initiailizeï¼Œä¸»è¦çš„åŠŸèƒ½æœ‰å…©å€‹\n1. Namespace å¦‚æœæœ‰å…©å€‹ class åœ¨ä¸åŒçš„ context ä¸­å»æœ‰é¡ä¼¼çš„å‘½åï¼Œå¯ä»¥ç”¨ Module ç•¶ä½œå‰ç¶´éš”é–‹ï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 module FeatureA class Hello end end module FeatureB class Hello end end FeatureA::Hello FeatureB::Hello 2. Code Reuse åœ¨ Ruby ä¸­ç¹¼æ‰¿åªèƒ½å¤  å–®ä¸€ç¹¼æ‰¿ï¼Œç¹¼æ‰¿è¨­è¨ˆçš„ç†å¿µåå‘æ˜¯ is-aï¼›\nå¦‚æœæƒ³æ›´å»£æ³›çš„è³¦äºˆ class æŸç¨®èƒ½åŠ› could-doï¼Œé‚£ç”¨ module çš„æ–¹å¼æœƒæ›´åŠ çš„é©åˆï¼Œåœ¨ module åµŒå…¥çš„æ•¸é‡ä¸Š Ruby ä¸¦æ²’æœ‰é™åˆ¶ (åƒè€ƒ é¡åˆ¥ï¼ˆClassï¼‰èˆ‡æ¨¡çµ„ï¼ˆModuleï¼‰)\næœ€åŸºæœ¬çš„ä¾‹å­æ˜¯ Ruby Core Module Comparableï¼Œç•¶ class include Module å¾Œåªè¦å¯¦ä½œ \u0026lt;=\u0026gt; methodï¼Œå°±å¯ä»¥ä½¿ç”¨ Comparable å®šç¾©çš„åŠŸèƒ½å¦‚ \u0026lt;ã€\u0026gt;ã€==ã€between? ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 class SizeMatters include Comparable attr :str def \u0026lt;=\u0026gt;(other) str.size \u0026lt;=\u0026gt; other.str.size end def initialize(str) @str = str end def inspect @str end end s1 = SizeMatters.new(\u0026#34;Z\u0026#34;) s2 = SizeMatters.new(\u0026#34;YY\u0026#34;) s1 \u0026lt; s2 æ¿«ç”¨ Module çš„å£å‘³é“ ä»‹ç´¹äº† Module çš„åŠŸç”¨ï¼Œä¾†çœ‹ä¸€ä¸‹åœ¨æ¿«ç”¨çš„æƒ…æ³ä¸‹é€ æˆçš„å‰¯ä½œç”¨\nè‡­å‘³ 1. ç›¸ä¾æ€§è®Šæˆéš±å¼ï¼Œé™ä½æ˜“è®€æ€§ è©¦æƒ³ä»Šå¤©åªæ˜¯ç‚ºäº†é™ä½ class çš„ç¨‹å¼ç¢¼è¡Œæ•¸ï¼Œè€Œå–®ç´”æŠŠ code æŠ½åˆ° Module æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ\n1 2 3 4 5 6 7 class AfterSignupController include Wicked::Wizard include SetAdmin include MailAfterSuccessfulCreate include FooBarFighters::MyHero # ... end æ‰“é–‹äº†ä¸€å€‹æª”æ¡ˆï¼Œçµæœç™¼ç¾ class ä¸­æ‰€æœ‰çš„ method éƒ½åœ¨åˆ¥çš„ module å…§ï¼Œé€™æ™‚å€™è¦æ‰¾åˆ°å°æ‡‰çš„ module åœ¨å“ªå°±å¾ˆéº»ç…©\næ›´å¯æ€•çš„æ˜¯ç•¶ä½ æ‰¾åˆ°å¾Œï¼Œä½ æ€éº¼æ”¹ä¿è­‰åœ¨æœ‰ class ä¾è³´çš„æƒ…æ³ä¸‹ï¼Œæ”¹å‹• Module æœƒä¸æœƒå£æ‰ï¼Ÿ\nExtracting methods into a module to only turn around and include them is worse than pointless. It\u0026rsquo;s actively damaging to the readability of your codebase.\nè‡­å‘³ 2. åš´é‡è€¦åˆï¼Œå¦‚æœå…±ç”¨ Instance Variable æœƒè®“æƒ…æ³æ›´ç³Ÿ åˆ†äº«ä¸€ä¸‹ç›®å‰é‡åˆ°çš„æ¡ˆä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 module SharedFunction def update_method self.var += 10 end def print puts self.var + self.var2 end end class Hello include SharedFunction def initialize self.var = 0 self.var2 = 10 # è€¦åˆé»1: class å¿…é ˆå…ˆ initial varï¼Œå¦å‰‡ update_method å°±æœƒå‡ºéŒ¯ # è€¦åˆé»2: å¿…éœ€è¦çŸ¥é“ module method å‘¼å«é †åºï¼Œè®Šæˆæ˜¯è¦çŸ¥é“ module æ‰€æœ‰ç´°ç¯€æ‰èƒ½ä½¿ç”¨ï¼Œç¼ºå°‘å°è£çš„æ„ç¾© update_method print end def update_var # è€¦åˆé»3. var é€™é‚Šä¹Ÿæœ‰æ©Ÿæœƒè®Šå‹•ï¼Œæœªä¾†åœ¨æ‰¾ var çš„å€¼åˆ°åº•æ˜¯ä»€éº¼æœƒå¾ˆå›°é›£ self.var = 20 end attr_accessor var end å¯ä»¥çœ‹å‡º module åœ¨ä½¿ç”¨ instance variable å¾Œæœƒæœ‰å¾ˆå¤šè€¦åˆçš„åœ°æ–¹ï¼ŒåŒ…å« initialzie çš„æ™‚æ©Ÿ / æš´éœ²éå¤šç´°ç¯€ç­‰å•é¡Œ\nå£å‘³é“3. å¤šå€‹ Module é–“å¯èƒ½æœƒæœ‰å‘½åè¡çª å¦‚æœä»Šå¤©å…©å€‹ Module å‘½åé‡è¤‡æ€éº¼è¾¦ï¼Ÿ åœ¨ Ruby ä¸­æœƒä¾ç…§ç¹¼æ‰¿éˆæ±ºå®šå¥—ç”¨åˆ°çš„ methodï¼Œä½†å¯èƒ½ä¸ç¬¦åˆ caller çš„é æœŸï¼Œé€™é‚Šå¯ä»¥åƒè€ƒå‰ç«¯ React åœˆçš„è¨è«– Mixins Considered Harmful\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 module A def method_a end end module B def method_b end end # å¦‚æœ module B ä¸å°å¿ƒä¹Ÿå®šç¾©äº† method_aï¼Œå°±æœƒè¦†è“‹éå» class C include A include B end å¦‚ä½•è§£æ±º å»ºè­° 1. Composition over Inheritance Module æŸç¨®ç¨‹åº¦æ˜¯å¤šé‡ç¹¼æ‰¿ï¼Œä¹Ÿå¯ä»¥ç”¨ class.ancestors çœ‹åˆ° included Module åœ¨ç¹¼æ‰¿éˆä¸Šï¼Œè¦è§£æ±ºé€™æ¨£çš„è‡­å‘³å¯ä»¥æ”¹ç”¨ Composition\nComposition æ˜¯æŒ‡èªªæŠŠé¡ä¼¼çš„è¡Œç‚ºå°è£æˆ classï¼Œç›´æ¥åœ¨åŸæœ¬çš„ class ä¸­ä½¿ç”¨ï¼Œé€™å¸¶ä¾†çš„å¥½è™•æ˜¯\nclass æœ‰æ›´å¥½çš„å°è£æ€§ï¼Œåªæœ‰ public method å¯ä»¥è¢«ä½¿ç”¨ (åœ¨ Ruby ä¸­ä¸å®Œå…¨æ­£ç¢º) class å¯ä»¥ç¨ç«‹æ¸¬è©¦ ä¾‹å¦‚ä»¥ä¸‹ï¼ŒåŸæœ¬ tracking ç›¸é—œçš„è¡Œç‚ºè¢«æŠ½åˆ° module ä¸­ï¼Œè¦çŸ¥é“ notify_next! å®šç¾©åœ¨å“ªå°±å¿…é ˆæ‰¾æ‰€æœ‰çš„ module åŒ…å«ç¹¼æ‰¿çš„ class\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 class Todo \u0026lt; ActiveRecord::Base # Other todo implementation # ... include EventTracking end module EventTracking extend ActiveSupport::Concern included do has_many :events before_create :track_creation after_destroy :track_deletion end def notify_next! # end private def track_creation # ... end end ä½†ç¾åœ¨ tracking è®Šæˆ class EventPlanningï¼Œå¥½è™•æ˜¯ä¸ç”¨çŒœ notify_next! åœ¨å“ªå€‹ moduleï¼Œè·è²¬èˆ‡ç´°ç¯€éƒ½å°è£åœ¨ EventPlanning è£¡é¢ï¼Œè¦æ”¹å‹•åªè¦ç¢ºä¿ç›¸ä¾çš„ classï¼Œå°±ä¸ç”¨ç‰¹åˆ¥æ“”å¿ƒï¼Œè€Œä¸”é‚„æœ‰æ¸¬è©¦ä¿è­·\n1 2 3 4 5 6 7 8 9 10 class Todo \u0026lt; ActiveRecord::Base # Other todo implementation # ... has_many :events before_create :track_creation after_destroy :track_deletion def notify_next! EventPlanning.new(self.events).notify_next! end end å»ºè­° 2. è¨­è¨ˆ Module æ™‚æœ‰æ˜ç¢ºçš„è·è²¬ï¼Œä¸¦ç¢ºä¿æš´éœ²çš„ç´°ç¯€ åƒè¬ä¸è¦ç‚ºäº† reuse code è€Œæ”¾æ£„ Object Oriented çš„æ€è€ƒï¼Œè¦ç¢ºä¿æ¯ä¸€å€‹ Module è¢«è¨­è¨ˆçš„å«ç¾©ï¼Œå…·é«”ä¾†èªªå°±æ˜¯\ninclude çš„ class å¿…é ˆå¯¦ä½œä»€éº¼åŠŸèƒ½ (æ±ºå®šè€¦åˆé») Module å¯ä»¥æä¾› class æ€æ¨£çš„é¡å¤–åŠŸèƒ½ è®“æˆ‘å€‘çœ‹å¹¾å€‹æ¼‚äº®çš„ Module è¨­è¨ˆ\nç¯„ä¾‹ï¼šEnumerable Enumerable æ˜¯æä¾›é›†åˆé¡å‹çš„ class æœ‰æ–¹ä¾¿éæ­· (iterate) çš„æ–¹æ³•\ninclude class å¿…é ˆå¯¦ä½œ each Module å¯ä»¥æä¾› class map / select / sort / count ç­‰ iterator è©²æœ‰çš„åŠŸèƒ½ 1 2 3 4 5 6 7 8 9 class Foo include Enumerable def each yield 1 yield 1, 2 yield end end Foo.new.each_entry{ |element| p element } Enumerable èˆ‡ class è€¦åˆé»åªæœ‰ each é€™å€‹ methodï¼Œå®Œå…¨æ²’æœ‰ instance variable ç­‰å…¶ä»–è€¦åˆï¼Œéå¸¸ä¹¾æ·¨\nå»ºè­° 3. å¦‚æœè¦ç”¨ instance variable è«‹ç¢ºä¿åªæœ‰ Module è‡ªå·±ä½¿ç”¨ å¦‚æœ Module é‚„æ˜¯éœ€è¦ä½¿ç”¨ instance variable ä¹Ÿæ²’é—œä¿‚ï¼Œç¢ºä¿ class ä¸æœƒç”¨åˆ°å³å¯\nç¯„ä¾‹ï¼šSidekiq::Worker è®“æˆ‘å€‘çœ‹ä¸€å€‹ç¨å¾®è¤‡é›œçš„æ¡ˆä¾‹\n1 2 3 4 5 6 7 8 9 10 class HardWorker include Sidekiq::Worker sidekiq_options queue: \u0026#39;critical\u0026#39;, retry: 5 def perform(*args) # do some work end end HardWorker.perform_async(1, 2, 3) åœ¨ include Sidekiq::Workerï¼Œå¯ä»¥æ‰‹å‹•èª¿æ•´åƒæ•¸ sidekiq_optionsï¼Œé€™é‚Šå¯¦ä½œå°±æœƒå»ºç«‹ instance variable\n1 self.sidekiq_options_hash = get_sidekiq_options.merge(opts) ä½†å¾ˆæ˜é¡¯é€™å€‹ variable åœ¨ class æ˜¯å®Œå…¨ä¸æœƒç”¨åˆ°ï¼Œåªæœ‰ module å…§éƒ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æ²’æœ‰å•é¡Œ\nå¦å¤–ç•¶æˆ‘å€‘å¾€ä¸‹è¿½ perform_async æ™‚ï¼Œå¯ä»¥çœ‹åˆ°\n1 2 3 def perform_inline(*args) Setter.new(self, {}).perform_inline(*args) end é€™é‚Šå‡ºç¾ä¸€å€‹ module å…§éƒ¨å®šç¾©çš„ class Setterï¼Œå¯ä»¥çœ‹åˆ°å¯¦éš›ç™¼é€çš„é‚è¼¯åœ¨é€™é‚Šï¼Œé€é class å°è£å¥½è™•æ˜¯ä¸æ€•è¢«å…¶ä»–äººä¸å°å¿ƒè¤‡å¯«æˆ–æ”¹å‹•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 module Test def module_method puts private_method end private def private_method \u0026#34;module private\u0026#34; end end class A include Test private def private_method \u0026#34;class private\u0026#34; end end A.new.module_method // \u0026#34;class private\u0026#34; module å…§çš„ method æœƒè¢«è¦†å¯«ï¼Œä½†å¦‚æœæ”¹ç”¨ class æŒ‡å®šå°±ä¸æœƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 module Test def module_method puts ModuleClass.new.private_method end private class ModuleClass def private_method \u0026#34;module private\u0026#34; end end end class A include Test private def private_method \u0026#34;class private\u0026#34; end end A.new.module_method // \u0026#34;module private\u0026#34; çˆ­è­° Rails ActiveSupport::Concern ActiveSupport::Concern æ˜¯ Rails ä¸­è »æœ‰è¶£çš„è¨­è¨ˆï¼Œé¡ä¼¼æ–¼ Module ä½†æœ‰å¢åŠ æ›´å¤šçš„ é­”æ³•ï¼Œå¯ä»¥æŠŠå¤ªå¤§çš„ orm class ä»¥ module çš„å½¢å¼åˆ†æ‹†å‡ºå»ï¼Œç®—æ˜¯ orm ç‰ˆçš„ Moduleï¼Œåœ¨ä½¿ç”¨çš„å¿ƒæ³•èˆ‡ä¸Šè¿°é›·åŒï¼Œå°±ä¸è´…è¿°ï¼Œä¹Ÿå¯ä»¥åƒè€ƒ Rails Concerns: To Concern Or Not To Concern\nåŸºæœ¬ä¸Šä¹Ÿéƒ½æ˜¯æåˆ° å¦‚æœ module èˆ‡ class ç”¢ç”Ÿäº† circular dependencyï¼Œå¦‚æœæœ‰äººæ²’æ³¨æ„åˆ°ç›´æ¥æ”¹ classï¼Œé‚£ module å°±å¯èƒ½æœƒå£æ‰ï¼›è§£æ³•åŒæ¨£æ˜¯é™ä½ä¾è³´çš„æ©Ÿæœƒï¼Œè®“ module åšçš„äº‹æƒ…ç°¡å–®ä¸€äº›\nä½†æœ‰è¶£çš„æ˜¯ DHH æœ¬äººçœ‹èµ·ä¾†å¾ˆå–œæ­¡é€™æ¨£çš„å¯«æ³• ï¼Œæˆ–è¨±é€™ä¹Ÿæ˜¯ä¸€ç¨® convention over configuration çš„é«”ç¾ XD ä½†è »å¤šäººæŠ±æŒåå°ç«‹å ´ï¼Œå°±å¤§å®¶æ–Ÿé…Œä½¿ç”¨\nçµèª Ruby æ˜¯ä¸€é–€æœ‰è¶£çš„ç‰©ä»¶å°å‘èªè¨€ï¼Œæ‰€æœ‰çš„æ±è¥¿éƒ½æ˜¯ç‰©ä»¶ï¼Œæ‰€ä»¥åœ¨è¨­è¨ˆä¸Šå¦‚æœå¤šä½¿ç”¨ç‰©ä»¶å°å‘çš„æ€ç¶­å»è¨­è¨ˆï¼Œæœƒè®“ç¨‹å¼ç¢¼æ›´å¥½ç¶­è­·\nå¦å¤–ç™¼ç¾å¾ˆå¤šäººéƒ½æœƒæŠŠ DRY (Dont repeat yourself) ç•¶ä½œè–æ—¨ï¼Œçœ‹åˆ°ä¸€é»é»é‡è¤‡å°±æœƒå¿ä¸ä½æŠ½å…±ç”¨ï¼Œä½†æ²’æœ‰è€ƒæ…®åˆ°æŠ½å…±ç”¨çœ‹èµ·ä¾†é¿å…äº†é‡è¤‡ä»£ç¢¼ï¼Œä½†é€™æ¨£é€ æˆäº†æ„å¤–çš„è€¦åˆï¼Œåœ¨ç†è§£ Clean Architecture å¾Œæœƒç™¼ç¾å¾ˆå¤šçœ‹ä¼¼é‡è¤‡éƒ½æ˜¯éš±æ€§çš„é‡è¤‡ï¼Œå…¶å¯¦æ²’æœ‰å¿…è¦æŠ½å…±ç”¨å°è‡´è€¦åˆçš„å­˜åœ¨ï¼Œé€™é»æœªä¾†æœ‰æ©Ÿæœƒå†å»¶ä¼¸æ¢è¨\nåœ¨ä½¿ç”¨ Module ä¸Šï¼Œè«‹ç¢ºä¿\nçœŸçš„éœ€è¦ç”¨ module åœ¨ç”¨ï¼Œå¦å‰‡ç”¨ composition + class æœƒè®“ç”Ÿæ´»æ›´ç°¡å–® Module è¨­è¨ˆä¸Šè¦ç¢ºå®šæš´éœ²çš„ç´°ç¯€èˆ‡è€¦åˆé» ä½¿ç”¨ instance variable è¦å°å¿ƒï¼Œè«‹é™ç¸®åœ¨ module å…§ä½¿ç”¨ ","date":"2022-08-27T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-08-27-%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%E8%AC%B9%E6%85%8E%E4%BD%BF%E7%94%A8-mixin-%E6%B7%BA%E8%AB%87-ror-module-%E4%BD%BF%E7%94%A8%E7%9A%84%E9%99%B7%E9%98%B1/","title":"ã€ç¨‹å¼è¨­è¨ˆã€‘è¬¹æ…ä½¿ç”¨ Mixin - æ·ºè«‡ RoR Module ä½¿ç”¨çš„é™·é˜±"},{"content":"ä»Šå¤©åœ¨è§£ 549. Binary Tree Longest Consecutive Sequence IIï¼Œåœ¨è©•è«–å€ç™¼ç¾æœ‰è¶£çš„è§£æ³• Merkle Treeï¼Œèªªä¾†è§£æ³•ä¹Ÿå¾ˆå–®ç´”ï¼Œå°±æ˜¯ tree ç¯€é»æœƒ (å·¦å­æ¨¹çš„ hash value + å³å­æ¨¹çš„ hash value + è‡ªå·±çš„ hash value) å†å–ä¸€æ¬¡ hash value ä»£è¡¨æ•´æ£µ treeï¼Œæ‰€ä»¥éœ€è¦ O(n) çš„æ™‚é–“è¤‡é›œåº¦èˆ‡ç©ºé–“è¤‡é›œåº¦ï¼Œn ç‚ºç¯€é»æ•¸\nåœ–ç‰‡ä¾†è‡ª wiki\n#549 ç¨‹å¼ç¢¼å¤§è‡´æ˜¯ï¼Œä»¥ä¸‹ä»£ç¢¼çš„ä¾†æºæ˜¯ awice-Python, O(N) Merkle Hashing Approach\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 def findDuplicateSubtrees(self, root): from hashlib import sha256 def hash_(x): S = sha256() S.update(x) return S.hexdigest() def merkle(node): if not node: return \u0026#39;#\u0026#39; m_left = merkle(node.left) m_right = merkle(node.right) node.merkle = hash_(m_left + str(node.val) + m_right) count[node.merkle].append(node) return node.merkle count = collections.defaultdict(list) merkle(root) return [nodes.pop() for nodes in count.values() if len(nodes) \u0026gt;= 2] é€é hash value æ¯”å°å…©å€‹ subtree æ˜¯å¦ç›¸åŒï¼Œä»¥ä¸Šè§£æ³•è¦å°å¿ƒæœ‰ hash collision å•é¡Œï¼Œæœ€å¥½é‡æ–°æª¢æŸ¥ä¸€ä¸‹æ¯”è¼ƒä¿éšª\nMerkle Tree åœ¨ç¾å¯¦ä¸­æœ‰ä»€éº¼æ‡‰ç”¨å‘¢ï¼Ÿ ä»¥ä¸‹å…§å®¹åƒè€ƒè‡ªÂ Understanding Merkle Trees\nä¸»è¦æœƒå‡ºç¾åœ¨æ¨¹ç‹€çµæ§‹ä¸”éœ€è¦å¿«é€Ÿæ‰¾å‡ºé€™å…©æ£µ Tree / Subtree å·®ç•°ä¹‹è™•ï¼Œä¾‹å¦‚\nGit åœ¨ pull request éœ€è¦å¿«é€ŸçŸ¥é“æ˜¯å¾å“ªå€‹ git commit tree é–‹å§‹ä¸åŒ / file tree ä¸­æœ‰å“ªäº›æª”æ¡ˆæœ‰ç•°å‹•éœ€è¦åŒæ­¥ Blockchain ä¸­éœ€è¦çŸ¥é“äº¤æ˜“éˆä¸Šçš„æŸç­†äº¤æ˜“æ˜¯å¦å­˜åœ¨æ–¼è©²å€å¡Šä¸­ åˆ†æ•£å¼è³‡æ–™åº«ä¸­åœ¨åŒæ­¥è³‡æ–™æ™‚ï¼Œè¦ç¢ºèªå“ªéƒ¨åˆ†è³‡æ–™æœ‰è½å·®éœ€è¦åŒæ­¥ï¼Œå¦‚ Dynamo DB ä¸­ è®“æˆ‘å€‘æ›´æ·±å…¥çœ‹ä¸€ä¸‹ Git å…§éƒ¨å¯¦ä½œ\nGit Internals - Git Objects https://git-scm.com/book/en/v2/Git-Internals-Git-Objects\nè®“æˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ Git å…§éƒ¨æ€éº¼å„²å­˜è³‡æ–™ï¼ŒGit å…§éƒ¨æœ‰ä¸€å€‹ key-value databaseï¼Œè£¡é¢æœƒå„²å­˜ hash key èˆ‡å°æ‡‰çš„å…§å®¹ (Object)ï¼ŒåŒ…å«çš„é¡å‹æœ‰æª”æ¡ˆ (blob) / è³‡æ–™å¤¾ (tree) / commit éƒ½æœƒä»¥é€™æ¨£çš„æ–¹å¼å„²å­˜ï¼Œä¸åŒçš„é¡å‹æœƒ hash function çš„åƒæ•¸æœƒæœ‰æ‰€ä¸åŒï¼Œä½†éƒ½æ˜¯é€é SHA-1 ç”¢ç”Ÿ\nä»¥ä¸Šçš„å…§å®¹æœƒå„²å­˜åœ¨Â .git/objectÂ çš„è·¯å¾‘\nBlob Objects æª”æ¡ˆåŒ…å«æ–‡å­—åœ–æª”ç­‰éƒ½æ˜¯ blob å½¢å¼ï¼Œæˆ‘å€‘å¯ä»¥é€é\n$git hash-objectÂ å°‡æŒ‡å®šçš„æª”æ¡ˆæˆ–å…§å®¹å„²å­˜åˆ° git database ä¸­ï¼Œä¸¦å–å¾— hash code\n$git cap-fileÂ è¼¸å…¥å°æ‡‰çš„ hash code å¯ä»¥å–å‡ºå°æ‡‰çš„å…§å®¹\nå¦‚å®˜æ–¹æ¡ˆä¾‹\n1 2 3 4 5 6 7 8 9 10 $ mkdir test \u0026amp;\u0026amp; cd test $ git init $ echo \u0026#39;test content\u0026#39; | git hash-object -w --stdin d670460b4b4aece5915caf5c68d12f560a9fe3e4 $ find .git/objects -type f .git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4 $ git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4 test content åœ¨ .git/objects ä¸‹å¯ä»¥çœ‹åˆ°Â d6/70460b4b4aece5915caf5c68d12f560a9fe3e4ï¼Œgit æœƒæŠŠ 40 ç¢¼ hash code æ‹†æˆ 2 + 38ï¼Œå‰ 2 ç¢¼è®Šæˆè³‡æ–™å¤¾åç¨±ï¼‹å¾Œ 38 ç¢¼è®Šæˆæª”æ¡ˆåç¨±ï¼Œå¦‚æœè©¦è‘—ç›´æ¥è®€å– file æœƒç™¼ç¾ç„¡æ³•è­˜åˆ¥ï¼Œä¸»è¦æ˜¯ Git æœƒç”¨ zlib å£“ç¸®å…§å®¹\nTree Objects è³‡æ–™å¤¾åœ¨ Git ä¸­ä»¥ Tree çš„æ ¼å¼å„²å­˜ï¼Œå…¶å…§å®¹æœƒå„²å­˜è·¯å¾‘ä¸‹ tree / blob çš„ hash code\n1 2 3 4 5 6 7 8 9 10 11 12 13 $ mkdir -p test1/test2 $ echo \u0026#34;123\u0026#34; \u0026gt; test1/test2/test.txt $ git add . $ git commit -m \u0026#34;init\u0026#34; $ git cat-file -p master^{tree} 040000 tree b5a59142d85435f6a41a972e376a422fc6b2df93 test1 $ git cat-file -p b5a59142d85435f6a41a972e376a422fc6b2df93 040000 tree 33dacd7d9ac656ddebea4ecfc8ab9a87b37c2736 test2 $ git cat-file -p 33dacd7d9ac656ddebea4ecfc8ab9a87b37c2736 100644 blob d800886d9c86731ae5c4a62b0b77c437015e00d2 test.txt å…¶ä¸­ master^{tree}æ˜¯ä»£è¡¨ master branch çš„ç›®éŒ„ï¼Œå…§å®¹å„²å­˜ç¬¬ä¸€å±¤çš„æ‰€æœ‰æª”æ¡ˆèˆ‡è³‡æ–™å¤¾ test1ï¼Œæ¥è‘—ä¸€å±¤ä¸€å±¤å¾€ä¸‹æ‰¾å°±èƒ½æ‰¾åˆ° test.txt\nå¦‚æœæˆ‘å€‘æ›´æ–° test.txt æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ 1 2 3 4 5 6 7 8 9 $ echo \u0026#34;456\u0026#34; \u0026gt; test1/test2/test.txt $ git cat-file -p master^{tree} 040000 tree ff1e53b4ff4c130ece8c9f12cdcc3f2613a779e7 test1 $ git cat-file -p b5a59142d85435f6a41a972e376a422fc6b2df93 040000 tree 33dacd7d9ac656ddebea4ecfc8ab9a87b37c2736 test2 $ git cat-file -p e9e2bd5dfa2916e3b1cba933bd9250a9822406e4 100644 blob 4632e068d5889f042fe2d9254a9295e5f31a26c7 test.txt å¯ä»¥çœ‹åˆ° test.txt å› ç‚ºå…§å®¹æ”¹è®Šè€Œ SHA key ä¹Ÿæ”¹è®Šï¼ŒåŒæ¨£çš„ test1 ã€test2 å°æ‡‰çš„ tree object SHA key å·²ç¶“è®Šæˆäº†ï¼Œæ‰€ä»¥åªè¦åº•ä¸‹çš„ blob æ”¹è®Š tree SHA keyä¹Ÿæœƒè·Ÿè‘—æ”¹è®Š\næˆ‘æš«æ™‚æ²’æœ‰æ‰¾åˆ°ç›´æ¥æŠŠè³‡æ–™å¤¾è½‰æˆ hash code ä¸¦å„²å­˜çš„æ–¹å¼ï¼Œåœ¨æ–‡ä»¶ä¸­åªæœ‰è¨˜è¼‰ç•¶åœ¨ staging å€å¢åŠ æª”æ¡ˆæ™‚ï¼Œgit æœƒå¹«å¿™å»ºç«‹ index èˆ‡ tree\næ¯æ¬¡è®Šå‹• git éƒ½æœƒå„²å­˜æ•´ä»½æª”æ¡ˆå…§å®¹ï¼Œé€™æ¨£ .git/objects å°±æœƒè¶…è‚¥ï¼Ÿ æ²’éŒ¯ï¼Œæœƒéå¸¸è‚¥ï¼Œæ‰€ä»¥ git æä¾›æŒ‡ä»¤å¯ä»¥æ¸…é™¤æª”æ¡ˆå¤ªèˆŠçš„è³‡æ–™ï¼Œåƒè€ƒ How to shrink the .git folderï¼Œåœ¨ git æ–‡ä»¶ä¸­æœ‰æ›´è©³ç´°æè¿° 10.7 Git Internals - Maintenance and Data Recovery\n1 $ git repack -a -d --depth=250 --window=250 Commit Objects åœ¨ git ä¸­ commit å„²å­˜æ˜¯æ¨¹ç‹€çµæ§‹ï¼Œç•¶åŸ·è¡Œ $ git commit æ™‚ï¼Œgit æœƒç”¢ç”Ÿ commit object ä¸¦è¨˜éŒ„ commit è¨Šæ¯ / æ™‚é–“ / ä½œè€…èˆ‡ parent commitï¼Œå¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ git add . $ git commit -m \u0026#34;init\u0026#34; $ git remove . $ git commit -m \u0026#34;delete\u0026#34; $ git log commit 8864a737bf54b251c878655c263dc9b1e16640e2 (HEAD -\u0026gt; master) ..... delete commit ff226f74f095fd1acb5c965583688be28ad3bbb4 .... init $ git cat-file -p 8864a737bf54b251c878655c263dc9b1e16640e2 tree 4b825dc642cb6eb9a060e54bf8d69288fbee4904 parent ff226f74f095fd1acb5c965583688be28ad3bbb4 author Yuanchieh \u0026lt;sj82516@gmail.com\u0026gt; 1654239635 +0800 committer Yuanchieh \u0026lt;sj82516@gmail.com\u0026gt; 1654239635 +0800 delete SHA key å¦‚ä½•é‹ç®— åœ¨æ–‡ä»¶æœ€å¾Œæœ‰è£œå……å¦‚ä½•è¨ˆç®— blob çš„ SHA keyï¼Œé€™é‚Šåƒè€ƒé¾å“¥æ•™å­¸Â ã€å†·çŸ¥è­˜ã€‘é‚£å€‹é•·å¾—å¾ˆåƒäº‚ç¢¼ SHA-1 æ˜¯æ€éº¼ç®—å‡ºä¾†çš„ï¼ŸÂ 1 2 3 4 5 6 7 8 9 10 11 # å¼•å…¥ SHA-1 è¨ˆç®—å‡½å¼åº« require \u0026#34;digest/sha1\u0026#34; # è¦è¨ˆç®—çš„å…§å®¹ content = \u0026#34;Hello, 5xRuby\u0026#34; # è¨ˆç®—å…¬å¼ input = \u0026#34;blob #{content.length}\\0#{content}\u0026#34; puts Digest::SHA1.hexdigest(input) # å¾—åˆ° \u0026#34;4135fc4add3332e25ab3cd5acabe1bd9ea0450fb\u0026#34; ç¸½çµï¼šåœ¨ Git ä¸­æª”æ¡ˆèˆ‡ Commit éƒ½æ˜¯ä»¥æ¨¹ç‹€çµæ§‹å„²å­˜ï¼Œåªè¦ç¯€é»ä¸‹çš„å­ç¯€é»æœ‰è®Šå‹•ï¼Œå¾€ä¸Šä¸€è·¯åˆ°è·Ÿç¯€é»çš„ Hash key éƒ½æœƒè·Ÿè‘—æ”¹è®Šï¼Œé€é Mercle Tree å°±å¯ä»¥åœ¨ O(N) æ‰¾åˆ°è®Šå‹•çš„åœ°æ–¹\nçµèª åˆ·é¡Œæœ‰æ™‚å€™æœ‰è¶£çš„ä¸æ˜¯å–®ç´”ç­”æ¡ˆå¯«å‡ºä¾†ï¼Œè€Œæ˜¯çœ‹åˆ°è¨è«–å€æœ‰å„ç¨®ç‰›é¬¼è›‡ç¥çš„å¼·å¤§è§£æ³•ï¼Œè¨±å¤šè³‡æ–™çµæ§‹æˆ–æ¼”ç®—æ³•åœ¨æ—¥å¸¸çš„ç³»çµ±ä¸­éƒ½æ‰®æ¼”é‡è¦çš„è§’è‰²\n","date":"2022-06-01T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-06-01-%E5%88%B7%E9%A1%8C%E9%95%B7%E7%9F%A5%E8%AD%98mercle-tree-%E8%AD%98%E5%88%A5%E5%AD%90%E6%A8%B9%E7%9B%B8%E5%90%8C%E8%88%87%E5%90%A6/","title":"ã€åˆ·é¡Œé•·çŸ¥è­˜ã€‘Mercle tree è­˜åˆ¥å­æ¨¹ç›¸åŒèˆ‡å¦"},{"content":"ç•¶éœ€è¦åœ¨æŸä¸€é™£åˆ—ä¸­ï¼Œæ±‚æŸä¸€æ®µå€é–“çš„æ•¸å€¼å’Œæˆ–æ˜¯æœ€å°å€¼ï¼Œå¦‚æœæ˜¯éœæ…‹è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯é™£åˆ—å…§å®¹ä¸æœƒå†æ”¹è®Šï¼Œæˆ‘å€‘å¯ä»¥ç”¨ prefix sum åœ¨ constant time å–å¾—çµæœ\nä½†å¦‚æœé™£åˆ—çš„å€¼æœƒæ”¹è®Šï¼Œå°±éœ€è¦æ¯æ¬¡éƒ½é‡æ–°è¨ˆç®— prefix sumï¼Œæ­¤æ™‚çš„æ™‚é–“è¤‡é›œåº¦æœƒæ˜¯ O(N)ï¼Œæœ‰æ²’æœ‰æ›´å¿«çš„æ–¹æ³•å‘¢ï¼Ÿ\né€™é‚Šæœ‰å…©å€‹ç›¸ä¼¼çš„æ¨¹ç‹€çµæ§‹ Segment Tree / Binary Indexed Tree (åˆç¨± Fenwick Tree) å¯ä»¥ç”¨ O(logN) è§£æ±ºå‹•æ…‹å€é–“å’Œçš„å•é¡Œï¼Œå…¶ä¸­ Segment Tree å¯ä»¥æ›´å»£æ³›è§£æ±ºå€é–“æ¥µå€¼çš„å•é¡Œ\nç›¸é—œé¡Œç›®\n307. Range Sum Query - Mutable 308. Range Sum Query 2D - Mutable 315. Count of Smaller Numbers After Self 327. Count of Range Sum Segment Tree æ•™å­¸å½±ç‰‡ï¼šSegment Tree Data Structure - Min Max Queries\nSegment Tree èˆ‡ BIT çš„æ¦‚å¿µé›·åŒï¼ŒåŸæœ¬æˆ‘ç”¨ prefix sum é‡åˆ°æ›´æ–°æ™‚è¦ç”¨ O(n) æ•´å€‹é‡å»ºï¼Œä½†å¦‚æœæˆ‘æŠŠå€é–“åˆ‡å°ï¼Œæ¯æ¬¡æ›´æ–°åªè¦å½±éŸ¿åˆ°éƒ¨åˆ†å€é–“ï¼Œå°æ‡‰çš„è®€å–è¦ç¯©é¸ç¬¦åˆçš„å€é–“è®€å–ï¼Œå¦¥å”å¾Œ è®€å–èˆ‡æ›´æ–°éƒ½æ§åˆ¶åœ¨ log(N)ï¼Œä½†å€é–“è©²æ€éº¼åˆ‡ä»¥åŠå¦‚ä½•å¯¦ä½œå‘¢ï¼Ÿ é€™å°±æ˜¯ Segment Tree èˆ‡ BIT ä¸åŒä¹‹è™•\nSegment Tree ç”¨é™£åˆ—å„²å­˜å€é–“å€¼ï¼Œéœ€è¦å…©å€é¡å¤–è¨˜æ†¶é«”ç©ºé–“ï¼ŒåŸé™£åˆ—æ”¾åœ¨æ–°é™£åˆ—çš„æœ€å¾Œï¼Œæ¥è‘—å¾€å‰è·Ÿæ–°å€é–“ (parent = idx/2)ï¼Œå¦‚ä¸‹åœ– (å¾å½±ç‰‡æˆªåœ–è€Œä¾†)\næ‰€ä»¥å€é–“æ˜¯ 2 -\u0026gt; 4 -\u0026gt; 8 é€™æ¨£å¾€ä¸Šç–ŠåŠ \nåˆå§‹åŒ–ç¨‹å¼ç¢¼ç‚º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 class SegmentTree { public: SegmentTree(const std::vector\u0026lt;int\u0026gt;\u0026amp; nums) { offset_ = nums.size(); nodes_.resize(offset_ * 2, 0); // å…ˆæŠŠåŸé™£åˆ—æ”¾åœ¨æœ€å¾Œ for (int i = 0; i \u0026lt; offset_; i++) { nodes_[i + offset_] = nums[i]; } // parent = å·¦ child + å³ child for (int i = offset_ - 1; i \u0026gt; 0; i--) { nodes_[i] = nodes_[i * 2] + nodes_[i * 2 + 1]; } } void update(int index, int val) { // å› ç‚ºæœ‰ç§»å‹•ï¼Œæ‰€ä»¥è¦åŠ ä¸Š offset_ int nodeIdx = index + offset_; int diff = val - nodes_[nodeIdx]; // æ›´æ–°æ™‚è¦æ›´æ–°å…¨éƒ¨çš„ parent while (nodeIdx \u0026gt; 0) { nodes_[nodeIdx] += diff; nodeIdx /= 2; } } private: int offset_; std::vector\u0026lt;int\u0026gt; nodes_; }; é€é O(N) å³å¯å®Œæˆåˆå§‹åŒ–ï¼Œæˆ‘å€‘å°‡åŸé™£åˆ—æ”¾åœ¨æœ€å¾Œï¼Œä¸¦å¾€ä¸Šç–ŠåŠ å‡ºå¤šå€‹å€é–“ï¼ŒUpdate éœ€è¦ O(logN)ï¼Œå› ç‚ºè¦å¾€å‰æŠŠç›¸é—œçš„å€é–“éƒ½è¦æ›´æ–°ä¸€æ¬¡\næ¥è‘—é‡é»æ˜¯ range queryï¼Œå‚³å…¥ left / right (é–‰å€é–“) è¦åœ¨ O(logN) è§£æ±ºï¼Œé‡é»ï¼Œ\nå¦‚æœæˆ‘å€‘æŸ¥æ‰¾çš„ç¯„åœæœƒæ¶µè“‹å®Œæ•´å€é–“ï¼Œå¾€ä¸Šæ‰¾å€é–“å€¼ åä¹‹ï¼Œå‰‡å–å¾—ç•¶ä¸‹çš„å€¼ï¼Œä¸¦å¾€ä¸‹ä¸€å€‹å€é–“é‚é€² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 int sumRange(int left, int right) { int nodeLeftIndex = left + offset_; int nodeRightIndex = right + offset_; int count = 0; while (nodeLeftIndex \u0026lt;= nodeRightIndex) { // å¦‚æœæ˜¯å·¦æŒ‡é‡ï¼Œä¸”æŒ‡åˆ°å€é–“å³å´ï¼Œç•¶ä¸‹å–å€¼ if ((nodeLeftIndex \u0026amp; 1) == 1) { count += nodes_[nodeLeftIndex]; nodeLeftIndex++; } // å¦‚æœæ˜¯å³æŒ‡é‡ï¼Œä¸”æŒ‡åˆ°å€é–“å·¦å´ï¼Œç•¶ä¸‹å–å€¼ if ((nodeRightIndex \u0026amp; 1) == 0) { count += nodes_[nodeRightIndex]; nodeRightIndex--; } nodeLeftIndex /= 2; nodeRightIndex /= 2; } return count; } å¦‚æœæƒ³è¦æŸ¥è©¢æ•´æ®µå€é–“çš„æŒ‡æ¨™ç§»å‹•ï¼Œæˆ‘å€‘å¯ä»¥è§€å¯Ÿå‡ºä¸€å€‹é‡é»\nå¶æ•¸ index éƒ½åœ¨å€é–“çš„å·¦å´ / å¥‡æ•¸ index æ˜¯åœ¨å€é–“çš„å³å´\nå› ç‚ºæˆ‘å€‘æ˜¯ç”¨ left / right å»æ‰¾å€é–“å’Œï¼Œæ‰€ä»¥æˆ‘å€‘è¦æ‰¾left å¾€å³æ‰¾èˆ‡ right å¾€å·¦æ‰¾çš„å…±åŒå€é–“ï¼Œç¸½å…±åˆ†æˆ 4 ç¨®æƒ…æ³è€ƒæ…®\nleft æŒ‡å‘å¶æ•¸ï¼š\nä»£è¡¨æˆ‘å€‘æœƒæ‹¿æ•´å€‹å€é–“ï¼Œå› ç‚ºå€é–“çš„å·¦å´æ˜¯å¶æ•¸ï¼Œç•¶ç›®å‰ left å°±æŒ‡å‘å¶æ•¸ï¼Œä»£è¡¨è¦å–å‡ºæ•´å€‹å€é–“ left æŒ‡å‘å¥‡æ•¸ï¼š\nä»£è¡¨æˆ‘å€‘ä¸å¯ä»¥æ‹¿å€é–“ç•¶ä½œä»£è¡¨ï¼Œå› ç‚ºå¥‡æ•¸æ˜¯å€é–“çš„å³å´ï¼Œå†å¾€ä¸‹å°±åˆ°å¦ä¸€å€‹å€é–“ï¼Œæ‰€ä»¥æˆ‘å€‘è¦ç›´æ¥å–å€¼ right æŒ‡å‘å¶æ•¸ï¼š right è·Ÿ left é‚è¼¯å‰›å¥½ç›¸åï¼Œæˆ‘å€‘åªèƒ½æ‹¿ right å¾€å·¦çš„å€é–“ï¼Œå› ç‚ºå¶æ•¸æ˜¯ parent å·¦å´ï¼Œå†å¾€ä¸‹ç§»å°±åˆ°ä¸‹å€‹å€é–“ï¼Œæ‰€ä»¥è¦æ‹¿ç•¶å‰å€¼ right æŒ‡å‘å¥‡æ•¸ï¼š\nå› ç‚ºå¥‡æ•¸æ˜¯å€é–“çš„å³å´ï¼Œä»£è¡¨æˆ‘å€‘å¯ä»¥æ‹¿æ•´å€‹å€é–“ç‚ºç•¶å‰å€¼ ä»¥ä¸Šåœ–ç‚ºä¾‹\nå·¦æŒ‡é‡æŒ‡å‘ -2ï¼Œæ­¤æ™‚æ˜¯å€é–“çš„å³å´ï¼Œç¬¦åˆæ¢ä»¶ 2ï¼Œæ‹¿å®Œ -2 å¾€ä¸‹ä¸€å€‹å€é–“èµ° / å³æŒ‡é‡åªåœ¨å€é–“å³å´ç¬¦åˆæ¢ä»¶4ï¼Œå¾€ä¸Šä¸€å€‹å€é–“ å·¦æŒ‡é‡æŒçºŒæŒ‡å‘å€é–“å·¦å´ç¬¦åˆæ¢ä»¶1ã€å³æŒ‡é‡æŒ‡å‘å€é–“å³å´ç¬¦åˆæ¢ä»¶4ï¼Œä¸€è·¯å¾€ä¸ŠæŒ‡åˆ°åŒä¸€å€‹å€å¡Šï¼Œç›´æ¥æ‹¿å®Œæ•´æ®µå€é–“ (8~-5) å½±ç‰‡åƒè€ƒè³‡æ–™æ˜¯å·¦é–‰å³é–‹çš„è¨ˆç®—æ–¹å¼ï¼Œä½†é€™æ¨£æˆ‘è¦ºå¾—å†å–å‡ºå€é–“å’Œæ¯”è¼ƒä¸å¥½åšï¼Œæ‰€ä»¥åƒè€ƒ leetcode è§£ç­”èª¿æ•´æˆç›®å‰çš„é–‰å€é–“ç®—æ³•\n307. Range Sum Query - Mutable å®Œæ•´è§£æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 class SegmentTree { public: SegmentTree(const std::vector\u0026lt;int\u0026gt;\u0026amp; nums) { offset_ = nums.size(); nodes_.resize(offset_ * 2, 0); for (int i = 0; i \u0026lt; offset_; i++) { nodes_[i + offset_] = nums[i]; } for (int i = offset_ - 1; i \u0026gt; 0; i--) { nodes_[i] = nodes_[i * 2] + nodes_[i * 2 + 1]; } } void update(int index, int val) { int nodeIdx = index + offset_; int diff = val - nodes_[nodeIdx]; while (nodeIdx \u0026gt; 0) { nodes_[nodeIdx] += diff; nodeIdx /= 2; } } int sumRange(int left, int right) { int nodeLeftIndex = left + offset_; int nodeRightIndex = right + offset_; int count = 0; while (nodeLeftIndex \u0026lt;= nodeRightIndex) { if ((nodeLeftIndex \u0026amp; 1) == 1) { count += nodes_[nodeLeftIndex]; nodeLeftIndex++; } if ((nodeRightIndex \u0026amp; 1) == 0) { count += nodes_[nodeRightIndex]; nodeRightIndex--; } nodeLeftIndex /= 2; nodeRightIndex /= 2; } return count; } private: int offset_; std::vector\u0026lt;int\u0026gt; nodes_; }; class NumArray { public: NumArray(vector\u0026lt;int\u0026gt;\u0026amp; nums) { tree_ = new SegmentTree(nums); } void update(int index, int val) { tree_-\u0026gt;update(index, val); } int sumRange(int left, int right) { return tree_-\u0026gt;sumRange(left, right); } private: SegmentTree* tree_; }; /** * Your NumArray object will be instantiated and called as such: * NumArray* obj = new NumArray(nums); * obj-\u0026gt;update(index,val); * int param_2 = obj-\u0026gt;sumRange(left,right); */ Binary Index Tree 1994 å¹´çš„è«–æ–‡ A New Data Structure for Cumulative Frequency Tables / æˆ‘è¦ºå¾—è¬›å¾—å¾ˆå¥½çš„å½±ç‰‡ Fenwick Tree (Binary Index Tree) - Quick Tutorial and Source Code Explanation\né€™å¼µåœ–æ˜¯å¾è«–æ–‡æˆªåœ–è€Œä¾†ï¼Œå¯¦ä½œæŠ€å·§éå¸¸å·§å¦™ï¼Œä»–åˆ©ç”¨ Last Significant Bit (LSB) ä¾†æ±ºå®šå€é–“çš„ç¯„åœï¼Œå¦‚æœ LSB æ˜¯ xxx1ï¼Œå‰‡åªå„²å­˜ç•¶å‰ä¸€å€‹æ•¸ï¼Œå¦‚æœ LSB æ˜¯ xx10ï¼Œå‰‡å„²å­˜ç•¶å‰å…©å€‹æ•¸ï¼Œä»¥æ­¤é¡æ¨ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ° 1, 3 ç­‰åªæœƒå„²å­˜ç•¶å‰ 1 å€‹æ•¸ã€8 æœƒå„²å­˜å¾€å‰ 8 å€‹æ•¸\næ‰€ä»¥æ›´æ–°æ™‚æœƒéœ€è¦æ›´æ–°æ‰€æœ‰ç›¸é—œå€é–“ï¼Œä¸Šé¢é€™å¼µåœ–æ˜¯ä»£è¡¨ç•¶ä½ æ›´æ–° index i æ™‚ï¼Œéœ€è¦å¾€ä¸Šèª¿æ•´çš„ bit indexï¼Œä¾‹å¦‚æ›´æ–° idx 1 æ™‚ï¼Œå› ç‚º bit[2]ã€bit[4]ã€bit[8] éƒ½æœ‰åŒ…å« idx 1ï¼Œæ‰€ä»¥éƒ½è¦ä¸€ä½µæ›´æ–°\nå¯¦ä½œæ–¹é¢éå¸¸ç°¡å–®ï¼Œé€é 2 è£œæ•¸ i \u0026amp; -i å³å¯å–å¾— LSB\n1 2 3 4 5 6 7 8 9 // 1: 0001 //-1: 1111 // 1 \u0026amp; -1 =\u0026gt; 0001 // 6: 0110 //-6: 1010 // 6 \u0026amp; -6 =\u0026gt; 0010 int getParent(int i) { return i + (i \u0026amp; -i); } è®“æˆ‘å€‘çœ‹æŸ¥è©¢æœƒè®Šå¾—å¦‚ä½•ï¼š åœ–ç‰‡è¡¨é”å¦‚æœä½ è¦æŸå€‹ prefix sumï¼Œä½ å¿…é ˆå¾€å‰è¼ªè©¢çš„ indexï¼Œä¾‹å¦‚è¦æ‰¾ idx 1~9 çš„ prefix sumï¼Œå‰‡éœ€è¦ bit[9] + bit[8]ï¼Œæ­é…ä¸Šä¸€å¼µåœ– bit[9] åªæœ‰å„²å­˜ idx 9 é€™å€‹å…ƒç´ ï¼Œè€Œ bit[8] å„²å­˜äº† idx 1-8 å€‹å…ƒç´ \nå¯¦ä½œæ–¹é¢åŒæ¨£é€é 2 è£œæ•¸ï¼Œåªæ˜¯è®Šæˆå¾€ä¸‹æ¸›\n1 2 3 int getNextInterval(int i) { return i - (i \u0026amp; -i); } æ•´é«”å¯¦ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 class BIT { public: BIT(const std::vector\u0026lt;int\u0026gt;\u0026amp; nums) { int size = nums.size(); // index å¾ 1 é–‹å§‹æ¯”è¼ƒå¥½è¨ˆç®— bit_.resize(size + 1, 0); arr_.resize(size, 0); // åˆå§‹åŒ–åªè¦å¾€ä¸‹ä¸€å€‹ parent åŠ  // å¾Œé¢ iterate æœƒç–Šä¸Šå» for (int i = 0; i \u0026lt; size; i++) { int bitIdx = i + 1; bit_[bitIdx] += nums[i]; arr_[i] = nums[i]; int parent = getParent(bitIdx); if (parent \u0026lt; bit_.size()) { bit_[parent] += bit_[bitIdx]; } } } void update(int index, int val) { int diff = val - arr_[index]; arr_[index] = val; index++; // æ›´æ–°è¨˜å¾—è¦å…¨éƒ¨åŒ…å«çš„å€é–“éƒ½æ›´æ–° while (index \u0026lt; bit_.size()) { bit_[index] += diff; index = getParent(index); } } int prefixSum(int index) { int count = 0; index++; // å–å€¼è¦å¾€å‰æ¨ while (index \u0026gt; 0) { count += bit_[index]; index = getNextInterval(index); } return count; } private: std::vector\u0026lt;int\u0026gt; bit_; std::vector\u0026lt;int\u0026gt; arr_; int getParent(int i) { return i + (i \u0026amp; -i); } int getNextInterval(int i) { return i - (i \u0026amp; -i); } }; class NumArray { public: NumArray(vector\u0026lt;int\u0026gt;\u0026amp; nums) { tree_ = new BIT(nums); } void update(int index, int val) { tree_-\u0026gt;update(index, val); } int sumRange(int left, int right) { return tree_-\u0026gt;prefixSum(right) - tree_-\u0026gt;prefixSum(left - 1); } private: BIT* tree_; }; å°çµï¼šBIT vs Segment Tree æ•´ç†ä¸€ä¸‹å…©è€…\næ¯”è¼ƒ æ“ä½œ Segment Tree Binary Index Tree è¨˜æ†¶é«”ç©ºé–“ 2 * n n åˆå§‹åŒ– O(n) O(n) æŸ¥è©¢ O(logN) O(logN) æ›´æ–° O(logN) O(logN) æ­¤å¤–ï¼Œä½¿ç”¨ä¸Šå…©è€…æœ‰å…±åŒä¾·é™ æ–°å¢ / ç§»é™¤å…ƒç´ éœ€è¦é‡æ–°åˆå§‹åŒ–\nå…©è€…å·®ç•° å…©è€…éƒ½å¯ä»¥è§£æ±º #307 é€™é“é¡Œç›®ï¼Œä½†çœ‹ä¼¼ç›¸åŒä½†é‚„æ˜¯æœ‰å·®ç•°ä¹‹è™•ï¼Œç°¡å–®ä¾†èªª Segment Tree ç”¨é€”æ›´å»£ï¼ŒBIT åªèƒ½è§£æ±º Prefix Sum è¨ˆç®—\nä¾‹å¦‚ Segment Tree é‚„å¯ä»¥è§£æ±ºå€é–“æœ€å°å€¼/å€é–“æœ€å¤§å€¼ï¼Œè€Œ BIT æ˜¯åšä¸åˆ°çš„ï¼Œç‚ºä»€éº¼ï¼Ÿ\nå› ç‚º BIT ä¸¦ä¸æ˜¯å„²å­˜æ¯ä¸€å€‹å€¼ï¼Œè€Œæ˜¯åœ¨åˆå§‹åŒ–å°±ä»¥å€é–“çš„å½¢å¼ä¿å­˜ï¼Œå¦‚æœæ˜¯åŠ æ³•é€™ç¨® invertible ç®—æ³•ï¼Œæ„å³æˆ‘å€é–“å„²å­˜ (a+b), æˆ‘å¯ä»¥é€é (a+b) - a é‚„åŸ b çš„å€¼ï¼›\nä½†æ±‚æ¥µå€¼æ˜¯ non invertableï¼Œå¦‚æœè¦ç”¨ BIT æ±‚æ¥µå€¼ï¼Œé‚£éº¼åœ¨å€é–“è¨ˆç®—æ™‚å°±ç”¨å„²å­˜æ¥µå€¼ï¼Œé€™æ¨£æ›´æ–°æ™‚å°±æœƒå‡ºéŒ¯\n1 2 3 4 5 åŸé™£åˆ—ï¼š[3, 2] BIT: [, 3, 3(ä¿å­˜å€é–“æ¥µå€¼)] update (0, 1) BIT: [, 1, ?] =\u0026gt; ç„¡æ³•è¨ˆç®— æ‰€ä»¥ BIT ç”¨é€”æ¯”è¼ƒä¾·é™ï¼Œä½†å„ªé»æ˜¯è¨˜æ†¶é«”ç©ºé–“å°ï¼Œè€Œä¸” bitwise çš„è¨ˆç®—é€Ÿåº¦æœƒå¿«æ›´å¤š\næœ‰ä¸€ç¯‡è«–æ–‡å¯«å¯ä»¥ç”¨å…©å€‹ BIT å¯¦ä½œå€é–“æ¥µå€¼çš„æŸ¥è©¢ï¼Œçµæœé‚„æ˜¯æ¯” Segment Tree å¿«ä¸Šè¨±å¤šï¼Œå¯ä»¥åƒè€ƒçœ‹çœ‹ Efficient Range Minimum Queries - using Binary Indexed Trees\n","date":"2022-05-23T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-05-23-%E7%AE%97%E6%B3%95segment-tree-%E8%88%87-binary-indexed-tree-%E8%A7%A3%E9%A1%8C%E6%95%B4%E7%90%86/","title":"ã€ç®—æ³•ã€‘Segment Tree èˆ‡ Binary Indexed Tree è§£é¡Œæ•´ç†"},{"content":"é—œæ–¼ MySQL Lock ä¾†ä¾†å›å›å¯«äº†ä¹Ÿæœ‰å¹¾ç¯‡ï¼Œæ¯æ¬¡çœ‹éƒ½æœ‰ä¸åŒçš„ç™¼ç¾ï¼Œé€™æ¬¡ç‚ºäº†æº–å‚™å…¬å¸å…§éƒ¨åˆ†äº«ï¼Œé‡æ–°å†ç¿»é–±ä¸€æ¬¡åˆæ‰¾åˆ°ä¸€äº›æ–°çš„æœ‰è¶£ç™¼ç¾ï¼Œä»¥ä¸‹å°‡ç›¡å¯èƒ½å®Œæ•´çš„è§£æ MySQL Lock èˆ‡ Index çš„é—œä¿‚ï¼Œæ€æ¨£çš„æŸ¥è©¢æœƒæ‹¿åˆ°æ€æ¨£çš„é–ï¼Œä»¥åŠæ€æ¨£çš„æŸ¥è©¢åˆå¯èƒ½äº’ç›¸ Deadlock\næ–‡ç« ä¸»è¦å—å•Ÿç™¼æ–¼ è§£å†³æ­»é”ä¹‹è·¯ï¼ˆç»ˆç»“ç¯‡ï¼‰ - å†è§æ­»é”ï¼Œå°æ‡‰çš„å¯¦é©—å¯ä»¥çœ‹ç¨‹å¼ç¢¼ sj82516/mysql-deadlock-testï¼Œå…ˆèªªçµè«–ï¼Œåœ¨ DML (æ›´æ–°ã€åˆªé™¤ã€æ’å…¥)çš„æ“ä½œä¸­ï¼ŒLock æœƒèˆ‡å¥—ç”¨çš„ Index æœ‰é—œï¼Œåœ¨ MySQL ä¸­ Index æœ‰å¹¾ç¨®\nClustered Index:\né€šå¸¸æ˜¯ Primary Key Unique Secondary Index:\nå¦‚æœæ²’æœ‰ Primary Keyï¼Œå‰‡ Unique Secondary Index æœƒæ˜¯ Clustered Indexï¼Œè¡Œç‚ºèˆ‡ Clustered Index é›·åŒï¼Œä¸é¡å¤–è´…è¿° Non Unique Secondary Index ä»¥ä¸‹å°‡é‡é»åˆ†æ Clustered Index / Non Unique Secondary Index å°æ–¼ MySQL æ“ä½œæœ‰ä»€éº¼ä¸åŒçš„å½±éŸ¿ï¼Œåœ¨ Read Committed ç°¡ç¨± RC) èˆ‡ Repeatable Read (ç°¡ç¨± RR) ä¸‹åˆæœ‰æ€æ¨£çš„ä¸åŒè¡Œç‚ºï¼Œå¯¦é©—é è¨­æ˜¯ 5.7 + Repeatable Read (MySQL é è¨­)\nClustered Index å…ˆä¾†ä¸€é¡Œç°¡å–®çš„æš–èº«é¡Œï¼Œä»¥ä¸‹å…©å€‹ Transaction ç‚ºä»€éº¼æœƒ Deadlock è¦æ»¿è¶³ Deadlock éœ€è¦æœ‰å››å€‹æ¢ä»¶\nno preemption hold and wait mutual exclusion circular waiting åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼ŒMySQL åœ¨ RR ä¸‹è¦ update æœƒå…ˆå–å¾— exclusive lockï¼Œå…©å€‹ Transaction æ‰‹ä¸Šéƒ½æ‹¿äº†å°æ–¹æƒ³è¦çš„è³‡æºå»ä¹Ÿä¸éƒ½æœƒå…ˆæ”¾é–‹æ‰‹ä¸Šçš„é–ï¼Œå°è‡´ Deadlock ç›´æ¥å¾åœ–ç‰‡å¾ˆå®¹æ˜“çœ‹å‡ºå½¼æ­¤ Deadlockï¼Œä½†æ­£å¼ç’°å¢ƒä¸­å¤šç­† Transaction äº¤é›œï¼Œè©²å¦‚ä½•æ‰¾å‡º Deadlock å‘¢ï¼Ÿ\n1. å¦‚ä½• Debug Deadlock MySQL æœ‰å¹¾å€‹ç›¸é—œåƒæ•¸\ninnodb_deadlock_detect: æ˜¯å¦åµæ¸¬ deadlockï¼Œé è¨­é–‹å•Ÿ innodb_lock_wait_timeout: å¦‚æœæ²’æœ‰é–‹å•Ÿ Deadlock detectï¼Œå»ºè­°è¨­å®šè¼ƒçŸ­çš„ wait timeout å¦å‰‡æœƒä¸€ç›´ç­‰åˆ° innodb_print_all_deadlocks: å°‡æ‰€æœ‰ Deadlock éŒ¯èª¤è¼¸å‡ºè‡³ error log å¦‚æœæ²’æœ‰è¼¸å‡º Deadlock errorï¼Œå¯ä»¥ç”¨ \u0026gt; SHOW ENGINE INNODB STATUS è¼¸å‡ºï¼Œå…¶ä¸­æœ‰å…©å€‹å€å¡Š deadlock é¡¯ç¤ºæœ€è¿‘ä¸€ç­† deadlock éŒ¯èª¤ï¼Œtransaction å‰‡æœƒé¡¯ç¤ºç›®å‰åœ¨ç­‰å¾… lock çš„ transaction\n1.1 å¯¦éš›é–±è®€ Deadlock 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 LATEST DETECTED DEADLOCK ------------------------ 2022-04-26 09:33:29 0x40de5bc700 *** (1) TRANSACTION: TRANSACTION 9597, ACTIVE 3 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1 MySQL thread id 1034, OS thread handle 278338676480, query id 14980 172.17.0.1 root updating `UPDATE teachers SET teachers.age = 10 WHERE teachers.id = 5` *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9597 lock_mode X locks rec but not gap waiting Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 8; hex 8000000000000005; asc ;; 1: len 6; hex 00000000257c; asc %|;; 2: len 7; hex 23000001c017d1; asc # ;; 3: len 1; hex 62; asc b;; 4: len 4; hex 80000010; asc ;; 5: SQL NULL; *** (2) TRANSACTION: TRANSACTION 9596, ACTIVE 3 sec starting index read mysql tables in use 1, locked 1 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1 MySQL thread id 1033, OS thread handle 278608463616, query id 14979 172.17.0.1 root updating `UPDATE teachers SET teachers.age = 6 WHERE teachers.id = 1` *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 lock_mode X locks rec but not gap Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 8; hex 8000000000000005; asc ;; -\u0026gt; indexï¼Œç”¨ 16 é€²ä½è¡¨ç¤ºï¼Œé€™é‚Šæ˜¯æŒ‡ id: 5 1: len 6; hex 00000000257c; asc %|;; 2: len 7; hex 23000001c017d1; asc # ;; 3: len 1; hex 62; asc b;; 4: len 4; hex 80000010; asc ;; 5: SQL NULL; *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 `lock_mode X locks rec but not gap waiting` Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 8; hex 8000000000000001; asc ;; 1: len 6; hex 00000000257d; asc %};; 2: len 7; hex 22000001cc02e5; asc \u0026#34; ;; 3: len 1; hex 61; asc a;; 4: len 4; hex 8000000f; asc ;; 5: SQL NULL; *** WE ROLL BACK TRANSACTION (2) ------------ é€™éƒ¨åˆ†å…§å®¹åƒè€ƒ MySQLæ­»é”é—®é¢˜å¦‚ä½•åˆ†æï¼Œé‡é»çœ‹é€™ä¸€æ®µ\nRECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 lock_mode X locks rec but not gap waiting å°ˆæŒ‡ row lock\nRecord lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 8; hex 8000000000000001; asc ;; -\u0026gt; indexï¼Œç”¨ 16 é€²ä½è¡¨ç¤ºï¼Œé€™é‚Šæ˜¯æŒ‡ id: 1\nï¼Œæˆ‘å€‘å¯ä»¥å¾ log ä¸­çœ‹å‡ºæ“ä½œ / æ‰‹ä¸Šçš„ lock / ç­‰å¾…çš„ lock / Lock åœ¨å“ªä¸€å€‹ row\n2. å–å¾— Lock çš„é †åºæ€§ å¦‚æœæŸ¥è©¢çš„æ¢ä»¶å‘½ä¸­å¤šç­†ï¼Œé‚£ Lock æœƒæ€éº¼å–å¾—å‘¢ï¼Ÿ æ¥è‘—çœ‹ä»¥ä¸‹æ¡ˆä¾‹ æ ¹æ“š MySQL æ–‡ä»¶ï¼Œæœƒæ ¹æ“š Order By çš„æŒ‡å®šæ¢ä»¶èˆ‡ Index æœ¬èº«é †åºæ€§ä¸€è¡Œä¸€è¡Œé–èµ·ä¾†\nIf an UPDATE statement includes an ORDER BY clause, the rows are updated in the order specified by the clause. This can be useful in certain situations that might otherwise result in an error. Suppose that a table t contains a column id that has a unique index. The following statement could fail with a duplicate-key error, depending on the order in which rows are updated\nå¾ Deadlock Log å¯ä»¥æ¸…æ¥šçœ‹åˆ° id 2 / id 5 è¢«äº’ç›¸é–ä½\n1 2 3 4 5 6 7 8 9 *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 278 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9676 lock_mode X waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 8; hex `8000000000000002`; asc ;; ------ *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 278 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9675 lock_mode X waiting Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 8; hex `8000000000000005`; asc ;; 2.1 å»ºç«‹ Index æ™‚æ±ºå®šé †åº ç•¶å»ºç«‹ MySQL Index ä¹Ÿå¯ä»¥æŒ‡å®šé †åºï¼Œä½†éœ€è¦æ³¨æ„ MySQL 5.7 æœƒå¿½è¦– (å…¨éƒ¨éƒ½æ˜¯ asc) åªæœ‰åœ¨ MySQL 8.0 ä»¥ä¸Šæ‰æ”¯æ´ï¼Œæ‰€ä»¥ä»¥ä¸‹æ¡ˆä¾‹åªç™¼ç”Ÿåœ¨ MySQL 8.0\næˆ‘å€‘å¯ä»¥é€é USE INDEX() æŒ‡å®šåŸ·è¡Œæ™‚çš„ Index (5.7 æ–‡ä»¶) A key_part specification can end with ASC or DESC. These keywords are permitted for future extensions for specifying ascending or descending index value storage. Currently, they are parsed but ignored; index values are always stored in ascending order.\n2.2 æ°å·§å…©å€‹ Index é †åºç›¸ä»¿ 2.1 æ¡ˆä¾‹ä¸­æˆ‘å€‘å¾ˆåˆ»æ„è®“ Index åŒä¸€å€‹æ¬„ä½æ¬„ä½ä½†é †åºå‰›å¥½ç›¸åï¼Œä½†å¦‚æœæ˜¯å…©å€‹ä¸åŒ Index è€Œè³‡æ–™å¯«å…¥æ™‚è®“é †åºæ°å¥½ç›¸åå‘¢ï¼Ÿ åœ¨å»ºç«‹è³‡æ–™æ™‚ï¼Œid è·Ÿ name çš„é †åºå‰›å¥½ç›¸åï¼Œä¹Ÿå°±æ˜¯\n1 id1 \u0026gt; id2 \u0026amp;\u0026amp; name1 \u0026lt; name2ï¼Œä¾‹å¦‚ (1, \u0026#34;zz\u0026#34;) (2, \u0026#34;zx\u0026#34;) é€™æ¨£ä¹Ÿæœƒç™¼ç”Ÿ Deadlock!\n3. æŸ¥è©¢æ²’æœ‰å‘½ä¸­ : Gap Lock å¦‚æœæŸ¥è©¢æ²’æœ‰å‘½ä¸­ï¼Œæ­¤æ™‚ MySQL åœ¨ RR æƒ…æ³ä¸‹æœƒå–å¾— Gap Lockï¼Œæ‰€è¬‚çš„ Gap æ˜¯åœ¨å·²å­˜åœ¨æ¬„ä½ä¹‹é–“çš„ç¸«éš™ï¼Œç‚ºäº†é¿å…å¹»è®€ MySQL æœƒé–ä½ Gap ä¸è®“å…¶ä»– Transaction æ’å…¥è³‡æ–™\né€™é‚Šç‰¹åˆ¥ä»‹ç´¹å…©å€‹é–å®šå€é–“çš„ Lockï¼Œåˆ†åˆ¥æ˜¯ Gap Lock / Insert Intention Lock\nInsert Intention Lock æ•…åæ€ç¾©æ˜¯æ˜¯æ’å…¥å‰æœƒé–å®šè©²å€é–“ é€™å…©ç¨® Lock ç‰¹åˆ¥åœ¨æ–¼ä¸æœƒæ’æ“ è‡ªå·±äººï¼Œä¾‹å¦‚ Gap Lock ä¸æœƒé˜»æ“‹ Gap Lock / Insert Intention Lock ä¸æœƒé˜»æ“‹ Insert intention Lockï¼Œä½†æ˜¯ Insert Intention Lock è·Ÿ Gap Lock äº’æ–¥ï¼ŒåŸå› æ˜¯å€é–“å¯èƒ½å¾ˆå¤§ï¼Œç‚ºäº†æå‡æ€§èƒ½ï¼Œåœ¨åŒä¸€å€‹å€é–“å¯ä»¥åŒæ™‚æ’å…¥æ–°è³‡æ–™ï¼Œå¦‚æœçœŸçš„æœ‰é•å Unique Key å‰‡æœƒæœ‰åŸæœ¬çš„é‡è¤‡æ€§æª¢æŸ¥é˜»æ“‹ï¼ŒUpdate ä¹Ÿæ˜¯ æœ‰ä¸€å€‹å ´æ™¯æ˜¯ã€Œæˆ‘å€‘å¸Œæœ›æ›´æ–°æŸä¸€ç­†è³‡æ–™ï¼Œç™¼ç¾è³‡æ–™ä¸åœ¨å‰‡å¯«å…¥ã€ï¼Œå¦‚ä»¥ä¸‹ç¯„ä¾‹å‰‡æœƒé€ æˆ Deadlock å› ç‚º id 6 / 10 åœ¨ update æ™‚éƒ½å–å¾—äº† Gap Lockï¼Œæ¥è‘—è¦ Insert å–å¾— Insert Intention Lock å»å› ç‚ºé›™æ–¹éƒ½é‚„æ¡æœ‰ Gap Lock è€Œç„¡æ³•å¯«å…¥ï¼Œè®“æˆ‘å€‘çœ‹å…·é«”çš„ Deadlock ç´°ç¯€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9700 `lock_mode X insert intention waiting` Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc `supremum`;; *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9699 `lock_mode X` Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc `supremum`;; *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9699 lock_mode X insert intention waiting Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc supremum;; å¯ä»¥çœ‹åˆ°é›™æ–¹éƒ½åœ¨ç­‰ lock_mode X insert intention waitingï¼ŒæŒ‡å®šçš„ row æ˜¯ supermum é€™æ˜¯ä»£è¡¨æœ€å¾Œä¸€å€‹å€é–“ï¼Œå€é–“å¤§è‡´é•·ä»¥ä¸‹é€™èˆ¬\n1 2 3 4 (negative infinity, ç¬¬ä¸€ç­†] (ç¬¬ä¸€ç­†, ç¬¬äºŒç­†] .... (æœ€å¾Œä¸€ç­†, positive infinity) æ‰€ä»¥åŒæ¨£çš„ query åªæ˜¯åŸå§‹è³‡æ–™æ”¹è®Šè½åœ¨ä¸åŒå€é–“ï¼Œå°±ä¸æœƒæœ‰ Deadlock å¦‚ä»¥ä¸‹ 4. ç¯„åœæŸ¥è©¢ï¼šé–å®šæ‰¾éçš„æ¯ç­†è³‡æ–™å³ä½¿æ¢ä»¶ä¸åˆ æ¥ä¸‹ä¾†çœ‹ä¸€å€‹ RR è »åš‡äººçš„ä¸€å€‹ç‰¹æ€§ï¼Œåƒè€ƒæ–‡ä»¶ 15.7.2.1 Transaction Isolation Levels\n\u0026ldquo;When using the default REPEATABLE READ isolation level, the first UPDATE acquires an x-lock on each row that it reads and does not release any of them\nä¹Ÿå°±æ˜¯èªª where condition å‡ä½¿æ˜¯ç¯„åœæœå°‹ï¼ŒRR æœƒæŠŠæœå°‹åˆ°çš„ç¯„åœå…¨éƒ¨é–æ­»ï¼Œç›´åˆ° transaction çµæŸ!\nè®“æˆ‘å€‘çœ‹ä»¥ä¸‹æ¡ˆä¾‹ Update çš„æ¢ä»¶æ²’æœ‰å‘½ä¸­ä½†æ˜¯å…¨éƒ¨éƒ½è¢« Lockï¼Œè¦ update / insert éƒ½ä¸è¡Œï¼Œç›¸å°çš„\nRC åœ¨æª¢æŸ¥ä¸ç¬¦åˆæ¢ä»¶å°±æœƒ releaseï¼Œåœ¨åšå¤§è¦æ¨¡çš„ Update / Delete è¨˜å¾—è¦ç”¨ RC æœƒæ¯”è¼ƒå¥½\nNon Unique Index ä¸Šé¢çš„ç¯„ä¾‹éƒ½æ˜¯ Clustered Indexï¼ŒMySQL æ”¯æ´ Secondary Indexï¼Œå…¶ä¸­ Unique Secondary Index èˆ‡ Clustered Index è¡Œç‚ºé¡ä¼¼ï¼Œå°±ä¸å¦å¤–è´…è¿°ï¼Œä½†æ˜¯ Non Unique Index è¦ç¨å¾®ç•™æ„\n1. æŸ¥è©¢å‘½ä¸­ï¼šä¾ç„¶æœƒ Gap Lock åœ¨ä¸€é–‹å§‹çš„ç¯„ä¾‹ï¼Œå¦‚æœ Clustered Index æŸ¥è©¢æœ‰å‘½ä¸­åªæœƒé–é‚£ä¸€è¡Œ (ex. update id = 1)ï¼Œä½†å¦‚æœ Non Unique Index å³ä½¿å®Œå…¨å‘½ä¸­ï¼Œä¹Ÿæœƒé€£åŒ Gap ä¸€èµ·é–èµ·ä¾† (Next Key Lock)\né€™é‚Š Lock æ¯”è¼ƒå¤šï¼Œéœ€æ³¨æ„ Secondary Index æœƒè¢«é–ä¹‹å¤–ï¼Œå°æ‡‰çš„ Clustered Index ä¹Ÿæœƒè¢«é–ï¼Œé€™é‚Š age é–å®š 10 ä»¥åŠå‰é¢çš„å€é–“ï¼Œæ‰€ä»¥è¦æ’å…¥ age: 9 å°±æœƒå¤±æ•—ï¼›é‹ç”¨ä¸Šé¢çš„æŠ€å·§ï¼Œage åˆ‡æ›åˆ°ä¸åŒå€é–“å°±å¯ä»¥æˆåŠŸæ’å…¥\nForeign Keyï¼šæœƒæœ‰ Share Lock If a FOREIGN KEY constraint is defined on a table, any insert, update, or delete that requires the constraint condition to be checked sets shared record-level locks\næ›´æ–°æ¬„ä½æ™‚ Foreign Key ä¹Ÿæœƒè¢«é–ä½ï¼Œä¹‹å‰æœ‰ç´€éŒ„å°±ä¸è´…è¿° MySQL Deadlock å•é¡Œæ’æŸ¥èˆ‡è™•ç†\nç¸½çµèˆ‡å»ºè­° å¹¾é»å»ºè­°\nå¢åŠ  Index è¦ä»”ç´°è©•ä¼°ï¼ŒSecondary Index æœƒé€ æˆå¯«å…¥æ•ˆèƒ½ä¸‹é™ï¼Œé«”ç¾æ–¼ lock çš„ä½¿ç”¨ å¦‚æœæ˜¯ç”¨ ORMï¼Œè¨˜å¾—æª¢æŸ¥ Query å¦‚æœéœ€è¦ç”¨ Secondary Index æ”¹è®Šæ¬„ä½ï¼Œå»ºè­°å¯ä»¥ç”¨æ‰¹æ¬¡ (RoR å°±æ˜¯ find_in_batch) æˆ–æ˜¯å…ˆç¯©é¸å‡º Primary Key (é è¨­ select ä¸æœƒæœ‰ lock)ï¼Œå†ä½¿ç”¨ Primary Key ç•¶ä½œä¿®æ”¹æ¢ä»¶é¿å… Gap Lock æ²’äº‹å°±ç”¨ Read Committed é€²éšï¼šç‚ºä»€éº¼ä¸è¦é è¨­ Read Committed ? æ—¢ç„¶ Repeatable Read æœƒæœ‰é€™éº¼å¤šæ•ˆèƒ½ç–‘æ…®ï¼Œæ›´æ–°æ™‚é€£ where æ¢ä»¶ä¸ç¬¦åˆçš„è¡Œéƒ½æœƒé–ã€é‚„æœƒæœ‰ä¸é æœŸçš„ Gap Lockï¼Œé‚£ç‚ºä»€éº¼é è¨­ä¸è¦æ”¹æˆ Read Committed ?\nåœ¨ PostgreSQL ç¢ºå¯¦å¦‚æ­¤ï¼ŒPQ 9.3. Read Committed Isolation Levelæåˆ°\nThe partial transaction isolation provided by Read Committed level is adequate for many applications, and this level is fast and simple to use\næˆ‘åœ¨æŸ¥é–± MySQL ç›¸é—œè³‡æ–™ï¼Œä¹Ÿæœ‰æŸ¥åˆ° Percona ä¸€ç¯‡æ–‡ç« æåŠ MySQL é è¨­æ‡‰è©²è¦æ”¹æˆ Read Committed æ¯”è¼ƒå¥½ MySQL performance implications of InnoDB isolation modes\nIn general I think good practice is to use READ COMITTED isolation mode as default and change to REPEATABLE READ for those applications or transactions which require it.\né‚£ MySQL å®˜æ–¹æ€éº¼èªªï¼Œæˆ‘æ‰¾åˆ°ä¸€ç¯‡å®˜æ–¹çš„ blog Performance Impact of InnoDB Transaction Isolation Modes in MySQL 5.7 å»ºè­°åˆ°\nFor short running queries and transactions, use the default level of REPEATABLE-READ. For long running queries and transactions, use the level of READ-COMMITTED è£¡é¢æœ‰å¦ä¸€ç¯‡æ–‡åšäº† Benchmark éå¸¸æœ‰è¶£ MySQL Performance : Impact of InnoDB Transaction Isolation Modes in MySQL 5.7ï¼Œå¾ MySQL å…§éƒ¨çš„ Lock æ•¸é‡èˆ‡æ“åš QPS è¡¡é‡ä¸åŒ isolation levelï¼Œæˆ‘æœ¬ä¾†ä»¥ç‚º Read Committed åœ¨å¢åˆªæŸ¥æ”¹æœƒç¢¾å£“ Repeatable Readï¼Œä½†ç™¼ç¾ç›¡ç„¶æ²’æœ‰ï¼Œåè€Œå› ç‚º Read Committed åœ¨æ¯æ¬¡ Read éƒ½æœƒç”¢ç”Ÿæ–°çš„ MVCC ç‰ˆæœ¬è€Œæœ‰æ›´å¤šçš„å…§éƒ¨ Lockï¼Œéå¸¸æœ‰è¶£\næ‰€ä»¥ç¸½çµå®˜æ–¹éƒ¨è½æ ¼å»ºè­°ï¼Œé è¨­é‚„æ˜¯ä¿ç•™ RR æ™®éæ•ˆèƒ½åè€Œæ›´å¥½ï¼Œåªæœ‰åœ¨é•·æ™‚é–“çš„ Job å†æ”¹æˆ RC å³å¯\n","date":"2022-04-25T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/","title":"ã€MySQLã€‘Lock èˆ‡ Index é—œä¿‚å’Œ Deadlock åˆ†æ"},{"content":"DDIA - ã€ŠDesigning Data-Intensive Applicationsã€‹ï¼Œé€™æœ¬æ›¸å€¼å¾—æœ‰ä¸€å€‹å°ˆé–€çš„ç¸®å¯« XD åœ¨å¹¾å¹´å‰å‰›å‡ºç¤¾æœƒæ™‚æœ‰å…ˆç¡¬å•ƒäº†å¤§åŠéƒ¨åˆ†ï¼Œåœ¨å¾€å¾Œçš„å·¥ä½œä¸Šé€™äº›è§€å¿µä¸æ–·çš„è¢«ä½¿ç”¨ä¸Šï¼Œä¸€ç›´å¾ˆæƒ³å†é‡æ–°æ›´æ·±å…¥ç†è§£é€™æœ¬æ›¸ï¼›\nå‰›å¥½æœ€è¿‘è¦é–‹å§‹æº–å‚™å…¬å¸å…§éƒ¨åˆ†äº«ï¼Œåˆ†äº«ä¸€äº›é—œæ–¼è³‡æ–™åº«çš„äº‹æƒ…ï¼Œé‡æ–°ç¿»é–±é€™æœ¬æ›¸ï¼Œä¸¦å¯«ä¸‹è®€æ›¸å¿ƒå¾—ï¼Œä»¥ä¸‹å…§å®¹åŒ…å«åœ–ç‰‡éƒ½æ˜¯æ•´ç†è‡ªç›¸é—œè³‡æ–™\nä»¥ä¸‹å°‡æè¿°\næœ€ç°¡å–®å¯¦ä½œè³‡æ–™åº«çš„æ–¹å¼ SSLTable / B Tree å„²å­˜æ–¹å¼èˆ‡æ¯”è¼ƒ Column Storage Storage and Retrieval è³‡æ–™åº«æœ€åŸºæœ¬çš„æ ¸å¿ƒåŠŸèƒ½\nçµ¦ä½ ä¸€äº›è³‡æ–™ï¼Œå¹«æˆ‘ä¿å­˜ - storage æˆ‘æ™šé»è·Ÿä½ æ‹¿é€™äº›è³‡æ–™ï¼Œè¨˜å¾—çµ¦æˆ‘ - retrieval å¦‚æœåƒ…è€ƒæ…®é€™å…©å€‹åŠŸèƒ½ï¼Œå¦‚ä½•ç”¨æœ€ç°¡å–®çš„æ–¹å¼å¯¦ä½œå‘¢ï¼Ÿ\nä¸€. æœ€ç°¡å–®çš„è³‡æ–™åº« - Log Structured Storage ä»Šå¤©å¯¦ä½œä¸€å€‹ key-value DBï¼Œæˆ‘å€‘ç”¨å…©å€‹ bash command å°±å¯ä»¥å®Œæˆ\n1 2 3 4 5 6 7 8 #!/bin/bash db_set() { echo \u0026#34;$1,$2\u0026#34; \u0026gt;\u0026gt; database } db_get() { grep \u0026#34;^$1,\u0026#34; database | sed -e \u0026#34;s/^$1,//\u0026#34; | tail -n 1 } å‘¼å« db_set æ™‚ï¼Œå¾ˆå–®ç´”ä¸€ç›´æŠŠå€¼ append åˆ°æª”æ¡ˆçš„æœ€å¾Œï¼›å¦‚æœè¦å–å‡ºï¼Œå‰‡å¾æª”æ¡ˆçš„æœ€å¾Œé–‹å§‹æ¯”å° keyï¼Œå›å‚³ç¬¬ä¸€ç­†åŒ¹é…çš„å€¼ï¼Œé€™æ¨£å°±èƒ½è§£æ±ºåŒå€‹ key è¢«æ›´æ–°å¤šæ¬¡çš„ç‹€æ³\n1 2 3 $ db_set 42 \u0026#39;hello word\u0026#39; $ db_get 42 hello world å¦‚æœæˆ‘å€‘è€ƒé‡å¯«å…¥èˆ‡è®€å–çš„æ•ˆèƒ½\nå¯«å…¥ï¼šéå¸¸å¥½ï¼Œå› ç‚ºæ˜¯é †åºæ€§å¯«å…¥ï¼ŒåŸºæœ¬ä¸Šæ²’æœ‰æ¯” append æ›´å¿«çš„å¯«æ³•ï¼Œåœ¨éå¸¸å¤šçš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œä¹Ÿéƒ½ç”¨ä¸Š append only logï¼Œå¦‚ MySQL binlog è®€å–ï¼šå› ç‚ºè¦å¾æª”æ¡ˆæœ€æœ«ç«¯é–‹å§‹è®€å–ï¼Œæ™‚é–“è¤‡é›œåº¦ç‚º O(n)ï¼Œéå¸¸æ…¢ 1. æ”¹å–„è®€å–æ•ˆç‡ - åŠ ä¸Š Index æˆ‘å€‘å¯ä»¥é€éåœ¨ memory ä¸­ç¶­è­·ä¸€ä»½ Hash Tableï¼Œåœ¨å¯«å…¥æ™‚é †ä¾¿å„²å­˜ { key:æª”æ¡ˆä½ç½® }ï¼Œé€™æ¨£å°±èƒ½åœ¨æŸ¥è©¢æ™‚ç”¨ O(1) çš„æ™‚é–“æ‰¾åˆ° key\nä½†é€™å¸¶ä¾†å¦ä¸€å€‹é™åˆ¶ï¼ŒHash Table å¿…é ˆèƒ½å®Œæ•´æ”¾å…¥ Memoryï¼Œå¦‚æœä»Šå¤© key size è¶…éï¼Œå‰‡ Index ç„¡æ³•è¢«å»ºç«‹å°±æœƒå›åˆ° O(n) çš„æŸ¥è©¢è¤‡é›œåº¦\n2. æ”¹å–„å„²å­˜æ•ˆç‡ - Compact æ€è€ƒå¦ä¸€å€‹å„²å­˜å•é¡Œï¼Œä»Šå¤©å¦‚æœæ˜¯åŒä¸€å€‹ key è¢«åè¦†å„²å­˜å¤šæ¬¡ï¼Œä»¥ç›®å‰ append-only çš„è¨­è¨ˆï¼Œä»–æœƒè¢«å„²å­˜å¾ˆå¤šç­†ï¼Œæ¯æ¬¡è®€å–åªæ‹¿æœ€å¾Œä¸€ç­†ï¼Œå‰é¢å¹¾ç­†çš„è³‡æ–™ç©ºé–“å°±æµªè²»äº†\næ‰€ä»¥é€šå¸¸æœƒæ­é… Compact è¨­è¨ˆï¼Œé‡æ–°æ•´ç† log æŠŠèˆŠè³‡æ–™åˆªé™¤ï¼Œé‡‹æ”¾å„²å­˜ç©ºé–“ï¼Œå¯¦ä½œä¸Š æœƒé–‹æ–°çš„æª”æ¡ˆåˆä½µèˆŠçš„æª”æ¡ˆå…§å®¹ï¼Œä¸¦ä¸æœƒç›´æ¥ä¿®æ”¹èˆŠæª”æ¡ˆï¼Œé€™æ¨£åšçš„å¥½è™•æ˜¯å¯«å…¥ã€è®€å–ä¸æœƒä¸­æ–·ï¼Œç­‰åˆ°æ–°çš„æª”æ¡ˆå®Œæˆå¾Œï¼Œå†ç§»é™¤èˆŠæª”æ¡ˆ\n3. ç‚ºä»€éº¼è¦ç”¨ append è€Œä¸æ˜¯ç›´æ¥ update ? å¦‚æœæˆ‘ç›´æ¥æ”¹åŸæœ¬çš„è³‡æ–™ï¼Œæ˜¯ä¸æ˜¯å°±ç¯€çœäº† compact çš„éç¨‹ï¼ŸåŸå› åœ¨æ–¼ç¡¬ç¢Ÿé †åºå¯«å…¥æ•ˆèƒ½æœƒæ¯”è¼ƒå¥½ï¼Œå³ä½¿ SSD ä¹Ÿæ˜¯ï¼Œé€™é»å¾ŒçºŒè£œå……\n4. ç„¡å¯é¿å…çš„ç¼ºé» - range search å¦‚æœè¦ç¯„åœæœå°‹ï¼ŒHash Table ç„¡æ³•åšåˆ°é€™ä»¶äº‹ï¼ŒåŒæ¨£çš„ disk å„²å­˜æ–¹å¼ä¹Ÿæ²’æœ‰æ’åºï¼Œæ‰€ä»¥åªèƒ½å…¨éƒ¨ Scan\n5. Real World Sample: Bitcask ä»¥ä¸Šçš„æ–¹å¼è½èµ·ä¾†ç°¡å–®çš„éåˆ†ï¼Œä½†é€™ä¹Ÿæ˜¯çœŸå¯¦æœ‰åœ¨æ¡ç”¨çš„ä½œæ³•ï¼Œå¦‚ Riak å…§çš„å„²å­˜å¼•æ“ Bitcaskï¼ŒRiak æ˜¯åˆ†æ•£å¼ Key-Value DB\nBitcask æ˜¯ç”¨ Erlang å¯¦ä½œï¼ŒåŸå§‹ç¢¼ æœ‰é»çœ‹ä¸æ‡‚ï¼Œä½†æœ‰å¦ä¸€ç¯‡æ–‡ç« å¯ä»¥å¾ high level è§’åº¦å»æŸ¥è­‰ Bitcask: A Log-Structured Hash Table for Fast Key/Value Data\nå„²å­˜æ–¹é¢ï¼Œbitcask ç¶­è­·ä¸€å€‹ active file æŒçºŒå¯«å…¥ï¼Œå…¶é¤˜æœƒæœ‰å¤šå€‹ older file åªè®€ä¸å¯«ï¼ŒèƒŒæ™¯é‹è¡Œä¸€å€‹ merge process æŒçºŒåˆä½µå¤šå€‹ older file\næ¯ç­†è³‡æ–™æœ‰å‰ç¶´ metadataï¼Œé€™äº›è³‡æ–™æ¬„ä½çš„å°ºå¯¸éƒ½æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯ key value çš„é•·åº¦å¯ä»¥æ˜¯è®Šå‹•ï¼Œé€é keysz / valuesz çŸ¥é“å°æ‡‰é•·åº¦ï¼›\nå…¶ä¸­ CRC æ˜¯ checksumï¼Œå¯ä»¥æª¢æŸ¥è³‡æ–™å¯«å…¥æ˜¯å¦æœ‰èª¤\nbitcask ä¸­çš„è³‡æ–™çµæ§‹ keydir å°±æ˜¯ hash tableï¼Œä¿å­˜ key å°æ‡‰åˆ° value çš„å„²å­˜ä½ç½®ï¼Œé€™æ¨£å°±èƒ½å¤ ä¸€æ¬¡ Disk æŸ¥è©¢å–å‡º value\n6. ä¸åŒé¢å‘è€ƒé‡ è³‡æ–™åº«ä¸å–®æ˜¯è®€å¯«ï¼Œé‚„éœ€è¦è€ƒé‡å…¶ä»–é¢å‘çš„å•é¡Œï¼Œè®“æˆ‘å€‘ä¸€ä¸€æª¢è¦–é€™æ¨£çš„ç°¡å–®è¨­è¨ˆ\nCrash Recovery: åŸºæœ¬ä¸Šä¸æœƒæœ‰å•é¡Œï¼Œå› ç‚ºæª”æ¡ˆéƒ½æ˜¯ append onlyï¼Œå¦‚æœæœ‰å•é¡Œå¯ä»¥é€é CRC æª¢æŸ¥ï¼Œåªæ˜¯ keydir è¦é‡å»º Restore: ç›´æ¥è¤‡è£½æª”æ¡ˆéå»å°±å¥½ Heavy Load \u0026amp; High Volume: ç•¶è³‡æ–™é‡è®Šå¤§æˆ–æ˜¯ loading è®Šå¤§æ™‚ï¼Œé æœŸ bitcask çš„æ•ˆèƒ½ä¸æœƒæœ‰å¤ªå¤§å·®ç•°ï¼Œå› ç‚ºéƒ½æ˜¯å¾ˆç°¡å–®çš„ disk èˆ‡ memory æ“ä½œ äºŒ. SSTable èˆ‡ LSM Tree ä¸Šé¢æåˆ° Log Structure é‡åˆ° range search æ•ˆèƒ½æœƒå¾ˆå·®ï¼Œé‚£å¦‚æœæˆ‘å€‘æŠŠè³‡æ–™æ’åºå¾Œå†å¯«å…¥å‘¢ï¼Ÿ\nåœ¨è¨ˆç®—æ©Ÿç§‘å­¸ä¸­ï¼Œè² è²¬å¿«é€Ÿæ’å…¥ã€æŸ¥æ‰¾ã€ç¯„åœæœå°‹çš„è³‡æ–™çµæ§‹å¯ä»¥ç”¨ å¹³è¡¡æ¨¹ï¼Œæ’å…¥èˆ‡æœå°‹éƒ½æ˜¯ O(logn)ï¼Œå¦‚æœæ˜¯ç¯„åœæœå°‹å‰‡ç‚º O(logn, k)\nå¯¦ä½œä¸Šï¼Œç•¶è³‡æ–™å¯«å…¥æ™‚\næœƒå…ˆæš«å­˜åˆ° memory ä¸­ï¼Œè³‡æ–™çµæ§‹ç‚ºå¹³è¡¡æ¨¹ï¼Œæ­¤ç¨±ç‚º memtable ç•¶ memtable è¶…éé–€æª»ï¼Œå¯«å…¥ç¡¬ç¢Ÿï¼Œç¨±ç‚º SSTable (Sorted String Table)ï¼Œå¾ŒçºŒè³‡æ–™å¯«å…¥æ–°çš„ memtable SSTable åŒæ¨£æœƒåœ¨èƒŒæ™¯ compactï¼Œå¦‚ Log Structure åˆ°åº•å„²å­˜ç”¨ sorted å¾Œçš„çµæœæœ‰ä»€éº¼å·¨å¤§çš„å¥½è™•ï¼Ÿåˆæœƒæœ‰å¸¶ä¾†ä»€éº¼å½±éŸ¿å‘¢ï¼Ÿ\nè®“æˆ‘å€‘æ€è€ƒä»¥ä¸‹å¹¾å€‹ç´°ç¯€\n1. å¯«å…¥æœ€ä¸€é–‹å§‹æ˜¯å„²å­˜åœ¨ memory ä¸­ï¼Œå¦‚æœ crash æœƒä¸æœƒæ‰è³‡æ–™ï¼Ÿ æœƒï¼Œæ‰€ä»¥å¯«å…¥ memory æ™‚åŒæ™‚æœƒç”¨ append log æ–¹å¼å¯«å…¥è³‡æ–™åº«ï¼Œå€Ÿç”¨ log structure çš„æ™ºæ…§ï¼Œç•¶ crash recovery å¾ log å¾©åŸå³å¯\n2.sorted å¾Œå„²å­˜çµæœçš„å¹¾å€‹å¥½è™• é™¤äº†å‰›å‰›èªªçš„æ”¯æ´æ›´å¿«çš„ç¯„åœæŸ¥è©¢å¤–ï¼Œä¿å­˜åœ¨ memory ä¸­çš„ index æ•¸é‡å¯ä»¥æ›´å°‘ï¼Œè®“ dataset æ”¯æ´å®¹é‡æ›´å¤§ï¼Œå¦‚ä¸Šé¢åœ–ç¤ºï¼ŒSSTable æœƒä»¥å¤šç­†è³‡æ–™ç‚ºä¸€å€‹ blockä¿å­˜ï¼Œä»Šå¤©æˆ‘è¦æ‰¾ 2ï¼Œindex tree å…§æ²’æœ‰ 2 æ²’é—œä¿‚ï¼Œæˆ‘å¯ä»¥æ‰¾åˆ° 1 çš„æª”æ¡ˆä½ç½®ï¼Œæ¥è‘—æŠŠ block è®€å–å‡ºä¾†ï¼Œé€™æ¨£æˆ‘å°±èƒ½é€é 1 æ‰¾åˆ° 2ï¼Œèƒ½å¤ é€™æ¨£æ‰¾æ˜¯å› ç‚º å„²å­˜æœ‰æŒ‰ç…§ index æ’åº\n3. compact éç¨‹æœƒä¸æœƒå¾ˆéº»ç…©? ä¸æœƒï¼Œå¦‚æœæœ‰å­¸é merge sortï¼Œé€™å€‹éç¨‹å°±æ˜¯æŠŠå…©å€‹å°çš„ block å¾é ­åˆ°å°¾ iterate éå°±è§£æ±ºäº†ï¼Œæ™‚é–“è¤‡é›œåº¦ç‚º O(n+m)\n4. æŸ¥æ‰¾ä¸å­˜åœ¨çš„ key æ•ˆç‡ä¸å¥½ å› ç‚ºè¦æ‰¾éæ¯ä¸€å€‹ SSTable æ‰èƒ½ç¢ºå®šè³‡æ–™ä¸å­˜åœ¨ï¼Œé€™é‚Šå¯ä»¥åˆ©ç”¨ Bloom Filter å¿«é€Ÿåˆ¤æ–·ï¼Œå¯ä»¥åƒè€ƒæˆ‘ä¹‹å‰çš„ç­†è¨˜ Sketch Data Structure - Bloom Filter ä»‹ç´¹èˆ‡å¯¦ä½œ\n5. Real World Sample: LevelDB / RocksDB / BigTable Google LevelDB æ˜¯ç”¨ SSTable æ¦‚å¿µå¯¦ä½œçš„ Key-Value DBï¼Œå¯ä»¥åƒè€ƒä»–çš„èªªæ˜ LevelDB impl.mdï¼Œå…¶ä¸­å¯ä»¥æ³¨æ„ compact éç¨‹æ˜¯æœ‰åˆ†ç­‰ç´šçš„ (æ‰€ä»¥æ‰å« level DB)ï¼Œé¿å…ä¸€æ¬¡æ€§å¤§é‡çš„ compact ç™¼ç”Ÿå°è‡´ç¡¬ç¢Ÿæ•ˆèƒ½åƒä¸æ¶ˆï¼Œå…¶ä¸­ç¿»äº†ä¸€ä¸‹ memtable æ²’æœ‰çœ‹åˆ°æ˜¯ç”¨ä»€éº¼æ–¹å¼å¯¦ä½œ\nRocksDB å‰‡æ˜¯ Facebook åŸºæ–¼ LevelDB æ‰€é–‹ç™¼çš„ï¼Œèªªæ˜è »å®Œæ•´çš„ RocksDB Overview\nThe memtable is an in-memory data structure - new writes are inserted into the memtable and are optionally written to the logfile (aka. Write Ahead Log(WAL)). The logfile is a sequentially-written file on storage. When the memtable fills up, it is flushed to a sstfile\nä¸‹æ–¹æœ‰æåˆ°ä¸€äº› memtable å¯¦ä½œèˆ‡æ¯”è¼ƒï¼Œé è¨­æ˜¯ skiplistï¼Œæ„Ÿè¦ºè »æœ‰è¶£çš„ï¼Œæœªä¾†å¯ä»¥å†æ·±å…¥ç ”ç©¶\nå¦å¤–é‚„æœ‰ Google çš„Bigtable: A Distributed Storage System for Structured Dataï¼Œè£¡é¢ä¹Ÿæœ‰æåˆ°å¾ˆå¤šç›¸é—œçš„å…§å®¹ï¼Œæœªä¾†å¾…è®€é …ç›®ä¹‹ä¸€ (æŒ–å‘)\nä»¥ä¸Š Log Structure èˆ‡ SSTable éƒ½å¯ç¨±ç‚º LSMTreeï¼Œä¹Ÿå°±æ˜¯ Log Structure and Merging Treeï¼Œé€é log æ–¹å¼å„²å­˜ä¸¦æœ‰æŒçºŒ merge çš„è¡Œç‚º\nä¸‰. B Tree B Tree åœ¨è³‡æ–™åº«å„²å­˜ä¸Šæ˜¯éå¸¸å—æ­¡è¿çš„é¸é …ï¼Œå¦‚ MySQL / PostgreSQL ç­‰ï¼ŒB Tree ä¹Ÿæ˜¯å¹³è¡¡æ¨¹çš„ä¸€ç¨®ï¼Œæ¯ä¸€å±¤ä¿å­˜æŒ‡å®šæ•¸é‡çš„ç¯€é» (branching factor) ä»£è¡¨ä¸åŒçš„ç¯„åœï¼Œä¸¦ä¿å­˜æŒ‡å‘ä¸‹ä¸€å±¤çš„æŒ‡é‡ï¼Œæœ€å¾Œåœ¨è‘‰å­ç¯€é» (leef node) ä¿å­˜è³‡æ–™\nåœ¨ B Tree çš„ä¿å­˜ä¸­ï¼Œæ˜¯ä»¥å›ºå®šå°ºå¯¸çš„ Page ç‚ºå–®ä½ï¼Œå‰›å¥½å°æ‡‰åˆ°ç¡¬ç¢Ÿå„²å­˜æ–¹å¼ä¹Ÿæ˜¯ä»¥å›ºå®šå°ºå¯¸çš„å€å¡Šå„²å­˜ï¼Œå¦‚æœè³‡æ–™æ²’æœ‰å¡æ»¿ Page å‰‡æœƒé€ æˆä¸€äº›ç ´ç¢\né«˜åº¦ç‚º 4 + brancing factor ç‚º 5 + Page size 4 KB çš„ B Tree å°±èƒ½å„²å­˜ 256 TB\nB Tree èˆ‡ SSTable ç›¸ä¼¼ä¹‹è™•åœ¨æ–¼è³‡æ–™ä¿å­˜æ–¼ç¡¬ç¢Ÿéƒ½æ˜¯æ’åºéï¼Œä½†æ˜¯ B Tree æœƒä¸æ–·ä¿®æ”¹å·²ç¶“æŒä¹…åŒ–çš„æª”æ¡ˆï¼Œå°¤å…¶æ˜¯ç•¶ Page å…§è³‡æ–™è¶…ééœ€è¦æ‹†åˆ† Page ä¸¦é‡æ–°å¹³è¡¡æ™‚ï¼Œæœƒæœ‰æ¯”è¼ƒå¤šçš„ç¡¬ç¢Ÿæ“ä½œï¼Œè€Œ SSTable åªæœƒä¸€ç›´å¯«å…¥ç­‰åˆ° compact éšæ®µæ‰åˆä½µç”¢ç”Ÿæ–°çš„æª”æ¡ˆ\nB Tree vs SSTable å¸¸ç†ä¾†èªª SSTable å¯«å…¥æœƒæ¯”è¼ƒå¿«ï¼Œå› ç‚ºå°±æ˜¯ append ä¸Šå»è€Œ B Tree éœ€è¦å…ˆå¯« WAL ä¸¦ç­‰åˆ° Page åˆ·æ–°åˆ°ç¡¬ç¢Ÿä¸Šï¼Œé€™é»åœ¨é«˜å¯«å…¥çš„ç³»çµ±ä¸‹å°¤ç‚ºé‡è¦ï¼› å¦å¤– SSTable æœƒæœ‰ compact éç¨‹ï¼Œç›¸æ¯” B Tree Page è¨­è¨ˆå¯ä»¥æ›´æœ‰æ•ˆä½¿ç”¨ç£ç¢Ÿç©ºé–“\nè€Œ B Tree çš„å¥½æ˜¯è®€å–è¼ƒå¿«ï¼Œå› ç‚º SSTable çš„åŒä¸€å€‹ key å¯èƒ½æ•£è½åœ¨å¤šå€‹ file ä¸­éœ€è¦æ¯å€‹éƒ½æª¢æŸ¥ï¼›åŒæ™‚ç•¶é‡ä¸Š compact æ™‚æ•ˆèƒ½æœƒæœ‰æ¯”è¼ƒå¤§çš„è¡æ“Šï¼Œè€Œ B Tree ç›¸å°æœƒæ¯”è¼ƒç©©å®š\nColumn Storage ä¸Šè¿°å OLTP çš„è³‡æ–™åº«è¨­è¨ˆï¼Œè³‡æ–™æ˜¯ä»¥ row çš„æ–¹å¼å„²å­˜ï¼Œä½†æ˜¯åœ¨ OLAP å°ˆé–€åšåˆ†æä¸Šï¼Œå¾€å¾€æˆ‘å€‘éœ€è¦çš„æ˜¯ query éå¸¸å¤šçš„è³‡æ–™ç­†æ•¸ä½†åªåˆ†æå…¶ä¸­ä¸€å…©å€‹æ¬„ä½ï¼Œä¾‹å¦‚æ’ˆå‡ºéå»ä¸€å¹´çš„éŠ·å”®ç¸½é¡ï¼Œå¦‚æœè³‡æ–™æ˜¯ä»¥ row æ–¹å¼å„²å­˜ï¼Œè¦æŠŠä¸€æ•´å¹´çš„è³‡æ–™éƒ½æ‹¿å‡ºä¾†éæ¿¾ã€ç¯©é¸å†ç¸½å’Œï¼Œååˆ†è€—è²»è³‡æº\nåœ¨ OLAP ä¸­ï¼Œæ—¢ç„¶æˆ‘å€‘å¸¸å¸¸ä»¥ column ç‚ºä¸»ï¼Œé‚£æ”¹ç”¨ column ä¾†ç•¶ä½œå„²å­˜çš„ä¾æ“šæ˜¯ä¸æ˜¯æœƒæ¯”è¼ƒå¥½ï¼Ÿ column storage çš„æ¦‚å¿µå°±é€™æ¨£å»¶ä¼¸å‡ºä¾†\né€™æ¨£åšçš„æœ€å¤§å¥½è™•éå¸¸å¥½å£“ç¸®ï¼Œå¾æ¬„ä½è³‡æ–™çš„ cardinality ä¾†çœ‹ï¼Œå¾€å¾€æ•¸é‡ä¸å¤šï¼Œä¾‹å¦‚æ•¸ç™¾è¬ç­†è³‡æ–™ä¸­åœ‹å®¶ç¨®é¡å°±é‚£å…©ç™¾å€‹ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸€äº›å£“ç¸®çš„æŠ€å·§å¦‚ bitmap encodingï¼Œç”¨ bitmap ä»£è¡¨æŸå€‹ç‰¹å®šå€¼å„²å­˜ï¼Œåœ¨è®€å–æ™‚å¯ä»¥ç”¨ bitwise æ“ä½œï¼Œå°æ–¼ CPU æ•ˆç‡æœƒå¥½ä¸Šè¨±å¤šï¼›\næ‰€ä»¥å„²å­˜ç©ºé–“å°ã€é‹ç®—ä¹Ÿå¾ˆå¿«\né™åˆ¶èˆ‡æ‡‰è®Š å› ç‚ºç¾åœ¨æ˜¯æ¯ä¸€å€‹ column éƒ½ç¨ç«‹å„²å­˜ï¼Œé‚£å¦‚æœæˆ‘æƒ³è¦è®€å–æŸä¸€å€‹ row çš„æ‰€æœ‰ column æ€éº¼è¾¦ï¼Ÿ\næ‰€ä»¥åœ¨å„²å­˜æ™‚æ¯ä¸€å€‹ column file çš„ row order éƒ½å¿…é ˆä¸€æ¨£ï¼Œé€™æ¨£æ‰èƒ½é‚„åŸåŒä¸€ç­† row çš„å…¨éƒ¨ column\nå¦‚æœåœ¨å„²å­˜æ™‚å¸Œæœ›æœ‰æ’åºï¼Œä¾‹å¦‚åˆ†æè³‡æ–™é€šå¸¸æœƒæŒ‰ç…§æ—¥æœŸæ’åºï¼Œå¯ä»¥å¥—ç”¨ä¹‹å‰ SSTable æ¦‚å¿µï¼Œå…ˆç”¨ memtable æ’å¥½åºï¼Œå¯«å…¥æ™‚å†åˆ†æˆå¤šå€‹ column file å„²å­˜\nè¦æ³¨æ„ column-family database èˆ‡ column storage database æ˜¯ä¸ä¸€æ¨£çš„è©å½™ï¼Œå¦‚ Cassandra åœ¨æ–‡ä»¶è¡¨æ˜æ˜¯ä»¥ row-based å„²å­˜ï¼Œåƒè€ƒ Apache Cassandra is a highly-scalable partitioned row storeï¼Œä½†ä»–è¢«æ­¸é¡åœ¨ column-family ä¸­ï¼Œè‡³æ–¼ç‚ºä»€éº¼é€™æ¨£æ­¸é¡å¯èƒ½æ˜¯è·Ÿä»–çš„ç”¨é€”è·Ÿå°è±¡æ¯”è¼ƒæœ‰é—œï¼Œç¶²è·¯ä¸Šéš¨ä¾¿ä¸€æŸ¥éƒ½æœ‰ä¸€äº›éŒ¯èª¤çš„è³‡è¨Šï¼Œè¦åœ¨å°å¿ƒç•™æ„ (æœƒä¸æœƒæˆ‘æ‰æ˜¯éŒ¯çš„ ?! å¦‚æœæ˜¯æ­¡è¿ç•™è¨€è®“æˆ‘çŸ¥é“)\nçµè«– çŸ¥é“è³‡æ–™åº«æ€éº¼å„²å­˜å¥½åƒä¸æœƒè®Šæˆè³‡æ–™åº«å¤§å¸« XD ä½†å°æ–¼æœªä¾†åœ¨è©•ä¼°ä¸åŒçš„è³‡æ–™åº«æ™‚ï¼Œåˆå¤šä¸€å€‹å¯ä»¥é©—è­‰çœŸå½çš„å·¥å…·ï¼Œå°¤å…¶æ˜¯åœ¨å¤§ç‡ŸéŠ·æ™‚ä»£å„ç¨®æ–°çš„æŠ€è¡“åè©æŒçºŒè¢«ç™¼æ˜ï¼Œä½†è³‡æ–™åº«çš„æœ¬è³ªå°±é‚„æ˜¯ storage and retrieval\n","date":"2022-04-02T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-04-02-ddia03-%E8%B3%87%E6%96%99%E5%BA%AB%E5%84%B2%E5%AD%98%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6/","title":"ã€DDIAã€‘03 - è³‡æ–™åº«å„²å­˜åŸç†ç ”ç©¶"},{"content":"å¾æ‡‰ç”¨ç¨‹å¼çš„è§’åº¦ï¼ŒåŸ·è¡Œä»»å‹™å¯ä»¥åˆ†æˆ I/O bound èˆ‡ CPU boundï¼Œè€Œ I/O è™•ç†ç›¸æ¯”æ–¼ CPU é‹ç®—é€Ÿåº¦æ…¢å¥½å¹¾å€‹å±¤ç´šï¼Œæ‰€ä»¥ç•¶ I/O é‚„æ²’æº–å‚™å¥½æ™‚æœƒã€Œä¸»å‹•è®“ã€çµ¦å…¶ä»–ä»»å‹™ï¼Œç›¡å¯èƒ½åœ°è®“ CPU ä¿æŒå¿™ç¢Œï¼Œç­‰åˆ° ã€ŒI/O æº–å‚™å¥½å†é‡æ–°å›åˆ° CPU åŸ·è¡Œã€\nåœ¨ä¹‹å‰ç†è§£ Nodejs non-blocking I/O æ™‚ï¼Œå®˜æ–¹æ–‡ä»¶ Overview of Blocking vs Non-Blocking å¯«åˆ°\n1 Any code that is expected to run in a concurrent manner must allow the event loop to continue running as non-JavaScript operations, like I/O, are occurring. Nodejs sdk æœ‰æä¾› non-blocking I/O æ©Ÿåˆ¶ï¼Œåº•å±¤ libuv æœƒè™•ç† event loop èˆ‡å…¶é¤˜ I/O çš„åŸ·è¡Œï¼Œã€Œç•¶ I/O åŸ·è¡Œæ™‚å¯ä»¥è®“å…¶ä»–çš„ JavaScript code ç¹¼çºŒé‹è¡Œä¸è¢« blockã€\næ‰€æœ‰ç”¨ã€Œã€æ‹¬èµ·ä¾†çš„åœ°æ–¹éƒ½æ˜¯æˆ‘æ‰€æƒ³ä¸é€çš„ï¼Œç‚ºä»€éº¼ I/O é‹è¡Œæ™‚å…¶ä»– JavaScript Code å¯ä»¥ç¹¼çºŒé‹è¡Œï¼Ÿæ˜¯å› ç‚º Nodejs æœ‰æŸç¨®ç‰¹æ®Šçš„æ–¹æ³•çŸ¥é“ç›®å‰çš„ç¨‹å¼åœ¨ç­‰å¾… I/O æ‰€ä»¥ä¸»å‹•åˆ‡æ›ä¸åŒçš„ä»»å‹™åŸ·è¡Œï¼Ÿå¦‚æœä¸æ˜¯ Nodejs runtime åˆ‡æ›ï¼Œé‚£æœƒæ˜¯ä½œæ¥­ç³»çµ±åˆ‡æ›çš„å—ï¼Ÿè©²æ€éº¼åˆ‡æ›ï¼Ÿ\nåˆç‚ºä»€éº¼ I/O çš„è™•ç†ä¸éœ€è¦ CPU çš„ä»‹å…¥å—ï¼Ÿ CPU æ€éº¼çŸ¥é“ IO è™•ç†å®Œäº†è©²ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼Ÿæ˜¯ä¸æ˜¯æˆ‘çš„ IO å…¨éƒ¨æ”¹æˆ asynchronous æ•ˆèƒ½å°±çªé£›çŒ›é€²ï¼Ÿé‚£ç‚ºä»€éº¼ async io ä¸¦ä¸æ˜¯æ¯å€‹ç¨‹å¼èªè¨€åŸ·è¡Œæ™‚çš„é è¨­æ”¯æ´ï¼Ÿ\nåŒæ¨£æœ€è¿‘åœ¨çœ‹ Golang goroutine Go: Goroutine, OS Thread and CPU Managementæ™‚åˆé‡åˆ°ç›¸åŒçš„å•é¡Œï¼Œç•¶è®€åˆ° goroutine ç­‰å¾… I/O å›æ‡‰æ™‚ M æœƒè§£é™¤ P ä¸¦é€²å…¥ç­‰å¾…ï¼Œè®“å…¶ä»–çš„ M åŸ·è¡Œï¼›å¦‚æœæ˜¯é‡åˆ° network ç›¸é—œçš„ I/O å‰‡æ¨è‡³ network poll ç­‰å¾… network å®Œæˆ\nå¾æ‡‰ç”¨ç¨‹å¼é–‹ç™¼è€…çš„è§’åº¦ï¼Œæˆ‘å€‘åªè¦çŸ¥é“æœ‰ç¥ç§˜çš„å°ç²¾éˆæœƒå¹«æˆ‘å€‘å®Œæˆ I/Oï¼ŒJavaScript callback / goroutine system call å¯ä»¥åœ¨éåŒæ­¥çš„ç‹€æ³ä¸‹æ‹¿åˆ° I/O å›å‚³çš„çµæœå°±å¥½\nä½†å¾€ä¸‹æ€ç´¢ï¼Œé€™ä¸€åˆ‡çš„é»‘å¹•èƒŒå¾Œæœ‰æ»¿å±±æ»¿è°·çš„ç–‘æƒ‘\nä½œæ¥­ç³»çµ±èˆ‡ I/O è£ç½® ç‚ºäº†è®“é–‹ç™¼è€…å¯ä»¥å°ˆæ³¨æ–¼è»Ÿé«”é–‹ç™¼ï¼Œæ‡‰ç”¨ç¨‹å¼å¤šåŠé‹è¡Œåœ¨ä½œæ¥­ç³»çµ±ä¹‹ä¸Šï¼Œé€éä½œæ¥­ç³»çµ±æä¾›çš„çµ±ä¸€ä»‹é¢æŠ½è±¡åŒ–ç¡¬é«”ï¼Œä¸¦ç¢ºä¿å–®ä¸€æ‡‰ç”¨ç¨‹å¼ä¸æœƒéœ¸ä½”ç¡¬é«”è³‡æºï¼Œæ‰€æœ‰èˆ‡ I/O è£ç½®è¨­å‚™é€šè¨Šéƒ½å¿…é ˆç¶“éä½œæ¥­ç³»çµ±çš„æ“æ§ system callï¼Œè€Œé€™ç¥ç§˜çš„å°ç²¾éˆå°±èº²åœ¨é€™å€‹ç’°ç¯€ä¸­\nå¾ high level çš„è§’åº¦ä¾†çœ‹ï¼Œå¤§è‡´å¦‚ä¸‹ åˆ†æˆå…©æ¢è·¯ç·šï¼šæ‡‰ç”¨ç¨‹å¼ä¸»å‹•å‘¼å«èˆ‡ I/O è£ç½®ä¸»å‹•è§¸ç™¼\næ‡‰ç”¨ç¨‹å¼å‘¼å« system callï¼Œæ­¤æ™‚é€å‡º interrupt åˆ‡æ›åˆ° kernel space åŸ·è¡Œ system call æ“ä½œ(å¦‚è®€å¯«) I/O è£ç½®å°æ‡‰çš„ Fileï¼Œè§¸ç™¼ kernel module é‹ä½œï¼Œé€™é‚Šå°ˆæŒ‡ device driver çš„éƒ¨åˆ† ç•¶ I/O è£ç½®å®Œæˆç‰¹å®šå‹•ä½œï¼Œå¦‚ç¶²å¡æ¥æ”¶åˆ°å°åŒ… / ç¡¬ç¢Ÿè®€å–å®Œè³‡æ–™ï¼Œæœƒç›´æ¥é€éç¡¬é«”æ‰“å‡º interrupt è¨Šè™Ÿçµ¦ CPU CPU æœƒæ‰¾åˆ° OS è¨»å†Šå°æ‡‰çš„ interrupt handler è™•ç†ï¼Œé¡ä¼¼æ–¼ API server è¨»å†Š api route ç­‰ request è¿‘ä¾†å°±åˆ°å°æ‡‰çš„ handlerï¼Œmapping éç¨‹ç¨±ç‚º ISR ISR æœƒæ‰¾åˆ°å°æ‡‰çš„ device driver è™•ç† è£œå……ï¼šé€™é‚Šæˆ‘å€‘åªæ¢è¨è·Ÿ I/O ç›¸é—œçš„è­°é¡Œï¼Œæ‰€ä»¥ interrupt handler æŒ‡çš„æ˜¯å°±æ˜¯ä»¥ kernel module å­˜åœ¨çš„ I/O device driverï¼Œå…¶ä»–é‚„æœ‰å¦‚ timer interrupt handler ç­‰ æ‰€ä»¥çœŸæ­£æœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼\nI/O device driver å¦‚ä½•åœ¨æº–å‚™è³‡æ–™çš„æ™‚å€™é‡‹æ”¾ CPU è³‡æºï¼Œä¸¦åœ¨è³‡æ–™æº–å‚™å®Œæˆå¾Œé€é interrupt é‡æ–°å‘ OS æ’ç¨‹ä¸¦å›å‚³è³‡æ–™\nä»¥ä¸‹å°‡ä»¥ Linux ç‚ºä¸»ï¼Œæ¢ç´¢ä½œæ¥­ç³»çµ±èˆ‡ I/O è£ç½®çš„äº’å‹•\nLinux Kernel module å¯¦ä½œ åƒè€ƒå…§å®¹ The Linux Kernel Module Programming Guideï¼Œç¾åœ¨å­¸ç¿’ Linux çœŸçš„å¾ˆå¹¸é‹æœ‰ Jserv å¤§å¤§çš„è²¢ç»ï¼Œç”¨å½±ç‰‡èˆ‡å…±ç­†åˆ†äº«åœ¨æˆå¤§æ•™æˆçš„èª²ç¨‹ï¼Œä¸¦ç¶­è­·é€™ä»½æ˜“è®€å¥½æ‡‚çš„ Linux Kernel é–‹ç™¼æ•™å­¸ï¼Œä»¥ä¸‹å°‡å…ˆä»¥å¯¦ä½œåˆ‡å…¥\nkernel spaceã€user space èˆ‡ kernel module å…ˆå‰æåˆ°ä½œæ¥­ç³»çµ±æ˜¯ç‚ºäº†çµ±ä¸€ç®¡ç†ç¡¬é«”è€Œå­˜åœ¨ï¼Œé¿å…æ‡‰ç”¨ç¨‹å¼éœ¸ä½”è³‡æºè€Œä½¿å…¶ä»–æ‡‰ç”¨ç¨‹å¼ç„¡æ³•ä½¿ç”¨ï¼Œåœ¨åŸ·è¡Œå±¤é¢ Linux æ‹†æˆ kernel space èˆ‡ user spaceï¼Œkernel space å¯ä»¥æ“ä½œæ‰€ä»¥çš„è³‡æºï¼Œè€Œä¸€èˆ¬æ‡‰ç”¨ç¨‹å¼åŸ·è¡Œæ–¼ user space ç•¶ä¸­ï¼Œé€™æ¨£çš„ä¿è­·æ˜¯åŸºæ–¼ CPU æ‰€æä¾›ï¼ŒCPU æœ‰ä¸åŒçš„æ¨¡å¼å¯ä»¥ç”¨å‹ï¼Œkernel space æœ‰æœ€é«˜æ¬Šé™ (supervisor mode) è€Œ user space å‰‡æ˜¯æœ€ä½æ¬Šé™ (protect mode)\nkernel module æ˜¯åœ¨ Linux runtime å¯ä»¥å‹•æ…‹é–‹é—œè€Œä¸éœ€è¦é‡æ–°ç·¨è­¯ kernel image çš„ä¸€æ®µç¨‹å¼ï¼Œå¯ç›´æ¥åœ¨ kernel space åŸ·è¡Œï¼Œå¸¸è¦‹ç‚º I/O device driver\nåˆå› ç‚º kernel module æ˜¯å±¬æ–¼ kernel çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä»–å€‘çš„è³‡æºæ˜¯å…±äº«çš„å¦‚è¨˜æ†¶é«”ï¼ŒåŒæ¨£çš„å¦‚æœ kernel module æœ‰å•é¡Œé€£å¸¶æ•´å€‹ kernel éƒ½æœƒ crashï¼Œä»¥ä¸‹å¯¦é©—å»ºè­°å¦å¤–é–‹ VM å˜—è©¦ï¼Œæˆ‘è‡ªå·±æ˜¯ç”¨ Macbook M1 + Ubuntu 20.20 VM åŸ·è¡Œ\nhello world - kernel module åƒè€ƒè³‡æ–™ lkmpg - 4.2 Hello and Goodbye\nè®“æˆ‘å€‘å…ˆå¾æœ€ç°¡å–®çš„ hello world é–‹å§‹ï¼Œå…ˆäº†è§£æœ€åŸºæœ¬çš„ kernel module å®‰è£ã€å¸è¼‰èˆ‡åŸ·è¡Œéç¨‹\n1. hello world 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /* * hello-1.c - The simplest kernel module. */ #include \u0026lt;linux/kernel.h\u0026gt; /* Needed for pr_info() */ #include \u0026lt;linux/module.h\u0026gt; /* Needed by all modules */ int init_module(void) { pr_info(\u0026#34;Hello world 1.\\n\u0026#34;); /* A non 0 return means init_module failed; module can\u0026#39;t be loaded. */ return 0; } void cleanup_module(void) { pr_info(\u0026#34;Goodbye world 1.\\n\u0026#34;); } MODULE_LICENSE(\u0026#34;GPL\u0026#34;); ç·¨å¯« kernel module æ™‚ï¼Œæœ‰ä»¥ä¸‹ä¸‰é»å¿…å‚™\nç•¶ module å®‰è£æ™‚è¦åšä»€éº¼ï¼šinit_module ç•¶ module ç§»é™¤æ™‚è¦åšä»€éº¼ï¼šcleanup_module æŒ‡å®š module çš„ licenseï¼šMODULE_LICENSE éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€™å€‹ program åœ¨è¼¸å‡ºæ™‚æ˜¯ç”¨ pr_info è€Œé printfï¼ŒåŸå› æ˜¯åƒè€ƒ C ç·¨è­¯éç¨‹ åœ¨ç¬¬ä¸‰éšæ®µ Assembly ç”¢å‡º object codeï¼Œå¦‚æœæœ‰å¤–éƒ¨å‡½å¼åº«å‘¼å«æœƒåœ¨ç¬¬å›› Linking éšæ®µè£œä¸Šç¼ºå°‘çš„ object codeï¼›\nä½†æ˜¯ kernel module çš„ç¬¬å››éšæ®µä¸åŒï¼Œä»–åªèƒ½è§£æ kernel æ‰€è¨»å†Šçš„ symbolï¼Œä¹Ÿå°±æ˜¯ kernel æœ¬èº«æä¾›çš„ system callï¼Œå¯ä»¥åœ¨ /proc/kallsyms æŸ¥çœ‹\n2. æ¢åˆ— / å®‰è£ / ç§»é™¤ kernel module ç·¨è­¯ç”¨çš„ MakeFile åƒè€ƒä¸Šé™„é€£çµï¼Œç”¢å‡º module object code å¾Œï¼Œå¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤æ“ä½œ kernel module\n1 2 3 4 5 6 // æ¢åˆ— $ sudo lsmod // å®‰è£ $ sudo insmod {module.ko} // ç§»é™¤ $ sudo rmmode {module} å¯ä»¥é€é $ sudo journalctl --since \u0026quot;1 hour ago\u0026quot; | grep kernel æŸ¥çœ‹è¿‘ä¸€å°æ™‚ kernel module æ‰“å°çµæœ\ndevice driver æ‰€æœ‰çš„è£ç½®åœ¨ linux ä¸­éƒ½æ˜¯ fileï¼Œè³‡æ–™çµæ§‹å¯ä»¥åƒè€ƒ include/linux/fs.hï¼Œé¦–å…ˆè¦å…ˆé‡æ¸…é€™é‚Šçš„ File åªå­˜åœ¨æ–¼ kernelï¼Œé›–ç„¶ä¸­æ–‡å¯èƒ½éƒ½è¢«ç¿»æˆæ–‡ä»¶æˆ–æª”æ¡ˆï¼Œä½†å¯¦éš›ä¸Šèˆ‡æª”æ¡ˆç³»çµ±ä¸­çš„æª”æ¡ˆæ¦‚å¿µæ˜¯ä¸åŒçš„! å¾Œè€…é€šå¸¸æ˜¯å«åš inode\næ‰€ä»¥æ¯ä¸€å€‹è£ç½®åœ¨ linux ä¸­éƒ½æ˜¯ä»¥ä¸€å€‹ file å­˜åœ¨ï¼Œé€šå¸¸å„²å­˜æ–¼ /dev/ åº•ä¸‹ï¼Œè€Œ device driver å‰‡æ˜¯ user space æ‡‰ç”¨ç¨‹å¼èˆ‡ device æºé€šçš„ç®¡é“ï¼Œæµç¨‹å¤§è‡´æ˜¯\ndriver å‘ kernel è¨»å†Šå–å¾—å±¬æ–¼è‡ªå·±çš„è£ç½®ç·¨è™Ÿèˆ‡æŒ‡å®šæª”æ¡ˆ driver å®šç¾©æª”æ¡ˆæ“ä½œ 1. è¨»å†Šè£ç½® åƒè€ƒè³‡æ–™ lkmpg - 5.6 Device Drivers å…ˆè§€å¯Ÿç³»çµ±ä¸­æ—¢æœ‰çš„è£ç½®\n1 $ ls -l /dev/ å¯ä»¥çœ‹åˆ°é¡ä¼¼çš„è¼¸å‡º\n1 2 3 brw-rw---- 1 root disk 3, 1 Jul 5 2000 /dev/hda1 brw-rw---- 1 root disk 3, 2 Jul 5 2000 /dev/hda2 brw-rw---- 1 root disk 3, 3 Jul 5 2000 /dev/hda3 æ³¨æ„åˆ° \u0026ldquo;3, 1\u0026rdquo; é€™é¡å‹çš„å­—ä¸²ï¼Œå‰é¢æ˜¯ major number å¾Œé¢æ˜¯ minor numberï¼Œåˆ†åˆ¥ä»£è¡¨ æŒ‡å®š driver, è£ç½® idï¼Œæ¯å€‹ device driver éƒ½æœƒè¢«åˆ†é…ä¸€å€‹ idï¼Œè€Œå¯èƒ½æœ‰å¤šå€‹è£ç½®éƒ½æ˜¯ç”±åŒä¸€å€‹ driver æ‰€é©…å‹•ï¼Œæ‰€ä»¥æœ‰ç¬¬äºŒå€‹ minor id è®“ driver å€åˆ†ä¸åŒçš„ç¡¬é«”\næ¥è‘—æ³¨æ„åˆ°æœ€å‰çš„å­—å…ƒï¼Œå¯èƒ½æœƒçœ‹åˆ° d / b / c ä¸‰ç¨®ï¼Œd ä»£è¡¨ directory ç›®éŒ„ï¼Œb ä»£è¡¨ blockã€c ä»£è¡¨ charï¼›\nblock device æ˜¯æŒ‡èªªæ“ä½œæœƒä»¥ block ç‚ºå–®ä½ï¼Œæ‰€ä»¥æœ‰æ™‚æ“ä½œæœƒè¢« buffer å¾Œæ‰åŸ·è¡Œï¼Œä¾‹å¦‚ç¡¬ç¢Ÿå„²å­˜è£ç½®ï¼Œå¯ä»¥æœ€ä½³åŒ–è®€å¯«çš„æ•ˆç‡ï¼›\nchar device å‰‡æ²’æœ‰ bufferï¼Œå¯ä»¥ä»»æ„è®€å¯«ä¸åŒçš„å¤§å°ï¼Œå¹¾ä¹å¤§å¤šæ•¸çš„è£ç½®éƒ½æ˜¯ char device\n2. è¨»å†Šæª”æ¡ˆæ“ä½œ ç•¶æˆ‘å€‘æƒ³æŒ‡å®š device driver å¦‚ä½•æ“ä½œæª”æ¡ˆæ™‚ï¼Œæœƒå®šç¾© file_operationsï¼ŒæŒ‡å®šç•¶æª”æ¡ˆè¢«è®€å– / å¯«å…¥æ™‚è¦å°æ‡‰è§¸ç™¼çš„ handler functionï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹ struct ä¸­å¹¾ä¹éƒ½æ˜¯å®šç¾© function pointer\n1 2 3 4 5 6 7 8 struct file_operations { struct module *owner; loff_t (*llseek) (struct file *, loff_t, int); ssize_t (*read) (struct file *, char __user *, size_t, loff_t *); ssize_t (*write) (struct file *, const char __user *, size_t, loff_t *); ssize_t (*read_iter) (struct kiocb *, struct iov_iter *); ssize_t (*write_iter) (struct kiocb *, struct iov_iter *); ..... è£œå…… file ç›¸é—œè³‡æ–™ Linux ç³»çµ±ç¨‹å¼è¨­è¨ˆ - fd åŠ open()ã€close() ç³»çµ±å‘¼å«ï¼Œfile åœ¨ Linux ä¸­å¿…é ˆå…ˆè¢« open() æ‰èƒ½åŸ·è¡Œå¾ŒçºŒçš„è®€å¯«æ“ä½œï¼Œopen() æ™‚æœƒæŠŠæª”æ¡ˆç¨±ä½œ open fileï¼Œæ­¤æ™‚æœƒå›å‚³ file descriptorï¼Œè³‡æ–™çµæ§‹å°±æ˜¯ä¸Šé¢çš„ file_operations ç´€éŒ„æ¯ç¨®å‹•ä½œå°æ‡‰çš„è™•ç†æ–¹æ³•\n3. ç¯„ä¾‹ç¨‹å¼ç¢¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 static struct file_operations chardev_fops = { .read = device_read, .write = device_write, .open = device_open, .release = device_release, }; static int __init chardev_init(void) { major = register_chrdev(0, DEVICE_NAME, \u0026amp;chardev_fops); if (major \u0026lt; 0) { pr_alert(\u0026#34;Registering char device failed with %d\\n\u0026#34;, major); return major; } pr_info(\u0026#34;I was assigned major number %d.\\n\u0026#34;, major); cls = class_create(THIS_MODULE, DEVICE_NAME); device_create(cls, NULL, MKDEV(major, 0), NULL, DEVICE_NAME); pr_info(\u0026#34;Device created on /dev/%s\\n\u0026#34;, DEVICE_NAME); return SUCCESS; } /* Methods */ /* Called when a process tries to open the device file, like * \u0026#34;sudo cat /dev/chardev\u0026#34; */ static int device_open(struct inode *inode, struct file *file) { static int counter = 0; if (atomic_cmpxchg(\u0026amp;already_open, CDEV_NOT_USED, CDEV_EXCLUSIVE_OPEN)) return -EBUSY; sprintf(msg, \u0026#34;I already told you %d times Hello world!\\n\u0026#34;, counter++); try_module_get(THIS_MODULE); return SUCCESS; } /* This function is called whenever a process which has already opened the * device file attempts to read from it. */ static ssize_t device_read(struct file *file, /* see include/linux/fs.h */ char __user *buffer, /* buffer to be filled */ size_t length, /* length of the buffer */ loff_t *offset) { /* Number of bytes actually written to the buffer */ int bytes_read = 0; /* How far did the process reading the message get? Useful if the message * is larger than the size of the buffer we get to fill in device_read. */ const char *message_ptr = message; if (!*(message_ptr + *offset)) { /* we are at the end of message */ *offset = 0; /* reset the offset */ return 0; /* signify end of file */ } message_ptr += *offset; /* Actually put the data into the buffer */ while (length \u0026amp;\u0026amp; *message_ptr) { /* Because the buffer is in the user data segment, not the kernel * data segment, assignment would not work. Instead, we have to * use put_user which copies data from the kernel data segment to * the user data segment. */ put_user(*(message_ptr++), buffer++); length--; bytes_read++; } pr_info(\u0026#34;Read %d bytes, %ld left\\n\u0026#34;, bytes_read, length); *offset += bytes_read; /* Read functions are supposed to return the number of bytes actually * inserted into the buffer. */ return bytes_read; } çµè«–é—œéµçš„ç¨‹å¼ç¢¼\né€é register_chrdev è¨»å†Šè£ç½®èˆ‡æŒ‡å®šçš„ fileï¼Œç³»çµ±æœƒè¿”å› major number è¨»å†Š file_operatorsï¼Œå¯ä»¥æŒ‘é¸éœ€è¦çš„ handler è¨»å†Š å¯ä»¥æ³¨æ„ä¸€ä¸‹ device_read è¨»è§£ï¼Œè£¡é¢æœ‰å€‹ system call put_userï¼Œå› ç‚º driver æ˜¯åœ¨ kernel modeï¼Œè€Œ read æ˜¯å¾ user space è§¸ç™¼ï¼Œç•¶ä»Šå¤© driver æƒ³è¦å›å‚³è³‡æ–™çµ¦ user spaceï¼Œä¸èƒ½ç›´æ¥å¯«å…¥è¨˜æ†¶é«”ï¼Œè€Œæ˜¯éœ€è¦é€é put_user å°‡è¨˜æ†¶é«”å¾ kernel space è¤‡è£½åˆ° user space åŸ·è¡Œä¸Šçš„ç´°ç¯€å°±ä¸è´…è¿°ï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹åƒè€ƒè³‡æ–™\nIO blocking / non-blocking åƒè€ƒè³‡æ–™ lkmpg - 11 Blocking Processes and threads\nç•¶æ‡‰ç”¨ç¨‹å¼æ±ºå®šæ“ä½œ I/O æ™‚ï¼Œdevice driver å¯èƒ½é¢è‡¨è³‡æ–™å°šæœªæº–å‚™å¥½çš„æƒ…æ³ï¼Œæ­¤æ™‚æœƒé€é O_NONBLOCK flag æ±ºå®šæ˜¯å¦ç‚º block æ‡‰ç”¨ç¨‹å¼ï¼Œå¦‚æœ non-blocking å‰‡ç›´æ¥å›å‚³éŒ¯èª¤ -O_NONBLOCK è®“æ‡‰ç”¨ç¨‹å¼æ™šé»é‡è©¦ (polling)ï¼Œé€™ä¹Ÿå°±æ˜¯ Nodejs æ‰€é€éçš„æ–¹å¼ï¼Œnon-blocking I/O (é€™å¥è©±ä¸å…¨ç„¶å°ï¼Œé‚„æ˜¯è¦çœ‹ libuv é‡å°ä¸åŒ I/O çš„å¯¦ä½œï¼Œä½† non-blocking å°±æ˜¯æŒ‡é€™ç¨®æƒ…æ³æ²’éŒ¯)\næˆ–æ˜¯æ‡‰ç”¨ç¨‹å¼é¸æ“‡ block modeï¼Œæ­¤æ™‚ device driver é‚„åœ¨ç­‰å¾…è³‡æ–™çš„åŒæ™‚ï¼Œå¯ä»¥é¸æ“‡é€é wait_event_interruptible ä¸»å‹•äº¤å‡º CPU æ§åˆ¶æ¬Šï¼Œé¿å…ç„¡è¬‚çš„ä½”ç”¨ CPU è³‡æºï¼› åŒæ™‚åœ¨ wait ä¹‹å‰æœƒå…ˆè¨»å†Šå°æ‡‰çš„ wake_up äº‹ä»¶ï¼Œæˆ–æ˜¯æ”¶åˆ° signal æœƒå†å«é†’åŸæœ¬æ²ˆç¡çš„ process\n*åœ–ç‰‡åƒè€ƒè³‡æ–™ https://medium.com/@clu1022/%E6%B7%BA%E8%AB%87i-o-model-32da09c619e6\né‡æ–°å›ä¾†çœ‹ blocking èˆ‡ non-blocking çš„åœ–ï¼Œé€™é‚Šæ˜¯å¾æ‡‰ç”¨ç¨‹å¼è§’åº¦å‡ºç™¼ï¼Œblocking I/O æœƒåœ¨ kernel device driver æ²’æœ‰è³‡æ–™æ™‚ç­‰å¾…ï¼Œä½†å¾ kernel è§’åº¦ï¼Œå¦‚æœæœ‰æŒ‡å®š interruptable å‰‡ä½œæ¥­ç³»çµ±æœƒåˆ‡æ›åˆ°ä¸åŒçš„ process å»ï¼Œæ‰€ä»¥ä¹Ÿä¸æœƒæœ‰è³‡æºæµªè²»çš„å•é¡Œ (æ’‡é™¤ context switching é–‹éŠ·)\nsystem call åƒè€ƒè³‡æ–™ lkmpg - 10. system call\nå‰é¢å¯¦ä½œäº†ç°¡å–®çš„ kernel moduleï¼Œä¸¦çœ‹åˆ° device driver å¯ä»¥åœ¨ file ç™¼ç”Ÿè®ŠåŒ–æ™‚ç”¢ç”Ÿå°æ‡‰çš„è¡Œç‚ºï¼Œä½†ä¸€èˆ¬ä¾†èªªæ‡‰ç”¨ç¨‹å¼èˆ‡ kernel çš„äº’å‹•æ˜¯é€éå°è£éå¾Œçš„ system call\nLinux kernel æœƒæœ‰ä¸€å¼µ table sys_call_table å„²å­˜æ”¯æ´çš„ system call èˆ‡å°æ‡‰çš„ addressï¼Œ ç•¶æ‡‰ç”¨ç¨‹å¼éœ€è¦æ“ä½œç¡¬é«”éœ€è¦æŒ‡å®š system callï¼Œä¾‹å¦‚ open() é–‹å•Ÿæª”æ¡ˆ / read() è®€å–æª”æ¡ˆç­‰ï¼Œåœ¨æš«å­˜å™¨å¯«å…¥æŒ‡å®šè³‡æ–™å¾Œé€éç‰¹æ®ŠæŒ‡ä»¤ interrupt é€šçŸ¥ CPU è¦åˆ‡æ› kernel space åŸ·è¡Œ (åœ¨ intel ä¸­æ˜¯ 0x80)ï¼Œé€²éšè³‡æ–™å¯ä»¥åƒè€ƒ CPU protection ring\n1. å¾ printf è§€å¯Ÿ system call åƒè€ƒ lkmpg 5.2 Functions available to modules é€éæœ€ç°¡å–®çš„ c program printf ä¾†çœ‹ system call çš„åŸ·è¡Œ\n1 2 3 4 5 6 7 #include \u0026lt;stdio.h\u0026gt; int main(void) { printf(\u0026#34;hello\u0026#34;); return 0; } æ‰“åŒ…å¾Œé€é strace æŸ¥çœ‹ system call ç‹€æ³\n1 2 $ gcc -Wall -o hello hello.c $ strace ./hello.o æ‰“å°å‡ºè »å¤šæ±è¥¿ï¼ŒåŒ…å«ä¸€äº› memory allocate çš„æŒ‡ä»¤ç­‰ï¼Œæœ€çµ‚å¯ä»¥çœ‹åˆ° write çš„ system call å‘¼å«\n1 2 write(1, \u0026#34;hello world\u0026#34;, 11hello world) exit_group(0) 2. ä¿®æ”¹ system call å¦‚æœæˆ‘å€‘å¸Œæœ›ä¿®æ”¹ system callï¼Œç†è«–ä¸Šå¯ä»¥ç›´æ¥æ”¹ sys_call_table çš„ mappingï¼Œä½†åŸºæ–¼å®‰å…¨æ€§è€ƒé‡é€™æ˜¯ç„¡æ³•ç›´æ¥åœ¨ runtime æ“ä½œçš„ï¼ŒåŸå› æ˜¯é¿å… hacker ç›´æ¥ä¿®æ”¹ system call\nç¬¬äºŒå€‹å˜—è©¦å¯ä»¥é€é $sudo grep sys_call_table /proc/kallsyms æ‰¾å‡º sys_call_table æ‰€å„²å­˜çš„å¯¦éš›è¨˜æ†¶é«”ä½ç½®ä¸¦æ›¿æ›ï¼Œä½†é€™ç›®å‰ä¹Ÿä¸è¡Œï¼ŒåŒæ¨£æ˜¯å› ç‚ºå®‰å…¨æ€§è€ƒé‡ï¼Œ Linux kernel åœ¨æ¯æ¬¡ boot æ™‚æœƒå‹•æ…‹æ“¾äº‚ kernel code è·Ÿ data (ç¨±ç‚º KASLR)ï¼Œå¢åŠ  hacker å˜—è©¦æ”»æ“Šçš„é›£åº¦\nä¸€å€‹å¯è¡Œçš„åšæ³•æ˜¯é€é kprobeï¼Œé€™æ˜¯ä¸€å€‹ kernel debug çš„å·¥å…·ï¼Œç•¶ CPU åŸ·è¡Œåˆ°ä¸­æ–·é»æ™‚æœƒä¿å­˜æš«å­˜å™¨ç‹€æ…‹ï¼Œä¸¦åŸ·è¡Œ kprobe æŒ‡å®šçš„æŒ‡ä»¤ï¼Œå¯ä»¥é€éé€™ç¨®æ–¹å¼å»å‹•æ…‹èª¿æ•´ system call åŸ·è¡Œ\nä½†ä¸Šé¢çš„æ–¹æ³•åœ¨ production å¾ˆå±éšªï¼Œè©¦æƒ³å¦‚æœæœ‰å¤šå€‹ kernel module å»èª¿æ•´ system callï¼Œåœ¨ restore æ™‚å¯èƒ½æœƒç™¼ç”Ÿæ„å¤–ï¼Œä¸è«–æ˜¯å¾©åŸéŒ¯èª¤æˆ–æ˜¯åŸ·è¡Œåˆ°å·²ç¶“ç§»é™¤çš„ kernel moduleï¼Œæ‰€ä»¥å»ºè­°æ˜¯ç›´æ¥é‡æ–°ç·¨è­¯ kernel\nCPU èˆ‡ Hardware interrupt ä¸Šé¢å¤§è‡´æè¿°ç¶ ç·šçš„èµ°å‘ï¼Œå¾ user space å‘¼å« system callï¼Œè§¸ç™¼å°æ‡‰ device driver æ‰€æŒ‡å®šçš„ file operation\næ¥ä¸‹ä¾†çœ‹è—ç·šçš„éƒ¨åˆ†ï¼Œç•¶ I/O device æ”¶åˆ°å¤–éƒ¨è¨Šè™Ÿå¦‚ç¶²å¡æ”¶åˆ°å°åŒ…ã€éµç›¤è¢«æŒ‰ä¸‹æŒ‰éˆ•ï¼Œå¦‚ä½•é€å‡ºä¸­æ–·çµ¦ CPU ä¸¦é€²å…¥å¾ŒçºŒçš„è™•ç†\nå…·é«”å…§å®¹è«‹åƒè€ƒå®…è‰²å¤«çš„ Linux æ ¸å¿ƒè¨­è¨ˆ: ä¸­æ–·è™•ç†å’Œç¾ä»£æ¶æ§‹è€ƒé‡ï¼Œé€™é‚Šåƒ…å¤§è‡´æä¸€ä¸‹æµç¨‹\nI/O è£ç½®é€å‡º Interrupt Request (IRQ) Hardware controller æ•´ç†å¾Œé€å‡º interrupt vector åˆ° CPU CPU åˆ‡æ›æ¨¡å¼ç«‹å³è™•ç† interruptï¼Œé€é ISR æ‰¾åˆ°å°æ‡‰çš„ Interrupt Handler Interrupt handler ä¸­æœ‰åˆ†æˆ top half / bottom halfï¼Œtop half æ˜¯ä¸æœƒè¢«å…¶ä»– Interrupt ä¸­æ–·ï¼Œæ‰€ä»¥ä¸€å®šæœƒç•¶ä¸‹å®Œæˆï¼›è€Œ bottom half å‰‡æœƒè¢«æ’å…¥ softiqr é‡æ–°æ’æˆï¼Œsoft åœ¨ OS ä¸­æœ‰æ™‚æ˜¯ä»£è¡¨ä¸ç¢ºå®šä½•æ™‚æœƒè¢«å®Œæˆ å¯¦ä½œé¢çš„éƒ¨åˆ†åƒè€ƒ lkmpg 15.2 Detecting button pressesï¼Œé€é request_irq è¨»å†Š interrupt requestï¼Œç•¶æŒ‡å®šçš„ I/O ç™¼ç”Ÿ interrupt æ™‚å°±æœƒå‘¼å«è¨»å†Šçš„ funtion\n1 2 3 ret = request_irq(button_irqs[0], button_isr, IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING, \u0026#34;gpiomod#button1\u0026#34;, NULL); æ›´å¤šçš„è¨è«–å¯ä»¥åƒè€ƒæ–‡ä»¶ï¼Œä¸åŒçš„ CPU èˆ‡ä½œæ¥­ç³»çµ±æœ‰ä¸åŒçš„è€ƒé‡ï¼Œè€ƒæ…®åˆ°æ’ç¨‹ realtime OS çš„è¨­è¨ˆåˆæœƒæœ‰ä¸åŒ\nå»¶ä¼¸ï¼šLinux çš„ Asynchronous I/O ç¾åœ¨æµè¡Œçš„ network I/O è™•ç†æ–¹å¼æ˜¯é€é I/O multiplexingï¼Œå¦‚ Linux çš„ epollï¼Œè€Œ asynchrous I/O çœ‹èµ·ä¾†ååˆ†çš„è¿·äººï¼Œæ‡‰ç”¨ç¨‹å¼ç™¼å‡ºè«‹æ±‚å¾Œå°±ç›´æ¥ç­‰åˆ°ä½œæ¥­ç³»çµ±é€šçŸ¥ï¼Œä¸­é–“å®Œå…¨ä¸ç”¨ç­‰å¾…ï¼Œä½†ç‚ºä»€éº¼ç›®å‰æ²’æœ‰è¢«å¤§è¦æ¨¡æ¡ç´å‘¢ï¼Ÿ\n*åœ–ç‰‡åƒè€ƒè³‡æ–™ https://medium.com/@clu1022/%E6%B7%BA%E8%AB%87i-o-model-32da09c619e6\nåƒè€ƒè³‡æ–™ Efficient IO with io_uringï¼ŒAIO åœ¨ Linux 2.5 å°±å·²ç¶“åŠ å…¥äº†ï¼Œä½†æŒçºŒè¢«è©¬ç—…ä¾‹å¦‚é‡å° buffer i/o é‚„æ˜¯æœƒè®Šæˆ synchronous ä¸” API é›£ä»¥ä½¿ç”¨ï¼Œåœ¨ Linux 5.1 å¾ŒåŠ å…¥äº† io_urningæ–°çš„ AIO API ä¸¦æŒçºŒå„ªåŒ–\nlibuv æœ‰é–‹å§‹è¨è«–å°å…¥ io_uring çš„éƒ¨åˆ†ï¼Œæœ‰äººæä¾› benchmark åœ¨è®€å–æª”æ¡ˆéƒ¨åˆ†å¯ä»¥æ¯”åŸæœ¬çš„ thread pool è¨­è¨ˆæ›´å¿«\nSO: Is there really no asynchronous block I/O on Linux? è£¡é¢æœ‰æä¾›å¾ˆå¤šçš„ç›¸é—œé€£çµï¼Œè³‡æ–™åº«å¦‚ PostgreSQL / RocksDB å˜—è©¦ç”¨ io_uring æå‡ç¡¬ç¢Ÿè®€å¯«æ•ˆèƒ½ï¼Œåœ¨ networking æ–¹é¢ä¹Ÿæœ‰ä¸€äº›å˜—è©¦ï¼Œåœ¨å¦ä¸€ç¯‡æ–‡ç«  Epoll vs. io_uring æ•ˆèƒ½æ¸¬è©¦èˆ‡æ¯”è¼ƒçœ‹èµ·ä¾†æ•ˆèƒ½æå‡ä¸å°‘ï¼ŒCPU ä½¿ç”¨ç‡ä½ä¸”èƒ½è™•ç†æ›´å¤šçš„ requestï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†æ·±å…¥ç ”ç©¶\nç¸½çµ çªç„¶é–“ä¸çŸ¥å¦‚ä½•ç¸½çµï¼Œç ”ç©¶çš„éç¨‹æ¯”æƒ³åƒä¸­ç™¼æ•£ï¼Œçœ‹äº†å¾ˆå¤šæ–‡ä»¶ XD\nå¤§æŠµä¸Šå¾ high level è§’åº¦ç†è§£äº†æ•´å€‹ I/O ç™¼ç”Ÿçš„éç¨‹ï¼Œèªè­˜åˆ°äº†ã€Œæ‡‰ç”¨ç¨‹å¼è®€å¯« IO çš„éç¨‹ã€ï¼Œä¸­é–“æ¶‰åŠåˆ° system call / kernel module çš„åŸ·è¡Œï¼Œä»¥åŠ OS context switch çš„éç¨‹ï¼Œæˆ–è¨±æˆ‘çœŸæ­£æƒ³é‡æ¸…çš„æ˜¯ ä¸¦éæŠŠ I/O è®Šæˆ non-blocking / asynchronous ç³»çµ±æ•ˆèƒ½å°±æœƒç„¡è…¦æå‡ï¼Œmemory çš„ copy / interrupt handler è™•ç†ç­‰é‚„æ˜¯æœƒä½”ç”¨ CPU æ™‚é–“ï¼Œå¯ä»¥åƒè€ƒå¦ä¸€ç¯‡ cloudflare çš„æ•´ç†ï¼ŒçœŸæ­£æƒ³åšåˆ°æ•ˆèƒ½æå‡æœ‰æ™‚é‚„æ˜¯éœ€è¦ I/O è£ç½®çš„å‡ç´š\nç ”ç©¶çš„éç¨‹é‚„æœ‰å¾ˆå¤šæ²’è§£é‡‹æ¸…æ¥šçš„åœ°æ–¹ï¼Œä¾‹å¦‚ File çš„è³‡æ–™å¦‚ä½•è¢« I/O è£ç½®è®€å¯«ï¼Œéœ€è¦åœ¨æ¶‰çµæ›´å¤šç¡¬é«”ç›¸é—œçš„çŸ¥è­˜ï¼Œæˆ–è¨±è©²ä¾†ç ”ç©¶æ¨¹è“æ´¾äº† XD\nç¸½ä¹‹ï¼Œä¹Ÿç®—æ˜¯ç¨ç¨é‡æ¸…å›°æ“¾è‡ªå·±å¤šå¹´çš„ç–‘æƒ‘ï¼Œå¸Œæœ›ä¹Ÿå¯ä»¥åˆ†äº«çµ¦å°æ–¼æ‡‰ç”¨ç¨‹å¼èˆ‡ I/O è£ç½®äº’å‹•æœ‰ç–‘å•çš„äººï¼Œæˆ‘åœ¨æ¯ä¸€æ®µéƒ½ç›¡å¯èƒ½ç•™ä¸‹åƒç…§çš„ lkmpg ç« ç¯€ï¼Œå¼·çƒˆæ¨è–¦æœ‰èˆˆè¶£å¯ä»¥è®€å®Œæ•´ç¯‡ï¼Œå°æ–¼ Linux ä½œæ¥­ç³»çµ±æœ‰åŸºæœ¬çš„èªçŸ¥\nå¦‚æœæœ‰ä»»ä½•ä¸æ¸…æ¥šæˆ–å¯«éŒ¯çš„åœ°æ–¹ï¼Œå†éº»ç…©ç•™è¨€æŒ‡æ•™\n","date":"2022-02-06T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-02-06-i/o-%E5%90%8C%E6%AD%A5%E8%88%87%E9%9D%9E%E5%90%8C%E6%AD%A5%E5%BE%9E%E7%A1%AC%E9%AB%94%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%E5%88%B0%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/","title":"I/O åŒæ­¥èˆ‡éåŒæ­¥ï¼šå¾ç¡¬é«”ã€ä½œæ¥­ç³»çµ±åˆ°æ‡‰ç”¨ç¨‹å¼"},{"content":"æœ€è¿‘æƒ³äº†è§£ä¸€ä¸‹ä½œæ¥­ç³»çµ±è™•ç† I/O çš„éç¨‹ï¼Œç¿»é–±åˆ° CloudFlare ä¸€ç³»åˆ—é—œæ–¼ä½œæ¥­ç³»çµ±èˆ‡ Network Packet è™•ç†çš„å¯¦é©—èˆ‡æ–‡ç« ï¼Œè »æœ‰è¶£çš„ç¨å¾®æ•´ç†äº†ä¸€ä¸‹\né—œæ–¼ Linux å°åŒ…è™•ç† ä¸»è¦åœ¨é‡æ¸¬ Linux æ¥µé™å¯ä»¥è™•ç†å¤šå°‘ packet per second / ä»¥åŠå¦‚ä½•æŒçºŒå„ªåŒ–\nLinux å–®æ©Ÿè™•ç† 1M udp packet per second æ–‡ç« å‡ºè‡ªï¼šHow to receive a million packets per secondï¼Œåœ¨ç¡¬é«”è¦æ ¼\n1 2 3 4 1. six core 2GHz Xeon processors. 2. With hyperthreading (HT) enabled that counts to 24 processors on each box 3. multi-queue 10G network card by Solarflare 4. with 11 receive queues configured. å¯ä»¥æ’åˆ°æ¯ç§’æ¥æ”¶ä¸€ç™¾è¬å€‹ udp å°å°åŒ…(32 bytes)ï¼Œç™¼é€è·Ÿæ¥æ”¶ç«¯åœ¨åŒå€‹å€ç¶²çš„ä¸åŒæ©Ÿå™¨ä¸Š\nä¸­é–“çš„å˜—è©¦è¿­ä»£éç¨‹å¾ˆæœ‰è¶£\n1. è£¸æ¸¬ åƒ…èƒ½åˆ° 0.19~0.35 Mï¼Œç™¼ç¾ kernel å¯èƒ½éš¨æ©Ÿåˆ†é… process åˆ°ä¸åŒ CPU ä¸Šï¼Œé€é taskset æŒ‡å®š CPU é‹è¡Œï¼Œç©©å®šåœ¨ 0.35 M ä¸Šä¸å»ï¼Œç™¼ç¾åªæœ‰å–®ä¸€ CPU å¿™ç¢Œåˆ° 100%\n2. NUMA æ¶æ§‹å„ªåŒ– å¤šæ ¸å¿ƒè™•ç†å™¨ç‚ºäº†é¿å…å¤šæ ¸å¿ƒåœ¨å­˜å– Memory çš„è²§é ¸ï¼Œæœƒæ¡ç”¨ NUMA æ¶æ§‹ï¼Œè®“ä¸€è‡³å¤šå€‹ CPU core å…±ç”¨ä¸€å¡Š memory çµ„æˆä¸€å€‹ NUMA nodeï¼› åœ–ç‰‡å‡ºè™• @lkmem/SkWYoA-TU NUMA å¥½è™•æ˜¯å¦‚æœ CPU éƒ½åªå­˜å– local memory æ•ˆç‡æœƒéå¸¸å¥½ï¼Œå¦‚æœè¦å­˜å–åˆ°ä¸åŒå€åŸŸçš„ memory æˆ–æ˜¯ä»»å‹™åœ¨ä¸åŒ NUMA node CPU ä¸­ context switch å‰‡æ•ˆç‡æœƒå¾ˆå·®ï¼Œä½œè€…é€²è¡Œä»¥ä¸‹æ¯”è¼ƒï¼š\nå¦‚æœ RX queue å’Œæ‡‰ç”¨ç¨‹å¼æ˜¯åœ¨åŒä¸€å€‹ NUMA node çš„ä¸åŒ core ä¸Šï¼Œæ•ˆèƒ½æ˜¯æœ€å¥½çš„ å¦‚æœæ˜¯åœ¨ä¸åŒçš„ NUMA node ä¸Šï¼Œå‰‡æ•ˆèƒ½å·®ä¸”ä¸ç©©å®š å¦‚æœæ˜¯åœ¨åŒå€‹è¶…åŸ·è¡Œç·’(HT)ä¸Šï¼Œå‰‡æ•ˆèƒ½åªå‰©ä¸€åŠ 3. å¢åŠ  NIC çš„ RX queue æ•¸é‡ éå¾€ NIC åªæœ‰ä¸€å€‹ RX queue ç”¨ä¾†å­˜æ”¾æ¥æ”¶åˆ°çš„å°åŒ…ï¼Œè€Œä¸€å€‹ RX queue åªèƒ½ç”±ä¸€å€‹ CPU è®€å–é™åˆ¶äº†å¤šæ ¸å¿ƒæ©Ÿå™¨çš„æ•ˆèƒ½ï¼Œæ‰€ä»¥ NIC ç›®å‰éƒ½æœƒæœ‰å¤šæ¢ RX queue\nä½†æ˜¯æœ‰äº†å¤šæ¢ queueï¼ŒNIC éœ€è¦æŠŠåŒä¸€å€‹ connection çš„å¤šå€‹ packet é€åˆ°åŒä¸€å€‹ queue ä¸­è®“åŒä¸€å€‹ CPU è™•ç†ï¼Œå¦å‰‡æœƒé‡åˆ° packet order äº‚æ‰çš„å•é¡Œï¼Œæ­¤æ™‚å¯ä»¥é€é hashing è§£æ±ºï¼Œhash function ç‚º {ip, port}\nå¾Œä¾†å› ç‚ºå¯¦é©—çš„ NIC ç„¡æ³•èª¿æ•´ hash æ©Ÿåˆ¶ï¼Œæ‰€ä»¥æ”¹ç”¨å¢åŠ  IP çš„æ–¹å¼ï¼Œä½†ç›®çš„ä¹Ÿæ˜¯è¦æŠŠ packet åˆ†æ•£åˆ°å¤šå€‹ RX queue ä¸Šï¼Œæ­¤èˆ‰å¢åŠ åˆ° 0.47M\n4. åŠ é–‹ recv thread åŸæœ¬æ˜¯ç”¨ single thread æ¥æ”¶ï¼Œå˜—è©¦é–‹å•Ÿ multi thread ä½†åè€Œæ€§èƒ½ä¸‹é™ï¼ŒåŸå› æ˜¯å¤šå€‹ thread å…±ç”¨åŒä¸€å€‹ file descriptor éœ€è¦é¡å¤– lock\nä½†å¥½åœ¨ Linux åœ¨ 3.9 å¾ŒåŠ å…¥äº† SO_REUSEPORT å¯ä»¥è®“å¤šå€‹socket descriptor ç¶å®šåˆ°åŒä¸€å€‹ port ä¸Šï¼Œæ‰€ä»¥è®“å¤šå€‹ thread å¯ä»¥åˆ†æ“”è®€å–çš„å·¥ä½œï¼Œä½†ä½œè€…åŒæ¨£è§€å¯Ÿåˆ° SO_REUSEPORT é€™ä¸€å±¤åŒæ¨£æœ‰åˆ†æ•£ä¸å¹³å‡çš„å•é¡Œï¼Œåªæœ‰å¹¾å€‹ CPU ç‰¹åˆ¥å¿™ç¢Œ\nOne of the features merged in the 3.9 development cycle was TCP and UDP support for the SO_REUSEPORT socket option; that support was implemented in a series of patches by Tom Herbert. The new socket option allows multiple sockets on the same host to bind to the same port, and is intended to improve the performance of multithreaded network server \u0026hellip;..\n\u0026hellip;. Incoming connections and datagrams are distributed to the server sockets using a hash based on the 4-tuple of the connectionâ€”that is, the peer IP address and port plus the local IP address and port.\nå°çµ å–®æ©Ÿ Linux å„ªåŒ–å¾Œå¯ä»¥åšåˆ°æ¯ç§’æ¥æ”¶ 1M UDP packet\nè¨˜å¾—å°‡ packet åˆ†æ•£åˆ° RX queue æ¥æ”¶ç«¯æ‡‰ç”¨ç¨‹å¼è¦æ‰“é–‹ SO_REUSEPORT ä¸¦é€é multi thread è®€å– è¦æœ‰å¤šçš„ CPU è² è²¬å¾ RX queue è®€å– å¦‚æœæ˜¯ NUMA æ¶æ§‹ï¼ŒRX queue / æ‡‰ç”¨ç¨‹å¼çš„ CPU è¦åœ¨åŒä¸€å€‹ Node æ€§èƒ½æ¯”è¼ƒå¥½ ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ Linux kernel è™•ç† TCP stack? æ–‡ç« å‡ºè‡ªï¼šWhy we use the Linux kernel\u0026rsquo;s TCP stack\nç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ OS è©¦æƒ³ä¸€å€‹å•é¡Œï¼Œå¦‚æœæˆ‘å€‘ä¸€å° server ä¸Šåªè·‘ä¸€å€‹å°ˆç”¨çš„æ‡‰ç”¨ç¨‹å¼ï¼Œé‚£ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦å…ˆé¡å¤–å®‰è£ä¸€å€‹ä¸Šåƒè¬è¡Œçš„ OS å»ä»£ç†åŸ·è¡Œæˆ‘å€‘çš„æ‡‰ç”¨ç¨‹å¼ï¼Ÿ\nOS ä¸»è¦æä¾›å¹¾å€‹å¥½è™•ï¼š\næŠ½è±¡åŒ–ç¡¬é«”ã€æä¾›çµ±ä¸€ä»‹é¢ï¼š\nOS æœƒæŠ½è±¡åŒ–åº•å±¤çš„ç¡¬é«”ï¼Œè®“æ‡‰ç”¨ç¨‹å¼å°ˆæ³¨æ–¼é–‹ç™¼è€Œä¸ç”¨ç®¡å¯¦éš›åŸ·è¡Œçš„ç¡¬é«”ç‚ºä½•ï¼Œå¸¶ä¾†æ›´å¥½çš„ç§»æ¤æ€§ è³‡æºç®¡ç†ï¼š\nOS å¯ä»¥é€éæ’ç¨‹è®“ä¸€å€‹ç¡¬é«”æ–¼å¤šå€‹æ‡‰ç”¨ç¨‹å¼é–“åˆ‡æ›ä½¿ç”¨ï¼Œè€Œä¸æœƒæœ‰ä¸€å€‹æ‡‰ç”¨ç¨‹å¼éœ¸ä½”æ•´å€‹ç¡¬é«”è³‡æºï¼Œä¾‹å¦‚ç¶²å¡å¯åŒæ™‚è™•ç† server request ä¹Ÿå¯ç”¨æ–¼ ssl sesson ç‚ºä»€éº¼éœ€è¦ userspace TCP stack å¦‚æœé€é OS å‰‡è®€å¯«ç¡¬é«”è³‡æºæ™‚éœ€è¦æ¶‰åŠ user space / kernel space è³‡æ–™çš„è¤‡è£½èˆ‡ context switchï¼Œé€™æœƒå¸¶ä¾†é¡å¤–çš„ latency / CPU performance å½±éŸ¿\nä¾‹å¦‚ Googleã€Cloudflare é€™ç¨®ç¶²è·¯æµé‡éå¸¸å¤§çš„å…¬å¸ï¼Œå°±æœƒæœ‰å‹•æ©Ÿå»å®¢è£½åŒ– TCP stackï¼Œæ‰€è¬‚çš„ userspace TCP stack å°±æ˜¯ ç¹é(bypass) OS Kernelç›´æ¥å­˜å–ç¶²å¡ï¼Œé€™å¼µç¶²å¡å°±å°ˆé–€è¢«å–®ä¸€çš„æ‡‰ç”¨ç¨‹å¼æ‰€ä½¿ç”¨ï¼ŒOS çš„ç›£æ§å·¥å…· (iptable/netstat) ç­‰éƒ½ç„¡æ³•ä½¿ç”¨ï¼Œå…¶ä»–æ‡‰ç”¨ç¨‹å¼ä¹Ÿéƒ½ä¸èƒ½\nCloudflare æœ‰æåˆ°é€é Linux iptable å¤§æ¦‚å¯ä»¥è™•ç†æ¯ç§’ä¸€ç™¾è¬çš„ packetsï¼Œè€Œ Cloudflare åœ¨é­é‡æ”»æ“Šæ™‚æµé‡æœƒåœ¨ å–®å° server æ¯ç§’ä¸‰ç™¾è¬çš„ packetsï¼Œé€™ä¹Ÿæ˜¯ä»–å€‘éœ€è¦ç¹é kernel è‡ªè¡Œè™•ç†çš„å‹•æ©Ÿ\nä½†ç›®å‰æ²’æœ‰ç©©å®šçš„ open-source userspace TCP stack å¯ä»¥ä½¿ç”¨ï¼Œè¦è‡ªå·±ç¶­è­·é–‹ç™¼ï¼Œé™¤äº†åŸ·è¡Œå¤–å‘¨é‚Šçš„ debugã€monitor å·¥å…·éƒ½è¦è‡ªå·±æƒ³è¾¦æ³•æˆæœ¬å¾ˆé«˜ï¼Œæ‰€ä»¥ Cloudflare æ¡å–åŠç¹éçš„æ–¹å¼ï¼Œåªæœ‰ \u0026ldquo;RX queue\u0026rdquo; æœƒç¹é kernelï¼Œé€™å¸¶ä¾†çš„å¥½è™•æ˜¯äº«æœ‰ä¸€å®šçš„æ•ˆèƒ½æå‡ä¸”å…¶é¤˜ packets è™•ç†èƒ½ä»°è³´æ—¢æœ‰çš„å·¥å…·å¦‚ iptables/netstat\nå„ªåŒ– latency æ–‡ç« å‡ºè‡ªï¼šHow to achieve low latency with 10Gbps Ethernet\nå‰é¢å„ªåŒ–äº† throughputï¼Œç¾åœ¨è¦ä¾†çœ‹ latency å¦‚ä½•è¢«å„ªåŒ–ï¼Œé‡æ¸¬çš„åŸºæº–ç·šå¾å¹³å‡ 47.5 us é–‹å§‹\n1. æé«˜ read çš„é »æ¬¡ Linux 3.11 é–‹å§‹å¢åŠ äº† SO_BUSY_POLL çš„ socket é¸é …ï¼Œåœ¨æŒ‡å®šçš„æ™‚é–“å…§ kernel å°±æœƒå»è®€å– packet æå‡è®€å–çš„é »æ¬¡ï¼Œé€éå¢åŠ  CPU ä½¿ç”¨ç‡é™ä½ latency 7 us\nåŒæ¨£çš„é“ç†å¯ä»¥å¥—ç”¨åœ¨ user space ï¼Œé€é non-blocking read fd.recvmsg(MSG_DONTWAIT) å†å¾€ä¸‹é™ä½ 4 us\n2. pin process é€éæŒ‡å®š process åœ¨ç‰¹å®šçš„ CPU ä¸ŠåŸ·è¡Œæ¸›å°‘ context switchï¼Œé™ä½ 1 usï¼›\nä½†å¦‚åŒå…ˆå‰æåˆ°ï¼Œé è¨­ä¸€å€‹ RX queue åªèƒ½æœ‰å–®ä¸€ CPU è®€å–ï¼Œå¦‚æœå‰›å¥½æ‡‰ç”¨ç¨‹å¼ä¹Ÿåœ¨æœ€å¿™ç¢Œçš„ CPU ä¸Šï¼Œå‰‡å»¶é²åè€Œæœƒå¢åŠ  2 us\n3. å°‡ RX queue ç¶å®šåˆ°æŒ‡å®š CPU ç‚ºäº†é¿å…ä¸Šé¢å•é¡Œï¼Œå¯ä»¥é€é Indirection Table èª¿æ•´ RX queue å¦‚ä½•åˆ†é…åˆ° CPU è®€å–ï¼Œä½œè€…é™å®šåªæœ‰åœ¨åŒä¸€å€‹ NUMA node çš„ CPU æ‰èƒ½è®€å– RX queue\nåŒæ¨£çš„åšæ³•ä¹Ÿå¯ä»¥ç”¨ Flow steering å¯¦ä½œï¼ŒæŒ‡å®šç‰¹å®šçš„ flow åˆ°ç‰¹å®šçš„ RX queue ä¸Šé¢ï¼Œé¡å¤–ç”¨é€”æ˜¯ç¢ºä¿åœ¨é«˜æµé‡æƒ…æ³ä¸‹æŒ‡å®šçš„å°åŒ…é‚„èƒ½è¢«ç‰¹å®šçš„ CPU è™•ç†ï¼Œå¦‚ SSH/BGPï¼Œä¹Ÿå¯ä»¥ç”¨ä¾†é˜²å µ DDoS æ”»æ“Š\n1 client$ sudo ethtool -N eth2 flow-type udp4 dst-ip 192.168.254.1 dst-port 65500 action 1 åœ¨å‚³é€ç«¯ä¹Ÿå¯ä»¥æŒ‡å®šé¡ä¼¼çš„äº‹æƒ…ï¼Œèª¿æ•´ TX queue é€éå“ªå€‹ CPU ç™¼é€çš„æ©Ÿåˆ¶\nå°çµ å†é€šéä¸€äº›å„ªåŒ–ï¼Œå¾åŸæœ¬ 47 us é™åˆ° 26 usï¼›å¦‚æœæ˜¯é€é bypass kernel å‰‡è¿‘ä¸€æ­¥ä¸‹é™åˆ° 17 us\n","date":"2022-02-02T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-02-02-%E7%AD%86%E8%A8%98cloudflare-%E5%84%AA%E5%8C%96%E5%B0%81%E5%8C%85%E6%8E%A5%E6%94%B6%E7%9A%84%E9%81%8E%E7%A8%8B/","title":"ç­†è¨˜ï¼šCloudFlare å„ªåŒ–å°åŒ…æ¥æ”¶çš„éç¨‹"},{"content":"åœ¨ 2022 å¹´ä¸€é–‹å§‹å°±ä¸Šåˆ°å¦‚æ­¤æ‰å¯¦ã€æœ‰æ”¶ç©«çš„èª²ç¨‹çœŸçš„æ˜¯å¤ªè®šäº†ï¼Œä¹‹å‰åœ¨åŒäº‹çš„ä»‹ç´¹ä¸‹èªè­˜äº† Event Storming ä¸¦æ¥è§¸åˆ°ä¸€äº› DDD çš„åè©ï¼Œé–‹å§‹åœ¨ç¶²è·¯ä¸Šé€éå½±éŸ³èª²ç¨‹ Domain-Driven Design Fundamentalsã€éµäººè³½ç³»åˆ—æ–‡ç« å­¸ç¿’ï¼Œåœ¨ä¸Šèª²å‰ä¹Ÿå¤§æ¦‚ç¿»äº†ä¸€ä¸‹ DDD è—çš®æ›¸ï¼Œä»¥ä¸Šçš„æ•™æéƒ½å¾ˆä¸éŒ¯ï¼Œä¹ŸæŠŠåè©è§£é‡‹è·Ÿ DDD æµç¨‹å¤§è‡´æ¢³ç†ä¸€éï¼Œä½†æ˜¯è“‹ä¸Šæ›¸æœ¬ã€é—œæ‰ç¶²é ï¼Œæˆ‘è¦æ€éº¼å°å…¥ï¼Ÿ\nä¾‹å¦‚èªª DDD æåˆ°é–‹ç™¼äººå“¡è¦æ‰¾é ˜åŸŸå°ˆå®¶ä¸€èµ·æ‰¾å‡º Domain Modelï¼Œä¸¦å°‡ Domain åŠƒåˆ†å‡ºé©åˆçš„ Bounded Contextï¼Œä½†ä»€éº¼æ˜¯é©åˆï¼Ÿæˆ‘è©²æ€æ¨£çŸ¥é“ä¸é©åˆï¼Ÿç•¶æˆ‘æ‰¾åˆ°é©åˆçš„\u0026quot;æ„Ÿè¦º\u0026quot; A-ha Moment æ˜¯æ€æ¨£æœƒç™¼ç”Ÿï¼Ÿ\nåœ¨ç¿»é–±ã€ŠClean Architectureã€‹ä¸€æ›¸ä¹Ÿæœ‰åŒæ„Ÿï¼Œæ–‡ç« å¯«å¾—éå¸¸æ¸…æ¥šï¼Œä¹Ÿé€é Uncle Bob çš„æ–‡ç­†é‡æ–°èªè­˜äº†è»Ÿé«”æ¶æ§‹ï¼Œä½†ç„¶å¾Œå‘¢ï¼Ÿæˆ‘è©²æ€éº¼å¯¦ä½œï¼Ÿ\nåœ¨ DDD ä¸€æ›¸é—¡è¿°äº†è»Ÿé«”çš„å»ºç«‹éœ€è¦æ”œæ‰‹ Domain Expert å®šç¾© Domain Modelï¼Œä¸¦ç¢ºä¿ç¨‹å¼å¯¦ä½œè¦è·Ÿ Model ä¿æŒä¸€è‡´ï¼Œåœ¨åœ–è¡¨ä¸­æ‹†åˆ†äº† Entity / Value Object ç­‰ï¼Œä»¥åŠæä¾›å¾ˆå¤šå…ƒä»¶é–“æºé€šçš„ Pattenï¼Œä½†æ²’æœ‰èªªå¯¦ä½œèµ·ä¾†æœƒæ€æ¨£ (è¬›ç™½äº†æ›¸æœ¬ä¸­æ²’æœ‰å¤ªå¤šçš„ç¨‹å¼ç¢¼) åœ¨ ã€ŠClean Architectureã€‹ ä¸­æè¿°çš„ SOLID / åˆ†å±¤åŸå‰‡ / ä¾è³´æ€§åŸå‰‡ï¼Œä½†æ²’æœ‰èªªå…ƒä»¶æ‰€è¬‚çš„è·è²¬æ€éº¼åŠƒåˆ†ï¼Œæœ‰å¾ˆå¤šå¯¦ä½œçš„ç´°ç¯€è·Ÿå–æ¨ä¸¦æ²’æœ‰å¤ªå¤šæ¡ˆä¾‹\nTeddy å°‡å…©è€…çµåˆï¼Œç”¨è‡ªå·±è¨­è¨ˆçš„ Kanban ç³»çµ±ï¼Œå¸¶è‘—å­¸å“¡è·‘éä¸€æ¬¡ DDD å»ºæ¨¡çš„éç¨‹ï¼Œä¸¦é€éã€ŠClean Architectureã€‹å¯¦ä½œï¼Œä»–èªªä»–å¾ˆæ¥è¿‘ç†æƒ³çš„è»Ÿé«”\næ”¹å‹•çš„æˆæœ¬åªè·Ÿéœ€æ±‚ç¯„åœæœ‰é—œï¼Œè·Ÿç³»çµ±å­˜åœ¨çš„æ™‚é–“ç„¡é—œ\né€éä¸€å€‹éšæ®µä¸€å€‹éšæ®µçš„è¨è«–èˆ‡æª¢è¨ï¼Œå…ˆè©¦éŒ¯å†å›é ­è§£é‡‹åè©ï¼Œé€™æ¨£çš„å­¸ç¿’æ–¹å¼æˆ‘è¦ºå¾—æ¯”çœ‹æ›¸ã€çœ‹å½±ç‰‡é‚„è¦å¥½å¾ˆå¤šï¼Œä»¥ä¸‹æˆ‘å°‡ç”¨æ™‚é–“è»¸åˆ†äº« Teddy ä¸Šèª²çš„å…§å®¹ä»¥åŠæˆ‘å€‘å°çµ„è¨è«–çš„æ¼”é€²ï¼Œæœƒæœ‰å¤§é‡éŒ¯èª¤ç„¶å¾Œè¢«ç³¾æ­£ ~æ‰“è‡‰~ çš„æ¡ˆä¾‹ XD\nå…§å®¹æœ‰é»ç´°ï¼Œä¸æœƒå®Œæ•´ä»‹ç´¹ DDD è·Ÿ Event Stormingï¼Œåªæœƒåˆ†äº«åœ¨å¯¦ä½œä¸ŠéŒ¯èª¤èˆ‡è€å¸«çš„ç³¾æ­£\næ¨å€‹èª²ç¨‹é é¢ é ˜åŸŸé©…å‹•è¨­è¨ˆèˆ‡ç°¡æ½”æ¶æ§‹å…¥é–€å¯¦ä½œç­ï¼Œå¯¦éš›åƒèˆ‡å°çµ„è¨è«–æœƒæ¸…æ™°å¾ˆå¤š\nDomain Driven Design DDD åŸºæœ¬ä»‹ç´¹ 1. ä»€éº¼æ˜¯ Domain Domain å¯ä»¥è¢«æ‹†åˆ†ç‚º Problem Domain ä»¥åŠ Solution Domainï¼ŒProblem Domain æ˜¯æŒ‡å¯¦éš›ç™¼ç”Ÿåœ¨ä¸–ç•Œä¸Šçš„å•é¡Œï¼Œä¹Ÿå°±æ˜¯å…¬å¸æ‰€é¢è‡¨çš„å•†æ¥­å•é¡Œï¼Œä¾‹å¦‚å¤–å‡ºæƒ³è¦å«è»Šã€è‚šå­é¤“æƒ³è¦é»å¤–è³£ç­‰ï¼Œä½†æ˜¯ä¸–ç•Œä¸Šçš„å•é¡Œå¤ªå¤šäº†ï¼Œä¸æœƒæ¯ä¸€å€‹éƒ½é—œæ³¨ï¼Œæ‰€ä»¥ç¸½åˆä¾†èªª\nåˆ©å®³é—œä¿‚äººæ‰€åœ¨ä¹çš„å¯¦éš›å•é¡Œå°±æ˜¯ä½ çš„ Domain\nUber åœ¨ä¹ç”¨æˆ¶å¤–å‡ºçš„é€šå‹¤å•é¡Œ / Food Panda åœ¨ä¹ç”¨æˆ¶è‚šå­é¤“æƒ³é»å¤–è³£æœè…¹çš„å•é¡Œï¼Œå„è‡ªæœ‰å„è‡ªçš„ Problem Domainï¼Œä¸¦å°æ­¤æå‡ºå„è‡ªçš„è§£æ³• Solution Domainï¼Œä¹‹å¾Œè¨è«–å°‡ Solution Domain é™ç¸®åœ¨è»Ÿé«”è¨­è¨ˆä¸Š\nå›æ­¸é–‹ç™¼çš„æ ¹æœ¬ï¼Œç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ä¸€ç›´è·Ÿ PM / åˆ©å®³é—œä¿‚äºº (å¾ŒçºŒä»¥é ˜åŸŸå°ˆå®¶ä»£ç¨±) ä¸æ–·é‡æ¸…å•é¡Œï¼Œå› ç‚ºå•é¡Œæ‰æ˜¯é©…å‹•ä¸€åˆ‡çš„æœ¬è³ªï¼Œå¦‚æœä»Šå¤©ä¸ç”¨å¯«ä¸€è¡Œç¨‹å¼ç¢¼å°±èƒ½è§£æ±ºå•é¡Œï¼Œé‚£ä½•å¿…å‹•æ‰‹ï¼Œé‡æ¸…å•é¡Œæ˜¯é–‹ç™¼çš„ç¬¬ä¸€æ­¥\n2. ä»€éº¼æ˜¯ Domain Model æœ‰äº† Problem Domainï¼Œéå¾€çš„ç¿’æ…£æ˜¯ç›´æ¥é€²å…¥é–‹ç™¼è¨­è¨ˆï¼Œä¹Ÿå°±æ˜¯å°æ‡‰åˆ° Solution Domainï¼Œä½†é€™å…©å€‹ Domain é–“æœ‰ä¸€å€‹å¾ˆå¤§çš„é´»æº (é™„åœ–è·¯å¾‘ A)ï¼Œé–‹ç™¼äººå“¡ä»¥ç‚ºè‡ªå·±è½æ‡‚äº†éœ€æ±‚å°±é–‹å§‹å¯¦ä½œï¼Œè€Œé ˜åŸŸå°ˆå®¶ä¹Ÿä»¥ç‚ºé–‹ç™¼äººå“¡çœŸçš„æ‡‚äº†ï¼Œæœ€å¾Œç­‰ç³»çµ±é©—æ”¶æ™‚æ‰ç™¼ç¾æ ¹æœ¬åšéŒ¯äº†\nDDD æå€¡é ˜åŸŸå°ˆå®¶èˆ‡é–‹ç™¼äººå“¡æ‡‰è©²è¦å…ˆé”æˆå…±è­˜ï¼Œå°‡ Domain å»ºç«‹å‡ºå°æ‡‰çš„æ¨¡å‹ Modelï¼Œè®“é›™æ–¹å°‡å…±è­˜è½‰æ›ç‚ºåœ–å½¢ï¼Œä¸¦åœ¨éç¨‹ä¸­å»ºç«‹ Ubiquitous Language å…±åŒèªè¨€ï¼Œç­‰ç¢ºèªå¾Œé–‹ç™¼äººå“¡æ‰å»å¯¦ä½œ (é™„åœ–è·¯å¾‘ B)\næ¯”å°è·¯å¾‘ A ã€Bï¼Œçœ‹ä¼¼ B ç¹äº†é»é è·¯ï¼Œä½†å…ˆé€é Domain Model é—¡è¿° Solution çš„é•·ç›¸ä¸¦æŠ½é›¢å¯¦ä½œï¼Œæ‰èƒ½ç”¨æœ€å°çš„æˆæœ¬ï¼Œè®“é ˜åŸŸå°ˆå®¶åŠæ—©ç¢ºèªè§£æ³•çš„æ–¹å‘æ­£ä¸æ­£ç¢º\nQ: æ˜¯ä¸æ˜¯æ‰€æœ‰å•é¡Œéƒ½è¦å»º Domain Model?\nA: ä¸æ˜¯ï¼Œåªæœ‰ç•¶å•†æ¥­é‚è¼¯è¶³å¤ è¤‡é›œæ‰éœ€è¦ï¼Œå–®ç´”çš„ CRUDã€å ±è¡¨ç³»çµ±æ˜¯ä¸éœ€è¦çš„\nEvent Storming æ˜¯ä¸€å€‹å»ºç«‹ Domain Model çš„æ–¹æ³•ï¼Œå¾ High Level åˆ° Low Level æŒçºŒæ¼”åŒ–çš„éç¨‹\n3. Domain Model è¦è¶ŠçœŸè¶Šå¥½å— æ‰€è¬‚çš„ã€ŒçœŸã€æ˜¯æŒ‡å¯¦éš›ä¸–ç•Œçš„çœŸå¯¦æ€§ï¼ŒTeddy ä¸Šèª²èˆ‰ä¾‹ï¼šã€Œæ¨£å“å±‹æ˜¯ä¸æ˜¯è¶ŠåƒçœŸçš„å¯¦é«”å±‹è¶Šå¥½ï¼Ÿã€\nç­”æ¡ˆæ˜¯ã€Œä¸ä¸€å®š!ã€ï¼Œé‡æ–°æ€è€ƒ Domain Model æ˜¯ Solution Domain çš„ä¸€ç’°ï¼Œæ‰€ä»¥çœŸæ­£çš„é‡é»æ˜¯æºé ­çš„ Problem Domainï¼Œä»Šå¤©å»ºå•†è“‹æ¨£å“å±‹æ˜¯å¸Œæœ›ç”¨æˆ¶è³¼è²·å¯¦é«”å±‹ï¼Œä½†å¦‚æœä»Šå¤©å»ºå•†è“‹å®Œå°±éŠ·å”®ä¸€ç©ºï¼Œé‚£æ ¹æœ¬é€£æ¨£å“å±‹éƒ½ä¸ç”¨è“‹\nåªè¦ Model èƒ½å¤ å‰›å¥½è§£æ±ºå•é¡Œå°±å¥½ï¼Œover design æˆ– under design éƒ½æ˜¯ä¸å¥½çš„ï¼Œé€™é»åœ¨å¾ŒçºŒçš„å¯¦éš›æ“ä½œæœƒå†è£œå……\nEvent Storming ä»¥ Kanban ç³»çµ± ezKanbanï¼ŒTeddy æ“”ä»»é ˜åŸŸå°ˆå®¶ (å…¼ä»»é–‹ç™¼äººå“¡XD) å¸¶å¤§å®¶è·‘é Event Stormingï¼Œä»¥ä¸‹ä»‹ç´¹ Kanban çš„æ ¸å¿ƒå•†æ¥­é‚è¼¯\nVisualizeï¼šè¦–è¦ºåŒ–è¡¨é” Limit WIPï¼šæ¯ä¸€å€‹å·¥ä½œéšæ®µçš„é€²è¡Œä¸­å·¥ä½œ (WIP) æœ‰æ•¸é‡é™åˆ¶ Manage Flowï¼šç®¡ç†å·¥ä½œæµç¨‹ å»ºæ¨¡å·¥å…·ä½¿ç”¨ Miro é€²è¡Œé †åºæŒ‰ç…§éšå±¤å¾ Big Picture é–‹å§‹èˆ‡é ˜åŸŸå°ˆå®¶è¨è«–æ ¸å¿ƒçš„ç”¨æˆ¶è¡Œç‚ºï¼Œæ¥è‘—åˆ° Process Modeling è£œå……æ›´å¤šçš„è¦å‰‡ã€è¡Œå‹•ï¼Œæœ€å¾Œæ‰æ˜¯ Software Design 1. Big Picture: æ‰¾å‡º Domain Event å…ˆæ‹‰å‡ºä¸€æ¢ç®­é ­è¡¨é”æ™‚é–“è»¸ï¼Œå…ˆå¾Œé †åºï¼Œå°‡ User Story ä¸­çš„é—œéµäº‹ä»¶ (Domain Event) å…ˆæ¢åˆ—å‡ºä¾†ï¼Œæ‰€è¬‚çš„äº‹ä»¶æ˜¯æœƒæ”¹è®Šç³»çµ±ç‹€æ…‹ï¼Œä¾‹å¦‚é›»å•†ç³»çµ±ç”¨æˆ¶åŠ è³¼ç‰©è»Šã€çµå¸³ç­‰ï¼Œåä¹‹è®€å–ä¸æ˜¯äº‹ä»¶ï¼Œå› ç‚ºä¸æœƒæ”¹è®Šç³»çµ±ç‹€æ…‹ï¼Œä¸ç®¡ Data è®€å–å¹¾æ¬¡éƒ½ä¸æœƒæœ‰è®ŠåŒ–\näº‹ä»¶æ˜¯ä»£è¡¨ç™¼ç”Ÿéçš„äº‹æƒ…ï¼Œæ‰€ä»¥éƒ½æœƒç”¨éå»å¼è¡¨é”ï¼Œä¾‹å¦‚çœ‹æ¿ç³»çµ±ä¸­çš„\nWorkflow Created Workflow Deleted Stage WIP set ç­‰ç­‰ åœ¨è¨è«–éç¨‹ä¸­ï¼Œå‹™å¿…è¨˜å¾—\nä¸è¦å‡ºç¾æŠ€è¡“ç”¨èªï¼Œä¾‹å¦‚è³‡æ–™åº«æ€éº¼å„²å­˜ã€å¯¦ä½œè¦å¥—ä»€éº¼ Design Patten ä¸è¦è¢« UI ç¶æ¶äº†! å› ç‚ºæˆ‘å€‘æ˜¯çœ‹è‘— Teddy å·²ç¶“å¯¦ä½œå¥½çš„ ezKanbanï¼Œæ‰€ä»¥ Domain Event å¾ˆå¤šï¼Œå¯¦å‹™ä¸Šçœ‹å„è‡ªç³»çµ±è¦æ¨¡ï¼Œè€Œä¸” Event Storming æ˜¯æŒçºŒæ¼”é€²ï¼Œä¸ç”¨æ±‚ä¸€æ­¥åˆ°ä½ ä¸Šåœ–æ˜¯æˆ‘å€‘å°çµ„å»ºç«‹ Domain Eventï¼Œå…¶ä¸­æœ‰ä¸‰é»éŒ¯èª¤\na. æ™‚é–“è»¸é †åºæ€§ æˆ‘å€‘ä¸€é–‹å§‹æŠŠ User Created / User Logined æ”¾åœ¨åŒä¸€åˆ—ä¸Šï¼ŒåŒä¸€åˆ—åœ¨ Event Storming ä»£è¡¨é€™å…©å€‹äº‹ä»¶æ˜¯åœ¨å·®ä¸å¤šæ™‚é–“é»ç™¼ç”Ÿï¼Œä½†ç†è«–ä¸Š User Create å¿…ç„¶åœ¨ User Logined ä¹‹å‰ï¼Œæ‰€ä»¥ä¸è©²æ”¾åœ¨åŒä¸€åˆ—ä¸Š\nb. ä¸è¦è¢« UI ç¶æ¶ é€™æ˜¯ä¸€å€‹éå¸¸æœ‰è¶£çš„æ¡ˆä¾‹ï¼Œåœ¨ ezKanban ä¸­ä½ å¿…é ˆåœ¨ç•«é¢ä¸Šé»æ“Šã€ŒLayout Editã€æ‰èƒ½ç·¨è¼¯å·¥ä½œæµç¨‹çš„æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘å€‘çµ„å…§è¨è«–å¾ˆç›´è¦ºçš„æƒ³é€™å€‹äº‹ä»¶å¾ˆé‡è¦ï¼Œæ‰€ä»¥å°±è£œäº†ä¸€å€‹ ã€ŒLayout Mode Enteredã€ï¼Œä½†è€å¸«èªªä¸å°!! è¢« UI ç¶æ¶äº†ï¼Œé€™åªæ˜¯ä¸€å€‹å¯¦ä½œç´°ç¯€ï¼Œæˆ‘ä»Šå¤©å¯ä»¥æ›ä¸€å€‹æŒ‰éˆ•æˆ– UI æµç¨‹åšåˆ°åŒä¸€ä»¶äº‹ï¼Œé€™å±¬æ–¼æ‡‰ç”¨å±¤é¢çš„é‚è¼¯\nDomain Event åˆå¯ç´°åˆ†æˆå…©ç¨® Core Domain Event / Application Domain Eventï¼Œå‰è€…æ˜¯æ»¿è¶³æ ¸å¿ƒå•†æ¥­é‚è¼¯çš„äº‹ä»¶ã€å¾Œè€…æ˜¯æ‡‰ç”¨ç¨‹å¼åŸ·è¡Œæ™‚éœ€è¦çš„äº‹ä»¶ï¼Œä»Šå¤©ä»¥çœ‹æ¿ç³»çµ±ï¼Œç”¨æˆ¶å“ªæœƒé—œå¿ƒä»€éº¼ Layout Modeï¼Œé‚£æ˜¯ä½ å¯¦ä½œçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¸è©²æŠŠé€™å€‹ Event æ”¾åœ¨ä¸Šé¢\næˆ‘è‡ªå·±å¾Œä¾†åœ¨åæ€é€™ä»¶äº‹æƒ…ï¼Œæˆ‘å˜—è©¦ç”¨é€™æ¨£çš„é‚è¼¯å»é‡æ¸…\næˆ‘èƒ½ä¸èƒ½ç”¨ä¸åŒçš„ UI Flow å–ä»£ç•¶å‰çš„äº‹ä»¶ï¼Ÿ ä¾‹å¦‚åœ¨ Board é é¢å°±å€åˆ†å‡ºã€Œç‰ˆä½èª¿æ•´ã€/ã€Œå·¥ä½œèª¿æ•´ã€ï¼Œå¦‚æœå¯ä»¥çš„è©±ï¼Œé‚£å°±æ˜¯æ‡‰ç”¨äº‹ä»¶ ä»Šå¤©æˆ‘å¯¦ä½œåœ¨å¤šå¹³å° Web / App / Server éƒ½éœ€è¦é€™å€‹äº‹ä»¶å—ï¼Ÿå¦‚æœè¦é‚£æœ‰å¯èƒ½æ˜¯æ ¸å¿ƒï¼Œå¦‚æœåªæœ‰ Web è¦å¯¦ä½œå…¶ä»–å¹³å°ä¸ç”¨ï¼Œé‚£è‚¯å®šæ˜¯æ‡‰ç”¨äº‹ä»¶ é€™éº¼åœ¨æ„æ˜¯ä¸æ˜¯ Core Domain Event çš„ç”¨æ„æ˜¯è®“ Domain Model ä¿æŒç°¡æ½”ï¼Œå¤ªå¤šç´°ç¯€åƒé›œæœƒæ··æ·†è¨è«–\nc. ä¸è¦è¢« DB ç¶æ¶ - ä»»å‹™é©…å‹•è€ŒéæŒ‡ä»¤é©…å‹• åœ¨æ¢åˆ— Domain Model æ™‚ï¼Œæˆ‘èˆ‡çµ„å“¡éƒ½æœ‰ä¸€å€‹ç–‘å• ã€Œä¸€å€‹ Stage æœ‰ 10 å€‹å±¬æ€§éƒ½èƒ½å¤  CRUDï¼Œé‚£æˆ‘è¦å…¨éƒ¨åˆ—å‡ºä¾†å—ï¼Ÿä¾‹å¦‚ Stage çš„æ¨™é¡Œã€èªªæ˜æ¬„ç­‰ï¼Œé‚£æˆ‘æ˜¯è¦å¯«ä¸€å€‹ Stage Updated å°±å¥½é‚„æ˜¯è¦å¯« Stage Name Updatedï¼Ÿã€\né™¤äº†ä¸è¦è¢« UI ç¶æ¶å¤–ï¼Œä¹Ÿä¸è¦è¢«è³‡æ–™åº«ç¶æ¶äº†! ä»Šå¤©ç”¨æˆ¶æ‰ä¸ç®¡ä½ æ€éº¼ CRUDï¼Œä»–çœŸæ­£åœ¨æ„æ˜¯èƒ½ä¸èƒ½å®Œæˆä»–æ‰‹ä¸­çš„ä»»å‹™ï¼Œä¾‹å¦‚èªªä»Šå¤©æˆ‘å» ATM é ˜éŒ¢ï¼Œç³»çµ±é¡¯ç¤º\nèªªæ³• A: æ‚¨å·²æé ˜ 1000 å…ƒ èªªæ³• B: å·²æ›´æ–°æ‚¨çš„å¸³æˆ¶é¤˜é¡ç‚ºåŸé¤˜é¡æ¸›å»1000 å…ƒ ç›¸ä¿¡ä½ ææ¬¾å¾Œçœ‹åˆ°èªªæ³• B æ‡‰è©²æœƒå‚»çœ¼ï¼Œè«‹ä»¥ã€Œç”¨æˆ¶æƒ³è¦å®Œæˆä»€éº¼ä»»å‹™ã€çš„è§’åº¦æè¿° Domain Event\nd. ç”¨èªªæ•…äº‹çš„æ–¹å¼å»é‡æ¸… Model è¡¨é”åŠ› æˆ‘åœ¨æ“ä½œ ezKanban å…ˆè·‘äº†å»ºç«‹å·¥ä½œæµç¨‹ï¼Œæœ€å¾Œæ‰ç™¼ç¾ ezKanban æœ‰ Team çš„æ¦‚å¿µï¼ŒTeam å¯ä»¥é‚€è«‹å…¶ä»– User ç•¶ä½œ Member å…±äº« Projectï¼Œå› ç‚ºæˆ‘æ¯”è¼ƒæ™šçœ‹åˆ°æ‰€ä»¥ Team ç›¸é—œçš„äº‹ä»¶æ”¾åœ¨æ™‚é–“è»¸å¾Œé¢\næœ€å¾Œ Teddy å•èªªï¼šã€Œé€™æ¨£çš„ Model è¡¨é”äº†ä»€éº¼å«æ„ï¼Ÿã€Model çš„æ„ç¾©åœ¨æ–¼åœ–å½¢åŒ–æˆ‘å€‘æƒ³è¦è§£æ±ºçš„å•é¡Œèˆ‡ç™¼ç”Ÿé †åºï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ¶çš„ä½¿ç”¨æ­·ç¨‹èˆ‡æ¯ä¸€å€‹ä½¿ç”¨æ¡ˆä¾‹ï¼Œä»Šå¤©ç”¨èªªæ•…äº‹çš„æ–¹å¼æœƒåƒ\næ•…äº‹ A:ã€Œç”¨æˆ¶ä»Šå¤©æƒ³è¦ä½¿ç”¨çœ‹æ¿ç³»çµ±ï¼Œä»–å…ˆè¨»å†Šäº†å¸³è™Ÿä¸¦ç™»å…¥ï¼Œæ¥è‘—å»ºç«‹å°ˆæ¡ˆï¼Œä¸¦é–‹å§‹è¨­å®šè‡ªå·±çš„å·¥ä½œæµç¨‹\u0026hellip;\u0026hellip; æœ€å¾Œä»–é‚€è«‹ä»–çš„æˆå“¡åŠ å…¥ï¼Œå¤§å®¶ä¸€èµ·æ“ä½œçœ‹æ¿ã€ æ•…äº‹ B: ã€Œç”¨æˆ¶ä»Šå¤©æƒ³è¦ä½¿ç”¨çœ‹æ¿ç³»çµ±ï¼Œä»–å…ˆè¨»å†Šäº†å¸³è™Ÿä¸¦ç™»å…¥ï¼Œæ¥è‘—å»ºç«‹åœ˜éšŠï¼Œé‚€è«‹ä»–çš„æˆå“¡åŠ å…¥ï¼Œå¤§å®¶ä¸€èµ·æ“ä½œçœ‹æ¿ï¼Œæ¥è‘—å»ºç«‹å°ˆæ¡ˆï¼Œä¸¦é–‹å§‹è¨­å®šåœ˜éšŠçš„å·¥ä½œæµç¨‹\u0026hellip;\u0026hellip;ã€ å…©å€‹æ•…äº‹éƒ½èªªå¾—é€šï¼Œä½† Teddy è¦ºå¾—æ•…äº‹ B æ›´ç¬¦åˆä»–çš„ä½¿ç”¨å ´æ™¯ï¼Œåœ˜éšŠçš„å»ºç«‹æœƒåœ¨å·¥ä½œæµç¨‹ä¹‹å‰ï¼Œæ‰€ä»¥èª¿æ•´å¾Œçš„ Domain Event å¤§è‡´é•·é€™æ¨£ 2. Big Picture - åŠƒåˆ† Bounded Context æ´‹æ´‹ç‘ç‘åˆ—å‡º Domain Event å¾Œï¼Œæ¥ä¸‹ä¾†è¦ä¾†åˆ†ç¾¤ï¼Œæƒ³åƒæˆæ˜¯è²·æˆ¿ç•«éš”é–“ï¼Œè¨­è¨ˆåœ–æ‡‰è©²è¦èƒ½æ¸…æ¥šè¾¨è­˜å‡ºé€™æ˜¯ä¸€å€‹å•†å‹™è¾¦å…¬å®¤é‚„æ˜¯ä¸€å€‹å°å®¶åº­è‡ªä½ç”¨ï¼Œé€ééš”é–“å»è¡¨é”ç³»çµ±çš„æ„åœ– *é™„åœ–å¾ Google æœå°‹ï¼Œä¸ç”¨æ‡‚å®¤å…§è¨­è¨ˆä½†ä¹Ÿå¤§è‡´èƒ½çœ‹å‡ºå·¦å³å…©å¼µåœ–çš„ä¸åŒ\næˆ‘å€‘å°çµ„ä¸€é–‹å§‹æ€è€ƒæ–¹å¼æ˜¯ã€Œä¸ç„¶å°±æ¯å€‹ç‰©ä»¶ä¸€é–“ï¼ŒWorkflow ä¸€é–“ / Board ä¸€é–“ç­‰ã€ï¼Œå¦‚åœ–ç¤º Teddy çœ‹åˆ°æˆ‘å€‘å¦‚æ­¤è¨­è¨ˆï¼Œä»–åå•èªªã€Œä½ å€‘çš„éš”é–“æœ‰åæ‡‰å‡º \u0026ldquo;çœ‹æ¿ç³»çµ±\u0026rdquo; é€™å€‹æ„åœ–å—ï¼Ÿå¦‚æœå¾å¤–éƒ¨ä½¿ç”¨è€…çš„è§’åº¦ï¼Œä»–çœ‹åˆ° Workflow / Board / Stage é€™éº¼å¤šç´°ç¯€å°å—ï¼Ÿã€\næ­£ç¢ºçš„éš”é–“æ‡‰è©²æ˜¯ å€åˆ†æˆä¸‰å¡Šï¼š\nCore Domainï¼šKanban æ˜¯æˆ‘å€‘çš„æ ¸å¿ƒé ˜åŸŸï¼Œåƒè¬ä¸è¦å¤–åŒ… Generic Domainï¼šUser / Team å±¬æ–¼é€šç”¨æ€§åŠŸèƒ½ Support Domainï¼šåœ–ä¸Šæ²’æœ‰ï¼Œå¦‚é‡‘æµã€å¤–éƒ¨é€šçŸ¥ç³»çµ±ï¼Œé€™ç¨®çš„æ‰¾å¤–åŒ…å³å¯ï¼Œä¸ä¸€å®šè¦è‡ªå·±é–‹ç™¼ å¦‚ä½•çŸ¥é“è‡ªå·±çš„éš”é–“æ˜¯å¦æ­£ç¢ºï¼Ÿå›åˆ°å•†æ¥­é‚è¼¯èˆ‡èªªæ•…äº‹çš„æ–¹å¼ï¼ŒåŠƒåˆ† Bounded Context å¾Œæ˜¯å¦èƒ½æ­£ç¢ºæ‹†è§£å‡ºå…¬å¸çš„æ ¸å¿ƒèˆ‡éæ ¸å¿ƒå•†æ¥­é‚è¼¯\nå¤§å®¶æœ€é—œå¿ƒçš„å¾®æœå‹™ï¼Œé€šå¸¸æ˜¯ä¸€å€‹ Bounded Context ä¸€å€‹éƒ¨ç½²çš„å…ƒä»¶\n3. Big Picture - åŠ å…¥ Role / Externel System åŠ å…¥è§¸ç™¼çš„è§’è‰² / å¤–éƒ¨ç³»çµ±ï¼Œé€™ä¸€æ­¥é©Ÿç›¸å°å–®ç´”ï¼Œè§’è‰²æ˜¯ç³»çµ±ä¸­å‹•ä½œçš„åŸ·è¡Œè€… HotSpot æ˜¯ç•¶è¨è«–éç¨‹å¡ä½ã€ç™¼ç”Ÿæ„è¦‹ä¸åŒã€å‘½åä¸åŒæ™‚å¯ä»¥è²¼è‘—è¨»è¨˜ï¼Œé¿å…è¨è«–è¢«å¡ä½ï¼Œæœ€å¾Œå¯ä»¥çœ‹å“ªä¸€å€‹å€å¡Šæ˜¯å¤§å®¶æœ€æ²’æœ‰å…±è­˜çš„\n4. Process Modeling - åŠ å…¥ Command / Read Model é€™ä¸€æ­¥ç›¸å°å–®ç´”\nCommand æ˜¯è§¸ç™¼ Domain Event çš„å‹•ä½œï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æŠŠå®Œæˆå¼æ”¹æˆç¾åœ¨å¼è¡¨é” Read Model å‰‡æ˜¯å®Œæˆ Command æ‰€éœ€çš„åƒæ•¸ a. å»ºç«‹äº‹ä»¶æ˜¯å¦è¦å‚³å…¥ id æœ‰è¶£çš„å°ç´°ç¯€æ˜¯ Create Board æ™‚æˆ‘å€‘æŠŠ board_id ä¹Ÿå¯«å‡ºä¾†ï¼Œå°çµ„è¨è«–æ™‚æœƒè¦ºå¾— DB æœƒè‡ªå‹•ç”¢ç”Ÿ id æ‰€ä»¥ä¸ç”¨å¯«åˆ° read modelï¼Œä½† Teddy èªª ã€ŒéŒ¯ï¼Œæˆ‘å“ªç®¡ä½  id æ˜¯ DB ç”¢ç”Ÿé‚„æ˜¯å‰ç«¯ç”¨ UUID ç”¢ç”Ÿï¼Œé€™æ˜¯å¯¦ä½œç´°ç¯€ï¼ŒBoard å°±æ˜¯éœ€è¦ id è­˜åˆ¥ã€ï¼Œå†æ¬¡å¼·èª¿ï¼Œä¸è¦é™·å…¥ UI/DB çš„ç´°ç¯€\n5. Process Modeling - åŠ å…¥Policy Policy/Rule/Process æ˜¯æŒ‡ äº‹ä»¶å®Œæˆå¾Œè§¸ç™¼çš„æµç¨‹ï¼Œåƒè¬ä¸è¦è·Ÿå‹•ä½œéœ€è¦å®Œæˆçš„é©—è­‰ææ··ï¼Œä¾‹å¦‚èªª\nè¼¸å…¥ Email è¨»å†Šæ™‚ï¼ŒEmail å¿…é ˆç¬¦åˆæ ¼å¼ =\u0026gt; é€™æ˜¯é©—è­‰ å¯†ç¢¼è¼¸éŒ¯ä¸‰æ¬¡å¾Œï¼Œéœ€è¦å°é–å¸³è™Ÿ =\u0026gt; é€™æ˜¯ Policy é©—è­‰æ˜¯å¯¦ä½œç´°ç¯€åœ¨ Event Storming ä¸­ä¸è¡¨é”ï¼ŒPolicy æ‰æ˜¯æˆ‘å€‘ç¾éšæ®µè¦é—œæ³¨çš„ï¼Œä»¥ä¸‹æ˜¯èˆ‰ä¾‹ã€Œå…¨å®¶æ¨å‡ºé ˜å–åŒ…è£¹å¾Œï¼Œå¯ä»¥å…«æŠ˜è²·æ‹¿éµã€ é€™é‚Šå·å¤¾å¸¶ä¸€å¼µç™½è‰²çš„ä¾¿åˆ©è²¼ï¼ŒTeddy èªªä»–ç¢ºå¯¦ä¹Ÿé‡åˆ°æœ‰äº›é©—è­‰æ˜¯é‡è¦çš„å•†æ¥­é‚è¼¯ï¼Œä»–è‡ªå·±è®Šå½¢å¢åŠ äº†ç™½è‰²ä¾¿åˆ©è²¼ï¼Œè¡¨ç¤º Command çš„é©—è­‰è¦å‰‡\nåˆ°é€™ä¸€æ­¥æˆ‘å€‘å¯ä»¥ç™¼ç¾ Event Storming å¾ˆå¥½çš„æè¿°äº†ä¸€å€‹æ•…äº‹ ã€ŒUser want receive package, we have to check his id card, after user have received package, he can purchase latte 20% offã€\né€™å°±æ˜¯ Event Storming çš„é­…åŠ›\n6. Software Design - åŠ å…¥ Model æ¥ä¸‹ä¾†é€²å…¥å¯¦ä½œç´°ç¯€ï¼ŒModel å¯ä»¥æƒ³åšæ˜¯ç‰©ä»¶ï¼Œæ¯”å° Command æ‡‰è©²æ˜¯å“ªä¸€å€‹ç‰©ä»¶è² è²¬ï¼Œæ¢åˆ—å¾Œæœ€çµ‚æŠŠ Model çš„å¤§è‡´é—œä¿‚ä¹Ÿæç¹ªï¼Œå¤§è‡´å¦‚ä¸‹ å› ç‚º Stage / Swimlane ä¸€è€…æ˜¯æ©«å‘ä¸€è€…æ˜¯ç›´å‘ï¼Œå…©è€…å¯ä»¥äº’ç›¸åŒ…å«ï¼Œæ‰€ä»¥åœ–è¡¨æœ‰é»è¤‡é›œï¼Œåœ–è¡¨è¤‡é›œä»£è¡¨ç¨‹å¼ç¢¼å¯¦ä½œä¸€å®šä¹Ÿä¸å¥½å¯«ï¼Œè©²æ€éº¼å„ªåŒ–å‘¢ï¼Ÿ\næŠ½ä¸€å€‹ Lane ä»£è¡¨ Stage / Swimlaneï¼Œé€™æ¨£é—œä¿‚å°±å–®ç´”å¾ˆå¤š æ›´ç²¾æº–è¡¨é”å•†æ¥­é‚è¼¯ï¼Œå¦å¤–ä¸€å€‹é‡é»æ˜¯ Workflow èˆ‡ Stage é—œè¯è€Œä¸æ˜¯ Laneï¼Œå› ç‚º Workflow é è¨­ç¬¬ä¸€å±¤å¿…é ˆæ˜¯ Stageï¼Œé€éåœ–è¡¨è¡¨ç¤ºå‡ºæ ¸å¿ƒçš„è¨­è¨ˆé‚è¼¯ a. Model æ‹†åˆ†å¾ˆçœ‹å•†æ¥­é‚è¼¯ åŒå­¸åœ¨èª²å ‚ä¸Šè©¢å•ï¼šã€Œå¦‚æœæˆ‘æœ‰å¤šå€‹æ”¯ä»˜ï¼Œæˆ‘æ˜¯ä¸æ˜¯è¦æŠŠæ¯å€‹ CreditCardPay / ApplePay éƒ½å¯«æˆä¸€å€‹ Modelï¼Ÿã€ Teddy åå•ï¼šã€Œç‚ºä»€éº¼éœ€è¦ï¼Ÿå¦‚æœ Pay åªæ˜¯ä¸€å€‹ä»˜æ¬¾æ‰‹æ®µï¼Œå¦‚æœæ²’æœ‰å¾ˆå¤§çš„å·®ç•°ï¼Œä¸€å€‹ Pay è¡¨é”å¯¦ä½œæ™‚å†æ‹†åˆ†å°±å¥½ã€\næˆ‘æ¥è‘—æå•ï¼šã€Œé‚£ç‚ºä»€éº¼ Stage / Swimlane è¦æ‹†åˆ†ï¼Ÿä»–å€‘ä¹Ÿåªæ˜¯ä¸€å€‹æ©«çš„ä¸€å€‹ç›´çš„ã€\nTeddy è¡¨ç¤º å› ç‚ºåœ¨çœ‹æ¿çš„ Domain ä¸­ï¼Œç›´çš„ä»£è¡¨å·¥ä½œéšæ®µ / æ©«çš„ä»£è¡¨å·¥ä½œæµç¨‹æ˜¯æˆªç„¶ä¸åŒçš„ï¼Œé€™æ˜¯éå¸¸æ ¸å¿ƒçš„å•†æ¥­é‚è¼¯ï¼Œæ‰€ä»¥ Model è¦æ‹†åˆ°å¤šç´°ï¼Œè¦ä¸è¦çœŸçš„æŠŠæ¯å€‹å¯¦ä½œçš„ç‰©ä»¶éƒ½è¡¨é”ï¼Œå®Œå…¨çœ‹é ˜åŸŸå°ˆå®¶èˆ‡é–‹ç™¼äººå“¡æ˜¯å¦å¾ˆé‡è¦–æ¯å€‹å…ƒä»¶çš„ç¨ç«‹æ€§èˆ‡è¡¨é”æ€§\n7. Software Design - æ‰¾å‡º Aggregate æœ€å¾Œä¸€æ­¥! ä¹Ÿæ˜¯å¾ˆæŠ½è±¡çš„ä¸€æ­¥ï¼Œå°‡ Model åˆ†ç¾¤ï¼Œæœ‰äº› Model æ˜é¡¯æ˜¯å…¶ä»– Model çš„é™„åº¸ ï¼Œä¾‹å¦‚èªªè¨‚å–®ç´°é … Order Item æ˜¯è¨‚å–® Order çš„é™„åº¸ï¼Œæ¯æ¬¡ Order Item çš„æ”¹å‹•æœƒå½±éŸ¿ Order çš„è¨ˆç®—ï¼Œæœƒé€²éšå½±éŸ¿ä¾‹å¦‚æŠ˜åƒ¹åˆ¸ç­‰è¨ˆç®—ï¼Œæ‰€ä»¥ Order Item æœ€å¥½ä¸è¦ç›´æ¥èª¿æ•´ï¼Œç”± Order çµ±ä¸€èª¿æ•´æ‰èƒ½ç¢ºä¿è³‡æ–™çš„ä¸€è‡´æ€§\nè¦ä¸è¦æŠŠ Model Aggregate æˆä¸€å¡Šæœ‰å…©å€‹ä½œç”¨åŠ›\nè³‡æ–™ä¸€è‡´æ€§ ä½µç™¼æ“ä½œ Teddy å¸¶æˆ‘å€‘æ€è€ƒçš„æ–¹å¼æ˜¯\nä»Šå¤©æˆ‘æ”¹å‹• Model Aï¼Œé‚£æˆ‘å¯ä¸å¯ä»¥åŒæ™‚æ”¹å‹• Model B ? æˆ‘åœ¨ Workflow name çš„æ™‚å€™ï¼Œå¯ä»¥åŒæ™‚æ“ä½œ Board å—ï¼Ÿ\nåˆ‡è¨˜ä¸è¦ç”¨ Database Relation æ€è€ƒï¼Œä¾‹å¦‚ User åˆªé™¤ Order ä¹Ÿè¦è·Ÿè‘—è¢«åˆªé™¤ï¼Œé€™æ¨£ Aggregate æ°¸é åˆ‡ä¸é–‹ï¼Œæ›´ç›´è§€åœ°èªª è¦åŒ… Transaction æ“ä½œçš„éƒ½å°±æ”¾åœ¨åŒä¸€å€‹ Aggregate\næ‰¾å‡º Aggregate å¾Œï¼Œéœ€è¦æ‰¾ä¸€å€‹ Model ç•¶ä½œ Rootï¼Œå¾€å¾Œ Aggregate å…§çš„ Model éƒ½ç”±ä»–ä¾†æ§åˆ¶ï¼Œå¤–äººä¸å¯ç›´æ¥æ“ä½œå…§éƒ¨ Modelï¼Œä»»ä½•è·¨ Aggregate æ“ä½œåªèƒ½ä¿è­‰æœ€çµ‚ä¸€è‡´æ€§\nå»¶ä¼¸è®Šé«”ï¼šé‚„æ˜¯å¾ˆæƒ³æŠŠè®€å–ä¹Ÿæ”¾å…¥ Event Storming å¯ä»¥å—ï¼Ÿ Teddy ä¸Šèª²ä¸€ç›´å¼·èª¿è®€å–éš¨ä¾¿å¯«å°±å¥½ï¼Œæ€éº¼é«’éƒ½æ²’é—œä¿‚å› ç‚º Command æ‰æœƒå½±éŸ¿ç³»çµ±ç‹€æ…‹ XD Query æ•ˆèƒ½å•é¡Œç­‰åˆæ˜¯ DB ç´°ç¯€ï¼Œæœ¬èº«ä¹Ÿä¸æ˜¯ Event Storming è©²é—œæ³¨çš„å±¤ç´š\nä½†å”ä½œä¸Šå¤§å®¶é‚„æ˜¯æƒ³æŠŠ UI æ”¾åˆ°è¨è«–ä¸­ / Read Model å¦‚æœæœ‰å‰ç«¯å¯èƒ½ä¹Ÿå¸Œæœ›åœ¨å¯«å¾—ç´°ä¸€é»ï¼Œé€™äº›éƒ½å¯ä»¥è‡ªå·±å»¶ä¼¸ï¼ŒTeddy ä¹Ÿåˆ†äº«æœ‰äº›æµç¨‹ UI å¯ä»¥å¹«åŠ©èªªæ˜çš„è©±ä»–ä¹Ÿæœƒæ”¾é€²å»ï¼Œä¾‹å¦‚ Command å¾Œå›å‚³å¦ä¸€å¼µ Read Model / UI åœ–ç¤ºæ”¾åœ¨ Read Model æ—é‚Šç­‰ å»¶ä¼¸å•é¡Œï¼šé–‹ç™¼åªè¦é€™ä¸€ä»½æ–‡ä»¶å°±å¥½äº†å—ï¼Ÿ æ–‡ä»¶çš„ç¶­è­·ä¹Ÿæ˜¯æˆ‘èª²å‰å¾ˆæƒ³äº†è§£çš„éƒ¨åˆ†ï¼Œåœ¨ DDD è—çš®æ›¸ä¸­ä¸æ–·å¼·èª¿ Domain Model è·Ÿç¨‹å¼ç¢¼å¯¦ä½œè¦é«˜åº¦ä¸€è‡´ä¸¦æŒçºŒæ¼”é€²ï¼Œä½†å·¥ä½œå¤šå¹´æœ‰è‰¯å¥½ç¶­è­·æ–‡ä»¶ç¿’æ…£çš„äººé‚„çœŸçš„æ˜¯å°‘æ•¸ï¼Œå°¤å…¶æ˜¯æ–‡ä»¶è¶Šå¤šä»½ç¶­è­·çš„æˆæœ¬å°±æ›´é«˜ï¼Œæ‰€ä»¥æˆ‘èª²å¾Œå°±å• Teddy ä»–å€‘åœ˜éšŠé–‹ç™¼æ˜¯ä¸æ˜¯åªæœ‰é€™ä¸€ä»½æ–‡ä»¶ï¼Œä»–èªªåŸºæœ¬ä¸Šæ˜¯ï¼Œè³‡æ–™åº«éƒ¨åˆ†å› ç‚ºä»–æ˜¯èµ° Event Sourcing æ‰€ä»¥ä¸ç”¨å¦å¤–çš„ Schema è¨­è¨ˆæ–‡ä»¶ï¼Œå¦‚æœä¸æ˜¯é ‚å¤šå†ä¸€ä»½ DB Schema æ–‡ä»¶å°±è¶³å¤ äº†\nDDD - Tacticle Design \u0026amp; Strategic Design è·‘éä¸€æ¬¡ Event Storming å†å›ä¾†çœ‹ DDD å»£ç‚ºäººçŸ¥çš„å…©å¼µåœ–å°±æ¯”è¼ƒèƒ½ç†è§£äº†ï¼Œé€™é‚Šåªé¡å¤–è£œå……å…©ä»¶äº‹\n1. Entity èˆ‡ Value Object å€åˆ† å‰è€…æ˜¯å…·æœ‰ id åœ¨ Conext ä¸‹æœ‰å”¯ä¸€è­˜åˆ¥æ€§çš„ç‰©ä»¶ï¼Œå¾Œè€…æ˜¯å…§å®¹é‡è¦ä½†æ˜¯ä¸æ˜¯åŒä¸€å€‹ç‰©ä»¶ä¸å¤ªé—œå¿ƒï¼Œä¾‹å¦‚èªªç´™éˆ”ï¼Œå¤§å¤šç³»çµ±ä¸‹æˆ‘å€‘åªé—œå¿ƒç´™éˆ”çš„é¢é¡ï¼Œç”­ç®¡ä½ æ˜¯å·¦é‚Šçš„ 100 å…ƒé‚„æ˜¯å³é‚Šçš„ 100 å…ƒï¼Œæ‰€ä»¥æ˜¯ Value Object / ä½†å¦‚æœæ˜¯å°éˆ”ç³»çµ±ï¼ŒåŒæ¨£æ˜¯ 100 å…ƒé‚„æ˜¯è¦ç”¨ id å€åˆ†ä¸åŒçš„ç´™éˆ”ï¼Œé€™æ™‚å°±æ˜¯ Entity äº†\n2. å¦‚æœæœ‰é©—è­‰éœ€æ±‚ï¼Œå¯ä»¥è€ƒæ…®ç”¨ Value Object ä¸€å€‹å¯¦ä½œçš„å°ç´°ç¯€ï¼Œå¦‚æœä»¥å¾€éƒ½æ˜¯ç”¨æ¬„ä½å„²å­˜ä¸€å€‹åŸºç¤å‹åˆ¥ï¼Œä¾‹å¦‚ string emailï¼Œè¦å¢åŠ é©—è­‰å°±æœƒå¾ˆç‘£ç¢ï¼Œå°è£ä¸€å€‹ Email ç‰©ä»¶ä¸¦åœ¨ constructor çµ±ä¸€é©—è­‰æœƒæ¯”è¼ƒç°¡æ½”\nçµèª é‡é»å°æ•´ç†ï¼š\nä»¥å•†æ¥­æ ¸å¿ƒç‚ºå‡ºç™¼ ç”¨èªªæ•…äº‹çš„æ–¹å¼è·‘ Event Storming ä¸è¦è½å…¥å¯¦ä½œç´°ç¯€ å¦‚æœæœ‰éœ€è¦ï¼Œå¯ä»¥è‡ªå·±è®Šé«”é©æ‡‰çµ„ç¹” ä¸Šå®Œèª²è‡ªå·±é‡æ–°è¦†ç›¤ï¼Œæ²’æƒ³åˆ°èŠ±é€™éº¼å¤šæ™‚é–“æ‰æ•´ç†å®Œï¼ŒDDD ç”¨éœæ…‹çš„å­¸ç¿’æ–¹å¼çœŸçš„å¾ˆæŠ½è±¡ï¼Œå¤§è…¦ä¸€ç›´è½‰ä¸éå»ï¼Œä¸Šå®Œ Teddy çš„èª²æ‰è¦ºå¾—é‚£æ‰‡é–€è¢«æ‰“é–‹äº†ä¸€å€‹ç¸«ï¼Œçœ‹åˆ°ç†æƒ³è»Ÿé«”é–‹ç™¼çš„å…‰æ˜ XD\né€™ä¸€ç¯‡ä¸»è¦æ•´ç† DDDï¼Œä¸‹ä¸€ç¯‡é è¨ˆæ•´ç† Clean Architecture èˆ‡å¦‚ä½•è·Ÿ DDD çµåˆï¼Œå¸Œæœ›é€™äº›ç´€éŒ„å°å¤§å®¶æœ‰å¹«åŠ©ï¼Œæœ€å¾Œåœ¨å¹« Teddy è€å¸«æ¨å»£ä¸€ä¸‹ä»–çš„èª²ç¨‹ï¼Œåªæœ‰å¯¦éš›è·‘éä¸€æ¬¡Event Storming æ‰èƒ½çœŸæ­£å­¸æœƒï¼Œå¦‚æœæœ‰ä»€éº¼å»ºè­°æˆ–ç³¾éŒ¯å†éº»ç…©ç•™è¨€\n","date":"2022-01-14T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2022/2022-01-14-%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87%E7%B0%A1%E6%BD%94%E6%9E%B6%E6%A7%8B%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C%E7%8F%AD%E4%B8%8A%E8%AA%B2%E7%AD%86%E8%A8%98%E8%88%87%E5%BF%83%E5%BE%97%E9%97%9C%E6%96%BC%E6%95%8F%E6%8D%B7-ddd-%E8%88%87-event-storming-%E4%B8%8A/","title":"ã€Œé ˜åŸŸé©…å‹•è¨­è¨ˆèˆ‡ç°¡æ½”æ¶æ§‹å…¥é–€å¯¦ä½œç­ã€ä¸Šèª²ç­†è¨˜èˆ‡å¿ƒå¾—ï¼šé—œæ–¼æ•æ·ã€ DDD èˆ‡ Event Storming - ä¸Š"},{"content":"ç¬¬å››ç« ï¼šåˆ†è§£è³‡æ–™åº« ä¸Šä¸€ç« æ˜¯ç”¨ç³»çµ±çš„å±¤ç´šè¨è«–å¦‚ä½•æ‹†åˆ†ï¼Œä½†ç³»çµ±æœ€é›£æ‹†åˆ†çš„éƒ¨åˆ†ç„¡ç–‘æ˜¯ è³‡æ–™åº«ï¼Œæ‰€ä»¥ä½œè€…èŠ±äº†å¾ˆå¤§çš„ç¯‡å¹…æè¿°å¤šç¨®è³‡æ–™åº«æ‹†åˆ†çš„æ–¹å¼\nåˆ†è§£æ¨¡å¼ æ¨¡å¼ä¸€ï¼šå…±äº«è³‡æ–™åº« æ‰€æœ‰çš„æœå‹™å…±äº«ä¸€å€‹è³‡æ–™åº«ï¼Œé€™æ˜¯ä¸€å€‹ä¸å¤ªå¥½çš„é¸æ“‡ï¼Œå› ç‚ºç„¡æ³•ä¿è­‰èª°æ§åˆ¶äº†è³‡æ–™ï¼Œæ¯å€‹æœå‹™éƒ½æœ‰è®€å¯«ã€ä¿®æ”¹ Schema çš„èƒ½åŠ›ï¼Œé€™æš—ç¤ºäº†ç¼ºä¹å•†æ¥­é‚è¼¯çš„å‡èšåŠ› æ¨¡å¼äºŒï¼šè³‡æ–™åº«è¦–åœ– å¦‚æœä»å¸Œæœ›å¤šå€‹æœå‹™é–“å…±äº«ä¸€å€‹è³‡æ–™åº«ï¼Œå¯ä»¥é€éè¦–åœ– (View Table) æ¸›è¼•è€¦åˆä¸Šçš„å›°æ“¾ï¼Œå› ç‚ºè¦–åœ–å¯ä»¥æœ‰ç¨ç«‹çš„æ¬Šé™ç®¡ç†ä¸¦éš±è—åº•å±¤å¯¦éš›å„²å­˜çš„é‚è¼¯ï¼› è¦–åœ–çš„åŠŸèƒ½å–æ±ºæ–¼è³‡æ–™åº«æœ¬èº«çš„é™åˆ¶ï¼Œè¦å°å¿ƒè³‡æ–™æ˜¯å¦éæ™‚ç­‰å•é¡Œ æ¨¡å¼ä¸‰ï¼šè³‡æ–™åº«åŒ…è£æœå‹™ å°‡è³‡æ–™åº«éš±è—åœ¨æœå‹™å¾Œé¢ï¼Œå¾è³‡æ–™åº«ä¾è³´è½‰è®Šæˆæœå‹™ä¾è³´ï¼Œé€™å¯ä»¥ç•¶ä½œè½‰ç§»çš„ç¬¬ä¸€æ­¥ï¼Œå…ˆé¿å…è³‡æ–™åº«è€¦åˆæŒçºŒæƒ¡åŒ–ï¼Œé€éä¸€å±¤æœå‹™å°è£èˆ‡éš±è—å¯¦éš›çš„è³‡æ–™åº«é‚è¼¯\næ›¸ä¸­æ¡ˆä¾‹æ˜¯éŠ€è¡Œçš„æ¬Šé™ç®¡ç†ï¼Œå¤šå€‹æœå‹™å› æ‡‰ä¸åŒçš„å ´æ™¯æŒçºŒå †ç–Šæ–°çš„æ¬Šé™ç®¡ç†åœ¨è³‡æ–™åº«ä¸­ï¼Œé€éæ‹†åˆ†å‡ºæ¬Šé™æœå‹™ï¼Œå°‡æ¬Šé™èª¿æ•´é™ç¸®å–®ä¸€æœå‹™ï¼Œå¾ŒçºŒå†è€ƒæ…®æ‹†åˆ†ç¨ç«‹è³‡æ–™åº«ï¼Œæœ‰é»åƒä¸Šä¸€ç« æåˆ°çš„æŠ½è±¡åˆ†æ\nè·Ÿè¦–åœ–ç›¸æ¯”çš„å¥½è™•æ˜¯ä¸éœ€è¦æ˜ å°„ç¾æœ‰çš„è³‡æ–™è¡¨ï¼Œä¸”å¯ä»¥é€éç¨‹å¼é‚è¼¯æ§åˆ¶æ›´è¤‡é›œçš„æ“ä½œï¼Œåªæ˜¯ä¸Šæ¸¸ä»‹æ¥çš„æœå‹™éœ€è¦èª¿æ•´ æ¨¡å¼å››ï¼šè³‡æ–™åº«æœå‹™ä»‹é¢ å¦‚æœå®¢æˆ¶ç«¯æ˜¯ BI å·¥å…·éœ€è¦ç›´æ¥é€é SQL ç«¯é»è®€å–ï¼Œæœ€å¥½æ˜¯å»ºç«‹å°ˆé–€çš„è³‡æ–™åº«ä½œç‚ºå…¬é–‹çš„è®€å–ç«¯é»ï¼Œå°æ˜ å¼•æ“è² è²¬åŒæ­¥è³‡æ–™ï¼Œå¯ä»¥é€éæ‰¹æ¬¡è™•ç†ã€ä¸²æµåŒæ­¥å·¥å…· (ä½œè€…æ¨è–¦ Debezium)ï¼Œè™•ç†çš„è¤‡é›œåº¦ä»°è³´æ–¼å…§éƒ¨è³‡æ–™åº«èˆ‡å°å¤–è³‡æ–™åº«çš„å·®ç•°ï¼Œå¦‚å¾ Cassandra æ˜ å°„åˆ° SQL DB å…ˆåˆ†å‰²è³‡æ–™åº«é‚„æ˜¯ç¨‹å¼ç¢¼ å…ˆåˆ†å‰²è³‡æ–™åº« è¦å°å¿ƒè·¨è³‡æ–™åº« Joinã€ä¸€è‡´æ€§èˆ‡å®Œæ•´æ€§å•é¡Œï¼Œå¦‚æœè¦ç‰¹åˆ¥æ³¨æ„è³‡æ–™ä¸€è‡´æ€§å•é¡Œå¯ä»¥æ¡å–æ­¤æ–¹æ³•ï¼Œç¼ºé»æ˜¯çŸ­æœŸæ•ˆç›Šä¸å¤§ï¼Œä¾ç„¶è¦é¢è‡¨å–®é«”å¼æ¶æ§‹\nå¯ä»¥é€éç¨‹å¼ä¸­çš„ Storage Layer å°‡ Domain å°æ‡‰åˆ°ç¨ç«‹çš„ Table / Database\nå…ˆåˆ†å‰²ç¨‹å¼ç¢¼ å…ˆåˆ†å‰²ç¨‹å¼ç¢¼æ›´å®¹æ˜“äº†è§£æ–°æœå‹™éœ€è¦çš„è³‡æ–™ï¼Œä¹Ÿèƒ½å¤ ææ—©ç¨ç«‹éƒ¨ç½²æ–°æœå‹™ï¼Œä½†æœ‰å¯èƒ½æ‹†åˆ†å®Œç¨‹å¼ç¢¼å°±æ²’æœ‰ç¹¼çºŒæ‹†åˆ†è³‡æ–™åº«\nè³‡æ–™ä¸€è‡´æ€§ å¦‚æœéœ€è¦é‡å°ä¸åŒçš„ Domain æ“ä½œå¯ä»¥åœ¨ SQL è³‡æ–™åº«ä¸­ç”¨ Transaction åŒ…èµ·ä¾†ç¢ºä¿åŸå­æ€§ï¼Œä½†æ˜¯åˆ†æ•£å¼æ¶æ§‹å°±éœ€è¦ç”¨åˆ¥çš„æ–¹å¼ç¢ºä¿åŸå­æ€§\næ–¹æ³•ä¸€ï¼šäºŒéšæ®µæäº¤ é€éä¸€å€‹å”èª¿è€…ï¼Œèˆ‡å¤šå€‹æœå‹™æºé€šä¸¦ç¢ºä¿å¤§å®¶ä¸€èµ· commit æˆ–ä¸€èµ· rollbackï¼Œæ¼”ç®—æ³•è¤‡é›œä¸”æ•ˆç‡å·®ï¼Œå¦‚æœå±…ä¸­çš„å”èª¿è€…å¤±æ•—å‰‡æœƒå‡ºç¾éä¸€è‡´æ€§å•é¡Œ æ–¹æ³•äºŒï¼šSaga é¿å…é•·æ™‚é–“é–å®šè³‡æ–™ï¼Œå°‡æ¯å€‹åŸ·è¡Œæ­¥é©Ÿæ¨¡çµ„åŒ–ç¨ç«‹é‹ä½œï¼Œå€‹åˆ¥æœå‹™éƒ½è¦è™•ç†ç•°å¸¸äº‹ä»¶æ™‚çš„è£œå„Ÿè¡Œç‚ºï¼Œåƒè€ƒ Saga åˆ†æ•£å¼äº¤æ˜“æ¨¡å¼ï¼Œä½†è¦å°å¿ƒ Saga æ¨¡å¼çš„è¤‡é›œåº¦å¾ˆé«˜ ç¬¬äº”ç« ï¼šæˆé•·éç¨‹ä¸­çš„ç—›è‹¦ å°å…¥å¾®æœå‹™æœƒé‡åˆ°å¾ˆå¤šçš„æŒ‘æˆ°ï¼Œå°¤å…¶æ˜¯ç•¶åœ˜éšŠäººæ•¸èˆ‡å¾®æœå‹™æ•¸é‡æŒçºŒå¢åŠ æ™‚ï¼Œå¯èƒ½æœƒé–‹å§‹å‡ºç¾ä»¥ä¸‹å•é¡Œ\n1. å¤§è¦æ¨¡æ‰€æœ‰æ¬Š ç•¶è¦æ”¹å‹•ç¨‹å¼ç¢¼æ™‚ï¼Œæœƒä¾ç…§ç¨‹å¼ç¢¼æ‰€æœ‰æ¬Šæ¦‚å¿µè€Œæœ‰æ‰€ä¸åŒï¼Œå¦‚æœæ˜¯å¼·å¤§çš„ç¨‹å¼ç¢¼æ‰€æœ‰æ¬Šå‰‡éœ€è¦å†ä¿®æ”¹å‰å‘ŠçŸ¥æŒæœ‰è€…ï¼›å¼±æ‰€æœ‰æ¬Šæˆ–æ˜¯é›†é«”æ‰€æœ‰æ¬Šå‰‡æ˜¯ç›´æ¥ä¿®æ”¹ä¸éœ€è¦é¡å¤–é€šçŸ¥\né€šå¸¸ä¸€é–‹å§‹éƒ½æ˜¯é›†é«”æ‰€æœ‰æ¬Šï¼Œå¤§å®¶åˆ†å·¥é–‹ç™¼è€Œæ²’æœ‰ç‰¹å®šçš„ä»»å‹™ï¼Œä½†æ˜¯ç•¶äººæ•¸è¶…é 100 äººï¼Œé€šå¸¸å¥½çš„åœ˜éšŠéƒ½æ˜¯å¼·æ‰€æœ‰æ¬Šï¼Œè®“æ¯å€‹åœ˜éšŠå°ˆæ³¨æ–¼ç‰¹å®šé ˜åŸŸ\n2. é‡å¤§è®Šé© ç•¶å¾®æœå‹™æ”¹å‹•æ™‚ï¼Œå¦‚æœæ²’æœ‰è¬¹æ…æ€è€ƒç ´å£åŸæœ¬çš„ä»‹é¢ï¼Œå‰‡ç›¸ä¾çš„æœå‹™ä¹Ÿæœƒè·Ÿè‘—è¢«ç ´å£ï¼Œä¾‹å¦‚æå‡ API ç‰ˆè™Ÿæ™‚ï¼Œè¨˜å¾—è¦å…¬å‘Šä¸¦ä¿ç•™ä¸€å®šçš„æ”¯æ´æ™‚é–“\n3. å ±å‘Š éå¾€å–®é«”å¼è³‡æ–™åº«è¦æ‹‰å ±è¡¨ç›¸å°ç°¡å–®ï¼Œä½†å¦‚æœæ‹†åˆ†å¾®æœå‹™ï¼Œä¸åŒåœ˜éšŠæ¡ç”¨ä¸åŒçš„è³‡æ–™åº«ï¼Œè¦ç¢ºä¿æœ€çµ‚å†ç”¢ç”Ÿå ±å‘Šæ™‚æœ‰åŒæ­¥ç›¸åŒçš„è³‡æ–™\n4. ç›£æ§å’Œç–‘é›£æ’æŸ¥ åˆ†æ•£å¼ç³»çµ±çš„ç›£æ§èˆ‡æ’æŸ¥é›£åº¦æœƒæ¯”å–®é«”å¼é«˜éå¸¸å¤šï¼Œå¯ä»¥ä½¿ç”¨ ELK / Fluentd ç­‰æŠ€è¡“å½™æ•´ï¼Œä¸¦å¢åŠ ç³»çµ±çš„å¯è§€æ¸¬æ€§ï¼ŒObservability çš„æ¦‚å¿µç®—æ˜¯æŠŠ Monitoring å†å¾€å‰æ¨é€²ä¸€æ­¥ï¼Œå¯ä»¥åƒè€ƒ å–¬å”å¸¶ä½ ä¸Šæ‰‹ Elastic Stack - æ¢ç´¢èˆ‡å¯¦è¸ Observabilityï¼š01 - å‰è¨€ \u0026amp; æ·ºè«‡ Observabilityï¼›åœ¨è¿½è¹¤éƒ¨åˆ†ï¼Œå¯ä»¥æŠŠæ¯ä¸€å€‹å‘¼å«éƒ½ç”¢ç”Ÿå°æ‡‰çš„é—œè¯ IDï¼Œè¿½è¹¤åœ¨ä¸åŒå¾®æœå‹™é–“çš„é€šä¿¡ï¼Œå¯ä»¥åƒè€ƒé–‹æºå·¥å…· Jaeger\n5. ç•¶åœ°é–‹ç™¼è€…ç¶“é©— ç•¶æœ‰æ›´å¤šæœå‹™æ™‚ï¼Œè¦åœ¨æœ¬åœ°ç«¯é–‹ç™¼è®Šæˆä¸€å ´å¤¢é­˜ï¼Œé›–ç„¶èªªæœ‰ Docker ç­‰å®¹å™¨åŒ–æŠ€è¡“ï¼Œä½†å¦‚æœåƒ JVM éœ€è¦åƒå¤§é‡è³‡æºï¼Œå¯èƒ½æœƒè€—ç›¡é–‹ç™¼è€…çš„æœ¬åœ°ç«¯è³‡æºï¼Œå¦‚æœæ˜¯ä½¿ç”¨ k8s å¯ä»¥è€ƒæ…®ç”¨ Telepresenceï¼Œéƒ¨ç½²å®Œæ•´æœå‹™åœ¨é›²ç«¯ï¼Œé–‹ç™¼è€…å¯ä»¥é‹è¡Œç‰¹å®šæœå‹™åœ¨æœ¬åœ°ç«¯å…¶é¤˜ä¾è³´é›²ç«¯çš„æœå‹™\n6. å…¨åŸŸèˆ‡æœ¬åœ°å„ªåŒ–æ¯”è¼ƒ é›–ç„¶èªªå¾®æœå‹™å¯ä»¥è®“å„å€‹åœ˜éšŠå½ˆæ€§çš„æ¡ç”¨æŠ€è¡“ï¼Œä½†å¾æ•´é«”çš„è§’åº¦å¤ªéåˆ†æ•£çš„æŠ€è¡“æ£§å¯èƒ½æœƒå°è‡´è²»ç”¨ä¸Šæˆ–æ˜¯ç¶­è­·ä¸Šçš„å›°é›£ï¼›ä½†å¦‚æœå¤ªé›†ä¸­åŒ–ç®¡ç†ï¼Œå¼·è¿«å„å€‹åœ˜éšŠæ¡ç”¨ç›¸åŒçš„æŠ€è¡“åˆå¤±å»äº†å¾®æœå‹™çš„éƒ¨åˆ†å¥½è™•\né€™å¯ä»¥ç”¨å‰å¹¾ç« æè¿°çš„å¯é€†èˆ‡ä¸å¯é€†æ±ºç­–ï¼Œå¦‚æœæ˜¯ä¸å¯é€†å¦‚é›²ç«¯ä¾›æ‡‰å•†ç­‰ï¼Œå‰‡éœ€è¦è·¨åœ˜éšŠçš„è¨è«–ï¼Œä½†å¯é€†çš„æ±ºç­–å¦‚æ¡ç”¨å‡½å¼åº«ã€å˜—è©¦æ–°çš„ç¨‹å¼èªè¨€å‰‡å¯ä»¥æ”¾æ‰‹çµ¦åœ˜éšŠæ±ºå®šï¼Œæœ€å¥½æ˜¯å¯ä»¥è®“æ¯å€‹åœ˜éšŠå‡ºä¸€åæŠ€è¡“è² è²¬äººçµ„æˆè·¨éƒ¨é–€å°çµ„ï¼ŒåŒæ™‚å…¼å®¹å…¨åŸŸèˆ‡æœ¬åœ°å„ªåŒ–çš„å¯èƒ½\nç¸½çµ ä»¥ä¸Šæ˜¯å¾æ›¸ä¸­æ‘˜éŒ„çš„å…§å®¹ï¼Œå› ç‚ºé‚„æ²’æœ‰å¤ªå¤šçš„å¯¦éš›ç¶“é©—ï¼Œåªèƒ½ç…§æœ¬å®£ç§‘ï¼Œç„¡æ³•åƒå®‰å¾·é­¯å¤§å”å¯«å‡ºæŠ½è±¡åŒ–ç¨‹åº¦å¤ ä¹ŸåŒ…å«è¶³å¤ æ‰å¯¦çš„ç¶“é©—åˆ†äº«ï¼ŒæœŸè¨±è‡ªå·±æœªä¾†æœ‰æ›´å¤šç¶“é©—èƒ½å¤ é‡æ–°è£œå……æ–‡ç« å…§å®¹\nå¥½çš„æ¶æ§‹è¨­è¨ˆæ˜¯æŒçºŒæ¼”é€²çš„ï¼Œå»ºè­°æ˜¯å¾ Monolithic -\u0026gt; Modulized Monolithic -\u0026gt; Microservicesï¼Œå¦‚æœç„¡æ³•æ¨¡çµ„åŒ–å–®é«”å¼ï¼Œé‚£åªæœƒå¾—åˆ°æ›´ç³Ÿç³•çš„å¾®æœå‹™ï¼Œå¾®æœå‹™æœ¬èº«é€éç¨ç«‹çš„æœå‹™å½¢æˆé«˜å¼·åº¦ã€é›£ä»¥é•èƒŒçš„æ¨¡çµ„åŒ–ï¼Œå•é¡Œå°±å›åˆ°ç¨‹å¼è¨­è¨ˆçš„æœ€æºé ­å¦‚ä½•è¨­è¨ˆå‡ºé«˜å…§èš+ä½è€¦åˆçš„æ¨¡çµ„ï¼Œå¾€ä¸‹é è¨ˆé‚„æœ‰å¹¾å€‹çŸ¥è­˜é»çš„å»¶ä¼¸ DDD / Event Storming / Clean Architecture / Observability (é æœ›\n","date":"2021-12-05T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-12-05-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8B/","title":"ã€Šå–®é«”å¼ç³»çµ±åˆ°å¾®æœå‹™ã€‹è®€å¾Œåˆ†äº« - ä¸‹"},{"content":"å¾®æœå‹™å› æ‡‰å®¹å™¨åŒ–æŠ€è¡“ã€æŒçºŒæ•´åˆèˆ‡äº¤ä»˜å·¥å…·æˆç†Ÿï¼Œæˆç‚ºé¡¯å­¸å¥½ä¸€æ®µæ™‚é–“äº†ï¼Œä½†é€™ä¸ä»£è¡¨æˆ‘å€‘å°±æ‡‰è©²å°å…¥å¾®æœå‹™ï¼Œçµ‚ç©¶å¾®æœå‹™åªæ˜¯ä¸€é …æŠ€è¡“(æˆ–èªªæ˜¯æ¶æ§‹)ï¼Œå¦‚æœæ²’æœ‰è¨­å®šä¸€å€‹æ­£ç¢ºçš„ç›®æ¨™ï¼Œä¸¦ç”¨é©ç•¶çš„æŒ‡æ¨™æ™‚æ™‚é—œæ³¨ï¼Œé‚£å°å…¥ä»»ä½•æ–°æŠ€è¡“æœ€å¾Œéƒ½æœƒæ˜¯ä¸€å ´ç½é›£ï¼Œå¾®æœå‹™æ›´æ˜¯ï¼› æˆ‘å¾ˆå–œæ­¡é€™ç¯‡åˆ†äº«ï¼Œå…ˆæª¢è¦–åœ˜éšŠçš„ CI/CDã€monitoring æ©Ÿåˆ¶æ˜¯å¦å¥å…¨å†ä¾†æ€è€ƒå¾®æœå‹™ https://www.facebook.com/hatelove/post/10223238347681539\né€™éƒ¨å½±ç‰‡æ˜¯ Sam Newman (æœ¬æ›¸ä½œè€…)èˆ‡ Martin Fowler å°è«‡ï¼Œï¼Œä¸»è¦å¾å¯«æ›¸çš„å‹•æ©Ÿé–‹å§‹ï¼Œå¾Œé¢è«‡åˆ°äº†ç‚ºä»€éº¼è¦å°å…¥å¾®æœå‹™ã€å°å…¥ç†ç”±ä»¥åŠè³‡æ–™åº«ã€åœ˜éšŠå¦‚ä½•æ‡‰å°ç­‰ï¼ŒåŸºæœ¬ä¸Šè·Ÿæ›¸çš„çµæ§‹äº’ç›¸å‘¼æ‡‰ï¼ŒGOTO è »ç”¨å¿ƒçš„å½±ç‰‡ä¸€å€‹æ®µè½å°±æœƒæ‰“ Tag ä»¥åŠçµ±æ•´ï¼Œå¾ŒçºŒè¦å›é¡§å¾ˆæ–¹ä¾¿ï¼›å¾Œä¾†ç¶“æ­·æ‰çŸ¥é“ Sam Newman ä¹‹å‰ åœ¨ ThoughtWorks å·¥ä½œ 12 å¹´\nä»¥ä¸‹é‡å°æ¯ç« ç¯€åšä¸€äº›åˆ†äº«èˆ‡ç¸½çµï¼Œä¸¦èåˆä¸€äº›çœ‹éçš„è³‡æ–™\nç¬¬ä¸€ç« ï¼šè¶³å¤ çš„å¾®æœå‹™ å¾®æœå‹™æ˜¯æ³›æŒ‡åœç¹æ¥­å‹™é ˜åŸŸå»ºæ¨¡çš„å¯ç¨ç«‹éƒ¨ç½²ä¹‹æœå‹™ï¼Œé€™é‚Šçš„é‡é»æœ‰å…©å€‹\nåœç¹æ¥­å‹™é ˜åŸŸ å¯ç¨ç«‹éƒ¨ç½² 1. åœç¹æ¥­å‹™é ˜åŸŸ Conway\u0026rsquo;s Law: ä»»ä½•è¨­è¨ˆç³»çµ±çš„çµ„ç¹”ï¼Œéƒ½å°‡ä¸å¯ä»¥é¿å…çš„ç”¢ç”Ÿä»¥çµ„ç¹”é€šè¨Šæ¶æ§‹ç‚ºå‰¯æœ¬ä¹‹è¨­è¨ˆ\nçµ„ç¹”çš„æ¶æ§‹æŸç¨®ç¨‹åº¦è·Ÿç¨‹å¼æ¶æ§‹é›·åŒï¼Œéƒ½æ‡‰è©²è¿½æ±‚é«˜å…§èšä½è€¦åˆï¼Œå¦å‰‡æœƒå› è·¨çµ„åˆ¥çš„é«˜æºé€šæˆæœ¬ï¼Œè€Œè®“çµ„ç¹”çš„ç”Ÿç”¢åŠ›ä¸‹é™ï¼Œé€²è€Œè®“å¤§å®¶é¸æ“‡å°è‡ªå·±æœ€æ–¹ä¾¿çš„è§£æ³•è€Œéå…¨å±€æœ€ä½³è§£\næŠŠåº·å¨å®šå¾‹è½‰æˆå·¥ç¨‹å¸«çš„æ¯”å–»æœƒæ˜¯\nIf you have four groups working on a compiler, you\u0026rsquo;ll get a 4-pass compiler\néå¾€çµ„ç¹”çš„åˆ†çµ„æ˜¯é€éè·èƒ½ï¼Œå¦‚ RD çµ„æˆä¸€å€‹ RD éƒ¨é–€è² è²¬ã€IT éƒ¨é–€è² è²¬éƒ¨ç½²èˆ‡ç¶­é‹ã€æ¥­å‹™éƒ¨é–€è² è²¬ç”¢å“ç«¯çš„å…¶é¤˜äº‹é …ï¼Œæ‰€ä»¥æ¥­å‹™ç«¯ç™¼èµ·éœ€æ±‚å¾Œï¼Œéœ€è¦å…ˆèˆ‡ RD éƒ¨é–€æºé€šã€RD éƒ¨é–€é–‹ç™¼å¾Œè«‹ IT éƒ¨é–€éƒ¨ç½²ï¼Œå±¤å±¤çš„è·¨éƒ¨é–€æºé€šè®“æ–°åŠŸèƒ½ä¸Šç·šå¾ˆæ…¢ï¼Œæ­¤æ™‚çµ„ç¹”çš„é‡é»æ˜¯ä»¥è·èƒ½å…§èšè€Œåˆ†æ¥­å‹™å…§èšï¼Œå»¶ä¼¸åˆ†äº«ä¹‹å‰æ•´ç†çš„ç­†è¨˜ FredèŠèŠSOLIDè¨­è¨ˆåŸå‰‡ï¼ŒSOLID åŸå‰‡ä¸­çš„ Single Responsibility å¯ä»¥å¾æ¥­å‹™è§’åº¦å»æ€è€ƒ\nå› æ‡‰è»Ÿé«”éœ€è¦æ›´é«˜é »æ¬¡çš„åŠŸèƒ½éƒ¨ç½²ï¼Œé–‹å§‹ä»¥æ¥­å‹™é ˜åŸŸä¾†åšçµ„ç¹”çš„æ¶æ§‹ï¼Œä¾‹å¦‚ Amazon çš„ two pizza team è¿½æ±‚you build it, you run itçš„ç²¾ç¥ï¼Œè®“æ¯å€‹åœ˜éšŠå¾éœ€æ±‚è¨­è¨ˆåˆ°ä¸Šç·šåæ‡‰é€Ÿåº¦æ›´å¿«\n2. ç¨ç«‹éƒ¨ç½² çµ„ç¹”ä¾ç…§æ¥­å‹™é ˜åŸŸåˆ‡é–‹å¾Œï¼Œæœƒéœ€è¦å¯ä»¥éš¨æ™‚æŒ‰ç…§åœ˜éšŠçš„ç¯€å¥éƒ¨ç½²æœå‹™ï¼Œä¸¦ç¢ºä¿å…¶é¤˜æœå‹™ä¸å—å½±éŸ¿ï¼Œé€™ä¹Ÿå°±æ˜¯ç¨ç«‹éƒ¨ç½²çš„é‡è¦æ€§\nåœ¨è¨­è¨ˆæœå‹™ï¼Œè¦ç¢ºä¿æœå‹™çš„ä½è€¦åˆï¼Œå¦å‰‡æœƒé™·å…¥æ›´æ–°ä¸€å€‹æœå‹™è¦é€£å¸¶æ›´æ–°å…¶é¤˜å¤šå€‹æœå‹™ï¼Œè®Šæˆå¯æ€•çš„åˆ†æ•£å¼å–®é«”å¼æ¶æ§‹ï¼Œé€™å°±å»¶ä¼¸åˆ°é–‹é ­åˆ†äº«çš„ FB æ–‡ç«  - åœ˜éšŠæ˜¯å¦æœ‰è‰¯å¥½çš„ CICDã€æ˜¯å¦æœ‰è‰¯å¥½çš„ Log æ¶æ§‹èˆ‡ Tracing ç³»çµ±\n3. è‡ªèº«æ“æœ‰çš„è³‡æ–™ å¾®æœå‹™ä¸æ‡‰è©²å…±äº«è³‡æ–™åº«ï¼Œå¦‚æœå…¶é¤˜æœå‹™éœ€è¦è³‡æ–™ï¼Œæ‡‰è©²è¦é€éæœå‹™ä»‹é¢è€Œéç›´æ¥å­˜å–è³‡æ–™ï¼Œé¿å…ç¨‹å¼ç¢¼æ‹†åˆ†æœ€å¾Œå»åœ¨è³‡æ–™åº«è€¦åˆï¼Œæ¶ˆæŠ¹äº†ç¨ç«‹éƒ¨ç½²çš„åŠŸç”¨\nå¾®æœå‹™å¥½è™• ä¸»è¦é«”ç¾åœ¨éˆæ´»æ€§\néƒ¨ç½²ç¨ç«‹æ€§ï¼šæ”¹å–„ç³»çµ±è¦æ¨¡èˆ‡å¼·å¥æ€§ (Robust)ã€å¯æ··ç”¨ä¸åŒæŠ€è¡“ æ›´å¥½åˆ†å·¥ï¼šä¸åŒåœ˜éšŠå°ˆæ³¨ä¸åŒçš„ code base å–®é«”å¼æ¶æ§‹ 1. å–®ä¸€ç¨‹åº å°‡æ‰€æœ‰ç¨‹å¼ç¢¼æ”¾å…¥å–®ä¸€ç¨‹åºéƒ¨ç½²çš„ç³»çµ±ä¸­\n2. æ¨¡çµ„åŒ–å–®é«”å¼ å°‡å–®ä¸€ç¨‹åºæ¨¡çµ„åŒ–ï¼Œè®“æ¯å€‹æ¨¡çµ„éƒ½èƒ½ç¨ç«‹é‹ä½œï¼Œåªæ˜¯éƒ¨ç½²æœƒçµ±ä¸€éƒ¨ç½²ï¼Œç”šè‡³å¯ä»¥è®“ä¸åŒæ¨¡çµ„ä½¿ç”¨ä¸åŒçš„è³‡æ–™åº«ï¼›éå¸¸æ¨è–¦ Shopify çš„åˆ†äº« Under Deconstruction: The State of Shopifyâ€™s Monolithï¼Œé è¨ˆä¹‹å¾Œå†å±•é–‹è¨è«–\nè€¦åˆèˆ‡å…§èš å…§èšæ˜¯æŒ‡ã€Œç¨‹å¼ç¢¼åŒè®Šå‹•ã€å…±ç•™å­˜ã€ï¼Œç•¶ä»Šå¤©æ”¹ A åŠŸèƒ½æ™‚ï¼Œåƒ…éœ€è¦ç¢ºä¿ A åŠŸèƒ½ç›¸é—œçš„æœå‹™æ”¹å‹•ï¼Œé™ä½è®Šå‹•æˆæœ¬\nè€¦åˆæ˜¯æŒ‡ã€Œè³‡è¨Šéš±è—ã€ï¼ŒæŠŠç›¸å°ç¶“å¸¸æ€§è®Šå‹•çš„éƒ¨åˆ†èˆ‡éœæ…‹çš„éƒ¨åˆ†åˆ†é–‹ï¼Œæœ‰å€‹ç©©å®šçš„æ¨¡çµ„é‚Šç•Œï¼Œåˆå¯ç´°åˆ†æˆå¯¦ä½œè€¦åˆã€æ™‚é–“è€¦åˆã€éƒ¨ç½²è€¦åˆã€é ˜åŸŸè€¦åˆ\nå°çµ ç¬¬ä¸€ç« å®šç¾©äº†å¾®æœå‹™ã€å–®é«”å¼æ¶æ§‹ï¼Œä¸¦åˆ†æèƒŒå¾Œè¨­è¨ˆåŸç†èˆ‡æœ€çµ‚åæ‡‰çš„æ¶æ§‹å„ªåŠ£ï¼Œä½†éœ€è¦å°å¿ƒ å–®é«”å¼ä¸ç­‰åŒæ–¼å‚³çµ±ï¼Œä¸è¦æ±¡ååŒ–å–®é«”å¼ï¼Œæ‡‰è©²è¦ç”¨æ›´å®¢è§€çš„è§’åº¦æ¬Šè¡¡æ¶æ§‹é¸æ“‡\næœ€å¾Œä½œè€…æ¨è–¦ DDD å”åŠ©æ¥­å‹™é ˜åŸŸçš„å®šç¾©èˆ‡æ‹†åˆ†\nç¬¬äºŒç« ï¼šé·ç§»è¨ˆç•« å¾®æœå‹™æ˜¯å€‹æŠ€è¡“é¸æ“‡è€Œéç›®çš„ï¼Œå†å°å…¥å‰æ‡‰è©²å…ˆè¬¹æ…æ€è€ƒ\næƒ³è¦è§£æ±ºçš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿæƒ³è¦è§£æ±ºçš„å•é¡Œè·Ÿå…¬å¸åˆ©ç›Šæ˜¯å¦ä¸€è‡´ï¼Ÿç”¨æˆ¶æ˜¯å¦æœƒå› æ­¤å—ç›Šï¼Ÿ æ˜¯å¦æ¯”è¼ƒéæ›¿ä»£æ–¹æ¡ˆï¼Ÿæ˜¯ä¸æ˜¯å…¶ä»–ã€Œç„¡èŠçš„æŠ€è¡“ã€å°±èƒ½è§£æ±ºå•é¡Œï¼Ÿ å¦‚ä½•è¡¡é‡å°å…¥å¾®æœå‹™çš„æˆæ•ˆï¼Ÿæ€éº¼å†å°å…¥éç¨‹çŸ¥é“æ–¹å‘æ˜¯å¦æ­£ç¢ºï¼Ÿ ç‚ºä»€éº¼é¸æ“‡å¾®æœå‹™ å¦‚æœæ˜¯å› ç‚ºä¸‹åˆ—åŸå› è€Œæƒ³è¦å°å…¥å¾®æœå‹™ï¼Œå¯ä»¥å…ˆæ€è€ƒçœ‹çœ‹æ›¿ä»£æ–¹æ¡ˆæ˜¯å¦å¯è¡Œ\nå°å…¥ç›®çš„ å¾®æœå‹™çš„æ½›åœ¨å„ªé» æ›¿ä»£æ–¹æ¡ˆ å¢åŠ åœ˜éšŠè‡ªä¸»æ€§ æ‹†åˆ†å¾®æœå‹™è®“åœ˜éšŠçš„è¦æ¨¡å°ã€æ“æœ‰ç›¸å°æ¬ŠåŠ›ï¼Œå¯ä»¥æ›´æœ‰æ•ˆçš„å·¥ä½œ åˆ†é…è²¬ä»»æœ‰å¾ˆå¤šæ–¹å¼ï¼Œä¸¦ä¸ä¸€å®šè¦æ”¹æ¶æ§‹ï¼Œå¯ä»¥å°‡ç¨‹å¼ç¢¼æ‰€æœ‰æ¬Šåˆ†å±¬ä¸åŒçš„åœ˜éšŠï¼Œåƒæ˜¯æ¡å–æ¨¡çµ„åŒ–å–®é«”å¼çµæ§‹ï¼Œä¾‹å¦‚ shopify ç¸®çŸ­ä¸Šå¸‚æ™‚é–“ å–®ç¨é‡å°å¾®æœå‹™é€²è¡Œè®Šæ›´èˆ‡éƒ¨ç½² åœ¨æ€è€ƒç”Ÿç”¢åŠ›å•é¡Œæ™‚ï¼Œæ‡‰è©²è¦å…ˆæª¢è¦–é–‹ç™¼æµç¨‹çš„è²§é ¸åœ¨ä½•è™•ï¼Œä½œè€…æåˆ°ä»–çš„é¡§å•ç”Ÿæ¶¯ä¸­ç™¼ç¾æ˜¯éœ€æ±‚å‚³ééç¨‹è€—è²»æœ€å¤šæ™‚é–“è€Œéé–‹ç™¼ï¼Œæ‰€ä»¥æ‡‰è©²å…ˆå¯©è¦–èˆ‡é‡æ¸¬è»Ÿé«”é–‹ç™¼çš„æ¯å€‹æ­¥é©Ÿ æœ‰æ•ˆæ“´å±•è² è¼‰ å–®å€‹å¾®æœå‹™å¯ä»¥ç¨ç«‹æ“´å±•ï¼Œæ›´å‹•æ…‹çš„èª¿æ•´å€‹åˆ¥æœå‹™çš„è¦æ¨¡ å–®é«”å¼çš„æ°´å¹³æ“´å±•ä¾ç„¶æ˜¯å¾ˆæœ‰æ•ˆçš„æ“´å±•æ–¹å¼ï¼Œå¦‚æœç•¶ä¸‹é‡åˆ°æ•ˆèƒ½è²§é ¸ï¼Œç›´æ¥æ“´å±•è€Œéå°å…¥å¾®æœå‹™å¯èƒ½æ˜¯ç›¸å°å¿«é€Ÿåˆæœ‰æ•ˆçš„é¸æ“‡ å¢é€²å¼·å¥æ€§ æ‹†åˆ†å¾®æœå‹™å¾Œï¼Œå¯å€‹åˆ¥ä¾æ“šæ¥­å‹™éœ€æ±‚è€Œå€åˆ†å‡ºæ ¸å¿ƒèˆ‡éæ ¸å¿ƒçš„å¾®æœå‹™ï¼Œé€²è€Œæä¾›ä¸åŒçš„å¼·å¥æ€§èª¿æ•´ é€é Load Balancerã€Event Queue æ­é…å–®é«”å¼ç³»çµ±çš„æ°´å¹³æ“´å±•ï¼Œä¸€æ¨£å¯ä»¥å¢é€²å¼·å¥æ€§ï¼ŒæŠŠè³‡æºæŠ•æ³¨åœ¨è¨ºæ–·ç³»çµ±åŸå› å¯èƒ½æœƒæ›´æœ‰å¹«åŠ© æ“´å±•é–‹ç™¼äººå“¡ åœ¨ã€Šäººæœˆç¥è©±ã€‹ä¸­åªæœ‰æŠŠé …ç›®æ‹†åˆ†æˆå¯ç¨ç«‹ä½œæ¥­çš„é …ç›®ï¼Œå¢åŠ äººåŠ›æ‰æœ‰è¾¦æ³•åŠ é€Ÿé–‹ç™¼å¦å‰‡å¤šé¤˜çš„äººåŠ›æ˜¯æ²’æœ‰æ¬è‘—çš„ï¼Œå¾®æœå‹™é€éè‰¯å¥½çš„ä»‹é¢éš”é›¢å¯¦ä½œï¼Œè®“åœ˜éšŠè¦åŠ äººç›¸å°å®¹æ˜“ é‡é»æ“ºåœ¨åœ˜éšŠèˆ‡æœå‹™çš„æ‰€æœ‰æ¬Šè¦ä¿æŒä¸€è‡´ï¼Œå¯ä»¥é€éæ¨¡çµ„åŒ–å–®é«”å¼åˆ†å·¥åˆä½œ æ“æŠ±æ–°æŠ€è¡“ å¾®æœå‹™å› ç‚ºæ˜¯ç¨ç«‹éƒ¨ç½²ï¼Œä¸åŒæœå‹™é–“å¯ä»¥æ¡å–å®Œå…¨ä¸åŒçš„æŠ€è¡“æ¶æ§‹ é€™æ˜¯å¾®æœå‹™å¾ˆæ˜é¡¯çš„å„ªå‹¢ï¼Œæ›¿ä»£æ–¹æ¡ˆå¯ä»¥è€ƒæ…®å‘ JVM æ”¯æ´ Java, Scala, Kotlin ç­‰åŒå®¶æ—èªè¨€ï¼Œæˆ–æ˜¯åƒ Graal VM \u0008åŒä¸€å€‹ Runtime æ”¯æ´å¤šç¨®èªè¨€ å¾®æœå‹™ä½•æ™‚æ˜¯ä¸å¥½çš„ä¸»æ„ æ¨¡ç³Šé ˜åŸŸï¼šéŒ¯èª¤å®šç¾©æœå‹™é‚Šç•Œæœƒå¾ˆå¯æ€•ï¼Œå› ç‚ºæœƒé€ æˆè·¨æœå‹™çš„é€£é–æ”¹å‹• æ–°å‰µå…¬å¸ï¼šå¯èƒ½æœ‰é»çˆ­è­°ï¼Œä½†é€™å‘¼æ‡‰åˆ°ä¸Šä¸€é»ï¼Œå¦‚æœå…¬å¸çš„å•†æ¥­æ¨¡å¼é‚„æ²’æœ‰ç©©å®šï¼Œé‚£è‡ªç„¶å°±ç„¡æ³•åˆ‡å‡ºæ­£ç¢ºçš„æœå‹™é‚Šç•Œ å®¢æˆ¶å®‰è£èˆ‡è»Ÿé«”ç®¡ç†ï¼šå¦‚æœæ˜¯è¦æŠŠè»Ÿé«”æ‰“åŒ…çµ¦åº«æˆ¶ï¼Œä½¿ç”¨å¾®æœå‹™å¯èƒ½æœƒä¸å¤ªå¥½ï¼Œè¦è€ƒé‡åˆ°å®¢æˆ¶çš„ç®¡ç†èƒ½åŠ› æ²’æœ‰å……åˆ†ç†ç”±æ™‚ çµ„ç¹”è®Šé© ä½œè€…è¼ƒå“¨å¦‚ä½•åœ¨çµ„ç¹”å…§å°å…¥æ–°çš„æŠ€è¡“ï¼Œåˆ†äº« John Kother åšå£«çš„çµ„ç¹”è®Šé©æ­¥é©Ÿï¼Œå¤§è‡´ä¸Šæºé€šã€å°å¹…å˜—è©¦ã€çœ‹åˆ°åˆæ­¥æ•ˆç›Šã€èå…¥çµ„ç¹” å†ç”¢ç”Ÿè®Šé©æ™‚ï¼Œè¦æ³¨æ„åˆ°è®Šé©æˆæœ¬ï¼ŒJeff Bezos å°‡è®Šé©åˆ†æˆå…©é¡ï¼šç¬¬ä¸€é¡æ˜¯å¿…ç„¶ã€ä¸å¯é€†çš„ï¼Œç¬¬äºŒé¡æ˜¯å¯é€†ã€å¯è®ŠåŒ–çš„ï¼Œç¬¬ä¸€é¡éœ€è¦é•·æœŸè¨è«–ã€è¬¹æ…çš„æ€è€ƒï¼Œç¬¬äºŒé¡å¯ä»¥è®“é«˜åˆ¤æ–·åŠ›çš„å€‹äººæˆ–çµ„ç¹”è¿…é€Ÿåšå‡ºï¼› æ²’æœ‰ç¶“å¸¸ä¸‹æ±ºç­–çš„äººé€šå¸¸æœƒèª¤æŠŠç¬¬äºŒé¡ç•¶ä½œç¬¬ä¸€é¡ï¼Œè®“æ‰€æœ‰æ±ºç­–éƒ½åœæ»¯ä¸å‰ é€™ä¹Ÿå‘¼æ‡‰åˆ°ä¹‹å‰å·¥ä½œæ™‚å…¬å¸å°å…¥æ•æ·é–‹ç™¼ï¼Œå›ºç„¶çœ‹åˆ°å¿«é€Ÿè¿­ä»£ã€æŒçºŒé©—è­‰èˆ‡å¾®èª¿çš„å„ªå‹¢ï¼Œä½†å…§éƒ¨ä¹Ÿæ™‚å¸¸åœ¨çˆ­è«–å¦‚å°è¦æ¨¡å¯¦é©—æ˜¯å¦çœŸçš„æœ‰æ•ˆã€ç”¨æˆ¶æœƒä¸æœƒå› ç‚ºå¯¦é©—è€Œå¤§é‡æµå¤±ç­‰ç­‰ï¼Œç¾åœ¨åæ€èµ·ä¾†å°±æ˜¯æ²’æœ‰æŠŠç¬¬ä¸€é¡èˆ‡ç¬¬äºŒé¡æ±ºç­–æºé€šæ¸…æ¥šçš„ç·£æ•…\nå¦‚ä½•é–‹å§‹ ä½œè€…æ¨å´‡é€é DDD å¹«åŠ©å®šç¾©æœå‹™é‚Šç•Œï¼Œä¸¦æ¡ç”¨ Event Storming è®“å¤§å®¶å°æ–¼æ¨¡å‹æœ‰å…±åŒçš„ç†è§£\næ¥è‘—å¾€å…§æª¢è¦–åœ˜éšŠçš„çµ„æˆï¼Œåœ˜éšŠæˆå“¡æ˜¯å¦æœ‰è¶³å¤ çš„æŠ€èƒ½ï¼Ÿä¾‹å¦‚èªªå¾®æœå‹™è¦é€éäº‹ä»¶æºé€šå°å…¥ Kafkaï¼Œé‚£åœ˜éšŠæ˜¯å¦æœ‰ Kafka ç†Ÿæ‚‰çš„äººæ‰ï¼Ÿå¦‚æœæ²’æœ‰è¦èŠ±å¤šå°‘æ™‚é–“è·Ÿè³‡æºèª¿æ•´ï¼Ÿ\nå¦‚ä½•ç¢ºå®šè½‰ç§»æ˜¯å¦æœ‰æ•ˆ å¯ä»¥è¨­ç«‹å®šæœŸæª¢æŸ¥é»ï¼Œå†ä¸€å®šæ™‚é–“æª¢æŸ¥å®šæ€§èˆ‡å®šé‡æªæ–½ï¼Œå®šé‡æªæ–½åŒ…å«ç™¼å¸ƒé€±æœŸã€æ•…éšœç‡ã€éƒ¨ç½²æ¬¡æ•¸ã€æ€§èƒ½ç›£æ§ç­‰ï¼Œä½†è¦å°å¿ƒå®šé‡çš„æŒ‡æ¨™æœƒè®Šæˆé™·é˜±ï¼Œä¾‹å¦‚åœ˜éšŠè¿½æ±‚éƒ¨ç½²æ¬¡æ•¸è€Œç›²ç›®æ›´æ–° (å°±è·Ÿ RD è²¢ç»åº¦çœ‹ç¨‹å¼ç¢¼è¡Œæ•¸å£¹æ¨£çš„å¯ç¬‘)ï¼Œæ‰€ä»¥éœ€è¦æ­é…å®šæ€§æªæ–½ï¼Œè¨ªè«‡æˆå“¡å°æ–¼è½‰ç§»éç¨‹çš„æ„Ÿå—\nç¬¬ä¸‰ç« ï¼šåˆ†å‰²å–®é«”å¼æ¶æ§‹ ç•¶é€šéä¸Šé¢å…©ç« çš„è¨è«–ï¼Œç¢ºå®šè¦å°å…¥å¾®æœå‹™æ™‚ï¼Œå›é¦–ç¾å¯¦è¦é¢å°çš„æ™‚é¾å¤§ã€æ¶æ§‹æ··äº‚çš„å–®é«”å¼æ¶æ§‹\n1. é‡çµ„å–®é«”å¼ç³»çµ± å‚³çµ±ç¨‹å¼ç¢¼é€šå¸¸ä»¥æŠ€è¡“åˆ†é¡è€Œéæ¥­å‹™é ˜åŸŸåˆ†é¡ï¼Œä¾‹å¦‚ Model / Controller / View ç­‰è³‡æ–™å¤¾æ‹†åˆ†ï¼Œè¦é‡æ–°ä»¥æ¥­å‹™é ˜åŸŸæ‹†åˆ†ä¸¦æ‰¾å‡ºå°æ‡‰çš„ç¨‹å¼ç¢¼æœƒæ˜¯ä¸€é …å¤§å·¥ç¨‹ï¼Œæ­¤æ™‚å¯ä»¥åƒè€ƒå¸‚é¢ä¸Šé‡æ§‹èˆ‡ç®¡ç† legacy code çš„æ–¹æ³•\n2. æ¨¡çµ„åŒ–å–®é«”å¼ å¯ä»¥è€ƒæ…®å°‡åŠŸèƒ½å»ºç«‹ç¨ç«‹çš„æ¨¡çµ„ï¼Œä¾‹å¦‚ Java çš„ Jar æª”ã€Ruby çš„ Gem ç­‰ï¼Œæ‹†å‡ºç¨ç«‹çš„æ¨¡çµ„æœªä¾†è¦ç¨ç«‹éƒ¨ç½²æˆå¾®æœå‹™ä¹Ÿæœƒæ¯”è¼ƒå®¹æ˜“\n3. æ¼¸é€²é‡å¯« è©¦è‘—å…ˆé‡æ§‹ç¾æœ‰çš„ç¨‹å¼ç¢¼ï¼Œæ¥è‘—åœ¨é‡æ–°å¯¦ç¾åŠŸèƒ½ï¼Œå¦‚æœåŸæœ¬ç¨‹å¼ç¢¼ä¸­çš„é‚è¼¯æ²’æœ‰å…ˆæ¢³ç†æ¸…æ¥šå°±è²¿ç„¶é‡å¯«ï¼ŒåªæœƒæŠŠéæ™‚ä¸”è¤‡é›œçš„é‚è¼¯é‡æ–°å¾©åˆ»ï¼Œä¸¦æ‹–ç´¯è½‰ç§»çš„é€Ÿåº¦\né·ç§»æ¨¡å¼ æ¨¡å¼ä¸€ï¼šçµæ®ºæ¦• (Strangler Fig) ç”± Martin Fowler åœ¨çœ‹åˆ°çµæ®ºæ¦•ç”Ÿé•·è¯æƒ³çš„ç³»çµ±é·ç§»æ¨¡å¼ StranglerFigApplicationï¼Œä¸€é–‹å§‹ç¨®å­åœ¨æ¨¹ä¸Šç”Ÿé•·ï¼Œæ¥è‘—è½åœ°å¾ŒæŒçºŒæˆé•·ï¼Œæœ€å¾Œæ¯æ¨¹æœƒæ­»äº¡\nå¥—ç”¨é¡ä¼¼çš„é‚è¼¯åœ¨è»Ÿé«”ç³»çµ±ä¸Šï¼Œæœ€ç›´è¦ºçš„åšæ³•æ˜¯é‡å¯«ä¸€å€‹æ–°ç³»çµ±ç›´æ¥é·ç§»å°±å¥½ï¼Œä½†å¾€å¾€äº‹æƒ…æ›´è¤‡é›œï¼Œä¸€æ¬¡æ€§é‡å¯«æ–°ç³»çµ±éœ€è¦æ›´å¤šçš„æ™‚é–“ä¸¦å†’è‘—æ›´å¤§çš„é¢¨éšªï¼›\nå­¸ç¿’çµæ®ºæ¦•ï¼Œè®“æ–°ç³»çµ±å¯ä»¥ç›¸å®¹æ–¼èˆŠç³»çµ±ï¼Œæ¥è‘—å†é€æ­¥æŠ½é›¢æ–°ç³»çµ±ï¼Œæœ€å¾Œå®Œæˆè½‰ç§»æ±°æ›èˆŠç³»çµ±ï¼Œè®“æ¯ä¸€å€‹æ­¥é©Ÿæ›´å°ä¸¦é™ä½é¢¨éšªï¼Œå¦‚æœä¸­é–“çŠ¯éŒ¯å¯ä»¥å¾ˆå¿«é€€è¿”ï¼Œæˆ–æ˜¯çµ‚æ­¢è½‰ç§»ä¹Ÿä¸æœƒæœ‰ä»»ä½•å•é¡Œ æ–¹æ³•é©ç”¨æ–¼ä¸Šå±¤çš„æœå‹™ï¼Œå¦‚æœæ˜¯ç³»çµ±å…§æ¯”è¼ƒåº•å±¤çš„æœå‹™æœƒæ¯”è¼ƒé›£å¥—ç”¨ (å¾ŒçºŒä»‹ç´¹)ï¼Œå¯¦ä½œä¸Šå¯ä»¥åœ¨å–®é«”å¼æ¶æ§‹å‰å¤šä¸€å€‹ä»£ç†å™¨å¦‚ HTTP Proxy æˆ–æ˜¯ Message Queueï¼Œé·ç§»æ­¥é©Ÿå¤§æ¦‚æ˜¯\nç•¶æ–°ç³»çµ±å¯¦ä½œå°šæœªå®Œæˆæ™‚ï¼ŒåŸæœ¬çš„ Request æŒçºŒæµå‘\u0008èˆŠç³»çµ± æ–°ç³»çµ±å®Œæˆå¾Œå¯å…ˆéƒ¨ç½²ï¼Œä½†æ­¤æ™‚é‚„æœªå°å¤–é–‹æ”¾ é€éé‡‘çµ²é›€éƒ¨ç½²ï¼Œå…ˆæ”¾æ‰‹éƒ¨åˆ†æµé‡åˆ°æ–°ç³»çµ± ç¢ºä¿æ²’å•é¡Œï¼Œæµé‡å®Œæ•´åˆ‡æ›è‡³æ–°ç³»çµ±ï¼Œæ±°æ›èˆŠç³»çµ± åœ¨å°å…¥ä»£ç†å™¨æ™‚ï¼Œè¦æ³¨æ„ Smart Endpoints and Dumb Pipesï¼Œä¸è¦è®“ä»£ç†å™¨æ‰¿æ“”éå¤šçš„è·è²¬ï¼Œä¾‹å¦‚èªªå› ç‚ºèˆŠç³»çµ±æ”¯æ´ soap ä½†æ–°ç³»çµ±è¦æ”¯æ´ grpcï¼Œèˆ‡å…¶è®“ä»£ç†å™¨åˆ¤æ–· soap -\u0026gt; èˆŠç³»çµ± / grpc èµ°æ–°ç³»çµ±ï¼Œé‚„ä¸å¦‚ç›´æ¥å°å¤–å…¬é–‹å…©å€‹å”å®šï¼Œè€ŒèˆŠç³»çµ±å†æŠŠ soap æ ¼å¼è½‰æ›åˆ°æ–°ç³»çµ±çš„ grpc å»¶ä¼¸é–±è®€ Microservice Principles: Smart Endpoints and Dumb Pipes\næ¨¡å¼äºŒï¼šæŠ½è±¡åˆ†æ”¯ ç•¶è¦æŠ½é›¢çš„çµ„ä»¶æ˜¯ç³»çµ±çš„åº•å±¤ï¼Œä¾‹å¦‚ä½¿ç”¨è€…é€šçŸ¥åŠŸèƒ½ï¼Œå¦‚æœè¦ç›´æ¥æ”¹å¯«æœƒå¿…é ˆæŠŠå¯¦ä½œç«¯èˆ‡å‘¼å«ç«¯ä¸€æ¬¡æ”¹å‹•ï¼Œæ­¤æ™‚æœ€å¥½æ˜¯\nç‚ºè¦æ›¿æ›çš„åŠŸèƒ½å»ºç«‹æŠ½è±¡ è®“èˆŠç³»çµ±çš„å…¶ä»–åŠŸèƒ½ä¾è³´ä»‹é¢è€Œéå¯¦ä½œ æä¾›å¾®æœå‹™çš„å¯¦ä½œ åˆ‡æ›æŠ½è±¡ä¸¦ä½¿ç”¨å¯¦ä½œ åˆªé™¤èˆŠå¯¦ä½œ åœ¨å®‰å¾·é­¯å¤§å”çš„éƒ¨è½æ ¼ä¸­æœ‰æåˆ°ç›¸åŒçš„æ¦‚å¿µ å¾®æœå‹™æ¶æ§‹ #2, æŒ‰ç…§æ¶æ§‹ï¼Œé‡æ§‹ç³»çµ±ï¼Œèº«ä»½é©—è­‰çµ„ä»¶å¹¾ä¹æ˜¯æ‰€æœ‰åŠŸèƒ½éƒ½æœƒç›¸ä¾çš„çµ„ä»¶ï¼Œè¦å¾å–®é«”å¼æ¶æ§‹æŠ½å‡ºä¾†å‰ï¼Œè¨˜å¾—å…ˆæŠ½è±¡åŒ–ï¼Œç¢ºä¿åŠŸèƒ½å¼•ç”¨éƒ½ä¾è³´æŠ½è±¡åŒ–ï¼Œæœ€å¾Œæ‰\u0008æ›¿æ›å¾®æœå‹™å¯¦ä½œï¼Œé€™æ¨£æœ€å¾Œå¤±æ•—è¦åˆ‡æ›å›å»ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œé€™åˆå‘¼æ‡‰å› Martin Fowler åœ¨çµæ®ºæ¦•æ–‡ç« èªªçš„\nwhen designing a new application you should design it in such a way as to make it easier for it to be strangled in the future.\næœç„¶å¤§å¸«å€‘èªªçš„é“ç†éƒ½æ˜¯ç›¸é€šçš„\næ¨¡å¼ä¸‰ï¼šå¹³è¡Œæ¨¡å¼ å¦‚æœæ˜¯éå¸¸æ ¸å¿ƒã€é‡è¦çš„åŠŸèƒ½å¦‚é‡‘æµï¼Œåœ¨é‡å¯«æˆæ–°å¾®æœå‹™æ™‚ï¼Œå¯ä»¥æ¡ç”¨å¹³è¡Œæ¨¡å¼é›™é‚Šå¯«å…¥ï¼Œæ¯æ—¥é€²è¡Œæ¯”å°ç›´åˆ°æ²’æœ‰å‡ºéŒ¯æ™‚åœ¨åˆ‡æ›ï¼Œé™ä½å¾®æœå‹™ä¸Šç·šçš„é¢¨éšª\ngithub æœ‰é–‹æºä¸€å€‹ Ruby gem scientistï¼Œå°ˆé–€åšå¹³è¡ŒåŒ–å¯¦é©—çš„æ¯”è¼ƒ è£é£¾è€…æ¨¡å¼ å¦‚æœç•¶å‰ç³»çµ±ç„¡æ³•è¢«ä¿®æ”¹ï¼Œå»éœ€è¦æ””æˆªå‘¼å«ä¸¦é¡å¤–å¢åŠ è¡Œç‚ºï¼Œå¯ä»¥è€ƒæ…®ç”¨è£é£¾è€…æ¨¡å¼ï¼Œé€éä»£ç†æœå‹™å™¨åœ¨å‘¼å«å®ŒåŸç³»çµ±å¾Œï¼Œé¡å¤–å‘¼å«å¾®æœå‹™ï¼›ä½†è¦å°å¿ƒé•å dump pipe çš„é¢¨éšª\næ¨¡å¼å››ï¼šè®Šæ›´è³‡æ–™æ“·å– åŒæ¨£æ˜¯ä¸ä¿®æ”¹ç•¶å‰ç³»çµ±ï¼Œä¹Ÿä¸æƒ³ç”¨è£é£¾è€…æ¨¡å¼ï¼Œä½†åŒæ¨£å¸Œæœ›åœ¨è¡Œç‚ºè®Šå‹•æ™‚è§¸ç™¼å¾®æœå‹™ï¼Œå¦‚æœƒå“¡è¨»å†Šå¾Œï¼Œè¦æ‰“å°æœƒå“¡å¡ï¼Œå¯ä»¥é€éè³‡æ–™å„²å­˜çš„æ–¹å¼ï¼Œä¾‹å¦‚è³‡æ–™åº«çš„ triggerã€å®šæœŸ polling è³‡æ–™åº«ï¼›ä½†è¦å°å¿ƒè€¦åˆåœ¨è³‡æ–™åº« æ¨¡å¼äº”ï¼šä½¿ç”¨è€…ä»‹é¢çµ„æˆ UI ç«¯ä¹Ÿå¯ä»¥æŠŠé é¢æ‹†è§£æˆä¸åŒçš„çµ„ä»¶ï¼Œä¾‹å¦‚ Micro Frontendï¼Œå› æ‡‰ Web æ¨™æº–çš„ç™¼å±•æ”¯æ´ custom elementï¼Œè®“ä¸åŒçš„åœ˜éšŠå¯ä»¥æ¡ç”¨ä¸åŒçš„æŠ€è¡“å¯¦åšä¸åŒçš„çµ„ä»¶ï¼Œé€é DOM event è·¨çµ„ä»¶é€šä¿¡\nç¸½çµ å‰ä¸‰å¼µè«‡äº†çµ„ç¹”èˆ‡ç¨‹å¼ç¢¼æ¶æ§‹ï¼Œè©•ä¼°å°å…¥å¾®æœå‹™çš„å„ªåŠ£ã€å¤§æ–¹å‘ä¸Šå°å…¥çš„æ–¹å¼ï¼Œå¾Œé¢å…©å¼µæœƒç¹¼çºŒè«‡æœ€é›£æ‹†åˆ†çš„è³‡æ–™åº«æ¬ç§»ä»¥åŠå°å…¥å¾Œéš¨è‘—çµ„ç¹”æˆé•·æœƒé‡åˆ°çš„å›°å¢ƒ\n","date":"2021-12-03T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-12-03-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8A/","title":"ã€Šå–®é«”å¼ç³»çµ±åˆ°å¾®æœå‹™ã€‹è®€å¾Œåˆ†äº« - ä¸Š"},{"content":"æœ€è¿‘å› ç‚ºè³‡æ–™åˆ†æé–‹å§‹å¤§é‡ä½¿ç”¨ Pythonï¼Œèˆ‡åŒäº‹å”ä½œåœ¨åŒä¸€å€‹ Package ä¸‹æ‹†åˆ†ä¸åŒ Module å¯¦ä½œï¼Œç•¶æˆ‘æƒ³ç›´æ¥åŸ·è¡Œ Module é‡ä¸Šäº† ã€ŒModuleNotFoundError: No module namedã€çš„éŒ¯èª¤ï¼Œè®“æˆ‘é–‹å§‹æƒ³ç­è§£ Python çš„ Package ç³»çµ±é‹ä½œçš„åŸç†\nPython Package è¼‰å…¥æ–¹å¼ å®˜æ–¹æ–‡ä»¶ï¼š6. æ¨¡çµ„ (Module) å¯«å¾—å¾ˆè©³ç›¡ï¼Œæ¨¡çµ„çš„è¼‰å…¥é †åºæ˜¯æ ¹æ“š sys.pathï¼Œè€Œ sys.path ä¾åºç”±ä»¥ä¸‹çµ„æˆ\nç•¶å‰è·¯å¾‘ ç’°å¢ƒè®Šæ•¸ PYTHONPATH site-package å…¶ä¸­ site-package æ˜¯ä½¿ç”¨æ‰‹å‹•å»ºç½® package æ‰€åœ¨ä½ç½® (pip install, python setup.py install)ï¼Œå¯èƒ½æœƒæœ‰éå¸¸å¤šçµ„ï¼Œæ¯ä¸€ä½ user / venv ä¸‹åˆæœ‰å°æ‡‰çš„ site-packageï¼Œåƒè€ƒ How do I find the location of my Python site-packages directory?å¯ä»¥æ‰¾å‡ºå°æ‡‰çš„è·¯å¾‘\nGlobal: $ python -m site User: $ python -m site --user-site æ‰€ä»¥ sys.path æ±ºå®šäº† package è¼‰å…¥çš„é †åºï¼Œä¾‹å¦‚ç•¶å‰è·¯å¾‘ä¸‹ package åç¨±èˆ‡æ ¸å¿ƒæ¨¡çµ„é‡è¤‡ï¼Œé‚£æœƒä»¥ç•¶å‰è·¯å¾‘å„ªå…ˆè¼‰å…¥ï¼›\næ‰€ä»¥èƒ½é€éå‹•æ…‹æ”¹è®Š sys.path æ±ºå®šè¼‰å…¥é †åº\nç‚ºä»€éº¼ç›´æ¥åŸ·è¡Œ Package ä¸‹çš„ Module æœƒå¤±æ•— åœ¨ Python ä¸­ï¼Œimport å¯ä»¥é¸æ“‡å®Œæ•´çš„ Module è·¯å¾‘æˆ–æ˜¯ç›¸å°è·¯å¾‘ï¼Œè€Œè·¯å¾‘æœƒå—åˆ°åŸ·è¡Œæª”æ¡ˆçš„ sys.path èˆ‡ __package__ çš„å½±éŸ¿ï¼Œç›¸é—œçš„ magic method ç‚º\n__name__ï¼šModule çš„å®Œæ•´åç¨± __package__ï¼šæ±ºå®šç›¸å°è·¯å¾‘ import çš„è§£æè·¯å¾‘ï¼Œå¦‚æœæª”æ¡ˆæ˜¯ Packageï¼Œå‰‡ __package__ æœƒç­‰æ–¼ __name__ï¼›\nå¦‚æœæ˜¯ Module å‰‡ __package__ æ˜¯æ‰€å±¬çš„ Package åç¨±ï¼›\nå¦‚æœ Module æ˜¯ top-level modulesï¼Œä¹Ÿå°±æ˜¯ __name__ == __main__ï¼Œå‰‡ __package__ ç‚º None ä»¥ä¸‹åƒè€ƒè‡ª Relative imports in Python 3ï¼Œ\u0008å‡è¨­ç›®å‰çš„å°ˆæ¡ˆç›®éŒ„æ˜¯\n1 2 3 4 5 main.py mypackage/ __init__.py mymodule.py myothermodule.py åœ¨ myothermodule.py ä¸­ï¼Œè¼‰å…¥ mymoduleï¼Œå¯ä»¥é€éå®Œæ•´è·¯å¾‘ import mypackage.mymodule æˆ–æ˜¯ç›¸å°è·¯å¾‘ import .mymodule çš„æ–¹å¼ï¼Œä½†å¦‚æœç›´æ¥åŸ·è¡Œ $python myothermodule æœƒåˆ†åˆ¥é‡åˆ°ä»¥ä¸‹éŒ¯èª¤\nå®Œæ•´è·¯å¾‘ 1 ModuleNotFoundError: No module named \u0026#39;mypackage\u0026#39; ç›¸å°è·¯å¾‘ 1 ImportError: attempted relative import with no known parent package å®Œæ•´è·¯å¾‘çš„éŒ¯èª¤åŸå› æ˜¯å› ç‚º sys.path ä¸­æ²’æœ‰ mypackageï¼Œsys.path æ˜¯åŠ å…¥script ç•¶å‰çš„è³‡æ–™å¤¾ (./mypackage)è€Œä¸æ˜¯ ./ï¼Œæ‰€ä»¥ mypackage æ˜¯ç„¡æ³•è¢«è¼‰å…¥çš„ï¼›\nç›¸å°è·¯å¾‘çš„éŒ¯èª¤å‰‡æ˜¯å› ç‚ºç•¶å‰ myothermodule.py æ˜¯ top-level moduleï¼Œ __package__ è¢«è¨­å®šç‚º Noneï¼Œæ‰€ä»¥ç›¸å°è·¯å¾‘è§£ææœƒå¤±æ•—\nå¦‚ä½•è§£æ±º åˆ†åˆ¥é‡å°å®Œæ•´è·¯å¾‘èˆ‡ç›¸å°è·¯å¾‘æå‡ºè§£æ±ºæ–¹æ¡ˆ\n1. å®Œæ•´è·¯å¾‘ æ—¢ç„¶å®Œæ•´è·¯å¾‘æ˜¯å› ç‚º sys.path æ²’æœ‰åŒ…å«åˆ° package çš„ä¸Šå±¤è·¯å¾‘è€Œæ²’æœ‰è¢«è¼‰å…¥ï¼Œé‚£å°±åŠ ä¸Šå»å³å¯\nPython é¼“å‹µä½†ä¸å¼·åˆ¶ import éƒ½è¦æ”¾åœ¨æª”æ¡ˆé–‹é ­\n1 2 3 4 5 6 7 8 9 10 11 12 13 import sys from pathlib import Path # if you haven\u0026#39;t already done so file = Path(__file__).resolve() parent, root = file.parent, file.parents[1] sys.path.append(str(root)) # Additionally remove the current file\u0026#39;s directory from sys.path try: sys.path.remove(str(parent)) except ValueError: # Already removed pass import mypackage.mymodule # æˆåŠŸ Import ç›´æ¥å®‰è£ package å¦ä¸€å€‹ä½œæ³•æ˜¯é€é setuptools ç›´æ¥å®‰è£ç›¸ä¾çš„å¥—ä»¶ï¼Œé€™æ¨£å°±èƒ½å¾ site-package importï¼Œä½†é€™æ”¹å‹•ç›¸å°éº»ç…©äº›ï¼Œä¸”è®Šæˆå¥—ä»¶è¦é¡å¤–ç®¡ç†åè€Œéº»ç…©\n2. ç›¸å°è·¯å¾‘ ä½¿ç”¨ -m åŸ·è¡Œ ç›´æ¥æŒ‡å®šå®Œæ•´çš„ package.module è·¯å¾‘ $ python -m mypackage.myothermoduleï¼Œæ­¤æ™‚ __package__ æœƒè¢«æ­£ç¢ºè§£ææˆ mypackageï¼Œåƒè€ƒ PEP366\nBy adding a new module level attribute, this PEP allows relative imports to work automatically if the module is executed using the -m switch\næ‰‹å‹•æŒ‡å®š æ‰‹å‹•å¯¦ä½œ PEP366 çš„ææ¡ˆï¼Œåƒè€ƒPEP366_boilerplate.pyï¼ŒåŠ å…¥å°æ‡‰çš„ sys.path ä¸¦æŒ‡å®š __package__ï¼Œé”åˆ°è·Ÿ -m ç›¸åŒçš„æ•ˆæœ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import sys, importlib from pathlib import Path def import_parents(level=1): global __package__ file = Path(__file__).resolve() parent, top = file.parent, file.parents[level] sys.path.append(str(top)) try: sys.path.remove(str(parent)) except ValueError: # already removed pass __package__ = \u0026#39;.\u0026#39;.join(parent.parts[len(top.parts):]) importlib.import_module(__package__) # won\u0026#39;t be needed after that if __name__ == \u0026#39;__main__\u0026#39; and __package__ is None: import_parents(level=...) çµèª ç¬¬ä¸€æ¬¡æ¥è§¸ Python è¦ºå¾—é —ç¥å¥‡ï¼Œæœ‰è¨±å¤š magic number ä»¥åŠç¨æ¨¹ä¸€æ ¼çš„ package ç®¡ç†æ–¹å¼ï¼ŒåŒ…å« virtual env çš„ä½¿ç”¨ç­‰\n","date":"2021-11-22T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-11-22-python-%E7%9B%B4%E6%8E%A5%E5%9F%B7%E8%A1%8C-package-%E4%B8%8B%E7%9A%84-module-%E7%9A%84%E9%8C%AF%E8%AA%A4/","title":"Python - ç›´æ¥åŸ·è¡Œ package ä¸‹çš„ module çš„éŒ¯èª¤"},{"content":" å¤©ç“è³¼è²·é€£çµ\næœ€è¿‘åœ¨å¹«å…¬å¸è™•ç† Data Pipelineï¼Œå°‡è³‡æ–™é€å¾€ BigQuery å„²å­˜ï¼Œä¸¦é–‹å§‹äº† SQL ç…‰ç„ï¼Œå¿…é ˆèªªå¹³å¸¸é–‹ç™¼å¯«çš„ Query è¤‡é›œåº¦éƒ½ä¸å¤ªé«˜ï¼Œæ¯”è¼ƒæ³¨é‡è³‡æ–™è¡¨çš„è¨­è¨ˆèˆ‡æ•ˆèƒ½ï¼Œè€Œå ±è¡¨ç›¸é—œå‰‡éœ€è¦æ›´å¤§é‡çš„é—œè¯ã€å»é‡ã€æŸ¥è©¢æ•ˆèƒ½ç­‰ï¼Œæ‰€ä»¥ç‰¹åˆ¥è²·äº†ã€ŠEffective SQLã€‹æ‹œè®€ä¸€ç•ªï¼Œè£¡é ­æä¾›å¾ˆå¤šå¯« SQL çš„å„ªåŒ–ï¼Œä»¥åŠé—œè¯å¾Œå„ç¨®çš„ Edge Caseï¼Œå¦‚æœä½ å°æ–¼å¯«çš„ SQL æ²’æœ‰è¶³å¤ è‡ªä¿¡ï¼Œé‚£å¾ˆæ¨è–¦å…¥æ‰‹\nä»¥ä¸‹å°‡æ•´ç†å¹¾é»æˆ‘è¦ºå¾—ç‰¹åˆ¥æœ‰å•Ÿç™¼æ€§çš„\né—œè¯é‹ç®— åœ¨é—œè¯é‹ç®—ä¸­ï¼ŒåŒ…å«äº†å…«ç¨®é‹ç®—\né¸æ“‡ï¼šé€é where / having éæ¿¾ æŠ•å½±ï¼šé€é select / group by é¸æ“‡å›å‚³æ¬„ä½ é€£æ¥ï¼šé€é join é€£æ¥å¤šå¼µè³‡æ–™è¡¨ äº¤é›†ï¼šé€é interset æ‰¾å‡ºå…©å€‹é›†åˆçš„é‡ç–Š (MySQL ä¸æ”¯æ´)ï¼Œä¹Ÿå¯ä»¥ç”¨ INNER JOINï¼Œä¾‹å¦‚ã€Œæ‰¾åˆ°åŒæ™‚è²·é bike èˆ‡ sakteboard çš„å®¢æˆ¶ã€ ç¬›å¡çˆ¾ç©ï¼šå…©å€‹é›†åˆçš„æ‰€æœ‰çµ„åˆåˆ—èˆ‰ï¼Œä½¿ç”¨ CROSS JOIN è¯é›†ï¼šåˆä½µå…©å€‹æ¬„ä½ç›¸åŒçš„é›†åˆï¼Œé€é UNION é™¤æ³•ï¼šè¢«é™¤æ•¸é›†åˆä¸­å¸¶æœ‰å…¨éƒ¨é™¤æ•¸é›†åˆçš„åˆ—ï¼Œä¾‹å¦‚ã€ŒæŸæ‡‰å¾µè€…ç¬¦åˆæ‰€ä»¥çš„å·¥ä½œæ¢ä»¶ã€ å·®é›†ï¼šä¸€å€‹é›†åˆæ¸›å»å¦ä¸€å€‹é›†åˆï¼Œå¯ä»¥é€é EXCEPT (MySQL ä¸æ”¯æ´)ï¼Œä½†å¯ä»¥ç”¨ OUTER JOIN å†å»æª¢æŸ¥ null å€¼æ¨¡æ“¬ ä½œæ³• 23: æ‰¾å‡ºä¸ç›¸ç¬¦æˆ–ä¸å­˜åœ¨çš„ç´€éŒ„ https://www.db-fiddle.com/f/4WX7yN4GWRrA1wX7zb8AXv/2\nä¸»è¦å¯ä»¥ä½¿ç”¨ 3 ç¨®æ–¹å¼\nä½¿ç”¨ In ä½¿ç”¨ Exists ä½¿ç”¨ Left Join ä¸¦ç”¨ Where å‰å…©ç¨®æ­é… subqueryï¼Œexists é€šå¸¸æ€§èƒ½æ¯” in å¥½å› ç‚ºåªè¦ subquery è‡³å°‘å­˜åœ¨ä¸€åˆ—å°±èƒ½ return\nä½œæ³• 24: ä½¿ç”¨ Case è§£æ±ºå•é¡Œçš„æ™‚æ©Ÿ https://www.db-fiddle.com/f/knMFW8pMRiVa6yg22i59DB/0\nç´€éŒ„ä¸€ä¸‹ Case ä¸­ when å¯ä»¥ä½¿ç”¨ subqueryï¼Œé€™è®“å¯èƒ½æ€§å¢å¤§å¾ˆå¤šï¼Œä¾‹å¦‚æ¨™è¨˜å•†å“çš„ç†±éŠ·ç¨‹åº¦ï¼Œå¯ä»¥åœ¨ when ä¸­åŠ å…¥ subquery æŸ¥è©¢è²©è³£ç¸½æ•¸è€Œä¸ç”¨å…ˆ outer join å† select ä¸€æ¬¡\nä½œæ³• 25: è§£æ±ºå¤šæ¢ä»¶å•é¡Œçš„æŠ€å·§ ç•¶è³‡æ–™è¡¨éœ€è¦é—œè¯å¾Œå†ç”¨å¤šç¨®æ¢ä»¶ç¯©é¸ï¼Œè¦å°å¿ƒä¸‹æ¢ä»¶çš„ä½ç½®é¿å…ç¯©é¸éŒ¯èª¤ï¼Œä¾‹å¦‚ã€Œè¦æ‰¾å‡ºè²·é skateboard åˆåŒæ™‚è²·é helmet / knee pad çš„ç”¨æˆ¶ã€ï¼Œéœ€è¦ä½¿ç”¨å¤šæ¬¡ INNER JOIN æ‰èƒ½å¤ ç¯©é¸å‡ºåŒæ™‚æ»¿è¶³å¤šæ¢ä»¶çš„æŸ¥è©¢ï¼Œè¦å°å¿ƒä¸èƒ½ç›´æ¥ç”¨ IN æœƒè®Šæˆ \u0026ldquo;OR\u0026rdquo; çš„æ¢ä»¶\n1 2 3 4 5 6 7 -- é€™åªæœƒæ‰¾åˆ°æœ‰è²·éä»»ä¸€å•†å“çš„ç”¨æˆ¶ select users.id from users where users.id in ( select orders.user_id from orders inner join products on products.id = orders.product_id where products.name in (\u0026#39;skateboard\u0026#39;, \u0026#39;helmet\u0026#39;, \u0026#39;knee pad\u0026#39;) ); å¯ä»¥é©æ™‚ç”¨ function ç°¡åŒ–é‡è¤‡çš„ SQL https://www.db-fiddle.com/f/vpB9hZgNGhnFPZo2FQrLhn/0\nä½œæ³• 26: éœ€è¦å®Œå…¨ç¬¦åˆæ™‚ä½¿ç”¨é™¤æ³• https://www.db-fiddle.com/f/sA2VfuFSxW9Lr4krdcUg29/1 å‡è¨­æ˜¯ä¸€å€‹æ±‚è·ç¶²ç«™ï¼Œç”¨æˆ¶éœ€è¦æ‰¾ã€Œæ»¿è¶³ç‰¹å®šæŠ€èƒ½çµ„åˆçš„è·ç¼ºã€ï¼Œå°±éœ€è¦ç”¨åˆ°é™¤æ³•çš„æ¦‚å¿µï¼Œå¯ä»¥ç”¨å…©ç¨®æ–¹å¼\n1. é›™é‡å¦å®šï¼š å…ˆçœ‹æœ€å…§å±¤ - æ‰¾å‡ºç”¨æˆ¶æ‰€æœ‰çš„èˆ‡æ‰€éœ€æŠ€èƒ½æ¨¹ç›¸ç¬¦åˆçš„æŠ€èƒ½ï¼Œç¬¬ä¸€å€‹å¦å®šå¼æ˜¯æ‰¾å‡ºæ‰€éœ€æŠ€èƒ½æ¨¹ä¸­ç”¨æˆ¶æœ‰å“ªäº›ä¸è¶³çš„ (not exists)ï¼Œç¬¬äºŒå±¤å¦å®šå¼ ç”¨æˆ¶æ²’æœ‰ (æ‰€éœ€æŠ€èƒ½æ¨¹ä¸­ä¸å†(ç”¨æˆ¶æ‰€éœ€çš„æŠ€èƒ½æ¨¹))\n1 2 3 4 5 6 7 8 9 select * from users where not exists ( select * from prefered_skills where not exists ( select * from users as u2 inner join user_skills on user_skills.user_id = u2.id where u2.id = users.id and user_skills.skill_id = prefered_skills.skill_id ) ) é‚è¼¯ä¸Šæœ‰é»ç¹ï¼Œå‡è¨­æ‰€éœ€æŠ€èƒ½æ¨¹éœ€è¦ js / awsï¼Œè€Œ user åªæœƒ rails / awsï¼Œç¬¬ä¸€å±¤æœƒå…ˆç¯©é¸å‡º aws (rails ä¸å†æ‰€éœ€æŠ€èƒ½æ¨¹å…§)ï¼›ç¬¬äºŒæ­¥æœƒç¯©é¸å‡º js (å› ç‚ºç”¨æˆ¶æ²’æœ‰è©²æŠ€èƒ½)ï¼Œç¬¬ä¸‰æ­¥è¨ˆç®—å‡º (ç”¨æˆ¶æœ‰ç¼ºå°‘æ‰€éœ€æŠ€èƒ½æ¨¹) æ‰€ä»¥è¢«éæ¿¾æ‰ï¼›\nä¸éä»¥ä¸Šé™¤äº†é‚è¼¯æ¯”è¼ƒç¹ï¼Œé‚„æœ‰ä¸€å€‹ç¼ºé»æ˜¯ å¦‚æœæ‰€éœ€æŠ€èƒ½æ¨¹ç‚ºç©ºï¼Œå‰‡æœƒå›å‚³æ‰€æœ‰çš„è¡Œï¼Œå› ç‚ºç¬¬ä¸€å±¤å¦å®šæœƒæ˜¯ all true\n2. ä½¿ç”¨ group by èˆ‡ havingï¼š é€™å€‹æ–¹æ³•æ¯”æƒ³åƒä¸­ç°¡å–®ï¼Œé€é LEFT JOIN æ‰¾å‡º user ç›®å‰èˆ‡ prefered_skills æœ‰å¹¾å€‹é‡è¤‡æŠ€èƒ½ï¼Œæœ€å¾Œç›´æ¥æ¯” count æ˜¯å¦ç›¸åŒå°±çŸ¥é“\n1 2 3 4 5 6 select users.id, count(prefered_skills.skill_id) as prefered_skill_count from users inner join user_skills on user_skills.user_id = users.id left join prefered_skills on prefered_skills.skill_id = user_skills.skill_id group by users.id having (select count(*) from prefered_skills) = prefered_skill_count; ä½œæ³• 33: ä¸ç”¨ GROUP BY æ‰¾å‡ºæœ€å¤§æˆ–æœ€å°å€¼ https://www.db-fiddle.com/f/8TMwJykwSRc4Li4J9hbdyb/0 é€™å€‹æè­°å¾ˆæœ‰è¶£ä¹Ÿå¾ˆå¯¦ç”¨ï¼Œé€šå¸¸çœ‹åˆ° MIN/MAX å¾ˆç›´è¦ºå°±æ˜¯ç”¨ GROUP BY æ‰¾å‡ºï¼Œä½†æ˜¯ GROUP BY å¾Œåªæœƒä¿ç•™èšé›†çš„æ¬„ä½è€Œå…¶ä»–æ¬„ä½è³‡è¨Šéƒ½æœƒæ¶ˆå¤± (é™¤éç”¨ primary ç•¶ä½œ GROUP BY æ¢ä»¶ä½†é€šå¸¸ä¸æœƒé€™éº¼ç”¨)ï¼Œé€™é‚Šä½œè€…çµ¦å‡ºå¦ä¸€å€‹å¾ˆæ£’çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä½¿ç”¨ LEFT JOIN æ‰¾å‡ºæ¥µå€¼\nä¾‹å¦‚èªªä»Šå¤©æœ‰ä¸€å€‹é…’å–® [é¡åˆ¥, ç”¢åœ°åœ‹å®¶, é…’ç²¾æ¿ƒåº¦]ï¼Œæˆ‘å€‘å¸Œæœ›ã€Œæ‰¾å‡ºåŒä¸€é¡åˆ¥ä¸­æœ€çƒˆçš„é…’åŒæ™‚é¡¯ç¤ºç”¢åœ°åœ‹å®¶ã€ ç¬¬ä¸€ç¨®æ˜¯éŒ¯èª¤ç¤ºç¯„ï¼Œæœƒå‡ºç¾ER_WRONG_FIELD_WITH_GROUP çš„éŒ¯èª¤\n1 2 select max(alcohol), category, country from beers group by category; å¯ä»¥ç”¨ LEFT JOIN æ–¹å¼ï¼Œæ‰¾åˆ°åŒä¸€å€‹ç¨®é¡ä¸­æ¯”ç•¶å‰æ¬„ä½æ›´é«˜çš„é…’ç²¾æ¿ƒåº¦ï¼Œå¦‚æœæ‰¾ä¸åˆ° (where .. is null) ä»£è¡¨ç•¶å‰æ¬„ä½å°±æ˜¯æœ€çƒˆçš„å•¤é…’\n1 2 3 select * from beers left join beers as beers2 on beers.category = beers2.category and beers.alcohol \u0026lt; beers2.alcohol where beers2.category is null; Subquery vs JOINï¼š å¯ä»¥çœ‹åˆ° Subquery åœ¨å¾ˆå¤šæ™‚å€™å¯ä»¥èˆ‡ JOIN äº’ç›¸æ›¿æ›ï¼Œä¸è«–æ˜¯åœ¨ç¯©é¸æ‰€é—œè¯çš„è³‡æ–™è¡¨ã€è¨ˆç®—åŠ ç¸½ç­‰ï¼Œé‚£ç©¶ç«Ÿå…©è€…èª°æ¯”è¼ƒå¥½ï¼Ÿ ç¶²è·¯ä¸Šæ™®éèªª JOIN æ¯”è¼ƒå¥½ï¼Œå› ç‚º DBMS åŸ·è¡Œæ™‚æ¯”è¼ƒå®¹æ˜“å„ªåŒ–ï¼Œä¸” Subquery æ¯æ¬¡éƒ½æœƒåŸ·è¡Œï¼› ä½†åœ¨é€™æœ¬æ›¸ä¸­å»æ²’æœ‰æ˜è¬›ï¼Œæœ‰æ™‚å€™ Subquery æ¶‰åŠçš„æ¬„ä½å°‘ã€å¯ä»¥é€éç´¢å¼•åŠ é€Ÿæ™‚ (ex. åŸºæ–¼ç´¢å¼•çš„ COUNT) åè€Œæœ‰å¯èƒ½æœƒæ›´å¿«ï¼Œæœ€å¾Œçœ‹ä¾†é‚„æ˜¯è¦å¯¦éš›è·‘è·‘çœ‹ç”¨ EXPLAIN æ‰çŸ¥é“\nçª—å£å‡½å¼ æ—©æœŸ SQL æ²’æœ‰ç›¸é„°åˆ—çš„æ¦‚å¿µï¼Œåªèƒ½ç”¨ GROUP BY åšå½™æ•´ï¼Œè€Œçª—å£å‡½å¼æä¾›äº†ä»¥ç•¶å‰è¡Œè¨ˆç®—çš„é¡ä¼¼åŠ ç¸½æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨æŸæ¢ä»¶ä¸‹è©²è¡Œçš„åŠ ç¸½(SUM)ã€æ’è¡Œ (RANK)ã€å‰ä¸€ç­† (LEAD) ç­‰ï¼Œå¯ä»¥åšåˆ°ä»¥å¾€å¾ˆé›£å¯¦è¸çš„åŠŸèƒ½ä¾‹å¦‚åŒæœˆè·¨å¹´çš„ç‡Ÿæ”¶æˆé•·æ¯”ä¾‹\né€é partition by month è®“çª—å£ä¾ç…§ month åˆ†é¡ï¼ŒåŒæ™‚ç”¨ year ç•¶ä½œæ’åºï¼Œå– lag ä¹Ÿå°±æ˜¯å‰ä¸€ç­†çš„ revenue å°±å¯ä»¥å¾—åˆ°ã€Œå»å¹´åŒæœˆã€çš„è³‡æ–™\n1 2 3 select year, month, revenue - lag(revenue, 1) over (partition by month order by year asc) as increase from revenues; å¸¸ç”¨çš„é‚„æœ‰ ROW_NUMBER / ROW_NUMBER æ˜¯å–®ç´”çš„è¡Œæ•¸ï¼Œ RANK å‰‡æ˜¯æŒ‰ç…§é †åºæ’åï¼Œå…©è€…çš„æ¦‚å¿µå¾ˆæ¥è¿‘ï¼Œåªæœ‰åœ¨æœ‰é‡è¤‡æ•¸å€¼æ™‚ RANK æœƒå‡ºç¾ç›¸åŒçš„æ’åï¼›ä½†æ˜¯ç•¶ RANK ç›¸åŒæ’åå‡ºç¾å¾Œæœƒæ–·å±¤ï¼Œå¦‚æœå¸Œæœ›æ˜¯é€£çºŒæ’åå¯ä»¥ç”¨ DENSE_RANK\nå¦å¤–é‚„æœ‰ RANGEï¼Œå¯ä»¥å–å‰å¾Œä¸€å€‹ç¯„åœå€é–“åšå‹•æ…‹å½™æ•´\nç¸½çµ SQL å¯«èµ·ä¾†ä¹Ÿé —æœ‰æŒ‘æˆ°æ€§ï¼Œè¦æƒ³è¾¦æ³•å…¼é¡§ç°¡æ½”èˆ‡æ€§èƒ½éœ€è¦ä¸€å®šçš„æ™‚é–“å­¸ç¿’ï¼Œé‚„æœ‰ä¸€äº›é€²éšçš„è­°é¡Œå¦‚éšå±¤åŒ–é¡¯ç¤ºç­‰å°±å…ˆç•¥é\n","date":"2021-11-14T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-11-14-effective-sql%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/","title":"ã€ŠEffective SQLã€‹è®€å¾Œåˆ†äº«"},{"content":" å¤©ç“è³¼è²·é€£çµ\nä¸è«–æ˜¯å› ç‚ºéš¨è‘—ç”¢å“è®ŠåŒ–è€Œå°è‡´éå¾€çš„ç¨‹å¼è¨­è¨ˆä¸é©åˆï¼Œæˆ–æ˜¯å–®ç´”è¨­è¨ˆäººå“¡æ²’æœ‰éµå®ˆåŸºæœ¬è¨­è¨ˆåŸå‰‡è€Œå°è‡´çš„è¨­è¨ˆéŒ¯èª¤ï¼Œå¦‚æœæ²’æœ‰æŒçºŒçš„å›é¡§ä¸¦é‡æ§‹ï¼Œæœƒè®“æŠ€è¡“å‚µè¶Šç–Šè¶Šé«˜ï¼Œè€ŒæŠ€è¡“å‚µæœ€çµ‚é«”ç¾åœ¨è®Šæ›´æˆæœ¬ (cost of change)ï¼Œè¦åŠ æ–°åŠŸèƒ½è¶Šä¾†è¶Šé›£åŠ ã€æˆ–æ˜¯åŠ äº†è«åå…¶ä»–çš„åœ°æ–¹é–‹å§‹å£æ‰ï¼Œè®“ç”¢å“é–‹ç™¼è¶Šä¾†è¶Šè‰±é›£\nä½†æ˜¯è­˜åˆ¥ç¨‹å¼å£å‘³é“æœ‰æ™‚æ²’é€™éº¼ç›´è¦ºï¼Œè€Œã€Šè¨­è¨ˆé‡æ§‹ã€‹ç”¨å¾ˆæ¸…æ¥šçš„æ–¹å¼æ•´ç†ï¼Œå¾ç™¼ç”Ÿå£å‘³é“çš„æ½›åœ¨åŸå› ã€é€é Java SDK çš„éŒ¯èª¤è¨­è¨ˆã€æœ€å¾Œçµ¦å‡ºå¯¦éš›ç¯„ä¾‹ï¼Œä¸¦æŒ‡å‡ºé©åˆçš„é‡æ§‹æ–¹å¼ï¼›è€Œè¨­è¨ˆæ˜¯éœ€è¦å› åœ°åˆ¶å®œï¼Œæ‰€ä»¥æœ‰äº›å£å‘³é“æœ¬èº«æ˜¯åˆ»æ„çš„ï¼Œé€™æœ¬æ›¸ä¹Ÿé©ç•¶çš„èˆ‰å‡ºä¸€äº›åä¾‹ï¼Œè®“æ•´å€‹è«–è¿°æ›´åŠ çš„å®Œæ•´\næ•´æœ¬æ›¸åƒ… 248 é å¾ˆæ¨è–¦å…¥æ‰‹ï¼Œç¸½å…±æ•´ç† 25 å€‹å£å‘³é“ï¼Œæ­é… Design Pattern / Refactoring ç³»åˆ—çš„æ›¸å¯ä»¥ç›¸äº’ä½è­‰ ä»¥ä¸‹ç´€éŒ„ä¸€ä¸‹æˆ‘ç‰¹åˆ¥æœ‰æ„Ÿï¼Œä»¥åŠå¯¦éš›é‡åˆ°çš„ç¨‹å¼å£å‘³é“\næŠ½è±¡ æŠ½è±¡æ˜¯ç‚ºäº†ç²¾ç°¡å’Œæ³›åŒ–ä¾†ç°¡åŒ–å¯¦é«”ï¼Œå…·é«”çš„å¯¦ç¾æ‰‹æ³•æœ‰\næä¾›æ¸…æ™°çš„æ¦‚å¿µé‚Šç•Œèˆ‡å”¯ä¸€èº«ä»½ æ˜ å°„é ˜åŸŸå¯¦é«” ç¢ºä¿å…§èšæ€§èˆ‡å®Œæ•´æ€§ è³¦äºˆå–®ä¸€è€Œé‡è¦çš„è·è²¬ é¿å…é‡è¤‡ 3.1 ç¼ºå¤±æŠ½è±¡ å¾ˆå¤šæ™‚å€™æˆ‘å€‘æœƒç”¨åŸºæœ¬å‹åˆ¥ä¾†è¡¨é”ä¸€å€‹æ‡‰è©²è¢«æŠ½è±¡åŒ–çš„æ¦‚å¿µï¼Œä¾‹å¦‚æ›¸ç±ä¸­çš„ ISBNï¼ŒISBN åˆæœ‰ 10 ç¢¼ / 13 ç¢¼çš„å€åˆ¥ï¼Œæœ¬èº«æ•¸å­—çš„çµ„åˆåˆæœ‰å€‹åˆ¥çš„æ„ç¾©ï¼Œå¦‚æœæˆ‘å€‘åªç”¨åŸºæœ¬å‹åˆ¥ String å„²å­˜ï¼Œç•¶é‡åˆ°å•†æ¥­é‚è¼¯éœ€è¦æª¢æŸ¥ ISBN ç¢¼ã€é€é ISBN ç¢¼è§£è®€è³‡è¨Šæ™‚ï¼Œå°±æœƒè®“è™•ç†é‚è¼¯å››è™•é‡è¤‡\nè§£æ±ºæ–¹å¼æ˜¯å¢åŠ ä¸€å€‹ ISBN classï¼Œè®“åŸæœ¬çš„ Book å»å¼•ç”¨ ISBNï¼Œè®“æª¢æŸ¥èˆ‡è§£è®€çš„ method éš±è—åœ¨ ISBN class ä¸­\n3.2 å‘½ä»¤å¼æŠ½è±¡åŒ– ç‰©ä»¶å°å‘çš„è¨­è¨ˆåŸå‰‡æ˜¯è­˜åˆ¥çœŸå¯¦ä¸–ç•Œçš„äº‹å‹™ï¼Œä¸¦ç”¨æŠ½è±¡åŒ–è¡¨ç¤ºä»– (æ˜ å°„é ˜åŸŸå¯¦é«”)ï¼Œå…·é«”ä¾†èªªå°±æ˜¯æŠ½è±¡çš„ç‰©ä»¶æ‡‰è©²è¦è¡¨é”äº‹ç‰©çš„è¡Œç‚ºèˆ‡å…¶ç‹€æ…‹ï¼Œå¦‚æœæ˜¯ç¿’æ…£ç¨‹åºå‹æ€ç¶­è€Œéç‰©ä»¶å‹æ€ç¶­ï¼Œå®¹æ˜“ç”¢ç”Ÿè³‡æ–™èˆ‡è¡Œç‚ºè™•ç†åˆ†é–‹çš„å ´é¢ï¼Œå¦‚ Data class å„²å­˜æ‰€æœ‰çš„åƒæ•¸ï¼ŒDataHandler class è² è²¬æ¥æ”¶ Data class çš„åšåƒæ•¸ä¸¦å®šç¾©å¾ˆå¤š method\nä¿®æ”¹çš„æ–¹å¼æ˜¯æ‰¾åˆ°é©åˆçš„ç‰©ä»¶ï¼Œè®“è³‡æ–™èˆ‡è¡Œç‚ºéƒ½åˆ†é¡åˆ°æ‰€å±¬çš„ç‰©ä»¶ï¼Œç”¨ä¾†è¡¨é”ä¸€å€‹æ¸…æ™°ä¸”å®Œæ•´çš„æ¦‚å¿µï¼Œå¦‚æœæ˜¯åƒ Data / DataHandler æˆ–è¨±å¯ä»¥è€ƒæ…®åˆä½µä¸€èµ·\néå¾€åœ¨å¯« js æ™‚ Object Listeral çœŸçš„å¤ªæ–¹ä¾¿äº†ï¼Œå¾€å¾€ class éƒ½è®Šæˆå–®ç´”çš„ method è€Œæ²’æœ‰ç‹€æ…‹ï¼Œç›´æ¥åƒ object ç•¶ä½œåƒæ•¸åšé‹ç®—ï¼Œé€™è®“ç¨‹å¼ç¢¼çš„æŠ½è±¡åŒ–ä¸å®Œå…¨ï¼Œå°è‡´å¯ç†è§£æ€§ã€å¯é‡ç”¨æ€§ä½å¾ˆå¤š\nåä¾‹ï¼šè¨­è¨ˆæ¨¡å¼ä¸­æœ‰å¹¾ç¨®éƒ½æœ‰å‘½ä»¤å¼æŠ½è±¡åŒ–çš„å£å‘³é“ï¼Œä¾‹å¦‚\nç­–ç•¥æ¨¡å¼ï¼šæ¯å€‹ç­–ç•¥éƒ½æ˜¯ç¨ç«‹ç‰©ä»¶ï¼Œåœ¨å‹•æ…‹åŸ·è¡Œæ™‚ç•¶ä½œåƒæ•¸å‚³å…¥æ”¹è®Šè¡Œç‚º ç‹€æ…‹æ¨¡å¼ï¼šå°‡ç‰©ä»¶çš„ä¸åŒç‹€æ…‹å®£å‘Šæˆç‰©ä»¶ï¼Œåœ¨åŸ·è¡Œæ™‚åˆ‡æ›ä¸åŒç‹€æ…‹ï¼Œæ–¹ä¾¿è®“æ¯å€‹è¡Œç‚ºå¯ä»¥æœ‰å°æ‡‰çš„æ“ä½œ å‘½ä»¤æ¨¡å¼ï¼šå°‡æ¯å€‹å‘½ä»¤éƒ½å®£å‘Šæˆç‰©ä»¶ ä»¥ä¸Šçš„ç‰©ä»¶å®£å‘Šéƒ½æœ‰é»é•ååŸå…ˆçš„ç‰©ä»¶æŠ½è±¡åŒ–åŸå‰‡ï¼Œä½†ç‚ºäº†æé«˜å¯é‡ç”¨æ€§ã€å¯æ“´å±•æ€§ï¼Œé€™æ¨£æ˜¯å¯ä»¥æ¥å—çš„å–æ¨\nå°è£ éš±è—å¯¦ä½œç´°ç¯€ï¼Œå¯¦ä½œé—œæ³¨é»åˆ†é›¢èˆ‡è³‡è¨Šéš±è—\n4.4 æœªåˆ©ç”¨å°è£ ç•¶æˆ‘å€‘åœ¨ä¸€æ®µé‚è¼¯ä¸­é–‹å§‹ç”¨å¤§é‡çš„ if/else ã€switch æª¢æŸ¥å‹åˆ¥ä¸¦çµ¦äºˆä¸åŒæ“ä½œæ™‚ï¼Œå°±å¯èƒ½è½å…¥äº†æœªåˆ©ç”¨å°è£çš„å£å‘³é“ä¸­ï¼Œé€™æœƒæœ‰å¹¾å€‹å•é¡Œ\né¡¯å¼å‹åˆ¥æª¢æŸ¥è®“ç¨‹å¼ç¢¼èˆ‡å…·é«”å‹åˆ¥è€¦åˆï¼Œé™ä½å¯ç¶­è­·æ€§ï¼Œå¦‚æœæ–°å¢å‹åˆ¥å°±éœ€è¦æ”¹ç¨‹å¼ç¢¼ å¦‚æœå‘¼å«æ–¹æ¼æª¢æŸ¥å‹åˆ¥ï¼Œå¯èƒ½æœƒæœ‰ä¸é æœŸçš„è¡Œç‚ºå‡ºç¾ é€éå¤šå‹å¯ä»¥å¾ˆå¥½çš„è§£æ±ºå•é¡Œï¼Œå¤šå¼•å…¥ä¸€å€‹è¶…å‹åˆ¥ï¼Œæ¥è‘—å„å€‹é¡åˆ¥å¯¦ä½œç›¸åŒçš„ä»‹é¢å³å¯\næ¨¡çµ„åŒ– é€éé›†ä¸­å’Œåˆ†è§£å»ºç«‹é«˜å…§èšã€ä½è€¦åˆçš„æŠ½è±¡\n5.3 å¾ªç’°ä¾è³´å¼æ¨¡çµ„åŒ– å¦‚æœä¾è³´é—œä¿‚åœ–æœ‰ç’°å‡ºç¾ï¼Œä¹Ÿå°±æ˜¯è¶…å‹åˆ¥ä¾è³´æ–¼å­å‹åˆ¥ï¼Œé€™æœƒå°è‡´ä¿®æ”¹é¡åˆ¥æ™‚ä¸å°å¿ƒå½±éŸ¿åˆ°å…¶ä»–çš„é¡åˆ¥\nå‡ºç¾çš„åŸå› å¯èƒ½æ˜¯\nè·è²¬æ‹†åˆ†éŒ¯èª¤ æŠŠè‡ªå·±ç•¶ä½œåƒæ•¸å‚³é å¯¦ä½œ callback æ™‚ ä¾è³´å±¤ç´šå¤ªå¤šæ²’æœ‰æ³¨æ„åˆ° ä¾‹å¦‚èªªæœ‰ä¸€å€‹é›²ç«¯æ–‡ä»¶ç³»çµ±éœ€è¦æŠŠæ–‡ä»¶åŠ å¯†ï¼Œè€ŒåŠ å¯†éœ€è¦æ–‡ä»¶çš„å…§å®¹ï¼Œè®Šæˆ SourceDocument class è·Ÿ DESEncryption class ç›¸äº’ä¾è³´ è§£æ±ºè¾¦æ³•å¯ä»¥è®“ SourceDocument ä¾è³´æ–¼ IEncrytionï¼Œè€Œ DESEncryption å¯¦ä½œ IEncrytionï¼Œé€™æ¨£å°±æ²’æœ‰å¾ªç’°ä¾è³´ä»¥åŠ SourceDocument class è€¦åˆæ–¼ DESEncryption å¯¦ä½œçš„å•é¡Œ å±¤æ¬¡çµæ§‹ (heirarchy) é€éåˆ†é¡ã€åˆä½µã€æ›¿æ›å’Œæ’åºç­‰æ‰‹æ³•å±¤æ¬¡åŒ–æŠ½è±¡ï¼Œä¾‹å¦‚å‹•ç‰©å­¸åˆ†é¡\n6.7 å›é€†å‹ heirachy å­å‹åˆ¥å¯ä»¥å¾è¶…å‹åˆ¥ç¹¼æ‰¿è¡Œç‚ºï¼Œæˆ–æ˜¯è‡ªè¡Œè¤‡å¯«è¡Œç‚ºï¼Œä½†å¦‚æœå­å‹åˆ¥æœªç…§è¶…å‹åˆ¥ä»‹é¢å¯¦ä½œï¼Œæœƒç ´å£ is-a çš„ç¹¼æ‰¿é—œä¿‚ï¼Œé€²è€Œé•åé‡Œæ°æ›¿æ›åŸå‰‡ (LPS)ï¼Œé€™ç¨®é•èƒŒè¶…å‹åˆ¥çš„æ‰¿è«¾å°±æ˜¯å›é€†å‹å±¤æ¬¡çµæ§‹\nå¯èƒ½æ˜¯å› ç‚ºè¶…å‹åˆ¥æ¶µè“‹å¤ªå»£ï¼Œæˆ–æ˜¯å­å‹åˆ¥å–®ç´”æƒ³é‡ç”¨æŸäº›è¡Œç‚ºè€Œå¿…é ˆé•èƒŒå…¶é¤˜è¡Œç‚ºçš„è¨­è¨ˆ\nä¾‹å¦‚æœ‰ä¸€å€‹è¶…å‹åˆ¥æ˜¯ CallSiteï¼Œå…¶ä¸­ä¸€å€‹å­å‹åˆ¥ ConstantCallSite ç‚ºäº†æä¾›ä¸å¯è®Šçš„ç‰¹æ€§ï¼Œæ‰€ä»¥ç•¶å‘¼å« setTarget æ™‚æœƒæ‹‹å‡ºéŒ¯èª¤ è§£æ±ºæ–¹æ³•å¯ä»¥æŠŠå­å‹åˆ¥å…±ç”¨çš„è¡Œç‚ºå†å¤šæŠ½ä¸€å±¤è¶…å‹åˆ¥å‡ºä¾†ï¼Œå…±ç”¨ç›¸åŒçš„è¡Œç‚ºï¼Œå…¶é¤˜çš„å„è‡ªå‹åˆ¥è™•ç† ç¸½çµ å¾ä¹‹å‰å­¸ç¿’ SOLID åŸå‰‡ï¼Œåˆ°å¾åå‘ç”¨ç¨‹å¼ç¢¼è‡­å‘³ä¾†çœ‹ç‚ºä»€éº¼éœ€è¦ SOLID ç®—æ˜¯ä¸€å€‹è »æœ‰è¶£çš„å°ç…§ï¼Œå†æ­é… Refactoring è®“è‡ªå·±å°æ–¼æŠ½è±¡çš„ç‰©ä»¶å°å‘ã€ŒæŠ½è±¡ã€ã€ã€Œå°è£ã€ã€ã€Œç¹¼æ‰¿ã€æœ‰æ›´å¤šçš„äº†è§£èˆ‡åæ€\n","date":"2021-11-06T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-11-06-%E8%A8%AD%E8%A8%88%E9%87%8D%E6%A7%8B%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/","title":"ã€Šè¨­è¨ˆé‡æ§‹ã€‹è®€å¾Œåˆ†äº«"},{"content":"å…¬å¸ç›®å‰ä¸»è¦è³‡æ–™åº«æ˜¯ MySQLï¼Œç‚ºäº†è³‡æ–™åˆ†ææœ‰é–‹å•Ÿæ–°çš„ Read Replica é¿å…å½±éŸ¿åˆ°æ­£å¼ç’°å¢ƒï¼Œå› ç‚ºä¸€äº›åˆ†æå·¥å…· (Metabase) çš„é™åˆ¶ï¼Œæ‰€ä»¥èˆ‡åŒäº‹åœ¨æ€è€ƒ Read Replica å¦‚æœåªåŒæ­¥æŒ‡å®šçš„è³‡æ–™è¡¨ï¼ŒåŒæ™‚ä¿ç•™å¯«å…¥å…¶ä»–è³‡æ–™è¡¨çš„å½ˆæ€§è©²æœ‰å¤šå¥½ ?!ï¼ŒæŸ¥äº†ä¸€ä¸‹ RDS ç™¼ç¾é€™æ˜¯å¯ä»¥çš„ How can I perform write operations to my Amazon RDS for MariaDB or MySQL DB instance read replica?ï¼Œç•¶æ™‚è¦ºå¾—ååˆ†çš„è¡çªï¼Œç‚ºä»€éº¼ \u0026ldquo;Read\u0026rdquo; Replica å¯ä»¥ Writeï¼Œä¹Ÿå€Ÿæ­¤å›åˆ°æºé ­ç†è§£ MySQL Replication è¨­å®šèˆ‡æ©Ÿåˆ¶ï¼Œæ‰ç™¼ç¾é€™ä¸€åˆ‡éƒ½æ˜¯å¾ˆåˆä¹æƒ…ç†çš„\nä»¥ä¸‹éƒ½æ˜¯ä»¥ MySQL v5.7 ç‚ºä¸»\nMySQL Replication é–±è®€é Chapter 16 Replicationï¼Œç°¡å–®æ•´ç†å¹¾å€‹é‡é»\nSource DB / Replica DB éƒ½è¦æŒ‡å®š server_id Source DB å¿…é ˆé–‹å•Ÿ binlogï¼Œæœ‰ä¸‰ç¨®æ ¼å¼å¯ä»¥é¸ï¼Œå¾ŒçºŒè£œå…… Replica DB å¯ä»¥é€é replication_do_table æŒ‡å®šè³‡æ–™è¡¨åŒæ­¥ Replica DB å¯ä»¥æŒ‡å®šå¤šå€‹ Source DB GTIDs å»ºè­°é–‹å•Ÿï¼Œä¸»è¦æ˜¯å¹«åŠ© binlog çš„æ¯ä¸€å€‹æ“ä½œéƒ½æ‰“ä¸Š idï¼Œæ–¹ä¾¿ç¢ºèªåŒæ­¥é€²åº¦ï¼›ä¸é–‹å•Ÿå‰‡æ˜¯ç”¨ file åŒæ­¥ï¼Œéœ€è¦ç´€éŒ„åŒæ­¥çš„æª”æ¡ˆåç¨±èˆ‡ä½ç½®ï¼Œç›¸å°è¤‡é›œäº› binlog æœƒç´€éŒ„åœ¨ master ä¸Šçš„æ‰€æœ‰æ“ä½œï¼Œè€Œ replica å¾ˆå–®ç´”å°±æ˜¯æ‹¿åˆ° binlog æŠŠåŒæ¨£çš„æ“ä½œå¥—ç”¨åœ¨è‡ªå·±èº«ä¸Šï¼Œç”¨é€™å€‹è§’åº¦æ€è€ƒï¼Œå°±å¯ä»¥ç†è§£ç‚ºä»€éº¼ replica åŒæ™‚ä¿ç•™å¯«å…¥çš„åŠŸèƒ½å¾ˆæ­£å¸¸ï¼Œåªè¦ä¸å½±éŸ¿ master binlog ä¸Šçš„æ“ä½œå³å¯\nbinlog format 1. statement binlog ç›´æ¥ç´€éŒ„ master ä¸Š SQL èªå¥ï¼Œæ‰€ä»¥ binlog æœ¬èº«éå¸¸å®¹æ˜“é–±è®€ï¼Œåœ¨åšç³»çµ±æ“ä½œæª¢æŸ¥æ™‚ï¼Œä¹Ÿå¯ä»¥å¾ˆæ¸…æ¥šçœ‹åˆ°æ¯ä¸€å€‹ SQL æ“ä½œ (audit)ï¼Œå¥½è™•æ˜¯ç›¸å°è³‡æ–™é‡å°ã€å¥½é–±è®€ï¼›ç¼ºé»æ˜¯æœ‰äº› statement æ˜¯ undeterminsiticï¼Œä¹Ÿå°±æ˜¯åœ¨ replica ä¸Šé‡æ–°åŸ·è¡Œæœƒæœ‰ä¸åŒçš„çµæœï¼Œä¾‹å¦‚ UUID() / USER() ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œæœ‰è¶£çš„æ˜¯ RAND() / NOW() é€™äº›çœ‹èµ·ä¾†å°±æ˜¯æœƒæœ‰å•é¡Œçš„åè€Œä¸æœƒæœ‰å•é¡Œ\n2. row ä¸ç´€éŒ„æ¯ä¸€å€‹ SQLï¼Œè€Œæ˜¯æŠŠ SQL æœƒå½±éŸ¿åˆ°çš„æ¬„ä½ä»¥ Row çš„æ ¼å¼ç´€éŒ„ï¼Œä¾‹å¦‚ UPDATE æ›´æ–°äº† 10 ç­†æ¬„ä½å°±ç´€éŒ„ 10 ç­†ï¼Œå¥½è™•æ˜¯é‡æ–°åŸ·è¡Œä¿è­‰çµæœä¸€è‡´ / å£è™•æ˜¯è³‡æ–™é‡å¾ˆå¤§ã€æ ¼å¼ä¸æ˜“é–±è®€éœ€è¦å·¥å…· decodeã€æ²’è¾¦æ³•çœ‹åˆ°åŸå§‹çš„ SQL\n3. mixed çµåˆ statement / row çš„å„ªé»ï¼Œåªæœ‰é‡ä¸Š undeterministic çš„ statement æ‰æœƒç”¨ row ç´€éŒ„ï¼Œé€™ä¹Ÿæ˜¯ RDS é è¨­çš„æ ¼å¼\nå¯¦é©— å®Œæ•´å¯¦é©—å¯ä»¥åƒè€ƒæˆ‘çš„ Repo play-with-mysql-replicationï¼Œä¸»è¦é©—è­‰äº†\nä¸è¦åœ¨åŒæ­¥çš„è³‡æ–™åº«æ–°å¢è³‡æ–™ï¼Œå¦å‰‡æœƒçµ‚æ­¢åŒæ­¥ åœ¨éåŒæ­¥çš„è³‡æ–™åº«åšä»»åˆæ“ä½œéƒ½æ²’å•é¡Œ åœ¨åŒæ­¥çš„è³‡æ–™åº«ï¼Œå¢åŠ  Indexã€å¢åŠ æ–°çš„æ¬„ä½ã€UPDATE å·²ç¶“åŒæ­¥çš„è³‡æ–™éƒ½æ²’å•é¡Œ å¦‚æœæ˜¯ä¿®æ”¹åŒæ­¥çš„è³‡æ–™åº«æ¬„ä½æ ¼å¼ï¼Œä¾‹å¦‚ varchar(255) =\u0026gt; varchar(200)ï¼Œåœ¨ä¸è¶…éæ¬„ä½å°ºå¯¸ä¸‹ï¼Œstatement åŒæ­¥æ­£å¸¸ã€row ä¸èƒ½åŒæ­¥ RDS ä¸Šè¡Œç‚ºé¡ä¼¼ï¼Œå·®åˆ¥åœ¨é è¨­å°±ä¸èƒ½æœ‰ Multi Source çš„åŠŸèƒ½\nçµèª ä½¿ç”¨è¨—ç®¡æœå‹™å¦‚ RDS ä»£ç‚ºç®¡ç† MySQL è »æœ‰è¶£çš„ï¼Œå¤§å¹…é™ä½äº†ç®¡ç†çš„éº»ç…©ï¼Œä½†å¦‚æœæœ‰ä»€éº¼åŠŸèƒ½é¢çš„å•é¡Œï¼Œå›æ­¸å·¥å…·æœ¬èº«å»æ¢ç´¢åè€Œå¯ä»¥çœ‹å¾—æ›´å…¨é¢ï¼›\nä¸é RDS é‚„æœ‰è€Œå¤–è·Ÿ Aurora åšçµåˆï¼Œå¯ä»¥è£½ä½œ Aurora Read Replicaï¼Œä¸ç¢ºå®šæœ‰æ²’æœ‰åˆ¥çš„è¡Œç‚ºå·®ç•°ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†ä¾†ç ”ç©¶\n","date":"2021-10-10T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-10-10-mysql-replication-%E8%88%87-rds/","title":"MySQL Replication èˆ‡ RDS"},{"content":"ä¸€é–‹å§‹å­¸å¯«ç¨‹å¼ï¼Œå¾ˆç¿’æ…£ä¾ç…§åŸ·è¡Œé †åºï¼ŒæŠŠä½å±¤æ¬¡çš„ç‰©ä»¶å¯«æ­»åœ¨é«˜å±¤æ¬¡çš„ç‰©ä»¶ä¸­ï¼Œæ›´ç”šè€…ç›´æ¥è®€å–è³‡æ–™åº«æ²’æœ‰ä»»ä½•çš„æŠ½è±¡åŒ–ï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 class PaymentService { constructor() { this.orderCollection = mongoClient.collection(\u0026#39;order\u0026#39;); this.s3Service = new S3Service(); } async pay(orderId) { const order = this.orderCollection.find({ id: orderId }); ..... this.s3Service.uploadResult(....); } } å¯èƒ½æœƒè¦ºå¾—è³‡æ–™åº«ã€é›²ç«¯æœå‹™æœ¬èº«ä¸å¤ªæœƒæœ‰è®Šå‹•ï¼Œæ‰€ä»¥å¯«æ­»æ²’å·®ï¼Œä½†é™¤äº†æœå‹™è¢«ç¶æ­»å¤–ï¼Œå¦ä¸€å€‹é›£é¡Œæ˜¯å¯«æ¸¬è©¦ï¼Œæ²’è¾¦æ³•å°‡ç¬¬ä¸‰æ–¹æœå‹™ mock å¯«å‡ºä¹¾æ·¨çš„ unit testï¼Œæˆ–æ˜¯å¿…é ˆ mock æ•´å€‹ç¬¬ä¸‰æ–¹ module åœ¨å¯«æ¸¬è©¦å‰å°±å…ˆèŠ±äº†ä¸€å°æ™‚åœ¨ mocking éå¸¸æµªè²»æ™‚é–“\nç•¶æˆ‘å€‘æŠŠå¤–éƒ¨ç›¸ä¾æŠ½å‡ºä¾†ï¼Œé€éå»ºæ§‹å¼æ³¨å…¥ï¼Œå°±è§£æ±ºäº†ä»¥ä¸Šçš„å•é¡Œï¼Œä½†å¸¶ä¾†çš„æ–°å•é¡Œæ˜¯å‘¼å«æ–¹éœ€è¦èŠ±å¾ˆå¤šæ™‚é–“å…ˆå»ºæ§‹å‡ºéœ€è¦çš„æœå‹™ï¼Œä¾‹å¦‚\n1 2 3 4 5 function main() { const orderStorageService = new OrderStorageService(); const s3Service = new S3Service(); const paymentService = new PaymentService(orderStorageService, s3Service); } åœ¨æ¯ä¸€å€‹ä½¿ç”¨ paymentService çš„åœ°æ–¹ï¼Œéƒ½éœ€è¦æ‰‹å‹•å»ºç«‹ç›¸ä¾çš„æœå‹™ï¼Œå³ä½¿æœ‰ç”¨ Factory Pattern å†å¤šä¸€å±¤æŠ½è±¡åŒ–ï¼Œç®¡ç†èµ·ä¾†ä¹Ÿæ˜¯ååˆ†çš„éº»ç…©\næ­¤æ™‚å¯ä»¥ç”¨ InvertifyJS è§£æ±ºä¾è³´æ³¨å…¥çš„éº»ç…©\nåŸå§‹ç¢¼ sj82516/inversify-js-example\néœæ…‹ç›¸ä¾ InversifyJS æ¦‚å¿µå¤§æ¦‚æ˜¯\nåˆå§‹åŒ– Containerï¼Œå°‡å¯ä»¥è¢«æ³¨å…¥çš„ Class éƒ½æ‰“ä¸Šæ¨™è¨˜ï¼Œå¯ä»¥æŠŠ Container ç•¶ä½œæ˜¯ Namespace åœ¨è¦æ³¨å…¥çš„åœ°æ–¹ï¼Œé€éæ¨™è¨˜æ±ºå®šåˆå§‹åŒ–ä¸¦æ³¨å…¥ç›¸ä¾çš„ Class å¦‚æœè¦å‹•æ…‹å–å¾—ç‰©ä»¶ï¼Œå¯ä»¥å¾ Container æ‹¿å– è®“æˆ‘å€‘å…ˆçœ‹ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œå‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹ Payment Serviceï¼Œæœƒä¾è³´æ–¼ç¬¬ä¸‰æ–¹ä»˜æ¬¾å¹³å° PaymentGatewayService ä»¥åŠåŸºæœ¬çš„ LogService è’é›† log\néœæ…‹ç›¸ä¾æ˜¯åªèªª Payment Service åœ¨åˆå§‹åŒ–å°±æ±ºå®šç›¸ä¾çš„ç‰©ä»¶ï¼Œè€Œä¸æœƒå‹•æ…‹çš„æ±ºå®šï¼Œç¬¬ä¸€æ­¥å°‡ LogService æ¨™è¨˜ @injectableï¼Œéœ€æ³¨æ„è¦å…ˆå®šç¾© interfaceï¼Œæ¥è‘—æŠŠå¯¦ä½œè¨­å®šç‚º injectableï¼Œè®“æœå‹™ç›¸ä¾æ–¼æŠ½è±¡ä»‹é¢è€Œä¸æ˜¯å¯¦ä½œï¼Œç¬¦åˆ ISP - ä»‹é¢éš”é›¢åŸå‰‡ï¼Œä¾‹å¦‚èªª LogService å¯¦ä½œä¸Šå¯ä»¥æ˜¯å„²å­˜æ–¼æœ¬åœ°ç«¯æª”æ¡ˆã€ä¸Šå‚³åˆ° Slack ç­‰ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 export interface LogService { log(message: string): void; error(message: string): void; } export const LogServiceTypes = { slack: Symbol(\u0026#34;slack\u0026#34;), local: Symbol(\u0026#34;local\u0026#34;) } export type LogServiceTypeValueTypes = typeof LogServiceTypes[keyof typeof LogServiceTypes]; @injectable() export class LocalLogService implements LogService { static NORMAL_FILE = \u0026#39;./normal.log\u0026#39; static ERROR_FILE = \u0026#39;./error.log\u0026#39; async log(message: string) { await fs.appendFile(LocalLogService.NORMAL_FILE, message); } async error(message: string) { await fs.appendFile(LocalLogService.ERROR_FILE, message); } } @injectable() export class SlackLogService implements LogService { async log(message: string) { console.log(\u0026#34;send log to slack\u0026#34;, message) } async error(message: string) { console.log(\u0026#34;send error log to slack\u0026#34;, message) } } LogServiceTypes æ˜¯ç‚ºäº†è®“ä½¿ç”¨è€…åœ¨æŒ‡å®š logService æ™‚æœ‰å‹åˆ¥çš„æç¤º LogServiceTypeValueTypes ä¸»è¦æ˜¯ç‚ºäº†æŒ‡å‘ LogServiceTypes çš„ values type åœ¨ PaymentGatewayService åšé¡ä¼¼çš„äº‹æƒ…ï¼Œæ¥è‘—å®šç¾©æˆ‘å€‘ PaymentService\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @injectable() export class StaticPaymentService { constructor( @inject(\u0026#34;slackLog\u0026#34;) private logService: LogService, @inject(\u0026#34;stripePaymentGateway\u0026#34;) private paymentGatewayService: PaymentGatewayService ) { } pay(client: Client, order: Order): string|void { const totalFee = this.paymentGatewayService.totalFee(order) if (totalFee \u0026gt; client.balance) { return this.logService.error(`${client.name} doesn\u0026#39;t have enough money`); } this.logService.log(`${client.name} paid ${totalFee}`) return this.paymentGatewayService.generateLink(client, totalFee); } } é‡é»åœ¨ constructor ä¸­ä¸»å‹•å®£å‘Šäº†ç›¸ä¾çš„ç‰©ä»¶ï¼Œé€™é‚Šæˆ‘å€‘æŒ‡å®šè¦æ³¨å…¥ slackLogã€stripePaymentGateway\næœ€å¾Œæ˜¯å®šç¾©é€™äº›è³‡æºçš„åœ°æ–¹ invertify.config.ts\n1 2 3 4 5 6 const paymentServiceContainer = new Container(); paymentServiceContainer.bind\u0026lt;LogService\u0026gt;(\u0026#34;localLog\u0026#34;).to(LocalLogService); paymentServiceContainer.bind\u0026lt;LogService\u0026gt;(\u0026#34;slackLog\u0026#34;).to(SlackLogService); paymentServiceContainer.bind\u0026lt;StaticPaymentService\u0026gt;(\u0026#34;staticPaymentService\u0026#34;).to(StaticPaymentService); paymentServiceContainer.bind\u0026lt;StripePaymentGatewayService\u0026gt;(\u0026#34;stripePaymentGateway\u0026#34;).to(StripePaymentGatewayService); paymentServiceContainer.bind\u0026lt;PaypalPaymentGatewayService\u0026gt;(\u0026#34;paypalPaymentGateway\u0026#34;).to(PaypalPaymentGatewayService); æˆ‘å€‘å®šç¾©ä¸€å€‹ paymentServiceContainerï¼Œæ¥è‘—å°‡ç‰©ä»¶éƒ½è¨»å†Šåˆ° Container ä¹‹ä¸­ï¼Œæ–¹ä¾¿å¾ŒçºŒçš„èª¿ç”¨ï¼Œä¸Šä¸€æ­¥ inject() çš„åç¨± slackLog å°±æ˜¯åœ¨é€™é‚Šå®šç¾©ï¼Œå¯ä»¥è‡ªç”±æ›¿æ›ï¼Œåªè¦å–®å€‹ Container ä¸­ä¸é‡è¤‡å°±å¥½\næœ€å¾Œæ˜¯ PaymentService çš„åˆå§‹åŒ–èˆ‡èª¿ç”¨\n1 2 const staticPaymentService = paymentServiceContainer.get\u0026lt;StaticPaymentService\u0026gt;(\u0026#34;staticPaymentService\u0026#34;); staticPaymentService.pay(client, order); é€™æ¨£å°±å®Œæˆäº† å°çµ é€éä»¥ä¸Šçš„æ¡ˆä¾‹ï¼Œå¯ä»¥ç™¼ç¾ InvertifyJS åšçš„äº‹æƒ…ä¹Ÿä¸è¤‡é›œï¼Œè®“é–‹ç™¼è€…é¡¯å¼çš„è¨»å†Šå°æ‡‰çš„ç‰©ä»¶èˆ‡å…¶ä»‹é¢ï¼Œæ¥è‘—åœ¨éœ€è¦æ³¨å…¥çš„åœ°æ–¹ç›´æ¥ç”¨è¨»å†Šåç¨±å‘¼å«ï¼Œå¦‚æœéœ€è¦å‹•æ…‹åˆå§‹åŒ–ç‰©ä»¶èˆ‡å…¶ç›¸ä¾çš„æœå‹™ä½¿ç”¨ container.get(\u0026quot;name\u0026quot;) å³å¯\nè®“å‘¼å«ç«¯è¦åšçš„å·¥ä½œå°‘äº†éå¸¸å¤š\nå‹•æ…‹ç›¸ä¾ å¦‚æœæˆ‘å€‘å¸Œæœ›å‹•æ…‹ä¸€äº›ï¼Œåœ¨åˆå§‹åŒ–æ™‚æ‰æ±ºå®šè¦é¸æ“‡ï¼Œå¯ä»¥æ¡ç”¨å·¥å» æ¨¡å¼\n1 2 3 4 5 6 7 8 9 10 11 export class DynamicPaymentService { constructor( private logService: LogService, private paymentGatewayService: PaymentGatewayService ) { } pay(client: Client, order: Order): string|void { .... } } æˆ‘å€‘ä¸ç”¨åœ¨å®£å‘Šçš„åœ°æ–¹åŠ ä¸Š Injectableï¼Œè€Œæ˜¯é€é Container å»ºç«‹ Factor\n1 2 3 4 5 6 7 8 9 10 11 12 paymentServiceContainer.bind\u0026lt;PaymentGatewayService\u0026gt;(\u0026#34;PaymentGatewayService\u0026#34;).to(StripePaymentGatewayService).whenTargetNamed(\u0026#34;stripe\u0026#34;) paymentServiceContainer.bind\u0026lt;PaymentGatewayService\u0026gt;(\u0026#34;PaymentGatewayService\u0026#34;).to(PaypalPaymentGatewayService).whenTargetNamed(\u0026#34;paypal\u0026#34;) type PaymentServiceFatory = (logType: LogServiceTypeValueTypes, paymentPlatform: string) =\u0026gt; DynamicPaymentService; paymentServiceContainer.bind\u0026lt;PaymentServiceFatory\u0026gt;(\u0026#34;DynamicPaymentService\u0026#34;).toFactory\u0026lt;DynamicPaymentService\u0026gt;((context: interfaces.Context) =\u0026gt; { return (logType: string, paymentPlatform: string) =\u0026gt; { let paymentGatewayService = context.container.getNamed\u0026lt;PaymentGatewayService\u0026gt;(\u0026#34;PaymentGatewayService\u0026#34;, paymentPlatform); let logService = context.container.get\u0026lt;LogService\u0026gt;(logType); return new DynamicPaymentService(logService, paymentGatewayService); }; }); çœ‹èµ·ä¾†æœ‰é»åš‡äººï¼Œåˆ†æˆå¹¾æ®µ\n\u0026lt;(logType: symbol, paymentPlatform: string) =\u0026gt; DynamicPaymentService\u0026gt; bind è£é¢æ”¾çš„æ˜¯å›å‚³çš„å‹åˆ¥ï¼Œæˆ‘å€‘çš„ Factor æ˜¯æœ‰å…©å€‹åƒæ•¸ logType / paymentPlatform ä¸¦ä¸”å›å‚³ DynamicPaymentService çš„å‡½å¼ (\u0026quot;DynamicPaymentService\u0026quot;) åœ¨ Container ä»–å°æ‡‰çš„åç¨±æ˜¯ \u0026ldquo;DynamicPaymentService\u0026rdquo;ï¼Œå¯ä»¥ç”¨ Stringï¼Œæ›´è¬¹æ…å¯ä»¥ç”¨ Symbol .toFactory\u0026lt;DynamicPaymentService\u0026gt; å®šç¾© Factory å›å‚³ DynamicPaymentService å‹åˆ¥çš„ç‰©ä»¶ (context: interfaces.Context) =\u0026gt; {} é€éç•¶å‰ä¸Šä¸‹æ–‡å–å¾—ç›¸é—œè³‡è¨Šï¼Œä¸¦è¿”å›å¯¦éš› Factory å‡½å¼çš„å¯¦ä½œ ç‚ºäº†æ›´æ–¹ä¾¿å–å¾—å°æ‡‰çš„æœå‹™ï¼Œå¯ä»¥åŠ ä¸Š whenTargetNamed ç›´æ¥æŒ‡å®šåç¨± æœ€å¾Œä½¿ç”¨\n1 2 3 const factory = paymentServiceContainer.get\u0026lt;PaymentServiceFatory\u0026gt;(\u0026#34;DynamicPaymentService\u0026#34;); const paymentService = factory(LogServiceTypes.slack, \u0026#34;paypal\u0026#34;); paymentService.pay(client, order); çµèª Inversify é‚„æœ‰å…¶ä»–æœ‰è¶£çš„åŠŸèƒ½ï¼ŒåŒ…å«ä½¿ç”¨ tag / å®šç¾© middleware ç­‰ç­‰ï¼Œæ•´é«”çœ‹èµ·ä¾†æ˜¯å€‹æ“´å……æ€§éå¸¸è‰¯å¥½çš„è¨­è¨ˆï¼Œæœ‰æ©Ÿæœƒå†ä¾†ç ”ç©¶å…§éƒ¨çš„å¯¦ä½œ\n","date":"2021-09-05T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-09-05-%E4%BD%BF%E7%94%A8-inversifyjs-%E9%81%94%E5%88%B0-iversion-of-control-%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%89/","title":"ä½¿ç”¨ InversifyJS é”åˆ° Iversion of Control æ§åˆ¶åè½‰"},{"content":"é–‹ç™¼ä¸Šç‚ºäº†æ–¹ä¾¿ï¼Œå¸¸å¸¸ä½¿ç”¨åˆ¥äººé–‹ç™¼å¥½çš„å¥—ä»¶ï¼Œä½†æ˜¯æœ€è¿‘é‡åˆ°å¹¾æ¬¡è¡çªï¼Œç™¼ç¾å¥—ä»¶çš„ç‰ˆæœ¬ç®¡ç†æ²’æœ‰æƒ³åƒä¸­ç°¡å–®ï¼Œä»¥ä¸‹å°‡é‡æ¸… npm / gem+bundler åœ¨å¥—ä»¶çš„\nå®‰è£ è¼‰å…¥æ–¹å¼ å­å¥—ä»¶çš„ç‰ˆæœ¬è¡çª åšæ›´æ·±å…¥çš„äº†è§£èˆ‡æ¯”å° å¯¦é©—æ–¹å¼æœƒæº–å‚™ test_module_1 / test_module_2ï¼Œåˆ†åˆ¥ä½¿ç”¨ depend_module version 1 / version 2ï¼Œæœ€å¾ŒåŒæ™‚ä½¿ç”¨ test_module_1 \u0026amp; 2\n1 2 3 4 - test_module_1 |- depend_module@1.0.0 - test_module_2 |- depend_module@2.0.0 TLDRï¼›NPM å¯ä»¥åœ¨ä¸åŒæ¨¡çµ„å¼•ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼›è€Œ Gem ä¸è¡Œï¼›Golang å¯ä»¥é€é replace æŒ‡å®šå¤šå€‹ç‰ˆæœ¬\nNPM NPM install ç¯€éŒ„ NPM 7.x npm-install å®˜æ–¹æ–‡ä»¶éƒ¨åˆ†å…§å®¹\n$npm install ä¸»è¦æ˜¯å”åŠ©å®‰è£ package æ‰€ç›¸ä¾çš„ packagesï¼Œæ‰€è¬‚çš„ package æ˜¯\nè³‡æ–™å¤¾ä¸­æœ‰ package.json gzip å£“ç¸®çš„ tar æª” (1)ï¼Œä¹Ÿå°±æ˜¯æŠŠæœ‰ package.json çš„è³‡æ–™å¤¾å£“ç¸® æŒ‡å‘ (2) çš„ urlï¼Œä¾‹å¦‚ $npm install https://github.com/indexzero/forever/tarball/v0.5.6 æŒ‡å‘ (1) çš„ git remote url è¢«ç™¼ä½ˆåˆ° registry çš„ (3)ï¼Œä¾‹å¦‚ npm install git+ssh://git@github.com:npm/cli#semver:^5.0 ç­‰ åœ¨ package è·¯å¾‘ä¸‹åŸ·è¡Œ $npm installï¼Œå‰‡æœƒå®‰è£ packages åœ¨ node_modules ä¸­ï¼›-g æœƒå®‰è£åˆ° global ç’°å¢ƒä¸‹ï¼›--production å‰‡ä¸æœƒå®‰è£ devDependencies ä¸‹çš„ package\nå¦‚æœè¦å®‰è£åŒä¸€å€‹ package ä¸åŒç‰ˆæœ¬ä¸¦åŒæ™‚ä½¿ç”¨ï¼Œåœ¨ npm 6.9.0 ä»¥å¾Œå¯ä»¥ç”¨ alias\n1 2 npm install jquery2@npm:jquery@2 npm install jquery3@npm:jquery@3 è¼‰å…¥ Nodejs require ç¯€éŒ„è‡ª Nodejs v16.4.2 Modules: CommonJS modulesï¼Œé€™é‚Šå…ˆæ¢è¨ Commonjs Module è€Œä¸æ˜¯ ESM\nåœ¨ Nodejs ä¸­ï¼Œæ¯ä¸€å€‹ file å°±æ˜¯ä¸€å€‹ç¨ç«‹çš„ moduleï¼Œå¯ä»¥é€é require ä¾†å¼•å…¥ï¼Œç•¶ require(X) åœ¨ Path Y ä¸‹ç™¼ç”Ÿæ™‚ï¼Œæœƒå˜—è©¦ä»¥ä¸‹æ­¥é©Ÿ\nå¦‚æœ X æ˜¯ core moduleï¼Œå‰‡è¿”å› core module ä¸¦çµæŸ å¦‚æœ X æ˜¯ / é–‹é ­ï¼Œå‰‡å°‡ Y è¨­å®šç‚º filesystem root (æ²’ç”¨é) å¦‚æœ X æ˜¯ ./ã€ ../ ã€ / é–‹é ­ï¼Œå‰‡å˜—è©¦è¼‰å…¥å°æ‡‰è·¯å¾‘çš„æª”æ¡ˆæˆ–è³‡æ–™å¤¾ å¦‚æœ X æ˜¯ # é–‹é ­ï¼Œå‰‡å¾€ä¸Šå±¤æ‰¾åˆ°æœ€è¿‘æœ‰ package.json çš„åœ°æ–¹ (ç¨±ç‚º scope)ï¼Œä¸¦èµ° ESM è¼‰å…¥æ–¹å¼ æ‰¾åˆ° scopeï¼Œæ¯”å° package.json ä¸­å®šç¾©ï¼Œçœ‹æ˜¯ä¸æ˜¯è¦è¼‰å…¥è‡ªå·± ä¸æ–·åœ°å¾€ä¸Šä¸€å±¤è·¯å¾‘æ‰¾åˆ° node_modulesï¼Œä¸¦æŸ¥è©¢æœ‰æ²’æœ‰å°æ‡‰çš„ package å¯¦éš›è¼‰å…¥çš„éç¨‹æŒºè¤‡é›œçš„ï¼Œåªè¦è¼‰å…¥ä¸€æ¬¡å¾Œ package å°±æœƒè¢« cache èµ·ä¾†ï¼Œå¯ä»¥å¾ require.cache ä¸­çœ‹åˆ°è¢« cache çš„ç‹€æ³ï¼Œæ‰€ä»¥å¦‚æœä¸€å€‹å¥—ä»¶è¢«å¤šå€‹å¥—ä»¶å¼•ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½å› ç‚º cache è€Œå°è‡´æŸäº›å¥—ä»¶ä½¿ç”¨éŒ¯èª¤çš„ç‰ˆæœ¬å—ï¼Ÿ çœ‹èµ·ä¾†æ˜¯ä¸æœƒçš„ï¼Œå› ç‚ºæ–‡ä»¶æåˆ° module cache æ˜¯åŸºæ–¼ä»–å€‘è¢«è§£æçš„ filenameï¼Œå› æ­¤ä¸åŒç‰ˆæœ¬çš„ package æœƒå®‰è£åœ¨ä¸åŒçš„ node_modules ä¸‹ï¼Œæ‰€ä»¥è§£æçš„ filename è‡ªç„¶ä¹Ÿä¸åŒ\nModules are cached based on their resolved filename. Since modules may resolve to a different filename based on the location of the calling module (loading from node_modules folders), it is not a guarantee that require(\u0026lsquo;foo\u0026rsquo;) will always return the exact same object, if it would resolve to different files.\nç‰ˆæœ¬å¯¦é©— æœ¬åœ°ç«¯ä½¿ç”¨ Nodejs@14.15.4 / NPM@6.14.0ï¼Œæˆ‘ç™¼ä½ˆäº†\ndepend_module 1.0.0 / 2.0.0 yuan_test_module_1 require depend_module@1 yuan_test_module_2 require depend_module@2\næœ€å¾Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 require(\u0026#39;yuan_test_module_1\u0026#39;) require(\u0026#39;yuan_test_module_2\u0026#39;) console.log(\u0026#34;require tow modules\u0026#34;) console.log(require.cache) ----- è¼¸å‡º depend_module version 1 test_module_1 depend_module version 2 test_module_2 require tow modules [ \u0026#39;/Users/zhengyuanjie/Desktop/package/test/index.js\u0026#39;, \u0026#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/yuan_test_module_1/index.js\u0026#39;, \u0026#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/depend_module/index.js\u0026#39;, \u0026#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/yuan_test_module_2/index.js\u0026#39;, \u0026#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/yuan_test_module_2/node_modules/depend_module/index.js\u0026#39; ] å‡ºä¹æˆ‘æ„æ–™ä¹‹å¤–ï¼Œnode_modules çš„çµæ§‹æ˜¯\n1 2 3 4 5 6 |- node_modules |- depend_module (version 1) |- yuan_test_module_1 |- yuan_test_module_2 |- node_modules |- depend_module (version 2) æˆ‘æ²’æœ‰é æœŸç¬¬ä¸€å±¤çµæ§‹ä¸­æœƒæœ‰ depend_moduleï¼Œä»¥ç‚ºéƒ½æœƒæ˜¯åœ¨å€‹åˆ¥çš„ test_module ä¸‹ï¼Œå†å›ä¾†çœ‹ npm æ–‡ä»¶èªªæ˜\npackage{dep} structure: A{B,C}, B{C}, C{D}ï¼Œæ²’æœ‰ç‰ˆæœ¬è¡çªï¼Œå‰‡é è¨­éƒ½å®‰è£åœ¨æœ€ä¸Šå±¤ 1 2 3 4 A +-- B +-- C +-- D A{B,C}, B{C,D@1}, C{D@2}ï¼ŒD@1 å®‰è£åœ¨æœ€ä¸Šå±¤ï¼ŒD@2 å‰‡å®‰è£åœ¨ C ä¸‹é¢ 1 2 3 4 5 A +-- B +-- C `-- D@2 +-- D@1 é€™æ¨£å¯ä»¥åšåˆ°é è¨­å…±äº«ç›¸åŒç‰ˆæœ¬çš„ module é¿å…é‡è¤‡ä¸‹è¼‰ï¼Œå»ä¹Ÿä¸ç”¨æ“”å¿ƒå¤šå€‹ç‰ˆæœ¬è¡çªçš„å•é¡Œ\nç’°ç‹€ç›¸ä¾ å¦‚æœ package A require package B è€Œ package B åˆ require package Aï¼Œè®Šæˆç’°ç‹€ç›¸ä¾çš„æƒ…æ³ï¼Œåœ¨ Nodejs ä¸­é€™æ¨£ä¸æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œåªæ˜¯è¡Œç‚ºå¯èƒ½ä¸å¦‚é æœŸ\nå®˜ç¶²çš„æ¡ˆä¾‹ä¸­\nmain.js require a.js / b.jsï¼Œå› ç‚º a.js å…ˆè¢« require å‰‡å…ˆè¢«è¼‰å…¥ åœ¨ a.js ä¸­ï¼ŒåŸ·è¡Œåˆ° require b.jsï¼Œå‰‡é–‹å§‹è¼‰å…¥ b.js åœ¨ b.js ä¸­ï¼ŒåŸ·è¡Œåˆ° require a.jsï¼Œå‰‡ç‚ºäº†é¿å…ç„¡é™è¿´åœˆï¼Œæ­¤æ™‚æœƒå›å‚³æ­¥é©Ÿ(2)è¼‰å…¥åˆ°ä¸€åŠçš„ a.jsï¼Œæ¥è‘—ç¹¼çºŒå®Œæˆ b.js è¼‰å…¥ å›åˆ° a.jsï¼Œæ­¤æ™‚çš„ b.js å¼•ç”¨æ˜¯å®Œæ•´çš„ï¼Œç¹¼çºŒè¼‰å…¥ a.js å›åˆ° main.js ä¸­ï¼Œæ­¤æ™‚åœ¨ main.js ä¸­ a.js / b.js éƒ½æ˜¯å®Œæ•´çš„å¼•ç”¨ 1 2 3 4 5 6 7 8 9 $ node main.js main starting a starting b starting in b, a.done = false b done in a, b.done = true a done in main, a.done = true, b.done = true Gem / Bundler æ¥è‘—ä¾†çœ‹ Ruby ç”Ÿæ…‹å¦‚ä½•ç”¨ Gem Bundler ç®¡ç†å¥—ä»¶ï¼Œä»¥ä¸‹å…§å®¹ä¸»è¦åƒè€ƒ Understanding How Rbenv, RubyGems And Bundler Work Togetherï¼Œé¦–å…ˆå…ˆå®‰è£ rbenvï¼Œç”¨æ–¼ç®¡ç†ä¸»æ©Ÿä¸Šå¤šå€‹ Ruby ç‰ˆæœ¬\nRubyGem åœ¨ Ruby 1.9 å¾Œå°±æ•´åˆäº†ï¼Œgem å®‰è£è·¯å¾‘å¯ä»¥é€é $gem env ä¸­çš„ \u0026ldquo;INSTALLATION DIRECTORY\u0026rdquo; è·¯å¾‘ï¼Œä¸åŒç‰ˆæœ¬æœ‰è¢«åˆ†é–‹ä¸åŒçš„è·¯å¾‘å®‰è£ï¼Œä½†ä¸åƒ npm æœƒåœ¨æ¯å€‹å°ˆæ¡ˆä¸‹éƒ½æœ‰ç¨ç«‹çš„ node_modules\nè¼‰å…¥ æœ‰ä¸‰ç¨®æ–¹å¼\nload:\né¡ä¼¼æ–¼ requireï¼Œä½†æœƒé‡è¤‡è¼‰å…¥ require:\nåˆ° $LOAD_PATH ä¸‹æª¢æŸ¥æ˜¯å¦æœ‰è¼‰å…¥å°æ‡‰çš„ gemï¼Œæ²’æœ‰å‰‡å»ç³»çµ±å®‰è£è·¯å¾‘è¼‰å…¥ gem ä¸‹çš„ libï¼Œä¸¦åŠ åˆ° $LOAD_PATH ä¸­ï¼Œè©³è¦‹é¾å“¥çš„ Ruby èªæ³•æ”¾å¤§é¡ä¹‹ã€Œä½ çŸ¥é“ require å¹«ä½ åšäº†ä»€éº¼äº‹å—?ã€ require_relative:\næ¥å—ç›¸å°è·¯å¾‘è¼‰å…¥ æ‰€ä»¥ RubyGem ç®¡ç†ç›¸ç•¶å–®ç´”ï¼ŒæŠŠ Gem éƒ½å®‰è£åœ¨çµ±ä¸€çš„å®‰è£è·¯å¾‘ä¸‹\nBundler Bundler è² è²¬å¹¾é …å·¥ä½œ\nè®€å– Gemfile ä¸¦å®‰è£å°æ‡‰é©åˆçš„ç‰ˆæœ¬ ç”¢ç”Ÿ Gemfile.lock ç¢ºä¿åœ¨ä¸åŒç’°å¢ƒä¸‹é‚„åŸæ™‚ç‰ˆæœ¬ä¸€è‡´ å› ç‚ºä¸èƒ½è¼‰å…¥å¤šç‰ˆæœ¬ï¼Œæ‰€ä»¥ Bundler æœƒåœ¨æ‰€æœ‰ç‰ˆè™Ÿä¸­æ‰¾åˆ°é©åˆçš„ï¼Œä¾‹å¦‚ module_a éœ€è¦ module_c \u0026gt; 1.0.0ï¼Œè€Œ module_b éœ€è¦ module_c \u0026lt;=1.1.0ï¼Œå‰‡æœ€å¾Œæœƒå®‰è£ module_c@1.1.0 ç¬¦åˆå…©è€…éœ€æ±‚ å¯¦é©— å¯¦é©—æ–¹å¼ç›¸åŒï¼Œä½†æ˜¯ç™¼ç¾ Ruby ä¸èƒ½è¼‰å…¥å¤šå€‹ç‰ˆæœ¬ï¼Œæœƒå‡ºç¾\n1 `raise_if_conflicts\u0026#39;: Unable to activate yuan_test_gem_2-2.0.0, because depend_gem-1.0.0 conflicts with depend_gem (= 2.0.0) (Gem::ConflictError) ä½¿ç”¨ Bundler æœƒå› ç‚ºæ‰¾ä¸åˆ°é©åˆç‰ˆæœ¬è€Œæ‹‹éŒ¯\n1 2 There was an error parsing `Gemfile`: You cannot specify the same gem twice with different version requirements. You specified: depend_gem (~\u0026gt; 1.0) and depend_gem (~\u0026gt; 2.0). Bundler cannot continue. Golang mod åƒè€ƒUsing Different Versions of a Package in an Application via Go Modulesï¼ŒGolang å¯ä»¥åœ¨ mod file ä¸­æŒ‡å®š replaceï¼Œå°±å¯ä»¥åœ¨ç¨‹å¼ä¸­ä½¿ç”¨å¤šå€‹ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘è‡ªå·±çš„ forkï¼Œç›¸ç•¶çš„æ–¹ä¾¿ï¼Œå®˜æ–¹æ–‡ä»¶ï¼šRequiring external module code from your own repository fork\nçµèª æ¯”å°ä¸åŒçš„å¯¦ä½œè »æœ‰è¶£ï¼Œç›®å‰çœ‹ä¾† npm æœƒ install åœ¨ç•¶ä¸‹è·¯å¾‘ï¼Œæ›ä¾†å¥½è™•æ˜¯å¯ä»¥è¼‰å…¥å¤šå€‹ç‰ˆæœ¬çš„ç›¸åŒæ¨¡çµ„ï¼›è€Œ gem æ²’æœ‰é€™æ¨£çš„å½ˆæ€§ è‡³æ–¼è¼‰å…¥å¤šç‰ˆæœ¬çš„ç›¸åŒæ¨¡çµ„æˆ‘è¦ºå¾—æ˜¯è »ç¾ä»£çš„éœ€æ±‚ï¼Œä¸ç¢ºå®šç‚ºä»€éº¼ Ruby / Gem æ²’æœ‰æä¾›é€™æ¨£çš„ç‰¹æ€§ï¼ŒèƒŒå¾Œçš„è„ˆçµ¡ä¸çŸ¥æ˜¯å¦‚ä½•è€ƒé‡\n","date":"2021-07-10T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-07-10-nodejs-/-ruby-/-golang-%E5%A5%97%E4%BB%B6%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%AE%E7%95%B0%E6%AF%94%E5%B0%8D-npm-%E8%88%87-bundler/","title":"Nodejs / Ruby / Golang å¥—ä»¶ç‰ˆæœ¬ç®¡ç†å·®ç•°ï¼šæ¯”å° NPM èˆ‡ Bundler"},{"content":"å…¬å¸ä½¿ç”¨ MySQLï¼Œè¿‘æ—¥é‡åˆ°ä¸€äº›è®€å–çš„ç“¶é ¸ï¼Œæœ‰äº†ä½¿ç”¨ AWS Aurora çš„è¨è«–ï¼Œå‰›å¥½ä¸Šä¸€é€±çœ‹åˆ° Exploring performance differences between Amazon Aurora and vanilla MySQL æ‰èµ«ç„¶ç™¼ç¾ AWS Aurora åº•å±¤å„²å­˜æ¶æ§‹æœƒå½±éŸ¿ä½¿ç”¨å ´æ™¯ï¼Œè·Ÿé æœŸçš„è‡ªé§• MySQL æ­é… Replica æœ‰ä¸åŒçš„æ•ˆæœ\nä»¥ä¸‹é€™ç¯‡å°‡æ¢è¨\nMySQL å„²å­˜çš„åŸºæœ¬åŸç† Aurora çš„å„²å­˜æ¶æ§‹ è³‡æ–™æºè‡ªæ–¼\nExploring performance differences between Amazon Aurora and vanilla MySQL Amazon Aurora: Design Considerations for High Throughput Cloud-native Relational Databases MySQL å„²å­˜çš„åŸºæœ¬åŸç† é—œè¯å¼è³‡æ–™åº«æœ€åŸºæœ¬è¦ä¿éšœ ACIDï¼Œå…¶ä¸­ Durability æ˜¯æœ€åŸºæœ¬çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¿è­‰å¯«å…¥æˆåŠŸçš„è³‡æ–™ä¸æœƒå› ç‚ºç³»çµ± crash ç­‰å•é¡Œè€Œéºå¤±ï¼Œåœ¨ MySQL å¯«å…¥çš„æµç¨‹å¤§æ¦‚æ˜¯\nå°‡æ›´æ–°å¯«å…¥ Redo Log buffer (WAL)ï¼Œç­‰å¾… commit ç¢ºå®šå°±åˆ·æ–°åˆ°ç¡¬ç¢Ÿä¿å­˜ç´€éŒ„é¿å…éºå¤±è³‡æ–™ å¦‚æœè³‡æ–™æœ‰è¢«è®€å–åˆ° memory ä¸­ï¼Œå‰‡æ›´æ–° Page å…§å®¹ä¸¦æ¨™è¨˜ç‚º dirty èƒŒæ™¯é‹è¡Œçš„ç¨‹åºåœ¨ checkpoint æ™‚æ©Ÿè§¸ç™¼æ™‚å°‡ dirty page èˆ‡ redo log çš„å…§å®¹æ›´æ–°æ–¼ç¡¬ç¢Ÿä¸Šçš„ data file å…¶ä¸­æœ‰å¹¾å€‹ç›®çš„\næ¸›å°‘ disk I/O ä¸¦ä¿éšœé€£çºŒæ€§å¯«å…¥ï¼š\nå¦‚æœæ¯ä¸€ç­†è³‡æ–™é€²ä¾†å°±é¦¬ä¸Šæ›´æ–°ç¡¬ç¢Ÿä¸Šçš„å„²å­˜ï¼Œé€™æœƒæ‹–å® DB æ•ˆèƒ½ï¼Œæ‰€ä»¥ MySQL è®€å¯«æ™‚æ˜¯ä»¥ page ç‚ºå–®ä½ï¼Œå¦‚æœç™¼ç¾æ›´æ–°çš„ page åœ¨è¨˜æ†¶é«”ä¸­æœƒæ¨™è¨˜ç‚º dirty pageï¼Œå¾ŒçºŒå† checkpoint çµ±ä¸€æ›´æ–°åˆ°ç¡¬ç¢Ÿä¸­ \u0008Redo Log é¿å…ç³»çµ± Crash è€Œè³‡æ–™éºå¤±ï¼š\nç‚ºäº†é¿å…è³‡æ–™éºå¤±ï¼Œæ‰€ä»¥æœƒå…ˆå¯«å…¥ Redo Logï¼Œæ‰€ä»¥åˆç¨±ä½œ Write Ahead Log å…ˆå¯«å…¥ log å†æ“ä½œï¼ŒRedo Log æ˜¯ä¸€å€‹é †åºæ€§æŒçºŒå¯«å…¥çš„ Logï¼Œæ‰€ä»¥å¯«å…¥æ•ˆèƒ½æ¯”éš¨æ©Ÿæ€§æ›´æ–°é‚„è¦å¥½ï¼Œç•¶ç³»çµ± crash å¾Œï¼Œæœƒä¾†æª¢æŸ¥ Redo Log ä¸­æ˜¯å¦å­˜åœ¨æ²’æœ‰æ›´æ–°åˆ°è³‡æ–™åº«ç¡¬ç¢Ÿçš„è³‡æ–™ï¼›\nå…·é«”å¯«å…¥ç¡¬ç¢Ÿæ™‚æ©Ÿçœ‹ innodb_flush_log_at_trx_commitï¼Œé è¨­ 1 ç‚ºæ¯ä¸€ç­†éƒ½åŠæ™‚å¯«å…¥ç¡¬ç¢Ÿä¸­ å®šæœŸåŒæ­¥åˆ°ç¡¬ç¢Ÿä¸­ï¼š\næ¯å€‹æ“ä½œéƒ½æœ‰å…ˆå¯«å…¥ Redo Logï¼Œä½†é€™æ˜¯ç‚ºäº†ç½é›£å¾©åŸè€Œç”¨ï¼Œè³‡æ–™åº«çš„è³‡æ–™æœƒä»¥ Page å½¢å¼å„²å­˜æ–¼ç¡¬ç¢Ÿä¸­ï¼Œæ‰€ä»¥å®šæœŸåˆ° checkpoint æœƒæŠŠ dirty page å¾è¨˜æ†¶é«”æ›´æ–°åˆ°ç¡¬ç¢Ÿä¸­ Binlog Binlog é©ç”¨æ–¼ç³»çµ±ç•°åœ°æ¢å¾©/å»ºç«‹ Replicaï¼ŒBinlog ä¸åƒ Redo Log æœƒä¿å­˜æ‰€æœ‰çš„æ“ä½œï¼Œåªæœƒä¿å­˜å°æ–¼è³‡æ–™æœ‰ç•°å‹•çš„è¡Œç‚ºï¼Œä¾‹å¦‚ update / delete ç­‰\nå¯«å…¥æ™‚æ©Ÿåœ¨ commit å®Œæˆæ™‚ï¼Œæœƒåœ¨ commit çµæŸå‰ / lock é‡‹æ”¾å‰å¯«å…¥ç¡¬ç¢Ÿï¼Œé¿å…è³‡æ–™ç•°å¸¸ï¼Œå…·é«”çš„å¯«å…¥é »ç‡è¦çœ‹ sync_binlogï¼Œé è¨­ç‚º 1 ä»£è¡¨æ¯ä¸€ç­† commit å°±å¯«ä¸€æ¬¡ï¼Œå¯ä»¥è¨­å®šç‚º n ä»£è¡¨ n ç­† commit æ‰å¯«å…¥ä½†å°±æœƒæœ‰éºå¤±è³‡æ–™çš„é¢¨éšª\nUndo log å¦‚æœ isolation level é–‹åˆ° repeatable readï¼Œå‰‡ MySQL æ¡ç”¨ MVCCï¼Œè®“æ¯å€‹ transaction åªæœƒè®€å–åˆ°è‡ªå·± transaction é–‹å§‹å‰çš„æœ€æ–°è³‡æ–™ï¼Œè€Œä¸è¢«ä¸¦è¡Œçš„ transaction æ‰€å½±éŸ¿\nä¹‹æ‰€ä»¥éœ€è¦ undo log æ˜¯ç•¶ transaction rollback æ™‚ï¼Œéœ€è¦çŸ¥é“è‡ªå·±è¦å›æ»¾çš„ç‹€æ…‹ï¼Œæ‰€ä»¥ undo log å¿…é ˆä¿å­˜åˆ° transaction åŸ·è¡Œå®Œç•¢æ‰å¯ä»¥åˆªé™¤ï¼Œé•·åº¦æœƒæ˜¯ åŸ·è¡Œæœ€ä¹…çš„ transaction\nAurora æ¶æ§‹ Aurora æ˜¯ AWS åŸºæ–¼é›²ç«¯å»ºæ§‹çš„é—œè¯å¼è³‡æ–™åº«æœå‹™ï¼Œå…¼å®¹æ–¼ MySQL / PostgreSQLï¼Œä¸»è¦æƒ³è§£æ±ºå¹¾å€‹å•é¡Œ\nå®¹éŒ¯èƒ½åŠ›ï¼š\nç¡¬ç¢Ÿå¯èƒ½æœƒå£ / ä¸»æ©Ÿå¯èƒ½æœƒæœ‰å•é¡Œ / ç”šè‡³ Data Center éƒ½æœƒå‡ºæ„å¤–ï¼Œå°¤å…¶æ˜¯åœ¨é›²ç«¯åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œæ©Ÿå™¨æ•¸å¢åŠ å¸¶ä¾†æ›´é«˜çš„å‡ºéŒ¯æ©Ÿæœƒï¼ŒAurora æ¯ä¸€å€‹ replica éƒ½æœƒå°æ‡‰ 3 å€‹ AZ å„ 2 å€‹ node ç¸½å…± 6 å€‹ node å„²å­˜è³‡æ–™ï¼Œå¤§å¹…å¢åŠ å®¹éŒ¯èƒ½åŠ› æ“´å±•æ€§ï¼š\nå‚³çµ±çš„è³‡æ–™åº«æ¶è¨­æ–¼å–®ä¸€ä¸»æ©Ÿä¸Šï¼Œè®€å–æœƒå—é™æ–¼ Disk I/O çš„è²§é ¸ï¼ŒAurora å°‡ Compute / Storage åˆ†é›¢ï¼Œå¯ä»¥é‡å°éœ€æ±‚ç¨ç«‹å‡ç´šï¼Œä¸¦å¢åŠ è·¨å€åŸŸã€è·¨ AZ çš„ Read Replica ä½†æœ‰é€™éº¼å¤šå¥½è™•å»ä¸ç”¨å—åˆ°å¤ªå¤šçš„æ€§èƒ½å½±éŸ¿ï¼Œè½èµ·ä¾†æœ‰é»ç¾å¥½çš„ä¸åˆ‡å¯¦éš›ï¼Œä¾‹å¦‚å‚™ä»½åˆ°å¤šå€‹å„²å­˜ node å°±éœ€è¦æ“”å¿ƒè³‡æ–™ä¸€è‡´æ€§/æ•ˆèƒ½çš„å•é¡Œï¼Œé™¤äº†åŸæœ¬çš„ Disk I/O åˆå¤šäº†ä¸€æ®µ Network I/Oï¼ŒAurora åœ¨ä¸åŒçš„åœ°æ–¹ä½œå‡ºäº†å°æ‡‰çš„èª¿æ•´\n2. DURABILITY AT SCALE 2.1 Replication and Correlated Failures Aurora è·Ÿå¾ˆå¤šåˆ†æ•£å¼å„²å­˜çš„æœå‹™å¾ˆåƒï¼Œæ¡ç”¨å¤šæ•¸è®€å¯«çš„æ©Ÿåˆ¶ï¼Œåªè¦ç¢ºä¿\nVw + Vr \u0026gt; V Vw \u0026gt; V / 2 V ä»£è¡¨ç¯€é»æ•¸é‡ï¼Œå¦‚æœ Vw å¯«å…¥ç¯€é»æ•¸é‡è¶…é 1/2 ç¯€é»éƒ½æˆåŠŸæ‰æˆåŠŸï¼Œä¸” Vr è®€å–æ•¸é‡æ˜¯è®€å–å¤šæ•¸å‰‡\næœ€åŸºæœ¬çš„æ•¸é‡æœƒå– 3ï¼Œå‰‡ Vw / Vr åªè¦æœ‰ 2 å€‹ node å­˜æ´»å‰‡å¯ä»¥ç¹¼çºŒé‹ä½œï¼Œå®¹éŒ¯ç‡æ˜¯ 33%ï¼Œä½†æ–‡ä»¶ä¸­èªªåˆ° Aurora é¸æ“‡ 6 å€‹ nodeåˆ†æ•£åœ¨ 3 å€‹ AZï¼Œé€™æ¨£å¯ä»¥é é˜²ä¸€å€‹ AZ ä»¥åŠä¸€å€‹é¡å¤–éŒ¯èª¤ä¸‹è®€å–é‚„ä¸æœƒä¸­æ–·\n2.2 Segmented Storage ç‚ºäº†é™ä½åŒæ™‚æ©Ÿå™¨æ•…éšœè€Œå°è‡´ç ´å£å¤šæ•¸çš„å¯èƒ½ï¼Œè¦ç›¡å¯èƒ½é™ä½ MTTF(å¹³å‡éŒ¯èª¤æ™‚é–“)èˆ‡ MTTR(å¹³å‡å¾©åŸæ™‚é–“)ï¼ŒAurora ä»¥ 10GB ç•¶ä½œä¸€å€‹å€æ®µï¼Œç”¢ç”Ÿ 6 å€‹å‚™ä»½ä¸¦åˆ†æ•£åˆ° 3 å€‹ AZ ç¨±ä¹‹ç‚º PG(Protection Group)ï¼Œä¸€å€‹ Storage Volume å°±æ˜¯ç”±å¤šå€‹ PG æ‰€çµ„æˆï¼Œå¯¦é«”ä¸Šå°±æ˜¯ç”± EC2 åŠ ä¸Šä¸€ç¾¤åˆ†å‰²çš„ SSD çµ„æˆï¼Œæœ€å¤§å¯æ”¯æ´åˆ° 64TB\nSegment æ˜¯æœ€å°ç¨ç«‹å–®ä½ (ä¹Ÿå°±æ˜¯æœƒå£æ‰æ˜¯ç¨ç«‹ä¸€å€‹ Segment å£)ï¼ŒAWS æœƒè² è²¬æŒçºŒç›£æ§èˆ‡å¾©åŸï¼Œç›®å‰å¾©åŸä¸€å€‹ Segment ç´„ 10ç§’é˜ (ç¶²è·¯å¸¶å¯¬ç‚º 10Gbps ä¸‹)ï¼Œæ‰€ä»¥å‡ºç¾ç ´å£å¤šæ•¸çš„å ´æ™¯ï¼šå…©å€‹ node åœ¨ 10ç§’é˜å…§åŒæ™‚å£æ‰ä¸”ä¸€å€‹ AZ æ›æ‰åˆä¸åŒ…å«åŒæ™‚å£æ‰çš„ node æ©Ÿç‡å°±å¾®ä¹å…¶å¾®\nå°çµï¼šé€™é‚Šè«‡çš„æ˜¯ AWS åœ¨æŒä¹…æ€§ä¸Šçš„å„ªåŒ–ï¼Œå°‡æœ€å°çš„å„²å­˜å–®ä½å®šåœ¨ 10GBï¼Œè®“å¾©åŸé€Ÿåº¦è®Šå¿« / ç”¢ç”Ÿ 6 çµ„å‚™ä»½å¢åŠ å®¹éŒ¯\nTHE LOG IS THE DATABASE 3.1 The Burden of Amplified Writes å…ˆçœ‹ç¬¬ä¸€ç‰ˆ Aurora å˜—è©¦çš„æ¶æ§‹ - å‚³çµ±çš„é¡åƒåŒæ­¥æ¶æ§‹ï¼Œä¸€å° Primary Instance è² è²¬å¯«å…¥å„²å­˜æ–¼ EBS ä¸¦åŒæ™‚å‚™ä»½åˆ°å¦ä¸€ä»½ EBS ä¸­ï¼Œæœ‰ä¸€å° Replica Instance åŒæ­¥ Primary çš„å¯«å…¥ä¸¦å„²å­˜æ–¼å…©ä»½ EBS ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸€å€‹ MySQL å¯«å…¥æœ€å¤šæœƒè§¸ç™¼äº”å€‹ I/O binlog / redo log / frm(metadata) / double-writeï¼Œè¦ç­‰åˆ°å…¨éƒ¨å¯«å…¥çµæŸæ‰ç®—æ˜¯æ“ä½œæˆåŠŸï¼Œé€™æœƒæ‹‰é•·å›æ‡‰æ™‚é–“ï¼Œæ›´ç³Ÿç³•çš„æ˜¯åœ–ç‰‡ä¸­æ­¥é©Ÿ 1,3,5 (ç‚ºä»€éº¼æœ‰5?) æ˜¯åŒæ­¥ä¸”é †åºå¯«å…¥\n3.2 Offloading Redo Processing to Storage ç›¸åçš„ Aurora é€é Redo Log åŒæ­¥ï¼Œè®“ Storage level è² è²¬ Redo Log å¯«å…¥èˆ‡æ›´æ–° Data fileï¼ŒåŒæ™‚åˆ†é€çµ¦ Replica æ›´æ–°è¨˜æ†¶é«”ä¸­ page çš„è³‡æ–™ï¼›\nä¸åƒéå¾€ MySQL éœ€è¦åœ¨ Checkpoint / background / cache ç©ºé–“ä¸è¶³æ™‚åˆ·æ–°è³‡æ–™åˆ°ç¡¬ç¢Ÿä¸­ï¼Œå…¨éƒ¨ç”± Storage Service è² è²¬ï¼Œå¤§å¹…é™ä½äº† Network I/O\nå¾ Benchmark å¯ä»¥çœ‹åˆ°ï¼Œæ¯ç­† Transaction æ‰€éœ€çš„ I/O å¾ 7.4 è®Šæˆ 0.9ï¼Œå®Œæˆçš„ Transaction æ•¸ä¹Ÿæå‡äº† 35 å€\né€™åŒæ™‚ä¹Ÿé™ä½äº†å¾©åŸçš„æ™‚é–“ï¼Œå‚³çµ± DB éœ€è¦å¾ Redo Log ä¸Šä¸€æ¬¡çš„ checkpoint é–‹å§‹é€æ¢åŸ·è¡Œï¼Œä½† Aurora çš„å¾©åŸæ˜¯å¾ Storage level å‘å…¶ä»–å‚™ä»½æ‹‰ Segmentï¼Œå¾©åŸé€Ÿåº¦å¯ä»¥åœ¨ä¸€åˆ†é˜ä»¥å…§\n3.3 Storage Service Design Points Storage Service æ ¸å¿ƒè¨­è¨ˆè¦é™ä½å¯«å…¥è«‹æ±‚çš„å»¶é²ï¼Œæ‰€ä»¥æŠŠå¤§éƒ¨åˆ†çš„å„²å­˜å·¥ä½œéƒ½ç§»è‡³èƒŒæ™¯åŸ·è¡Œï¼Œå°¤å…¶æ˜¯æ›´å¥½åœ°åˆ©ç”¨ CPU å»æ›å– Disk å¯«å…¥æ™‚é–“ï¼Œä¾‹å¦‚èˆŠçš„ Page è¦åƒåœ¾å›æ”¶å¯ä»¥åœ¨èƒŒæ™¯ç”¨ CPU åŸ·è¡Œè€Œä¸è¦å»¶é²å‰æ™¯åœ¨è™•ç†å¯«å…¥è«‹æ±‚ï¼Œæ‰€ä»¥ Aurora çš„èƒŒæ™¯é‹ä½œä¸æœƒå½±éŸ¿å‰æ™¯ï¼Œä¸åŒæ–¼å‚³çµ± DB å¦‚æœèƒŒæ™¯åœ¨ Checkpoint åˆ·æ–°ç¡¬ç¢Ÿå‰‡æœƒé€ æˆå‰æ™¯å¯«å…¥çš„å»¶é²\nStorage Service æ”¶åˆ°è«‹æ±‚æœƒåŸ·è¡Œ\næ”¾å…¥ Memory ä¸­ å¯«å…¥ç¡¬ç¢Ÿï¼Œå¯«å…¥è«‹æ±‚æˆåŠŸ æ’åºï¼Œä¸¦ç¢ºèªå¯«å…¥ç´€éŒ„æ˜¯å¦æœ‰éºæ¼ é€é gossip è·Ÿå…¶ä»–ç¯€é»è¦éºæ¼çš„ç´€éŒ„ æ›´æ–°åˆ° page ä¸­ å®šæœŸåŒæ­¥åˆ° s3 å®šæœŸæ¸…é™¤èˆŠçš„ page å®šæœŸæª¢æŸ¥ page çš„é©—è­‰ç¢¼ é™¤äº†æ­¥é©Ÿ 1, 2 æœƒå½±éŸ¿å‰æ™¯å¯«å…¥ï¼Œå…¶é¤˜æ­¥é©Ÿéƒ½å¯ä»¥éåŒæ­¥ä¸”æ–¼èƒŒæ™¯åŸ·è¡Œ\n4. THE LOG MARCHES FORWARD æ¥è‘—è¦ç¢ºä¿ rumtimeã€replica éƒ½ä¿æŒä¸€è‡´æ€§ï¼Œç©¶ç«Ÿæ˜¯å¦‚ä½•ä¸ä½¿ç”¨æ˜‚è²´çš„ 2pc å»åˆèƒ½ä¿æŒä¸€è‡´æ€§\n4.1 Solution sketch: Asynchronous Processing å‰é¢æé Aurora æ˜¯é€é redo log åŒæ­¥ï¼Œæ¯ä¸€ç­† log éƒ½æœ‰ æŒçºŒéå¢çš„ LCN (Log Sequence Number)ï¼Œå› ç‚ºå¯«å…¥æˆåŠŸåªè¦å¤šæ•¸çš„ node åŒæ„å³å¯ï¼Œæ‰€ä»¥æœ‰äº› node å¯èƒ½æœƒç¼ºå°‘å¹¾å€‹ logï¼Œå¯ä»¥é€é LCN å»è·Ÿå…¶ä»– node ç´¢å–éºå¤±çš„ log\nè€ƒé‡åˆ°å¤š transaction çš„æƒ…æ³ï¼Œæ¯å€‹ transaction åŸ·è¡Œé †åºæœ‰æ‰€ä¸åŒï¼Œåœ¨éç¨‹æœƒé™¸çºŒæŠŠ commit é€åˆ° storage service å„²å­˜ (åˆ° complete) éšæ®µï¼Œä½†å¦‚æœç™¼ç”Ÿäº†ç³»çµ±æ•…éšœæ™‚ï¼Œé‡æ–°æ¢å¾©å¾Œéœ€è¦æŠŠæ²’æœ‰ commit çš„ transaction éƒ½ rollbackï¼Œå‡è¨­ DB ç›®å‰æœ€é«˜å®Œæˆå¯«å…¥çš„ LCN ç¨±ç‚º VCL (Volume Complete LSN))ï¼Œåœ¨å¾©åŸä¸­ä»»ä½• LCN é«˜æ–¼ VCL éƒ½æœƒè¢«éºæ£„ï¼Œå› ç‚ºä»£è¡¨æ²’æœ‰è¢« complete\næ›´é€²éšé€™äº›é«˜æ–¼ VCL çš„ LCN æœƒè¢«æ¨™è¨˜æˆ CPL (Consistency Point LSNs)ï¼Œæ¥è‘—å®šç¾©å‡º VDL ç‚ºé‚£äº›åœ¨ä½æ–¼ VCL ä¸­æœ€é«˜çš„ CPLï¼Œä¾‹å¦‚ CPL æœ‰ 900,1000, 1100 ä½†æ˜¯ VCL ç‚º 1007ï¼Œå‰‡ VDL ç‚º 1000ï¼Œé€™ä»£è¡¨ storage service complete åˆ° 1007 ä½†æ˜¯æŒä¹…åŒ–å„²å­˜åˆ° 1000\né€™ä¸€æ•´æ®µæ²’æœ‰åˆ°éå¸¸ç†è§£ï¼Œå¾…ä¹‹å¾Œæ…¢æ…¢æ€è€ƒ\n4.2 Normal Operation Aurora æœƒåŒæ™‚è™•ç†å¤§é‡çš„å¯«å…¥è«‹æ±‚ï¼Œæ¯ä¸€ç­† redo log éƒ½æœƒç”¢ç”Ÿä¸€å€‹å¤§æ–¼ VDL(è¢«æŒä¹…åŒ–ä¿å­˜çš„ LCN)çš„ LCNï¼Œä½†ç‚ºäº†ä¸è¦è®“ LCN çš„éå¢é å¤§æ–¼ Storage Service æ‰€èƒ½ä¿å­˜çš„é€Ÿåº¦ï¼ŒLSN Allocation Limit (LAL) é è¨­ç‚º 10è¬ç­†ï¼Œæ„å³ Aurora æœ€å¤šä¸¦è¡Œ 10 è¬ç­†é€²è¡Œä¸­çš„ transaction é¿å…å¯«å…¥é€Ÿåº¦è·Ÿä¸ä¸Š\næ¯ä¸€å€‹ PG ä¸­çš„æ¯ä¸€å€‹ Segment åªæœƒä¿å­˜éƒ¨åˆ†çš„ redo logï¼Œä½†æœƒæœ‰ä¸€å€‹ link æŒ‡å‘ä¸Šä¸€ä»½ log æ‰€åœ¨çš„ PGï¼Œé€™ç”¨ä¾†è¿½è¹¤ç›®å‰æ‰€å®Œæˆæœ€å¤§çš„ LCNï¼Œä¸¦ä¸”åœ¨èˆ‡å…¶ä»– node gossip æ™‚å¯ä»¥çŸ¥é“ç¼ºæ¼çš„ log\nRead å¦‚åŒå¤§å¤šæ•¸çš„ DBï¼ŒAurora æœƒåœ¨ buffer ä¸­ cache page ï¼Œå¦‚æœ cache miss å‰‡å¾ disk è®€å–ï¼Œæ­¤æ™‚å‚³çµ± DB æœƒå„ªå…ˆç§»é™¤ dirty page ä¸¦å¯«å›ç¡¬ç¢Ÿä¸­ï¼›ä½† Aurora ä¸¦ä¸éœ€è¦åˆ·æ–° dirty page (å› ç‚º storage service å·²ç¶“ç¨ç«‹æ›´æ–°)ï¼Œç›¸åçš„æ˜¯æŠŠ page LCN å¤§æ–¼ç­‰æ–¼ VDL çš„ page ç§»é™¤ä¸¦è®€å–æœ€æ–°è¢«æŒä¹…åŒ–çš„page\nå‰é¢æåˆ° Aurora é€éå¤šæ•¸è®€å–ç¢ºä¿ä¸€è‡´æ€§ï¼Œä½†å¤§å¤šæ•¸æ™‚æ©Ÿä¸¦ä¸éœ€è¦ï¼ŒAurora æœƒåœ¨ Page è®€å–æ™‚ç´€éŒ„ Page LCN ç•¶ä½œ read pointï¼Œæ¥è‘—åªè¦è®€å–çš„ storage node VDL ç¢ºå®šåœ¨ read point ä¹‹å¾Œï¼Œå°±ä»£è¡¨è©² node æœ‰è©² page å®Œæ•´æœ€æ–°çš„è³‡æ–™ï¼Œè€Œä¸”å› ç‚ºæ¯å€‹ segment éƒ½æœ‰ç´€éŒ„ LCN èˆ‡ linkï¼Œæ‰€ä»¥èƒ½å¾ˆå¿«çŸ¥é“è³‡æ–™è¦åˆ°å“ªä¸€å€‹ segment è®€å–\nåŒæ™‚æ¯å€‹ PG æœƒç¶­è­·ä¸€ä»½ç›®å‰æœ€ä½çš„ Protection Group Min Read Point LSN (PGMRPL)ï¼Œé€™ä»£è¡¨ä½æ–¼æ­¤æ•¸å­—çš„ LCN çš„ page éƒ½ä¸æœƒå†è¢«è®€å–ï¼Œé€™æ¨£åƒåœ¾å›æ”¶å°±èƒ½ç§»é™¤éèˆŠçš„ log\nReplica ä¸€å€‹ write node å¯ä»¥æ­é… 16 å€‹ read replica ä¸¦å…±ç”¨ç›¸åŒçš„ storage serviceï¼Œwriter æœƒæŠŠ redo log ä¹ŸåŒæ­¥çµ¦ readerï¼Œå¦‚æœ log æœ‰åœ¨ cache ä¸­å‰‡æ›´æ–°ï¼Œå¦å‰‡å°±ç›´æ¥ä¸Ÿæ£„\nå› ç‚º reader è·Ÿ storage service çš„ redo log æ›´æ–°æ˜¯éŒ¯é–‹ï¼Œæ‰€ä»¥ reader åœ¨æ›´æ–° log æ™‚è¦ç¢ºä¿ LCN æ˜¯å°æ–¼ç­‰æ–¼ VDL / å¦‚æœ log æ˜¯ mini-transaction çš„ä¸€éƒ¨åˆ†å‰‡æ›´æ–°ï¼Œç¢ºä¿è·Ÿæ‰€æœ‰çš„ database çœ‹åˆ°ç›¸åŒå…§å®¹\né æœŸ reader çš„å»¶é²æœƒåœ¨ 20ms ä»¥å…§\n4.3 Recovery å‚³çµ± DB åœ¨ç½é›£å¾©åŸæ™‚ï¼Œæœƒå»è®€å– redo log ä¸­é‚„æ²’è¢« checkpoint åŸ·è¡Œçš„ logï¼Œæ­é… undo log å°‡å¤±æ•—çš„ transaction rollbackï¼Œä½†é€™åŸ·è¡Œéç¨‹è »èŠ±æ™‚é–“ï¼Œè€Œ Aurora æ²’æœ‰é€™æ–¹é¢å›°æ“¾\né¦–å…ˆæœƒæª¢æŸ¥æ¯ä¸€å€‹ PGï¼Œæ‰¾å‡ºè®€å–å¤šæ•¸ä¸­å¯ä»¥ç¢ºä¿å·²ç¶“å®Œæˆçš„å¯«å…¥å¤šæ•¸ç´€éŒ„ VDLï¼Œé«˜æ–¼ VDL çš„ LCN å…¨éƒ¨æ¨æ£„ï¼Œæ¥è‘—ä¸€æ¨£éœ€è¦é€é undo log å» rollbackï¼Œæ•´å€‹éç¨‹ç´„ 10ç§’ä»¥å…§\n5. PUTTING IT ALL TOGETHER æ¥è‘—çœ‹å®Œæ•´çš„æ¶æ§‹åœ– ç¤¾ç¾¤ç‰ˆçš„ MySQL InnoDB å¼•æ“åœ¨å¯«å…¥æ“ä½œæ™‚æœƒä¿®æ”¹ buffer ä¸­çš„ page èˆ‡å¯«å…¥ WAL redo log bufferï¼Œç­‰åˆ° commit æ™‚å†æŠŠ redo log buffer å¯«å…¥ç¡¬ç¢Ÿä¸­ï¼›è€Œè¢«ä¿®æ”¹çš„ page è¦å‰‡é€é double-write buffer é¿å…åªæ›´æ–°éƒ¨åˆ† pageï¼Œpage å¯«å…¥æœƒç™¼ç”Ÿåœ¨èƒŒæ™¯ / checkpoint / cache ç§»é™¤æ™‚ï¼› æ­¤å¤–é‚„æœ‰ä¸€äº› B+Tree æ“ä½œèˆ‡ç›¸é—œçš„ mini trasaction (MTR) å¦‚æ‹†åˆ†ã€åˆä½µ B+Tree page éœ€è¦æ˜¯åŸå­æ€§æ“ä½œ\nåœ¨ Aurora ç‰ˆæœ¬ä¸­ï¼Œredo log record å°±ä»£è¡¨æ¯ä¸€å€‹ MTR æ“ä½œï¼Œæœ€æ–°çš„ä¸€ç­† log è¢«æ¨™è¨˜æˆ consistency pointï¼›Aurora æä¾›ç›¸åŒçš„ isolation level\nå…¶é¤˜å°±æ˜¯æ¶æ§‹çš„èªªæ˜ï¼Œä»¥åŠå„æ–¹é¢çš„æ€§èƒ½è¡¨ç¾ï¼Œå°±ä¸è´…è¿°äº†\nAurora å°æ¯” MySQL æœ‰ä»€éº¼éš±æ†‚ å› ç‚º Aurora å¦‚æœ primary è·Ÿ read replica åœ¨åŒä¸€å€‹ region ä¸‹ï¼Œå‰‡æœƒå…±ç”¨ storage serviceï¼Œé€™ä¹Ÿå°±ä»£è¡¨ undo log æœƒæ˜¯åŒä¸€ä»½ï¼Œå¦‚æœä»Šå¤© read replica æœ‰ä¸€ç­†åŸ·è¡Œéå¸¸ä¹…çš„ transactionï¼Œå‰‡ undo log ä¹Ÿæœƒè·Ÿè®Šå¤§å°è‡´ primary æ•ˆèƒ½ä¸‹é™\né€™å€‹åœ¨å‚³çµ± MySQL ä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºå¦‚ 3.1 æåˆ° MySQL æ˜¯é€é binlog åŒæ­¥å„è‡ªçš„ MySQL ç¶­è­·å„è‡ªçš„ redo log / undo log æ‰€ä»¥ read replica ä¸æœƒæœ‰ä»»ä½•å½±éŸ¿ primary çš„æ™‚å€™\næœ€å¾Œä½œè€…æŒ‡å‡ºæœ‰å¹¾å€‹è§£æ³•\nèª¿æ•´ read replica é è¨­ isolation level ç‚º read commitedï¼Œå°±ä¸æœƒç”¨åˆ° undo log(éœ€æ³¨æ„é è¨­ç‚º repeatable read) Aurora é¸æ“‡ binlog relicaï¼Œå°±è·Ÿå‚³çµ±çš„ mysql ä¸€æ¨£ æ‹¿åœ¨ S3 çš„å‚™ä»½è³‡æ–™ï¼Œç”¨å…¶ä»–å¤§æ•¸æ“šå·¥å…·åˆ†æ Aurora æ”¯æ´ cloneï¼Œå‚™ä»½ä¸€çµ„æ–°çš„è¨­å®š çµèª ç¿»æ•´å€‹ Aurora æ¶æ§‹æœ‰å¾ˆå¤šç”Ÿç¡¬çš„åœ°æ–¹æ²’æœ‰å®Œå…¨ææ‡‚ï¼Œä½†æ˜¯çœ‹åˆ°é€™ç¨®è§£ bug è¿½æ ¹ç©¶åº•åˆ°åº•å±¤æ¶æ§‹é‚„æ˜¯è¦ºå¾—å¾ˆéç™®ï¼Œä¹‹å¾ŒæœƒæŒçºŒçš„å„ªåŒ–æ–‡ç« å…§å®¹ï¼Œå¦‚æœæœ‰å“ªè£¡æœ‰å»ºè­°è·ŸæŒ‡æ•™å†éº»ç…©ç•™è¨€ï½\n","date":"2021-07-02T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-07-02-aws-aurora-%E6%9E%B6%E6%A7%8B%E7%A0%94%E7%A9%B6%E4%BB%A5%E5%8F%8A%E8%88%87%E8%87%AA%E9%A7%95-mysql-%E7%9A%84%E5%B7%AE%E7%95%B0/","title":"AWS Aurora æ¶æ§‹ç ”ç©¶ä»¥åŠèˆ‡è‡ªé§• MySQL çš„å·®ç•°"},{"content":"æœ€è¿‘åŠŸèƒ½ä¸Šç·šé‡åˆ°ä¸€äº› OOM å•é¡Œï¼Œåœ¨ Staging æ‰‹å‹•é©—è­‰æµé‡ä¸å¤ æ¸¬ä¸å‡ºä¾†æœ‰é»é ­ç–¼ï¼Œæ‰€ä»¥å›é ­ç”¨ JMeter é€²è¡Œå£“åŠ›æ¸¬è©¦ï¼Œå› ç‚ºæœ‰ Cache æ‰€ä»¥åªæ‰“å–®ä¸€ç¨® request æ˜¯æ²’æœ‰ç”¨çš„ï¼Œå¿…é ˆçµ„åˆå‡ºå¤šç¨®åƒæ•¸ä¸€èµ·åŸ·è¡Œï¼Œå¥½åœ¨ JMeter æ”¯æ´ csv è¼¸å…¥åƒæ•¸ï¼Œä»¥ä¸‹å°‡ä»‹ç´¹å¦‚ä½•ä½¿ç”¨\nSample å¯ä»¥åƒè€ƒæˆ‘çš„ github repo jmeter-pre-post-processor\nå®‰è£ åˆ°å®˜ç¶²ä¸‹è¼‰æœ€æ–°ç‰ˆï¼Œè§£å£“ç¸®å®Œ $ bin/jmeter å³å¯åŸ·è¡Œï¼Œè¨˜å¾—é›»è…¦è¦å®‰è£ java\nSample1: æ“ä½œ é€²è¡ŒåŸºæœ¬çš„å£“åŠ›æ¸¬è©¦ï¼Œå¤§æ¦‚æœƒæœ‰ä»¥ä¸‹çš„æ­¥é©Ÿ\næ±ºå®šé€²è¡Œå¹¾è¼ªæ¸¬è©¦ è¦ç™¼é€å¤šå°‘ requestã€åŒæ™‚é–“ä½µç™¼æ•¸ request é‡å°çš„ host / åƒæ•¸è¨­å®š çµæœçš„é¡¯ç¤ºï¼Œå¯ä»¥å°‡ response å­˜æˆæª”æ¡ˆ / åœ–è¡¨é¡¯ç¤º response é€Ÿåº¦ã€æˆåŠŸç‡ç­‰ å°æ‡‰ JMeter è¨­å®šæ˜¯\nThread Group Number of Threads: å¤šå°‘ request Loop Count: ç¸½å…±å¹¾è¼ª Ramp-Up Second: æœ‰é» ticky çš„åƒæ•¸ï¼ŒæŒ‡å®šå¤šå°‘æ™‚é–“å…§ Thread æœƒå•Ÿå‹•ï¼Œå‡è¨­è¨­å®š 90 sec ç¸½å…±æœ‰ 10 å€‹ threadï¼Œå‰‡ä¸‹ä¸€å€‹ thread æœƒä¸Šä¸€å€‹ thread æˆåŠŸå¾Œ + 9 (90/10) sec å¾Œå•Ÿå‹•ï¼Œå®˜æ–¹å»ºè­° é è¨­ = threads æ•¸é‡å†è¦–æƒ…æ³å¢æ¸›ï¼Œå¦‚æœè¦ç¢ºä¿åŒæ™‚ä½µç™¼ï¼Œrequest åŸ·è¡Œæ™‚é–“è¦å¤§æ–¼ thread å•Ÿå‹•æ™‚é–“ åœ¨ Thread Group ä¸Šï¼ŒæŒ‰ä¸‹å³éµå¢åŠ  Config Element ç³»åˆ—ï¼šå¯ä»¥æ”¾å…±ç”¨åƒæ•¸ Http Request Default: Http request çš„é è¨­åƒæ•¸ï¼Œå¯ä»¥æ”¾ host / port ç­‰å…±ç”¨è¨­å®š Http Header Manager: æ”¾å…±åŒ Header Sampler: æ¡æ¨£ï¼Œä¹Ÿå°±æ˜¯è¦æ¸¬è©¦çš„é …ç›® Http Request: æŒ‡å®šè¦æ‰“çš„åƒæ•¸ Listener: æ”¶é›†çµæœ Summary Reportï¼šçµ±è¨ˆæ‰€æœ‰ request çš„é€Ÿåº¦èˆ‡æˆåŠŸç‡ç­‰ Sample2: å¾ csv è®€å–åƒæ•¸ é¸æ“‡ Config Element \u0026gt; CSV Data Set Configï¼Œé¸æ“‡ csv æª”æ¡ˆå¾Œï¼Œåœ¨ Http Request å¯ä»¥ç”¨ ${è®Šæ•¸å} çš„æ–¹å¼ï¼Œå°±å¯ä»¥è®€å–åˆ°å°æ‡‰çš„ csv æ¬„ä½å–” ä¾‹å¦‚æˆ‘çš„ csv é•·é€™æ¨£\n1 2 3 4 account,password user1,test1 user2,test2 user3,test3 æˆ‘å¸Œæœ›æ‰“å‡º POST /login ä¸­çš„ body å¸¶åƒæ•¸ï¼Œè®Šæˆ\n1 {\u0026#34;user\u0026#34;: \u0026#34;${account}\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;${password}\u0026#34;} JMeter æœƒä¾åºå¾ä¸Šè‡³ä¸‹ä¸æ–·è¼ªè¿´ç™¼é€å–”\nSample3: Pre Processor å¦‚æœæˆ‘å€‘å¸Œæœ›åœ¨æ¯æ¬¡ Request å‰åšä¸€äº›é è™•ç†ï¼Œä¾‹å¦‚ç”¢ç”Ÿäº‚æ•¸ã€å­—ä¸²çµ„åˆç­‰ï¼Œå°±å¯ä»¥ç”¨ Pre Processorï¼Œæœ‰åˆ†æˆå¾ˆå¤šç¨®ï¼Œå¯ä»¥ç”¨ BeanShell (java-like script language) æˆ–æ˜¯ JSR223 (javascript / groovy ç­‰æ›´å¤šçš„ script language)ï¼Œé€™é‚Šå°±ç”¨ javascript\nå»¶ä¼¸è‡ª Sample2ï¼Œå…ˆå°‡ csv è®€é€²ä¾†çš„ account / password ç•¶ä½œåƒæ•¸ï¼Œåœ¨ account å‰é¢åŠ ä¸€å€‹ \u0026ldquo;prefix_\u0026rdquo; å­—ä¸²ï¼Œåšæ³•ä¸Šæ–°å¢ä¸€å€‹ JSR223 Preprocessorï¼Œé¸æ“‡ javascriptï¼Œä¸¦è¼¸å…¥\n1 2 3 4 var account = vars.get(\u0026#34;account\u0026#34;) account = \u0026#34;prefix_\u0026#34; + account vars.put(\u0026#34;account\u0026#34;, account) log.info(vars) æœ‰ä¸€äº›ç’°å¢ƒè®Šæ•¸å¯ä»¥ä½¿ç”¨ï¼Œä¾‹å¦‚ vars å¯ä»¥å–å¾—/è¨­å®šç•¶å‰çš„è®Šæ•¸ï¼Œå…¶é¤˜é‚„æœ‰ sample å¯ä»¥æ”¹è®Š sample çµæœ / log æ‰“å‡º logï¼Œ console.log æ˜¯ä¸èƒ½ç”¨çš„ / props å–å¾—ç•¶å‰ JMeter è¨­å®šç­‰ï¼Œé€™äº›æ¯”è¼ƒé€²éšï¼Œå¯ä»¥åƒè€ƒ How to Use BeanShell: JMeter\u0026rsquo;s Favorite Built-in Component\nPost Processor æœ‰äº›æ™‚å€™ï¼Œæˆ‘å€‘æœƒå¸Œæœ›åšä¸€äº›å¾Œè™•ç†ï¼Œä¾‹å¦‚ parse response åš assertion ç­‰ï¼Œå¯ä»¥å¢åŠ  post-processorï¼Œä¾‹å¦‚æˆ‘å€‘å¯ä»¥æ¥ç™»å…¥å–å¾—çš„ tokenï¼Œç•¶ä½œä¸‹ä¸€å€‹ request çš„åƒæ•¸ï¼Œæ–°å¢ä¸€å€‹ JSR223 PostProcessor\n1 2 3 var responseBody = sampler.sample().getResponseDataAsString(); responseBody = JSON.parse(responseBody) vars.put(\u0026#34;user_id\u0026#34;, String(responseBody.id)) é€™æ¨£ä¸‹ä¸€å€‹ request å°±å¯ä»¥æ‹¿ ${user_id} äº†\nçµèª JMeter æœ‰éå¸¸å¤šæ–¹ä¾¿ä¸”å¼·å¤§çš„çµ„ä»¶ï¼Œå¯ä»¥çµ„åˆå‡ºå„ç¨®å®¢è£½åŒ–çš„å£“æ¸¬ç’°å¢ƒ\n","date":"2021-06-26T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-06-26-jmeter-%E4%BD%BF%E7%94%A8%E6%95%99%E5%AD%B8-+-%E8%87%AA%E5%AE%9A%E7%BE%A9%E8%AE%8A%E6%95%B8%E4%BD%BF%E7%94%A8/","title":"å£“æ¸¬å·¥å…·ï¼šJMeter ä½¿ç”¨æ•™å­¸ + è‡ªå®šç¾©è®Šæ•¸ä½¿ç”¨"},{"content":"ç•¶æ™‚åœ¨ç¤¾ç¾¤çœ‹åˆ°åˆ†äº«ï¼Œæƒ³èªªè½çœ‹çœ‹ä¹Ÿæ²’ä»€éº¼æå¤±ï¼Œè½å®Œæ‰ç™¼ç¾æ ¹æœ¬è³ºåˆ°ï¼Œæ²’æœ‰æƒ³é SOLID å¯ä»¥ç”¨é€™ç¨®æ–¹å¼ç†è§£ï¼Œä¹Ÿæ‰çœŸæ­£æ˜ç™½è‡ªå·±ä»¥å¾€åœ¨çœ‹ Uncle Bob çš„æ›¸æ€è€ƒéƒ½å¤ªæ·ºå±¤ï¼ŒçœŸå¿ƒæ„Ÿè¬ Fred å¤§å¤§æ’¥ç©ºè·Ÿå¤§å®¶åˆ†äº«å¯¶è²´çš„çŸ¥è­˜ï¼Œåœ¨ç›´æ’­ä¸­é‡åˆ°è¨­å‚™ã€ç¶²è·¯å•é¡Œé‚„æ˜¯å¾ˆæœ‰æ¢ç†çš„å®Œæˆåˆ†äº«\nä»¥ä¸‹å°‡æ•´ç† Fred å¤§å¤§ç›´æ’­çš„åˆ†äº«ï¼Œå»ºè­°æœ‰ç©ºå¯ä»¥èŠ±å…©å°æ™‚çœ‹å®Œç›´æ’­\nSOLID Uncle Bob åœ¨ 1995 å¹´(ç´„ 37æ­²)æ ¹æ“šè‡ªå·±é–‹ç™¼ç¨‹å¼çš„ç—›é»ï¼Œä¹Ÿå°±æ˜¯å¤§å‹è»Ÿé«”ç¨‹å¼å¯ç¶­è­·æ€§ï¼Œéœ€æ±‚è®Šæ›´å¸¶ä¾†ç¨‹å¼ç¢¼ç¶­è­·å•é¡Œï¼Œè€Œç¶­è­·å•é¡Œçš„æ ¹æœ¬åŸå› æ˜¯ç¨‹å¼ç¢¼çš„è€¦åˆï¼Œåœ¨ç¤¾ç¾¤æå‡ºè¨è«–ï¼Œç„¶å¾Œè¢«æˆ°ç¿»äº† XD\nè¨­è¨ˆå£å‘³é“ Rigidity åƒµåŒ–ï¼šä»»ä½•è®Šæ›´æœƒå°è‡´ç³»çµ±ä¸­ç›¸ä¾çš„çµ„ä»¶éœ€è¦è®Šæ›´ï¼Œè¶…å‡ºæƒ³åƒ Fragility è„†å¼±ï¼šç™¼ç”Ÿè®Šæ›´æ™‚ï¼Œå…¶ä»–åœ°æ–¹å®¹æ˜“ç™¼ç”Ÿå•é¡Œ Immobility é›£ä»¥æœç”¨ï¼šçµ„ä»¶æœ‰å¤ªå¤šç´°ç¯€çš„ä¾è³´ Viscosity é»æ»¯ï¼šè®Šæ›´æ™‚ç”¨å¤ªå¤š hackï¼Œè€Œéä»¥åŸè¨­è¨ˆçš„æ–¹å¼é€²è¡Œ çµ„ä»¶ç›¸äº’ä¾è³´æ€§ SOLID æœ¬è³ªåœ¨è§£æ±ºçµ„ä»¶ä¹‹é–“ä¸åˆç†çš„ç›¸äº’ä¾è³´æ€§\nSingle Responsibility æè¿°èˆ‡å®šç¾©æœ€æ¨¡ç³Šçš„ä¸€æ¢ï¼Œæœ‰å¹¾ç¨®å¸¸è¦‹èªªæ³•\nä¸€å€‹é¡åˆ¥æ‡‰è©²åªæœ‰ä¸€å€‹æ”¹è®Šçš„åŸå›  ä¸€å€‹é¡åˆ¥åªæ‡‰åšä¸€ä»¶äº‹ï¼Œå°±æ˜¯ä»–çš„è·è²¬ =\u0026gt; é‚£è·è²¬æ‡‰è©²æ˜¯ä»€éº¼ï¼Œå°±æ˜¯é€™å€‹é¡åˆ¥è©²åšçš„äº‹ (ç„¡é™ loop) ä¾‹å¦‚ä¸€å€‹å­¸ç”Ÿç®¡ç†ç³»çµ±ï¼ŒStudent çš„é¡åˆ¥å¢åˆªæ”¹æŸ¥ï¼Œè¦ç”¢ç”Ÿå¹¾å€‹é¡åˆ¥ï¼Ÿ è³‡æ–™è™•ç†ä¸­çš„ ETL æ˜¯ä¸€å€‹è·è²¬é‚„æ˜¯ä¸‰å€‹åŸå‰‡ï¼Ÿ é•å SRP çš„è¨­è¨ˆå¯èƒ½æœƒé•·é€™æ¨£ å¯ç¶­è­·æ€§å•é¡Œæ–¹é¢ï¼Œé™¤äº†ç¨‹å¼ç¢¼è€¦åˆï¼Œä¹Ÿè¦æ³¨æ„ æ¥­å‹™è€¦åˆ ä¸€å€‹çµ„ä»¶æœ‰äº†ç”¨æˆ¶ç›¸é—œï¼Œåˆæœ‰ä¿¡ç”¨å¡ç›¸é—œï¼Œçµæœå…©ç¨®æ¥­å‹™å°±è€¦åˆäº†\nè»Ÿé«”çµ„ä»¶ç™¼ç”Ÿçš„åŸå› (è·è²¬)ï¼Œæ‡‰è©²ä¾†è‡ªåŒä¸€å€‹æ¥­å‹™æ–¹ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ç¾¤æœƒå°çµ„ä»¶æå‡ºæ¥­å‹™éœ€æ±‚çš„äºº\nç•¶çµ„ä»¶è¦æ¨¡å¢åŠ ï¼Œæ¥­å‹™é‡å¢åŠ ï¼Œè€ƒæ…®ä½¿ç”¨ SRP æ‹†åˆ†çµ„ä»¶ï¼Œè®“æ¥­å‹™å–®ç´”åŒ–ï¼ŒæŒçºŒè¿­ä»£ï¼Œå¾å¦ä¸€å€‹è§’åº¦ç†è§£ SRP æ˜¯çµ„ä»¶ä¸è©²ç¢°çš„äº‹æƒ…åˆ¥ç¢°\nè­˜åˆ¥æ˜¯å¦éµå¾ SRP çš„æå•ã€Œé€™å€‹ xxx æ˜¯åšä»€éº¼çš„ï¼Ÿã€/ å¦‚æœç­”æ¡ˆåŒ…å«äº†ã€Œooo å’Œ xxxã€ï¼Œå‰‡é€šå¸¸é•èƒŒäº† SRP\nå¸¸è¦‹éŒ¯èª¤\nä¸è¦ç”¨è¨‚å–® ID æ ¼å¼ç•¶ä½œåˆ†é¡çš„æ–¹æ³•ï¼Œè€Œæ‡‰è©²ç”¨ç¨ç«‹çš„æ¬„ä½ (ex. çªç„¶è¦æ”¹ id é•·åº¦å°±çˆ†ç‚¸äº†) é€éä»¥ä¸‹å•é¡Œæ€è€ƒ SRP æ–¹é‡ ä¸ä¸€å®šè¦æ‹†ï¼Œå¦‚æœ 20 å€‹æ–¹æ³•æ˜¯ç·Šè€¦åˆä¹Ÿå±¬æ–¼åŒæ¥­å‹™ å¯ä»¥ï¼Œä½†è¨ˆç®—æ–¹å¼æ‡‰è©²æ‹†é™¤ åˆ†é–‹ æœ€å¥½ä¸è¦ï¼Œç”¨æˆ¶ç­‰ç´šå°±æ˜¯ç­‰ç´šï¼Œç‹€æ…‹å°±æ˜¯ç‹€æ…‹ å°çµ SRP å»ºè­°ï¼šä»»ä½•ä¸€å€‹çµ„ä»¶æ‡‰è©²åªå°åŒä¸€å€‹å®¢æˆ¶/æ¥­å‹™é—œè¯æ–¹çš„éœ€æ±‚è€Œç™¼ç”Ÿè®Šå‹• ä¸è©²åšåˆ°çš„äº‹å°±ä¸è¦ç¢° è­˜åˆ¥æ˜¯å¦é•å SRP : é€™å€‹çµ„ä»¶/æœå‹™/é¡åˆ¥/æ¬„ä½/å€¼æ˜¯åšä»€éº¼çš„ å¾è¢«æ›´å‹•çš„çµ„ä»¶è§’åº¦è§£æ±ºæ¥­å‹™çš„è€¦åˆ Open Close å¦‚æœæ¯æ¬¡åŠŸèƒ½ä¿®æ”¹éƒ½æœƒé€ æˆç³»çµ±ä¸€é€£ä¸²çš„çµ„ä»¶ä¿®æ”¹ï¼Œé€™æ¨£å°±ä¸ç¬¦åˆé–‹é–‰åŸå‰‡ï¼Œä¸€èˆ¬æœƒç†è§£æˆä¸ä¿®æ”¹åŸå§‹ç¢¼å°±å¯ä»¥æ“´å±•ç³»çµ±è¡Œç‚º ï¼Ÿï¼é€™æ˜¯é€šéˆå— XD æ€éº¼å¯èƒ½æ²’æœ‰å¯« code è¡Œç‚ºå°±å‡ºç¾\nçœŸæ­£çš„è§£è®€æ˜¯\nç³»çµ±è¦å¯ä»¥å¦¥å–„é æ¸¬è¤‡é›œåº¦çš„ç™¼ç”Ÿé»ï¼Œä¸¦å»ºç«‹é©åˆçš„ æ“´å±•é» ï¼Œè€Œç™¼ç”Ÿè¡Œç‚ºè®Šæ›´æ™‚ï¼Œé€éæ“´å±•é»è®Šæ›´ï¼ŒåŸæœ¬çš„ä¸»æµæˆèˆ‡ä½¿ç”¨è©²æ“´å±•é»æœ¬èº«çš„ client æœ¬èº«ä¸éœ€è¦ä¿®æ”¹\nä¾‹å¦‚æœ‰ä¸€å€‹å¤–è³£å¹³å°ï¼Œæœ‰å¤šç¨®æœƒå“¡èº«ä»½ï¼Œå°æ‡‰ä¸åŒçš„æŠ˜æ•¸ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 calPrice(){ if(ç”¨æˆ¶æ˜¯å°ˆå±¬æœƒå“¡) { if(é‡‘é¡ \u0026gt; 200){ æ‰“ä¸ƒæŠ˜ } } if(ç”¨æˆ¶æ˜¯ vip æœƒå“¡){ æ‰“å…«æŠ˜ } if(æ™®é€šæœƒå“¡){ if(ä¸Šå€‹æœˆé‚„æ˜¯ vip æœƒå“¡){ æ‰“å…«æŠ˜\t} } åŸåƒ¹ } å¦‚æœ PM èª¬\næœƒå“¡åˆ¶åº¦å¢åŠ  èª¿æ•´æŠ˜æ•¸ å‰‡æ•´å€‹è¨ˆåƒ¹éƒ½æœƒå—åˆ°å½±éŸ¿ æ‰€ä»¥è¤‡é›œåº¦ç™¼ç”Ÿé»åœ¨æ–¼ è¨ˆç®—æ‡‰ä»˜åƒ¹æ ¼ ï¼Œæ‡‰è©²åœ¨æ­¤è™•è¨­è¨ˆæ“´å±•é»ï¼Œé€é Strategy Patternï¼Œå»ºç«‹ UserPayService interfaceï¼Œå°‡è¨ˆç®—é‚è¼¯æ”¾åœ¨ä¸åŒçš„å¯¦ç¾ä¸Š\nå¦‚æœç™¼ç”Ÿ\nå¢åŠ æœƒå“¡ç­‰ç´š â‡’ å¢åŠ å¯¦ä½œå³å¯ åŸæœ¬è¨ˆç®—çš„æµç¨‹ä¸éœ€è¦ä¿®æ”¹ å¯ä»¥åƒè€ƒ ç”¨å¤šå‹å–ä»£é‡è¤‡çš„åˆ¤æ–·å¼\nå°çµ çµ„ä»¶çš„è€¦åˆï¼Œæœƒè®“å¾®å°çš„è®Šå‹•ä¹Ÿè®“ç³»çµ±æœ‰å¤§å¹…åº¦ä¿®æ”¹ï¼ŒOCP å»ºè­°ï¼šçµ„ä»¶çš„è¨­è¨ˆå¿…é ˆè®“ç³»çµ±æ˜“æ–¼æ“´å±•ï¼ŒåŒæ™‚é™åˆ¶æ¯æ¬¡è¢«ä¿®æ”¹çš„ç¯„åœï¼Œå¯¦ä½œç‚ºå°‡ç³»çµ±åŠƒåˆ†ä¸€ç³»åˆ—çš„çµ„ä»¶ï¼Œå°‡ä¾è³´æ€§é—œä¿‚ä¾ç…§å±¤æ¬¡çµæ§‹çµ„ç¹” (ç©©å®šçš„çµ„ä»¶ä¸è¦ç›¸ä¾æ–¼ä¸ç©©å®šçš„çµ„ä»¶)ï¼Œå¥—ç”¨åˆ°æ¶æ§‹è¨­è¨ˆä¹Ÿæ˜¯å¦‚æ­¤ (Clean Architecture)\nOCP ä¹Ÿæ˜¯ä¸€å€‹å¾ˆå¥½çµåˆ Design Pattern çš„åŸå‰‡\nä¾è³´åè½‰åŸå‰‡ æ–°æå‡ºçš„è¨­è¨ˆæ¶æ§‹ï¼Œæœƒåˆ†å±¤ä¸åŒçš„æ¥­å‹™ ä¾‹å¦‚ç¶²é æ“ä½œæœƒå¾ web ui å±¤ =\u0026gt; controller æ¥­å‹™é‚è¼¯ =\u0026gt; å„²å­˜åˆ° db å±¤å†åŸè·¯è¿”å›çµ¦ clientï¼Œå¯«ç¨‹å¼æ™‚å¦‚æœæŒ‰ç…§é€™æ¨£çš„é †åºï¼Œæœ‰å¯èƒ½ç™¼ç”Ÿé«˜éšçµ„ä»¶ä¾è³´ä½éšçµ„ä»¶ï¼Œä¾‹å¦‚å®¢æˆ¶åŒ¯å‡ºé›²ç«¯ç™¼ç¥¨æœƒå„²å­˜æ–¼ S3ï¼Œé‚£æˆ‘å€‘å¾ˆå®¹æ˜“æŠŠ s3 ä¸Šå‚³é‚è¼¯å¯«æ­»é›²ç«¯ç™¼ç¥¨çš„æ¥­å‹™é‚è¼¯ä¸­ï¼Œä½†å¦‚æœ s3 sdk å‡ç´šæ€éº¼è¾¦ï¼Ÿ\nä»”ç´°æƒ³æƒ³ã€Œç™¼ç¥¨åŒ¯å‡ºã€çš„æ¥­å‹™éœ€æ±‚è·Ÿã€Œå¯¦éš›ä½¿ç”¨å“ªä¸€é–“é›²æœå‹™ã€æœ‰é—œä¿‚å—ï¼Ÿ æ‰€ä»¥éœ€è¦ä¸€å€‹ å½ˆæ€§çµ„ç¹”çµ„ä»¶çš„ä¾è³´ ï¼Œå°‡èƒ½åŠ›æŠ½è±¡åŒ–å‡ºæ¥­å‹™è¦å‰‡ï¼Œæ˜ç¢ºå®šç¾©å‡ºä»‹é¢æ–¹æ³•\nå°çµ ç‚ºäº†é”æˆ OCP æ•ˆæœï¼Œéœ€è¦åšçµ„ä»¶çš„åˆ‡ç‰‡çš„æ–¹å¼ èˆ‡ å½ˆæ€§èª¿æ•´çµ„ä»¶ä¾è³´é—œä¿‚çš„æ–¹æ³• ç¨‹å¼ç¢¼ä¾è³´é—œä¿‚æ‡‰å¤šä½¿ç”¨ä»‹é¢ï¼Œè€Œéå…·é«”å¯¦ç¾ é‡Œæ°æ›¿æ›åŸå‰‡ 70 å¹´ä»£è»Ÿé«”è¶Šä¾†è¶Šå¤§ï¼Œé–‹ç™¼çš„æˆæœ¬è¶Šä¾†è¶Šé«˜\nâ‡’ åŠ å…¥æµç¨‹æ§åˆ¶ / blocks / subroutines åˆ†è§£å¤šå€‹çµ„ä»¶ (modules)ï¼Œçµ„åˆå‡ºçµæ§‹åŒ–çš„ç³»çµ±\nâ‡’ ç¶“å¸¸æœ‰å¤šå€‹åŠŸèƒ½é¡ä¼¼çš„çµ„ä»¶çµ„ä»¶ï¼Œè®“é€™äº›çµ„ä»¶çµ„ä»¶ä¹‹é–“æœ‰é—œè¯çš„ç‹€æ…‹ï¼Œsmalltalk åŠ å…¥äº† ç¹¼æ‰¿\nâ‡’ Liskov æ–¼ 1987 å¹´ç™¼ç¾ç¹¼æ‰¿æœƒå¸¶ä¾†å¯ç¶­è­·æ€§çš„å•é¡Œ\nâ‡’ B ç¹¼æ‰¿ A -\u0026gt; B is Aï¼Œé€™æ˜¯éå¸¸å¼·çš„è€¦åˆ æ‰€ä»¥ Liskov æ‰æœƒå»ºè­° æ‰€æœ‰ç”¨ A çš„åœ°æ–¹ä¸€å®šè¦å¯ä»¥ç”¨ B\nåœ¨è€ƒæ…®ä»£ç¢¼è¤‡ç”¨ä¸Šï¼Œå„ªå…ˆè€ƒæ…®çµ„åˆï¼Œå¦‚æœçœŸçš„è¦å¤šæ…‹ï¼Œä½¿ç”¨ interface è·Ÿ abstract class æœƒæ˜¯æ›´å¥½çš„çµ„åˆ\næ“´å±•é—¡è¿° æ‰€æœ‰å°æŸå€‹ä»‹é¢ (interface / api)çš„å¯¦ç¾ï¼Œéƒ½å¯ä»¥æ˜¯ä½œç‚ºå°è©²ä»‹é¢çš„ subtypingï¼Œç„¡è«–ä»‹é¢èƒŒå¾Œçš„å¯¦ç¾æ›´å‹•ï¼Œè¡Œç‚ºæ‡‰è©²ä¿æŒè·Ÿç•¶åˆæ‰¿è«¾ä¸€è‡´\napi æœƒä¾ç…§ client ç‰ˆè™Ÿç”¢ç”Ÿä¸åŒçš„è¡Œç‚ºï¼Œé€™æœƒç ´å£ç•¶åˆçš„æ‰¿è«¾ Interface Segregation Robert Martin åƒèˆ‡å°è¡¨æ©Ÿé–‹ç™¼ï¼Œè™•ç†/å°å‡º/è£è¨‚éƒ½æœƒç”¢ç”Ÿä¸€å€‹å°æ‡‰çš„ job é¡åˆ¥ï¼Œéš¨è‘—é–‹ç™¼è¦æ¨¡ï¼ŒJob å…§æœ‰ä¸Šç™¾å€‹ function èˆ‡éœ€æ±‚ï¼Œæ‰€æœ‰çš„æ¥­å‹™é‚è¼¯éƒ½å¼•ç”¨äº† Jobï¼Œåˆ°å¾Œé¢ Job é¡åˆ¥çš„ typo ä¿®æ­£ï¼Œéƒ½æœƒå°è‡´å°ˆæ¡ˆæ•¸å€‹å°æ™‚çš„ç·¨è­¯æ™‚é–“\né–‹ç™¼åªæ”¹åˆ—å°ç›¸é—œçš„åŠŸèƒ½ï¼Œä½†ä»–ä¸çŸ¥é“å…¶ä»–äººæœ‰æ²’æœ‰ä¾è³´é€™å€‹æ–¹æ³•ï¼Œæ‡‰è©²è¦å…·é«”åŠŸèƒ½é¡èˆ‡ Job é¡é€éä»‹é¢åˆ†é›¢ï¼ŒåŠŸèƒ½é¡åªä¾è³´ä»‹é¢ APIï¼Œè®“å¯¦éš›çš„ Job é¡å·¥ä½œé¿å…äº’ç›¸å¹²æ“¾\nç•¶ä¸€å€‹åŠŸèƒ½è±å¯Œçš„ concrete class è¦çµ¦å¤šå€‹èª¿ç”¨æ–¹æä¾›åŠŸèƒ½ï¼Œæ‡‰è©²é€éä»‹é¢æˆ–æŠ½è±¡é¡ä¾†æä¾›çµ¦ ä¸åŒèª¿ç”¨æ–¹ä¸åŒçš„åŠŸèƒ½å¤ éä¸åŒçš„ä»‹é¢éš”é›¢ â‡’ SRP æŒ‡å°çµ„ä»¶çš„è¨­è¨ˆï¼ŒISP ç”¨æ–¼æŒ‡å°ä»‹é¢çš„è¨­è¨ˆ\nä¸æ‡‰è®“å®¢æˆ¶ç«¯çŸ¥é“é¡å¤–çš„åŠŸèƒ½\nç¸½çµ SRP æ˜¯è»Ÿé«”æ¶æ§‹çš„ç†å¿µå‰æï¼Œä¸€å€‹çµ„ä»¶ä¸æ‡‰è©²è¢«å¤šå€‹ä¸ç›¸é—œçš„æ¥­å‹™è€Œé€ æˆè€¦åˆå¸¶ä¾†ç¶­è­·æ€§ä¸Šçš„å•é¡Œ OCP å‰‡æ˜¯è¨­è¨ˆåŸå‰‡çš„æŒ‡å°æ€æƒ³ï¼Œå¯ä»¥é€éè¨­è¨ˆæ¨¡å¼ã€DIP ä¾†é”æˆ DIP æè¿°çµ„ä»¶ä¹‹é–“å¦‚ä½•æŠ½è±¡åŒ–èˆ‡çµ„ç¹”çš„æŒ‡å°æ–¹é‡ LSP ç¢ºä¿ä»‹é¢å¯¦ç¾èˆ‡ä½¿ç”¨æ–¹çš„è€¦åˆï¼Œä¿è­‰ä»‹é¢è¡Œç‚ºçš„ç©©å®š ISP ç¶­è­·èˆ‡ä½¿ç”¨ä¸€å€‹çµ„ä»¶è©²æš´éœ²çš„çŸ¥è­˜ï¼Œåœ¨å¯¦ä½œä¸ŠæŒ‡å°ä»‹é¢è¨­è¨ˆ ç•¶ä¸€å€‹ä»‹é¢å› ç‚ºæ¥­å‹™ A è€Œä¿®æ”¹ï¼Œé‚£æ‡‰è©²ä¹Ÿåªæœ‰æ¥­å‹™ A è¢«å½±éŸ¿åˆ° ","date":"2021-06-15T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-06-15-youtube-%E7%9B%B4%E6%92%ADfred%E8%81%8A%E8%81%8Asolid%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E6%95%B4%E7%90%86/","title":"Youtube ç›´æ’­ã€ŒFredèŠèŠSOLIDè¨­è¨ˆåŸå‰‡ã€æ•´ç†"},{"content":"åœ¨èˆ‡å…¬å¸å‰è¼©è«‹æ•™æ™‚ï¼Œæœ‰èŠåˆ° Mutex , RWMutex æ€§èƒ½å°æ¯”ï¼Œä»¥åŠä½µç™¼ä¸‹ç”¨ SingleFlight é¿å…æ“Šç©¿å•é¡Œï¼Œæ‰€ä»¥å°±èŠ±é»æ™‚é–“çœ‹å¯¦ä½œèˆ‡ç·´ç¿’ï¼Œç™¼ç¾é€™ç³»åˆ—å¯«å¾—å¤ªå¥½äº† 6.2 åŒæ­¥åŸè¯­ä¸é”ï¼Œæ‹œè®€éå¾Œæ•´ç†ä»¥ä¸‹çš„æå•\nMutex å¯¦ä½œ åˆ†æˆå…©ç¨®æ¨¡å¼ï¼šä¸€èˆ¬æ¨¡å¼èˆ‡é£¢é¤“æ¨¡å¼ å–å¾— Lock æ™‚\næ²’æœ‰äººä½”ç”¨å‰‡ç›´æ¥å–å¾— æœ‰äººå ç”¨æ™‚ï¼Œå¦‚æœåˆ¤æ–·æ˜¯å¦èƒ½é€²å…¥è‡ªæ—‹æ¨¡å¼ï¼Œæ‰€è¬‚çš„è‡ªæ—‹æ˜¯é€éæ¶ˆè€— CPU cylcles çš„ buzy waitingï¼Œé™ä½ context switch çš„èŠ±è²» é‡æ–°å˜—è©¦å–å¾—é–ï¼Œå¦‚æœæ²’æœ‰å–å¾—é–ï¼Œç­‰åˆ°æ™‚é–“è¶…é 1ms å‰‡é€²å…¥é£¢é¤“æ¨¡å¼ï¼Œä¸¦ç­‰å¾…ä¿¡è™Ÿ (runtime_SemacquireMutex) RWMutex æœƒç”¢ç”Ÿ Write Starvation å—ï¼Ÿ RWMutex æ¡ç”¨å¯«å…¥å„ªå…ˆï¼Œå¦‚æœåœ¨å–å¾— RWMutex å¯«é–æ™‚ï¼Œç™¼ç¾ç›®å‰æœ‰å¤šå€‹è®€é–\nå…ˆå°‡ readerCount è®Šæˆè² æ•¸ï¼Œè®“å¾ŒçºŒè®€é–éƒ½ç„¡æ³•å–å¾— ç­‰åˆ°ä¿¡è™Ÿ writerSem å–šé†’ è®€é–åœ¨å–å¾—æ™‚\næª¢æŸ¥ readerCount æ˜¯å¦ç‚ºè² æ•¸ï¼Œå¦‚æœæ˜¯ä»£è¡¨æœ‰å¯«é– å¦‚æœæœ‰å¯«é–ï¼Œå‰‡åµè½ readerSem ä¿¡è™Ÿå–šé†’åŸ·è¡Œ åœ¨è§£é™¤å¯«é– / è®€é–ï¼Œæœƒåˆ†åˆ¥å»å‡ºç™¼ä¿¡è™Ÿï¼Œè®“ç­‰å¾…çš„è®€é– / å¯«é–é–‹å§‹åŸ·è¡Œ\nRWMutex è·Ÿ Mutex æ•ˆèƒ½æ¯”è¼ƒ å¯¦éš›æ¸¬è©¦çš„çµæœï¼Œè¨­å®šä¸€å€‹å¯«å…¥æ¯”ç‡ï¼Œå–®ç´”æ¯”è¼ƒå–é–/é‡‹æ”¾é–ï¼Œè·‘ä¸€ç™¾è¬æ¬¡å…©è€…å·®ç•°ä¸å¤§\n1 2 3 4 BenchmarkMutexTest-8 10000000 0.04064 ns/op BenchmarkRWMutexTest BenchmarkRWMutexTest-8 10000000 0.04699 ns/op BenchmarkFakeWrite åŠ å…¥äº†è®€å–è·Ÿå¯«å…¥ï¼Œæœ‰äº›æ¸¬è©¦æœƒç”¨ time.Sleep ï¼Œä½†æˆ‘å¯¦é©—å› ç‚ºåŒæ™‚è·‘ goroutine é—œä¿‚ï¼Œå¦‚æœå…¨éƒ¨ goroutine éƒ½åœ¨ sleep æœƒå‡ºéŒ¯ï¼Œæ‰€ä»¥æ”¹ç”¨ç°¡å–®çš„è¨ˆæ•¸å¾é›¶æ•¸åˆ°ä¸€ç™¾è¬ç•¶ä½œè®€å–ï¼Œè€Œå¯«å…¥å‰‡æ˜¯äº”å€çš„è®€å–æ™‚é–“\nå¯«å…¥æ¯”ä¾‹æŠ“ 0.2 çš„è©±ï¼ŒRWMutex ç”¨èµ·ä¾†æœ‰å„ªå‹¢å¾ˆå¤š\n1 2 3 4 BenchmarkMutexTest BenchmarkMutexTest-8 10000 58176 ns/op BenchmarkRWMutexTest BenchmarkRWMutexTest-8 10000 37176 ns/op æ¸¬è©¦çš„ç¨‹å¼ç¢¼åœ¨æ­¤ go-rwmutex-benchmark\nç¸½çµ\nRWMutex æ¸¬è©¦èµ·ä¾†æ•ˆèƒ½è »å¥½çš„ï¼Œåœ¨è€ƒé‡åˆ°è®€å–æ¯”è¼ƒå¤šçš„æƒ…æ³è¡¨ç¾æœƒæ¯” Mutex é‚„è¦å¥½\nSingleflight ç•¶ Server åœ¨è™•ç†ä½µç™¼æ™‚ï¼Œæœƒé¿å…å¤§é‡é‡è¤‡çš„æŸ¥è©¢æ“ä½œé€²å…¥ DB ä¸­ï¼Œé€™å°¤å…¶æœƒç™¼ç”Ÿåœ¨ Cache å¤±æ•ˆçš„ç•¶ä¸‹ï¼Œæœ€ç†æƒ³ç‹€æ³æ˜¯æ‰€æœ‰åŒæ¨£çš„æŸ¥è©¢åªè¦é€² DB æŸ¥ä¸€æ¬¡ï¼Œå…¶ä»–æŸ¥è©¢ç­‰å¾…è¿”å›ç›¸åŒçš„çµæœ\né€™æ¨£çš„æƒ…å¢ƒå¯ä»¥ä½¿ç”¨ Singleflightï¼Œæä¾›é˜»å¡å…¶é¤˜æŸ¥è©¢ï¼Œåªè®“ä¸€å€‹æŸ¥è©¢ç™¼ç”Ÿçš„æ©Ÿåˆ¶ï¼Œä¸¦å°å¤–é–‹æ”¾ä¸‰å€‹æ–¹æ³•\nDo: ä½¿ç”¨è€…æŒ‡å®š Key èˆ‡å—ä¿è­·çš„æ–¹æ³•ï¼ŒåŒä¸€æ™‚é–“åªæœ‰ä¸€å€‹ä¿è­·æ–¹æ³•æœƒè¢«åŸ·è¡Œï¼Œå…¶é¤˜é€²ä¾†çš„å‘¼å«æœƒç­‰å¾… DoChan: åŒæ–¼ Doï¼Œä½†è¿”å› channelï¼Œå¯ä»¥æ­é… timeout ä½¿ç”¨ Forget: æœ‰æ™‚å€™æœƒå¸Œæœ›ä¸»å‹•è®“ Key ä¸å†ä¿è­·ï¼Œä¾‹å¦‚éäº†æ•¸ç§’ç‚ºäº†é¿å…è®€å–å¤ªèˆŠçš„å€¼ï¼Œå¯ä»¥ä¸»å‹•åˆªé™¤ Key è®“ä¸‹ä¸€å€‹ä¿è­·æ–¹æ³•å¯ä»¥åŸ·è¡Œ (å³ä½¿å‰è€…å°šæœªè¿”å›) æ›´è©³ç´°å…§å®¹å¯åƒè€ƒæ­¤ç¯‡ Go: Avoid duplicate requests with sync/singleflightï¼Œè‡ªå·±å¯«äº†ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ go playground\nSingleflight çš„å¯¦ä½œä¹Ÿååˆ†ç²¾ç·´ï¼Œç”¨ä¸€å€‹ map ä¿å­˜ key å°æ‡‰ structï¼Œstruct è£¡é¢æ”¾ mutext é¿å…åŒæ­¥æ“ä½œ / wg è®“å…¶ä»–å‘¼å«ç™¼ç¾æœ‰äººåœ¨åŸ·è¡Œå°±ä¹–ä¹–ç­‰å¾… ï¼Œå¯åƒè€ƒ golangé˜²ç¼“å­˜å‡»ç©¿åˆ©å™¨\u0026ndash;singleflight\ntypescript å¯¦ä½œ å¾Œä¾†è¦ºå¾—é —æœ‰è¶£å°±è‡ªå·±å¯¦ä½œä¸€å€‹ typescript ç‰ˆæœ¬ï¼šsj82516/go-singleflightï¼ŒåŸæœ¬æƒ³è¦å¤šä¸€å€‹å„²å­˜çš„ adpter æ”¯æ´ redisï¼Œä½†å¡åœ¨ Object / Error è¦å¦‚ä½• serialize / deserialize å°±å…ˆä¸­æ­¢äº†\nGo Assembler å¾€ä¸‹è¿½ \u0026quot;sync/atomic\u0026quot; ç™¼ç¾æ²’æœ‰ç›¸é—œçš„ CompareAndSwapInt32 çš„ç¨‹å¼ç¢¼ï¼Œé€™æ˜¯å› ç‚ºé€™äº›éƒ¨åˆ†æ˜¯åœ¨ runtime ç”¢ç”Ÿï¼Œatomic æŒ‡ä»¤å¿…é ˆç”± CPU æä¾›æ‰èƒ½ä¿è­‰åŸ·è¡Œæ™‚çš„åŸå­æ€§ï¼Œè€ŒæŒ‡ä»¤å‰‡æ˜¯å„å¹³å°é™å®šï¼Œå¦‚ x86 / x64 / arm 32 / arm 64 / powerpc ç­‰ç­‰ï¼Œé€™åœ¨ç·¨è­¯çš„æ™‚å€™å¯ä»¥é€é GOARCH / GOOS æŒ‡å®šç·¨è­¯çš„å¹³å°\nè£œå……è³‡æ–™å¯ä»¥åƒè€ƒ\né«˜éšèªè¨€å¦‚ä½•è®Šæˆæ©Ÿå™¨å¯åŸ·è¡Œçš„ä½å…ƒæª”ï¼šCompiling, assembling, and linking GopherCon 2016: Rob Pike - The Design of the Go Assembler / æ–‡å­—èªªæ˜ Go Tools: The Compiler â€” Part 1 Assembly Language and Go Rob Pike èªªæ˜ä¸€é–‹å§‹ Go çš„åŸå§‹ç¢¼æœ‰ä½¿ç”¨ C/Yaac å®Œæˆç·¨è­¯çš„æ–¹å¼ï¼Œä½†å› ç‚ºé›£ç®¡ç†å¾Œä¾†åœ¨ Go 1.3 é–‹å§‹æ±°æ›æˆ Go å¯¦ä½œ\né€™é‚Šå¯¦ä½œæœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼ Rob Pike è¡¨ç¤ºé›–ç„¶æ¯å€‹å¹³å°çš„æŒ‡ä»¤/æš«å­˜å™¨åç¨±éƒ½ä¸åŒï¼Œä½†æ˜¯åŸºæœ¬çš„ä½¿ç”¨å¯ä»¥è¢«æŠ½è±¡åŒ–ï¼Œæ‰€ä»¥ Go Compiler æœƒç·¨è­¯å‡º semi pseudo codeï¼Œæ¥è‘—ä¾ç…§æŒ‡å®šçš„å¹³å°è½‰æ›æˆå°æ‡‰çš„ assembly codeï¼Œé€™éƒ¨åˆ†å¯¦ä½œäº† obj library\né€™æ¨£çš„å¥½è™•æ˜¯å°æ–¼ Compiler ä¾†èªªç”¢ç”Ÿ semi pseudo code å°±æ˜¯å–®ç´”çš„æ–‡å­—è½‰æ›\nåœ¨å½±ç‰‡ä¸­çš„ç¯„ä¾‹\n1 2 3 4 5 6 7 8 9 ADDW AX, BX ----- \u0026amp;obj.Prod{ As: arch.Instructions[\u0026#34;ADDW\u0026#34;], From: obj.Addr{Reg: arch.Register[\u0026#34;AX\u0026#34;]}, To: obj.Addr{Reg: arch.Register[\u0026#34;BX\u0026#34;]} } æœ€å¾Œæåˆ°ä»–å€‘åœ¨é–‹ç™¼å·¥å…·ï¼Œç›´æ¥è®€ PDF ç”¢ç”Ÿå„å¹³å°å°æ‡‰çš„ instruction set åœ¨æ€è€ƒçš„éç¨‹ä¸­ï¼Œé–‹å§‹æƒ³ assembly å¤¾åœ¨ source code / machine code çš„åœ°ä½ï¼Œé€™ä¸€ç¯‡ SO çµ¦å‡ºäº†å›ç­” Why do we even need assembler when we have compiler?\næ­£å¦‚åŒå¤¾åœ¨ä¸­é–“çš„åœ°ä½ï¼Œmachine code äººé¡ç„¡æ³•è®€ï¼Œsource code åˆå¤ª high levelï¼Œå¦‚æœè¦ç¢ºèª compiler æ˜¯å¦ç·¨è­¯å‡ºæœ‰æ•ˆçš„ machine codeï¼Œé‚£æŸ¥çœ‹ assembly çœ‹å¯¦éš›äººé¡å¯è®€çš„æŒ‡ä»¤æ˜¯æœ€å¥½çš„\nGo ç·¨è­¯éç¨‹å¯åƒè€ƒ Go è¯­è¨€è®¾è®¡ä¸å®ç° å­˜åƒå€‹åœ¨ SO ä¸Šè¢«æ‰£åˆ†çš„ç™¼å• Why assembly is unportableï¼Œcomment æœ‰å¾ˆå¤šè§£é‡‹ä¹‹å¾Œæ…¢æ…¢ç´°è®€å†è£œå……\n","date":"2021-06-06T01:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-06-06-golang-%E4%BD%B5%E7%99%BC%E8%99%95%E7%90%86-mutex-/-rwmutex-/-singleflight/","title":"Golang ä½µç™¼è™•ç† Mutex / RWMutex / SingleFlight"},{"content":"å››å¹´å‰æ›¾ç¶“å°æ–¼ WebRTC æä¾› P2P å½±éŸ³ä¸²æµæ„Ÿåˆ°æ–°å¥‡ï¼Œå¯«ä¸‹äº† WebRTC-ä»‹ç´¹èˆ‡å¯¦æˆ°ï¼›\nå¾Œä¾†åœ¨å·¥ä½œä¸­ï¼Œé–‹å§‹æ›´æ·±å…¥ä½¿ç”¨ WebRTCï¼Œä¹Ÿé–‹å§‹è‡ªæ¶ TURN Serverï¼Œå¾ Spec è§’åº¦èªè­˜äº†\nSDP Spec é–±è®€ç­†è¨˜ RFC 5389 - STUN å”å®šä»‹ç´¹\nCoturn Server æ¶è¨­æ•™å­¸ - on AWS\nåªæ˜¯ä½¿ç”¨ä¸Šæˆ–ç†è§£ä¸Šï¼Œå§‹çµ‚åœç•™æ–¼æ¯”è¼ƒè¡¨å±¤çš„ SDK API å‘¼å«æˆ–æ˜¯æ–‡ä»¶é–±è®€ï¼Œè€Œæ²’æœ‰çœŸæ­£å¾å¤§æ–¹å‘ç†è§£ï¼Œæ±ºå®šå¾ WebRTC For The Curious æ·±å…¥ç†è§£ WebRTC çš„åŸç†èˆ‡ç´°ç¯€\næœ¬ç¯‡æ–‡ç« å…§å®¹æœƒæ¶µè“‹\nWebRTC åˆ°åº•æ˜¯ä»€éº¼ WebRTC çš„é€£ç·šç”±å§‹è€Œçµ‚çš„æµç¨‹ ä»€éº¼æ˜¯ WebRTC ä»¥ä¸‹å…§å®¹ç†è§£è‡ª WebRTC For The Curious\nWebRTC æ˜¯ Web Real-Time Communication ç¸®å¯«ï¼Œæœ¬èº«æ˜¯ API ä¹Ÿæ˜¯ Protocolï¼Œä¸»è¦æ˜¯å¯ä»¥è®“å…©å€‹ WebRTC Agent å»ºç«‹ å³æ™‚ã€é›™å‘ã€å®‰å…¨çš„ä¸²æµï¼ŒWebRTC API å‰‡æ˜¯éµå®ˆ Protocol å®šç¾©æ‰€æä¾›çš„å¯¦ä½œï¼Œç›®å‰å¤šå®¶ç€è¦½å™¨éƒ½æœ‰å¯¦ä½œ WebRTC APIï¼Œä¹Ÿæœ‰é Javascript çš„ WebRTC API å¯¦ä½œ\nWebRTC protocol æœ¬èº«åªæ˜¯é›†åˆäº†å¤šå€‹å·²çŸ¥ã€ç©©å®šçš„å”å®šè€Œæä¾›çš„å®Œæ•´è§£æ±ºæ–¹æ¡ˆï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ­¥é©Ÿ\nä¸€. Signaling ç•¶å…©å€‹ Agent è¦äº’ç›¸æºé€šæ™‚ï¼Œä»–å€‘ä¸çŸ¥é“å½¼æ­¤çš„ä½ç½®ã€å½¼æ­¤æ”¯æ´çš„å½±éŸ³ç‰ˆæœ¬ç­‰ç­‰ï¼Œæ­¤æ™‚æœƒéœ€è¦ SDP æè¿°é›™æ–¹ç‹€æ…‹ï¼Œä¸¦é€éç®¡é“æºé€šï¼ŒSDP æ˜¯ä¸€å€‹ç”± Key-Pair çµ„æˆçš„æ–‡æœ¬å”å®šï¼Œåªè¦åŒ…å«ä»¥ä¸‹å¹¾å€‹é …ç›®ï¼š\nIP/Port (Candidate) Agent é æœŸæœ‰å¹¾å€‹ Audio/Video Track Audio/Video codec æ”¯æ´ é€£ç·šè³‡è¨Š (å¦‚ Frag ç­‰) å®‰å…¨æ€§è³‡è¨Š (å¦‚ Fingerprint ç­‰) éœ€æ³¨æ„å¦‚ä½•äº¤æ› SDP ä¸å† WebRTC å®šç¾©ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„å”å®šå¦‚ HTTP / Websocket / XMPP ç­‰ï¼Œåªè¦ Agent ä¹‹é–“èƒ½å¤ äº¤æ›å³å¯\näºŒ. Connecting WebRTC Agent è¦æº–å‚™å»ºç«‹é€£ç·šæ™‚ï¼Œæœƒé€é ICE (Interactive Connectivity Establishment)ï¼ŒAgent æœ¬èº«å¯èƒ½åœ¨åŒå€‹ Local å€ç¶²ä¸‹ï¼Œä¹Ÿå¯èƒ½åœ¨ä¸–ç•Œçš„å…©ç«¯ï¼Œé€é ICE æ‰¾å‡ºå…©å€‹ Agent èƒ½å¤ ç›´æ¥é€£ç·šçš„æ–¹å¼ï¼Œé€™èƒŒå¾Œéš±è—äº† NAT Traversal èˆ‡ STUN/TURN ç´°ç¯€ï¼Œæœƒåœ¨å¾ŒçºŒä»‹ç´¹\nä¸‰. Security å»ºç«‹é›™å‘é€£ç·šå¾Œï¼ŒWebRTC æœƒåœ¨å¢åŠ é€£ç·šçš„å®‰å…¨æ€§ï¼Œé€é DTLS (Datagram Transport Layer Security) UDP over TLS èˆ‡ SRTP (Secure Real-time Transport Protocol)\nDTLS ä¸»è¦ç”¨æ–¼ Data Channelï¼ŒWebRTC é€é DTLS äº¤æ¡å»ºç«‹å®‰å…¨é€£ç·šï¼Œå…¶ä¸­ TLS é©—è­‰éƒ¨åˆ†ç•¥èˆ‡ HTTPS éç¨‹ä¸åŒï¼Œåœ¨ WebRTC ä¸­æ²’æœ‰å»å‘ CA é©—è­‰æ†‘è­‰ï¼Œè€Œæ˜¯é€éå…ˆå‰ Signaling äº¤æ›çš„ fingerprint æª¢æŸ¥\nè€Œ Audio/Video ä¸²æµå‰‡æ˜¯é€é RTPï¼Œç‚ºäº†å¤šç–ŠåŠ ä¸€å±¤å®‰å…¨æ€§æ¡ç”¨ SRTP å‚³è¼¸ RTP å…§å®¹ï¼Œæ‰€æ¡ç”¨çš„åŠ å¯†é‡‘é‘°å‰‡æ˜¯é€é Data Channel æ‰€äº¤æ›\nç›®å‰å°±æˆåŠŸå»ºç«‹é›™å‘ã€å®‰å…¨çš„é€£ç·šå¾Œï¼Œä½†æ˜¯å½±éŸ³ä¸²æµé‚„å¿…é ˆè€ƒé‡åˆ°ç¶²è·¯ç‹€æ³ï¼Œå¦‚å°åŒ…éºå¤±ã€é »å¯¬é™åˆ¶ç­‰å•é¡Œ\nå››. Communicating æ¡ç”¨ SCTP (Stream Control Transmission Protocol) åšå‚³è¼¸ç‹€æ³çš„ç›£æ§ã€æµé‡ç®¡åˆ¶ï¼Œå¯¦éš›ä¸Š SCTP çš„å°åŒ…æ˜¯é€é Data Channel èµ° DTLS\nå…¨éƒ¨ç¸½çµï¼ŒWebRTC å°±æ˜¯ç”±é€™äº›å”å®šæ‰€é›†çµè€Œæˆçš„ WebRTC API å¿«é€Ÿéä¸€ä¸‹ API è¨­è¨ˆ\n1. new PeerConnection å»ºç«‹ WebRTC Sessionï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°çš„æ‰€æœ‰ Protocol é›†åˆ\n2. addTrack å»ºç«‹ RTP Streamï¼Œä¸¦ç¶å®šä¸€å€‹éš¨æ©Ÿç”¢ç”Ÿçš„ SSRCï¼Œä¹‹å¾Œåœ¨ createOffer æ™‚æœƒå¸¶åœ¨ SDP ç•¶ä¸­ä¸¦å»ºç«‹å°æ‡‰çš„ media sessionï¼Œæ¯ç•¶ addTrack ä¸€æ¬¡éƒ½æœƒå»ºç«‹æ–°çš„ RTP Stream\nåªè¦ ICE å¾ŒæˆåŠŸå»ºç«‹ SRTP é€£ç·šï¼Œmedia packets å°±æœƒé¦¬ä¸Šå‚³é€å‡ºå»\n3. createDataChannel å¦‚æœ SCTP é€£ç·šé‚„æ²’å»ºç«‹å‰‡æ–°å»ºç«‹ä¸€å€‹ï¼Œé è¨­åªæœ‰åœ¨æŸä¸€æ–¹è¦æ±‚ data channel æ‰æœƒå»ºç«‹\nç•¶ DTLS æˆåŠŸå»ºç«‹é€£ç·šå¾Œï¼ŒSCTP packets å°±æœƒé–‹å§‹å‚³é€\n4. createOffer å»ºç«‹ local SDP\n5. setLocalDescription å…ˆå‰çš„ addTrack / createDataChannel åªæ˜¯æš«æ™‚æ€§çš„ï¼Œåªæœ‰ç•¶å‘¼å« setLocalDescription æ‰ç¢ºå®šå¥—ç”¨ä¿®æ”¹\né€šå¸¸å‘¼å« setLocalDescription å°±æœƒå‚³é€ offer è®“å°æ–¹ setRemoteDescription\n6. setRemoteDescription setRemoteDescription é€šçŸ¥ local agent å°æ–¹çš„ candidate ç‹€æ…‹ï¼Œå¦‚æœé›™æ–¹éƒ½ setRemoteDescriptionå°±å¯ä»¥é–‹å§‹ connecting\n7. addIceCandidate é€šçŸ¥ WebRTC Agent å¢åŠ  remote ICE candidate\n8. ontrack ç•¶ RTP stream æ¥æ”¶åˆ°å°åŒ…æ™‚è§¸ç™¼äº‹ä»¶ï¼Œå°åŒ…æ‡‰è©²æœƒå»åˆ setRemoteDescription æ™‚æŒ‡å®šçš„æ ¼å¼\nWebRTC æœƒé€é SSRC ç¢ºèªå°æ‡‰çš„ Media Stream\n9. oniceconnectionstatechange å¦‚æœ ICE Agent æœ‰ç•°å‹•æœƒè§¸ç™¼äº‹ä»¶ï¼Œåƒæ˜¯é‡åˆ°ç¶²è·¯ç‹€æ³ç­‰\n10. onstatechange ICE Agent / DTLS Agent ç‹€æ…‹ç•°å‹•æ™‚æœƒè§¸ç™¼äº‹ä»¶\nä¸€. Signaling WebRTC Agent ä¸€é–‹å§‹å»ºç«‹æ™‚ä¸¦ä¸çŸ¥é“è©²èˆ‡èª°é€šè¨Šã€ä¹Ÿä¸çŸ¥é“è©²ç”¨ä»€éº¼æ ¼å¼ï¼Œæ‰€ä»¥æœƒéœ€è¦åœ¨åˆå§‹åŒ–æ™‚åš Signalingï¼Œè®“å¾ŒçºŒçš„é€£ç·šæœ‰æ©Ÿæœƒç™¼ç”Ÿ\nWebRTC ä¸¦æ²’æœ‰ç¡¬æ€§è¦å®š Signaling å‚³è¼¸çš„æ©Ÿåˆ¶ï¼Œå¸¸è¦‹åšæ³•æ˜¯é€é Websocket\nä»€éº¼æ˜¯ SDP WebRTC ä»°è³´ SDP äº¤æ›å»ºç«‹é€£ç·šæ‰€éœ€çš„è³‡è¨Šï¼ŒSDP æœ¬èº«ç›¸ç•¶å¥½ç†è§£ï¼Œåªæ˜¯è¦å»ç†è§£ WebRTC è‡ªå®šç¾©çš„åƒæ•¸èˆ‡ä»£è¡¨å€¼\nSDP å®šç¾©åœ¨ RFC4566ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€å€‹ key / value çµ„åˆï¼Œä¸€ä»½ SDP ä¸­å¯ä»¥åŒ…å«å¤šå€‹ Media Descriptionï¼Œè€Œä¸€å€‹ Media Description é€šå¸¸ä»£è¡¨ä¸€å€‹ Media Stream\nä¾‹å¦‚èªªä¸€å€‹å½±ç‰‡æœ‰å…©å€‹ Video Stream å¤–åŠ ä¸‰å€‹ Audio Streamï¼Œé‚£å°±éœ€è¦äº”å€‹ Media Description æè¿°\nå¦‚ä½•è§£è®€ SDP SDP æ ¼å¼ç‚º k=valueï¼Œéµé€šå¸¸æ˜¯ä¸€å€‹è‹±æ–‡å­—æ¯ä»£è¡¨ï¼Œç­‰è™Ÿå¾Œé€£æ¥å€¼ï¼Œä»¥ä¸‹æ˜¯å®šç¾©çš„å¹¾å€‹éµ\nv: Versionï¼Œä»£è¡¨ç‰ˆæœ¬ o: Originï¼Œé€šå¸¸ä»£è¡¨ id ç”¨ä»¥è­˜åˆ¥ s: Session åç¨± t: Timingï¼Œé€šå¸¸æ˜¯ 0 0 m: Media Description a: Attribute æœ€å¸¸è¦‹çš„éµ c: Connectionï¼Œé€šå¸¸æ˜¯ IN IP4 0.0.0.0 Media Description ä¸€å€‹ Session Description é€šå¸¸åŒ…å«å¤šå€‹ Media Descriptionï¼Œè€Œ Media Description å‰‡ç”±ä¸€é€£ä¸²çš„ RTP Payload çš„æ ¼å¼å®šç¾©ï¼Œå¯¦éš›çš„ codec æœƒä»¥ rtpmap è¡¨ç¤º å¦‚ä»¥ä¸‹\n1 2 3 4 5 6 v=0 m=audio 4000 RTP/AVP 111 a=rtpmap:111 OPUS/48000/2 m=video 4000 RTP/AVP 96 a=rtpmap:96 VP8/90000 a=my-sdp-value é€™è£¡å®šç¾©å…©å€‹ Media Description\nä¸€å€‹æ˜¯ audio å¸¶è‘— fmt 111ï¼Œä¸¦æŒ‡å®š codec ç‚º OPUS å¦ä¸€å€‹æ˜¯ video å¸¶è‘— fmt 96ï¼Œcodec ç‚º VP8ï¼Œä¸¦å¸¶è‘—ç¬¬äºŒå€‹å±¬æ€§å€¼ç‚º my-sdp-value\nWebRTC å¦‚ä½•åˆ©ç”¨ SDP æ¥è‘—è«‡åˆ° WebRTC å¦‚ä½•ä½¿ç”¨ SDP çš„æ ¼å¼ï¼ŒWebRTC æ¡ç”¨ Offer / Answer æ¶æ§‹ï¼Œä¸€æ–¹ Agent å…ˆä¸»å‹•æä¾› Offerï¼Œå¦ä¸€æ–¹å†æ±ºå®šæ˜¯å¦æ¥å—ï¼Œä¸¦å›æ‡‰ Answer ç¢ºå®š codec ç­‰\nTransceivers Transceiver æŒ‡å®š Media å‚³è¼¸çš„æ–¹å‘ï¼Œä¾‹å¦‚èªªå¯ä»¥æŒ‡å®šã€Œæˆ‘è¦ç”¨é€™å€‹æ ¼å¼ç™¼é€ã€ã€Œæˆ‘è¦ç”¨é€™å€‹æ ¼å¼æ¥æ”¶è€Œä¸”æˆ‘ä¸æƒ³è¦æ”¶åˆ°ä»»ä½•è³‡æ–™ã€ç­‰ï¼Œä¸»è¦æœ‰å››å€‹å€¼\nsend recv sendrecv inactive\næ¯ç”¢ç”Ÿä¸€å€‹ Transceiver å°±æœƒå°æ‡‰æœ‰ä¸€å€‹ Media Descriptionï¼Œä¸¦å¸¶æœ‰ä¸€å€‹ attribute æè¿°å¦‚ a=sendrecv å…¶é¤˜å¸¸è¦‹å±¬æ€§ group:BUNDLE:\næœ‰äº› WebRTC Agent æœƒåœ¨ä¸€å€‹ connection ä¸Šå‚³è¼¸å¤šç¨®é¡å‹çš„ media stream\nfingerprint:sha-256:\nDTLS è¦ç”¨åˆ°çš„æ†‘è­‰ sha 256 å€¼ï¼Œç”¨ä¾†æ¯”å°æ†‘è­‰çš„æ­£ç¢ºæ€§\nsetup:\næ±ºå®š DTLS Agent åœ¨ ICE é€£ç·šå»ºç«‹å¾Œçš„è¡Œç‚º\nice-ufrag: ICE Agent çš„ user fragmentï¼Œç”¨ä¾†é©—è­‰èº«ä»½\nice-pwd: åŒé©—è­‰èº«ä»½ä½¿ç”¨\nrtpmap: æŒ‡å RTP Payload çš„ codec\nfmtp: Payload é¡å¤–å±¬æ€§è³ªï¼Œä¾‹å¦‚ video encoding æ–¹å¼ç­‰ç´°ç¯€\ncandidate: ICE candidateï¼Œä¾›å¾ŒçºŒ ICE Agent å»ºç«‹é€£ç·šä½¿ç”¨\nssrc: Media Stream çš„ ID\nç¯„ä¾‹ SDP å¯ä»¥åœ¨é€™é‚Šç”¢ç”Ÿ WebRTC samples Munge SDP\näºŒ. Connecting ä¸Šä¸€æ­¥ Signaling äº¤æ›å®Œé€£ç·šè³‡è¨Šï¼Œæ¥è‘—å°±è¦å»ºç«‹é›™æ–¹ P2P é€£ç·šï¼Œä½†ç¾å¯¦çš„ç¶²è·¯ä¸–ç•Œåœ¨æœ‰ä¸åŒç¨®çš„ NAT å­˜åœ¨ï¼Œä½¿å¾—å»ºç«‹é€£ç·šæ™‚æœƒæœ‰ä¸€äº›é˜»ç¤™ï¼Œç‚ºäº†å…‹æœè¡ç”Ÿå‡ºäº† NAT ç©¿è¶Šæ©Ÿåˆ¶ Interactive Connectivity Establishment (ICE)\nNAT ç¨®é¡ NAT æ˜¯åœ¨ä¸€å€‹å€åŸŸç¶²è·¯ä¸‹ï¼Œç”±çµ±ä¸€çš„å°å¤–è·¯ç”±å™¨å…±ç”¨ public ipï¼Œè€Œå…§éƒ¨çš„æ©Ÿå™¨å‰‡ä½¿ç”¨ private ipï¼Œå¦‚æœå…§éƒ¨æ©Ÿå™¨éœ€è¦èˆ‡å¤–éƒ¨ç¶²è·¯æºé€šï¼Œå‰‡é€éè·¯ç”±å™¨æ”¶ç™¼ï¼Œè·¯ç”±å™¨æœƒè¨˜ä½å“ªäº›å°åŒ…è¦è½‰é€åˆ°å°æ‡‰çš„å…§éƒ¨æ©Ÿå™¨ï¼›\nä¸è«–æ˜¯å› æ‡‰ IPv4 ä½ç½®ä¸å¤ ç”¨ï¼Œåˆæˆ–æ˜¯å®‰å…¨æ€§è€ƒé‡ï¼ŒNAT æ™®éå­˜åœ¨æ–¼ç¾ä»Šçš„ç¶²è·¯ç’°å¢ƒä¸‹\n*åœ–ç‰‡ä¾†è‡ª webrtcforthecurious\nè€Œè·¯ç”±å™¨é‡å°å°åŒ…çš„ç™¼é€æœƒæœ‰ä¸åŒçš„å°æ‡‰ç”¢ç”Ÿï¼Œå‡è¨­ Machine A å‘ public Host 1 ç™¼é€è«‹æ±‚ï¼Œå‰‡æœƒåœ¨è·¯ç”±å™¨è¨»å†Šä¸€å€‹ Mapping\n1. Endpoint-Independent Mapping å¦‚æœ Machine A è¦å‘ public Host 2 ç™¼é€è«‹æ±‚ï¼Œå‰‡å¯ä»¥å¾©ç”¨åŒä¸€å€‹ Mapping\n2. Address Dependent Mapping å¦‚æœ Machine A è¦å‘ public Host 2 ç™¼é€è«‹æ±‚ï¼Œå‰‡æœƒç”¢ç”Ÿæ–°çš„ Mapping\n3. Address and Port Dependent Mapping å¦‚æœ Machine A è¦å‘ public Host 1 ä½†æ˜¯ä¸åŒçš„ port ç™¼é€è«‹æ±‚ï¼Œå‰‡æœƒç”¢ç”Ÿæ–°çš„ Mapping\né‡å°å¤–éƒ¨å°åŒ…çš„æ¥æ”¶æœƒæœ‰ä¸åŒçš„é™åˆ¶\n4. Endpoint-Independent Filtering ä»»ä½• public Host éƒ½å¯ä»¥å°åŒä¸€å€‹ Mapping é€å°åŒ…çµ¦ Machine A\n5. Address Dependent Filtering åªæœ‰ Machine A å…ˆé€é public Host 1ï¼Œå‰‡ public Host 1 æ‰å¯ä»¥é€éæ­¤ Mapping é€å°åŒ…çµ¦ Machine A\n6. Address and Port Dependent Filtering åªæœ‰ Machine A å…ˆé€é public Host 1 + port 1ï¼Œå‰‡ public Host 1 + port 1 æ‰å¯ä»¥é€éæ­¤ Mapping é€å°åŒ…çµ¦ Machine A\nå°çµï¼Œå¯ä»¥çœ‹åˆ° NAT é™åˆ¶ç”±ä¸Šå¾€ä¸‹è¶Šä¾†è¶Šåš´è¬¹ï¼Œä¸€é–‹å§‹ä»»ä½• public ip éƒ½å¯ä»¥é€ï¼Œæ¥è‘—é™åˆ¶ ip addressï¼Œæœ€åš´æ ¼æ˜¯è¦ ip address + port éƒ½å»åˆæ‰å¯ä»¥é€\nèªªå®Œäº† NAT ç¨®é¡ï¼Œä½†é€™äº›ç¨®é¡æœƒæ€éº¼å½±éŸ¿ P2P é€£ç·šå‘¢ï¼Ÿ\nSTUN å¦‚æœä»Šå¤©å…©å€‹ webrtc client éƒ½åœ¨ NAT ä¹‹å¾Œï¼Œé‚£è¦å»ºç«‹é€£ç·šå°±å¿…é ˆå…ˆçŸ¥é“ è‡ªå·±çš„ public IPï¼Œé€™ä¹Ÿæ˜¯ STUN å”å®š æ‰€åšçš„äº‹æƒ…ï¼Œè®“ client å¯ä»¥çŸ¥é“ NAT Mapping å°å¤–çš„ public IP\nè©¦æƒ³ä»¥ä¸‹æƒ…å¢ƒ\nclient A / client B éƒ½åœ¨å„è‡ªçš„ NAT ä¹‹å¾Œï¼Œä»–å€‘æƒ³è¦å»ºç«‹ P2P é€£ç·š client A / client B æ­¤æ™‚ä¸çŸ¥é“è‡ªå·±çš„ public IP client A / client B åˆ†åˆ¥å‘ STUN Server(æœ‰å›ºå®š public IP) ç™¼å‡ºè«‹æ±‚ï¼Œæ­¤æ™‚ NAT ä¸Šæœƒå»ºç«‹ Mapping + client A / client B å–å¾— public IP äº¤æ› å¦‚æœ NAT æ˜¯å±¬æ–¼ Endpoint-Independent Mapping + Endpoint-Independent Filteringï¼Œå‰‡ client A / client B é€é SDP äº¤æ›è³‡è¨Šå¾Œï¼Œå°±å¯ä»¥å»ºç«‹é›™å‘é€£ç·šäº† åæ€å¦‚æœ NAT æ˜¯ Address Dependent Mapping + Address Dependent Filteringï¼Œé€é STUN ä¹‹å¾Œ client A / B å¯ä»¥ç›´æ¥é€£ç·šå—ï¼Ÿ\nç­”æ¡ˆæ˜¯ä¸è¡Œçš„å–”ï¼Œå› ç‚º client A å»ºç«‹äº†èˆ‡ STUN server çš„ NAT Mapping åªèƒ½å…©è€…ç”¨ï¼Œclient B æƒ³è¦é€å°åŒ…çµ¦ client A å°±æœƒè¢«æ“‹ä¸‹ä¾†\nTURN é‡åˆ° STUN server ç„¡æ³•ç”¨ï¼Œæ¥è‘—å°±è¦ç”¨ TURNï¼ŒTURN server æœƒå±…ä¸­ï¼Œæ‰€æœ‰çš„å°åŒ…éƒ½é€é TURN server è½‰ç™¼ï¼Œä½†é€™æ¨£ä¹Ÿå°±ä¸æ˜¯ P2P é€£ç·šäº†\nTURN çš„é‹ä½œæ©Ÿåˆ¶å»ºç«‹æ–¼ STUN ä¹‹ä¸Šï¼Œæ“´å…… STUN å°åŒ…çš„æ ¼å¼ï¼Œæµç¨‹å¤§æ¦‚æ˜¯\nclient A å»ºç«‹ Allocationï¼ŒTURN server æœƒä¿ç•™ä¸€å€‹ port çµ¦ client Aï¼Œä¸¦å›å‚³ Relayed Transport Addressï¼Œå¯ä»¥æƒ³åƒæˆæ¬é€²æ–°å¤§æ¨“æ™‚ä¸€æ¨“ä¿¡ç®±æœ‰ä¸€å€‹æ ¼å­å°ˆå±¬æ–¼ä½ çš„ï¼Œæ‰€ä»¥å¯„ä¿¡åˆ°é€™å€‹æ ¼å­çš„è³‡æ–™éƒ½æ˜¯è¦çµ¦ä½ çš„ ç•¶ WebRTC åœ¨äº¤æ› SDP æ™‚å°‡ Relayed Transport Address çµ¦å°æ–¹ ç‚ºäº†é¿å…å…¶ä»–äººäº‚å¯„è³‡æ–™ï¼Œclient å¿…é ˆåœ¨ Relay Server å¹«å°æ–¹å¢åŠ  Permission Allocation / Permission éƒ½æœ‰æ™‚é–“é™åˆ¶(LIFETIMEåƒæ•¸æ§åˆ¶)ï¼Œå¯ä»¥å¾ŒçºŒ Refresh å¦å¤–ä¸€ç¨®å°æ–¼ NAT çš„åˆ†é¡ (éŒå½¢ã€å°ç¨±å‹) é“ç†ä¹Ÿæ˜¯é¡ä¼¼ï¼ŒPeer A è¨»å†Šçš„ Mapping è¦åœ¨ä»€éº¼æƒ…æ³ä¸‹ Peer B å¯ä»¥ç›´æ¥æ‹¿ä¾†ç”¨ï¼Œå¦‚æœä¸è¡Œ (å°ç¨±å‹) å°±è¦èµ° TURN Serverï¼Œå¯åƒè€ƒ 30-28ä¹‹ WebRTC é€£ç·šå‰å‚³ - ç‚ºä»€éº¼ P2P é€£ç·šå¾ˆéº»ç…© ? ( NAT ) ICE çµåˆä»¥ä¸Šçš„é€£ç·šæ–¹æ³•ï¼Œå°±çµ„åˆæˆ ICE protocolï¼Œæ¯å€‹ ICE Agent æœƒåˆ†æˆ Controlling / Controlledï¼Œæœ‰ä¸€æ–¹ä¸»å°é€£ç·šéç¨‹ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿï¼Œå˜—è©¦æ‰¾å‡ºé›™æ–¹å¯ä»¥äº’é€šçš„é€£ç·š\n1.Candidate Gathering Candidate æ˜¯æŒ‡å¯èƒ½è¢«ä½¿ç”¨çš„é€£ç·šæ–¹å¼ï¼Œå…±æœ‰å¹¾ç¨®\nhost: local interface srflx: Server Reflexiveï¼Œä¹Ÿå°±æ˜¯å¾ STUN é‚£æ‹¿åˆ°çš„ public ip relay: é€é TURN server æ‹¿åˆ°çš„ ip prflx: Peer Reflexiveï¼Œå¾ peer é‚£é‚Šæ‹¿åˆ°è‡ªå·±çš„ ipï¼Œæ™šé»è£œå…… ä»¥ä¸Šè³‡è¨Šæ”¶é›†å®Œå¾Œï¼Œé€é signaling æ–¹å¼ç™¼é€çµ¦å°æ–¹\n2.Candidate Selection å› ç‚ºé›™æ–¹éƒ½è’é›†äº†å„è‡ªçš„ candidateï¼Œæ¥è‘—å°±æ˜¯ full mesh çµ„åˆå‡º Candidate Pairï¼Œä¸¦æŒ‰ç…§å„ªå…ˆé †åºé–‹å§‹æ¸¬è©¦é€£ç·šï¼Œå¯ä»¥æˆåŠŸæ”¶ç™¼è¨Šæ¯å‰‡æ¨™è¨˜ç‚º Valid Candidateï¼Œä¸»å°æ–¹æœƒæŒ‘ä¸€å€‹ valid candidate æ¨™è¨˜æˆ Nominated Pairï¼Œæ¥è‘—é›™æ–¹åœ¨æ¸¬è©¦ä¸€æ¬¡æ˜¯å¦èƒ½æˆåŠŸæ”¶ç™¼è¨Šæ¯ï¼Œå®Œæˆå‰‡æ¨™è¨˜ç‚º Selected Candidate Pairï¼Œé€™ä¸€å€‹ session å°±ç”¨ä¸€çµ„é€£ç·šæ–¹å¼\n3. Restart å¦‚æœ Selected Candidate Pair æœ‰ä»»ä½•å•é¡Œï¼Œå‰‡ä»¥ä¸Šæ­¥é©Ÿé‡æ–°ä¾†é\næœ€å¾Œè£œå……ä¸€ä¸‹ Peer Reflexiveï¼Œç‚ºä»€éº¼æœƒæœ‰å¾å°æ–¹æ‹¿åˆ°è‡ªå·±æ‰€ä¸çŸ¥é“çš„ ip é€™ç¨®ç‹€æ³ï¼Œä¸»è¦æœƒç™¼ç”Ÿåœ¨ Host Candidate èˆ‡ Server Reflexive Candidate æºé€š\nè©¦æƒ³ client A é€é host candidate å¤šåŠæ‹¿åˆ°æ˜¯è‡ªå·±çš„ private ipï¼Œæ­¤æ™‚é€é NAT å‘ client B ç™¼é€è«‹æ±‚ï¼Œclient B æœƒæ‹¿åˆ° NAT çš„ public address (ä¹Ÿå°±æ˜¯ client A çš„ Mapping)ï¼Œæ­¤æ™‚è¿”å› public address çµ¦ client Aï¼Œæ­¤æ™‚å°±æ˜¯ prflx å…¶å¯¦ä¸Šè¿°çš„éç¨‹é¡ä¼¼æ–¼ STUN server çš„åŠŸç”¨ å› ç‚º ICE protocol æ˜¯æœ‰ç¶“éé©—è­‰çš„ï¼Œæ‰€ä»¥ client A å¯ä»¥æ”¾å¿ƒçš„æ‹¿é€™çµ„ public ip ç•¶ä½œè‡ªå·±çš„ ip\nä¸‰. Securing è©²æ€éº¼ç¢ºä¿æ”¶åˆ°çš„ sdp ä¾†è‡ªé æœŸçš„ client / è¦å¦‚ä½•ç¢ºä¿æ”¶åˆ°çš„ media æ˜¯ä¾†æ­£ç¢ºçš„ clientï¼ŒWebRTC çµåˆè¨ˆæœ‰çš„åŠ å¯†æ–¹å¼ DTLS / SRTPï¼Œç¢ºä¿æ©Ÿå¯†æ€§/å®Œæ•´æ€§/èº«ä»½é©—è­‰\nDTLS DTLS æ˜¯ TLS çš„è¿‘è¦ªï¼Œåªæ˜¯ DTLS çš„å‚³è¼¸å±¤æ˜¯ UDP è€Œ TLS æ˜¯ TCPï¼› DTLS æ˜¯ Client/Server æ¶æ§‹ï¼ŒæŸä¸€æ–¹æœƒå…ˆç™¼èµ·é€šä¿¡ï¼Œæ¥è‘—é›™æ–¹æœƒäº¤æ›æ†‘è­‰ï¼Œè€Œç¢ºä¿æ†‘è­‰çš„æ­£ç¢ºæ€§æ˜¯æ¯”å° SDP ä¸­çš„æ†‘è­‰ hash å€¼ï¼›\nå®Œæˆäº¤æ¡å¾Œæœƒå–å¾—å…±åŒå°ç¨±å¯†é‘°ï¼Œå¾ŒçºŒå°±ç”¨æ­¤åŠ å¯† *åœ–ç‰‡ä¾†è‡ª webrtcforthecurious\næµç¨‹åŸºæœ¬èˆ‡ HTTPS å¾ˆåƒï¼Œåªæ˜¯ client ä¹Ÿè¦æä¾›æ†‘è­‰çµ¦ serverï¼Œåœ¨ https é€™ä¸€æ­¥æ˜¯å¯é¸çš„ä½†é€šå¸¸å¿½ç•¥\nServerHello/ClientHello å„è‡ªå†ç”¢ç”Ÿ random secretï¼Œæ‹¿åˆ°æ†‘è­‰å¾Œ client ç”¢ç”Ÿ pre-master ä¸¦åŠ å¯†å‚³é€çµ¦ serverï¼Œé›™æ–¹å¯ä»¥å¾—åˆ°ç›¸åŒä½†å…¶ä»–äººä¸çŸ¥é“çš„ master key\néç¨‹ä¸­çªç„¶æƒ³åˆ°ï¼Œæ—¢ç„¶æ˜¯ client æœ€å¾ŒæŠŠ pre-master åŠ å¯†ï¼Œé‚£ç‚ºä»€éº¼é‚„è¦ client/secret random number ? åŸå› æ˜¯ç‚ºäº†é¿å…å›æ”¾æ”»æ“Šï¼Œåƒè€ƒ Why does the SSL/TLS handshake have a client and server random? å¦‚æœå°‘äº† Server random numberï¼Œé‚£é§­å®¢å³ä½¿ä¸çŸ¥é“å…§æ–‡ä¹Ÿæ²’é—œä¿‚ï¼Œé‡è¤‡å›æ”¾è«‹æ±‚ï¼ŒServer æ²’è¾¦æ³•çŸ¥é“é€™äº›è«‹æ±‚æ˜¯éæ™‚çš„ åä¹‹å¦‚æœæœ‰ random numberï¼ŒServer å°±æœƒç™¼ç¾ master key ä¸åŒè€Œä¸­æ–·è«‹æ±‚\nSRTP SRTP æ˜¯é‡å° RTP è¨­è¨ˆçš„åŠ å¯†ç‰ˆæœ¬ï¼Œæœ¬èº«æ²’æœ‰å®šç¾©ç”¢ç”Ÿ keyï¼Œæ‰€ä»¥ WebRTC å°±æ‹¿ DTLS äº¤æ¡å¾Œç”¢ç”Ÿçš„å…±åŒé‡‘é‘°ç•¶ä½œ SRTP çš„åŠ å¯†é‡‘é‘°\nå…·é«”å…§å®¹å°±å…ˆç•¥é\nReal-time Networking ç¶²è·¯ç‹€æ³æœƒå¾ˆå¤§å¹…åº¦å½±éŸ¿å³æ™‚å½±éŸ³æœå‹™çš„å“è³ªï¼Œå“è³ªå‰‡æ˜¯åœ¨ Quality \u0026amp; Latency ä¸­åšæŠ‰æ“‡ï¼Œè©•ä¼°ç¶²è·¯ç‹€æ³æ™‚æœƒçœ‹\nBandwidth: é€šé“ä¸Šæœ€å¤§å¯å‚³è¼¸çš„é‡ Transmission Time and Round Trip Timeï¼šå¾ç™¼é€åˆ°æ”¶åˆ°å›æ‡‰çš„æ™‚é–“ åœ¨ç¶²è·¯ç‹€æ³ä¸å¥½çš„æƒ…æ³ä¸‹ï¼Œæœƒé‡åˆ°å¹¾ç¨®è² é¢æƒ…æ³\nJitter: RTT æ™‚é•·æ™‚çŸ­ï¼Œå°è‡´ç•«é¢å¡é “\nå¯ä»¥é€é Jitter Buffer æ”¹å–„å•é¡Œï¼Œæ”¶åˆ°å°åŒ…å¾Œå…ˆ queue ä¸€å°æ®µæ™‚é–“ï¼Œç­‰åˆ°å¯ä»¥å®Œæ•´è§£æ frame åœ¨ render Packet Loss: æŸäº›å°åŒ…æ‰äº†ï¼Œå°è‡´ç•«é¢è·³æ ¼\nè§£æ±º Packet Loss å•é¡Œå¯ä»¥é€é æ”¶åˆ°å°åŒ…å¾Œå›å‚³ ACK æ”¶åˆ°å°åŒ…å¾Œå›å‚³æ”¶åˆ°çš„å°åŒ… SACK å›å‚³æ²’æœ‰æ”¶åˆ°çš„å°åŒ… NACK (é‡åˆ°è·³è™Ÿæ™‚) ä»Šå¤©å¦‚æœç¶²è·¯ç‹€æ³ä¸å¥½ï¼Œå‰‡ç™¼é€æ–¹æ‡‰è©²è¦é™ä½å½±éŸ³å“è³ª / æ¸›ç·©ç™¼é€é€Ÿåº¦ï¼Œé¿å…ç¶²è·¯ç‹€æ³æƒ¡åŒ–ï¼›\nå¦ä¸€æ–¹é¢ç•¶ç¶²è·¯ç‹€æ³æ”¹å–„ï¼Œå‰‡ç™¼é€æ–¹ä¹Ÿæ‡‰è©²è¦çŸ¥é“ï¼Œé€²è€Œæå‡å‚³è¼¸çš„å“è³ªèˆ‡é€Ÿåº¦\né‚£æ¥æ”¶æ–¹å¦‚ä½•å›å ±ç¶²è·¯ç‹€æ³çµ¦ç™¼é€æ–¹å‘¢ï¼Ÿ\nMedia WebRTC æœ¬èº«ä¸ç®¡åº•å±¤çš„å½±éŸ³ codecï¼Œåªè¦é›™æ–¹éƒ½å¯ä»¥è™•ç†å°±å¥½ï¼Œé€é RTP å‚³è¼¸å½±éŸ³è³‡æ–™ / RTCP è™•ç†ç¶²è·¯ç‹€æ³+æ§åˆ¶æµé‡\nRTCP å¦‚ä½•æ•´ç†ç¶²è·¯ç‹€æ³ RTCP é€éå¹¾ç¨®æ–¹å¼ï¼Œè®“ç™¼é€æ–¹å¯ä»¥å¾—çŸ¥ç¶²è·¯ç‹€æ³\nReceiver Reports\nSender å†ç™¼é€æ™‚æ‰“ä¸Šç•¶æ™‚çš„æ™‚é–“æˆ³è¨˜ t1ï¼ŒReceiver æ”¶åˆ°å¾ŒåŠ ä¸Šè‡ªå·±è™•ç†çš„æ™‚é–“ t2ï¼Œå›å‚³ Report çµ¦ Senderï¼Œæœ€å¾Œ Sender æ”¶åˆ°çš„æ™‚é–“ç‚º t3\nå‰‡ Sender å¯ä»¥ç®—å‡º rtt = t3 - t1 - t2 REMB\nReciver æ ¹æ“šçµ±è¨ˆ packet lossï¼Œè·Ÿ Sender å›å ±é æœŸçš„ bitrate 1 2 if (packetLoss \u0026lt; 2%) video_bitrate *= 1.08 if (packetLoss \u0026gt; 10%) video_bitrate *= (1 - 0.5*lossRate) ä½†é€™å€‹æ–¹æ³•ç†è«–ä¸Šçœ‹èµ·ä¾†ä¸éŒ¯ï¼Œå¯¦éš›æ‡‰ç”¨ä¸Šå»å¾ˆç³Ÿç³•ï¼Œå› ç‚º encoder åœ¨å‹•æ…‹æ”¹è®Š bitrate ä¸‹æ²’æœ‰é€™éº¼æœ‰æ•ˆç‡ 3. TWCC\nè¿½è¹¤æ¯ä¸€å€‹å°åŒ…çš„ç‹€æ³ï¼Œå¯ä»¥è®“ Sender æœ‰æ›´å³æ™‚ã€æ¸…æ¥šçš„ç¶²è·¯ç‹€æ³\né€™ä¸€æ®µç†è§£ä¸é€™éº¼å…¨é¢ï¼Œæœªä¾†æœ‰æ©Ÿæœƒè£œä¸Š\nç¸½çµ å»ºç«‹ WebRTC é€£ç·šéç¨‹ï¼Œç¸½å…±åˆ†æˆ\nSignalingï¼š äº¤æ›å½¼æ­¤è³‡è¨Šçš„ç®¡é“ï¼Œé€é SDP æè¿°é€™äº›è³‡è¨Š Connectingï¼šç‚ºäº†æ‡‰ä»˜è¤‡é›œçš„ç¶²è·¯ç’°å¢ƒ(NAT)ï¼Œé€é ICE è§£æ±ºé€£ç·šå•é¡Œ Securingï¼šç¢ºä¿äº¤æ›çš„è³‡æ–™æ˜¯å®‰å…¨çš„ Real-time communicationï¼šå³æ™‚å‚³é€è³‡æ–™ ","date":"2021-05-30T07:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-05-30-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-webrtc/","title":"æ·±å…¥ç†è§£ WebRTC"},{"content":"å·¥ä½œäº†æ•¸å¹´ï¼Œå¯èƒ½æ˜¯ä¸€é–‹å§‹å¯«å‹•æ…‹èªè¨€çš„é—œä¿‚ï¼Œé®®å°‘æ³¨æ„åˆ°æŠ½è±¡åŒ– / å°è£ / ç‰©ä»¶å°å‘çš„è¨­è¨ˆï¼Œå°è‡´ç¨‹å¼ç¢¼è¶Šä¾†è¶Šé›£ä»¥ç¶­è­·ï¼Œæ·±çŸ¥é€™æ˜¯è‡ªå·±æŠ€èƒ½ä¸Šçš„å¼±é»ï¼Œé–‹å§‹å»å­¸ç¿’ TDD / é‡æ§‹ï¼Œå¸Œæœ›å¯ä»¥å¯«å‡ºå¥½æ‡‚ / å¥½ç¶­è­· / æœ‰æ¸¬è©¦ä¿è­·çš„ä¹¾æ·¨ç¨‹å¼ç¢¼\nå‰›å¥½æœ€è¿‘æ›å·¥ä½œé–‹å§‹å¯« Rubyï¼Œå°±é †ä¾¿è²·äº†é€™æœ¬ ã€Refactoring Ruby Editionã€‘ï¼ŒåŸæœ¬æ˜¯ Martin Fowler å¤§å¤§ç”¨ Java ç•¶ä½œç¯„ä¾‹æ‰€ç·¨å¯«ï¼Œé€™ä¸€æœ¬æ˜¯ç”±å¦å¤–å…©åä½œè€…èˆ‡ Martin Fowler æ›åï¼Œæ¡ç”¨ Ruby ç•¶ä½œç¯„ä¾‹ä¸¦åŠ å…¥ Ruby çš„èªè¨€ç‰¹æ€§ï¼Œä¸å½±éŸ¿å°æ–¼é‡æ§‹çš„ç†è§£èˆ‡å¯¦è¸\nç›®å‰çœ‹äº†ä¸€åŠè¦ºå¾—å¾ˆå—ç”¨ï¼Œæ•´ç†å¾ˆå¤š code smellï¼Œä»¥åŠé‡åˆ°æ™‚è©²å¦‚ä½•æœ‰ç³»çµ±çš„é‡æ§‹æˆä¹¾æ·¨çš„ç¨‹å¼ç¢¼ï¼Œæœ‰ä¸€äº›åŸå‰‡å¯èƒ½æœƒäº’æ–¥ (æŠ½é¡åˆ¥æˆ–æ˜¯æŠŠé¡åˆ¥å¡å›å»)ï¼Œæ›¸ä¸­ä¹Ÿæœ‰æåŠè©²å¦‚ä½•åˆ¤æ–·ä½•è€…ç‚ºä½³\nä»¥ä¸‹å…§å®¹å°æ‡‰çš„æ˜¯ç¬¬ä¸€ç«  ã€ŒRefactoring, a First Exampleã€ï¼Œç¨‹å¼ç¢¼æ–¼æ­¤ sj82516/refactoring-rubyï¼Œä»¥ä¸‹æ¯å€‹æ­¥é©Ÿéƒ½æœƒå°æ‡‰åˆ°ä¸€å€‹ commit\nç¯„ä¾‹ é€™æ˜¯ä¸€å€‹ç§Ÿç‰‡æœå‹™ï¼Œè¨ˆç®—ç›®å‰ç”¨æˆ¶ç§Ÿç‰‡çš„è²»ç”¨èˆ‡å›é¥‹é»æ•¸ï¼Œå½±ç‰‡æœ‰åˆ†ä¸‰ç¨®é¡å‹\né‡æ§‹ä¹‹å‰ ä¸€é–‹å§‹å…ˆè§€å¯Ÿé€™æ®µé€™æ®µç¨‹å¼ç¢¼ï¼Œ Customer ä¸­çš„ statement method æ˜é¡¯å¾ˆé•·ä¸€æ®µï¼Œè² è²¬è¨±å¤šäº‹æƒ…ï¼ŒåŒ…å«è¨ˆç®—èˆ‡æ•´ç†è¼¸å‡ºè¦æ ¼\nå¾åŠŸèƒ½é¢ä¸Šä¾†çœ‹ï¼Œé€™æ®µç¨‹å¼ç¢¼é‹ä½œç¬¦åˆé æœŸï¼Œå°æ–¼ç›´è­¯å™¨ä¾†èªªä¹Ÿä¸å­˜åœ¨é†œä¸é†œçš„ç¨‹å¼ç¢¼ï¼Œä½†ä»Šå¤©å¦‚æœéœ€æ±‚è®Šæ›´ï¼Œéœ€è¦äººé¡çš„ä»‹å…¥å»ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œé‚£å¯è®€æ€§å°±å¾ˆé‡è¦äº†\nä¾‹å¦‚èªªä»Šå¤©è¦å¢åŠ ä¸€å€‹è¼¸å‡ºæˆ html æ ¼å¼ï¼Œç›®å‰çš„å¯«æ³•åªèƒ½ copy statement ä¸¦ä¿®æ”¹è¼¸å‡ºæ ¼å¼ï¼Œåˆå¦‚æœä¹‹å¾Œè¦èª¿æ•´å½±ç‰‡çš„è¨ˆåƒ¹æ–¹å¼ï¼Œé‚£å¾ˆä¸å¹¸å…©å€‹æ–¹æ³•éƒ½è¦åŒæ­¥æ”¹å‹•\nç•¶ä½ ç™¼ç¾è¦å¢åŠ æ–°åŠŸèƒ½å¾ˆé›£æ”¹å‹•æ™‚ï¼Œå…ˆé‡æ§‹åˆ°ä½ è¦ºå¾—å¾ˆå¥½åŠ æ–°åŠŸèƒ½å¾Œï¼Œå†åŠ ä¸Šæ–°åŠŸèƒ½\né–‹å§‹é‡æ§‹ ä»¥ä¸‹æŒ‰ç…§æ›¸ä¸­å»ºè­°ï¼Œé–‹å§‹é€²è¡Œé‡æ§‹\ninit\n1. å¯«æ¸¬è©¦ å¦‚ä½•ç¢ºä¿åœ¨é‡æ§‹éç¨‹ä¸æŠŠåŠŸèƒ½æ”¹å£ï¼Ÿ å¯«æ¸¬è©¦ï¼ é€éå¯«æ¸¬è©¦å¯ä»¥æ˜ç¢ºè¡¨é”æˆ‘å€‘é æœŸçš„ç¨‹å¼ç¢¼è¡Œç‚ºï¼Œåœ¨èˆ‡ PM æºé€šæ™‚é€éå…·é«”çš„æ¸¬è©¦æ¡ˆä¾‹ä¹Ÿå¯ä»¥é¿å…æœ‰èªçŸ¥ä¸Šçš„æ­§ç•°\ntest: add unit test\n2. æ‹†è§£èˆ‡é‡çµ„ - Extact Method é¦–å…ˆæ‹†è§£éæ–¼è¤‡é›œçš„ statement æ–¹æ³•ï¼Œè¦æ‹†è§£é¦–å…ˆæ‰¾åˆ°é‚è¼¯ä¸Šæ¯”è¼ƒç·Šå¯†çš„å€å¡Šï¼Œä¸¦æ‹†åˆ†å‡ºç¨ç«‹çš„æ–¹æ³•ï¼Œä¾‹å¦‚ case å°±å¾ˆé©åˆ\nåœ¨æ‹†åˆ†æ™‚è¦æ³¨æ„ä½¿ç”¨åˆ°çš„è®Šæ•¸æœ‰æ²’æœ‰è¢«ä¿®æ­£ï¼Œä¾‹å¦‚ rental æ²’æœ‰è¢«æ”¹å‹•æ‰€ä»¥ç•¶ä½œåƒæ•¸å‚³é€²å»å°±æ²’äº‹ï¼Œä½†æ˜¯ this_amount æœ‰è¢«æ”¹å‹•ï¼Œå¦‚æœè¢«æ”¹å‹•åªæœ‰ä¸€å€‹è®Šæ•¸ï¼Œé‚£å°±ç•¶åš function return å³å¯\nåˆ¥å¿˜è¨˜æ¯æ”¹ä¸€å°æ­¥éƒ½è¦è·‘æ¸¬è©¦\u0008ï¼Œå°¤å…¶æ˜¯å‹•æ…‹èªè¨€å®¹æ˜“å¡åœ¨è®Šæ•¸åç¨±å¯«éŒ¯ç­‰å°å•é¡Œä¸Š\nrefactor extract amount_for method\n2-2 é‡æ–°å‘½åå¹«åŠ©èªçŸ¥ åœ¨æ–°çš„ amount_for methodï¼Œæ”¹å‹•ä¸€ä¸‹è®Šæ•¸åç¨±æœ‰åŠ©æ–¼å«ç¾©çš„è¡¨é”ï¼Œå°‘ç”¨å¤ªå»£æ³›çš„å«ç¾©ä¾‹å¦‚ element / i é€™é¡\nAny fool can write code that a computer can understand. Good programmers write code that humans can understand.\nä¸å¾—ä¸æ¨è–¦ä¸€ä¸‹ RubyMineï¼Œä¸€å¹´è¨‚é–±è¦ $89 é‚ä½†æ˜¯æœ‰ Refactor ç³»åˆ—çš„è¼”åŠ©å·¥å…·è¶…æ–¹ä¾¿ï¼Œé€é shift éµ * 2 å«å‡º action dialog å¾Œè¼¸å…¥ã€Œrefactor thisã€ï¼Œå°±æœƒæœ‰ä¸€ç³»åˆ—çš„é‡æ§‹æ–¹æ³•è®“ä½ æŒ‘é¸\nrefactor: rename\n3. æŠŠé‚è¼¯æ”¾åœ¨æ­£ç¢ºçš„ç‰©ä»¶ä¸Š - Move Method ä»”ç´°çœ‹ä¸€ä¸‹ amount_for æ–¹æ³•ä¸­ï¼Œé‹ç®—é‚è¼¯çš„è³‡æ–™ä¾†æºéƒ½å¾ Rental é€™å€‹ç‰©ä»¶è€Œä¾†ï¼Œéƒ½æ²’æœ‰ç”¨ä¸Š Customer ç‰©ä»¶ä¸Šçš„è³‡æ–™ï¼Œé€™æ™‚å€™å¯ä»¥åˆç†çš„æ‡·ç–‘æ˜¯ä¸æ˜¯æŠŠæ–¹æ³•ç§»åˆ° Rental æœƒæ›´åŠ åˆé©\næ¥è‘—ä¿®æ­£ Customer çš„å¼•ç”¨\nrefactor: move method to rental\n3-2. ç§»é™¤ä¸å¿…è¦çš„å€åŸŸè®Šæ•¸ - Inline é€™æ™‚å€™ this_amount å°±æœ‰é»å¤šé¤˜äº†ï¼Œé€é inline è®Šæ•¸ç›´æ¥å¾ rental.charge è®€å–\næˆ–è¨±æœƒæœ‰äººçˆ­è«–ï¼šå¤šæ¬¡å‘¼å«æ–¹æ³•æœƒé™ä½æ•ˆèƒ½ï¼Œä½†æ˜¯åŸå‰‡ä¸Šé‡æ§‹æ˜¯ç‚ºäº†ç°¡æ½”ï¼Œæ•ˆèƒ½å•é¡Œç­‰åˆ°ç™¼ç”Ÿæ™‚åœ¨å„ªåŒ–å³å¯ï¼Œå°¤å…¶æ˜¯ç¾åœ¨çš„é‹ç®—è³‡æºå¾€å¾€å¾ˆè¶³å¤ ï¼Œå¥½ç¶­è­·ä¸Šå¸¶ä¾†çš„é–‹ç™¼è³‡æºç¯€çœæœƒæ¯”é‹ç®—è³‡æºä¾†å¾—é‡è¦\nå›éé ­ä¾†çœ‹å€åŸŸè®Šæ•¸å“ªè£¡ä¸å¥½ï¼Ÿ\nè©¦æƒ³æˆ‘å€‘å‰›å‰›åœ¨æŠ½æ–¹æ³•ï¼Œéœ€è¦æ“”å¿ƒå€åŸŸè®Šæ•¸æœ‰æ²’æœ‰è¢«å…¶ä»–äººè®€å–æˆ–ä¿®æ”¹ï¼Œè€Œæ›´ç³Ÿç³•çš„äº‹æœƒæœ‰äººæŠŠå€åŸŸè®Šæ•¸é‡è¤‡ assign æ–¼ä¸åŒçš„ç”¨é€”ï¼Œç‚ºäº†é¿å…å¤šé¤˜çš„æ“”å¿ƒèˆ‡é–±è®€éšœç¤™ï¼Œç§»é™¤å€åŸŸè®Šæ•¸æ˜¯æœƒæœ‰å¹«åŠ©çš„\nrefactor: remove total_amount\n3-3. ä¿®æ”¹ frequent_renter_points åŒæ¨£çš„ä¿®æ”¹å¯ä»¥å¥—ç”¨åˆ° frequent_renter_pointsï¼Œä¸é frequent_renter_points æœ¬èº«æ˜¯å€åŸŸè®Šæ•¸ï¼Œè€Œä¸”æ˜¯ä¸æ–·åœ°éš¨è‘— loop è€Œæ”¹è®Šï¼Œé€™æ™‚å€™ç•¶ä½œåƒæ•¸å‚³é€²å»åœ¨ç”¨ return reassign æœ‰é»æ²’å¿…è¦ refactor: extract and move frequent_renter_points method\n4. ç§»é™¤å€åŸŸè®Šæ•¸ Remove Temp å…ˆå‰æåˆ°å€åŸŸè®Šæ•¸çš„ç¼ºé»ï¼Œæ¥è‘—ç§»é™¤ total_amount èˆ‡ frequent_renter_pointsï¼Œç›´æ¥åœ¨ä½¿ç”¨çš„åœ°æ–¹å‘¼å«æ–¹æ³•ï¼ŒåŒæ¨£çš„ï¼Œå‘¼å«æ–¹æ³•çš„æ•ˆèƒ½ç–‘æ…®åªæœ‰åœ¨çœŸçš„æœ‰å•é¡Œæ™‚å†è€ƒæ…®\nRuby æ¯”è¼ƒå¦™çš„æ˜¯æ–¹æ³•å‘¼å«å¯ä»¥çœç•¥()ï¼Œæ‰€ä»¥çœ‹èµ·ä¾†è·Ÿå‘¼å«è®Šæ•¸æ²’ä»€éº¼å…©æ¨£\nrefactor: remove frequent_renter_points\n5. é€éå¤šå‹å–ä»£ case å¦‚æœè¦ä½¿ç”¨ caseï¼Œé‚£è¨˜å¾— case ä¸­çš„åˆ¤æ–·ä¾æ“šæ‡‰è©²æ˜¯ç‰©ä»¶æœ¬èº«çš„è³‡æ–™\nç›®å‰åœ¨ Rental çš„ charge ä¸­ï¼Œæœƒä¾ç…§ Movie çš„ type åˆ†ä¸åŒçš„æ”¶è²»æ–¹å¼ï¼Œé€™è£¡å¦‚æœæœªä¾† Movie è¦å¢åŠ  type / èª¿æ•´æ¯ç¨® type çš„æ”¶è²»æ–¹å¼ï¼Œä¸€ç›´ä¾†æ”¹ Rental çš„ charge å‘¼å«ç«¯ä¸å¤ªåˆé©ï¼Œæ‰€ä»¥å°‡ charge çš„é‚è¼¯æ­¸é¡åˆ° Movie ä¸­ refactor: move charge logic to Movie\nç›¸åŒçš„é“ç†ä¹Ÿå¥—ç”¨æ–¼ frequent_renter_points ä¸Š\nrefactor: move frequent_renter_points logic to Movie\n5-2. å°‡ case è½‰æ›æˆå¤šå‹ Movie ä¸­çš„ charge ä¾ç…§ä¸åŒçš„ type æ”¶è²»ï¼Œé€™è½èµ·ä¾†å°±å¾ˆåƒç¹¼æ‰¿å¯ä»¥è™•ç†çš„äº‹æƒ…ï¼Œå¯å»ºç«‹å¤šå€‹ä¸åŒçš„ Sub Movie Class\nä½†é€™é»ä¸¦ä¸é©ç”¨æ–¼ç›®å‰çš„å ´æ™¯ï¼Œå› ç‚º Movie çš„ type æœƒéš¨è‘—æ™‚é–“è€Œæ”¹è®Šï¼Œä¸¦ä¸æ˜¯åˆå§‹åŒ–å¾Œå°±ä¸è®Šçš„ï¼Œæ‰€ä»¥æ›´é©åˆç”¨ State/Strategy Pattern\nState/Strategy Pattern æœ€å¤§å·®ç•°åœ¨æ–¼ State è¡¨é”çš„æ˜¯ç‹€æ…‹çš„æ”¹è®Šï¼Œè€Œ Strategy ä»£è¡¨çš„æ˜¯è¨ˆç®—æ™‚çš„æ¼”ç®—æ³•æ”¹è®Šï¼Œå…©è€…çœ‹èµ·ä¾†è »åƒçš„ï¼Œä¸»è¦åœ¨æ–¼å‘½åå¦‚ä½•è¡¨é”è¨­è¨ˆè€…çš„æ„åœ–\né€™é‚Šæ¯”è¼ƒé©åˆç”¨ State Patternï¼Œå› ç‚º Movie çš„ type æ¯”è¼ƒæ˜¯ä¸€ç¨® stateï¼ŒæœƒæŒçºŒä¸€æ®µæ™‚é–“è€Œéç•¶ä¸‹è¨ˆç®—å®Œå°±çµæŸ\né€™é‚Šç¬¬ä¸€æ­¥å…ˆåœ¨ price_code= æ–¹æ³•ä¸­åˆå§‹åŒ–ç‹€æ…‹ï¼Œå…ˆæš«æ™‚ç”¨ case é ‚æ›¿ç­‰ç­‰æœƒæ›æ‰ refactor: add state pattern to extract charge logic\n5-3. æŠ½æ› frequent_render_points frequent_render_points ä¹Ÿå¯ä»¥ç”¨é¡ä¼¼çš„æ–¹å¼ï¼Œä½†æ³¨æ„åˆ°åªæœ‰ New Release çš„è¨ˆç®—æ–¹å¼ä¸åŒï¼Œé€™é‚Šå¯ä»¥ç”¨ Module çš„æ–¹å¼è¨­å®šé è¨­æ–¹æ³•ï¼Œåœ¨ New Release Sub Class ä¸­åœ¨è¤‡å¯«\nrefactor: update frequent_renter_points\n5-4. ç§»é™¤ price_code= æœ€å¾Œè®“å‘¼å«è€…å°‡åˆå§‹åŒ–çš„ price class å‚³å…¥ï¼Œå°±å¯ä»¥çœå» price_code= ä¸­çš„ case ä½¿ç”¨\nå°å…¥ State Pattern èŠ±äº†å¹¾å€‹æ­¥é©Ÿï¼Œä¸»è¦æ˜¯åœ¨æœªä¾†å¢åŠ æ–°çš„è¨ˆåƒ¹æ¨¡å¼ï¼ŒèˆŠçš„ Code éƒ½ä¸æœƒå—åˆ°å½±éŸ¿ï¼Œåªè¦æ–°å¢å°±å¥½ï¼Œç¬¦åˆ Open Close åŸå‰‡\nrefactor: change Movie initialize\nçµèª é‡æ§‹æœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼ä¸€æ­¥ä¸€æ­¥èª¿æ•´ç¨‹å¼ç¢¼åˆ°æœ‰å½ˆæ€§çš„æ–¹å¼ï¼Œæ‰€ä»¥ä¸ç”¨ä¸€é–‹å§‹å°±è¿½æ±‚å®Œç¾çš„è¨­è¨ˆï¼Œé¿å…äº† over design çš„å•é¡Œï¼Œå› ç‚ºåªè¦æœ‰é‡æ§‹çš„ç¿’æ…£å°±ä¸æœƒè®“ç¨‹å¼ç¢¼åƒµç¡¬åˆ°ç„¡æ³•ç¶­è­·\nä¹‹å‰å·¥ä½œå¸¸å¸¸é‡åˆ°å¤§å®¶æœƒèªª Legacy Code å¤šåˆ°ç„¡æ³•ç¶­è­·è€Œéœ€è¦ã€Œé‡å¯«ã€ï¼Œä½†å›éé ­ä¾†çœ‹å¦‚æœç”¨ä¸€æ¨£çš„é‚è¼¯è·Ÿé–‹ç™¼æ–¹å¼ï¼Œé‡å¯«å¹¾ç™¾æ¬¡æœ€å¾Œéƒ½é¢è‡¨åŒæ¨£çš„å›°å¢ƒï¼Œå­¸ç¿’é‡æ§‹é€æ­¥å„ªåŒ–ï¼Œä¸¦èª¿æ•´å°æ–¼ç‰©ä»¶å°å‘ã€è¨­è¨ˆæ¨¡å¼çš„èªçŸ¥ï¼Œé€™æ‰æ˜¯é•·ä¹…ä¹‹è¨ˆ\n","date":"2021-05-01T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-05-01-refactoring-ruby-edition%E4%B8%80-%E9%AB%94%E9%A9%97%E9%87%8D%E6%A7%8B/","title":"ã€Refactoring Ruby Editionã€‘(ä¸€) é«”é©—é‡æ§‹"},{"content":"é‚„è¨˜å¾—ç´„åœ¨ 2016 å¹´ç¬¬ä¸€æ¬¡åœ¨å‹Ÿè³‡å¹³å°ä¸Šçœ‹åˆ° ARRC çš„å‹Ÿè³‡æ´»å‹•ï¼Œæ‰çŸ¥é“äº¤å¤§æœ‰é€™éº¼ä¸€ä½ç†±è¡€çš„æ•™æˆ å³å®—ä¿¡æ•™æˆï¼Œæƒ³è¦æ‰“é€ ä¸€éš»ç´” MIT çš„ç«ç®­ï¼Œæ‰¾äº†ç•¶æ™‚ä¸€èµ·èµ´ç¾å”¸æ›¸çš„æœ‹å‹ï¼Œä¸²é€£å¤šæ‰€å¤§å­¸çš„å°ˆæ¥­ä¸€èµ·ç‚ºäº†å¤ªç©ºå¤¢è€ŒåŠªåŠ›\nå°ç£æœ¬åœŸç«ç®­ è¦è®“å¤ªç©ºæ—…è¡Œå¤¢æƒ³æˆçœŸ | å³å®—ä¿¡ Jong-Shinn Wu | TEDxTaipei\nç•¶æ™‚æˆ‘é‚„åœ¨é¦¬ç¥–ç•¶æ›¿ä»£å½¹ï¼Œé ˜è‘—æ™‚è–ª 8å…ƒçš„è–ªæ°´ XD é‚„æ˜¯è´ŠåŠ©äº†åŸºæœ¬æ–¹æ¡ˆï¼Œæœ€å¾Œæ”¶åˆ°è´ŠåŠ©å“æ˜¯ä¸€æœ¬è¬›å¤ªç©ºèˆ‡ ARRC çš„ç™¼å±•å²çš„æ›¸(ç¹ªæœ¬?!)\nå…¶å¯¦æˆ‘å°å¤ªç©ºä¸€ç«…ä¸é€šï¼ŒèªªçœŸçš„ä¹Ÿæ²’æœ‰ç‰¹åˆ¥çš„åš®å¾€ï¼Œä½†æˆ‘å¾ˆèªå¯æ•™æˆæ‰€æç¹ªçš„å¤ªç©ºæ™‚ä»£ï¼Œåœ¨ 2021 å¹´å›ä¾†çœ‹ï¼Œåƒ Starlink / Facebook éƒ½åœ¨ç©æ¥µç™¼å°„è¡›æ˜Ÿï¼Œé€£æ•™æˆæ‰€æç¹ªçš„é€éè¡›æ˜ŸæŸ¥çœ‹å•†æ¥­æ¨¡å¼ä¹Ÿåœ¨æˆ‘å–œæ­¡çš„å½±é›†ã€ŠBillionaresã€‹çœŸå¯¦ä¸Šæ¼”ï¼›\nå¦å¤–é‚„æœ‰å¤ªç©ºç§‘æŠ€æ˜¯æŠ€è¡“çš„ç«è»Šé ­ï¼Œå¯ä»¥å¸¶å‹•åŸºç¤ç”¢æ¥­ä¸€èµ·å‘ä¸Šå‡ç´šï¼Œé€™ä¹Ÿæ˜¯æˆ‘è¦ºå¾—å¾ˆç†±è¡€ã€å¾ˆå€¼å¾—æŠ•è³‡çš„äº‹æƒ…\næ‰€ä»¥åœ¨ 2020å¹´æ¨å‡ºç¬¬äºŒæ³¢çš„è´ŠåŠ©æ™‚å°±ç«‹é¦¬è´ŠåŠ©ï¼Œæ‹¿åˆ°å°ç£å¤ªç©ºéšŠçš„è¡£æœè·ŸéšŠå“¡è­‰ï¼ æœ€å¾Œä¹Ÿæ†‘è­‰æœ‰é€™æ¬¡åƒè§€çš„æ©Ÿæœƒï¼Œä»¥ä¸‹å°‡æ•´ç†èˆ‡åˆ†äº«åƒè§€çš„éç¨‹èˆ‡å¿ƒå¾—\n*è£œå€‹ç•¶åˆæ•™æˆè·Ÿå‘±å‰çš„å°è«‡ï¼Œè¶…ç†±è¡€çš„ ã€å‘±å‰ç›´æ’­ã€‘æ”¿æ²»é›»å°EP12ï¼šè½Ÿéš†éš†éš†è¡è¡è¡æ‹‰é¢¨å¼•æ“ç«ç®­ç™¼å‹•\né€™æ¬¡å»çš„æ˜¯äº¤å¤§ ARRCå‰ç»ç«ç®­ç ”ç©¶ä¸­å¿ƒ ç«ç®­çš„ç¨®é¡ ç«ç®­åœ¨é«˜ç©ºå› ç‚ºå¤–ç•Œç©ºæ°£ç¨€è–„ï¼Œæ‰€ä»¥éœ€è¦è‡ªå‚™ç‡ƒæ–™èˆ‡åŠ©ç‡ƒåŠ‘ï¼ŒåŸºæœ¬ç¨®é¡å¯åˆ†æˆ\nå›ºæ…‹ç«ç®­ï¼š\nç‡ƒæ–™èˆ‡åŠ©ç‡ƒåŠ‘å…ˆæ··åˆå¥½ï¼Œä¸¦ä»¥å›ºæ…‹å„²å­˜ï¼Œä¸€é»ç«å°±æœƒé–‹å§‹åŠ‡çƒˆç‡ƒç‡’ï¼Œæœ€å…¥é–€çš„æ˜¯è”—ç³–ç«ç®­ sugar rocketï¼Œå¯ä»¥çœ‹ è‡ªè£½ç¡ç³–ç«ç®­ï¼å¤§é›…ä¸€è™Ÿèƒ½å¤ é †åˆ©é£›å‘å®‡å®™å—ï¼Ÿã€èƒ¡æ€äº‚æã€‘(Feat.@é»ƒå°æ½”Jerryâ€‹ , ARRCå‰ç»ç«ç®­ç ”ç©¶ä¸­å¿ƒ) æ¶²æ…‹ç«ç®­ï¼š\nç‡ƒæ–™èˆ‡åŠ©ç‡ƒåŠ‘éƒ½æ˜¯æ¶²æ…‹ï¼Œä½†å› ç‚ºæ˜¯æ¶²é«”æ‰€ä»¥æ··åˆå¾Œå®¹æ˜“çˆ†ç‚¸ï¼Œå±éšªåº¦è¼ƒé«˜ æ··åˆå¼ç«ç®­ï¼š\nç‡ƒæ–™æ˜¯å›ºæ…‹ï¼ŒåŠ©ç‡ƒåŠ‘æ˜¯æ¶²æ…‹ï¼Œå¯ä»¥ç”¨é–¥é–€æ§åˆ¶åŠ©ç‡ƒåŠ‘ä¾†æ§åˆ¶ç«åŠ›ï¼Œç”šè‡³åšåˆ°æ‡¸æµ®çš„åŠŸèƒ½ï¼Œé€™æ˜¯å¦å¤–å…©è€…æ‰€ä¸è¡Œçš„ æ··åˆå¼ç«ç®­æ˜¯å¤ªç©ºç§‘æŠ€çš„æœªä¾†ï¼Œå…·æœ‰å¯æ§åˆ¶ / å®‰å…¨çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ ARRC æ¥ä¸‹ä¾† HTTP ç³»åˆ—ç«ç®­çš„ç™¼å±•æ–¹å‘\näº¤å¤§ã€ŒARRCå‰ç»ç«ç®­ç ”ç©¶ä¸­å¿ƒã€ å®Œæˆå…¨çƒé¦–æ¬¡æ··åˆå¼ç«ç®­ç©ºä¸­æ‡¸æµ®é£›è©¦\néç¨‹ä¸­æœ‰å•ç‚ºä»€éº¼æ··åˆå¼å¾ˆå¥½å…¶ä»–åœ‹å®¶æ²’æœ‰ç‡å…ˆç™¼å±•ï¼Ÿ å¾—åˆ°çš„ç­”è¦†æ˜¯ç¾åœ‹ç•¶åˆäºŒæˆ°å¾Œç¶æ¶å¾·åœ‹çš„é£›å½ˆå°ˆå®¶ï¼Œæœ‰å„ªè‰¯çš„æ¶²æ…‹ç«ç®­æŠ€è¡“ / æ—¥æœ¬åœ¨ç³¸å·è‹±å¤«çš„ç ”ç©¶ä¸‹ç™¼å±•å›ºæ…‹ç«ç®­ï¼Œå› ç‚ºç«ç®­çš„ç ”ç™¼æˆæœ¬éå¸¸é«˜ï¼Œæ‰€ä»¥æ—¢æœ‰çš„æŠ€è¡“å¾ˆå¥½å°±æœƒæ¡ç”¨ï¼Œåˆå› ç‚ºç«ç®­æ˜¯é«˜æ©Ÿå¯†ç§‘æŠ€ï¼Œä¸æœƒå°å¤–è¼¸å‡ºï¼Œæ‰€ä»¥å°ç£è‡ªå·±åªèƒ½å¾é ­æ‘¸ç´¢ï¼Œæ²’æœ‰éå¾€çš„æŸç¸›æ˜¯åŠ£å‹¢ä¹Ÿæ˜¯å„ªå‹¢\næœ‰å€‹æ•…äº‹æ˜¯æ—¥æœ¬çš„å›ºæ…‹ç«ç®­ç™¼å±•å¤ªå¥½ç¾åœ‹æœƒæ€•ï¼Œåè€Œè¼¸å‡ºæ¶²æ…‹ç«ç®­çµ¦æ—¥æœ¬ï¼Œé€éå¦ä¸€ç¨®æ–¹å¼é™åˆ¶æ—¥æœ¬çš„ç™¼å±• æ—¥æœ¬çš„å®‡å®™æ”¿ç­–ï¼ˆä¸‹ï¼‰ï¼šçµ‚çµè‡ªä¸»é–‹ç™¼ï¼Œç¾åœ‹å‘æ—¥æœ¬æä¾›æ¶²é«”ç‡ƒæ–™ç«ç®­æŠ€è¡“çš„å…©é»ç†ç”±\nç«ç®­çš„å™´å˜´èˆ‡ç‡ƒæ–™ å·¦åœ–ç‚ºç«ç®­çš„ç‡ƒæ–™ï¼Œæ“šèªªå°±åƒæ˜¯å¡‘è† è·Ÿæ¨¹è„‚çš„æè³ªï¼Œç‡ƒç‡’æœƒç”¢ç”Ÿå¤§é‡æ°£é«”ï¼Œä¸­é–“æœ‰ä¸€å€‹æ´æœƒè®“æ°£é«”å¾€å¤–æ’æ”¾\nå³åœ–çš„ä¸Šæ–¹æ˜¯å™´å˜´ï¼Œä¸‹æ–¹æ˜¯æ©Ÿé›»çµ„ï¼Œå™´å˜´ä¹Ÿæ˜¯å¤§æœ‰å­¸å•ï¼Œåœ¨ä½å¤ªç©ºæœƒç”¨å°å™´å˜´ï¼Œé«˜å¤ªç©ºå‰‡ç”¨å¤§å™´å˜´ï¼Œä¸»è¦æ˜¯ç‚ºäº†è®“ç‡ƒæ–™å™´å‡ºçš„æ°£é«”å¾—åˆ°æœ€å¤§çš„æ¨é€²å‹•åŠ›ï¼Œæ°£é«”æµå‹•é€Ÿåº¦åœ¨å°æ–¼éŸ³é€Ÿæ™‚æ´å£è¶Šå°å‰‡é€Ÿåº¦è¶Šå¿«ï¼Œä½†æ˜¯åˆ°è¶…éŸ³é€Ÿä¹‹å¾Œåè€Œæ˜¯æ´å£è¶Šå¤§é€Ÿåº¦è¶Šå¿«ï¼Œé€™ä¹Ÿå°±æ˜¯å™´å˜´è¨­è¨ˆæ˜¯å¤§åˆ°å°åœ¨å°åˆ°å¤§ï¼›\nå¦å¤–å™´å˜´å¤§å°ä¹Ÿæ˜¯ç‚ºäº†é…åˆå¤–ç•Œå¤§æ°£å£“åŠ›ï¼ŒåŒæ¨£æ˜¯æµé«”çš„ç‰¹æ€§ï¼Œç•¶æ’å‡ºæ°£é«”çš„å£“åŠ›èˆ‡å¤–ç•Œæ°£å£“ç›¸åŒæ™‚å¯ä»¥ç²å¾—æ›´å¤§çš„å‹•èƒ½ï¼Œæ‰€ä»¥é«˜å¤ªç©ºå› ç‚ºæ°£å£“ä½æ‰€ä»¥å™´å˜´è¦æ›´å¤§\nä»¥ä¸Šæ“šèªªæ˜¯æµé«”åŠ›å­¸æœ‰æ•™éçš„åŸç†ï¼Œæˆ‘è‡ªå·±æ²’æœ‰ä¿®éå¦‚æœæœ‰å¯«éŒ¯å†éº»ç…©ç³¾æ­£\né€™ä¹Ÿæ˜¯å¤šç¯€å¼ç«ç®­çš„è¨­è¨ˆåŸå› ä¹‹ä¸€ï¼Œä¸‹æ¬¡å†çœ‹ç«ç®­ç™¼å°„çš„éç¨‹ä¸å¦¨æ³¨æ„çœ‹çœ‹å™´å˜´çš„éƒ¨åˆ†\nç¢³çº–ç¶­ ç«ç®­è¦é«˜é€Ÿæ¨é€²åˆ°éå¸¸é™é çš„å½¼å²¸ï¼Œéœ€è¦å¾ˆå¤§çš„å‹•åŠ› \u0008/ å …å›ºåŒæ™‚è¼•é‡åŒ–çš„é‡é‡ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œé€šå¸¸æ˜¯ç”¨å¾ˆè–„çš„é‡‘å±¬æ‰“é€ ä¸€å±¤å¤–æ®¼ (åœ–ç‰‡å³ä¸Š)ï¼Œåœ¨ç”¨ç¢³çº–ç¶­çºç¹åœ¨å¤–é¢å¢åŠ å¼·åº¦ (å·¦ä¸‹)ï¼Œä¸€çµ„å››æ ¹ (å³ä¸‹)\nåœ–ç‰‡ä¸­çš„æ˜¯æ”¾ç‡ƒæ–™çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ç«ç®­çš„å¼•æ“ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ç™½è‰²ä¸­ç©ºçš„æ£’æ£’åŠ å¤§ç‰ˆï¼Œåœ–ç‰‡å³ä¸Šæ˜¯é‡‘å±¬æ®¼ï¼Œå¯¦éš›é•·ç´„ 1.2 å…¬å°ºï¼Œä½†ä»–éå¸¸å¾—è¼•ï¼Œæ‰€ä»¥æ‰è¦ç”¨å¤–é¢çš„é‡‘å±¬æ”¯æ¶ä¿è­·ï¼Œé¿å…è®Šå½¢\næœ€å¾Œç”¨ç¢³çº–çºç¹æŠ€è¡“ï¼Œå°‡é‡‘å±¬æ®¼çºç¹ï¼Œé€™é»åœ¨å½±ç‰‡ä¸­æœ‰æåˆ°æ˜¯ä¸€é–“ç†±å¿ƒçš„å» å•†å¹«å¿™åšçš„ï¼Œåœ¨å°è¦½éç¨‹ä¸­ä¹Ÿæåˆ°ä»–å€‘é€™å€‹çºç¹æŠ€è¡“å¾ˆä¸éŒ¯ï¼Œæœ€è¿‘é€šéäº†é©—è­‰å¯ä»¥å¹«å¿™åœ¨å¤ªç©ºç›¸é—œçš„ç”¢å“ ã€HTTP-3A ç ”ç™¼é€²åº¦ï½œç«ç®­ç¢³çº–ç¶­çºç¹å¤–æ®¼ã€‘ï¼Œå†æ¬¡æ‡‰è­‰äº†å°ç£çš„ç”¢æ¥­å¯¦åŠ›çœŸçš„å¾ˆæ£’ï¼Œåªæ˜¯æ²’æœ‰ä¸€å€‹å“ç‰Œè·Ÿæ•´åˆçš„é¾é ­\nä½†å¤§å¤šæ•¸çš„ç¢³çº–ç¶­éƒ½åªèƒ½ç”¨äººå·¥å»æ‹¼è²¼ï¼Œåƒæ˜¯ç¢³çº–ç¶­è…³è¸è»Šéƒ½æ˜¯ç´”æ‰‹å·¥ï¼Œè¤‡é›œçš„éƒ¨åˆ†é‚„æ²’è¾¦æ³•ç”¨æ©Ÿå™¨å–ä»£ï¼Œåœ¨ ARRC ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦è‡ªå·±è²·ç¢³çº–ç¶­çš„å¸ƒè‡ªå·±å‹•æ‰‹ï¼Œé€™ä½å¹«å¿™å°è¦½çš„åŒå­¸å°±è‡ªå·±å‹•æ‰‹åšäº†ä¸€å°å››ç¶­çš„ç¢³çº–ç¶­åˆ‡å‰²æ©Ÿ(ä¸‹åœ–)ï¼Œä»–èªªå¤–é¢ä¸€å°å¯èƒ½è¦ä¸Šç™¾è¬ï¼Œè‡ªå·± DIY åªèŠ±äº†äº”ã€å…­è¬è€Œå·²ï¼Œè€Œä¸”çœä¸‹å…©ã€ä¸‰å€‹äººåŠ›éå¸¸æ£’ï¼Œé€™ä½åŒå­¸æœ€å¾Œèªªä»–ç¾åœ¨æ‰å¤§å››ï¼Œå¾å¤§ä¸€å°±é–‹å§‹å¹«å¿™äº†ï¼Œæ»¿æ»¿çš„ respect! å¯æƒœå¿˜äº†å•åŒå­¸çš„å¤§å\nåœ–ç‰‡å·¦ä¸Šæ˜¯ç«ç®­å°–ç«¯çš„éƒ¨åˆ†ï¼Œå› ç‚ºè¦è€é«˜æº«æ‰€ä»¥ç”¨é‡‘å±¬çš„é¼»é ­ï¼Œæœ‰æåˆ°ç«ç®­é‹ç”¨çš„æ˜¯ç¢³çº–ç¶­èˆ‡é‡‘å±¬çš„æ··åˆä½¿ç”¨ï¼Œåœ¨é›¶ä»¶ä¹‹é–“æ˜¯é€éç‰¹æ®Šçš„è† æ°´å›ºå®šï¼Œèºçµ²åŸºæœ¬ä¸Šæ˜¯ä¸å—åŠ›çš„\néš¨æ‰‹æ‹æ‹ ä¸‰å¼µå°åœ–æ˜¯é‚„åœ¨ç ”ç™¼çš„ HTTP-3A å–”ï¼ å³ä¸‹è§’æ˜¯åˆ°æ™‚å€™æ¬é‹ç«ç®­çš„è¼‰å…·ï¼Œå› ç‚ºç«ç®­éå¸¸éå¸¸è¼•ï¼Œæ‰€ä»¥è·¯ä¸Šæ¬é‹æœƒæœ‰è®Šå½¢ï¼Œéœ€è¦æœ‰å¤–å±¤æ”¯æ¶ä¿è­·ï¼Œè¨˜å¾—åœ¨æŸéš»å½±ç‰‡æœ‰æåˆ°å°ç£åœ¨æ±éƒ¨ç™¼å°„é‚„ä¸éŒ¯ï¼Œç©©åº¦ä½æœ‰è¶³å¤ çš„åœ°çƒè‡ªè½‰é€Ÿåº¦ï¼ŒåŒæ™‚æ…£æ€§æœƒå¾€å¤ªå¹³æ´‹å°„æ¯”è¼ƒå®‰å…¨\nç¥ç™¼å°„é †åˆ©ä»¥åŠç„¡é è­¦å‡ºç¾çš„å³å®—ä¿¡æ•™æˆ\nçµèª å”±è¡°å°ç£çš„äººå¾ˆå¤šï¼Œä½†è‚¯å‡ºä¾†æ”¹è®Šçš„äººå¾ˆå°‘ï¼Œé€™æ¬¡åƒè§€çš„éç¨‹çœ‹åˆ°æœ‰ä¸€ç¾¤è¸å¯¦çš„äººåœ¨åŠªåŠ›åšä¸€ä»¶ä¸å¯æ€è­°ä½†é€æ­¥å¯¦ç¾çš„éç¨‹ï¼Œè¦ºå¾—æ»¿æ»¿çš„è¸å¯¦èˆ‡ç†±è¡€ï¼Œè‡ªå·±æœ‰é€™å€‹æ©Ÿæœƒå¯ä»¥ç”¨å¾®è–„çš„è´ŠåŠ©æ”¯æŒè¦ºå¾—å¾ˆé–‹å¿ƒï¼Œä¹ŸæœŸè¨±è‡ªå·±çš„æœªä¾†ä¹Ÿå¯ä»¥è¸å¯¦çš„èµ°ä¸‹å»\n","date":"2021-04-23T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-04-23-%E4%B8%80%E6%97%A5%E5%8F%83%E8%A7%80-arrc-%E5%AF%A6%E9%A9%97%E5%AE%A4/","title":"ä¸€æ—¥åƒè§€ ARRC å¯¦é©—å®¤"},{"content":"ã€è·¨ç¨‹å¼èªè¨€ä¸Šæ‰‹ã€‘ç³»åˆ—ç¬¬ä¸€ç¯‡ï¼Œæœ€è¿‘æ›å·¥ä½œå­¸ç¿’äº† Golang / Rubyï¼Œå¯ä»¥èªªæ˜¯è¨­è¨ˆç†å¿µè™•æ–¼å°ç«‹é¢çš„ç¨‹å¼èªè¨€ï¼Œåœ¨å­¸ç¿’ä¸­ä¸æ–·æ‹¿å…©è€…æ¯”è¼ƒï¼Œæ‰¾åˆ°å¾ˆå¤šæœ‰è¶£çš„åœ°æ–¹\nåœ¨é€™æ¨£çš„éç¨‹ä¸­ï¼Œæ…¢æ…¢æ‰¾å‡ºè‡ªå·±ä¸Šæ‰‹æ–°ç¨‹å¼èªè¨€çš„ patternï¼Œä¹Ÿå°±æ˜¯é€æ­¥å¡«è£œè‡ªæˆ‘ç–‘å•çš„éç¨‹ï¼Œåƒæ˜¯ã€Œæ€éº¼å®£å‘Šè®Šæ•¸ï¼Ÿã€ã€Œæ€éº¼å¯«æ¸¬è©¦ï¼Ÿã€ã€Œapi server / http request æ€éº¼ç™¼ï¼Ÿã€ã€Œä½µç™¼æˆ–æ•ˆèƒ½æ€éº¼è™•ç†ï¼Ÿã€ç­‰ç­‰å…±é€šçš„ç–‘æƒ‘é»\nåŠé–“æœ‰å¾ˆå¤šå–„å¿ƒäººå£«çš„æ•™å­¸ï¼Œä½†å¾€å¾€éƒ½ç¼ºä¸€é»æˆ‘æƒ³äº†è§£çš„è³‡è¨Šï¼Œä¾‹å¦‚ Google æœå°‹ã€ŒRuby æ•™å­¸ã€çš„ä¸­æ–‡ç´ æï¼Œè·‘å‡ºé€™å¹¾å€‹å¾ˆæ£’çš„æ•™å­¸\né«˜è¦‹é¾å¤§å¤§çš„ ç‚ºä½ è‡ªå·±å­¸ Ruby on Rails Ruby on Rails å¯¦æˆ°è–ç¶“ Ruby å®˜ç¶²çš„ äºŒååˆ†é˜ Ruby é«”é©— Ruby æ•™å­¸æœƒè¢«ç¶åœ¨ Rails æ•™å­¸ä¸­æˆ–è¨±æ˜¯ Ruby ç”Ÿæ…‹ç‰¹æœ‰çš„ç¾è±¡ï¼Œä½†æ™®éç¨‹å¼èªè¨€æ•™å­¸ä¹Ÿéƒ½ç¼ºå°‘\nTestingï¼šåŒ…å« Testing Framework / Unit Test / Mockã€Stub Moduleï¼šCore Module / Local Module æ€éº¼è¼‰å…¥ Concurrencyï¼šåº•å±¤å¦‚ä½•è™•ç†ä½µç™¼/å¹³è¡Œé‹ç®— ç¨‹å¼èªè¨€å¤šç”¨æ–¼å¾Œç«¯ï¼Œæ‰€ä»¥æˆ‘æœƒåœ¨æ„å¯« api server / http request çš„æ„Ÿè¦ºæ˜¯æ€æ¨£ å¯ä»¥èªªé€™å¹¾é»éƒ½æ˜¯æ¯”è¼ƒé€²éš/åç§‘çš„è­°é¡Œï¼Œä½†å°æˆ‘çš„å·¥ä½œå¾ˆé‡è¦ï¼Œä¹Ÿæ˜¯é€™ç³»åˆ—çš„èµ·æºï¼Œæˆ‘æƒ³è¦é‡æ–°å¯«ä¸€ä»½å°æˆ‘è‡ªå·±ä¾†èªªå®Œæ•´çš„ç¨‹å¼èªè¨€æ•™å­¸ï¼Œéç¨‹ä¸­æœƒæ‹¿æˆ‘å·²ç¶“ç†Ÿæ‚‰çš„ç¨‹å¼èªè¨€å¦‚ Javascript è·Ÿä¸€é»é»çš„ Golang åšå°æ¯”\nç›®æ¨™æœƒè‘—é‡æ–¼æœ‰ç¶“é©—çš„ç¨‹å¼è¨­è¨ˆå¸«ï¼Œå·²ç¶“ç†Ÿç·´ä»»ä¸€ç¨‹å¼èªè¨€ï¼Œæƒ³è¦å¿«é€Ÿä¸Šæ‰‹æˆ–æ˜¯å“å‘³å¦ä¸€é–€èªè¨€çš„äºº\nä»¥ä¸‹å…§å®¹æœƒåŒ…å«\nRuby è¨­è¨ˆç†å¿µèˆ‡èµ·æº åŸºç¤èªæ³• æ¨¡çµ„ æ¸¬è©¦ Http / API ç›¸é—œ å…¶ä»–è£œå…… å…§å®¹å¤§é‡åƒè€ƒä¸Šé™„çš„åƒè€ƒè³‡æ–™ï¼Œä¸¦èå…¥è‡ªå·±çš„æ·ºè¦‹ï¼Œæœƒéš¨è‘—ä½¿ç”¨æ™‚é–“çš„æ‹‰é•·æŒçºŒä¿®æ”¹ï¼Œæœ‰ä»€éº¼ä¸åŒçš„æ„è¦‹æ­¡è¿ç•™è¨€åˆ†äº«\n1. Ruby è¨­è¨ˆç†å¿µèˆ‡èµ·æº Ruby æ˜¯ä¸€é–€ Dynamic Languageï¼Œé‹è¡Œåœ¨ Ruby Virtual Machine ä¸Šï¼Œæœ¬èº«æ˜¯å¼±å‹åˆ¥ä½†æ²’æœ‰ JS ä¸­éš±å¼çš„è½‰å‹ (ex. 1 + \u0026ldquo;23\u0026rdquo;)ï¼Œåœ¨ 3.0 åŠ å…¥ Type safety å·¥å…· TypeProf å¹«åŠ©æª¢æŸ¥å‹åˆ¥å•é¡Œ\né€éç¯„ä¾‹ç°¡å–®çœ‹ä¸€ä¸‹ Ruby å¹¾å€‹ç‰¹åˆ¥çš„è¨­è¨ˆç†å¿µ\nRuby is designed to make programmers happy å‡ºè‡ªæ–¼ The Philosophy of Ruby A Conversation with Yukihiro Matsumoto, Part Iï¼ŒRuby çµ¦äºˆé–‹ç™¼è€…å¾ˆé«˜çš„è‡ªç”±åº¦\nå®šç¾© symbol åœ¨ Ruby çš„æ¡†æ¶ä¸‹ç”¢ç”Ÿè‡ªå·±çš„ DSLï¼Œä¾‹å¦‚ sinatra é€™å€‹ web frameworkï¼Œçœ‹ç¯„ä¾‹æœƒä»¥ç‚ºæ ¹æœ¬ä¸æ˜¯ ruby å¯«çš„ æ”¯æ´ Meta programming å¯ä»¥åœ¨ Runtime æ”¹è®Šé¡åˆ¥è¡Œç‚º å¯ä»¥è¤‡å¯«ä»»æ„çš„æ–¹æ³•ï¼ŒåŒ…å«åŸç”Ÿé¡åˆ¥ åŒä¸€ç¨®åŠŸèƒ½å¯ä»¥æœ‰éå¸¸å¤šç¨®å¯«æ³•ï¼Œå…‰æ˜¯è¿´åœˆå¯ä»¥ç”¨ while / for in / each / until / begin while ç­‰ Seeing Everything as an Object åœ¨ Ruby çš„ä¸–ç•Œä¸­ï¼Œå¹¾ä¹æ¯ä¸€å€‹è®Šæ•¸éƒ½æ˜¯ç‰©ä»¶ï¼ŒåŒ…å« 1+2 ä¹Ÿå¯ä»¥å¯«æˆ 1.+(2)ï¼Œ1 æœ¬èº«æ˜¯ Integer é¡åˆ¥è£¡é ­æœ‰ + é€™å€‹æ–¹æ³•\né€™è®“ Ruby å¾ˆé©åˆ OOPï¼Œä¹Ÿå¸¶ä¾†å¾ˆå¤šçš„å½ˆæ€§ï¼Œåƒæ˜¯åœ¨ operator overwrite\n1 2 3 4 5 6 7 8 9 10 11 12 13 class Integer alias :plus :+ def + (other) puts self.to_s + \u0026#34; is adding \u0026#34; + other.to_s self.plus other end end puts 1 + 2 # è¼¸å‡ºçµæœ # 1 is adding 2 # 3 Integer æ˜¯é è¨­é¡åˆ¥ï¼ŒRuby é‡åˆ°é¡åˆ¥é‡è¤‡å®£å‘Šæ™‚æœƒåˆä½µï¼Œæ¥è‘—æˆ‘å€‘åœ¨ Integer å®£å‘Š plus æ˜¯åŸæœ¬ + çš„åˆ¥åï¼Œæ¥è‘—è¦†å¯« + å…ˆæ‰“å°å‡º is adding å­—ä¸²åœ¨å›å‚³ï¼Œåœ¨ Ruby ä¸­é è¨­ function æœ€å¾Œä¸€è¡Œå³ä½¿ä¸é¡¯å¼å®£å‘Šä¹Ÿæœƒ return\né€éåŒ¿åå‡½å¼æ”¯æ´ Functional Programming Style åœ¨ Ruby ä¸–ç•Œä¸­ï¼Œä¸åƒ Javascript / Golang æŠŠ function è¦–ç‚ºä¸€ç­‰å…¬æ°‘\nåœ¨ç¨‹å¼èªè¨€ä¸­ï¼Œæ‰€è¬‚çš„ä¸€ç­‰å…¬æ°‘æ¢ä»¶æ˜¯\nå¯ä»¥å‚³å…¥ function ç•¶ä½œåƒæ•¸ å¯ä»¥è¢« function ç•¶ä½œ return å€¼ å¯ä»¥è¢«å„²å­˜æ–¼è³‡æ–™çµæ§‹ä¸­ä½¿ç”¨ ä½†æ˜¯ Ruby ä¹Ÿé‚„æ˜¯åŒ¿åå‡½å¼çš„èªæ³•ï¼Œå¤§è‡´å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 def sum(x) total = x proc { |y| x += y } end sum_five = sum 5 puts sum_five.call(5) puts sum_five.call(5) puts sum_five.call(5) å¾ŒçºŒæœƒæœ‰æ›´è©³ç´°è£œå……ï¼Œä½†è‡³å°‘ Ruby ä¸–ç•Œä¸­ä¹Ÿæ˜¯å¯ä»¥åšåˆ° functional programming çš„\nç¶œåˆä»¥ä¸Šï¼ŒRuby æ˜¯ä¸€é–€å½ˆæ€§å¾ˆå¤§ã€å¾ˆè‡ªç”±çš„èªè¨€ï¼Œé€™æ˜¯ä¸€æŠŠé›™é¢åˆƒï¼Œå°æ–¼æ–°æ‰‹å¯èƒ½ä¹Ÿä¸æ˜¯é€™éº¼å‹å–„ï¼Œç•¢ç«Ÿæœ‰å¤ªå¤šèªæ³•è·Ÿé—œéµå­—è¦å»ç†Ÿæ‚‰\nå¦‚ä½•å®‰è£ å¯ä»¥å¾å®˜ç¶²ä¸‹è¼‰å®‰è£ Installing Rubyï¼Œæˆ–æ˜¯å…ˆå®‰è£ Ruby ç‰ˆæœ¬ç®¡ç†å·¥å…·å¦‚ RVM\nå¥—ä»¶ç®¡ç† å®‰è£å®Œ ruby å¾Œï¼Œä¹ŸåŒæ™‚å®‰è£äº† gemï¼Œgem æ˜¯ ruby å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¯ä»¥å®‰è£æˆ–ç™¼ä½ˆè‡ªå·±çš„å¥—ä»¶\ngem æˆ‘ä¸€é–‹å§‹ç†è§£æˆ npmï¼Œä½† npm å±¤ç´šé«˜äº†ä¸€äº›ï¼Œä¾‹å¦‚ gem ä¸¦æ²’æœ‰åšåˆ°ç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼Œgem + bundle æ¯”è¼ƒæ˜¯ npm çš„çµ„åˆ\nè©³ç´°å¯åƒè€ƒ Ruby çš„ Rvm VS Gem VS Bundler çš„å·®åˆ¥\nåŸºç¤èªæ³• è®Šæ•¸å®£å‘Š ä¸ç”¨å®£å‘Šå‹åˆ¥ è®Šæ•¸å¯ä»¥æ”¹è®Šå‹åˆ¥ ä½†æ˜¯æ²’æœ‰éš±å¼çš„å‹åˆ¥è½‰æ› è®Šæ•¸çš„ scope åªæœ‰ç•¶å‰çš„ contextï¼Œä½†è¦æ³¨æ„åŒ¿åå‡½å¼æœƒè®€å–ç•¶å‰çš„ contextï¼Œä¸¦ä¸æœƒä¸€ç›´å¾€ä¸ŠæŸ¥æ‰¾ï¼Œé™¤éç”¨å…¨åŸŸè®Šæ•¸ $ é–‹é ­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 x = 123 x = \u0026#34;123\u0026#34; x = 123 + \u0026#34;123\u0026#34; # æ‹‹éŒ¯ TypeError (String can\u0026#39;t be coerced into Integer) sum = 5 def func puts sum # æ‹‹éŒ¯ end 1.upto(5) { |i| sum += i } # é€™æ¨£æ˜¯å¯ä»¥çš„ï¼Œå› ç‚º block æ˜¯ç”¨å®£å‘Šç•¶å‰çš„ context $sum = 5 # å…¨åŸŸè®Šæ•¸å¯ä»¥ def func puts $sum end å‘½åè¦å‰‡ è®Šæ•¸åç¨±å¸¸ç”¨è›‡å½¢å‘½åæ³• è®Šæ•¸å…¨å¤§å¯«ä»£è¡¨å¸¸æ•¸ï¼Œä½†æ˜¯å¸¸æ•¸è¢«æ”¹æœƒæœ‰ warning ä¸æœƒæœ‰éŒ¯èª¤ Class/Module åç¨±é–‹é ­å¤§å¯« 1 2 3 naming_convetion = 123 FIVE = 5 FIVE = 4 # warning: already initialized constant X Symbols å»ºç«‹å”¯ä¸€ä¸”ä¸å¯è®Šçš„ç‰©ä»¶ï¼Œç”¨ : é–‹é ­ï¼Œé‡è¤‡å®£å‘Šéƒ½æœƒæŒ‡å‘åŒä¸€ä»½è¨˜æ†¶é«”ä½ç½® (é€é object_id è­˜åˆ¥)ï¼Œè€Œå­—ä¸²æ¯ä¸€æ¬¡å®£å‘Šéƒ½æœƒåœ¨è¨˜æ†¶é«”ç”¢ç”Ÿæ–°çš„ä¸€ä»½ String Objectï¼Œå¦‚æœæ˜¯è¦å–®ç´”ç”¨ä¾†è­˜åˆ¥ Symbol æ•ˆèƒ½æœƒæ¯” String å¥½ä¸Šå¾ˆå¤šå–”\n1 2 3 4 5 6 7 8 9 hello = :hello world = :hello puts hello == world puts hello.object_id == world.object_id #true hello = \u0026#34;hello\u0026#34; world = \u0026#34;hello\u0026#34; puts hello == world puts hello.object_id == world.object_id #false Hash Ruby æœ‰ Hashï¼Œå¯ä»¥ç”¨ =\u0026gt; æˆ– : åˆ†éš” key valueï¼Œä½†æ˜¯å…©è€…æœ‰å¾ˆå¤§çš„å·®ç•°\n=\u0026gt; éå¸¸çš„è‡ªç”±ï¼Œkey å€¼å¯ä»¥æ˜¯ä»»æ„çš„å€¼ : çš„ key åªèƒ½æ˜¯ symbolï¼Œå¦‚æœæ”¾å­—ä¸²æœƒç›´æ¥è½‰æˆ symbol\nè¦éå¸¸å°å¿ƒ string è·Ÿ symbol æ˜¯ä¸åŒçš„ï¼Œå¯¦ä½œä¸Šå¾ˆå®¹æ˜“è¸©åˆ°é€™å€‹å‘ 1 2 3 4 5 6 7 a = { \u0026#34;123\u0026#34;: \u0026#34;123\u0026#34; } b = { \u0026#34;123\u0026#34; =\u0026gt; \u0026#34;123\u0026#34; } puts a[\u0026#34;123\u0026#34;] # nil puts a[:\u0026#34;123\u0026#34;] # \u0026#34;123\u0026#34; puts b[\u0026#34;123\u0026#34;] # \u0026#34;123\u0026#34; puts b[:\u0026#34;123\u0026#34;] # nil Ruby ä¸­å¹¾ä¹éƒ½æ˜¯ç‰©ä»¶ï¼Œæœ‰å…§å»ºå¾ˆå¤šä¾¿åˆ©çš„æ–¹æ³• 1 2 3 4 5 x = 1 puts x.methods # åˆ—å‡ºæ‰€æœ‰ Integer åŒ…å«çš„ method puts x.odd? # æ˜¯ä¸æ˜¯å¶æ•¸ puts x.class # é¡åˆ¥ puts x.to_s # è½‰æˆå­—ä¸² é™£åˆ— 1 2 3 4 5 arr = [1,2,3,4,5] puts arr.include?(2) puts arr.push 0 puts arr.pop loop / control flow æ¢ä»¶å¼ åŸºæœ¬çš„ if / elseif / else èˆ‡ä¸‰å…ƒåˆ¤æ–·å¼\n1 2 3 4 5 6 7 8 9 10 x = 1 if x.odd? puts \u0026#34;x is odd\u0026#34; elsif x.even? puts \u0026#34;x is even\u0026#34; else puts \u0026#34;never happen\u0026#34; end puts (x.odd?) ? \u0026#34;x is odd\u0026#34;:\u0026#34;x is even\u0026#34; switch case æ¡ç”¨ case / when / else èªæ³•ï¼Œä¸ç”¨åŠ  break case å¦‚æœæ²’æœ‰æ¥åƒæ•¸ï¼Œå‰‡ when æ¢ä»¶å¯ä»¥æ”¾ statement / å¦‚æœæœ‰æ¥åƒæ•¸ï¼Œå‰‡ when æ¢ä»¶æ”¾å¸¸æ•¸ å¦‚æœå¸Œæœ› case when çµæœè³¦å€¼çµ¦è®Šæ•¸ï¼Œå¯ä»¥ç”¨ when \u0026hellip; then 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 x = 1 case when x.odd? puts \u0026#34;x is odd\u0026#34; when x.even? puts \u0026#34;x is even\u0026#34; else puts \u0026#34;never happen\u0026#34; end case x when 1..10 puts \u0026#34;x is in 1 to 10\u0026#34; else puts \u0026#34;x is not in 1 to 10\u0026#34; end val = case x when 1..10 then \u0026#34;x is in 1 to 10\u0026#34; else \u0026#34;x is not in 1 to 10\u0026#34; end # val = \u0026#34;x is in 1 to 10\u0026#34; è¿´åœˆ æ–¹å¼å¾ˆå¤šç¨®\nå…ˆæª¢æŸ¥æ¢ä»¶çš„ for in / while / until å¾Œæª¢æŸ¥æ¢ä»¶çš„ begin \u0026hellip; (when/until) Enumerable ç‰©ä»¶å¯ä»¥ç”¨ each ä½†æ²’æœ‰å¸¸è¦‹ for(initialExpression; conditionExpression; incrementExpression) å®£å‘Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 arr = [1,2,3,4,5] i = 0 while i \u0026lt; arr.size do puts arr[i] i += 1 end i=0 until i \u0026gt;= arr.size puts arr[i] i += 1 end i=0 begin puts arr[i] i += 1 end while i \u0026lt; arr.size for i in arr do puts i end arr.each { |x| puts x } Error handling é€é raise æ‹‹å‡ºéŒ¯èª¤ é€é rescue æ¥éŒ¯èª¤ï¼Œå¯ä»¥æ›´é€²éšæŒ‡å®šéŒ¯èª¤é¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 begin #... process, may raise an exception raise ArgumentError rescue ArgumentError puts \u0026#34;ArgumentError\u0026#34; rescue =\u0026gt; error puts error #... error handler else #... executes when no error ensure #... always executed end é€²éšè³‡æ–™è«‹åƒè€ƒ How to Rescue Exceptions in Ruby\nFunction function ä¸ç”¨å®šç¾©å›å‚³å€¼ å‘¼å«å¯ä»¥çœç•¥æ‹¬è™Ÿ é è¨­æœ€å¾Œä¸€è¡Œæœƒå›å‚³ï¼Œä¸ç”¨åœ¨é¡¯ç¤ºå®£å‘Š return å¦‚æœå‘¼å«çš„åƒæ•¸æ•¸é‡è·Ÿå®£å‘Šä¸åŒæœƒæ‹‹å‡ºéŒ¯èª¤ 1 2 3 4 5 def add (a, b) a + b # ç­‰åŒæ–¼ return a + b end puts add 1,2 Class é è¨­ Class åç¨±é–‹é ­å¤§å¯« æ”¯æ´ç¹¼æ‰¿ Successor \u0026lt; Predecessor è¦å»ºç«‹ instance é€é Class.newï¼Œæœƒå‘¼å« class ä¸­çš„ private method initialize å®£å‘Š instance è®Šæ•¸ä»¥ @ é–‹é ­ / å®£å‘Š class static è®Šæ•¸ç”¨ @@ éœ€è¦é¡¯å¼æŒ‡å®šé‡å° instance è®Šæ•¸çš„ getter/setterï¼Œæˆ–æ˜¯ç”¨ attr_accessor/attr_writer/attr_reader å¢åŠ  æ”¯æ´ public/protected/privateï¼Œä½†è·Ÿå…¶ä»–èªè¨€çš„ private ä¸å¤ªåŒï¼Œä»¥ä¸‹ç¯€éŒ„è‡ªé«˜è¦‹é¾å¤§å¤§çš„æ–‡ç«  å› ç‚ºåœ¨ Ruby è£¡æ‰€è¬‚çš„ private æ–¹æ³•çš„ä½¿ç”¨è¦å®šå¾ˆç°¡å–®ï¼Œå°±åªæœ‰ä¸€æ¢ï¼šã€Œä¸èƒ½æ˜ç¢ºçš„æŒ‡å‡º receiverã€ã€‚ç”¨ç™½è©±æ–‡è¬›ï¼Œå°±æ˜¯ã€Œåœ¨å‘¼å« private æ–¹æ³•çš„æ™‚å€™ï¼Œå‰é¢ä¸å¯ä»¥æœ‰å°æ•¸é»ã€ã€‚ä¹Ÿå°±æ˜¯å› ç‚ºé€™æ¨£ï¼Œåœ¨ Ruby çš„ private æ–¹æ³•å…¶å¯¦ä¸åªé¡åˆ¥è‡ªå·±å…§éƒ¨å¯ä»¥å­˜å–ï¼Œå®ƒçš„å­é¡åˆ¥ä¹Ÿå¯ä»¥ï¼Œä¸¦æ²’æœ‰åƒå…¶å®ƒç¨‹å¼èªè¨€ä¸€æ¨£çš„ç¹¼æ‰¿é™åˆ¶\nå®šç¾© static method å¯ä»¥ç”¨ def self.methodï¼Œæˆ–æ˜¯ç”¨ class \u0026lt;\u0026lt; self æ²’æœ‰ interface / method overloading / polymorphism 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 class Person attr_accessor :name def initialize(name, age) @name = name @age = age end def hello puts \u0026#34;Hello, my name is #{@name}\u0026#34; end def self.show_specy puts \u0026#34;we are Mammals\u0026#34; end =begin ç­‰åŒæ–¼ä¸Šè€…ï¼Œæ­¤æ–¹æ³•é©å’Œæ–¼å¤§é‡å®šç¾© class \u0026lt;\u0026lt; self def show_specy puts \u0026#34;we are Mammals\u0026#34; end end =end protected def my_protected_method puts \u0026#34;my protected method\u0026#34; end private def my_little_secret puts \u0026#34;private methods\u0026#34; end end Person.show_specy p1 = Person.new(\u0026#34;yoyo\u0026#34;, 10) puts p1.name p1.name = \u0026#34;hello\u0026#34; # puts p1.age å°æ‡‰ç¬¬5é»ï¼Œä¸èƒ½ç›´æ¥å‘¼å« .age å–å¾— age è®Šæ•¸ class Teacher \u0026lt; Person def initialize(name, age, major) super(name, age) @major = major end def can_access_parent_private_method self.my_protected_method my_little_secret # é€™æ¨£å¯ä»¥è®€å– parent private method #self.my_little_secret end end t1 = Teacher.new(\u0026#34;Mark\u0026#34;, 10, \u0026#34;English\u0026#34;) t1.hello t1.can_access_parent_private_method t1.send :my_little_secret t1.send :my_protected_method Ruby ç‰©ä»¶æ¯”æƒ³åƒä¸­è¤‡é›œï¼Œå°¤å…¶æ˜¯æ”¯æ´ Meta programmingï¼Œé€²éšè³‡æ–™å¯ä»¥åƒè€ƒ Ruby çš„ç¹¼æ‰¿éŠ (1) ç‰©ä»¶å°å‘å¦‚ä½•å¯¦è¸\nåŒ¿åå‡½å¼ block / Proc / lambda block ä»£è¡¨ç¨‹å¼ç¢¼å€å¡Šï¼Œå°‘æ•¸ Ruby ä¸­ä¸æ˜¯ç‰©ä»¶çš„å­˜åœ¨ï¼Œå¿…é ˆä¾é™„åœ¨ function ä¸Šï¼Œé€é yeild å‘¼å« block åŸ·è¡Œï¼Œå–®è¡Œå®£å‘Šç”¨ {...}ï¼Œå¤šè¡Œç”¨ do ... end Proc æ˜¯ç‰©ä»¶ï¼Œä¸é™åˆ¶åƒæ•¸ï¼Œreturn æ™‚æ˜¯ä»£è¡¨ç•¶æ™‚çš„ context returnï¼Œé€é proc.call åŸ·è¡Œ lambda æ˜¯ç‰¹æ®Šçš„ Procï¼Œæœƒåš´æ ¼æª¢æŸ¥åƒæ•¸ï¼Œreturn å°±å¦‚åŒä¸€èˆ¬çš„ function return 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 1.upto(5).map {|ele| puts ele} # å¯ä»¥åˆ¤æ–·æ˜¯ä¸æ˜¯æœ‰ block è¢«å‚³å…¥ï¼Œå¦‚æœæœ‰å‰‡ç”¨ yeild å‘¼å«åŸ·è¡Œ def hello if block_given? yield(\u0026#34;world\u0026#34;) end end hello do |x| puts \u0026#34;message from hello: #{x}\u0026#34; end # Proc / lambda å¯ä»¥å„²å­˜æ–¼è®Šæ•¸å‚™ç”¨ my_proc = Proc.new{ |x| return puts \u0026#34;from proc #{x}\u0026#34; } my_lambda = lambda { |x| puts \u0026#34;from lambda #{x}\u0026#34; } def func(block) puts \u0026#34;before call\u0026#34; block.call(\u0026#34;func\u0026#34;) puts \u0026#34;after call\u0026#34; end func(my_lambda) # before call/n from lambda func/n after call # proc å®£å‘Šæ–¼æœ€ä¸Šå±¤ contextï¼Œæ‰€ä»¥ return æ™‚æœƒé€£å¸¶çµæŸæ•´å€‹ç¨‹å¼ func(my_proc) # before call/n from proc func æœ‰è¶£çš„èªæ³• \u0026amp;:symbol ç¶²è·¯ä¸Šæœ‰äº›èªªæ³•æ˜¯ {|x| x[:symbol]} çš„ç¸®å¯«ï¼Œè®“æˆ‘å€‘çœ‹ä¸‹å»\n1 2 3 4 5 6 7 8 9 10 11 12 class Person attr_reader :name def initialize(name) @name = name end end a = [ Person.new(\u0026#34;123\u0026#34;), Person.new(\u0026#34;2222\u0026#34;) ] name_list = a.map { |x| x.name } # å…©è€…ç›¸åŒ name_list = a.map(\u0026amp;:name) p name_list åƒæ•¸ç”¨ \u0026amp; é–‹é ­ä»£è¡¨åƒæ•¸æ˜¯ä»¥ Proc å‚³å…¥ï¼Œä»–è·Ÿä¸€èˆ¬çš„åƒæ•¸ argsæ˜¯åˆ‡é–‹çš„ 1 2 3 4 5 6 7 8 9 10 def some_method(*args, \u0026amp;block) puts \u0026#34;args: #{args.inspect}\u0026#34; puts \u0026#34;block: #{block.inspect}\u0026#34; end some_method(1,2,3, :whatever) # args: [1,2,3, :whatever] # block: nil some_method(1,2,3, \u0026amp;:whatever) # args: [1,2,3] # block: #\u0026lt;Proc:0x007fd23d010da8\u0026gt; åœ¨ Ruby å‘¼å« object method å¯ä»¥ç”¨ send çš„æ–¹å¼ 1 2 3 4 5 6 7 class Person attr_reader :name def initialize(name) @name = name end end p Person.new(\u0026#34;123\u0026#34;).name == Person.new(\u0026#34;123\u0026#34;).send(:name) \u0026amp;:symbol å¯¦éš›ä¸Šæœƒå»å‘¼å« :symbol#to_proc ï¼Œè€Œåœ¨ Symbol ä¸­æœ‰å®šç¾© to_proc è¡Œç‚ºï¼Œä¹Ÿæœƒæœ‰äººå»è‡ªå®šç¾© class ä¸­çš„ to_proc æ–¹æ³• 1 2 3 4 5 6 7 class Symbol def to_proc Proc.new do |receiver| receiver.send self end end end ç¶œåˆä¸Šè¿°ï¼Œå¯ä»¥æ‹†è§£æˆ\n1 2 3 4 5 6 7 a = [ Person.new(\u0026#34;123\u0026#34;), Person.new(\u0026#34;2222\u0026#34;) ] puts a.map(\u0026amp;:name) # å¯ä»¥æ‹†è§£æˆä¸‹è€… puts a.map { |x| x.send(:name) } ä¹Ÿå°±æ˜¯ receiver æœƒæ”¶åˆ° symbol çš„æ–¹æ³•å‘¼å«ï¼Œåƒè€ƒè‡ª What does map(\u0026amp;:name) mean in Ruby?\nå…¶ä»–å„ªç§€çš„è³‡è¨Š\nRuby æ¢ç´¢ï¼šBlocks æ·±å…¥æ·ºå‡º [Ruby] å¦‚ä½•ç†è§£ Ruby Block Concurrency \u0026amp; Parallelism Ruby æ”¯æ´ Process ï¼Œå¯ç”¨æ–¼è™•ç† CPU-Heavy issue Ruby åœ¨ 2.0 å°å…¥ Cope on Writeï¼Œç•¶ process fork æ™‚å¦‚æœ value æ²’æœ‰æ”¹å‹•å‰‡ä½¿ç”¨åŒä¸€ä»½è¨˜æ†¶é«”ç©ºé–“ï¼Œé™ä½ fork å°æ–¼è¨˜æ†¶é«”è³‡æºç„¡è¬‚çš„ä½”ç”¨\nRuby æ”¯æ´ Threadï¼Œé©ç”¨æ–¼è™•ç† IO Eventï¼Œä½†å¦‚æœæ˜¯ CPU-Heavy issue å‰‡æ²’æœ‰å¹«åŠ©ï¼Œå› ç‚º Ruby æœ‰ GIL (Global Interpreter Lokc) æ‰€ä»¥ç„¡æ³•ä½µç™¼ï¼Œä¸€æ¬¡åªèƒ½åŸ·è¡Œä¸€å€‹ threadï¼Œé€™è·Ÿ Ruby VM å¯¦ä½œæœ‰é—œï¼Œå¦‚æœæ˜¯ JRuby å‰‡æ²’æœ‰æ­¤å•é¡Œ Thread releases GIL when it hits blocking I/O operations such as HTTP requests, DB queries, writing / reading from disk and even sleep\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 require \u0026#39;benchmark\u0026#39; ELE_AMOUNT = 1000 PROCESS_NUM = 2 arr = Array.new(ELE_AMOUNT) { Array.new(ELE_AMOUNT){rand(1...9)}} Benchmark.bm(10) do |bm| bm.report(\u0026#34;seq\u0026#34;) do total = arr.reduce(0) do |sum, ele| sum + ele.sum end end bm.report(\u0026#34;parallel\u0026#34;) do read, write = IO.pipe 1.upto(PROCESS_NUM).map do |i| Process.fork do p i step = (ELE_AMOUNT * 1.0 / PROCESS_NUM).ceil start_ele = step * (i-1) total = arr[start_ele, step].reduce(0) do |sum, ele| sum + ele.sum end write.puts total end end Process.wait end bm.report(\u0026#34;thread\u0026#34;) do total = 0 threads = [] 1.upto(PROCESS_NUM).map do |i| t = Thread.new do step = (ELE_AMOUNT * 1.0 / PROCESS_NUM).ceil start_ele = step * (i-1) total += arr[start_ele, step].reduce(0) do |sum, ele| sum + ele.sum end end threads \u0026lt;\u0026lt; t end threads.each(\u0026amp;:join) end end Fiber æ˜¯é¡ä¼¼æ–¼ goroutine çš„æ¦‚å¿µï¼Œæ›´è¼•é‡çš„ user space threadï¼Œä¸»è¦ç”¨ä¾†éåŒæ­¥çš„æ’ç¨‹ï¼Œé©ç”¨æ–¼çµåˆ Non-blocking IOï¼Œå› ç‚º Fiber åœ¨ Context Switch æ¯” Thread æ›´ç‚ºè¼•é‡\nç¯„ä¾‹ä¾†æºï¼šIntroduction to Concurrency Models with Ruby. Part I 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 EventMachine.run do Fiber.new { page = http_get(\u0026#39;http://www.google.com/\u0026#39;) if page.response_header.status == 200 about = http_get(\u0026#39;https://google.ca/search?q=universe.com\u0026#39;) # ... else puts \u0026#34;Google is down\u0026#34; end }.resume end def http_get(url) current_fiber = Fiber.current http = EM::HttpRequest.new(url).get http.callback { current_fiber.resume(http) } http.errback { current_fiber.resume(http) } Fiber.yield end Ruby 3.0 å°å…¥äº†åŸºæ–¼ Actor æ¨¡å¼çš„ Ractor ï¼ŒçœŸæ­£èƒ½åšåˆ°åˆ©ç”¨ Thread é”æˆ Parallelismï¼Œä»¥å‰æœƒéœ€è¦ GIL æ˜¯ç‚ºäº†é¿å… multi thread ä¹‹ä¸‹çš„ deadlock / race condition ç‹€æ³ï¼Œä½†æ˜¯åœ¨ Ractor ä¸­åŸºæœ¬ä¸Š Object éƒ½ä¸æœƒè¢«å…±äº«ï¼Œåƒè€ƒ Share Memory By Communicating æœ‰äº›æ–‡ç« æœƒå¯« Guildï¼Œä½†æˆ‘æŸ¥ Ruby å®˜æ–¹æ–‡ä»¶åªæœ‰çœ‹åˆ° Ractor Do not communicate by sharing memory; instead, share memory by communicating.\næ„å³å¦‚æœå¸Œæœ›åœ¨å¤šå€‹ Thread ä¸­å…±äº«è³‡è¨Šï¼Œä¸è¦é€éå…±äº«è¨˜æ†¶é«”ä¾†æºé€šï¼Œè€Œæ˜¯é€éé€šä¿¡äº¤æ›è³‡æ–™é”åˆ°å…±äº«è³‡æ–™çš„ç›®çš„ å› ç‚ºå…±äº«è¨˜æ†¶é«”å°±å¿…é ˆè™•ç† lockï¼Œæ¥è‘—å°±è¦æ“”å¿ƒ dead lock ç­‰å•é¡Œ\nå¦‚æœä¸å…±äº«è¨˜æ†¶é«”ï¼Œç›´æ¥å°‡è³‡æ–™é€éé€šé“ç­‰æ–¹å¼å‚³éï¼Œå°±ä¸ç”¨æ“”å¿ƒä»¥ä¸Šçš„å•é¡Œï¼Œä¹Ÿå¯ä»¥æ›´å¥½çš„ä¸¦è¡Œé‹ç®—\nå„ªè‰¯çš„è³‡æºåƒè€ƒ\nRuby Concurrency and Parallelism: A Practical Tutorial Introduction to Concurrency Models with Ruby. Part I / II RubyConf Taiwan 2019 - The Journey to One Million by Samuel Williams Module Module æä¾›é¡ä¼¼æ–¼ Namespace è§’è‰²ï¼Œå¯ä»¥è‡ªå®šç¾©æ–¹æ³•èˆ‡å¸¸æ•¸ä¸ç”¨æ“”å¿ƒèˆ‡å…¶ä»–äººè¡çª Module ä¸èƒ½è¢«å¯¦é«”åŒ– (ä¹Ÿå°±æ˜¯ä¸èƒ½è¢« new)ï¼Œä¸»è¦é€é mixin æ“´å…… Class åœ¨å…±äº«å¯¦ä½œæ–¹é¢ï¼ŒRuby ä¸€å€‹ Class åªèƒ½ç¹¼æ‰¿ä¸€å€‹ Parentï¼Œä½†æ˜¯ Module å¯ä»¥ mixin å¤šå€‹ï¼Œåœ¨æ²’æœ‰ç›´æ¥é—œä¿‚çš„æƒ…æ³ä¸‹æƒ³è¦è·¨å¤šå€‹ Class å…±äº«æŸäº›ç‰¹å®šçš„æ–¹æ³•ï¼ŒModule æ˜¯ä¸éŒ¯çš„é¸æ“‡ ä½¿ç”¨ Mixin è¦å°å¿ƒå¤šå€‹ Module å¯èƒ½æœƒæœ‰ä¸é æœŸçš„äº’ç›¸å¹²æ“¾ï¼Œä¾‹å¦‚ä¿®æ”¹åŒä¸€å€‹ instance è®Šæ•¸ï¼Œæœ‰ç‹€æ…‹è¦ç´€éŒ„è¨˜å¾—å–ä¸€å€‹æ¯”è¼ƒç‰¹æ®Šçš„åç¨± å¦‚æœ Module ä¸­æœ‰ Class å®£å‘Šï¼Œè¦æŒ‡å®šè©² Class å¯ä»¥ç”¨é›™å†’è™Ÿ :: é€£æ¥ä¾‹å¦‚ Module Name::Class Name 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ##### calculator.rb module Greeting def sayhi puts \u0026#34;hello, #{@name}\u0026#34; end class Hi end end ###### main.rb require_relative \u0026#39;./calculator\u0026#39; class Person \u0026lt; Greeting::Hi # é€é include é”åˆ° mixin æ•ˆæœ include Greeting def initialize(name) @name = name end end p = Person.new(\u0026#34;yoyo\u0026#34;) p.sayhi Module é™¤äº†å¯ä»¥è¢« include å¤–ï¼Œé‚„æœ‰ extend è·Ÿ prependï¼Œè«‹åƒè€ƒ Ruby çš„ç¹¼æ‰¿éŠ (2) â€” Module çš„ includeã€prepend å’Œ extend\nç¨‹å¼ç¢¼æ‹†åˆ†æª”æ¡ˆ æŠŠå…¨éƒ¨ç¨‹å¼ç¢¼å¡åœ¨åŒä¸€å€‹æª”æ¡ˆååˆ†çš„å¯æ€•ï¼Œé€éé©æ™‚çš„æ‹†åˆ†å¯ä»¥è®“ç¨‹å¼ç¢¼æ›´å¥½ç¶­è­·ï¼Œåœ¨ Ruby ä¸­å¦‚æœè¦ include å…¶ä»–æª”æ¡ˆçš„å®£å‘Šï¼Œå¯ä»¥ç”¨ require_relative 'æª”æ¡ˆæœ¬èº«çš„ç›¸å°è·¯å¾‘'çš„æ–¹å¼\nç›®å‰çœ‹èµ·ä¾†åªæœ‰å¸¸æ•¸ã€Moduleã€Class æœƒè¢«è‡ªå‹• exportï¼Œé‚„å†æ‰¾åˆ°ç›¸é—œçš„æ–‡ä»¶èªªæ˜\nrequire ç¸½å…±æœ‰å¹¾ç¨®\nrequireï¼š å¦‚æœæ˜¯ç›¸å°è·¯å¾‘ï¼Œå‰‡æ ¹æ“š $LOCAL_PAHT è¨­å®šå»æ‰¾å°æ‡‰çš„ libraryï¼Œé€šå¸¸æ˜¯ç”¨ä¾†æ‰¾å¤–éƒ¨ç›¸ä¾æˆ–æ˜¯ gem å¦‚æœæ˜¯çµ•å°è·¯å¾‘ï¼Œå‰‡ç›´æ¥è¼‰å…¥å°æ‡‰æª”æ¡ˆ require_local:\né€éæª”æ¡ˆçš„ç›¸å°è·¯å¾‘æ‰¾åˆ°æª”æ¡ˆï¼Œä¸»è¦æ˜¯ç”¨æ–¼åœ¨è‡ªå·±å°ˆæ¡ˆä¸­çš„å…¶ä»–æª”æ¡ˆ Testing Ruby ä¸¦æ²’æœ‰å…§å»ºçš„ Test Frameworkï¼Œè©•ä¼°å¾Œé¸ç”¨ RSpecï¼Œæä¾› TDD/BDD Style èªæ³•ï¼Œé€é describe / it çµ„åˆæ¸¬è©¦æ¡ˆä¾‹\næ…£ä¾‹æ˜¯å°ˆæ¡ˆæ ¹ç›®éŒ„å»ºç«‹ spec ç›®éŒ„ï¼Œå¾…æ¸¬é …ç›®å°æ‡‰æª”æ¡ˆååŠ ä¸Š _spec çµå°¾ Unit Test æ”¯æ´ before / after / around(before + each)ï¼ŒåŸ·è¡Œé »ç‡åˆ†æˆ each / all / suite suite æ˜¯åœ¨æ•´å€‹ test file åªæœƒè·‘ä¸€æ¬¡ï¼Œall å‰‡æ˜¯æ¯å€‹ describe éƒ½æœƒåŸ·è¡Œä¸€æ¬¡\nå¦‚æœæ˜¯æœ‰è®Šæ•¸è¦åœ¨æ¯ä¸€æ¬¡ test case å‰åŸ·è¡Œï¼Œå¯ä»¥ç”¨ before(:each)ï¼Œæˆ–æ˜¯ç”¨ let(è®Šæ•¸åç¨±){å›å‚³å€¼} ä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„é‹è²»è¨ˆç®—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 require(\u0026#39;rspec\u0026#39;) require_relative \u0026#39;../calculator\u0026#39; describe Calculator do let(:calculator) { Calculator.new } it \u0026#39;small package should get $100 fee\u0026#39; do expect(calculator.fee(1, 5)).to eq(100) end it \u0026#39;medium size should get $500 fee\u0026#39; do expect(calculator.fee(10, 5)).to eq(500) end before do @calculator = Calculator.new end around do |t| p \u0026#34;before each test\u0026#34; t.run p \u0026#34;after each test\u0026#34; end it \u0026#39;large size should get $700 fee\u0026#39; do expect(@calculator.fee(100, 10)).to eq(750) end end Stub / Mock / Spy RSpec æä¾› mock æ–¹æ³•å«åš double (å‡ºè‡ªæ–¼ stunt double æ¼”å“¡æ›¿èº«)\ndouble å¯ä»¥æ†‘ç©ºç”¢ç”Ÿç‰©ä»¶ï¼Œå¯ä»¥è‡ªå®šç¾© function èˆ‡å›å‚³å€¼ double å¯ä»¥åªè¦†å¯«ç‰¹å®šæ–¹æ³•çš„å›å‚³å€¼ allow(instance).to receive(method).and_return(value) spy ä¸æ”¹æ–¹æ³•çš„å¯¦ä½œï¼Œåªç¢ºèªæœ‰æ²’æœ‰è¢«å‘¼å«ï¼Œä»¥åŠç¢ºèªå‚³å…¥çš„åƒæ•¸ä»¥åŠå‘¼å«é †åºæ˜¯å¦å¦‚é æœŸ æ¯ä¸€å€‹ test case å¾Œéƒ½æœƒè¢«è‡ªå‹• restore å› ç‚ºæ˜¯å‹•æ…‹èªè¨€ï¼Œæ‰€ä»¥è¦ \u0026ldquo;double(string)\u0026rdquo; ç­‰æ–¹æ³•éƒ½æ˜¯å¯ä»¥çš„ é‹è²»è¨ˆç®—åŠ ä¸Šä¸€å€‹ VIP æª¢æŸ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 class VIP_Service def is_vip? raise \u0026#34;do some query\u0026#34; end end describe let(:calculator) do vip_service = VIP_Service.new # é€™è£¡é€é mock å‹•æ…‹æ”¹è®Š allow(vip_service).to receive(:is_vip?).and_return(false) Calculator.new(vip_service) end end spy çš„æ¡ˆä¾‹è«‹çœ‹å®˜æ–¹æ–‡ä»¶ç¯„ä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 require \u0026#39;rspec\u0026#39; class Invitation def deliver(email) p email end end describe \u0026#34;Invitation\u0026#34; do let(:invitation) { spy(\u0026#34;invitation\u0026#34;) } before do invitation.deliver(\u0026#34;foo@example.com\u0026#34;) invitation.deliver(\u0026#34;bar@example.com\u0026#34;) end it \u0026#34;passes when a count constraint is satisfied\u0026#34; do # é€é have_recieved çœ‹æ–¹æ³•æœ‰æ²’æœ‰è¢«å‘¼å« expect(invitation).to have_received(:deliver).twice end it \u0026#34;passes when an order constraint is satisifed\u0026#34; do # åŠ ä¸Š with æª¢æŸ¥æ–¹æ³•å‘¼å«æ™‚å‚³å…¥çš„åƒæ•¸ # åŠ ä¸Š ordered ä»£è¡¨è¦æŒ‰ç…§æ­¤é †åºå‘¼å« expect(invitation).to have_received(:deliver).with(\u0026#34;foo@example.com\u0026#34;).ordered expect(invitation).to have_received(:deliver).with(\u0026#34;bar@example.com\u0026#34;).ordered end end HTTP Request \u0026amp; API Server Ruby ä¸¦æ²’æœ‰æä¾› http server çš„å°è£ï¼Œåªæœ‰ tcp serverï¼Œæ‰€ä»¥æˆ‘å€‘é¸ç”¨ Rack é€™ä¸€å¥— libraryï¼Œä»–è¢« Ruby ç”Ÿæ…‹åœˆå»£æ³›æ¡ç”¨çš„åº•å±¤æ¡†æ¶ï¼Œå¦‚ RoR ä¹Ÿæ˜¯\nRack provides a minimal, modular, and adaptable interface for developing web applications in Ruby.\nAPI Server æ–°å¢ server.ruï¼Œé€é $rackup server.ru å•Ÿå‹•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 require \u0026#39;rack\u0026#39; require \u0026#39;json\u0026#39; rack_proc = lambda { |env| req = Rack::Request.new(env) case req.request_method + \u0026#34;:\u0026#34; + req.path_info when \u0026#34;GET:/hello\u0026#34; return [200, { \u0026#34;content-type\u0026#34;=\u0026gt; \u0026#34;application/json\u0026#34; }, [ { \u0026#34;hello\u0026#34; =\u0026gt; req.params[\u0026#34;name\u0026#34;] }.to_json ]] when \u0026#34;POST:/world\u0026#34; body = JSON.parse req.body.gets return [200, { \u0026#34;content-type\u0026#34;=\u0026gt; \u0026#34;application/json\u0026#34; }, [ { \u0026#34;hello\u0026#34; =\u0026gt; body[\u0026#34;name\u0026#34;]}.to_json ]] else return [406, { \u0026#34;content-type\u0026#34;=\u0026gt; \u0026#34;html/txt\u0026#34; }, [\u0026#39;not_implemented_yet\u0026#39;]] end } run rack_proc HTTP Request åƒè€ƒ 5 ways to make HTTP requests in Ruby\n1 2 3 4 5 6 7 require \u0026#34;http\u0026#34; response = HTTP.get(\u0026#34;http://localhost:9292/hello\u0026#34;, :params =\u0026gt; {:name =\u0026gt; \u0026#34;world\u0026#34;}) p response.parse response = HTTP.post(\u0026#34;http://localhost:9292/world\u0026#34;, :body =\u0026gt; {:name =\u0026gt; \u0026#34;jojo\u0026#34; }.to_json) p response.parse çµèª å¯«éæœ€é•·çš„æ–‡ç« ï¼Œæ•´ç†äº†é€™ä¸€å€‹ç¦®æ‹œä¸Šæ‰‹ Ruby çš„éç¨‹ï¼ŒRuby å¯¦éš›ä¸Šé‚„æœ‰éå¸¸å¤šçš„ é»‘é­”æ³•ï¼Œè·Ÿæ–°åŒäº‹å€‘ä¸€èµ·ä¸Šæ‰‹çš„éç¨‹ä¸æ–·ç™¼ç¾é©šå–œ(æ?!)\nå¿…é ˆå¦ç™½èªªä¸Šæ‰‹åˆ°ç¾åœ¨æ²’æœ‰å¾ˆæ„› Rubyï¼Œå› ç‚ºå¤ªè‡ªç”±äº†ï¼Œåˆæœ‰å¤ªå¤šé—œéµå­—è·Ÿå¯«æ³•ï¼Œå¯èƒ½è¦åœ¨ä¸€æ®µæ™‚é–“ç†Ÿæ‚‰ï¼Œä¹‹å¾Œå†ä¾†æ…¢æ…¢è£œå……\n","date":"2021-04-02T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-04-02-%E8%B7%A8%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80%E4%B8%8A%E6%89%8Bruby-%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/","title":"ã€è·¨ç¨‹å¼èªè¨€ä¸Šæ‰‹ã€‘Ruby åŸºç¤æ•™å­¸"},{"content":"ä¸Šé 91 è€å¸«çš„ TDD å¾Œï¼Œé–‹å§‹æ³¨é‡ç¨‹å¼èªè¨€æ”¯æ´çš„æ¸¬è©¦æ¡†æ¶ï¼Œç·¨å¯«æ¸¬è©¦ä»£ç¢¼èˆ‡å¯«å‡ºå®¹æ˜“å¯«æ¸¬è©¦çš„ä»£ç¢¼æ˜¯å¾ˆé‡è¦çš„ä¸€ä»¶äº‹ï¼Œå¥½æ¸¬è©¦çš„ä»£ç¢¼é€šå¸¸å¥½ç¶­è­·ï¼Œå› ç‚ºé€šå¸¸ä»£è¡¨æœ‰æ›´ä½çš„è€¦åˆæ€§ã€ç‰©ä»¶ä¾è³´é—œä¿‚æ˜ç¢ºç­‰ï¼Œèªªæ˜¯ã€Œé€šå¸¸ã€ä¹Ÿä»£è¡¨ä¸æ˜¯é€™éº¼çµ•å°ï¼›ä½†åä¹‹ ä¸å®¹æ˜“å¯«æ¸¬è©¦çš„ä»£ç¢¼å¾€å¾€éƒ½æ˜¯æœ‰å¥‡æ€ª smell çš„\né—œæ–¼æ¸¬è©¦æ¡ˆä¾‹çš„ç¨®é¡è«‹åƒè€ƒ 91 è€å¸«çš„ Unit Test - Stub, Mock, Fake ç°¡ä»‹\nä»¥ä¸‹å°‡åˆ†äº«å¦‚ä½•åœ¨ Golang ä¸­ç·¨å¯«\nå–®å…ƒæ¸¬è©¦ å¦‚ä½• Stub/Mock å¤–éƒ¨ç›¸ä¾ å¦‚ä½•é‡å° http handler åš http request å‡è«‹æ±‚æª¢æŸ¥ è‡ªå·±é–‹å§‹çœŸæ­£å¯« Golang ä¹Ÿæ˜¯é€™å¹¾å€‹ç¦®æ‹œï¼Œæœ‰ä¸€äº›å‘½åã€å¯«æ³•ä¸æ­£ç¢ºï¼Œç…©è«‹æŒ‡æ•™ï¼Œä½†é‡å°æ¸¬è©¦çš„æœ¬èº«æ‡‰è©²æ˜¯æ²’ä»€éº¼å•é¡Œçš„\nç›®å‰æ¡ç”¨ Ginkgo + gomock + httptest çµ„åˆçš„æ¸¬è©¦å·¥å…·\nä»¥ä¸‹æˆ‘å€‘å°‡å¯«ä¸€å€‹ç°¡å–®çš„åŒ¯ç‡å…Œæ›è¡¨ï¼Œç”¨æˆ¶è¼¸å…¥æ—¢æœ‰çš„å¹£åˆ¥ / æ¬²å…Œæ›çš„å¹£åˆ¥ / æ•¸é‡ï¼ŒServer å›å‚³å…Œæ›å¾Œçš„æ•¸é‡ï¼Œç¨‹å¼ç¢¼æ–¼æ­¤ golang-exchange-currency\nä»¥ä¸‹æ˜¯ç¨‹å¼ç¢¼çµæ§‹\nmain.go: å•Ÿå‹• http server src/exchange_currency_model.go: æ¨¡æ“¬å»è³‡æ–™åº«è®€å–åŒ¯ç‡å…Œæ›è¡¨ src/currency_exchange_handler.go: http handlerï¼Œè™•ç† request èˆ‡ response å–®å…ƒæ¸¬è©¦ é¦–å…ˆè¦æ±ºå®šæ¸¬è©¦æ¡†æ¶ï¼Œé€™éƒ¨åˆ†è©•ä¼°é åŸç”Ÿçš„testingã€Testifyï¼Œæœ€å¾Œé¸æ“‡äº† Ginkgoï¼Œæœ€å¤§åŸå› æ˜¯ç†Ÿæ‚‰åŸæœ¬ Nodejsçš„ Decribe / It çµ„ç¹” test case çš„æ–¹å¼ï¼Œä»¥åŠæœ‰æ–¹ä¾¿çš„ BeforeEach å¯ä»¥æŠ½å‡ºé‡è¤‡æ¸¬è©¦è¡Œç‚ºçš„éƒ¨åˆ†ï¼Œä¾‹å¦‚åœ¨æ¯å€‹æ¸¬è©¦æ¡ˆä¾‹ä¹‹å‰éƒ½å…ˆ new å¥½ object\né€™äº›åœ¨ testing / Testify éƒ½è¦é¡å¤–çš„åŠŸå¤«è™•ç†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import ( . \u0026#34;github.com/onsi/ginkgo\u0026#34; . \u0026#34;github.com/onsi/gomega\u0026#34; ) var _ = Describe(\u0026#34;currency exchange\u0026#34;, func() { c := \u0026amp;CurrencyExchangeHandler{} .... BeforeEach(func() { c = NewCurrencyExchangeHandler(e) }) It(\u0026#34;should get 0 if amount is 0\u0026#34;, func(done Done) { .... Expect(c.Exchange(\u0026#34;US\u0026#34;, \u0026#34;TW\u0026#34;, 0)).To(Equal(0)) close(done) }) .... } Stub/Mock Stub å°ˆæ³¨æ–¼æ¸¬è©¦ç‰©ä»¶æœ¬èº«ï¼Œåªæ˜¯æŠŠå¤–éƒ¨ç›¸ä¾çš„æ–¹æ³•å¡ä¸€å€‹è¨­å®šå€¼å›å‚³ï¼›\nMock å‰‡å»¶ä¼¸ Stubï¼Œé™¤äº†å¡å›å‚³å€¼å¤–ï¼Œè€Œå¤–æª¢æŸ¥è¢«å‘¼å«ç‰©ä»¶çš„å‚³å…¥å€¼ / å‘¼å«æ¬¡æ•¸ / ç‹€æ…‹æ”¹è®Šç­‰éæ¸¬è©¦ç‰©ä»¶æœ¬èº«çš„ç‹€æ…‹\nåœ¨ Golang ä¸­ï¼Œä½¿ç”¨ gomock çœŸçš„æ˜¯è¶…ç´šæ–¹ä¾¿ï¼Œå¯ä»¥ç›´æ¥é‡å°æª”æ¡ˆç”¢å‡ºå°æ‡‰çš„ mock æª” exchange_price_model_mock.goï¼Œé€™é‚Šè¦æ³¨æ„ mock æ˜¯é‡å° interface ç”¢ç”Ÿï¼Œæ‰€ä»¥å¦‚æœä½ çš„æª”æ¡ˆä¸­æ²’æœ‰ interfaceï¼Œmock æª”å‡ºä¾†å°±æœƒæ˜¯ç©ºçš„\næ‰€ä»¥æˆ‘åœ¨ exchange_price_model.go ä¸­æœ‰å®šç¾©\n1 2 3 type IExchangePriceModel interface { GetExchangeRate(string, string, chan\u0026lt;- ExchangeRateResult) } æ¥è‘—åŸ·è¡Œ mockgen -source={è¦ mock çš„æª”æ¡ˆ} -destination={è¼¸å‡ºä½ç½®} -package={package åç¨±}ï¼Œä¾‹å¦‚ $ mockgen -source=exchange_price_model.go -destination=exchange_price_model_mock.go -package=srcï¼Œmockgen æ˜¯ gomock ç”¨ä¾†ç”¢ç”Ÿ mock æª”æ¡ˆçš„ binary åŸ·è¡Œå·¥å…·\nä¹‹å¾Œæ¸¬è©¦æ¡ˆä¾‹æ¡ç”¨ NewMockIExchangePriceModel é€™å€‹ç”± mockgen ç”¢ç”Ÿçš„ struct å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 var _ = Describe(\u0026#34;currency exchange\u0026#34;, func() { c := \u0026amp;CurrencyExchangeHandler{} var ( mockCtrl *gomock.Controller e *MockIExchangePriceModel ) BeforeEach(func() { mockCtrl = gomock.NewController(GinkgoT()) e = NewMockIExchangePriceModel(mockCtrl) c = NewCurrencyExchangeHandler(e) }) It(\u0026#34;should get 0 if amount is 0\u0026#34;, func(done Done) { e.EXPECT().GetExchangeRate(\u0026#34;US\u0026#34;, \u0026#34;TW\u0026#34;, gomock.Any()).Do(func(from string, to string, ch chan\u0026lt;- ExchangeRateResult) { ch \u0026lt;- ExchangeRateResult{ IsExists: true, ExchangeRate: 40, } }) Expect(c.Exchange(\u0026#34;US\u0026#34;, \u0026#34;TW\u0026#34;, 0)).To(Equal(0)) close(done) .... }) } ç·¨å¯« mock çš„æ–¹å¼å¦‚ä¸‹\n1 2 3 e.EXPECT().Method(\u0026#34;é æœŸ method è¦æ”¶åˆ°çš„åƒæ•¸\u0026#34;).Do(func(\u0026#34;å¯¦éš›åŸ·è¡Œæ™‚æ”¶åˆ°çš„åƒæ•¸\u0026#34;) { åšä»»ä½•é€ å‡ }) ç­‰æ–¼æ˜¯å¯«ä¸€æ¬¡é€£é æœŸè¼¸å…¥ã€é€ å‡è¼¸å‡ºéƒ½ä¸€ä¸¦åšå®Œï¼Œå¦‚æœè¦æ–¹ä¾¿å¯ä»¥ .Return() ç›´æ¥å¯«å›å‚³å…§å®¹ï¼Œä½†å› ç‚ºæ¶‰åŠ channel è¦å‚³éè³‡æ–™ï¼Œæ‰€ä»¥æˆ‘é¸æ“‡ .Do() ä¸¦å¡å…¥é€ å‡çš„è³‡æ–™å›å‚³ channel\nå¦‚æœä¸åœ¨æ„é æœŸè¼¸å…¥ï¼Œå¯ä»¥éƒ½ç”¨ gomock.Any() è·³éæª¢æŸ¥\nå¦‚ä½•é€ å‡ Time.Now ç­‰ç³»çµ±ç›¸ä¾çš„å‡½å¼ æœå°‹äº†ä¸€ä¸‹é€™é¡å•é¡Œï¼Œå»ºè­°æ˜¯æŠŠæœ‰å¤–éƒ¨ç›¸ä¾éƒ½æŠ½åˆ°å¦ä¸€å€‹ Object å»ï¼Œç„¶å¾Œé€éä¾è³´æ³¨å…¥çš„æ–¹å¼å‚³é€²å»ï¼Œæ‰èƒ½å¤ é€ å‡\nä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 type ObjectA {} func (a *ObjectA) MethodA(){ a.MethodB() } func (a *ObjectA) MethodB(){ return Time.Now() } é€™æ¨£æ˜¯ç„¡æ³•æ¸¬è©¦çš„ï¼Œè¦æ‹†è§£æˆ\n1 2 3 4 5 6 7 8 9 10 11 interface IObjectB { MethodB func() } type ObjectA { ObjB IObjectB } func (a *ObjectA) MethodA(){ a.ObjB.MethodB() } åœ¨ä½¿ç”¨ Interface æ›¿æ›éç¨‹ï¼Œè¦æ³¨æ„ *Type è·Ÿ Type çš„å·®ç•°ï¼Œå¦‚æœç™¼ç¾ä»¥ä¸‹éŒ¯èª¤è¨Šæ¯è«‹åƒè€ƒ X does not implement Y (â€¦ method has a pointer receiver)\nå¾å•ç­”ä¸­å›å»æ–‡ä»¶çœ‹ï¼Œå¯ä»¥æ³¨æ„åˆ°ä»¥ä¸‹å…§å®¹ Method sets Â¶\n1 The method set of any other type T consists of all methods declared with receiver type T. The method set of the corresponding pointer type *T is the set of all methods declared with receiver *T or T (that is, it also contains the method set of T) é€™ä¸€æ®µä¹Ÿå°±æ˜¯èªª\nå¦‚æœ method å®£å‘Šçš„ reciever æ˜¯ non pointer type func (t T) methodï¼Œå‰‡ T / *T éƒ½æœ‰åŒ…å«æ­¤ method ä½†å¦‚æœ method å®£å‘Šçš„ reciever æ˜¯ pointer typeï¼Œå‰‡åªæœ‰ *T åŒ…å«æ­¤ method å»¶ä¼¸è‡³ embedded struct\n1 2 3 - If S contains an embedded field T, the method sets of S and *S both include promoted methods with receiver T. The method set of *S also includes promoted methods with receiver *T. - If S contains an embedded field *T, the method sets of S and *S both include promoted methods with receiver T or *T. å¦‚æœæ˜¯\nS æ˜¯ non pointerï¼Œä¸” T ä¹Ÿæ˜¯ non pointerï¼Œå‰‡åŒ…å«äº† T non pointer type methods S æ˜¯ non pointer + T æ˜¯ pointer / åªè¦ S æ˜¯ pointer typeï¼Œå‰‡åŒ…å«äº† T non pointer / pointer type methods è©³è¦‹ç¨‹å¼ç¢¼ï¼Œæˆ‘æŠŠ struct æœ‰çš„ method éƒ½åˆ—å‡ºä¾†ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°ä»¥ä¸Šçš„è¦å‰‡ Go playground\nå¦å¤–æŠ½å‡ºä¾è³´å†æ³¨å…¥ï¼Œå¦‚æœå¿˜è¨˜åˆå§‹åŒ–æœƒæœ‰è¨˜æ†¶é«”å­˜å–å¤±æ•—çš„éŒ¯èª¤ http: panic serving runtime error: invalid memory address or nil pointer dereferenceï¼Œçœ‹åˆ°éŒ¯èª¤è¨˜å¾—å»æª¢æŸ¥\né‡å° HTTP Handler åšæª¢æŸ¥ é€éå–®å…ƒæ¸¬è©¦èˆ‡ Stub/Mockï¼Œå¯ä»¥æª¢æŸ¥å®Œå•†æ¥­é‚è¼¯çš„éƒ¨ä»½ï¼Œä½†å¦‚æœæƒ³æ›´ç¢ºå®š server æ˜¯å¦æœ‰æ­£ç¢ºè™•ç† http requestï¼ŒåŒ…å«æ˜¯å¦å›å‚³é æœŸçš„éŒ¯èª¤çµæœï¼Œå¯ä»¥å†é€²ä¸€æ­¥é‡å° http handler åšæ¸¬è©¦\né€™é‚Šæ¡ç”¨ core library åŒ…å« net/http/httptest æ¸¬è©¦ï¼Œå®Œæ•´æ•™å­¸å¯ä»¥åƒè€ƒ Testing Your (HTTP) Handlers in Go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 It(\u0026#34;test ServeHttp integration\u0026#34;, func(done Done) { e.EXPECT().GetExchangeRate(gomock.Any(), gomock.Any(), gomock.Any()).Do(func(from string, to string, ch chan\u0026lt;- ExchangeRateResult) { ch \u0026lt;- ExchangeRateResult{ IsExists: false, ExchangeRate: 0, } close(ch) }) req, _ := http.NewRequest(\u0026#34;GET\u0026#34;, \u0026#34;/exchange-currency\u0026#34;, nil) query := req.URL.Query() query.Add(\u0026#34;from\u0026#34;, \u0026#34;US\u0026#34;) query.Add(\u0026#34;to\u0026#34;, \u0026#34;TW\u0026#34;) query.Add(\u0026#34;amount\u0026#34;, \u0026#34;10\u0026#34;) req.URL.RawQuery = query.Encode() rr := httptest.NewRecorder() e := \u0026amp;ExchangePriceModel{} c := \u0026amp;CurrencyExchangeHandler{ E: e, } handler := http.HandlerFunc(c.ServeHTTP) handler.ServeHTTP(rr, req) Expect(rr.Code).To(Equal(200)) var body struct { Amount int } _ = json.Unmarshal(rr.Body.Bytes(), \u0026amp;body) Expect(body.Amount).To(Equal(300)) close(done) }) ä»¥ä¸ŠåŸºæœ¬å°±æ˜¯é€ å‡ / åˆå§‹åŒ– handler / åˆå§‹åŒ– http request / é€é handler.ServeHTTP(rr, req) æ¨¡æ“¬ http handler è™•ç†éç¨‹ / æª¢æŸ¥ response\nåŸºæœ¬ä¸Š Context / Cookie ç­‰éƒ½å¯ä»¥è™•ç†ï¼Œè™•ç†èµ·ä¾†ç›¸ç•¶æ–¹ä¾¿\nçµèª å¾å‹•æ…‹èªè¨€éä¾†ï¼Œæœ€ä¸ç¿’æ…£çš„å°±æ˜¯è¦ä¸€ç›´å»æƒ³ç‰©ä»¶ä¹‹é–“çš„ç›¸ä¾ï¼ŒåŒ…å«è¦è™•ç† mock æ™‚è¦æ‹†å‡º interface èˆ‡å¤–éƒ¨ç‰©ä»¶ï¼Œè€Œä¸èƒ½é‡å°æŸä¸€å€‹ object çš„æŸä¸€å€‹ method é€ å‡\nä½†æ•´é«”ä¸Šï¼ŒGolang çš„æ¸¬è©¦ç®—æ–¹ä¾¿ä¸”å¥½ä¸Šæ‰‹ï¼Œ~æ‰¾ä¸åˆ°å·æ‡¶ä¸å¯«æ¸¬è©¦çš„ç†ç”±äº†~\n","date":"2021-03-18T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-03-18-golang-test/","title":"Golang Test - å–®å…ƒæ¸¬è©¦ã€Mockèˆ‡http handler æ¸¬è©¦"},{"content":" æˆ‘è¦ºå¾—é€™æ˜¯ä¸€æœ¬å¯«çµ¦ç†±æ„›ç”¢å“è€ŒéæŠ€è¡“æœ¬ä½çš„å·¥ç¨‹å¸«\nå·¥ä½œäº†ä¸€æ®µæ™‚é–“ï¼Œæ­·ç¶“å…¬å¸ç®¡ç†åˆ¶åº¦èˆ‡æ–‡åŒ–çš„è½‰è®Šï¼Œé–‹å§‹åœ¨æ€è€ƒæ€éº¼æ¨£çš„ç’°å¢ƒè·Ÿåœ˜éšŠæ‰æ˜¯é©åˆè‡ªå·±ï¼Œé‚£å®Œç¾çš„åœ˜éšŠåˆæ‡‰è©²æ˜¯æ€æ¨£çš„å‹æ…‹ï¼Ÿ æœŸé–“çœ‹éäº† Netflix é«”ç³»çš„ã€Šçµ¦åŠ›ã€‹/ã€Šä¸€åƒé›¶ä¸€å€‹é»å­ä¹‹å¾Œã€‹/ã€Šé›¶è¦å‰‡ã€‹ï¼Œå¼·èª¿äººæ‰å¯†åº¦ / é–‹æ”¾ / ä¸‹æ”¾æ¬ŠåŠ›ç­‰æ–¹å¼ï¼Œä½†é€™äº›éƒ½æ¯”è¼ƒæ˜¯ä»¥äººè³‡ / ç®¡ç†å±¤è§’åº¦å‡ºç™¼ è€Œã€ŠClean Coderã€‹æ˜¯ç”±å°ˆæ¥­å·¥ç¨‹å¸«æ‰€æ’°å¯«ï¼Œå¦‚ä½•ç•¶ä¸€ä½å ‚å ‚æ­£æ­£çš„ç¨‹å¼è¨­è¨ˆå¸«ï¼Œè£¡é¢ç³¾æ­£äº†è‡ªå·±å¾ˆå¤šå£ç¿’æ…£ï¼Œä½†æ¯”è¼ƒåƒæ•™æ¢/å®ˆå‰‡ä¸€èˆ¬ï¼Œå°‘äº†é»è¶£å‘³èˆ‡åœ˜éšŠçš„æè¿°\nè€Œé€™æœ¬ã€Šå‰µæ„ç«¶æ“‡ã€‹ï¼Œç”±æ›¾ç¶“æ˜¯ Apple é¦–å¸­è»Ÿé«”å·¥ç¨‹å¸«ï¼Œåƒèˆ‡é Safari / iPhone ç¬¬ä¸€ä»£éµç›¤è¨­è¨ˆ / iPad éµç›¤è¨­è¨ˆï¼Œæè¿°æ¯ä¸€å€‹å°ˆæ¡ˆç¶“æ­·çš„éç¨‹èˆ‡æŒ«æŠ˜ï¼Œä¸¦æ”¶æ–‚å‡ºä½œè€…èªç‚ºç‚ºä»€éº¼ Apple å¯ä»¥è¨­è¨ˆå‡ºé ‚å°–ç”¢å“çš„å¿ƒæ³•ï¼Œä¸¦æç¹ªå‡ºå°ˆæ¥­çš„ç”¢å“åœ˜éšŠåœ¨æ±ºç­–/åŸ·è¡Œçš„éç¨‹ï¼Œæ¯ä¸€æ­¥çš„åæ€éƒ½ç™¼äººæ·±çœï¼Œä»¥ä¸‹æ˜¯æ•´ç†éå¾Œçš„è‡ªæˆ‘åæ€\næ¼”ç¤º(Demo) -\u0026gt; è’é›†åé¥‹ -\u0026gt; ä¸‹ä¸€æ¬¡æ¼”ç¤º 2005 å¹´ Apple å•Ÿå‹•äº† Purple è¨ˆç•«ï¼Œä¹Ÿå°±æ˜¯ iPhone çš„è¨­è¨ˆï¼Œåœ¨ 2005 å¹´ 9æœˆï¼Œæ•´å€‹å·¥ç¨‹åœ˜éšŠä¸¦å¬é›†è¦è§£æ±ºæœ€æ£˜æ‰‹çš„å•é¡Œ éµç›¤ï¼Œä¸åŒæ–¼é»‘è“æ©Ÿçš„å¯¦é«”éµç›¤ï¼ŒiPhone æ‰“ç®—ç”¨å¤šé»è§¸æ§é »å¹•ç•¶åšè»Ÿé«”éµç›¤ï¼Œä½†æ˜¯å› ç‚ºç¬¬ä¸€ä»£ iPhone è¢å¹•å¤ªå°ï¼Œæ‰€ä»¥éµç›¤è¨­è¨ˆå°±è‡³é—œé‡è¦ï¼Œé€™æ˜¯ iPhone è¨ˆç•«é‡åˆ°çš„ä¸€å¤§é›£é¡Œ\nä¸»ç®¡åœ¨æ¸¬è©¦ç¬¬ä¸€ä»£éµç›¤æ™‚ï¼Œç™¼ç¾é€£è‡ªå·±çš„å§“åéƒ½æ‰“ä¸å‡ºä¾†ï¼Œæ–¼æ˜¯å¬é›†æ‰€æœ‰äººï¼Œè¦å¤§å®¶åœä¸‹æ‰‹é‚Šä»»å‹™ï¼Œå…¨åŠ›æ”»å…‹éµç›¤å•é¡Œï¼Œå¤§å®¶å°±å„è‡ªç™¼æƒ³ï¼Œæå‡ºè‡ªå·±çš„è§£æ±ºæ–¹æ¡ˆ\nä½œè€…æƒ³åˆ°ï¼Œå¦‚æœæŠŠå¤šå€‹è‹±æ–‡å­—æ¯ä½µå…¥ä¸€å€‹è¼¸å…¥æ ¼ï¼Œé€éå­—å…¸è‡ªå‹•æ ¡æ­£çŒœå‡ºç”¨æˆ¶è¦è¼¸å…¥çš„å–®å­—ï¼Œå°±å¯ä»¥è§£æ±ºé¢ç©å° + æå‡é€Ÿåº¦çš„å•é¡Œï¼Œå¾Œä¾†åœ¨å±•ç¤ºéç¨‹ä¸­ä¹ŸæˆåŠŸæ“Šæ•—å…¶ä»–ææ¡ˆï¼Œä»–ä¹Ÿå°±æˆç‚º iPhone ä¸»è¦è² è²¬éµç›¤çš„ç¨‹å¼è¨­è¨ˆå¸«\nä½†æ˜¯é€™æ¨£çš„éµç›¤å•é¡Œå¾ˆå¤šï¼Œä¾‹å¦‚åªé€éå­—å…¸æ ¡æ­£ï¼Œé‚£å¦‚æœç”¨æˆ¶è¼¸å…¥ã€ŒArrrr!ã€å°±æ‰“ä¸å‡ºä¾†äº†ï¼Œæ‰€ä»¥å°±ä¸æ–·çš„èª¿æ•´ -\u0026gt; æ¼”ç¤º -\u0026gt; å›é¥‹ï¼Œæ¯å€‹æˆå“¡æ‰‹ä¸Šéƒ½å¸¶è‘—åŸå‹æ©Ÿï¼Œå½¢å½±ä¸é›¢ä¸æ–·çš„æ¸¬è©¦ä¸¦çµ¦äºˆåé¥‹\né€™è½èµ·ä¾†æ˜¯ common senseï¼Œä½†æ˜¯æ¼”ç¤ºçš„ç´°ç¯€æ‰æ˜¯é—œéµ\nçµ¦äºˆç›´æ¥çš„å›é¥‹ æ¼”ç¤ºçš„æ™‚å€™æ˜¯ä¸æ˜¯èƒ½æŠ“åˆ°é‡é»ï¼ŒæŠŠåŠ›æ°£èŠ±åœ¨æ­£ç¢ºçš„ä½ç½®ä¸Šï¼Œæ›´é‡è¦çš„æ˜¯ã€Œæœ‰æ²’æœ‰äººå¯ä»¥çµ¦å‡ºæœæ–·çš„åé¥‹ã€\nä½œè€…æåˆ°è³ˆä¼¯æ–¯å¯ä»¥çš„è©±æœƒç›¡å¯èƒ½åƒèˆ‡æ¼”ç¤ºï¼Œä¸¦çµ¦äºˆéå¸¸ç›´æ¥çš„å›é¥‹ï¼Œä¾‹å¦‚èªªç¬¬ä¸€ä»£ iPad éµç›¤å…¶å¯¦æœ‰å…©å€‹éµç›¤æ¨¡å¼å¯ä»¥åˆ‡æ›ï¼Œä½†è³ˆä¼¯æ–¯ç©ä¸€ç©å°±å•ä½œè€…ã€Œä½ è¦ºå¾—æ˜¯ä¸æ˜¯åªè¦ä¸€å€‹å°±å¥½ï¼Ÿä½ å–œæ­¡å“ªä¸€å€‹ï¼Ÿã€\nä¹‹å¾Œå°±æ‹æ¿æ±ºå®šï¼Œåªç•™ä¸€å€‹ç°¡åŒ–æ¨¡å¼çš„éµç›¤\nå·¥ä½œä¹…äº†è¦ºå¾—æœ‰ä¸€å€‹æœæ–·çš„æ±ºç­–è‡³é—œé‡è¦ï¼Œå¾ˆå¤šæ™‚å€™å¤§å®¶åœ¨æœƒè­°ä¸Šéƒ½ä¸æ•¢çµ¦äºˆç›´æ¥çš„åé¥‹æˆ–æ±ºå®šï¼Œå¯ä»¥è½å‡ºå¤§å®¶å°æ–¼èƒŒè² è²¬ä»»çš„ææ‡¼èˆ‡æ’æ–¥ï¼Œæˆ–æ˜¯çŒœä¸é€æŒæ¬Šè€…çš„å¿ƒæ€ï¼Œé€™ä¾†å›ä¹‹é–“ç•™ä¸‹å¾ˆå¤šæœ¦æœ§çš„ç©ºé–“ï¼Œååˆ†çš„å¯æƒœ\næ¼”ç¤ºå¾ˆé‡è¦ å¦ä¸€é»æ˜¯å·¥ç¨‹å¸«å°æ–¼æ¼”ç¤ºçš„å¿ƒæ…‹èˆ‡æŠ€å·§ï¼Œå¹´å‰å‰›å¥½èˆ‡ CEO One on Oneï¼Œä»–æåŠå·¥ç¨‹å¸«æ™®éä¸é‡è¦–æ¼”ç¤ºï¼Œä¸æ‡‚å¾—å¦‚ä½•ç”¨æ­£ç¢ºçš„æ–¹å¼è®“å¤§å®¶ (åŒ…å« CEO æœ¬äºº)äº†è§£æŠ€è¡“çš„é‡è¦æ€§ï¼Œä¾‹å¦‚æ•å¸æœ‰æŒçºŒåœ¨ç ”ç©¶ä½å…‰æºéŒ„å½±çš„å„ªåŒ–æ¼”ç®—æ³•ï¼Œä½†æ˜¯ Demo æ™‚é¸æ“‡åœ¨æ˜äº®çš„æœƒè­°å®¤ï¼ŒCEO è¡¨ç¤ºä»–å¾ˆç´æ‚¶ç‚ºä»€éº¼ä¸æ‰¾ä¸€å€‹åˆé©çš„å ´æ™¯æ›´å‡¸é¡¯æŠ€è¡“ä¸Šçš„çªç ´å‘¢ï¼Ÿ\nç«™åœ¨ç§‘æŠ€èˆ‡äººæ–‡çš„äº¤ç•Œé» åœ¨æ›¸ä¸­æœ‰æåŠå“å‘³ï¼Œä¾‹å¦‚éµç›¤å°±æ‡‰è©²è¦è®“ç”¨æˆ¶é †æš¢çš„æ‰“å‡ºä»–æ‰€æƒ³è¦çš„å­—ï¼Œæ‰€ä»¥ä½œè€…ä¸æ–·çš„å„ªåŒ–è‡ªå‹•æ ¡æ­£åŠŸèƒ½ï¼ŒåŒæ™‚ä¿ç•™ç”¨æˆ¶è¼¸å…¥å†·åƒ»å­—çš„å¯èƒ½\nå“å‘³è½èµ·ä¾†è™›ç„¡ç¸¹ç·²ï¼Œä½œè€…çš„å®šç¾©æ˜¯\nåŸ¹é¤Šéˆå·§çš„åˆ¤æ–·åŠ›ï¼Œæ‰¾åˆ°ä»¤äººæ„‰æ‚…åˆå®Œå–„çš„å¹³è¡¡é»\né€™ä»°è³´åœ˜éšŠä¸­è¨­è¨ˆå¸«èˆ‡å·¥ç¨‹å¸«ä¸æ–·çš„æºé€šï¼Œä»¥åŠç®¡ç†è€…å¾ˆæ˜ç¢ºçš„è¡¨é”ç›®æ¨™ï¼Œä¾‹å¦‚é–‹ç™¼ Safari çš„æ™‚ç©ºèƒŒæ™¯æ˜¯è¦å–ä»£åŸæœ¬ Mac OS å…§å»ºçš„ IEï¼Œé‚£æ™‚å€™è³ˆä¼¯æ–¯çµ¦äºˆéå¸¸æ˜ç¢ºçš„æŒ‡ç¤ºã€Œé€Ÿåº¦ã€ï¼Œè¦ç”¨æˆ¶æ”¾æ£„ IE è·³æ§½åˆ° Safari é€Ÿåº¦å°±æ˜¯æœ€é‡è¦çš„ç”¨æˆ¶é«”é©—æŒ‡æ¨™\nå¦å¤–ä½œè€…å°æ–¼ A/B Test æå‡ºè³ªç–‘ï¼Œæœ€æœ‰åçš„å°±æ˜¯ Google æ¸¬è©¦ 41 ç¨®è—è‰²ï¼Œå¾ç”¨æˆ¶çµ¦äºˆçš„æ•¸æ“šå›é¥‹ä½œç‚ºä¾ç¡…æ˜¯ã€Œæœ€é¡§å®¢å°å‘çš„åšæ³•ã€ï¼Œä½†æ˜¯ä½œè€…è¡¨ç¤ºé€™ä¸æœƒæ˜¯ Apple åšäº‹çš„æ…‹åº¦ï¼Œæˆ–è¨±ä»–å€‘æœƒæ¡ç”¨æ•¸æŠ€åˆ†æï¼Œä½†ä»–å€‘æœ‰å°ˆæ¥­çš„è¨­è¨ˆå¸«åœ¨ç‚ºæ‰€æœ‰çš„è¨­è¨ˆæŠŠé—œï¼ŒåŒ…å«åƒè¨­è¨ˆå¸«æå‡ºè§¸æ§è¢å¹•æ‡‰è©²è¦æœ‰é•·æŒ‰æ‹–å‹•çš„è¨­è¨ˆï¼Œå°±åƒæ˜¯åœ¨æ‰‹æŒ‰è‘—ç´™åœ¨æ¡Œé¢æ‹–å‹•çš„æ„Ÿè¦ºï¼Œé€™æ¨£æ‰æœ‰æ›´æ²ˆæµ¸çš„é«”é©—ï¼›\næ»‘å‹•æ²è»¸æ™‚æŒçºŒæ»‘å‹•æœƒåŠ é€Ÿï¼Œè§¸åº•æœƒæœ‰å°å°çš„åå½ˆå›é¥‹ï¼Œéƒ½æ˜¯ Apple è¨­è¨ˆå¸«æ‰€è¨­è¨ˆçš„\næ•å¸è¿‘å¹´ä¹Ÿåœ¨å°å…¥æ•¸æ“šé©…å‹•è¨­è¨ˆï¼Œä½†è‡ªå·±ä¹Ÿåœ¨åæ€éœ€æ±‚è¨­è¨ˆæ˜¯ä¸æ˜¯çœŸçš„å®Œç¾ï¼Ÿå¾ç”¨æˆ¶çš„æ•¸æ“šä¸æ–·å»æ‰“ç£¨å°±èƒ½å¾—åˆ°æœ€æ£’çš„ç”¢å“ï¼Ÿ\næˆ–è¨±é‚„æ˜¯è¦å›æ­¸éœ€æ±‚è¨­è¨ˆçš„æœ¬èº«ï¼Œé€™æ¨£çš„ææ¡ˆæ˜¯ä¸æ˜¯æœ‰ã€Œå“å‘³ã€ï¼Œæ‰æœ‰å¾ŒçºŒçš„ AB Test çš„åƒ¹å€¼\nçœ‹åˆ°é€™ä¸€æ®µä¹Ÿé —æœ‰æ„Ÿè§¸ï¼Œåœ¨éµç›¤å°ˆæ¡ˆä¸­æœ‰å°ˆè·çš„è¨­è¨ˆå¸«ï¼Œè€Œä½œè€…èº«ç‚ºè»Ÿé«”å·¥ç¨‹å¸«å»ä¸å–®å–®æŠŠè‡ªå·±æ“ºåœ¨å¯¦ä½œè€…çš„è§’è‰²ï¼Œè€Œæ˜¯æŠŠè‡ªå·±ç•¶ä½œç”¨æˆ¶ä¸æ–·å»å„ªåŒ–éµç›¤è¨­è¨ˆï¼Œåœ¨æ›¸ä¸­æè¿°äº†äº”å…­ä»£éµç›¤çš„å„ªåŒ–éç¨‹ï¼Œåƒæ˜¯å¾åŸæœ¬çš„å¤šå­—ä¸€éµæ”¹æˆä¸€å­—ä¸€éµï¼Œç„¶å¾Œå†æ”¹æˆ QWERTY éµç›¤ï¼Œè‡ªå‹•æ ¡æ­£ä¹Ÿå¾å–®ç´”çš„å­—å…¸æ¯”å°è®Šæˆè¼¸å…¥çš„ä½ç§»å‘é‡å·®ï¼Œå¯ä»¥çœ‹å‡ºä½œè€…æƒ³è¦æŠŠæœ€æ£’çš„ç”¨æˆ¶é«”é©—å¸¶çµ¦æ‰€æœ‰çš„äººï¼ŒåŒ…å«ä»–è‡ªå·±\næœ€å›°é›£çš„å•é¡Œ å› ç‚º Safari å°ˆæ¡ˆçš„æˆåŠŸï¼Œä½œè€…çš„ä¸»ç®¡å¸Œæœ›ä½œè€…æŠŠç€è¦½å™¨åŒ…æˆå¥—ä»¶ Webkit åµŒå…¥ Email ç•¶ä¸­åšæ–‡å­—ç·¨è¼¯å™¨ï¼Œä½œè€…èŠ±äº†å¾ˆå¤šæ™‚é–“åœ¨è§£æ±ºæ»‘é¼ æ¸¸æ¨™ä½ç½®çš„å•é¡Œï¼Œå› ç‚ºé€™æ¶‰åŠåˆ°æ–‡å­—æ’ç‰ˆ / æ›è¡Œè·³å­—ç­‰é‚è¼¯ï¼Œé æ¯”æƒ³åƒä¸­è¤‡é›œå¾—å¤š ä½œè€…åœ¨æ›¸ä¸­æœ‰æè¿°ä»–é‡åˆ°çš„é›£é¡Œï¼Œä»¥åŠä»–æ›¾ç¶“å˜—è©¦éçš„è§£æ³•ï¼ŒèŠ±äº†å¥½å¹¾é€±çš„æ™‚é–“éƒ½ç„¡æ³•çªç ´ï¼Œæœ€å¾Œå‘ä¸»ç®¡å°‹æ±‚å¹«åŠ©ï¼Œå¾å…¶ä»–éƒ¨é–€æ‰¾ä¾†æœ‰ç¶“é©—çš„å·¥ç¨‹å¸«ï¼Œæœ€å¾Œå°±ä¸€èµ·è§£æ±ºäº†å•é¡Œ\nä½œè€…çµ±æ•´äº†å¹¾å€‹é»\nå•å•é¡Œä¹‹å‰å¿…é ˆè‡ªå·±å…ˆåŠªåŠ›é èº«ç‚ºç¨‹å¼è¨­è¨ˆå¸«å¿…é ˆæ‹‹é–‹è‡ªå·±çš„å°Šåš´ï¼Œæœ‰å•é¡Œå°±è¦æœ‰èª æ„åœ°å»å°‹æ±‚å”åŠ© è½èµ·ä¾†å¾ˆä¸€èˆ¬ï¼Œä½†ä»”ç´°å›æƒ³å·¥ä½œçš„ç¶“æ­·ï¼Œå¯è¬‚æ–‡äººç›¸è¼•ï¼Œå¾ˆå¤šæ™‚å€™å…¶å¯¦åŒäº‹ä¹‹é–“å¾ˆå°‘æœ‰åˆ‡ç£‹ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯å¤§å®¶åœ¨è—æ‹›é‚„æ˜¯å®³ç¾ï¼Œè¦ºå¾—å¯¦åœ¨å¾ˆå¯æƒœï¼Œå°¤å…¶æ˜¯äº‹å¾Œå›æƒ³å½¼æ­¤éƒ½è¸©éä¸€æ¨£çš„å‘ï¼Œå¦‚æœæ—©é»åˆ†äº«æˆ–æ˜¯äº’ç›¸è«‹æ•™ï¼Œå°±èƒ½é¿å…é€™ç„¡è¬‚çš„æµªè²»\nçµèª è‡ªå·±åœ¨è·æ¶¯ç™¼å±•çš„éç¨‹ï¼Œä¹Ÿä¸æ–·æ€ç´¢è‡ªå·±çš„å®šä½ï¼Œä¸€æ–¹é¢å¸Œæœ›è‡ªå·±æœ‰è¶³å¤ çš„æŠ€è¡“å¯¦åŠ›ï¼Œèƒ½å¤ æŒ‘å…¬å¸è€Œä¸æ˜¯è®“å…¬å¸æŒ‘æˆ‘ï¼›å¦ä¸€æ–¹é¢ä¹Ÿå¸Œæœ›è‡ªå·±èƒ½å¤ æ‰¾åˆ°ç†±æ„›çš„ç”¢å“ï¼ŒæŠŠè‡ªå·±çš„æŠ€è¡“èƒ½åŠ›è®Šæˆå½±éŸ¿åŠ›\nä»¥å‰æœƒè¦ºå¾—å…©è€…æœ‰é»è¡çªï¼Œç•¢ç«Ÿç”¢å“é–‹ç™¼æœ‰æ™‚å€™éœ€è¦çš„ä¸è¦‹å¾—æ˜¯æŠ€è¡“èƒ½åŠ›ï¼Œè€Œæ˜¯åè¦†çš„æºé€šä»¥åŠæ›´æ·±å…¥çš„ç†è§£ç”¨æˆ¶éœ€æ±‚ï¼ŒæŠ•å…¥ç”¢å“è¶Šå¤šæœƒä¸æœƒè®“æŠ€è¡“ç™¼å±•ä¸Šçš„æ™‚é–“ç¸®çŸ­ ?!\nç¾…èƒ–èªªéè¦åšåˆ° Uç›¤åŒ–ç”Ÿå­˜ã€Œè‡ªå¸¦ä¿¡æ¯ï¼Œä¸è£…ç³»ç»Ÿï¼Œéšæ—¶æ’æ‹”ï¼Œè‡ªç”±åä½œã€‚ã€\nä½†æ…¢æ…¢åœ°é–‹å§‹é«”æœƒåˆ°ï¼Œå…©è€…æœ‰æ™‚å€™æ˜¯ç›¸è¼”ç›¸æˆçš„ï¼Œç†±æƒ…é€™ç¨®æ±è¥¿æ˜¯ç„¡å½¢ä¸”å®¹æ˜“è¢«å¿½è¦–çš„åƒ¹å€¼ï¼Œå¦‚æœä¸Šç­å°æ–¼ç”¢å“æœ‰ç†±æƒ…ï¼Œé€™å¯ä»¥å»¶ç‡’åˆ°å°æ–¼æŠ€è¡“å°ˆç²¾çš„åŸ·è‘—ï¼Œè®“è§£æ±ºå•é¡Œå¯ä»¥å¾æ›´æ ¹æœ¬çš„è§’åº¦è€Œä¸æ˜¯å«Œéº»ç…©çš„è² é¢å¿ƒæ…‹å»é¢å°\nè¬›å¾—æœ‰é»ç± çµ±ï¼Œè‡ªå·±å¯èƒ½ä¹Ÿé‚„æ²’æƒ³å¾—å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å¾é€™æœ¬æ›¸ä¸­çœ‹åˆ°å¦ä¸€æ¢æˆ‘è¦ºå¾—å€¼å¾—æ•ˆæ³•çš„è·æ¶¯\n","date":"2021-03-07T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-03-07-%E5%89%B5%E6%84%8F%E7%AB%B6%E6%93%87%E5%BF%83%E5%BE%97%E5%88%86%E4%BA%AB/","title":"ã€Šå‰µæ„ç«¶æ“‡ã€‹å¿ƒå¾—åˆ†äº«"},{"content":"åœ¨ä¸€å…©å¹´å‰ Golang å¾ˆç«ç´…æ™‚æœ‰å­¸äº†ä¸€ä¸‹ï¼Œä½†ç•¶æ™‚æ²’æœ‰æ·±å…¥çš„ç†è§£ Golang ç›¸å°æ–¼å…¶ä»–èªè¨€çš„ç‰¹è‰²èˆ‡é­…åŠ›ï¼Œåªåœç•™åœ¨è¡¨å±¤çš„èªæ³•å­¸ç¿’ï¼Œæ™‚éš”å¤šå¹´å› ç‚ºæ›å·¥ä½œçš„éœ€æ±‚ï¼Œé‡å­¸ Golang ç™¼ç¾æœ‰è »å¤šæœ‰è¶£çš„åœ°æ–¹ï¼Œæ‹¿ä¾†èˆ‡ Nodejs ç›¸æ¯”æœ‰è¨±å¤šé¡ä¼¼ä½†ä¸åŒçš„å¯¦ä½œå·®ç•°ï¼Œå°¤å…¶åœ¨éåŒæ­¥é€™ä¸€å¡Šï¼Œç‰¹æ­¤ç­†è¨˜ä¸¦åˆ†äº«å¦‚ä½•å¾ Nodejs è·³æ§½åˆ° Golang\næœ¬ç¯‡å°‡è‘—é‡æ–¼ä»‹ç´¹ Golang ä¸Šæ‰‹çš„æ•™å­¸è³‡æºï¼Œä»¥åŠå°æ¯” Nodejs (Javascript)ï¼ŒGolang çš„ç‰¹è‰²åœ¨ä»€éº¼åœ°æ–¹\nGolang èˆ‡ Nodejs ç•°åŒä¹‹è™• - ä»¥éåŒæ­¥ç‚ºä¾‹ Golang èˆ‡ Nodejs åœ¨éåŒæ­¥è¨­è¨ˆä¸Šæœ‰äº›é›·åŒä¹‹è™•ï¼Œç›¸è¼ƒæ–¼å‚³çµ±çš„æ¯ä¸€å€‹ IO äº‹ä»¶å°±é–‹ä¸€å€‹ thread è®“ OS å»æ’ç¨‹ï¼ŒNodejs èˆ‡ Golang éƒ½ç›¡å¯èƒ½æ¸›å°‘ kernel thread çš„ç”¢ç”Ÿï¼Œè€Œæ˜¯é€é Non blocking system call æˆ–æ˜¯ user thread èˆ‡ scheduler æ–¹å¼ï¼Œé™ä½ OS Context Switch å°±èƒ½æ›´æœ‰æ•ˆç‡ä½¿ç”¨ kernel thread\nNodejs å…§éƒ¨éåŒæ­¥è™•ç† é€é runtime åº•å±¤ libuv å‘¼å« non-blocking system callï¼Œå‘ system è¨»å†Šæœ‰èˆˆè¶£çš„äº‹ä»¶ä¸¦åŠ å…¥ event loop ï¼Œevent loop ä¸­åˆç´°åˆ†æˆå¤šå€‹ phase æª¢æŸ¥ä¸åŒçš„ä»»å‹™å¦‚ timer / io / check ç­‰ï¼Œç­‰åˆ° main thread åŸ·è¡Œå®Œå¾Œæª¢æŸ¥ event loop ä¸Š IO äº‹ä»¶æ˜¯å¦å®Œæˆï¼Œå¦‚æœå®Œæˆå‰‡è§¸ç™¼ callback åˆ° main thread åŸ·è¡Œ\nä½†éœ€è¦æ³¨æ„ Nodejs core library æœ‰äº›æ˜¯æ²’æœ‰ non blocking system callï¼Œä¾‹å¦‚ fs / crypto / dns.lookup æŸ¥è©¢ï¼Œé€™äº›æ˜¯å¾ Worker Pool å¦å¤–é–‹ thread åŸ·è¡Œï¼Œæœƒå—é™æ–¼ç’°å¢ƒè®Šæ•¸ UV_THREADPOOL_SIZE æ§åˆ¶æ•´é«” kernel thread æ•¸é‡ï¼Œæ‰€ä»¥å†æ¬¡æé†’ Nodejs runtime æ˜¯ multi threadï¼Œåªæ˜¯ js è·Ÿ event loop callback éƒ½è·‘åœ¨åŒä¸€å€‹ main thread ä¸Šï¼Œå…·é«”å¯ä»¥åƒè€ƒ\nThe Node.js Event Loop: Not So Single Threaded Node\u0026rsquo;s Event Loop From the Inside Out by Sam Roberts, IBM Basics of libuv Instead, the application can request the operating system to watch the socket and put an event notification in the queue. The application can inspect the events at its convenience\nå¦‚æœæ˜¯ core library æ²’æœ‰æ”¯æ´çš„ non blocking ä»»å‹™ï¼Œå°±å¿…é ˆè‡ªå·±é€é worker_threads / child_process / cluster ç­‰æ–¹å¼æ‰ä¸æœƒ block main threadï¼Œé€™ä¹Ÿæ˜¯æ–°æ‰‹ææ··çš„å•é¡Œ æ˜¯ä¸æ˜¯ç”¨ Promise åŒ…æˆéåŒæ­¥å°±ä¸æœƒ blocking (X)\nGolang çš„ goroutine èˆ‡ scheduler å…§å®¹æ‘˜éŒ„è‡ªé€™å¹¾ç¯‡å„ªè‰¯çš„å…§å®¹ï¼š\nGopherCon 2018: Kavya Joshi - The Scheduler Saga / Go: Goroutine, OS Thread and CPU Management / Scheduling In Go : Part II - Go Scheduler\nå‰æƒ…æè¦ï¼Œprocessor åªèƒ½åŸ·è¡Œ kernel thread ä»»å‹™ï¼Œæ¯å€‹ kernel thread åœ¨è¨˜æ†¶é«”ä½”ç”¨èˆ‡ context switcth èŠ±è²»éƒ½ä¸å° (8KB / 1 ms)\nè€Œ Golang æœ¬èº«å»ºç«‹ user thread (goroutine)ï¼Œé–‹éŠ·ç›¸å°åªè¦ (2KB/10 ns) é€é Schedule å®‰æ’ user thread -\u0026gt; kernel thread -\u0026gt; processor å¯¦éš›é‹è¡Œç¨‹å¼ï¼Œç›¡å¯èƒ½è®“ kernel thread æŒçºŒä¿æŒ running æ¸›å°‘ context switch\nGolang æœ¬èº«æœ‰ Scheduler è² è²¬æ’ç¨‹ï¼Œé€é go func()å•Ÿå‹• goroutine (user thread)ï¼Œæ­¤ user thread å°‡ç”± Scheduler æ’ç¨‹\n(ä¾†è‡ªåƒè€ƒæ–‡ä»¶)\nScheduler é è¨­ç‚ºå•Ÿå‹•ä¸€å€‹ Processor P1ï¼Œé€™è£¡æœƒå°æ‡‰åˆ°ç¡¬é«”ä¸Šå¯ç¨ç«‹åŸ·è¡Œ thread çš„é‹ç®—å–®å…ƒ ä¸ä¸€å®šç­‰æ–¼ CPU core æ•¸é‡ï¼Œå› ç‚ºåƒ intel Hyper-Threading åŠŸèƒ½ï¼Œä¸€å€‹ physical core å¯é‹è¡Œå…©å€‹ thread\nProcessor P1 ä¸Šé‹è¡Œä¸€å€‹ Kernel Thread M1ï¼Œä¸¦å°‡ goroutine G1 æ’ç¨‹åˆ° M1 ä¸­åŸ·è¡Œ å¦‚æœæœ‰æ–°çš„ goroutine G2 èª•ç”Ÿï¼Œä¸”ç›®å‰çš„ Processor P1é‚„åœ¨è·‘ï¼Œå‰‡å»ºç«‹æ–°çš„ kernel thread M2èˆ‡ Processor P2ï¼Œä¸¦åŸ·è¡Œ goroutine G2 å¦‚æœ kernel thread å•Ÿå‹•æ•¸é‡é”åˆ°ä¸Šé™ GOMAXPROCSï¼Œå‰‡æœƒæ”¾åˆ° FIFO queue ç•¶ä¸­ï¼Œç°¡ç¨± runqï¼Œæ¯å€‹ Processor éƒ½æœ‰å°æ‡‰è‡ªå·±çš„ local runq Processor å¦‚æœæŠŠ local run queue éƒ½è™•ç†å®Œï¼Œå¯ä»¥å»å·å…¶ä»– processor çš„ runq (work stealing)ï¼Œé”åˆ°å·¥ä½œ balance é™¤äº† local runqï¼Œé‚„æœ‰ä¸€å€‹ global runq æ”¾è¢«ä¸­æ–·çš„é•·æ™‚é–“ä½”ç”¨ goroutineï¼Œkernel thread æœƒç”¨æ¯”è¼ƒä½çš„é »ç‡å»åŸ·è¡Œï¼Œé‚„æœ‰åƒåƒåœ¾å›æ”¶ç­‰ä»»å‹™ 1 2 3 4 5 6 7 8 runtime.schedule() { // only 1/61 of the time, check the global runnable queue for a G. // if not found, check the local queue. // if not found, // try to steal from other Ps. // if not, check the global runnable queue. // if not found, poll network. } é‡åˆ° system callï¼Œæœƒæœ‰å…©ç¨®åæ‡‰ å¦‚æœæ˜¯ blocking system callï¼Œå‰‡è©² kernel thread æœƒæš«åœ (parking) ä¸¦ç§»å‡º processorï¼ŒæŠŠ process è®“çµ¦å…¶ä»–äºº (handoff)ï¼Œæ­¤æ™‚ thread ä¸æœƒä½”ç”¨ç¸½é«”ä¸Šé™ å¦‚æœæ˜¯ non blocking system call ä¾‹å¦‚ network ç›¸é—œï¼Œå‰‡ä¸éœ€è¦ç§»å‡º threadï¼Œè€Œæ˜¯æŠŠ goroutine æ”¾åˆ° network pollï¼Œprocessor æœƒåœ¨æœ‰ç©ºçš„æ™‚å€™å» network poll æ‰¾å‡ºå®Œæˆ system callä¸” runnable çš„ goroutine é€™æ¨£æ¯å€‹ process éƒ½ç›¡å¯èƒ½ç¶å®šä¸€å€‹ kernel threadï¼Œä¸”æ­¤ kernel thread å°±æŒçºŒåœ¨ running ç‹€æ…‹è€Œæ²’æœ‰åˆ‡æ›ï¼Œé€é Go Scheduler æ›¿æ› user thread æ’ç¨‹å·¥ä½œ\nScheduler æœ¬èº«æœƒåœ¨ä»¥ä¸‹æƒ…æ³è™•ç†æ’ç¨‹\ngo keyword åƒåœ¾å›æ”¶ï¼šåƒåœ¾å›æ”¶æœ‰ç¨ç«‹çš„ goroutine system call sync ç›¸é—œå‘¼å«: atomic / mutex / channel ç›¸é—œæ“ä½œï¼Œæœƒå°è‡´ goroutine å µå¡ goroutine å¯ä»¥é‡å° function level å•Ÿå‹•ä½µç™¼ï¼Œä¹Ÿæœ‰è±å¯Œçš„åŒæ­¥èªæ³•ï¼Œä¾‹å¦‚ sync.Mutex ä¿è­· critical section / sync.WaitGroup ç­‰å¾… goroutine å®Œæˆ / channel åœ¨ goroutine ç•¶ä¸­å‚³éè³‡æ–™èˆ‡æ§åˆ¶åŸ·è¡Œ\nç¯„ä¾‹ä¸€ï¼šé€é http request è®€å– users list ä¸¦å†æ¬¡é€é http request å–å¾— 10 ä½ user çš„è©³ç´°è³‡æ–™ï¼Œç®—æœ€å¾Œçš„æ€§åˆ¥åŠ ç¸½ ç¯„ä¾‹åªæ˜¯è¦ç¨å¾®å“åšä¸€ä¸‹å…©å€‹èªæ³•çš„å·®ç•°ï¼ŒéŒ¯èª¤è™•ç†ç­‰å°±å…ˆä¸è¦å¤ªåœ¨æ„\né€™éƒ¨åˆ†å¯«èµ·ä¾†ç”¨ Nodejs å°±è »æ–¹ä¾¿çš„\nç¯„ä¾‹äºŒï¼šè¨ˆç®— 1000 * 1000 æ•¸å­—çŸ©é™£åŠ ç¸½ï¼Œä½µç™¼å››å€‹ thread åŸ·è¡Œæœ€å¾ŒåŠ ç¸½ Nodejs åœ¨ child_process æˆ–æ˜¯ worker thread æˆ‘è‡ªå·±éƒ½è¦ºå¾—æœ‰é»ä¸å¤ªæ–¹ä¾¿ï¼Œä¸èƒ½é‡å°æŸä¸€å€‹ function èµ·æ–°çš„ threadï¼Œå‚³éè³‡æ–™ä¸Šä¹Ÿä¸æ˜¯å¤ªæ–¹ä¾¿ï¼Œä¸å¦‚ Golang ç›´æ¥ go func() æ­é… channel ä¾†çš„ç°¡ä¾¿\næ¥è‘—å›éé ­ä¾†çœ‹ï¼Œåˆ†äº«å¾ Nodejs è·³æ§½åˆ° Golang çš„å­¸ç¿’æ–¹å¼\nGolang æ•™å­¸è³‡æºæ¨è–¦ å½±ç‰‡ä»˜è²»è³‡æºï¼šGo Core Language ï¼Œè‡ªå·±æœ¬èº«è »å–œæ­¡å½±ç‰‡å¼æ•™å­¸ï¼Œå¯ä»¥å¿«é€Ÿéä¸€éï¼ŒPluralsight çš„èª²ç¨‹å“è³ªé‚„ä¸éŒ¯ï¼Œè€Œä¸”é‚„æœ‰ Skill å¯ä»¥æ¸¬è©¦è‡ªå·±çš„èƒ½åŠ›ï¼ŒæŠŠä¸Šé¢ Go æ ¸å¿ƒèª²ç¨‹çœ‹å®Œå¤§æ¦‚å°±èŠ±å€‹ 5å€‹å°æ™‚å·¦å³ï¼Œè¦ºå¾—å…¥é–€ä¾†èªªé —åˆ’ç®—\nç‚ºä»€éº¼è¦ç”¨ Golang é™¤äº†æœ¬èº«æ˜¯éœæ…‹å¼·å‹åˆ¥çš„ç·¨è­¯å¼èªè¨€ï¼ŒGolang ç›¸æ¯”æ–¼ Nodejs èªè¨€æœ¬èº«æœ‰å¹¾å¤§ç‰¹è‰²è®“æˆ‘ååˆ†å–œæ­¡\n1. éå¸¸å·¥ç¨‹å°å‘/ç°¡æ½”ï¼š Golang å¾ä¸€é–‹å§‹æ¨å‡ºå°±æ˜¯ç‚ºäº†è§£æ±º Google æ‰€é‡åˆ°çš„å¤§å‹è»Ÿé«”ç³»çµ±è¨­è¨ˆé›£é¡Œï¼Œæ‰€ä»¥å¾ä¸€é–‹å§‹è¨­è¨ˆå°±éå¸¸å·¥ç¨‹ã€åœ˜éšŠåˆä½œå°å‘ï¼Œä¾‹å¦‚\nåªæœ‰ for loop æ²’æœ‰ while / do while ç­‰ï¼Œè®“å¯«æ³•æœ‰çµ±ä¸€çš„æ–¹å¼ï¼Œä¸æœƒæ¯å€‹äººéƒ½æœ‰å„è‡ªçš„å¯¦ä½œ package ä¸­å¤§å¯«ä»£è¡¨ public / å°å¯«ä»£è¡¨ private test function å¿…é ˆæ˜¯ä»¥ Test é–‹é ­\nGolang åªæœ‰ 25 å€‹ keywordsï¼Œä¸”åœ¨è¨±å¤šåœ°æ–¹éƒ½æœ‰æ˜ç¢ºçš„é™åˆ¶ï¼Œè€Œä¸æ˜¯çµ¦äºˆç©ºæ³›çš„è‡ªç”±ï¼Œé€™è®“åœ˜éšŠæœ‰æ˜ç¢ºçš„ coding style å¯ä»¥éµå®ˆ 2. èªè¨€æ ¸å¿ƒåŒ…å«å¸¸ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ CLI / Testing åœ¨ Nodejs ä¸­ï¼Œæˆ‘å€‘å¸¸éœ€è¦å„ç¨® npm package å®Œæˆä»»å‹™ï¼Œå°è‡³ http request éƒ½è¦å®‰è£ node-fetch / axios / request ç­‰ï¼Œå› ç‚ºæ ¸å¿ƒ library æä¾›çš„ api ä¸å¥½ç”¨ï¼› ä½†æ˜¯ Golang ä¸­æ²’æœ‰é€™æ¨£çš„å•é¡Œï¼Œå¦‚æœæ˜¯è¦å¯« CLI å·¥å…·ï¼Œè™•ç†åƒæ•¸ / ç”¢ç”Ÿ -help æ–‡ä»¶ç­‰æ ¸å¿ƒ library éƒ½è™•ç†å¦¥ç•¶ï¼›http request ç”¨åŸç”Ÿçš„ net/http å°±å¾ˆæ–¹ä¾¿ï¼Œç”šè‡³ api server ä¹Ÿéƒ½å¯ä»¥ä¸ç”¨ç¤¾ç¾¤çš„ framework å°±èƒ½å¤ å¿«é€Ÿå¯¦ä½œ\n3. è·¨å¹³å°ç·¨è­¯å‡ºå–®ä¸€å¯åŸ·è¡Œçš„ Binary æª” é›–ç„¶æœ‰ Docker æä¾›è·¨å¹³å°éƒ¨ç½²çš„ä¸€è‡´æ€§ä¿è­‰ï¼Œä½†æ˜¯ Golang å¯ä»¥ç›´æ¥ç·¨è­¯å‡ºå°æ‡‰å¹³å°å¯åŸ·è¡Œçš„ Binary æª”é‚„æ˜¯å¾ˆæ–¹ä¾¿ï¼Œåœ¨å¯« Dockerfile ä¹Ÿä¸ç”¨æ“”å¿ƒå¤ªå¤šç’°å¢ƒè¨­å®šæ˜¯å¦æ­£ç¢º / å®‰è£éå¤šå¥—ä»¶æ˜¯å¦æœ‰å®‰å…¨æ¼æ´ç­‰ç­‰\n4. å®˜æ–¹æ–‡ä»¶é½Šå…¨ä¸”è©³ç›¡ Golang å®˜ç¶²ä¸­çš„ Frequently Asked Questions (FAQ) èˆ‡ The Go Blogå°±æœ‰è§£ç­”æˆ‘è¨±å¤šç–‘æƒ‘ï¼ŒåŒ…å«\nç‚ºä»€éº¼ Golang è¦æŠŠå‹åˆ¥å®£å‘Šæ”¾åœ¨å¾Œé¢ Why are declarations backwards? å› ç‚ºç”¨å£èªå¿µç¨‹å¼ç¢¼æ›´ç›´è¦ºè¡¨é”å‡ºæ„åœ–\nç‚ºä»€éº¼è¦ç”¨ Go Two recent Go articles\nå› ç‚ºç›®å‰ç†±é–€çš„èªè¨€éƒ½æ˜¯åœ¨ç¶²è·¯/å¤šæ ¸å¿ƒæ™‚ä»£å‰çš„ç”¢ç‰©ï¼Œå¦‚C/C++/Javaï¼Œåƒæ˜¯thread åŠŸèƒ½éƒ½æ˜¯åœ¨èªè¨€èª•ç”Ÿå¾ˆä¹…ä¹‹å¾Œæ‰è¨­è¨ˆçš„ï¼›å¦å¤–ç¾ä»Šç³»çµ±çš„è¦æ¨¡ / å”ä½œäººå“¡ç­‰æ•¸é‡éƒ½å®Œå…¨ä¸åŒï¼Œæ‰€ä»¥éœ€è¦æœ‰æ–°å‹æ…‹çš„èªè¨€ä¾†æ”¯æ´ï¼›\nGo å…·å‚™å¿«é€Ÿç·¨è­¯/è·¨å¹³å°æ”¯æ´/åƒåœ¾å›æ”¶æ©Ÿåˆ¶/goroutine ä½µç™¼è¨­è¨ˆï¼Œè®“è¨­è¨ˆç¾ä»£è»Ÿé«”æ›´åŠ ç°¡ä¾¿\nå®˜æ–¹å°±æœ‰è±å¯Œçš„è³‡æºå¯ä»¥è®“é–‹ç™¼è€…æ›´æ·±åº¦çš„ç†è§£ Golang è¨­è¨ˆç²¾é«“èˆ‡å¥§å¦™\nçµèª é—œæ–¼åº•å±¤çš„ runtime ç¨®ç¨®é‚„æœ‰è¨±å¤šæœªè§£ä¹‹è¬ï¼Œå°±ç­‰æœªä¾†æ…¢æ…¢å¡«å‘ï¼Œçœ‹è‘—ä¸åŒèªè¨€çš„ç™¼å±•èˆ‡è¨­è¨ˆç†å¿µï¼Œè¦ºå¾—å¯¦åœ¨æ˜¯æœ‰è¶£\nå›æ­¸å·¥ä½œï¼Œå¦‚æœæ˜¯ä¸€äº›ç°¡å–®çš„ä»»å‹™ï¼Œå¯« Nodejs é‚„æ˜¯è »é †æ‰‹çš„ï¼›åªæ˜¯åœ¨å¤§å‹è»Ÿé«”é–‹ç™¼ä¸Šï¼ŒGolang çš„è¨­è¨ˆç†å¿µ / èªè¨€ç‰¹æ€§éƒ½è®“ä»–æˆç‚ºç†±é–€çš„é¸æ“‡ï¼Œä¸æ„§æ˜¯ Docker / K8s ç­‰å·¥å…·é¸æ“‡çš„é–‹ç™¼èªè¨€\n","date":"2021-03-07T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-03-07-%E5%BE%9E-nodejs-%E5%88%B0-golang-concurrency-%E5%AF%A6%E4%BD%9C%E6%AF%94%E8%BC%83/","title":"å¾ Nodejs åˆ° Golang: Concurrency å¯¦ä½œæ¯”è¼ƒ"},{"content":"æœ‹å‹æ–¼ 2018 å¹´å°±å»ä¸Šäº† 91 è€å¸«çš„èª²ï¼Œä¸æ–·çš„å¤§æ¨æ¥µé€Ÿé–‹ç™¼èˆ‡ TDDï¼Œç•¶æ™‚æƒ³èªªä¸€å ‚èª²ä¸€å…©è¬ä¹Ÿå¤ªé©šäººï¼Œå¾Œä¾†æœ‹å‹ç›´æ¥ç¾å ´ Demoï¼Œå°±æ­¤æ‰“ç ´æˆ‘çš„ä¸–ç•Œè§€ï¼Œæ²’æœ‰æƒ³åˆ°å¯«ç¨‹å¼å¯ä»¥æµæš¢æˆé€™ç¨®åœ°æ­¥ï¼Œå ±åå¹¾æ¬¡éƒ½æ²’æœ‰æ¶åˆ°ç¥¨ï¼Œæœ€å¾Œå ±åˆ° 2021/01 çš„èª²ç¨‹ï¼Œå¦‚æœæƒ³è¦å ±åï¼Œè¨˜å¾—è¦å†é–‹æ”¾ç¬¬ä¸€å¤©å°±æ¶ç¥¨å–”ï¼\nçµ•å°ç‰©è¶…æ‰€å€¼\nç¶“éå››é€±çš„ç·´ç¿’ï¼Œç›®å‰ Tennis Kata ä½¿ç”¨ WebStorm + ES6 é–‹ç™¼ï¼Œå¯ä»¥åœ¨ 15 åˆ†é˜å®Œæˆï¼Œè·Ÿé‚£äº›å£“åœ¨10åˆ†é˜ä»¥å…§çš„ç¥äººåŒå­¸ç›¸æ¯”é‚„å·®å¾ˆé ï¼Œä½†æƒ³èªªé‚„æ˜¯å¯ä»¥ç”¨è‡ªå·±çš„è§’åº¦åˆ†äº«ç·´ç¿’çš„éç¨‹\nå‰æƒ…æè¦ 91 éƒ¨è½æ ¼ã€æ¥µé€Ÿé–‹ç™¼+ã€‘ ä¸­æ˜ç¢ºæåˆ°\næˆ‘èªåŒã€Œæ™‚é–“ä¸å¤ ã€æ˜¯å€‹å•é¡Œï¼Œç„¶è€Œå»å¾ˆå°‘äººå»æ”¹å–„æˆ–è§£æ±ºé€™å€‹å•é¡Œã€‚é€™é–€èª²ï¼Œå°‡è®“å„ä½å­¸åˆ°ï¼Œå¦‚ä½•å»ºç«‹è‡ªæˆ‘åˆ»æ„ç·´ç¿’çš„æ¨¡å‹ï¼Œå°‡æ‰€æœ‰å·¥å…·çš„æ•´åˆèµ·ä¾†ç™¼æ®æœ€å¤§ç¶œæ•ˆï¼Œé€éæ­£ç¢ºçš„é–‹ç™¼æ–¹å¼èˆ‡é †åºï¼Œè®“ä½ å¯«ä»£ç¢¼æ™‚èƒ½è¡Œé›²æµæ°´ï¼Œä¸¦ä¸”å…¼é¡§è¨­è¨ˆã€å“è³ªèˆ‡ç”Ÿç”¢åŠ›ã€‚\nä¸€é–‹å§‹è½æœ‹å‹åˆ†äº«ï¼Œæœƒè¦ºå¾—ç†Ÿæ‚‰å·¥å…·ä½¿ç”¨å¥½åƒå¾ˆ lowï¼Œèº«ç‚ºå·¥ç¨‹å¸«æ‡‰è©²æ›´å°ˆæ³¨æ–¼æ¼”ç®—æ³•ã€æ¶æ§‹å±¤é¢ï¼Œä½†æ®Šä¸çŸ¥è‡ªå·±ä¸€å¤©çš„å·¥ä½œæ™‚é–“éƒ½æµªè²»åœ¨ç„¡è¬‚çš„éµç›¤æŒ‰éµèˆ‡æ»‘é¼ ç§»å‹•\nä¸Šèª²çš„ç¬¬ä¸€å€‹èª²ç¨‹æ˜¯ï¼Œå…©å…©ä¸€çµ„ï¼Œä¸€äººå¯« Tennis Kataï¼Œå¦ä¸€å€‹äººç´€éŒ„å¯«ç¨‹å¼çš„äººæµªè²»å¤šå°‘ç„¡è¬‚çš„æ–¹å‘éµï¼Œæˆ–æ˜¯åœ¨æ€æ¨£çš„å ´æ™¯ä½¿ç”¨æ»‘é¼ ï¼Œé€™ç„¡é—œä¹ç†Ÿä¸ç†Ÿæ‚‰ Tennis Kataï¼Œè€Œæ˜¯å°æ–¼å¯«ç¨‹å¼é€™é …æŠ€è—æ˜¯å¦ç°¡æ½”åˆ°æ²’æœ‰å¤šé¤˜çš„å‹•ä½œ\nåœ¨å¯«æ¸¬è©¦æ¡ˆä¾‹ï¼Œæˆ‘å€‘æ˜¯å¦æ¯æ¬¡éƒ½è¦é‡æ–°æ‰“\n1 2 3 it(\u0026#39;....\u0026#39;, ()=\u0026gt;{ expect(...).toBe(...) }) æˆ‘å€‘çœ¼ç›ç›¯è‘—ç¨‹å¼ç¢¼ç¬¬ 100 è¡Œçš„ name é€™å€‹è©ï¼Œæ˜¯å¦èƒ½å¤ å¾ˆç²¾æº–åˆå¿«é€Ÿè·³åˆ°å–®å­—ä¸Šï¼Œä¸¦é‡æ–°å‘½åç‚º firstName ç„¶å¾Œå¥—ç”¨åˆ°æ‰€æœ‰çš„å¼•ç”¨ä¸Šï¼Ÿ\nä¸Šå®Œèª²æœ€éœ‡æ’¼çš„æ˜¯ï¼Œè‡ªå·±å¾æ²’æœ‰æŠ½çµ²å‰ç¹­ã€Œå¯«ç¨‹å¼ã€é€™ä»¶äº‹ï¼Œè€Œæ˜æ˜æœ‰å¥½çš„å·¥å…· / å¥½çš„æ–¹æ³•ï¼Œç‚ºä»€éº¼ä¸ç”¨å‘¢ï¼Ÿï¼\nå¦‚ä½•ç·´ç¿’ ä¸Šå®Œèª² 91 ç¬‘è‘—èªªï¼Œæ¯å¤©åªç·´ 30 åˆ†é˜å°±å¥½ï¼Œå› ç‚ºå¤šç·´ä¹Ÿå¯èƒ½æ˜¯é‡è¤‡éŒ¯èª¤çš„å‹•ä½œï¼Œéµå®ˆè€å¸«çš„å©å’ï¼Œæˆ‘å›ºå®šæ¯å¤©æ—©ä¸Šç·´ç¿’ 30 åˆ†é˜ï¼Œé›–ç„¶æœ‰æ™‚å€™æœƒè¶…éï¼Œä½†ç›¡é‡ä¸è¦è®“è‡ªå·±ç·´ç¿’åˆ°å¿ƒç…©ï¼Œé¿å…å®¹æ˜“ä¸­æ–·ç¿’æ…£\nç¬¬ä¸€é€±ç·´ç¿’ ç¬¬ä¸€é€±ç®—æ˜¯æœ€ç—›è‹¦ï¼Œä½†å¥½åœ¨ä¹Ÿæ˜¯å‰›ä¸Šå®Œèª²èƒ½é‡æœ€å¼·çš„æ™‚å€™ï¼Œfocus åœ¨ tune IDE ä¸Šï¼Œå¾åŸæœ¬çš„ VSCode è½‰ç§»è‡³ Webstorm çš„é™£ç—›æœŸï¼Œä¸»è¦èª¿æ•´\nNodejs ç’°å¢ƒè¨­å®šï¼šå› ç‚ºæƒ³è¦ ESM æ‰€ä»¥è¦æ‰“é–‹è¨­å®šåƒæ•¸ (Nodejs v14 ä»¥å‰) æ’ç‰ˆï¼šå¹«å¿™è£œä¸Šï¼›ç­‰ / å»é™¤å¤šé¤˜çš„æ–·è¡Œ / æ›å­—é«”ç­‰ç­‰ èª¿æ•´ .ideavimrm\né€™éƒ¨åˆ†å¾ˆèŠ±æ™‚é–“ï¼Œä½†å¾ˆå»ºè­°è‡ªå·±æƒéæ•´å€‹æª”æ¡ˆï¼ŒæŠŠå¤šé¤˜çš„æŒ‡ä»¤ç§»é™¤ï¼Œä¸¦ç¢ºä¿è‡ªå·±å¤§æ¦‚çŸ¥é“æ¯å€‹æŒ‡ä»¤çš„å«ç¾©ï¼Œå°¤å…¶æ˜¯ zr ç³»åˆ— 1 2 3 4 5 zri: inline zrp: æŠ½åƒæ•¸ zrm: æŠ½æ–¹æ³• zrf: æŠ½æˆ field zrn: æˆ‘è‡ªå·±åŠ çš„ï¼Œrefactor element åƒæ˜¯ç”¨ Mac é–‹ç™¼ï¼Œè¦ä½¿ç”¨ F1~F12 éƒ½å¾ˆç—›è‹¦ï¼Œæˆ‘å°±å»æŸ¥ :actionlist æ‰¾å‡º idealvim æ”¯æ´çš„ actionï¼Œæˆ–æ˜¯æŸ¥é€™ä¸€åˆ† IdeaVim actionlist\né›–ç„¶è¨­å®š keymap ä¹Ÿå¯ä»¥ï¼Œä½†æƒ³èªªèƒ½å¤ ç”¨ä¸€å¥—å°±å…¨éƒ¨ç”¨ä¸€å¥—ï¼Œæ‰€ä»¥åˆ‡æ›æª”æ¡ˆæˆ‘ä¹Ÿé‡æ–°ç¶é\nç¬¬ä¸€é€±åªåšåˆ° tune ideï¼Œä¸¦ç·´ç¿’åˆ° \u0026rsquo;thirty love\u0026rsquo;ï¼Œä¸¦ç†Ÿæ‚‰ zr ç³»åˆ—çš„å¿«æ·éµ\nç¬¬äºŒé€± æ¥ä¸‹ä¾†æŒ‘æˆ°å¯«å®Œæ•´å€‹ tennisï¼Œé€Ÿåº¦å¤§æ¦‚åœ¨ 22~25 åˆ†é˜ï¼Œæ¯å¤©å›ºå®šå…ˆçœ‹ä¸€æ¬¡è€å¸«çš„å½±ç‰‡ï¼Œæ³¨æ„è‡ªå·±å¾ˆå¡çš„åœ°æ–¹è€å¸«æ€éº¼å¯«ï¼Œä¾‹å¦‚è£œ \u0026rsquo;this.\u0026rsquo; / è£œ ; è£œ , ç­‰ç­‰ï¼Œæ…¢æ…¢ä¿®æ‰ä¸€äº›å£ç¿’æ…£ï¼Œç›¡å¯èƒ½æ¯æ¬¡ç·´ç¿’åªå°ˆæ³¨åœ¨ä¸‰å€‹é»ä¸Šé¢ï¼Œä¹Ÿæ…¢æ…¢æ›´ç†Ÿæ‚‰ä½¿ç”¨ j / k / w / b ç§»å‹•ï¼Œæ™‚æ™‚æé†’è‡ªå·±æƒ³ä¸å‡ºä¾†ä¹Ÿä¸å¯ä»¥è‡ªæš´è‡ªæ£„ç”¨æ–¹å‘éµè·Ÿæ»‘é¼ ï¼Œåœä¸‹ä¾†çœ‹è€å¸«çš„å½±ç‰‡\nç¬¬ä¸‰é€± è‡ªå·±ç·´ç¿’é€Ÿåº¦å¡åœ¨ 22 åˆ†é˜ä¸Šä¸‹ï¼Œç™¼ç¾æ˜¯å¾ŒåŠæ®µå¤ªä¸ç†Ÿç·´ï¼Œæ±ºå®šå°ˆæ”»å¾ŒåŠæ®µï¼Œç”¨ git ä¿å­˜é€²åº¦ï¼Œæ¯å¤© reset åè¦†ç·´ç¿’ï¼Œä¸€æ¨£æ˜¯å…ˆçœ‹è€å¸«çš„å½±ç‰‡é…æ—©é¤ï¼Œæ¥è‘—ç”¨ä¾¿æ¢ç´™å¯«ä¸‹è¦æ”¹é€²çš„ä¸‰å€‹é»ï¼Œå¦‚æœé‡åˆ°è‡ªå·±å¾ˆå¡çš„åœ°æ–¹ï¼Œç›´æ¥ä¿®æ”¹ .ideavimrc\né€™ä¸€é€±é€Ÿåº¦çš„é€²æ­¥ä¾†è‡ª\næ›´å¤šæ¡ç”¨ Acejump\nä¸€é–‹å§‹ä¸‹æ„è­˜éƒ½æ˜¯ç”¨ j/k/w/b å»ç§»å‹•ï¼Œé–‹å§‹æœ‰æ„è­˜ç·´ç¿’ç”¨ Acejumpï¼Œé€™é‚Šä¹Ÿå¾ˆæ„Ÿè¬åŒæ¢¯åŒå­¸åœ¨ç¾¤çµ„ä¸­ä¸æ–·è¨è«–æœ€ä½³å¯«æ³• ç·´ç¿’ vim surround å„ªåŒ– Math.abs ç·¨å¯«\nå¯ä»¥åƒè€ƒé€™ä»½ gist vim-surroundä½¿ç”¨æŒ‡å—.MDï¼Œå¦‚æœè¦é‡å°å·²é¸å–çš„éƒ¨åˆ†è¦ç”¨ S åŠ ä¸Šå°ç¨±ç¬¦è™Ÿ å–æ¶ˆ Webstorm æŠ½åƒæ•¸æ™‚è£œä¸Šé è¨­\nå‡è¨­ä»¥ä¸‹è¦æŠŠ \u0026ldquo;joey\u0026rdquo; æŠ½æˆåƒæ•¸ï¼Œæˆ‘çš„é è¨­æœƒæ˜¯å¸¶å…¥é è¨­å€¼ï¼Œé€™æ¨£æœƒè®“åŸæœ¬åœ¨åˆå§‹åŒ– Tennis æ™‚ä¸æœƒè‡ªå‹•è£œä¸Š new Tennis(\u0026ldquo;joey\u0026rdquo;) 1 2 3 4 5 6 7 constructor(){ this.firstPlayerName = \u0026#34;joey\u0026#34; } constructor(firstPlayerName = \u0026#34;joey\u0026#34;){ let firstPlayerName = firstPlayerName } åœ¨æŠ½åƒæ•¸æ™‚æœƒæœ‰å°æç¤ºï¼Œè¨˜å¾—è¦é»æ‰\nå¦ä¸€å€‹ç·´ç¿’æ˜¯æª”æ¡ˆç›®éŒ„æ“ä½œï¼Œä¾‹å¦‚èªªå¤šå»ºä¸€å€‹ folder / æŠŠæª”æ¡ˆç§»å‹•éå» / åˆªé™¤æª”æ¡ˆé€™äº›ï¼ŒåŸæœ¬ Tennis æ²’æœ‰ç·´åˆ°é€™éƒ¨åˆ†ï¼Œä½†å¯¦å‹™ä¸Šé€™äº›å‹•ä½œå¾ˆéœ€è¦ï¼Œå°±æœ‰èŠ±é¡å¤–çš„æ™‚é–“ç·´ç¿’\nç¬¬å››é€±ç·´ç¿’ å¾åŸæœ¬ 22 åˆ†é˜é€²æ­¥åˆ° 19 åˆ†ï¼Œé–‹å§‹ç”¨æ®µè½åˆ‡å‰²ï¼Œä¸€é‚Šæ”¾è€å¸«çš„å½±ç‰‡ä¸€é‚Šæ”¾è‡ªå·±çš„å½±ç‰‡ï¼Œæ‰¾å‡ºç‚ºä»€éº¼è‡ªå·±æœƒè½å¾Œçš„åœ°æ–¹\nè€å¸«çš„æ™‚é–“å¤§æ¦‚æ˜¯\n(1:54) fifteen love (4:16) thirty love (8:00) love thirty (9:24) deuce (13:24) done è§€å¯Ÿå¾Œæœ‰å¹¾å€‹è‡ªå·±å®¹æ˜“å¿˜è¨˜çš„å¿«æ·éµ\né¸å–æŠ½æ–¹æ³•ï¼Œå¯ä»¥ç”¨ z( / z{ å¿«é€ŸæŠ½å–ï¼Œå°æ¯” vi( å¿«ä¸Šä¸€é» åˆªé™¤å«å–®å¼•è™Ÿçš„è®Šæ•¸ å·¥ä½œä¸Šç”¨å¾—åˆ°å—ï¼Ÿ ç·´ç¿’çœ‹èµ·ä¾†å¾ˆç†æƒ³ï¼Œä½†å¯¦å‹™ä¸Šæœ‰ç”¨å—ï¼Ÿ\né€™ä¹Ÿæ˜¯åœ¨ç·´ç¿’éç¨‹ä¸æ–·æ€è€ƒçš„ï¼Œé›–ç„¶æœæ–·ä¹ŸæŠŠå·¥ä½œæ©Ÿè½‰æˆ Webstrom + idealvimï¼Œæ–°å°ˆæ¡ˆç·¨å¯«è‡ªç„¶æ²’å¤ªå¤§å•é¡Œï¼Œä½†æ˜¯èˆŠå°ˆæ¡ˆä½¿ç”¨ä¸Šå°±å¡å¡çš„ï¼Œä¸»è¦æ˜¯ä»¥å‰çš„ js å¯«æ³•æ¯”è¼ƒäº‚ï¼Œide å¾ˆé›£è‡ªå‹•è¾¨åˆ¥ï¼ŒåŠ ä¸Šä¸€å€‹æª”æ¡ˆç¨‹å¼ç¢¼ä¸Šåƒè¡Œï¼ŒèŠ±æœ€å¤šçš„æ™‚é–“ä¸æ˜¯åœ¨æ–¼ä¿®æ”¹è€Œæ˜¯æŸ¥è©¢ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ ,m å»çœ‹ file structureï¼Œæ¥ä¸‹ä¾†å°±æ˜¯ç”¨æ»‘é¼ æ»¾æ»¾æ»¾çœ‹ Code\nè€å¸«ä¹Ÿæœ‰åœ¨ä¸Šèª²æåˆ°ï¼Œæ»‘é¼ ä¹Ÿä¸æ˜¯ä¸å¥½ï¼Œåœ¨æŸ¥è©¢æ™‚æ»‘é¼ æ»¾å‹•é‚„æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¸ç”¨å¤ªæ‹˜æ³¥\nç¸½ä¹‹ç›®å‰å·¥ä½œä½¿ç”¨ä¸Šé‚„æ²’æœ‰åˆ°å¾ˆé †ï¼Œæœƒå°‘é‡ç”¨ä¸€äº›å¿«æ·éµå¦‚æŠ½æ–¹æ³• / æŠ½åƒæ•¸ï¼Œä½†æ˜¯é‚„æ²’æœ‰è¾¦æ³•æµæš¢çš„ä½¿ç”¨çµ„åˆæŠ€\n","date":"2021-02-16T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-02-16-%E6%A5%B5%E9%80%9F%E9%96%8B%E7%99%BC-%E4%B8%8A%E8%AA%B2%E8%88%87%E7%B7%B4%E7%BF%92%E5%BF%83%E5%BE%97/","title":"ã€æ¥µé€Ÿé–‹ç™¼+ã€‘ä¸Šèª²èˆ‡ç·´ç¿’å¿ƒå¾—"},{"content":"å·¥ä½œä¹Ÿå››å¹´äº†ï¼Œä¾†åˆ°è·æ¶¯æœ€ç‚ºè¿·æƒ˜çš„ä¸€å¹´ï¼Œéå»ä¹Ÿä¸ç®—æ··æ±å­¸è¥¿å­¸å¥½åƒæ‹¼æ¹Šå‡ºä¸€äº›æ±è¥¿ï¼Œä½†ä¹Ÿé–‹å§‹æ‡·ç–‘è‡ªå·±è©²é¸ä»€éº¼æŠ€è¡“ç™¼å±•ï¼Ÿåˆæ‡‰è©²é¸æ“‡æ€æ¨£çš„å·¥ä½œèˆ‡è·æ¶¯ï¼Ÿæœªä¾†åˆä½•å»ä½•å¾ï¼Ÿ\nåœ¨é€™ä½æ½®æœŸï¼Œå‰›å¥½ä¸Šå®Œ 91 è€å¸«çš„æ¥µé€Ÿé–‹ç™¼èª²ç¨‹ï¼Œåœ¨æŠ€è¡“åŸ¹è¨“ä¸Šå¸¶çµ¦æˆ‘å¾ˆæ£’çš„è¦–é‡èˆ‡å¼·å¤§çš„å­¸ç¿’å‹•èƒ½ï¼Œç™¼ç¾è‡ªå·±çš„åŸºæœ¬åŠŸæ‡‰è©²å†å¥½å¥½é›•ç¢ï¼›\nåˆå‰›å¥½åœ¨å•†æ¥­æ€ç¶­å­¸é™¢çœ‹åˆ° 91 è€å¸«åˆ†äº«è·æ¶¯çš„ç¨®ç¨®é¸æ“‡èˆ‡è¦åŠƒï¼Œè¦ºå¾—ååˆ†çš„æ•¬ä½©ï¼Œè‡ªå·±ä»¥ä¸€å€‹å·¥ç¨‹å¸«è·æ¶¯ç™¼å±•çš„è§’åº¦ï¼Œæ‘˜éŒ„ 91 å¤§å¤§åœ¨å•†æ¥­æ€ç¶­å­¸é™¢çš„åˆ†äº«\nå…ˆåˆ†äº«æœ€å¾Œ Qï¼†Aï¼Œä¹Ÿæ˜¯å¤§å®¶å¸¸è¦‹çš„å•é¡Œï¼Œæ¥è‘—åœ¨æ‘˜éŒ„å¾ŒçºŒ 91 çš„åˆ†äº«\né«˜è–ªå·¥ç¨‹å¸«èˆ‡ä½è–ªå·¥ç¨‹å¸«çš„å·®ç•° å›æ­¸å¸‚å ´éœ€æ±‚ï¼Œçœ‹é€™å€‹å¸‚å ´éœ€è¦æ€éº¼æ¨£çš„èƒ½åŠ›ï¼Ÿæ˜¯ä¸æ˜¯æœ‰å¾ˆå¤šäººå¯ä»¥æä¾›é€™æ¨£çš„èƒ½åŠ›ï¼Ÿæˆ‘å¯ä¸å¯ä»¥åˆå¿«åˆå¥½åˆä¾¿å®œçš„è§£æ±ºå•é¡Œï¼ŸåŸ¹é¤Šå‡ºè‡ªæˆ‘çš„ç¨€ç¼ºèƒ½åŠ›ï¼Œæ‰æœ‰è­°åƒ¹çš„è‡ªç”±\nå·¥ç¨‹å¸«è¦å°å¿ƒæŠ€è¡“æœ¬ä½ï¼Œéœ€è¦è‘—çœ¼æ–¼å•†æ¥­åƒ¹å€¼çš„è²¢ç»ï¼Œ91 è€å¸«èˆ‰ä¾‹è‡ªå·±çš„èª²ç¨‹æ²’æœ‰ä¸²é‡‘æµï¼Œå› ç‚ºé€™ä¸æ˜¯å•†æ¥­ä¸Šç™¼å±•çš„ç“¶é ¸ï¼Œä½†å¾ˆå¤šå·¥ç¨‹å¸«æœƒè¦ºå¾—å¾ˆé…·å¾ˆæ–¹ä¾¿å°±å»åšï¼Œä½†é€™ä¸æœƒå¸¶ä¾†å¤ªå¤§çš„æ•ˆç›Š\nå¦‚ä½•é¿å…è‡ªå·±æˆç‚ºä¸€å¹´ç¶“é©—ç”¨åå¹´çš„å·¥ç¨‹å¸« å¦‚æœè‡ªå·±æ˜¯ç’°å¢ƒä¸­æœ€å¼·çš„äººï¼Œå»ºè­°æ›å€‹ç’°å¢ƒï¼Œæ‰¾æ–°çš„å­¸ç¿’å‹•èƒ½ è§€å¯Ÿåˆ¥äººå¦‚ä½•è§£æ±ºå•é¡Œï¼Œæ‰€ä»¥ 91 æ¨å´‡ Pair / Mod Programmingï¼Œå¾åˆ¥äººçš„ä½œæ³•å¯ä»¥æ‰¾åˆ°ä¸åŒçš„å­¸ç¿’æ–¹å¼ æŒçºŒå­¸ç¿’ / æŒçºŒå˜—è©¦ è§€å¯Ÿè‡ªå·±æœ‰æ²’æœ‰å¾ˆå¸¸åŠ ç­ï¼Œæˆ–æ˜¯ä¸€ç›´åšé‡è¤‡æ€§å¾ˆé«˜çš„å·¥ä½œï¼Œè«‹ç”¨æ™‚é–“å»è³ºæ™‚é–“ï¼Œæ‰¾åˆ°æ­£å‘å¢å¼·è¿´è·¯ è©²é¸æ“‡ä»€éº¼æŠ€è¡“ç™¼å±• åŒæ¨£æ˜¯å¸‚å ´éœ€æ±‚ï¼Œç•¶åˆ 91 ä¸å–œæ­¡å‹•æ…‹èªè¨€ï¼Œä½†å‰é™£å­ python å¾ˆç«ç†±ï¼Œä»–é€éé¡§å•å‘å®¢æˆ¶å­¸ç¿’ï¼Œæœ€å¾Œç™¼ç¾ä»–ä¹Ÿå–œæ­¡ä¸Š python äº†\n91 å¾ˆæ…¶å¹¸è‡ªå·±æ˜¯é¡§å•èˆ‡æ•™å­¸å…¼ä½µï¼Œé¡§å•å¯ä»¥å¾å®¢æˆ¶ä¸­å¾—åˆ°å¯¦å‹™ä¸Šçš„ç¶“é©—ï¼Œè½‰è®ŠæˆåŸ¹è¨“æ™‚çš„æ•™å­¸æ–¹å‘ï¼Œå¦‚æœåªåšæ•™å­¸å°±ä¸€ç›´åƒè€æœ¬ç„¡æ³•æˆé•·\nJunior å·¥ç¨‹å¸«æ”¹å¾€å»£é‚„æ˜¯å¾€æ·± å…ˆæ‰¾åˆ°ç«‹è¶³ä¹‹åœ°ï¼Œç†Ÿæ‚‰ä¸€å€‹æŠ€è¡“åˆ°å¯ä»¥è§£æ±ºå¤§å¤šæ•¸çš„å•†æ¥­å•é¡Œï¼Œä¾‹å¦‚èªª GraphQL ç”¨å‹•æ…‹èªè¨€ python / js æ¯”è¼ƒå¥½å¯¦ä½œï¼Œä½† c# ä¸€æ¨£å¯ä»¥è§£æ±ºä½†å¯èƒ½æ¯”è¼ƒä¸é©åˆ(é€™å¥½åƒæ€ªæ€ªçš„ï¼Ÿ)ï¼Œæ…¢æ…¢ç™¼ç¾æŸäº›åœ°æ–¹å¯èƒ½è§£æ³•ä¸å¤ æ¼‚äº®ï¼Œå†é–‹å§‹è·³å»å­¸æ–°çš„æŠ€è¡“ï¼Œå°±æœ‰è¶³å¤ çš„å‹•æ©Ÿå»å­¸ç¿’\nJunior å·¥ç¨‹å¸«è©²å»æ–°å‰µé‚„æ˜¯å¤§å…¬å¸ éƒ½æ˜¯é¸æ“‡è€Œå·²ï¼Œæ–°å‰µå…¬å¸éœ€è¦å¿«é€Ÿã€ä½æˆæœ¬çš„è¿­ä»£ï¼Œå¯ä»¥å­¸ç¿’å¦‚ä½•æ¶ç˜ã€å¿«é€Ÿå¾—åˆ°å¸‚å ´çš„å›é¥‹ï¼›å¤§å…¬å¸å‰‡æ˜¯åˆ†å·¥å¾ˆç´°ï¼Œé–‹ç™¼åªåšé–‹ç™¼ï¼Œä¸æ‡‚æ•´å€‹ç”¢å“é¢å‘ï¼Œ91 ä¸å¤ªèªåŒé€™æ¨£çš„åˆ†å·¥æ–¹å¼ï¼Œä½†æ˜¯ç•¶åˆé¸æ“‡ Yahoo æ˜¯å› ç‚ºå¯ä»¥æ¥è§¸åˆ°æ›´å¤šçš„è¦–é‡ / å¯¦åŠ›å¾—åˆ°æ›´å¤šçš„åŸ¹é¤Šï¼Œè€Œä¸”èƒ½åšå…¨ä¸–ç•Œçš„ç”Ÿæ„\næœ€å¾Œå›æ­¸é‡é»ï¼Œæ™‚é–“æ˜¯æœ€è²´çš„ï¼Œç”¨æ™‚é–“å»è³ºæ™‚é–“\n91 å¤§å¤§ä¸»è¦åˆ†äº«å·¥ä½œä¸Šçš„é¸æ“‡ / å·¥ä½œä»¥å¤–å¦‚ä½•å‰µé€ é€£çµ / å¦‚ä½•é€éæŠ€è¡“è®Šç¾ / æœ€å¾Œå›é¡§è·æ¶¯çš„æˆé•·\nå¤§äº‹è¨˜(å·¥ä½œç¶“æ­·) ç¬¬ä¸€ä»½å·¥ä½œï¼šå¡æš(åœ‹é˜²å½¹) 4 å¹´ åœ‹é˜²å½¹å°±æ˜¯å››å¹´è·‘ä¸æ‰çš„å¥½ç”¨å‹å·¥ï¼Œæ‰€ä»¥ 91 ä¹Ÿå¸¸è¢«æ´¾å»è™•ç†æ£˜æ‰‹çš„ä»»å‹™ï¼Œåœ¨é€™ç¬¬ä¸€ä»½å·¥ä½œä¸­ï¼Œ91 ç£¨ç·´äº†æ‰å¯¦åŸºæœ¬åŠŸ / å¦‚ä½•å¸¶ team / æ•æ·é–‹ç™¼ï¼Œå› ç‚ºæ˜¯ä½¿ç”¨å¾®è»Ÿçš„ solutionï¼Œ91 ä¹Ÿæ‹¿åˆ°äº†å¾®è»Ÿ MVP çš„é ­éŠœ\nç·´å¥½åŸºæœ¬åŠŸï¼Œæ‰¾åˆ°è‡ªæˆ‘çš„ç«‹è¶³ä¹‹åœ°\nç¬¬äºŒä»½å·¥ä½œï¼šYahoo 5 å¹´ é›¢é–‹åœ‹é˜²å½¹æ™‚æœ‰æ‹¿åˆ° 7 å€‹ offerï¼Œæœ€å¾Œé¸æ“‡è–ªè³‡æœ€ä½çš„ Yahoo åŸå› æ˜¯\næœ¬èº«å°æ–¼äº¤æ˜“å‹ç³»çµ±æœ‰èˆˆè¶£ è·æ¶¯æ‰å‰›é–‹å§‹ï¼Œé¸æ“‡è·æ¶¯å‡ºè·¯æœ€å»£çš„å…¨çƒæ€§ / ç´”è»Ÿå…¬å¸ å¾ˆæ·±çš„é«”æ‚Ÿæ˜¯ å¦‚æœå·²ç¶“æ˜¯åœ˜éšŠæœ€å¼·çš„äººï¼Œé‚£ä½ çš„é€²æ­¥æœƒå¾ˆæ…¢ï¼Œé¸æ“‡ Yahoo æœ‰å¾ˆå¤šå¾ˆå¼·çš„æŠ€è¡“äººå¯ä»¥ç•¶ä½œ role modelï¼ŒåŒæ™‚é–‹æ”¾çš„æ–‡åŒ–ä¹Ÿè®“ 91 æœ‰æ›´å¤šå˜—è©¦çš„æ©Ÿæœƒï¼Œç´¯ç©æ›´å¤šçš„æŠ€è¡“è²é‡\nç¬¬ä¸‰ä»½å·¥ä½œï¼šæ±æ£®ä¿¡æ¯ - 1 å¹´ åœ¨ Yahoo äº”å¹´ä¹Ÿåšå¾—å·®ä¸å¤šäº†ï¼Œç¬¬ä¸‰ä»½å·¥ä½œæœ‰é»è·Œç ´å¤§å®¶çœ¼é¡ï¼Œå»äº†ä¸€å€‹ç™¾å»¢å¾…èˆˆçš„æ±æ£®ä¿¡æ¯ï¼Œæ“”ä»»æ¶æ§‹å¸« / è² è²¬èˆ‡å…¶ä»–åœ˜éšŠæºé€šï¼ŒæŠŠä¹‹å‰æ‰€æœ‰ç´¯ç©çš„ç¶“é©—éƒ½è®Šæˆè–ªè³‡ç±Œç¢¼ (350+)ï¼Œä½†é€™ä¹Ÿæ˜¯äººç”Ÿæœ€æ…˜æ•—çš„ä¸€å¹´ï¼Œç™¼ç¾ ä¸Šç­æ™‚çš„ä¸å¿«æ¨‚ä¸èƒ½å¾ä¸‹ç­ä¸­è£œè¶³ï¼ŒåŒæ™‚ç§‘æ™®ä¸€ä¸‹å¹´è–ªé 300 å¾Œç¨…æ”¶ä¹Ÿå¢åŠ ï¼Œå¤šä¸€äº›éŒ¢ä½†å…¶å¯¦ä¸æœƒæ¯”è¼ƒå¿«æ¨‚\nç¬¬å››ä»½å·¥ä½œï¼šOdd-e ä»¥å‰å°±æ‰¾åˆ°è‡ªå·±ç†±æ„›çš„å¤©è·ï¼šé¡§å•+æ•™å­¸ï¼ŒåŸºæ–¼ä¸Šä¸€ä»½æ•™è¨“ï¼Œæ±ºå®šå¾è‡ªå·±ç†±æ„›çš„äº‹ç‰©è®Šç¾(å•†æ¥­æ€ç¶­)ï¼Œé›–ç„¶è¦é¢è‡¨æ›´é«˜çš„ä¸ç¢ºå®šæ€§ï¼Œä½†æ±ºå®šçµ¦è‡ªå·±ä¸€å¹´çš„æ™‚é–“å˜—è©¦ï¼Œæœ€å¾Œå°±ä¸€è·¯åšåˆ°ç¾åœ¨ (è–ªè³‡é‚„ç¿»å¥½å¹¾å€!)\nå‰µé€ é€£çµ è¦åœ¨ç¤¾ç¾¤ä¸­æ‰¾åˆ°è‡ªå·±çš„ç«‹è¶³ä¹‹åœ°ï¼Œ91 = æ•æ· + é–‹ç™¼ï¼Œæ‰€æœ‰çš„å˜—è©¦éƒ½åœç¹è‘—é€™å…©å¡Šèµ°\nç¤¾ç¾¤è²¢ç» åœ¨ç¤¾ç¾¤ä¸­æ‰¾åˆ°å¾ˆå¤šè²´äººï¼Œä¹Ÿé€éç¤¾ç¾¤å¥ å®šè‡ªå·±çš„æ±Ÿæ¹–åœ°ä½\næŒçºŒæ›å…‰ å¯«éƒ¨è½æ ¼ / åƒåŠ  IT éµäººè³½ / è¬›å¸«äº¤æµ / FB ç²‰çµ²å°ˆé  / Youtuber\nç•°æ¥­çµç›Ÿ å¤©ç“æ›¸å±€ / å‡ºç‰ˆæ¥­ / ä¼æ¥­æ‹›å‹Ÿ / å•†æ¥­æ€ç¶­å­¸é™¢\nå°ˆæ¥­å½¢è±¡ å‡ºç‰ˆæ›¸ç± / å¾®è»Ÿ MVP / ç ”è¨æœƒè¬›å¸«\næŠ€è¡“è®Šç¾ å¾å¯©æ ¡é–‹å§‹ ç¬¬ä¸€æ¬¡å‡ºç‰ˆæ˜¯å¯©æ ¡ç°¡é«”ç‰ˆçš„ .net æ›¸ç±ï¼Œæ­¤æ™‚ä»¥é–‹ç™¼è€…çš„è§’åº¦å‡ºç™¼ï¼Œè¸å‡ºç¬¬ä¸€æ­¥å°‡æŠ€è¡“è®Šç¾\næ¥è‘—ç¬¬äºŒæ¬¡å‡ºç‰ˆè®Šæˆå…±åŒç¿»è­¯æ•æ·åŸæ–‡æ›¸ï¼Œä¹Ÿå…±åŒå‡ºç‰ˆäº†è·Ÿ .net ç›¸é—œçš„æ›¸ç±\næ¥åˆ°ç¬¬ä¸€å ´ä¼æ¥­å…§è¨“ æŒçºŒå‡ºç‰ˆè·Ÿ .net ç›¸é—œçš„æ›¸ç±ç´¯ç©è²é‡ï¼ŒåŒæ™‚æ¥åˆ°ç¬¬ä¸€å ´ä¼æ¥­å…§è¨“ï¼Œç•¶æ™‚æœ‰åº•æ°£æ¥ä¼æ¥­å…§è¨“ä¹Ÿæ˜¯å› ç‚ºåœ¨ Yahoo ç´¯ç©å¾ˆå¤šå ´å…§éƒ¨å“¡å·¥åŸ¹è¨“çš„ç¶“é©—ï¼Œä¹Ÿé–‹å§‹é–‹è¾¦å…¬é–‹èª²ç¨‹\nåœ¨ç¤¾ç¾¤çš„è€•è€˜ä»¥åŠéƒ¨è½æ ¼çš„ç´¯ç©ï¼Œé–‹å§‹æ”¶åˆ°å°ˆæ¬„é‚€ç´„ï¼Œæœ‰äº†å¦ä¸€ä»½æ”¶å…¥\næŒçºŒå˜—è©¦ 91 åœ¨æ¼”è¬›ä¸æ–·é‡è¤‡ã€Œåœ¨ä¸é¤“æ­»çš„æƒ…æ³ï¼Œæˆ‘é‚„æœ‰XXX æƒ³è¦å˜—è©¦ã€ï¼Œåƒ 2021 å¹´åˆç¿»è­¯äº† Kent Beck çš„æ›¸ç±ï¼Œç®—æ˜¯äººç”Ÿä¸€å¤§çªç ´ï¼Œä¹Ÿå¾ˆç¬¦åˆã€Œæ•æ·+é–‹ç™¼ã€çš„äººç‰©è¨­å®šï¼› åœ¨ä»Šå¹´ 91 å› æ‡‰ç–«æƒ…ï¼Œæ±ºå®šå˜—è©¦ Youtube / ç·šä¸Šèª²ç¨‹ï¼Œä¸¦å˜—è©¦èˆ‡ä¸åŒè¬›å¸«å»ºç«‹é€£çµã€å½¼æ­¤å°æµ\nå°ç¯€ å¾ªåºæ¼¸é€²çš„çªç ´ï¼š å¾å¯©æ ¡ \u0026gt; å…±åŒç¿»è­¯ \u0026gt; å…±åŒå‡ºç‰ˆ / å…¬å¸å…§è¨“ \u0026gt; å¤–éƒ¨ä¼æ¥­åŸ¹è¨“ \u0026gt; å…¬é–‹èª²ç¨‹ \u0026gt; é¡§å• è®“æ‰€æœ‰çš„å˜—è©¦æœ‰é€£çµï¼š ç¿»è­¯ã€Šå–®å…ƒæ¸¬è©¦çš„è—è¡“ã€‹ï¼Œæ”¯æ’ä¼æ¥­å…§è¨“èˆ‡åŸ¹è¨“èª²çš„å…§å®¹ / å…¬é–‹èª²å°æ–¼äº‹æ¥­çš„å¹«åŠ©ï¼Œå­¸å“¡æœƒå»å…¬å¸æ¨å‹•ï¼Œå¸¶ä¾†ä¼æ¥­å…§è¨“ + é¡§å•æ¡ˆçš„æ©Ÿæœƒ æ‰¾åˆ°é˜²ç·šï¼š ç¢ºä¿è‡ªå·±æœ‰åº•ç·šï¼Œæœ‰ç¬¬ä¸€é–“é¡§å•æ¡ˆéˆ¦å¦ï¼Œä¹‹å¾Œæ‰å¥½è«‡åº•åƒ¹ï¼Œè‡ªå·±ä¹Ÿä¸æœƒæ…Œ æ°¸é ç•™æ™‚é–“ä¿æŒå˜—è©¦ï¼š æ‰¾åˆ°ç¬¬äºŒé–“é¡§å•æ°¸è±é‡‘ / å­¸ç¿’æ–°èªè¨€ Pythonï¼Œè—‰ç”±å®¢æˆ¶æ‹“å±•è¦–é‡ï¼Œå›é¥‹åˆ°å…¬é–‹èª²ç¨‹ / ç¤¾ç¾¤çš„å…§å®¹ä¸­ ç‚ºå¸‚å ´å¸¶ä¾†åƒ¹å€¼ï¼š\nè§€å¯Ÿå¸‚å ´çš„å‹•å‘ï¼Œä»¥è§£æ±ºä¼æ¥­å•é¡Œç‚ºç›®æ¨™ è·æ¶¯æˆé•· 1. Job æ™‚é–“æ˜¯æœ€è²´çš„ï¼šå¦‚ä½•è¡¡é‡è‡ªå·±çš„åƒ¹å€¼ï¼Ÿ 91 è¡¨ç¤ºç¯€çœè€é—†çš„æ™‚é–“ / ç¯€çœåœ˜éšŠçš„æ™‚é–“å°±æ˜¯ä½ çš„åƒ¹å€¼ ç”¨æ™‚é–“è³ºæ™‚é–“ï¼šé€éå·¥å…· / æå‡æŠ€èƒ½ç­‰è³ºæ›´å¤šçš„æ™‚é–“ï¼Œæ‰èƒ½æŒçºŒæå‡è‡ªå·±çš„åƒ¹å€¼ è·¨å‡ºå»æŒçºŒå­¸ç¿’ï¼šæŒ‘å…¬å¸æ™‚é¸æ“‡é–‹æ”¾é€æ˜ï¼ŒæŠŠæ–°çš„æ–¹æ³•å¸¶å›å…¬å¸ï¼Œç”¨æ™‚é–“è³ºæ™‚é–“ (å‘¼æ‡‰ä¸Šä¸€é») å‘ä¸Šæºé€šï¼šæŒçºŒèˆ‡ä¸Šå¸å³æ™‚åŒæ­¥ï¼Œå–å¾—å…±è­˜ 2. Work æ‰¾æ„›ï¼šé€™æ˜¯é•·æœŸæŠ•è³‡ï¼ŒåŸæœ¬ 91 å¾ˆè¨å­å‹•æ…‹èªè¨€ï¼Œä½†ä»–è¦ºå¾—æ‡‰è©²è¦å˜—è©¦éæ‰èƒ½æ‰¹è©•ï¼Œæœ€å¾Œä¹Ÿå–œæ­¡ä¸Š Pythonã€Ruby ç­‰ï¼Œè¦è©¦éæ‰çŸ¥é“ ç¶œæ•ˆï¼šæ‰¾æ„›å¾Œé–‹å§‹æƒ³è¾¦æ³•é—œè¯ï¼Œä¾‹å¦‚å¸‚å ´ä¸Šé–‹ç™¼èˆ‡æ•æ·åŸ¹è¨“çš„éœ€æ±‚ï¼Œæœ‰æ•æ·æ•™ç·´ï¼Œä½†ä»–å€‘å¯èƒ½ä¸æ‡‚é–‹ç™¼ / åä¹‹äº¦ç„¶ï¼Œ91 å°±æŠŠå…©å€‹ä»–æ‰€æ„›çš„èˆˆè¶£çµåˆèµ·ä¾†ï¼Œåœ¨å¸‚å ´ä¸Šå°±åªèƒ½æ‰¾ä»– 3. Career å¤©èŠ±æ¿ \u0026gt; è–ªè³‡ï¼šé¸æ“‡ Yahoo è–ªè³‡å¾ˆä½ï¼Œä½†æ˜¯å¸¶ä¾†å¾ˆå¤§çš„æˆé•·ï¼ŒæŠŠé€™äº›æˆé•·çŒåœ¨ä¸‹ä¸€ä»½å·¥ä½œä¸Š ç”¨æˆæœæè¿°è‡ªæˆ‘ï¼Œè€Œä¸æ˜¯é¡¯æ“ºçš„ Titleï¼šæŒçºŒåœ¨ Job / Work è¼¸å‡ºï¼Œç”¨æˆæœèªªæœäººï¼Œå¾ŒçºŒ 91 å·¥ä½œéƒ½æ˜¯é‚€ç´„ï¼Œè€Œä¸ç”¨è‡ªå·±æŠ• 4. Values åˆå¿ƒï¼šæ“‡å…¶æ‰€æ„› äººè„ˆï¼šä½ å¯ä»¥å¹«åŠ©åˆ°å¤šå°‘äººï¼Ÿ æ˜¯å¦æœ‰èƒ½åŠ›å¹«åŠ©å…¶ä»–äººï¼Ÿ æ˜¯å¦æœ‰è¾¦æ³•çŸ¥é“å…¶ä»–äººç¾åœ¨æœ‰éœ€è¦å¹«å¿™ï¼Ÿ ç‚ºä»€éº¼ä»–äººè¦é¸æ“‡ä½ å¹«å¿™ï¼Ÿ\næ‰¾åˆ°è‡ªå·±åƒ¹å€¼çš„åŸºåº• è‡ªç”±ï¼šé¸æ“‡çš„è‡ªç”± / ä¸éœ€è¦æ“”å¿ƒåˆ¥äººç«¶çˆ­èˆ‡å£“è¿« / å¥åº· ç¸½çµ æˆ‘è‡ªå·±æŠŠè¬›åº§æ‹†æˆå…©éƒ¨åˆ†ï¼Œä¸€å€‹æ˜¯æŠ€è¡“è€…çš„è·æ¶¯ç™¼å±• / ä¸€å€‹æ˜¯æŠ€è¡“è€…çš„æŠ€èƒ½è®Šç¾ï¼Œè‡ªå·±ç›®å‰å°ˆæ³¨æ–¼å‰è€…ï¼Œç¸½çµè‡ªå·±çš„å¿ƒå¾—\næ™‚é–“æœ€è²´ï¼Œä¸æ–·çš„æƒ³å¦‚ä½•ç¯€çœè‡ªå·±çš„æ™‚é–“ / åœ˜éšŠçš„æ™‚é–“ / è€é—†çš„æ™‚é–“ å¾å¸‚å ´éœ€æ±‚èˆ‡å•†æ¥­åƒ¹å€¼çš„è§’åº¦å»æ€è€ƒè‡ªæˆ‘è·æ¶¯ç™¼å±• å˜—è©¦æŠŠè‡ªå·±æ‰€ç†±æ„›çš„äº‹ç‰©è®Šç¾ï¼Œæƒ³æƒ³çœ‹å¦‚ä½•ç™¼æ®ç¶œæ•ˆ ","date":"2021-02-06T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-02-06-%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9C%8B%E5%95%86%E6%A5%AD%E6%8A%80%E8%A1%93%E5%B7%A5%E4%BD%9C%E8%80%85%E7%9A%84%E5%95%86%E6%A5%AD%E6%80%9D%E7%B6%AD%E8%AC%9B%E5%BA%A7%E5%88%86%E4%BA%AB/","title":"ã€å·¥ç¨‹å¸«çœ‹å•†æ¥­ã€‘æŠ€è¡“å·¥ä½œè€…çš„å•†æ¥­æ€ç¶­è¬›åº§åˆ†äº«"},{"content":"\nClean Code ç›¸ä¿¡å¾ˆå¤šäººéƒ½çœ‹éï¼Œæä¾›è»Ÿé«”ç•Œä¸€å€‹è‡ªæˆ‘å¯©æ€ç¨‹å¼ç¢¼å“è³ªçš„æ¨™ç«¿ï¼Œä¹Ÿè¢«è¨±å¤šå·¥ç¨‹å¸«å¥‰ç‚ºåœ­è‡¬ï¼Œé€™ä¸€æœ¬ Clean Coder æ›´å¤šè‘—é‡æ–¼èº«ç‚ºä¸€åå°ˆæ¥­äººå£«æ‰€éœ€å…·å‚™çš„å…§æ¶µï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ç¨‹å¼ç¢¼\nHighlight å…©é»æˆ‘è¦ºå¾—è¢«é‡é‡æé†’çš„åœ°æ–¹ï¼Œä¸¦æå‡ºä¸€äº›è‡ªå·±çš„æƒ³æ³•\nèªªã€Œä¸ã€èˆ‡èªªã€Œæ˜¯ã€ èº«ç‚ºå·¥ç¨‹å¸«ï¼Œéƒ½é‡é PM è‡¨æ™‚ä¾†çš„éœ€æ±‚ï¼Œä¸¦å¼·ç¡¬çš„è¦å£“ä¸€å€‹ä¸å¤ªåˆç†çš„æ—¥æœŸï¼Œåœ¨é€™ç¨®å£“åŠ›ä¸‹ï¼Œä¸è«–æ˜¯å‡ºæ–¼å–„æ„æˆ–æ˜¯æ‡¶å¾—çˆ­è¾¯ï¼Œæ˜¯å¦éƒ½æ›¾èªªéã€Œå¥½çš„æˆ‘è©¦è©¦ã€\nå°æ–¼ç­”æ‡‰æ¥ä¸‹å·¥ä½œçš„å·¥ç¨‹å¸«è€Œè¨€ï¼Œã€Œè©¦è©¦ã€å°±æ˜¯ä»£è¡¨æœ‰å¯èƒ½åšåˆ°ï¼Œä½†æ˜¯ PM æœƒè§£è®€æˆã€Œå¥½çš„æ²’å•é¡Œã€\nç­‰åˆ°ä¸Šç·šæ—¥ä¾†è‡¨é–‹å¤©çª—ï¼Œèº«ç‚º PM è¦ºå¾—è¢«å·¥ç¨‹å¸«è€äº†ï¼Œè€Œå·¥ç¨‹å¸«ä¹Ÿå¾ˆç„¡è¾œçš„è¡¨ç¤ºã€Œå°±èªªè©¦è©¦è€Œå·²ã€ï¼Œé–‹å§‹è¸¢èµ·çš®çƒï¼Œé€™å°é›™æ–¹éƒ½æ˜¯å¾ˆä¸å°ˆæ¥­çš„è¡¨ç¾\nç•¶æˆ‘å€‘è¦çµ¦äºˆæ‰¿è«¾æ™‚ï¼Œè«‹éå¸¸å°å¿ƒæˆ‘å€‘çš„æªè¾­ï¼Œå¦‚æœå› ç‚ºå£“åŠ›å°±æ”¹å£èªªã€Œæˆ‘è©¦è©¦çœ‹ã€ï¼Œé‚£æ˜¯å¦ä»£è¡¨è‘—éå»çš„ä½ éƒ½åœ¨å·æ‡¶ï¼Œåœ¨å£“åŠ›ç›¸é€¼çš„æƒ…æ³ä¸‹åè€Œå¢åŠ å·¥ä½œç”¢èƒ½ï¼Ÿ\nå¦‚æœé‚„æ˜¯ç…§æ—¢å®šçš„æ–¹å¼åšï¼Œé‚£æ‰€è¬‚çš„ã€Œå˜—è©¦ã€åˆæ˜¯åœ¨å˜—è©¦ä»€éº¼å‘¢ï¼Ÿ\né€™è½èµ·ä¾†å¾ˆç†æƒ³åŒ–ï¼Œæˆ–è¨±æœƒå—¤ä¹‹ä»¥é¼»ï¼Œä½†åŠæ—©èªªä¸ï¼Œä¸¦å …å®ˆåº•ç·šï¼Œä¸è¦å› ç‚ºå£“åŠ›å°±æ”¾æ£„æ¸¬è©¦ï¼Œä¸è¦å› ç‚ºå£“åŠ›å°±æƒ³å¯«å‡ºæœ‰è‡­å‘³çš„ç¨‹å¼ç¢¼ï¼Œèº«ç‚ºå°ˆæ¥­äººå£«æ‡‰è©²æœ‰å°è‡ªå·±å·¥ä½œå“è³ªçš„ä¿è­‰ï¼Œè€Œä¸æ˜¯ä¸€æ˜§çš„é™ä½æ¨™æº–\næˆ–è¨±æ›´å¥½çš„æ–¹å¼æ˜¯å°‡ä»»å‹™ç´°åˆ†ï¼Œåœ¨æ™‚é™å…§çµ¦å‡ºåˆç†çš„æˆæœï¼Œä¸¦è¦åŠƒæœªä¾†é€æ­¥å®Œæˆçš„æ™‚è¾°ï¼Œé‡åˆ°æ™‚è¾°å›°é›£æ‡‰å„˜æ—©åæ‡‰ï¼Œè€Œä¸æ˜¯æŠ±è‘—åƒ¥å€–çš„å¿ƒæ…‹ç¥ˆç¦±æˆ–æ˜¯å†·çœ¼çœ‹è‘—ä»»å‹™å¤±æ•—\nç•¶ç¢ºå®šè¦æ¥ä¸‹ä»»å‹™æ™‚ï¼Œè«‹ç¢ºä¿å†çµ¦äºˆã€Œæ˜¯ã€çš„æ‰¿è«¾æ™‚åŒ…å«ä¸‰å€‹æ­¥é©Ÿ\nå£é ­ä¸Šèªªè‡ªå·±æœƒå»åš å¿ƒè£¡èªçœŸå°å¾…è‡ªå·±æ‰€åšå‡ºçš„æ‰¿è«¾ çœŸçš„ä»˜è«¸è¡Œå‹• å¦‚æœç™¼ç¾æœ‰é€™äº›å¾µå…†ï¼Œé‚£å¤šåŠæ‰¿è«¾éƒ½æœƒè½ç©º\néœ€è¦ / æ‡‰ç•¶ - æˆ‘å€‘éœ€è¦æœ‰äººå®Œæˆé€™é …äº‹æƒ… å¸Œæœ› / ä½†é¡˜ - ä½†é¡˜æˆ‘æœ‰æ™‚é–“å¹«ä½ è™•ç† è®“æˆ‘å€‘ (è€Œä¸æ˜¯ã€Œè®“æˆ‘ã€) - è®“æˆ‘å€‘ä¸€èµ·åšé€™é …ä»»å‹™ çœŸæ­£çš„æ‰¿è«¾ï¼Œæ‡‰ç•¶æ˜¯æ˜ç¢ºæŒ‡å‡ºè‡ªå·±å°‡è² è²¬é€™ä»¶äº‹æƒ…ï¼Œä¸¦çµ¦äºˆæ˜ç¢ºçš„æ™‚è¾°èˆ‡äº¤ä»˜å…§å®¹\né€™é»çœŸçš„å¾ˆæœ‰æ„Ÿï¼Œå°¤å…¶æ˜¯åšå¾Œç«¯ï¼Œæ™‚å¸¸è¦å”åŠ©å…¶ä»–åœ˜éšŠèª¿æŸ¥ API å‘¼å«ç´€éŒ„ / ä¼ºæœå™¨é‹ä½œç‹€æ³ / DB è³‡æ–™æŸ¥è©¢ç­‰ç‘£äº‹ï¼Œå¸¸å¸¸æœƒèªªã€Œå¥½çš„ï¼Œæˆ‘ç­‰ç­‰å¹«ä½ æŸ¥ã€ï¼Œä¸€æ–¹é¢æ­£äº‹ä¸€ç›´è¢«æ‰“æ–·æ•ˆç‡å·®ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå®¹æ˜“å¿˜è¨˜ç­”æ‡‰éçš„äº‹æƒ…ï¼Œå°è‡´æ•´å¤©å·¥ä½œå¾ˆå¿™å»ä¹Ÿæ²’æœ‰ä»€éº¼ç”¢å‡º\nå¾Œä¾†æˆ‘åšäº†ä¸€äº›èª¿æ•´\nä¸Šç­ä¸€é–‹å§‹å°±ç”¨ç­†è¨˜æœ¬å¯«ä¸‹ä»Šå¤©è¦å®Œæˆçš„ä»»å‹™ é–‹ç™¼é€”ä¸­æœ‰äººæ•² slack éœ€è¦å”åŠ©ï¼Œé™¤éäº‹æ…‹ç·Šæ€¥ï¼Œå¦å‰‡ç­‰ä»»å‹™åšåˆ°ä¸€å€‹éšæ®µå†å›è¦† æ¯å¤©åªæ¥å›ºå®šçš„ç‘£äº‹æ•¸é‡ï¼Œå…¶é¤˜çš„çµ¦äºˆæ˜ç¢ºæ™‚é–“å›è¦†(å¦‚éš”å¤©) ç›¡å¯èƒ½ç¢ºä¿è‡ªå·±çš„ä»»å‹™æº–æ™‚ä¸”æœ‰å“è³ªäº¤ä»˜ï¼Œä¹‹é¤˜ä¹Ÿå”åŠ©å…¶ä»–åœ˜éšŠæˆå“¡çš„èª¿æŸ¥ï¼Œè®“è‡ªå·±çµ¦äºˆçš„æ‰¿è«¾æ˜¯æ­£é¢çš„\né ä¼° é ä¼°å·¥æ™‚æ˜¯ä¸€å€‹è »å¾®å¦™çš„è—è¡“ï¼ŒPM æœƒæ‹¿ä¸€å€‹ä¸æ˜¯å®Œå…¨æ˜ç¢ºçš„éœ€æ±‚ä¾†è©¢å•ä¸€å€‹é ä¼°çš„å·¥æ™‚ï¼Œé ä¼°ä¸æ˜¯æ‰¿è«¾ï¼Œå¸¶æœ‰è‘—ä¸€é»æ¨¡ç³Šçš„ç©ºé–“ï¼Œã€Œå¯èƒ½ä¸‰å¤©ï¼Ÿå¦‚æœæœ‰ç·Šæ€¥äº‹ä»¶å¯èƒ½è¦äº”å¤©ï¼Ÿã€æœªä¾†æœ‰è‘—å¤ªå¤šçš„ä¸ç¢ºå®šæ€§ï¼Œä½†æ˜¯é ä¼°èˆ‡è³‡æºå®‰æ’æ¯æ¯ç›¸é—œï¼Œä¸èƒ½å› ç‚ºé ä¼°ä¸æº–è€Œè®“ PM é›£ä»¥å®‰æ’é€²åº¦ï¼Œè€Œå¾€å¾€å·¥ç¨‹å¸«æœ‰éåº¦æ¨‚è§€çš„ç‹€æ³ (ç¬‘\nPERT (Program Evaluation and Review Technique) ç¾è»åœ¨ 1957 å¹´ç™¼å±•æ½›è‰‡æ¥µåœ°èˆªè¡Œè¨ˆç•«æ™‚æ‰€è¨­è¨ˆçš„é ä¼°å·¥æ™‚æ–¹æ³•ï¼Œæ¡ç”¨ä¸‰å€‹æ•¸å€¼\nO ç•°å¸¸æ¨‚è§€ï¼šæ‰€æœ‰äº‹æƒ…éƒ½å¾ˆé †åˆ©çš„æƒ…æ³ä¸‹çš„å·¥æ™‚ï¼Œæ©Ÿç‡æ‡‰å°æ–¼ 1% N å¸¸è¦é ä¼°ï¼šæ©Ÿç‡ç™¼ç”Ÿæœ€é«˜çš„é ä¼°å·¥æ™‚ P ç•°å¸¸æ‚²è§€ï¼šè€ƒé‡å„ç¨®ç½å®³å¦‚åœ°éœ‡ç­‰ï¼Œçµ¦äºˆæœ€æ‚²è§€çš„å·¥æ™‚é ä¼°ï¼Œæ©Ÿç‡æ‡‰å°æ–¼ 1% å¾—å‡ºä¸Šé¢ä¸‰å€‹æ•¸å€¼å¾Œï¼Œå¯ä»¥ç”¨æ©Ÿç‡åˆ†æè¡¨ç¤º\né ä¼°å®Œæˆå·¥æ™‚: u = (O+4N+P) / 6 æ¨™æº–å·®ï¼Œç”¨ä¾†è¡¡é‡ä¸ç¢ºå®šæ€§ï¼š(P-O) / 6 å¾·çˆ¾è²æ³• å‰›æ‰çš„ PERT æ˜¯ä¸€å€‹äººé ä¼°çš„å·¥æ™‚ï¼Œä½†æ˜¯æ›ä¸€å€‹äººå¯èƒ½æœƒçµ¦å‡ºä¸åŒçš„é ä¼°çµæœï¼Œä»°è³´åœ˜éšŠæˆå“¡çµ¦å‡ºä¸åŒçš„é ä¼°ï¼Œæœ€å¾Œé”æˆå…±è­˜ä¹Ÿæ˜¯ä¸€ç¨®æ–¹æ³•\nä¸»æŒäººè«‹æ¯å€‹æˆå“¡åœ¨ä»–äººä¸çŸ¥é“çš„ç‹€æ³ä¸‹æ±ºå®šé ä¼°å·¥æ™‚ï¼Œæ™‚é–“åˆ°ä¸€èµ·äº®ç‰Œ(æ•¸æ‰‹æŒ‡ä¹‹é¡çš„)ï¼Œçœ‹å¤§å®¶æ˜¯å¦æœ‰å…±è­˜ï¼Œå¦‚æœæœ‰äººæœ‰å¾ˆå¤§çš„æ­§ç•°ï¼Œå‰‡é–‹å§‹è¨è«–åˆ†æ­§çš„ä¾æ“šï¼Œæ¥è‘—ä¸‹ä¸€è¼ªï¼Œç›´åˆ°å¤§å®¶çµ¦äºˆçš„è©•ä¼°éƒ½å·®ä¸å¤šæ‰çµæŸ\nå‡èšå…±è­˜ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€ç’°ï¼Œå°¤å…¶æ˜¯åœ˜éšŠåˆä½œä¸Šï¼Œå¾æ¯ä¸€å€‹äººè©•ä¼°å·¥æ™‚çš„ä¸åŒï¼Œå°±èƒ½å»çœ‹å‡ºå°æ–¼ç´°ç¯€èˆ‡å¯¦ä½œæƒ³æ³•ä¸Šçš„å·®ç•°ï¼Œå½Œå¹³é€™é¡çš„å·®ç•°å¯ä»¥è®“åœ˜éšŠåˆä½œæ›´é †æš¢\nå¤§æ•¸å®šå¾‹ å°‡å¤§ä»»å‹™æ‹†è§£æˆå°ä»»å‹™å¾Œåœ¨ä¼°æ™‚æœƒæ¯”è¼ƒç²¾æº–ï¼Œä¸”ç¶“éæ‹†è§£å¯ä»¥æ›´ç†è§£ä»»å‹™çš„å„ç¨®é¢å‘\nçµèª æ›¸ä¸­é‚„æœ‰è«‡å…¶ä»–é¢å‘å¦‚æ¸¬è©¦ / ç·´ç¿’ / å”ä½œç­‰ï¼Œç®—è »æœ‰è¶£çš„ä¸€æœ¬æ›¸ï¼Œæ˜ç¢ºæŒ‡å‡ºå°ˆæ¥­äººå£«çš„å€åˆ¥ï¼Œå…¶ä¸­èˆ‰çš„æ¡ˆä¾‹ä¹Ÿæ˜¯æ­·æ­·åœ¨ç›®ï¼Œå€¼å¾—åœ¨è·æ¶¯ä¸­æ™‚æ™‚å“å‘³\n","date":"2021-01-26T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-01-26-clean-coder-%E7%84%A1%E7%91%95%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC%E5%BF%83%E5%BE%97/","title":"ã€ŠClean Coder ç„¡ç‘•çš„ç¨‹å¼ç¢¼ã€‹å¿ƒå¾—"},{"content":"è¦æ‰“é€ ä¸€å€‹ã€Œå¯ä»¥å‹•çš„ Docker Imageã€å¾ˆç°¡å–®ï¼Œåƒè€ƒ Node.js å®˜æ–¹æ–‡ä»¶ Dockerizing a Node.js web app å°±å¯ä»¥ç”¢å‡ºä¸€å€‹å°‡è¿‘ 1GB çš„ Docker Image\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 FROM node:14 # Create app directory WORKDIR /usr/src/app # Install app dependencies # A wildcard is used to ensure both package.json AND package-lock.json are copied # where available (npm@5+) COPY package*.json ./ RUN npm install # If you are building your code for production # RUN npm ci --only=production # Bundle app source COPY . . EXPOSE 8080 CMD [ \u0026#34;node\u0026#34;, \u0026#34;server.js\u0026#34; ] å°±é–‹å§‹æƒ³\né€™æ¨£å®‰å…¨å—ï¼Ÿ å¯ä»¥æ‰“é€ æ›´è¼•é‡ã€æ›´å¥½ ship çš„ Image å—ï¼Ÿ å¾Œä¾†æ‰¾åˆ°é€™ä¸€ç¯‡æ–‡ç« 10 best practices to containerize Node.js web applications with Dockerè¦ºå¾—ååˆ†å¯¦ç”¨ï¼Œä¹Ÿè§£æ±ºå®‰å…¨æ€§ä¸Šçš„ç–‘æ…®ï¼Œä»¥ä¸‹æ‘˜è¦é‡é»\n1. é¸æ“‡æ­£ç¢ºçš„ Base Image ä¸¦é€é Build Stage ç²¾ç°¡ç”¢å‡º tldr;\næ¡ç”¨ alpine æˆ– -slim ç‰ˆæœ¬çš„ base image ç”¨ sha256 æŒ‡å®š base image ç‰ˆæœ¬é¿å…ç•°å‹• æ”¯æ´å¤šéšæ®µï¼Œå¯ä»¥å‰æœŸ build ç”¨æ¯”è¼ƒå¤§çš„ base imageï¼Œæœ€å¾Œç”¢å‡ºåœ¨ä½¿ç”¨ç²¾ç°¡çš„ base image 1 2 3 4 5 6 7 FROM node:latest AS build .... # --------------\u0026gt; The production image FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a .... COPY --from=build /usr/src/app/node_modules /usr/src/app/node_modules .... é€²å…¥ docker hub node.js å®˜æ–¹ imageï¼Œå¯ä»¥çœ‹åˆ°ç²ç…æ»¿ç›®çš„ç‰ˆæœ¬ï¼Œé™¤äº†å°æ‡‰ä¸åŒçš„ node.js ç‰ˆæœ¬ï¼Œåº•å±¤çš„ os å¯ä»¥åˆ†æˆå¹¾ç¨®\nstretch: åŸºæ–¼ debian 9 bulter: åŸºæ–¼ debian 10 alpine: åŸºæ–¼ alpine linux å¦ç™½èªªç›®å‰é‚„ä¸å¤ªç†è§£ debian 9 / 10 çœŸæ­£çš„å·®ç•°ï¼Œè€Œ alpine linux ç›®æ¨™æ˜¯æ‰“é€ æœ€è¼•é‡çš„ container osï¼Œæœ€å¤§å·®ç•°åœ¨æ¡ç”¨ musl libc å–ä»£ glibcï¼Œå¦‚æœä½¿ç”¨çš„ js å¥—ä»¶æœ‰åˆ©ç”¨åˆ° libc å¯èƒ½æœƒæœ‰å•é¡Œ\nè€Œå¸¶æœ‰ -slim çµå°¾å‰‡æ˜¯ä»£è¡¨è©² image æ˜¯æœ€è¼•é‡å¯é‹è¡Œ Node.js çš„ container osï¼Œä¹Ÿæ˜¯å®˜æ–¹å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒæ¡ç”¨\nä¾‹å¦‚èªª node:14.15.4-stretch å°ºå¯¸ 942MB vs node:14.15.4-stretch-slim å°ºå¯¸ 167MBï¼Œå‰è€…é€£ build å·¥å…·éƒ½æœ‰åŒ…å«å¦‚ python / node-gyp ç­‰ï¼Œé€™å°è‡´å°ºå¯¸å·®ç•°éå¸¸å·¨å¤§\nå®‰è£è¶Šå¤šå·¥å…·çš„ Imageï¼Œå°è‡´çš„æ½›è—æ€§å®‰å…¨æ¼æ´å°±è¶Šå¤šï¼Œæ‰€ä»¥æ­£å¼ç’°å¢ƒé‹è¡Œç›¡é‡æ¡ç”¨ slim ç‰ˆæœ¬\næ‰€ä»¥æœ€æ£’çš„æ˜¯åœ¨ç¬¬ä¸€éšæ®µæ¡ç”¨å®Œæ•´ Image æ–¹ä¾¿ build node_modulesï¼Œæœ€å¾Œéšæ®µç”¢å‡ºç”¨ç²¾ç°¡ Image ç¢ºä¿é‹è¡Œæ™‚æ²’æœ‰å¤šé¤˜çš„å·¥å…·\n2. ç¢ºä¿åªå®‰è£ production éœ€è¦çš„ node modules ä¸¦æŒ‡å®š NODE_ENV ç‚º production é€é RUN npm ci --only=production åªå®‰è£ dependencies è€Œæ²’æœ‰ dev_dependencies é–‹ç™¼ç”¨çš„å¥—ä»¶\nnpm ci èˆ‡ npm install çœ‹ä¼¼éƒ½åœ¨å®‰è£å¥—ä»¶ä½†æœ‰å¾ˆå¤§çš„å·®ç•°ï¼›\nnpm ci åªè®€å– lock fileï¼Œä¸¦ç”¨ package.json åšæ¯”å°ï¼Œå¦‚æœ lock file èˆ‡ package.json ç‰ˆæœ¬ä¸åˆæœƒå™´å‡ºéŒ¯èª¤ï¼Œæœ€é©åˆç”¨åœ¨è¦ç©©å®šä¸”å¼·ä¸€è‡´çš„å¥—ä»¶ç‰ˆæœ¬è¦æ±‚\nnpm install å‰‡æ˜¯è®€å– package.jsonï¼Œä¸¦é€é lock file åšå®‰è£çš„ç‰ˆæœ¬æŒ‡å®šï¼Œå¦‚æœæœ‰å¥—ä»¶æ²’æœ‰å‡ºç¾åœ¨ lock file ä¸­ï¼Œå‰‡ npm ç›´æ¥å®‰è£\né‹è¡Œç’°å¢ƒï¼Œæ ¹æ“š Node.js çš„ä¸æˆæ–‡è¦å®šï¼Œè«‹æŒ‡å®šNODE_ENV=productionï¼Œå„å€‹å¥—ä»¶éƒ½æœƒé‡å° production é€²è¡Œå„ªåŒ–ï¼Œå¦å¦‚æ–‡ä¸­èˆ‰ä¾‹ express.js æœƒåœ¨ç”Ÿç”¢ç’°å¢ƒåŠ å…¥é é¢ cache æ©Ÿåˆ¶\n3. ä¸è¦ç”¨ root é‹è¡Œ container!! è¨˜å¾—åŠ å…¥ USER node åˆ‡æ›ä½¿ç”¨è€…ï¼Œä¸¦è¨˜å¾— COPY æ™‚è¦çµ¦äºˆä½¿ç”¨è€…ç›¸å°æ¬Šé™ COPY --chown=node:node . /usr/src/app\né€™å¾ˆé‡è¦ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¿˜è¨˜ï¼Œçµ¦äºˆç”¨æˆ¶ä¸å¤šä¸å°‘çš„æ¬Šé™ä¸€ç›´æ˜¯å®‰å…¨æ€§çš„åŸºæœ¬æº–å‰‡ï¼Œé è¨­ docker container å…§æ˜¯ä»¥ root é‹è¡Œ processï¼Œä½†å¦‚æœä¸å°å¿ƒæ‡‰ç”¨ç¨‹å¼æœ‰æ¼æ´ï¼Œç”šè‡³æœ‰å¯èƒ½è®“é§­å®¢è·³è„« container context ç²å¾— host root æ¬Šé™\n4. æ­£ç¢ºæ¥æ”¶ç¨‹åºä¸­æ–·äº‹ä»¶èˆ‡å„ªé›…åœ°é€€å‡º æ¡ç”¨ dump-init ç›´æ¥å•Ÿå‹• Node.js process\n1 2 RUN apk add dumb-init CMD [\u0026#34;dumb-init\u0026#34;, \u0026#34;node\u0026#34;, \u0026#34;server.js\u0026#34;] ä¸¦è¨˜å¾—åœ¨ Node.js ä¸­åµæ¸¬äº‹ä»¶\n1 2 process.on(\u0026#39;SIGINT\u0026#39;, closeGracefully) process.on(\u0026#39;SIGTERM\u0026#39;, closeGracefully) ä¼ºæœå™¨é•·æ™‚é–“é‹è¡Œæ™‚ï¼Œç¸½æœƒé‡åˆ°ç‰ˆæœ¬æ›´æ–°çš„æ™‚å€™ï¼Œæœ€ç†æƒ³çš„åšæ³•æ˜¯è®“ä¸­æ–·æµé‡ä¸¦è®“ç¨‹åºå®Œæˆå‰©é¤˜å·¥ä½œå¾Œå„ªé›…é€€å‡ºï¼Œä½†å¦‚æœæ¡ç”¨çš„æ–¹å¼éŒ¯èª¤ Docker Container æœƒç„¡æ³•æ”¶åˆ°ç³»çµ±ä¸­æ–·çš„äº‹ä»¶ SIGKILL ã€SIGTERM ç­‰\nä»¥ä¸‹æ˜¯å¹¾ç¨®å¸¸è¦‹çš„ Container åŸ·è¡ŒæŒ‡ä»¤ï¼Œä½†åˆ†åˆ¥æœ‰ä¸€äº›å•é¡Œ\n1. CMD \u0026ldquo;npm\u0026rdquo; \u0026ldquo;start\u0026rdquo; é€™æœƒé‡åˆ°å…©å€‹å•é¡Œ\né€é npm å•Ÿå‹• Node.js processï¼Œä½†æ˜¯ npm ä¸æœƒæ­£ç¢º pass æ‰€æœ‰çš„ç³»çµ±ä¸­æ–·åˆ° Node.js process ä¸Š CMD \u0026quot;cmd\u0026quot; \u0026quot;params\u0026quot; .. èˆ‡ CMD [\u0026quot;cmd\u0026quot;, \u0026quot;params\u0026quot;] æ˜¯ä¸åŒçš„ï¼Œå‰è€…æ˜¯å…ˆå•Ÿå‹• shell å†å»åŸ·è¡Œå¾Œé¢çš„ cmdï¼›è€Œå¾Œè€…å‰‡æ˜¯ç›´æ¥åŸ·è¡Œ cmdï¼Œæœ€ç›´æ¥çš„å·®ç•°å°±æ˜¯ PID 1 æ˜¯ shell é‚„æ˜¯ cmdï¼Œé€é shell åŒæ¨£æœ‰å¯èƒ½ä¸æœƒæ”¶åˆ°å…¨éƒ¨çš„ç³»çµ±ä¸­æ–· 2. CMD [\u0026ldquo;node\u0026rdquo;, \u0026ldquo;index.js\u0026rdquo;] å„ªåŒ–ä¸Šé¢çš„æŒ‡ä»¤ï¼Œæ”¹ç”±ç›´æ¥å•Ÿå‹• node.js å°‘äº† npm èˆ‡ shellï¼Œé€™æœƒé‡åˆ°å¦ä¸€å€‹å•é¡Œ linux å°æ–¼ PID 1 çš„ç¨‹åºæœ‰ç‰¹åˆ¥çš„è™•ç†ï¼Œå› ç‚º PID 1 ä»£è¡¨æ­¤ç¨‹åºè¦è² è²¬ç³»çµ±çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥ Kernel æœƒæœ‰é¡å¤–çš„è™•ç†æ©Ÿåˆ¶ï¼Œå¯¦éš›çš„å½±éŸ¿æœ‰\nä¸€èˆ¬çš„ç¨‹åºæ”¶åˆ° SIGTERM å¾Œ Kernel æœƒæœ‰é è¨­çš„çµæŸè™•ç†ï¼Œä½†æ˜¯ PID 1 æ²’æœ‰é è¨­çµ‚æ­¢è™•ç†ï¼Œä¹Ÿå°±æ˜¯æ”¶åˆ°å¾Œæ²’æœ‰ä¸»å‹•é€€å‡ºå°±ä¸æœƒé€€å‡º å¦‚æœæœ‰ orphan process æœƒè¢«ä¸»å‹•æ›è¼‰åˆ° PID 1 ä¹‹ä¸‹ï¼Œä½†ä¸€èˆ¬çš„ process ä¸æœƒå»è™•ç† orphan processï¼Œæœƒç•™ä¸‹å¾ˆå¤š zombie process æ ¹æ“š Node.js Docker å°çµ„å»ºè­°ï¼Œä¸è¦è®“ Node.js é‹è¡Œåœ¨ PID 1 ä¸Š\nNode.js was not designed to run as PID 1 which leads to unexpected behaviour when running inside of Docker. For example, a Node.js process running as PID 1 will not respond to SIGINT (CTRL-C) and similar signals\næœ€çµ‚è§£æ³•ï¼šé€é init process å†å»å•Ÿå‹• Node.js æœ€å¾Œç”¨ dumb-initï¼Œé€™å¥—ç”± yelp é‡‹å‡ºçš„å•Ÿå‹• processï¼Œæœƒæ­£ç¢ºå°‡æ‰€æœ‰çš„ç³»çµ±ä¸­æ–·éƒ½ pass çµ¦æ‰€æœ‰çš„ child processï¼Œä¸¦ä¸”åœ¨é€€å‡ºæ™‚æ¸…é™¤æ‰€æœ‰çš„ orphan process\nIntroducing dumb-init, an init system for Docker containers\nå¸‚é¢ä¸Šé‚„æœ‰ä¸åŒçš„é¸æ“‡ï¼Œå¯ä»¥åƒè€ƒæ­¤ç¯‡ Choosing an init process for multi-process containers\n5. æ­£ç¢ºè™•ç† Build éšæ®µä½¿ç”¨çš„æ©Ÿæ•è³‡æ–™ å–„ç”¨ multi stageï¼Œè®“æ©Ÿæ•è³‡æ–™ä¸è¦å¤–æ´©åœ¨ Image ç•¶ä¸­ï¼Œä¸¦ä½¿ç”¨ mount secret åŒæ­¥æ©Ÿæ•è³‡æ–™\n1 RUN --mount=type=secret,id=npmrc,target=/usr/src/app/.npmrc npm ci --only=production å¦‚æœæœ‰ä¸€äº›æ©Ÿæ•è³‡æ–™æ˜¯åœ¨ Building éšæ®µæ‰€éœ€è¦ï¼Œä¾‹å¦‚è¦å» private github æ‹‰ repo çš„ .npmrc ç­‰è³‡æ–™ï¼Œéœ€è¦è¢«å¦¥å–„è™•ç†ï¼Œå¸¸è¦‹çš„éŒ¯èª¤ç¤ºç¯„æœ‰\nhard code å¯«æ­» æ¡ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œåœ¨ docker build æ™‚æŒ‡å®šï¼Œä½†å¦‚æœç”¨ docker history é‚„æ˜¯æœƒè¢«ç™¼ç¾ å¥‡æ€ªçš„æ˜¯æˆ‘ä¸¦æ²’æœ‰åœ¨ Docker æ–‡ä»¶ Use bind mounts çœ‹åˆ° \u0026ndash;mount type=secret çš„èªªæ˜ï¼Œä½†ç¢ºå¯¦æœ‰åœ¨å®˜æ–¹æ•™å­¸çœ‹åˆ° Build images with BuildKit\nçµèª æœ€çµ‚çš„ç”¢å‡ºæœƒé•·é€™æ¨£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # --------------\u0026gt; The build image FROM node:latest AS build WORKDIR /usr/src/app COPY package-*.json /usr/src/app/ RUN --mount=type=secret,id=npmrc,target=/usr/src/app/.npmrc npm ci --only=production # --------------\u0026gt; The production image FROM node:lts-alpine RUN apk add dumb-init ENV NODE_ENV production USER node WORKDIR /usr/src/app COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules COPY --chown=node:node . /usr/src/app CMD [\u0026#34;dumb-init\u0026#34;, \u0026#34;node\u0026#34;, \u0026#34;server.js\u0026#34;] ","date":"2021-01-21T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-01-21-%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E5%AE%89%E5%85%A8%E7%9A%84-production-ready-node.js-docker-image/","title":"å¦‚ä½•æ‰“é€ å®‰å…¨çš„ production ready Node.js Docker Image"},{"content":" æ­¤ç¯‡ç‚ºåƒåŠ å•†æ¥­æ€ç¶­å­¸é™¢ 2021 è¬›åº§ã€Šé‡åŒ–è¡ŒéŠ·ã€‹æ„Ÿæƒ³èˆ‡åæ€ï¼Œè¬›è€…æ˜¯ä¾†è‡ª KKday ç‡ŸéŠ·é•· Yukiï¼Œåˆ†äº«åœ¨å…¬å¸ç¶“ç‡Ÿæµé‡èˆ‡å•†æ¥­é–‹ç™¼çš„å¿ƒå¾—\né‡åŒ–è¡ŒéŠ·çš„è¿·æ€ åœ¨å‚³çµ±è§€å¿µä¸­ï¼Œæœƒç›´è¦ºèªç‚ºæµé‡æœƒå¸¶ä¾†ç‡Ÿæ”¶ï¼Œç”šè‡³æŠŠæµé‡åˆ¶å®šç‚ºå…ˆè¡ŒæŒ‡æ¨™ï¼Œå»å¿½ç•¥äº†æµé‡çš„å“è³ªã€å¾ŒçºŒè³¼è²·è½‰æ›ã€ä¸åŒçš„å®¢æˆ¶çµ‚ç”Ÿåƒ¹å€¼ç­‰åˆ†æï¼Œå°è‡´çœ‹ä¼¼æ“æœ‰å¤§æµé‡ï¼Œç‡Ÿæ”¶å»ä¹Ÿä¸è¦‹èµ·è‰²ï¼Œä»¥ä¸‹ Yuki è€å¸«æ•´ç†äº†å¹¾ç¨®è¿·æ€\nå‰µé€ æµé‡å°±æœ‰æ›´å¤šçš„ç”Ÿæ„ï¼Ÿ ä¸åˆ†è¡ŒéŠ·é€šè·¯ä¾†æº å¸¸è¦‹çš„é›»å•†ç¶²ç«™æœƒèˆ‡æŠ˜æ‰£ç¶²åˆä½œï¼Œå¸¶ä¾†æ›´å¤šçš„æ›å…‰ï¼Œä½†æ˜¯é€™æ¨£çš„æ›å…‰è·Ÿæµé‡å€¼å¾—å—ï¼Ÿè©¦æƒ³ä¸€èˆ¬æ¶ˆè²»è€…è¡Œç‚ºï¼Œåˆ°ç¶²ç«™æ‰¾åˆ°å•†å“å¾Œï¼Œæœƒå†å»æŠ˜æ‰£ç¶²æœå°‹æŠ˜æ‰£ç¢¼ï¼Œé€™æ¨£ç­‰åŒæ–¼å¤šäº†ä¸€æ¬¡æµé‡ï¼Œä½†ä¸€æ¨£åªæˆäº¤ä¸€ç­†ï¼Œé‚„è³ ä¸Šäº†æ¯›åˆ©\næ‰€ä»¥åœ¨ç²å–æµé‡çš„åŒæ™‚ï¼Œæ‡‰è©²å»é—œæ³¨æµé‡æœ¬èº«çš„å“è³ª\nä¸åˆ†ç”¢å“èˆ‡æ´»å‹• Yuki è€å¸«èˆ‰è‡ªå®¶ç¶²ç«™çš„ç¯„ä¾‹ï¼Œä¹‹å‰äº”æœˆå¤©æ¼”å”±æœƒé–€ç¥¨ç§’æ®ºï¼Œè©±é¡Œæ­£åœ¨é¢¨å£ä¸Šï¼Œä»–å€‘ä¹Ÿè¦åŠƒäº†ã€Œäº”æœˆå¤©æ¼”å”±æœƒæ¥é§æœå‹™ã€çš„å•†å“ï¼ŒæˆåŠŸç²å¾—å·¨å¤§çš„æµé‡ï¼Œä½†æ˜¯æ²’æœ‰ä»€éº¼æˆäº¤é‡ï¼Œå› ç‚ºç”¨æˆ¶å¤šåŠæ˜¯æƒ³è¦è²·æ¼”å”±æœƒé–€ç¥¨ï¼Œå³ä½¿è¢«é¨™é€²ä¾†ä¹Ÿå¾ˆå¿«å°±èµ°äº†\næ‰€ä»¥è«‹å°ç·¨å¯«æ¡ˆè¹­æµé‡å¾ˆç°¡å–®ï¼Œä½†å…¶å¯¦éƒ½æ²’æœ‰å¯¦éš›å¹«åŠ©ï¼Œé‚„ä¸å¦‚é–‹ç™¼æœ‰ç”¨çš„å•†å“\nèˆ‰è¾¦è¡ŒéŠ·æ´»å‹•è®“èˆŠå®¢å›è³¼ï¼Œå°±èƒ½æ“æœ‰å…è²»æµé‡ é›»å•†ç¶²ç«™ç¶“ç‡Ÿå¸¸æœƒé€éæŠ˜æ‰£ç­‰èˆ‰è¾¦è¡ŒéŠ·æ´»å‹•ï¼Œå¸Œæœ›å–šé†’æ²ˆç¡çš„èˆŠå®¢å›è³¼ï¼Œä½†å¦‚æœæ²’æœ‰ä»”ç´°å»è€ƒé‡æˆæœ¬ï¼Œå…¶å¯¦å–šé†’èˆŠå®¢çš„æˆæœ¬å¾€å¾€æ¯”ç²å–æ–°å®¢æˆæœ¬ä¾†å¾—é«˜\nç²å®¢æˆæœ¬èˆ‡ç²æµé‡æˆæœ¬æ²’æœ‰æœƒå“¡åƒ¹å€¼åˆ†æ Yuki è€å¸«åœ¨åˆ†ææ•¸æ“šæ™‚ç™¼ç¾åˆ°ï¼Œç”¨æˆ¶çš„ç¬¬ä¸€ç­†è¨‚å–®å¦‚æœæ˜¯é«˜å–®åƒ¹ï¼Œé‚£ä»–å¾ŒçºŒçš„è¨‚å–®å¾€å¾€ä¹Ÿæ˜¯é«˜å–®åƒ¹ï¼Œçµ‚ç”Ÿæœƒå“¡åƒ¹å€¼æœƒæ˜¯ä¸€èˆ¬ç”¨æˆ¶çš„ 2 ~ 4 å€ä»¥ä¸Šï¼ é€™æ¨£çš„ç”¨æˆ¶å¾ˆæ˜é¡¯å°±å€¼å¾—æ›´é«˜çš„æˆæœ¬å»æ‹‰æ”\nå¦‚æœæ²’æœ‰ä»”ç´°åˆ†ææœƒå“¡åƒ¹å€¼ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰ç”¨æˆ¶éƒ½æ··ç‚ºä¸€è«‡ï¼Œç”šè‡³è¨‚è£½éŒ¯èª¤çš„ KPIï¼Œæœƒå°è‡´æµé‡åšå¾—å¾ˆè¾›è‹¦ä¹Ÿä¸è¦‹èµ·è‰²\nTakeaway ä»¥ç”¢å“ç·šå»¶ä¼¸å‰µé€ èˆŠå®¢æµé‡èˆ‡åˆ†ç¾¤å›è³¼ï¼Œè€Œä¸æ˜¯é æŠ˜æ‰£ï¼ KKday ä¹‹å‰æ›¾åšéæ­è™èˆªæ³¡æº«æ³‰çš„æ´»å‹•ï¼Œç´¯ç©äº†ä¸€æ‰¹èˆªç©ºè¿·ç”¨æˆ¶ï¼Œå¾Œä¾†æ¨å‡ºæ˜Ÿå®‡å¾®æ—…è¡Œï¼Œé€™äº›è€ç”¨æˆ¶å°±å¾ˆè²·å–® / å¦å¤–æœ‰ä¸€æ‰¹è¦ªå­ç”¨æˆ¶ï¼Œéå¾€å›ºå®šæœƒåœ¨å¯’æš‘å‡å‡ºåœ‹åº¦å‡ï¼Œä½†å› ç‚ºç–«æƒ…çš„é—œä¿‚æ ¹æœ¬ç„¡æ³•å‡ºåœ‹ï¼Œçµ¦äºˆå†å¤šçš„æŠ˜æ‰£æ²’ç”¨ï¼ŒKKday æ”¹ç‚ºèˆ‰è¾¦å¤ä»¤ç‡Ÿ/å†¬ä»¤ç‡Ÿï¼Œå°±å—åˆ°é€™ç¾¤è¦ªå­ç”¨æˆ¶çš„å–œæ„› è¦åšå‡ºç”¨æˆ¶å–œæ„›çš„ç”¢å“æ‰èƒ½å¤ é›™è´\nè¦è¿½æ±‚çš„ä¸æ˜¯æµé‡ï¼Œè€Œæ˜¯èƒ½å‰µé€ åƒ¹å€¼çš„æµé‡ï¼ å¦‚åŒå…ˆå‰çš„åˆ†äº«ï¼Œé«˜åƒ¹å€¼çš„ç”¨æˆ¶ç²å–æˆæœ¬é€šå¸¸æœƒæ¯”è¼ƒé«˜ï¼Œè€Œä¸”è½‰æ›ç‡ä¹Ÿæœƒæ¯”è¼ƒä½ï¼Œä½†æ›ç®—çµ‚ç”Ÿåƒ¹å€¼å¾Œé‚„æ˜¯é é«˜æ–¼ä¸€èˆ¬ç”¨æˆ¶ï¼Œåƒè¬ä¸è¦ç”¨éŒ¯èª¤çš„ KPI å°è‡´éŒ¯èª¤çš„çµæœ\nçœŸæ­£çš„æ©Ÿæœƒåœ¨è¡ŒéŠ·æ¼æ–—ä¹‹å¤– å‚³çµ±çš„è¡ŒéŠ·æ¼æ–—ï¼Œå­œå­œçŸ»çŸ»åœ¨å„ªåŒ–æ¯ä¸€å±¤çš„è½‰æ›ç•¶ä¸­ï¼Œä½† Yuki è€å¸«åˆ†äº«åˆ°å¾€å¾€æœ€å¤§çš„æ©Ÿæœƒéƒ½åœ¨é€™æ¼æ–—ä»¥å¤–ï¼Œä»¥ä¸‹æ˜¯å¹¾å€‹ KKday å˜—è©¦çš„æ–¹å‘\nIP åˆä½œ KKday æ›¾çˆ­å–åˆ°é˜¿å¦¹å°æ±è·¨å¹´æ¼”å”±æœƒçš„åˆä½œæ–¹æ¡ˆï¼Œæ­é…åŒ…æ©Ÿ / æ©Ÿå ´æ¥é§ç­‰æœå‹™ï¼Œçµ„åˆæˆæ›™å…‰è·¨å¹´è¡Œç¨‹ï¼Œæ—¢æ­ä¸Šç†±é–€è©±é¡Œä¹Ÿè¿åˆå®¢æˆ¶éœ€æ±‚ï¼Œæ‰€ä»¥ä¸€æ¨å‡ºå°±ç§’æ®ºï¼Œå¾ŒçºŒå®¢æˆ¶ä¹Ÿçµ¦äºˆå¥½è©•ï¼Œå¾ŒçºŒä¹Ÿæ•²é–‹èˆ‡å…¶ä»–æ˜æ˜Ÿçš„æ¼”å”±æœƒåˆä½œæ©Ÿæœƒ\nç›¸æ¯”æ–¼äº”æœˆå¤©æ¥é§è»Šçš„æ“¦é‚Šçƒï¼Œæå‡ºæœ‰è©±é¡Œåˆæœ‰çœŸæ­£éœ€æ±‚çš„å•†å“æ‰èƒ½é•·é•·ä¹…ä¹…\nåœ¨èˆ‡ IP åˆä½œéç¨‹ä¸­ï¼ŒYuki è€å¸«å¼·èª¿ ä¸è¦å¦„è‡ªè²è–„æƒ³èªªã€Œç‚ºä»€éº¼XXX é€™éº¼æœ‰åæ€éº¼æœƒæƒ³è·Ÿæˆ‘å€‘åˆä½œã€ï¼Œå¥¹åœ¨éå»é€£çºŒèˆ‡å¤šå®¶ IP å¦‚ç¦æ–¯æ±½è»Š/ tomicaå°å¡è»Šåˆä½œç­‰ç­‰ï¼Œéƒ½æ¨å‡ºå¤šè´çš„å•†æ¥­åˆä½œæ¡ˆï¼Œæœ€æ£’çš„æ˜¯å°æ–¹æä¾›é™å®šå•†å“ï¼ŒåŒæ™‚ä¹Ÿæœƒå¹«å¿™å®£å‚³ï¼Œç”¨æˆ¶è²·å–®ä¹Ÿæœƒå¾ˆé–‹å¿ƒ\nç§‘æŠ€å·¥å…·çš„æ‡‰ç”¨ KKday è¦çµåˆè‡ªå®¶å•†å“ç”¢å‡ºå¤§é‡çš„æ–‡ç« æ¨å»£ï¼Œä½†è³‡æ–™çš„æ•´ç†/åœ–æ–‡æ’ç‰ˆç­‰ååˆ†è€—è²»äººåŠ›ï¼Œå¾Œä¾†å°±ç ”ç™¼ KKday æ™ºèƒ½å°å¹«æ‰‹ï¼Œé€é AI çˆ¬æ–‡ / è‡ªå‹•ç”¢ç”Ÿæ–‡æ¡ˆæœ€å¾Œå†ç”±è³‡æ·±ç·¨è¼¯å¯©æ ¸ç™¼å¸ƒï¼ŒåŠ é€Ÿæ—…éŠæ–‡ç« çš„ç™¼å¸ƒé€Ÿåº¦\néç¨‹ä¹Ÿæåˆ°é€™æŠ€è¡“é–€æª»ä¸é«˜ï¼Œä½†å°±æ˜¯æä¾›å¾ˆæ£’çš„å•†æ¥­åƒ¹å€¼ï¼Œè§£æ±ºäº†çœŸå¯¦çš„å•é¡Œ\nè½‰æ›ç‡è¿·æ€ åªè¦ç™¼ç”Ÿæµé‡å¤§ã€è½‰æ›ç‡ä½ï¼Œé€šå¸¸ç›´è¦ºå°±æ˜¯è¦å» tune ä»‹é¢æå‡è½‰æ›ç‡ï¼Œä½†é€™å¾€å¾€é™·å…¥äº†æ€ç¶­çš„èª¤å€ï¼ŒYuki è€å¸«åˆ†äº«åˆ° KKday ä¸€å€‹æ¡ˆä¾‹ï¼Œç™¼ç¾éå¹´æœŸé–“çš„æ—¥æœ¬æŸä¸€å€‹æ´»å‹•çš„æµé‡å¾ˆå¥½ä½†è½‰å–®ç‡è¶…ä½ï¼Œä»”ç´°ç ”ç©¶æ‰ç™¼ç¾æ˜¯å°ç£å»æ—¥æœ¬ç©çš„éŠå®¢é»æ“Šï¼Œä½†æ˜¯åœ¨é¸æ“‡æ—¥æœŸæ™‚å°±é›¢é–‹äº†ï¼Œè¿½æŸ¥å¾Œçœ‹åˆ°æ˜¯å› ç‚ºæ´»å‹•çš„å‰ç½®æ—¥æœŸæ˜¯äº”å¤©ï¼Œå¦‚æœæ˜¯éŠå®¢ä¸å¤ªå¯èƒ½åœ¨æ—…éŠä¸­è²·äº”å¤©å¾Œçš„è¡Œç¨‹ï¼Œæœ€å¾Œçš„èª¿æ•´æ˜¯èˆ‡ä¾›æ‡‰å•†æ´½è«‡ï¼ŒæŠŠå‰ç½®æ—¥æœŸå£“ç¸®åˆ°ä¸€å¤©ï¼Œè½‰æ›ç‡ä¹Ÿå°±è·Ÿè‘—æå‡\né€™å›æ‡‰åˆ°è€å¸«å¦ä¸€å€‹é‡é»\næœ€ç›´è¦ºçš„æ”¹å–„æ–¹æ¡ˆï¼Œå¾€å¾€åªåœ¨åˆæœŸæœ‰æ•ˆï¼Œéç›´è¦ºçš„æ©Ÿæœƒæ›´é¡¯å¾—çè²´\né€™é»éå¸¸æœ‰æ„Ÿï¼Œå› ç‚ºæˆ‘å€‘å…¬å¸ä¹Ÿæ˜¯åœ¨ä¸€å€‹æ™‚æœŸç˜‹ç‹‚çš„åœ¨å„ªåŒ– onboarding æµç¨‹ / è³¼è²·è½‰æ›ï¼Œä¸æ–·åœ¨çœ‹æ¯ä¸€å€‹ step é–“çš„æ•¸æ“šï¼Œç¢ºå¯¦ä¹Ÿåœ¨éç¨‹ä¸­å¾—åˆ°ä¸€å®šçš„æå‡ï¼Œä½†æ˜¯å¾ŒçºŒå°±é‡ä¸Šè²§é ¸ï¼Œæœ€çµ‚é‚„æ˜¯è¦æŒçºŒçš„å„ªåŒ–ç”¢å“/èª¿æ•´è³¼è²·æ–¹æ¡ˆï¼Œæ‰èƒ½è®“ç”¨æˆ¶é¡˜æ„è²·å–®\nå¥½åšçš„é€šå¸¸éƒ½åšéäº†(æ²’åšéç•¶ç„¶é‚„æ˜¯è¦åš)ï¼Œä½†è¦è¨˜å¾—ç”¢å“æœ¬èº«çš„å…§æ¶µæ‰æ˜¯çœŸæ­£çš„é•·é ä¹‹é“\nå¦‚ä½•å¸¶é ˜åœ˜éšŠ ğŸ‘ åˆ¥åªå•æ•¸å­— å¦‚æœä¸»ç®¡åªéå•æ•¸å­—ï¼Œä¸åœ¨ä¹éç¨‹ï¼Œé‚£æœ€å¾Œç”¢å‡ºä¸è¦‹å¾—æ˜¯æœ€ç†æƒ³çš„ï¼Œåƒæ˜¯æ´—å‡ºä½å“è³ªçš„æµé‡ ğŸ‘ åˆ¥é¼“å‹µåšå ±å‘Š æ•¸å­—æ‡‰è©²å¯ä»¥è‡ªå·±å¾å ±è¡¨æª¢è¦–ï¼Œæ‡‰è©²è®“ä¸‹é¢çš„äººæœ‰æ›´å¤šæ€è€ƒèˆ‡è©¦éŒ¯çš„æ©Ÿæœƒ\nğŸ‘ åšç­–ç•¥è¦æ¸…ç©ºè…¦è¢‹ ä¸è¦ç”¨é–‹æœƒå¡æ»¿å¤§å®¶çš„è¡Œç¨‹\nğŸ‘ ç”¨è©¢å•ä»£æ›¿å»ºè­° å› ç‚ºç®¡ç†éšå±¤çš„æ¬Šå¨æ„Ÿï¼Œå¯èƒ½çªç™¼å¥‡æƒ³çš„å»ºè­°å°±æœƒè¢«ä¸‹å±¬ç†è§£æˆåŸ·è¡Œæ–¹å‘(è¶…æœ‰æ„Ÿ)ï¼Œæ‡‰è©²ä»¥è©¢å•ä»£æ›¿å»ºè­°ï¼Œå¾ˆå¤šäº‹æƒ…ç¬¬ä¸€ç·šçš„å“¡å·¥åè€Œæ›´æ¸…æ¥š\nç¸½å›é¡§ æ–°å®¢æµé‡ï¼š\nèƒ½è¢«å„ªåŒ–çš„å¤§å¤šéƒ½åšäº†ï¼Œè¦åšä¸€äº›æ„æƒ³ä¸åˆ°çš„çªç ´ èˆŠå®¢å›è³¼ï¼š\né€éç”¢å“ç·šçš„å»¶ä¼¸ï¼Œè¿åˆç”¨æˆ¶çš„éœ€æ±‚è€Œéé€éæŠ˜æ‰£ å¢åŠ åŠ©æ”»ï¼š KKday æ•¸æ“šç ”ç©¶ç™¼ç¾ï¼Œç”¨æˆ¶åœ¨æ—…éŠå‰ 14 å¤©æœƒé–‹å§‹é€›ç¶²ç«™è²·è¡Œç¨‹ï¼Œè³¼è²·é€”ä¸­æœƒæœ‰ 7 å€‹é—œéµé»ï¼Œå¦‚ä½•åœ¨è³¼è²·æ—…ç¨‹ä¸­æ‰“å‹•ç”¨æˆ¶ï¼Œå°±è¦ä¸æ–·åœ°å»æ€è€ƒè·Ÿå˜—è©¦ï¼Œä¾‹å¦‚å¢åŠ åœ–ç‰‡/å½±ç‰‡çš„å“è³ªå¯ä»¥æå‡è½‰æ›ç­‰ å¥åº·çš„æµé‡æ¨¡å‹ï¼š\nåˆ†ç”¢å“/åˆ†æµé‡/åˆ†ç”¨æˆ¶åƒ¹å€¼ï¼Œæ‰èƒ½åˆ¶å®šæ­£ç¢ºçš„æµé‡ç­–ç•¥ Martech:\nåˆ©ç”¨ç¾æœ‰çš„å·¥å…·å„ªåŒ–è¡ŒéŠ·çš„æ–¹å¼ è·å ´å¿ƒæ…‹ åœ¨éç¨‹ä¸­ï¼ŒYuki è€å¸«æŒçºŒå¼·èª¿ è€é—†æ€ç¶­ï¼Œä¸è¦åªè‘—çœ¼æ–¼è‡ªèº«çš„ KPI é”æˆï¼Œè€Œæ˜¯è¦æ›´è¿‘ä¸€æ­¥ç™¼æ®è‡ªèº«å½±éŸ¿åŠ›ï¼Œè©¦è‘—ç«™åœ¨è€é—†çš„è§’åº¦æ€è€ƒï¼Œçœ‹çœ‹å…¬å¸ç”¢å“é‚„æœ‰ä»€éº¼åœ°æ–¹å¯ä»¥æ”¹å–„ï¼Œè€Œä¸æ˜¯å—é™æ–¼è‡ªèº«çš„è·ä½\nä½†åŒæ™‚è€å¸«ä¹Ÿæé†’ï¼Œç•¶è€é—†é‚„æ˜¯ç”¨èˆŠæœ‰çš„è§€å¿µæ™‚ï¼Œç›¡å¯èƒ½å…ˆè¿åˆè€é—†çš„éœ€æ±‚ï¼Œä¾‹å¦‚æµé‡ç¿»å€ï¼Œåœ¨éç¨‹ä¸­æœ‰å¯ä»¥æ–½åŠ›çš„åœ°æ–¹åœ¨ä½¿åŠ›ï¼Œæ…¢æ…¢çš„å°æ­£è§€å¿µï¼Œè€Œä¸æ˜¯ç›´æ¥åé§è€é—†ï¼Œé€™æ¨£æ‰æœ‰è½‰è®Šçš„æ©Ÿæœƒ\nåæ€ è½å®Œæ¼”è¬›ï¼Œåéä¾†æ€è€ƒå¹¾ä»¶äº‹æƒ…\næˆ‘å€‘å…¬å¸æœ‰å®Œæ•´çš„ç”¨æˆ¶åƒ¹å€¼åˆ†æå—ï¼Ÿ\nå¦‚æœè¦æœ‰å¹¾å€‹è©æè¿°æˆ‘å€‘å…¬å¸æœ€æœ‰åƒ¹å€¼çš„ç”¨æˆ¶ç¾¤æœƒæ€éº¼æè¿°å‘¢ï¼Ÿ\næˆ‘å€‘æœ‰å®Œæ•´çš„æµé‡æ¨¡å‹åˆ†æå—ï¼Ÿ\næˆ‘å€‘æœ‰åšä»€éº¼æµé‡æ¨å»£å—ï¼Ÿ\nå›é¡§è‡ªå®¶å…¬å¸æ˜¯åš SaaSï¼Œå°ˆæ³¨æ–¼å–®ä¸€çš„ç”¢å“é–‹ç™¼ï¼Œæ‰€ä»¥ä¸åƒ KKday æ˜¯ä»¥å¹³å°çš„å½¢å¼ï¼Œæœ‰å¤§é‡çš„å•†å“èˆ‡åˆä½œæ¡ˆå¯ä»¥æ“ä½œï¼Œä½†æ˜¯å°æ–¼ç”¨æˆ¶è¼ªå»“èˆ‡åˆ†ç¾¤é€™éƒ¨åˆ†ä¹Ÿæ˜¯æœ‰åœ¨è‘—æ‰‹ï¼Œä¾‹å¦‚èªªæˆ‘å€‘æœƒåœ¨ onboarding æµç¨‹åŸ‹å…¥ç”¨æˆ¶çš„ç”¨é€”é¸å¡«ï¼Œè—‰æ­¤åˆ†ç¾¤ç”¨æˆ¶\nä½†æœ‰è¶£çš„æ˜¯æˆ‘å€‘å…¬å¸ç”¨æˆ¶éä½ˆä¸–ç•Œå„åœ°ï¼Œç”¨æˆ¶çš„è³¼è²·è¡Œç‚º/è½‰æ›ç‡ç­‰å—åˆ°åœ‹æƒ…å½±éŸ¿æ¯”ç”¨æˆ¶ç”¨é€”å½±éŸ¿é‚„è¦å¤§ï¼Œæ‰€ä»¥åœ¨åšå¤§éƒ¨åˆ†è³¼è²·å¯¦é©—æ™‚éƒ½æ˜¯ä»¥åœ‹å®¶ç‚ºå€åˆ†\nè‡³æ–¼æµé‡è¿½è¹¤å¾ŒçºŒç”¨æˆ¶è½‰æ›çš„éƒ¨åˆ†ï¼Œå‰‡é‚„åœ¨è‘—æ‰‹é–‹ç™¼ä¸­ï¼Œä½†å…¥å£ç›¸å°ä¹Ÿå–®ç´”ï¼Œå¾ç¶²ç«™å°æµæˆ–æ˜¯ app store / play store æœå°‹ã€ä¸‹å»£å‘Šé€²ä¾†çš„ï¼ŒæŒçºŒè§€å¯Ÿæœƒä¸æœƒæœ‰ä»€éº¼è®ŠåŒ–å‡ºç¾\n","date":"2021-01-19T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2021/2021-01-19-%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9C%8B%E5%95%86%E6%A5%AD%E9%87%8F%E5%8C%96%E8%A1%8C%E9%8A%B7%E7%9A%84%E6%B5%81%E9%87%8F%E6%80%9D%E7%B6%AD%E8%AC%9B%E5%BA%A7%E5%BF%83%E5%BE%97/","title":"ã€å·¥ç¨‹å¸«çœ‹å•†æ¥­ã€‘é‡åŒ–è¡ŒéŠ·çš„æµé‡æ€ç¶­è¬›åº§å¿ƒå¾—"},{"content":"å¯«äº†ä¸€å€‹ç°¡å–®çš„è³¼ç‰©æµç¨‹ SQLï¼Œåœ¨ä¸€å€‹ transaction ä¸­åŸ·è¡Œ\nè®€å– product è³‡è¨Šï¼šselect * from product where id = 1 å¯«å…¥æ–°è¨‚å–® order ç‹€æ…‹: insert into orders (product_id) values (1) æ›´æ–° product è²©å”®ç‹€æ…‹ï¼šupdate product set sold=1 where id = 1\nå…¶ä¸­ order table çš„ product_id æ˜¯å¼•ç”¨ product table çš„ id ç•¶åš foriegn keyï¼Œä¸¦åœ¨ä½µç™¼çš„æƒ…æ³ä¸‹åŸ·è¡Œï¼Œé–‹å§‹å¶ç„¶é‡åˆ° Deadlock 1 Error: update `products` set `sold` = 34 where `id` = \u0026#39;919\u0026#39; - Deadlock found when trying to get lock; try restarting transaction ç•¶ä¸‹è¦ºå¾—å¥‡æ€ªï¼Œç¬¬ä¸€å°è±¡ä¸­ Deadlock åªç™¼ç”Ÿåœ¨å…©å€‹ Transaction äº’ç›¸æ‰€éœ€çš„æ¬„ä½è€Œç„¡æ³•é‡‹æ”¾ï¼Œå¦‚\nT1: lock(r1) , wait(r2) T2: lock(r2), wait(r1)\nä½†æ˜æ˜æˆ‘å°±ä¸€ç¨® SQL ä½µç™¼åŸ·è¡Œï¼Œæ€éº¼ä¹Ÿæœƒæœ‰ Deadlock ä»¥ä¸‹é–‹å§‹æ’æŸ¥åŸå› \nMySQL Deadlock èªªæ˜ è®“æˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡ä»¶ 15.7.5 Deadlocks in InnoDB\nDeadlock ä¸»è¦æ˜¯å¤šå€‹ Transaction æ‰‹ä¸Šæ¡æœ‰å°æ–¹éœ€è¦çš„è³‡æºï¼Œåœ¨ç­‰å¾…è³‡æºé‡‹æ”¾çš„åŒæ™‚å»ä¹Ÿä¸æœƒé‡‹æ”¾æ‰‹ä¸Šçš„è³‡æºï¼Œå¸¸ç™¼ç”Ÿåœ¨ä½¿ç”¨ update å»é †åºå‰›å¥½ç›¸å\nå¦‚æœ Deadlock æ•¸é‡å¾ˆå°‘ä¸å¤ªéœ€è¦æ“”å¿ƒï¼Œæ‡‰ç”¨ç¨‹å¼è¨˜å¾— retry å°±å¥½ï¼Œä½†å¦‚æœç™¼ç”Ÿå¾ˆé »ç¹å°±è¦æª¢æŸ¥ SQL çš„ç‹€æ³\nç‚ºäº†ç›¡é‡æ¸›å°‘ Deadlock ç™¼ç”Ÿï¼Œå¯ä»¥æª¢æŸ¥ä»¥ä¸‹æ–¹å¼\nç›¡å¯èƒ½æ¸›å°‘ Update / Delete åœ¨å–®ä¸€ Transaction ä¸­çš„æ•¸é‡ Lock æ™‚è«‹ä¾ç…§åŒæ¨£çš„é †åº (ä¾‹å¦‚ select \u0026hellip; for update) é™ä½ Lock çš„å±¤ç´šï¼Œé¿å… lock tables çš„æ“ä½œ è­¦æ…é¸æ“‡ indexï¼Œå› ç‚ºéå¤šçš„ index å¯èƒ½æœƒé€ æˆ deadlockï¼Œå¾ŒçºŒæœƒå†å±•é–‹æè¿° InnoDB uses automatic row-level locking. You can get deadlocks even in the case of transactions that just insert or delete a single row. That is because these operations are not really â€œatomicâ€; they automatically set locks on the (possibly several) index records of the row inserted or deleted.\nè€ƒæ…®é™ä½ isolation levelï¼Œé«˜å±¤ç´šçš„ isolation level æœƒå»æ”¹è®Š read çš„æ“ä½œï¼Œä¾‹å¦‚ MySQL ä¸­ serializable å…¶å¯¦å°±æ˜¯éš±å¼æŠŠæ‰€æœ‰ select éƒ½åŠ ä¸Š lock for shareï¼Œå¼•è‡ªæ–¼å®˜æ–¹æ–‡ä»¶ 15.7.2.1 Transaction Isolation Levels This level is like REPEATABLE READ, but InnoDB implicitly converts all plain SELECT statements to SELECT \u0026hellip; FOR SHARE if autocommit is disabled.\nDeadlock detection é è¨­æ˜¯é–‹å•Ÿï¼Œä½†å¦‚æœåœ¨é«˜æµé‡ä¸‹æœƒæœ‰æ•ˆèƒ½çš„å½±éŸ¿ï¼Œå¦‚æœé æœŸ Deadlock ç‹€æ³ä¸å¤šå¯ä»¥æ”¹é€é innodb_deadlock_detect é¸é …é—œé–‰ï¼Œç”¨ innodb_lock_wait_timeout ä¸€ç›´ç­‰ä¸åˆ° lock ç™¼ç”Ÿ timeout è€Œè§¸ç™¼ rollback å–ä»£\nMySQL å¯ä»¥é€é SQL æŒ‡ä»¤ \u0026gt; SHOW ENGINE INNODB STATUS çœ‹æœ€å¾Œä¸€ç­†ç™¼ç”Ÿ Deadlock çš„åŸå› ï¼Œæˆ–æ˜¯é–‹å•Ÿ innodb_print_all_deadlocks æŠŠæ¯ä¸€æ¬¡ Deadlock åŸå› éƒ½è¼¸å‡ºåˆ° error log ä¸­\né–‹å•Ÿè¨­å®šçš„ SQL ç‚º \u0026gt; SET GLOBAL innodb_print_all_deadlocks=ON;\nå…·é«”çš„ Deadlock log ç•¶åœ¨æ‡‰ç”¨ç¨‹å¼ç™¼ç¾ deadlock éŒ¯èª¤å¾Œï¼Œå›åˆ° MySQL ä½¿ç”¨æŒ‡ä»¤æŸ¥çœ‹ï¼Œå¾—åˆ°ä»¥ä¸‹åŸå§‹ log\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 ===================================== 2020-12-26 00:10:16 0x7f9668490700 INNODB MONITOR OUTPUT ===================================== Per second averages calculated from the last 29 seconds ----------------- BACKGROUND THREAD ----------------- .... ---------- SEMAPHORES ---------- .... ------------------------ LATEST DETECTED DEADLOCK ------------------------ 2020-12-26 00:05:14 0x7f9657cf9700 *** (1) TRANSACTION: TRANSACTION 14048, ACTIVE 1 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 11 lock struct(s), heap size 1136, 6 row lock(s), undo log entries 2 MySQL thread id 54, OS thread handle 140283242518272, query id 45840 172.22.0.1 api-server updating update `products` set `sold` = 32 where `id` = \u0026#39;919\u0026#39; *** (1) HOLDS THE LOCK(S): RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table `online-transaction`.`products` trx id 14048 lock mode S locks rec but not gap Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 4; hex 00000397; asc ;; 1: len 6; hex 0000000036d7; asc 6 ;; 2: len 7; hex 010000013f1e26; asc ? \u0026amp;;; 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;; 4: len 4; hex 800000b1; asc ;; 5: len 4; hex 800000fe; asc ;; 6: len 4; hex 80000020; asc ;; *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table `online-transaction`.`products` trx id 14048 lock_mode X locks rec but not gap waiting Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 4; hex 00000397; asc ;; 1: len 6; hex 0000000036d7; asc 6 ;; 2: len 7; hex 010000013f1e26; asc ? \u0026amp;;; 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;; 4: len 4; hex 800000b1; asc ;; 5: len 4; hex 800000fe; asc ;; 6: len 4; hex 80000020; asc ;; *** (2) TRANSACTION: TRANSACTION 14052, ACTIVE 1 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 11 lock struct(s), heap size 1136, 6 row lock(s), undo log entries 2 MySQL thread id 57, OS thread handle 140283970258688, query id 45841 172.22.0.1 api-server updating update `products` set `sold` = 34 where `id` = \u0026#39;919\u0026#39; *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table `online-transaction`.`products` trx id 14052 lock mode S locks rec but not gap Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 4; hex 00000397; asc ;; 1: len 6; hex 0000000036d7; asc 6 ;; 2: len 7; hex 010000013f1e26; asc ? \u0026amp;;; 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;; 4: len 4; hex 800000b1; asc ;; 5: len 4; hex 800000fe; asc ;; 6: len 4; hex 80000020; asc ;; *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table `online-transaction`.`products` trx id 14052 lock_mode X locks rec but not gap waiting Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 4; hex 00000397; asc ;; 1: len 6; hex 0000000036d7; asc 6 ;; 2: len 7; hex 010000013f1e26; asc ? \u0026amp;;; 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;; 4: len 4; hex 800000b1; asc ;; 5: len 4; hex 800000fe; asc ;; 6: len 4; hex 80000020; asc ;; *** WE ROLL BACK TRANSACTION (2) ------------ TRANSACTIONS ------------ ..... -------- FILE I/O -------- ..... ------------------------------------- INSERT BUFFER AND ADAPTIVE HASH INDEX ------------------------------------- ..... --- LOG --- ..... ---------------------- BUFFER POOL AND MEMORY ---------------------- ..... -------------- ROW OPERATIONS -------------- ..... ---------------------------- END OF INNODB MONITOR OUTPUT ============================ æŒ‘å‡ºé‡é»ä¾†çœ‹\nLATEST DETECTED DEADLOCK ä»¥ä¸‹é¡¯ç¤ºæœ€å¾Œä¸€æ¬¡ç™¼ç”Ÿçš„ Deadlockï¼Œæœ‰è¡¨è¿°äº’ç›¸æ­»é–çš„å…©ç­† Transaction *** (1) TRANSACTION: èˆ‡ *** (2) TRANSACTION: æ¥è‘—çœ‹åˆ°å…©ç­† Transaction æ‰‹ä¸Šæ¡æœ‰çš„ Lockï¼Œçœ‹å¾—å‡ºä¾†ä»–å€‘éƒ½æœ‰åŒä¸€è¡Œ product row çš„ lock mode S locks 1 RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table `online-transaction`.`products` trx id 14052 lock mode S locks rec but not gap æ¥è‘—ä»–å€‘åœ¨ç­‰å¾…çš„é–ç‚º 1 `online-transaction`.`products` trx id 14052 lock_mode X locks rec but not gap waiting ç­”æ¡ˆå°±æ­¤æ­æ›‰ï¼Œå› ç‚ºå…©å€‹ Transaction æ‰‹ä¸Šéƒ½æ¡æœ‰ share lockï¼Œå¦‚æœè¦å–å¾— exclusive lock å‰‡å°æ–¹å¿…é ˆå…ˆé‡‹æ”¾ share lockï¼Œå› æ­¤é€ æˆ Deadlockï¼Œæœ€çµ‚çœ‹åˆ° Transaction 2 è¢« rollback äº†\n1 *** WE ROLL BACK TRANSACTION (2) Debug è³‡è¨Šä¹çœ‹å¾ˆå¤šï¼Œä½†ä»”ç´°çœ‹é‚„è »å¥½ç†è§£çš„\næ‰¾å‡ºå•é¡Œæ ¹æº çŸ¥é“æ˜¯å› ç‚º shared lock å°è‡´å¾Œé¢çš„ exclusive lock æ­»é–çš„åŸå› ï¼Œå›é ­çˆ¬æŒ‡ä»¤çœ‹å“ªè£¡æœ‰å•é¡Œ\né¦–å…ˆå®šä½åˆ° select fromï¼Œæ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼Œé™¤é isolation æ˜¯ serializableï¼Œå¦å‰‡ä¸€èˆ¬çš„ select from æ˜¯æ²’æœ‰ lock çš„ï¼Œå‡ºè™• 15.7.2.3 Consistent Nonlocking Reads\nConsistent read is the default mode in which InnoDB processes SELECT statements in READ COMMITTED and REPEATABLE READ isolation levels. A consistent read does not set any locks on the tables it accesses, and therefore other sessions are free to modify those tables at the same time a consistent read is being performed on the table.\næ—¢ç„¶ä¸æ˜¯ select é€ æˆï¼Œå«Œç–‘çŠ¯å°±è®Šæˆ insert order äº†ï¼Œorders table ä¸­çš„ product_id æ˜¯å¼•ç”¨ product table ä¸­çš„ id ç•¶ä½œ foreign keyï¼Œæœç„¶æ‰¾åˆ°ç›¸é—œçš„æè¿° 14.7.3 Locks Set by Different SQL Statements in InnoDB\nIf a FOREIGN KEY constraint is defined on a table, any insert, update, or delete that requires the constraint condition to be checked sets shared record-level locks on the records that it looks at to check the constraint. InnoDB also sets these locks in the case where the constraint fails.\nçœŸç›¸å¤§ç™½\nå¦‚ä½•è§£æ±º åœ¨ SQL æœ€ä¸€é–‹å§‹ï¼Œå› ç‚ºç¯¤å®šæœƒæ”¹è®Š product æ¬„ä½ï¼Œç›´æ¥ä½¿ç”¨ select for update ç”¨ exclusive lock é–ä½ï¼Œå°±è§£æ±ºå•é¡Œäº†\néœ€æ³¨æ„è¨­å®šæˆ serializable é‚„æ˜¯æœ‰æ©Ÿæœƒç™¼ç”Ÿ Deadlock å–”ï¼Œå› ç‚ºåœ¨ MySQL ä¸­åªæ˜¯è¿½åŠ  select from çš„é–ï¼Œè€Œä¸æ˜¯çœŸçš„åƒ redis ä¸€æ¬¡åªé †åºåŸ·è¡Œä¸€é“æŒ‡ä»¤å–”\nè£œå……è³‡æ–™ - é—œæ–¼ MySQL Lock è§£å†³æ­»é”ä¹‹è·¯ï¼ˆç»ˆç»“ç¯‡ï¼‰ - å†è§æ­»é” å¼·åŠ›æ¨è–¦é€™ç¯‡æ–‡ç« ï¼Œå¾Œä¾†èˆ‡åŒäº‹åœ¨å·¥ä½œä¸Šæ’æŸ¥æ­»é–ï¼Œç™¼ç¾ update å–®ç­†è³‡æ–™ç«Ÿç„¶ä¹Ÿæœ‰æ­»é–çš„ç‹€æ³ï¼Œæ‰çŸ¥é“ lock éœ€è¦é–å®šå°æ‡‰çš„ Index ä¸¦ä¸”åœ¨æ²’æœ‰å‘½ä¸­æ™‚æœƒä½¿ç”¨å€é–“é– (å¦‚æœ isolation level åœ¨ Repeatable Read ä»¥ä¸Š)ï¼Œé‚„æ˜¯æœ‰æ©Ÿæœƒé€ æˆæ­»é–\né€éä¸Šè¿°çš„åƒè€ƒè³‡æ–™ï¼Œä¸¦é‡æ–°ç¿»é–± MySQL æ–‡ä»¶ï¼Œæ•´ç†äº†å¦ä¸€ç¯‡ ã€MySQLã€‘Lock èˆ‡ Index é—œä¿‚å’Œ Deadlock åˆ†æ\n","date":"2020-12-26T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-12-26_mysql-deadlock-%E5%95%8F%E9%A1%8C%E6%8E%92%E6%9F%A5%E8%88%87%E8%99%95%E7%90%86/","title":"MySQL Deadlock å•é¡Œæ’æŸ¥èˆ‡è™•ç†"},{"content":"UUID æ˜¯ä¸€å€‹è¢«å¤§é‡ä½¿ç”¨çš„æ¼”ç®—æ³•ï¼Œåˆ†æ•£å¼åœ°ç”¢ç”Ÿå¤§é‡ä¸é‡è¤‡ä¸”å›ºå®šç‚º 128 bitçš„ IDï¼Œåˆ†æ•£å¼æ˜¯æŒ‡èªªå¤šå°æ©Ÿå™¨æ¯ç§’åŒæ™‚ç”¢ç”Ÿå¤šç­† UUIDï¼Œæœ‰æ¥µå¤§æ¦‚ç‡é€™äº› UUID éƒ½ä¸æœƒç™¼ç”Ÿé‡è¤‡ï¼Œä¸éœ€è¦æœ‰ä¸€å°æ©Ÿå™¨å±…ä¸­è² è²¬ ID çš„ç®¡æ§èˆ‡ç™¼æ”¾ï¼Œåä¾‹åƒæ˜¯ MySQL è³‡æ–™åº«ä¸­çš„ auto increment id\nå…ˆæé‡é»ï¼Œå¦‚ä½•é¸æ“‡ UUID v1 ~ v5ï¼Œåƒè€ƒ Which UUID version to use?\nv4: å®Œå…¨éš¨æ©Ÿï¼Œæ²’æœ‰ç‰¹æ®Šéœ€æ±‚é¸é€™å€‹ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ 77% ç”¨æˆ¶é¸æ“‡é€™å€‹ v1: çµ„æˆåŒ…å« timestamp èˆ‡æ©Ÿå™¨è­˜åˆ¥ç¢¼(MAC Address)ï¼Œå¦‚æœéœ€è¦è­˜åˆ¥ç”±å“ªä¸€å°æ©Ÿå™¨åœ¨ä»€éº¼æ™‚é–“é»ç”¢ç”Ÿå¯ä»¥é¸é€™å€‹ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ 21% ç”¨æˆ¶é¸æ“‡é€™å€‹ v5 \u0026amp; v3: å¯ä»¥æŒ‡å®š Namespace èˆ‡ Nameï¼Œç›¸åŒçš„ Namespace èˆ‡ Name æœƒç”¢ç”Ÿç›¸åŒçš„ UUIDï¼Œv3 é›·åŒ v5ï¼Œå·®åˆ¥åœ¨æ–¼ v5 æœƒæ¡ç”¨ SHA1 ç•¶ä½œ Hash function è€Œ v3 æ¡ç”¨ MD5ï¼Œé™¤äº†ç›¸å®¹æ€§ç­‰è€ƒé‡ï¼Œå¦å‰‡è«‹å„ªå…ˆæ¡ç”¨ v5ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ 1% ç”¨æˆ¶é¸æ“‡é€™å€‹ v2: ä¸æ¡ç”¨ï¼Œé€£ RFC æ–‡ä»¶ä¹Ÿåªæœ‰å¸¶åˆ°å®šç¾©ï¼Œæ²’æœ‰å¯¦ä½œè¦ç¯„ éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ uuid.js çš„ v1ï¼Œuuid å¯¦ä½œæ˜¯æ²’æœ‰æ¡ç”¨ MAC Addressï¼Œæ‰€ä»¥å¦‚æœæœ‰è­˜åˆ¥åŒä¸€å°æ©Ÿå™¨ç”¢ç”Ÿçš„ uuid çš„éœ€æ±‚ï¼Œéœ€è¦è‡ªå·±å¦å¤–å¯¦ä½œï¼Œå¾Œé¢æœ‰æ›´è©³ç›¡çš„è£œå……\nä»¥ä¸‹å°‡æ‘˜è¦ RFC 4122 - A Universally Unique IDentifier (UUID) URN Namespace ï¼Œä¸¦æ¯”å°æ¯é€±æœ‰å°‡è¿‘å››ç™¾è¬ä¸‹è¼‰çš„ uuid.js å¯¦ä½œï¼Œæœ‰è©¢å•ä½œè€…ä¸€äº›ç´°ç¯€ï¼Œä»–ä¹Ÿéå¸¸ç†±å¿ƒè£œå……å¾ˆå¤šæœ‰æ£’çš„è³‡æ–™ï¼Œæœƒä¸€ä¸¦æ•´ç†åˆ†äº«\nRFC 4122 UUID å…±æœ‰ 128 bitsï¼Œä»¥ä¸‹æ˜¯ v1 å¯¦ä½œè¦ç¯„\n4.1.2. Layout and Byte Order ä»¥ä¸‹å°‡ä»‹ç´¹æ¯å€‹æ¬„ä½çš„çµ„æˆ\n4.1.3. Version UUID ç‰ˆæœ¬å¤¾åœ¨ time_hi_and_version æœ€é«˜æ•ˆä½å…ƒ(most significant)ä¸­ 4~7 bitï¼Œæ‰€ä»¥å¾ UUID string å°±èƒ½çœ‹å‡ºç‰ˆè™Ÿ\n4.1.4. Timestamp Timestamp ç¸½å…±æ˜¯ 60 bitsï¼Œå°æ–¼ UUID v1 ä¾†èªªæ˜¯ UTC æ™‚é–“ä¸”è‡ª 1582/10/15 00:00:00 (the date of Gregorian reform to the Christian calendar) é–‹å§‹è¨ˆç®—ï¼Œå¦‚æœæ©Ÿå™¨æ²’æœ‰ UTC æ™‚é–“ï¼Œå¯ä»¥æ¡ç”¨ local timeï¼Œä½†æ˜¯è¦ç¢ºä¿ local time æ˜¯ç©©å®šçš„\n4.1.5. Clock Sequence å¦‚æœç³»çµ±æ™‚é–“ç™¼ç”Ÿå€’è½‰ï¼Œæˆ–æ˜¯ Node ID ç™¼ç”Ÿæ”¹è®Šï¼Œå‰‡æœƒå¢åŠ ç¢°æ’çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥é€é Clock Sequence ä¾†ç´€éŒ„ï¼Œå¦‚æœç™¼ç¾ç”¢ç”Ÿéçš„ UUID æ¡ç”¨çš„ Timestamp æ¯”ç•¶ä¸‹çš„æ™‚é–“é‚„è¦æ™šæ™‚ (æ„å³ Clock æ™‚é–“è¢«å€’è½‰)ï¼Œå‰‡ clock sequence éå¢ï¼Œåˆå§‹åŒ–å‰‡éš¨æ©Ÿç”¢ç”Ÿ\nå¦å¤–å¦‚æœ Node ID ç™¼ç”Ÿæ”¹è®Šï¼Œé‚£æœ€å¥½ä¹Ÿå°‡ clock sequence éš¨æ©Ÿé‡ç½®ï¼Œé™ä½ç¢°æ’çš„é¢¨éšª\néœ€æ³¨æ„ clock sequence çš„è¨­å®šæœ€å¥½æ˜¯åœ¨ç³»çµ±å•Ÿå‹•å¾Œè¨­å®šä¸€æ¬¡å°±ä¸è¦å†æ”¹è®Šï¼Œé™ä½è·¨ç³»çµ±ç”¢ç”Ÿç¢°æ’çš„é¢¨éšª\n4.1.6. Node Node ID æ¡ç”¨ IEEE 802 MAC addressï¼Œå¦‚æœæœ‰å¤šå€‹ MAC Address ä»»ä¸€æŒ‘ä¸€å€‹æœ‰ç”¨çš„å³å¯ï¼Œå¦‚æœæ²’æœ‰å‰‡éš¨æ©Ÿç”¢ç”Ÿ\nä»¥ä¸Šæ˜¯ v1 çš„æ¬„ä½æ„ç¾©ï¼Œv3ã€v5 å‰‡æ˜¯æŠŠ Name åŠ ä¸Š Namespace å–é›œæ¹Šï¼Œæ¥è‘—åˆ†é…è‡³ä¸Šè¿°çš„æ¬„ä½ä¸­ï¼Œv4 å‰‡å…¨éƒ¨éš¨æ©Ÿç”¢ç”Ÿ\n4.2.1. Basic Algorithm æ¥è‘—çœ‹æœ€åŸºæœ¬çš„æ¼”ç®—æ³•å¯¦ä½œæµç¨‹\nå–å¾—ç³»çµ±ç´šåˆ¥çš„å…¨åŸŸé– è®€å–ç³»çµ±è¨­å®šæª”ï¼ŒåŒ…å« clock_seq / node id / timestamp è¨ˆç®—å‡º timestamp å–å¾— node id å¦‚æœä¿å­˜ node id èˆ‡è®€å–çš„ node id ä¸åŒï¼Œé‡æ–°è¨­å®š clock_seq ç•¶å‰ timestamp å°æ–¼ä¿å­˜çš„ timestampï¼Œclock_seq + 1 å°‡ç›®å‰è¨ˆç®—çš„å€¼ä¿å­˜å›å» é‡‹æ”¾é– å°‡ç›®å‰çš„ timestamp / clock_seq / node id çµ„åˆå‡º uuid å¦‚æœè¦é«˜é »ç‡è£½é€  uuidï¼Œæœƒé‡åˆ°ä»¥ä¸‹å¹¾å€‹æ•ˆèƒ½è²§é ¸èˆ‡å°æ‡‰è§£æ³•\næ¯æ¬¡å­˜ç³»çµ±è®€å–è³‡æ–™å¾ˆæ²’æ•ˆç‡:\nåƒ…éœ€è¦å†ç³»çµ±å•Ÿå‹•æ™‚è®€å–ä¸€æ¬¡é€² memory å³å¯ï¼Œå‡è¨­ç³»çµ±æ²’æœ‰ç©©å®šå„²å­˜ç©ºé–“ï¼Œå‰‡æ¯æ¬¡éƒ½è¦éš¨æ©Ÿç”¢ç”Ÿ clock_seqï¼Œé€™æœƒå°è‡´ç¢°æ’æ©Ÿç‡å¢åŠ ï¼Œæ‡‰è©²è¦ç›¡é‡é¿å…ï¼›å¦‚æœç¢ºå®š node id éƒ½ä¸æœƒè®Šï¼Œä¹Ÿå¯ä»¥ä¸ç”¨ä¿å­˜ç›´æ¥è¿”å›å³å¯ system clock ç²’åº¦ä¸è¦‹å¾—æœ‰åˆ° 100-nanoseconds:\nSystem Clock Resolutionï¼šå¦‚æœç”¢ç”Ÿé »æ¬¡ä¸é«˜ï¼Œå‰‡ç›´æ¥å°‡ç³»çµ±æ™‚é–“æ”¾å¤§åˆ° 100-nano çš„ç²’åº¦å³å¯ï¼Œä½†å¦‚æœç³»çµ±å–®ä¸€æ™‚é–“ç”¢ç”Ÿéå¤š uuidï¼Œå¯¦ä½œå¿…é ˆè¿”å›éŒ¯èª¤ï¼Œæˆ–æ˜¯æš«åœç”¢ç”Ÿï¼Œç›´åˆ°ç³»çµ±æ™‚é–“æ­£å¸¸ï¼Œå¦‚æœè¦æé«˜ç²’åº¦ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨åŒä¸€å€‹ç³»çµ±æ™‚é–“å…§ç´¯è¨ˆç”¢ç”Ÿçš„ uuid å€‹æ•¸ï¼Œ æ¯æ¬¡è¦å›å¯«ç³»çµ±è³‡æ–™å¾ˆæ²’æ•ˆç‡\nåªéœ€è¦å®šæ™‚æ›´æ–°å„²å­˜è³‡æ–™å³å¯ï¼Œå°‡ timestamp è¨­å®šåœ¨æ¯”è‡³ä»Šç”¢ç”Ÿçš„ UUID ä½¿ç”¨çš„ timestamp å¤§ä¸€é»ï¼Œä½†åˆä¸è¦å¤§åˆ°è¶…é reboot æ™‚çš„æ‰€éœ€è¦çš„å•Ÿå‹•æ™‚é–“ï¼Œç›®çš„åœ¨æ–¼é™ä½ clock sequence é‡ç½®çš„æ©Ÿæœƒï¼Œåœ¨ä¸‹æ–¹çš„å»ºè­°å¯¦ä½œä¸­æ˜¯æ¯ 10 ç§’å¯«å…¥ä¸€æ¬¡ 1 2 3 4 5 6 7 if (timestamp \u0026gt;= next_save) { fp = fopen(\u0026#34;state\u0026#34;, \u0026#34;wb\u0026#34;); fwrite(\u0026amp;st, sizeof st, 1, fp); fclose(fp); /* schedule next save for 10 seconds from now */ next_save = timestamp + (10 * 10 * 1000 * 1000); } è·¨é€²ç¨‹åˆ†äº«ç‹€æ…‹å¾ˆæ²’æ•ˆç‡\nå¦‚æœè·¨é€²ç¨‹å…±äº«ç‹€æ…‹å¾ˆè€—è³‡æºï¼Œå¯ä»¥æ¯å€‹é€²ç¨‹åˆ‡å‰²ä¸€å¡Šæ™‚é–“å€æ®µå€‹åˆ¥ç”¢ç”Ÿ uuid ï¼Œç›´åˆ°æ™‚é–“å€æ®µç”¨å®Œæ‰å»è¦æ–°çš„ 4.3. Algorithm for Creating a Name-Based UUID v3 è·Ÿ v5 ä¸»è¦æ˜¯åœ¨æŸä¸€ç‰¹å®šçš„ Namespace ä¸‹é‡å° Name ç”¢ç”Ÿå°æ‡‰çš„ UUIDï¼Œæœ‰ä»¥ä¸‹ç‰¹æ€§\nç›¸åŒçš„ namespace ç›¸åŒçš„ nameï¼Œä¸åŒç³»çµ±æ™‚é–“ä¸€æ¨£æœ‰ç›¸åŒçš„ uuid ç›¸åŒ namespace ä¸‹ä¸åŒ nameï¼Œuuid ä¸åŒ ç›¸åŒ name ä¸åŒ namespaceï¼Œuuid ä¸åŒ å¦‚æœå…©å€‹ uuid ç›¸åŒï¼Œå‰‡ä»£è¡¨ namespace / name ç›¸åŒ UUID æ¬„ä½å‰‡æ˜¯é€é Name + Namespace é›œæ¹Šå¾Œçš„å€¼å»æ´¾ç™¼\n4.5. Node IDs that Do Not Identify the Host å¦‚æœ MAC Address ä¸èƒ½ä½¿ç”¨ï¼Œæœ‰å¹¾ç¨®åšæ³•èƒ½ä¿è­‰ Node ID çš„ç¨ä¸€æ€§\nå»è·Ÿ IEEE è²è«‹ç¨ç«‹å€æ®µçš„ä½å€ï¼Œåœ¨æ–‡ä»¶ç·¨å¯«æ™‚æœŸåƒ¹æ ¼æ˜¯ US$550 ä½¿ç”¨å¯†ç¢¼å­¸å¼·åº¦çš„éš¨æ©Ÿç¢¼å–æœ€ä½ä½ 47 bitï¼Œæœ€é«˜ bit è¨­å®šç‚º 1ï¼Œä¸»è¦æ˜¯é¿é–‹ IEEE ä¸­ MAC Address çš„å€æ®µ å¸¸è¦‹åšæ³•æ˜¯åœ¨ buffer ä¸­éš¨æ©Ÿç´¯ç©ä¸€æ®µè³‡æ–™ï¼Œæ¥è‘—ç”¨ SHA1 æˆ– MD5 å– 48 bitsï¼Œç„¶å¾ŒæŠŠæœ€é«˜ bit è¨­å®šç‚º 1\n6. Security Considerations UUID ä¸¦ä¸ä¿è­‰éš¨æ©Ÿæ€§ï¼Œæ‰€ä»¥ä¸æœƒå¾ˆé›£çŒœï¼Œæ‰€ä»¥ä¸èƒ½æ‹¿ä¾†åšè·Ÿå®‰å…¨æ€§æœ‰é—œçš„æ¥­å‹™\nDo not assume that UUIDs are hard to guess\nä»¥ä¸Šå¤§æ¦‚æŒ‘å€‹é‡é»å¸¶é\nuuid.js å¯¦ä½œæ‹†è§£ ä»¥ä¸‹å°‡é–±è®€uuid.js github repoçš„åŸå§‹ç¢¼ï¼Œåœ¨é–‹å§‹çœ‹ v1~v5 çš„å¯¦ä½œå‰ï¼Œå…ˆçœ‹ä¸€å€‹ç”¨æ–¼ç”¢ç”Ÿéš¨æ©Ÿæ•¸çš„é‡è¦å‡½å¼ rng.js\n1 2 3 4 5 6 7 8 9 10 import crypto from \u0026#39;crypto\u0026#39;; const rnds8Pool = new Uint8Array(256); // # of random values to pre-allocate let poolPtr = rnds8Pool.length; export default function rng() { if (poolPtr \u0026gt; rnds8Pool.length - 16) { crypto.randomFillSync(rnds8Pool); poolPtr = 0; } return rnds8Pool.slice(poolPtr, (poolPtr += 16)); } ç¨‹å¼ç¢¼å¾ˆçŸ­ï¼Œä¸»è¦å°±æ˜¯ç”¢ç”Ÿä¸€å€‹ rnds8Pool é™£åˆ—ï¼Œéš¨æ©Ÿå¡å…¥æ•¸å€¼ï¼Œæœ€å¾Œæ¯æ¬¡å›å‚³ 16 bitï¼Œå¦‚æœé€™ä¸€æ®µ rnds8Pool éƒ½å›å‚³äº†ï¼Œå°±åœ¨ä¸€æ¬¡ç”¢ç”Ÿæ–°çš„éš¨æ©Ÿäº‚æ•¸\né€™å¯ä»¥ä¿è­‰ç”¢ç”Ÿ Generates cryptographically strong pseudo-random data.ï¼Œä¾†è‡ª Nodejs å®˜æ–¹æ–‡ä»¶çš„ä¿è­‰ï¼Œä¹Ÿæ˜¯ uuid ä¸æœƒæœ‰é«˜ç¢°æ’æ©Ÿç‡çš„ä¿è­‰ï¼Œåˆ‡è¨˜ Math.random ä¸è¶³å¤ éš¨æ©Ÿï¼Œæ‹¿ä¾†ä½¿ç”¨å•é¡Œæœƒå¾ˆå¤š\nUUID v1 å¯¦ä½œ ä»¥ä¸‹æŒ‘é‡é»èªªï¼Œä¸å¾—ä¸èªªä½œè€…çš„ç¨‹å¼ç¢¼ä»¥åŠè¨»è§£å¯«å¾—å¾ˆä¹¾æ·¨ï¼Œç›´æ¥æ¨™æ˜å¯¦ä½œå°æ‡‰çš„ RFC æ®µè½\n1 const seedBytes = options.random || (options.rng || rng)(); å…ˆç”¢ç”Ÿéš¨æ©Ÿæ•¸å‚™ç”¨ï¼Œåœ¨å‰é¢æ–‡ä»¶ä»‹ç´¹ä¸­ï¼Œæœ‰ç”¨åˆ°éš¨æ©Ÿç”¢ç”Ÿçš„éƒ½æœƒå¾ seedBytes ä¸­æå–\n1 2 3 4 5 6 7 8 9 10 11 if (node == null) { // Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1) node = _nodeId = [ seedBytes[0] | 0x01, seedBytes[1], seedBytes[2], seedBytes[3], seedBytes[4], seedBytes[5], ]; } é€™è£¡å¯ä»¥çœ‹åˆ°ï¼Œå¯¦ä½œä¸­çš„ node_idæ˜¯æ¯æ¬¡å•Ÿå‹•æ™‚éš¨æ©Ÿç”¢ç”Ÿï¼Œé€™ç¬¦åˆæ–‡ä»¶ 4.1.6ï¼Œæ²’æœ‰æ¡ç”¨ MAC Address è‡ªå·±äº‚æ•¸ç”¢ç”Ÿä¹Ÿå¯ä»¥ï¼›\nåŒæ™‚é€™ä¸€æ®µæˆ‘æœ‰ç‰¹åˆ¥ç•™ä¸€å€‹ Issue è©¢å•ä½œè€…ï¼Œç‚ºä»€éº¼ä¸ç…§æ–‡ä»¶è¦ç¯„å»æ‹¿æ©Ÿå™¨çš„ MAC Addressï¼Œä»–å›ç­”åˆ°åŸºæ–¼éš±ç§å•é¡Œï¼Œè€Œä¸”å¦‚æœ Node ID è·Ÿ Clock Seq æ¯æ¬¡éƒ½éš¨æ©Ÿç”¢ç”Ÿä¹Ÿæ˜¯ç¬¦åˆæ–‡ä»¶è¦ç¯„çš„\nI believe that this comes close to the idea of the spec while avoiding the privacy problems that come with trying to derive a stable node ID from hardware.\n1 2 3 4 if (clockseq == null) { // Per 4.2.2, randomize (14 bit) clockseq clockseq = _clockseq = ((seedBytes[6] \u0026lt;\u0026lt; 8) | seedBytes[7]) \u0026amp; 0x3fff; } æ²’æœ‰ clockseq å°±äº‚æ•¸ç”¢ç”Ÿ\n1 2 3 4 // Per 4.2.1.2 Throw error if too many uuids are requested if (nsecs \u0026gt;= 10000) { throw new Error(\u0026#34;uuid.v1(): Can\u0026#39;t create more than 10M uuids/sec\u0026#34;); } å¦‚æœå¯¦ä½œè€…ç™¼ç¾çŸ­æ™‚é–“å…§æœ‰å¤ªå¤§é‡çš„ uuid ç”¢ç”Ÿï¼Œéœ€è¦æ‹‹å‡ºéŒ¯èª¤æˆ–æ˜¯æš«åœ uuid ç”Ÿæˆé¿å…ç¢°æ’\n1 2 3 4 5 6 7 8 9 10 11 12 13 // `time_low` const tl = ((msecs \u0026amp; 0xfffffff) * 10000 + nsecs) % 0x100000000; b[i++] = (tl \u0026gt;\u0026gt;\u0026gt; 24) \u0026amp; 0xff; b[i++] = (tl \u0026gt;\u0026gt;\u0026gt; 16) \u0026amp; 0xff; b[i++] = (tl \u0026gt;\u0026gt;\u0026gt; 8) \u0026amp; 0xff; b[i++] = tl \u0026amp; 0xff; // `time_mid` const tmh = ((msecs / 0x100000000) * 10000) \u0026amp; 0xfffffff; b[i++] = (tmh \u0026gt;\u0026gt;\u0026gt; 8) \u0026amp; 0xff; b[i++] = tmh \u0026amp; 0xff; // `time_high_and_version` b[i++] = ((tmh \u0026gt;\u0026gt;\u0026gt; 24) \u0026amp; 0xf) | 0x10; // include version b[i++] = (tmh \u0026gt;\u0026gt;\u0026gt; 16) \u0026amp; 0xff; ç”¢ç”Ÿ time ç›¸é—œæ¬„ä½\nv4 å¯¦ä½œç›¸ç•¶ç°¡å–®ï¼Œå°±æ˜¯ä¿ç•™ versionï¼Œå…¶é¤˜å¡éš¨æ©Ÿæ•¸ï¼› v3,v5 å¤§åŒå°ç•°ï¼Œæ‰€ä»¥ä½œè€…å¯«äº†ä¸€å€‹ v35.js ï¼Œé‡é»å¤§æ¦‚å°±é€™éº¼å¹¾è¡Œ\n1 2 3 4 5 6 7 // Compute hash of namespace and value, Per 4.3 // Future: Use spread syntax when supported on all platforms, e.g. `bytes = // hashfunc([...namespace, ... value])` let bytes = new Uint8Array(16 + value.length); bytes.set(namespace); bytes.set(value, namespace.length); bytes = hashfunc(bytes); æŠŠ namespace è·Ÿ value åˆèµ·ä¾†ç„¶å¾Œ hash éï¼Œæ¥è‘—å°±æŒ‰ç…§æ–‡ä»¶å¡åˆ°å°æ‡‰çš„ä½ç½®\nå¾Œè¨˜ï¼šä½œè€…æäº¤ proposal çµ¦ tc39 ä½œè€…åœ¨ PR ä¸­æœ‰èªªåˆ°ä»–æäº†ä¸€å€‹ proposal çµ¦ tc39 proposal-uuidï¼Œç›®å‰é‚„åœ¨ stage 0ï¼Œå¸Œæœ›æŠŠ uuid ç”¢ç”Ÿè®Šæˆ js çš„è¦ç¯„ï¼Œä¸»è¦æ˜¯æœ‰å¤ªå¤šéŒ¯èª¤ä¸”ç²—å¿ƒçš„å¯¦ä½œï¼Œä¾‹å¦‚ä½¿ç”¨ Math.random ç­‰ï¼Œé€™é‚Šå¼•ç”¨ä¸€ç¯‡éå¸¸æ£’çš„æ–‡ç« æŒ‡å‡ºç‚ºä»€éº¼ Math.random ä¸å¥½ TIFU by using Math.random()ï¼Œä»¥ä¸‹å°‡æ‘˜éŒ„é‡é»\nTIFU by using Math.random() æ–‡ç« é‡é»æ‘˜è¦ TIFU =\u0026gt; Today I Fucked Up\nä½œè€…å…¬å¸æ¡ç”¨ microserviceï¼Œä½†ä»–å€‘å¸Œæœ›å¯ä»¥è¿½è¹¤æ¯å€‹ request åœ¨ service ä¸­äº¤äº’çµæœï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€å€‹å…¨åŸŸçš„ request idï¼Œéœ€è¦ä¸€å€‹éš¨æ©Ÿç”Ÿæˆæ¼”ç®—æ³•ç”¢ç”Ÿè¶³å¤ éš¨æ©Ÿçš„ id\næ‰€è¬‚çš„è¶³å¤ éš¨æ©ŸåŒ…å«å…©é»\nè¶³å¤ å¤§çš„ identifier spaceï¼šæœ‰è¶³å¤ å¤šçš„çµ„åˆèˆ‡å¯èƒ½æ€§ è¶³å¤ éš¨æ©Ÿçš„ identifier generationï¼šæœ‰äº†è¶³å¤ å¤šçš„ identifier spaceï¼Œé‚„éœ€è¦è¶³å¤ éš¨æ©Ÿçš„ç”Ÿæˆæ©Ÿåˆ¶ ä½œè€…æ±ºå®šç”¨é•·åº¦ 22 çš„ base 64ï¼Œä¹Ÿå°±æ˜¯ space æœ‰ 64^22 é€™éº¼å¤§ï¼Œgeneration å‰‡æ˜¯ç”¨ decent pseudo-random number generator (PRNG) å¸¸è¦‹çš„æ¼”ç®—æ³•ï¼ŒV8 å³æ˜¯æ¡ç”¨é€™ä¸€å¥—ï¼Œå¦‚æœè¶³å¤ éš¨æ©Ÿï¼Œé‚£é€™æ¨£çš„ç©ºé–“è¶³ä»¥é è¨ˆæ¯ç§’ç”¢ç”Ÿä¸€ç™¾è¬æ¬¡ä¹Ÿè¦ä¸‰ç™¾å¹´æ‰æœƒç¢°æ’ï¼Œå¤šéº¼çš„ç¾å¥½\næœ€å¾Œä½œè€…å…œå‡ºä¾†çš„ç¨‹å¼ç¢¼å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 var ALPHABET = \u0026#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_\u0026#39;; random_base64 = function random_base64(length) { var str = \u0026#34;\u0026#34;; for (var i=0; i \u0026lt; length; ++i) { var rand = Math.floor(Math.random() * ALPHABET.length); str += ALPHABET.substring(rand, rand+1); } return str; } çœ‹èµ·ä¾†ä¸€é»å•é¡Œéƒ½æ²’æœ‰ï¼Œä¹Ÿæ˜¯å¤§å®¶å¸¸è¦‹çš„éš¨æ©Ÿç”Ÿæˆåšæ³•\nä½†æ˜¯åœ¨ä¸ä¹…å¾ŒåŒäº‹ç™¼ç¾ ID ç¢°æ’äº† ğŸ’¥\nâ€œAnyone who considers arithmetical methods of producing random digits is, of course, in a state of sin.â€ From John von Neumann æ„å³è¦é€éæ•¸å­¸æ–¹å¼ç”¢ç”ŸçœŸæ­£éš¨æ©Ÿæ ¹æœ¬æ˜¯ä¸å¯èƒ½\nPRNG å¯¦ä½œ ç°¡å–®çœ‹ä¸€ä¸‹å½éš¨æ©Ÿæ•¸çš„ç”Ÿæˆæ–¹å¼ä¹‹ä¸€ PRNG (pseudo random number generator) ä¾†è‡ªåŸæ–‡çš„åœ–ç‰‡\nç°¡å–®ä¾†èªªå°±æ˜¯æœƒæœ‰ä¸€å€‹åˆå§‹çš„ Seedï¼Œæ¥è‘—æŒ‰ç…§æ•¸å­¸å…¬å¼ç®—å‡ºä¸€å€‹å°æ‡‰çš„ä½ç½®ï¼Œæ‰€ä»¥åªæœ‰ç¶“éå¹¾æ¬¡è¼ªè½‰ï¼Œæ‰€ä»¥è¦ç”¨ finite state ç”¢ç”Ÿéš¨æ©Ÿæ•¸æ˜¯ä¸å¯èƒ½çš„ï¼Œåªè¦ PRNG æŒçºŒç”¢ç”Ÿï¼Œé‚£æœ€çµ‚è¼¸å‡ºæœƒé‡è¤‡å‡ºç¾ Periodicï¼Œä½œè€…æ¯”é‡åˆ°ï¼Œ PRNG å°±åƒä¸€æœ¬å£“ç¸®çš„å¯†ç¢¼æœ¬æœ¬åŒ…å«è‘—ä¸€ä¸²æ•¸å­—ï¼ŒSeed åƒæ˜¯ä½ æŒ‘æŸä¸€é é–‹å§‹çœ‹ï¼Œæ¥è‘—ä¸€è·¯å¾€ä¸‹ç¿»ï¼Œåˆ°æ›¸å°¾å†å¾æ›¸é¦–é–‹å§‹çœ‹èµ·ï¼Œçµ‚å°‡è¼ªè¿´\nä¸éåªè¦ Cycle çš„é•·åº¦é•·åˆ°åœ¨æœ‰é™æ™‚é–“å…§ä¸æœƒç™¼ç”Ÿå³å¯ï¼Œé€™ä¹Ÿæ±ºå®š PRNG æ¼”ç®—æ³•å“è³ªï¼Œç¨±ä¹‹ç‚º full-cycle generator\nIf a PRNGâ€™s state has a k-bit representation, the cycle length is less than or equal to 2áµ. A PRNG that actually achieves this maximum cycle length is called a full-cycle generator.\nè‰¯å¥½çš„ PRNG æœƒç›¡å¯èƒ½é”åˆ° 2áµ ä¸Šé™\nå¾Œé¢æœ‰ä¸€æ®µå†èªªæ˜ Chrome ç•¶æ™‚çš„ Math.random æ¼”ç®—æ³•éŒ¯èª¤ï¼Œæ‰€ä»¥å¯¦éš›ä¸Š 590 million å°±æœƒç™¼ç”Ÿå¾ªç’°ï¼Œæ›´ç³Ÿç³•çš„æ˜¯åŸºæ–¼ç”Ÿæ—¥æ‚–è«–ï¼Œç”¢ç”Ÿåƒ…åƒ… 3 è¬æ¬¡å°±æœƒæœ‰ 50% çš„ç¢°æ’æ©Ÿæœƒ (50% chance of collision after generating just 30,000 identifiers.)\næœ€å¾Œçš„çµè«–æ˜¯å¦‚æœè¦æ¡ç”¨å½éš¨æ©Ÿç”Ÿæˆæ•¸è«‹ç”¨ CSPRNG(cryptographically secure PRNG)ï¼Œæˆ–æ˜¯æ¡ç”¨ç³»çµ±æ ¸å¿ƒåŸºæ–¼å¤–éƒ¨å™ªéŸ³ã€ç¶²è·¯å°åŒ…ç­‰ç”¢ç”Ÿçš„çœŸéš¨æ©Ÿæ•¸ urandom\nå…¶ä»– ä»Šå¤©è·¯éçœ‹åˆ°ä¸€ç¯‡é—œæ–¼ UUID çš„å¥½æ–‡ é–’è«‡è»Ÿé«”æ¶æ§‹ï¼šUUIDï¼Œä¸»è¦æ›´æ·±å…¥æ¢è¨å¦‚æœæŠŠ UUID ç•¶ä½œè³‡æ–™åº«çš„ Key å°æ–¼æ•ˆèƒ½çš„å½±éŸ¿ï¼Œä¸»ç›®çš„æ˜¯å¸Œæœ›èƒ½é”åˆ° åˆ†æ•£å¼ç”¢ç”Ÿéå¢çš„ Keyï¼ŒUUID v1 ç®—æ˜¯æœ‰ç¬¦åˆé€™å€‹è¦æ±‚ï¼Œä½†å› ç‚ºæœ‰åšé timestamp çš„æ‹†åˆ†ï¼Œå°è‡´ Java å¯¦ä½œåœ¨æ¯”å°æ™‚æœƒæœ‰é»å•é¡Œ\nå¯ä»¥è‡ªå·±å®¢è£½åŒ– UUID çš„æ ¼å¼ï¼Œæˆ–ä¹¾è„†è‡ªå‰µï¼Œåƒè€ƒå…¶ä»–å¯¦ä½œå¦‚ Twitter Snowflake(å·² deprecated) æˆ–æ˜¯ Firebase Push IDï¼Œå¤§æŠµä¸Šéƒ½è„«é›¢ä¸äº† timestamp åŠ ä¸Šäº‚æ•¸æˆ–æ˜¯åŠ ä¸Šæ©Ÿå™¨è­˜åˆ¥ç¢¼çš„åšæ³•\nçµè«– ID æ˜¯å¸¸ç”¨çš„å±¬æ€§ï¼Œç”¨ä¾†æŠ½è±¡åŒ–æŒ‡å‘æŸå€‹ç‰©ä»¶/äº‹ä»¶ï¼Œé¸æ“‡æ­£ç¢ºçš„æ–¹å¼ç”¢ç”Ÿ IDï¼Œæ‰ä¸æœƒå°æ–¼ç³»çµ±ç”¢ç”Ÿæ•ˆèƒ½è²§é ¸ï¼Œé€éå­¸ç¿’ UUID çš„å¯¦ä½œéç¨‹ï¼Œçœ‹åˆ°åˆ†æ•£å¼ç”¢ç”Ÿ ID çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯åœ¨å¤§æ•¸æ“šæ™‚ä»£ï¼Œå¿«é€Ÿç”¢ç”Ÿç¨ä¸€(ä¸”éå¢)çš„ ID å°¤ç‚ºåŸºç¤ä¸”é‡è¦ï¼Œè€Œåœ¨ä¹‹ä¸­éš¨æ©Ÿæ€§åœ¨æ•´å€‹éç¨‹æ‰®æ¼”è‘—å¾ˆé—œéµçš„è§’è‰²\n","date":"2020-12-01T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-12-01-uuid-%E5%8E%9F%E7%90%86%E8%88%87%E5%AF%A6%E4%BD%9C%E5%88%86%E6%9E%90-%E8%A9%B2%E5%A6%82%E4%BD%95%E6%8C%91%E9%81%B8%E9%81%A9%E5%90%88%E7%9A%84-uuid-%E7%89%88%E6%9C%AC/","title":"UUID åŸç†èˆ‡å¯¦ä½œåˆ†æ - è©²å¦‚ä½•æŒ‘é¸é©åˆçš„ UUID ç‰ˆæœ¬"},{"content":"è‡ªå·±æ˜¯ä¸€å€‹å–œæ­¡é€éé‹å‹•è³½äº‹å¢æ·»ç”Ÿæ´»è¶£å‘³çš„äººï¼Œä¹Ÿäº«å—è‘—èªè­˜ä¸åŒé‹å‹•çš„é­…åŠ›ï¼Œå¾å…«æœˆåº•è³¼å…¥è‡ªè¡Œè»Šå¾Œï¼Œå°±é–‹å§‹æ‰¾ç›¸é—œçš„è‡ªè¡Œè»Šè³½äº‹ï¼Œæœ€å¾ŒæŒ‘é¸äº†æ™‚é–“é‚„è »å‰›å¥½çš„ç’°èŠ±æ± 365 æŒ‘æˆ°è³½ï¼Œæœ‰å¤§æ¦‚ä¸‰å€‹æœˆèƒ½æº–å‚™ï¼Œæœ‰é»è¶•ä½†å€¼å¾—æ‹¼æ‹¼çœ‹ï¼Œç¶²è·¯ä¸Šçš„åˆ†äº«å¤§å¤šæ˜¯è»Šå‹çš„æ¯”è³½é¨ä¹˜å¿ƒå¾—ï¼Œæ¯”è¼ƒå°‘è¦‹åˆ°å‚™è³½ç›¸é—œçš„ç¶“é©—ï¼Œä»¥åŠèƒ½ä¸èƒ½åœ¨æ²’æœ‰è»ŠéšŠæˆ–è£œçµ¦è»Šçš„æƒ…æ³ä¸‹å®Œæˆæ¯”è³½\nç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä»¥ä¸‹å°‡åˆ†äº«æˆ‘å¾å…«æœˆåº•åˆ°åä¸€æœˆåº•å¦‚ä½•æº–å‚™ï¼Œä»¥åŠæ¯”è³½é€™å…©å¤©çš„å¿ƒè·¯æ­·ç¨‹ï¼Œæœ€å¾Œçµ¦ä¸€äº›æ•´é«”çš„æº–å‚™æ¸…å–®ï¼Œä¹Ÿå¿…é ˆèªªæˆ‘è‡ªå·±é–‹å§‹é¨è‡ªè¡Œè»Šä¹Ÿä¸åˆ°åŠå¹´ï¼Œåˆ†äº«æ¯”è¼ƒé©ç”¨æ–¼è·Ÿæˆ‘ä¸€æ¨£çš„å°ç™½ï¼Œå¦‚æœå°ˆæ¥­çš„è»Šå‹æœ‰ä¸åŒçš„å»ºè­°æˆ–æŒ‡æ•™ï¼Œä¹Ÿéå¸¸æ­¡è¿ç•™è¨€\näº‹å‰æº–å‚™ é™¤äº†è‡ªè¡Œè»Šä¹‹å¤–ï¼Œæœ‰å¹¾é …æ±è¥¿è¦ºå¾—è¦ç·´è»Šæ‡‰è©²è¦æº–å‚™çš„\n1. è»ŠéŒ¶ï¼‹è¸é »ï¼‹å¿ƒç‡æ„Ÿæ¸¬ï¼š ä¸€é–‹å§‹æˆ‘æ˜¯ç”¨æ‰‹æ©Ÿé–‹ Strava ç´€éŒ„ï¼Œä½†çœŸå¿ƒå»ºè­°è¦èªçœŸç·´é‚„æ˜¯æº–å‚™è»ŠéŒ¶ï¼Œåƒæˆ‘è‡ªå·±ç”¨ Bryton 320 è¦ºå¾—çºŒèˆªé” 30 å€‹å°æ™‚çœŸå¾ˆæ–¹ä¾¿ï¼Œä¹Ÿä¸ç”¨å¿ƒç–¼æ‰‹æ©Ÿä¸€è·¯éœ‡å‹•æ€•å£æ‰ï¼›\nè¸é »çš„æ¨è–¦æ˜¯å› ç‚ºä¸€é–‹å§‹é¨è»ŠæŠ“ä¸åˆ°æ„Ÿè¦ºï¼Œçœ‹ç¶²è·¯æ•™å­¸å»ºè­°ç¶­æŒåœ¨ 100 ä»¥ä¸Šçš„è¸é »ï¼Œé¿å…å‚·è†è“‹ï¼›\nå¿ƒç‡å¸¶æ˜¯å› ç‚ºè€åŠ›é‹å‹•æœ€å¥½æ˜¯ç¶­æŒåœ¨æœ€å¤§å¿ƒç‡çš„ 70% ä¸Šä¸‹ï¼Œæœ€å¤§å¿ƒç‡çš„å…¬å¼ç´„ç‚º 206.9 - (0.67 x å¹´é½¡)ï¼Œåƒæˆ‘è‡ªå·±æ˜¯æŠ“ 150ï¼Œå¹³å¸¸ç·´ç¿’å°±ç›¡é‡ç¶­æŒï¼Œæœ€å¤§ä¸è¦è¶…é 165 é¿å…å¤ªæ—©çˆ†æ‰åè€Œæ’ä¸ä¹…ï¼Œæˆ‘è¦ºå¾—ç·´ç¿’äº†ä¸€é™£å­å¿ƒç‡å¸¶æ¯”è¸é »æ›´é‡è¦ è²·ä¸€å¥— Bryon 3000å…ƒä¸Šä¸‹å°±å¾ˆå¤ ç”¨äº†\n2.è»Šè¡£ã€è»Šè¤² ä¸€é–‹å§‹æœ‰ç©¿éä¾¿å®œçš„è»Šè¤²ï¼Œé¨æ²’å¤šä¹…å±è‚¡å°±æœƒéº»éº»çš„ï¼Œè²·äº† Monton è»Šè¤²è¦ºå¾—èˆ’é©å¾ˆå¤šï¼Œå¦‚æœé¨äº†ä¸èˆ’é©æœƒå½±éŸ¿é¨ä¹˜çš„æ„é¡˜ï¼Œå°±æ›´åˆ¥èªªè¦æ¯”è³½äº†ï¼Œä¸€ä»¶ç´„ 2000 å…ƒé‚„ç®—è »å€¼å¾—çš„ è»Šè¡£çš„éƒ¨åˆ†ï¼Œæˆ‘å¹³å¸¸ä¹Ÿæœƒç©¿ä¸€èˆ¬çš„æ’æ±—è¡«ï¼Œä½†å°ˆé–€çš„è»Šè¡£æœ€å¤§ç‰¹é»åœ¨å¾Œæ–¹æœ‰å£è¢‹ï¼Œè¦è£œçµ¦å°±éå¸¸æ–¹ä¾¿ï¼Œæ¯”è³½çš„æ™‚å€™å¾ˆå¥½ç”¨ï¼Œä¹Ÿè »æ¨è–¦\n3.é˜²é›¨å¤–å¥— é€™æˆ‘å€‹äººæ²’æœ‰è²·ï¼Œä½†çœŸå¿ƒè¦ºå¾—æ‡‰è©²è¦è²·ï¼Œå› ç‚ºæ¯”è³½å…©å¤©éƒ½ä¸‹é›¨ï¼Œæœ‰é˜²é¢¨é˜²é›¨çš„å¤–å¥—æœƒè®“é¨ä¹˜æ›´åŠ èˆ’é©å®‰å…¨ï¼Œè€Œä¸”æ—©ä¸Šå…­é»å‡ºç™¼é‚„å¾ˆå†·ï¼Œæ²¿é€”çš„è»Šå‹äº”æˆä»¥ä¸Šéƒ½æœ‰è²·\n4. èƒ½é‡è†  ä¸€é–‹å§‹æ˜¯å› ç‚ºå¹³æ—¥ç·´ç¿’åˆ°ä¸€åŠæœƒè‚šå­é¤“æ‰å˜—è©¦è³¼è²·ï¼Œä½†ç™¼ç¾çœŸçš„å¾ˆå¥½ç”¨ï¼Œç”šè‡³å¯ä»¥èªªæ˜¯å¿…å‚™çš„ç”¨å“ï¼Œæˆ‘æ˜¯è²· SIS èƒ½é‡è† ï¼Œå£å‘³æ²’é€™éº¼ç”œä¸»æ‰“å¯ä»¥ç›´æ¥åƒä¸ç”¨é…æ°´ / GU çš„æˆ‘ä¹Ÿæœ‰è²·ï¼Œé™¤äº†å•¤é…’å£å‘³è¶…é›·å…¶ä»–çš„éƒ½ä¸éŒ¯ï¼Œä»–æ¯” SIS æ›´æ¿ƒï¼Œé‡é‡åªæœ‰ä¸€åŠä½†æä¾›ç›¸åŒçš„ç†±é‡ï¼Œéœ€è¦é…ä¸€å£æ°´ åŸºæœ¬ä¸Šæˆ‘å¹³å¸¸ç·´ç¿’å¸¶ä¸€åŒ…ï¼Œé¨ä¹˜ç´„ 40 ~ 50 åˆ†é˜åƒä¸€åŒ…ï¼Œæ¯”è³½æ™‚èº«ä¸Šå¸¶ 5~6 åŒ…å‚™ç”¨\nå‚™è³½ å…«æœˆåº•é–‹å§‹ï¼Œæ¯é€±è‡³å°‘é¨ä¸‰æ¬¡ï¼Œå…©æ¬¡æŒ‘å¹³æ—¥æ—©ä¸Šï¼Œå¾ä¸‰é‡æ²¿æ²³æ¿±ä¾†å›å—æ¸¯ç´„ 60 å…¬é‡Œï¼Œç´„ 2å°æ™‚å‡ºé ­å®Œæˆ å‡æ—¥æŒ‘ä¸€å¤©é¨é•·è·é›¢ï¼Œæœ‰é¨éä¸‰é‡ç¿»éé¢¨æ«ƒå˜´ä¾†å›é‡‘å±±(ç´„85å…¬é‡Œä½†è »å¤šå±±è·¯)ã€ä¸‰é‡å»¶æ²³æ¿±å¾€æ·¡æ°´åˆ°çŸ³é–€å†æŠ˜è¿”(å¹³è·¯ç¸½è¨ˆç´„100å…¬é‡Œ)ï¼Œé€£çºŒé¨ä¹˜æ™‚é–“éƒ½åœ¨äº”å€‹å°æ™‚å·¦å³\nè‡ªå·±é¨ä¹˜çš„å¯¦åŠ›å¤§æ¦‚æ˜¯å¾æ¥“æ—æ©‹ä¸Šé¢¨æ«ƒå˜´33åˆ†ï¼Œçœ‹ Strava ç®—è »ä¸€èˆ¬çš„æˆç¸¾ï¼Œå°±æä¾›çµ¦å¤§å®¶åƒè€ƒï¼Œä¸éä»¥ä¸Šçš„ç·´ç¿’ä¸å¤ªå¤ ï¼Œæ¨ä¼°å¯èƒ½ä¸€é€±ç·´ 250 å…¬é‡Œï¼ŒæŒçºŒå››å€‹æœˆå‚™è³½æœƒè®“æ¯”è³½å¥½éä¸€äº›\näº¤é€šèˆ‡ä½å®¿ å› ç‚ºæ²’æœ‰éšŠè»Šï¼Œæ‰€ä»¥è¦è‡ªå·±æƒ³è¾¦æ³•åˆ°èŠ±è“®ï¼Œæˆ‘å¾Œä¾†é¸æ“‡æ­ç«è»Šåˆ°èŠ±è“®ï¼Œåˆ°äº†ç•¶åœ°åœ¨ç§Ÿæ±½æ©Ÿè»Šä»£æ­¥ï¼Œåœ¨ç¶²è·¯ä¸Šè²·ä¸€å€‹ 500 å…ƒçš„æ”œè»Šè¢‹ï¼Œæ‹†é™¤å‰å¾Œè¼ªå°±å¯ä»¥ä¸Šè·¯ï¼Œéç¨‹æ¯”æƒ³åƒä¸­ç°¡å–®ï¼ŒåŒ…å¥½çš„è…³è¸è»Šå°±ç®—æ˜¯ä¸€èˆ¬çš„è¡Œæï¼Œæ²’æœ‰å…¶ä»–çš„ç­æ¬¡é™åˆ¶ï¼Œé™¤éæ˜¯æ²’æœ‰æ‹†çš„æ‰è¦ç‰¹åˆ¥æ‰¾å°ˆé–€åˆ—è»Šå–”\nä½å®¿éƒ¨åˆ†èŠ±è“®ç«™çš„èµ·é»åœ¨äºå£«éƒ½é£¯åº—ï¼Œé›¢èŠ±è“®ç«è»Šç«™ä¸é ï¼Œå»ºè­°ä½å¸‚å€å°±å¥½ï¼Œé¤é£²è§£æ±ºä¹Ÿæ¯”è¼ƒæ–¹ä¾¿ï¼›\nå°æ±çš„èµ·é»åœ¨å¨œè·¯å½é£¯åº—ï¼Œä¸å¾—ä¸èªªæˆ‘ä¸€é–‹å§‹ä»¥ç‚ºä¹Ÿåœ¨å°æ±ç«è»Šç«™é™„è¿‘ï¼Œçµæœç›¸å·®è¶…é  XD è€Œä¸”å°æ±ç«è»Šç«™é™„è¿‘æ²’ä»€éº¼æ±è¥¿ï¼Œé›¢å¸‚å€é‚„æœ‰ä¸€å°æ®µè·é›¢ï¼Œå°±ä¸å¤ªå»ºè­°ä½åœ¨å°æ±ç«è»Šç«™é™„è¿‘ï¼Œå› ç‚ºç¬¬ä¸€å¤©æ¯”è³½æ¯”å®Œè¦å›æ°‘å®¿ï¼Œé¨å¤ªé è…³è¶…ç´šé…¸ï¼Œé‚„è¦å†å‡ºä¾†è¦“é£ŸçœŸçš„ç´¯ OTZ\nå¦å¤–å°æ±ä½å®¿å»ºè­°å•ä¸€ä¸‹èƒ½ä¸èƒ½æ²–æ´—è‡ªè¡Œè»Šï¼Œç¬¬ä¸€å¤©æ¯”å®Œè»Šå­æ‡‰è©²éƒ½è »é«’ï¼Œæˆ‘æœ‰æº–å‚™æ¸…æ½”ç”¨å“ï¼Œæ´—ä¹¾æ·¨é‡æ–°ä¸Šæ²¹è¿æ¥ç¬¬äºŒå¤©çš„æŒ‘æˆ°\næ¯”è³½å…©æ—¥ æŠ±è‘—å¿å¿‘çš„å¿ƒï¼Œå› ç‚ºè‡ªå·±ä¹Ÿæ²’æœ‰çœŸçš„é¨ä¹˜è¶…é 150 å…¬é‡Œçš„ç¶“é©—ï¼Œåœ¨æ²’æœ‰è»ŠéšŠã€è£œçµ¦è»Šï¼Œç”šè‡³é‚„ä¸æœƒè£œèƒ(åªæœ‰å¸¶å·¥å…·ä¸¦éš¨æ™‚æº–å‚™çœ‹ Youtube æ•™å­¸XD)çš„ç‹€æ³ä¸‹ï¼Œè‡ªå·±çœŸçš„èƒ½å®Œè³½å—ï¼Ÿ\nç’°èŠ±æ± 365 æœ‰åˆ†è‡ªè¡Œè»Šè³½è·ŸæŒ‘æˆ°è³½ï¼Œè¦è¨˜å¾—å ±åæŒ‘æˆ°è³½å–”ï¼Œç•¶åˆä¸€ç›´çœ‹æƒ³èªªæ€éº¼è·¯ç·šä¸ä¸€æ¨£ï¼Œæ‰ç™¼ç¾è‡ªè¡Œè»Šè³½æ˜¯å°ˆæ¥­åœ¨æ¯”çš„ï¼Œä¸è¦ææ··å›‰\næ¯”è³½å‰ä¸€å¤©æœƒå»äºå£«éƒ½é£¯åº—å ±åˆ°ï¼Œä¸‹åˆäº”é»æœƒæœ‰èªªæ˜æœƒï¼Œç°¡å–®è‡´è©èˆ‡èªªæ˜äº¤é€šè·¯æ³\n11/28 ç¬¬ä¸€å¤©: èŠ±è“®åˆ°å°æ± å…­é»å¾èŠ±è“®äºå£«éƒ½é£¯åº—ï¼Œæ²¿è‘—æµ·å²¸èµ°å° 11 ç·šä¸€è·¯æ®ºåˆ°å°æ±ï¼Œé€”ä¸­æœƒç¿»éæµ·æ‹”å…©ç™¾çš„ç‰›å±±ï¼Œæ¥è‘—å°±ä¸Šä¸Šä¸‹ä¸‹çš„ä¸˜é™µåœ°ï¼Œæ“šèªªä»¥å¾€çš„ç’°èŠ±æ±éƒ½åœ¨å››æœˆèˆ‰è¾¦ï¼Œä»Šå¹´å› ç‚ºç–«æƒ…å»¶åˆ°åä¸€æœˆï¼Œé †è‘—æ±åŒ—å­£é¢¨ä¸€è·¯å¾€å—æ®ºï¼Œä¸€é–‹è³½çœ‹è‘—å¤§å®¶å¹³è·¯æ™‚é€Ÿéƒ½é£† 40 å…¬é‡Œï¼Œå®³æˆ‘ä¹Ÿè·Ÿè‘—è¡ï¼Œçœ‹åˆ°å¿ƒç‡é‚„ç¶­æŒåœ¨ 150 å·¦å³ï¼Œæ‰ç™¼ç¾å¼·å‹çš„å­£é¢¨çœŸçš„å¾ˆçµ¦åŠ›\nä¸€è·¯ä¸Šè·¯æ³éƒ½ä¸éŒ¯ï¼Œæ±½è»Šä¹Ÿä¸ç®—å¤šï¼Œè »å¤šè·¯æ®µéƒ½æœ‰æ©Ÿæ…¢è»Šé“æ‰€ä»¥é¨ä¹˜è »é †æš¢ï¼Œåœ¨ 60 å…¬é‡Œè™•é–‹å§‹ä¸‹é›¨ï¼Œç„¡å¥ˆè‡ªå·±æ²’æœ‰é›¨è¡£ï¼Œå°±é ‚è‘—é›¨ç¹¼çºŒè¡ï¼Œåˆ°äº† 80 å…¬é‡Œè™•åƒåˆé¤ï¼Œæ­¤æ™‚æ‰æ—©ä¸Šä¹é»ï¼Œé æ¯”é æœŸçš„å¿«\nåƒé£½å¾Œç¹¼çºŒæ·‹é›¨ï¼Œåœ¨é †é¢¨çš„æƒ…æ³ä¸‹ï¼Œå¤§å®¶éƒ½ä¸‰å…©æˆç¾¤çš„é¨ï¼Œå› ç‚ºç¬¬ä¸€å¤©é«”èƒ½å……æ²›ï¼Œåˆæœ‰æ·‹é›¨æ€•èº«é«”å†·æ‰æ‰€ä»¥æ¯ä¸€ç«™éƒ½æœ‰é€²è£œçµ¦ï¼Œä½†åƒä¸€åƒä¸Šå€‹å»æ‰€å°±è¶•å¿«ç¹¼çºŒé¨ï¼Œå»ºè­°å¯ä»¥åœ¨è£œçµ¦ç«™å¸¶ä¸€å¡Šé¦™è•‰åœ¨èº«ä¸Šåƒï¼Œæˆ‘è‡ªå·±çš„è£œçµ¦ç­–ç•¥æ˜¯ æ¯å€‹è£œçµ¦ç«™éƒ½é€²ï¼Œè·¯ä¸Šé¨ä¹˜ç´„ 50åˆ†é˜åƒä¸€åŒ…èƒ½é‡è† ï¼Œè·¯ä¸Šæœ‰è»Šå°±è·Ÿï¼Œä¹Ÿä¸ç”¨ä¸å¥½æ„æ€å°±è¹­åœ¨å¾Œé¢ï¼Œä¿æŒå®‰å…¨è»Šè·ï¼›\nè·Ÿè»Šæ™‚é€Ÿåº¦å¿«å¯ä»¥æ›å¤§ç›¤ï¼Œè¸©å€‹å¹¾ä¸‹å¾Œä¼‘æ¯ï¼Œä¸è¦ç”¨è¼•é½’æ¯”ç‹‚è¸©ï¼Œä¿æŒè»Šè·ä¸æ‹‰è¶…éä¸‰å€‹è»Šèº«å³å¯ï¼Œè¦æŠ“ç·Šä¼‘æ¯çš„ç¯€å¥ï¼Œé€™æ˜¯å¥½å¿ƒçš„å¤§å“¥è·¯éæ•™æˆ‘çš„ï¼Œé€™æ¨£è¼•é¬†äº†è¨±å¤š\nå‰é¢è…³éƒ½æ²’ä»€éº¼å•é¡Œï¼Œå¤§æ¦‚ä¸€è·¯åˆ° 130 å…¬é‡Œè™•å¤©æ°£æ”¾æ™´ï¼Œä½†å¤§è…¿ä¹Ÿé–‹å§‹æœ‰ç–²å‹æ€§ç— ç—›ï¼Œä¸€è·¯ä¸Šç¨æ¨æ™‚å°±æ”¾æ…¢é€Ÿåº¦ï¼Œç­‰åˆ°æœ‰å·®ä¸å¤šæ™‚é€Ÿçš„é›†åœ˜å‡ºç¾å°±è·Ÿä¸Šï¼Œè·Ÿåˆ°ä¸è¡Œåœ¨æ”¾æ‰ä¼‘æ¯ï¼Œä¸€è·¯é€™æ¨£åˆ°çµ‚é»ï¼Œå®Œæˆç¬¬ä¸€å¤©çš„ 170 å…¬é‡Œï¼Œç¸½å®Œè³½æ™‚é–“ç´„å…­å€‹åŠå°æ™‚\nä¸å¾—ä¸èªªä¸€è·¯ä¸Šå¤§å®¶éƒ½å¾ˆæ‹¼ï¼Œä¸‹å¤§é›¨ä¸‹å¡ç…§æ¨£é£† 4,50 æ²’åœ¨æ€•çš„ XD\næœ€å¾Œæˆç¸¾æ˜¯ 209 / 1395ï¼Œæ¯”é æœŸçš„å¥½ :P\n11/29 ç¬¬äºŒå¤©: å°æ±åˆ°èŠ±è“® ç¬¬ä¸€å¤©çš„æ¯”è³½éç¨±å ªç¨±çˆ½å¿«ï¼Œæœ‰é †é¢¨å¯ä»¥é£†ï¼Œå¾Œæ®µä¹Ÿæœ‰å…‹æœç— ç—›çš„æ„å¿—éç¨‹ï¼Œä½†ç¬¬äºŒå¤©çš„æ¯”è³½å°±çœŸçš„æ˜¯é€²å…¥åœ°ç„äº†ï¼Œåœ¨ä¸€é–‹å§‹ç†±èº«æ®µèº«é«”é‚„å¸¶è‘—æ˜¨å¤©çš„ç–²å‹ï¼Œè†è“‹èˆ‡å°è…¿é‚„æœ‰é»ç·Šç¹ƒçš„ç— ç–¼æ„Ÿï¼Œé€™æ‰ä¸åˆ° 1/10 çš„è·¯æ®µå•Šï¼Œå’¬è‘—ç‰™å‘Šè¨´è‡ªå·±å¤šæ’ä¸€æ®µåœ¨æ”¾æ£„ä¹Ÿä¸é²\né¢¨ç¥åªçœ·é¡§äº†æ˜¨å¤©ï¼Œä»Šå¤©å›ç¨‹è½‰è®Šæˆå¤§é€†é¢¨ï¼Œä¸åŒæ–¼æ˜¨å¤©ä¸‰å…©æˆç¾¤ï¼Œé€™ä¸€å¤©å¤§å®¶ä¹–ä¹–æ’æˆä¸€ç›´ç·šï¼Œç”±å‹‡è€…ç ´é¢¨å¸¶é ˜å¤§å®¶å‰è¡Œï¼Œè™•æ–¼éšŠä¼ä¸­å¤®çœŸçš„çœåŠ›éå¸¸å¤šï¼Œè·¯ä¸Šè»Šå‹ä¹Ÿéƒ½å¾ˆå®¢æ°£ï¼Œè¦æ’å…¥éšŠä¼æ¯”å€‹æ‰‹å‹¢å¤§å®¶éƒ½å¾ˆæ¨‚æ„äº’åŠ©\nè·Ÿåˆ°ä¸è¡Œå°±æ…¢æ…¢ç¨æ¨ï¼Œç­‰ä¸‹ä¸€æ³¢é›†åœ˜å†ç¹¼çºŒè·Ÿï¼Œä½†é€™ä¸€å¤©çš„ç‹€æ³æ¯”ç¬¬ä¸€å¤©ç³Ÿï¼Œæº«åº¦ä¸‹é™äº†å…©åº¦ï¼ŒåŒæ¨£é£„é›¨ï¼Œåªæ˜¯åŠ ä¸Šç¬¬ä¸€å¤©çš„ç–²æ†Šï¼Œå¾Œä¾†æ±ºå®šé™¤äº†è£œçµ¦ç«™ï¼Œé‡åˆ° 7-11 ä¹Ÿé€²å»åä¸€ä¸‹åƒå€‹å·§å…‹åŠ›è£œä¸€è£œï¼Œå¤§æ¦‚æ¯ 10 å…¬é‡Œå°±æœƒè‚šå­é¤“äº†ï¼Œä¸åƒç¬¬ä¸€å¤©æ€¥è‘—æƒ³è¦å®Œè³½ï¼Œç¬¬äºŒå¤©å°±åªæœ‰èƒ½å¤ å®Œè³½å°±æ˜¯è‹±é›„çš„å¿µé ­XD\nå›å»çš„è·¯ç·šå¤§å¤šèµ°å°9ç·šï¼Œé¨åœ¨èŠ±æ±ç¸±è°·ä¸Šçœ‹è‘—å…©å²¸çš„å±±è„ˆä¹Ÿæ˜¯é —æœ‰è¶£ï¼Œå‰æœŸè¦å…ˆä¸Šé¹¿é‡é«˜å°å†å¾€ä¸‹æºœï¼Œæ¥è‘—åˆ°ç‘ç©—çˆ¬ä¸€å€‹é™¡å¡åˆ°åŒ—å›æ­¸ç·šæ™¯é»åƒè£œçµ¦ï¼Œæ¥è‘—å°±ç¹¼çºŒä¸Šä¸Šä¸‹ä¸‹çš„ä¸˜é™µè·¯æ®µå›èŠ±è“®å¸‚å€\nå°å°æŠ±æ€¨ä¸€ä¸‹é€™ä¸€å¤©åˆé¤å®‰æ’åœ¨ 125 å…¬é‡Œè™•ï¼Œåœ¨åŠ æ²¹ç«™æ—é‚Šè‡¨æ™‚æ­æ£šå­ï¼Œä½†å› ç‚ºä¸‹é›¨ï¼Œæ’éšŠç­‰è‘—é ˜ç‚’éºµæ™‚é‚„è¦æ·‹é›¨ï¼Œæ„Ÿè¦ºæœ‰é»ä¸å¥½\nå …æŒäº†å…«å€‹å°æ™‚å¤šæ‰å®Œæˆæ¯”è³½ï¼Œå¯æƒœè»ŠéŒ¶åˆ°å¾Œé¢ç•¶æ©Ÿæ²’æœ‰å®Œæ•´è¨˜éŒ„åˆ° QQ æœ€çµ‚æˆç¸¾æ˜¯ 439 / 1206ï¼Œç¬¬äºŒå¤©æ²’åŠ›æœç„¶æ‰å¾ˆå¤š XD\nå¾Œä¾†å¥³å‹æ­ä¸Šç«è»Šï¼Œçœ‹åˆ°æœ‰ä¸€äº›è»Šå‹ä¸Šç«è»Šåå€‹å¹¾ç«™å†ç¹¼çºŒé¨ï¼Œæœƒè¦ºå¾—å¥½åƒæ€ªæ€ªçš„ï¼Œä½†æˆ‘è¦ºå¾—å¦‚æœèº«é«”æ’ä¸ä½ï¼Œé€™æ¨£å€’ä¹Ÿæ˜¯å€‹åšæ³•ï¼Œç„¡é—œä¹æ¯…åŠ›æˆ–æ˜¯é¬¥å¿—ç­‰ç­‰ï¼Œé¡§åŠåˆ°è‡ªå·±çš„ç”Ÿå‘½ï¼Œç›¡å¯èƒ½åœ°åšåˆ°æœ€å¥½å°±å¥½ï¼ŒæŒ‘æˆ°è³½æœ¬ä¾†å°±æ„åœ¨è¶…è¶Šè‡ªå·±ï¼Œè‡´æ•¬æ‰€æœ‰å®Œè³½çš„è»Šå‹å€‘ï¼Œä¹Ÿæ…¶å¹¸è‡ªå·±ä¸€è·¯å¹³å®‰çš„å®Œè³½\nçµèª å¦‚æœèƒ½æœ‰è»ŠéšŠçœŸçš„å¾ˆä¸éŒ¯ï¼Œçœ‹åˆ°æ²¿è·¯å¤§è»ŠéšŠéƒ½æœ‰æ»¿æ»¿çš„è£œçµ¦è»Šï¼ŒçœŸçš„å¥½æ£’å•Šï¼Œå› ç‚ºå¤§æœƒå®‰æ’çš„è£œçµ¦é»æœ‰æ™‚å€™è·é›¢ä¸ç­‰æœ‰é»é ­ç–¼ï¼›\næ²¿è·¯é‚„æœ‰èªè­˜çš„è»Šå‹äº’ç›¸åŠ æ²¹æ‰“æ°£æ˜¯ä¸€ä»¶å¾ˆæ£’çš„äº‹ï¼Œä½†é€™ä¹Ÿä¸ä»£è¡¨ä¸€å€‹äººå°±ç„¡æ³•åƒåŠ ï¼Œå¤§æœƒåå†Šä¸Šç´„æœ‰ 1600 äººå ±åï¼Œå…¶ä¸­ç´„æœ‰å…©ä¸‰ç™¾äººä¹Ÿéƒ½æ˜¯å€‹äººèº«ä»½ï¼Œè‡ªå·±ä¹Ÿåœ¨é€™æ¨£çš„ç‹€æ³ä¸‹å®Œè³½ï¼Œå¸Œæœ›åˆ†äº«èƒ½å¤ çµ¦å…¶ä»–æƒ³åƒåŠ æ¯”è³½çš„è»Šå‹ä¸€äº›åƒè€ƒ\n","date":"2020-11-30T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-11-30-%E7%92%B0%E8%8A%B1%E6%9D%B1365%E6%8C%91%E6%88%B0%E8%B3%BD%E5%88%86%E4%BA%AB-%E5%A6%82%E4%BD%95%E4%B8%80%E4%BA%BA%E5%82%99%E8%B3%BD%E8%88%87%E6%AF%94%E8%B3%BD%E9%81%8E%E7%A8%8B/","title":"ç’°èŠ±æ±365æŒ‘æˆ°è³½åˆ†äº«-å¦‚ä½•ä¸€äººå‚™è³½èˆ‡æ¯”è³½éç¨‹"},{"content":"åœ¨ç³»çµ±è¨­è¨ˆä¸­ï¼Œæˆ‘å€‘å¸¸å¸¸éœ€è¦æª¢è¦–æŸä¸€å€‹å€¼æ˜¯å¦å‡ºç¾éï¼Œä¾‹å¦‚éŠæˆ²ä¸­ç”¨æˆ¶ ID æ˜¯å¦å·²ç¶“è¨»å†Šéç­‰ç­‰ï¼Œå¦‚æœæŠŠæ¯å€‹ ID éƒ½å­˜æˆä¸€å¼µè¡¨æ¯æ¬¡å»æª¢è¦–ï¼Œæœƒéœ€è¦å¾ˆå¤§é‡çš„è¨˜æ†¶é«” ( ID å¤§å° * ID æ•¸é‡)ï¼Œå¦‚æœæ˜¯åƒ Google é€™é¡æœ‰ä¸Šå„„çš„ç”¨æˆ¶ï¼Œå…‰æ˜¯å¸³è™Ÿé‡è¤‡æª¢æŸ¥å¯èƒ½å°±éœ€è¦ 1,20 GB çš„è¨˜æ†¶é«”ç©ºé–“ï¼›\nä»¥ä¸‹å°‡ä»‹ç´¹ï¼ŒBloom Filter ç‚ºä»€éº¼å¯ä»¥çŠ§ç‰²ä¸€é»æº–ç¢ºæ€§å°±èƒ½ç¯€çœå¤§é‡çš„ç©ºé–“\nåŸç† Bloom Filter åŸç†å…¶å¯¦å¾ˆç°¡å–®ï¼Œç”¢ç”Ÿä¸€å€‹é™£åˆ—ï¼Œç”¨ bit ä»£è¡¨è©²å…ƒç´ æ˜¯å¦å‡ºç¾éï¼Œé€é Hash function å°‡è¼¸å…¥å°ˆæ›æˆé™£åˆ—ä½ç½®ï¼Œè—‰æ­¤æ¨™è¨˜èˆ‡æŸ¥è©¢æ˜¯å¦å…ƒç´ å‡ºç¾é\nå› ç‚º Hash æœƒæœ‰ç¢°æ’å•é¡Œï¼Œæ‰€ä»¥æœƒæœ‰ False Positive ä½†ä¸æœƒæœ‰ False Negative æ„å³ Bloom Filter å›ç­”å…ƒç´ å·²å­˜åœ¨ä½†å¯¦éš›ä¸Šæ²’æœ‰å­˜åœ¨ï¼Œ Bloom Filter å›ç­”ä¸å­˜åœ¨å‰‡ä¸€å®šä¸å­˜åœ¨\nåŸç†å¾ˆå¥½æ‡‚ï¼Œä½†è¤‡é›œçš„æ˜¯é™£åˆ—è¦å¤šå¤§? è¦é¸å¹¾ç¨® Hash æ‰èƒ½å¹³è¡¡è¨˜æ†¶é«”ç”¨é‡ä»¥åŠé¿å… False Positive çš„éŒ¯ï¼Œé€™ä¸€å€‹éƒ¨è½æ ¼ç”¨æ•¸å­¸è­‰æ˜ Bloom Filters - the math\nå‡è¨­æˆ‘å€‘æ±ºå®šç”¨ä¸€å€‹é•·åº¦ç‚º m çš„é™£åˆ—ï¼Œé™£åˆ—çš„å…ƒç´ æ˜¯ä¸€å€‹ bit è¡¨ç¤ºè©²éµå€¼å·²å‡ºç¾é ç•¶ä»Šå¤©å¢åŠ éµå€¼æ™‚ï¼Œç¶“é Hash æœƒéš¨æ©Ÿåˆ†é…é™£åˆ—ä¸­çš„ä¸€å€‹ä½ç½®çµ¦è©²éµå€¼ï¼Œæ›å¥è©±èªªé™£åˆ—çš„æŸå€‹ä½ç½®è¢«æ’å…¥çš„å¯èƒ½æ€§æ˜¯ 1/m ä»Šå¤©å‡è¨­æ’å…¥äº†ä¸€å€‹éµå€¼ï¼Œé‚£ç¬¬äºŒå€‹éµå€¼èˆ‡ç¬¬ä¸€å€‹éµå€¼ç¢°æ’çš„æ©Ÿç‡æ˜¯ 1/m (å¥½æ­»ä¸æ­»åˆ†é…åˆ°åŒä¸€å€‹é™£åˆ—)ï¼Œä¹Ÿå°±ä»£è¡¨ä¸æœƒç¢°æ’çš„æ©Ÿç‡æ˜¯ 1 - 1/m ä»Šå¤©å‡è¨­æ’å…¥äº†å…©å€‹éµå€¼ï¼Œé‚£ç¬¬ä¸‰å€‹éµå€¼ä¸æœƒç¢°æ’çš„æ©Ÿç‡æ˜¯ (1 - 1/m)^2ï¼Œå¦‚æœæ’å…¥äº† n å€‹éµå€¼ï¼Œé‚£ç¬¬ n + 1 å€‹ä¸æœƒç¢°æ’çš„æ©Ÿç‡æ˜¯ (1 - 1/m)^n ä»¥ä¸Šæ˜¯ Hash æ•¸é‡ç‚º 1 çš„æƒ…æ³ï¼Œæ¥ä¸‹ä¾†è€ƒé‡ç¨ç«‹ Hash ç‚º k çš„æƒ…æ³\nå› ç‚º Hash æ•¸é‡ç‚º k ï¼Œæ‰€ä»¥æ¯ä¸€è¼ªé™£åˆ—æœƒæœ‰è‡³å¤š k å€‹ä½ç½®è¢«æ¨™è¨˜æˆ 1ï¼Œéœ€æ³¨æ„ Hash ä¹‹é–“ä¹Ÿå¯èƒ½æ¨™è¨˜åˆ°åŒä¸€å€‹ä½ç½®ï¼Œæ‰€ä»¥åœ¨æ©Ÿç‡ä¸Šæ˜¯ç¨ç«‹äº‹ä»¶ï¼Œæ‰€ä»¥æ˜¯æŸä½ç½®åœ¨æ’å…¥å¾Œä¸æœƒè¢«é¸ä¸­çš„æ©Ÿç‡æ˜¯ (1-1/m)^kï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡ Hash å¾Œçš„å€¼éƒ½æ²’æœ‰é¸åˆ°ä»– æ‰€ä»¥æ’å…¥ n å€‹éµå€¼å¾Œï¼Œç¬¬ n + 1 å€‹ä¸æœƒç”¢ç”Ÿç¢°æ’çš„æ©Ÿç‡æ˜¯ (1-1/m)^(k*n) æ›ç®—ä¸€ä¸‹ï¼Œæœƒç”¢ç”Ÿ False Positive çš„æ©Ÿç‡æ˜¯ (1 - (1-1/m)^(k*n))^kï¼Œä¹Ÿå°±æ˜¯ç¬¬ n + 1 å€‹éµå€¼èˆ‡ä»»ä¸€ä¸€æ¬¡ Hash å¾Œç”¢ç”Ÿç¢°æ’çš„æ©Ÿç‡ï¼Œç°¡åŒ–å¾Œå¯ä»¥è®Šæˆ (1 - e ^ (-k*n/m))^k å¾é€™å€‹å…¬å¼å¯ä»¥çœ‹å‡º\nm è¶Šå¤§ï¼ŒFalse Positive çš„æ©Ÿç‡å°±è¶Šå°ï¼Œé€™ä¹Ÿè »ç›´è§€çš„ï¼Œå› ç‚º Hash å¾Œç”¢ç”Ÿçš„ç¢°æ’æ©Ÿç‡è‡ªç„¶å°±è®Šå°ï¼›\nä½†æ˜¯ k çš„å€¼å°±æ¯”è¼ƒæ²’é€™éº¼ç›´è§€ï¼Œä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œä¹Ÿä¸æ˜¯è¶Šå°è¶Šå¥½ï¼Œè€Œæ˜¯åœ¨ m,n åœ¨å°æ‡‰çš„æ¯”ä¾‹ä¸‹ï¼Œæœƒæœ‰ä¸€å€‹æœ€å‰›å¥½çš„å€¼\næˆ‘å€‘å¯ä»¥ç”¨ Bloom Filter Calculator æ‰‹å‹•èª¿æ•´åƒæ•¸ï¼Œå»è©•ä¼°é æœŸçš„ False Positive æ©Ÿç‡èˆ‡æ‰€éœ€è¦è€—è²»çš„è¨˜æ†¶é«”ç©ºé–“ (m çš„å¤§å°)\nåŸºæœ¬ä¸Šï¼Œå¦‚æœ m æ˜¯ n çš„ 10 å€ï¼Œåœ¨é¸æ“‡ 4 å€‹ Hash function ä¸‹ False Positive æ©Ÿç‡ç´„ç‚º 1.2 %ï¼Œå¦‚æœé¸æ“‡ 5 å€‹ Hash function å‰‡æ©Ÿç‡é™ç‚º 0.9 %\nä¸€é–‹å§‹åœ¨æ€è€ƒæ™‚ï¼Œæœƒæƒ³èªªæ˜æ˜å¢åŠ  Hash function çš„æ•¸é‡æ‡‰è©²æœƒå¢åŠ ç¢°æ’æ©Ÿç‡æ‰å°ï¼Œå¾Œä¾†æ‰æƒ³åˆ°å‰ææ˜¯ m \u0026gt;\u0026gt; n çš„æ™‚å€™ï¼Œæœ‰è¶³å¤ çš„å¤šé¤˜ç©ºé–“è®“å¤šå€‹ Hash function çš„æ•´é«”ç¢°æ’æ©Ÿç‡æ›´å°\nè®Šå½¢ - å¢åˆªéµå€¼ å¦‚æœä»Šå¤©è¦åˆªé™¤éµå€¼æ™‚é †ä¾¿æ›´æ–° Bloom Filterï¼Œå°±ä¸èƒ½ç”¨ boolean å„²å­˜ï¼Œè€Œæ˜¯è¦ç”¨ unsigned integerï¼Œå¢åŠ æ™‚ + 1 ç§»é™¤æ™‚ - 1ï¼Œé‚£ integer éœ€è¦ 4 bit / 8 bit é‚„æ˜¯å¤šå°‘å€‹ bit æ‰è¶³å¤ å‘¢ ?!\nåŒä¸€ç¯‡éƒ¨è½æ ¼æ–‡ä¸­ï¼ŒåŒæ¨£æœ‰æ•¸å­¸æ¨å°ï¼Œä½†å› ç‚ºä¸å¤ªäº†è§£å°±å…ˆç•¥éï¼Œæœ€å¾Œçš„çµè«–å¦‚æœ Hash function è¶³å¤ éš¨æ©Ÿçš„è©± 4 bit æ‡‰è©²å·²ç¶“è¶³å¤ ï¼Œä½†éœ€è¦å°å¿ƒå¦‚æœéå¸¸éå¸¸ä¸å¹¸ 4 å€‹ bit ä¸å¤ å„²å­˜ï¼Œæœƒç”¢ç”Ÿ False Negativeï¼Œä¹Ÿå°±æ˜¯ Bloom Filter å›ç­”ä¸å†ä½†å¯¦éš›ä¸Šé‚„æ˜¯å­˜åœ¨çš„ç‹€æ³\nå¯¦ä½œ å¯¦ä½œéƒ¨åˆ†ï¼Œå¯ä»¥æ‹†æˆå…©å€‹æ­¥é©Ÿ\nå¦‚ä½•ç”¢ç”Ÿ k å€‹ç¨ç«‹çš„ Hash Function å¯¦ä½œæ’å…¥èˆ‡æŸ¥è©¢çš„ bitwise æ“ä½œ å¦‚ä½•ç”¢ç”Ÿ k å€‹ç¨ç«‹çš„ Hash Function å¦‚ä½•ç”¢ç”Ÿä¸€å€‹é‹ç®—å¿«é€Ÿã€è¶³å¤ éš¨æ©Ÿä¸” Universal çš„ Hash function æ˜¯éå¸¸é—œéµçš„ä¸€æ­¥ï¼Œå½±éŸ¿å¾ŒçºŒçš„éŒ¯èª¤ç‡ï¼Œé¸æ“‡ç”¨ non-cryptographic hash function å³å¯ï¼Œå¼·åº¦ä¸é«˜ä½†æ˜¯æ€§èƒ½å¤ å¥½ï¼Œå·®åˆ¥åœ¨æ–¼ hash å¾Œè¢«é€†æ¨çš„å¯èƒ½æ€§(æ²’æœ‰å¼·æŠ—ç¢°æ’èˆ‡å¼±æŠ—ç¢°æ’çš„ä¿è­‰)ï¼Œå¯èƒ½æœƒé­é‡ HashDosï¼Œè¢«ç™¼ç¾ç¢°æ’å¾Œå°±ä¸æ–·å˜—è©¦å°è‡´æ€§èƒ½è®Šå·®\nå›æ­¸æ­£é¡Œï¼Œçˆ¬äº†ä¸€äº› Bloom Filter çš„å¯¦ä½œï¼Œæœ‰ç™¼ç¾ä½¿ç”¨ xxHashã€MurMurHash ç­‰å·²çŸ¥çš„ hash function libraryï¼Œé€™ä¸€å€‹å¯¦ä½œè »æœ‰è¶£ bloomfilter.jsï¼ŒHash function æ˜¯å¯¦ä½œ Fowlerâ€“Nollâ€“Vo(FNV) hash functionï¼Œç¨‹å¼ç¢¼å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 function fnv_1a(v, seed) { var a = 2166136261 ^ (seed || 0); for (var i = 0, n = v.length; i \u0026lt; n; ++i) { var c = v.charCodeAt(i), d = c \u0026amp; 0xff00; if (d) a = fnv_multiply(a ^ d \u0026gt;\u0026gt; 8); a = fnv_multiply(a ^ c \u0026amp; 0xff); } return fnv_mix(a); } // a * 16777619 mod 2**32 function fnv_multiply(a) { return a + (a \u0026lt;\u0026lt; 1) + (a \u0026lt;\u0026lt; 4) + (a \u0026lt;\u0026lt; 7) + (a \u0026lt;\u0026lt; 8) + (a \u0026lt;\u0026lt; 24); } // See https://web.archive.org/web/20131019013225/http://home.comcast.net/~bretm/hash/6.html function fnv_mix(a) { a += a \u0026lt;\u0026lt; 13; a ^= a \u0026gt;\u0026gt;\u0026gt; 7; a += a \u0026lt;\u0026lt; 3; a ^= a \u0026gt;\u0026gt;\u0026gt; 17; a += a \u0026lt;\u0026lt; 5; return a \u0026amp; 0xffffffff; } åœ¨ Stack Exchange çœ‹åˆ°æœ‰è¶£çš„å•ç­” Which hashing algorithm is best for uniqueness and speed?ï¼Œæœ‰å¼·è€…æ¯”è¼ƒå¤šç¨® Hash Function çš„æ•ˆèƒ½ä»¥åŠç¢°æ’æ©Ÿç‡ï¼ŒFNV-1a è¡¨ç¾é‚„ä¸éŒ¯ï¼Œä½†ä½œè€…æ¯”è¼ƒæ¨è–¦ Murmur2\næ¥è‘—ï¼Œæœ‰å¦ä¸€ç¯‡è«–æ–‡ Building a Better Bloom Filter è­‰æ˜å¦‚æœè¦ç”¢ç”Ÿå¤šå€‹ Hash function æ‡‰ç”¨åœ¨ Bloom filter ä¸Šï¼Œåªéœ€è¦ç”¢ç”Ÿå…©å€‹ Hash function å†åŠ ä¸Šä¿‚æ•¸çš„çµ„åˆå‡ºå…¶ä»–çš„ Hash function å³å¯\n1 gi(x) = h1(x)+ ih2(x) mod p // p æ˜¯è³ªæ•¸ ç¸½çµ å¦‚æœåŸæœ¬çš„éµå€¼å¾ˆé•·ï¼Œå†å®¹å¿ä¸€å®šçš„ False Positive ä¸‹ä½¿ç”¨ Bloom Filter å¯ä»¥ç¯€çœéå¸¸å¤§é‡çš„å„²å­˜ç©ºé–“ï¼Œä½†éœ€æ³¨æ„ Hash é‹ç®—æœƒå¤šä¸€äº› CPU è³‡æº\n","date":"2020-11-17T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-11-17-sketch-data-structure-bloom-filter-%E4%BB%8B%E7%B4%B9%E8%88%87%E5%AF%A6%E4%BD%9C/","title":"Sketch Data Structure - Bloom Filter ä»‹ç´¹èˆ‡å¯¦ä½œ"},{"content":"å…±è­˜æ¼”ç®—æ³•ä¸»è¦æ‡‰ç”¨æ–¼åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œä¸€å€‹é›†ç¾¤ä¸­æœ‰å¤šå€‹ç¯€é»çµ„æˆï¼Œè®“æ¯å€‹ç¯€é»éƒ½ç¶­è­·ç›¸åŒçš„ç‹€æ…‹ï¼Œä¾‹å¦‚èªªåœ¨å¤šç¨®ç³»çµ±ä¸­éƒ½éœ€è¦é›†ç¾¤æœ‰å–®ä¸€å€‹ Leader å­˜åœ¨ï¼Œæ‰€æœ‰ç¯€é»éƒ½å¿…é ˆæ‰¿èªé€™ä¸€å€‹ Leaderï¼Œå¦å‰‡å¤šå€‹ Leader å¯èƒ½æœƒå°è‡´ Split brain ç­‰è³‡æ–™ä¸ä¸€è‡´ç­‰å•é¡Œï¼›\nä½†å¦‚ä½•è®“ç¯€é»ç‹€æ…‹ä¸€è‡´æ˜¯ä¸€ä»¶ä¸ç°¡å–®çš„äº‹æƒ…ï¼Œè¦è€ƒæ…®åˆ°ç¯€é»å¯èƒ½å¤±æ•— / ç¶²è·¯å°åŒ…å»¶é²ç­‰ç­‰\nRaft æ¼”ç®—æ³•æ˜¯ç”±å²ä¸¹ä½›å¤§å­¸çš„æ•™æˆæ‰€æå‡ºï¼Œä»–åœ¨å½±ç‰‡ä¸­æåˆ°éå¾€çš„å…±è­˜æ¼”ç®—æ³• Paxos éæ–¼è¤‡é›œï¼Œä¸–ç•Œä¸ŠçœŸæ­£äº†è§£çš„äººæ²’æœ‰å¹¾å€‹ï¼Œå¸‚é¢ä¸Šçš„å¯¦ä½œä¹Ÿåˆ†æ­§å‡ºéå¸¸å¤šçš„å¯¦ä½œç‰ˆæœ¬ï¼Œç†è«–å¤ªéè‰±æ·±å°è‡´å¯¦å‹™ä¸Šæœ‰å¾ˆå¤§çš„è½å·®\næ‰€ä»¥ä»–åœ¨è¨­è¨ˆ Raft çš„ä¸€å€‹æ ¸å¿ƒç†å¿µæ˜¯å¥½æ‡‚ï¼Œä»–åœ¨ Conference ä¸Šä¹Ÿåƒ…ç”¨ç´„ 10 åˆ†é˜å°±å¤§è‡´ä»‹ç´¹å®Œ Raft çš„åŸç†ï¼Œæ•´ä»½è«–æ–‡ä¹Ÿæ‰ 16 é \nä»¥ä¸‹å°‡æ•´ç†å½±ç‰‡ä»‹ç´¹èˆ‡è«–æ–‡æ‘˜è¦ï¼Œæ¢è¨ Raft å¦‚ä½•åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­è®“å¤šç¯€é»åœ¨å®¹å¿éŒ¯èª¤ä¸‹é”åˆ°å¼·ä¸€è‡´æ€§\nå½±ç‰‡ä»‹ç´¹ å…ˆå¾åœ¨ Conf ä¸Šçš„ä»‹ç´¹å½±ç‰‡å¿«é€Ÿç†è§£ï¼ŒRaft ç”±ä¸‰å€‹éƒ¨åˆ†çµ„æˆ\nLeader Election:\næ•´å€‹é›†ç¾¤ä¸­ç¥¨é¸å‡ºä¸€ä½ Leader Log Replication:\nLeader è² è²¬æ¥æ”¶ Client çš„æŒ‡ä»¤ï¼Œä¸¦æŠŠç‹€æ…‹åŒæ­¥åˆ°å¤šæ•¸ç¯€é»ä¸Š Safety:\nç•¶ Leader è¦é‡æ–°ç¥¨é¸æ™‚ï¼Œç¢ºä¿æ“æœ‰æœ€æ–°è³‡æ–™çš„ç¯€é»æ‰èƒ½ç•¶ä¸Š Leaderï¼Œé¿å…ç¢ºèªé(commited)çš„è³‡æ–™è¢«å–æ¶ˆ ä»¥ä¸‹å°‡æ‘˜è¦è«–æ–‡ ã€ŠIn Search of an Understandable Consensus Algorithm (Extended Version)ã€‹éƒ¨åˆ†å…§å®¹\nè«–æ–‡æ‘˜è¦ Raft æ˜¯ä¸€ç¨®ç”¨æ–¼ç®¡ç†å‰¯æœ¬ç´€éŒ„çš„å…±è­˜æ¼”ç®—æ³•ï¼Œæ•ˆæœé¡ä¼¼æ–¼ Paxosï¼Œä½†çµæ§‹ä¸Šå®Œå…¨ä¸åŒï¼Œé€™ä¹Ÿä½¿å¾— Raft ç›¸è¼ƒæ–¼ Paxos æ›´å®¹æ˜“äº†è§£\nç‚ºäº†å¢åŠ å¯è®€æ€§ï¼ŒRaft è§£æ§‹å‡ºå¹¾å€‹å…±è­˜æ¼”ç®—æ³•ä¸­é—œéµçš„å…ƒç´ ï¼Œåƒæ˜¯ Leader Election / Log replication / Safetyï¼Œä¸¦é€éæ¸›å°‘ç‹€æ…‹é”åˆ°æ›´å¼·çš„å‡èšæ€§ (æ„æŒ‡ç¯€é»å¯ä»¥è®ŠåŒ–çš„ç‹€æ…‹å°‘ï¼Œå°±æ›´å®¹æ˜“é”åˆ°ä¸€è‡´)\n1. Introduction å…±è­˜æ¼”ç®—æ³• (Consensus) æä¾›ç”±æ©Ÿå™¨çµ„æˆçš„é›†åˆå¯ä»¥é‹ä½œé¡ä¼¼åŒä¸€é«”ä¸¦èƒ½å¤ å®¹å¿éƒ¨åˆ†æˆå“¡å‡ºéŒ¯ï¼Œä¹Ÿé€™æ˜¯é€™äº›ç‰¹æ€§ï¼Œå…±è­˜æ¼”ç®—æ³•åœ¨å»ºæ§‹å¤§å‹è»Ÿé«”ç³»çµ±æ˜¯å¾ˆé—œéµçš„è§’è‰²\nPaxos ä¸»å®°é€™ä¸€å¡Šè¿‘åå¹´ï¼Œä½†ä¸å¹¸çš„æ˜¯ Paxos å¾ˆé›£æ‡‚ï¼ŒåŒæ™‚åœ¨å¯¦å‹™ä¸Šéœ€è¦æœ‰å¾ˆè² è²¬çš„è¨­è¨ˆæ‰èƒ½å¤ ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸è«–æ˜¯å­¸ç”Ÿé‚„æ˜¯ç³»çµ±å·¥ç¨‹å¸«éƒ½ååˆ†å›°æ“¾\næ‰€ä»¥ä½œè€…é–‹å§‹æƒ³è¦è¨­è¨ˆä¸€é–€è¶³å¤ å¥½ç†è§£ã€åŒæ™‚å°æ–¼ç³»çµ±å·¥ç¨‹å¸«ä¹Ÿå®¹æ˜“å¯¦è¸çš„å…±è­˜æ¼”ç®—æ³•\nour primary goal was understandability: could we define a consensus algorithm for practical systems and describe it in a way that is significantly easier to learn than Paxos\né€éè§£æ§‹å‡ºç¨ä»¶ä»¥åŠæ¸›å°‘æ©Ÿå™¨åœ¨ä¸ä¸€è‡´ç‹€æ…‹çš„å¯èƒ½æ€§ï¼Œè®“æ•´å€‹æ¼”ç®—æ³•æ›´å®¹æ˜“ç†è§£\nRaft æœ‰ä»¥ä¸‹å¹¾å€‹ç‰¹é»\nStrong Leader:\nLog çš„å¯«å…¥å¿…é ˆç¶“ç”± Leader å†åˆ°å…¶ä»–ç¯€é»ä¸Šï¼Œé€™æ¨£å¯ä»¥ç°¡åŒ–å¾ˆå¤šä¸å¿…è¦çš„è¤‡é›œæ€§ Leader Election:\nåœ¨é¸èˆ‰æ™‚ï¼ŒRaft åˆ©ç”¨éš¨æ©Ÿå»¶é²(randomized timers)æ–¹å¼å¿«é€Ÿä¸”æœ‰æ•ˆè§£æ±ºå¯èƒ½çš„è¡çª (é¿å…å¤§å®¶åœ¨åŒä¸€å€‹æ™‚åˆ»æƒ³è¦è®Šæˆ Leader) èº«ä»½æ”¹è®Š\nåœ¨æ”¹è®Šç¯€é»çš„è¨­å®šæª”æ™‚ï¼Œå¯ä»¥å°‡å‰å¾Œå…©ç¨®è¨­å®šæª”ä»¥è¯é›†æ–¹å¼åˆä½µ(joint consensus)ï¼Œåœ¨æ›´æ”¹è¨­å®šåŒæ™‚é‚„èƒ½ç¶­æŒæœå‹™ ä½œè€…èªç‚º Raft æ˜¯å€‹å„ªç•°çš„å…±è­˜æ¼”ç®—æ³•ï¼Œå°±è®“æˆ‘å€‘ç¹¼çºŒå¾€ä¸‹çœ‹\n2. Replicated state machines Replicated state machines æ˜¯æŒ‡ä¸€ç¾¤æ©Ÿå™¨çš„é›†åˆï¼Œå¯ä»¥é‹ç®—å‡ºç›¸åŒçš„ç‹€æ…‹ï¼Œä¸¦åœ¨å°‘æ•¸ç¯€é»å¤±æ•—æ™‚é‚„èƒ½æ­£å¸¸é‹è¡Œï¼Œä¸»è¦ç”¨ä¾†è§£æ±ºåˆ†æ•£å¼ç³»çµ±ä¸­å„ç¨®éŒ¯èª¤å®¹å¿æ€§çš„å•é¡Œï¼Œä¾‹å¦‚ GFS / HDFS / RAMCloudï¼Œåœ¨é€™äº›ç³»çµ±ä¸­æœ‰ç¨ç«‹çš„ Replicated state machine æŒç®¡ Leader Election / ä¿å­˜ Configï¼Œåœ¨ Leader crash æƒ…æ³ä¸‹é‚„èƒ½ç¹¼çºŒé‹ä½œï¼› Replicated state machine çš„å¯¦éš›æ¡ˆä¾‹æœ‰ Chubby / ZooKeeper\nReplicated state machine é€šå¸¸æ˜¯ç”±è¤‡è£½ Log æ‰€å¯¦è¸ï¼Œå¦‚ä¸‹åœ–ï¼Œæ¯å€‹ Server éƒ½æœ‰ä¸€ä»½ logï¼Œä¾ç…§ç›¸åŒé †åºç´€éŒ„è‘—ç›¸åŒçš„æŒ‡ä»¤ï¼Œé‹ç®—æ•´ä»½ log å°±èƒ½å¾—åˆ°ç›¸åŒçš„ç‹€æ…‹æ©Ÿ (state machine)\nå¾ client æ”¶åˆ°æŒ‡ä»¤å¾Œï¼Œå¦‚ä½•ä¿æŒé †åºè¤‡è£½ç›¸åŒçš„æŒ‡ä»¤åˆ°æ¯å°æ©Ÿå™¨ä¸Šï¼Œå°±æ˜¯å…±è­˜æ¼”ç®—æ³•çš„ä»»å‹™ï¼Œå…±è­˜æ¼”ç®—æ³•å…·é«”æä¾›ä¸‹åˆ—ä¿è­‰\nSafety:\nåœ¨éæ‹œå åº­æƒ…æ³ä¸‹ï¼Œç³»çµ±å³ä½¿é­é‡ç¶²è·¯å»¶é²ã€ç¶²è·¯åˆ†éš” (partition)ã€å°åŒ…éºå¤±ã€æŒ‡ä»¤é‡è¤‡ç™¼é€ã€ç™¼é€é †åºæ”¹è®Šç­‰å•é¡Œï¼Œéƒ½ä¸å½±éŸ¿çµæœ åªè¦å¤šæ•¸ç¯€é»å­˜æ´»å°±èƒ½å¤ æ­£å¸¸é‹è¡Œï¼Œä¾‹å¦‚ 5 å€‹ç¯€é» 3 å€‹é‚„æ´»è‘—å°±å¯ä»¥ï¼Œä¸¦ä¸”å¤±æ•—çš„ç¯€é»å¯ä»¥åœ¨å¾Œé¢é‡æ–°åŠ å›é›†ç¾¤ä¸­ ä¸ä¾è³´æ™‚é–“ç•¶ä½œåˆ¤æ–·ï¼Œåœ¨åˆ†æ•£å¼ç³»çµ±ä¸­æ™‚é–“æ˜¯ä¸å¯ä¿¡çš„(é™¤éå­¸ Google ç”¨åŸå­é˜è‡ªå¹¹å‡º TrueTime )ï¼Œæ¯å€‹ç³»çµ±éƒ½å­˜åœ¨è‘—æ™‚é˜æ²’å°é½Šçš„å¯èƒ½ å¤šæ•¸ç¯€é»æœ‰å›æ‡‰æ”¶åˆ°å‰¯æœ¬å°±ç®—æˆåŠŸï¼Œå°‘æ•¸ç¯€é»æ™šå›è¦†ä¸æœƒé€ æˆæ€§èƒ½å½±éŸ¿ 3. Whatâ€™s wrong with Paxos? é€™ä¸€ç« ç¯€ä¸»è¦åœ¨æç¹ª Paxos çš„èƒŒæ™¯èˆ‡æœ‰å¤šé›£ç†è§£çš„åŸå› ï¼Œä½†å› ç‚ºä¹‹å‰æ²’æœ‰å­¸é Paxosï¼Œå°±å…ˆç•¥éé€™ç« \n4. Designing for understandability é€™ä¸€ç« ç¯€ä¸»è¦æ˜¯ä½œè€…ä¸æ–·å¼·èª¿ understandability æ˜¯ä»–å€‘çš„æ ¸å¿ƒç†å¿µï¼Œç•¶é‡åˆ°è¨­è¨ˆæœ‰å¤šç¨®æ–¹æ¡ˆé¸æ“‡æ™‚ï¼Œä»–å€‘æœƒé¸æ“‡æœ€å¥½è§£é‡‹çµ¦åˆ¥äººè½çš„é‚£ä¸€å€‹ï¼Œå°æ–¼ä»–å€‘ä¾†èªªå¯è®€æ€§æ˜¯æ ¸å¿ƒç†å¿µ\nå…·é«”ä¸Šï¼Œé€é decomposition æ‹†åˆ†ç¨ç«‹æ¨¡çµ„ä»¥åŠæ¸›å°‘ä¸ç¢ºå®šæ€§èˆ‡ç‹€æ…‹å¯èƒ½æ€§ é”æˆç›®çš„ï¼Œä½†åœ¨æŸä¸€äº›éƒ¨åˆ†é‚„æ˜¯æœ‰ç”¨ä¸Šéš¨æ©Ÿæ€§ï¼Œå› ç‚ºé€™è®“æ¼”ç®—æ³•æ›´å¥½ç†è§£\n5. The Raft consensus algorithm Raft åœ¨å¯¦ä½œä¸Šæœƒå…ˆé¸å‡ºä¸€å Leader ï¼Œç”± Leader ç®¡ç† log çš„è¤‡è£½åˆ°å…¶ä»–ç¯€é»çš„ç‹€æ…‹æ©Ÿä¸Šï¼Œé€é Leader çš„å¥½è™•æ˜¯ä¸éœ€è¦å…¶ä»–ç¯€é»åŒæ„ Leader èƒ½ç¨è‡ªæ±ºå®šæ–°çš„ log è¦å„²æ”¾çš„ä½ç½®ï¼›\nå¦‚æœ Leader å¤±æ•—äº†å¯ä»¥å†é¸æ–°çš„ Leader å‡ºä¾†\n5.1 Raft basics é€šå¸¸ Raft é›†ç¾¤æœƒç”±äº”å€‹ç¯€é»çµ„æˆï¼Œå¯ä»¥å®¹å¿å…©å€‹ç¯€é»å¤±æ•—ï¼Œè€Œæ¯å€‹ç¯€é»æœ‰ä¸‰ç¨®ç‹€æ…‹ leader / follower / candidateï¼Œé€šå¸¸æƒ…æ³ä¸‹æ˜¯ä¸€å€‹ leader å…¶ä»–äººéƒ½æ˜¯ follower\nfollower: è¢«å‹•çš„è™•ç†ä¾†è‡ª leader æˆ– candidate çš„è«‹æ±‚ leader: è² è²¬æ‰€æœ‰ client çš„ requestï¼Œä¸¦è¤‡è£½æŒ‡ä»¤åˆ° follower ä¸­ candidate: follower ç™¼ç¾æ²’æœ‰ leaderï¼Œè¨­ä¸€å€‹éš¨æ©Ÿ timeout åˆ‡æ›æˆ candidate æ¨¡å¼ï¼Œæº–å‚™è¦é¸æ–° leader ä¸‹åœ–ç‚ºç‹€æ…‹æ©Ÿç¤ºæ„åœ– Raft å°‡æ™‚é–“åˆ‡å‰²æˆ å›åˆ (term)ï¼Œæ¯ä¸€å€‹å›åˆä»£è¡¨è‘—ä¸€æ¬¡çš„é¸èˆ‰ï¼Œä¹Ÿå°±æ˜¯ candidate å»ç«¶é¸ leader çš„éç¨‹ï¼Œå¦‚æœæˆåŠŸæ¨é¸å‡º leader å¾Œï¼Œå‰‡æ¯å€‹ç¯€é»ç´€éŒ„é€™ä¸€å€‹å›åˆæ•¸ï¼›å¦‚æœé¸èˆ‰å¤±æ•—ï¼Œå‰‡é–‹å•Ÿæ–°çš„å›åˆç›´åˆ°æœ‰äººæˆç‚º leader\nä»¥ä¸‹ç‚ºæ¦‚å¿µåœ– å›åˆæœ¬èº«æ˜¯ä¸€å€‹éå¢æ•¸å€¼ï¼Œç”¨ä¾†è¡¨ç¤ºé‚è¼¯ä¸Šçš„æ™‚é–“æ¦‚å¿µï¼Œæœ‰å¯èƒ½ç¯€é»è§€å¯Ÿåˆ°çš„å›åˆè·Ÿå…¶ä»–ç¯€é»ä¸åŒï¼Œå¦‚æœå›åˆæ•¸å°å‰‡ä»£è¡¨è‡ªèº«çš„è³‡æ–™éæ™‚ï¼Œä»–å¿…é ˆæ›´æ–°è‡ªå·±çš„å›åˆæ•¸ï¼›\nä¾‹å¦‚èªªåŸæœ¬çš„ leader å¯èƒ½æ–·ç·šï¼Œå…¶ä»–ç¯€é»æ¨é¸å‡ºæ–°çš„ leader å‰‡æœƒé€²åˆ°ä¸‹ä¸€å€‹å›åˆæ•¸ï¼ŒåŸæœ¬çš„ leader å›æ­¸å¾Œç™¼ç¾è‡ªå·±çš„å›åˆæ•¸æ¯”è¼ƒå°ï¼Œå‰‡æœƒä¸»å‹•è®Šæˆ followerï¼›\nå¦‚æœç¯€é»æ”¶åˆ°è«‹æ±‚æ™‚ï¼Œç™¼ç¾å›åˆæ•¸æ¯”è‡ªå·±å°ï¼Œå‰‡ä»£è¡¨è«‹æ±‚éæœŸï¼Œç›´æ¥æ‹‹æ£„è©²è«‹æ±‚\n5.2 Leader election Raft é€é heartbeat è§¸ç™¼ leader é¸èˆ‰ï¼Œç•¶ leader é¸ä¸Šæ™‚ï¼Œæœƒåœ¨å›ºå®šæ™‚é–“å…§ç™¼å…§å®¹ç‚ºç©ºçš„ AppendEntries RPC ç•¶ä½œå¿ƒè·³åŒ…ï¼Œå¦‚æœ follower è¶…é election timeout æ²’æœ‰æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œå‰‡é€²å…¥é¸èˆ‰éšæ®µ\nfolower æœƒå°‡ç¾ä»Šçš„å›åˆæ•¸åŠ ä¸€ä¾¿è½‰ç‚º candidateï¼Œä¸¦è«‹æ±‚å…¶ä»– follower æŠ•ç¥¨çµ¦ä»– RequestVote RPCï¼Œé‡åˆ°ä»¥ä¸‹æƒ…æ³ candidate æ‰æœƒæ”¹è®Šç‹€æ…‹\nè´å¾—é¸èˆ‰ å…¶ä»–ç¯€é»æˆç‚º leader è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º leader è´å¾—é¸èˆ‰ å¦‚æœ candidate æ‹¿ä¸‹éåŠçš„ç¥¨æ•¸ï¼Œå‰‡æˆç‚ºæ–°çš„ leaderï¼Œæ¯ä¸€å€‹ follower åœ¨åŒä¸€å€‹å›åˆæ•¸ä¸‹åªæœƒæŠ•ç¥¨çµ¦è«‹æ±‚å…ˆåˆ°çš„ candidateï¼Œé€™é¿å…ç„¡æ•ˆé¸èˆ‰çš„ç™¼ç”Ÿ\nå¦‚æœ candidate æˆç‚º leaderï¼Œå‰‡é–‹å§‹ç™¼é€å¿ƒè·³åŒ…\nç™¼ç¾æœ‰å…¶ä»– leader å¦‚æœåœ¨ candidate éšæ®µæ”¶åˆ°å¿ƒè·³åŒ…(AppendEntries)ï¼Œå‰‡ä»£è¡¨æœ‰å…¶ä»– leader ç”¢ç”Ÿï¼Œcandidate æœƒå»æ¯”å°å›åˆæ•¸è‡³å°‘è¦å¤§æ–¼ç­‰æ–¼ä»–è‡ªèº«çš„å›åˆæ•¸ï¼Œå¦‚æœæ˜¯å‰‡è½‰æˆ followerï¼›\nåä¹‹å‰‡ç¹¼çºŒç¶­æŒ candidate\nè¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º leader è¶…éä¸€å®šæ™‚é–“é‚„æ˜¯æ²’æœ‰é¸å‡ºä¾†çš„è©±ï¼Œtimeout å¾Œé–‹å§‹ä¸‹ä¸€è¼ªæ–°çš„é¸èˆ‰\nRaft é€éåœ¨ä¸€å®šæ™‚é–“å…§éš¨æ©Ÿ timeout (150-300ms)ï¼Œé¿å…æ‰€æœ‰çš„ follower åŒæ™‚é€²å…¥é¸èˆ‰éšæ®µï¼Œé€™æ¨£èƒ½åŠ é€Ÿ leader çš„æ¨é¸ï¼Œå¾ŒçºŒæœƒæœ‰æ›´è¿‘ä¸€æ­¥çš„èªªæ˜\nåœ¨è¨­è¨ˆéç¨‹ï¼Œä½œè€…æ›¾è€ƒæ…®åŠ å…¥ rank ï¼Œrank è¼ƒé«˜è€…æ›´æœ‰æ©Ÿæœƒæˆç‚º leaderï¼Œä½†ç™¼ç¾é€™æœƒå°è‡´æ¼”ç®—æ³•è¨­è¨ˆæ›´åŠ è¤‡é›œï¼Œä¸”æœ‰å¯ç”¨æ€§çš„å•é¡Œï¼Œä¾‹å¦‚é«˜é †ä½ candidate ç™¼ç”Ÿç‹€æ³ï¼Œå‰‡ä½é †ä½ candidate è¦å¤šä¸€æ¬¡ timeout æ‰èƒ½ç•¶ä¸Š leader ç­‰å•é¡Œ\n5.3 Log replication Leader æœƒé€é AppendEntries RPC å°‡æŒ‡ä»¤åŒæ­¥åˆ° follower ä¸¦å›å‚³åŸ·è¡Œçµæœçµ¦ clientï¼Œå¦‚æœ follower æ­¤æ™‚ crash ç­‰ï¼Œleader æœƒæŒçºŒé€ç›´åˆ° follower ç‹€æ…‹åŒæ­¥\nLog æ˜¯ä»¥ å›åˆæ•¸ + æŒ‡ä»¤ çš„æ–¹å¼ä¾åºå„²å­˜ï¼Œä¸»è¦æ˜¯æª¢è¦–æ˜¯å¦æœ‰ä¸ä¸€è‡´çš„ç‹€æ³ç”¢ç”Ÿ\næ¯å€‹ç¯€é»éƒ½æœƒä¿å­˜ç¾ä»Šæœ€å¾Œä¸€å€‹ commited log çš„ç´¢å¼• (commitIndex)ï¼ŒLeader åœ¨åŒæ­¥ log æ™‚ï¼Œæœƒç´€éŒ„ log è¦å¯«å…¥çš„ä½ç½® (commitIndex + 1)ï¼Œä¸¦åŒæ™‚ç™¼é€çµ¦ follower (leaderCommit)ï¼Œç­‰åˆ°å¤šæ•¸çš„ follower éƒ½å¯«å…¥ log å¾Œæ‰æ¨™è¨˜æˆ commitedï¼ŒRaft ä¿è­‰ commited log æ˜¯å·²ç¶“æŒä¹…åŒ–ä¸”æœ€çµ‚æ¯å€‹ follower éƒ½æœƒé”åˆ°ä¸€è‡´æ€§\nå› æ­¤ Raft ä¿è­‰ Logs æœ‰ä»¥ä¸‹ç‰¹æ€§\nå¦‚æœä»»æ„å…©å€‹ç¯€é»çš„ log æœ‰è‘—ç›¸åŒçš„ index èˆ‡å›åˆæ•¸ï¼Œå‰‡ä»–å€‘å¿…å®šå„²å­˜ç›¸åŒçš„æŒ‡ä»¤ å¦‚æœä»»æ„å…©å€‹ç¯€é»çš„ log æœ‰è‘—ç›¸åŒçš„ index èˆ‡å›åˆæ•¸ï¼Œå‰‡è©²æŒ‡ä»¤å…ˆå‰çš„ log ç´€éŒ„éƒ½å¿…å®šç›¸åŒ ç¬¬ä¸€é»ä¿è­‰ç¯€é»å„²å­˜ log å¾Œå°±ä¸æœƒå†è¢«æ”¹è®Šï¼Œç¬¬äºŒé»å‰‡ç¢ºä¿ç•¶ follower ç™¼ç¾è‡ªå·±çš„ log è·Ÿ leader ä¸åŒæ™‚ï¼Œå¯ä»¥ä¾æ­¤é‡æ–°è·Ÿ leader åŒæ­¥ç´€éŒ„\nLeader æœƒé‡å°æ¯ä¸€å€‹ follower ç¶­è­·æŒ‡é‡ nextIndexï¼Œç”¨ä¾†è¨˜éŒ„ follower ç›®å‰éœ€è¦åŒæ­¥çš„ log ç´¢å¼•ï¼Œleader åœ¨ç™¼é€ AppendEntries æŒ‡ä»¤æ™‚ï¼Œæœƒå¤¾å¸¶æœ€æ–° committed log çš„å›åˆæ•¸èˆ‡ indexï¼Œè®“ follower å¯ä»¥æ¯”å° log æ˜¯å¦åŒæ­¥ï¼Œå¦‚æœ follower åœ¨è‡ªå·±çš„ logs ä¸­æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„ç´€éŒ„ï¼Œå‰‡ä»£è¡¨å…©è€…éåŒæ­¥ï¼Œå›å‚³å¤±æ•—ï¼Œæ¥è‘— Leader ä¸æ–·éæ¸› nextIndex ç›´åˆ° follower æ‰¾åˆ°å…©è€…æœ€è¿‘ä¸€æ¬¡åŒæ­¥çš„ç´€éŒ„ï¼Œæ¥è‘—é–‹å§‹ä¸€æ­¥æ­¥åŒæ­¥ç´€éŒ„\nleader èˆ‡ follower æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡åŒæ­¥ç´€éŒ„çš„æ–¹å¼ï¼Œå¯ä»¥å„ªåŒ–æˆ follower å›å‚³é€™ä¸€å€‹å›åˆæ•¸ä¸‹ä»–æ‰€ä»¥ç´€éŒ„çš„ç´¢å¼•ï¼Œleader ç›´æ¥å€’å›é€™å€‹å›åˆé–‹å§‹åŒæ­¥ï¼›\nä½†ä½œè€…èªç‚ºä¸ä¸€è‡´ç‹€æ…‹æ‡‰è©²å¾ˆå°‘ç™¼ç”Ÿï¼Œå„ªåŒ–çš„æ•ˆç›Šä¸å¤§\né€éé€™æ¨£çš„ log åŒæ­¥è¨­è¨ˆï¼ŒLeader åœ¨å‰›å•Ÿå‹•æ™‚ä¸ç”¨æ“”å¿ƒå¤ªå¤šåŒæ­¥çš„å•é¡Œï¼Œåˆ©ç”¨ AppendEntries çš„æˆåŠŸèˆ‡å¤±æ•—å»èª¿é… follower å„²å­˜çš„ç´€éŒ„ï¼Œleader ä¹Ÿä¸ç”¨å»åˆªé™¤æˆ–æ›´æ–°è‡ªèº«çš„ logï¼Œè®“æ•´å€‹åŒæ­¥çš„éç¨‹æ›´åŠ çš„ç°¡å–®\n5.4 Safety å…ˆå‰ä»‹ç´¹äº† leader election å’Œ relicate logï¼Œä½†åƒ…æœ‰é€™æ¨£çš„æ©Ÿåˆ¶æ˜¯ä¸å¤ çš„ï¼Œè©¦æƒ³å¦‚æœ leader ç™¼ç”ŸéŒ¯èª¤ï¼Œä»Šå¤©æœ‰ä¸€å€‹ follower åƒ…åŒ…å«éƒ¨åˆ†çš„ commited logï¼Œé¸ä¸Š leader å¾Œä¾¿æœƒè¤‡å¯«åŸæœ¬å…¶ä»–å·²ç¶“ commited çš„ logï¼Œé€™æ¨£å°±ä¸èƒ½ä¿è­‰ä¸€è‡´æ€§èˆ‡æŒä¹…åŒ–\né€™ä¸€ç« ä»‹ç´¹ Raft åœ¨ leader election åŠ ä¸Šé™åˆ¶å¾Œï¼Œå¦‚ä½•é”åˆ°ç¢ºä¿æ¯ä¸€å°ç‹€æ…‹æ©Ÿéƒ½ä»¥ç›¸åŒé †åºä¿å­˜ç›¸åŒçš„æŒ‡ä»¤\nRaft æœƒç¢ºä¿ä»»ä½•æ™‚å€™é›†ç¾¤éƒ½ç¬¦åˆä¸Šè¿°æ¢ä»¶\nElection Safety: æ¯ä¸€è¼ªé¸èˆ‰è‡³å¤šåªé¸å‡ºä¸€ä½ leader Leader Append-Only: leader å¾ä¸åˆªé™¤æˆ–æ”¹å¯«è‡ªå·±çš„ logï¼Œåªæœƒä¸€ç›´å¢åŠ  Log Matching: ä»»å…©ä»½ logs åœ¨åŒä¸€å€‹ term åŒä¸€å€‹ index ä¸Šï¼Œå‰‡ log å…§å®¹å¿…å®šç›¸åŒï¼Œä¸”å…ˆå‰çš„ log ä¹Ÿéƒ½ç›¸åŒ Leader Completeness: æŸå€‹ log åœ¨ä»»ä¸€ä¸€å€‹ term ä¸­èªå®š commitedï¼Œå‰‡å¾ŒçºŒ term ä¸­çš„ leader éƒ½å¿…é ˆæœ‰è©²ä»½ log State Machine Safety: å¦‚æœæŸå€‹ server åœ¨æŸ index ä¸Šçš„ log å¥—ç”¨è‡³ç‹€æ…‹æ©Ÿï¼Œå‰‡ä¸æœƒæœ‰å…¶ä»–çš„ server åœ¨åŒä¸€å€‹ index ä¸Šå¥—ç”¨ä¸åŒçš„ log 5.4.1 Election restriction åœ¨ leader-based çš„å…±è­˜æ¼”ç®—æ³•ä¸­ï¼Œleader æœ€çµ‚æœƒå„²å­˜æ‰€æœ‰çš„ commited logï¼Œåœ¨æŸäº›æ¼”ç®—æ³•ä¸­ï¼Œleader åœ¨æ²’æœ‰ä¿å­˜æ‰€æœ‰ commited log æƒ…æ³ä¸‹ä¹Ÿèƒ½å¤ æª”é¸ï¼Œä¸¦é€éé¡å¤–çš„æ©Ÿåˆ¶å»å›è£œé€™äº›æœªåŒæ­¥çš„ logï¼Œé€™å¢åŠ äº†è »å¤šçš„è¤‡é›œæ€§\nRaft ç¢ºä¿ leader å¿…é ˆæ˜¯ç”± æ“æœ‰å¤§å¤šæ•¸ç¯€é»åŒæ„çš„æœ€æ–° committed log çš„ candidate æ‰èƒ½ç•¶é¸ï¼Œç¢ºä¿ leader ä¸€å®šæ˜¯æ“æœ‰æœ€æ–° log çš„ç¯€é»ï¼Œåªè² è²¬å¢åŠ æ–°çš„ logï¼Œè®“è³‡æ–™æµåªæœ‰ä¸€å€‹æ–¹å‘ï¼Œçœå»å…¶ä»–çš„éº»ç…©\nåœ¨ RequestVote RPC ä¸­å¢åŠ äº†é™åˆ¶ï¼ŒRPC ä¸­å¤¾å¸¶ candidate æœ€å¾Œä¸€å€‹ log ä¸­çš„å›åˆæ•¸èˆ‡ç´¢å¼•æ•¸ï¼Œå¦‚æœ follower ç™¼ç¾ candidate çš„ç´€éŒ„æ¯”è‡ªå·±èˆŠï¼Œå‰‡å›å‚³å¤±æ•—\n5.4.2 Committing entries from previous terms å…ˆå‰æåˆ°ï¼ŒLeader æœƒç­‰å¤šæ•¸çš„ç¯€é»å„²å­˜ log æ‰æ¨™è¨˜æˆ commitedï¼Œ ä½†å¦‚æœ leader å°‡ log å¯«åˆ°å¤šå€‹ follower å¾Œï¼Œé‚„ä¾†ä¸åŠæ”¶åˆ° commited å°± crash äº†\næ­¤æ™‚æ–°çš„ leader æœƒæŒçºŒåŒæ­¥ logï¼Œä½†ç„¡æ³•ç¢ºèªå…ˆå‰çš„ log æ˜¯ä¸æ˜¯è¢« commit äº†ï¼Œå› ç‚ºåªæœ‰å…ˆå‰çš„ leader æ‰èƒ½ç¢ºèª log å·²ç¶“è¢«å¤šæ•¸çš„ç¯€é»æ‰€ä¿å­˜\nå¦‚ä»¥ä¸‹åœ–ç¤º S1 ä¸€é–‹å§‹æ˜¯ leaderï¼ŒåŒæ­¥ term2 åˆ° S2 å°± crash S5 æ¥è‘—ç•¶ leader (S3,S4 å¯ä»¥æŠ•çµ¦ä»–) é–‹å§‹äº† term 3ï¼Œæ­¤æ™‚ç™¼ç”Ÿ crash S1 åˆå›ä¾†ç•¶ leaderï¼Œå°‡ term2 çš„ log åŒæ­¥åˆ° S3 å¾Œï¼Œæ­¤æ™‚åˆ crash æ¥è‘—æ‹†å…©ç¨®æƒ…æ³\nd. S1 ä¾†ä¸åŠåŒæ­¥ term4 è³‡æ–™ï¼Œå‰‡ S5 æœ‰æ©Ÿæœƒç•¶å…¥ leaderï¼Œä¸¦ç”¨ term3 è¤‡å¯«æ‰å…¶ä»–è³‡æ–™\ne. S1 åŒæ­¥ term4 è³‡æ–™åˆ°å¤§å¤šæ•¸ç¯€é»ä¸Šï¼Œå‰‡ S5 ç„¡æ³•ç•¶ä¸Š leader\nåœ¨ leader é‚„æ²’æ”¶åˆ° commited æƒ…æ³ä¸‹ï¼Œå³ä½¿å¤šæ•¸çš„ç¯€é»å·²ç¶“åŒæ­¥ logï¼Œä½†æ–°çš„ leader æœ‰æ©Ÿæœƒè¤‡å¯«\nç‚ºäº†æ¸›å°‘é€™æ¨£çš„æƒ…æ³ï¼ŒRaft ä¸å»è¨ˆç®—å…ˆå‰ log æ‰€åŒæ­¥çš„å‰¯æœ¬æ•¸å»åˆ¤å®šæ˜¯å¦ commitedï¼Œåªæœ‰ leader ç•¶ä¸‹çš„å›åˆæ•¸æ˜¯é€éå‰¯æœ¬çš„è¨ˆç®—ä¾†æ±ºå®š log æ˜¯å¦è¢« commitedï¼Œå¦‚æœ commit å¾Œï¼Œå‰‡å…ˆå‰çš„æ‰€æœ‰ log éƒ½è¢«è¦–ç‚º commitedï¼Œé™ä½è¨ˆç®—ä¸Šçš„è¤‡é›œæ€§ï¼Œä¸¦å› ç‚ºä¹‹å‰çš„ log ç‰¹æ€§ä¿è­‰ï¼Œå…ˆå‰çš„ log ä¸€å®šä¹Ÿéƒ½è¢«è¤‡è£½åˆ°å…¶ä»–å‰¯æœ¬ä¸Š\n5.4.3 Safety argument æ›´é€²ä¸€æ­¥è§£é‡‹ Leader Completenessï¼Œé€éåè­‰æ³•ï¼Œæ‰¾å‡ºé›†ç¾¤ç„¡æ³•ä¸éµå®ˆ Leader Completeness\nå‡è¨­ leaderT ä»£è¡¨åœ¨ term T çš„ leaderï¼Œleader U å‰‡æ˜¯ term Uï¼Œä¸” U ä»£è¡¨æ˜¯ T çš„ä¸‹ä¸€ä½ï¼Œä¸” leaderT æ‰€èªå®šçš„ commited log (logT) åœ¨ leader U ä¸å­˜åœ¨ (é•å Leader Completeness)\nleaderU åœ¨ç•¶ follower æ™‚ä¸¦ä¿å­˜æ²’æœ‰ logT leaderT å°‡ logT åŒæ­¥åˆ°å¤šæ•¸ç¯€é»ä¸Šï¼Œè€Œ leaderU åœ¨é¸èˆ‰æ™‚ç²å¾—å¤šæ•¸åŒæ„ï¼Œä¹Ÿå°±æ˜¯è‡³å°‘æœ‰ä¸€ä½æŠ•ç¥¨ç¯€é» (voter) æ”¶åˆ° logT åŒæ™‚åˆæŠ•ç¥¨çµ¦ leaderU voter å¿…é ˆå…ˆä¿å­˜ logTï¼Œæ‰åˆæŠ•ç¥¨çµ¦ leaderUï¼Œåéä¾†å°±ä¸æœƒæœ‰è¡çª (term U \u0026gt; term T æ‰€ä»¥ logT å¾Œåˆ°æœƒè¢«ä¸Ÿæ£„) voter ä¾ç„¶ä¿å­˜ logTï¼Œå› ç‚º leader å¾ä¸æ”¹è®Šæ—¢å®š logï¼Œè€Œ follower ä¹Ÿåªæœ‰èˆ‡ leader è¡çªæ™‚æ‰æœƒè¤‡å¯« è£½é€ å‡ºå ´æ™¯å¾Œï¼Œè®“æˆ‘å€‘ä¾†çœ‹ç‚ºä»€éº¼ Raft ä¸å¯èƒ½é”åˆ°é€™æ¨£çš„ç‹€æ³\n5. ä¾æ“šå…ˆå‰è¦å®šï¼Œ follower åªæœƒæŠ•çµ¦ log ä¿ç•™æ¯”è‡ªå·±æ›´å¤šçš„ candidate\n6. å¦‚æœ voter èˆ‡ leaderU æœ€æ–°ä¸€å€‹ term éƒ½æ˜¯ T çš„è©±ï¼Œå‰‡ leaderU çš„ log æ•¸æ‡‰è©²èˆ‡ voter ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ leaderU è‡³å°‘æ“æœ‰ voter æ‰€æ“æœ‰çš„ log\n7. åä¹‹ï¼Œå¦‚æœ leaderU çš„æœ€æ–° log term å¤§æ–¼ voter çš„è©±ï¼Œç‚ºäº†è¦ç¬¦åˆæ—©æ–¼ leaderU çš„ leader æ‰€æœ‰ commited log éƒ½æ‡‰è©²è¢«ä¿ç•™åˆ° leaderU ä¸­ï¼Œå› æ­¤æ ¹æ“š Log Matching å‰‡ leaderU æ‡‰è©²è¦å„²å­˜é€™äº› log\nåœ¨ç„¡æ³•é”æˆçš„æƒ…æ³ï¼Œè­‰æ˜äº† Raft æ»¿è¶³ Leader Completeness æ¢ä»¶ï¼Œç¢ºä¿ leader å¦‚æœæœ€æ–°çš„ log term \u0026gt; Tï¼Œå‰‡ leader å¿…å®šæ“æœ‰ term T æ‰€ commited çš„ä¸€åˆ‡ log\nThus, the leaders of all terms greater than T must contain all entries from term T that are committed in term T\næœ‰äº† Leader Completeness å±¬æ€§ï¼Œå°±èƒ½é€²ä¸€æ­¥è­‰æ˜ State Machine Safetyï¼Œå¦‚æœæŸä¸€æ©Ÿå™¨åœ¨æŸä¸€ index å¥—ç”¨æŒ‡ä»¤åˆ°ç‹€æ…‹æ©Ÿä¸­ï¼Œå‰‡å…¶ä»–æ©Ÿå™¨åœ¨ç›¸åŒ index ä¸‹ä¸¦ç„¶å¥—ç”¨ç›¸åŒçš„æŒ‡ä»¤ï¼Œå› ç‚ºèƒ½å¤ è¢«å¥—ç”¨çš„ log ä¸€å®šæ˜¯ leader commited å¾Œçš„ logï¼Œä¸”å› ç‚º Log Completenessï¼Œæ‰€æœ‰æ›´æ–°çš„ leader ä¹Ÿéƒ½ä¿ç•™è¢« commited å¾Œçš„ logï¼Œå› æ­¤èƒ½ç¢ºä¿æ‰€æœ‰çš„ç¯€é»çµ‚å°‡ä»¥ç›¸åŒçš„é †åºå¥—ç”¨ç›¸åŒçš„æŒ‡ä»¤åˆ°ç‹€æ…‹æ©Ÿä¸Š\n5.5 Follower and candidate crashes å…ˆå‰éƒ½æ˜¯è¨è«– leader crashed å¾Œçš„è™•ç½®ï¼Œè‡³æ–¼ follower èˆ‡ candidate å‰‡å–®ç´”å¾ˆå¤šï¼Œå› ç‚º Raft çš„ RPC æŒ‡ä»¤éƒ½æ˜¯ idempotentï¼Œleader å¯ä»¥æŒçºŒçš„é€æŒ‡ä»¤ç›´åˆ°æˆåŠŸï¼Œfollower è·Ÿ candidate å¤±æ•—å¾Œé‡å•Ÿå°±é‡æ–°æ¥æ”¶æŒ‡ä»¤å°±å¥½\n5.6 Timing and availability Raft Safety å»ºç«‹åœ¨ä¸ä¾è³´ timingï¼Œç³»çµ±ä¸æœƒå› ç‚ºè¨Šæ¯ç™¼é€çš„å¿«æ…¢è€Œå¾—åˆ°ä¸é æœŸçš„çµæœï¼›\nä½†æ•´é«”ç³»çµ±çš„å¯ç”¨æ€§å»é‚„æ˜¯è·Ÿæ™‚é–“æœ‰ä¸€äº›é—œè¯ï¼Œä¾‹å¦‚èªª server ä¸èƒ½å† election timeout æœŸé–“å…§ç¥¨é¸å‡º leaderï¼Œè€Œ Raft åœ¨æ²’æœ‰ leader çš„æƒ…æ³ä¸‹å°±ä¸å¯ç”¨\næ‰€ä»¥æ•´é«”ä¸Šè¦ç¬¦åˆä»¥ä¸‹ä¸ç­‰å¼ Raft æ‰èƒ½é‹ä½œæ­£å¸¸\nbroadcastTime â‰ª electionTimeout â‰ª MTBF\nbroadcastTime ä»£è¡¨ RPC å®Œæ•´ request / response æ‰€è€—è²»çš„æ™‚é–“ï¼Œé ˆå°æ–¼ electionTimeout ä¸€å€‹é‡ç´šï¼Œé€šå¸¸åœ¨ 0.5ms ~ 20msï¼› electionTimeout å‰‡æ˜¯ follower ç­‰å¾…å¤šä¹…å¾Œæœƒè§¸ç™¼é¸èˆ‰ï¼Œé€™æ˜¯å¯ä»¥ä¸»å‹•å»è¨­å®šçš„ï¼Œé€šå¸¸åœ¨ 100ms ~ 500msï¼› MTBF å‰‡ä»£è¡¨ server é€²å…¥éŒ¯èª¤ç‹€æ…‹çš„å€é–“ï¼Œé€šå¸¸æ˜¯æ•¸å¤©è‡³æ•¸å€‹æœˆ è©¦æƒ³å¦‚æœ broadcastTime \u0026gt; electionTimeoutï¼Œå‰‡æ¯ä¸€æ¬¡é¸èˆ‰åœ¨é‚„æ²’æ”¶åˆ°æŠ•ç¥¨çµæœåˆé–‹å§‹ä¸‹ä¸€è¼ªé¸èˆ‰ï¼Œå‰‡æ°¸é é¸ä¸å®Œï¼›\nå¦‚æœ electionTimeout \u0026gt; MTBFï¼Œå‰‡é¸èˆ‰é‚„æ²’çµæŸ server åˆ crashï¼Œé‚£ä¹Ÿä¸€æ¨£æœƒæœ‰ leader ç„¡æ³•ç”¢ç”Ÿçš„å•é¡Œ\nç¸½çµ å¾ŒçºŒé‚„æœ‰ Cluster membership changes / Log compaction / Client interaction é€²éšæ¢è¨ï¼Œå°±å…ˆæš«æ™‚ç•¥éï¼Œåƒ…ç†è§£å‰åŠéƒ¨æ¼”ç®—æ³•çš„æ ¸å¿ƒè¨­è¨ˆ\nåˆ†æ•£å¼ç³»çµ±çš„è¿·äººä¹‹è™•åœ¨æ–¼è¤‡é›œï¼Œéœ€è¦é¢å°ç¶²è·¯å»¶é² / æ™‚é–“ä¸ä¸€è‡´(time skewed) / æ©Ÿå™¨å¤±æ•—ç­‰ä¸ç©©å®šçš„å› å­ï¼Œã€Œå†ä¸ç©©å®šçš„æ¢ä»¶ä¸‹æ¶æ§‹å‡ºå¯å®¹éŒ¯/é«˜å¯ç”¨/ä¸€è‡´æ€§çš„ç©©å®šç³»çµ±ã€ï¼Œçœ‹ä¼¼è’è¬¬å»å¯ä»¥é€éæ¼”ç®—æ³•çš„è¨­è¨ˆé”æˆç›®çš„(æˆ–æ˜¯èªªæ›´è²¼è¿‘)ï¼Œå¯¦åœ¨ä»¤äººè®šå˜†é€™äº›è¨­è¨ˆæ¼”ç®—æ³•çš„å°ˆå®¶å€‘\nRaft é€éç”± Leader ä¸»å° Log çš„åŒæ­¥ï¼Œä¸¦åŠ å…¥é¸èˆ‰æ™‚çš„æ¢ä»¶é™åˆ¶ï¼Œç¢ºä¿ commited log ä¸æœƒè¢«æ”¹å¯«é”åˆ° å¼·ä¸€è‡´æ€§ï¼›å¦‚æœ Leade å¤±æ•—ï¼Œä¹Ÿä¸ç”¨æ“”å¿ƒ log ç™¼ç”Ÿå•é¡Œï¼Œç­‰ä¸‹ä¸€ä½ Leader è¢«æ¨é¸å‡ºä¾†åˆèƒ½å¤ ç¹¼çºŒç¶­æŒç³»çµ±é‹ä½œ\næ•´ä»½è«–æ–‡è®€èµ·ä¾†é‚„ç®—è »å¥½ç†è§£çš„ï¼Œç¢ºå¯¦ç¬¦åˆä½œè€…ä¸æ–·å¼·èª¿å¯è®€æ€§çš„é‡è¦\n","date":"2020-11-03T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-11-03-raft-%E6%BC%94%E7%AE%97%E6%B3%95%E4%BB%8B%E7%B4%B9%E8%88%87in-search-of-an-understandable-consensus-algorithm%E6%91%98%E8%A6%81/","title":"Raft æ¼”ç®—æ³•ä»‹ç´¹èˆ‡ã€ŠIn Search of an Understandable Consensus Algorithmã€‹æ‘˜è¦"},{"content":"Gossip Protocol Gossip Protocol æ˜¯ä¸€ç¨®é€šè¨Šæ©Ÿåˆ¶ï¼Œæ‡‰ç”¨æ–¼åŒä¸€ç¶²è·¯å…§æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“äº¤æ›è¨Šæ¯ä½¿ç”¨ï¼ŒåŸç†é¡ä¼¼æ–¼è¾¦å…¬å®¤å‚³è¬ è¨€ä¸€æ¨£ï¼Œä¸€å€‹å‚³ä¸€å€‹ï¼Œæœ€çµ‚æ¯ä¸€å€‹æ©Ÿå™¨éƒ½æ“æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œåˆç¨± Epidemic Protocol\nä¸Šä¸€ç¯‡åˆ†äº«åˆ° Cassandra å…§éƒ¨å¦‚ä½•ä½¿ç”¨ Gossip Protocolï¼Œå½±ç‰‡ä¸­æœ‰æ¨è–¦ Efficient Reconciliation and Flow Control for Anti-Entropy Protocolsï¼Œä»¥ä¸‹æ‘˜è¦æ­¤ç¯‡è«–æ–‡æ‰€æ¢è¨çš„å…§å®¹\nå»ºè­°å¯ä»¥å…ˆè®€ä¸Šç¯‡ï¼Œæœ‰å€‹æ¦‚ç•¥èªè­˜å¾Œåœ¨çœ‹ç†è«–æœƒæ¯”è¼ƒå¥½æ‡‚äº›\nã€ŠEfficient Reconciliation and Flow Control for Anti-Entropy Protocolsã€‹ æ‘˜è¦ anti-entropyï¼Œåˆæˆ–ç¨±ä½œ gossipï¼Œç”¨æ–¼ä¸éœ€è¦å¼·ä¸€è‡´æ€§çš„ç‹€æ…‹åŒæ­¥ï¼Œåœ¨ä¸€äº›é™åˆ¶ä¸‹ï¼Œæ™‚é–“è¤‡é›œåº¦æ˜¯ log(N) (N ç‚ºç¾¤é«”æ•¸é‡) ä¸”åœ¨ host é­é‡éŒ¯èª¤æˆ–æ˜¯è¨Šæ¯ä¸Ÿå¤±éƒ½ä¸å½±éŸ¿\ngossip å¸Œæœ›ç›¡é‡åœ¨å¯æ§åˆ¶çš„å›åˆå…§å®ŒæˆåŒæ­¥ï¼Œä½†å¦‚åŒå…¶ä»–åŒæ­¥æ“ä½œï¼Œé€™æœƒä»°è³´ CPU è³‡æºèˆ‡ Network æµé‡ï¼Œåœ¨é«˜è² è¼‰ä¸‹ CPU å¯èƒ½ä¾†ä¸åŠé‹ç®—è¦æ›´æ–°çš„ç‹€æ…‹æˆ–æ˜¯ç¶²è·¯æµé‡ä¸å¤ å¿«å°è‡´å»¶é²å°åŒ…\né€™ä»½è«–æ–‡ä¸»è¦æä¾›å…©å€‹åƒ¹å€¼ï¼Œ\nåœ¨é™å®š CPU / Network ä¸‹å„ªåŒ– gossip protocol å‚³è¼¸æ•ˆç‡ åˆ†æ gossip protocol çš„æµé‡ç®¡åˆ¶ gossip protocol ä¸»è¦æœ‰å…©ç¨®é¡å‹\nanti-entropy: æŒçºŒå‚³é€ gossip information ç›´åˆ°å…¨éƒ¨è³‡æ–™éƒ½æ›´æ–°å®Œæˆ rumormongering: é¸å®šä¸€å€‹è¶³å¤ æœ‰æ•ˆçš„æ™‚é–“æŒçºŒé€ gossip informationï¼Œå¤§æ¦‚ç‡ç¯€é»éƒ½æœƒæ‹¿åˆ°æœ€æ–°è³‡è¨Š å‡è¨­ç›®å‰çš„é›†ç¾¤ {p,q \u0026hellip;}ï¼Œæ¯å€‹åƒèˆ‡è€…éƒ½éœ€è¦ç¶­è­·ä¸€ä»½åˆ—è¡¨ï¼Œé€™å€‹åˆ—è¡¨æ˜¯ç”± key -\u0026gt; (value + version) çµ„æˆï¼Œä¹Ÿå°±æ˜¯ Cassandra å…§çš„ ApplicationState\nÏƒ âˆˆ S = K â†’ (V Ã— N ) // Ïƒ ä»£è¡¨å–ç‹€æ…‹ Ïƒ(k) = (v, n) ï¼Œè¡¨ç¤º key æ­¤æ™‚å°æ‡‰çš„ value v è·Ÿ version n\nåˆ—è¡¨åŒ…å« key -\u0026gt; value -\u0026gt; versionï¼Œå¦‚æœæ˜¯é€™å€‹ key çš„æœ€æ–°è³‡æ–™ï¼Œå‰‡ä»–çš„ version æœƒå¤§æ–¼èˆŠçš„ version\nÏƒ1(k) = (v1, n1), Ïƒ2(k) = (v2, n2) // Ïƒ1(k) ä»£è¡¨é€™ä¸€å€‹ç¯€é»å–ä»–çš„ keyï¼Œè¿”å› (v1, n1) ä»£è¡¨ value ç‚º v1 ä¸” version n1ï¼› Ïƒ(k) è¡¨ç¤ºå– Ïƒ1 èˆ‡ Ïƒ2 å– XORï¼Œä¸¦é‡åˆ°ç›¸åŒ key æ™‚å– verson è¼ƒå¤§è€…ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ n1 \u0026gt; n2 å‰‡ Ïƒ(k) = (v1, n1)\næ“ä½œæµç¨‹å¤§è‡´æ˜¯\nå¾é›†ç¾¤ä¸­éš¨æ©ŸæŒ‘ä¸€å€‹ host å‚³é€è¨Šæ¯ï¼Œè¨Šæ¯å…§å®¹æ˜¯è‡ªå·±æ‰€ç¶­è­·çš„åˆ—è¡¨ æ”¶åˆ°è¨Šæ¯å¾Œé‹ç®—ï¼Œæ­¤å‹•ä½œç¨±ç‚º merge æˆ–ç¨±ç‚º reconciliation ï¼Œä¹Ÿå°±æ˜¯æ”¶åˆ°è¨Šæ¯æ™‚æœƒå»é‹ç®—åˆ—è¡¨çš„å·®ç•°ï¼Œä¸¦ä¿ç•™å·®ç•°ä¸­ version è¼ƒé«˜çš„ key -\u0026gt; value âˆ€r : Âµq (r) = Âµq (r) âŠ• Âµp(r) // q çœŸæ­£è¦æ›´æ–°çš„æ˜¯ p å‚³ä¾†çš„è¨Šæ¯èˆ‡ q è‡ªèº«ç¾åœ¨çš„è¨Šæ¯å– XOR æ‰¾å‡ºå·®ç•°è™•\nå‚³é€è¨Šæ¯æœ‰ä¸‰ç¨®æ ¼å¼\npush: ç¯€é» p å‚³é€æ•´ä»½åˆ—è¡¨ï¼Œç¯€é» q æ”¶åˆ°å‰‡è¨ˆç®— merge å¾Œåˆä½µå…¥è‡ªå·±çš„åˆ—è¡¨ pull: ç¯€é» p å‚³é€ key -\u0026gt; version è€Œæ²’æœ‰ valueï¼Œç¯€é» q å›å‚³ç¯€é» p é ˆè¦æ›´æ–°çš„éµå€¼ï¼Œè®Šå…å¤šé¤˜çš„å€¼å‚³é€ push-pull: å°±åƒ pushï¼Œç¯€é» p å‚³é€å®Œæ•´åˆ—è¡¨ï¼Œç¯€é» q æœƒå›å‚³ p éæœŸé ˆè¦æ›´æ–°çš„éµå€¼ ( pull å¾ŒåŠæ®µï¼Œpush-pull æ˜¯æœ€æœ‰æ•ˆç‡çš„åšæ³• å¦‚æœæŸå€‹ key ä¸å†æ›´æ–°ï¼Œé‚£åœ¨ä¸€å®šçš„æ™‚é–“å…§å¾ˆé«˜çš„æ©Ÿç‡å¤§å®¶éƒ½æœƒåŒæ­¥ç›¸åŒçš„ valueï¼Œå¦‚æœé›†ç¾¤éš¨æ©ŸæŒ‘é¸ç¯€é»çš„æ¼”ç®—æ³• (Fp âŠ† P âˆ’ {p}) å¤ éš¨æ©Ÿçš„è©±ï¼Œå³ä½¿é‡åˆ° message loss æˆ–æ˜¯ host çŸ­æš« failedï¼Œä¹Ÿåƒ…åƒ…æ˜¯ç¨å¾®å»¶é²åŒæ­¥çš„æ™‚é–“\nå‡è¨­ update key çš„æ™‚é–“æ˜¯å›ºå®šçš„ï¼Œé‚£éš¨è‘—é›†ç¾¤æ•¸é‡ç·šæ€§å¢é•· Nï¼Œå‰‡é”æˆåŒæ­¥æ‰€éœ€è¦çš„æ™‚é–“æœƒæˆ log(N) å¢é•·ã€‚\nä½†å¯¦å‹™ä¸Šå¿…é ˆè€ƒé‡åˆ° CPU / Network ä»¥åŠæ›´æ–°çš„é »ç‡ï¼Œå¦‚æœæ›´æ–°çš„é »ç‡å¤ªé«˜ï¼Œå› ç‚ºè³‡æºå—é™å‰‡åŒæ­¥çš„å»¶é²å¯èƒ½æœƒç„¡é™çš„å¢é•·ï¼Œå¯¦éš›ä¸Šæ‡‰ç”¨ç¨‹å¼åœ¨æ„çš„ä¸æ˜¯å¤šå¸¸æ›´æ–°ï¼Œè€Œæ˜¯è³‡æ–™æ˜¯ä¸æ˜¯æŠµé”åŒæ­¥\næ¥è‘—è¦æ¢è¨å¦‚æœæˆ‘å€‘é™å®š gossip message ä¸èƒ½è¶…é MTU(Maximum Transmission Unit)ï¼Œé‚£æˆ‘å€‘è©²æ€éº¼æ±ºå®šè¦æ›´æ–°å“ªäº› key æ‰èƒ½æœ€æœ‰æ•ˆè®“æ‰€æœ‰ç¯€é»ç‹€æ…‹ä¸€è‡´\nRECONCILIATION å…ˆå‰æåˆ° p è·Ÿ q ä¾†å›é€šä¿¡éƒ½åªé€å…©è€…ç‹€æ…‹çš„ deltaï¼Œå¦‚æœè¶…é MTU å‰‡å¿…é ˆæœ‰ä¸€å€‹å„ªå…ˆåºæ±ºå®šå“ªäº›éµå€¼è¦å…ˆæ›´æ–°( \u0026lt;Ï€ ä»£è¡¨æ­¤æ’åºæ¼”ç®—æ³•)ï¼Œä½œè€…ä»‹ç´¹äº†å…©ç¨®ï¼Œä¸€ç¨®æ˜¯ precise reconciliation æœ€ç‚ºåŸºæº–ç·šï¼Œå°æ¯”å¦ä¸€å€‹ä½œè€…æå‡ºçš„ Scuttlebutt æ›´æ–°æ©Ÿåˆ¶\nprecise reconciliation æ ¹æ“šæ›´æ–°æ™‚é–“åºæ±ºå®šå“ªäº› key è¦å…ˆé€å‡ºå»ï¼Œåœ¨å¯¦å‹™ä¸Š precise reconciliation æ¯”è¼ƒéº»ç…©äº›ï¼Œå¦‚å…ˆå‰èªªå¿…é ˆè¦å…ˆé€ state çµ¦å°æ–¹åšæ¯”è¼ƒæ‰èƒ½ç®—å‡º deltaï¼Œé€™æœƒæ¶ˆè€—é »å¯¬ä»¥åŠ CPU cycle\nä¾æ“šæ™‚é–“åºåˆå¯ä»¥ç´°åˆ†æˆ precise-oldest: åœ¨ MTU é™åˆ¶ä¸‹å…ˆé€é‚£äº›å¾ˆä¹…æ²’æœ‰æ›´æ–°çš„ key / precise-newest: å…ˆé€æœ€è¿‘æ‰è¢«æ›´æ–°çš„ keyï¼Œå¾Œè€…è¦ç•™æ„æœƒæœ‰ starvation å•é¡Œï¼Œåœ¨å¯¦ä½œä¸Šç¯€é»å¿…é ˆåŒæ­¥æ™‚é–“ï¼Œæ‰èƒ½ä½œç‚ºåˆ¤æ–·çš„ä¾æ“š\nNote that, if implemented, both these orderings would require a synchronized clock among the members and that all updates be timestamped with this clock.\nScuttlebutt Reconciliation ä½œè€…æåŠå¦ä¸€ç¨®è§£æ³•ï¼Œä¹Ÿæ˜¯ Cassandra æ¡ç´çš„åšæ³•ï¼Œåˆå§‹åŒ–æ™‚ version å›ºå®šæ˜¯æœ€å°çš„æ•¸å­—ï¼Œæ¯æ¬¡æ›´æ–°éµå€¼æ™‚ï¼Œè¦æŠŠ version è¨­å®šå¤§æ–¼æˆç›®å‰ä»»æ„éµå€¼å°æ‡‰çš„æœ€é«˜ç‰ˆè™Ÿ\n{(r, max(Âµp(r))) | r âˆˆ P} // æ­¤å…¬å¼è¡¨ç¤º r æ˜¯å±¬æ–¼ç¯€é» P çš„å±¬æ€§ï¼Œæ‰¾å‡º r ä»¥åŠç•¶ä¸‹ P ä¸­ r æœ€å¤§çš„ç‰ˆè™Ÿï¼›\nä¾‹å¦‚èªªç›®å‰ Participant p çš„åˆ—è¡¨æ˜¯\n1 2 3 4 key | value | version a | a1 | 1 b | b1 | 2 c | c1 | 3 å¦‚æœæ­¤æ™‚ a è¦æ›´æ–°ï¼Œå‰‡ç‰ˆè™Ÿè‡³å°‘è¦æ‹‰åˆ° 4ï¼Œè€Œä¸”ä¸åƒ precise-conciliation æœƒä¸€æ¬¡é€å¤šçµ„é–“å€¼æ›´æ–°ï¼ŒScuttlebutt å…è¨±ä¸€æ¬¡å¯ä»¥é€ä¸€å€‹éµå€¼ï¼Œä½†å¿…é ˆæŒ‰ç…§ version å¤§å°é€ä¸€é€ æ•´å€‹æ¶æ§‹å¿…é ˆç¬¦åˆä»¥ä¸‹ç‹€æ…‹ ä¹Ÿå°±æ˜¯èªªåœ¨æ•´å€‹é›†ç¾¤ä¸‹ï¼Œä»»ä¸€éµå€¼ k åœ¨ç¯€é» p / ç¯€é» q å¿…é ˆæ»¿è¶³ä»¥ä¸‹ä»»ä¸€æ¢ä»¶\nåœ¨ç¯€é» p è·Ÿç¯€é» q ä¸­åŒä¸€å€‹ key version æ˜¯ä¸€æ¨£ï¼Œä»£è¡¨è³‡æ–™å·²ç¶“åŒæ­¥ å¦‚æœç¯€é» p çš„ key version è·Ÿç¯€é» q ä¸åŒï¼Œå‰‡æ­¤ version å¿…é ˆæ¯”æ˜¯ç¯€é»q ä¸­ä»»æ„æœ€å¤§çš„ç‰ˆè™Ÿé‚„è¦å¤§ ç¬¬äºŒé»éå¸¸é‡è¦ï¼Œé€™æ˜¯ä¿æŒæ¯æ¬¡æ›´æ–°ä¸éœ€è¦æ•´åŒ…é€ï¼Œå…ˆå¾ç‰ˆæœ¬åˆ¤æ–·å°±èƒ½åˆ¤æ–·å“ªäº›æ¬„ä½çœŸçš„éœ€è¦æ›´æ–°çš„ä¾æ“š\nä¾†çœ‹ä¸€å€‹å¯¦éš›æ¡ˆä¾‹ï¼Œç›®å‰æœ‰ä¸‰å€‹ç¯€é» r,p,qï¼Œå…±æœ‰ 3 å€‹ key a,b,cï¼Œå¯ä»¥çœ‹åˆ° t1 æ™‚ r çš„ä¸‰å€‹ key éƒ½è¢«æ›´æ–°éï¼Œç‰ˆè™Ÿåˆ†åˆ¥æ˜¯ 21/22/23ï¼›\næ­¤æ™‚ r è¦å‘ p,q ç™¼é€ gossip messageï¼Œä»–å¿…é ˆå…ˆå¾ a é–‹å§‹ï¼Œå› ç‚ºé€™æ˜¯ a,b,c ä¸‰è€…ä¸­ç‰ˆè™Ÿæœ€å°ï¼Œä¸”å¤§æ–¼ Âµq(p) / Âµp(p) ï¼Œé€™æ„å‘³è‘—ç¯€é» p å’Œ ç¯€é»q éƒ½è¦æ›´æ–°ï¼Œæ‰€ä»¥ r æœƒåŒæ™‚é€è¨Šæ¯çµ¦ p , qï¼Œåœ¨ t2 æ™‚åªæœ‰ key a å…ˆè¢«æ›´æ–°\nå¯ä»¥å›å»çœ‹ Gossip ä»‹ç´¹(ä¸Š)çš„ GossipDigestSynMessage éƒ¨åˆ†\né›–ç„¶èªªä¸€æ¬¡åªæ›´æ–°ä¸€å€‹éµå€¼æ•ˆç‡å¥½åƒå¾ˆä½ï¼Œä½†å„ªé»æ˜¯ r ä¸éœ€è¦é€å·²ç¶“æ›´æ–°éçš„å€¼ï¼Œæ¸›å°‘é‡è¤‡ï¼Œåœ¨é »å¯¬æœ‰é™æƒ…æ³ä¸‹ï¼ŒScuttlebutt ä¹Ÿå¿…é ˆæ±ºå®š gossip message å‚³é€çš„å„ªå…ˆåºï¼Œé€™è£¡æœ‰å…©ç¨®åšæ³•\nscuttle-breadth: åœ¨åŒä¸€å€‹ participant ä¸­ï¼Œå°‡ delta ç”¨ version å¾å°åˆ°å¤§æ’åºï¼Œå¦‚æœå…©å€‹ä¸åŒ delta çš„ version ç›¸åŒï¼Œå‰‡éš¨æ©ŸæŠ½ participant ç™¼é€ scuttle-depth: åœ¨ participant ä¸­ï¼Œåªæœ‰éµå€¼æœ‰è½å·®å°±ç®—ä¸€å€‹ deltaï¼Œå¾ delta æœ€å¤šçš„ participant é–‹å§‹é€ï¼Œæ‰€ä»¥æœ‰å¯èƒ½éƒ½é€çµ¦åŒä¸€å€‹ participant å¯¦é©—çµæœ ç¸½å…± 128 participants èˆ‡ 64 çµ„ key/ valueï¼Œæ¯ç§’æ¯å€‹ participant gossip ä¸€æ¬¡ï¼› å‰ 15 sec æš–æ©Ÿï¼Œä¸¦é–‹å§‹é™ç¸®é »å¯¬ / 25 ç§’é–‹å§‹åŠ å€æ›´æ–°é »ç‡ / 75 ç§’æ›´æ–°é »ç‡å›æ­¸æ­£å¸¸ / 120 sec åœæ­¢æ›´æ–°ï¼Œä¸­é–“ 25~75 åŠ å¤§æµé‡ä¸»è¦æ˜¯æƒ³è¦çœ‹æ¼”ç®—æ³•åœ¨é«˜è² è¼‰ä¸‹çš„è¡¨ç¾ï¼Œä»¥åŠé«˜å³°éå»å¾Œçš„æ¢å¾©é€Ÿåº¦\nç¬¬ä¸€å¼µåœ–è¡¨ä»£è¡¨é€™ä¸€å€‹æ™‚é–“ä¸Šï¼Œè©²éµå€¼è‡ªå¾ä¸Šæ¬¡è¢«æ›´æ–°å¾Œéš”äº†å¤šä¹…æ‰æ”¶åˆ°æœ€æ–°è³‡è¨Šï¼Œè¶Šä½è€…è¶Šå¥½ staleness of such a mapping Âµq (p)(k) is the amount of time that has lapsed since Âµq(p)(k) was last updated\nç¬¬äºŒå¼µåœ–è¡¨ä»£è¡¨é€™ä¸€å€‹æ™‚é–“æœ‰å¤šå°‘å€‹éµå€¼æ˜¯éæœŸçš„ ï¼Œè¶Šä½è€…è¶Šå¥½ reports the number of stale mappings as a function of time\näº¤å‰æ¯”å°æœ‰ä»¥ä¸‹çµè«–\nScuttle-depth è¡¨ç¾å„ªç•° Precise-newest å¯ä»¥çœ‹å‡ºæœ‰ starvation ç‹€æ³ï¼Œä¹Ÿå°±æ˜¯æœ‰éµå€¼å¾ˆä¹…æ²’æœ‰è¢«æ›´æ–° (åœ–ä¸€ä»–æœ€é«˜)ï¼Œä½†æ˜¯çœŸæ­£å½±éŸ¿åˆ°çš„éµå€¼å…¶å¯¦æ˜¯å°‘æ•¸ (åŒä¸€æ™‚é–“é»å…¶å¯¦éæœŸçš„éµå€¼æ•¸ä¸å¤š)ï¼Œä½†æ˜¯é«˜å³°éå»æ”¶æ–‚å¾ˆå¿« å…¶é¤˜å…©è€…è¡¨ç¾æ™®æ™® Flow Control åœ¨ä¸€äº›æƒ…æ³ä¸‹ï¼Œparticipant äº¤æ›è¨Šæ¯æ™‚æ›´æ–°é »ç‡å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æœƒéœ€è¦ä¸€å€‹æµé‡æ§åˆ¶çš„æ¼”ç®—æ³•ï¼Œå»å¹³è¡¡ä¸€å€‹ participant æƒ³è¦å¢åŠ æ›´æ–°é »ç‡è€Œå¦ä¸€å€‹æƒ³è¦é™ä½é »ç‡çš„å¯èƒ½ï¼Œè¦è£½é€ å‡ºé€™æ¨£çš„ä¸åŒæ›´æ–°é »ç‡ï¼Œä½†åŒæ™‚ç³»çµ±å¿…é ˆç¶­æŒç›¸åŒçš„æœ€å¤§äº¤æ›é »ç‡ä¸Šé™\nåœ¨ participant äº¤æ› gossip æ™‚ï¼Œæœƒé€£å¸¶äº¤æ›å½¼æ­¤é è¨­æ›´æ–°çš„é »ç‡ (Ïp , Ïq)ä»¥åŠæœ€å¤§å€¼ (Ï„p,Ï„q )ï¼Œç•¶å…©å€‹ participant åœ¨äº¤æ›æ™‚æœƒé †ä¾¿äº¤æ›\næ©Ÿåˆ¶æœ‰é»é¡ä¼¼æ–¼ TCP çš„ Additive Increase Multiplicative Decrease (AIMD)ï¼Œé€æ¼¸å¢åŠ ç™¼é€çš„é »ç‡ä½†é‡åˆ°éŒ¯èª¤æ™‚å¿«é€Ÿæ¸›å°‘ï¼›\nå¦‚æœè¦ç™¼é€çš„ delta æ•¸é‡é«˜æ–¼ MTUï¼Œå‰‡ç·šæ€§å¢åŠ ï¼Œåä¹‹ï¼Œå‰‡å€æ•¸æ¸›å°‘\nå¯¦é©—éç¨‹æ˜¯åœ¨ t = 90 æ™‚é™ç¸® mtu å¾ 100 é™åˆ° 50ï¼Œå¯ä»¥çœ‹åˆ° 90 ä¹‹å¾Œ max out of date å¤§å¹…å¢åŠ ï¼Œä¹‹å¾Œæ‰æ…¢æ…¢æ”¶æ–‚ï¼Œå…¶ä¸­ scuttle-depth åœ¨è¡¨ç¾ä¸Šæ¯”è¼ƒç©©å®š é€™ä¸€ç« ç¯€æ¯”è¼ƒä¸ç¢ºå®šï¼Œå¦‚æœæœ‰ä»€éº¼éŒ¯èª¤éº»ç…©æŒ‡æ•™ ğŸ™\nç¸½çµ æœ¬ç¯‡æå‡ºå…©å€‹é‡é»\næ–°çš„ reconciliation æ©Ÿåˆ¶ï¼ŒåŠ é€ŸåŒæ­¥çš„æ•ˆç‡ï¼ŒåŒæ™‚é¿å… starvation å¼•å…¥ flow control æ©Ÿåˆ¶ï¼Œè®“ participant å¯ä»¥ç”¨åˆç†çš„é€Ÿåº¦æ›´æ–° å¯¦ä½œé¢ ç¶²è·¯ä¸Šæ‰¾äº†ä¸€å€‹ nodejs ç‰ˆæœ¬çš„ gossip protocol å¯¦ä½œ node-gossipï¼Œçœ‹èµ·ä¾†æ˜¯ä½¿ç”¨ scuttle-depth å”è­°æ©Ÿåˆ¶ è¨ˆç®—èˆ‡ peer ä¸­çš„ delta æœ€å¤šçš„ï¼Œæ¥è‘—å…ˆæŒ‰ç…§ peer ä¸­æœ€èˆŠçš„ version é–‹å§‹æ’åº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Sort by peers with most deltas deltas_with_peer.sort( function(a,b) { return b.deltas.length - a.deltas.length } ); var deltas = []; for(i in deltas_with_peer) { var peer = deltas_with_peer[i]; var peer_deltas = peer.deltas; // Sort deltas by version number peer_deltas.sort(function(a,b) { return a[2] - b[2]; }) if(peer_deltas.length \u0026gt; 1) { // console.log(peer_deltas); } for(j in peer_deltas) { var delta = peer_deltas[j]; delta.unshift(peer.peer); deltas.push(delta); } } ","date":"2020-10-28T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-10-28-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8B-efficient-reconciliation-and-flow-control-for-anti-entropy-protocols%E8%AB%96%E6%96%87%E6%91%98%E8%A6%81/","title":"Gossip Protocol ä»‹ç´¹ (ä¸‹) - ã€ŠEfficient Reconciliation and Flow Control for Anti-Entropy Protocolsã€‹è«–æ–‡æ‘˜è¦"},{"content":"Gossip Protocol æ˜¯ä¸€ç¨®é€šè¨Šæ©Ÿåˆ¶ï¼Œæ‡‰ç”¨æ–¼åŒä¸€ç¶²è·¯å…§æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“äº¤æ›è¨Šæ¯ï¼ŒåŸç†é¡ä¼¼æ–¼è¾¦å…¬å®¤å‚³è¬ è¨€ä¸€æ¨£ï¼Œä¸€å€‹å‚³ä¸€å€‹ï¼Œæœ€çµ‚æ¯ä¸€å€‹æ©Ÿå™¨éƒ½æ“æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œåˆç¨± Epidemic Protocol\nå¯¦å‹™ä¸Šæœ‰å¹¾å€‹å¥½è™•\nå»ä¸­å¿ƒåŒ–:\næ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“ç›´æ¥æºé€š (peer to peer) å®¹éŒ¯ç‡é«˜:\nå³ä¾¿ç¯€é»èˆ‡ç¯€é»ä¹‹é–“ç„¡æ³•ç›´æ¥ç›¸é€£ï¼Œåªæœ‰æœ‰å…¶ä»– ç¯€é» å¯ä»¥å‚³éç‹€æ…‹ï¼Œä¹Ÿå¯ä»¥ç¶­æŒä¸€è‡´çš„ç‹€æ…‹ æ•ˆç‡é«˜ä¸”å¯é  Gossip Protocol è¢«å»£æ³›æ¡ç´ï¼Œå¦‚Cassandra / Redis Cluster / Consul ç­‰é›†ç¾¤æ¶æ§‹ï¼Œä»¥ä¸‹å°‡å¾ Cassandra çš„å¯¦ä½œä¾†ç†è§£ Gossip Protocol\nApple Inc.: Cassandra Internals â€” Understanding Gossip å…ˆå¾å¯¦å‹™é¢ä¾†çœ‹ï¼ŒGossip Protocol åœ¨ Cassandra ä¸­ä¸»è¦ç”¨æ–¼åŒæ­¥ ç¯€é» çš„ Metadataï¼ŒåŒ…å«\ncluster membership heartbeat node status\nåŒæ™‚æ¯å€‹ç¯€é»éƒ½æœƒä¿å­˜ä¸€ä»½å…¶ä»–ç¯€é»ç‹€æ…‹çš„ Mapping Table æ›´å…·é«”ä¾†çœ‹ç¯€é»ç‹€æ…‹æ‰€ä¿å­˜çš„è³‡æ–™æ ¼å¼\nHeartbeatState:\næ¯ä¸€å€‹ç¯€é»æœƒæœ‰ä¸€å€‹ HeartbeatStateï¼Œç´€éŒ„ generation / versionï¼Œgeneration æ˜¯ç¯€é»å•Ÿå‹•æ™‚çš„ timestampï¼Œç”¨ä¾†å€åˆ†æ©Ÿå™¨æ˜¯å¦é‡æ–°å•Ÿå‹•éï¼›version å‰‡æ˜¯éå¢æ•¸å€¼ï¼Œæ¯æ¬¡ ApplicationState æœ‰å€¼æ›´æ–°æ™‚å°±æœƒéå¢ æ‰€ä»¥åŒä¸€å€‹ç¯€é»å…§çš„ ApplicationState version ä¸æœƒé‡è¤‡ï¼Œä¸” version æ¯”è¼ƒå¤§ä¸€å®šä»£è¡¨é€™å€‹éµå€¼æ¯”è¼ƒæ–°\nApplicationState: ä¸€å€‹ç”±{enum_name, value, version}å»ºç«‹çš„ tupleï¼Œenum_name ä»£è¡¨å›ºå®šçš„ key åç¨±ï¼Œversion å‰‡è¡¨ç¤º value çš„ç‰ˆæœ¬è™Ÿç¢¼ï¼Œè™Ÿç¢¼å¤§è€…å‰‡ä»£è¡¨è³‡æ–™è¼ƒæ–° EndpointState: ç´€éŒ„æŸä¸€å€‹ç¯€é»ä¸‹æ‰€æœ‰çš„ ApplicationState EndpointStateMapping: ä¸€å€‹ç¯€é»æœƒæœ‰ä¸€å¼µé‡å°å·²çŸ¥çš„ç¯€é»æ‰€ç´€éŒ„çš„ EndpointStateï¼ŒåŒæ™‚æœƒåŒ…å«è‡ªå·±çš„ç‹€æ…‹ å¦‚ä¸‹åœ–\n1 2 3 4 5 6 7 8 9 10 EndPointState 10.0.0.1 HeartBeatState: generation 1259909635, version 325 ApplicationState \u0026#34;load-information\u0026#34;: 5.2, generation 1259909635, version 45 ApplicationState \u0026#34;bootstrapping\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 56 ApplicationState \u0026#34;normal\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 87 EndPointState 10.0.0.2 HeartBeatState: generation 1259911052, version 61 ApplicationState \u0026#34;load-information\u0026#34;: 2.7, generation 1259911052, version 2 ApplicationState \u0026#34;bootstrapping\u0026#34;: AujDMftpyUvebtnn, generation 1259911052, version 31 ..... é€™é‚Šå¯ä»¥çœ‹åˆ°ç¯€é» 10.0.0.1 æ‰€ä¿å­˜çš„ EndPointStateMap æœ‰å…©ç­† EndPointStateï¼Œå…¶ä¸­ 10.0.0.1 çš„ HeartBeatState æ˜¯ generation 1259909635, version 325ï¼Œé€™ä»£è¡¨ 10.0.0.1 æ˜¯åœ¨ 1259909635 æ™‚å•Ÿå‹•çš„ï¼Œä¸¦ä¸”ä»–ç›®å‰ä¿å­˜æ¬„ä½ä¸­æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ 325ï¼›\næ¥è‘—çœ‹ ApplicationState \u0026quot;load-information\u0026quot;: 5.2, generation 1259909635, version 45ï¼Œé€™ä»£è¡¨ç¯€é»å…§ \u0026ldquo;load-information\u0026rdquo; é€™å€‹ Key å°æ‡‰çš„å€¼æ˜¯ 5.2 ä»¥åŠç•¶æ™‚æ”¶åˆ°çš„ generation èˆ‡ versionï¼Œå¾Œå…©è€…ç”¨ä¾†æ±ºå®š é€™å€‹ key æ”¶åˆ°è¨Šæ¯å¾Œè¦ä¸è¦æ›´æ–°çš„ä¾æ“š\nGossip Messaging æ¥è‘—ä¾†çœ‹æ¯æ¬¡ Gossip çš„å¯¦ä½œæµç¨‹ï¼Œæ¯å€‹ç¯€é»æœƒåœ¨æ¯ä¸€ç§’å•Ÿå‹•ä¸€å€‹æ–°çš„ gossip å›åˆ\næŒ‘å‡º 1~3 çš„ç¯€é»ï¼Œå„ªå…ˆé¸æ“‡ live ç‹€æ…‹çš„ç¯€é»ï¼Œæ¥è‘—æœƒæ©Ÿç‡æ€§é¸æ“‡ Seed ç¯€é» / å…ˆå‰åˆ¤å®šå·²ç¶“é›¢ç¶«çš„ç¯€é» å‚³éè¨Šæ¯çš„æµç¨‹æ˜¯ SYN / ACK / ACK2 (é¡ä¼¼æ–¼ TCP çš„3æ¬¡äº¤æ¡) å‡è¨­ç¾åœ¨æ˜¯ç¯€é» A è¦å‚³è¨Šæ¯çµ¦ ç¯€é» B é—œæ–¼ç¯€é» C çš„ Gossip\nGossipDigestSynMessage :\nç¯€é» A è¦ç™¼é€çš„ SYN è¨Šæ¯åŒ…å« {ipAddr, generation, heartbeat}ï¼Œéœ€æ³¨æ„æ­¤æ™‚åªè¦é€ HeartbeatStateï¼Œè€Œæ²’æœ‰é€è©³ç´°çš„ ApplicationStateï¼Œé¿å…å¤šé¤˜çš„è³‡æ–™å‚³è¼¸ GossipDigestAckMessage :\nç¯€é» B æ”¶åˆ°å¾Œï¼Œæœƒå»æ¯”å°ä»–è‡ªå·±æš«å­˜ç¯€é» C çš„ç‹€æ…‹ï¼Œé‹ç®—å…©è€…å·®ç•° a. ç¯€é» A çš„è³‡æ–™æ¯”è¼ƒæ–°ï¼Œå‰‡ç¯€é» B æœƒæº–å‚™è·Ÿç¯€é» A è¦æ–°çš„è³‡æ–™\nb. ç¯€é» B çš„è³‡æ–™æ¯”è¼ƒæ–°ï¼Œæ‰“åŒ…è¦æ›´æ–°çš„ ApplicationState å›å‚³ ACK é€šçŸ¥ç¯€é» A GossipDigestAck2Message :\nç¯€é» A æ”¶åˆ° ACK å¾Œï¼Œæ›´æ–°è‡ªå·±æš«å­˜çš„è³‡æ–™ï¼Œä¸¦ä¸”æ ¹æ“š (2.a) ä¸­ç¯€é» B æ‰€éœ€è¦çš„ ApplicationStateï¼Œå›å‚³ ACK2 æœƒå¤šä¸€å€‹ ACK2 æ˜¯ç‚ºäº†è®“é€šè¨Šæ›´ç©©å®šï¼Œé”åˆ°æ›´å¿«æ”¶æ–‚çš„ä½œç”¨ï¼Œä½†é€™é‚Šå¦‚æœ ç¯€é» B æ²’æ”¶åˆ° ACK2 æ˜¯å¦æœƒé‡è©¦ç­‰å¦‚åŒ TCP ä½œæ³•å°±æ²’æœ‰æåŠ\nç¸½çµä¾†çœ‹å‚³é€è¨Šæ¯çš„éç¨‹ï¼Œåœ¨ Cluster æ²’æœ‰ç¯€é»ç‹€æ…‹ç•°å‹•ä¸‹ï¼Œå‚³é€çš„è¨Šæ¯é‡æ˜¯å›ºå®šçš„ï¼Œä¸æœƒæœ‰ Gossip Storm ç¶²è·¯å°åŒ…çªç„¶çˆ†é‡çš„æƒ…æ³ï¼› é™¤éæ˜¯æœ‰ç¯€é» æ–°åŠ å…¥ï¼Œå¤šå€‹ç¯€é» å¸Œæœ›åŒæ­¥è³‡è¨Šæ‰æœ‰å¯èƒ½\nä¾†çœ‹å¯¦éš›æ¡ˆä¾‹ï¼Œå‡è¨­ ç›®å‰æœ‰ç¯€é»A (10.0.0.1)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 EndPointState 10.0.0.1 HeartBeatState: generation 1259909635, version 325 ApplicationState \u0026#34;load-information\u0026#34;: 5.2, generation 1259909635, version 45 ApplicationState \u0026#34;bootstrapping\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 56 ApplicationState \u0026#34;normal\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 87 EndPointState 10.0.0.2 HeartBeatState: generation 1259911052, version 61 ApplicationState \u0026#34;load-information\u0026#34;: 2.7, generation 1259911052, version 2 ApplicationState \u0026#34;bootstrapping\u0026#34;: AujDMftpyUvebtnn, generation 1259911052, version 31 EndPointState 10.0.0.3 HeartBeatState: generation 1259912238, version 5 ApplicationState \u0026#34;load-information\u0026#34;: 12.0, generation 1259912238, version 3 EndPointState 10.0.0.4 HeartBeatState: generation 1259912942, version 18 ApplicationState \u0026#34;load-information\u0026#34;: 6.7, generation 1259912942, version 3 ApplicationState \u0026#34;normal\u0026#34;: bj05IVc0lvRXw2xH, generation 1259912942, version 7 ä»¥åŠç¯€é»B (10.0.0.2)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 EndPointState 10.0.0.1 HeartBeatState: generation 1259909635, version 324 ApplicationState \u0026#34;load-information\u0026#34;: 5.2, generation 1259909635, version 45 ApplicationState \u0026#34;bootstrapping\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 56 ApplicationState \u0026#34;normal\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 87 EndPointState 10.0.0.2 HeartBeatState: generation 1259911052, version 63 ApplicationState \u0026#34;load-information\u0026#34;: 2.7, generation 1259911052, version 2 ApplicationState \u0026#34;bootstrapping\u0026#34;: AujDMftpyUvebtnn, generation 1259911052, version 31 ApplicationState \u0026#34;normal\u0026#34;: AujDMftpyUvebtnn, generation 1259911052, version 62 EndPointState 10.0.0.3 HeartBeatState: generation 1259812143, version 2142 ApplicationState \u0026#34;load-information\u0026#34;: 16.0, generation 1259812143, version 1803 ApplicationState \u0026#34;normal\u0026#34;: W2U1XYUC3wMppcY7, generation 1259812143, version 6 ç¯€é»A æ±ºå®šå‘ç¯€é»B ç™¼èµ· Gossip ç”¢ç”Ÿçš„ GossipDigestSynMessage æœƒæ˜¯é¡ä¼¼æ–¼ 10.0.0.1:1259909635:325 10.0.0.2:1259911052:61 10.0.0.3:1259912238:5 10.0.0.4:1259912942:18ï¼Œä¸»è¦æ˜¯å‚³é€ Node IP:generation:version\nç¯€é»B æ”¶åˆ° GossipDigestSynMessage æœƒæœ‰ä»¥ä¸‹æµç¨‹\nè·Ÿè‡ªå·±çš„ç‹€æ…‹æ¯”è¼ƒï¼Œå¾å·®ç•°æœ€å¤šçš„éæ¸›æ’åºï¼Œé€™æ„å‘³è‘—å„ªå…ˆè™•ç†å·®ç•°æœ€å¤šçš„ç¯€é»è³‡è¨Š æ¥è‘—æª¢é©—æ¯ä¸€å€‹ç¯€é»çš„è³‡æ–™ -ç¯€é»A æ‰€ä¿å­˜çš„ 10.0.0.1:1259909635:325 æœƒå¤§æ–¼ç¯€é»B æ‰€ä¿å­˜çš„10.0.0.1:1259909635:324ï¼Œgeneration ä¸€æ¨£æ‰€ä»¥ç•¥éï¼Œä½†æ˜¯ version 325 \u0026gt; 324ï¼Œå‰‡ä»£è¡¨ç¯€é»B éœ€è¦å‘ç¯€é» A ç´¢å– 10.0.0.1 åœ¨ ApplicationState åœ¨ç‰ˆæœ¬ 324 ä¹‹å¾Œçš„è³‡æ–™ 10.0.0.2:1259911052:61 æ¯”ç¯€é»B ä¿å­˜çš„ç‰ˆæœ¬é‚„è¦å°ï¼Œæ‰€ä»¥åˆ°æ™‚å€™æœƒæ‰“åŒ…è³‡æ–™çµ¦ç¯€é»A 10.0.0.3:1259912238:5 éƒ¨åˆ†ç¯€é»B generation æ¯”è¼ƒå°ï¼Œé€™æ„å‘³è‘— 10.0.0.3 æœ‰ reboot éï¼Œæ‰€ä»¥ç¯€é»B éœ€è¦æ›´æ–°å…¨éƒ¨çš„è³‡æ–™ 10.0.0.4:1259912942:18ç¯€é»B æ ¹æœ¬æ²’æœ‰ 10.0.0.4 çš„è³‡æ–™ï¼Œæ‰€ä»¥éœ€è¦å…¨éƒ¨çš„è³‡æ–™ çµ„åˆä»¥ä¸Šçµæœ GossipDigestAckMessageçš„å…§å®¹æœƒæ˜¯\n1 2 3 4 10.0.0.1:1259909635:324 10.0.0.3:1259912238:0 10.0.0.4:1259912942:0 10.0.0.2:[ApplicationState \u0026#34;normal\u0026#34;: AujDMftpyUvebtnn, generation 1259911052, version 62], [HeartBeatState, generation 1259911052, version 63] é€™ä»£è¡¨è‘—\nè«‹çµ¦æˆ‘ 10.0.0.1 åœ¨ generation 1259909635 ä¸­ version 324 ä»¥å¾Œçš„æ›´æ–°è³‡æ–™ è«‹çµ¦æˆ‘ 10.0.0.3 åœ¨ generation 1259912238 å…¨éƒ¨è³‡æ–™ (version:0) 10.0.0.4 åŒä¸Š é€™æ˜¯ä½ éœ€è¦æ›´æ–°é—œæ–¼ 10.0.0.2 çš„ ApplicationState è³‡æ–™ ç¯€é»A å›è¦† GossipDigestAck2Message ç¯€é»A æ”¶åˆ°å¾Œï¼Œæ›´æ–°å®Œ 10.0.0.2 çš„è³‡è¨Šå¾Œï¼Œæ¥è‘—å›è¦†ç¯€é»B æ‰€è¦çš„è³‡æ–™\n1 2 3 10.0.0.1:[ApplicationState \u0026#34;load-information\u0026#34;: 5.2, generation 1259909635, version 45], [ApplicationState \u0026#34;bootstrapping\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 56], [ApplicationState \u0026#34;normal\u0026#34;: bxLpassF3XD8Kyks, generation 1259909635, version 87], [HeartBeatState, generation 1259909635, version 325] 10.0.0.3:[ApplicationState \u0026#34;load-information\u0026#34;: 12.0, generation 1259912238, version 3], [HeartBeatState, generation 1259912238, version 3] 10.0.0.4:[ApplicationState \u0026#34;load-information\u0026#34;: 6.7, generation 1259912942, version 3], [ApplicationState \u0026#34;normal\u0026#34;: bj05IVc0lvRXw2xH, generation 1259912942, version 7], [HeartBeatState: generation 1259912942, version 18] é€™æ¨£å°±å®Œæˆä¸€è¼ªçš„ Gossip äº†\nå¯ä»¥çœ‹å‡ºç‚ºä»€éº¼ HeartbeatState çš„ version æœƒèˆ‡ ApplicationState å…±äº«ï¼Œé€™é‚Šçš„å…±äº«æŒ‡çš„æ˜¯åœ¨åŒä¸€å€‹ç¯€é»ä¸‹ ApplicationState çš„ version å¿…é ˆæ˜¯ç¨ä¸€ç„¡äºŒä¸”éå¢ï¼Œé€™æ¨£æ‰èƒ½åœ¨ SYN æ™‚åªå‚³é€ HeartbeatState ç›´æ¥åˆ¤æ–·æœ‰å“ªäº›æ¬„ä½éœ€è¦æ›´æ–°\nä»¥ä¸Šç¯„ä¾‹æ•´ç†è‡ª ArchitectureGossip\nå…¶ä»–é›†ç¾¤ä¸Šçš„ç®¡ç† é›†ç¾¤ç®¡ç†ä¸Šï¼Œé™¤äº†é€é Gossip Protocol åŒæ­¥è³‡è¨Šå¤–ï¼Œé‚„æœ‰å¹¾å€‹å•é¡Œè¦è§£æ±º\nèª°åœ¨ Cluster ç•¶ä¸­ å¦‚ä½•æ±ºå®šç¯€é»çš„ç‹€æ…‹æ˜¯ Up / Downï¼Œé€™åˆæœƒå¸¶ä¾†ä»€éº¼å½±éŸ¿ ä½•æ™‚è¦çµ‚æ­¢è·ŸæŸç¯€é»çš„é€šè¨Š æ‡‰è©²è¦åå¥½èˆ‡å“ªå€‹ç¯€é»é€šè¨“ å¢åŠ /ç§»é™¤/åˆªé™¤/å–ä»£ç¯€é»æ™‚å¦‚ä½•å¯¦ä½œ èª°åœ¨ Cluster ç•¶ä¸­ ç•¶ä¸€å€‹æ–°çš„ç¯€é»è¦å•Ÿå‹•æ™‚ï¼Œä»–å¿…é ˆè¦çŸ¥é“é›†ç¾¤ä¸­æœ‰å“ªäº›ç¯€é»å» Gossipï¼Œåœ¨ Cassandra çš„è¨­å®šæª”ä¸­å¯ä»¥æŒ‡å®š Seedï¼Œæœ‰ä¸åŒçš„ä½œæ³•å¯ä»¥æŒ‡å®šï¼Œå¸¸è¦‹æ˜¯å¯«æ­»æŸä¸€äº›ç¯€é»çš„ ip addrï¼Œç¯€é»å•Ÿå‹•å¾Œå°±è·Ÿ Seed ç¯€é»æºé€šï¼Œå¾ŒçºŒå°±é€é Gossip Protocol å–å¾—æ‰€æœ‰ç¯€é»çš„ç‹€æ…‹èˆ‡ IP\nåœ¨ Consul ä¸­ï¼Œæœƒè‡ªå·±é€éå»£æ’­åœ¨ LAN è£¡é¢è‡ªå‹•ç™¼ç¾æœ‰æ²’æœ‰å…¶ä»–ç¯€é»ï¼Œåœ¨ EC2 ä¸Šé‚„å¯ä»¥æŒ‡å®š EC2 Tag å»æ‰¾å‡ºå…¶ä»–ç¯€é»\nFailure Detection: æ±ºå®šç¯€é»æ˜¯ Up æˆ– Down åœ¨ Cassandra ä¸­ï¼ŒéŒ¯èª¤åµæ¸¬æ˜¯è©²ç¯€é»åœ¨æœ¬åœ°ç«¯æ±ºå®šæŸç¯€é»çš„ç‹€æ…‹ï¼Œè€Œé€™å€‹ç‹€æ…‹ä¸æœƒéš¨è‘— Gossip æ‰€å‚³é€\nex.ç¯€é»A è¦ºå¾—ç¯€é»B æ˜¯ Downï¼Œç•¶ç¯€é»A è·Ÿç¯€é»C Gossip æ™‚ï¼Œç¯€é»C ä¸æœƒå› ç‚ºç¯€é»A è€ŒæŠŠç¯€é»B åˆ¤æ–·æˆ Downï¼Œç¯€é» C æœƒè‡ªè¡Œåˆ¤æ–·\nåµæ¸¬çš„æ–¹å¼é€é Heartbeatï¼ŒHeartbeat å¯ä»¥æ˜¯ç¯€é»è·Ÿç¯€é»ç›´æ¥ç”¨ Gossip é€šè¨Šï¼Œä¹Ÿå¯ä»¥æ˜¯å¾å…¶ä»–ç¯€é»é–“æ¥å–å¾— Gossipï¼›\nç¯€é»æœƒè¨ˆç®—æ¯æ¬¡ Heartbeat çš„é–“éš”ï¼Œç•¶è¶…é phi_convict_threshold å‰‡åˆ¤å®šç‚º Downï¼Œç³»çµ±éœ€è¦å› æ‡‰ç¡¬é«”ç‹€æ…‹/ç¶²è·¯ç’°å¢ƒå»èª¿æ•´é–¥å€¼ï¼Œé¿å…å¤ªæ•æ„Ÿèª¤åˆ¤æˆ–æ˜¯å¤ªé²éˆè€Œåæ‡‰ä¸åŠç­‰ç‹€æ³\nåœ¨ç¯€é»æ–·ç·šçš„æ™‚å€™ï¼Œå…¶ä»–ç¯€é»éƒ¨åˆ†çš„å¯«å…¥å¯èƒ½å› æ­¤æ²’æœ‰æ”¶åˆ° ACK å›è¦†ï¼Œæ­¤æ™‚æœƒæš«å­˜åœ¨æœ¬åœ°ç•¶ä½œ Hintï¼Œå¦‚æœç¯€é»åœ¨ä¸€å®šæ™‚é–“å…§æ¢å¾©ï¼Œå‰‡æœƒé€é Hint é‡æ–°å‚³é€å¯«å…¥ï¼Œä¿®å¾©æ‰è³‡æ–™çš„å¯èƒ½\nå¦‚æœç¯€é»é‡æ–°æ¢å¾©æ™‚ï¼Œå…¶ä»–ç¯€é»æœƒå®šæœŸé‡é€ Gossip çµ¦ Offline ç¯€é»ï¼Œå±†æ™‚å°±èƒ½æŠŠ Down èª¿æ•´å› Up\nç¯€é»åå¥½ é™¤äº†éŒ¯èª¤åµæ¸¬å¤–ï¼ŒCassandra å…§éƒ¨æœ‰æ¨¡çµ„ Dynamic Snitch å°ˆé–€åšç¯€é»é–“çš„é€šè¨Šå“è³ªåµæ¸¬ï¼Œæ¯ 100 msè¨ˆç®—èˆ‡å…¶ä»–ç¯€é»çš„å»¶é²ï¼Œè—‰æ­¤æ‰¾å‡ºè¡¨ç¾è¼ƒå¥½çš„ç¯€é»ï¼›\nç‚ºäº†é¿å…ä¸€æ™‚ç¶²è·¯æ³¢å‹•ï¼Œæ¯ 10 åˆ†é˜å°±æœƒé‡æ–°è¨ˆç®—\nå…¶é¤˜çš„ç¯€é»ç®¡ç†å°±æš«æ™‚ç•¥éï¼Œå°æ–¼ç†è§£ Gossip Protocol ä¸å¤§\nçµèª åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œç¯€é»çš„ç‹€æ…‹åŒæ­¥ååˆ†åŸºç¤ä¸”é‡è¦ï¼Œè€Œ Gossip Protocol ç›®å‰æ˜¯è¢«å»£æ³›æ‡‰ç”¨çš„è§£æ³•ï¼Œæ¨¡æ“¬äººé¡å‚³é€å…«å¦çš„æ–¹å¼ï¼Œæƒ³ä¸åˆ°åœ¨æ©Ÿå™¨ä¹Ÿä¸€æ¨£é©ç”¨\næ•´é«”æœ€æœ‰è¶£çš„è¨­è¨ˆæ‡‰è©²åœ¨æ–¼ generation / version çš„å¯¦ä½œï¼Œé€é generation å¯ä»¥çŸ¥é“æ©Ÿå™¨é‡å•Ÿéå¾Œè¦ä¸è¦é‡æ–°è¦è³‡æ–™ï¼›é€é version å¯ä»¥å¿«é€Ÿ diff åƒ…æœ‰å“ªäº›è³‡æ–™è¦æ›´æ–°ï¼Œé¿å…é¡å¤–çš„å‚³è¼¸æµªè²»ï¼Œä¸‹ä¸€ç¯‡å°‡å¾ç†è«–ä¸Šå»åˆ†æ Gossip Protocol\n","date":"2020-10-26T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8A-%E5%BE%9E-cassandra-%E5%85%A7%E9%83%A8%E5%AF%A6%E4%BD%9C%E8%AA%8D%E8%AD%98-gossip-protocol-%E7%9A%84%E4%BD%BF%E7%94%A8/","title":"Gossip Protocol ä»‹ç´¹ (ä¸Š) - å¾ Cassandra å…§éƒ¨å¯¦ä½œèªè­˜ Gossip Protocol çš„ä½¿ç”¨"},{"content":"é›–ç„¶ Redis Cluster æ¨å‡ºå·²ä¹…ï¼Œä½†å…¬å¸æœ€è¿‘æ‰æº–å‚™å¾ Sentinel è½‰æˆ Clusterï¼Œæ¶æ§‹ä¸Šæœ‰ä¸å°‘çš„èª¿æ•´ï¼Œä»¥ä¸‹é–±è®€æ–‡ä»¶ Redis Cluster Specificationä¸¦æ‘˜è¦\nOverview å¯ä»¥ç”±ä¸€è‡³å¤šå€‹ replica çµ„æˆï¼Œæ¯ä¸€å€‹ replica åˆ†é…å›ºå®šçš„ slotï¼Œé€é CRC å°‡ key åš hash å¾Œåˆ†é…è‡³å›ºå®šçš„ replicaï¼Œslot ç¸½æ•¸å›ºå®šåœ¨ 16358 å€‹\nå‹•æ…‹å¢åŠ ã€åˆªé™¤ replicaï¼Œå¯ä»¥é€é Migrate æŒ‡ä»¤é‡æ–°åˆ†é… slot ä»»ä½•ä¸€å€‹ Node éƒ½èƒ½å¤ æ¥æ”¶ requestï¼Œä½†æ²’æœ‰ proxy åŠŸèƒ½ï¼Œæœƒé€é MOVED å›å‚³ client æ­£ç¢ºçš„ Node å¯ç”¨æ€§ï¼Œé­é‡ç¶²è·¯åˆ†å‰²æ™‚å¤šæ•¸ç¾¤é«”å¯ä»¥æ´»ä¸‹ä¾†ï¼Œæ¢ä»¶æ˜¯ replica è‡³å°‘æœ‰ä»»ä¸€ Master å­˜åœ¨ (å¾ Slave Promote æˆ Master ä¹Ÿå¯ä»¥) æ‰€æœ‰çš„å–®ä¸€key æŒ‡ä»¤æ”¯æ´ Clusterï¼Œå¦‚æœæ˜¯ multi-key æŒ‡ä»¤ä¾‹å¦‚ set union ç­‰ï¼ŒRedis æœƒç”¢ç”Ÿ hash tag å¼·è¿«æ‰€æœ‰çš„ multi-key åˆ†é…åˆ°åŒä¸€å€‹ Node ä¸Š\nNode æ¯å€‹ Node å½¼æ­¤äº’ç›¸é€é tcp é€£æ¥ï¼Œç¨±ç‚º Redis Cluster Busï¼Œé€é gossip protocol ç™¼ç¾æ–°çš„ node /ping å½¼æ­¤ / ç™¼é€ cluster message ç­‰\næ¯å€‹ Node éƒ½æœƒæœ‰ 160 bitäº‚æ•¸ IDï¼Œå³ä½¿ Cluster ip ä½ç½®æ”¹è®Šï¼ŒID ä¹Ÿä¸æœƒæ”¹è®Šï¼Œé™¤éæ˜¯ config æª”è¢«åˆªé™¤æˆ–æ˜¯ admin å¼·åˆ¶æ›¿æ› Node ä¹‹é–“æ˜¯èµ° TCP ä¸¦é€é 16739 portï¼ŒNode æœƒèˆ‡å…¶ä»– Cluster å…§çš„æ‰€æœ‰ Node ç›¸é€£è¡Œç¨‹ full mesh (N-1 connection)\nClusert Node æœƒæ¥å—ä»»æ„çš„é€£ç·šï¼Œä¸¦å›æ‡‰ä»»æ„çš„pingï¼Œä½†å…¶ä»–è¨Šæ¯åªæœ‰è¢«è¦–ç‚º cluster ä¸€éƒ¨åˆ†çš„ Node æ‰æœƒè™•ç†ï¼Œå¦å‰‡ç›´æ¥ä¸Ÿæ£„ è¦åŠ å…¥ cluster çš„é©—è­‰æœ‰å…©ç¨®æ–¹å¼\nadmin ä½¿ç”¨ CLUSTER MEET ip port åŠ å…¥ å·²ç¶“äº’ç›¸é©—è­‰éçš„ Node å£è€³ç›¸å‚³ï¼Œä¾‹å¦‚ A -\u0026gt; B é©—è­‰éï¼ŒB\u0026lt;-\u0026gt;Cé©—è­‰éï¼Œå‰‡ B æœƒæ¨è–¦ C çµ¦ Aï¼Œå‰‡ A\u0026lt;-\u0026gt;C ä¹Ÿèƒ½æˆåŠŸå»ºç«‹é€£ç·šï¼› æ‰€ä»¥ Node èˆ‡ä»»ä¸€è¢«é©—è­‰çš„ Node è¨±å¯å¾Œï¼Œå¾ŒçºŒå…¶ä»– Node å°±èƒ½è‡ªå‹•ç™¼ç¾ æ•´é«”çš„ Cluster Node æ•¸é‡ä¸Šé™å»ºè­°åœ¨ 1000 ä»¥å…§\nå¯«å…¥éºå¤± å› ç‚ºæ˜¯éåŒæ­¥å‰¯æœ¬ï¼Œæ‰€ä»¥æœ‰å°æ¦‚ç‡å·²ç¶“å›å‚³æˆåŠŸçµ¦ client çš„ write æœƒè¢«è¦†è“‹ï¼ŒRedis æ¡å– last failover winsï¼Œä¹Ÿå°±æ˜¯æœ€æ–°çš„ä¸€å€‹ Master æœƒè¦†å¯«å…¶ä»–å‰¯æœ¬çš„çµæœï¼Œæ‰€ä»¥æœƒæœ‰ä¸€æ®µç©ºçª—æœŸéºå¤±è³‡æ–™ï¼Œç©ºçª—æœŸé•·çŸ­è¦çœ‹ç™¼ç”Ÿç¶²è·¯åˆ†éš”æ™‚ client æ˜¯é€£åˆ°å¤šæ•¸é‚„æ˜¯å°‘æ•¸ç¾¤\nMaster å¯«å…¥å¾Œï¼Œé‚„ä¾†ä¸åŠè¤‡è£½åˆ° Slave å°±æ­»æ‰äº†ï¼Œå¦‚æœæ²’æœ‰åœ¨ä¸€å®šæ™‚é–“ ( NODE_TIMEOUT )å…§æ¢å¾©ï¼ŒSlave è¢« promote æˆ Master é‚£å¯«å…¥çš„çµæœå°±æ‰äº†ï¼› è€Œ Master è¢« partition éš”é–‹ï¼Œåœ¨ä¸€æ®µæ™‚é–“å¾Œ Master ç™¼ç¾è‡ªå·±é€£ä¸åˆ°å¤šæ•¸Master å°±æœƒåœæ­¢æ¥å—å¯«å…¥è«‹æ±‚\nå¯ç”¨æ€§ ä¾‹å¦‚èªªç›®å‰æœ‰ N å€‹ Master ï¼Œä¸”å°æ‡‰æ­é… N å€‹ Slave (1å°1)ï¼Œå‡è¨­æœ‰ä»»ä¸€å€‹ Node æ›æ‰ï¼Œç›®å‰ç‚º 2N - 1\næ­¤æ™‚å¦‚æœå‰›å¥½æ®˜å­˜çš„ replica é‚£ä¸€å€‹ Node æ­»å»ï¼Œæ•´å€‹ Cluster æ‰ç®—æ›æ‰ï¼Œåä¹‹å°±èƒ½ç¹¼çºŒé‹ä½œï¼Œå› ç‚ºæœƒæœ‰ä¸€éƒ¨åˆ†çš„ slot æ²’æœ‰ Node è² è²¬\næ‰€ä»¥ avalaibility æ˜¯ 1 / (2N-1)\næ•ˆèƒ½ å› ç‚º Node æ²’æœ‰ Proxy åŠŸèƒ½ï¼Œæ‰€ä»¥åªæœƒè·Ÿ client èªªæ­£ç¢ºçš„ Node åœ¨å“ªï¼Œæ¥è‘— client è¦å†ç™¼èµ·ä¸€æ¬¡ request æ‰èƒ½å®Œæˆæ“ä½œï¼Œæœ€çµ‚ client æœƒçŸ¥é“æ‰€æœ‰çš„æ“ä½œè©²å»å“ªå€‹ Nodeï¼›\nåŸºæœ¬ä¸Šä¸å¤ªéœ€è¦æ“”å¿ƒæ•ˆèƒ½å•é¡Œï¼Œå‡è¨­ Cluster æœ‰ N å€‹ Masterï¼Œè² è¼‰èƒ½åŠ›åŸºæœ¬ä¸Šå¯ä»¥è¦–ç‚ºå–®æ©Ÿ * Nï¼Œé›–ç„¶æœ‰ä¸Šè¿°åœ¨ç¬¬ä¸€æ¬¡è¦å¤šæŸ¥ä¸€æ¬¡çš„å•é¡Œï¼Œä½†å› ç‚º Client å°æ–¼æ¯å€‹ Cluster Master éƒ½ä¿æŒ TCP é•·é€£çµï¼Œæ‰€ä»¥ä¸è‡³æ–¼å¤ªæ“”å¿ƒ\nåˆ†æ•£å¼æ¨¡å‹ redis å°‡ key space åˆ‡å‰²æˆ 16384 ç­‰åˆ† HASH_SLOT = CRC16(key) mod 16384ï¼Œåˆ†é…å¾Œæœƒå›ºå®šï¼Œè©² slot å°±æœƒç”±åŒä¸€å€‹ Node è² è²¬ï¼Œç›´åˆ°æœ‰ reconfig çš„æŒ‡ä»¤ï¼›\nhash tag æ˜¯ä¸€å€‹åˆ†æ•£çš„ä¾‹å¤–ï¼Œä¸»è¦æ˜¯ç‚ºäº†æ”¯æ´ multi-key å¯ä»¥åˆ†é…åˆ°åŒä¸€å€‹ hash slot ä¸Šï¼Œå¦‚æœ key åŒ…å« {} ï¼Œå‰‡ hash key ç”¢ç”Ÿæ˜¯key è£¡é¢ç¬¬ä¸€çµ„ {â€¦} ä¸­é–“çš„å€¼ (æ²’æœ‰åŒ…å« {})\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 unsigned int HASH_SLOT(char *key, int keylen) { int s, e; for (s = 0; s \u0026lt; keylen; s++) if (key[s] == \u0026#39;{\u0026#39;) break; /* æ²’æœ‰æ‰¾åˆ° {ï¼Œå‰‡ hash æ•´å€‹å­—ä¸² */ if (s == keylen) return crc16(key,keylen) \u0026amp; 16383; /* æ‰¾åˆ° { */ for (e = s+1; e \u0026lt; keylen; e++) if (key[e] == \u0026#39;}\u0026#39;) break; /* æ²’æœ‰æ‰¾åˆ° }ï¼Œhash æ•´å€‹å­—ä¸² */ if (e == keylen || e == s+1) return crc16(key,keylen) \u0026amp; 16383; /* å¦‚æœæœ‰ {} é…å°ï¼Œå‰‡ key å– {...} ä¹‹é–“çš„å­—ä¸² */ return crc16(key+s+1,e-s-1) \u0026amp; 16383; } Resharding Redis Cluster åœ¨ç®¡ç†ä¸Šä»¥åŠä½¿ç”¨ä¸Šéƒ½æœ‰ç›¸ç•¶å¤§çš„å½ˆæ€§ï¼ŒCluster å¯ä»¥ä»»æ„å¢æ¸› Node æ•¸é‡ä»¥åŠèª¿æ•´ Slot å°æ‡‰çš„ Nodeï¼›è€Œ Redis Client å¯ä»¥èˆ‡ä»»æ„çš„ Node é€£ç·š\nå¦‚æœ Node æ”¶åˆ° Client request å¾Œ\nå¦‚æœè©²è³‡æ–™å±¬æ–¼ä»–çš„ slotï¼Œå‰‡ç›´æ¥è™•ç† åä¹‹å‰‡æ‰¾å‡ºå“ªå€‹ Node æ‡‰è©²è² è²¬ï¼Œå›å‚³ Moved éŒ¯èª¤çµ¦ Client -MOVED 3999 127.0.0.1:6381ï¼Œé€™ä»£è¡¨ key åœ¨ slot 3999ï¼Œæ­£ç¢ºçš„ Node æ˜¯ 127.0.0.1:6381 Client åœ¨æ¯æ¬¡æ”¶åˆ° MOVED å¾Œéƒ½æ‡‰è©²å»è¨˜ä½å“ªä¸€å€‹ slot å°æ‡‰å“ªä¸€å€‹ Nodeï¼Œé€™æ¨£å¯ä»¥å¢åŠ æ•ˆç‡ï¼›\nåˆç›´æ¥æ‹‰ä¸‹æ•´å¼µ mappingï¼Œç”¨ $cluster nodes æ‰¾å‡ºæ‰€ä»¥çš„ nodeï¼Œä¸¦çµåˆ $cluster slots ç›´æ¥æŸ¥çœ‹ cluster å®Œæ•´å°ç…§è¡¨ï¼Œå°±å¯ä»¥å®Œæ•´çŸ¥é“ node å°æ‡‰çš„ slot ä»¥åŠ node ip ä½ç½®èˆ‡ id\nRebalance Cluster å¯ä»¥åœ¨é‹è¡Œä¸­å¢æ¸› Nodeï¼Œä¸¦ä¸”æœƒè‡ªå‹•æ¬ç§»è³‡æ–™ä¸¦æ›´æ–° slot mappingï¼Œæœ‰å¹¾å€‹ command å¯ä»¥å‹•æ…‹å½±éŸ¿ Node èˆ‡ Slot\naddslot : æŒ‡å®š Node å¢åŠ  slot delslot : ç§»é™¤ slotï¼ŒåŸæœ¬è² è²¬çš„ Node æœƒéºå¿˜é€™å€‹ slot setslot : è½‰ç§» slot è½‰ç§»çš„éƒ¨åˆ†æ¯”è¼ƒè¤‡é›œï¼Œæœƒéœ€è¦å…ˆå»èª¿æ•´ Node ç‹€æ…‹ï¼Œä¾‹å¦‚èªªå¸Œæœ›å°‡ slot 8å¾ Node A è½‰åˆ° Node B\nåœ¨ Node B ä¸ŠæŒ‡å®šè³‡æ–™æœƒå¾ Node A éä¾†: $CLUSTER SETSLOT 8 IMPORTING A åœ¨ Node A ä¸ŠæŒ‡å®šè¦æŠŠ slot 8 è½‰ç§»åˆ° Node B ä¸Š: $CLUSTER SETSLOT 8 MIGRATING B ä¹‹å¾Œæœ‰ä¸€å€‹èƒŒæ™¯ç¨‹å¼ redis-trib æœƒä¸»å‹•å°‡ slot é€æ­¥æ¬ç§» ä¹Ÿå¯ä»¥æ‰‹å‹•è½‰ç§»\nåˆ—å‡ºè©² slot ä¸€å®šæ•¸é‡çš„ hash key: $CLUSTER GETKEYSINSLOT slot count å°‡é€™äº› key è½‰ç§»: $MIGRATE target_host target_port key target_database id timeoutï¼ŒMigrate æœƒåœ¨è½‰ç§»æˆåŠŸå¾Œæ‰ç§»é™¤ Node B çš„ç´€éŒ„ éç¨‹å¯åƒè€ƒæ­¤å•ç­” Redis cluster live reshard failure\nè½‰ç§»éç¨‹ åœ¨è½‰ç§»éç¨‹ä¸­ï¼Œclient é‡å°æ¬ç§»ä¸­èˆ‡æ¬å…¥ä¸­çš„ Node ç™¼å‡º Request åæ‡‰æœƒæœ‰æ‰€ä¸åŒ\næ¬å‡ºä¸­çš„ Node : a. å¦‚æœ key é‚„åœ¨ Nodeä¸­ å‰‡ç›´æ¥è™•ç† b. ä¸å†å‰‡å›å‚³ ASK éŒ¯èª¤ï¼ŒClient æ¥è‘—å¿…å…ˆå‘æ–°çš„ Node ç™¼å‡º ASKINGï¼Œæ¥è‘—æ‰å‚³é€ Request æ¬å…¥ä¸­çš„ Node : åªè™•ç†æœ‰å…ˆå‚³é€ ASKING çš„è«‹æ±‚ï¼Œå…¶é¤˜å›å‚³ MOVED éŒ¯èª¤ é€™æ¨£çš„ç›®çš„æ˜¯ç‚ºäº†æ–¹ä¾¿è½‰ç§»éç¨‹ï¼ŒNew Key ä¸€å®šæ˜¯åœ¨æ¬å…¥ä¸­ Nodeç”¢ç”Ÿï¼ŒMigrate å‰‡åªéœ€è¦è™•ç† Old Key\nå·²ç¶“æœ‰ MOVED éŒ¯èª¤ç¢¼ä»ç„¶éœ€è¦ ASK çš„åŸå› æ˜¯ ASK æ˜¯ä¸€æ¬¡æ€§è«‹æ±‚ï¼Œæˆ‘å€‘æœƒå¸Œæœ›åœ¨æ¬ç§»éç¨‹ï¼Œå‡è¨­ Client å¦‚æœæœ‰ slot 8 çš„è«‹æ±‚ï¼Œæ‡‰è©²å…ˆå»å• A å†å»å• Bï¼Œå¦‚æœ A æ²’æœ‰æœƒç”¨ ASK è½‰å» Bï¼›\nMOVED ä»£è¡¨çš„æ˜¯å¾€å¾Œçš„æ°¸ä¹…æ€§æ‰€æœ‰é‡å° slot 8 çš„è«‹æ±‚éƒ½å» Node Bï¼Œä½†é¡¯ç„¶é‚„åœ¨ migrate çš„è©±æœƒæœ‰å¤§é‡çš„ key é‚„æ²’æ¬ç§»ï¼Œæ‰€ä»¥ç”¨ ASK ä¸€æ¬¡æ€§çš„æŸ¥è©¢ç•¶ä½œéåº¦\nå¦‚æœæ˜¯ multi-key æ“ä½œï¼Œå‡è¨­ key åˆ†æ•£åœ¨å…©å€‹ node ä¹‹é–“ï¼Œå‰‡æœƒæ”¶åˆ° TRYAGAIN éŒ¯èª¤\nFault Tolerance Node æœƒç™¼é€ ping / pong å»ç¢ºèªå…¶ä»– Node æ˜¯å¦é‚„å­˜æ´»ï¼Œå…©è€…åˆä½µåˆç¨± heartbeatï¼Œé™¤äº† ping æœƒè§¸ç™¼ pong å›å¾©å¤–ï¼Œå¦‚æœ Node æœ‰ config æª”æ›´æ–°ï¼Œä¹Ÿæœƒä¸»å‹•ç™¼é€ pong çµ¦å…¶ä»– Node\nåœ¨åŠå€‹ NODE_TIMEOUT æ™‚é–“å…§ï¼ŒNode æœƒé€ ping çµ¦å…¶ä»–æ‰€æœ‰çš„ Node ç¢ºä¿å­˜æ´»ï¼Œåœ¨ NODE_TIMEOUT æ™‚é–“é»åˆ°å‰ï¼ŒNode é‚„æœƒé‡æ–°èˆ‡å…¶ä»– Node å»ºç«‹ TCP é€£ç·šï¼Œç¢ºä¿ping æ²’æ”¶åˆ°ä¸æ˜¯å‰›å¥½é€™ä¸€æ¬¡çš„ TCP é€£ç·šæœ‰å•é¡Œ\næ‰€ä»¥ packet äº¤æ›æ•¸é‡èˆ‡ Node æ•¸é‡å’Œ NODE_TIMEOUT æ™‚é–“æœ‰é—œï¼Œä¾‹å¦‚ 100 Node + 60 sec çš„ timeoutï¼Œå‰‡æ¯ä¸€å€‹ Node 30 sec å…§æœƒé€ 99 å€‹ping çµ¦å…¶ä»– Nodeï¼Œæ›ç®—å¾Œæ•´å€‹ cluster æ˜¯æ¯ç§’ 330ping\nheartbeat å°åŒ…å…±ç”¨ Header å¤§è‡´å¦‚ä¸‹\nNodeID: 160 bit è­˜åˆ¥ç¢¼ currentEpoch: éå¢æ•¸å­—ï¼Œç”¨ä¾†è¡¨ç¤ºè¨Šæ¯çš„å…ˆå¾Œé †åº flag: æ˜¯ Master é‚„æ˜¯ Slave bitmap: ç”¨ä¾†è¡¨ç¤ºè² è²¬çš„ slot sender çš„ tcp port sender èªç‚º Cluter æ˜¯å¦é‚„åœ¨é‹è¡Œ å¦‚æœæ˜¯ Slave å‰‡éœ€è¦åŒ…å« Master NodeID Fault Detection åœ¨ Cluster ä¸­ï¼Œä¸€å€‹ Node è¢«åˆ¤å®šéŒ¯èª¤æ˜¯ç¶“ç”±å¤šæ•¸çš„ Node æ‰€æ±ºå®šï¼›\nè€Œå¦‚æœç™¼ç”ŸéŒ¯èª¤çš„æ˜¯ Masterï¼Œä¸”æ²’æœ‰ Slave è¢«æˆåŠŸå‡ç´šæˆ Masterï¼Œå‰‡æ­¤æ™‚ Cluster é€²å…¥éŒ¯èª¤ç‹€æ…‹ï¼Œåœæ­¢ Client çš„è«‹æ±‚\nNode åœ¨æ™‚é–“å…§æœƒéš¨æ©Ÿå°æ•¸å€‹ Node ç™¼é€ping è«‹æ±‚ï¼Œæ­¤æ™‚å¦‚æœè¶…é NODE_TIMEOUT éƒ½æ²’æ”¶åˆ° pongï¼Œå‰‡æœƒæ¨™è¨˜è©² Node ç‚º PFAILï¼Œæ­¤æ™‚çš„ PFAIL ä¸¦ä¸æœƒè§¸ç™¼ä»»ä½•æ©Ÿåˆ¶ï¼›\nç•¶ Node åœ¨å›è¦† pong æ™‚ï¼ŒæœƒæŠŠè‡ªå·±æ‰€ç¶­è­·çš„hash slot mapä¹Ÿä¸€ä¸¦ç™¼é€ï¼Œæ‰€ä»¥æ¯å€‹ Node åœ¨ä¸€å®šçš„æ™‚é–“å…§éƒ½æœƒçŸ¥é“å…¶ä»– Node æ‰€ç¶­è­·çš„æ¨™è¨˜ç‹€æ…‹æ¸…å–®\nå‡è¨­ Node A æ¨™è¨˜ Node B ç‚º PFAILï¼Œæ¥è‘— Node A æ”¶åˆ°ä¾†è‡ªå…¶ä»– Master Node å°æ–¼ Node B çš„æ¨™è¨˜ï¼Œå¦‚æœåœ¨ NODE_TIMEOUT * FAIL_REPORT_VALIDITY_MULT ç­‰å¾…æ™‚é–“å…§ï¼Œå¤§å¤šæ•¸çš„ Master ä¹Ÿéƒ½æ¨™è¨˜ Node B ç‚º PFAIL æˆ–æ˜¯ FAILï¼Œå‰‡ Node A è½‰æ¨™è¨˜ Node B ç‚º FAIL\nè¢«æ¨™è¨˜æˆ FAIL å¹¾ä¹æ˜¯ä¸å¯é€†ï¼Œé™¤äº†ä¸‹è¿°æƒ…æ³\nNode æ˜¯ Slave ä¸”å¯ä»¥è¢«é€£ä¸Š Node æ˜¯ Master ä¸”å¯ä»¥è¢«é€£ä¸Šï¼ŒåŒæ™‚æ²’æœ‰åˆ†é…åˆ°ä»»ä½• slotï¼Œæ­¤æ™‚æœƒç­‰å¾…è¢«åŠ å…¥ Cluster Node æ˜¯ Master ä¸”å¯ä»¥è¢«é€£ä¸Šï¼ŒåŒæ™‚ Cluster éå¾ˆé•·ä¸€æ®µæ™‚é–“éƒ½æ²’æœ‰ Slave è¢« Promote æˆåŠŸï¼Œå‰‡å¯ä»¥è€ƒæ…®é‡æ–°åŠ å…¥ Cluster é€éé€™æ¨£çš„è¨­è¨ˆï¼Œæœ€çµ‚ Cluster ä¸­æ¯ä¸€å€‹ç¯€é»çš„ç‹€æ…‹éƒ½æœƒæ˜¯è¢«åŒæ­¥çš„\nConfiguration handling, propagation, and failovers é€™ä¸€ç« ç¯€ä¸»è¦è«‡ Slave promotion çš„éç¨‹\nCluster current epoch åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œå¿…é ˆæœ‰å€‹æ–¹å¼æ±ºå®šé‡è¤‡æˆ–æ˜¯è¡çªçš„äº‹ä»¶è©²é¸æ“‡å“ªä¸€å€‹ï¼ŒRedis Cluster ä¸­æ¡ç”¨ epoch (å°æ¯” Raft ä¸­çš„ term) æ˜¯ä¸€å€‹ 64 bit unsigned intï¼Œåˆå§‹åŒ– Master / Slave éƒ½æ˜¯ 0ï¼Œåœ¨ç™¼é€è¨Šæ¯æ™‚åŠ  1ï¼Œåœ¨æ”¶åˆ°è¨Šæ¯æ™‚å¦‚æœå°æ–¹çš„ epoch é«˜æ–¼è‡ªå·±ï¼Œå‰‡æ›´æ–° epoch ä¸¦åŠ  1ï¼›\né‡åˆ°æœ‰è¡çªï¼Œå‰‡é¸æ“‡ epoch è¼ƒé«˜çš„é‚£ä¸€å‰‡è¨Šæ¯\nMaster åœ¨ç™¼é€ ping æ™‚æœƒå¤¾å¸¶ configEpoch ä¸”åœ¨å› pong æ™‚æœƒå¤¾å¸¶æ‰€å±¬çš„ slot mapping\nPromotion éç¨‹ å¦‚æœç¬¦åˆä»¥ä¸‹æ¢ä»¶\nMaster Node å¤±æ•— Master æœ‰è² è²¬ slot Slave ä¸¦æ²’æœ‰èˆ‡ Master å¤±è¯è¶…éä¸€å®šæ™‚é–“ï¼Œé€™å€‹åˆ¤å®šæ˜¯ç‚ºäº†é¿å… Slave çš„è³‡æ–™å¤ªèˆŠ å‰‡ Slave æœƒæº–å‚™æèµ· Promotionï¼Œæ­¤æ™‚æœƒå¢åŠ  configEpoch å€¼ï¼Œä¸¦å¸Œæœ›å–å¾—å¤šæ•¸ Master çš„åŒæ„ï¼Œç™¼é€ FAILOVER_AUTH_REQUEST çµ¦ Master Nodesï¼Œæ¥è‘— Slave æœƒç­‰å¾… 2 * NODE_TIMEOUT\næ­¤æ™‚ Master å¦‚æœåŒæ„ï¼Œå‰‡å›è¦† FAILOVER_AUTH_ACKï¼Œæ­¤æ™‚ Master åœ¨æ¥ä¸‹ä¾†çš„ 2 * NODE_TIMEOUT ä¸å¯ä»¥å›è¦†å…¶ä»– Slave Node FAILOVER_AUTH_ACK è¨Šæ¯ï¼Œé¿å…å¤šå€‹ Slave åŒæ™‚æŠ•ç¥¨\nå¦‚æœ Slave åœ¨ 2 * NODE_TIMEOUT å…§æ”¶åˆ°å¤šæ•¸ Master åŒæ„ï¼Œå‰‡é¸èˆ‰é€šéï¼›\nåä¹‹å¦‚æœå¤±æ•—ï¼Œå‰‡ 4 * NODE_TIMEOUT å¾Œé–‹å§‹ä¸‹ä¸€æ¬¡é¸èˆ‰\nHash Slot ç¶­è­· å…ˆå‰æåˆ° Master åœ¨é€ pong æ™‚æœƒæŠŠè‡ªå·±ç®¡ç†çš„ slot ä¹Ÿä¸€ä½µæ›´æ–°ï¼Œæ­¤æ™‚çš„ slot æœƒå¤¾å¸¶ç›®å‰ Master çš„ epoch è³‡è¨Šï¼Œä¾‹å¦‚ä»¥ä¸‹\nCluster åˆå§‹åŒ–ï¼Œæ­¤æ™‚ Slot éƒ½æ²’æœ‰å°æ‡‰çš„ Masterï¼Œéœ€è¦ CLUSTER ADDSLOTS åˆ†é… 1 2 3 4 5 0 -\u0026gt; NULL 1 -\u0026gt; NULL 2 -\u0026gt; NULL ... 16383 -\u0026gt; NULL å‡è¨­åˆ†é…éƒ¨åˆ†çµ¦ Aï¼ŒA æœƒé †ä¾¿æ¨™è¨˜ epochï¼Œå‡è¨­æ­¤æ™‚å€¼ç‚º 3 1 2 3 4 5 0 -\u0026gt; NULL 1 -\u0026gt; A [3] 2 -\u0026gt; A [3] ... 16383 -\u0026gt; NULL ç”¢ç”Ÿ Failoverï¼ŒB ä¸Šä¾†é ‚æ›¿ Aï¼Œæ­¤æ™‚æœƒæŠŠ epoch + 1 1 2 3 4 5 0 -\u0026gt; NULL 1 -\u0026gt; B [4] 2 -\u0026gt; B [4] ... 16383 -\u0026gt; NULL é€™ä¹Ÿå°±æ˜¯ last failover wins ç­–ç•¥ï¼Œå‡ä½¿ A æ­¤æ™‚ç¶²è·¯é€£ç·šå›ä¾†è¦å®£ç¨±è‡ªå·±æ˜¯ Master ä¹Ÿæœƒè¢«æ“‹ä¸‹ä¾†ï¼Œå› ç‚º A çš„ epoch æ¯”è¼ƒå°\nå¯¦éš›æ¡ˆä¾‹ å‡è¨­ Master å·²ç¶“æ›äº†ï¼Œæ­¤æ™‚æœ‰ A,B,C ä¸‰å€‹ Slave\nA ç«¶é¸æˆåŠŸè®Šæˆäº† Master ç¶²è·¯å€éš”é—œä¿‚ï¼ŒA è¢«è¦–ç‚ºéŒ¯èª¤ B å› æ­¤ç«¶é¸è€Œæˆ Master æ¥è‘—æ› B è¢«ç¶²è·¯å€éš” æ­¤æ™‚ A æˆåŠŸé€£ç·šå›ä¾† æ­¤æ™‚ B å¤±è¯ï¼ŒA ä»¥ç‚ºè‡ªå·±é‚„æ˜¯ Masterï¼Œæ­¤æ™‚ C å› ç‚º B å¤±è¯æœƒæƒ³è¦å»ç«¶é¸ Master\næ­¤æ™‚ C æœƒæˆåŠŸï¼Œå› ç‚ºå…¶ä»–çš„ Master çŸ¥é“ C çš„ Master(B) å·²ç¶“å¤±æ•— A ç„¡æ³•å®£ç¨±è‡ªå·±æ˜¯ Master ï¼Œå› ç‚º hash slot å·²ç¶“è¢«æ›´æ–°æˆ B çš„ epoch ï¼ˆç¬¬ä¸‰æ­¥)ï¼Œä¸” B çš„ epoch é«˜æ–¼ A çš„ epoch æ¥è‘— C æœƒæ›´æ–° hash slot çš„ epochï¼ŒCluster æŒçºŒé‹ä½œ çµè«– æ•´å€‹çœ‹é Redis Cluster Spec æœƒå°æ–¼å¯¦éš›æ“ä½œæ¯”è¼ƒæœ‰ä¿¡å¿ƒï¼Œä¸‹ä¸€ç¯‡ä¾†è‡ªå·±å¯¦éš›æ¶è¨­çœ‹çœ‹\næœ‰ä¸€äº›ç´°ç¯€æ¯”è¼ƒç‘£ç¢å°±è·³éï¼Œæœ‰äº›ç« ç¯€è®€èµ·ä¾†æ¯”è¼ƒä¸é€šé †ï¼Œè‡ªå·±é‡æ–°ç†è§£å¾Œç·¨æ’ä¸€ä¸‹ (OS. å¯èƒ½æœƒè®Šå¾—æ›´é›£ç†è§£ ?!\n","date":"2020-10-19T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-10-19-redis-cluster-%E4%BB%8B%E7%B4%B9/","title":"Redis Cluster ä»‹ç´¹"},{"content":"æœ€è¿‘å…¬å¸ API æœå‹™è¢« Client ä¸é æœŸçš„é«˜é »å­˜å–ï¼Œé€ æˆå¾Œç«¯ DB å¾ˆå¤§çš„è² æ“”ï¼Œé–‹å§‹è©•ä¼°å„ç¨® API Rate Limit çš„æ–¹æ¡ˆï¼Œå…¶ä¸­ä¸€å€‹æœ€å¸¸è¦‹çš„ä½œæ³•å°±æ˜¯é  Redisï¼Œä½†å…·é«”çš„æ–¹æ¡ˆå…¶å¯¦æœ‰è »å¤šç¨®ï¼Œåƒè€ƒä»¥ä¸‹å½±ç‰‡æ•´ç†ä¸‰ç¨®ä½œæ³•\né †ä¾¿æ¨è–¦ä¸€ä¸‹ RedisLabs æ‰€æ¨å‡ºçš„ GUI ç®¡ç†å·¥å…· RedisInsightsï¼Œå¯ä»¥å¿«é€Ÿåˆ†æ Redis ä¸­ Key Space çš„ä½¿ç”¨ / Profiling ä¸€æ®µæ™‚é–“å…§å“ªäº› Key è¢«å¤§é‡å­˜å–ç­‰ç­‰ï¼ŒåŸºæœ¬çš„ Redis CLI æ“ä½œå°±æ›´ä¸ç”¨æäº†ï¼Œå°æ¯”ä¹‹å‰ç”¨çš„ medis åŠŸèƒ½å¼·åŒ–ä¸å°‘ï¼Œå°¤å…¶æ˜¯ç®¡ç†/ç›£æ§é€™ä¸€å¡Šçš„åŠŸèƒ½\nç›®å‰æ˜¯å…è²»çš„ï¼Œæ”¯æ´ Cluster Modeï¼Œé€£æ¥ AWS ElasticCache ä¹Ÿæ²’å•é¡Œï¼Œååˆ†æ¨è–¦\nRate Limit å…¨è§€ è¦è¨­è¨ˆ Rate Limit æ©Ÿåˆ¶æ™‚éœ€è¦è€ƒé‡å¹¾å€‹é¢å‘\nWho è©²å¦‚ä½•è­˜åˆ¥è¦é™åˆ¶çš„å°è±¡ï¼Ÿ\næœ€ç›´è¦ºæ˜¯é€é IPï¼Œä½†æ˜¯ä½¿ç”¨ IP æœ€å¤§çš„é¢¨éšªæ˜¯ å¦‚æœæ˜¯å¤§å®¢æˆ¶ï¼Œä»–ä¸€å€‹äººçš„æµé‡é è¶…éå…¶ä»–å°å®¢æˆ¶ï¼Œå°å…¬å¸çš„åƒ¹å€¼é¡¯ç„¶ä¹Ÿæ˜¯é é é‡è¦ï¼Œå¦‚æœç”¨ IP å¾ˆå®¹æ˜“æœ‰èª¤æ®ºçš„æƒ…æ³ï¼ŒæŠŠæœ‰åƒ¹å€¼çš„ç”¨æˆ¶é˜»æ“‹åœ¨å¤–\nå…¶ä»–çš„ä½œæ³•å¯ä»¥ç”¨ JWT Token / API Key ç­‰å€‹åˆ¥ç”¨æˆ¶è­˜åˆ¥çš„æ–¹å¼ï¼Œéœ€è¦é‡å°è‡ªå®¶çš„æ¥­å‹™å ´æ™¯å»åˆ¤æ–·\nHow è©²ä½¿ç”¨æ€æ¨£çš„æ–¹å¼è¨ˆç®—é™åˆ¶çš„æ–¹å¼ï¼Ÿ\né€šå¸¸æ˜¯åœ¨æŸå€‹æ™‚é–“å€æ®µå…§ï¼Œé™åˆ¶åªèƒ½å­˜å–å¤šå°‘æ¬¡çš„è¨ˆç®—æ¨¡å¼ï¼Œæœ‰ä¸‰ç¨®æ–¹å¼å¯ä»¥åƒè€ƒ\nstatic time window - å›ºå®šæ™‚é–“å€æ®µ ä¾‹å¦‚èªªæ¯ä¸€åˆ†é˜ç‚ºä¸€å€‹å–®ä½ï¼Œé€™ä¸€åˆ†é˜å…§åªèƒ½å­˜å–äº”æ¬¡\né€™æ¨£çš„æ–¹å¼ååˆ†ç°¡å–®ï¼Œä½†å¯èƒ½æœƒæœ‰çŸ­æ™‚é–“å…§è¶…é‡çš„å•é¡Œï¼Œä¾‹å¦‚èªª 0:59 å­˜å– 4 æ¬¡ï¼Œæ¥è‘— 1:01 å­˜å–4 æ¬¡ï¼Œåˆ†é–‹åœ¨å…©å€‹æ™‚é–“å€æ®µéƒ½æ˜¯åˆæ³•ï¼Œä½†æ˜¯æ‰éš”å…©ç§’å°±å­˜å– 8 æ¬¡ï¼Œé€™å¯èƒ½ä¸æœƒæ˜¯å¸Œæœ›çš„çµæœ\nå¯¦ä½œæ–¹å¼ï¼Œä»¥ç›®å‰æ¯é€± 160 k ä¸‹è¼‰çš„ express-rate-limit ä¸­ redis ç‰ˆæœ¬ rate-limit-redis æ˜¯ä»¥ä¸‹åšæ³•\nå…ˆè¨ˆç®—å‡ºè©²æ™‚é–“æ®µçš„éµå€¼ï¼Œä¾‹å¦‚ 01:00 ~ 01:59 çš„éµå€¼éƒ½æ˜¯ 01 1 var expiryMs = Math.round(1000 * options.expiry); å¢åŠ  key ä¸¦æ›´æ–° ttl æ™‚é–“ï¼Œincr æœƒå›å‚³ç•¶ä¸‹å¢åŠ å¾Œçš„å€¼ï¼Œè—‰æ­¤åˆ¤æ–·æ˜¯å¦è¶…éé™åˆ¶ 1 2 3 4 options.client.multi() .incr(rdskey) .pttl(rdskey) .exec() å› ç‚ºæœ‰ ttlï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒ key çš„åˆªé™¤ï¼Œé€™å€‹æ–¹æ³•ç°¡å–®ç›´è¦ºå„²å­˜æˆæœ¬ä¹Ÿå¾ˆä½\nç‚ºäº†åš´æ ¼é™åˆ¶ä»»æ„æ™‚é–“å€æ®µå…§çš„æœ€å¤§å­˜å–æ•¸é‡ï¼Œåƒè€ƒä»¥ä¸‹æ–‡ç« æåŠå…©ç¨®åšæ³• Better Rate Limiting With Redis Sorted Sets token bucket æ¯ä¸€å€‹ç”¨æˆ¶éƒ½æœ‰ä¸€å€‹å°æ‡‰çš„ bucketï¼Œåªæœ‰ token è¶³å¤ æ™‚å¯ä»¥é€²è¡Œæ“ä½œï¼Œæ¯éš”ä¸€æ®µæ™‚é–“æœƒå›è£œ token æ•¸é‡ï¼Œå¥½è™•æ˜¯å¯ä»¥åˆ¶å®šå¤šç¨®æ“ä½œçš„ token éœ€è¦æ•¸é‡ï¼Œåƒæ˜¯æ›´ç¹é›œçš„æ“ä½œéœ€è¦æ¶ˆè€—æ›´å¤šçš„ token ï¼Œæ›´æœ‰å½ˆæ€§æ‡‰å°ä¸åŒçš„é™åˆ¶æ–¹æ¡ˆ\nè³‡æ–™çµæ§‹ä½¿ç”¨ Redis çš„ Hashï¼Œæ¼”ç®—æ³•å¤§è‡´å¦‚ä¸‹\nç”¨æˆ¶è¦æ“ä½œçš„æ™‚å€™ï¼Œå¦‚æœæ­¤æ™‚æ²’æœ‰ç´€éŒ„ï¼Œå…ˆæ’å…¥ä¸€ç­† Hash user: ç•¶ä¸‹ çš„ timestamp =\u0026gt; token åˆå§‹åŒ–æ•¸é‡ å¾ŒçºŒæ“ä½œæ™‚ï¼Œå–å‡ºä¸Šä¸€æ¬¡æ“ä½œçš„ timestampï¼Œæ¥è‘—å›è£œé€™ä¸€æ®µæ™‚é–“éœ€è¦è£œå……çš„ Token æ•¸é‡ æ¥è‘—æ‰£é™¤æ“ä½œæ‰€éœ€çš„ Token æ•¸ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç¬¦åˆé™åˆ¶ éœ€æ³¨æ„é€™ç¨®åšæ³•æœƒæœ‰ Race Condition å•é¡Œï¼Œå¦‚æœä¸€å€‹ç”¨æˆ¶åŒæ™‚æœ‰å…©å€‹æ“ä½œï¼Œåœ¨ç¬¬ä¸‰æ­¥é©Ÿæª¢æŸ¥æ™‚ï¼Œæœƒèª¤ä»¥ç‚ºè‡ªå·±éƒ½æœ‰è¶³å¤ çš„ tokenï¼Œé™¤éä½¿ç”¨ Lua scriptï¼ŒRedis æ‰æœƒå°‡å¤šå€‹æ“ä½œè¦–ç‚º atomic é¿å… Race Condition\nnode-redis-token-bucket-ratelimiter ä¾¿æ˜¯æ¡ç”¨ Lua script ä½œæ³•ï¼Œè®“æˆ‘å€‘ä¾†æ¬£è³ä¸€ä¸‹\nå–å¾—åƒæ•¸ï¼Œä¸¦æŒ‡å®š redis.replicate_commands()ï¼Œé€™æ˜¯åœ¨èª¿ç”¨ $ redis eval æ™‚è¦ç”¢ç”Ÿéš¨æ©Ÿ IO æ™‚éœ€è¦æå‰åŸ·è¡Œçš„æŒ‡ä»¤ Redis - EVAL script numkeys keyï¼Œé€™ä¸€ç¯‡æœ‰æ˜“æ‡‚çš„è§£é‡‹ Redis Â· å¼•æ“ç‰¹æ€§ Â· Luaè„šæœ¬æ–°å§¿åŠ¿ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ç‚ºäº†ç¬¦åˆ Redis åœ¨æŒä¹…åŒ–ä»¥åŠå‰¯æœ¬è³‡æ–™æ™‚çš„åŠŸèƒ½ï¼Œåœ¨ 5.0 ä»¥å¾Œæ˜¯é»˜èªé¸é …ï¼› æ¥è‘—å°±æ˜¯åˆ†åˆ¥è¨ˆç®—ä¸Šä¸€æ¬¡æ›´æ–°æ™‚é–“ initialUpdateMS / æ®˜ç•™çš„ token æ•¸ prevTokens 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 -- valueKey timestampKey | limit intervalMS nowMS [amount] local valueKey = KEYS[1] -- \u0026#34;limit:1:V\u0026#34; local timestampKey = KEYS[2] -- \u0026#34;limit:1:T\u0026#34; local limit = tonumber(ARGV[1]) local intervalMS = tonumber(ARGV[2]) local amount = math.max(tonumber(ARGV[3]), 0) local force = ARGV[4] == \u0026#34;true\u0026#34; local lastUpdateMS local prevTokens -- Use effects replication, not script replication;; this allows us to call \u0026#39;TIME\u0026#39; which is non-deterministic redis.replicate_commands() local time = redis.call(\u0026#39;TIME\u0026#39;) local nowMS = math.floor((time[1] * 1000) + (time[2] / 1000)) local initialTokens = redis.call(\u0026#39;GET\u0026#39;,valueKey) local initialUpdateMS = false if initialTokens == false then -- If we found no record, we temporarily rewind the clock to refill -- via addTokens below prevTokens = 0 lastUpdateMS = nowMS - intervalMS else prevTokens = initialTokens initialUpdateMS = redis.call(\u0026#39;GET\u0026#39;,timestampKey) if(initialUpdateMS == false) then -- this is a corruption -- å¦‚æœè³‡æ–™æœ‰å•é¡Œï¼Œéœ€è¦å›æ¨ lastUpdateMS æ™‚é–“ï¼Œä¹Ÿå°±æ˜¯ç”¨ç¾åœ¨æ™‚é–“å›æ¨æ®˜å­˜ Token æ•¸é‡çš„å›è£œæ™‚é–“ lastUpdateMS = nowMS - ((prevTokens / limit) * intervalMS) else lastUpdateMS = initialUpdateMS end end æ¥è‘—è¨ˆç®—ä¸Šä¸€æ¬¡åˆ°ç¾åœ¨éœ€è¦å›è£œçš„ Token addTokens / é€™ä¸€æ¬¡é‹ç®—é…é¡å¤ ä¸å¤  netTokens / å¦‚æœä¸‹ä¸€æ¬¡è¦å˜—è©¦éœ€è¦ç­‰å¤šä¹…çš„æ™‚é–“ retryDelta 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 local addTokens = math.max(((nowMS - lastUpdateMS) / intervalMS) * limit, 0) -- calculated token balance coming into this transaction local grossTokens = math.min(prevTokens + addTokens, limit) -- token balance after trying this transaction local netTokens = grossTokens - amount -- time to fill enough to retry this amount local retryDelta = 0 local rejected = false local forced = false if netTokens \u0026lt; 0 then -- we used more than we have if force then forced = true netTokens = 0 -- drain the swamp else rejected = true netTokens = grossTokens -- rejection doesn\u0026#39;t eat tokens end -- == percentage of `intervalMS` required before you have `amount` tokens retryDelta = math.ceil(((amount - netTokens) / limit) * intervalMS) else -- polite transaction -- nextNet == pretend we did this again... local nextNet = netTokens - amount if nextNet \u0026lt; 0 then -- ...we would need to wait to repeat -- == percentage of `invervalMS` required before you would have `amount` tokens again retryDelta = math.ceil((math.abs(nextNet) / limit) * intervalMS) end end å¦‚æœæˆåŠŸæ“ä½œ ( rejected == false )ï¼Œå‰‡å»¶é•· key çš„éæœŸæ™‚é–“ 1 2 3 4 5 6 7 8 9 10 if rejected == false then redis.call(\u0026#39;PSETEX\u0026#39;,valueKey,intervalMS,netTokens) if addTokens \u0026gt; 0 or initialUpdateMS == false then -- we filled some tokens, so update our timestamp redis.call(\u0026#39;PSETEX\u0026#39;,timestampKey,intervalMS,nowMS) else -- we didn\u0026#39;t fill any tokens, so just renew the timestamp so it survives with the value redis.call(\u0026#39;PEXPIRE\u0026#39;,timestampKey,intervalMS) end end sliding time window - æ»‘å‹•æ™‚é–“å€æ®µ æœ€å¾Œä¸€å€‹æ˜¯ä½¿ç”¨ sorted setï¼Œå¯ä»¥ä½¿ç”¨ $ redis.multi å°‡å¤šå€‹ sorted set çš„æŒ‡ä»¤ä¸²å†ä¸€èµ· Atomic åŸ·è¡Œæ‰€ä»¥èƒ½å¤ é¿å… Race Condition ç‹€æ³\nå…·é«”æƒ³æ³•æ˜¯\nç”¨ä¸€å€‹ sorted set å„²å­˜æ‰€æœ‰çš„ timestamp request é€²ä¾†å¾Œï¼Œå…ˆç”¨ ZREMRANGEBYSCORE æ¨æ£„ time window ä»¥å¤–çš„ key å–å¾— sorted set å‰©é¤˜çš„æ‰€æœ‰å…ƒç´  ZRANGE(0, -1) åŠ ä¸Šé€™ä¸€æ¬¡çš„æ“ä½œ ZADDï¼Œä¸¦å»¶é•· sorted set çš„ ttl æ¥è‘—ç®—æ•´å€‹ sorted set çš„å…ƒç´ é‡ï¼Œå°±çŸ¥é“å­˜å–å¹¾æ¬¡äº† éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Œé€™é‚Šå¦‚æœç¬¬äº”æ­¥åˆ¤æ–·å¤±æ•—ä¹Ÿæœƒè¢«è¨ˆç®—åœ¨ limit ç•¶ä¸­ï¼Œå› ç‚ºç¬¬å››æ­¥å·²ç¶“å…ˆåŠ ä¸Šå»äº†ï¼Œå¦‚æœåœ¨ç¬¬ä¸‰æ­¥å…ˆåˆ¤æ–·æ•¸é‡å¤ ä¸å¤ å†å»æ›´æ–° sorted setï¼Œä¸­é–“çš„æ™‚é–“å·®å°±æœ‰å¯èƒ½ç™¼ç”Ÿ Race Conditionï¼Œæ‰€ä»¥è¦åš´æ ¼é™åˆ¶å¿…é ˆè¦é€™éº¼åšï¼Œé™¤éåˆè¦åŒ…æˆ lua script\né€™æœƒå°è‡´ä¸€å€‹é¢¨éšªï¼Œå¦‚æœ Client çœŸçš„å¤±æ§ä¸€ç›´æ‰“ï¼Œé‚£ä»–æœƒç„¡æ­¢ç›¡çš„å¤±æ•—ï¼Œå› ç‚ºæ¯ä¸€æ¬¡çš„å¤±æ•—æ“ä½œéƒ½æœƒè¢«åŠ å…¥ sorted set ç•¶ä¸­ï¼Œä½†å…¶å¯¦éƒ½æ²’æœ‰çœŸçš„åŸ·è¡Œåˆ°\næ¨¡çµ„è«‹åƒè€ƒ rolling-rate-limiterï¼Œç¨‹å¼ç¢¼åœ¨é€™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 const batch = this.client.multi(); batch.zremrangebyscore(key, 0, clearBefore); if (addNewTimestamp) { batch.zadd(key, String(now), uuid()); } batch.zrange(key, 0, -1, \u0026#39;WITHSCORES\u0026#39;); batch.expire(key, this.ttl); return new Promise((resolve, reject) =\u0026gt; { batch.exec((err, result) =\u0026gt; { if (err) return reject(err); // åŠ å®Œå¾Œæ‰ä¾†è¨ˆç®—æ˜¯ä¸æ˜¯æ‰£æ‰“è¶³å¤  const zRangeOutput = (addNewTimestamp ? result[2] : result[1]) as Array\u0026lt;unknown\u0026gt;; const zRangeResult = this.getZRangeResult(zRangeOutput); const timestamps = this.extractTimestampsFromZRangeResult(zRangeResult); return resolve(timestamps); }); }); çµè«– Rate Limit çœ‹ä¼¼ç°¡å–®ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘çš„çœ‰è§’è¦å»è€ƒé‡ï¼Œä¹‹å‰ä¸€ç›´éƒ½æ²’æœ‰å®¢è£½ Redis ä¸­ lua script çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯è »æœ‰è¶£çš„\n","date":"2020-10-18T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-10-18-%E4%BD%BF%E7%94%A8-redis-%E7%95%B6%E4%BD%9C-api-rate-limit-%E7%9A%84%E4%B8%89%E7%A8%AE%E6%96%B9%E6%B3%95/","title":"ä½¿ç”¨ Redis ç•¶ä½œ API Rate limit çš„ä¸‰ç¨®æ–¹æ³•"},{"content":"å¹³æ™‚å–œæ­¡é‹å‹•ï¼Œæ›¾åƒåŠ éé¾èˆŸã€è·‘éå…¨é¦¬/åŠé¦¬ï¼Œç¶­æŒä¸€é€±è‡³å°‘ä¸‰æ¬¡æ¯æ¬¡ä¸€å°æ™‚çš„é‹å‹•ç¿’æ…£ï¼Œåœ¨åŒäº‹çš„æ¨å‘ä¸‹ï¼Œè©¦é¨äº†å¹¾æ¬¡å¾Œè¦ºå¾—é¨è»Šå¾ˆèˆ’é©ï¼Œåœ¨å°åŒ—è¿‘éƒŠæœ‰å¾ˆå¤šä¸éŒ¯çš„å±±è·¯ï¼Œä¹Ÿæœ‰æ²³æ¿±å¯ä»¥èˆ’é©çš„é¨ä¹˜\nåˆ†äº«å¹¾å€‹ç•¶åˆé¸è»Šçš„æƒ³æ³•ï¼ŒåŒ…å«é ç®—ç­‰ç­‰è€ƒé‡ï¼Œä»¥åŠå…¥å‘ä¸€å€‹æœˆå¾Œçš„ä¸€äº›å¿ƒå¾—èˆ‡é¿é›·å»ºè­°\næ–°æ‰‹åˆ†äº«ï¼Œå¦‚æœ‰éŒ¯èª¤æ­¡è¿ç³¾æ­£ ğŸ™\nç‰½è»Šå¾Œä¸€é€±ç¬¬ä¸€æ¬¡ä¸Šé¢¨æ«ƒå˜´\n*æ›´æ–°: åœ¨ 2020/11 å®Œè³½ç’°èŠ±æ±ï¼Œæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒçœ‹çœ‹ ä¸€äººå‚™æˆ°ç’°èŠ±æ±365æŒ‘æˆ°è³½ - å‚™è³½ã€æ¯”è³½éç¨‹åˆ†äº«ï¼Œå¸Œæœ›è®“é€™ç¯‡çœ‹èµ·ä¾†æ›´æœ‰å¯ä¿¡åº¦ (å’¦ ?!\nè³¼è»Šå‰çš„è€ƒé‡ å› ç‚ºç•¢ç«Ÿæ˜¯å‰›å…¥å‘ï¼Œé ç®—ä¸€é–‹å§‹æ˜¯æŠ“å…©è¬ï¼Œé€™å…¶å¯¦é‚„è »ä½çš„ï¼Œåªèƒ½è²·å„å®¶å» ç‰Œçš„å…¥é–€è»Šæ¬¾ï¼Œå¦ç™½èªªé¸æ“‡ä¸å¤šï¼Œä½†æˆ‘è‡ªå·±è¦ºå¾—é€™å€‹åƒ¹æ ¼æ˜¯æˆ‘å¿ƒç†å¯ä»¥è² æ“”çš„ï¼Œå¦‚æœæ—¥å¾Œ~ä¸å¹¸~é¨å‡ºèˆˆè¶£ï¼Œè¦å†æ›ä¹Ÿé‚„æ˜¯å¯ä»¥çš„\nä¸€èˆ¬è‡ªè¡Œè»Šé¡å‹æœ‰åˆ†æˆ å…¬è·¯è»Šã€ç™»å±±è»Šã€ä¸‰éµè»Šç­‰ç­‰ï¼Œå…¬è·¯è»ŠæŠŠæ‰‹éƒ¨åˆ†åˆæœ‰ å¹³æŠŠ èˆ‡ å½æŠŠï¼Œå¹³æŠŠç›¸å°åå§¿è¼ƒé«˜ï¼Œæ‰€ä»¥é•·é€”ç›¸å°æ¯”è¼ƒä¸æœƒç´¯ï¼Œä¸€é–‹å§‹è©¦é¨ä¹Ÿæ˜¯ç”¨å¹³æŠŠï¼›\nå½æŠŠ å°±æ˜¯ç›¸å°åå§¿è¼ƒè¶´ï¼ŒæŠŠæ‰‹æœ‰å¤šç¨®æ‰‹å‹¢å¯ä»¥è®Šæ›ï¼Œç›¸å°èº«é«”è² æ“”å°±æ¯”è¼ƒå¤§ä¸€äº›ï¼Œä½†å¹³å¸¸æœ‰é‹å‹•ã€é‡è¨“ç¿’æ…£æ‡‰è©²æ˜¯è »èƒ½é©æ‡‰\nè »å»ºè­°è³¼è»Šå‰å…ˆå»è·Ÿæœ‹å‹å€Ÿé¨çœ‹çœ‹ï¼Œç•¶åˆä¹Ÿæ˜¯æ„Ÿè¬åŒäº‹é ˜é¨äº†ä¸‰å››æ¬¡ï¼Œç¢ºèªå–œæ­¡é¨ä¹˜åœ¨å…¥æ‰‹æœƒæ¯”è¼ƒå¥½\nè³¼è»Šè©•ä¼° å› ç‚ºé ç®—æŠ“åœ¨å…©è¬ï¼ŒåŸºæœ¬ä¸Šåªèƒ½é¸é‹åˆé‡‘çš„è»Šï¼Œè»Šæ¬¾ä¹Ÿæ²’å¤ªå¤šå¯ä»¥æŒ‘çš„ï¼Œå°æ–¼æ–°æ‰‹å…¥å‘ä¼¼ä¹ä¹Ÿæ˜¯å¥½äº‹ï¼Œä¸ç„¶æœ‰é¸æ“‡éšœç¤™ XD\nç©¶ç«Ÿè¦ä¸è¦ç›´ä¸Šç¢³çº–ä¹Ÿèªªä¸æº–ï¼Œé¨å±±è·¯è»Šé‡æ‡‰è©²å½±éŸ¿è »å¤šï¼Œä½†æˆ‘é¨é‹è»Šé‚„æ˜¯èƒ½ä¸Šé¢¨æ«ƒå˜´ã€å†·æ°´å‘ï¼Œé¨ç’°èŠ±æ±ä¹Ÿä¸è¼¸ç¢³çº–çš„è»Š (æ’åéƒ½åœ¨å‰ 50%)ï¼Œé™¤éæ˜¯å¿—åœ¨åƒåŠ  KOM\nå¾Œä¾†æœ‰å¹¸é¨åˆ°æœ‹å‹ç ´åè¬çš„ç¢³çº–è»Šï¼Œä¸€é¨ä¸Šå»å°±ç™¼ç¾ã€Œå“‡ï¼ä¹Ÿå¤ªå¥½é¨äº†å§ã€é¨èµ·ä¾†æ›´çµå¯¦ã€åŠ›é‡æ›´ç›´æ¥å‚³è¼¸å‡ºå»çš„æ„Ÿè¦ºï¼Œå³ä½¿é¨å¹³è·¯æ„Ÿå—ä¹Ÿå®Œå…¨ä¸åŒï¼Œæ‰€ä»¥é ç®—å¤ ç›´ä¸Šä¹Ÿç„¡ä»¿ XD\nä½†ç¢³çº–ä¸€ç´šè»Šæ¶è·ŸäºŒç´šè»Šæ¶çš„å·®è·æ²’æœ‰æ„Ÿå—éä¹Ÿé‚„ä¸çŸ¥é“\nè»Šå­æœ¬é«” å…¬è·¯è»ŠåŸºæœ¬ä¸Šè¶Šè¼•è¶Šè²´ï¼Œå…¥é–€åƒ¹å¤§ç´„éƒ½å¾ 1ã€2 è¬é–‹å§‹ï¼Œé€™æ™‚å€™é€šå¸¸éƒ½æ˜¯è²·æˆè»Šï¼Œå» ç‰Œçˆ¬äº†æ–‡å¤§æ¦‚å°±æ˜¯ Giant / Performer / KHS / Fuji / Merida ç­‰ï¼Œä¹‹å‰åªæœ‰è½éæ·å®‰ç‰¹çš„å¤§åï¼Œå¾Œä¾†è€ƒé‡äº†ä¸€ä¸‹æ±ºå®šè²· Performer çš„ Storm Dark\nä¸»è¦æ˜¯è½åº—å“¡ä»‹ç´¹èªªï¼Œä¸€èˆ¬å…¥é–€è»Šæ¬¾å„å¤§å» å·®ç•°ä¸å¤§ï¼Œå°±æ˜¯çœ‹è»Šå‹ã€å“ç‰Œåå¥½ã€é¡è‰²ç­‰ç­‰çš„é¸æ“‡ï¼Œç•¶åˆæœ€å¸å¼•æˆ‘çš„æ˜¯ Performer æœ‰æä¾›å·¥å» å®¢è£½åŒ–çƒ¤æ¼†ï¼Œè¦ºå¾—å¤šèŠ±ä¸€é»éŒ¢çƒ¤æˆè‡ªå·±å–œæ­¡çš„é…è‰²å¾ˆä¸éŒ¯\nä½†å¾Œä¾†æ²’æœ‰çƒ¤æ¼†ï¼Œå› ç‚ºç–«æƒ…é—œä¿‚è…³è¸è»Šè¨‚å–®æš´å¢ï¼Œè¦æ’çƒ¤æ¼†éœ€è¦å¾ˆä¹…ï¼Œå¾Œä¾†æƒ³èªªç­‰ä¹‹å¾Œæœ‰æ©Ÿæœƒå†èªª\né€™é‚Šæ¨è–¦ä¸€ä¸‹è³¼è²·çš„è»Šåº—å°å“²å±…å–®è»Šï¼Œè³¼è²·å¾Œæœ‰å¹«å¿™èª¿æ•´åé«˜ã€æŠŠæ‰‹ç­‰ç­‰åŸºæœ¬çš„ Fittingï¼Œå»ºè­°ç¬¬ä¸€æ¬¡è²·é‚„æ˜¯å»å¯¦é«”åº—é¢ï¼Œè«‹åº—å®¶å¹«å¿™æŠ“è»Šæ¶å¤§å°ç­‰ç­‰ï¼Œé€™é–“æœå‹™é‚„ä¸éŒ¯æ¨è–¦çµ¦å¤§å®¶\nå¾Œä¾†åœ¨ç¶²è·¯ä¸Šçœ‹åˆ°å°ˆæ¥­ Fitting å¸«èˆ’è¿·èªªçš„åˆ†äº«ï¼Œä¹Ÿè »æ¨è–¦å¤§å®¶å¯ä»¥æ”¶çœ‹é€™å€‹é »é“ï¼Œå¯ä»¥å­¸ç¿’åˆ°å¾ˆå¤šé—œæ–¼è‡ªè¡Œè»Šä»¥åŠå¦‚ä½•é¨ä¹˜ç­‰çŸ¥è­˜\nè®Šé€Ÿç³»çµ± è®Šé€Ÿç³»çµ±è¦æ ¼å¯ä»¥é¸æ“‡ï¼Œé€šå¸¸æ­é…çš„å» å•†æ˜¯æ—¥å•† Shimanoï¼Œä»–å€‘å®¶çš„è®Šé€Ÿå™¨æœ‰åˆ†å¹¾å€‹ Levelï¼Œæˆ‘é¸æ“‡æ˜¯ SORAï¼Œåº—å“¡æ˜¯èªªå…¥é–€å»ºè­°å°±å¾é€™æ¬¾é–‹å§‹ï¼Œæ›´ä½éšå°±ä¸æ¨ï¼Œè‡³æ–¼æ›´é«˜éšçš„ 105 / Ultegra ç­‰é‚„æ²’æœ‰å˜—è©¦éï¼Œç¨å¾®è©¢å•ä¸€ä¸‹ç­‰ç´šå·®ç•°ï¼Œä¸»è¦åœ¨æ–¼è®Šé€Ÿæ‰‹æ„Ÿã€ç²¾æº–åº¦èˆ‡é€Ÿåº¦çš„å·®ç•°ï¼›\nä½éšçš„åŸºæœ¬ä¸Šéƒ½æ˜¯æ©Ÿæ¢°è®Šé€Ÿï¼Œé‚„æœ‰æ›´è²´çš„é›»å­è®Šé€Ÿï¼Œåƒ¹æ ¼éƒ½è¦å¥½å¹¾è¬\nå¤§é½’ç›¤èˆ‡é£›è¼ª è‡ªè¡Œè»Šçš„å‚³å‹•ç³»çµ±ï¼Œå‰æ–¹æ˜¯å¤§é½’ç›¤ï¼Œå¾Œæ–¹æ˜¯é£›è¼ªï¼Œå¤§é½’ç›¤é€šå¸¸æ˜¯å…©ç›¤: å¤§ç›¤åŠ å°ç›¤ï¼Œå¾Œæ–¹é£›è¼ªå‰‡æ˜¯ç®—æœ€å°é½’åˆ°æœ€å¤§é½’\né½’è¼ªæ¯”æœƒå½±éŸ¿é¨ä¹˜æ™‚è¸©è¸çš„åŠ›é“ï¼Œé½’è¼ªæ¯”é«˜å°±è²»åŠ›ï¼Œé©åˆä¸‹å¡è·Ÿå¹³è·¯ï¼Œåä¹‹å‰‡ä¸Šå¡æ¯”è¼ƒè¼•é¬†ï¼Œçœ‹ä¸€äº›æ–‡ç« æœ‰æåˆ°é½’è¼ªæ¯”å°æ–¼é¨ä¹˜å½±éŸ¿å¾ˆå¤§ï¼Œç†æƒ³æ˜¯è…³è¸©è¸çš„è¼¸å‡ºåŠŸç‡ç©©å®šï¼Œä¹Ÿå°±æ˜¯åŠ›é“èˆ‡é »ç‡å›ºå®šï¼Œé€éè®Šé€Ÿä¾†é©æ‡‰åœ°å½¢çš„è®ŠåŒ–\næˆ‘å¾Œä¾†é£›è¼ªé¸æ“‡ 11T~34Tï¼Œä¸»è¦æ˜¯é æœŸæœƒå¾ˆå¸¸çˆ¬å¡ï¼Œ34T çˆ¬å¡è¸©èµ·ä¾†å°±å¾ˆè¼•\nå¡é‹ å¦ä¸€å€‹åœ¨è€ƒæ…®çš„æ˜¯å¡é‹ï¼Œä¸Šå¡åŸºæœ¬ä¸Šè¦ä¸‰åƒèµ·è·³ï¼Œè½æœ‹å‹èªªé€™æœƒå½±éŸ¿ç™¼åŠ›çš„æ–¹å¼ï¼Œå› ç‚ºè…³èˆ‡è¸æ¿åˆé«”ï¼Œæ‰€ä»¥å¾€å›æ‹‰å¤§è…¿è‚Œä¹Ÿæœƒå‡ºåŠ›ï¼Œè€Œä¸åƒä¸€èˆ¬é¨ä¹˜åªæœ‰ä¸‹è¸©çš„æ™‚å€™èƒ½å‡ºåŠ›\né™¤äº†åƒ¹æ ¼å¤–ï¼Œç©¿ä¸Šå¡é‹å±éšªæ€§æœƒé«˜ä¸€äº›ï¼Œå¯èƒ½è‡¨æ™‚è¦åœè»Šä½†è„±å¡ä¸é †å°±æœƒæ‘”è»Šï¼Œè€ƒé‡å¾Œæ±ºå®šå…ˆä¸€èˆ¬é¨ä¹˜å°±å¥½ï¼ŒæŠŠè‚ŒåŠ›ç·´èµ·ä¾†ä¹‹å¾Œå†èªª\né…ä»¶ å…¶ä»–é…ä»¶éƒ¨åˆ†ï¼Œæ¨è–¦å¹¾å€‹å¥½æ±è¥¿è¦æº–å‚™\næ‰‹é›»ç­’ / å¾Œæ–¹è­¦ç¤ºç‡ˆ:\né€™æ˜¯ä¸Šè·¯å¿…å‚™è£å‚™ï¼Œå¦å‰‡æœƒæœ‰è¡Œè»Šå®‰å…¨èˆ‡æ³•è¦å•é¡Œå–”! æ™šä¸Š/è¦–ç·šä¸å¥½ä¸€å®šè¦é–‹ç‡ˆ æ‰‹æ©Ÿæ¶:\næ¶åœ¨é¾é ­ä¸Šæ–¹ä¾¿å°èˆªï¼Œä½†å¦‚æœå¸Œæœ›é¨å±±è·¯æˆ–é•·æ™‚é–“(è¶…éå…©å°æ™‚)ï¼Œå»ºè­°è²·è»ŠéŒ¶ æ°´å£ºæ¶:\né€šå¸¸èƒ½å¤ åœ¨è»Šæ¶ä¸Šè£å…©å€‹ï¼Œå»ºè­°å…©å€‹éƒ½è£ï¼Œä¸€å€‹æ”¾æ°´å£ºï¼Œä¸€å€‹æ”¾ç¶­ä¿®ç½\nç¶­ä¿®ç½ç›®å‰å€‹äººæº–å‚™äº† CO2 é‹¼ç“¶ / å…§èƒ / æŒ–èƒæ£’ï¼Œä½†ç›®å‰é‚„æ²’ç”¨é è…³è¸è»ŠåŒ…:\nå¼·çƒˆæ¨è–¦ï¼Œç¸½æ˜¯è¦æœ‰å€‹åœ°æ–¹æ”¾é›¨è¡£ã€éŒ¢åŒ…ã€é‘°åŒ™ç­‰é›œç‰©ï¼Œè²·ä¸€å€‹åæ–¹æ–¹ä¾¿ï¼›\nå¦å¤–ä¸æ¨è–¦æ”¾åœ¨å‰æ–¹çš„å‰ç®¡è…³è¸è»ŠåŒ…ï¼Œç«™ç«‹æŠ½è»Šç­‰æœƒå½±éŸ¿é¨ä¹˜ï¼Œé™¤éæ˜¯æœ‰ç‰¹åˆ¥è¨­è¨ˆçš„è·Ÿå‰ç®¡å·®ä¸å¤šå¯¬åº¦ä¸å½±éŸ¿é¨ä¹˜ï¼Œå¦å‰‡è²·ç¶åœ¨åå¢Šä¸‹æ–¹çš„å€‹äººè¦ºå¾—ä¸éŒ¯ ä»¥ä¸Šæˆ‘éƒ½åœ¨äº¤è»Šæ™‚ä¸€æ¬¡è«‹è‡ªè¡Œè»Šåº—çµ„è£ï¼Œé…ä»¶å¤§æ¦‚ä¹ŸèŠ±äº† 3000 å¤šï¼Œç¸½å…±èŠ±äº† 2 è¬å‡ºé ­åœ¨è»Šå­ä¸Šï¼Œä½†å‘ä¹‹æ‰€ä»¥ç‚ºå‘å°±æ˜¯ä»–æœƒæ¯”ä½ æƒ³åƒä¸­çš„æ·±\u0026hellip;.\né™¤äº†ä¸Šè¿°è»Šç”¨å“å¤–ï¼Œé‚„æœ‰å¹¾é …äººèº«é…ä»¶\nå®‰å…¨å¸½:\nåŸºæœ¬ä¸Šè·¯å¤§å®¶éƒ½æœƒå¸¶ï¼Œç•¢ç«Ÿå…¬è·¯è»Šæ™‚é€Ÿä¹Ÿæ˜¯è »å¿«ï¼Œæœ‰äº›å…¬è·¯æœ‰å…¬è»Šã€æ±½æ©Ÿè»Šæ··é›œï¼Œæ‰€ä»¥å®‰å…¨æ˜¯è »åŸºæœ¬çš„ï¼Œæˆ‘æ˜¯åœ¨è¿ªå¡å„‚è²·å€‹ç°¡ä¾¿çš„ 999 å…ƒå®‰å…¨å¸½ è»Šè¡£è»Šè¤²:\nå› ç‚ºåå¢Šå…¶å¯¦è »ç¡¬çš„ï¼Œè¦èˆ’é©çš„é•·æ™‚é–“é¨ä¹˜ (ä¸€å°æ™‚ä»¥ä¸Š)ï¼Œå»ºè­°è²·å€‹è»Šè¤²ï¼Œæˆ‘åœ¨è¦çš®è²·ä¸€ä»¶ç´„ 500ï¼Œé‚„ç®—å¯ä»¥ï¼Œå¾Œä¾†ç™¼ç¾é‚„æ˜¯è¦è²·å¥½ä¸€é»çš„ï¼Œä¸ç„¶èƒ¯ä¸‹è·Ÿå¤§è…¿é¨å€‹ä¸€å°æ™‚å°±æœƒç™¼éº»ï¼Œå¾Œä¾†é¸è³¼ Monton å°ç£å“ç‰Œè¦ºå¾—ä¸éŒ¯ï¼Œç´„ $2000 ä¸Šä¸‹ï¼›\nè»Šè¡£æˆ‘è¦ºå¾—çœ‹å€‹äººï¼Œç©¿ä¸€èˆ¬é‹å‹•è£ä¹Ÿæ˜¯å¯ä»¥ï¼Œåªæ˜¯è»Šè¡£éƒ½æœƒåœ¨èƒŒå¾Œè¨­è¨ˆå£è¢‹ï¼Œå¦‚æœè¦é¨æ¯”è³½é‚„æ˜¯è¦è²·è»Šè¡£æ¯”è¼ƒæ¨è–¦ï¼Œè£œçµ¦æ”¾å£è¢‹å¾ˆæ–¹ä¾¿ è‡ªè¡Œè»Šæ¶:\nä¸€èˆ¬ä¸æœƒè£åœè»ŠæŸ±ï¼Œå› ç‚ºé‡é‡èˆ‡ç¾è§€è€ƒé‡ï¼Œå¹³å¸¸éƒ½æ˜¯æ–œé åœ¨ç‰†ä¸Šï¼Œä½†æ˜¯å¶çˆ¾è¦æ¸…ç†è»Šå­é‚„æ˜¯è¦è²·å€‹è»Šæ¶ï¼Œæ¥µåº¦ä¸æ¨è–¦ä»¥ä¸‹é€™æ¬¾ï¼Œé€™ç¨®é€šå¸¸ä¸€å…©ç™¾å…ƒå°±æœ‰ï¼Œä½†æ˜¯è¶…ç´šä¸ç©©å®š æˆ‘æ˜¯è‡ªå·±å¦å¤–æ›¿æ›èºçµ²æ‰å‹‰å¼·å‰›å¥½ï¼Œä¸ç„¶ç¬¬ä¸€æ¬¡æ´—è»Šä¸€ç›´æ»‘è½è¶…ç´šä¸çˆ½\n4. æ¸…æ½”ç”¨å“\néˆæ¢ç‚ºäº†è¦ç¶­æŒæ»‘é †çš„é‹ä½œï¼Œéœ€è¦ä¸ŠéŠæ¢æ²¹ï¼Œä½†æ˜¯è·¯é¢çš„ç°å¡µã€å°çŸ³å­æœƒè¢«æ²¹æ²¾é»ï¼Œæ‰€ä»¥ä¹…äº†å°±æœƒé»‘é»‘çš„ï¼Œéœ€è¦å»æ²¹æ¸…æ½”å¾Œå¾Œé‡æ–°ä¸Šæ²¹ï¼Œæ‰€ä»¥éœ€è¦å»æ²¹æ±¡æ¸…æ½”åŠ‘ä»¥åŠéŠæ¢æ²¹ï¼Œé€šå¸¸é¨ä¹˜å¾Œå°±è¦ç¨å¾®æ¸…æ½”è·Ÿä¿é¤Šï¼Œè‡³å°‘æ·‹åˆ°é›¨ä¸€å®šè¦ä¿é¤Š\næˆ‘è‡ªå·±æ˜¯ç”¨å»¢æ£„ç‰™åˆ·è·Ÿå»šæˆ¿çš„é›™è‰²æ´—ç¢—åˆ·æ¸…æ½”ï¼Œä¸ŠéŠæ¢æ²¹å¾Œç”¨å»šæˆ¿é¤å·¾ç´™è¼•è¼•çš„æŠŠå¤šé¤˜çš„æ²¹æ“¦æ‰é¿å…æ²¾æŸ“ç°å¡µ\n5. æ‰“æ°£ç­’\næ¯æ¬¡å‡ºç™¼å‰éƒ½è¦æª¢æŸ¥èƒå£“ï¼Œæˆ‘åŸºæœ¬ä¸Šéƒ½æœƒæ‰“åˆ° 110 psiï¼Œè²·äº†ä¸€å€‹æ·å®‰ç‰¹çš„æ‰“æ°£ç­’ CONTROL TOWER 1+ 1000å…ƒé‚„è »å¥½ç”¨ï¼Œä½†æ„Ÿè¦ºå¯ä»¥ä¸ç”¨è²·åˆ°é€™éº¼è²´ï¼Œç•¶åˆä¸å°å¿ƒæ‰‹æ»‘\u0026hellip;\nä»¥ä¸Šå¤§æ¦‚åˆèŠ±äº† 5000å…ƒ\nç›®å‰ç¸½åƒ¹ é‚„æœ‰ä¸€äº›é›¶é›¶ç¸½ç¸½å…± 27000 30000 å…ƒï¼Œé‚„æœ‰ä¸€äº›å•†å“æ˜¯è§€æœ›ä¸­ï¼Œåˆ—å‡ºä¾†åƒ…ä¾›åƒè€ƒ\nè»ŠéŒ¶èˆ‡ç›£æ§è¨­å‚™ å¦‚æœå¸Œæœ›é¨çš„æ›´å°ˆæ¥­ï¼Œå°±éœ€è¦æ›´å°ˆæ¥­çš„è¨­å‚™å»ç›£æ§æ¯æ¬¡é¨ä¹˜çš„æ•ˆæœï¼Œæœƒæœ‰å¾ˆå¤šçš„æ„Ÿæ¸¬å™¨å»ç›£æ¸¬è¸é »ã€é€Ÿç‡ã€å¿ƒç‡ã€åŠŸç‡ï¼Œä»¥ä¸Šè·Ÿé¨ä¹˜è¡¨ç¾æœ‰å¾ˆç›´æ¥ç›¸é—œ\nå¦‚åŒè·‘æ­¥å¤§å®¶éƒ½æœƒå•å€™ä½ çš„åˆ†é€Ÿã€Œè·‘ä¸€å…¬é‡Œéœ€è¦å¹¾åˆ†é˜ã€ï¼Œè…³è¸è»Šè«‡çš„æ˜¯ã€ŒåŠŸç‡ã€ï¼Œä¸€å°æ™‚èƒ½å¤ è¼¸å‡ºå¹¾ç„¦è€³çš„èƒ½é‡ï¼Œæ‰€ä»¥éœ€è¦åŠŸç‡è¨ˆå»è§€æ¸¬è…³è¼¸å‡ºçš„åŠ›é‡ï¼Œä½†åŠŸç‡è¨ˆéå¸¸è²´ï¼Œéƒ½è¦ä¸€å…©è¬èµ·è·³ï¼Œæ–°æ‰‹å…¥é–€æˆ‘å°±å…ˆä¸è€ƒæ…®äº†\u0026hellip;\nå¯ä»¥åƒè€ƒä»¥ä¸‹å½±ç‰‡å°æ–¼åŠŸç‡çš„åˆ†ç´šï¼Œå¾ˆæœ‰è¶£\nç¬¬äºŒå€‹æ˜¯å¿ƒç‡ï¼Œå› ç‚ºè‡ªè¡Œè»Šé€šå¸¸ä¹Ÿæ˜¯èµ°é•·é€”è€åŠ›è³½ï¼Œæ‰€ä»¥è¦ç¶­æŒåœ¨ä¸€å®šçš„å¿ƒç‡å¼·åº¦è¨“ç·´ï¼Œå¯ä»¥è§€å¯Ÿè‡ªå·±æ˜¯å¦å¤ªå¿«æˆ–å¤ªæ…¢ï¼Œå°±è·Ÿè·‘æ­¥è§€æ¸¬çš„æŒ‡æ¨™ä¸€æ¨£\nå¯ä»¥è²·å°ˆæ¥­çš„å¿ƒç‡å¸¶ï¼Œæˆ–æ˜¯æœ‰æ‰‹éŒ¶ï¼Œä½†å› ç‚ºåƒ¹æ ¼è€ƒé‡ä¸€æ¨£å…ˆç•¥é\næœ€å¾Œå°±æ˜¯é€Ÿç‡èˆ‡è¸é »ï¼Œæˆ‘é¸æ“‡å…ˆè²·ä¸€å€‹è¸é »æ„Ÿæ¸¬å™¨ï¼Œæˆ‘é¸æ“‡ Bryton è¸é »æ„Ÿæ¸¬å™¨ç´„ 800 å…ƒï¼Œä¸»è¦è€ƒé‡æ˜¯è¸é »æ˜¯æœ€åŸºæœ¬çš„æŒ‡æ¨™ï¼Œçœ‹äº†ä¸€äº›æ•™å­¸å½±ç‰‡éƒ½æ¨è–¦æ–°æ‰‹å…ˆè¨“ç·´è¸é »ç©©å®šåº¦é–‹å§‹ï¼Œè€Œä¸”è¸é »å¤ªä½æœƒå‚·è†è“‹ï¼Œç›®å‰æ˜¯æŠ“å¹³è·¯ 90~100ï¼Œä¸Šå¡è‡³å°‘ 65~70ï¼Œå¯ä»¥ç”¨æ‰‹æ©Ÿæ­é… Appï¼ŒiOS æˆ‘ç”¨ ã€ŒALA Cyclingã€ï¼Œå…è²» App é‚„ç®—å·®å¼·äººæ„\nå¾Œä¾†å¥³å‹è²¼å¿ƒçš„è²·äº† Bryton 320 ï¼Œæœ‰è»Šæ©ŸçœŸçš„æ–¹ä¾¿å¾ˆå¤šï¼ŒBryton å…¥é–€ä½¿ç”¨é‚„ç®—ä¸éŒ¯ï¼Œæ­é…è¸é » / å¿ƒç‡å¸¶æœ‰æ•¸æ“šå¯ä»¥ç›£æ§è‡ªå·±é‹å‹•çš„ç‹€æ³å¾ˆä¸éŒ¯ï¼Œçµ‚æ–¼å¯ä»¥è®“æ‰‹æ©Ÿé€€å½¹ï¼Œå¯ä»¥çš„è©±å»ºè­°æ­é…ï¼Œè¦è¨“ç·´åŸºæœ¬ä¸Šå°±æ˜¯å¿…å‚™ï¼›\né«˜éšè»ŠéŒ¶æœƒæ­é…å…¨å½©è¢å¹•èˆ‡ GPS å°èˆªåŠŸèƒ½ï¼Œæˆ‘å€‹äººä¸Šè·¯æ˜¯éƒ½ä¸å¤ªçœ‹å°èˆªï¼Œé ‚å¤šæ‰‹æ©Ÿç¨å¾®æŸ¥ä¸€ä¸‹ï¼Œè¦ºå¾—å°èˆªåŠŸèƒ½æ€§å¥½åƒæ™®æ™®ï¼Œå¦‚æœé¨å›ºå®šè·¯ç·šå±…å¤šå»ºè­°å¯ä»¥ä¸ç”¨å…ˆè€ƒæ…® GPS åŠŸèƒ½\nå…¶é¤˜é›œä¸ƒé›œå…«çš„æ¨è–¦ æ°´ç®¡ å…ˆæ¨è–¦ä¸€äº› Youtube é »é“\nå¯åˆ©ä¹ï¼Œæˆ‘æœ€å–œæ­¡çš„é »é“ï¼Œå¤§å”çš„è²éŸ³å¾ˆæœ‰ç£æ€§ XD æ˜¯è‡ªè¡Œè»Šåº—è€é—†èˆ‡æ„›å¥½è€…ï¼Œçœ‹èµ·ä¾†æœ‰åœ¨åœ‹å¤–ç”Ÿæ´»ï¼Œä»‹ç´¹çš„ç¯„åœå¾ˆå»£ï¼Œå¾æ´—è»Šã€è»Šæ¬¾ä»‹ç´¹ã€è‡ªä¸»ç¶­ä¿®ã€æ–°å“ä»‹ç´¹ç­‰ç­‰æˆ‘éƒ½å¾ˆå–œæ­¡ è„†ç“œåŸä¸»ï¼Œæœ‰ä¸€äº›è·¯ç·šæ¨è–¦ã€é€²éšçŸ¥è­˜çš„åˆ†äº« k2ï¼Œä¸»è¦çœ‹ä¸€äº›çµ„è£ç­‰ç­‰ä»‹ç´¹ï¼Œè¦ºå¾—å½±ç‰‡å…§å®¹ã€ç¯€å¥éƒ½è »å–œæ­¡çš„ ä¸€è¼ªçš„é‹å‹•æ—¥å¸¸eLun_fitnessTWã€Linda Loves Cyclingã€ä¼Šå¨ƒ Evaï¼Œçœ‹æ­£å¦¹çš„é »é“å°±æ˜¯å¾ˆæ£’ XD æœ‰å¾ˆå¤šçš„é¨è»Šç´€éŒ„ã€è‡ªè¡Œè»Šç”Ÿæ´»ç›¸é—œçš„åˆ†äº«ï¼Œå……æ»¿æ­£èƒ½é‡ App Strava: ç¤¾ç¾¤+é‹å‹•ç´€éŒ„ï¼Œæ¯æ¬¡éƒ½å¯ä»¥è¨˜éŒ„è‡ªå·±çš„é¨ä¹˜ï¼Œé‚„å¹«ä½ åˆ‡è·¯æ®µæ¯”è¼ƒé€Ÿåº¦è¶…æœ‰è¶£çš„ï¼Œå¯ä»¥çœ‹åˆ°è‡ªå·±ä¸€æ¬¡æ¯”ä¸€æ¬¡é€²æ­¥å°±å¾ˆèˆ’å£“ï¼Œé€šå¸¸å„å¤§è»ŠéŒ¶ä¹Ÿéƒ½æ”¯æ´å°‡ç´€éŒ„å½™æ•´åˆ° Stravaï¼Œåƒ Bryton ä¹Ÿæœ‰æ”¯æ´\nè·¯ç·šç´€éŒ„ è·¯æ®µè¨ˆæ™‚ï¼Œå¯èƒ½æ˜¯ç¿»è­¯å•é¡Œæ‰€ä»¥æœ‰çš„è·¯æ®µåç¨±å¾ˆæ€ªï¼Œæœ‰çš„æœ‰åœ¨åœ°åŒ– Velodash:\næ“šèªªæ˜¯å°ç£äººç¶“ç‡Ÿçš„ï¼Œç›¸å° Strava æœ‰æ›´å¤šåœ¨åœ°çš„å…ƒç´ ï¼Œå°¤å…¶æ˜¯è·¯ç·šæ¢ç´¢å¾ˆå¥½ç”¨ï¼Œç´€éŒ„é é¢æˆ‘å€‹äººä¹Ÿè¦ºå¾—æ¯” Strava å¥½çœ‹ï¼Œå¯æƒœæ²’è¾¦æ³•é€£çµè£å‚™ ALA Cycling: ç‚ºäº†æŠŠæ‰‹æ©Ÿç•¶è»ŠéŒ¶ç”¨çš„ App\nç¸½çµ é•·è·¯æ¼«æ¼«ï¼Œæœ€è¿‘é¨çš„é‚„ç®—è »æœ‰èˆˆè¶£ï¼Œå¸Œæœ›èƒ½å¤ ç¨å¾®å¹«åŠ©åˆ°å‰›æº–å‚™å…¥å‘çš„äºº\nå¹³å¸¸è »å–œæ­¡é¨ç’°å°å°åŒ—ã€æ²³æ¿±ã€é¢¨æ«ƒå˜´\n","date":"2020-10-08T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020-10-08_%E5%85%AC%E8%B7%AF%E8%BB%8A%E6%96%B0%E6%89%8B%E4%B8%8A%E8%B7%AF-%E5%85%A5%E5%9D%91%E4%B8%80%E5%80%8B%E6%9C%88%E7%9A%84%E5%BF%83%E5%BE%97/","title":"å…¬è·¯è»Šæ–°æ‰‹ä¸Šè·¯-å…¥å‘ä¸€å€‹æœˆçš„å¿ƒå¾—"},{"content":"è¿‘æ—¥å› é…æˆ´å…©ä¸‰å¹´çš„çœ¼é¡ç£¨æéæ–¼åš´é‡ï¼ŒåŠ ä¸Šæˆ¶å¤–é‹å‹•éœ€æ±‚å¸Œæœ›æ­é…è‡ªå‹•è®Šè‰²é¡ç‰‡ï¼Œé™ä½ç´«å¤–ç·šå°æ–¼çœ¼ç›çš„å‚·å®³ï¼Œæ±ºå®šé ç®—æ‹‰é«˜ä¸€æ¬¡é…åˆ°å¥½ï¼›\nåœ¨ç¶²è·¯ä¸ŠæŸ¥è©•åƒ¹ï¼Œçœ‹åˆ°æœ€å¾Œå°±æ˜¯é€™å…©é–“åœ¨çŒ¶è±« éˆé­‚ä¹‹çª— vs å…‰æ˜åˆ†å­ï¼ŒPTT æ¿ä¸Šå¤§å¤šæ¨è–¦é©—å…‰å¾ˆå²å®³ï¼Œåƒ¹æ ¼ä¹Ÿå¾ˆå²å®³ï¼Œä½†æ²’æœ‰è¦ªèº«é«”é©—ä¹Ÿä¸å¤ªç¢ºå®šï¼Œå‰›å¥½å¥³å‹ä¹Ÿè¦æ›çœ¼é¡ï¼Œå°±æ±ºå®šä¸€äººä¸€é–“ä¾†æ¯”å°æœå‹™ï¼Œåˆ†åˆ¥æ˜¯é¸éˆé­‚ä¹‹çª—ä¸­å±±åº—å’Œå…‰æ˜åˆ†å­æ•¦å—åº—\nä»¥ä¸‹ä¸å°ˆæ¥­å¿ƒå¾—ï¼Œåƒ…ä¾›åƒè€ƒ (æ‡‰è©²ä¸æœƒæœ‰äººæ‡·ç–‘æ˜¯æ¥­é…å§ XD\nTLDRï¼›\nå…©é–“æœå‹™éƒ½å¾ˆè®šï¼Œéƒ½æœƒå¾ˆä»”ç´°é©—å…‰ï¼Œä¸¦ä»‹ç´¹æ¯ä¸€æ­¥é©Ÿçš„ç›®çš„è·Ÿæ„ç¾©ï¼Œä¹Ÿå°è‡ªå·±çš„çœ¼ç›æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼›\nå€‹äººé«”é©—ä¸Šçš„å·®ç•°\néˆé­‚ä¹‹çª—åƒ¹æ ¼å¸¶è¼ƒå¯¬ï¼Œé«˜è¦åˆ°ä½è¦éƒ½æœ‰ï¼› å…‰æ˜åˆ†å­æ•´é«”é«”é©—æ¯”è¼ƒé«˜ç´šï¼Œé©åˆå¾ˆè¬›ç©¶å“å‘³çš„äºº å¯¦éš›æ­é…çš„çœ¼é¡åƒ¹æ ¼:\nåº—å®¶ é¡æ¶ é¡ç‰‡ ç¸½åƒ¹ éˆé­‚ä¹‹çª— ä¸é½é‹¼å°ç£å“ç‰Œï¼ŒåŸåƒ¹ æ‰“6æŠ˜ 7000å¤š ä¾è¦–è·¯å…¨è¦–ç·š+æ›²ç‡1.6 ç´„ 7000å¤š ç¾é‡‘åƒ¹å¯å¤šæ‰“ 95æŠ˜ï¼Œç¸½å…±ç´„ 14000 å…ƒ (æœŸé–“æ­é…æŒ¯èˆˆåˆ¸å¯ä»¥å¤šæŠ˜ 1000) å…‰æ˜åˆ†å­ æ—¥æœ¬å“ç‰Œ Mr. gentlemanï¼Œæœ‰é»å¿˜è¨˜å·¥è—ã€æè³ªä¸Šæœ‰æ²’æœ‰ç‰¹æ®Šçœ‰è§’ï¼Œç´„ 14000 ä»‹ç´¹åªæœ‰è”¡å¸å‹éŒ„ï¼Œæ›²ç‡é¸ 1.67 çš„æ–°ä¸€ä»£éè†œ ï¼Œå› é–ƒå…‰éé‡æ‰€ä»¥éœ€è¦å®¢è£½åŒ–é¡ç‰‡ç´„ 9900 23000 å·¦å³ï¼Œæ²’æœ‰ç‰¹æ®Šçš„æŠ˜æ‰£ é ç®—å¤ å°±åˆ°é€™å…©é–“é…é…çœ‹ï¼Œè·Ÿä¸€èˆ¬çš„çœ¼é¡è¡Œæœå‹™ã€å°ˆæ¥­åº¦çœŸçš„æ˜¯æœ‰å¾ˆå¤§çš„è½å·®\né©—å…‰ æœ¬äººé«”é©—çš„æ˜¯éˆé­‚ä¹‹çª—ï¼Œå…¨ç¨‹å¥³å‹é™ªåŒåœ¨æ—ï¼Œäº‹å¾Œæ¯”å°é©—å…‰æµç¨‹å…©é–“å¹¾ä¹ä¸€æ¨¡ä¸€æ¨£ï¼Œåªæœ‰é †åºä¸åŒ\nè§’è†œç‹€æ³ ç”¨ä¸€å°æœ‰å¤šå€‹åœ“åœˆçµ„æˆçš„å„€å™¨å»æ‹æ”è§’è†œï¼Œæ“šé©—å…‰å¸«èªªäººçœ¼ 70% åº¦æ•¸ä¾†è‡ªè§’è†œï¼Œä¹Ÿå°±æ˜¯çœ¼ç›æœ€å¤–åœçš„ä¸€å±¤ï¼Œå…ˆæ‹æ”è§’è†œæ˜¯ç‚ºäº†ç¢ºèªå¥åº·ç‹€æ…‹ï¼Œå¦‚æœæœ‰å—æé‡æ¸¬è¦–åŠ›ä¹Ÿä¸æº–ï¼Œä¹Ÿå°±æ²’æœ‰å¾ŒçºŒé©—å…‰çš„å¿…è¦\né‡æ¸¬å‡ºä¾†æœƒæœ‰ç­‰é«˜ç·šåœ–ï¼Œé¡¯ç¤ºè§’è†œæ›²åº¦çš„ç‹€æ…‹ï¼Œå¦‚æœæ˜¯æœ‰é–ƒå…‰æœƒå‘ˆç¾å…«å­—å½¢\né™¤äº†è§’è†œå¤–ï¼Œé‚„æœƒè§€å¯Ÿç³å­”å¤§å°ï¼Œå€‹äººç³å­”åå¤§ï¼Œæ‰€ä»¥é©—å…‰å¸«èªªæœƒæœ‰æ—¥å¤œè¦–å·®å¤§ä»¥åŠç•å…‰ç­‰ç¼ºé»\næ¸¬é‡åº¦æ•¸ é€™éƒ¨åˆ†æœ‰é»é¡ä¼¼ä¸€èˆ¬çœ¼é¡è¡Œçš„é©—å…‰ï¼Œæœƒçœ‹ç¿»æ»¾ E çš„ç¼ºå£ / ç´…è‰²ç¶ è‰²å“ªé‚Šé¡¯çœ¼ï¼Œå¾Œä¾†æ‰çŸ¥é“å¦‚æœç´…è‰²æ˜é¡¯ä»£è¡¨èª¿æ•´è¦–åŠ›å¤ªæ·ºï¼Œç¶ è‰²æ˜é¡¯ä»£è¡¨èª¿æ•´è¦–åŠ›éæ·±ï¼Œè¦å…©é‚Šä¸€æ¨£æ¸…æ¥šæ‰æ˜¯æ­£ç¢ºçš„\nå› ç‚ºæœ¬èº«æœ‰é–ƒå…‰ï¼Œé©—å…‰å¸«æœƒå»é‡æ¸¬é–ƒå…‰çš„è§’åº¦ï¼Œç›¸èšæ–¼æ­£å¸¸çš„çœ¼ç›å‘ˆç¾çƒé«”ï¼Œé–ƒå…‰çš„çœ¼ç›æ˜¯å±¬æ–¼æ©¢åœ“å½¢ï¼Œæœƒé€éé¡ç‰‡ç£¨è£½å»çŸ¯æ­£ï¼Œä½†æ©¢åœ“å‚¾æ–œçš„è§’åº¦å°±æœƒå½±éŸ¿é¡ç‰‡ç£¨è£½çš„æ–¹å‘ï¼Œæ‰€ä»¥éœ€è¦å»èª¿æ•´è§’åº¦\næ¥è‘—é‚„æœ‰æ¸¬é‡ æ–œè¦–è·Ÿæ–œä½ï¼Œæ–œè¦–æ˜¯å‘å‰çœ‹æ™‚ç³å­”ä¸æ˜¯æŒ‡å‘æ­£å‰æ–¹ï¼Œæ‰€ä»¥é¢å°é¢èªªè©±æœƒä»¥ç‚ºå°æ–¹è¦–ç·šä¸åœ¨è‡ªå·±èº«ä¸Šï¼›\nè€Œæ–œä½æ˜¯çœ¼ç›é–‰èµ·æ™‚æœƒå¾€æ—é‚Šä½ç§»ï¼Œç­‰åˆ°è¦ç›´è¦–æ™‚æœƒé€éè‚Œè‚‰æ‹‰æ‰¯æŠŠç³å­”å°æ­£ï¼Œä½†å¦‚æœè‚Œè‚‰ç„¡åŠ›å°±æœƒæœ‰æ–œè¦–çš„å•é¡Œï¼Œå¯ä»¥ç†è§£æˆçœ¼ç›æœƒæ‰¾æ™‚é–“å·æ‡¶çš„æ¦‚å¿µ XD\næ¸¬é‡æ–¹æ³•æ˜¯ç”¨çœ¼ç›ç›´è¦–å‰æ–¹ï¼Œç”¨ç‰¹æ®Šçš„é¡ç‰‡å»æª¢æ¸¬çœ¼ç›æ˜¯å¦æœ‰ä¸Šè¿°ç‹€æ³ï¼Œå¤ªåš´é‡è€…è¦çŸ¯æ­£ï¼Œæœ¬èº«æœ‰ç¨å¾®æ–œä½ï¼Œä½†æ˜¯ä¸åš´é‡ä¸éœ€è¦å¦å¤–çŸ¯æ­£\næœ€å¾Œé©—å…‰å¸«æœƒæŠŠå‰›å‰›çš„æ•¸æ“šï¼Œå†åšèª¿æ•´ï¼Œéˆé­‚ä¹‹çª—çš„é©—å…‰å¸«ç›´æ¥æ‹¿å‡ºç™½æ¿ç•«åœ–è¬›è§£ï¼Œå€‹äººååˆ†å–œæ­¡é€™ç¨®æ•™è‚²é¡§å®¢çš„ä½œæ³•ï¼Œå¾Œé¢è£œå……èªªæ˜äº†\nèª¿æ•´è¦–åŠ›åªæ˜¯è¦è®“æˆåƒä½ç½®æº–ç¢ºè½åœ¨è¦–ç¶²è†œä¸Šï¼Œè€Œè¦–åŠ›çŸ¯æ­£çš„æ¥µé™(1.0 é‚„æ˜¯ 2.0)æ˜¯çœ‹è¦–ç¶²è†œç´°èƒæ•¸é‡ï¼Œç´°èƒè¶Šå¤šæˆåƒæ•ˆæœè¶Šå¥½ï¼Œå°±åƒæ‹ç…§åŒæ¨£çš„é¡é ­åº•ç‰‡ç´ è³ªä¸åŒæ‹æ”æ•ˆæœä¹Ÿä¸åŒçš„é“ç† é‡æ¸¬åº¦æ•¸å¯ä»¥å¾®èª¿ï¼Œä¸€èˆ¬é‡æ¸¬çš„è¦–åŠ›æ˜¯çœ‹é ç‰©ï¼Œä¹Ÿå°±æ˜¯å…­å…¬å°ºä»¥ä¸Šï¼Œä½†å¦‚æœå¹³å¸¸éƒ½æ˜¯çœ‹è¿‘ç‰©ç‚ºä¸»ï¼Œå¯ä»¥å¾®èª¿é™è¿‘è¦–åº¦æ•¸ï¼Œäººçœ¼é€éç«ç‹€è‚Œè·Ÿæ°´æ™¶é«”å»èª¿æ•´èšç„¦çš„ä½ç½®ï¼Œåªèƒ½æŠŠæˆåƒä½ç½®å¾€å¾Œæ‹‰ä¸å¯èƒ½å¾€å‰æ‹‰ï¼ŒåŸç†åƒæ˜¯è¿‘è¦–çš„äººæ±è¥¿æ‹¿è¿‘å°±çœ‹å¾—åˆ°ï¼Œå› ç‚ºæˆåƒä½ç½®æœƒå¾€å‰æ‹‰å‰›å¥½è½åˆ°è¦–ç¶²è†œä¸Š å…¨è¦–ç·š æ˜¯ä¸€é–€å°ˆåˆ©æŠ€è¡“ï¼Œæˆæ¬Šçµ¦é¡ç‰‡è£½é€ å•†å»ç”Ÿç”¢ï¼Œæ‰€ä»¥å¥½åƒæœ‰è »å¤šé–“å» å•†éƒ½æœ‰æä¾›ï¼Œå¦å¤–å…¨è¦–ç·šæ˜¯éš”çµ•ç´«å¤–ç·šè€Œéå…‰é‡ï¼Œä¹Ÿå°±æ˜¯é™°å¤©å¯èƒ½é¡ç‰‡ä¹Ÿæœƒè®Šè‰²ï¼Œä½†é–‹è»Šå¯ä»¥ä¸ç”¨æ“”å¿ƒï¼Œå› ç‚ºæ“‹é¢¨ç»ç’ƒé€šå¸¸æœƒéš”çµ•ç´«å¤–ç·šï¼Œä¸å¤ªéœ€è¦æ€•é€²å…¥éš§é“æœƒå¤ªæš— ç¾åœ¨æŠ—è—å…‰æŠ€è¡“æœ‰æå‡ï¼Œåƒ…å¸æ”¶éƒ¨åˆ†å°äººçœ¼æœ‰å®³çš„éƒ¨åˆ†è—å…‰æ³¢é•·ï¼Œé¡è‰²ä¸æœƒè®Šé»ƒå¾ˆå¤šï¼Œæœ‰å¯¦éš›æ‹¿é¡ç‰‡æ¸¬è©¦ç¢ºå¯¦å·¥ç¨‹å¸«çš„çœ¼ç›çœ‹ä¸å‡ºè‰²å·® XD ä»¥ä¸Šé©—å…‰æ™‚é–“ç´„ 45 åˆ†é˜ï¼Œé€™å…©é–“éƒ½å·®ä¸å¤šï¼Œé æ¯”å…¶ä»–é–“é©—å…‰é‚„è¦ä»”ç´°çš„å¤šï¼Œè¨˜å¾—ç¶²è·¯å…ˆé ç´„å–”\næ¸¬é‡é¡æ¡†åœ¨è‡‰ä¸Šçš„ä½ç½® ä»¥å‰é…çœ¼é¡ï¼Œéƒ½æ˜¯é©—å…‰å®ŒæŒ‘å®Œé¡æ¡†è¨­è¨ˆå°±çµæŸï¼Œä½†å…¶å¯¦å› ç‚ºæ¯å€‹äººè‡‰å‹ä¸æ˜¯å®Œç¾å°ç¨±ï¼Œå–œæ­¡å¸¶çš„çœ¼é¡é«˜åº¦ä¹Ÿä¸åŒï¼Œé€™äº›éƒ½æœƒå½±éŸ¿åˆ°é¡ç‰‡ï¼Œæ‰€ä»¥é¡æ¡†çš„å¾®èª¿ä¹Ÿæ˜¯å¾ˆé‡è¦çš„\né€™æ¬¡å»éˆé­‚ä¹‹çª—ï¼Œæœ‰å„€å™¨æ­é… app æ‹æ”æ­£é¢èˆ‡å´é¢ï¼Œæ­£é¢å»çœ‹ç³è·ï¼Œå´é¢çœ‹çœ¼ç›è·é›¢é¡ç‰‡çš„é•·åº¦ï¼Œé€™äº›æ•¸æ“šæœƒå½±éŸ¿é¡ç‰‡ç£¨è£½çš„è§’åº¦\nå…‰æ˜åˆ†å­é€™æ–¹é¢åšå¾—æ›´åŠ çš„å…ˆé€²ä¸€äº›ï¼Œé¦–å…ˆæ˜¯å„€å™¨ä½¿ç”¨è”¡å¸æä¾›çš„ï¼Œå…±æœ‰å¤šé¡†é¡é ­æ‰€ä»¥ç«™å®šé»æ‹ä¸€æ¬¡æå®šï¼Œå¦å¤–å´è‡‰æœ‰å»èª¿æ•´çœ¼é¡çš„å‚¾æ–œçš„è§’åº¦ï¼Œé¿å…è²¼è‡‰å¤ªè¿‘æˆ–å¤ªé ï¼Œé€™éƒ¨åˆ†æ˜é¡¯å¥½ä¸€äº›\nå…¶é¤˜ è¬›ä¸€äº›å…¶ä»–é›œä¸ƒé›œå…«çš„æ„Ÿå—å¥½äº†\næœå‹™ å…©é–“é©—å…‰å¸«éƒ½å¾ˆæ£’ï¼Œæœå‹™æ…‹åº¦éƒ½å¾ˆå¥½ï¼Œåƒæ˜¯æœ‰å•å…¨è¦–ç·šæ˜¯ä»€éº¼ã€çœ¼ç›èƒ½ä¸èƒ½çŸ¯æ­£åˆ° 2.0 ç­‰ç­‰é›œä¸ƒé›œå…«çš„å•é¡Œï¼Œéƒ½æœ‰å¾ˆå®Œæ•´çš„è§£ç­”ï¼Œä½†å…©äººæ¯”è¼ƒå¾Œç¨ç¨åå¥½éˆé­‚ä¹‹çª—çš„è§£èªªï¼Œå› ç‚ºç”¨ç™½æ¿å¤ªèªçœŸäº† XD è€Œä¸”æ•´é«”ä¸Šè¬›å¾—æ¯”è¼ƒå…¨é¢\nåº—é¢ åœ°é»éƒ½éå¸¸æ–¹ä¾¿ï¼Œè£æ½¢éƒ¨åˆ†å…‰æ˜åˆ†å­å°±æ˜¯ç°¡ç´„ä½†æ˜¯åˆé€éœ²è‘—å¥¢è¯ï¼Œè®“æœ¬å®…ç©¿è‘—å¤¾è…³æ‹–é€²å»æœ‰é»ä¸å¤ªè‡ªåœ¨ (çª®äººè²Œ)ï¼Œç‡Ÿé€ è‘—æ™‚å°šã€å¹´ä»£æ„Ÿçš„æ°£æ°›ï¼Œé¡æ¶ä¹Ÿéƒ½æ˜¯è¨­è¨ˆå“ç‰Œï¼Œæ‰€ä»¥å¾ˆåœ¨æ„è¨­è¨ˆæ„Ÿã€å¤–è§€çš„äººå¯ä»¥è€ƒæ…®ï¼› éˆé­‚ä¹‹çª—ç›¸å°å°±å¾ˆæ˜äº®ï¼Œæ¯”è¼ƒæ˜¯å¹³æ—¥æœƒå»çš„çœ¼é¡è¡Œï¼Œåƒ¹æ ¼å¸¶å¾ˆå¯¬ï¼Œä¾¿å®œçš„å¹¾åƒå…ƒåˆ°ä¸Šè¬å…ƒéƒ½æœ‰ï¼Œå¸‚äº•å°æ°‘æƒ³è¦é…å€‹å¥½çœ¼é¡å»é€™é‚Šæ‡‰è©²æ¯”è¼ƒè‡ªåœ¨\nè‡³æ–¼é¡ç‰‡éƒ¨åˆ†è”¡å¸è·Ÿä¼Šè¦–è·¯åœ¨è€ç”¨æ€§ã€è¦–è¦ºæ¸…æ™°åº¦ã€é€äº®åº¦ç­‰ç­‰çš„æ¯”è¼ƒï¼Œå› ç‚ºä¹Ÿä¸æ˜¯å°ˆæ¥­çš„å°±ä¸å¤šèªªï¼Œåƒ…æ†‘ä¸€å€‹é–€å¤–çš„æ¶ˆè²»è€…åˆ†äº«è‡ªå·±é«”é©—çš„éç¨‹ï¼Œå¦‚æœæœ‰ä»»ä½•è¬›éŒ¯çš„åœ°æ–¹æ­¡è¿ç•™è¨€\n","date":"2020-10-04T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-10-04_-%E9%85%8D%E7%9C%BC%E9%8F%A1%E6%8E%A8%E8%96%A6-%E9%9D%88%E9%AD%82%E4%B9%8B%E7%AA%97%E8%88%87%E5%85%89%E6%98%8E%E5%88%86%E5%AD%90/","title":"é…çœ¼é¡æ¨è–¦ - éˆé­‚ä¹‹çª—èˆ‡å…‰æ˜åˆ†å­"},{"content":"STUN æ‡‰ç”¨æ–¼è™•ç† NAT ç©¿è¶ŠæŠ€è¡“ (å¦‚ ICE ) ä¸‹çš„ä¸€ç¨®å·¥å…·ï¼Œæœ¬èº«ä¸¦é NAT ç©¿è¶Šçš„è§£æ±ºæ–¹æ¡ˆï¼Œä¸»è¦åŠŸèƒ½ç‚ºç¢ºèªå…©å€‹åœ¨ NAT èƒŒå¾Œç¯€é»çš„ IP / Portï¼Œæœ¬ç¯‡ç‚º RFC 5389 çš„é–±è®€å¿ƒå¾—ï¼Œåˆ†äº« STUN èƒŒå¾Œçš„è¨­è¨ˆåŸç†èˆ‡çµæ§‹\nSTUN ä¹‹ä¸Šé‚„æœ‰æ“´å¢ä¸€å€‹ TURN å”å®šï¼Œæä¾› relay é€£ç·šçš„åŠŸèƒ½ï¼Œä¸€èˆ¬çš„ TURN Server æœƒåŒæ™‚æä¾› STUN çš„æœå‹™ï¼Œå¦‚æœæƒ³çŸ¥é“ TRUN Server æ¶è¨­ï¼Œå¯ä»¥åƒè€ƒå¦ä¸€ç¯‡æ–‡ç«  AWS Coturn serveræ¶è¨­æ•™å­¸\nå¦‚æœä½ æœ‰ä»¥ä¸‹ç–‘æƒ‘ï¼Œé‚£é€™ç¯‡æ–‡ç« æ‡‰è©²å¯ä»¥å¹«åŠ©åˆ°ä½ \nSTUN Server ç©¶ç«Ÿæ˜¯å¦‚ä½•é‹ä½œ STUN Server æ˜¯å¦æœ‰é©—è­‰æ©Ÿåˆ¶ æƒ³çŸ¥é“ Coturn config ä¸­çš„åƒæ•¸å«ç¾©ï¼Œå¦‚ Fingerprint / Realm / Nonce èˆ‡èˆŠç‰ˆ STUN çš„å·®ç•° å…ˆå‰æœ‰ä¸€ç‰ˆ STUN çš„å®šç¾© RFC-3489ï¼Œç•¶æ™‚çš„ STUN è¢«å®šç¾©æˆå®Œæ•´çš„ NAT ç©¿è¶Šè§£æ±ºæ–¹æ¡ˆï¼Œä½†æ˜¯é­é‡äº†ä»¥ä¸‹å•é¡Œæ‰æ”¹ç”¨é€™ä¸€ç‰ˆ 5389 å–ä»£äº†èˆŠç‰ˆ\nç„¡æ³•æ­£ç¢ºå€åˆ† NAT é¡å‹ï¼Œå°è‡´å¯èƒ½é€£ç·šæœ‰å•é¡Œ\nNAT å…±æœ‰å››ç¨®é¡å‹ï¼Œå…¶ä¸­ symmetric NATs æ˜¯æ¯æ¬¡é€šè¨Šæ²’æœ‰å›ºå®šçš„ Public IP / Portï¼Œæ‰€ä»¥åªèƒ½é€é TURN ä¾†è§£æ±ºé›™ç¯€é»çš„é€£ç·šå•é¡Œ\nä½†æ˜¯èˆŠç‰ˆ STUN æ¼”ç®—æ³•è¨­è¨ˆç„¡æ³•å€åˆ† NAT é¡å‹ï¼Œæ‰€ä»¥æœ‰å¯èƒ½é€ æˆéƒ¨åˆ†çš„é€£ç·šç•°å¸¸ æ”¯æ´ TCP / DTLS:\nèˆŠç‰ˆåªæ”¯æ´ UDP Security è€ƒé‡ æ–°ç‰ˆ STUN ä¸å†æ˜¯å®Œæ•´çš„ NAT traversal è§£æ±ºæ–¹æ¡ˆï¼Œåªå°ˆæ³¨æ–¼æ‰¾å‡ºç¯€é»å¤–å±¤ NAT å°å¤–çš„ Public IP/Portï¼Œå®Œæ•´çš„è§£æ±ºæ–¹æ¡ˆå¦‚ ICE / SIP Outbound ç­‰ç­‰\nä¹Ÿå› æ­¤ STUN SERVER é è¨­ port æ˜¯ 3489 / TLS port æ˜¯ 5398\næ¶æ§‹ä»‹ç´¹ å¯ä»¥çœ‹åˆ° STUN Client èº²åœ¨å…©å±¤ NAT ä¹‹å¾Œï¼Œè€Œ STUN Server å°±æ˜¯è¦é€šçŸ¥ STUN Client æœ€å¤–å±¤ NAT æ‰€å°æ‡‰çš„ Public IP / Port\nSTUN æ¡ç”¨ client/server æ¶æ§‹ï¼Œæ”¯æ´å…©ç¨®æºé€šæ–¹å¼(transaction)\nrequest / response indicate (é€å‡ºå»ä¸ç­‰å›è¦†) æ¯å€‹ transaction éƒ½æœ‰ 96bit random id\nå‚³é€æ©Ÿåˆ¶ æ¯å€‹ Transaction æœƒå®šç¾©é¡å‹ (Action)ï¼Œç›®å‰ Spec åƒ…å®šç¾© Binding action\né‹ä½œæ©Ÿåˆ¶å¦‚ä¸‹\nclient é€å‡º request NAT æœƒä¿®æ”¹ client package å°åŒ…çš„ IPï¼Œä¸¦è‡ªä¸»ç®¡ç† client private ip port èˆ‡ NAT å°æ‡‰å‡ºå»çš„ ip / port ä¸€è·¯åˆ° server æ‰‹ä¸Šåªæœƒæ‹¿åˆ° NAT çš„ public ip / portï¼Œç¨±ä¹‹ç‚º server reflexive transport address (srflx)ï¼Œå¦‚æœæœ‰ç”¨é WebRTC æ‡‰è©²æœ‰çœ‹é srflx ï¼Œé€™å°±æ˜¯ä»£è¡¨ç”¨æˆ¶èµ° STUN æ¥è‘— server æŠŠé€™å€‹ public ip / port ç•¶ä½œå…§å®¹ XOR-MAPPED-ADDRESS å‚³å›å»çµ¦ client NAT æ¥è‘—æœƒä¸€è·¯æ”¹ ip portï¼Œä½†å› ç‚ºå…§æ–‡ä¸æ”¹æ‰€ä»¥ client æœƒçŸ¥é“æœ€å¤–å±¤ NAT çš„ public ip + port Packet Format 1 2 3 4 5 6 7 8 9 10 11 0 1 2 3 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |0 0| STUN Message Type | Message Length | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Magic Cookie | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | | | Transaction ID (96 bits) | | | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ å°åŒ…æ ¼å¼ä»‹ç´¹\næœ€å‰æ–¹å…©å€‹ bit å›ºå®šç‚º 0 ï¼Œä¸»è¦æ˜¯ç”¨ä¾†å€åˆ†æ˜¯ä¸æ˜¯ STUN çš„ packet Message Type åŒ…å« Transaction é¡å‹ / response æˆåŠŸæˆ–å¤±æ•— magic cookie å›ºå®šç‚º 0x2112A442 Transaction ID ç”¨ä¾†å€åˆ† STUN transaction STUN message ä¸å¯ä»¥è¶…é MTO å¦‚æœå‚³è¼¸é€é UDP:\nClient è¦è‡ªå·±è™•ç† retransmitï¼Œé è¨­ timeout 500ms ~ 3000 ms é–“ï¼Œä¹‹å¾Œæ¯æ¬¡ retry Timeout double å¦‚æœå‚³è¼¸é€é TCP:\nä¸è¦å¢åŠ è€Œå¤–çš„ framing / demultiplexing å·²ç¶“ä¿éšœè³‡æ–™å¯é æ€§ï¼Œé è¨­ Timeout ç‚º 39.5s Server æ‡‰è©²ç­‰ Client ä¸»å‹•æ–·ç·šï¼Œé™¤éé‡åˆ° timeout é©—è­‰è¨Šæ¯ Server æ”¶åˆ°è¨Šæ¯å¾Œï¼Œæœƒå…ˆåšåŸºæœ¬çš„é©—è­‰ï¼Œå¦‚æœæœ‰é–‹å•Ÿ fingerprint extension å‰‡é©—è­‰ï¼Œå¦‚æœç™¼ç¾æœ‰ä¸æ”¯æ´çš„å±¬æ€§å‰‡å›å‚³éŒ¯èª¤ï¼› Server å›å‚³éŒ¯èª¤æ™‚ï¼Œå¿…é ˆæŒ‡å®š error codeï¼Œä¸¦æŒ¾å¸¶ error code attributeï¼Œä¾‹å¦‚èªªæœ‰ä¸æ”¯æ´çš„å±¬æ€§å‰‡å›å‚³ 420 + UNKNOWN-ATTRIBUTESï¼Œå¦‚æœæ˜¯ 401 é©—è­‰å¤±æ•—å‰‡å¿…é ˆå°æ‡‰å›å‚³é©—è­‰æ–¹å¼ï¼Œé€™é‚Šçš„ error code åƒè€ƒ HTTP æ‰€ä»¥æœƒæœ‰ç¨®ä¼¼æ›¾ç›¸ä¼¼çš„åˆ†é¡ï¼›\nå¦‚æœè¨Šæ¯æˆåŠŸå‰‡å¤¾å¸¶ XOR-MAPPED-ADDRESS å›å‚³\nFINGERPRINT å†Multiplexing ä¸‹ï¼Œæœƒæœ‰å¤šå€‹ä¸åŒ protocol çš„ packet å‚³é€åˆ°ç›¸åŒä½å€çš„ï¼Œä¾‹å¦‚èªª RTPï¼ŒåŠ ä¸Š fingerprint å¯ä»¥æ–¹ä¾¿ STUN Server å€åˆ† STUN message\nDNS é€é SRV ç´€éŒ„å›å‚³ STUN Server ç›¸é—œçš„æœå‹™ï¼ŒSRV æ ¼å¼å¦‚ä¸‹\n1 _service._proto.name. TTL class SRV priority weight port target. å¦‚æœæ˜¯ä»¥ STUN Server é–‹æ”¾ TCP / UDP ï¼Œå‡è¨­ STUN Server domain name æ˜¯ stun.example.comçš„è©±\n1 2 _stun._udp.example.com 86400 IN SRV 0 5 3489 stun.example.com. _stun._tcp.example.com 86400 IN SRV 0 5 3489 stun.example.com. ä½¿ç”¨ SRV å¥½è™•æ˜¯å¯ä»¥æ”¹è®Šé è¨­çš„ Portï¼›\nå¦‚æœä¸ç”¨ SRVï¼Œä¹Ÿå¯ä»¥ç”¨ A / AAAA ç´€éŒ„è¿”å› IP Listï¼Œä½† Port å°±åªèƒ½ç”¨é è¨­çš„\nèº«ä»½é©—è­‰èˆ‡è¨Šæ¯å®Œæ•´æ€§æª¢æŸ¥ å…±æœ‰å…©ç¨®èº«ä»½é©—è­‰çš„æ–¹å¼ï¼Œ\nçŸ­æœŸ Client / Server æœƒé å…ˆå…±äº«åŒä¸€å€‹ secretï¼Œå¾ŒçºŒ Client ç”¢ç”Ÿä¸€å€‹æœ‰æ™‚é–“é™åˆ¶çš„ credential (password)ï¼ŒServer æ”¶åˆ°å¾Œæœƒç”¨ç›¸åŒçš„ secret åšé©—è­‰ï¼›\nç¢ºä¿è¨Šæ¯å®Œæ•´æ€§å‰‡é€é MESSAGE-INTEGRITY æ¬„ä½ï¼Œæ­¤æ¬„ä½ç”¢ç”Ÿçš„æ–¹å¼æ˜¯æŠŠ STUN Message åš HMAC_SHA1ï¼›\nServer æ”¶åˆ°STUN Message å¾Œçš„é©—è­‰æµç¨‹å¦‚ä¸‹\næ²’æœ‰ MESSAGE-INTEGRITY å’Œ USERNAME æ¬„ä½å‰‡å›å‚³ 401 æª¢æŸ¥ USERNAME æ˜¯å¦åˆæ³• ç”¨ passwrod èˆ‡ username è¨ˆç®—å‡º message intergrity çš„å€¼ä¸¦æ¯”å° éƒ½é€šéå‰‡ç”¢ç”Ÿ responseï¼Œresponse åŒæ¨£è¦åŒ…å« MESSAGE-INTEGRITY Client æ”¶åˆ° response ä¹Ÿéœ€è¦æª¢æŸ¥ MESSAGE-INTEGRITY\nå› ç‚º credential æœ‰æ™‚é–“é™åˆ¶ï¼Œæ‰€ä»¥ä¸æœƒé‡åˆ°å›æ”¾(replay)æ”»æ“Š\né•·æœŸ Server / Client å›ºå®šé•·æœŸä½¿ç”¨ç›¸åŒçš„ username / password\næ­¥é©Ÿ\nClient ä¸å¸¶ä»»ä½• credential ç™¼èµ· Server rejectï¼Œä¸¦åˆ†é… realm (æŒ‡å¼• client é¸æ“‡ credential) èˆ‡ nonce (é¡ä¼¼æ–¼ cookieï¼ŒæŒ‡å®š duration / client identity ç­‰) å¤šä¸€å±¤ä¿è­· Client retry ï¼Œæˆ´ä¸Š credential èˆ‡ nonce + message-integrity (å°æ•´å€‹ request åš HMAC) Server æª¢æŸ¥ auth èˆ‡ integrity Server æ”¶åˆ°è¨Šæ¯æ™‚æœƒä¾åºæª¢æŸ¥\nMESSAGE-INTEGRITY: æ²’æœ‰å›å‚³ 401 å¦‚æœæ²’æœ‰ username / password / realm / nonce ï¼Œå›å‚³ 400 Nonce éæœŸäº†ï¼Œ438 Username ç„¡æ•ˆï¼Œ401 Message-integrity éŒ¯èª¤ï¼Œå›å‚³ 401 ALTERNATE-SERVER Mechanism å¦‚æœ Server å¸Œæœ› Redirect Client å»åˆ¥çš„ Serverï¼Œå¯ä»¥å›å‚³ error code 300 ä¸¦æŒ‡å®š ALTERNATE-SERVER Client æ”¶åˆ°å¾Œï¼Œç”¨ç›¸åŒçš„ transport protocol / credential å°æ–°çš„ Server é‡å•Ÿ transaction ä¹‹æ‰€ä»¥é–‹é ­è¦ç”¢ç”Ÿä¸€æ¬¡ auth failed çš„ requestæ˜¯è¦äº†å»è·Ÿ Server æ‹¿ Nonceï¼Œä¸»è¦æ˜¯ç‚ºäº†é¿å…å›æ”¾æ”»æ“Šï¼›\nå›æ”¾æ”»æ“Šä¸»è¦æ˜¯ å¦‚æœæœ‰ä¸­é–“äººï¼Œä»–æ‹¿åˆ° Client request è¨˜éŒ„ä¸‹ä¾†ï¼ŒæŠŠåŒæ¨£çš„ request å¾€ Server é€ï¼Œå› ç‚º credential æ˜¯é•·æœŸæœ‰æ•ˆæ‰€ä»¥ä¸­é–“äººä¹Ÿèƒ½å¤ é€šéé©—è­‰ï¼Œå³ä½¿æ˜¯æœ‰ TLS ä¿è­· / ä¸­é–“äººä¸çŸ¥é“ username, password å›æ”¾æ”»æ“Šéƒ½æœ‰ç”¨ï¼›\næ‰€ä»¥æ‰éœ€è¦ Nonce ä¸€å€‹ç”± Server æ ¸ç™¼ä¸€æ¬¡æ€§çš„ Tokenï¼ŒåŒ…è£åœ¨ STUN Message ä¸­ï¼Œè¶…å‡ºæ™‚é–“å°±æœƒè¢«èªå®šç„¡æ•ˆï¼Œå¾è€Œé¿å…å›æ”¾æ”»æ“Š\nSTUN Attributes å† STUN Header ä¹‹å¾Œï¼Œå¯ä»¥æ¥é›¶è‡³å¤šå€‹ attributeï¼Œattribute æ¡ç”¨ TLV encode\n1 2 3 4 5 6 7 0 1 2 3 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Type | Length | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Value (variable) .... +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ å¦‚æœ response ä¸­æœ‰é‡è¤‡çš„ attributeï¼Œåªæœ‰ ç¬¬ä¸€å€‹ æœƒè¢«è€ƒæ…®ï¼Œå…¶é¤˜æœƒè¢«æ¨æ£„ Type å† 0x0000 and 0x7FFF æ˜¯å¿…é ˆè¦è¢«è™•ç†çš„ï¼Œå¦‚æœ STUN agent ç„¡æ³•è™•ç†å‰‡æœƒå¤±æ•— 0x8000~0xFFFF å‰‡æ˜¯ optional ä»¥ä¸‹èˆ‰å¹¾å€‹å¸¸è¦‹çš„ attribute\nMAPPED-ADDRESS ä¸»è¦æ˜¯ç‚ºäº†å…¼å®¹èˆŠç‰ˆ STUNï¼Œé¡¯ç¤º Client æœ€å¾Œä¸€å€‹ Public NAT çš„ ip / port\nXOR-MAPPED-ADDRESS é›·åŒæ–¼ä¸Šè€…ï¼Œä½†æ˜¯ ip / port éƒ½æ˜¯è·Ÿ magic-cookie å‰ 16 bits åš XOR å„²å­˜ (ipv4 / ipv6 xor æ–¹å¼ä¸åŒ)ï¼ŒåŸå› æ˜¯ç™¼ç¾æœ‰äº› NAT å¦‚æœçœ‹åˆ° payload æ˜¯è‡ªå·±çš„ public IP æœƒå»ä¿®æ”¹ï¼Œxor ä¹‹å¾Œå°±æ²’é€™å€‹å•é¡Œ\nåŸæ–‡è§£é‡‹ deployment experience found that some NATs rewrite the 32-bit binary payloads containing the NAT\u0026rsquo;s public IP address, such as STUN\u0026rsquo;s MAPPED-ADDRESS attribute, in the well-meaning but misguided attempt at providing a generic ALG function.\nUSERNAME ç”¨ä¾†é©—è­‰ç”¨çš„ï¼Œå¿…é ˆæ˜¯ç”¨ utf-8 encode ä¸¦å°æ–¼ 513 bets SASLprep\nMESSAGE-INTEGRITY å° STUN Message å– HMAC-SHA1ï¼Œå›ºå®šé•·åº¦ç‚º 20 bytes (å› ç‚º sha1 ) HMAC key æœƒå› ç‚º credential ä¸åŒè€Œæœ‰æ‰€ä¸åŒ\nLong term: key = MD5(username â€œ:â€ realm â€œ:â€ SASLprep(password)) Short term: key = SASLprep(password) éœ€æ³¨æ„ hash åŒ…å«æ•´å€‹ STUN Messageï¼ŒåŒæ™‚ä¹ŸåŒ…å«äº† Message lengthï¼Œæ‰€ä»¥åœ¨ç”¢ç”Ÿ hash å‰ï¼ŒMESSAGE-INTEGRITY ä¹Ÿå¿…é ˆå…ˆå®‰æ’é€²å» STUM Message ä¸­ä¸¦å¸¶ dummy contentï¼Œå…¶ä»–åœ¨ä¹‹å¾Œçš„å±¬æ€§å‰‡è¢«æ’é™¤åœ¨å¤– é©—è­‰æ™‚ä¹Ÿå¿…é ˆéµå®ˆç›¸åŒçš„æµç¨‹\nFingerprint å°æ•´å€‹ STUN Message (æ’é™¤è‡ªå·±) å– CRC-32ï¼Œæ¥è‘—èˆ‡ 0x5354554e åš XOR ( é¿å…å…¶ä»– packet ä¹Ÿç”¨ CRC-32 Fingerprint å¿…é ˆæ˜¯æœ€å¾Œä¸€å€‹å±¬æ€§\n1 the FINGERPRINT attribute MUST be the last attribute in the message, and thus will appear after MESSAGE-INTEGRITY. Error Code åŒ…å«æ•¸å€¼çš„ error code å¾ 300~699ï¼Œä¿æŒèˆ‡ SIP / HTTP ç›¸ä¼¼çš„ç¾½ç¿¼ å†åŠ ä¸Š rease: utf-8çš„æ–‡å­—æè¿° ï¼Œä¸»è¦æ˜¯è®“ç”¨æˆ¶å¯ä»¥ç†è§£\nREALM å¦‚æœ STUN Server åŒæ™‚æ”¯æ´å¤šå€‹ domainï¼Œé€é REALM å¯ä»¥å€åˆ†ä¸åŒ domain ä½¿ç”¨çš„è¨­å®š\nNONCE ç”¨æ–¼æ¯æ¬¡é€£ç·šé¿å… replay å•é¡Œçš„æ–¹å¼ï¼Œé¡ä¼¼æ–¼ web çš„ cookie\nUNKNOWN-ATTRIBUTES å† error code 420 æ™‚å‡ºç¾\nSOFTWARE æè¿°è»Ÿé«”çš„ç‰ˆæœ¬ / è£½é€ å•†ç­‰è³‡è¨Š\nALTERNATE-SERVER Server è¦æ±‚è½‰æ›æ™‚\nSecurity ä»¥ä¸‹æ¢åˆ—å¹¾ç¨®è¢«æ”»æ“Šçš„å¯èƒ½èˆ‡é˜²ç¯„æªæ–½\nAttacker å¯èƒ½ç«„æ”¹ STUN è¨Šæ¯:\nä½†å¯ä»¥ç”¨ message integrity é©—è­‰é˜²æ­¢ Attacker å¯ä»¥å±…ä¸­å›å‚³ error response\nåœ¨æŸäº›å¦‚é©—è­‰å¤±æ•—çš„è¨Šæ¯ï¼Œé€™å€‹å°±ä¸å¥½é˜²å µï¼Œé™¤éä½¿ç”¨ TLS æ‰èƒ½æœçµ•å•é¡Œ HMACå¯èƒ½é­å—å­—å…¸æ”»æ“Š:\nå› ç‚º STUN åˆ©ç”¨ HMACï¼Œå¯èƒ½é­å—å­—å…¸æ”»æ“Šï¼Œè«‹ç¢ºä¿ password è¶³å¤ è¤‡é›œï¼Œæˆ–æ˜¯ç”¨ TLS é˜²æ­¢å•é¡Œï¼›ä¸æ’é™¤ SHA1 ä¹‹å¾Œè¢«æ”»ç ´ï¼Œæœªä¾†å¯èƒ½å¢åŠ æ–°çš„æ¬„ä½èˆ‡æ–°çš„ hash æ©Ÿåˆ¶ DoS éƒ¨åˆ†: STUN server æ˜¯ statelessï¼Œæ‰€ä»¥æ¯”è¼ƒä¸æœƒè¢« DoS æ‰“å®ï¼›\nAttacker å¯èƒ½å‡å†’ source IPï¼Œè®“ STUN server å»æ”»æ“Šå—å®³è€…ï¼Œæ”»æ“Šä¸æœƒè¢«è·¨å¤§ï¼Œè¦å¾ ingress å»éæ¿¾ ipï¼› SOFTWARE æ­éœ²ç‰ˆæœ¬è³‡è¨Šï¼Œå¯èƒ½è®Šæˆæ½›è—çš„è½é»\nSTUN Server æ‡‰è©²è¦æœ‰å°æ‡‰çš„è¨­å®šå»é—œé–‰æ­¤é¸é … ä¿®æ”¹ source ip\nAttack å±…ä¸­çš„è©±ï¼Œå¯ä»¥æ””æˆªclient çš„ source ip ä¸¦ä¿®æ”¹ï¼Œserver æ”¶åˆ°éŒ¯çš„ ip å°±æœƒç”¨ XOR-MAPPED-ADDRESS å›å‚³å›ï¼Œé€™å¹¾ä¹ä¸å¯èƒ½é˜»æ“‹ï¼Œå› ç‚ºæ­£å¸¸çš„ NAT ä¹Ÿæœƒå»ä¿®æ”¹ source ipï¼›\nåªèƒ½åœ¨æ›´ä¸Šå±¤çš„å”è­°ï¼Œä¾‹å¦‚ ICE å»é©—è­‰ address çš„æ­£ç¢ºæ€§ ","date":"2020-09-22T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-09-22-rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/","title":"RFC 5389 - STUN å”å®šä»‹ç´¹"},{"content":"å…¬å¸ P2P é€šä¿¡æ¡ç”¨ WebRTC tech stackï¼Œè¿‘æ—¥å¸Œæœ›è‡ªå»º STUN/TURN Serverï¼Œæ±ºå®šæ¡ç”¨ Coturn é€™å¥—çŸ¥åçš„è§£æ±ºæ–¹æ¡ˆï¼Œåœ¨ AWS æ¶è¨­éç¨‹é‡åˆ°ä¸€äº›å‘ï¼Œæ±ºå®šåˆ†äº«å¦‚ä½•æ¶è¨­ï¼Œä¸¦åˆ†äº«è¨­å®šæª”å¦‚ä½•è¨­å®šèˆ‡æ“ä½œ\nä»¥ä¸‹åŒ…å«\nCoturn æ–¼ AWS ä¸Šçš„æ¶è¨­èˆ‡æ¸¬è©¦ ä»‹ç´¹è¨­å®šæª”å…§å®¹ ä¸Š Production çš„è€ƒé‡ è£œå…… NAT èˆ‡ STUN/TURN é—œä¿‚ å¦‚æœæƒ³çŸ¥é“æ›´è©³ç´°çš„å”å®šä»‹ç´¹ï¼Œè«‹åƒè€ƒ\nRFC 5398 - STUN å¦‚æœæƒ³è¦ç”¨ Container æ¶è¨­ï¼Œå¯ä»¥åƒè€ƒæˆ‘ç”¨ docker-compose æ¶è¨­çš„æ–¹å¼ Running Coturn + Promethes + Grafana in Docker\nCoturn æ–¼ AWS ä¸Šçš„æ¶è¨­ ä½¿ç”¨ Ubuntu 18.04 éå¸¸ç°¡å–®ï¼Œåªè¦ä»¥ä¸‹æŒ‡ä»¤å°±èƒ½å•Ÿå‹• Coturn\n1 2 $ sudo apt-get -y update $ sudo apt-get -y install coturn å¼·çƒˆå»ºè­°ä½¿ç”¨ Ubuntu 18.04 è€Œä¸è¦ç”¨ Amazon Linux 2ï¼ŒAmazon Linux 2 è¦è‡ªå·±è™•ç†å„ç¨®å¥—ä»¶çš„ç›¸ä¾æ€§ï¼Œæ¶è¨­éç¨‹èŠ±äº†åŠå¤©é‚„æ²’æ¶èµ·ä¾†\nç”¨ apt-get install çš„è©±ï¼Œæœƒè¢«é™åˆ¶ç‰ˆæœ¬ï¼Œå¦‚æœæœ‰å…¶ä»–éœ€æ±‚ï¼Œä¾‹å¦‚æ”¯æ´é™¤äº† SQLite ä»¥å¤–çš„ DBï¼Œæˆ–æ˜¯è¦å®‰è£ Prometheusï¼Œå»ºè­°å¾ source code build èµ·ï¼Œå¯ä»¥åƒè€ƒå¦ä¸€ç¯‡æ–‡ç« \nå®‰è£å¾Œæœƒæœ‰å¹¾å€‹ command èƒ½å¤ ä½¿ç”¨\nturnserver\nå•Ÿå‹• STUN/TURN server instance turnadmin\nä»‹é¢ç®¡ç†å¾Œå°\nå…¶é¤˜éƒ½æ˜¯æ¸¬è©¦ç”¨å·¥å…· turnutils_peer\nUDP-only echo serverï¼Œæª¢æ¸¬é€£ç·šä½¿ç”¨ turnutils_stunclient\nå‘¼å« STUN server ä¸¦å–å¾—å›æ‡‰ turnutils_uclient\nå¯ä»¥æ¨¡æ“¬å¤šäººé€£ç·š TURN server ä¸¦å–å¾—å›æ‡‰ ä¸Šä¸€æ­¥å®‰è£å¾Œé è¨­æœƒè‡ªè¡Œå•Ÿå‹• Coturnï¼Œä½†ç‚ºäº†å¾ŒçºŒçš„å¯¦é©—ï¼Œå…ˆæŠŠ turn service é—œé–‰\n1 2 3 $ sudo service coturn status // å¦‚æœæœ‰åœ¨é‹è¡Œï¼Œå…ˆé—œé–‰ $ sudo service coturn stop æ¥è‘—å•Ÿå‹• turnserver\n1 $ sudo turnserver ç¨å¾®çœ‹ä¸€ä¸‹ command line è·³å‡ºçš„è¨Šæ¯ï¼Œå¤§è‡´èªªæ˜\nfile descriptor ä¸Šé™ï¼Œé€™æœƒå½±éŸ¿æœ€å¤§é€£ç·šæ•¸ï¼Œå¯ä»¥é€é $ sudo ulimit -n {number}å»èª¿æ•´ æ”¯æ´çš„é€šè¨Šå”å®šï¼Œé è¨­ STUN æ”¯æ´ UDP / TCP / DTLSï¼Œä½†å› ç‚ºç›®å‰æ²’æœ‰æŒ‡å®šæ†‘è­‰ï¼Œæ‰€ä»¥ DTLS ä¸æ”¯æ´ æ¡ç”¨çš„ Databaseï¼Œé è¨­ä½¿ç”¨ SQLiteï¼Œä¸»è¦ç”¨ä¾†å„²å­˜ admin è³‡è¨Š / turn é€£ç·šè³‡è¨Šç­‰ï¼ŒåŒæ™‚æ”¯æ´ MySQL / Redis / PostgreSQL / MongoDBï¼Œå¯ä»¥è‡ªç”±æ›¿æ›ï¼›\næ ¹æ“š Spec STUN/TURN Server è™•ç†é€£ç·šæ˜¯ State-lessï¼Œæ„å³ Database ä¸æ˜¯ç”¨ä¾†å„²å­˜é€£ç·šè³‡æ–™ï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒæœƒæ˜¯ bottleneck (å¦‚æœ Coturn éµå®ˆ Spec çš„è©±) çœ‹ä¸€ä¸‹æœ‰æ²’æœ‰ä»€éº¼éŒ¯èª¤ï¼Œcli-password éŒ¯èª¤å¯ä»¥å…ˆå¿½ç•¥\nå•Ÿå‹• turnserver è¦æ¸¬è©¦ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆè¨­å®š AWS security groupï¼Œé–‹æ”¾ä»¥ä¸‹çš„ port\n1 2 3 3478: UDP+TCP // TURN Server æ¥æ”¶ request çš„ port 5394: UDP+TCP // TURN Server æ¥æ”¶ TLS request çš„ port 49152-65536: UDP+TCP // å¯¦éš›é€£ç·šçš„ Socket Port range ä»¥ä¸Šä¸‰å€‹éƒ½èƒ½å¤ èª¿æ•´ï¼Œä½†å°±å…ˆæ¡ç”¨é è¨­\næ¥è‘—å•Ÿå‹• turnserver\n1 sudo turnserver -v --lt-cred-mech --user hello:world --realm \u0026lt;your domain name\u0026gt; --external-ip \u0026lt;your instance public-ip\u0026gt; ä»¥ä¸Šçš„åƒæ•¸ä»£è¡¨\n-v: é¡¯ç¤ºè©³ç´°çš„ log --lt-cred-mech: æŒ‡å®šç‚º long term credentialï¼Œç¨å¾Œè§£é‡‹ --user {username}:{password}: æ­é… long term credentialï¼ŒæŒ‡å®š username / password --realm: æŒ‡å®š TURN server å°æ‡‰çš„ domain nameï¼Œæç¤º client è¦æ¡ç”¨å°æ‡‰çš„é©—è­‰æ–¹å¼ --external-ip: æŒ‡å®š external ipï¼Œåœ¨ Coturn æ–‡ä»¶å¯«åˆ°ï¼Œå¦‚æœæ˜¯åœ¨ AWS EC2 ä¸Šæ¶è¨­ external-ip åªè¦æŒ‡å®š public ic è¨˜å¾—è¦å»å°‡ç¶å®š domain name A record æŒ‡å‘ AWS instance\næ¥è‘—ï¼Œæœ‰å¹¾ç¨®æ¸¬è©¦æ–¹æ³•\n1. ä½¿ç”¨ Coturn è‡ªå¸¶çš„ test tool 1 2 $ turnutils_uclient -T \u0026lt;server ip\u0026gt; $ turnutils_stunclient \u0026lt;server ip\u0026gt; ç¬¬ä¸€å€‹æœƒå˜—è©¦å‚³é€å°åŒ…ï¼Œå¯ä»¥çœ‹ packet çš„ loss rate æ˜¯å¦ç‚º 0 /\nç¬¬äºŒå€‹æœƒå›å‚³ä¸»æ©Ÿ public ip (å¦‚æœå‰é¢æ²’æœ‰ NAT çš„è©±)ï¼Œä¹Ÿå°±æ˜¯ STUN æœ€ä¸»è¦çš„åŠŸç”¨\n2. ç”¨ç€è¦½å™¨é–‹å•Ÿ WebRTC samples Trickle ICE è¼¸å…¥ server domain æ™‚è¨˜å¾—è¦åŠ  turn:{domain name}ï¼Œå°±å¯ä»¥æˆåŠŸæ‹¿åˆ° STUN (srflx) / TURN (relay) çš„ç´€éŒ„\næ¸¬è©¦äº†ä¸€ä¸‹ï¼ŒChrome / Firefox ä¸æ”¯æ´ no auth è¨­å®šï¼ŒChrome ä¸æ”¯æ´ ip based çš„ server\né€™æ¨£å°±å®Œæˆç¬¬ä¸€æ­¥çš„è¨­å®šèˆ‡æ¸¬è©¦ï¼Œæ¥è‘—çœ‹ Coturn çš„å®Œæ•´ä»‹ç´¹èˆ‡è¨­å®š\nè¨­å®šæª” è¨­å®šæª”çš„é è¨­è·¯å¾‘ç‚º /etc/turnserver.confï¼Œä¹Ÿå°±æ˜¯ç­‰ç­‰æœƒä¿®æ”¹çš„æ–‡ä»¶ï¼Œå¯ä»¥æ”¾åœ¨å…¶ä»–åœ°æ–¹ç”¨ cmd æŒ‡å®š\nä¹Ÿå¯ä»¥å¾ç¶²è·¯ä¸Šçœ‹åˆ°å®˜æ–¹çš„é è¨­è¨­å®šæª” # Coturn TURN SERVER configuration file\né©—è­‰ STUN çš„è²»ç”¨å¾ˆä¾¿å®œï¼Œåªæœ‰ç°¡å–®çš„ request / responseï¼Œä½†æ˜¯ TURN å°±éå¸¸è²´ï¼Œå› ç‚ºè¦å›æ”¾(Relay) P2P çš„ media streamï¼Œæ‰€ä»¥ Bandwidth ç›¸ç•¶é©šäººï¼Œé€™æ™‚å€™å°±éœ€è¦åŠ ä¸Šå¸³è™Ÿå¯†ç¢¼çš„æª¢æŸ¥\nTURN æ”¯æ´å…©ç¨®æ¨¡å¼ï¼Œå»ºè­°æ˜¯å…©è€…é¸å…¶ä¸­ä¸€è€…\nlong term credential é•·æœŸæ†‘è­‰å±¬æ–¼éœæ…‹é¡å‹ï¼Œä¹Ÿå°±æ˜¯ Client / Server å…±ç”¨å›ºå®šçš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¾‹å¦‚ä¸Šè¿°çš„ hello:world\nåœ¨è¨­å®šæª”ä¸­\n1 2 3 4 lt-cred-mech user=hello:world user=hello2:world2 .... short term credential å¦‚æœå¸Œæœ›ç™¼çµ¦ Client çŸ­æœŸçš„æ†‘è­‰ï¼Œæˆ–æ˜¯å¸Œæœ›å¤šä¸€å±¤æˆæ¬Šçš„æµç¨‹ä¾‹å¦‚å¾ API Server çµ¦äºˆç­‰ç­‰ï¼Œå¯ä»¥ä½¿ç”¨çŸ­æœŸæ†‘è­‰\nTURN å¯¦ä½œçš„æ–¹å¼æ˜¯ Client / Server å…±äº«ä¸€å€‹å›ºå®šçš„ secret keyï¼Œæ¥è‘—ä½¿ç”¨ HMAC_SHA1 å°‡ username hashedï¼Œusername çš„å‰åŠæ®µæ˜¯ unix timestamp\næ‰€ä»¥ TURN server æ”¶åˆ°å¾Œï¼Œå¾ username å¯ä»¥çœ‹å‡ºéæœŸæ™‚é–“ï¼Œé€é HMAC_SHA1 å¯ä»¥ç¢ºä¿æ˜¯ç”±åˆæ³•çš„ Client æ‰€é€å‡º\nè¨­å®šæª”å¯«æ³•\n1 2 use-auth-secret static-auth-secret={secret} Nodejs ç‰ˆæœ¬çš„ç”¢ç”Ÿè¦å‰‡å¦‚ä¸‹ï¼Œåƒè€ƒè‡ª CoTURN: How to use TURN REST API?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 var crypto = require(\u0026#39;crypto\u0026#39;); // name éš¨ä¾¿å¡«æ²’æœ‰é—œä¿‚ function getTURNCredentials(name, secret){ var unixTimeStamp = parseInt(Date.now()/1000) + 24*3600, // this credential would be valid for the next 24 hours username = [unixTimeStamp, name].join(\u0026#39;:\u0026#39;), password, hmac = crypto.createHmac(\u0026#39;sha1\u0026#39;, secret); hmac.setEncoding(\u0026#39;base64\u0026#39;); hmac.write(username); hmac.end(); password = hmac.read(); return { username: username, password: password }; } ç¶²è·¯è¨­å®š ç¶²è·¯è¨­å®šå°±æ”¾åœ¨ä¸€å¡Šçœ‹\n1 2 3 external-ip=\u0026lt;public ip\u0026gt; fingerprint realm=turn.yuanchieh.page ä»¥ä¸Šæ˜¯å¿…é ˆè¨­å®šçš„åƒæ•¸\nexternal-ip:\nTURN server çš„ public ipï¼Œçœ‹æ–‡ä»¶å®Œæ•´çš„è¨­å®šæ˜¯ external-ip=\u0026lt;public ip\u0026gt;/\u0026lt;private ip\u0026gt;ï¼Œä½†å› ç‚ºåœ¨ AWS ä¸Š EC2 è™•æ–¼ NAT ä¹‹å¾Œï¼Œæ‰€ä»¥åªèƒ½æ”¾ public ip fingerprint:\nä¸»è¦æ˜¯ TURN Server ç”¨ä¾†å€åˆ† packetï¼Œå¾ŒçºŒçš„ Spec æœƒæœ‰æ›´è©³ç´°ä»‹ç´¹ realm:\nè¨­å®šç‚ºè‡ªå·±æŒ‡å‘ TURN Server çš„ domain nameï¼Œæ–‡ä»¶è¡¨ç¤º TURN Server å¯ä»¥æŒ‡å®šå¤šå€‹ realmï¼Œæ¯å€‹ realm æœ‰å„è‡ªçš„ user æ¬Šé™ç®¡ç†ï¼ŒClient è¡¨æ˜æ‰€å±¬çš„ realm å°±èƒ½ç”¨å°æ‡‰çš„ user æª¢æŸ¥ å…¶é¤˜é‚„æœ‰éå¸¸å¤šçš„è¨­å®šï¼Œä¾‹å¦‚èªª\næ˜¯å¦è¦é–‹æ”¾ UDP / TCP / DTLS / stun-only è¨­å®šä¸åŒçš„ port / port ranage æŒ‡å®šçš„ DB / Log ç­‰ç­‰ æ¯æ¬¡é€£ç·š session çš„æ™‚é•· / æ¯å€‹ user çš„é€£ç·š quota ç­‰ç­‰ é€™äº›ç´°éƒ¨çš„è¨­å®šå¯ä»¥åœ¨æ…¢æ…¢çœ‹æˆ–æ˜¯ä¿ç•™é è¨­å³å¯ ä»¥ä¸‹æ˜¯æˆ‘æ¸¬è©¦éæˆåŠŸçš„è¨­å®šæª”\n1 2 3 4 5 6 external-ip=52.72.33.185 verbose fingerprint use-auth-secret static-auth-secret=north realm=turn.yuanchieh.page å•Ÿå‹• turnserver æ™‚é€é -c æŒ‡å®š turnserver.conf çš„ä½ç½®ï¼Œå®Œæˆå¾Œå»ºè­°åœ¨ä½¿ç”¨æ¸¬è©¦å·¥å…·æ¸¬è©¦é\nSample Code ç‚ºäº†æ›´æ–¹ä¾¿æ¸¬è©¦ TURN Serverï¼Œè‡ªå·±å¯«äº†ä¸€å€‹ Sample Code Connection through self-hosted TURN serverï¼Œæˆ–æ˜¯ç›´æ¥çœ‹ Demo Page https://webrtc-turn-server-test.vercel.app/ï¼Œè¼¸å…¥å°æ‡‰çš„å¸³è™Ÿå¯†ç¢¼ï¼Œæœƒä¸»å‹•ç”Ÿæˆå°æ‡‰çš„ iceServers\nGo To Production æº–å‚™ä¸Šæ­£å¼ç’°å¢ƒæ™‚ï¼Œé‚„æœ‰ç›£æ§ä»¥åŠå¯ç”¨æ€§çš„èª¿æ•´\nç›£æ§ 2020/12/04æ›´æ–°ï¼šç›®å‰ 4.5.2 å¯ä»¥æ”¯æ´ prometheus å›‰ï¼Œå¯æ˜¯åªæœ‰æ”¯æ´ Debianï¼Œå…¶ä»–å¹³å°å°šæœªæ”¯æ´ï¼Œå¦å¤–è¦æ³¨æ„ç›´æ¥ç”¨ apt-get install coturn ç‰ˆæœ¬ç›®å‰æ˜¯ä¸æ”¯æ´ prometheusï¼Œéœ€è¦è‡ªå·±æ‰‹å‹•ç·¨è­¯å–”\n1 2 3 4 Version 4.5.2 \u0026#39;dan Eider\u0026#39;: - fix null pointer dereference in case of out of memory. (thanks to Thomas Moeller for the report) - merge PR #517 (by wolmi) * add prometheus metrics Warning: æ’°æ–‡æ™‚é–‹å•Ÿ prometheus æœƒæœ‰è¨˜æ†¶é«”å•é¡Œï¼Œå»ºè­°å…ˆä¸è¦ä½¿ç”¨å–”ï¼Œè©³è¦‹ github issue https://github.com/coturn/coturn/issues/666\nçœ‹åˆ°æ–‡ä»¶çš„ç¯„ä¾‹ä»¥åŠè¨­å®šæª”æ”¯æ´ prometheus é€™å¥—é–‹æºçš„ç›£æ§å·¥å…·ï¼Œä½†å¯æƒœå¯¦æ¸¬ä¸‹ä¾†æš«æ™‚ç„¡æ³•ä½¿ç”¨(4.5.1.2)ï¼Œé›–ç„¶èªªæœ‰ç›¸é—œçš„ branch å·²ç¶“ merged ä½†æ˜¯ Issue é‚„æ˜¯é–‹è‘— support export metrics to prometheus #474\nå¯ç”¨æ€§ å¦‚æœåªæœ‰å–®å° TURN server æ›æ‰å°è‡´æœå‹™ä¸­æ–·å°±å¾ˆæ…˜äº†ï¼Œå®˜æ–¹æœ‰å¹¾å€‹å¯ç”¨æ€§/Load Balance ä½œæ³•\nTCP Level LB Proxy:\néœ€æ³¨æ„å¦‚æœæœ‰ä½¿ç”¨ TURN åŠŸèƒ½ï¼Œå¿…é ˆç¢ºä¿åŒä¸€å€‹ Client æŒçºŒé€£åˆ°åŒä¸€å° TURN Serverï¼Œå¦å‰‡æ™®é€šçš„ TCP LB å³å¯ DNS:\né€é DNS Round-Robin ç´€éŒ„ï¼Œè®“ Client é€£åˆ°å°æ‡‰çš„ TURN Server å…§å»ºçš„ ALTERNATE-SERVER:\néœ€è¦åœ¨æ‰€æœ‰çš„ TURN Server ä¹‹å‰å»ºä¸€å° LBï¼Œé€™å° LB æŒ‰ç…§æµé‡å›çµ¦ Client ALTERNATE-SERVER çš„éŒ¯èª¤ï¼ŒClient å°±æœƒæŒ‰ç…§æŒ‡å®šçš„ Server å»èµ°ï¼Œé”åˆ° LB çš„æ•ˆæœ çœ‹ä¾†çœ‹å»ï¼Œæ¡ç”¨ DNS æ¯”è¼ƒæ–¹ä¾¿ï¼ŒAWS Route53 æ”¯æ´å®šæœŸæª¢æŸ¥ Server ç‹€æ…‹ï¼Œåªæœƒå›å‚³å¥åº·çš„ Serverï¼ŒåŒæ™‚èƒ½æ¡ç”¨ Latency based æˆ–æ˜¯ Region based çš„ DNS ç´€éŒ„ï¼Œè®“å…¨çƒéƒ¨ç½²æ›´åŠ æ–¹ä¾¿\nNAT ä»‹ç´¹èˆ‡ STUN/TURN ä½¿ç”¨ å…ˆå‰æœ‰æåˆ°å› ç‚º NAT é—œä¿‚ï¼Œæ‰€ä»¥è¦å»ºç«‹ P2P é€£ç·šæœƒéœ€è¦ STUN Server çš„å¹«åŠ©ï¼Œä½†æœ‰ä¸€ç¨® NAT æ˜¯å¿…é ˆé€é TURN Serverï¼Œä»¥ä¸‹è§£é‡‹é€™éƒ¨åˆ†çš„ç‹€æ³\nWiki NAT ç¶²è·¯ä½å€è½‰æ›\nNATçš„å››ç§ç±»å‹\nç°¡å–®æ•´ç†ä¸Šé¢æ–‡ä¸­çš„é‡é»\n1 ClientA (192.168.9.1:3000) ---\u0026gt; NAT (8.8.8.8:800) ---\u0026gt; Server1 (1.1.1.1:1000) ClientA é å…ˆèˆ‡ Server1 å–å¾—é€£ç·šï¼Œæ­¤æ™‚å‡è¨­ Server2 (2.2.2.2) æƒ³è¦å¾ (8.8.8.8:800) é€è³‡æ–™çµ¦ ClientB\nå®Œå…¨åœ“éŒå‹NAT å…è¨± å—é™åœ“éŒå‹NAT å¿…é ˆ ClientA ä¹Ÿé€éè«‹æ±‚çµ¦ Server2 (2.2.2.2)æ‰å¯ä»¥ åŸ å—é™åœ“éŒå‹NAT å¿…é ˆ ClientA ä¹Ÿé€éè«‹æ±‚çµ¦ Server2 (2.2.2.2:1000)æ‰å¯ä»¥ï¼Œç›¸è¼ƒæ–¼ä¸Šè€… Port å¿…é ˆå›ºå®š å°ç¨±NAT\nä¸å…è¨± æ‰€ä»¥åœ¨ WebRTC ä¸‹ï¼Œå¦‚æœ Client åœ¨å®Œå…¨åœ“éŒå‹NATï¼Œä»»ä¸€æ–¹ç™¼è«‹é€£ç·šéƒ½å¯ä»¥ï¼›\nå¦‚æœæ˜¯åœ¨äºŒã€ä¸‰ç¨®ï¼Œå‰‡ Client å¿…é ˆé›™æ–¹åŒæ™‚ç™¼é€è«‹æ±‚ï¼Œæ‰ç¬¦åˆ NAT è½‰ç™¼æ¢ä»¶ï¼›\nç¬¬å››ç¨®å‰‡ä¸å…è¨±ç›´æ¥çš„ P2P\n","date":"2020-09-21T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/","title":"Coturn Server æ¶è¨­æ•™å­¸ - on AWS"},{"content":"\næ¯å®¶çŸ¥åçš„å·¨é ­ï¼Œéƒ½æœ‰åŒ…è£å¾Œæ¼‚äº®çš„ã€Œå…¬é—œã€å‰µæ¥­æ•…äº‹ï¼Œåƒæ˜¯ Netflix å°±æ˜¯å‰µè¾¦äºº Reed Hastings å»ç™¾è¦–é”ç§Ÿç‰‡å› ç‚ºæ™šé‚„è¢«ç½°éŒ¢ï¼Œæ†¤è€Œå‰µè¾¦çš„æ•…äº‹\né€™å€‹æ•…äº‹çš„åŒ…è£æ˜¯å› ç‚ºç•¶æ™‚ Netflix è¢«ç™¾è¦–é”æ‹’çµ•æ”¶è³¼å¾Œï¼Œç‚ºäº†ç°¡æ½”ã€æœ‰å¸å¼•åŠ›é †ä¾¿æ¨éŠ·è‡ªå®¶ç”¢å“ç‰¹è‰² (æ²’æœ‰é²é‚„ç½°æ¬¾) æ‰€ç·¨é€ çš„ï¼Œé€™ç¢ºå¯¦æ˜¯å€‹å¾ˆæ£’çš„è…³æœ¬ï¼Œä½†çœŸå¯¦çš„å‰µæ¥­æ•…äº‹é æ¯”é€™ä¸€å°æ®µç²¾å½©çš„å¾ˆå¤š\né€™æœ¬æ›¸æœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼ï¼Œä½œè€… Marc Randolph é‰…ç´°å½Œéºåœ°å¾é»å­ç™¼æƒ³åˆ°å‰µè¾¦å‰ç·Šé‘¼å¯†é¼“çš„ç±ŒåŠƒï¼Œå…¬å¸ç¶“æ­·å¤šæ¬¡ Pivot çµ‚æ–¼æ‘¸ç´¢å‡ºè‡ªå·±çš„ä¸€å¥—å•†æ¥­æ¨¡å¼ï¼Œæè¿°çš„æ–¹å¼é€£ç•¶å¤©åƒä»€éº¼ / è·Ÿå®¶äººçš„äº’å‹• / èˆ‡å…¬å¸æˆå“¡çš„å°è©±ç­‰éƒ½æ’°å¯«ä¸‹ä¾†ï¼Œè®“äººèº«æ­·å…¶ç¶“è·Ÿè‘— Neflix ä¸€èµ·èµ°éé‚£ä¸€æ®µæ­²æœˆçš„æ„Ÿè¦ºï¼Œä½†åˆä¸æœƒæ’ˆå¨åˆ°å¦‚æ—¥è¨˜èˆ¬çš„ç‘£ç¢\nä»¥ä¸‹é‡é»æ•´ç†å¹¾é»å€‹äººè¦ºå¾—å¾ˆç²¾å½©çš„éƒ¨åˆ†\nä¸€åƒé›¶ä¸€å€‹é»å­ Marc å› ç‚ºå…¬å¸è¢«æ”¶è³¼è€Œèˆ‡ Reed æ‰€å…±äº‹ï¼Œå› ç‚ºå…¬å¸è¦è·‘è¡Œæ”¿æµç¨‹ï¼Œå…©äººæ¥ä¸‹ä¾†æ•¸å€‹æœˆéƒ½ç„¡æ‰€äº‹äº‹ï¼Œåœ¨æ¯å¤©é€šå‹¤è·¯ä¸Šï¼ŒMarc æœƒä¸æ–·åœ°ä¸Ÿå‡ºæ–°é»å­èˆ‡ Reed è¨è«–ï¼Œã€Œå®¢è£½åŒ–æ£’çƒæ£ã€/ ã€Œéƒµå¯„æ´—é«®ç²¾ã€ï¼ŒMarc æ“…é•· Marketing / æŒ–æ˜æ–°é»å­ï¼Œè€Œ Reed å‰‡æ˜¯æœ‰ç†æ€§ä¸”æœ‰é‚è¼¯çš„åˆ†ææ¯ä¸€å€‹é»å­ï¼Œä¸€è·¯ä¸Šå…©äººä¸æ–·çš„çˆ­åŸ·ã€æŒçºŒæ¿€ç›ªæ–°çš„æƒ³æ³•\næ¯ä¸€å€‹å¥½é»å­çš„èƒŒå¾Œéƒ½æœ‰å †ç©å¦‚å±±çš„çˆ›é»å­ï¼Œç”šè‡³æœ‰æ™‚å€™å¥½é»å­å‡ºç¾æ™‚ä½ é‚„ç„¡æ³•å¯Ÿè¦º\nå¾Œä¾† Marc åœ¨æ¯ä¸€å¤œè¦å“„å°å­©ç¡è¦ºæ™‚ï¼Œæ‹¿èµ·ä¾†éŒ„å½±å¸¶ã€Šé˜¿æ‹‰ä¸ã€‹ï¼Œè·Ÿ Reed è¨è«–æ™‚æ­£å¥½ä»–è¢«ç™¾è¦–é”å‘äº† 40 ç¾é‡‘ï¼Œåœ¨å¤šå€‹çˆ›é»å­è½Ÿç‚¸ä¸‹ï¼Œé€™ä¼¼ä¹æ˜¯ä¸€å€‹æœ‰å‰æ™¯çš„é»å­\nMarc æ¥è‘—çµ„ç¹”åœ˜éšŠï¼Œé–‹å§‹æƒ³å¦‚ä½•æ‰“é€ ã€Œéƒµå¯„å‡ºç§ŸéŒ„å½±å¸¶ã€äº‹æ¥­ï¼Œè·Ÿåœ˜éšŠè¨è«–å¾Œç™¼ç¾ï¼Œç‚ºäº†æ–¹ä¾¿ç”¨æˆ¶ï¼Œå…¬å¸è¦è² æ“”ä¾†å›çš„éƒµè²» / åŒ…æç­‰ï¼Œç®—ä¸€ç®—æˆæœ¬é«˜çš„é©šäººï¼Œç¶“éè©¦ç®—å¾Œå¿…é ˆè¦å‡ºç§Ÿä¸€ç™¾æ¬¡æ‰æœ‰è¾¦æ³•é‚„æœ¬ï¼Œé€™æ ¹æœ¬å°±è¡Œä¸é€š\nä½†æ˜¯ç•¶æ™‚(1997å¹´)æ–°çš„å½±éŸ³æ ¼å¼ DVD å³å°‡å•ä¸–ï¼Œæ‰­è½‰äº†éŒ„å½±å¸¶æ‰€é€ æˆçš„å•é¡Œ\nä¸€å¼µè–„å¦‚ CD çš„é«”ç©èˆ‡é‡é‡ åŠ ä¸Šä¹‹å‰å» å•†å› ç‚ºè¦æ ¼ä¹‹äº‚ wiki: éŒ„å½±æ©Ÿæ ¼å¼æˆ°ï¼Œæ‰€ä»¥å¤§å®¶æ¯”è¼ƒé¡˜æ„çµ„ç¹”è¯ç›Ÿéµå¾ªåŒä¸€å¥—è¦ç¯„ åª’é«”ç”¢æ¥­èƒŒæ™¯çš„æ­·å²å› ç´ ï¼Œå¥½èŠå¡¢ç­‰å¨›æ¨‚ç”¢æ¥­ä¸æ»¿ç™¾è¦–é”å£Ÿæ–·ç§Ÿç‰‡å¸‚å ´ï¼ŒDVD é è¨ˆç™¼è¡Œçš„åƒ¹æ ¼æ˜¯éŒ„å½±å¸¶çš„ 1/5\nç¬é–“è®“éƒµå¯„å‡ºç§Ÿ DVD é€™å€‹é»å­å¯è¡Œ é›–èªª DVD å‰æ™¯çœ‹èµ·ä¾†å¾ˆèª˜äººï¼Œå›æº¯æ™‚ç©ºç•¶æ™‚é‚„æ˜¯æ¥µç‚ºå°çœ¾çš„å¸‚å ´ï¼Œç”šè‡³ Marc å’Œ Reed éƒ½æ²’çœ‹é DVDï¼Œä½† Marc æ¥µåŠ›èªªæœ Reedï¼Œæœ€å¾Œå…©äººè³­èªªã€Œå¦‚æœéƒµå¯„ CD å¯ä»¥æˆåŠŸã€ï¼Œä»–å€‘å°±èªçœŸè€ƒæ…®é–‹å…¬å¸åšéƒµå¯„ DVD çš„ç”Ÿæ„\nèšé›†é ‚å°–äººæ‰ä¸¦æ”¾æ‰‹è®“ä»–å€‘ç™¼æ® ã€ŒçœŸæ­£çš„å‰µæ–°ï¼Œä¸æœƒä¾†è‡ªç”±ä¸Šè€Œä¸‹çš„ç™¼è™Ÿæ–½ä»¤ï¼Œä¹Ÿä¸æœƒä¾†è‡ªå®šç¾©ç‹¹éš˜çš„ä»»å‹™ã€‚ä½ è¦é›‡ç”¨ä¸€ç¾¤å°ˆæ³¨æ–¼å¤§ç›®æ¨™çš„å‰µæ–°è€…ï¼Œä»–å€‘æœ‰è¾¦æ³•æ‰¾å‡ºè‡ªå·±èº«è™•ä½•æ–¹ï¼Œè‘—æ‰‹è§£æ±ºå•é¡Œã€ ç›´æ¥å¾æ›¸ä¸­æ‘˜éŒ„é€™ä¸€æ®µï¼Œæç¹ªäº† Marc æœ€ä¸€é–‹å§‹å»ºç«‹åœ˜éšŠèˆ‡é‹ç‡Ÿçš„æ–¹å‘ï¼Œæ”¾æ‰‹è®“å°ˆæ¥­çš„äººæ‰å»è‡ªç”±ç™¼æ®ï¼ŒMarc åªæŠ“ä½å¤§æ–¹å‘ï¼Œä¸¦æŒçºŒæ‰¾å°‹å¤–éƒ¨åˆä½œæ©Ÿæœƒï¼Œä¾‹å¦‚èˆ‡ç´¢å°¼ / æ±èŠè«‡åˆä½œï¼Œé€™å…©å®¶æ˜¯ç•¶æ™‚è²©å”® DVD æ’­æ”¾å™¨çš„å¤§å» ï¼Œæ¨å‡ºäº†è²·æ–°æ©Ÿå…è²»ç§Ÿç‰‡çš„è¡ŒéŠ·æ–¹æ¡ˆ\nå›é¡§ Marc æœ¬äººçš„ç”Ÿå‘½ç¶“æ­·èˆ‡ç”Ÿæ´»å“²å­¸ï¼Œä»–ååˆ†é‡è¦–ä»¥å‰åœ¨é‡å¤–æ±‚ç”Ÿçš„è¨“ç·´ï¼Œåœ¨é‡å¤–æ”€å²© / æº¯æºª / ç™»å±±æ™‚ï¼Œä½ å¿…é ˆç’°é¡§æ•´å€‹ç’°å¢ƒï¼Œæ‰¾å‡ºä»»ä½•å¯èƒ½ç™¼ç”Ÿæ„å¤–çš„åœ°æ–¹ä¸¦è¨­æƒ³å¦‚ä½•è™•ç†ï¼ŒåŒæ™‚è¦ä¸æ–·åœ¨æ²’æœ‰æ˜ç¢ºæ–¹å‘ã€æ··äº‚çš„ç¾å¯¦ä¸­æŒçºŒå¾€ç›®æ¨™é‚é€²\nå°±åƒæ˜¯ Netflix åœ¨ä¸Šç·šå‰çš„æº–å‚™ï¼Œä»–å€‘ä¸æ–·çš„æ”¹è‰¯åŒ…è£ / å›éƒµçš„æ–¹å¼ï¼›å€‰å„²äººå“¡æŒçºŒæ‰¾å‡ºå¦‚ä½•æœ‰æ•ˆç®¡ç†åº«å­˜ã€æ‰¾å‡ºæ¯ä¸€å®¶éƒµå±€çš„æœ€çŸ­è·¯å¾‘èˆ‡å¯„é€æ™‚é–“ï¼›å…§å®¹ç‡Ÿé‹äººå“¡å»å„å¤§ DVD è«–å£‡è‡¥åº•æŒçºŒæ¨æ’­è¨Šæ¯ï¼Œæ‰€æœ‰äººéƒ½ç·Šé‘¼å¯†é¼“æº–å‚™æœå‹™ä¸Šç·šçš„é‚£ä¸€åˆ»\næ™‚é–“å¿«è½‰åˆ°æœå‹™å³å°‡ä¸Šç·šçš„å‰ä¸€åˆ» (1997/4/14)ï¼Œä¼ºæœå™¨éƒ½æ¶è¨­å®Œæˆï¼Œé€£æ¥äº†ä¸€å€‹å°éˆ´éºå¦‚æœæœ‰è¨‚å–®é€²ä¾†å°±æœƒè²éŸ¿ï¼Œç­‰åˆ°ä¹é»é˜ä¸€ä¸Šç·šï¼Œã€Œéˆ´éˆ´éˆ´ã€æœå‹™æ¯”æƒ³åƒä¸­ç«ç†±ï¼Œä¼ºæœå™¨éäº†ä¸€å€‹å°æ™‚å°±æ”¯æ’ä¸ä½ï¼ŒIT äººå“¡ä¸æ–·å¾€è¨ªå¤§è³£å ´çµ„å»ºæ–°çš„ä¼ºæœå™¨ï¼Œæ‰€æœ‰äººæ—¢ç·Šå¼µå»åˆæ„Ÿåˆ°æ¬£æ…°ï¼Œéƒµå¯„ DVD é€™é–€ç”Ÿæ„è¡Œå¾—é€š!\nå› ç‚ºç”Ÿæ„æ¯”æƒ³åƒä¸­ç«çˆ†ï¼Œé€™æ™‚å€™å€‰å„²äººå“¡å…ˆå‰ç ”ç©¶çš„å„å¤§éƒµå±€é—œé–€æ™‚é–“èˆ‡æœ€çŸ­è·¯å¾‘å°±éå¸¸é‡è¦ï¼ŒæŠŠè¦åšçš„ç´°ç¯€éƒ½å¯¦éš›çš„æ¸¬è©¦/èª¿æ•´éæ‰èƒ½æ‡‰ä»˜å„ç¨®çªç™¼çš„ç‹€æ³\nPivot Pivot åœ¨ Pivot é€™ä¸€æ®µ Pivot çš„è½‰æŠ˜ååˆ†ç²¾å½©ï¼Œæ•£è½åœ¨æ™‚é–“è»¸çš„ä¸åŒéƒ¨ä½ï¼ŒNetflix é›–èªªä¸€é–‹å§‹æ˜¯æ‰“ç®—éƒµå¯„å‡ºç§Ÿ DVDï¼Œä½†æ˜¯æœ€ä¸€é–‹å§‹çš„ç‡Ÿæ”¶é«˜é” 9 æˆéƒ½æ˜¯ä¾†è‡ªè²©å”®ï¼Œè€Œéå‡ºç§Ÿï¼Œä»–å€‘å°±æ˜¯æä¸æ‡‚ç‚ºä»€éº¼ç”¨æˆ¶ä¸æœƒæƒ³è¦æŒçºŒçš„ç§Ÿå€Ÿï¼›\né›ªä¸ŠåŠ éœœçš„æ˜¯ï¼ŒAmazon å‰äº›é™£å­æ‰ä¸Šå¸‚ï¼Œæ‰¾ä¸Š Netflix å¸Œæœ›è«‡ä½µè³¼ï¼Œäºé¦¬éœä¸æ»¿è¶³æ–¼ç·šä¸Šè³£æ›¸è€Œå·²ï¼Œè€Œæ˜¯å¸Œæœ›è·¨è¶³æˆç‚ºå…¨éƒ½è³£çš„é›»å•†å¹³å°ï¼Œä¸è«–ä½µè³¼æ˜¯å¦æˆåŠŸï¼ŒAmazon éƒ½æ±ºå¿ƒè¸å…¥ DVD ç·šä¸Šè²©å”®çš„å¸‚å ´ï¼Œå° Netflix æœƒæ˜¯ä¸€å€‹éå¸¸å¤§çš„æ‰“æ“Š\nå¾Œä¾† Marc è·Ÿ Reed å› ç‚ºæ”¶è³¼åƒ¹æ ¼å¤ªä½ï¼Œæ‰€ä»¥æ‹’çµ•äº† Amazon çš„é‚€è«‹ï¼Œä½†å…©äººæ„è­˜åˆ°å…¬å¸å±åœ¨æ—¦å¤•ï¼Œæ‰€ä»¥å¿ƒä¸€æ©«æŠŠè²©å”®çš„äº‹æ¥­åœæ­¢ï¼Œå°ˆå¿ƒåšå‡ºç§Ÿï¼Œæ­¤æ™‚å‡ºç§Ÿçš„äº‹æ¥­é›·åŒç·šä¸Šç‰ˆçš„ç™¾è¦–é”ï¼Œä¸€æ¨£æœƒæ”¶å–é²é‚„ç½°æ¬¾\nåŠ æ‹¿å¤§åŸå‰‡\né€™æ˜¯ Netflix æ—©æœŸåšå•†æ¥­æ±ºç­–æ™‚çš„é‡è¦ä¾æ“šï¼Œä»–å€‘æœ€ä¸€é–‹å§‹åªå°ˆæ³¨æ–¼ç¾åœ‹å¸‚å ´ï¼Œä½†å¾Œä¾†èª¿æŸ¥å¦‚æœå¢åŠ åŠ æ‹¿å¤§ï¼Œå¯ä»¥ç«‹åˆ»å¤šä¸€æˆçš„æ”¶å…¥ï¼Œä½†æ˜¯å¾Œä¾†æƒ³äº†æƒ³ï¼Œå› ç‚ºé‚„æœƒæœ‰æ³•è¦ / éƒµå¯„é™åˆ¶ / èªè¨€ (åŠ æ‹¿å¤§æœ‰æ³•èªå€)ï¼Œä»–å€‘æ±ºå®šåªå°ˆæ³¨æ–¼ä¸€ä»¶äº‹æƒ…ä¸Šï¼Œæ‰€ä»¥å°±ç¨±ç‚ºã€ŒåŠ æ‹¿å¤§åŸå‰‡ã€\nå‡ºç§Ÿèˆ‡è²©å”® DVD çš„äº‹æ¥­ä¹Ÿæ˜¯ï¼Œé›–èªªæœ‰ Amazon é€™å€‹å¤–æ•µå­˜åœ¨ï¼Œä½†ä»–å€‘å…§éƒ¨æ—©å·²å†è¨è«–å…©ç¨®å•†æ¥­æ¨¡å¼çš„å–æ¨ï¼Œç¾å…¶åèƒ½æ»¿è¶³æ›´å¤šå…ƒç”¨æˆ¶çš„éœ€æ±‚ï¼Œä½†ä¹Ÿç„¡å½¢ä¸­è®“ç”¨æˆ¶æ›´åŠ çš„å›°æƒ‘\nå‰²æ¨æ‰è²©å”® DVD å¾Œï¼ŒNetflix æŒçºŒçš„ç‡’éŒ¢ï¼Œç”¨æˆ¶ä¼¼ä¹å‡ºç§Ÿéä¸€æ¬¡å°±ä¸æƒ³ç§Ÿç¬¬äºŒæ¬¡ï¼ŒMarc èˆ‡ä»–çš„åœ˜éšŠæŒçºŒæƒ³å•é¡Œåœ¨ä»€éº¼åœ°æ–¹ï¼Œæœ€å¾Œä»–å€‘æƒ³å‡ºäº†ç¾ä»Š Netflix çš„å•†æ¥­æ¨¡å¼\nè¨‚é–±åˆ¶ + æ²’æœ‰é²é‚„ç½°æ¬¾ + ä¸æ–·é€åˆ°å®¶æœå‹™\næ¯ä¸€å€‹æœˆ 19.99 ç¾é‡‘ï¼Œä¸€æ¬¡å¯ä»¥ç§Ÿå››ç‰‡ï¼Œåœ¨ç¶²ç«™ä¸Šå¯ä»¥å»ºç«‹å¾…çœ‹æ¸…å–®ï¼Œæ¯é‚„ä¸€ç‰‡å°±ç«‹åˆ»é€ä¸‹ä¸€ç‰‡çµ¦ä½ ï¼Œæ²’æœ‰ä»»ä½•çš„é€€é‚„æœŸé™!\né€™å€‹å•†æ¥­æ¨¡å¼å¾¹åº•å¼•çˆ†äº†ï¼Œç”¨æˆ¶æ„›æ­»é€™å€‹å•†æ¥­æ¨¡å¼ï¼Œåœ¨æ¨å‡ºç¬¬ä¸€å€‹æœˆå…è²»è©¦ç”¨å¾Œï¼Œè¿‘ä¹ä¹æˆçš„ç”¨æˆ¶æ¬¡æœˆçºŒè¨‚ï¼Œé€™å€‹æ¨¡å¼æ›´ç¬¦åˆä¸€èˆ¬äººçœ‹å½±ç‰‡çš„éœ€æ±‚\né›–ç„¶æ‰¾åˆ°é©åˆçš„å•†æ¥­æ¨¡å¼ï¼Œä½†é‚„æ˜¯å¾ˆç‡’éŒ¢ï¼Œå› ç‚ºæä¾›ç¬¬ä¸€å€‹æœˆå…è²»è©¦ç”¨ï¼Œæ‰€ä»¥å…¬å¸å¿…é ˆè² æ“”ç”¨æˆ¶ç¬¬ä¸€å€‹æœˆçš„ DVD / éƒµå¯„æˆæœ¬ï¼Œç¾é‡‘æµå£“åŠ›å¾ˆå¤§ï¼ŒMarc èˆ‡ Reed æ‰¾ä¸Šç™¾è¦–é”è«‡ä½µè³¼ï¼Œæœ€å¾Œç„¡ç–¾è€Œçµ‚ï¼ŒMarc åœ¨æ›¸æœ«é…¸äº†ç™¾è¦–é”ä¸€ä¸‹ :P\nåœ¨ç•¶æ™‚ 2000 å¹´åˆé‡åˆ° .com æ³¡æ²«å¾Œï¼Œç¶²è·¯æœå‹™çš„å‹Ÿè³‡æ¥µåº¦å›°é›£ï¼ŒNetflix ä¸å¾—å·²é–‹å§‹äº†ç¬¬ä¸€æ³¢çš„å¤§è£å“¡ï¼ŒåŒ…å«å¾ˆå¤šçš„å‰µå§‹åœ˜éšŠæˆå“¡çš„é›¢å»ï¼Œç¶“éçµ„ç¹”ç˜¦èº«å¾Œæ‰€æœ‰äººæ›´åŠ å°ˆæ³¨æ–¼ç›®æ¨™ä¸Šï¼›\nåœ¨æ›¸çš„éç¨‹ä¸­ï¼ŒMarc æœ¬äººçš„æ¬Šåˆ©ä¹Ÿæ…¢æ…¢çš„è¢«å‰å¥ªï¼Œå…¶å¯¦ Marc æ‰æ˜¯ Netflix æœ€ä¸€é–‹å§‹çš„å‰µè¾¦äººï¼ŒReed å‡ºè³‡ä¸¦æ“”ä»»è‘£äº‹çš„è§’è‰²ï¼Œä½†å¾Œä¾† Reed å¦ç™½åœ°æŒ‡å‡º Marc ç¼ºå¤±ï¼Œæ”¹ç”± Reed å‡ºä»»åŸ·è¡Œé•·è®Šæˆé›™é¦–é•·åˆ¶ï¼Œå¾ŒçºŒ Marc åœ¨ä¸Šå¸‚å¾Œä¸€æ®µæ™‚é–“ï¼Œé›¢é–‹äº†å¾…ä¸ƒå¹´å¤šçš„ Netflix\nMarc å¾ˆå‹‡æ•¢åœ°æ‰¿èªè‡ªå·±çš„ä¸è¶³ï¼ŒReed ä¹Ÿå¾ˆèª å¯¦åœ°ä»¥å¥½å‹/è‘£äº‹çš„èº«ä»½ç›´æ¥æŒ‡å‡ºï¼Œæœ€å¾Œä¹Ÿåœ¨ä»–é ˜å°ä¸‹è®“ Netflix è®Šæˆå¸‚å€¼ä¸€åƒäº”ç™¾å„„ç¾å…ƒçš„å¤§å…¬å¸ï¼›\nä½†æ˜¯çœ‹åˆ°æ•´å€‹éç¨‹é‚„æ˜¯ä¸å‹å”å™“\nThat will never work -\u0026gt; Nobady knows anything That will never work æ˜¯åŸæ–‡æ›¸åï¼Œä»£è¡¨è‘—ç•¶åˆMarc çš„é»å­ä¸è¢«çœ¾äººçœ‹å¥½ï¼ŒNobady knows anything å‰‡æ˜¯ Marc çµ¦å‡ºçš„å›æ‡‰ï¼Œæ²’æœ‰äººçŸ¥é“ä»»ä½•äº‹ï¼Œåªæœ‰è©¦äº†æ‰çŸ¥é“\né€™æœ¬æ›¸ååˆ†çš„ç²¾å½©ï¼Œéç¨‹æœ‰å¾ˆå¤šå‰µæ¥­çš„å°æ•…äº‹ï¼Œä¾‹å¦‚æœ€ä¸€é–‹å§‹ Netflix å«åš kibble (ç‹—é£Ÿ)ï¼Œèµ·å› æ˜¯ Marc å¥½å‹æ¨è–¦å…ˆå¹«å…¬å¸å–çš„çˆ›åå­—ï¼Œé€™æ¨£åˆ°æœå‹™å¿«ä¸Šç·šï¼Œå³ä½¿ä½ å¿™åˆ°ç„¦é ­çˆ›é¡ï¼Œçœ‹åˆ°åå­—é€™éº¼çˆ›æ‰æœƒæœ‰å‹•åŠ›å»æƒ³çœŸæ­£çš„å¥½åå­— /\nä»–å€‘æ›¾ç¶“æœ‰ä¸€æ¬¡ç©ºå‰çµ•å¾Œçš„å¥½æ©Ÿæœƒå»è¡ŒéŠ·ï¼Œçµæœä¸å°å¿ƒæŠŠ A ç‰‡å¯„çµ¦ç”¨æˆ¶ï¼Œåè€Œé€ æˆå¾ˆå¤§çš„å…¬é—œå±æ©Ÿï¼\nååˆ†æ¨è–¦å–œæ­¡å‰µæ¥­ / å–®ç´”å° Netflix ç™¼è·¡ æœ‰èˆˆè¶£çš„æœ‹å‹å»è§€çœ‹\n","date":"2020-09-17T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-09-17-%E4%B8%80%E5%8D%83%E9%9B%B6%E4%B8%80%E5%80%8B%E9%BB%9E%E5%AD%90%E4%B9%8B%E5%BE%8Cnetflix%E5%89%B5%E5%A7%8B%E7%9A%84%E7%A5%95%E5%AF%86%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/","title":"ã€Šä¸€åƒé›¶ä¸€å€‹é»å­ä¹‹å¾Œï¼šNETFLIXå‰µå§‹çš„ç¥•å¯†ã€‹é–±è®€å¿ƒå¾—"},{"content":"ä»¥ä¸‹å…§å®¹åŒ…å«åŸºæœ¬çš„ CRUD æ“ä½œï¼ŒElasticsearch æä¾›è‰¯å¥½çš„ REST API å‘¼å«ä»‹é¢ï¼Œä»¥ä¸‹æ¨¡æ“¬æƒ…å¢ƒç‚ºæ›¸åº—ï¼Œæ——ä¸‹æœ‰ amazon / eslite å¤šå®¶æ›¸åº—ï¼Œæ¯ä¸€æ›¸åº—å„²å­˜æ›¸æœ¬ç›¸é—œçš„è³‡æ–™ï¼Œå¦‚æ›¸åã€é æ•¸ã€ç°¡ä»‹ç­‰\nå¦å¤–é‚„æœ‰ä¸€äº›ç³»çµ±é…ç½®èˆ‡é€²éšåŠŸèƒ½ï¼Œçœ‹åˆ° Alias åŠŸèƒ½è¦ºå¾—ååˆ†æœ‰è¶£ï¼Œè®“ç¶­é‹æœ‰æ›´å¤šçš„å½ˆæ€§è·Ÿæ–¹æ³•å»èª¿æ•´è³‡æ–™å„²å­˜èˆ‡ç¡¬é«”æ¶æ§‹\nå¦‚æœæƒ³ä¹‹å‰æ¶æ§‹å±¤é¢ï¼Œå¯ä»¥åƒè€ƒ Elasticsearch ç³»çµ±ä»‹ç´¹èˆ‡è©•ä¼°\nåŸºæœ¬åè©è§£é‡‹ï¼ŒIndex = MongoDB çš„ Collection / MySQL çš„ Tableï¼› Document = MongoDB Document / MySQL Row\nåŸºæœ¬æ“ä½œ CRUD å¸¸è¦‹çš„å›å‚³å€¼ ä¸è«–è«‹æ±‚æ˜¯å¦æˆåŠŸï¼Œé€šå¸¸æœƒè¿”å› _index / _type / _id / _version / _shard ç­‰è³‡è¨Š\n_version æ˜¯ç”¨ä¾†è¿½è¹¤ document è¢«æ”¹å‹•çš„æ¬¡æ•¸ï¼›\n_found ä»£è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨\nå»ºç«‹ å¦‚æœç³»çµ±å·²ç¶“æœ‰è¦åŠƒ _id 1 $ curl -XPUT http://localhost:9200/amazon/book/1?op_type=create å¦‚æœæ²’æœ‰ _id å‰‡ç”± Elasticsearch ç”Ÿæˆï¼Œé è¨­ç”Ÿæˆçš„ _id æ˜¯ 22å­—å…ƒé•· + Base64 ç·¨ç¢¼ + URL åˆæ³•çš„å­—ä¸² 1 $ curl -XPOST http://localhost:9200/amazon/book åˆªé™¤ 1 $ curl -XDELETE http://localhost:9200/amazon/book/1 å¯ä»¥çœ‹åˆ°å›å‚³å€¼ _version ä¹Ÿæœƒè¢«å¢åŠ \næ›´æ–° / éƒ¨åˆ†æ›´æ–° 1 2 3 4 $ curl -XPUT http://localhost:9200/amazon/book/1 // éƒ¨åˆ†æ›´æ–° $ curl -XPOST http://localhost:9200/amazon/book/1/_update å° Elasticsearch ä¾†èªªï¼Œæ‰€æœ‰çš„è³‡æ–™éƒ½æ˜¯ä¸å¯è®Šçš„ï¼Œæ‰€ä»¥æ›´æ–°å…¶å¯¦æ˜¯å»ºç«‹æ–°çš„æ–‡æª”ä¸¦åˆªé™¤èˆŠçš„\nå¦å¤–æœ‰å€‹å‹•è©æ˜¯ Indexingï¼Œä¹Ÿå°±æ˜¯å»ºç«‹èˆ‡æ›´æ–°åˆåœ¨ä¸€èµ·ï¼Œæ²’æœ‰æ–‡æª”æ™‚å»ºç«‹ã€å­˜åœ¨æ™‚å°±æ›´æ–°\nscripting æœ‰æ™‚å€™æˆ‘å€‘æœƒå¸Œæœ›åŸºæ–¼ç¾æœ‰çš„ document æ¬„ä½é€²è¡Œæ›´æ–°ï¼Œä¾‹å¦‚èªªç€è¦½æ¬¡æ•¸ +1 ç­‰ç­‰çš„åŠŸèƒ½ï¼Œå¯ä»¥é€é scripting èªæ³•\nå¦‚\n1 2 curl -XPOST curl http://localhost:9200/amazon/book/iVKeNXMBpRlP8dKifEma/_update -H \u0026#39;Content-Type: application/json\u0026#39; \\ -d \u0026#39;{ \u0026#34;script\u0026#34;: \u0026#34;ctx._source.page_num += 1\u0026#34; }\u0026#39; åœ¨ Body ä¸­å¤¾å¸¶ scriptï¼Œä¸¦æŒ‡å®šæ¬„ä½èˆ‡æ“ä½œå³å¯ï¼Œåƒé€™é‚Šæˆ‘æ˜¯å°‡æ›¸ç±çš„é é¢ +1\nupsert æœ‰æ™‚å€™æ¬„ä½è¦æ›´æ–°æ™‚å¯èƒ½ä¸å­˜åœ¨ï¼Œå¯ä»¥é€é upsert æŒ‡å®šæ¬„ä½ä¸å­˜åœ¨æ™‚çš„è¡Œç‚º\n1 \u0026#39;{ \u0026#34;script\u0026#34;: \u0026#34;ctx._source.page_num += 1\u0026#34;, \u0026#34;upsert\u0026#34;: { \u0026#34;page_num\u0026#34;: 100 } }\u0026#39; æ¨‚è§€é–èˆ‡ _version ç•¶æ¯æ¬¡æœ‰å¯«çš„æ“ä½œï¼Œdocument çš„ _version éƒ½æœƒè¢« +1ï¼Œé€™æ˜¯ç‚ºäº†å¯¦è¸æ¨‚è§€é–æä¾›åœ¨ä½µç™¼ç‹€æ³ä¸‹çš„ä¿è­·ï¼Œåœ¨æ‰€æœ‰çš„æ“ä½œä¸­å¯ä»¥åŠ å…¥ querystring ?version= ç¢ºä¿ç‰ˆè™Ÿ ä¾‹å¦‚æˆ‘è¦æŸ¥æ‰¾ id=\u0026ldquo;iVKeNXMBpRlP8dKifEma\u0026rdquo; çš„æ›¸ç±ä¸”ç¢ºä¿æ˜¯ version 1\n1 curl http://localhost:9200/amazon/book/iVKeNXMBpRlP8dKifEma?version=1 å¦‚æœæœ‰å…¶ä»–äººå·²ç¶“æ›´å‹•éæ›¸ç±å°è‡´ version ä¸å†æ˜¯ 1ï¼Œæ­¤æ“ä½œæœƒæ‹‹å‡º 409 éŒ¯èª¤\n1 \u0026#34;reason\u0026#34;:\u0026#34;[iVKeNXMBpRlP8dKifEma]: version conflict, current version [4] is different than the one provided [1]\u0026#34;,\u0026#34;index_uuid\u0026#34;:\u0026#34;gSaILK3KSH6UCpOeYBGKcQ\u0026#34;,\u0026#34;shard\u0026#34;:\u0026#34;0\u0026#34;,\u0026#34;index\u0026#34;:\u0026#34;amazon\u0026#34;},\u0026#34;status\u0026#34;:409 Warningï¼šæ¨‚è§€é–åƒ…é©ç”¨æ–¼å–®æ–‡æª”æ›´æ–°ï¼ŒElasticsearch æ²’æœ‰ Transaction æ¦‚å¿µï¼Œæ‰€ä»¥æ²’æœ‰å¤šæ–‡æª”æ›´æ–°çš„ä¸€è‡´æ€§ä¿è­‰\næŸ¥è©¢ 1 $ curl -XGET http://localhost:9200/amazon/book/1 å¦‚æœæƒ³è¦é‡å°å¤šç­† document æŸ¥è©¢ éœ€æŒ‡å®šå¤šç­†çš„ index/type/idï¼Œå¦‚æœæŸä¸€å€‹æª”æ¡ˆä¸å­˜åœ¨å›å‚³å€¼å¾— _found å°±æœƒæ˜¯ false\n1 2 3 4 5 6 7 è·¨ index æŸ¥è©¢ $ curl http://localhost:9200/_mget -H \u0026#39;Content-Type: application/json\u0026#39; \\ -d \u0026#39;{ \u0026#34;docs\u0026#34;: [ { \u0026#34;_index\u0026#34;: \u0026#34;amazon\u0026#34;, \u0026#34;_type\u0026#34;: \u0026#34;book\u0026#34;, \u0026#34;_id\u0026#34;: 5 }, { \u0026#34;_index\u0026#34;: \u0026#34;amazon\u0026#34;, \u0026#34;_type\u0026#34;: \u0026#34;book\u0026#34;, \u0026#34;_id\u0026#34;: \u0026#34;iVKeNXMBpRlP8dKifEma\u0026#34; } ] } ä¹Ÿå¯ä»¥åœ¨åŒä¸€å€‹ index/type åº•ä¸‹æŸ¥è©¢ï¼Œåªè¦æ¨™æ³¨ id å°±å¥½ $ curl http://localhost:9200/amazon/book/_mget -H \u0026#39;Content-Type: application/json\u0026#39; \\ -d \u0026#39;{ \u0026#34;ids\u0026#34;: [ 1, \u0026#34;iVKeNXMBpRlP8dKifEma\u0026#34; ] } æ‰¹æ¬¡å¯«å…¥æ“ä½œ å¦‚æœæˆ‘å€‘æƒ³è¦ä¸€æ¬¡å»ºç«‹å¤šå€‹æª”æ¡ˆï¼Œæˆ–æ˜¯åˆªé™¤ç­‰ï¼Œç”šè‡³æ˜¯æ··é›œå„ç¨®æŸ¥è©¢ä¸€æ¬¡æ€§å‘¼å«ï¼Œå¯ä»¥ä½¿ç”¨ batch\nElasticsearch åŸ·è¡Œ Batch æ™‚æœƒåŒæ™‚ç¨ç«‹è™•ç†ï¼Œçµæœä¹Ÿéœ€è¦å»å°æ‡‰çš„ Response æŸ¥è©¢ï¼Œå¦‚æœæœ‰ Shard å°±æœƒåˆ†æ•£åˆ°å°æ‡‰çš„ Shard æœ€å¾Œå†æŠŠçµæœåˆä½µ å¦‚æœæ“ä½œæ˜¯ create/index/update çš„è©±ï¼Œä¸‹ä¸€è¡Œæ˜¯æ”¾ document å…§å®¹\n1 2 curl http://localhost:9200/_bulk -H \u0026#39;Content-Type: application/json\u0026#39; \\ -d $\u0026#39;{ \u0026#34;create\u0026#34;: {\u0026#34;_index\u0026#34;:\u0026#34;amazon\u0026#34;, \u0026#34;_type\u0026#34;:\u0026#34;book\u0026#34;, \u0026#34;_id\u0026#34;: 2 }\\n {\u0026#34;name\u0026#34;:\u0026#34;....\u0026#34;,\u0026#34;page_num\u0026#34;:991,\u0026#34;publish_date\u0026#34;:\u0026#34;2017/05/16\u0026#34;,\u0026#34;intro\u0026#34;: \u0026#34;....\u0026#34;}\\n{\u0026#34;delete\u0026#34;: { \u0026#34;_index\u0026#34;: \u0026#34;amazon\u0026#34;, \u0026#34;_type\u0026#34;: \u0026#34;book\u0026#34;, \u0026#34;_id\u0026#34;: 5 } }\\n éœ€æ³¨æ„ Body ä¸­æ˜¯ä»¥ \\n ç•¶ä½œæ–°çš„æŒ‡ä»¤é–‹å§‹ï¼Œä¸”æœ€å¾Œä¸€ç­†ç´€éŒ„ä¹Ÿè¦ä»¥ \\n çµå°¾\nç‚ºä»€éº¼ Elasticsearch ä¸ç”¨ JSON Array ç•¶ä½œ Body å‘¢ï¼Ÿ\né€™æ˜¯å› ç‚ºå¦‚æœæ˜¯ Array çš„è©±ï¼ŒNode æ¥æ”¶åˆ°ä¹‹å¾Œé‚„è¦å»æ‹†è§£ Arrayï¼Œæ¥è‘—æ±ºå®šå“ªäº› Query æ˜¯å±¬æ–¼å“ªå€‹ Shard åœ¨åŒ…ä¸€å±¤ Arrayï¼› ç›´æ¥ä½¿ç”¨ JSON Object åŠ ä¸Š \\n å¯ä»¥ä¸ç”¨é¡å¤–çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œç”¨æ›è¡Œå­—ç¬¦æ‹†è§£ Query å°±å¥½ï¼Œç¯€çœè¨±å¤šä¸å¿…è¦é–‹éŠ·\næœå°‹ Elasticsearch åœ¨æœå°‹ä¸Šå½ˆæ€§å¾ˆå¤§ï¼Œå¯ä»¥è·¨ index / è·¨ type æœå°‹\n1 curl http://localhost:9200/_search æŒ‡å®šæ¢ä»¶éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨ querystring æˆ–æ˜¯ Body å¤¾å¸¶ï¼Œæ¨è–¦å¾Œè€…å› ç‚ºå½ˆæ€§èˆ‡å¯ç¶­è­·æ€§æ›´é«˜\næŒ‡å®šæŸæ¬„ä½çš„æ¢ä»¶æœå°‹ 1 curl http://localhost:9200/amazon/book/_search?q=name:Elasticsearch ç”¨ q=${æ¬„ä½åç¨±}:${æ¢ä»¶}ï¼Œå¦‚æœæœ‰å¤šç­†å‰‡ç”¨+é€£çµ\næŸæ–‡æª”ä»»ä¸€æ¬„ä½ç¬¦åˆæ¢ä»¶æœå°‹ åœ¨ Elasticsearch ä¸­ï¼Œæ¯å€‹æ–‡ä»¶éƒ½æœ‰ä¸€å€‹ç‰¹å‡ºæ¬„ä½ _allï¼Œä¹Ÿå°±æ˜¯æŠŠæ–‡ä»¶ä¸­æ‰€æœ‰çš„å­—ä¸²æ ¼å¼æ¬„ä½éƒ½æ‹¼æ¥èµ·ä¾†\n1 curl http://localhost:9200/amazon/book/_search?q=Elasticsearch Mapping ç‚ºäº†æ›´å¥½çš„æ”¯æ´æœå°‹ï¼ŒElasticsearch åœ¨å¯«å…¥æ–‡ä»¶æ™‚æœƒæœ‰å»ºç«‹ Schemaï¼Œå¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤æŸ¥è©¢\n1 curl http://localhost:9200/amazon/_mapping å‹åˆ¥æœ‰åˆ†æˆ text / number ç³»åˆ—(int, long) / date / boolean / object / geo_point ç­‰ç­‰ éå¸¸å¤šç¨®\nå¦‚æœæ¬„ä½æ˜¯ Arrayï¼Œå‰‡ä»¥ç¬¬ä¸€å€‹å…ƒç´ çš„å‹åˆ¥ç‚ºä¸»ï¼Œä¸”åŒä¸€ Array ä¸­å…ƒç´ å¿…é ˆéƒ½æ˜¯åŒå‹åˆ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 { \u0026#34;amazon\u0026#34;: { \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;intro\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;fields\u0026#34;: { \u0026#34;keyword\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;keyword\u0026#34;, \u0026#34;ignore_above\u0026#34;: 256 } } }, \u0026#34;page_num\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;long\u0026#34; }, \u0026#34;publish_date\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;date\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis\u0026#34; }, ... } } } } ä¹Ÿå¯ä»¥ä¸»å‹•é‡å° Index è¨­å®š Schema èˆ‡èª¿æ•´å‹åˆ¥è¨­å®šï¼Œä¾‹å¦‚èªªç´¢å¼•çš„æ·±åº¦èˆ‡æ•¸é‡ç­‰ï¼Œé è¨­ Elasticsearch æœƒæŠŠæ¯å€‹æ¬„ä½éƒ½å»ºç«‹ç´¢å¼•ï¼Œæ‰€ä»¥è¨˜æ†¶é«”æ¶ˆè€—éå¸¸é©šäºº\nWarning: å‹åˆ¥è¨­å®šå¾Œåªèƒ½æ–°å¢æ¬„ä½ï¼Œä¸èƒ½æ›´å‹•æ—¢æœ‰çš„å‹åˆ¥æˆ– Indexingï¼Œæœ€å¥½æ˜¯ä¸€é–‹å§‹å°±è¨­å®šå¥½ï¼Œä¸ç„¶è¦ ReIndex ï¼Œè©³è¦‹å¾ŒçºŒ\nå»ºç«‹ Mapping å…ˆåˆªé™¤ amazon Indexï¼Œé‡æ–°å»ºç«‹ Index èˆ‡ Mapping\nå‡è¨­æˆ‘å¸Œæœ› page_num æ¬„ä½æ˜¯ Integer ä¸”ä¸è¦å»ºç«‹ç´¢å¼•\n1 2 $ curl -XPUT http://localhost:9200/amazon/_mapping -H \u0026#39;Content-Type: application/json\u0026#39; \\ --data \u0026#39;{ \u0026#34;properties\u0026#34;: { \u0026#34;page_num\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;integer\u0026#34;, \u0026#34;index\u0026#34;: false } } }\u0026#39; é‡æ–°å°‡è³‡æ–™å¯«å…¥å¾Œï¼Œå…¶é¤˜çš„æ¬„ä½ Elasticsearch æœƒå¹«å¿™è£œä¸Šå‹åˆ¥ï¼Œpage_num å› ç‚ºå·²ç¶“å­˜åœ¨å‰‡ä¸æœƒæ”¹è®Š éœ€è¦æ³¨æ„å¦‚æœ indexæŒ‡å®šfalse å‰‡ä½¿ç”¨ /_search?q æœƒç„¡æ³•æœå°‹\nAnalyzer å¦‚æœåªèƒ½é‡å°æ¢ä»¶åšç¯©é¸ï¼Œé€™ä¸€èˆ¬çš„è³‡æ–™åº«ä¹Ÿåšå¾—åˆ°ï¼ŒçœŸæ­£è®“ Elasticsearch å€åˆ¥æ–¼ä¸€èˆ¬è³‡æ–™åº«çš„åœ°æ–¹åœ¨æ–¼ Analyzer\næ¯å€‹æ–‡æª”çš„æ¬„ä½é™¤äº†å‹åˆ¥å®šç¾©èˆ‡ç´¢å¼•å¤–ï¼Œé‚„å¯ä»¥æŒ‡å®šè©²æ¬„ä½å¦‚ä½•è¢«åˆ†æï¼Œä¾‹å¦‚èªªæœ€åŸºæœ¬çš„æ–·è© \u0026ldquo;ä¸­è¯æ°‘åœ‹\u0026rdquo; è¦æ‹†æˆ \u0026ldquo;ä¸­\u0026rdquo;ã€\u0026ldquo;è¯\u0026rdquo;ã€\u0026ldquo;æ°‘\u0026rdquo;ã€\u0026ldquo;åœ‹\u0026rdquo; é‚„æ˜¯ \u0026ldquo;ä¸­è¯\u0026rdquo;ã€\u0026ldquo;æ°‘åœ‹\u0026quot;ç­‰æœ‰å¤šç¨®æ–¹å¼ï¼Œæ±ºå®šå¦‚ä½•æ–·è©æœƒå½±éŸ¿æŸ¥è©¢\nå¦å¤–åƒèªæ„åˆ†æï¼Œå¦‚æœæˆ‘å€‘æƒ³æœå°‹ã€ŒQuick fox jumpsã€ï¼Œæˆ‘å€‘ä¸å–®å¸Œæœ›å­—é¢ä¸Šå®Œå…¨ç¬¦åˆï¼Œè€Œæ˜¯æ‰¾åˆ°é¡ä¼¼ä¸‹è€…çš„æ–‡æª” A quick brown fox jumps over the lazy dog\næ‰€ä»¥ Analyzer ä¸»è¦åˆ†æˆä¸‰å€‹éƒ¨åˆ†\ncharacter filter\næ±ºå®šå­—å…ƒå¦‚ä½•è™•ç†ï¼Œåƒæ˜¯è½‰æ›æ•¸å­—æ ¼å¼ / å»é™¤ HTML tag ç­‰ tokenizer\næ±ºå®šå­—å…ƒå¦‚ä½•çµ„åˆæˆå­—ä¸²ï¼Œè‹±æ–‡é è¨­æ˜¯ç”¨ç©ºç™½ï¼Œæ¯å€‹ Analyzer ä¸€å®šä¹Ÿåªèƒ½æœ‰ä¸€å€‹ tokenizer token filter\nå°‡å­—ä¸²åšè™•ç†ï¼Œä¾‹å¦‚å…¨éƒ¨è½‰å°å¯« / éæ¿¾åŒç¾©è©ç­‰ æ¸¬è©¦ Analyzer å¦‚æœä¸çŸ¥é“è¦æ€éº¼é¸æ“‡ Analyzerï¼Œå¯ä»¥çœ‹æ–‡ä»¶æ‰¾å‡ºå…§å»ºçš„ Analyzerä¸¦é€é API å»æ¸¬è©¦ï¼ŒæŒ‡å®šä¸åŒçš„ Analyzer èˆ‡æ¸¬è©¦å­—ä¸²\n1 2 3 4 5 $ curl http://localhost:9200/_analyze -H \u0026#39;Content-Type: application/json\u0026#39; \\ --data \u0026#39;{ \u0026#34;analyzer\u0026#34;: \u0026#34;standard\u0026#34;, \u0026#34;text\u0026#34;:\u0026#34;this is a test\u0026#34; }\u0026#39; $ curl http://localhost:9200/_analyze -H \u0026#39;Content-Type: application/json\u0026#39; \\ --data \u0026#39;{ \u0026#34;filter\u0026#34;: [\u0026#34;lowercase\u0026#34;], \u0026#34;char_filter\u0026#34; : [\u0026#34;html_strip\u0026#34;], \u0026#34;tokenizer\u0026#34;: \u0026#34;whitespace\u0026#34;, \u0026#34;text\u0026#34;:\u0026#34;this \u0026lt;a\u0026gt;iS\u0026lt;/a\u0026gt; A Test\u0026#34; }\u0026#39; å¯ä»¥çœ‹åˆ°å›å‚³å€¼æ˜¯ Analyzer æœƒå¦‚ä½• parse å­—ä¸²ä¸¦ç”¢ç”Ÿç´¢å¼•çš„ keywordï¼Œæ›´å¤šçš„åƒæ•¸å¯ä»¥åƒè€ƒæ–‡ä»¶ Analyze API å¦‚æœéœ€è¦æ”¯æ´ä¸­æ–‡ï¼Œå‰‡éœ€è¦å¦å¤–å®‰è£ plugin\nèª¿æ•´æ¬„ä½çš„ Analyzer å¯ä»¥åœ¨ Index ä¸‹å»ºç«‹å®¢è£½åŒ–çš„ Analyzerï¼Œä¾‹å¦‚æˆ‘å»ºç«‹ä¸€å€‹ my_intro_analyzer\n1 2 $ curl -XPUT http://localhost:9200/amazon/_settings -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;analysis\u0026#34;: { \u0026#34;analyzer\u0026#34;: { \u0026#34;my_intro_analyzer\u0026#34;: { \u0026#34;filter\u0026#34;: [\u0026#34;lowercase\u0026#34;], \u0026#34;char_filter\u0026#34; : [\u0026#34;html_strip\u0026#34;], \u0026#34;tokenizer\u0026#34;: \u0026#34;whitespace\u0026#34; } } } }\u0026#39; é€é Mapping API å»æ›´æ”¹æ¬„ä½çš„ Analyzerï¼ŒåŒæ¨£æ˜¯ä¸èƒ½æ›´æ”¹æ—¢æœ‰çš„ Indexï¼Œä¸”åªèƒ½æŒ‡å®š Analyzer è€Œä¸èƒ½åœ¨æ¬„ä½ä¸­è‡ªè¨‚ tokenizer ç­‰\n1 2 $ curl -XPUT http://localhost:9200/amazon -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;intro\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;my_intro_analyzer\u0026#34; } } }, \u0026#34;settings\u0026#34;: { \u0026#34;analysis\u0026#34;: { \u0026#34;analyzer\u0026#34;: { \u0026#34;my_intro_analyzer\u0026#34;: { \u0026#34;filter\u0026#34;: [\u0026#34;lowercase\u0026#34;], \u0026#34;char_filter\u0026#34; : [\u0026#34;html_strip\u0026#34;], \u0026#34;tokenizer\u0026#34;: \u0026#34;whitespace\u0026#34; } } } } }\u0026#39; çœ‹èµ·ä¾† Indexing æ·±åº¦èˆ‡ Analyzer åˆ†æçš„ Token æ•¸éƒ½éœ€è¦è¨­å®šä¸Šé™ï¼Œå¦å‰‡é è¨­å€¼æœƒè®Šæˆè¨˜æ†¶é«”æ€ªç¸!\nDSL å‰é¢æåˆ°æœå°‹æ™‚å¯ä»¥ç”¨ querystring åŠ ä¸Šæ¢ä»¶ï¼Œä½†ç‚ºäº†è¨­å®šæ›´è¤‡é›œä¸”å½ˆæ€§çš„æŸ¥è©¢èªæ³•ï¼Œå¯ä»¥ä½¿ç”¨ Elasticsearch è‡ªè¨‚çš„æŸ¥è©¢èªè¨€\nQuery å¦‚æœä»Šå¤©æƒ³è¦æ‰¾æ¬„ä½ä¸­æ˜¯å¦æœ‰ç›¸è¿‘çš„å€¼ï¼Œå¯ä»¥ç”¨ match\n1 2 $ curl http://localhost:9200/amazon/_search -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;query\u0026#34;: { \u0026#34;match\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;Distributed\u0026#34; } } }\u0026#39; Filter å¦‚æœä»Šå¤©æƒ³è¦æ‰¾æ¬„ä½ä¸­å®Œå…¨ä¸€æ¨¡ä¸€æ¨£å€¼ï¼Œå¯ä»¥ç”¨ term æ¥ç¯©é¸æ¢ä»¶\n1 2 $ curl http://localhost:9200/amazon/_search -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;query\u0026#34;: { \u0026#34;term\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;Elasticsearch: The Definitive Guide: A Distributed Real-Time Search and Analytics Engine 1st Edition, Kindle Edition\u0026#34; } } }\u0026#39; çµ„åˆå¤šç¨®æ¢ä»¶ å¦‚æœä»Šå¤©è¦æœå°‹çš„æ¢ä»¶æ¯”è¼ƒè¤‡é›œï¼Œä¾‹å¦‚èªªæˆ‘å¸Œæœ›åç¨±ä¸€å®šè¦åŒ…å« Distributedï¼Œé æ•¸æœ€å¥½åœ¨200è‡³500é æˆ–æ˜¯å‡ºç‰ˆå¹´ä»½åœ¨ä»Šå¹´(ä½†å…©è€…å¿…é ˆè‡³å°‘ç¬¦åˆä¸€é …)\nå¯ä»¥ç”¨ bool æ­é… must å¿…é ˆç¬¦åˆ + should æ‡‰è©²ç¬¦åˆï¼Œæ­é… minimum_should_match å¯ä»¥æ±ºå®šæ¢ä»¶çš„ç¬¦åˆç¨‹åº¦\n1 2 curl http://localhost:9200/amazon/_search -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;query\u0026#34;: { \u0026#34;bool\u0026#34;: { \u0026#34;must\u0026#34;: { \u0026#34;match\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;Distributed\u0026#34; } }, \u0026#34;minimum_should_match\u0026#34;: 1, \u0026#34;should\u0026#34;: [ { \u0026#34;range\u0026#34;: { \u0026#34;page_num\u0026#34;: { \u0026#34;gt\u0026#34;: 200, \u0026#34;lt\u0026#34;: 500 } } }, { \u0026#34;range\u0026#34;: {\u0026#34;publish_date\u0026#34;: { \u0026#34;gt\u0026#34;: \u0026#34;2020/01/01\u0026#34; } } } ] } } }\u0026#39; ç³»çµ±é…ç½®èˆ‡è¨­å®š Sharding ç›¸é—œ 1. è¨­å®š Index çš„ sharding èˆ‡ replica æ•¸é‡ æœ‰å…©ç¨®æ–¹å¼ï¼Œä¸€ç¨®æ˜¯å»ºç«‹ Index æ™‚å°±æŒ‡å®šï¼Œç¬¬äºŒç¨®æ˜¯å»ºç«‹ Index å¾ŒçºŒèª¿æ•´\n1 2 3 4 5 6 7 1. å»ºç«‹ Index æŒ‡å®š curl -XPUT http://localhost:9200/amazon -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;index\u0026#34;: { \u0026#34;number_of_shards\u0026#34;: 2, \u0026#34;number_of_replicas\u0026#34;: 0 } }\u0026#39; 2. å¾ŒçºŒå‹•æ…‹èª¿æ•´ curl -XPUT http://localhost:9200/amazon/_settings -H \u0026#39;Content-Type: application/json\u0026#39; --data \\ \u0026#39;{ \u0026#34;index\u0026#34;: { \u0026#34;number_of_replicas\u0026#34;: 0 } }\u0026#39; éœ€æ³¨æ„ sharding number æœ€å¥½ä¸€é–‹å§‹å°±è¨­å®šå¥½ï¼Œå¯ä»¥é…ç½®ç¨å¾®å¤šä¸€é» Primary shard æ–¹ä¾¿å¾ŒçºŒ scale out\nå¾ŒçºŒå¦‚æœè¦å‹•æ…‹èª¿æ•´å¾ˆéº»ç…©ï¼Œè¦æŠŠ Index è¨­æˆ read-only ä¸¦é€é Split API ä¿®æ”¹ / æˆ–æ˜¯ç”¨ Reindex æ–¹å¼é‡å»ºæ–°çš„ Index\n2. æŒ‡å®š Index ä½¿ç”¨çš„æ©Ÿå‹ æœ‰æ™‚å€™æˆ‘å€‘æœƒå¸Œæœ›æŸäº›ç†±é–€çš„ Index ä½¿ç”¨è¼ƒå¥½çš„ç¡¬é«”ï¼Œå…¶ä»–å†·é–€çš„ä½¿ç”¨å·®ä¸€é»çš„ç¡¬é«”ï¼ŒElasticsearch åœ¨æ©Ÿå™¨é‹ä½œæ™‚å¯ä»¥æ‰“ä¸Šæ¨™è¨˜ --node.box_type\n1 $ ./bin/elasticsearch --node.box_type strong æŒ‡å®š Index è¦å­˜æ”¾çš„æ©Ÿå‹\n1 2 3 4 $ POST /logs_2014-09-30/_settings { \u0026#34;index.routing.allocation.include.box_type\u0026#34; : \u0026#34;strong\u0026#34; } çµåˆå¾ŒçºŒçš„ Alias å¯ä»¥é…ç½®å‡ºæ›´ç¬¦åˆå¯¦éš›æ‡‰ç”¨çš„è¨­å®š\nIndex template ç•¶å»ºç«‹æ–°çš„ Index æ™‚ï¼Œå¯ä»¥æŒ‡å®š template å¥—ç”¨è¨­å®šï¼Œå°±ä¸ç”¨æ¯æ¬¡éƒ½è¦æ‰“è¨­å®šï¼ŒElasticsearch åœ¨ 7.8 ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥æŒ‡å®š component template èˆ‡ index templateï¼›\ncomponent template æ˜¯å°å–®ä½å¯ä»¥è¢«ç”¨ä¾†çµ„åˆçš„ï¼›è€Œ index template å‰‡æ˜¯ Index ç›´æ¥å¥—ç”¨çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // Component template PUT _component_template/other_component_template { \u0026#34;template\u0026#34;: { \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;ip_address\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;ip\u0026#34; } } } } } // Index templateï¼Œåªè¦ Index é–‹é ­æ˜¯ bar å°±æœƒå¥—ç”¨ PUT _index_template/template_1 { \u0026#34;index_patterns\u0026#34;: [\u0026#34;bar*\u0026#34;], \u0026#34;template\u0026#34;: { \u0026#34;settings\u0026#34;: { \u0026#34;number_of_shards\u0026#34;: 1 }, \u0026#34;mappings\u0026#34;: { \u0026#34;_source\u0026#34;: { \u0026#34;enabled\u0026#34;: false }, \u0026#34;properties\u0026#34;: { \u0026#34;host_name\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;keyword\u0026#34; }, \u0026#34;created_at\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;date\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;EEE MMM dd HH:mm:ss Z yyyy\u0026#34; } } }, \u0026#34;aliases\u0026#34;: { \u0026#34;mydata\u0026#34;: { } } }, \u0026#34;priority\u0026#34;: 10, \u0026#34;composed_of\u0026#34;: [\u0026#34;component_template1\u0026#34;, ....], \u0026#34;version\u0026#34;: 3, \u0026#34;_meta\u0026#34;: { \u0026#34;description\u0026#34;: \u0026#34;my custom\u0026#34; } } Reindex èˆ‡ Alias å…ˆä»‹ç´¹ Aliasï¼Œçœ‹åˆ°é€™å€‹åŠŸèƒ½è®“æˆ‘è¦ºå¾—ååˆ†é©šè±”ï¼Œå¯ä»¥å°‡ç¶­é‹èˆ‡é–‹ç™¼æ‹†åˆ†çš„æ›´åŠ ç¨ç«‹\nä»Šå¤©å‡è¨­å› ç‚ºè³‡æ–™çš„æ ¼å¼å•é¡Œ / Sharding é‡æ–°åˆ†é…ç­‰å•é¡Œéœ€è¦Index éœ€è¦é‡å»ºï¼ŒAlias å°±èƒ½æ´¾ä¸Šç”¨å ´\nä»–çš„æ¦‚å¿µå°±å¥½åƒæª”æ¡ˆé€£çµï¼Œå¯ä»¥å–ä¸€å€‹é€£çµåç¨±ï¼Œä½†åŒæ™‚å°æ‡‰åˆ°å¤šå€‹å¯¦éš›çš„æª”æ¡ˆè·¯å¾‘ï¼Œä¾‹å¦‚èªªæˆ‘æœ‰å…©å€‹ Index æƒ³è¦åˆ†é–‹å„²å­˜ /amazon + /eslite\nä½†æˆ‘å¸Œæœ›æŸ¥è©¢æ™‚å¯ä»¥æœ‰ä¸€å€‹å…±åŒçš„ endpoint å–åå« /bookstoreï¼Œå°±å¯ä»¥ç”¨ Alias é€£çµ /amazon èˆ‡ /eslite\n1 2 3 4 5 6 7 8 9 10 11 $ curl -XPUT http://localhost:9200/eslite/_alias/bookstore $ curl -XPUT http://localhost:9200/amazon/_alias/bookstore $ curl http://localhost:9200/boostore/_search // åŒæ™‚è¿”å› amazon / eslite åº•ä¸‹çš„æ–‡æª” $ curl http://localhost:9200/*/_alias/bookstore // æŸ¥è©¢å“ªäº› Index æœ‰è¨­å®š alias ç‚º bookstore $ curl -X DELETE http://localhost:9200/amazon/_alias/bookstore // åˆªé™¤ alias é›–ç„¶æœå°‹çš„æ™‚å€™ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šå¤šå€‹ Index å¦‚ curl http://localhost:9200/amazon,eslite/_searchï¼Œä½†å¦‚æœè¦å¢æ¸› Index é …ç›®å°±éœ€è¦æ”¹ç¨‹å¼ç¢¼ï¼Œååˆ†ä¸ä¹¾æ·¨\nå¦å¤–æ›´å¤§çš„å¥½è™•åœ¨æ–¼åŒä¸€å€‹ Index è¦å‡ç´šæ™‚ï¼Œå¯¦éš›å„²å­˜å¯ä»¥ç”¨ç‰ˆè™Ÿå¦‚ index_name_v1ï¼Œç”¨ alias æŒ‡å®š index_nameï¼›\næ¥è‘—åœ¨å»ºç«‹æ–°çš„ index_name_v2 æ›æˆæ–°çš„ Indexï¼Œå®Œæˆå¾Œåœ¨åˆ‡æ› index_name çš„æŒ‡å‘å°±èƒ½ zero downtime åˆ‡æ› index äº†\næŸ¥è©¢æ™‚æŒ‡å®š alias å°±å¯ / å¯«å…¥æ™‚å¦‚æœ alias ä¸‹åªæœ‰ä¸€å€‹ index å°±ä¸ç”¨æŒ‡å®šï¼›è¶…éä¸€å€‹å¿…é ˆæŒ‡å®šå¯«å…¥çš„ index\næ‹†åˆ† Index èˆ‡ Alias æ‡‰ç”¨ å‡è¨­ä»Šå¤©æˆ‘å€‘æ‹¿ Elasticsearch ç•¶ä½œ Logging Serviceï¼Œé€šå¸¸æ˜¯è¶Šè¿‘æœŸçš„è³‡æ–™è¶Šç†±é–€ï¼Œæ™‚é–“ä¹…ä¹‹å¾ŒèˆŠè³‡æ–™å¯èƒ½è¦ç§»é™¤æˆ–è½‰å‡ºä¿å­˜\nåœ¨ç³»çµ±è¨­è¨ˆä¸Šï¼Œæˆ‘å€‘è¦è€ƒé‡å¹¾å€‹é»\nå„²å­˜æ™‚å€åˆ†æ–°è³‡æ–™èˆ‡èˆŠè³‡æ–™ æœå°‹æ™‚å¸Œæœ›æ–°è³‡æ–™èˆ‡éƒ¨åˆ†èˆŠè³‡æ–™éƒ½å¯ä»¥è¢«æŸ¥è©¢ èˆŠè³‡æ–™çš„å®šæœŸåˆªé™¤èˆ‡å†·ä¿å­˜ æ›¸ä¸­å»ºè­°ï¼ŒLog ä¾ç…§æ™‚é–“å€é–“å»ºç«‹æ–°çš„ Indexï¼Œä¾‹å¦‚æ¯å€‹ä¾ç…§æ¯å€‹æœˆä»½å„²å­˜ 2020-05 å°±å–®æ”¾äº”æœˆä»½çš„ Log\nå»ºç«‹æ–°çš„ Index æ™‚å¯ä»¥é€é template ç¶å®šé è¨­å€¼ï¼Œå°±ä¸ç”¨æ¯æ¬¡éƒ½è¦æ‰‹å‹•é å…ˆå»ºç«‹ Index äº†\nå‡è¨­æŸ¥è©¢æ™‚æœƒå¸Œæœ›æœå°‹è¿‘æœŸ 3 å€‹æœˆçš„è³‡æ–™ï¼Œèˆ‡å…¶æ¯æ¬¡éƒ½æŒ‡å®š 3 å€‹ Indexï¼Œå¯ä»¥é€é Alias ç°¡åŒ–æŸ¥è©¢èªæ³•\næ‹†åˆ†å¤šå€‹ Index å¥½è™•æ˜¯èª¿æ•´éå¸¸å½ˆæ€§ï¼Œä¾‹å¦‚èªªèˆŠçš„ Index å¯ä»¥å–æ¶ˆ Replica / ç§»åˆ°è¼ƒå·®çš„ç¡¬é«” / å–®ç¨å‚™ä»½ / æ•´å€‹ç æ‰(æ•ˆç‡é æ¯”ç  document å¥½)\nç¸½çµ ç¤™æ–¼ç¯‡å¹…ï¼Œå…¶ä»–é‚„æœ‰è™•ç†è‡ªç„¶èªè¨€ / åœ°ç†ä½ç½®è³‡æ–™ / å¯¦éš›ä¸Šç·šçš„æ³¨æ„äº‹é …ç­‰ç­‰é€²éšè­°é¡Œï¼Œåªèƒ½ç­‰ä¹‹å¾ŒçœŸçš„æœ‰ç”¨ä¸Šå†ä¾†åˆ†äº«\n","date":"2020-07-15T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-07-15-elasticsearch-%E6%95%99%E5%AD%B8-api-%E6%93%8D%E4%BD%9C/","title":"Elasticsearch æ•™å­¸ - API æ“ä½œ"},{"content":"æœ€è¿‘æœ‰ä¸€äº›è‡ªå»ºæœå°‹å¼•æ“çš„éœ€è¦ï¼Œæ‰€ä»¥æ‰¾ä¸Šäº† Elasticsearch é€™ä¸€å¥—é–‹æºçš„åˆ†æ•£å¼çš„ NoSQL Databaseï¼Œé€™ä¸€ç¯‡æ–‡ç« ä¸»è¦åˆ†äº«è‡ªå·±å¦‚ä½•è©•ä¼° Elasticsearchï¼Œè‘—é‡åœ¨ç³»çµ±çš„æ¶æ§‹èˆ‡å…§éƒ¨å¯¦ä½œæ©Ÿåˆ¶ï¼Œæ•™å­¸é è¨ˆæœƒæ‹‰åˆ°å¦å¤–ä¸€ç¯‡æ–‡ç« \nä»¥ä¸‹å…§å®¹å¤§å¤šåƒè€ƒæ­¤æœ¬æ›¸ï¼šã€ŠElasticsearch: The Definitive Guide: A Distributed Real-Time Search and Analytics Engineã€‹ï¼Œé›–ç„¶æ˜¯ 2015 çš„æ›¸ï¼Œä½†å…§å®¹ç›¸ç•¶çš„è±å¯Œï¼Œé‚„æœ‰è±å¯Œçš„å…§éƒ¨å¯¦ä½œæ©Ÿåˆ¶/Clusteræ¶æ§‹ç­‰ç­‰çš„è£œå……ï¼Œé™¤äº† api æœ‰äº›åƒæ•¸è¦æ›´æ–°å¤–ï¼Œä¸æœƒå› ç‚ºæ™‚é–“è€ŒæŠ¹æ»…ä»–çš„åƒ¹å€¼ï¼ŒåŒ…å«äº†æœ‰è¶£çš„æµªæ¼«æ•…äº‹\nElasticsearch åŸä½œè€…å…¶å¯¦æ˜¯ç‚ºäº†å¹«è€å©†å¯«ä¸€å€‹é£Ÿè­œæœå°‹å¼•æ“è€Œé–‹å§‹çš„ï¼Œä½†éäº†å¥½å¹¾å¹´ Elasticsearch éƒ½è®Šæˆå…¬å¸äº†ä½†è€å©†ä¾ç„¶é‚„æ²’æ‹¿åˆ°èªªå¥½çš„é£Ÿè­œæœå°‹å¼•æ“\u0026hellip;. (æˆªè‡³ 2015å¹´)\nTerminology èˆ‡åŸºç¤ä»‹ç´¹ Elasticsearch æ˜¯å»ºæ§‹åœ¨ Lucene é€™å€‹ Java é–‹ç™¼çš„æœå°‹å¼•æ“ä¸Šï¼Œå¢åŠ äº†åˆ†æ•£å¼èˆ‡ API å‘¼å«çš„ä»‹é¢ï¼›\nè³‡æ–™å±¤ç´šåˆ†æˆ Index \u0026gt; Documentï¼Œæ¯å€‹ Index ç•¶ç¬¬ä¸€ç­† Document å»ºç«‹å¾Œæœƒæœ‰éš±å¼çš„æ¬„ä½å‹åˆ¥ï¼Œå¾ŒçºŒçš„ Document éƒ½è¦éµå®ˆå‹åˆ¥ï¼Œå…¶ä¸­ Index é€™å€‹è©è »å®¹æ˜“èª¤æœƒï¼Œå› ç‚ºä»–é™¤äº†ä»£è¡¨æœ€ä¸Šå±¤çš„è³‡æ–™é›†åˆå¤–ï¼Œä¹Ÿä»£è¡¨ç´¢å¼•çš„åŒç¾©è©\nElasticsearch å„²å­˜æ™‚æ˜¯ç”¨ JSON æ ¼å¼ï¼Œå¯ä»¥å°æ¯å€‹æ¬„ä½è¨­å®šå‹åˆ¥ï¼ŒåŒæ™‚å¯ä»¥æŒ‡å®šæ˜¯å¦æ”¯æ´å…¨æ–‡æœå°‹\nç‚ºäº†æ”¯æ´å…¨æ–‡æœå°‹ï¼ŒElasticsearch ä½¿ç”¨ Reverted indexï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€å¼µè¡¨ç´€éŒ„ä¸€å€‹è©åœ¨å“ªäº› Document ä¸­çš„æ¬„ä½å‡ºç¾é\nWarning: åœ¨ 6.x.x ç‰ˆæ™‚ Elasticsearch ç§»é™¤äº† Type å±¤ç´šï¼Œä¸»è¦æ˜¯å› ç‚ºç•¶ä¸€å€‹ Index ä¸‹æœ‰å¤šå€‹ Typeï¼Œå‡è¨­å¤šå€‹ Type æœ‰ç›¸åŒåç¨±çš„æ¬„ä½ï¼Œå°æ–¼ Lucence ä¾†èªªæœƒæŠŠå…©å€‹ç›¸åŒåç¨±æ¬„ä½éƒ½ç•¶ä½œåŒä¸€å€‹ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦å…©å€‹ä¸åŒ Type ä¸­ç›¸åŒåç¨±æ¬„ä½è¨­å®šä¸åŒå‹åˆ¥æ˜¯æœƒæ‹‹å‡ºéŒ¯èª¤çš„ (ex. Index ä¸‹æœ‰ User / Twitter å…©å€‹ Typeï¼Œä¸”å…©å€‹ Type éƒ½æœ‰ user_nameï¼Œå‰‡ user_name å¿…é ˆæ˜¯ç›¸åŒå‹åˆ¥)ï¼Œæ‰€ä»¥ç¶“éè€ƒé‡å¾Œå°±ç§»é™¤äº†\nåƒè€ƒæ–‡ä»¶ Removal of mapping types\nåœ¨å»ºç«‹ç´¢å¼•æ™‚ï¼ŒElasticsearch æœƒå°‡æ¬„ä½ç¶“é Analyzer è™•ç†ï¼Œä¹Ÿå°±æ˜¯ charaterizer -\u0026gt; tokenizer -\u0026gt; token filter\næ‰€ä»¥èƒ½å¤ æ”¯æ´åƒéæ¿¾ä»‹ç³»è© / å°‡æ–‡å­—è½‰æˆå°å¯«æˆ–æ˜¯åŒç¾©è©è½‰æ› / æ”¯æ´ä¸åŒèªè¨€çš„æ–·è©ç­‰éˆæ´»çš„èªè¨€è™•ç†æµç¨‹ï¼Œæ‰€ä»¥æ‰èƒ½å¤ æä¾›åˆ¥æ–¼ä¸€èˆ¬è³‡æ–™åº«æ­»æ¿çš„å…¨æ–‡æœå°‹\nåœ¨è³‡æ–™æ›´æ–°èˆ‡æŸ¥è©¢æ™‚ï¼ŒElasticsearch æä¾›è¿‘ä¹å³æ™‚çš„æ“ä½œï¼ŒåŒæ™‚æŸ¥è©¢æ”¯æ´ä¾ç…§æ¢ä»¶ç¯©é¸ (Filter) æˆ–æ˜¯ä¾æ“šé—œè¯åº¦æ’åº (Query)\nå‰è€…åƒæ˜¯ çµ¦æˆ‘ id æ˜¯ 123 çš„è³‡æ–™é€™é¡ yes/no å•é¡Œï¼›å¾Œè€…æ˜¯å›ç­” å¹«æˆ‘æ‰¾å‡ºè·Ÿ Mary ç›¸é—œçš„æ–‡æª” é€™é¡æ¨¡ç³Šæœå°‹çš„çµæœ\næ¶æ§‹ä»‹ç´¹ Elasticsearch æ”¯æ´åˆ†æ•£å¼ï¼Œå¯ä»¥åœ¨ Index å±¤ç´šæŒ‡å®šè¦ Sharding é…ç½®æ–¹å¼ï¼ŒShard æœ‰å…©ç¨®è§’è‰² Primary / Replicaï¼Œå‰è€…è² è²¬è®€å¯«è€Œå¾Œè€…è² è²¬å¾ Primary å‚™ä»½è³‡æ–™ä¸¦åˆ†æ•£è®€çš„æŸ¥è©¢ï¼Œæ¯ä¸€å€‹ Shard åŸ·è¡Œç¨ç«‹çš„ Luceneï¼Œå¯è¦–ç‚ºç¨ç«‹çš„ Worker å³ä½¿åœ¨å–®æ©Ÿä¸Šè·‘ï¼ŒElasticsearch ä¹ŸæœƒæŒ‰ç…§é…ç½®ï¼Œå°‡è³‡æ–™æ‹†åˆ†å„²å­˜\nå¦‚æœ Cluster æ­¤æ™‚å¢åŠ æ©Ÿå™¨ï¼ŒElasticsearch æœƒè‡ªå‹•å°‡ Shard åˆ†æ•£åˆ°å„å€‹ç¯€é»ä¸Šï¼Œå¦‚æœæœ‰ Replica å‰‡ç›¡å¯èƒ½åˆ†æ•£é¢¨éšªè®“æ¯å°æ©Ÿå™¨éƒ½æœ‰å‚™æ´è³‡æ–™ Cluster ä¹‹é–“æœƒæœ‰ä¸€å€‹ Masterï¼ŒMaster ä¸»è¦ç®¡ç†æ•´å€‹ Cluster / åŠ å…¥ã€ç§»é™¤ç¯€é» / å»ºç«‹ Index ç­‰ï¼Œä¾‹å¦‚æŸ¥è©¢/å¯«å…¥éƒ½æ˜¯å€‹ç¯€é»èƒ½å¤ ç¨ç«‹å®Œæˆï¼Œæ‰€ä»¥ä¸éœ€è¦æ“”å¿ƒ Master æœƒæˆç‚ºç³»çµ±çš„ Single Point of Failure\nç¯€é»ç™¼ç”Ÿå•é¡Œï¼ŒCluster æœƒè‡ªå‹•ç¥¨é¸ Master ä¸¦é‡æ–°åšè³‡æ–™æ¬ç§»çš„å‹•ä½œ å¯¦éš›ä¸Š Node æœ‰åˆ†å¾ˆå¤šé¡å‹ï¼Œåƒæ˜¯ Master Node è² è²¬ç®¡ç† Cluster / Data Node å„²å­˜è³‡æ–™ / Ingest Node é è™•ç†æµç¨‹ç­‰ç­‰\næœå‹™è©•ä¼° ä¸»è¦æ˜¯é‡å°å„ç¨®ç¶­é‹ä¸Šçš„é»é€²è¡Œè€ƒé‡ï¼Œçœ‹åˆ° åˆ†æ•£å¼è³‡æ–™åº«éƒ½æœƒæœ‰ä¸‰å€‹ç‰¹é»\n**Replica**: è³‡æ–™å¦‚ä½•å‚™æ´ **Sharding**: å¦‚ä½•æ‹†åˆ†è³‡æ–™é›† **Cluster**: å¦‚ä½•æ°´å¹³æ“´å±•æ©Ÿå™¨ ä¸€èˆ¬ä¾†èªªåˆ†æ•£å¼è³‡æ–™åº«çš„ Replica éƒ½æ˜¯ç”± active slave æ“”ä»»ï¼Œå³æ™‚å‚™ä»½æ‰€æœ‰çš„æ›´æ–°ï¼ŒåŒæ™‚èƒ½å¤ æ”¯æ´è®€å–çš„åˆ†æ“”ï¼Œå„å®¶æä¾›çš„åŠŸèƒ½éƒ½å·®ä¸å¤šï¼›\nè‡³æ–¼ Cluster / Sharding å‰‡å„å®¶è³‡æ–™åº«çš„å¯¦ä½œèˆ‡è€ƒé‡å„æœ‰ä¸åŒï¼ŒåŒæ™‚è€ƒé‡åˆ° CAP åœ¨å¯ç”¨æ€§èˆ‡è³‡æ–™ä¸€è‡´æ€§ä¹‹é–“åšå–æ¨é€™æ˜¯æˆ‘è¦ºå¾—æœ€æœ‰è¶£çš„åœ°æ–¹\nå¯¦éš›è©•ä¼°ä¸Šæœƒå»æ€è€ƒä»¥ä¸‹å¹¾å€‹æ¡ˆä¾‹ï¼ŒåŒæ™‚ä»¥æˆ‘æ¯”è¼ƒç†Ÿæ‚‰çš„ MongoDB / Redis ä½œç‚ºå°æ¯”\nåŸºç¤è³‡æ–™åº«\na. å¯«è³‡æ–™æ™‚å¦‚ä½•ä¿è­‰ Durability\nb. Concurrency ä¸‹çš„ Consistency ä¿è­‰æ˜¯ä»€éº¼ Sharding\na. Sharding çš„ä¾æ“šæ˜¯ä»€éº¼ / æ˜¯å¦èƒ½å¤ å‹•æ…‹å¢æ¸› shard\nb. Query å¦‚ä½• routing åˆ°æ­£ç¢ºçš„ shard ä¸Šé¢ Cluster\na. Cluster åŸºæœ¬æ¶æ§‹è¦å¦‚ä½•æ­å»º\nb. Cluster èª¿æ•´æ™‚éœ€è¦åšä»€éº¼æ”¹å‹•\nc. Cluster å¢æ¸› node æ™‚æœƒæœ‰ä»€éº¼è®ŠåŒ–\nd. Cluster åœ¨ä»€éº¼æƒ…æ³ä¸‹æœƒä¸å¯ç”¨ åŸºç¤è³‡æ–™åº« å¯«è³‡æ–™æ™‚å¦‚ä½•ä¿è­‰ Durability Elasticsearch ç‚ºäº†å¹³è¡¡ Durability èˆ‡æ•ˆèƒ½ï¼Œæ‰€ä»¥ç•¶ Reverted Index å»ºç«‹å¾Œå°±æ˜¯ ä¸å¯è®Š immutableçš„ï¼Œé€™æ¨£çš„å¥½è™•æ˜¯æ€§èƒ½å¸¶ä¾†å¾ˆå¤§çš„æå‡ï¼Œè³‡æ–™è¼‰å…¥ memory å¾Œä¸ç”¨æ“”å¿ƒæœƒè®Šå‹• / mulit thread ä¹Ÿä¸ç”¨æ“”å¿ƒè³‡æ–™éæœŸçš„å•é¡Œç­‰ç­‰\nä½†è³‡æ–™ä¸å¯é¿å…æœƒé‡åˆ°æ›´æ–°æˆ–åˆªé™¤çš„éœ€æ±‚ï¼Œæ‰€ä»¥ Elasticsearch æ¡ç”¨ Segment æ–¹å¼ï¼Œæ¯æ¬¡å»ºç«‹ Index å¾Œå°±æ˜¯ä¸€å€‹ç¨ç«‹çš„ Segmentï¼Œç´¯ç©ä¸€æ‰¹ä¿®æ”¹å¾Œåœ¨å»ºç«‹ä¸€å€‹æ–°çš„ Segment\næŸ¥è©¢è³‡æ–™æ™‚å°±åŒæ™‚æŸ¥æ‰¾å¤šå€‹ Segmentï¼Œå¦‚æœåŒç­†è³‡æ–™åœ¨å¤šå€‹ Segment éƒ½æœ‰ç´€éŒ„ï¼Œå‰‡æ¡å–æœ€æ–°ä¸€ç­†çš„è³‡æ–™\nå¯¦éš›çš„Elasticsearch å…§éƒ¨å„²å­˜æ©Ÿåˆ¶çš„æ–¹å¼åƒè€ƒä¸‹åœ–\nå„²å­˜æ©Ÿåˆ¶å¦‚ä¸‹\næ–°çš„ä¿®æ”¹ç”¢ç”Ÿï¼Œå¯«é€² in-memory buffer ä¸­ï¼Œæ­¤æ™‚è³‡æ–™ä¸èƒ½è¢«æœå°‹ [Refresh] å›ºå®šæ™‚é–“ refresh åˆ° file cache (ç°è‰²çš„ Segmentï¼Œä»£è¡¨é‚„æ²’çœŸæ­£å„²å­˜åˆ°ç¡¬ç¢Ÿä¸Š)ï¼Œæ­¤æ™‚è³‡æ–™å¯ä»¥è¢«æœå°‹ (é è¨­æ¯ 10ç§’) [Flush] å›ºå®šæ™‚é–“ file cache é€é fsync å¯«å…¥ç¡¬ç¢Ÿï¼Œæ­¤æ™‚æ‰æ˜¯çœŸæ­£çš„æŒä¹…åŒ– (é è¨­æ¯ 30åˆ†é˜æˆ–æ˜¯ Translogéå¤§æ™‚) æ¯æ¬¡ Flush æœƒç”¢ç”Ÿæ–°çš„ Segmentï¼Œä½†å¦‚æœ Segment å¤ªå¤šæœƒé€ æˆæª”æ¡ˆéå¤šæ€§èƒ½åè€Œä¸‹é™ï¼Œæœƒå›ºå®šæ™‚é–“åˆä½µå¤šå€‹ Segment\nä½†è¦å°å¿ƒ Segment åˆä½µæœƒåƒæ‰å¤§é‡çš„è¨˜æ†¶é«”èˆ‡ CPUï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½å¤ å¤ªé »ç¹ï¼Œå¯ä»¥æŒ‡å®š max_num_segments åƒæ•¸ Translog æ˜¯ç‚ºäº†ç¢ºä¿ 2~3 æ­¥é©Ÿå¦‚æœæ©Ÿå™¨ç™¼ç”Ÿå•é¡Œï¼Œå¯ä»¥é€é Translog å›å¾©è³‡æ–™\nTranslog å°‡æ¯ç­†æ“ä½œé †åºå¯«å…¥ç¡¬ç¢Ÿï¼Œç•¶ç¬¬ä¸‰æ­¥ flush å¾Œä¸€ä½µæ¸…ç©º\nä½† Translog æœ¬èº«ä¹Ÿæœ‰ fsync çš„é »ç‡ï¼Œé è¨­æ˜¯ 5 ç§’é˜ï¼Œæ‰€ä»¥æœ‰æ©Ÿæœƒä¸Ÿå¤± 5ç§’é˜å…§çš„è³‡æ–™ Redis åœ¨æŒä¹…åŒ–ä¿å­˜æœ‰åˆ† RDB èˆ‡ AOFï¼ŒRDB æ˜¯é€éä¿å­˜æ•´ä»½ Snapshot / AOF å‰‡æ˜¯å¯«å…¥æ¯ç­†æ“ä½œ log é è¨­æ¯ç§’ fsync åˆ°ç¡¬ç¢Ÿä¸Š\nConcurrency ä¸‹çš„ Consistency ä¿è­‰æ˜¯ä»€éº¼ å° Elasticsearch é€²è¡Œå¯«å…¥æ“ä½œæ™‚ï¼Œé‡å° Request Level å¯ä»¥åšä¸åŒçš„ä¿è­‰æ€§ï¼Œé è¨­æ˜¯ syncï¼Œä¹Ÿå°±æ˜¯ Primary + Replica éƒ½å¯«å…¥æˆåŠŸæ‰è¿”å›ï¼Œè³‡æ–™ä¸ç”¨æ“”å¿ƒæœƒä¸è¦‹ï¼›\nå¯ä»¥èª¿æ•´æˆ asyncï¼Œåªè¦ Primary å¯«å…¥æˆåŠŸå°±è¿”å›ï¼Œä½†å¯èƒ½è³‡æ–™æœƒä¸è¦‹ï¼› ä½†æ›¸ä¸­æåˆ°å»ºè­°é‚„æ˜¯ç”¨ syncï¼Œå› ç‚ºå¦‚æœ Elasticsearch æ­¤æ™‚è² è¼‰è¼ƒé«˜ï¼Œå¯ä»¥è®“ Request è¼ƒæ™šå›è¦†ç”¢ç”Ÿ back preasureï¼Œå¦å‰‡å¯èƒ½æœƒè®“ç³»çµ±ä¹˜è¼‰éå¤šçš„ Query\nåœ¨ä½µç™¼çš„ç‹€æ³ä¸‹ï¼ŒElasticsearch æ¡ç”¨æ¨‚è§€é–ï¼Œé€é_versionå»æ¯”å°æ›´å‹•æ˜¯å¦ç‚ºæ­£ç¢ºçš„ç‰ˆæœ¬ï¼Œé è¨­çš„_version æ˜¯éå¢çš„æ•¸å­—ï¼Œä¹Ÿå¯ä»¥ç”¨è‡ªå®šç¾©çš„ _version\nSharding Sharding çš„ä¾æ“šæ˜¯ä»€éº¼ / æ˜¯å¦èƒ½å¤ å‹•æ…‹å¢æ¸› shard Elasticsearch åœ¨å»ºç«‹ Index æ™‚ï¼Œå¯ä»¥æŒ‡å®š sharding çš„æ•¸é‡ï¼Œè¨­å®šå¾Œå¦‚æœè¦æ›´å‹•ï¼Œå°±å¿…é ˆè¦å…ˆé—œé–‰ Index å¯«å…¥ä¸¦èª¿æ•´è¨­å®š è‡³æ–¼è³‡æ–™å¦‚ä½•åˆ†é…åˆ° shardï¼Œå‰‡æ˜¯ç”±å…§éƒ¨çš„ hash function å° id åšé‹ç®—ï¼ŒElasticsearch æœƒè‡ªå‹• balance è³‡æ–™\nMongoDB å‰‡æ˜¯éœ€è¦å° collection æŒ‡å®š shard keyï¼Œå¯ä»¥åˆ†æˆ range shard / hash shardï¼Œå‰è€…å¯è‡ªå·±æŒ‡å®š shard è¦å„²å­˜çš„ key ç¯„åœï¼Œå¾Œè€…åŒæ¨£æœ‰å…§éƒ¨ hash function æ±ºå®šï¼ŒMongoDB æœƒè‡ªè¡Œè² è²¬ balanceï¼›\nRedis cluster é è¨­æœ‰ 16384 å€‹å‘ï¼Œé€é hash é‹ç®—(CRC16 mod 16384)åˆ†æ•£ key åˆ°ç¾æœ‰çš„ Node ä¸Šé¢ï¼Œå¦‚æœå‹•æ…‹å¢æ¸› cluster Redis æœƒè‡ªè¡Œè™•ç†è³‡æ–™æ¬ç§»\nQuery å¦‚ä½• routing åˆ°æ­£ç¢ºçš„ shard ä¸Šé¢ Elasticsearch æ¯ä¸€å€‹ Node éƒ½èƒ½å¤ è™•ç† Queryï¼Œæœƒåœ¨å…§éƒ¨è‡ªå·± routing åˆ°è³‡æ–™æ‰€åœ¨çš„ Node ä¸Šï¼Œå¦å¤–ç‚ºäº†æ•ˆèƒ½ï¼Œå¦‚æœæ˜¯è®€å–ä¸”æœ‰ replicaï¼ŒElasticsearch æœƒç”¨ Round-Robin å»åˆ†æ•£è®€å–çš„å£“åŠ›\nMongoDB å‰‡éœ€è¦ Mongos å»è™•ç† queryï¼Œæ‰€ä»¥å¤šä¸€å€‹æœå‹™è¦æ¶è¨­ï¼Œä¹Ÿé€ æˆæœå‹™å¤šä¸€å€‹ä¸­æ–·çš„å¯èƒ½ï¼›\nRedis Cluster ä¹Ÿæ˜¯æ¯ä¸€å€‹ Node éƒ½èƒ½è™•ç† Query\nCluster Cluster åŸºæœ¬æ¶æ§‹è¦å¦‚ä½•æ­å»º Elasticsearch åœ¨ Cluster æ¶æ§‹ä¸Šéå¸¸å½ˆæ€§ï¼Œè¦å¹¾å€‹ Node éƒ½å¯ä»¥ï¼ŒåŒæ™‚å¯ä»¥é‡å°ä¸åŒçš„ Indices å»èª¿æ•´ sharding / replica æ•¸é‡ï¼ŒElasticsearch æœƒä»¥å®¹éŒ¯åº¦æœ€é«˜çš„æ–¹å¼è‡ªå‹•åˆ†é…\nä½†å»ºè­°é‚„æ˜¯ Cluster é‚„æ˜¯ 3 å°ä»¥ä¸Šï¼Œæ‰å¯ä»¥è®“å¯ç”¨æ€§æ›´é«˜\nå¦‚æœåªæœ‰å…©å°ï¼Œç™¼ç”Ÿ Network partitioningï¼Œå‡è¨­è¦ä¿è­‰ Consistency è¦éå¤šæ•¸çš„å° Cluster èƒ½å¤ é‹ä½œ(é¿å… split brain)ï¼Œå‰‡å…©é‚Šå„ä¸€å°å°±æœƒæœå‹™ä¸­æ–·ï¼Œåœ¨ Network partitioning ä¸‹æ²’æœ‰ä»»ä½•çš„å®¹éŒ¯æ€§\næ‰€ä»¥ Cluster åŸºæœ¬éƒ½ 3å°èµ·è·³ä¸”é¸æ“‡å¥‡æ•¸\nMongoDB Cluster åªå°‘è¦ 3 å€‹ Node (è‡³å°‘å…©å€‹å¯å„²å­˜çš„ Node)ï¼Œå¦‚æœæ˜¯ Sharding Cluster å‰‡éœ€è¦ Config Server (3å°) + Replica set (3å°èµ·è·³) * nï¼Œå¤–åŠ  Mongos\nRedis Cluster å‰‡ä¹Ÿæ²’æœ‰é™åˆ¶ï¼Œè¦åŠ å¹¾å€‹ Node éƒ½å¯ä»¥ï¼Œå¦‚æœè¦å‚™æ´å‰‡è¨­å®š slave node\nCluster èª¿æ•´æ™‚éœ€è¦åšä»€éº¼æ”¹å‹• Elasticsearch å†å¢åŠ æ–°çš„ Cluster Node æ™‚ä¸éœ€è¦é¡å¤–çš„è¨­å®šï¼Œåªè¦ç¢ºä¿ Network å¯ä»¥ multicast ä¸”è¨­å®šåŒä¸€å€‹ cluster nameï¼Œå°±æœƒè‡ªå·±åŠ é€²å»\nMongoDB éœ€è¦æ”¹ Config Server è¨­å®šæª” / Redis Cluster ä¹Ÿæ˜¯\nCluster å¢æ¸› node æ™‚æœƒæœ‰ä»€éº¼è®ŠåŒ– Elasticsearch å†è¨­å®šæª”ï¼Œå¯ä»¥æŒ‡å®š Primary èˆ‡ Replica çš„æ•¸é‡ï¼Œä¸¦å¹³å‡åˆ†æ•£åˆ°æ¯ä¸€å€‹ Node ä¸Š\nä¾‹å¦‚èªª Primary 2 + replica 1ï¼Œå‰‡æœƒç”¢ç”Ÿ P1 / P2 + R1 / R2ï¼Œå‡è¨­ç›®å‰æœ‰å…©å€‹ Node ä»–æœƒè‡ªå‹•åˆ†é…æˆ P1 + R2 / P2 + R1 åˆ†æ•£é¢¨éšªï¼Œæ›äº†ä¸€å°è³‡æ–™ä¹Ÿä¸æœƒæ‰\nMongoDB çš„ Cluster Node ä¸»è¦æœ‰å…©ç¨® secondary / åƒ…æŠ•ç¥¨ç”¨çš„ Arbiter (æ’‡é™¤ Primary)\nRedis Cluster æ²’æœ‰ç‰¹åˆ¥å€åˆ† Node æ€§è³ª\nCluster åœ¨ä»€éº¼æƒ…æ³ä¸‹æœƒä¸å¯ç”¨ Elasticsearch / MongoDB / Redis Cluster é€™æ–¹é¢éƒ½æ˜¯é¡ä¼¼çš„ï¼Œç•¶ç™¼ç”Ÿ partitioning æ™‚ï¼Œåªæœ‰è¶…éåŠæ•¸çš„ cluster å¯ä»¥é‹ä½œ\n","date":"2020-07-08T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-07-08-elasticsearch-%E7%B3%BB%E7%B5%B1%E4%BB%8B%E7%B4%B9%E8%88%87%E8%A9%95%E4%BC%B0/","title":"Elasticsearch ç³»çµ±ä»‹ç´¹èˆ‡è©•ä¼°"},{"content":"ä¸€èˆ¬çš„ API Endpoint è¨­è¨ˆæ¡ç”¨ RESTful APIè¦ç¯„ï¼Œä¸é RESTful æ¯”è¼ƒæŒ‡ç¨±çš„æ˜¯ Client/Server çš„æ¶æ§‹è¨­è¨ˆè€Œä¸æ˜¯ä¾·é™æ–¼ API Endpoint çš„è¨­è¨ˆè¦ç¯„ï¼Œæ›´æº–ç¢ºçš„èªªæ³•æ˜¯ HTTP + JSON æ ¼å¼ï¼Œä½”æ“šå¤šæ•¸çš„ API è¨­è¨ˆè¿‘ä¸€äºŒåå¹´ (SOAP/WSDL å› ç‚ºå·¥ä½œä¸­æ²’æœ‰ä½¿ç”¨éå°±ä¸æè¿°)\nä½†å› æ‡‰æ–°çš„ç¶²è·¯æ‡‰ç”¨ç¨‹å¼ï¼Œä¸æ–·æœ‰æ–°çš„è¨­è¨ˆå˜—è©¦å»æ›´é€² API è¨­è¨ˆï¼Œè¿‘å¹´æœ‰ Facebook æå‡ºäº† GraphQLï¼Œå°‡è®€å–è³‡æ–™çš„å½ˆæ€§äº¤é‚„çµ¦ Clientï¼Œé©æ‡‰å¤šå±å¹•å¤šè£ç½® Client çš„æ‡‰ç”¨å ´æ™¯\nåˆæˆ–æ˜¯ä»Šå¤©è¦æ¢è¨çš„ gRPCï¼Œç”± Google åŸºæ–¼ http/2 æå‡ºä¸”å»£æ³›æ‡‰ç”¨åœ¨å¾®æœå‹™æ¶æ§‹ä¸­ï¼Œä¸»è¦å¸Œæœ›æ”¹å–„å¹¾å€‹å•é¡Œ\nAPI æ–‡ä»¶åŒ–èˆ‡ Client å¯¦ä½œç¹é›œ\nä¸€èˆ¬çš„ API è¨­è¨ˆæ˜¯ Server é–‹å¥½ HTTP endpoint å¾Œï¼Œå®šç¾©å¥½åƒæ•¸ä¸¦æ’°å¯«æ–‡ä»¶ï¼Œæ¥è‘— Client å†é–±è®€æ–‡ä»¶å¯¦ä½œï¼›\nå¥½è™•æ˜¯è§£è€¦çš„å¾ˆå¾¹åº•ï¼Œä¸ç®¡æœ‰å¹¾å€‹ Client æˆ–æ˜¯ä½¿ç”¨ä»€éº¼ç¨‹å¼èªè¨€ï¼ŒæŒ‰ç…§ API ä»‹é¢å¯¦ä½œå³å¯ï¼› ä½†åŒæ¨£çš„è¦ç¶­è­·æ™‚ç›¸å°æˆæœ¬ä¹Ÿæ¯”è¼ƒé«˜ï¼Œåƒæ˜¯åƒæ•¸çš„åç¨±èˆ‡å‹åˆ¥ï¼Œéƒ½å¿…é ˆé›™æ–¹å»ç¶­è­·èˆ‡é–±è®€æ–‡ä»¶ï¼Œå†ç”¨ç¨‹å¼ç¢¼å¯¦ä½œï¼Œä¸­é–“å¤šäº†ä¸€å±¤çš„è½‰æ› gRPC é è¨­æ¡ç”¨ protocol buffer ç•¶ä½œ IDL (ä»‹é¢å®šç¾©èªè¨€)ï¼Œå°‡ Endpoint æä¾›çš„æœå‹™/åƒæ•¸/å›å‚³å€¼éƒ½å®šç¾©å¥½åç¨±èˆ‡å‹åˆ¥ï¼Œç•¶ä½œ Server / Client å¯¦ä½œçš„ Interfaceï¼Œå¤§å¹…é™ä½é›™æ–¹æºé€šçš„æˆæœ¬ å¢åŠ å‚³è¼¸æ•ˆç‡\ngRPC é è¨­ä½¿ç”¨ protocol buffer ç•¶ä½œç·¨ç¢¼/è§£ç¢¼å‚³è¼¸å…§å®¹ï¼Œæ¯”ç”¨æ–‡å­—æè¿°çš„ JSON åœ¨æª”æ¡ˆå¤§å°èˆ‡ç¶²è·¯å‚³è¼¸æ•ˆç‡ä¸Šæ›´å…·å‚™å„ªå‹¢ï¼Œå°ˆæ¡ˆä¸­æœ‰æä¾› Android client benchmarkï¼ŒgRPC çš„å»¶é²é æ¯” JSON è¦å¿«ä¸Šè¨±å¤š æ‡‰ç”¨å½ˆæ€§ å‚³çµ±çš„ HTTP å°±æ˜¯ Request/Response ä¸€ä¾†ä¸€å¾€ï¼Œåœ¨ grpc ä¸­ç¨±ç‚º Unary Callï¼Œä½†æ˜¯ gRPC é¡å¤–æä¾› streamingï¼Œå¯ä»¥åˆ†æ‰¹åœ¨åŒä¸€å€‹ request response ä¸­å‚³é€å¤šæ¬¡ payloadï¼Œè¨­è¨ˆæ›´æœ‰å½ˆæ€§çš„æºé€šæ–¹å¼ HTTP verb ä¸¦ç„¡æ³•å®Œæ•´æè¿°è³‡æºçš„æ“ä½œ ä¹‹å‰è¨­è¨ˆ API é ­ç—›çš„æ˜¯ HTTP çš„å‹•è© (GET/POST) ç­‰ç„¡æ³•å®Œæ•´æè¿°æ‰€æœ‰çš„æ“ä½œï¼Œä¾‹å¦‚èªªæ‰¹æ¬¡åˆªé™¤ï¼Œå¾Œä¾†åƒç…§ Google API è¨­è¨ˆæ–‡ä»¶æœ‰æ‰¾åˆ°è§£æ³•ï¼Œä½†é‚„æ˜¯æœ‰é€™éº¼ä¸€é»å½†æ‰­\næ¡ç”¨ gRPC å°±æ²’æœ‰é€™æ–¹é¢çš„è¦ç¯„(èˆ‡å›°æ“¾ ?! ç›®å‰ gRPC ç”± Google é–‹æºä¸¦ä¸»åŠ›ç¶­è­·ï¼Œæ¡ç”¨çš„å¤§å» ä¹Ÿæœ‰ä¸å°‘ï¼Œä¹Ÿæ”¯æ´è¨±å¤šç¨‹å¼èªè¨€ Java/JS(Nodejs \u0026amp; browser)/Python/PHP ç­‰ç­‰ï¼ŒAndroid/iOS App ä¹Ÿéƒ½æœ‰æ”¯æ´çš„ Libraryï¼›\nè§€å¿µä¸Šè¦æ‰¾åˆ°æ˜ å°„æ–¼ HTTP é‚„è »å®¹æ˜“çš„ï¼Œåƒæ˜¯ Http header å°æ‡‰ gRPC metadata / Http Status Code å°æ‡‰ gRPC ä¹Ÿæœ‰åŒæ¨£çš„å›å‚³æ ¼å¼\nä»¥ä¸‹å…§å®¹åŒ…å«\nprotocol buffer ç°¡ä»‹èˆ‡ç·¨ç¢¼æ©Ÿåˆ¶ gPRC å››ç¨®å‚³è¼¸æ–¹å¼ä»‹ç´¹èˆ‡ server ç«¯å¯¦ä½œ éŒ¯èª¤è™•ç†èˆ‡é©—è­‰æ©Ÿåˆ¶ (*Warning æœ‰å‘) ä½†ç›®å‰ä¸åŒ…å« Client side å¯¦ä½œ\nNodejs å¯¦ä½œ ä»¥ä¸‹æœƒå¯¦ä½œä¸€å€‹ç°¡å–®çš„ To-Do Listï¼Œdemo code æ–¼æ­¤ grpc-demo\nå®šç¾© .proto æª”æ¡ˆ åœ¨å°ˆæ¡ˆè·¯å¾‘ä¸‹ï¼Œå»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ ./protos æ”¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import \u0026#34;google/protobuf/empty.proto\u0026#34;; syntax = \u0026#34;proto3\u0026#34;; package ToDoService; message ToDoItem { string title=1; string author=2; bool isDone=3; double createDate=4; } message ToDoList { repeated ToDoItem ToDoList = 1; } message GetQueryOptions { string author = 1; } service ToDoService { rpc CreateToDo (ToDoItem) returns (ToDoList); rpc createMultiToDo (stream ToDoItem) returns (google.protobuf.Empty); rpc GetToDoListByAuthor (GetQueryOptions) returns (stream ToDoItem); rpc GetToDoListByAuthorOnFly (stream GetQueryOptions) returns (stream ToDoItem); } import å¯ä»¥å¾å…¶ä»–åœ°æ–¹è¼‰å…¥ proto æª”æ¡ˆä½¿ç”¨è£¡é¢çš„å®£å‘Š syntax = \u0026quot;proto3\u0026quot;;\næ¨™è¨»ä½¿ç”¨ protobuffer version message å®£å‘Šå‹åˆ¥åç¨± { å‹åˆ¥ åƒæ•¸å = é †åº}\nå‹åˆ¥éƒ¨åˆ†å¯ä»¥åƒè€ƒå®˜ç¶²ï¼Œæœ‰æä¾› int / uint / float / string ç­‰å¤šæ¨£åŸºç¤å‹åˆ¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šç¾©å‹åˆ¥ï¼›\né †åºçš„éƒ¨åˆ†ï¼Œå¾ 1 é–‹å§‹ä¸€è·¯éå¢ï¼Œå‹åˆ¥å…§éƒ¨çš„åƒæ•¸é †åºä¸èƒ½é‡è¤‡ï¼Œä¸”è¶Šå°çš„æ•¸å­—é€šå¸¸æ˜¯è¶Šå¸¸ä½¿ç”¨åˆ°çš„åƒæ•¸ï¼Œè©³è¦‹å¾ŒçºŒè£œå…… service æœå‹™åç¨± { rpc å‡½å¼åç¨± (åƒæ•¸) returns (å›å‚³å€¼) }\nå¦‚æœå¸Œæœ›å°‡ proto ç”¨æ–¼ rpcï¼Œå°±éœ€è¦å®£å‘Š service é¡åˆ¥ï¼Œstream è¡¨ç¤ºåƒæ•¸æˆ–å›å‚³å€¼å¯èƒ½æœƒæ˜¯æ‰¹æ¬¡å‚³é€ payload\né€™é‚Šå®šç¾©äº†å››å€‹å‡½å¼ï¼Œå»ºç«‹ ToDoItem / streaming æ‰¹æ¬¡å»ºç«‹ ToDoItem / ä¾ç…§ä½œè€…æ‰¹æ¬¡å–å¾— ToDoItem / å‹•æ…‹æ”¹è®Šæœå°‹ä½œè€…ä¸¦å‹•æ…‹ä¾ç…§æ¢ä»¶å›å‚³ ToDoItem Server side å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 const path = require(\u0026#39;path\u0026#39;); const grpc = require(\u0026#39;grpc\u0026#39;); const protoLoader = require(\u0026#39;@grpc/proto-loader\u0026#39;); const toDoServiceImplementations = require(\u0026#39;./implementations/todoService\u0026#39;); async function main() { const server = new grpc.Server(); const PROTO_PATH = path.join(__dirname, \u0026#39;./protos/todo.proto\u0026#39;); const packageDefinition = protoLoader.loadSync( PROTO_PATH, { keepCase: true, longs: String, enums: String, defaults: true, oneofs: true }); const toDoProto = grpc.loadPackageDefinition(packageDefinition).ToDoService; server.addService(toDoProto.ToDoService.service, toDoServiceImplementations); server.bind(\u0026#39;0.0.0.0:50051\u0026#39;, grpc.ServerCredentials.createInsecure()); server.start(); } main(); ä»¥ä¸Šæ­¥é©Ÿå¤§æ¦‚æ˜¯\nå»ºç«‹ grpc server instance è¼‰å…¥ä¸Šä¸€æ­¥å®šç¾©çš„ proto å°‡ proto èˆ‡å¯¦ä½œçš„ function çµåˆ server bind port ä¸¦é–‹å§‹é‹è¡Œ æ¥è‘—çœ‹ implementation éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 const grpc = require(\u0026#39;grpc\u0026#39;); let todoList = [ { title: \u0026#39;Hello\u0026#39;, author: \u0026#39;Hello2\u0026#39;, isDone: true, createDate: 1.4 }, { title: \u0026#39;Hello2\u0026#39;, author: \u0026#39;Hello\u0026#39;, isDone: true, createDate: 1.4 }, { title: \u0026#39;Hello3\u0026#39;, author: \u0026#39;Hello\u0026#39;, isDone: true, createDate: 1.4 }, { title: \u0026#39;world\u0026#39;, author: \u0026#39;world\u0026#39;, isDone: true, createDate: 1.4 }, { title: \u0026#39;world2\u0026#39;, author: \u0026#39;Hello\u0026#39;, isDone: true, createDate: 1.4 }, { title: \u0026#39;world3\u0026#39;, author: \u0026#39;Hello2\u0026#39;, isDone: null, createDate: \u0026#34;1.4\u0026#34; } ]; function CreateToDo(call, callback) { const clientToken = call.metadata.get(\u0026#39;token\u0026#39;)?.[0]; if(clientToken !== \u0026#39;Secret\u0026#39;){ return callback({ error: grpc.status.PERMISSION_DENIED, message: \u0026#34;No token\u0026#34; }) } todoList.push(call.request); if(todoList.length \u0026gt; 5){ return callback({ error: grpc.status.OUT_OF_RANGE, message: \u0026#34;too many ToDoItem\u0026#34; }) } callback(null, { ToDoList: todoList }) } async function createMultiToDo(call, callback) { call.on(\u0026#39;data\u0026#39;, (data) =\u0026gt; { todoList.push(data); }) call.on(\u0026#39;end\u0026#39;, () =\u0026gt; { callback(null, {}); }) } function GetToDoListByAuthor(call) { const author = call.request.author; async function main() { let isAny = false; for (const todoItem of todoList) { if (author === todoItem.author) { isAny = true; call.write(todoItem); await wait(1); } } if (isAny === false) { return call.emit(\u0026#39;error\u0026#39;, grpc.status.PERMISSION_DENIED) } call.end() } main() } async function GetToDoListByAuthorOnFly(call) { let author = null; call.on(\u0026#39;data\u0026#39;, (data) =\u0026gt; { console.log(data) author = data.author; main(); }); call.on(\u0026#39;end\u0026#39;, () =\u0026gt; { call.end(); }); async function main() { for (const todoItem of todoList) { if (author === todoItem.author) { call.write(todoItem); } await wait(3); } } } async function wait(sec) { return new Promise((res) =\u0026gt; setTimeout(() =\u0026gt; res(), sec * 1000)); } module.exports = { CreateToDo, createMultiToDo, GetToDoListByAuthor, GetToDoListByAuthorOnFly, } å¯ä»¥çœ‹åˆ° handle function å…±æœ‰å››ç¨®\nhandleUnaryCall(call, callback) // CreateToDo handleClientStreamingCall(call, callback) // createMultiToDo handleServerStreamingCall(call) // GetToDoListByAuthor handleBidiStreamingCall(call) // GetToDoListByAuthorOnFly æ‹†æˆ client / server å…©éƒ¨åˆ†\nå¦‚æœ client æ˜¯é€ unary dataï¼Œå‰‡ç›´æ¥å¾ call.request è®€å–å‚³é€å€¼ å¦‚æœ client æ˜¯é€ streaming dataï¼Œå‰‡ä½¿ç”¨ call.on('data', (data)=\u0026gt;{}) / call.on('end', ()=\u0026gt;{}) è™•ç†è³‡æ–™èˆ‡å‚³é€çµæŸ å¦‚æœ server æ˜¯é€ unary dataï¼Œå‰‡handle function ç¬¬äºŒå€‹åƒæ•¸ç‚º callbackï¼Œcallback å¸¸ç”¨å‰å…©å€‹åƒæ•¸ï¼Œä»£è¡¨ error è·Ÿ dataï¼Œå¦‚æœæ²’æœ‰éŒ¯èª¤å‰‡å›å‚³ callback(null, myData) å¦‚æœ server æ˜¯é€ streaming dataï¼Œå‰‡ç”¨ call.write(myData)ï¼ŒçµæŸå‚³é€å‘¼å« call.end() æ­é…çš„ GUI Client å·¥å…·å¯ä»¥åƒè€ƒ bloomrpcï¼Œè¼‰å…¥ proto æª”æ¡ˆå¾Œå°±æœƒè‡ªå‹•è·³å‡ºå®šç¾©çš„ service èˆ‡é æœŸçš„å›å‚³çµæœï¼Œç›¸ç•¶çš„æ–¹ä¾¿ï¼Œé€™ä¹Ÿæ˜¯ä½¿ç”¨ gRPC çš„ä¸€å¤§å¥½è™•\nå‚³å…¥å¤šé¤˜çš„åƒæ•¸æˆ–å‹åˆ¥éŒ¯èª¤ åœ¨ä½¿ç”¨é å…ˆå‹åˆ¥å®šç¾©çš„è¨­è¨ˆæ™‚ï¼Œä¸å…è…¦ä¸­æµ®ç¾å¦‚æœæˆ‘ä¸æŒ‰ç…§å®šç¾©çš„è©±æœƒæ€éº¼æ¨£ï¼Ÿ\nå¦‚æœæ˜¯å‚³å…¥å¤šé¤˜çš„å‹åˆ¥ï¼Œprotobuffer åœ¨ version 2 \u0026amp;\u0026amp; version 3.5 ä»¥ä¸Šæœƒä¿ç•™ï¼Œç›®å‰ç‰ˆæœ¬åˆ° 3.12 äº†\nå¦‚æœæ˜¯ å‹åˆ¥ä¸å°ï¼Œå…§éƒ¨æ¡ç”¨çš„ encode / decode æ˜¯åŸºæ–¼ protobufjsï¼Œæœƒä½¿ç”¨ Number / Boolean ç­‰ JS é¡åˆ¥ä¾†è½‰æ›å‹åˆ¥ï¼Œä¾‹å¦‚ number \u0026ldquo;123\u0026rdquo; å°±æœƒè®Šæˆ 123\néŒ¯èª¤è™•ç† æ ¹æ“šå‰é¢æ‰€æè¿°ï¼ŒServer å›æ‡‰æ™‚æœƒåˆ†æˆ Unary è·Ÿ Streamingï¼Œå…©ç¨®çš„éŒ¯èª¤å›å‚³æ©Ÿåˆ¶ä¸åŒï¼›\né€™éƒ¨åˆ†æœ‰é»å°å‘ï¼Œå®˜æ–¹ç¯„ä¾‹åªæœ‰ç¤ºç¯„ Unary Response æ™‚çš„éŒ¯èª¤è™•ç†ï¼Œä¹Ÿå°±æ˜¯å‘¼å« callback çš„ç¬¬ä¸€å€‹åƒæ•¸\n1 2 3 4 callback({ error: grpc.status.OUT_OF_RANGE, message: \u0026#34;too many ToDoItem\u0026#34; }) å…ˆå‰å®šç¾© service æ™‚ä¸¦æ²’æœ‰å®£å‘ŠéŒ¯èª¤å›å‚³ï¼Œé€™æ˜¯å› ç‚º gRPC å…§å»ºéŒ¯èª¤è¨Šæ¯ï¼Œæ ¼å¼å¦‚ä¸‹\n1 2 3 4 { string error string message } error å°æ‡‰æ–¼ HTTP status codeï¼Œå¯ä»¥å¾ grpc çš„éœæ…‹åƒæ•¸å–å¾—å¦‚ grpc.status.PERMISSION_DENIED ç­‰åŒæ–¼ 403ï¼Œmessage å‰‡æ˜¯è‡ªå®šç¾©çš„å­—ä¸²ï¼Œéœ€æ³¨æ„ Nodejs ä¸æ”¯æ´ rich formatï¼Œä»¥ä¸‹æˆªè‡ªå®˜æ–¹æ–‡ä»¶\nThis richer error model is already supported in the C++, Go, Java, Python, and Ruby libraries, and at least the grpc-web and Node.js libraries have open issues requesting it.\næ‰€ä»¥ gRPC client æ”¶åˆ°çš„éŒ¯èª¤è¨Šæ¯æœƒè¢«è½‰æˆ\n1 2 3 { \u0026#34;error\u0026#34;: \u0026#34;2 UNKNOWN: too many ToDoItem\u0026#34; } å¦å¤– Streaming response å‚³ééŒ¯èª¤çš„æ–¹å¼æ˜¯\n1 call.emit(\u0026#39;error\u0026#39;, grpc.status.PERMISSION_DENIED) emit error å¾Œæœƒè‡ªå‹• closeï¼Œç›®å‰åªæ”¯æ´ statusï¼Œä¸èƒ½å‚³éç‰©ä»¶ï¼Œå¦å‰‡ connection ç„¡æ³•è¢« closeï¼Œå‘¼å« call.end() ä¹Ÿæ²’æœ‰ç”¨\nå¦‚æœè¦æœ‰æ›´è±å¯Œçš„éŒ¯èª¤æ ¼å¼ï¼Œå°±éœ€è¦è‡ªå·±å®šç¾©äº†\né©—è­‰æ©Ÿåˆ¶ gRPC å…§å»ºå…©ç¨®é©—è­‰ç›¸é—œçš„æ©Ÿåˆ¶ï¼Œä¸€ç¨®æ˜¯ SSL/TLSï¼Œæä¾›é€šè¨Šä¸Šçš„é»åˆ°é»åŠ å¯†ï¼Œå¦ä¸€ç¨®æ˜¯ Google æœå‹™çš„ OAuth Token é©—è­‰æ©Ÿåˆ¶ï¼Œå¾Œè€…åƒ…é™æ–¼èˆ‡ Google æœå‹™å°æ¥æ‰æœ‰ç”¨ï¼›\nç•¶ç„¶ä¹Ÿå¯ä»¥ç”¨ middleware æ–¹å¼è‡ªè¡Œå¯¦ä½œé©—è­‰æ©Ÿåˆ¶\né©—è­‰æ©Ÿåˆ¶æœ‰å…©ç¨® scopeï¼Œä¸€ç¨®æ˜¯ Channel Levelï¼Œä¹Ÿå°±æ˜¯é©ç”¨æ–¼ gRPC é€£ç·šï¼Œå¦ä¸€å€‹æ˜¯ Call Levelï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å‘¼å«ï¼Œé€™éƒ¨åˆ†æ˜¯ä½¿ç”¨æ–¼ Client side\n1 2 var ssl_creds = grpc.credentials.createSsl(root_certs); var stub = new helloworld.Greeter(\u0026#39;myservice.example.com\u0026#39;, ssl_creds); é€™é‚Šç‚ºäº†å¯¦ä½œæ–¹ä¾¿æ€§ï¼Œå°‡ token æ”¾ç½®æ–¼ metadata ä¹‹ä¸­ï¼Œè¦å¾ server side è®€å–ä½¿ç”¨ call.metadata.get('Key') å³å¯\nCacheï¼Ÿ å¦ä¸€å€‹ HTTP (RESTful æ¶æ§‹ä¸‹) åŸæœ‰çš„è¨­è¨ˆæ˜¯ Cache æ©Ÿåˆ¶ï¼Œåˆåˆ†æˆ server / proxy / client ä¸‰è€…è™•ç†ï¼ŒgRPC çœ‹èµ·ä¾†æœ‰é¡ä¼¼çš„è¦åŠƒï¼Œä½†ç›®å‰é‚„åœ¨å¯¦é©—éšæ®µ Provide support for caching GRPC method response #7945\nProtocol buffer Encoding æ©Ÿåˆ¶ åƒè€ƒå®˜æ–¹æ–‡ä»¶ Protocol buffer Encodingï¼Œå…ˆå‰æåˆ° Protocol buffer æœƒå°‡è¨Šæ¯ç·¨ç¢¼æˆ binary æ ¼å¼ï¼Œè€Œ JSON å‰‡ç¶­æŒæ–‡å­—æ ¼å¼ï¼Œé€™é‚Šç°¡å–®ä»‹ç´¹ Protocol buffer ç·¨ç¢¼çš„éç¨‹\nVarints varints æ˜¯ä¸€ç¨®ç”¨å¤šå€‹ bytes è¡¨é”æ•¸å­—çš„æ–¹å¼ï¼Œé™¤äº†æœ€å¾Œä¸€å€‹ byte å¤–ï¼Œå…¶é¤˜ byte çš„ç¬¬ä¸€ä½å…ƒè¡¨ç¤ºå¾ŒçºŒæ˜¯å¦é‚„æœ‰ byteï¼Œbyte çš„é †åºç‚ºæœ€ä½æœ‰æ•ˆä½(è¶Šå‰é¢çš„ byte æ˜¯ä½ä½) least significant group first.ï¼Œæ‰€ä»¥å¯¦éš›ä¸Šæ¯å€‹ byte æ˜¯ç”¨ 7 bits è¡¨é”æ•¸å€¼\nä¾‹å¦‚èªª 1010 1100 0000 0010 ä»£è¡¨ 300ï¼Œå› ç‚º 1 010 1100 1 ä»£è¡¨å¾Œé¢é‚„æœ‰ byte ç›¸é€£ï¼Œ0 000 0010 0 å‰‡è¡¨ç¤ºä»–æ˜¯æœ€å¾Œä¸€å€‹ byte äº†ï¼›\nå› ç‚ºæœ€ä½æœ‰æ•ˆä½ï¼Œæ‰€ä»¥é‡çµ„æˆ 000 0010 010 1100ï¼Œä¹Ÿå°±æ˜¯ 300\nKey Value å…¶å¯¦ Protocol buffer å°±æ˜¯ç·¨ç¢¼ä¸€é€£ä¸²çš„ Key-Valueï¼Œåœ¨ç·¨ç¢¼æ™‚æœƒä»¥ ç·¨ç¢¼è™Ÿ(5 bits) é¡åˆ¥(3 bits) æ•¸å€¼è¡¨ç¤ºï¼Œä¾‹å¦‚èªª\n1 2 3 message Test2 { optional string b = 2; } å‡è¨­ b å„²å­˜äº† \u0026ldquo;testing\u0026rdquo;ï¼Œé‚£æ™‚è¨˜å¾—ç·¨ç¢¼çµæœæ˜¯ 12 07 74 65 73 74 69 6e 67ï¼Œæ‹†è§£ 12 æˆ 0001 0010 =\u0026gt; 00010 010 å°æ‡‰åˆ°æ¬„ä½ç·¨è™Ÿ 2 + æ•¸å€¼é¡åˆ¥ 2(ä»£è¡¨æ˜¯è‡ªè¨‚é•·åº¦çš„é¡åˆ¥ï¼Œå¦‚ string / object ç­‰)ï¼›\næ¥è‘— 07 è¡¨ç¤ºæ¥ä¸‹ä¾† 7 å€‹ bytes æ˜¯æ•¸å€¼è¡¨ç¤ºï¼›\nå¾ŒçºŒçš„æ•¸å€¼æ˜¯ utf-8 ç·¨ç¢¼çš„é¡¯ç¤º\næ¥è‘—çœ‹\n1 2 3 4 5 6 7 message Test1 { optional int32 a = 1; } message Test3 { optional Test1 c = 3; } å‡è¨­ Test1 a å„²å­˜ 150ï¼Œå‰‡ç·¨ç¢¼çµæœhex è¡¨ç¤ºç‚º 08 96 01ï¼Œä¹Ÿå°±æ˜¯ 00001 000 æ¬„ä½ç·¨è™Ÿ 1 + æ•¸å€¼ç·¨è™Ÿ 0 ä¹Ÿå°±æ˜¯ varintsï¼›\n96 01 å‰‡æ˜¯ 1001 0110 + 0000 0001 ä¸¦ä¾ç…§ varints è¡¨ç¤ºæ³•è½‰ä¹˜ 000 0001 001 0110 ä¹Ÿå°±æ˜¯ 150\næ¥è‘— Test3 å„²å­˜ Test1ï¼Œå‡è¨­ Test1 çš„ a ç­‰æ–¼ 150ï¼›\nhex è¡¨ç¤ºæ³•ç‚º 1a 03 08 96 01ï¼Œä¹Ÿå°±æ˜¯ 00011 010ï¼Œæ¬„ä½ 3çš„é¡åˆ¥æ˜¯ 2ï¼Œæ¥ä¸‹ä¾† 03 å…± 3 å€‹bytes ç‚ºæ•¸å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€æ­¥çš„ 08 96 01\nç¸½çµ gRPC æœƒå…¨é¢å–ä»£ HTTP + JSON å—ï¼Ÿ é€™å€‹å•é¡Œæˆ–è¨±æœ‰é»åƒ Deno æœƒä¸æœƒå…¨é¢å–ä»£ Nodejsï¼Œç¾åœ¨è«‡å¥½åƒæœ‰é»éæ—©ï¼Œç•¢ç«Ÿ HTTP + JSON è¡Œä¹‹æœ‰å¹´ï¼Œå¤šæ–¹å¹³å°çš„æ”¯æ´åº¦é‚„æ˜¯æ¯”è¼ƒå¥½ï¼ŒåŒ…å«åƒ Proxy ç­‰ä¸­ä»‹ç¶²è·¯æœå‹™\nä½†æ˜¯ gRPC åœ¨æŸäº›ç”¨é€”ä¸Šï¼ŒåŸºæ–¼é–‹ç™¼æ•ˆç‡ / å‚³è¼¸é€Ÿç‡ç­‰ï¼Œç¢ºå¯¦å¾ˆå€¼å¾—æŠ•è³‡èˆ‡å˜—è©¦çš„æŠ€è¡“\n","date":"2020-06-07T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-06-07-grpc-%E4%BB%8B%E7%B4%B9%E8%88%87-nodejs-%E5%AF%A6%E4%BD%9C%E5%88%86%E4%BA%AB/","title":"gRPC ä»‹ç´¹èˆ‡ Nodejs å¯¦ä½œåˆ†äº«"},{"content":"ä¹‹å‰åœ¨é–±è®€ ES6 ç›¸é—œæ•™å­¸æ™‚ï¼Œæœ‰æåŠ Proxy / Reflect é€™å…©å€‹æ–°çš„å…§å»ºç‰©ä»¶å‹åˆ¥ï¼ŒProxy ä¸»è¦æ˜¯ä½œç‚ºæŒ‡å®šç‰©ä»¶çš„ä»£ç†ï¼Œå¯ä»¥æ”¹å¯«ã€åµè½ç‰©ä»¶çš„å­˜å–èˆ‡æ“ä½œ / Reflect å‰‡æ˜¯ç”¨éœæ…‹æ–¹æ³•æ“ä½œç‰©ä»¶ï¼Œå®Œå–„ Proxy handler çš„å¯¦ä½œï¼›\nç•¶åˆæœ‰çœ‹æ²’æœ‰æ‡‚ï¼Œä¹Ÿæƒ³ä¸åˆ°æ‡‰ç”¨çš„å ´æ™¯ï¼Œç›´åˆ°æœ€è¿‘åœ¨é–‹ç™¼æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œé‡åˆ°è¦åŒ…è£ API è‡ªå‹• retry æ©Ÿåˆ¶\né‡å°ä¸åŒçš„ API éŒ¯èª¤é›†ä¸­åŒ–è™•ç†ï¼Œå¯èƒ½æ˜¯å–®ç´” retry æˆ–æ˜¯å‘¼å«å…¶ä»– API æ›æ–°çš„ token ä¹‹é¡çš„\nå¦‚æœè¦æ¯æ¬¡ api call æ™‚å» catch error ä¸¦è™•ç†æ˜¯ä¸€ä»¶éå¸¸é ­ç–¼ä¸”é›£ä»¥ç®¡ç†çš„äº‹æƒ…ï¼Œè‡¨æ©Ÿä¸€å‹•æƒ³åˆ° Proxy é€™å€‹å¥½å¹«æ‰‹ï¼Œç›®å‰ç”¨èµ·ä¾†è »é †åˆ©çš„ï¼Œä»¥ä¸‹åˆ†äº« Proxy / Reflect åŸºæœ¬ä»‹ç´¹ï¼Œä»¥åŠå¦‚ä½•æ‡‰ç”¨åœ¨ API retry æ©Ÿåˆ¶çš„å¯¦ä½œ\næ–‡ç« å…§å®¹å¤§å¤šåƒè€ƒè‡ª javascript.info: Proxy and Reflectï¼Œå€‹äººè¦ºå¾—å¯«å¾—æ¯” MDN è©³ç›¡ä¸”æ˜“æ‡‚\nProxy ç•¶æˆ‘å€‘åœ¨èª¿ç”¨ Proxy æ™‚ï¼Œæœƒé€™æ¨£å®£å‘Š\n1 var p = new Proxy(target, handler); target\nè¦è¢« Proxy ä»£ç†çš„ç‰©ä»¶å°è±¡ï¼Œåªè¦æ˜¯ Object å‹æ…‹éƒ½å¯ä»¥ï¼ŒåŒ…å« Array / Function ç­‰ï¼Œå¦‚æœä¸æ˜¯ Object å®£å‘Šæ™‚æœƒæ”¶åˆ°éŒ¯èª¤ 1 Uncaught TypeError: Cannot create proxy with a non-object as target or handler handler\né¸æ“‡è¦æŒ‡å®šè§¸ç™¼çš„æ™‚æ©Ÿï¼ŒProxy æœƒç”¢ç”Ÿæ‰€è¬‚çš„ trapï¼Œä¹Ÿå°±æ˜¯æ””æˆªç‰©ä»¶æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚æœæœªå®šç¾©å‰‡ç›´æ¥å‘¼å«åŸ Target åœ¨ç‰©ä»¶çš„æ“ä½œä¸Šï¼Œéƒ½æœƒæœ‰å°æ‡‰çš„å…§éƒ¨å‘¼å«æ–¹æ³•(internal methods)ï¼Œä¾‹å¦‚èªª new A() ä»£è¡¨å‘¼å«äº† A ç‰©ä»¶çš„ [[Contructor]] æ–¹æ³•ï¼Œå¸¸ç”¨çš„ get / set å¦‚ a.prop / a.prop = 'hello world' å‰‡åˆ†åˆ¥å‘¼å«äº† [[Get]] / [[Set]] ç­‰æ–¹æ³•ï¼Œè€Œ handler å‰‡æ˜¯å°æ‡‰é€™äº›æ–¹æ³•ç”¢ç”Ÿæ””æˆªçš„å®šç¾©\nå¦å¤–æœ‰äº›ç‰©ä»¶æœƒæœ‰å…§éƒ¨çš„å„²å­˜è³‡æ–™æ ¼å¼ï¼Œç¨±ç‚º internal slotï¼Œä¾‹å¦‚ Map çš„å…§éƒ¨è³‡æ–™æ ¼å¼æ˜¯ [[Mapdata]] è€Œä¸æ˜¯é€é [[Get]]/[[Set]]ï¼Œé€™é¡å‹å°±ä¸èƒ½é€é Proxy ä»£ç†\nåŸºæœ¬æ¡ˆä¾‹ - æ”¹å¯« get è¨­å®šé è¨­å€¼ æˆ‘å€‘å¸Œæœ›åœ¨å–å¾—é™£åˆ—æ™‚ï¼Œé‡åˆ°è¶…å‡ºç¯„åœå‰‡å›å‚³é è¨­å€¼ 0\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 let numbers = [0, 1, 2]; numbers = new Proxy(numbers, { get(target, prop, receiver) { if (prop in target) { return target[prop]; } else { return 0; // default value } } }); console.log(a[1]) // 1 console.log(a[-1]) // 0 åœ¨ handler ä¸­å®šç¾© get å¯ä»¥æ””æˆª [[Get]] å‘¼å«ï¼Œæœƒæ”¶åˆ°ä¸‰å€‹åƒæ•¸ target / prop / receiver\ntarget ç›®æ¨™ç‰©ä»¶ï¼Œä¹Ÿå°±æ˜¯ number æœ¬èº« prop\nå‘¼å«çš„å±¬æ€§åç¨± receiver:\nåŸ·è¡Œ target[prop] æ™‚çš„ this ä»£è¡¨å€¼ï¼Œé€šå¸¸æ˜¯ Proxy æœ¬èº«ï¼Œä½†å¦‚æœæ˜¯æœ‰ç¹¼æ‰¿ç­‰å¯¦ä½œæœƒä¸å¤ªä¸€æ¨£ï¼Œå¾ŒçºŒæœƒè£œå…… å¦å¤–æ–¹æ³•å‘¼å«ä¹Ÿæœƒè§¸ç™¼ getå–”ï¼Œä¾‹å¦‚ a.method()\nç¬¬äºŒå€‹æ¡ˆä¾‹ - æ”¹å¯« set çµ±ä¸€é©—è­‰æ–¹å¼ åœ¨å¯«å…¥è¡¨å–®æ™‚ï¼Œå¯èƒ½æœƒç”¨ä¸€å€‹ç‰©ä»¶æš«å­˜ç”¨æˆ¶çš„è¼¸å…¥ï¼Œä½†æ­¤æ™‚éƒ½éœ€è¦æ¬„ä½çš„é©—è­‰ï¼Œä¾‹å¦‚æ‰‹æ©Ÿè™Ÿç¢¼ / åœ°å€æ ¼å¼ç­‰ç­‰\nå¦‚æœè¦å°‡é‚è¼¯æ•£è½åœ¨æ¯ä¸€å€‹è¼¸å…¥å¾Œçš„ function æœ‰é»éº»ç…©\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 let numbers = []; numbers = new Proxy(numbers, { // (*) set(target, prop, val, receiver) { // to intercept property writing if (typeof val == \u0026#39;number\u0026#39;) { target[prop] = val; return true; } else { return false; } } }); numbers.push(1); // added successfully numbers.push(2); // added successfully alert(\u0026#34;Length is: \u0026#34; + numbers.length); // 2 numbers.push(\u0026#34;test\u0026#34;); // TypeError (\u0026#39;set\u0026#39; on proxy returned false) set æœƒæ”¶åˆ°å››å€‹åƒæ•¸ï¼Œä¸¦æ³¨æ„éœ€è¦å›å‚³ boolean è¡¨ç¤º set æ˜¯å¦æˆåŠŸ\nå…¶é¤˜åƒæ˜¯ construct / getPrototypeOf / ownKeys ç­‰ç­‰çš„æ–¹æ³•\nå¯¦éš›ä½¿ç”¨ - æ­£å¼ç’°å¢ƒè¤‡å¯« console è¡Œç‚º åœ¨é–‹ç™¼æ™‚ï¼Œç‚ºäº† debug æ–¹ä¾¿å›ç•™ä¸‹å¾ˆå¤š console å‘¼å«çš„æ–¹æ³•ï¼Œä½†å¦‚æœä¸Šåˆ°æ­£å¼æ©Ÿå¿˜è¨˜é—œé–‰å°±æœƒå¾ˆå°·å°¬ï¼›\nåŒæ™‚åƒ error / warning æœƒéœ€è¦ç”¨å…¶ä»–çš„æ–¹å¼é€å› server ç´€éŒ„éŒ¯èª¤ logï¼Œé¿å…æ­£å¼æ©Ÿé™¤éŒ¯ä¸æ˜“ï¼Œæ­¤æ™‚ç”¨ Proxy å»åŒ… console å°±æ˜¯ä¸€å€‹è »æ–¹ä¾¿çš„åšæ³•\n1 2 3 4 5 6 7 8 9 10 11 12 window.console = new Proxy(window.console, { get: function(target, prop, receive){ if(prop === \u0026#39;log\u0026#39; || prop === \u0026#39;debug\u0026#39;){ alert(\u0026#34;ä½ çœ‹ä¸è¦‹æˆ‘\u0026#34;); return ()=\u0026gt;{}; } return target[prop] } }) console.log() // å½ˆå‡º alert console.error(\u0026#34;123\u0026#34;) // ç…§å¸¸é¡¯ç¤º ç•¶ç„¶ä¹Ÿå¯ä»¥è‡ªå®šç¾© Log Class é”åˆ°ä¸€æ¨£çš„æ•ˆæœï¼Œä½†æœƒè¦ºå¾—ç”¨ console.log æ˜¯å€‹å¾ˆç›´è¦ºçš„åšæ³•ï¼Œå¦‚æœèƒ½ç”¨ Proxy å»æ”¹å¯«é”åˆ°ä¸€æ¨£çš„æ•ˆæœæ¯”è¼ƒæ–¹ä¾¿ (æ‡¶\nreceiver æ‡‰ç”¨ å‰›æ‰æåˆ° get ç¬¬ä¸‰å€‹åƒæ•¸ receiver æŒ‡çš„æ˜¯å‡½å¼åŸ·è¡Œ this æ‰€ä»£è¡¨çš„ç‰©ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 let user = { _name: \u0026#34;Guest\u0026#34;, get name() { return this._name; } }; let userProxy = new Proxy(user, { get(target, prop, receiver) { if(prop === Symbol.iterator || prop === Symbol.toStringTag || prop === Symbol.for(\u0026#39;nodejs.util.inspect.custom\u0026#39;)){ return; } console.log({ target, prop, receiver }) return target[prop]; // (*) target = user } }); let admin = { __proto__: userProxy, _name: \u0026#34;Admin\u0026#34; }; console.log(userProxy.name) // outputs: Guest console.log(admin.name);// Expected: Admin but outputs: Guest (?!?) å®£å‘Šä¸€å€‹ user ç‰©ä»¶ï¼Œä¸¦ç”¨ userProxy ä»£ç†ï¼Œæœ€å¾Œ admin ç”¨ __proto__ æ–¹å¼ç¹¼æ‰¿ userProxyï¼Œé€é userProxy get å¯ä»¥çœ‹å‡º target éƒ½æŒ‡å‘ userï¼Œä½†æ˜¯ receiver å°±ä¸ä¸€æ¨£ï¼Œå…©è€…éƒ½æŒ‡å‘å‘¼å«çš„è‡ªèº« (Proxy / Admin)\nä½†å› ç‚ºæœ€å¾ŒåŸ·è¡Œæ˜¯é€é target[prop]ï¼Œæ‰€ä»¥ this æŒ‡å‘çš„éƒ½æ˜¯ user\nå¦‚æœå¸Œæœ› admin.name æœ€å¾Œå°å‡º \u0026ldquo;Admin\u0026rdquo;ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è®“åŸ·è¡Œæ™‚ this æŒ‡å‘ adminï¼Œå°±éœ€è¦ Reflect å”åŠ©\nè¨˜å¾—è¦é¿å…åœ¨ proxy handler get ä¸­ç›´æ¥å‘¼å« receiver[prop]ï¼Œå› ç‚ºæœƒä¸æ–·é€é [[GET]] -\u0026gt; Proxy get -\u0026gt; [[GET]] -\u0026gt; Proxy get è¼ªè¿´\né€™ä¸€æ®µæ˜¯ç”¨ node.js åŸ·è¡Œï¼Œéœ€åŠ å…¥ if condition é¿å…ä¸æ–·çš„éè¿´å‘¼å«ï¼Œå› ç‚ºåœ¨ console.log æ™‚æœƒä¸»å‹•å» iterate ç‰©ä»¶ä¸¦å‘¼å« toStringï¼Œé€™äº›ä¹Ÿæœƒè§¸ç™¼ [[GET]]\nReflect Reflect æ˜¯ ES6 æ–°å¢çš„é¡åˆ¥ï¼Œä¸èƒ½é€é new å»ºæ§‹æ–°çš„ instanceï¼Œåªèƒ½å‘¼å«éœæ…‹æ–¹æ³•ï¼Œä¸»è¦æ˜¯é‡å°ç‰©ä»¶æ“ä½œçš„æ–¹æ³•ï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 const a = {b: 123} a.b // 123 Reflect.get(a, \u0026#34;b\u0026#34;) // 123 const object1 = { property1: 42 }; delete object1.property1 Reflect.deleteProperty(object1, \u0026#39;property1\u0026#39;); åŸºæœ¬ä¸Šéƒ½æœ‰ä¸€å°ä¸€çš„æ–¹æ³•å¯ä»¥èª¿ç”¨\nå‰›æ‰æåˆ°ï¼Œgetter æ™‚ç¬¬ä¸‰å€‹åƒæ•¸ receiver å¯ä»¥è®Šæˆ target å‘¼å«æ™‚çš„ this æŒ‡å‘ï¼Œä¾‹å¦‚\n1 2 3 4 5 let a = {c: 123, get d(){ console.log(this); return this.c}} let b = {c: 456} Reflect.get(a, \u0026#34;d\u0026#34;) // 123 Reflect.get(a, \u0026#34;d\u0026#34;, b) // 456 æ‰€ä»¥ç•¶æˆ‘å€‘å¸Œæœ›æŒ‡å®š getter å¯¦éš›æ“ä½œçš„ç‰©ä»¶ï¼Œå¯ä»¥ç”¨ Reflect.get å»å–ä»£ target[propd]ï¼Œé€™æ˜¯ä¸€ç¨®æœ€å®‰å…¨çš„åšæ³•ï¼Œçµåˆ function call ç”¨ä»¥ä¸‹æ–¹å¼æœ€ç‚ºä¿éšª\n1 2 3 4 5 6 new Proxy(user, { get(target, prop, receiver) { let value = Reflect.get(...arguments); return typeof value == \u0026#39;function\u0026#39; ? value.bind(target) : value; } }); åœ¨æŸäº›æ™‚å€™ï¼Œç”¨ Reflect.get å¯ä»¥é¿å…ä¸é æœŸéŒ¯èª¤ï¼Œä¾‹å¦‚èªª Mapï¼ŒMap åœ¨è®€å¯«åƒæ•¸æ™‚æ˜¯é€é this.[[MapData]] è€Œä¸æ˜¯ this.[[Get]]/this.[[Set]]ï¼Œæ‰€ä»¥å¦‚æœæ²’æœ‰æŒ‡å®š receiver å‰‡é è¨­ this æŒ‡å‘ Proxy å°±æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œè¦æ”¹ç”¨ Reflect.get å°‡ this æ›¿æ›æˆ Map æœ¬èº«æ‰ä¸æœƒæœ‰å•é¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 let map = new Map(); let proxy = new Proxy(map, {}); proxy.get(\u0026#39;test\u0026#39;); // éŒ¯èª¤: Uncaught TypeError: Method Map.prototype.get called on incompatible receiver /// æ­£ç¢ºæ–¹æ³• let map = new Map(); let proxy = new Proxy(map, { get(target, prop, receiver) { let value = Reflect.get(...arguments); return typeof value == \u0026#39;function\u0026#39; ? value.bind(target) : value; } }); proxy.get(\u0026#39;test\u0026#39;) API retry æ©Ÿåˆ¶ å€‹äººé‚„æ˜¯è »å–œæ­¡ç”¨ axios çš„è€Œä¸æ˜¯ç”¨åŸç”Ÿçš„ fetchï¼Œå¯èƒ½æ˜¯å› ç‚º axios æ›´åƒä¸€å€‹ç‰©ä»¶ï¼Œå¯ä»¥é€é create å‰µå»º instance è »æ–¹ä¾¿çš„\næ¥è‘—ç”¨ Proxy ä»£ç† function çš„å‘¼å«ï¼Œä¸¦å›å‚³ä¸€å€‹ async functionï¼Œåœ¨è£¡é ­å°±èƒ½è‡ªå®šç¾©éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼Œä¾‹å¦‚èªªæ”¶åˆ° 403 å°±å»æ›æ–°çš„ token ä¹‹é¡çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 const APIInstace = axios.create({ baseURL: \u0026#39;https://httpstat.us\u0026#39; }) const APIProxy = new Proxy(APIInstace, { get(target, prop, receiver){ let fn = Reflect.get(...arguments); return async function(){ try{ const result = await fn(...arguments); return result; }catch(error){ if(error?.response?.status === 403){ const result = await APIInstace.get(\u0026#34;https://www.mocky.io/v2/5ed11b963500005b00ffa29a\u0026#34;); return result; } throw \u0026#34;OhNo\u0026#34; } } } }) console.log(await APIProxy.get(\u0026#34;/403\u0026#34;)); // æ²’æœ‰éŒ¯èª¤ await APIProxy.get(\u0026#34;/404\u0026#34;); // æ‹‹å‡º OhNo éŒ¯èª¤ ","date":"2020-05-27T08:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-05-27-js-proxy-/-reflect-%E5%AF%A6%E6%88%B0-%E5%AF%A6%E4%BD%9C-api-%E8%87%AA%E5%8B%95-retry-%E6%A9%9F%E5%88%B6/","title":"JS Proxy / Reflect å¯¦æˆ° - å¯¦ä½œ API è‡ªå‹• retry æ©Ÿåˆ¶"},{"content":" å…§å®¹æ‘˜éŒ„è‡ªå½±ç‰‡ä»‹ç´¹ï¼Œè¦è¨è«– Vault çš„åŠŸèƒ½ä¹‹å‰ï¼Œå…ˆé€€ä¸€æ­¥å›ä¾†çœ‹æœ€ä¸€èˆ¬çš„æ©Ÿæ•è³‡æ–™çš„å®šç¾©èˆ‡ç®¡ç†æ–¹å¼\næ©Ÿæ•è³‡æ–™ä¸»è¦åˆ†æˆ é©—è­‰(Authentication) èˆ‡ æˆæ¬Š(Authorization)ï¼Œä¸€è€…è¡¨æ˜èº«ä»½ä¸€è€…æ±ºå®šæ“ä½œçš„æ¬Šé™ï¼Œå¯èƒ½æ˜¯ DB çš„æ¬Šé™ / ç¬¬ä¸‰æ–¹æœå‹™çš„ API Token / ç”¨ä¾†åŠ è§£å¯†çš„å°ç¨±é‡‘é‘°ç­‰ç­‰ï¼Œé€™äº›è³‡æ–™å¯èƒ½è¢«æ”¾åœ¨åŸå§‹ç¢¼ç•¶ä¸­ / config æ–‡ä»¶ / ç’°å¢ƒè®Šæ•¸ / ç‰ˆæœ¬æ§åˆ¶ç­‰ç­‰å››æ•£å„åœ°ï¼Œä¹‹å‰ Github æœ‰æå‡ºè¨±å¤šé–‹ç™¼è€…éƒ½èª¤ä¸Šå‚³æ©Ÿæ•è³‡æ–™ï¼›\nå¦ä¸€æ–¹é¢æ™‚é–“ä¸€ä¹…æ²’æœ‰äººçŸ¥é“åˆ°åº•ç™¼å‡ºå»å“ªäº› key åˆæˆ–æ˜¯èª°æœ‰åœ¨ç”¨ï¼Œç³Ÿç³•çš„æ˜¯å¯èƒ½ä¸€çµ„ key æœ‰å¤šå€‹äººä½¿ç”¨\nVault æå‡ºä¸‰å€‹å±¤ç´šçš„è§£æ±ºæ–¹æ¡ˆ\n1. é›†ä¸­åŒ–ç®¡ç† æ­å»º Vault Server é›†ä¸­ç®¡ç†æ‰€æœ‰çš„æ©Ÿæ•è³‡æ–™ï¼Œåœ¨ Vault Server ä¸­ç¢ºä¿æ‰€æœ‰çš„æ©Ÿæ•è³‡æ–™éƒ½æ˜¯è¢«åŠ å¯†å„²å­˜ï¼ŒåŒæ™‚ Client ä¾†è·Ÿ Server è¦æ©Ÿæ•è³‡æ–™æ™‚å‚³è¼¸éç¨‹ä¹Ÿæ˜¯åŠ å¯†çš„ï¼Œå®‰å…¨æ€§å¤§å¹…æå‡ï¼›\nä¸”æœ‰ Vault ç®¡ç†ï¼Œå¯ä»¥å®šæœŸ Rotateï¼Œä¸¦éš¨æ™‚æŸ¥çœ‹ç›®å‰çš„æ©Ÿæ•è³‡æ–™ä½¿ç”¨ç‹€æ³\n2.å‹•æ…‹ç”Ÿæˆ é€éå‹•æ…‹ç”Ÿæˆæ–¹å¼ï¼Œæ¯ä¸€å€‹ Client ä¾†è¦å³ä½¿æ¬Šé™éœ€æ±‚ç›¸åŒï¼Œä¹Ÿå‹•æ…‹ç”Ÿæˆä¸åŒçš„ keyï¼Œå¦‚æœæœ‰ç•°å¸¸æ“ä½œï¼Œå°±èƒ½å¾ˆæ¸…æ¥šæ˜¯å“ªä¸€å€‹ Client æœ‰å•é¡Œï¼Œæ¥è‘—ç›´æ¥ revoke æ‰å°±è¡Œäº†ï¼›\nå¦‚æœå¤§å®¶éƒ½å…±ç”¨ä¸€æŠŠ keyï¼Œå°±æŸ¥ä¸å‡ºæ˜¯èª°ä¹Ÿä¸èƒ½ç›´æ¥ revokeï¼Œé€ æˆå®‰å…¨ä¸Šçš„æ¼æ´\n3.Encrpyt as Service\nAPI Server è¨­è¨ˆæ™‚ï¼Œæˆ‘å€‘å¸¸éœ€è¦åŠ è§£å¯†è³‡æ–™ï¼Œæ‰€ä»¥æœƒéœ€è¦é‡‘é‘°èˆ‡å¯¦ä½œåŠ è§£å¯†æ¼”ç®—æ³•ï¼Œä½†æ˜¯ä¸€æ–¹é¢é‡‘é‘°å¤–æµåˆ° API Server ä¸Šå¤šä¸€å±¤é¢¨éšªï¼Œå†è€…å¦‚æœåŠ è§£å¯†æ¼”ç®—æ³•æœ‰æ¼æ´åˆæ˜¯å¦ä¸€å€‹é¢¨éšªï¼›\næ‰€ä»¥ Vault Server æœ¬èº«ä¹Ÿæä¾›åŠ è§£å¯† APIï¼Œè®“é‡‘é‘°èˆ‡æ¼”ç®—æ³•çš„ä¿éšœéƒ½ç•™åœ¨ Vault Server ä¸Šï¼Œå¤§å¹…é™ä½é¢¨éšªã€‚\næ¶æ§‹ä¸Šï¼ŒVault æ‹†æˆå¹¾å€‹æ¨¡çµ„å¢åŠ ç›¸å®¹æ€§ Authentication\nåŸºæ–¼äººå“¡çš„é©—è­‰ï¼Œå¯ä»¥é€éç¬¬ä¸‰æ–¹çš„æ¶æ§‹å¦‚ AWS/LDAPï¼Œæˆ–æ˜¯K8S Audit å°‡æ‰€æœ‰çš„æ“ä½œéƒ½è¨˜éŒ„ä¸‹ä¾†ï¼Œå¯ä»¥å­˜æ”¾åœ¨ system logs æˆ–æ˜¯å…¶ä»–å„²å­˜æ–¹å¼ Secret\næ©Ÿæ•è³‡æ–™çš„å‹æ…‹ï¼Œå¯èƒ½æ˜¯ Key-Valueï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹æœå‹™å¦‚ Database / AWS ç­‰ Storage\næ©Ÿæ•è³‡æ–™çš„å„²æ”¾ä½ç½® ä»¥ä¸‹æ•™å­¸å°‡åˆæ­¥æ¢ç´¢ Vault åŠŸèƒ½ç‚ºä¸»ï¼Œåªé©ç”¨æ–¼å­¸ç¿’èˆ‡æ¸¬è©¦ç’°å¢ƒä½¿ç”¨!\nä¸‹ä¸€ç¯‡å¯¦ä½œç¯‡ï¼Œä»¥ AWS ç‚ºä¸»ï¼Œå‹•æ…‹ Launch API Server æ™‚ä¸»å‹•ç´¢å–æ©Ÿæ•è³‡æ–™ï¼Œè¢«é…èˆ‡å‹•æ…‹ MongoDB é‡‘é‘°èˆ‡ AWS Role\nVault åˆæ¢ Vault å®˜æ–¹æ•™å­¸ æ˜¯ä¸€å€‹äº’å‹•å¼çš„æ•™å­¸ï¼Œè »ç°¡å–®æ˜ç­çš„ï¼Œä»¥ä¸‹æ˜¯æ•´ç†çš„ç­†è¨˜ï¼Œåƒ…é©ç”¨æ–¼å­¸ç¿’ï¼Œå®Œå…¨ä¸å»ºè­°ç”¨åœ¨æ­£å¼ç’°å¢ƒ!\nå…ˆåˆ° å®˜æ–¹è¼‰é»ä¸‹è¼‰ä¸¦å®‰è£ï¼Œè¨­å®šå¥½è·¯å¾‘ä¹‹å¾Œå¯ä»¥å®‰è£ auto complete $vault -autocomplete-installï¼Œvault æœƒåµæ¸¬ shell å®‰è£å°æ‡‰çš„æ’ä»¶\nå•Ÿå‹•æ¸¬è©¦ç’°å¢ƒçš„ Vault server $ vault server -dev æ¥è‘—æœƒåœ¨ terminal æ‰“å°å‡º Root Token: çš„å­—æ¨£ï¼Œæ­¤æ™‚ vault server æœƒè·‘åœ¨å‰æ™¯ï¼›\né–‹å•Ÿå¦ä¸€å€‹ terminal tabï¼Œå°‡å…¶è¼¸å‡ºè‡³ç’°å¢ƒè®Šæ•¸ç­‰ç­‰æœƒä½¿ç”¨ä¸Š export VAULT_DEV_ROOT_TOKEN_ID=\u0026quot;{æ›¿æ› Root Token}\u0026quot;ï¼Œæ¥è‘—æŒ‡å®š vault server url $export VAULT_ADDR='http://127.0.0.1:8200'ï¼›\né€é $ vault status æª¢æŸ¥æ˜¯å¦æŒ‡å®šæ­£ç¢º\nå–å¾—/æ–°å¢/æ›´æ–°/åˆªé™¤ secret å…ˆå‰æåˆ° Secret æœ‰å¾ˆå¤šç¨®ï¼Œå¾æœ€ç°¡å–®çš„ key value é–‹å§‹ï¼ŒVault é€šéä»¥ä¸‹æŒ‡ä»¤è¨­å®š\nvault kv put secret/{path} {key}={vaule} {key2}={value2} vault kv get -format=json secret/{path}\nformat æ˜¯é¸æ“‡æ€§å›æŒ‡å®šå›å‚³æ ¼å¼ vault kv delete secret/{path} å¯ä»¥æŠŠ Vault Server å„²å­˜å¯†ç¢¼çš„æ–¹å¼æƒ³æˆ RESTful API Serverï¼ŒæŒ‡å®šè³‡æºçš„è·¯å¾‘ï¼Œæ¡ç”¨æœ€é•·åŒ¹é…æ–¹å¼ï¼Œsecret æ˜¯é è¨­çš„å‰ç¶´ï¼Œå¾Œé¢çš„path ç”¨ / åˆ†éš”ï¼Œæ¥è‘—çš„ kv å¯ä»¥è¨­å®šå¤šçµ„ï¼Œput åŒæ™‚ä»£è¡¨æ–°å¢èˆ‡æ›´æ–°ï¼›\nå•Ÿç”¨ Secret ä¸¦è¨­å®š path é è¨­ç”¨ dev å•Ÿå‹•å¾Œ secret/ è·¯å¾‘æœƒå°æ‡‰åˆ° KV å„²å­˜æ–¹å¼ï¼Œå¯ä»¥é€é $vault secrets list æŸ¥çœ‹ï¼Œæ¥è‘—å¦‚æœæˆ‘å€‘æƒ³è¦è‡ªè¨‚å…¶ä»–çš„ Secretï¼Œæˆ–æ˜¯æŒ‡å®šæ–°çš„è·¯å¾‘å„²æ”¾ KVï¼Œå¯ä»¥é€é $vault secrets enable -path={path} {secret engine} ä¾‹å¦‚ $vault secrets enable -path=kv kv å°±èƒ½æŒ‡å®š kv/ ç‚ºæ–°çš„ key-value å„²å­˜è·¯å¾‘\næ¥è‘—ä¸‹ $vault kv put kv/hello foo=bar å¯ä»¥å¾—åˆ°ç›¸åŒçš„çµæœï¼Œé€é $vault secrets list å¯ä»¥çœ‹å‡ºä¾†å¤šäº†ä¸€çµ„è¨­å®š\nå¦‚æœä¸è¦ç”¨äº†ï¼Œå¯ä»¥é€é $vault secrets disable {path}/ å¦‚ $vault secrets disable kv/ åˆªé™¤ï¼Œæ³¨æ„åº•ä¸‹å„²å­˜çš„å¯†ç¢¼ä¹Ÿéƒ½æœƒä¸€ä¸¦æ¶ˆå¤±\nå•Ÿå‹• AWS Secret Engine å–å¾—å‹•æ…‹ AccessKey / AccessSecret å…ˆå‰æåˆ° Vault ä¸€å¤§ç‰¹è‰²æ˜¯æ”¯æ´å¤šç¨® Secretï¼Œè€Œä¸” Secret å¯ä»¥æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œæ¯ä¸€å€‹ Client ä¾†ç´¢å–éƒ½èƒ½è¦åˆ°ç¨ç«‹çš„ Secret\né€é aws secret engineï¼Œå¯ä»¥æŒ‡å®š Role èˆ‡æ¬Šé™ä¸¦çµ¦äºˆå‹•æ…‹ secretï¼Œé¦–å…ˆè®“æˆ‘å€‘å•Ÿå‹• secret $vault secrets enable -path=aws awsï¼Œæ¥è‘—è¨­å®š aws å¸³è™Ÿ\n1 2 3 4 $ vault write aws/config/root \\ access_key=${AWS Access Key} \\ secret_key=${AWS Secret key} \\ region=${AWS Region} çµ•å°ä¸å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒå¦‚æ­¤ä½¿ç”¨ï¼Œå› ç‚º shell command æœƒè¢«è¨˜éŒ„åœ¨ log ä¸­\nå¾ŒçºŒçš„æ“ä½œï¼ŒVault å°±æœƒç”¨é€™çµ„å¸³å¯†å»ç®¡ç† IAM\næ¥è‘—å‰µå»ºè§’è‰²\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ vault write aws/roles/my-role \\ credential_type=iam_user \\ policy_document=-\u0026lt;\u0026lt;EOF { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;Stmt1426528957000\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:*\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;*\u0026#34; ] } ] } EOF é€™è£¡çµ¦äºˆäº† ec2 å…¨éƒ¨çš„æ¬Šé™\næ¥è‘—è¦ç”¢ç”Ÿ Secret é€šé $vault read aws/creds/my-roleï¼Œæ­¤æ™‚å°±æœƒå›å‚³ä¸€çµ„æ–°çš„ roleï¼Œæ¯æ¬¡å‘¼å«éƒ½æœƒå›å‚³ç¨ç«‹çš„ Secret (ç‚ºä»€éº¼ç”¨ read ä»£è¡¨å‰µå»ºå‹•ä½œå°±ä¸ç¢ºå®šè¨­è¨ˆçš„åŸç†äº† :thinking_face)ï¼Œå¾ IAM Console å¯ä»¥çœ‹åˆ°è¢«å‰µå»ºçš„ç”¨æˆ¶ å¦‚æœè¦ revoke çš„è©±ï¼Œé€šé $vault lease revoke aws/creds/my-role/{lease id} å³å¯\nå‰›å‰›æƒ³è¦æŸ¥æ‰¾æœ‰æ²’æœ‰æŒ‡ä»¤å¯ä»¥æ¢åˆ—å‡ºæ‰€æœ‰çš„ credentialsï¼Œä½†çœ‹ä¾†æ˜¯æ²’æœ‰é€™é …æŒ‡ä»¤ï¼Œå¦‚æœç•¶åˆæ²’æœ‰è¨˜å¾— lease id çš„è©±ï¼Œå°±è¦å» IAM Console æ‰‹å‹•åˆªé™¤äº†\næ‰€æœ‰çš„æŒ‡ä»¤å¯ä»¥å¾é€™é‚Šçœ‹åˆ° AWS Secret æ–‡ä»¶ï¼Œæˆ–æ˜¯ç”¨ $vault path-help aws æŸ¥çœ‹ï¼Œpath-help å¯ä»¥æŒ‡å®šä¸åŒçš„è·¯å¾‘å±¤æ¬¡ï¼Œä¾‹å¦‚ $vault path-help aws/config/lease\nAuthentication \u0026amp; Authorization ç¾åœ¨æˆ‘å€‘çŸ¥é“è¦å¦‚ä½•å»ºç«‹èˆ‡ç®¡ç†é‡‘é‘°ï¼Œä½†é‡é»å›åˆ°èª°èƒ½ä¾†è¦é‡‘é‘°ä»¥åŠæ¬Šé™åŠƒåˆ†ï¼ŒAuthentication éƒ¨åˆ† Vault å¯ä»¥ç”¨ token / AppRule / Github / AWS IAM / LDAP ç­‰ç­‰ï¼ŒAuthorization éƒ¨åˆ†å¯ä»¥åˆ¶å®š Policyï¼Œé™ç¸®ç”¨æˆ¶èƒ½å¤ æ“ä½œçš„ Secret æ¬Šé™\nToken Token é©—è­‰æ©Ÿåˆ¶æ˜¯ Vault æ ¸å¿ƒã€ä¸èƒ½è¢«é—œé–‰çš„é©—è­‰åŠŸèƒ½ï¼Œåƒæˆ‘å€‘ä¸€é–‹å§‹å•Ÿå‹• Vault Server å¾Œæœƒç”¢ç”Ÿä¸€å€‹ root tokenï¼Œæ¥è‘—æœƒç”¨ root token å»åˆ¶å®š Policyï¼Œä¸¦ç”¢ç”Ÿå¤šçµ„ Tokenï¼Œæ–‡ä»¶æåˆ°å¦‚æœè¨­å®šå®Œå°±æ‡‰è©² revoke root tokenï¼Œæœ€å¥½æ˜¯æœ‰ root token æ™‚å¤§å®¶ä¸€èµ·ç›¯è‘—è¢å¹•æ“ä½œå¾Œå°± revokeï¼Œå¾ŒçºŒæœ‰éœ€è¦å¯ä»¥åœ¨å‹•æ…‹ç”Ÿæˆ\n$vault operator init $vault operator generate-root ç”¨ root token ç”Ÿæˆå…¶ä»– root token åœ¨ Vault ä¸­ï¼ŒToken ç®¡ç†æ˜¯éšå±¤åŒ–çš„ï¼Œç”¨æ¯ Token å»ç”Ÿæˆçš„ Token æœƒè‡ªå‹•è®Šæˆå­ Tokenï¼Œç‚ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œå¦‚æœæ¯ Token è¢« Revoke é‚£éº¼ä»¥ä¸‹æ‰€æœ‰çš„å­ Token æœƒå…¨æ•¸è¢« Revokeï¼Œå¦‚æœå¸Œæœ› Token ä¸å—æ¯ Token å½±éŸ¿ï¼Œå¯ä»¥ç”¨è¨­å®šç‚º Orphan Tokenï¼Œè·³è„«éšå±¤ç¨ç«‹ç®¡ç†\né™¤äº† Root Tokenï¼Œå…¶é¤˜çš„ Token éƒ½æœ‰ TTLï¼ŒTTL è¨­å®šæœ‰å¹¾å€‹åœ°æ–¹\nVault Server å•Ÿå‹•æ™‚çš„ Config é€é mount tuning å»æ›´æ”¹ æ ¹æ“šæ¯ Token çš„Policy åœ¨æœ‰äº›é•·é§çš„ç¨‹å¼ä¸­ï¼Œéœ€è¦é•·æ™‚é–“æŒæœ‰ Token å¯ä»¥è¨­å®šç‚º Periodicï¼ŒæŒ‡å®šæ›´æ–°é€±æœŸåªè¦åœ¨é€™æœŸé–“å…§å» renew å°±èƒ½ç¹¼çºŒä½¿ç”¨ Tokenï¼ŒåŒæ™‚å¯ä»¥æŒ‡å®š TTL æˆ–æ˜¯è¨­ç‚ºæ°¸ä¸å¤±æ•ˆï¼Œç­‰ TTL åˆ°äº†æœƒè‡ªå‹• revoke\nToken å»ºç«‹å¾Œæœƒå›å‚³ id / accessor / policy ç­‰è³‡è¨Šï¼Œaccessor å¯ä»¥ç”¨ä¾†æ“ä½œ token ç›¸é—œçš„æŒ‡ä»¤ä¾‹å¦‚ renew / revoke / åæŸ¥ token id ç­‰ç­‰ï¼Œä¸å¤ªç¢ºå®šç‚ºä»€éº¼ä¸ç›´æ¥ç”¨ token id è€Œæ˜¯è¦å¤šç”¢ç”Ÿå¦ä¸€çµ„ accessor ä»£è™Ÿï¼Œä½†ç›®å‰çœ‹åˆ°è¦æ¢åˆ—å‡ºæ‰€æœ‰ token åªèƒ½é€éåˆ—å‡º accessors å†å»åæŸ¥ token\nä»¥ä¸Šçš„ Token æ˜¯æŒ‡ Service Tokenï¼Œä¹Ÿå°±æ˜¯é è¨­æœ€å¸¸ä½¿ç”¨çš„ Token å½¢å¼ï¼›å¦å¤–é‚„æœ‰ Batch Token ç”¨åœ¨ Vault æ“ä½œä¸Šï¼Œæš«æ™‚æ²’æœ‰çœ‹åˆ°ç”¨è™•å°±å…ˆç•¥é\næ¥è‘—å¯¦éš›æ“ä½œçœ‹çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 // é€é root ç”Ÿæˆçš„ tokenï¼Œttl é è¨­ç‚ºç„¡éæœŸ $ vault token create ----- é–‹å•Ÿå¦ä¸€å€‹ shellï¼Œè©¦è‘—ç”¨å‰›å‰›çš„ token ç™»å…¥ $ export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; $ vault login {token} ------ // åˆªé™¤å‰›æ‰çš„ token $ vault token revoke {token} // æ–°å¢ä¸€å€‹ ttl ç‚º 1h çš„ token $ vault token create -ttl=\u0026#34;1h\u0026#34; å…¶ä»–çš„éƒ¨åˆ†ï¼Œè¦ºå¾—é€é api ä¸‹æŒ‡ä»¤æ¯”è¼ƒæ–¹ä¾¿ï¼Œæ±è¥¿ä¹Ÿæ¯”è¼ƒå…¨é¢ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // æŸ¥çœ‹æ‰€æœ‰çš„ accessors $ curl \\ --header \u0026#34;X-Vault-Token: {token}\u0026#34; \\ --request LIST \\ http://127.0.0.1:8200/v1/auth/token/accessors // æŸ¥çœ‹å„åˆ¥ accessor $ curl \\ --header \u0026#34;X-Vault-Token: {token}\u0026#34; \\ --request POST \\ --data \u0026#39;{\u0026#34;accessor\u0026#34;: \u0026#34;{accessor id}\u0026#34;}\u0026#39; \\ http://127.0.0.1:8200/v1/auth/token/lookup-self // é€é accessor revoke token $ curl \\ --header \u0026#34;X-Vault-Token: {token}\u0026#34; \\ --request POST \\ --data \u0026#39;{\u0026#34;accessor\u0026#34;: \u0026#34;{accessor token}\u0026#34;}\u0026#39;\\ http://127.0.0.1:8200/v1/auth/token/revoke-accessor è¨­å®š Policy æ¥è‘—å°±æ˜¯è¨­å®š Policy éƒ¨åˆ†ï¼Œé™åˆ¶ä¸åŒ Token èƒ½å¤ æ“ä½œ Secret çš„æ¬Šé™ï¼ŒVault æ’°å¯« policy çš„æ ¼å¼æ˜¯æ¡ç”¨ hclï¼Œä¹Ÿå°±æ˜¯ HashiCorp è‡ªå·±å…§éƒ¨çš„ Config æè¿°èªè¨€ï¼Œåœ¨è·¯å¾‘ä¸‹å»ºç«‹æª”æ¡ˆ my-policy.hcl ä¸¦è²¼ä¸Šä»¥ä¸‹å…§å®¹\n1 2 3 4 5 6 7 path \u0026#34;kv/foo\u0026#34; { capabilities = [ \u0026#34;create\u0026#34;, \u0026#34;update\u0026#34; ] } path \u0026#34;secret/data/foo\u0026#34; { capabilities = [ \u0026#34;create\u0026#34;, \u0026#34;update\u0026#34; ] } ä¸Šè¿°æ–‡ä»¶çš„æ„æ€æ˜¯é€™å€‹ Policy åªèƒ½æ“ä½œ secret/foo çš„æ–°\u0026amp;æ›´æ–°ï¼Œå…¶ä»–çš„æ“ä½œéƒ½ä¸€ç‡è¢«ç¦æ­¢ï¼Œ/data/ æŒ‡çš„æ˜¯é è¨­ Key Value çš„ Secret è·¯å¾‘ï¼Œå¦‚æœæ˜¯å¦å¤–å•Ÿå‹•çš„å¦‚ $vault secrets enable -path=kv kvï¼Œå‰‡å¯ä»¥ä¸ç”¨åŠ  /data è®Šæˆ kv/foo å³å¯\næ¥è‘—å¯¦éš›æ“ä½œ\n1 2 $ vault policy write my-policy my-policy.hcl $ vault token create -policy=my-policy å¯ä»¥çœ‹åˆ° token çš„ policy çª©äº†è‡ªå®šç¾©çš„ my-policy\næ¥è‘—é–‹å¦ä¸€å€‹ shell ç™»å…¥\n1 2 3 4 5 6 $ vault login {token} $ vault kv put secret/foo bar=baz // permission denied $ vault kv read secret/foo $ vault kv put secret/foo/bar bar=baz å¾Œä¾†ç™¼ç¾ $vault login æœƒå½±éŸ¿æ‰€æœ‰çš„ shellï¼Œé€™é»åœ¨æ¸¬è©¦è¦ç¨åŠ ç•™æ„\nVault Policy è¨­å®šå¯ä»¥å¾ˆå½ˆæ€§ï¼Œä¸»è¦æœ‰å¹¾é …é—œéµå­—\n1. path è·¯å¾‘é¸æ“‡ï¼Œå¯ä»¥ç”¨ * ä»£è¡¨ä»¥ä¸‹æ‰€æœ‰è·¯å¾‘ / + ä»£è¡¨æ­¤è·¯å¾‘åŒ¹é…ä»»ä½•å­—å…ƒç­‰æ–¹å¼ï¼Œå¦‚æœæœ‰å¤šçµ„ pathï¼ŒVault æ¡å–æœ€é•·åŒ¹é…çš„åŸå‰‡\n2. capabilities æ¬Šé™é¸æ“‡ï¼Œæœ‰ [read, create, update, delete, list, sudo, deny]ï¼Œæ–‡ä»¶æåˆ° Vault æ²’æœ‰å¾ˆä»”ç´°å€åˆ† create/update çš„ä½¿ç”¨å ´æ™¯ï¼Œæ‰€ä»¥è¦çµ¦å°±ä¸€èµ·çµ¦ï¼›\nsudo æŒ‡çš„æ˜¯å— root ä¿è­·çš„æ¬Šé™ / deny æ˜¯ç¦æ­¢ä»»ä½•æ“ä½œåŒ…å« sudo ä¹Ÿä¸è¡Œ\n3. allowed_parameters \u0026amp; denied_parameters \u0026amp; required_parameters é‡å°åƒæ•¸çš„è¨­å®šï¼Œå¯ä»¥æ¢åˆ—å…è¨±/ä¸å…è¨±/å¿…å‚™çš„åƒæ•¸ï¼Œå¦‚æœæ²’æœ‰ç‰¹åˆ¥è¨­å®šï¼Œå‰‡ä»£è¡¨ä¸å—ä»»ä½•é™åˆ¶\n4. min_wrapping_ttl \u0026amp; max_wrapping_ttl ç”¢ç”Ÿå­ Token çš„æœ€é•·èˆ‡æœ€çŸ­ TTL\nä»¥ä¸‹æ˜¯ç¶œåˆç¯„ä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 path \u0026#34;secret/foo\u0026#34; { capabilities = [\u0026#34;create\u0026#34;] allowed_parameters = { \u0026#34;foo\u0026#34; = [] \u0026#34;bar\u0026#34; = [\u0026#34;zip\u0026#34;, \u0026#34;zap\u0026#34;] } min_wrapping_ttl = \u0026#34;1s\u0026#34; max_wrapping_ttl = \u0026#34;90s\u0026#34; } path \u0026#34;secret/bar/*\u0026#34; { capabilities = [\u0026#34;create\u0026#34;] required_parameters = [\u0026#34;bar\u0026#34;, \u0026#34;baz\u0026#34;] } path \u0026#34;secret/baz/+/data-*\u0026#34; { capabilities = [\u0026#34;create\u0026#34;] denied_parameters = { \u0026#34;deny-*\u0026#34; = [] } } é‡å° secret/fooï¼Œåœ¨å‰µå»ºæ™‚åªå…è¨±åƒæ•¸ foo / barï¼Œå…¶ä¸­ foo çš„ value ä¸å—é™ï¼Œä½†æ˜¯ bar åªèƒ½æ˜¯ zip æˆ–æ˜¯ zap\nç¬¬äºŒæ¢æ˜¯æŒ‡ secret/bar åº•ä¸‹çš„ä»»æ„è·¯å¾‘é©ç”¨ï¼ŒåŒ…å« secret/bar/baz å’Œ secret/bar/baz/foo\u0026hellip;. ç­‰ç­‰ï¼Œä¸¦ä¸”å¿…é ˆåŒ…å« bar, baz é€™å…©å€‹åƒæ•¸\nç¬¬ä¸‰æ¢æ˜¯è·¯å¾‘æœƒåŒ¹é…å¦‚ secret/baz/foo/data-barï¼Œä¸”ä¸å…è¨± deny- é–‹é ­çš„ key\nå¤šé‡ Policy èˆ‡è¡çª åœ¨ Token å‰µå»ºæ™‚å¯ä»¥åŒæ™‚ç¶å®šå¤šçµ„ Policyï¼Œä¸å…è®“äººå¥½å¥‡å¦‚æœå…©çµ„ Policy å°åŒä¸€è·¯å¾‘ç”¢ç”Ÿè¡çªæ™‚çš„ç‹€æ³ï¼Œå¯¦æ¸¬ç™¼ç¾æ˜¯ capacities ç›¸åŒè·¯å¾‘ä¸‹æœƒçµ¦äºˆæœ€ç¶œåˆçš„æ¬Šé™ï¼Œè€Œä¸æ˜¯æŒ‰ç…§é †åºè¦†è“‹ä¹‹é¡çš„\nå¯ä»¥ç”¨ $vault token capabilities {token} {path} æŸ¥è©¢\næ”¹è®Š Policy ç•¶æ”¹è®Š Policy æ™‚ï¼ŒåŸæœ¬å·²ç¶“å»ºç«‹å¥½çš„ Token ä¸æœƒå‹•æ…‹å¥—ç”¨ï¼Œéœ€è¦åˆªé™¤é‡å»ºï¼Œè€Œæ–°å¢/æ›´æ–° Policy çš„æ–¹å¼ç”¨ $ vault policy write {policy_name} my-policy.hclå³å¯\nçµ±æ•´ åƒ…åƒ…ä»‹ç´¹åŸºæœ¬åŠŸèƒ½å°±èŠ±äº†ä¸å°‘ç¯‡å¹…ï¼Œæ¶µè“‹äº†åŸºæœ¬çš„ Secrets / Auth çš„åŠŸèƒ½ä»‹ç´¹èˆ‡æ“ä½œ\nå•Ÿå‹• dev serverï¼Œé—œæ‰è³‡æ–™å‰‡å…¨éƒ¨æ¶ˆå¤± 1 $ vault server --dev ç™»å…¥èˆ‡è¨­å®šè·¯å¾‘ 1 2 $ vault login {token} $ export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; Secret Engine æ˜¯èˆ‡è·¯å¾‘åŒ¹é…ï¼Œsecret/data æ˜¯é è¨­ Key Store Secret Engineï¼Œå¯ä»¥å¦å¤–é–‹å•Ÿæ–°çš„è·¯å¾‘ 1 2 3 4 $ vault secrets enable -path=kv kv // æ¢åˆ— $ vault secrets list -detailed $ vault secrets disable {path} æ–°å¢\u0026amp;æ›´æ–°/å–å¾—ï¼åˆªé™¤ Token 1 2 3 $ vault kv put kv/foo foo=\u0026#34;123\u0026#34; $ vault kv get kv/foo $ vault kv delete kv/foo Authentication 1 2 $ vault token create -ttl=\u0026#34;1h\u0026#34; -policy=\u0026#34;my_policy\u0026#34; $ vault token revoke {token id} Authorization\nå¦å¤–ç”¨ hcl æª”å„²å­˜ Policyï¼Œä¸¦åŒ¯å…¥è¨­å®šä¸­ 1 2 3 4 5 $ vault policy write my-policy my-policy.hcl $ vault token capabilities {token} {path} $ vault policy read my-policy $ vault policy list $ vault policy delete my-policy æƒ³ä¸åˆ°åˆæ­¥ä»‹ç´¹å°±èŠ±é€™éº¼å¤§çš„ç¯‡å¹…ï¼Œä¸‹ä¸€ç¯‡è¦å¯¦ä½œçµåˆ AWS èˆ‡æ­é… API Server çš„æµç¨‹\n","date":"2020-04-23T20:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-04-23-vault-%E6%95%99%E5%AD%B8-%E9%9B%86%E4%B8%AD%E5%8C%96%E7%AE%A1%E7%90%86%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99%E4%B8%8A/","title":"Vault æ•™å­¸-é›†ä¸­åŒ–ç®¡ç†æ©Ÿæ•è³‡æ–™(ä¸Š)"},{"content":"ç•¶æˆ‘å€‘åœ¨åˆ©ç”¨ Vagrant å»ºç«‹é–‹ç™¼ç’°å¢ƒï¼Œæˆ–æ˜¯é›²ç«¯ä¸Šæº–å‚™éƒ¨ç½²æ™‚ï¼Œéƒ½éœ€è¦ç”¨ VM åŸ·è¡ŒæŒ‡å®šçš„ Imageï¼Œæº–å‚™å¥½ç’°å¢ƒå¾Œé–‹å§‹åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼ï¼Œä½†æ˜¯ç®¡ç† Image æ˜¯ä¸€ä»¶æœ‰é»éº»ç…©çš„äº‹ï¼Œå°¤å…¶æ˜¯è¦è¨˜éŒ„æ¯å€‹æ­¥é©Ÿåˆ°åº•åšéäº†ä»€éº¼ï¼Œåˆæˆ–æ˜¯è¦æ•´åˆå…¥æŒçºŒéƒ¨ç½² CD çš„ç’°ç¯€éƒ½ä¸é€™éº¼å‹å–„\nPacker ç”¨ json æª”æŒ‡å®šåŸºç¤ Image / Provision æ­¥é©Ÿ / æŒ‡å®šå¹³å°æ‰“é€ å°æ‡‰çš„ Imageï¼Œä¾‹å¦‚å¯ä»¥åŒæ™‚é‡å° AWS / DigitalOcean / vmware ç­‰ä¸åŒå¹³å°å»ºç«‹ï¼Œé€é command line å°±å¯ä»¥å»ºç«‹ Image\nä»¥ä¸‹æ•™å­¸å°ˆæ³¨åœ¨ AWS çš„ Image å»ºç«‹ä¸Šï¼Œä¸¦åˆ†äº«å¯¦éš›ä½¿ç”¨ç¶“é©—\nPacker åœ¨å»ºç«‹ AWS Image æ™‚æœƒéœ€è¦é–‹æ©Ÿå™¨ï¼Œè‡ªå‹•ä¸Šå‚³çš„ AMI ä¸¦é—œé–‰æ©Ÿå™¨ï¼ŒPacker é–‹ç«‹çš„æ©Ÿå™¨å‹åˆ¥æ™‚ t2.micro æœ‰å…è²»çš„é¡åº¦ï¼Œä½†å¦‚æœè¶…éå¯èƒ½æœƒæœ‰é¡å¤–çš„ä¸€é»é»è²»ç”¨ï¼Œå–æ±ºæ–¼ build image çš„æ¬¡æ•¸èˆ‡æ™‚é–“ï¼›\nå¦å¤– AWS AMI å„²å­˜æ–¼ S3ï¼Œä¹Ÿæœƒæœ‰é¡å¤–çš„æˆæœ¬ï¼ŒPacker åªè² è²¬å»ºç«‹ Imageï¼Œå¾ŒçºŒçš„ç®¡ç†è¦è‡ªå·±è™•ç†\nä¹‹å‰åœ¨å…¬å¸å»ºç«‹ Image ä¹Ÿæ˜¯è¦å…ˆé–‹æ–°æ©Ÿå™¨ï¼Œå‹•æ‰‹è™•ç†å®Œå£“æˆ Imageï¼Œç¼ºé»æ˜¯æ•´å€‹æ“ä½œæ­¥é©Ÿæ˜¯ä¸é€æ˜ï¼Œé›–ç„¶å¯ä»¥ç¿» bash_history ä½†é‚„æ˜¯ä¸é€™éº¼å®¹æ˜“ï¼Œå¦‚æœæ–‡ä»¶æ¼å¯«å¾Œäººç¶­è­·å°±æœƒå¾ˆç—›è‹¦ï¼›\nç”¨ Packer å°±è§£æ±ºäº† Image å»ºç«‹éç¨‹ä¸é€æ˜ã€æ¯æ¬¡éƒ½è¦é–‹é—œæ©Ÿå™¨çš„å›°æ“¾\nå®‰è£ Packer ä¸‹è¼‰é€£çµ\næŒ‡å®šåŸºç¤ Image å¯ä»¥åœ¨ AWS Marketplace ä¸Šæ‰¾æƒ³è¦æ¡ç”¨çš„ Imageï¼Œæˆ–ç›´æ¥æŒ‡å®š ami-idï¼Œä¾‹å¦‚æˆ‘åœ¨ us-east-1 ä½¿ç”¨ Ubuntu 18.04 LTS - Bionic çš„ ami-id æ˜¯ ami-0d03e44a2333dea65ï¼Œè¦æ‰¾åˆ° ami-id å…¶å¯¦æœ‰é»å°éº»ç…©ï¼Œå¯ä»¥åƒè€ƒä¸‹åˆ—æ­¥é©Ÿ\nå…ˆæ‰¾åˆ° Imageï¼Œé»é€²å»å¾ŒæŒ‰ \u0026ldquo;Continue to Subscribe\u0026rdquo; -\u0026gt; \u0026ldquo;Continue to Configuration\u0026rdquo; (æ²’æˆªåœ–)ï¼Œæ¥è‘—é¸å®šå€åŸŸå°±èƒ½çœ‹åˆ° ami-id äº†\nPacker è¨­å®šæª” Packer çš„è¨­å®šæª”æ˜¯ json æ ¼å¼ï¼Œå…§å®¹ç›¸ç•¶ç°¡å–®æ˜ç­ï¼Œä¸»è¦å››å¡Š\nvariables\næ–‡ä»¶æœ‰èªªç‚ºäº†è®Šæ•¸ç®¡ç†æ–¹ä¾¿ï¼Œå¾ŒçºŒè¨­å®šæª”çš„åƒæ•¸å…¨éƒ¨éƒ½è¦å®šç¾©åœ¨é€™è£¡ builders\næŒ‡å®šçš„å¹³å°èˆ‡å°æ‡‰çš„å»ºç«‹æ–¹å¼ï¼Œå¦‚ AWS è¦æŒ‡å®š credential / region / vpc ç­‰ provisioners\nImage è¦åŸ·è¡Œçš„è¨­å®šï¼Œå¯ä»¥ç”¨ shell åŸ·è¡Œ / file ä¸Šå‚³æª”æ¡ˆï¼Œæˆ–æ˜¯å…¶ä»–çš„ provisioning å·¥å…·å¦‚ Ansible ç­‰ post-processors\nç”¢ç”Ÿ Image çš„å¾Œè™•ç†ï¼Œå¯ä»¥å£“ç¸®ä¸Šå‚³åˆ°æŒ‡å®šä½ç½®ç­‰ï¼Œé€™é‚Šå…ˆç•¥é ä»¥ä¸‹æª”æ¡ˆæ˜¯å»ºç«‹ API server imageï¼ŒåŸºæ–¼ ubuntu å®‰è£ Nodejs ä¸¦å°‡ Server æª”æ¡ˆä¸Šå‚³è‡³æŒ‡å®šè·¯å¾‘åŸ·è¡Œï¼Œæ‰€ä»¥çš„è¨­å®šæª”åœ¨github ä¸Š packer_get_started\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 { \u0026#34;variables\u0026#34;: { \u0026#34;aws_access_key\u0026#34;: \u0026#34;{{env `AWS_ACCESS_KEY_ID`}}\u0026#34;, \u0026#34;aws_secret_key\u0026#34;: \u0026#34;{{env `AWS_SECRET_ACCESS_KEY`}}\u0026#34;, \u0026#34;region\u0026#34;: \u0026#34;us-east-1\u0026#34; }, \u0026#34;builders\u0026#34;: [{ \u0026#34;type\u0026#34;: \u0026#34;amazon-ebs\u0026#34;, \u0026#34;access_key\u0026#34;: \u0026#34;{{user `aws_access_key`}}\u0026#34;, \u0026#34;secret_key\u0026#34;: \u0026#34;{{user `aws_secret_key`}}\u0026#34;, \u0026#34;region\u0026#34;: \u0026#34;us-east-1\u0026#34;, \u0026#34;source_ami\u0026#34;: \u0026#34;ami-0d03e44a2333dea65\u0026#34;, \u0026#34;instance_type\u0026#34;: \u0026#34;t2.micro\u0026#34;, \u0026#34;ssh_username\u0026#34;: \u0026#34;ubuntu\u0026#34;, \u0026#34;ami_name\u0026#34;: \u0026#34;packer-example {{timestamp}}\u0026#34; }], \u0026#34;provisioners\u0026#34;: [{ \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, \u0026#34;script\u0026#34;: \u0026#34;init.sh\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, \u0026#34;inline\u0026#34;: [ \u0026#34;ls\u0026#34;, \u0026#34;pwd\u0026#34; ] }, { \u0026#34;type\u0026#34;: \u0026#34;file\u0026#34;, \u0026#34;source\u0026#34;: \u0026#34;server\u0026#34;, \u0026#34;destination\u0026#34;: \u0026#34;~/server\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, \u0026#34;script\u0026#34;: \u0026#34;start.sh\u0026#34; }] } åœ¨ json æª”ä¸­ï¼Œè®Šæ•¸å–ç”¨éƒ½æ˜¯ä»¥ {{}} é›™æ‹¬è™Ÿæ‹¬ä½ï¼Œåªæœ‰åœ¨ variables ä¸­å¯ä»¥ç”¨ env æŒ‡å®šä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œä¹Ÿå¯ä»¥ç•™ç©ºåœ¨ command line åŸ·è¡Œæ™‚æŒ‡å®šï¼Œå¦‚ $ packer build -var 'aws_access_key=YOUR ACCESS KEY' ... ä¾†æºé‚„å¯ä»¥å¾ Consul / Vault ç­‰åœ°æ–¹ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶\nå¾ŒçºŒéšæ®µè¦è®€å–å°±è¦ç”¨\n1 {{user `aws_access_key/`}} çš„å½¢å¼è®€å– variables ä¸­çš„åƒæ•¸\nbuilders å¯ä»¥çœ‹åˆ° builders æ˜¯ä»¥é™£åˆ—å½¢å¼ï¼Œé€™é‚Šå¯ä»¥æŒ‡å®šå¤šå€‹å»ºç«‹çš„ç›®æ¨™ï¼Œä¾‹å¦‚å¢åŠ  vmware / virtualbox ç­‰ç­‰ï¼ŒPacker æœƒä½µç™¼å»ºç«‹ Image\nprovisioner å¸¸ç”¨æ­é… shell / file åŸ·è¡Œ shell script æˆ–æ˜¯ä¸Šå‚³æœ¬åœ°ç«¯è³‡æ–™åˆ° serverä¸Šï¼Œå¯ä»¥æŒ‡å®šåœ¨æŸäº›ç›®æ¨™ä¸‹æ‰è¤‡å¯«ï¼Œå¦‚\n1 2 3 4 5 6 7 8 9 { \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, \u0026#34;script\u0026#34;: \u0026#34;script.sh\u0026#34;, \u0026#34;override\u0026#34;: { \u0026#34;vmware-iso\u0026#34;: { \u0026#34;execute_command\u0026#34;: \u0026#34;echo \u0026#39;password\u0026#39; | sudo -S bash {{.Path}}\u0026#34; } } } Packer å¤§æ¦‚å°±æ˜¯é€™éº¼ç°¡å–®! Do one thing and do it well. åŸ·è¡Œçš„æ™‚å€™ç…§æ¨£ hashicorp å·¥å…·çš„æ“ä½œæ–¹å¼ï¼Œ$packer validate å…ˆæª¢æŸ¥èªæ³•æ­£ç¢ºæ€§ï¼Œæ¥è‘— $packer build å°±å®Œæˆå›‰\næœ€å¾Œçœ‹ä¸€ä¸‹ Packer æ¯æ¬¡ Build æ‰€ç”¢ç”Ÿçš„ instance ä½¿ç”¨ç¶“é©—è«‡ ä»¥ä¸‹åˆ†äº«ä¸€äº›å¯¦éš›é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºè¾¦æ³•\nä½¿ç”¨ AWS build Image å¶çˆ¾é‡åˆ° package å®‰è£å¤±æ•—çš„å•é¡Œ ç—‡ç‹€å¤§æ¦‚æ˜¯ Packer åœ¨åŸ·è¡Œ $sudo apt-get install æ™‚å¶ç™¼èªª package not foundï¼Œä½†å¶çˆ¾å¯ä»¥ï¼Œä¸”é€²å»æ©Ÿå™¨å®‰è£ç¶²è·¯ç‹€æ³éƒ½æ˜¯æ²’å•é¡Œçš„\nå•é¡Œä¸»è¦å‡ºè‡ªæ–¼é–‹å•Ÿ AWS æ©Ÿå™¨æ™‚æœ‰å¯èƒ½ç¶²è·¯é‚„æ²’æœ‰å¥½ï¼Œæ‰€ä»¥æ‰æœƒæ˜¯å¶ç™¼æ€§ï¼Œè§£æ±ºè¾¦æ³•å°±æ˜¯ç¢ºèªç¶²è·¯å¥½æ‰é–‹å§‹åŸ·è¡Œ shell scriptï¼Œè©³ç´°è«‹åƒè€ƒ Packer Github Issue Option for builder to wait on cloud-init to complete\nåœ¨ provisions ç¬¬ä¸€æ­¥åŠ å…¥ä»¥ä¸‹ script (ç­”æ¡ˆæ‘˜éŒ„è‡ªä¸Šæ–¹ issue å›è¦†)\n1 2 3 4 5 6 provisions:[{ \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34; \u0026#34;inline\u0026#34;: \u0026#34;/usr/bin/cloud-init status --wait\u0026#34; }, .... ] å¸Œæœ›åœ¨ launch æ©Ÿå™¨æ™‚å°±å•Ÿå‹•æœå‹™ é€™æ¯”è¼ƒååŸæœ‰çš„ç³»çµ± service è¨­å®šï¼Œä½¿ç”¨ ubuntu çš„è©±å¯ä»¥è¨­å®š systemd serviceï¼Œä¸¦æŒ‡å®š target å°±å¯ä»¥åœ¨ launch æ©Ÿå™¨æ™‚å•Ÿå‹•ï¼Œè©³ç´°åƒè€ƒ How To Use Systemctl to Manage Systemd Services and Units èˆ‡\nUnderstanding Systemd Units and Unit Files å…©ç¯‡ä¾†è‡ª DigitalOcean çš„å¥½æ–‡ï¼Œé è¨ˆé€™ç¯‡æœƒåœ¨ç”¢å‡ºä¸€ç¯‡æ–‡ç«  (æŒ–å‘)\nå¸Œæœ›åœ¨ launch æ©Ÿå™¨å¾Œå–å¾—æ©Ÿå™¨è³‡è¨Šèˆ‡ IP é€™æ‡‰è©²æ˜¯è »å¯¦ç”¨çš„éœ€æ±‚ï¼Œåƒæ˜¯ç¶å®šä¸€äº›ç¶²è·¯æœå‹™ï¼Œæœƒéœ€è¦åœ¨ config æª”æŒ‡å®šæ©Ÿå™¨çš„ IP ç­‰ï¼Œé ˆæ³¨æ„é€™é‚Šè¦ç­‰åˆ° launch å¾Œæ‰ç¶å®šï¼Œè€Œä¸æ˜¯åœ¨ Packer Build çš„æ©Ÿå™¨ç”¢ç”Ÿï¼Œæ‰€ä»¥æœƒçµåˆä¸Šä¸€é»ï¼ŒæŒ‡å®š script åœ¨æ©Ÿå™¨å•Ÿå‹•å¾Œæ‰åŸ·è¡Œ\nå–å¾— AWS æ©Ÿå™¨è³‡è¨Š å–å¾— IPv6 ä¿®æ”¹æ–‡ä»¶ ","date":"2020-04-15T02:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-04-15-packer%E6%95%99%E5%AD%B8-%E6%89%93%E9%80%A0-image%E8%88%87%E5%AF%A6%E9%9A%9B%E4%BD%BF%E7%94%A8%E7%B6%93%E9%A9%97/","title":"Packeræ•™å­¸-æ‰“é€  Imageèˆ‡å¯¦éš›ä½¿ç”¨ç¶“é©—"},{"content":"å¤§ç¶± Infrusture as Code æŒ‘æˆ°è³½ - Hashicorp å·¥å…·éˆå…¨æ•™å­¸\nVagrant ä¸»è¦æ˜¯å»ºç«‹èˆ‡ç®¡ç† VM çš„å·¥å…·ï¼Œä¸»è¦å¸Œæœ›åœ¨å·¥ä½œæµç¨‹ä¸­æä¾›ä¸€è‡´çš„ç’°å¢ƒï¼Œä¾‹å¦‚èªªæœ‰æ–°äººåŠ å…¥é–‹ç™¼ï¼Œéœ€è¦åœ¨æœ¬åœ°ç«¯è¨­å®š Runtime ç’°å¢ƒ / è³‡æ–™åº«ç­‰ï¼Œé€™æ™‚å€™å¦‚æœç”¨ Vagrant ä½¿ç”¨ $vagrant up ä¸€éµå•Ÿå‹•æ‰€æœ‰éœ€è¦çš„ç’°å¢ƒï¼Œå°±éå¸¸çš„æ–¹ä¾¿ï¼Œä¹Ÿå¯ä»¥é¿å…ã€Œæ˜æ˜åœ¨æˆ‘çš„é›»è…¦å°±æ²’å•é¡Œã€çš„å°·å°¬\nVagrant ä¸»è¦æ˜¯ VM-based çš„å·¥å…·ï¼Œé è¨­ä½¿ç”¨ Virtualboxï¼Œä¹Ÿå¯ä»¥ç”¨ VMWare / AWS ç­‰è™›æ“¬åŒ–å¹³å°\næœ¬æ¬¡æ•™å­¸ç›®æ¨™ç‚ºéƒ¨ç½²ä¸€å€‹ nodejs api server + mongodb\ngithub repo åœ¨æ­¤ vagrant-getting-started\nInstall ä¸‹è¼‰ Vagrant\nä¸‹è¼‰ Virtualbox\nTerminology åœ¨ Vagrant æœ‰å¹¾å€‹åè©å…ˆä»‹ç´¹\nprovider:\næä¾› Vagrant è™›æ“¬åŒ–çš„ç’°å¢ƒï¼Œé è¨­æ˜¯ virtualboxï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ç¬¬ä¸‰æ–¹ provider box:\nå°æ¯”æ˜¯ Docker çš„ Imageï¼Œä¹Ÿå°±æ˜¯ Vagrant è™›æ“¬åŒ–å•Ÿå‹•çš„ Imageï¼Œé€éé€™å€‹åŸºç¤å†å»å®¢è£½åŒ–ï¼Œä»¥ä¸‹ç”¨ ubuntu ç¤ºç¯„ provision:\nå®¢è£½åŒ–ç’°å¢ƒçš„æ¯ä¸€å€‹æ­¥é©Ÿï¼Œå¯ä»¥ç”¨ shellåŸ·è¡Œ shell scriptã€file ä¸Šå‚³æª”æ¡ˆï¼Œæˆ–æ˜¯æ­é… chef/ansible ç­‰ provisioning å·¥å…· Get Started! é¦–å…ˆå»ºç«‹ä¸€å€‹æª”æ¡ˆå¤¾ vagrant-demoï¼Œå…ˆæ‹‰ä¸‹ç­‰ç­‰è¦ç”¨çš„ boxï¼Œ\n1 2 [Host] $ vagrant box add ubuntu/trusty64 å¯ä»¥åœ¨é€™é‚Šæ‰¾åˆ°ä½ æƒ³è¦çš„ boxï¼ŒDiscover Vagrant Boxes\næ¥è‘—å»ºç«‹ Vargrantfile æ–‡ä»¶ï¼Œè£¡é ­å¯«å…¥\n1 2 3 Vagrant.configure(\u0026#34;2\u0026#34;) do |config| config.vm.box = \u0026#34;ubuntu/trusty64\u0026#34; end é¦–å…ˆçœ‹ä¸€ä¸‹èªæ³•ï¼ŒVagrant è¨­å®šæª”æ˜¯ç”¨ Ruby èªæ³•ï¼Œç•¶ç„¶ä¸æœƒ Ruby ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼ŒVagrant.configure(\u0026quot;2\u0026quot;) å®šç¾© Vagrant çš„èªæ³•ç‰ˆæœ¬ï¼Œæ¥è‘— do |config| ... end å®šç¾© vm çš„è¨­å®šï¼Œconfig æ˜¯æˆ‘å€‘åœ¨é€™å€‹ block ä¸­çš„ vm åç¨±ï¼›\nconfig.vm.box å‰‡æ˜¯æŒ‡å®šæ¡ç”¨çš„ boxï¼Œconfig.vm åº•ä¸‹æœ‰å¾ˆå¤šåƒæ•¸å¯ä»¥æŒ‡å®šï¼Œè«‹åƒè€ƒæ–‡ä»¶\næ¥è‘—åŸ·è¡Œ\n1 2 [Host] $ vagrant up å¦‚æœå®‰è£æ­£ç¢ºï¼Œvagrant æœƒç›´æ¥å•Ÿå‹•æ–°çš„ vmï¼Œå¦‚æœç›´æ¥é–‹ virtuabox æœƒçœ‹åˆ°ä¸€å€‹æ–°çš„ vm instance $vagrant up è¡¨ç¤ºä¾åºè·¯å¾‘è®€å– Vagrantfile(ç•¶å‰è·¯å¾‘ \u0026ndash;æ²’æœ‰æ‰¾åˆ°å†å¾€\u0026ndash;\u0026gt; ../ç•¶å‰è·¯å¾‘ -\u0026gt; \u0026hellip;.)ï¼Œä¸¦å•Ÿå‹•æ–°çš„ vm instanceï¼Œå•Ÿå‹•å¾Œæœƒç™¼ç¾è·¯å¾‘ä¸‹å¤šäº† ./.vagrant çš„è³‡æ–™å¤¾ï¼Œé€™ä¸»è¦æ˜¯è¨˜éŒ„ vagrant åŸ·è¡Œç‹€æ…‹\næ¥è‘—è®“æˆ‘å€‘ ssh é€²å…¥ vm çœ‹ä¸€ä¸‹\n1 2 [Host] $ vagrant ssh ssh ç”¨çš„ key ç­‰ç­‰ vagrant éƒ½è™•ç†å¥½äº†ï¼Œssh é€²å…¥å¾Œï¼Œé è¨­æ“ä½œçš„ user æ˜¯ vagrantï¼Œå…ˆçœ‹ä¸€ä¸‹ /vagrant\n1 2 [VM] $ ls /vagrant ä½ æœƒæ„å¤–ç™¼ç¾ /vagrant è£¡é ­ç«Ÿç„¶æœ‰ Vagrantfileï¼Œä¸»è¦æ˜¯ vagrant é è¨­æœƒæŠŠæœ¬åœ°ç«¯ Vagrantfile åŒåœ¨çš„è³‡æ–™å¤¾ä¸€ä¸¦åŒæ­¥åˆ° vm åº•ä¸‹çš„ /vagrant ç•¶ä¸­\nä¾ç…§å…±äº«çš„ä¸åŒï¼Œå¯èƒ½æ˜¯ rsync ä¸€æ¬¡æ€§è¤‡è£½ï¼Œä¹Ÿå¯ä»¥é€é SMB é›™å‘åŒæ­¥å…±äº«è³‡æ–™å¤¾\nprovisioning æ¥è‘—æˆ‘å€‘å®‰è£ä¸Š nodejsï¼Œè®“æˆ‘å€‘é€é shell script å®‰è£ nvmï¼Œä¸¦å»ºç«‹ server è³‡æ–™å¤¾æ”¾åˆ° vm ä¸­ï¼Œæ¥è‘—é€é pm2 å•Ÿå‹•\nå°‡ Vagrantfile æ”¹æˆ\n1 2 3 4 5 6 7 8 9 10 11 12 Vagrant.configure(\u0026#34;2\u0026#34;) do |config| config.vm.box = \u0026#34;ubuntu/trusty64\u0026#34; config.vm.provision :shell, path: \u0026#34;init.sh\u0026#34;, privileged: false config.vm.provision \u0026#34;file\u0026#34;, source: \u0026#34;server\u0026#34;, destination: \u0026#34;/home/vagrant/\u0026#34; config.vm.provision :shell, path: \u0026#34;start.sh\u0026#34;, privileged: false config.vm.synced_folder \u0026#34;.\u0026#34;, \u0026#34;/vagrant\u0026#34;, id: \u0026#34;sync\u0026#34;, type: \u0026#34;rsync\u0026#34;, rsync__exclude: [\u0026#34;.git/\u0026#34;, \u0026#34;server/\u0026#34;, \u0026#34;start.sh\u0026#34;] end æ¯ä¸€å€‹ config.vm.provision ä»£è¡¨ä¸€å€‹æ­¥é©Ÿï¼Œæˆ‘å€‘æŒ‡å®šäº†\nåŸ·è¡Œ init.shï¼šä¸»è¦æ˜¯å®‰è£ nvm èˆ‡ pm2 file æ˜¯ç”¨ä¾†è¤‡è£½æª”æ¡ˆï¼Œå°‡ server è·¯å¾‘è¤‡è£½åˆ° /home/vagrant/ åº•ä¸‹ start.sh ä¸»è¦æ˜¯å•Ÿå‹• nodejs server config.vm.synced_folder å‰‡æ˜¯é¡¯ç¤ºæŒ‡å®šæˆ‘å€‘è¦åŒæ­¥åˆ° /vagrant åº•ä¸‹çš„è³‡æ–™ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šåˆ°å…¶ä»–è³‡æ–™å¤¾ä¸‹ï¼Œä¸éè¦å°å¿ƒè™•ç†æª”æ¡ˆè·¯å¾‘\næ¥è‘—åŸ·è¡Œ\n1 2 [Host] $ vagrant provision æ³¨æ„å¦‚æœé€™æ™‚å€™è·‘ $ vagrant up æ˜¯æ²’æœ‰ç”¨çš„ï¼Œå› ç‚º vm å·²ç¶“å•Ÿå‹•äº†ï¼Œå¦‚æœæ˜¯ Vagrantfile å¢åŠ  provisionï¼Œè¨˜å¾—ç”¨ $ vagrant provisionæˆ– $ vagrant reload --provisionï¼Œå¦‚æœæ˜¯ Vagrantfile å…¶ä»–è¨­å®šæª”æœ‰æ›´å‹•ï¼Œè«‹ç”¨ $ vagrant reload\næ­¤æ™‚ ssh ç™»å…¥å¾Œå¯ä»¥çœ‹åˆ° nodejs server å·²ç¶“åœ¨åŸ·è¡Œäº†\né€™æ™‚å€™å¥½å¥½èªªä¸€ä¸‹ shell éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œ\n1 2 3 4 .... source ~/.nvm/nvm.sh nvm install 12 npm install -g pm2 å¯ä»¥çœ‹åˆ°æˆ‘åœ¨ init.sh / start.sh è¦å‘¼å« nvm/pm2 ä¹‹å‰éƒ½è¦ $source ~/.nvm/nvm.sh è€Œé $source ~/.bash.shï¼Œä¸»è¦æ˜¯å› ç‚ºé è¨­ vagrant çš„ .bashrc æœ‰é€™ä¸€æ®µ\n1 2 3 4 5 # If not running interactively, don\u0026#39;t do anything case $- in *i*) ;; *) return;; esac è€Œæˆ‘å€‘åˆå°‡ nvm çš„å•Ÿå‹• script æ”¾åœ¨é€™ä¸€æ®µä¹‹å¾Œæ‰æœƒå°è‡´ shell æ‰¾ä¸åˆ° nvm commandï¼Œæ‰€ä»¥è¦æ”¹æˆ$source ~/.nvm/nvm.shï¼Œé€™éƒ¨åˆ†æ˜¯åƒè€ƒ stackoverflow Why is nvm command installed as root and also not found during vagrant bootstrap.sh?\nå…¶ä»–çš„ provisioning å·¥å…·æ­é…è«‹åƒè€ƒæ–‡ä»¶\ndestroy å¦‚æœé–‹ç™¼éç¨‹ä¸­æœ‰èª¤ï¼Œå»ºè­° Vagrantfile æ”¹å®Œç åˆ° vm é‡ä¾†ï¼Œä½¿ç”¨ $ vagrant destroyï¼Œä¸»è¦æ˜¯æ¯æ¬¡åŸ·è¡Œ $ vagrant provision æœƒä¸æ–·åœ¨åŸæœ¬çš„ vm instance æ“ä½œï¼Œé€™æ¨£æœƒå°è‡´æ¯æ¬¡ç–ŠåŠ çµæœè€Œé•å immutable\nnetwork åœ¨ Vagrant ä¸­ï¼Œç¶²è·¯å¤§è‡´æœ‰ä¸‰ç¨®è¨­å®šæ–¹å¼\nPort Forward\nè®“ Host ç’°å¢ƒå¯ä»¥ç”¨æŒ‡å®š port å°æ‡‰ VM ä¸­çš„ port Private Network\næŒ‡å®š private ip è®“å…§ç¶²çš„æ©Ÿå™¨éƒ½èƒ½é€é ip æºé€š Public Network\nVagrant é è¨­æ•´åˆ Ngrokï¼Œå¯ä»¥ç”¨å…¬é–‹é€£çµé€£ç·š æ­¤æ™‚ nodejs server åªèƒ½åœ¨ vm å…§éƒ¨ä½¿ç”¨ï¼Œæˆ‘å€‘ç”¨ Port Forward æ–¹å¼è®“ host ä¹Ÿå¯ä»¥å‘¼å« ä¿®æ”¹ Vagrantfile\n1 2 3 4 Vagrant.configure(\u0026#34;2\u0026#34;) do |config| ... config.vm.network \u0026#34;forwarded_port\u0026#34;, guest: 80, host: 8080 end æ¥è‘—ç”¨ $ vagrant reload é€™æ™‚å€™åœ¨ Host å°±å¯ä»¥ç™¼è«‹æ±‚åˆ° VM ä¸Šå›‰ $ curl localhost:8080\nå°çµ åœ¨ Provisioning éƒ¨åˆ†ï¼Œå€‹äººè¦ºå¾—ç”¨ shell script æœ‰é»ä¸å¤ªæ–¹ä¾¿ï¼Œä¾‹å¦‚èªªåˆ‡æ› OS æ™‚ script å°±éœ€è¦ä¿®æ”¹ï¼Œè€Œä¸”å¾ˆæŒ‡ä»¤å¼è€Œéå®£å‘Šå¼ï¼Œå¦‚æœèƒ½ç”¨å…¶ä»–çš„ provisioning tool å»ç®¡ç†ï¼Œåˆæˆ–æ˜¯ä½¿ç”¨ image / container å»éš”é›¢å°åº•å±¤ OS çš„ç›¸ä¾ï¼Œé€™å‹¢å¿…æœƒæ–¹ä¾¿å¾ˆå¤š\nVagrant æœ‰æä¾› AWS providerï¼Œä½†å› ç‚ºæ˜¯ç¤¾ç¾¤é–‹ç™¼å¥—ä»¶å°±æš«ä¸”ä¸è©¦ï¼Œå°ˆæ³¨åœ¨æ­å»ºæœ¬åœ°ç«¯çš„é–‹ç™¼ç’°å¢ƒ\nç›®å‰æ˜¯åªæœ‰ä¸€å° api serverï¼Œæ¥è‘—è¦é…ç½® DB ä¸¦æ”¾åœ¨åŒä¸€å€‹ Vagrantfile ä¸­æ•´ç†\nMulti machile å¦‚æœè¦åœ¨ Vagrantfile ä¸­å®šç¾©å¤šå€‹ vm instanceï¼Œå¯ä»¥é€é config.vm.define å€éš”ï¼Œé è¨­æœƒç¹¼æ‰¿å…¨åŸŸçš„æ‰€æœ‰ provisionï¼Œä½†æ˜¯å€‹åˆ¥å®šç¾©ä¸­å¯ä»¥è¤‡å¯«æˆ–æ˜¯å®¢è£½åŒ–ï¼Œå¦‚ä»¥ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 Vagrant.configure(\u0026#34;2\u0026#34;) do |config| config.vm.box = \u0026#34;ubuntu/trusty64\u0026#34; config.vm.define \u0026#34;api\u0026#34; do |api| api.vm.provision :shell, path: \u0026#34;init.sh\u0026#34;, privileged: false api.vm.provision \u0026#34;file\u0026#34;, source: \u0026#34;server\u0026#34;, destination: \u0026#34;/home/vagrant/\u0026#34; api.vm.provision :shell, path: \u0026#34;start.sh\u0026#34;, privileged: false api.vm.synced_folder \u0026#34;.\u0026#34;, \u0026#34;/vagrant\u0026#34;, id: \u0026#34;sync\u0026#34;, type: \u0026#34;rsync\u0026#34;, rsync__exclude: [\u0026#34;.git/\u0026#34;, \u0026#34;server/\u0026#34;, \u0026#34;start.sh\u0026#34;] api.vm.network \u0026#34;forwarded_port\u0026#34;, guest: 3000, host: 8080 end config.vm.define \u0026#34;db\u0026#34; do |db| db.vm.provision :shell, path: \u0026#34;./mongodb/install.sh\u0026#34;, privileged: false end end å¦‚æœæƒ³è¦æŒ‡å®šå…¶ä¸­ä¸€å°ä¸‹æŒ‡ä»¤ï¼Œé‡å°åç¨±å°±å¥½å¦‚ $vagrant ssh db\nçµèª å€‹äººè¦ºå¾—é–‹ç™¼ä¸æ¨è–¦ç”¨ Vagrant (é‚£æ€éº¼èŠ±äº†ä¸€å€‹å‡æ—¥\u0026hellip;)ï¼Œä¸»è¦æ˜¯ç¤¾ç¾¤çœ‹èµ·ä¾†æ²’æœ‰å¾ˆæ´»èºï¼Œä¾‹å¦‚æœ€å¤šäººä¸‹è¼‰çš„ box ubuntu/trusty64 é‚„æ˜¯åœ¨ 14.04 çš„ç‰ˆæœ¬ï¼Œæƒ³è¦ç›´æ¥æ‰¾ Mongodb çš„ box ä¹Ÿæ²’æœ‰(å¤§å¤šçš„ db éƒ½æ²’æœ‰)ï¼Œä¸”æ•´å€‹é…ç½®ä¸Šæ²’æœ‰å¾ˆæ–¹ä¾¿ï¼Œä¾‹å¦‚ shell script åˆ‡æ› os å°±è¦é‡å¯«ï¼Œé‚„ä¸å¦‚ç”¨ docker + docker compose ä¾†å¾—å¿«é€Ÿ\nä½†å¦‚æœä½ æ˜¯ä¸€å®šè¦ç”¨ vm é‚£æˆ–è¨± Vagrant é‚„æ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡\nå¦‚æœä½ æœ‰å…¶ä»–å»ºè­°ï¼Œåˆæˆ–æ˜¯æœ‰è¦ºå¾— Vagrant æœ‰å²å®³ç¨ç‰¹çš„æ‡‰ç”¨å ´æ™¯å†éº»ç…©æŒ‡æ•™ï½\n","date":"2020-04-12T11:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-04-12-vagrant-%E6%95%99%E5%AD%B8-%E5%BE%9E%E6%9C%AC%E5%9C%B0%E7%AB%AF%E9%96%8B%E7%99%BC%E5%88%B0-aws-%E9%83%A8%E7%BD%B2/","title":"Vagrant æ•™å­¸- å¾æœ¬åœ°ç«¯é–‹ç™¼åˆ° AWS éƒ¨ç½²"},{"content":"æœ€è¿‘é–‹å§‹æ¥è§¸ DevOps èˆ‡ Infrasture as Code çš„æ¦‚å¿µï¼Œæ·±æ·±è¢«ç”¨ç¨‹å¼ç¢¼ç®¡ç†éƒ¨ç½²æµç¨‹èˆ‡æ¶æ§‹è¨­è¨ˆæ„Ÿåˆ°è‘—è¿·ï¼Œå°å·¥ç¨‹å¸«ä¾†èªªæœ€æ£’çš„æ–‡ä»¶è«éæ–¼çµæ§‹æ¸…æ™°ã€æ²’æœ‰é‡è¤‡å†—ä½™çš„ä¹¾æ·¨ç¨‹å¼ç¢¼ï¼Œå°¤å…¶æ˜¯æŠŠéå¾€é€éäººå·¥æ“ä½œçš„ä¸ç©©å®šæ€§ä¸€åˆ‡æ”¤é–‹åœ¨é™½å…‰ä¸‹ç”¨ Code Review æ–¹å¼æª¢è¦–æ¯ä¸€å€‹ç’°ç¯€ï¼Œè®“ç¨‹å¼ç¢¼å¾å‡ºç”Ÿåˆ°éƒ¨ç½²éƒ½å¯ä»¥å®Œæ•´åœ°è¢«æª¢è¦–ï¼›\nå†è€…åœ¨ Cloud-Native æ™‚ä»£ï¼Œèƒ½å¤ è·¨å€åŸŸéƒ¨ç½²ã€ç”šè‡³æ··åˆé›²éƒ¨ç½²èƒ½å¤ è®“å…¬å¸çš„æ€§èƒ½èˆ‡æˆæœ¬ä¸Šç²å¾—æ›´å¤§çš„å½ˆæ€§\nåªæ˜¯åœ¨å­¸ç¿’éç¨‹ä¸­ï¼Œè¢«ä¸€å †æŠ€è¡“å·¥å…·è½Ÿç‚¸ï¼Œæ¯å€‹å·¥å…·ä¹‹é–“åˆæœ‰äº›é‡è¤‡åˆä¸æ€éº¼ç›¸åŒçš„åŠŸèƒ½ï¼Œåˆæˆ–æ˜¯æŠ½è±¡ç•«å±¤ç´šä¸åŒ (Container vs VM)ï¼Œåƒæ˜¯ Chef / Ansible / Terraform / Kubernetes / Docker ç­‰ç­‰ï¼Œæ¯æ¬¡æ±å­¸ä¸€äº›è¥¿å­¸ä¸€äº›ç¸½æ˜¯ä¸€å€‹é ­å…©å€‹å¤§ï¼Œæœ€è¿‘çœ‹äº†ä¾†è‡ª Hashicorp çš„ä»‹ç´¹å½±ç‰‡ä»¥åŠä¸€ç¯‡æ–‡ç« æ•´ç†ï¼Œè¦ºå¾—åœ¨è§€å¿µä¸Šæ›´åŠ çš„èæœƒè²«é€šï¼Œè‡³å°‘æ›´æ¸…æ¥šçŸ¥é“ éƒ¨ç½²çš„æµç¨‹ èˆ‡å°æ‡‰çš„å·¥å…·æ‡‰ç”¨\nWhy we use Terraform and not Chef, Puppet, Ansible, SaltStack, or CloudFormation\nç°¡å–®ç¸½çµä¸€ä¸‹ä¸Šé¢å…©å€‹åƒè€ƒè³‡æ–™çš„æƒ³æ³•\nApplication Delivery with HashiCorp ç•¶åœ¨é–‹ç™¼æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œè¦æ­£ç¢ºåœ°äº¤ä»˜åˆ°ç”¨æˆ¶æ‰‹ä¸­æœ‰ä¸€æ®µè·¯è¦èµ°ï¼Œä¸»è¦åˆ†æˆå¹¾å€‹éšæ®µ\n1. Write æœ¬åœ°é–‹ç™¼ åœ¨æœ¬åœ°ç«¯é–‹ç™¼æ™‚ï¼Œé–‹ç™¼è€…æœƒéœ€è¦æœ‰è·Ÿæ­£å¼ç’°å¢ƒé¡ä¼¼çš„é…ç½®ï¼Œä¾‹å¦‚è³‡æ–™åº«ç­‰ï¼Œé€™æ™‚å€™å¯ä»¥ç”¨ Vagrant å»ºåˆ¶é–‹ç™¼ç’°å¢ƒ\n2. Test æ¸¬è©¦ é€²è¡Œæ¸¬è©¦æ™‚ä¹Ÿéœ€è¦ä¸€å€‹ä¹¾æ·¨ã€ç¨ç«‹ã€èˆ‡æ­£å¼ç’°å¢ƒæ¥è¿‘çš„é…ç½®ï¼ŒåŒæ¨£èƒ½ç”¨ Vagrant\n3. Package æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼ ç•¶ç¨‹å¼ç¢¼æ¸¬è©¦å®Œï¼Œè¦æº–å‚™éƒ¨ç½²æ™‚ï¼Œé‚„éœ€è¦æŠŠè¨­å®šæª”ã€ç’°å¢ƒè®Šæ•¸ç­‰ä¸€ä½µæ‰“åŒ…è®Šæˆä¸€å€‹å¯éƒ¨ç½²çš„æœ€å°å–®å…ƒï¼Œæ­¤æ™‚èƒ½ç”¨ Packer ä¾æ“šä¸åŒç’°å¢ƒ(AWS/GCP\u0026hellip;)æ‰“åŒ…å‡º Image\n4. Provision (Day1/Day2+) æ©Ÿå™¨çš„ç’°å¢ƒè¨­å®š æ‡‰ç”¨ç¨‹å¼éœ€è¦å®Œæ•´çš„æ¶æ§‹è¨­è¨ˆï¼Œä¾‹å¦‚èªª CDN / DNS / Networking / Firewall / Storage System ç­‰ç­‰ï¼Œé€™æ™‚å€™å¯ä»¥ç”¨ Terraform é…ç½® dev/stage/prod ç’°å¢ƒ\n5. Deploy éƒ¨ç½²æ–¹å¼ (Orchestration) éƒ¨ç½²æ–¹å¼å¸¸è¦‹æœ‰ Canary / Blue-Green ç­‰ï¼Œåˆæˆ–æ˜¯é‡åˆ°æµé‡èµ·ä¼æ™‚çš„ Auto-Scalingï¼Œå¯ä»¥ç”¨ Nomandï¼Œå°‡ Dev è·Ÿ Ops ç¨ç«‹æ‹†åˆ†ï¼ŒDev åªéœ€è¦å°ˆæ³¨åœ¨éœ€è¦çš„é‹ç®—è³‡æºã€éƒ¨ç½²æµç¨‹çš„æŒæ¡ï¼ŒOps å‰‡è² è²¬åº•å±¤çš„æ©Ÿå™¨é…ç½®ã€æ•¸é‡ç®¡æ§ã€æ©Ÿå™¨çš„å®‰å…¨æ€§è£œä¸ç­‰\n6. Monitor ç›£æ§ Hashicorp ç›®å‰æ²’æœ‰ç›´æ¥ç›¸é—œçš„ç”¢å“ï¼Œä½†æœ‰æä¾› Consulï¼Œå¦‚æœæ˜¯æ¡ç”¨ Microservice / SOA æ¶æ§‹ï¼Œå…§éƒ¨æœå‹™é–“å¦‚ä½•ç™¼ç¾å½¼æ­¤éœ€è¦å…§éƒ¨çš„ DNSè™•ç† / æ©Ÿå™¨è¦æ€éº¼ç®¡ç† config éƒ½æ˜¯å€‹å•é¡Œï¼ŒConsul é€é Key/Store å„²å­˜è§£æ±ºé€™é¡çš„å•é¡Œ\n7. Security! å¦ä¸€å€‹ä¸å†æµç¨‹ä¸­ä½†é–‹ç™¼è€…éœ€æ™‚æ™‚ç‰¢è¨˜åœ¨å¿ƒ Securityï¼Œä¸€èˆ¬ä¾†èªª key æœƒåœ¨æ‰“åŒ…éšæ®µè¢«ä¸€ä¸¦æ”¾é€²ï¼Œä½†æ˜¯é€™æ¨£ç›¸å°ä¸å¤ªå®‰å…¨ï¼ŒVault æä¾›key è‡ªå‹• rotate / ä¸­å¿ƒåŒ–ç®¡ç† credential / ä¸­å¿ƒåŒ–è™•ç†åŠ è§£å¯†éç¨‹ï¼Œé™ä½æ©Ÿå™¨è¢«æ”»é™·å¾Œçš„å½±éŸ¿èˆ‡æ›´å¿«é€Ÿå½ˆæ€§çš„æ›¿æ› keyï¼Œå¢åŠ å®‰å…¨æ€§ä¿è­‰\nä»¥ä¸Šå·¥å…·éƒ½èƒ½å¤ æ•´åˆ VM / Container based çš„ç’°å¢ƒï¼Œä¹Ÿæœ‰è¨±å¤šä¸åŒçš„æ›¿ä»£æ–¹æ¡ˆï¼›\nä¾‹å¦‚ Docker å¯ä»¥å–®ç¨åƒæ‰ Write/Test/Package çš„åŠŸèƒ½ï¼ŒK8S å‰‡è² è²¬ Deploy èˆ‡ Monitoringï¼Œå¦‚æœæ˜¯è¨—ç®¡æ–¼ Cloud å‰‡ç”± Cloud è² è²¬ éƒ¨åˆ†Provisionçš„åŠŸèƒ½(å¦‚ Load Balancerï¼Œä½†ä¸æœƒè‡ªå‹•è¨­å®š Public DNS æˆ– S3 é€™é¡æ¶æ§‹)\nå…¶ä¸­ Nomand è·Ÿ K8S æ¯”è¼ƒæ˜¯äº’è£œçš„å·¥å…·ï¼ŒHashicorp æåˆ° K8s ä¸Šæ‰‹å­¸ç¿’æ›²ç·šå¤ªé«˜ï¼Œå¾ˆå¤šæ™‚å€™æˆ‘å€‘ä¸ä¸€å®šè¦é€™éº¼è¤‡é›œä½†å¼·å¤§çš„å·¥å…·ï¼Œå¦‚æœåŸæœ¬æ˜¯ VM based æ¶æ§‹é‚£ç”¨ Nomand ç®¡ç†éƒ¨ç½²æœƒè¼•é¬†ã€ç›´è§€å¾ˆå¤š\nWhy we use Terraform and not Chef, Puppet, Ansible, SaltStack, or CloudFormation é€™ç¯‡çš„ä½œè€…éå¸¸å²å®³ï¼Œä¹‹å‰æ‹œè®€äº†å…¨éƒ¨çš„ Terraform æ•™å­¸å€‹äººè¦ºå¾—æ¯”å®˜ç¶²æ›´å¯¦åœ¨ï¼Œé€™ä¸€ç¯‡æ–‡ç« å«é‡‘é‡ä¸€æ¨£è¶…é«˜ï¼Œå¾æ›´é«˜å±¤ç´šçš„è§’åº¦çœ‹é€™é¡å‹çš„å·¥å…·ï¼ŒChef, Puppet, Ansible, SaltStack ä¸»è¦æ˜¯åš Configuration managementï¼Œä¹Ÿå°±æ˜¯ä¸€å°ä¹¾æ·¨çš„æ©Ÿå™¨å•Ÿå‹•å¾Œè¦åšä»€éº¼é…ç½®ï¼Œä¾‹å¦‚ API Server éœ€è¦å®‰è£ program runtime ä¸¦éƒ¨ç½²ç¨‹å¼ç¢¼ / DB server è¦å®‰è£ DB ä¸¦æ­é…å®‰å…¨æ€§é…ç½®ç­‰ç­‰\nè€Œ Terraform / CloudFormation æ˜¯ Provisionï¼Œæ˜¯é…ç½®æ•´å€‹æ¶æ§‹ï¼Œæ‰€ä»¥å…©è€…çš„è¨è«–é¢å‘ä¸åŒï¼Œé›–ç„¶åƒ Ansible ä¹Ÿèƒ½åšä¸€äº› Provision å·¥ä½œï¼Œä½†ç›¸è¼ƒå°±ä¸é©åˆ\næ¥è‘—æ˜¯ Mutable / Immutable çš„å•é¡Œï¼ŒChef/Ansible ç­‰å·¥å…·åœ¨ç”¢ç”Ÿé…ç½®è®ŠåŒ–æ™‚æœƒåœ¨åŒä¸€å°æ©Ÿå™¨ç™¼ç”Ÿï¼Œä¹Ÿå°±æ˜¯ Mutableï¼Œç•¶ç´¯ç©çš„è®ŠåŒ–è®Šå¤šæ™‚å¯èƒ½æœƒæœ‰é…ç½®è¡çªçš„å•é¡Œï¼›\nå¦‚æœæ˜¯ç”¨ Terrform æ­é… Packer/Docker ç­‰ï¼Œæ¯æ¬¡éƒ½æœƒç”¢ç”Ÿæ–°çš„æ©Ÿå™¨ï¼Œæ‰€ä»¥æ˜¯ Immutableï¼Œè¡Œç‚ºç›¸å°æ¯”è¼ƒå–®ç´”ä¸”å¯é æ¸¬\næ¥è‘—ä½œè€…é‚„å¾èªæ³•ä¸Šã€ç®¡ç†ä¸Šã€ç¤¾ç¾¤å¤§å°åšäº†æ¯”å°ã€‚\næŠ€è¡“å±¤é¢ä¸Šå¯ä»¥åšä¸åŒæ··æ­ï¼Œä¾‹å¦‚ Terraform + Ansibleï¼Œé…ç½®å¥½æ¶æ§‹å¾Œç”¨ Ansible ç®¡ç†æ¯ä¸€å°æ©Ÿå™¨çš„è¨­å®šï¼› åˆæˆ–æ˜¯ Terraform + Packer + Docker + Kubernetesï¼Œä¸€æ¨£æ¶æ§‹é…ç½®å¥½ä¸”æ©Ÿå™¨çš„ Image é è¨­éƒ½è£æœ‰ Docker èˆ‡ K8s agentï¼Œå¾ŒçºŒç”¨ K8s ç®¡ç†éƒ¨ç½²çš„æµç¨‹\nå¯¦ä½œ çœ‹å®Œå°æ–¼æ•´å€‹éƒ¨ç½²æµç¨‹èˆ‡å·¥å…·æ›´åŠ çš„ç†è§£äº†ï¼Œæ­¤æ™‚ç•¶ç„¶è¦æŒ‘æˆ°è‡ªå·±å‹•æ‰‹æ­å»ºæ•´å€‹ç’°å¢ƒï¼Œä»¥ API Server + DB çš„æ¶æ§‹å»æŒ‘æˆ° Hashicorp å…¨å¥—å·¥å…·éŠï¼Œå¸Œæœ›ç”¨ä¸€å€‹æœˆå·¦å³æ™‚é–“å®Œæˆï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„æ•™å­¸è¨˜éŒ„ï¼Œå¸Œæœ›èƒ½å¤ å¹«åŠ©åˆ°å¤§å®¶\nVagrant æ•™å­¸-ä¸€éµå•Ÿå‹•é…ç½®é–‹ç™¼ç’°å¢ƒ\nPacker æ•™å­¸- æ‰“é€  Image Vault æ•™å­¸-é›†ä¸­åŒ–ç®¡ç†æ©Ÿæ•è³‡æ–™ (ä¸Š) \u0026hellip;å¾…çºŒ\n","date":"2020-04-12T02:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-04-12-infrusture-as-code-%E6%8C%91%E6%88%B0%E8%B3%BD-hashicorp-%E5%B7%A5%E5%85%B7%E9%8F%88%E5%85%A8%E6%95%99%E5%AD%B8/","title":"Infrusture as Code æŒ‘æˆ°è³½ - Hashicorp å·¥å…·éˆå…¨æ•™å­¸"},{"content":"å…¬å¸ä»Šå¹´åº¦é–‹å§‹å…¨é¢å°å…¥æ•¸æ“šé©…å‹•è¨­è¨ˆï¼Œæ¯å€‹éƒ¨é–€çš„æ‰€æœ‰å°ˆæ¡ˆéƒ½å¿…é ˆæœ‰æ˜ç¢ºçš„æ•¸æ“šè©•ä¼°æˆæ•ˆï¼Œèº«ç‚ºä¸€å€‹å·¥ç¨‹å¸«ï¼Œçœ‹åˆ°å…¬å¸å¾€æ›´æœ‰é‚è¼¯çš„æ–¹å¼çµ„ç¹”å°ˆæ¡ˆï¼Œç”¨æ›´å¤šçš„ç†æ€§æ•¸æ“šç•¶ä½œä¾æ“šä¾†å®‰æ’åšäº‹çš„å„ªå…ˆé †åºæ„Ÿåˆ°é–‹å¿ƒï¼Œé€™è®“æˆ‘å€‘æ“ºè„«çª®å¿™çš„å±€é¢ï¼Œå°ˆæ³¨åœ¨åŸ·å¾—æŠ•è³‡çš„é …ç›®ä¸Šï¼›\nä½†å¦ä¸€æ–¹é¢ä¹Ÿæ„Ÿåˆ°æ†‚æ…®ï¼Œæ˜¯ä¸æ˜¯ä»»ä½•ç¾éšæ®µç„¡æ³•ä½¿ç”¨æ•¸æ“šè¡¡é‡çš„äº‹ç‰©å°±å®Œå…¨ä¸é‡è¦ï¼Ÿä¾‹å¦‚ç”¨æˆ¶é«”é©—ã€å·¥ç¨‹å“è³ªç­‰ç­‰ï¼Œæ˜¯ä¸æ˜¯æˆ‘å€‘èµ°å‘æ•¸æ“šçš„åŒæ™‚å°±æˆäº†å®Œå…¨ç™¾åˆ†ç™¾çš„è³ºéŒ¢æ©Ÿå™¨ï¼Ÿ\nåŸºæ–¼é€™æ¨£çš„è€ƒé‡ï¼ŒåŒäº‹æ¨è–¦äº†é€™æœ¬æ›¸ã€ŠDesigning with Data å–„ç”¨æ•¸æ“šå¹«ä½ æ‰“é€ å¥½è¨­è¨ˆã€‹\n\u0008é€™æœ¬æ›¸ä»¥è¨­è¨ˆå¸«ç‚ºå‡ºç™¼ï¼Œé—¡è¿°æ•¸æ“šæ˜¯è¨­è¨ˆå¸«çš„å¥½æœ‹å‹ï¼Œè€Œä¸æ˜¯æ‰¼æ®ºå‰µæ„çš„ç‰¢ç± ï¼ŒåŒæ¨£çš„é€™å¥è©±æˆ‘è¦ºå¾—ä¹Ÿèƒ½å¥—ç”¨åˆ°å·¥ç¨‹å¸«èº«ä¸Š(å·¥ç¨‹å¸«ä¹Ÿæ˜¯æœ‰å°å“è³ªè¦æ±‚çš„æµªæ¼«)\nå¦‚æœä½ è·Ÿæˆ‘æœ‰ä¸€æ¨£çš„æ“”æ†‚ï¼Œåˆæˆ–æ˜¯æƒ³çŸ¥é“è‰¯å¥½çš„æ•¸æ“šé©…å‹•è¨­è¨ˆæ˜¯æ€éº¼æ­£å‘çš„æ¨å‹•ï¼Œé€™æœ¬æ›¸ç„¡ç–‘æ˜¯å€‹å¾ˆæ£’çš„å…¥é–€æ›¸ (æˆ‘å€‘å…¬å¸çš„è³‡æ·± UX è¨­è¨ˆå¸« / PM éƒ½æ¨è–¦é–±è®€)\næ•¸æ“šæ€ç¶­ æ•¸æ“šçš„æœ¬èº«åªæ˜¯å€‹å–®ç´”çš„è¨ˆæ•¸ï¼Œä»–å¯ä»¥æ˜¯ç¶²é ä¸ŠæŒ‰éˆ•é»æ“Šçš„æ¬¡æ•¸ã€ç”¨æˆ¶åœç•™çš„æ™‚é–“é•·ï¼Œåˆæˆ–æ˜¯ app store çµ¦äºˆçš„è©•åƒ¹æ˜Ÿç­‰ï¼Œæ•¸æ“šæ˜¯å€‹ç†æ€§ä¸”æ²’æœ‰æ„ç¾©çš„å­˜åœ¨ï¼Œåªæœ‰ç•¶äººå€‘è§£è®€æ™‚æ‰è³¦äºˆäº†å«ç¾©\nç•¶æˆ‘å€‘é–‹å§‹è§£è®€æ•¸æ“šï¼Œå¯ä»¥åˆ†æˆä¸‰å€‹å±¤æ¬¡çš„æ€ç¶­\næ•¸æ“šé©…å‹•\næ•¸æ“šçš„è¡¨ç¾å¾ˆæ˜ç¢ºï¼Œå¯ä»¥ç›´æ¥å›ç­”åœ˜éšŠçš„å•é¡Œï¼Œä¸¦é©…å‹•çµè«–çš„ç”¢ç”Ÿ ä¾‹å¦‚èªªå¸Œæœ›é€éæ”¹å–„ä»˜è²»é é¢å¢åŠ è½‰æ›ç‡ï¼Œæ­¤æ™‚é€éå¯¦é©—è§€å¯Ÿåˆ°è½‰æ›ç‡çš„é«˜æˆ–ä½ï¼Œå°±èƒ½æœ‰æ˜ç¢ºçš„çµè«–çŸ¥é“æ”¹å–„æ˜¯å¦æœ‰æ•ˆ\næ•¸æ“šå•Ÿç¤º\nç•¶é¢å°ä¸€å€‹æ¨¡ç³Šä¸æ¸…çš„é ˜åŸŸï¼Œåœ˜éšŠéœ€è¦èŠ±ä¸€äº›æ™‚é–“ç ”ç©¶èˆ‡æ¢ç´¢æ‰èƒ½æ˜å®šç›®æ¨™ï¼Œæ­¤æ™‚æ•¸æ“šçš„ç”¨é€”ä¸æ˜¯çµ¦äºˆä¸€ç¿»å…©çªçœ¼çš„çµè«–ï¼Œè€Œæ˜¯å¾ä¸­çš„å·®ç•°å»è§£è®€å¯èƒ½æ€§ å¦å¦‚èªªä¹‹å‰å…¬å¸ç‚ºäº†ç­è§£ç”¨æˆ¶å°æ–¼ç™»å…¥æ–¹å¼çš„æƒ³æ³•ï¼Œå¢è¨­å¤šå€‹ç¬¬ä¸‰æ–¹ç™»å…¥çš„æ–¹å¼ï¼Œæˆ‘å€‘ä¸æœŸå¾…é€™æ¬¡å¯¦é©—å¾Œå°±æ‹æ¿è¦ä¸è¦å°å…¥ç¬¬ä¸‰æ–¹ç™»å…¥ï¼Œè€Œæ˜¯å–®ç´”æ¢ç´¢ç”¨æˆ¶çš„åæ‡‰ï¼Œä¸¦åˆ†æå¢åŠ ç™»å…¥é€šéç‡çš„å¯è¡Œæ–¹æ¡ˆ å¾€å¾€æ˜¯å…ˆæœ‰äº†æ•¸æ“šå•Ÿç¤ºï¼Œç¶“éå¹¾æ¬¡çš„æ¢ç´¢æœ‰äº†æ›´æ˜ç¢ºçš„å‡è¨­èˆ‡ç›®æ¨™ï¼Œæ¥è‘—å°±æ‹†åˆ†æˆå¤šå€‹æ•¸æ“šé©…å‹•çš„å¯¦é©—\næ•¸æ“šæ„è­˜\nç•¶æˆ‘å€‘ç¿’æ…£æ•¸æ“šæ€è€ƒå¾Œï¼Œé–‹å§‹æ‰“é€ å®Œæ•´çš„æ•¸æ“šæ”¶é›†ç³»çµ±ï¼Œè®“æ•´å€‹ç”¢å“çš„æµç¨‹éƒ½èƒ½ç”¨æ•¸æ“šå»è§£é‡‹èˆ‡å‘ˆç¾ ä¾‹å¦‚èªªå…¬å¸ä¹‹å‰æƒ³è¦è¡¡é‡æ–°ç”¨æˆ¶çš„é«”é©—ï¼Œé‡æ–°å®šç¾©æ•¸æ“šæ”¶é›†çš„å…§å®¹èˆ‡æ ¼å¼ï¼Œç”¨æ•¸æ“šç´€éŒ„æŠµé”ç¬¬ä¸€å€‹ã€Œa ha momentã€çš„ç”¨æˆ¶é«”é©—é‡Œç¨‹ï¼Œé€™æˆäº†å¾ŒçºŒè©•ä¼°å°ˆæ¡ˆæˆæ•ˆçš„é‡è¦æŒ‡æ¨™\nç‚ºä»€éº¼éœ€è¦æ•¸æ“š ç•¶æˆ‘å€‘åœ¨æ‰“é€ ä¸€é …ç”¢å“ï¼Œæˆ‘å€‘éƒ½å¸Œæœ›æœ‰å¾ˆå¤šçš„ç”¨æˆ¶èƒ½å¤ ä½¿ç”¨è€Œå—æƒ ï¼Œé€²è€Œä»˜è²»è®“æ•´å€‹å•†æ¥­æ¨¡å¼å¯ä»¥é‹è½‰ï¼ŒæŒçºŒæ‰“é€ èƒ½å¤ è§£æ±ºç”¨æˆ¶ç—›é»çš„å¥½ç”¢å“\nä½†æ˜¯æˆ‘å€‘è¦å¦‚ä½•çŸ¥é“ã€Œç”¨æˆ¶æ˜¯ä¸æ˜¯çœŸçš„æ»¿æ„æˆ‘å€‘çš„ç”¢å“ï¼Ÿã€ã€Œæ¨å‡ºçš„æ–°åŠŸèƒ½æ˜¯ä¸æ˜¯ç”¨æˆ¶çœŸçš„è¦çš„ï¼Ÿã€ã€Œæ–°çš„ UI ä»‹é¢æˆæ•ˆæœ‰æ¯”èˆŠçš„ UI æ›´å—æ­¡è¿å—ï¼Ÿã€ã€Œæˆ‘å€‘è©²æ€éº¼åšæ‰èƒ½å¢åŠ ç‡Ÿæ”¶ï¼Ÿã€ç­‰å•é¡Œ\næˆ‘å€‘è©²å¦‚ä½•çŸ¥é“ç”¨æˆ¶çš„ä½¿ç”¨æƒ…æ³èˆ‡åé¥‹ï¼Ÿ\nå°æ–¼ç¶²è·¯ç”¢æ¥­ä¾†èªªï¼Œæ¨å‡ºç”¢å“èˆ‡æ”¶åˆ°åé¥‹çš„æ™‚é–“éƒ½éå¸¸å¿«ï¼Œåœ¨æ›´è¿‘ä¸€æ­¥è¨è«–æ•¸æ“šä¹‹å‰ï¼Œå¿…é ˆå…ˆå›æ­¸åŸé»ï¼Œå…¬å¸å†ä¸åŒçš„éšæ®µæœƒæœ‰ä¸åŒçš„æˆ°ç•¥ç›®æ¨™ï¼Œå¯èƒ½æ˜¯ç‡Ÿæ”¶çš„æˆé•·ç‡æˆ–æ˜¯ç”¨æˆ¶çš„æˆé•·æ•¸ç­‰\n[æ¡ˆä¾‹ä¸€] Netflix çš„å•†æ¥­æ¨¡å¼æ˜¯è¨‚é–±åˆ¶ï¼Œåœ¨è¨‚é–±æ–¹æ¡ˆçš„é‡‘é¡å›ºå®šä¸‹ï¼Œç”¨æˆ¶çš„è¨‚é–±æ•¸å°±æ˜¯ä»–å€‘å¾ˆé‡è¦çš„é—œéµæŒ‡æ¨™ï¼Œé—œéµæŒ‡æ¨™é€šå¸¸æ˜¯ç›´æ¥è·Ÿç‡Ÿæ”¶åšæ›é‰¤ï¼›æ¥è‘—é€éæ•¸æ“šè§€å¯Ÿåˆ°ç”¨æˆ¶çš„è¨‚é–±æ„é¡˜èˆ‡è§€çœ‹æ™‚é–“æˆæ­£æ¯”ï¼Œæ‰€ä»¥è§€çœ‹æ™‚é–“å°±æˆäº†æ¬¡è¦æŒ‡æ¨™ [æ¡ˆä¾‹äºŒ] Coursera çš„å•†æ¥­æ¨¡å¼æ˜¯é€éè²©å”®èª²ç¨‹å®Œæˆçš„çµæ¥­è­‰æ›¸ï¼Œä»–å€‘çš„æ¬¡è¦æŒ‡æ¨™æ˜¯ç”¨æˆ¶æ˜¯å¦é€šéç¬¬ä¸€æ¬¡è€ƒè©¦ã€ç”¨æˆ¶åœ¨ä¸€é€±å…§æ˜¯å¦æœ‰åè¦†å›ä¾†é€ è¨ªç¶²é  åœ¨è³‡æºæœ‰é™çš„æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘å¿…é ˆæŒçºŒä¸”å¿«é€Ÿçš„å˜—è©¦ï¼Œé—œéµæŒ‡æ¨™åæ‡‰å¯èƒ½æœƒæ¯”è¼ƒæ…¢ï¼Œæ‰€ä»¥æœƒéœ€è¦æœ‰å…¶ä»–çš„æ¬¡è¦æŒ‡æ¨™å»è§€å¯Ÿå˜—è©¦çš„çµæœï¼Œç”¨æ¯ä¸€æ¬¡çš„å­¸ç¿’å»å¾€æ¬¡è¦æŒ‡æ¨™èˆ‡é—œéµæŒ‡æ¨™é‚é€²ï¼Œå› æ­¤å¿«é€Ÿä¸”æ­£ç¢ºçš„è©•ä¼°ç”¨æˆ¶çš„åæ‡‰ï¼Œå°±æ˜¯ä»¶éå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå¸¸è¦‹çš„æ‰‹æ®µåˆ†æˆé‡åŒ–ç ”ç©¶èˆ‡è³ªåŒ–ç ”ç©¶\né‡åŒ–ç ”ç©¶ ä¸»è¦æ˜¯é€éå®¢è§€çš„è§€å¯Ÿå¤§é‡ç”¨æˆ¶çš„è¡Œç‚ºï¼Œé€éçµ±è¨ˆåˆ†ææ¢è¨ã€Œç”¨æˆ¶æ˜¯å¦‚ä½•æ“ä½œç”¢å“ / ç”¨æˆ¶æ€éº¼æ“ä½œé€™é …åŠŸèƒ½ã€\nè³ªåŒ–ç ”ç©¶ é€éç”¨æˆ¶è¨ªè«‡æˆ–ä½¿ç”¨æ€§æ¸¬è©¦ï¼Œèˆ‡å°‘é‡çš„ç”¨æˆ¶é€²è¡Œæ·±åº¦çš„è¨ªè«‡ï¼Œè—‰æ­¤äº†è§£ç”¨æˆ¶çš„çœŸå¯¦æƒ…ç·’åæ‡‰ï¼Œæ›´æ³¨é‡æ–¼ã€Œç‚ºä»€éº¼ç”¨æˆ¶æœƒæ€æ¨£æ€è€ƒã€ç­‰å•é¡Œ\né‡åŒ–ç ”ç©¶èˆ‡è³ªåŒ–ç ”ç©¶ç›¸è¼”ç›¸æˆï¼Œä¾‹å¦‚èªªå…¬å¸æ¨å‡ºäº†æ–°çš„ä»˜è²»æ–¹æ¡ˆï¼Œé€éé‡åŒ–ç ”ç©¶ç™¼ç¾æ•´é«”ç”¨æˆ¶çš„çºŒè¨‚ç‡ä¸‹é™äº†ï¼Œé€™æ™‚å€™å°±é€éè¨ªè«‡æ–¹å¼å»äº†è§£åˆ°ç”¨æˆ¶çœ‹åˆ°å¤šå€‹æ–¹æ¡ˆåè€Œä¸æ¸…æ¥šå…¶ä¸­çš„å·®ç•°ï¼Œå°è‡´è€ƒæ…®çš„æ™‚é–“æ‹‰é•·ç­‰ç•¶åˆè¨­è¨ˆæ–¹æ¡ˆæ™‚æ¬ ç¼ºè€ƒæ…®çš„æ–¹å‘\né€™æœ¬æ›¸åè¦†å¼·èª¿ï¼Œæ˜¯æ•¸æ“šå„ªå…ˆè€Œéå–®ç´”æ•¸æ“šï¼Œæ„å³é‡åŒ–ç ”ç©¶æˆ–è¨±æ˜¯ä¸»è¦æ‰‹æ®µï¼Œä½†ä¹Ÿä¸èƒ½å®Œå…¨æ¨æ£„è³ªåŒ–ç ”ç©¶\nA/B æ¸¬è©¦ ç•¶æˆ‘å€‘åŸ·è¡Œå°ˆæ¡ˆå¾Œï¼Œè¦æ€éº¼æ¸…æ¥šçš„çŸ¥é“é€™æ¨£çš„çµæœæ˜¯åŸºæ–¼æˆ‘å€‘åšå‡ºçš„æ”¹è®Šï¼Œè€Œä¸æ˜¯å¤–åœ¨å› ç´ å¹²æ“¾æˆ–æ˜¯çè²“ç¢°åˆ°æ­»è€—å­ï¼Œç°¡è¨€ä¹‹è¦é‡æ¸…é«˜ç›¸é—œæ€§èˆ‡å› æœæ€§ï¼Œåœ¨æ­¤æ¨è–¦ä¸€ç¯‡ whoscall åœ˜éšŠéå¸¸æ£’çš„æ–‡ç«  æ•¸æ“šåˆ†æçš„åŠ›é‡\nç‚ºäº†æ‰¾å‡ºå› æœæ€§ï¼Œå¯ä»¥å¥—ç”¨ç§‘å­¸å¯¦é©—çš„æ–¹æ³•ï¼Œ\næ‹†åˆ†åŒè³ªçš„å°ç…§çµ„èˆ‡å¯¦é©—çµ„ï¼Œæ§åˆ¶ä¸€æ¬¡æ”¹è®Šä¸€å€‹è‡ªè®Šæ•¸çš„æƒ…æ³ä¸‹ï¼Œè§€å¯Ÿæ‡‰è®Šæ•¸çš„è®ŠåŒ–é—œä¿‚\nä¹Ÿç¨±ä½œç‚º A/B æ¸¬è©¦ï¼Œæ‹†åˆ†æˆ A,B å…©çµ„ï¼Œä¸€çµ„ç¶­æŒåŸæœ¬çš„è¨­è¨ˆï¼Œå¦ä¸€çµ„ä¾ç…§æˆ‘å€‘çš„å‡è¨­å¥—ç”¨æ–°çš„è¨­è¨ˆï¼Œè§€å¯Ÿå…©çµ„çš„æŒ‡æ¨™è®ŠåŒ–ï¼Œæ¨è«–å‡è¨­æ˜¯å¦æˆç«‹\nåŸºæ–¼æˆ‘å€‘çš„å•†æ¥­ç›®æ¨™èˆ‡ç¾æœ‰çš„æ•¸æ“šï¼Œæˆ‘å€‘æå‡ºå¤šçµ„å‡è¨­ï¼Œä¸¦ä¾æ“šå‡è¨­è¨­è¨ˆå¤šçµ„å¯¦é©—çµ„ï¼Œå¯¦éš›çš„æƒ…æ³å¤§æ¦‚æœƒé•·é€™æ¨£\nä»¥ä¸‹æ‹†åˆ†æˆä¸‰å€‹éšæ®µ å®šç¾© -\u0026gt; åŸ·è¡Œ -\u0026gt; è©•ä¼°\nå®šç¾© æœ‰å¹¾å€‹å•é¡Œå¯ä»¥å¹«åŠ©æ€è€ƒç›®æ¨™\nä½ æƒ³æŠŠæ™‚é–“è·Ÿç²¾åŠ›æ”¾åœ¨å“ªé‚Šç”¢ç”Ÿå½±éŸ¿åŠ› ä½ ç›¸ä¿¡ä»€éº¼å°ä½¿ç”¨è€…æ˜¯å¥½çš„ æ€æ¨£çš„ä½¿ç”¨è€…é«”é©—æˆ–æ˜¯å•†æ¥­é—œéµè­°é¡Œå¯ä»¥è¢«è¦–ç‚ºæ©Ÿæœƒé» ä»€éº¼æ˜¯æ”¹é€²ä½¿ç”¨è€…é«”é©—çš„å¥½æ©Ÿæœƒ å®šç¾©çš„ç›®æ¨™å¯ä»¥æ˜¯é‡åŒ–æŒ‡æ¨™ï¼Œä¹Ÿå¯ä»¥æ˜¯è³ªåŒ–æŒ‡æ¨™ï¼Œä¾‹å¦‚æ›¸ä¸­ä»¥è¾¦ç‡ŸéšŠç‚ºä¾‹ï¼Œã€Œå¢åŠ ç‡ŸéšŠå ±åäººæ•¸ã€å¯ä»¥æ˜¯å€‹ç›®æ¨™ï¼Œã€Œè®“ç‡ŸéšŠè®Šå¾—æ›´å¥½ç©ã€ä¹Ÿå¯ä»¥æ˜¯å€‹ç›®æ¨™ï¼›\nä½†ä¸è«–ç›®æ¨™æ˜¯é‡åŒ–é‚„æ˜¯è³ªåŒ–ï¼Œéƒ½å¿…é ˆæ‰¾åˆ°é‡æ¸¬çš„æŒ‡æ¨™ï¼Œç¢ºèªè‡ªå·±æœ‰åœ¨å¾€ç›®æ¨™é‚é€²ï¼Œè³ªåŒ–ç›®æ¨™ä¹Ÿå¯ä»¥é€šéå•å·å›æ”¶ã€ç”°é‡èª¿æŸ¥ç­‰æ–¹å¼\næŒ‡æ¨™çš„è©•ä¼° å…ˆå‰æåˆ°é—œéµæŒ‡æ¨™èˆ‡æ¬¡è¦æŒ‡æ¨™ï¼Œè¨­å®šæ¬¡é©—æŒ‡æ¨™çš„ç›®çš„åœ¨æ–¼é—œéµæŒ‡æ¨™çš„åæ‡‰é€±æœŸå¯èƒ½å¾ˆé•·ï¼Œå¦å¦‚æœˆè¨‚é–±åˆ¶è¦ç­‰åˆ°ä¸€å€‹æœˆå¾Œæ‰çŸ¥é“çµæœå¤ªæ…¢äº†ï¼›\nåˆæˆ–æ˜¯é—œéµæŒ‡æ¨™å¤ªä¸æ•æ„Ÿï¼Œåƒæ˜¯app store è©•åƒ¹ï¼Œå¦‚æœä»Šå¤©åšçš„æ˜¯å±€éƒ¨+è©•ä¼°é¡å‹çš„æ”¹å‹•ï¼Œåƒæ˜¯èª¿æ•´æŒ‰éˆ•å¤§å°èˆ‡é¡è‰²ï¼Œä¼°è¨ˆæ˜¯ä¸æœƒå¾ˆå¿«åæ˜ åœ¨è©•åƒ¹ä¸Šï¼Œæ‰€ä»¥éœ€è¦é¡å¤–çš„æŒ‡æ¨™è¡¡é‡\næŒ‡æ¨™ä¹‹é–“çš„è¡çª ç›®æ¨™çš„åˆ¶å®šæ˜¯ç§‘å­¸ä¹Ÿæ˜¯è—è¡“ï¼Œä¾‹å¦‚ eBay çš„äº¤æ˜“åª’åˆçš„æ–¹å¼æ˜¯è³£å®¶ä¸Šæ¶å•†å“ + è²·å®¶ä¸‹æ¨™å…©è€…å‹•ä½œçµåˆï¼Œä»–å€‘é€éæ•¸æ“šç™¼ç¾åœ¨æŸäº›æƒ…æ³ä¸‹è²·å®¶æ£„æ¨™çš„æ¯”ä¾‹å¾ˆé«˜ï¼Œç¶“éç ”ç©¶ç™¼ç¾æ˜¯ç›®å‰çš„ä¸Šæ¶æµç¨‹æŸäº›è³‡æ–™ä¸é€æ˜ï¼Œä¾‹å¦‚è²·å®¶ä¸‹æ¨™æ‰ç™¼ç¾å•†å“åœ¨æµ·å¤–éœ€è¦é¡å¤–çš„é‹è²»è·Ÿç¨…æ”¶ï¼Œæ‰€ä»¥ä»–å€‘å¸Œæœ›ç ”ç©¶å¢åŠ å•†å“è³‡è¨Šé‡æ˜¯å¦èƒ½å¤ æ¸›å°‘æ£„æ¨™é‡ï¼Œä»–å€‘ç™¼ç¾å¢åŠ å•†å“è³‡è¨Šé‡ç¢ºå¯¦æ¸›å°‘æ£„æ¨™é‡ï¼Œä½†æ˜¯ä¹Ÿå› ç‚ºå¢åŠ è³¼è²·çš„é˜»åŠ›å°è‡´ä¸‹æ¨™æ•¸é‡ä¸‹æ»‘\né€™æ™‚å€™æ¸›å°‘æ£„æ¨™é‡å¢åŠ äº¤æ˜“å“è³ªè·Ÿä¸‹æ¨™æ•¸é‡ä¸‹æ»‘é€™å…©å€‹æŒ‡æ¨™å­°è¼•å­°é‡ï¼Œå°±è€ƒé©—åœ˜éšŠçš„åƒ¹å€¼è§€ï¼Œæ­¤æ™‚ eBay é¸æ“‡å‰è€…ï¼Œå› ç‚ºèˆ‡å…¶å¢åŠ çŸ­æœŸçš„ä¸‹æ¨™é‡ï¼Œä»–å€‘æ›´é‡è¦–ç”¨æˆ¶çš„ä¸­ã€é•·æœŸé—œä¿‚\nåŒæ¨£çš„ Airbnb ä¹Ÿé¢è‡¨éç›¸åŒçš„æŠ‰æ“‡ï¼Œä»–å€‘ç™¼ç¾æŸäº›å±‹ä¸»çš„ç‰©ä»¶æ¢ä»¶æ˜æ˜ä¸éŒ¯å»å‡ºç§Ÿæ—¥å¾ˆå°‘ï¼Œå¾Œä¾†ç™¼ç¾æ˜¯ç…§ç‰‡æ‹å¾—ä¸å¤ å¥½ã€è³‡è¨Šä¸å¤ å……åˆ†ï¼Œç•¶æ™‚å…§éƒ¨ä¸€å€‹åœ˜éšŠç›®æ¨™æ˜¯ã€Œå¢åŠ å±‹ä¸»çš„ä¸Šå‚³ç‰©ä»¶æ•¸ã€å¦ä¸€å€‹åœ˜éšŠçš„ç›®æ¨™æ˜¯ã€Œå¢åŠ å±‹ä¸»å‡ºç§Ÿçš„æ©Ÿæœƒã€ï¼Œå…©è€…åŒæ™‚å¸Œæœ›æ›´æ”¹è¨»å†Šæµç¨‹ï¼Œä¸€å€‹å¸Œæœ›ç°¡åŒ–å¦ä¸€å€‹å¸Œæœ›å±‹ä¸»æ›´æ…é‡è¨»å†Šï¼Œå¯¦é©—çš„æ–¹å‘å‰›å¥½è¡çªï¼Œæœ€çµ‚ä»–å€‘é¸æ“‡èåˆå…©è€…ç›®æ¨™å»å¹³è¡¡ï¼Œé”åˆ°æœ€ä½³çš„æˆæ•ˆ\né€™æ˜¯ä¸€å€‹ä¸æ–·åè¦†æ€ç´¢çš„éç¨‹ï¼Œå¾ç›®æ¨™åˆ°æŒ‡æ¨™çš„è¨­å®šéœ€è¦ä¾†å›çš„æª¢è¦–ï¼Œä¸¦èˆ‡å„å€‹åœ˜éšŠæºé€šä»¥å…å¯¦é©—äº’ç›¸è¡çª\nå‡èªª æœ‰äº†ç›®æ¨™å¾Œè¦é–‹å§‹ç™¼æƒ³å‡èªªï¼Œæˆ‘å€‘å¿…é ˆæ±ºå®šå°ˆæ¡ˆçš„è¦æ¨¡ä»¥åŠé è¨ˆå­¸ç¿’çš„äº‹ç‰©ï¼Œå¯ä»¥ç”¨å…©å€‹ç¶­åº¦å››å€‹è±¡é™æ‹†åˆ†ï¼šå±€éƒ¨/å…¨é¢ã€æ¢ç´¢/è©•ä¼°\næ”¹å‹•ç¯„åœå¦‚æœæ˜¯å±€éƒ¨ï¼Œé‚£ä»£è¡¨æˆ‘å€‘å¯ä»¥ç”¨è¼ƒæ¿€é€²çš„æ–¹å¼å»é‡æ¸¬ï¼Œå› ç‚ºæ½›åœ¨çš„é¢¨éšªæ¯”è¼ƒå°/\nå°ˆæ¡ˆçš„ç›®çš„å¦‚æœæ˜¯è©•ä¼°ï¼Œé‚£ä»£è¡¨çµæœå¿…é ˆå¾ˆæ˜ç¢ºçš„å›ç­”æŸäº›å•é¡Œï¼Œåœ¨è¨­è¨ˆæ•¸æ“šæ”¶é›†æ–¹é¢å°±è¦å¾€é€™æ–¹é¢é‚é€²\nä¾‹å¦‚èªªã€Œæ”¹å‹•ä»˜è²»é é¢å¸Œæœ›æå‡è½‰æ›ç‡ã€å°±æ˜¯å€‹å±€éƒ¨+è©•ä¼°é¡å‹çš„éœ€æ±‚ï¼Œåªæ”¹å‹•ä¸€å€‹é é¢ä¸æœƒå½±éŸ¿åˆ°å…¶ä»–é—œéµé«”é©—ï¼ŒåŒæ™‚å°ˆæ¡ˆçš„çµæœæœƒç›´æ¥æ±ºå®šè¦ä¸è¦å¥—ç”¨æ–°çš„è¨­è¨ˆï¼›\nè€Œã€Œä¿®æ”¹è¦–è¦ºç³»çµ±å¸Œæœ›æ›´æ¸…æ¥šè¡¨é”ç”¢å“åƒ¹å€¼èˆ‡å“ç‰Œæ„è­˜ã€å°±æ˜¯å€‹å…¨é¢+æ¢ç´¢çš„éœ€æ±‚ï¼Œæ”¹å‹•ä¸Šç·šå¾Œç„¡æ³•ç›´æ¥å›ç­”è½‰æ›ç‡æ˜¯å¦ç›´æ¥å› æ­¤æå‡ï¼Œéœ€è¦å¾å…¶ä»–é¢å‘èˆ‡å¢åŠ é‡æ¸¬æ–¹å¼æ‰èƒ½å¾—çŸ¥å°ˆæ¡ˆçš„æˆæ•ˆ\nåˆ¶å®šå‡èªª æ¥è‘—ç”¨ä»¥ä¸‹çš„å¥å­å•è‡ªå·±\nå°æ–¼ [ä½¿ç”¨è€…é¡å‹]ï¼Œå¦‚æœ [æ”¹è®Š]ï¼Œå°±æœƒ [æ•ˆæ‡‰]ï¼Œé€™æ˜¯ç”±æ–¼ [ç†ç”±]ï¼Œä¸¦æœƒå½±éŸ¿ [é‡æ¸¬å€¼]\nä½¿ç”¨è€…é¡å‹ å¯ä»¥æ˜¯ä¸åŒçš„å­é›†ï¼Œä¾‹å¦‚èªªæ–°ç”¨æˆ¶è·ŸèˆŠç”¨æˆ¶å°±æ˜¯å¾ˆå¤§çš„å·®ç•°ï¼Œåˆæˆ–æ˜¯ä¸åŒåœ‹å®¶ã€ä¸åŒæ€§åˆ¥ç­‰ï¼Œé€™ä¾æ“šç”¢å“èª¿æ€§èˆ‡å¯¦é©—çš„æ€§è³ªä¸åŒè€Œå€éš” ä»¥ä¸‹å•é¡Œå¯ä»¥å¹«åŠ©æ€è€ƒ\nä½ å°æ–¼ä»–å€‘çš„äººå£çµæ§‹æœ‰ä»€éº¼äº†è§£ï¼Ÿä»–å€‘æœ‰ä»€éº¼ç¿’æ…£ï¼Ÿ ä»–å€‘å’Œå…¬å¸æœ‰ä»€éº¼é—œä¿‚ï¼Ÿ é€™æ˜¯ç¾æœ‰çš„ä½¿ç”¨è€…ï¼Ÿæ–°ç”¨æˆ¶ï¼Ÿå°ˆæ¥­ç”¨æˆ¶ï¼Ÿ æ”¹è®Š æ˜¯æŒ‡å¸Œæœ›ç”¨ä¾†å½±éŸ¿ä½¿ç”¨è€…çš„äº‹ç‰©ï¼Œä¸€å€‹å‡èªªå¯ä»¥å¤šç¨®ä¸åŒçš„æ”¹è®Šè¨­è¨ˆ\nä½ æ˜¯è¦å¢åŠ æ–°çš„è¨­è¨ˆï¼Ÿ é‚„æ˜¯è¦ç§»é™¤èˆŠçš„è¨­è¨ˆ æ•ˆæ‡‰ æ˜¯é æœŸå¸¶ä¾†çš„æ”¹è®Š\nä½ ç™¼ç¾çš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿä»€éº¼æ¨£çš„ç”¨æˆ¶å¯ä»¥è§£æ±ºæˆ–æ˜¯æ¸›å°‘é€™å€‹å•é¡Œï¼Ÿ ä½ ç™¼ç¾çš„æ©Ÿæœƒé ˜åŸŸæ˜¯ä»€éº¼ï¼Ÿ ç†ç”± å‰‡æ˜¯æ”¯æŒå‡èªªçš„è­‰æ“š\nä½ çš„ç†ç”±æ˜¯ä¾†è‡ªæ¶ˆè²»è€…å‹•æ©Ÿï¼Ÿé‚„æ˜¯ç”±æŸç¨®æˆ°è¡“èˆ‡æ©Ÿåˆ¶ä¾†é”æˆæ”¹è®Š æœ‰å“ªç­†è³‡æ–™æ”¯æŒé€™é …å‡èªªï¼Ÿ é‡æ¸¬ æ˜¯æƒ³è¦å½±éŸ¿çš„çµ‚æ¥µæŒ‡æ¨™ï¼Œç”¨ä¸€å€‹å®¢è§€çš„æ–¹å¼æœ€å¤§åŒ–å­¸ç¿’\nç‚ºäº†ç­è§£ä½ æ­£åœ¨å‰µé€ æ­£é¢ä¸”å¤ å¤§çš„å½±éŸ¿ï¼Œéœ€è¦è¡¡é‡ä»€éº¼æŒ‡æ¨™ï¼Ÿ ä½ æœƒé‡æ¸¬ç”¨æˆ¶çš„æƒ…ç·’å—ï¼Ÿ ä»¥ç…§ç‰‡åˆ†äº«å¹³å°ç‚ºä¾‹ï¼Œå‡èªªå¯ä»¥æ˜¯ã€Œæˆ‘å€‘é æ¸¬è—‰ç”±å¢åŠ æ¿¾é¡èˆ‡ç…§ç‰‡ç‰¹æ•ˆï¼Œæœƒæœ‰æ›´å¤šäººä½¿ç”¨æˆ‘å€‘çš„ç”¢å“ï¼Œå› ç‚ºé€™æœƒè®“ä»–å€‘çš„ç…§ç‰‡æ›´å¥½çœ‹ã€æ›´æœ‰è¶£ï¼Œè‹¥æˆ‘å€‘ç™¼ç¾ä½¿ç”¨è€…æŠ•å…¥å±¤åº¦å¢åŠ å°±çŸ¥é“å‡è¨­æ˜¯çœŸçš„ã€\næ¨£æœ¬èˆ‡ä¿¡å¿ƒç¨‹åº¦ åœ¨å®šç¾©éšæ®µï¼Œæˆ‘å€‘éœ€è¦æ˜ç¢ºæ¸¬è©¦çš„æ—ç¾¤æ˜¯å“ªäº›ï¼Œä¸¦ä¸”æ±ºå®šæ¸¬è©¦çš„æ™‚é–“é€±æœŸèˆ‡æ¨£æœ¬æ•¸ï¼Œä¾‹å¦‚èªªå‡æ—¥ä¸Šç·šçš„ç”¨æˆ¶è·Ÿå¹³æ—¥ä¸Šç·šçš„ç”¨æˆ¶å¯èƒ½ä¸åŒï¼Œå¦‚æœæ¸¬è©¦çš„é€±æœŸä¸å¤ å…¨é¢ï¼Œå®¹æ˜“å¾—åˆ°éŒ¯èª¤çš„çµè«–\nç‚ºäº†é¿å…å‡é™½æ€§(å¯¦é©—åˆ¤æ–·æœ‰æ•ˆä½†å¯¦éš›ç„¡æ•ˆ)ã€å‡é™°æ€§(å¯¦é©—åˆ¤æ–·ç„¡æ•ˆä½†å¯¦éš›æœ‰æ•ˆ)ç­‰å¯¦é©—ä¸æº–ç¢ºçš„ç‹€æ³ï¼Œæˆ‘å€‘éœ€è¦å°æ¸¬è©¦çµæœæœ‰ä¸€å®šç¨‹åº¦çš„ä¿¡å¿ƒï¼Œä¾‹å¦‚èªªæœ‰äººé€šçŸ¥å··å£å¤±ç«äº†ï¼Œå¦‚æœåªæ˜¯ä¸€å€‹äººä½ å¯èƒ½è¦ºå¾—åœ¨é–‹ç©ç¬‘ï¼Œä½†æœ‰ä¸€ç™¾äººéƒ½é€™æ¨£èªªå‹¢å¿…å°±æœƒé–‹å§‹èµ·ç–‘å¿ƒï¼Œåœ¨çµ±è¨ˆä¸Šç¨±ç‚ºä¿¡è³´å€é–“ï¼Œå¾æ¯é«”æ¡é›†æŸå€‹æ•¸é‡çš„å­æ¨£æœ¬ï¼Œå¥—ç”¨æ•¸æ“šå¾Œå¾—åˆ°ä¸€å®šçš„ä¿¡å¿ƒæ°´æº–\né¢å°ä¸åŒç­‰ç´šçš„ä¿®æ”¹æœƒéœ€è¦ä¸åŒçš„ä¿¡å¿ƒæ°´æº–ï¼ŒåŒæ™‚ä¹Ÿæœƒæ±ºå®šçµæœæ”¾é‡çš„éç¨‹ï¼Œä¾‹å¦‚èªªè·Ÿç‡Ÿæ”¶ç›¸é—œçš„æ”¹å‹•å¯èƒ½è¦æ¯”è¼ƒé«˜çš„ä¿¡å¿ƒæ°´æº–ï¼Œä»¥åŠè¼ƒè¬¹æ…ç·©æ…¢çš„æ”¾é‡éç¨‹\nå¿«é€Ÿé©—è­‰ å†é€²è¡Œç”¢å“åšå¯¦é«”æ¸¬è©¦å‰ï¼Œå¯ä»¥æ¨å‡ºä½æ“¬çœŸåº¦çš„ mockup é€²è¡Œä½¿ç”¨æ€§ç ”ç©¶ï¼Œä¾‹å¦‚ spotify å¸Œæœ›çµ±ä¸€è¦–è¦ºç³»çµ±ï¼Œä½†ä¸ç¢ºå®šè¦æ¡ç”¨æ·±è‰²é‚„æ˜¯æ·ºè‰²çš„æ–¹æ¡ˆï¼Œæ­¤æ™‚ä»–å€‘å°‡è¨­è¨ˆåŸå‹åšæˆå•å·èª¿æŸ¥å…ˆå¿«é€Ÿé©—è­‰ï¼Œæœ€çµ‚æ¡ç”¨äº†æ·±è‰²çš„æ–¹æ¡ˆï¼Œç”¨æ­¤æ¸›å°‘ä¸å¿…è¦çš„å˜—è©¦\nåœ¨å®šç¾©çš„éšæ®µï¼Œè©¦è‘—å›ç­”ä»¥ä¸‹å•é¡Œ\nä½ æƒ³è¦ç‚ºå…¬å¸é”åˆ°çš„ç›®æ¨™æœ‰å“ªäº›ï¼Ÿ åœ¨ä½ çš„è©¦é©—ä¸­ï¼Œæœ€é‡è¦å­¸ç¿’åˆ°çš„æœƒæ˜¯ä»€éº¼ï¼Ÿ åœ¨ç”Ÿæˆå‡èªªæ™‚ï¼Œé‹ç”¨äº†å“ªäº›æ•¸æ“šï¼Ÿ åœ¨æŒ‘é¸å‡èªªæ™‚ï¼Œæ˜¯å¦çœŸçš„ç”Ÿæˆäº†æ‰€æœ‰çš„å‡èªªï¼Ÿ åŸ·è¡Œ é€™ä¸€å€‹éšæ®µæ˜¯å¦‚ä½•é€éè¨­è¨ˆå‘ˆç¾å‡èªªï¼Œä¾‹å¦‚ Netflix æƒ³è¦æ¸¬è©¦ ã€Œåœ¨é¦–é å¢åŠ é›»å½±çš„é¸æ“‡æ•¸ç›®æ˜¯å¦æœƒå¢åŠ éŠ·é‡ã€ï¼Œä½†æ˜¯å¢åŠ é¸æ“‡æ•¸ç›®æœ‰å¾ˆå¤šç¨®æ–¹å¼ï¼Œè¨­è¨ˆåœ˜éšŠæå‡º[å¢åŠ é›»å½±é¡åˆ¥æ•¸]æˆ–[é¡åˆ¥ä¸­é›»å½±çš„æ•¸é‡] (å»£åº¦èˆ‡æ·±åº¦)ï¼Œåˆ†åˆ¥æ¶‰åŠæˆä¸‰å€‹å¯¦é©—\n25 x 100 50 x 75 50 x 100 æœ€çµ‚ç™¼ç¾ä¸­é–“çš„å¯¦é©—æ•ˆæœæœ€å¥½ åœ¨ A/B Testing äº”å¤§å¿…æ®ºæ‹›æ•¸ï¼Œè®“ä½ è½‰æ›ç‡ç«‹é¦¬æå‡ 200% - Day 12 / 200, #EverythingAboutGrowth æ–‡ç« ä¸­åˆ†äº«ä¸€æ®µå¾ˆç²¾é—¢çš„è¦‹è§£\nå¥½çš„å¯¦é©—å‡è¨­ï¼Œéƒ½æ˜¯å¥ åŸºæ–¼ä½¿ç”¨è€…è¡Œç‚ºèˆ‡å¿ƒç†è„ˆçµ¡ç™¼å±•è€Œæˆ\n1 2 3 4 5 6 7 ã€åŠŸèƒ½æ€§å‡è¨­ã€‘ - æŒ‰éˆ•å¾è—è‰²è®Šç´…è‰²ï¼Œæœƒæå‡è½‰æ›ç‡ - æŠŠåœ–ç‰‡ç”±å°æ”¾å¤§ï¼Œæœƒæå‡è½‰æ›ç‡ ã€è¡Œç‚ºå¿ƒç†è„ˆçµ¡å‡è¨­ã€‘ - æ—…å®¿é é¢åŠ å¼·æ€¥è¿«æ„Ÿï¼Œæœƒæé†’ä½¿ç”¨è€…æœ‰è¨‚ä¸åˆ°æˆ¿çš„å¯èƒ½æ€§èˆ‡å£“åŠ›ï¼Œé€²è€Œæå‡è½‰æ›ç‡ - æœå°‹åˆ—è¡¨é è®“æ›´å¤šå•†å“èƒ½ä¸€æ¬¡æ˜ å…¥çœ¼ç°¾ï¼Œèƒ½å¹«åŠ©ä½¿ç”¨è€…å®¹æ˜“æ¯”è¼ƒå¤šé–“æ°‘å®¿ä¸¦æ‰¾åˆ°å–œæ­¡æ°‘å®¿ï¼Œé€²è€Œæå‡è½‰æ›ç‡ åˆ‡è¨˜æ¯å€‹å°ˆæ¡ˆçš„é‡é»è¦æ”¾åœ¨å­¸ç¿’èˆ‡æª¢è¨ï¼Œè€Œä¸æ˜¯åšå®Œæ²’æœ‰æˆæ•ˆå°±ç®—äº†ï¼Œæ“ºæ­£å¿ƒæ…‹æ‰èƒ½ä¸æ–·çš„èª¿æ•´èˆ‡æ”¹å–„\nå¥½çš„å¯¦é©—ä¸¦éœ€æ˜å®šç›®æ¨™ï¼Œä¸¦å¹³è¡¡å­¸ç¿’çš„ç´°åº¦ä»¥åŠæ¸¬è©¦çš„é …ç›®ï¼Œåœ¨éç¨‹ä¸­å¯èƒ½æœƒåŒæ™‚æœ‰å¤šå€‹å‡èªªèˆ‡å¯¦é©—å†é€²è¡Œï¼Œé€éä¸æ–·åœ°æª¢è¦–èˆ‡å­¸ç¿’ï¼Œå¯ä»¥æ¨æ£„æˆ–æ˜¯å¢åŠ æ¸¬è©¦é …ç›®\nå‡é–€æ¸¬è©¦ (Fake door) å¯ä»¥å†æŠ•å…¥å®Œå…¨å·¥ç¨‹é–‹ç™¼è³‡æºå‰ï¼Œå…ˆåšå‡çš„ä»‹é¢å¯ä»¥äº’å‹•ä½†èƒŒå¾Œçš„å·¥ç¨‹é‚è¼¯å…ˆå¿½ç•¥ï¼Œæ¸¬è©¦ç”¨æˆ¶æ˜¯å¦çœŸçš„æœ‰éœ€æ±‚ï¼Œå‡é–€æ¸¬è©¦ç›¸æ¯”å•å·å¯ä»¥çœŸå¯¦åæ‡‰ç”¨æˆ¶çš„éœ€æ±‚ï¼Œä½†è¦å°å¿ƒæœ‰å¯èƒ½æƒ¹æƒ±ç”¨æˆ¶ï¼Œæ‰€ä»¥åœ¨æŠ•æ”¾çš„éç¨‹æ‡‰è©²è¦ä¿å®ˆ\nä¾‹å¦‚æˆ‘å€‘å…¬å¸ç‚ºäº†æ¸¬è©¦ç”¨æˆ¶æ˜¯å¦éœ€è¦é¡å¤–çš„ç™»å…¥åŠŸèƒ½ï¼Œå°±å…ˆæ”¾å‡çš„ç™»å…¥æŒ‰éˆ•æ”¶é›†ç”¨æˆ¶éœ€æ±‚ï¼Œé»æ“Šå¾Œå½ˆçª—é¡¯ç¤ºåŠŸèƒ½é‚„åœ¨é–‹ç™¼ä¸­ï¼ŒåŸ·è¡Œå‡å€‘æ¸¬è©¦åƒ…å¥—ç”¨åˆ°æ¥µå°‘æ•¸çš„ç”¨æˆ¶ä¸Šï¼Œå–å¾—è¶³å¤ æ¨£æœ¬å¾Œå°±çµ‚æ­¢äº†\nè©¦é©—é›¶ å†é–‹å§‹èšç„¦ç´°ç¯€ä¹‹å‰ï¼Œå¯ä»¥å…ˆé€€ä¸€æ­¥æ€è€ƒã€Œå¦‚æœåŠŸèƒ½ç§»é™¤æœƒæœ‰æ€æ¨£çš„å½±éŸ¿ã€ä¾†é¿å…éåº¦èšç„¦çš„å‰¯ä½œç”¨ï¼ŒSkyscanner ç™¼ç¾ç§»é™¤é é¢ä¸Šçš„ã€Œæœ€ä¾¿å®œæ©Ÿç¥¨ã€æŒ‰éˆ•ä¸å½±éŸ¿é—œéµæ•¸æ“šï¼Œä»–å€‘å°±çœä¸‹ç²¾åŠ›åœ¨å„ªåŒ–é€™å€‹é …ç›®ä¸Š\né€™å€‹éšæ®µå¯ä»¥è©¦è‘—å•ä»¥ä¸‹å•é¡Œ\nä½ å¦‚ä½•æ‰“é€ æœ€ç¬¦åˆå‡èªªçš„é«”é©—èˆ‡è¨­è¨ˆï¼Ÿ åœ¨é€™å€‹éšæ®µä»€éº¼å…ƒç´ æ˜¯é—œéµè¨­è¨ˆï¼Ÿä»€éº¼æ˜¯å…¶ä»–å¯ä»¥ä¹‹å¾Œæ³¨æ„çš„ï¼Ÿ è·Ÿå…¶ä»–æ¸¬è©¦é …ç›®ç›¸æ¯”ï¼Œé€™å€‹é …ç›®èƒ½å¾ä¸­å­¸åˆ°çš„ç¨ç‰¹ä¹‹è™•åœ¨å“ªï¼Ÿ å¦‚æœéœ€è¦å­¸ç¿’åˆ°äº‹å‹™ï¼Œæœ€å¤šéœ€è¦å¹¾å€‹æ¸¬è©¦é …ç›®ï¼Ÿ ä½ èƒ½å¦èªªæ˜æ¯å€‹æ¸¬è©¦é …ç›®çš„å·®ç•°ï¼Ÿ åˆ†æ ç™¼è¡Œ AB æ¸¬è©¦ä¹‹å‰ ç•¶è¦ç™¼è¡Œæ¸¬è©¦æ™‚ï¼Œå¯ä»¥é€éä¸€äº›ä½¿ç”¨è€…ç ”ç©¶å»ç²¾ç·´æ¸¬è©¦é …ç›®ï¼Œç¢ºä¿å¯¦éš›ç™¼å‡ºçš„ AB æ¸¬è©¦é …ç›®æ˜¯æœ€æœ‰åƒ¹å€¼çš„ï¼Œå‘ spotify æ¯å…©åˆ°ä¸‰é€±æœƒæ‰¾çœŸå¯¦çš„ç”¨æˆ¶åˆ°è¾¦å…¬å®¤æ¥å—è²éŸ³æ¸¬è©¦ï¼Œå„åœ˜éšŠä¾æ“šéœ€æ±‚æå‡ºç”³è«‹ï¼Œåœ¨å¤§è¦æ¨¡ AB æ¸¬è©¦ä¹‹å‰èª¿æ•´æ–‡æ¡ˆèˆ‡è¨­è¨ˆ\næ¥è‘—è¦ç¢ºä¿ æœ€å°å¯æª¢æ¸¬æ•ˆæ‡‰ï¼Œæ„å³è¶³ä»¥å®£å‘ŠæˆåŠŸçš„æœ€å°æ”¹è®Šé‡ï¼Œè¦è¨˜å¾—åšä»»ä½•çš„å¯¦é©—éƒ½æœ‰ä»£åƒ¹çš„ï¼Œä¸è«–æ˜¯æŠ•å…¥çš„è³‡æºï¼Œé‚„æ˜¯ç”¨æˆ¶çš„å­¸ç¿’æˆæœ¬éƒ½æ˜¯ï¼Œè¦äº‹å…ˆæ˜å®šæŒ‡æ¨™çš„è®Šå‹•é‡å¤§æ–¼æŸå€‹æ•¸å€¼æ‰èƒ½å¸¶ä¾†çœŸæ­£çš„å•†æ¥­åƒ¹å€¼ï¼Œåä¹‹å‰‡ä¸å€¼å¾—ç™¼è¡Œ\næœ€å¾Œè¦åŸ·è¡Œå‰ï¼Œç¢ºèªæ¨£æœ¬çš„æª¢æ¨£æ–¹å¼æ˜¯å¦æ­£ç¢º / ç¢ºèªç™¼å¸ƒå¾Œè¦æŒçºŒå¤šä¹… / è€ƒé‡è½å¯¦çš„ç´°ç¯€ç­‰ï¼Œåƒæ˜¯ Facebook åœ¨æ¨å‡ºæ–°åŠŸèƒ½å‰éƒ½æœƒåœ¨ç´è¥¿è˜­å…ˆæ¸¬è©¦ï¼Œå› ç‚º Facebook æ¸¬è©¦æœƒéœ€è¦æœ‰å¯¦éš›çš„ç¤¾äº¤é—œä¿‚ï¼ŒåŒæ™‚åˆè¦èˆ‡å…¶ä»–åœ‹å®¶æœ‰é»éš”é–¡æ‰ä¸æœƒç”¨æˆ¶é«”é©—äº’ç›¸è¡çªç­‰\né€™æ™‚å€™å¯ä»¥å•è‡ªå·±å¹¾å€‹å•é¡Œ\næˆ‘åœ¨å˜—è©¦å­¸ç¿’çš„æ±è¥¿æ˜¯ä»€éº¼ï¼Ÿæ˜¯å¦æˆ‘é‚„ç›¸ä¿¡æˆ‘çš„è¨­è¨ˆå¯ä»¥å‚³é”æƒ³è¦å­¸ç¿’çš„æ±è¥¿ï¼Ÿ å¦‚æœæˆ‘çš„è©¦é©—æˆåŠŸæˆ–å¤±æ•—ï¼Œæˆ‘è¦åšä»€éº¼ï¼Ÿ æˆ‘çš„æ¸¬è©¦æ¨£æœ¬æ˜¯å¦è¶³å¤ å¤§ï¼Ÿ æ˜¯å¦äº†è§£æ¸¬è©¦ä¸­çš„æ‰€æœ‰æŒ‡æ¨™ï¼Ÿ æ˜¯å¦æœ‰è‰¯å¥½çš„æ¬¡è¦æŒ‡æ¨™ï¼Ÿ è©•ä¼°çµæœ å¦‚æœçµæœæ˜¯æ­£é¢çš„ï¼Œä»£è¡¨å‡èªªæ˜¯æœ‰åƒ¹å€¼çš„ï¼Œä½†æ­¤æ™‚è¦ä»”ç´°è©•ä¼°èƒŒå¾Œçš„å­¸ç¿’ï¼Œè€Œä¸æ˜¯è²¿ç„¶çš„æ¨å‡ºæ–°åŠŸèƒ½\nä¾‹å¦‚èªª Esty ç¶²ç«™æ¨å‡ºæ–°çš„å¾Œå°ç³»çµ±æµç¨‹ï¼Œé€éæ¸¬è©¦çµæœè‰¯å¥½ï¼Œä½†è²¿ç„¶æ¨å‡ºæ–°æµç¨‹å¢åŠ èˆŠç”¨æˆ¶çš„å­¸ç¿’æ›²ç·šï¼Œå¾Œä¾†ä»–å€‘åœ¨ä¸æœƒæ¨å‡ºèˆ‡é€æ­¥é‡‹å‡ºä¹‹é–“åšæŠ‰æ“‡\nå¦‚æœçµæœæ˜¯è² é¢çš„ï¼Œè¦åéä¾†æ€è€ƒ\nç”¨æˆ¶æ˜¯å¦ä»¥ä½ æ‰€æƒ³åƒçš„æ–¹å¼ä½¿ç”¨ï¼Ÿ ç”¨æˆ¶æ˜¯å¦é—œå¿ƒä½ æ‰€æ²’æœ‰è€ƒæ…®çš„äº‹ç‰©ï¼Ÿ é€™åŠŸèƒ½æ˜¯å¦åªæ˜¯ç¾¤é«”çš„ç´°åˆ†æ—ç¾¤ä½¿ç”¨è€Œéå¤§çœ¾éœ€æ±‚ï¼Ÿ æ­¤å¤–æœ‰äº›æ±ºç­–æ˜¯ç‚ºäº†æ›´å¤§çš„å•†æ¥­è€ƒé‡ï¼Œå³ä½¿ç›®å‰çš„æ¸¬è©¦å°è‡´äº›è¨±çš„è² é¢çµæœï¼Œä½†æ¬Šè¡¡ä¹‹å¾Œé‚„æ˜¯å€¼å¾—æ¨å‡ºï¼Œåƒæ˜¯å…ˆå‰ ebay çš„æ¡ˆä¾‹\nå¦‚æœå°ç…§çµ„èˆ‡å¯¦é©—çµ„çš„çµæœå·®ä¸å¤šï¼Œé€™æ˜¯å¸¸è¦‹çš„äº‹æƒ…ï¼Œä¸å¿…å¤ªæ°£é¤’ï¼Œå¯ä»¥åéé ­ä¾†æª¢è¦–æ‰“é€ æ¸¬è©¦çš„éç¨‹æ˜¯å¦æœ‰æ‰€éºæ¼\næ¨£æœ¬çš„é¸æ“‡æ˜¯å¦æ­£ç¢º æ˜¯å¦éœ€è¦æ›´å¤šçš„ç”¨æˆ¶æ‰èƒ½é‡æ¸¬ æ˜¯å¦æœ‰å¤–éƒ¨å› å­å¹²æ“¾ æŒ–æ˜å…¶ä»–æ¬¡è¦æŒ‡æ¨™èˆ‡é—œéµæŒ‡æ¨™ æ¥è‘—å¯ä»¥æ±ºå®šæ˜¯å¦é€²è¡Œä¸‹ä¸€è¼ªæ¸¬è©¦ï¼Œåˆæˆ–æ˜¯å°‡æˆæœé€æ­¥æ”¾é‡åˆ°å…¨éƒ¨ç”¨æˆ¶ä¸Š çµèª æœ€å¾Œå…©ç« è¬›å¾—æ˜¯å¦‚ä½•åœ¨å…¬å¸å…§å°å…¥ï¼Œä»¥åŠæ‹›è˜åˆé©çš„äººé¸ï¼Œé€™éƒ¨åˆ†å°±æš«ç•¥ï¼Œæ•´ä»½è®€æ›¸å¿ƒå¾—å…¶å¯¦æœ‰é»ç”Ÿç¡¬ï¼Œç•¢ç«Ÿæ˜¯ä¸å¸¸æ¥è§¸çš„é ˜åŸŸï¼Œå¾é–€å¤–æ¼¢èˆ‡å…¬å¸é‹ä½œè§’åº¦ä¸€ç¥æ•¸æ“šé©…å‹•èˆ‡ABæ¸¬è©¦çš„ç¾å¦™ï¼Œæ•´å¥—è¨­è¨ˆéå¸¸çš„ç†æ€§ç§‘å­¸ï¼Œå»ä¹Ÿåœ¨æŸäº›è¨­è¨ˆç’°ç¯€ä¾èˆŠä¿ç•™å‰µé€ èˆ‡å½ˆæ€§ï¼Œçµåˆå…©è€…æ‰èƒ½æŒçºŒæ‰“é€ ç”¨æˆ¶çœŸæ­£éœ€è¦çš„ç”¢å“\n","date":"2020-04-05T11:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-04-05-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97designing-with-data-%E5%96%84%E7%94%A8%E6%95%B8%E6%93%9A%E5%B9%AB%E4%BD%A0%E6%89%93%E9%80%A0%E5%A5%BD%E8%A8%AD%E8%A8%88/","title":"é–±è®€å¿ƒå¾—ã€ŠDesigning with Data å–„ç”¨æ•¸æ“šå¹«ä½ æ‰“é€ å¥½è¨­è¨ˆã€‹"},{"content":"æœƒçœ‹åˆ° DNS over HTTPs(DoH) æ˜¯å› ç‚ºé–±è®€åˆ° Firefox åœ¨ 2/26 æ–¼ç¾åœ‹ç”¨æˆ¶æ¨å‡ºé è¨­æ¡ç”¨ DoH çš„æ–‡ç« ï¼Œæ—©åœ¨ Firefox@62 æ™‚å°±å·²ç¶“å…§ç½®é€™é …è¨­å®šï¼Œå…¶é¤˜åœ°å€ç”¨æˆ¶å¯ä»¥é€éè¨­å®šé–‹å•Ÿï¼›\nç›®å‰ Chrome æ–¼ 78 ä¹‹å¾Œé è¨­é–‹å•Ÿï¼ŒWindows 10 ä¹Ÿå®£å¸ƒå³å°‡æ•´åˆ DoHï¼Œå…¬é–‹ DNS è§£ææœå‹™å•†ä¹Ÿè¶Šä¾†è¶Šå¤šæ”¯æ´ DoHï¼Œæ—©å…ˆ Firefox èˆ‡ Cloudflare åˆä½œï¼Œå¾ŒçºŒ Google Public DNS / AdGuard ç­‰ä¹ŸåŠ å…¥æ”¯æ´\nDNS æ˜¯æ­·å²æ‚ ä¹…çš„ç¶²è·¯é€šè¨Šå”å®šï¼ŒåŸºæ–¼ UDP/TCP æŸ¥è©¢åŸŸåå°æ‡‰çš„ç´€éŒ„ï¼Œä½†é€™ä¸€åˆ‡åœ¨ç¶²è·¯å‚³è¼¸éƒ½æ˜¯æ˜æ–‡ï¼Œæ²’æœ‰ä»»ä½•çš„éš±å¯†æ€§èˆ‡å®‰å…¨æ€§ï¼Œå¾Œä¾†æœ‰äº† DNSSEC å¯ä»¥ç¢ºä¿ DNS ç´€éŒ„æ²’æœ‰è¢«ç«„æ”¹ï¼Œä½†å¯æƒœåœ¨æ¨å»£ä¸Šéœ€è¦æ”¹ DNS Serverï¼Œå—åˆ°å¯¦ä½œé™åˆ¶ä¸¦æ²’æœ‰å…¨é¢å¯¦æ–½\nMozilla èˆ‡ Google æ–¼å‰é™£å­æå‡º DNS over HTTPsï¼Œå°‡ DNS æŸ¥è©¢æ”¾åœ¨ HTTPs ç•¶ä¸­ï¼Œå¦‚æ­¤ä¸€ä¾†é™¤äº†å¯ä»¥é˜²æ­¢è¢«æƒ¡æ„ç«„æ”¹ç­‰ä¸­é–“äººæ”»æ“Šå¤–ï¼Œæ›´å¯ä»¥ä¿è­·ç”¨æˆ¶éš±ç§ï¼ŒISP ç­‰ä¸­é–“çš„ç¶²è·¯è¨­æ–½æä¾›å•†å°±æ¯”è¼ƒé›£è¿½è¹¤ç”¨æˆ¶çš„ç¶²è·¯ç€è¦½\né€™ä¸€ç¯‡æ–‡ç« æœƒå…ˆå¤§ç•¥æŠ€è¡“ä»‹ç´¹ï¼Œæ¥è‘—æ•´ç†ç¶²è·¯ä¸Šå°æ–¼ DNS over HTTPs çš„æ­£åå…©æ–¹è¨è«–ï¼Œå…ˆèªªçµè«–æ˜¯\næ²’æœ‰æ‰€è¬‚çš„ 100% å®‰å…¨ï¼Œä½†æˆ‘å€‘èƒ½ç›¡åŠ›åšåˆ°æœ€å¥½\næŠ€è¡“å¯¦ä½œ DoH å…¶å¯¦å°±æ˜¯é€é HTTPs æŸ¥è©¢ DNS ç´€éŒ„ï¼Œä¸€èˆ¬ DNS åœ¨æŸ¥è©¢è¨˜éŒ„æ™‚æœƒéœ€è¦åè¦†å¤šæ¬¡ï¼Œå¾é ‚ç´šåŸŸåé–‹å§‹ä¸€è·¯æŸ¥åˆ°å­åŸŸåï¼Œåœ¨é€™éç¨‹ä¸­å…¨éƒ¨çš„æœå‹™å•†èˆ‡ç¶²è·¯ä¸­ä»‹è¨­å‚™éƒ½çŸ¥é“ä½ åœ¨æŸ¥è©¢å“ªå€‹ç¶²ç«™\nDoH å¸Œæœ›æ”¹é€é Trusted Recursive Resolver(TRR) å»æŸ¥è©¢ï¼Œäº¤ç”± TRR åšåˆ°è§£æåŸŸåé€™ä»¶äº‹ï¼Œé€™æ¨£å°±ç„¡æ³•å›æº¯åˆ°ä½¿ç”¨è€…æœ¬èº«çš„ IPï¼Œé”åˆ°ä¿å¯†æ€§çš„æ•ˆæœï¼›\nåŒæ™‚ç”± DNS åŸŸåå•†æä¾›çš„ TRR æœå‹™æ™‚ï¼Œæœƒåƒè€ƒç”¨æˆ¶çš„ IP ä½ç½®ï¼Œé¿å…ä¸€äº›é€é Geo DNS çš„æœå‹™é€ æˆå½±éŸ¿\nSpec æ¦‚è¦½ï¼šRFC-8484 RFC8484ï¼Œç°¡å–®æŠ“å‡ºå¹¾å€‹æœ‰è¶£çš„åœ°æ–¹\nMIME Type DoH Client å¯ä»¥ç”¨ application/dns-messageï¼Œè¡¨æ˜æ˜¯è¦ç”¨ dns æ ¼å¼æŸ¥è©¢ï¼Œä¹Ÿå¯ä»¥ç”¨ json ç­‰æ–¹å¼ï¼Œçœ‹ DoH Server æä¾›ï¼Œå¦‚ Cloudflare æœ‰æä¾› json æ ¼å¼\nHTTP Method æ”¯æ´ GET / POST å…©ç¨®æ–¹å¼æŸ¥è©¢\nä¾‹å¦‚èªªè¦æŸ¥è©¢ www.example.com é•·é€™æ¨£\n1 2 3 4 5 :method = GET :scheme = https :authority = dnsserver.example.net :path = /dns-query?dns=AAABAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB accept = application/dns-message å»ºè­° HTTP2 ç‚ºæœ€ä½ç‰ˆæœ¬ å°æ¯” DNS æ¡ç”¨çš„ UDP/TCP ä¾†èªªï¼ŒHTTP é–‹éŠ·å¤§å¾ˆå¤šï¼Œæ¡ç”¨ HTTP2 æœ‰ä¸€äº›æ€§èƒ½ä¸Šå„ªåŒ–çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚é‡ç”¨é€£çµã€é‡æ•´å°åŒ…é †åºã€Header å£“ç¸®ç­‰ï¼Œç›¸æ¯”æ›´èˆŠçš„ HTTP ç‰ˆæœ¬å·²å„˜å¯èƒ½æ¸›è¼•é€šè¨Šä¸Šçš„è² æ“”\nå¯¦éš›ä½¿ç”¨èˆ‡æ¸¬è©¦ è¦å¯¦éš›ä½¿ç”¨çš„æ–¹å¼æœ‰å¹¾ç¨®ï¼Œä¸€ç¨®æ˜¯åœ¨è‡ªå·±é›»è…¦è£ä¸Š DoH Clientï¼Œæ¥è‘—å°‡ DNS æŸ¥è©¢æŒ‡å‘ DoH Client ç¶“ç”±ä»–ä»£ç†æŸ¥è©¢ï¼Œå¥½è™•æ˜¯é€éä»£ç†ä¸ç”¨æ“”å¿ƒæ‡‰ç”¨ç¨‹å¼çš„æ”¯æ´å•é¡Œï¼Œé€™éƒ¨åˆ†å¯ä»¥å®‰è£ cloudflare æä¾›çš„ cloudflared\nä½†é€™æ¬¡å¯¦é©—åªæ˜¯è¦å¿«é€Ÿæ¸¬è©¦åŠŸèƒ½ï¼Œèˆ‡åˆ©ç”¨ Wireshark å¯¦åœ°çœ‹å°åŒ…é‡é€çš„éç¨‹ï¼Œæ‰€ä»¥å®‰è£å¦ä¸€å€‹ command line å·¥å…· kdigï¼Œkdig å¯ä»¥ç›´æ¥æŒ‡å®š DoH Client æŸ¥è©¢ dns ç´€éŒ„ï¼Œæ¯” dig åŠŸèƒ½å†å¤šä¸€äº›ï¼Œå®‰è£å®Œæˆå¾Œæ¯”è¼ƒå…©å€‹æŒ‡ä»¤\n$ kdig -d @1.1.1.1 +tls-ca +tls-host=cloudflare-dns.com yuanchieh.page vs kdig -d @1.1.1.1 yuanchieh.page\né€é Wireshark æ“·å–å°åŒ…çµæœ å‰è€…èµ°ä¸€èˆ¬ HTTPS æµç¨‹ï¼Œå¾Œè€…èµ° DNS æµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å‚³è¼¸é‡èˆ‡å‚³è¼¸é€Ÿåº¦çš„å·®ç•°\nçˆ­è­°ä¹‹è™• é€™ç¯‡æ–°èæ•´ç†äº†è¨±å¤šå°ˆå®¶å°æ–¼ DoH çš„åå°æ„è¦‹ï¼šDNS-over-HTTPS causes more problems than it solves, experts sayï¼Œå…¶ä¸­å¹¾é»è »å€¼å¾—æ›´æ·±å…¥æ¢è¨\nDoH ä¸èƒ½é˜²æ­¢ ISP æ¥­è€…çªºè¦–ç”¨æˆ¶çš„ç€è¦½ç´€éŒ„(å¯ä»¥è§£æ±º) DoH ç¢ºå¯¦èƒ½å¤ é˜²æ­¢ ISP æ¥­è€…çœ‹åˆ° DNS æŸ¥è©¢è¨˜éŒ„ï¼Œä½†å¦‚æœç”¨æˆ¶æ˜¯ç”¨ HTTPï¼Œé‚£èµ°ä¸èµ° DoH ä»–çš„ç¶²é ç€è¦½ç´€éŒ„é‚„æ˜¯æœƒè¢«ç™¼ç¾ï¼›\nå³ä½¿ç”¨æˆ¶èµ° HTTPSï¼ŒåŸºæ–¼ç¾æœ‰çš„ HTTPS ç¼ºå¤±ï¼Œä¸æ˜¯æ¯å€‹ request éƒ½æ˜¯åŠ å¯†çš„ï¼Œä¾‹å¦‚ SNI è·Ÿ OSCP\nSNI æ˜¯ Client å…ˆè·Ÿ Server èª¬ä»–è¦é€£ç·šçš„ hostname æ˜¯å“ªå€‹ï¼Œå› ç‚ºåŒå€‹ IP ä¸Šå¯èƒ½æœ‰å¤šå€‹ Server (Virtual host) éœ€è¦å›å‚³å°æ‡‰çš„æ†‘è­‰ï¼›\nOSCP æ˜¯ Client æ”¶åˆ° Server å›å‚³çš„æ†‘è­‰ï¼Œä¸¦éœ€å†å» CA é©—è­‰æ†‘è­‰çš„æœ‰æ•ˆæ€§ï¼›\né€™å…©å€‹ Request éƒ½æ˜¯æ˜æ–‡ï¼Œæ‰€ä»¥éƒ½æœƒè¢«è¨˜éŒ„åˆ°ã€‚\nå†è€…ï¼ŒISP æ¥­è€…é‚„æ˜¯æœƒçŸ¥é“ Client è¦é€å°åŒ…åˆ°å“ªå€‹ IPï¼ŒIP ä½ç½®ä¸æ˜¯å¾ˆæ™‚å¸¸æ›´å‹•ï¼Œé€éåæŸ¥å°±çŸ¥é“ Client æ˜¯åœ¨çœ‹ä»€éº¼ç¶²ç«™\nä¸Šè¿°æ¢ä»¶ç„¡é—œä¹ DoH çš„å•é¡Œï¼Œä½†ç¢ºå¯¦è®“ DoH æ¯«ç„¡ç”¨æ­¦ä¹‹åœ°\nå…¬å¸ç®¡ç†å›°æ“¾ å¦‚æœå…¬å¸é˜²ç«ç‰†é€éåœ¨ DNS éšæ®µéæ¿¾ï¼Œç¢°ä¸Š DoH å°±æœƒå¾ˆé ­ç–¼ï¼Œé€ æˆç®¡ç†ä¸Šçš„æ¼æ´\néåº¦é›†ä¸­æ–¼ DNS è§£æå•† å†ç™¼èµ· DoH æ™‚ï¼Œæœƒéœ€è¦æŒ‡å®š HTTPs è¯ç¹«çš„å°è±¡ï¼Œé€™é€šå¸¸æ˜¯ç”± DNS è§£æå•†æ‰€æä¾›ï¼Œé€™å°è‡´æ¬Šåˆ©é›†ä¸­æ–¼å¹¾é–“å¤§å…¬å¸æ‰‹è£¡ï¼Œä¾‹å¦‚ Firefox ç€è¦½å™¨å…§é è¨­ä½¿ç”¨ Cloudflare / NextDNSï¼Œé›–ç„¶ä¹Ÿå¯ä»¥åŠ å…¥è‡ªå®šç¾©ï¼Œä½†å¦‚æœä¸€èˆ¬çš„ç”¨æˆ¶ä¸æ…ç†Ÿæ‚‰ï¼Œé€™æœƒå°è‡´ DNS è§£æå•†åè€Œæœ‰å¾ˆå¤§çš„å½±éŸ¿\nå°ˆå®¶å»ºè­°æ˜¯åŸºæ–¼ DNS æœ¬èº«æ©Ÿåˆ¶å¤–åŠ åŠ å¯†æ–¹å¼ï¼Œè€Œä¸æ˜¯æŠŠä½œæ³•ç¶åˆ°å¹¾é–“è§£æå•†æ‰‹ä¸Šã€‚\nå…§æ–‡æœ‰æåˆ°ã€ŒæŸäº›å…¬å¸ç‚ºäº†è®“è‡ªå·±çœ‹èµ·ä¾†å¾ˆåœ¨æ„ç”¨æˆ¶éš±ç§ï¼Œæ‰æ¨å‡ºé€™ç¨®åŠæ®˜çš„å”å®šï¼Œæ˜¯éå¸¸ä¸è² è²¬ä»»çš„ã€\nçµè«–\u0026hellip; not the end! DoH çœ‹ä¼¼è§£æ±ºäº†éƒ¨åˆ†å•é¡Œï¼Œåˆæœ‰ Firefox / Chrome / Windows / Google DNS / Cloudflare ç­‰å¤šå®¶ä¸–ç•Œç´šç”¢å“èˆ‡ DNS æœå‹™å•†çš„æ¨å»£èˆ‡èƒŒæ›¸ï¼Œä½†ç¢ºå¯¦åå°è€…æå‡ºçš„è³ªç–‘ä¹Ÿå¾ˆæœ‰èªªæœåŠ›ï¼Œåªèƒ½èªªå¦‚æœåœ¨æ„ DNS æœ‰æ²’æœ‰è¢«ç«„æ”¹ï¼Œä½¿ç”¨ DoH æˆ–è¨±å¯ä»¥ï¼Œä½†ä¸èƒ½æœŸæœ› DoH å®Œå…¨æŠ¹å»å€‹äººçš„ç¶²é ç€è¦½ç´€éŒ„\nTLS 1.3 TLS 1.3 æ”¹è®Šäº†åŠ å¯†æµç¨‹ï¼Œç”±æœ€ä¸€é–‹å§‹çš„ Client ç™¼å‡º ClientHello å°±åŠ å¯†äº†ï¼Œæ­¤æ™‚åŠ å¯†çš„æ–¹å¼æ˜¯å¾ DNS ç´€éŒ„æ‹¿åˆ° Server çš„ Public Keyï¼Œä¸¦æ¡ç”¨ Diffie-Hellman äº¤æ›é‡‘é‘°æ–¹å¼ï¼Œç”¨ã€Œéå°ç¨±åŠ å¯†çš„å…¬é‘°ã€åŠ å¯†ã€Œå°ç¨±åŠ å¯†çš„é‡‘é‘°ã€ï¼Œç”¨ã€Œå°ç¨±åŠ å¯†çš„é‡‘é‘°ã€åŠ å¯†æŒ‡å®šçš„ Server name\nç›®å‰åƒ…å‰©å”¯ä¸€å€‹å•é¡Œ IP ä½ç½®ï¼Œä½†å¦‚æœ Server æ˜¯åœ¨ CDN å¾Œé¢ï¼Œè®“ ISP åªèƒ½è¿½è¹¤åˆ° CDNï¼Œå¾Œé¢çš„å°±ç„¡æ³•è¿½è¹¤åˆ°\næ­¤å¤– TLS 1.3 å°‡æ¡æ‰‹æ©Ÿåˆ¶æ¸›å°‘ä¸€å€‹ RTT è®Šæˆåªè¦ä¸€å€‹ RTT å°±èƒ½å®Œæˆäº¤æ¡ï¼Œæ•ˆç‡å¤§å¹…æå‡\nçµè«– TLS 1.3 éœ€è¦ DNS æ”¯æ´ï¼Œå°±å¯ä»¥å¾äº¤æ¡é–‹å§‹å°±å…¨ç¨‹åŠ å¯†ï¼›\nè€Œç‚ºäº†é¿å… DNS è¢«æ”»æ“Šæˆ–æ˜¯ç«„æ”¹ç´€éŒ„ï¼Œè¨˜å¾—è¦ä½¿ç”¨ DNSSECï¼›\næœ€å¾ŒåŠ ä¸Š DoHï¼Œè®“ DNS ç´€éŒ„æŸ¥è©¢é€™ä¸€æ®µä¹Ÿä¸æœƒè¢« ISP è¿½è¹¤\næ•´æ®µè£œä¸Šå¾Œï¼Œå°±èƒ½å¢åŠ ç”¨æˆ¶çš„éš±ç§èˆ‡å®‰å…¨æ€§ï¼Œå¯æƒœ AWS çš„ Route53 è·Ÿ Cloudfront ä¸æ”¯æ´\u0026hellip; :/\nçœ‹äº†ä¸€äº›æ–‡ç« ï¼Œç›®å‰è¦ºå¾— Cloudflare åœ¨å®‰å…¨æ€§é€™éƒ¨åˆ†è‘—å¢¨å¾ˆå¤šï¼Œæ”¯æ´åº¦ä¹Ÿéƒ½å¾ˆå¤ ï¼Œæˆ–è¨±è©²è€ƒæ…®çœ‹çœ‹\nåƒè€ƒè³‡æ–™ A cartoon intro to DNS over HTTPS: éå¸¸ä»”ç´°è¬›è§£éç¨‹ DNS over TLS / DNS over HTTPS - Is it the privacy magic bullet?\n","date":"2020-02-29T07:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-02-29-dns-over-https-%E5%88%86%E4%BA%AB/","title":"DNS over HTTPs åˆ†äº«"},{"content":"åœ¨ä½¿ç”¨ express.js ç•¶ä½œ Nodejs server æ¡†æ¶æ™‚ï¼Œæ™‚å¸¸æœƒéœ€è¦å¯«ä¸€äº› Middleware è™•ç† Token é©—è­‰ã€ç”¨æˆ¶æ¬Šé™æª¢æŸ¥ç­‰ç­‰ï¼Œä¹Ÿæœƒå¥—ç”¨å¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ¨¡çµ„å»å»ºæ§‹ç¨‹å¼\nä½†çªç„¶æŸå¤©åœ¨æ€è€ƒå¦‚ä½•è‡ªå·±å¯«ä¸€å€‹ç´€éŒ„response timeçš„ Middlewareï¼Œç™¼ç¾è‡ªå·±æ²’è¾¦æ³•ç”¨ä¸€å€‹ Middleware è¨»å†Šå°±å®Œæˆé€™ä»¶äº‹ï¼Œå› ç‚º express.js ä¸åƒæ˜¯ Koa çš„ middleware æ˜¯ç”¨ promise based å¯¦ä½œï¼Œæ‰€ä»¥ç•¶æŸå€‹ç’°ç¯€æ˜¯éåŒæ­¥ï¼ŒåŸ·è¡Œçš„é †åºå°±æœƒéŒ¯äº‚\nå¾Œä¾†æŸ¥çœ‹äº† morgan è¢«å¤§é‡ä½¿ç”¨çš„ express log middlewareï¼Œæ‰ç™¼ç¾å…¶ä¸­è¨­è¨ˆçš„å°å·§æ€ï¼Œä»¥ä¸‹æ˜¯æ•´ç†çš„å…§å®¹\nExpressjs Middleware è¨­è¨ˆ å…ˆä¾†çœ‹æœ€åŸºæœ¬çš„ Middleware è¨­è¨ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 const express = require(\u0026#34;express\u0026#34;); const app = express(); app.use(function(req, res, next){ console.log(\u0026#34;middleware 1 start\u0026#34;); next(); console.log(\u0026#34;middleware 1 end\u0026#34;); }); app.use(function(req, res, next){ console.log(\u0026#34;middleware 2 start\u0026#34;); next(); console.log(\u0026#34;middleware 2 end\u0026#34;); }); app.get(\u0026#34;/\u0026#34;, async function(req, res){ console.log(\u0026#34;request started\u0026#34;) await delay(); console.log(\u0026#34;request finished\u0026#34;) res.send(); }); async function delay(){ return new Promise((res)=\u0026gt;{ setTimeout(()=\u0026gt;{ res() }, 1000) }) } app.listen(3000); ç›®å‰çš„ log æœƒè®Šæˆ\n1 2 3 4 5 6 middleware 1 start middleware 2 start request started middleware 2 end middleware 1 end request finished å¦‚æœæˆ‘å€‘å¸Œæœ›åœ¨ Request é€²ä¾†å…ˆç´€éŒ„é–‹å§‹æ™‚é–“ï¼Œæ¥è‘—åœ¨ Response çµæŸæ™‚ç´€éŒ„çµæŸæ™‚é–“ï¼Œå°±å¿…é ˆä»°è³´å…¶ä»–çš„å¯¦ä½œæ–¹å¼\non-headers / on-finished çˆ¬é morgan ç¨‹å¼ç¢¼å¾Œï¼Œç™¼ç¾æ˜¯é€éé€™å…©å€‹æ¨¡çµ„å»å¯¦ä½œåŠŸèƒ½çš„\non-headersï¼šè¨»å†Šäº‹ä»¶ï¼Œç•¶ header è¢«å¯«å…¥æ™‚æœƒè§¸ç™¼\non-finishedï¼šè¨»å†Šäº‹ä»¶ï¼Œç•¶ request/response çµæŸæ™‚è§¸ç™¼\né€™å…©å€‹æ¨¡çµ„å¯ä»¥é‡å° Nodejs åŸç”Ÿçš„ http server æ­é…ä½¿ç”¨ï¼Œexpress.js ä¹Ÿæ˜¯ç¹¼æ‰¿åŸç”Ÿçš„ http server\nåœ¨ morgan module ä¸­ï¼Œåœ¨ middleware é€²å…¥ä¸€é–‹å§‹æ¨™è¨˜ request é–‹å§‹æ™‚é–“ï¼Œåœ¨ on-headers æ™‚ç´€éŒ„ request çµæŸæ™‚é–“ï¼Œåœ¨ on-finished å°‡è¨Šæ¯å°å‡ºï¼Œpseudo code å¤§è‡´å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 app.use(function (req, res, next) { res._startTime = new Date().getTime(); onHeader(res, function () { res._endTime = new Date().getTime(); }) onFinished(res, function () { console.log(`req process time: ${res._endTime - res._startTime} ms`) }) next() }) log çµæœæ˜¯\n1 2 3 request started request finished req process time: 1010 ms on-headers å¯¦ä½œ å°‡åŸæœ¬çš„ response ä¸­çš„ writeHead è¤‡å¯«ï¼Œåªæ˜¯å¤šåŒ…ä¸€å±¤è§¸ç™¼äº‹ä»¶çš„æ©Ÿåˆ¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 function createWriteHead (prevWriteHead, listener) { var fired = false // return function with core name and argument list return function writeHead (statusCode) { // set headers from arguments var args = setWriteHeadHeaders.apply(this, arguments) // fire listener if (!fired) { fired = true listener.call(this) .... } return prevWriteHead.apply(this, args) } } function onHeaders (res, listener) { if (!res) { throw new TypeError(\u0026#39;argument res is required\u0026#39;) } if (typeof listener !== \u0026#39;function\u0026#39;) { throw new TypeError(\u0026#39;argument listener must be a function\u0026#39;) } res.writeHead = createWriteHead(res.writeHead, listener) } on-finished å¯¦ä½œ é€™é‚Šçš„å¯¦ä½œå°±æ¯”è¼ƒæœ‰è¶£ï¼Œå¦‚ä½•æ­£ç¢ºçš„åˆ¤è®€ http request/response çµæŸäº†å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 function isFinished (msg) { var socket = msg.socket if (typeof msg.finished === \u0026#39;boolean\u0026#39;) { // OutgoingMessage return Boolean(msg.finished || (socket \u0026amp;\u0026amp; !socket.writable)) } if (typeof msg.complete === \u0026#39;boolean\u0026#39;) { // IncomingMessage return Boolean(msg.upgrade || !socket || !socket.readable || (msg.complete \u0026amp;\u0026amp; !msg.readable)) } // don\u0026#39;t know return undefined } å¦‚æœæ˜¯å¥—ç”¨åœ¨ responseï¼Œéœ€æ³¨æ„æ ¹æ“šå®˜æ–¹æ–‡ä»¶ response.finished æ˜¯æŒ‡èªª res.end() è¢«å‘¼å«å¾Œè¨­å®šç‚º trueï¼Œä¸ä»£è¡¨ response ä¸­çš„è³‡æ–™å®Œå…¨å‚³è¼¸åˆ°ç¶²è·¯ä¸Š\né€™äº›è¨è«–å¯ä»¥çœ‹ PR response is only finished if socket is detached #31ï¼Œæäº¤è€…ä¿®æ”¹æˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 if (stream \u0026amp;\u0026amp; typeof stream.closed === \u0026#39;boolean\u0026#39;) { // Http2ServerRequest // Http2ServerResponse return stream.closed } if (typeof msg.finished === \u0026#39;boolean\u0026#39;) { // OutgoingMessage return ( msg.finished \u0026amp;\u0026amp; msg.outputSize === 0 \u0026amp;\u0026amp; (!socket || socket.writableLength === 0) ) || (socket \u0026amp;\u0026amp; !socket.writable) } å¢åŠ  http2 çš„æª¢æŸ¥ï¼Œä»¥åŠç¢ºä¿ outputSize === 0 æ‰€æœ‰ queued ä½çš„è³‡æ–™éƒ½ç¢ºå¯¦é€å‡º socket\nçŸ¥é“å¦‚ä½•åˆ¤æ–· response æ˜¯å¦çµæŸï¼Œæœ€å¾Œçœ‹äº‹ä»¶çš„è¨»å†Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 function attachFinishedListener (msg, callback) { var eeMsg var eeSocket var finished = false function onFinish (error) { eeMsg.cancel() eeSocket.cancel() finished = true callback(error) } // finished on first message event eeMsg = eeSocket = first([[msg, \u0026#39;end\u0026#39;, \u0026#39;finish\u0026#39;]], onFinish) function onSocket (socket) { // remove listener msg.removeListener(\u0026#39;socket\u0026#39;, onSocket) .... eeSocket = first([[socket, \u0026#39;error\u0026#39;, \u0026#39;close\u0026#39;]], onFinish) } if (msg.socket) { // socket already assigned onSocket(msg.socket) return } // wait for socket to be assigned msg.on(\u0026#39;socket\u0026#39;, onSocket) .... } åœ¨ response èˆ‡ response.socket åˆ†åˆ¥è¨»å†Šäº‹ä»¶ï¼Œç•¶çµæŸæˆ–éŒ¯èª¤äº‹ä»¶è§¸ç™¼å¾Œï¼Œæª¢æŸ¥ response æ˜¯å¦çœŸçš„çµæŸï¼Œæœ€å¾Œè§¸ç™¼ç”¨æˆ¶è¨»å†Šçš„äº‹ä»¶\n","date":"2020-02-06T22:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-02-06-expressjs-middleware-%E5%A6%82%E4%BD%95%E5%9C%A8-response-%E7%B5%90%E6%9D%9F%E8%A7%B8%E7%99%BC/","title":"Expressjs Middleware å¦‚ä½•åœ¨ Response çµæŸè§¸ç™¼"},{"content":"æœ¬ç¯‡åˆ†äº« MongoDB åœ¨æ‰¹æ¬¡æŸ¥è¨Šå¤§é‡æ•¸æ“šæ™‚çš„å°æŠ€å·§\nåœ¨æŸ¥è©¢å°ç­†æ•¸æ“šæ™‚ï¼Œå¾€å¾€æˆ‘å€‘å°±æ˜¯ç”¨ find().toArray() ç›´æ¥å›å‚³çµæœï¼Œéœ€è¦ç°¡å–®çš„åˆ†é å°±æ­é… limit() / skip() å³å¯å®Œæˆ\nä½†å¦‚æœéœ€è¦åˆ†ææ•¸æ“šè·‘éæ•´å€‹ collectionï¼Œä¸å¯èƒ½ç”¨ find() ä¸€æ¬¡æ‹‰å›æ‰€æœ‰çš„è³‡æ–™ï¼Œé€é skip() æ‰¹æ¬¡è™•ç†ï¼Œå¦‚æœ collection è³‡æ–™ä¸å¤šé‚„å¥½ï¼Œå¦‚æœå¹¾åè¬ç­†ã€å¹¾ç™¾è¬ç­†è³‡æ–™æ•ˆèƒ½å›éå¸¸çš„ä½è½ï¼Œå› ç‚º skip çš„è©±æ¯æ¬¡æŸ¥è©¢ DB éƒ½å¿…é ˆè¦é‡é ­é–‹å§‹è·³éæŒ‡å®šç­†æ•¸è³‡æ–™ï¼Œæ‰èƒ½å›å‚³ï¼Œæ‰€ä»¥æŸ¥è©¢æ™‚é–“æœƒéš¨è‘—ç­†æ•¸å¢åŠ è€Œè¶¨è¿‘æ–¼æŒ‡æ•¸å€å¢é•·\nç›®å‰å·²çŸ¥æœ‰å…©ç¨®åšæ³•ï¼Œå¯ä»¥æœ‰æ•ˆè¼ªè©¢æ•´å€‹ collection è€Œä¸æ‹–å® DB æ•ˆèƒ½\nä¸€ç¨®æ˜¯ Cursorï¼Œä½†æ˜¯åœ¨å¯¦å‹™ä¸Šæˆ‘å€‹äººä¸¦æ²’æœ‰æ¡ç”¨ï¼ŒåŸå› æ˜¯ Cursor æ¯æ¬¡åªèƒ½é€é .next() å–å¾—ä¸€ç­†è³‡æ–™ï¼Œå¦‚æœå¸Œæœ›ä¸€æ¬¡æ‹‰å€‹ä¸Šåƒç­†è³‡æ–™è™•ç†å°±ç„¡æ³•åšåˆ°ï¼›\nå¦ä¸€ç¨®æ˜¯æœ¬æ¬¡è¦åˆ†äº«çš„æ–¹å¼ï¼Œé€ééè¿´æŸ¥è©¢ï¼Œä¿æŒæ€§èƒ½æƒ…æ³ä¸‹è·‘å®Œæ•´å€‹ Collectionï¼Œå¯¦å‹™ä¸Šæ¯å¤©æ‡‰ç”¨åœ¨æœ‰åƒè¬ç­†è³‡æ–™çš„ Collection è€Œæ²’æœ‰å¤ªå¤§çš„å•é¡Œ\néå›æŸ¥è©¢ èªªç©¿äº†å…¶å¯¦å¾ˆç°¡å–®ï¼Œé€éæœ‰å»ºç«‹ index çš„ç´¢å¼•ï¼ŒæŒ‰ç…§éå¢æˆ–éæ¸›æ’åºï¼Œæ¯æ‰¹æ¬¡å–å‡ºéƒ¨åˆ†æ•¸æ“šå¾Œï¼Œä¸‹æ¬¡æŸ¥è©¢çš„æ¢ä»¶æ”¹ç‚ºå–å‡ºæ•¸æ“šçš„æœ€å¾Œä¸€ä½ï¼Œä¸€è·¯åˆ° Collection çµæŸ\nä»¥ä¸‹æ˜¯ç¨‹å¼ç¢¼éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 const MongoClient = require(\u0026#39;mongodb\u0026#39;).MongoClient; const dbUrl = \u0026#34;mongodb://127.0.0.1:27017\u0026#34;; MongoClient.connect(dbUrl, async function (err, client) { console.log(err) const testDB = client.db(\u0026#34;test\u0026#34;); const userCollection = testDB.collection(\u0026#34;users\u0026#34;); const result = await iterateCollection({ sourceCollection: userCollection, query: { age: 20 }, batchSize: 10, order: \u0026#34;asc\u0026#34; }); console.log(result); client.close(); }); async function iterateCollection({ sourceCollection, query, batchSize, order }) { let result = []; let sort = { _id: -1 } let _query = { ...query }; if (order === \u0026#34;asc\u0026#34;) { sort = { _id: 1 } } while (true) { const queryResults = await sourceCollection.find(_query).limit(batchSize).sort(sort).toArray(); if(queryResults.length === 0){ break; } _query._id = { $lt: queryResults[queryResults.length - 1]._id } if (order === \u0026#34;asc\u0026#34;) { _query._id = { $gt: queryResults[queryResults.length - 1]._id } } // process data and push to result // result.push(queryResults.map(result =\u0026gt; result._id)); } return result; } ","date":"2020-02-06T22:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-02-06-mongodb-%E6%89%B9%E6%AC%A1%E8%99%95%E7%90%86%E5%A4%A7%E9%87%8F%E6%95%B8%E6%93%9A/","title":"MongoDB æ‰¹æ¬¡è™•ç†å¤§é‡æ•¸æ“š"},{"content":"å…ˆå‰å…¬å¸é‡åˆ° Client åœ¨ä¸æ˜ç‹€æ³ä¸‹é€£çºŒå‘¼å«è¨»å†Šç”¨æˆ¶çš„ API å…©æ¬¡ï¼Œå°è‡´ç”¨æˆ¶è¢«é‡è¤‡å»ºç«‹ï¼Œå°è‡´å¾ŒçºŒçš„ API æ“ä½œèˆ‡è³‡æ–™åˆ†æç•°å¸¸ï¼Œæ‰€ä»¥æ±ºå®šåŠ ä¸Š Lock æ©Ÿåˆ¶é¿å…é‡è¤‡å»ºç«‹çš„å•é¡Œ\nå‰›å¥½åœ¨ Redis å®˜ç¶²çœ‹åˆ° Redlockï¼Œä¸€ç¨® Redis ä½œè€… antirez åŸºæ–¼ Redis è¨­è¨ˆçš„åˆ†æ•£å¼ lock æ©Ÿåˆ¶ï¼Œä¸¦ä¸”å·²ç¶“æœ‰äº† Nodejs ç‰ˆæœ¬çš„å¯¦ä½œï¼Œæ‰€ä»¥å°±æ±ºå®šæ¡ç”¨é€™å¥—æ–¹æ³•ï¼Œä¹Ÿç¢ºå¯¦è§£æ±ºäº†å•é¡Œ\næœ¬æ¬¡éƒ¨è½æ ¼æœƒæ‘˜éŒ„å®˜æ–¹èªªæ˜ Distributed locks with Redisï¼Œä¸¦æ•´ç† Martin Kleppmann æå‡ºè³ªç–‘ How to do distributed lockingèˆ‡ä½œè€…å†æ¬¡å›å¾© Is Redlock safe?\né¡Œå¤–è©±ä»‹ç´¹ Martin Kleppmannï¼Œä»–å°±æ˜¯ã€ŠDesigning Data-Intensive Applicationsã€‹ä¸€æ›¸çš„ä½œè€…ï¼Œç›®å‰ä»æ˜¯æˆ‘æœ€æ¨è–¦çš„å·¥ç¨‹æ›¸ç±ï¼Œå¯ä»¥åƒè€ƒä¹‹å‰çš„ç­†è¨˜\næŠ€è¡“ç­†è¨˜ Designing Data-Intensive Applications ä¸Š\næŠ€è¡“ç­†è¨˜ Designing Data-Intensive Applications ä¸‹\nRedlock ç°¡ä»‹ ç•¶æˆ‘å€‘åœ¨è¨­è¨ˆåˆ†æ•£å¼ Lock æ©Ÿåˆ¶æ™‚ï¼Œæœ‰ä¸‰é»åŸå‰‡å¿…é ˆè€ƒé‡åˆ°\nSafety ç•¶ Lock è¢«å–èµ°å¾Œï¼Œåœ¨é‡‹æ”¾ä¹‹å‰ä¸èƒ½æœ‰å¦ä¸€å€‹ Client å–å¾— Lockï¼Œä¹Ÿå°±æ˜¯ mutual exclusive DeadLock Free\nLock å¿…é ˆåœ¨ä¸€æ®µæ™‚é–“å¾Œ(TTL) è‡ªå‹•é‡‹æ”¾ï¼Œé¿å…æ¡ä½ Lock çš„ Client è·¨æ‰è€Œ Lock å¾æ­¤ä¸èƒ½è¢«é‡‹æ”¾ Fault Tolerance\næ•´é«”ç³»çµ±ä¸èƒ½æœ‰å–®ä¸€ç¯€é»å¤±æ•—çš„å¯èƒ½ï¼Œå¿…é ˆè€ƒé‡ç³»çµ±å®¹éŒ¯æ€§ å¾ŒçºŒè§£èªªæ¼”ç®—æ³•å¯¦ä½œæ™‚ï¼Œæœƒä¸æ–·å»æª¢è¦–é€™ä¸‰é»åŸå‰‡æ˜¯å¦è¢«æ»¿è¶³\néœ€æ³¨æ„åˆ°å®¹éŒ¯æ©Ÿåˆ¶å¯èƒ½æœƒè¯æƒ³åˆ° Master / Slave æ¶æ§‹ï¼Œä½†æ˜¯åœ¨ Redis ä¸­ Slave è³‡æ–™å‚™ä»½æ˜¯éåŒæ­¥çš„ï¼Œæ‰€ä»¥ç•¶ Master æ›æ‰åˆ° Slave æ¥æ‰‹ï¼Œä¸­é–“çš„æ™‚é–“å·® Client æœ‰æ©Ÿæœƒå–å¾—å¤šå€‹ç›¸åŒ Lockï¼Œé€™æœƒé•åç¬¬ä¸€é»åŸå‰‡ï¼ŒCluster æ¶æ§‹åŒç†\næ‰€ä»¥é€™è£¡ä½œè€…æè­°çš„å®¹éŒ¯æ©Ÿåˆ¶ä¸»è¦åŸºæ–¼ Multi-Master æ©Ÿåˆ¶ï¼Œå¾ŒçºŒæœƒæœ‰æ›´æ·±å…¥çš„è§£é‡‹\nå–®æ©ŸåŸå‰‡ å†è€ƒé‡åˆ†æ•£å¼è¨­è¨ˆä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆæ€è€ƒå–®ä¸€å° Redis å¦‚ä½•å¯¦ä½œ Lock æ©Ÿåˆ¶\nå–å¾— Lock ç•¶è¦å–å¾— Lockï¼Œå¯ä»¥ç”¨ä»¥ä¸‹çš„æŒ‡ä»¤\n1 SET resource_name my_random_value NX PX 30000 NX è¡¨ç¤ºåªæœ‰ç•¶ resource_name ä¸å­˜åœ¨æ‰å‰µå»ºé€™å€‹ Keyï¼Œé¿å…é‡è¤‡å»ºç«‹ï¼Œç¬¦åˆç¬¬ä¸€é»åŸå‰‡ Px 30000 è¡¨ç¤º Key çš„ TTL æ˜¯ 30ç§’ï¼Œç¬¦åˆç¬¬äºŒé»åŸå‰‡\né‡‹æ”¾ Lock 1 2 3 4 5 if redis.call(\u0026#34;get\u0026#34;,KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;del\u0026#34;,KEYS[1]) else return 0 end åœ¨é‡‹æ”¾ Key æ™‚ï¼Œå¿…é ˆå…ˆæª¢æŸ¥ Key å°æ‡‰çš„ Valueæ˜¯ä¸æ˜¯æˆ‘å€‘ä¸€é–‹å§‹å¡é€²å»çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šå€‹æ­¥é©Ÿçš„ my_random_valueï¼Œé€™æ˜¯è¦ç¢ºä¿ç§»é™¤çš„ Lock æ˜¯ç•¶åˆæˆ‘å€‘å–å¾—çš„ Lockï¼Œè©¦æƒ³ä¸€ä¸‹æƒ…æ³\n1 2 3 4 1. Client A å–å¾— Lock 2. Client A æ™‚é–“è¶…é TTLï¼ŒRedis ç§»é™¤ Lock 3. Client B å–å¾—ç›¸åŒ Lockï¼Œå› ç‚º Client A è¶…æ™‚æ‰€ä»¥ Client B å¯ä»¥å–å¾— Lock 4. Client A æ­¤æ™‚è¦é‡‹æ”¾ Lock æ­¥é©Ÿå››å¦‚æœæ²’æœ‰æª¢æŸ¥ï¼ŒClient A ä¸å°å¿ƒç§»é™¤äº† Client B çš„ Lockï¼Œæ­¤æ™‚å°±æœƒç ´å£ç¬¬ä¸€é»åŸå‰‡\nRandom String Random String çš„ç”¢ç”Ÿæ©Ÿåˆ¶ï¼Œå¯ä»¥å– /dev/urandom çš„ 20 bytesï¼Œ/dev/urandom æ˜¯*unix ç³»çµ±ç”¢ç”Ÿå½äº‚æ•¸çš„æ–¹å¼ï¼Œä¾æ“šè¨­å®šçš„ä¸åŒå¯èƒ½æ˜¯å¾ç’°å¢ƒå™ªéŸ³ã€ç¶²è·¯æ•¸æ“šå°åŒ…ç­‰å¤–åœ¨ç‰©ç†ç¾è±¡ï¼Œé€™æ¨£çš„åšæ³•å¯ä»¥ä¿è­‰è¼ƒå¥½çš„éš¨æ©Ÿæ€§ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–ç°¡å–®çš„æ–¹å¼ï¼Œä¾‹å¦‚å–ç³»çµ±æ™‚é–“åŠ ä¸Š client_id ç­‰ç­‰ï¼Œå–æ±ºæ–¼å¯¦ä½œè€…çš„è¨­è¨ˆ\nå¥—ç”¨è‡³åˆ†æ•£å¼ç³»çµ± å–å¾— Lock å‡è¨­ç›®å‰æœ‰ N å° Redis masterï¼Œé€™ N å°éƒ½è·‘åœ¨ç¨ç«‹çš„ç’°å¢ƒä¸Šè€Œéä½¿ç”¨ Cluster æ¶æ§‹ï¼Œå‡è¨­ N=5ï¼Œä»¥ä¸‹æ˜¯å¯¦ä½œæ­¥é©Ÿ\nå–å¾—ç•¶å‰æ™‚é–“ T1 ç”¨ç›¸åŒçš„ Key / Value ä¾åºå–å¾— N å°çš„ Lockï¼Œåœ¨å–å¾— Lock æ™‚è¦è¨­å®šé€£ç·šTimeoutï¼Œæ­¤ Timeout(ex. 5~50ms) æ‡‰è©²é å°æ–¼ Lock çš„ TTL (ex. 10s)ï¼Œé¿å… Client æµªè²»å¤ªå¤šæ™‚é–“åœ¨ç­‰æ­»æ‰çš„ Redis Serverï¼ŒClient å› å„˜é€Ÿå–å¾— Lock ç•¶å–å¾— Lock å¾Œï¼Œå‡è¨­æ­¤æ™‚æ™‚é–“ç‚º T2ï¼ŒClient æª¢æŸ¥ T2-T1 æ˜¯å¦å¤§æ–¼ Lock æœ‰æ•ˆæ™‚é–“ TTLï¼Œåªæœ‰ç•¶æ™‚é–“æœ‰æ•ˆä¸”å¤§å¤šæ•¸çš„ Redis Servre(éåŠæ•¸ï¼Œä¹Ÿå°±æ˜¯ \u0026gt;=3) æ‰ç®—æ˜¯æœ‰æ•ˆå–å¾— Lock æ­¤æ™‚ Lock åƒ…å‰©æœ‰æ•ˆæ™‚é–“æ˜¯ T2 - T1 å¦‚æœ Client å–å¾— Lock å¤±æ•— (ä¾‹å¦‚æœ‰æ•ˆæ™‚é–“æ˜¯è² æ•¸ã€ç„¡æ³•å–å¾—éåŠ Redis Master Lock)ï¼ŒClient å¿…é ˆå°æ¯ä¸€å° Redis Master ç™¼é€é‡‹æ”¾ Lock æŒ‡ä»¤ï¼Œå³ä½¿è©²å° Redis Master æ²’æœ‰çµ¦ä»– Lock åˆ†æ•£å¼ä»£è¡¨å„å€‹ç¨‹åºæ²’æœ‰åŒæ­¥çš„æ™‚é–“ä¸Šï¼Œè€Œä¸”æ¯å°æ©Ÿå™¨å› ç‚ºè¨ˆæ™‚å™¨çš„ç‰©ç†æ€§è³ªï¼Œæœƒæœ‰æ™‚é–“åå·®çš„å•é¡Œ(Clock Drift å•é¡Œ) æ™‚é–“è¨ˆç®—æœƒå½±éŸ¿ç¬¬ä¸‰æ­¥é©Ÿçš„æœ‰æ•ˆæ™‚é–“ï¼Œæ‰€ä»¥éœ€è¦æ¸›å»ä¸€é»åå·®ç•¶ä½œè£œå„Ÿï¼Œä½†ç¾å¯¦ä¸–ç•Œçš„æ™‚é–“è¨ˆç®—é ‚å¤šå°±å¹¾å€‹æ¯«ç§’çš„èª¤å·®\næ‰€ä»¥å¯¦éš› Lock çš„æœ‰æ•ˆæ™‚é–“æœƒæ˜¯ TTL - (T2-T1) - CLOCK_DRIFT\nRetry å¦‚æœ Client å–å¾— Lock å¤±æ•—ï¼Œæ‡‰è©²åœ¨ä¸€å®šç§’æ•¸å¾Œéš¨æ©Ÿ delay ä¸€æ®µæ™‚é–“ï¼Œå†æ¬¡é‡æ–°å˜—è©¦ï¼Œéš¨æ©Ÿ delay æ˜¯ç‚ºäº†éŒ¯é–‹åŒæ™‚å¤šå€‹ Clientï¼Œè®“è¼ƒå¿«è€…å¯ä»¥å…ˆå–å¾— Lockï¼Œå¦‚æœ Client æ²’æœ‰å–å¾— Lockï¼Œæ‡‰è©²å„˜é€Ÿé‡‹æ”¾ Lock\né‡‹æ”¾ Lock åŒæ™‚å‘æ‰€æœ‰çš„ Redis Master é‡‹æ”¾ Lock\næª¢é©—æ¼”ç®—æ³• å› ç‚ºå†ä¾åºå–å¾— Lock æœƒæœ‰æ™‚é–“å·®ï¼Œå‡è¨­ Client å¾ç¬¬ä¸€å€‹ Redis Master å–å¾— Lock æ™‚é–“ç‚º T1ï¼Œæœ€å¾Œä¸€å€‹ Master å›å‚³æ™‚é–“ç‚º T2ï¼Œé‚£éº¼ç¬¬ä¸€å€‹ Lock åƒ…å‰©çš„ç”Ÿå‘½æ™‚é–“æ˜¯ TTL - (T2 - T1) - Clock Driftï¼Œé€™ä¹Ÿå°±æ˜¯æœ€å°æœ‰æ•ˆæ™‚é–“ MIN_VALIDITYï¼›Clock Drift æ˜¯ä¸Šè¿°çš„æ™‚é–“èª¤å·®ï¼›(T2-T1) å‰‡æ˜¯å– Lock çš„ç­‰å¾…æ™‚é–“\nå‡è¨­ Client å– Lock æ™‚é–“ (T2-T1) \u0026gt; TTLï¼Œä¹Ÿå°±æ˜¯ Client å–åˆ°æœ€å¾Œä¸€å€‹ Lock æ™‚ç¬¬ä¸€å€‹ Lock å·²ç¶“å¤±æ•ˆäº†ï¼Œé‚£æ­¤æ™‚å°±æœƒå…¨éƒ¨é‡‹æ”¾ï¼Œä¸æœƒæœ‰éŒ¯èª¤ç”¢ç”Ÿ\nå‡è¨­ Client æˆåŠŸå–å¾— Lockï¼Œé‚£åœ¨å…ˆå‰çš„æ¢ä»¶ä¿è­‰ï¼Œæ²’æœ‰å…¶ä»–ç”¨æˆ¶å¯ä»¥åœ¨ MIN_VALIDITY å…§å–å¾—å¤§å¤šæ•¸ Master çš„ Lockï¼Œä¹Ÿå°±ä¸æœƒç ´å£ Lock çš„åŸå‰‡æ€§\nè¦ç¢ºä¿ MIN_VALIDITY çš„æ™‚é–“å…§é—œéµè³‡æºèƒ½å¤ é‹ä½œå®Œæˆï¼Œä¸ç„¶ TTL éå¾Œ Lock è¢«å…¶ä»–äººå–èµ°ï¼ŒLock å°±å¤±å»äº’æ–¥åŸå‰‡\næ€§èƒ½ã€æ•…éšœå¾©åŸ Redis å¸¸ç”¨æ–¼é«˜æ€§èƒ½éœ€æ±‚çš„å ´æ™¯ï¼Œæˆ‘å€‘æœƒå¸Œæœ› Lock å–å¾—/é‡‹æ”¾å¯ä»¥è¶Šå¿«ï¼Œå¢åŠ  throughput èˆ‡é™ä½å»¶é²ï¼Œåœ¨éç¨‹æœ€å¥½çš„æ–¹å¼æ˜¯ Client åŒæ™‚å‘å¤šå° Master å– Lock\nå¦å¤–è€ƒé‡åˆ°æ•…éšœå¾©åŸçš„éƒ¨åˆ†ï¼Œå‡è¨­ä»Šå¤©å–å¾— Lock å¾Œ Master æ•…éšœäº†ï¼Œå‡ä½¿æ²’æœ‰é–‹ AOF å„²å­˜æ©Ÿåˆ¶ï¼Œé‚£å¯èƒ½ Lock æ²’æœ‰ä¿å­˜åˆ°ç£ç¢Ÿä¸Šï¼Œå¾©åŸæ™‚éºå¤±å°±æœ‰æ©Ÿæœƒé•åç¬¬ä¸€é»åŸå‰‡\nå‡ä½¿æœ‰é–‹ AOFï¼Œä¹Ÿè¨˜å¾—è¦èª¿æ•´ fsync é »ç‡ï¼Œæœ€ä¿éšªæ˜¯è¨­æˆ alwaysï¼Œä½†é€™æœƒå½±éŸ¿æ€§èƒ½\nä½†é™¤äº†å³æ™‚è³‡æ–™å‚™ä»½åˆ°ç£ç¢Ÿä¸Šå¤–ï¼Œé‚„å¯ä»¥è€ƒæ…®å¦ä¸€ç¨®åšæ³•ï¼Œç•¶ Master æ•…éšœå¾©åŸå¾Œï¼Œå»¶é²é‡å•Ÿçš„æ™‚é–“å¤§æ–¼ TTLï¼Œä¹Ÿå°±æ˜¯èªªè®“åŸå…ˆ Master ä¸Šçš„ Lock éƒ½é‡‹æ”¾æˆ–è‡ªå‹•å¤±æ•ˆï¼Œä¹‹å¾Œå†é‡æ–°åŠ å…¥å°±èƒ½é¿å…é•åå®‰å…¨åŸå‰‡ï¼Œä¸éè¦å°å¿ƒå¦‚æœè¶…éå¤šæ•¸çš„ Server æ•…éšœï¼Œéœ€è¦ç­‰ç›¸å°é•·çš„æ™‚é–“æ‰èƒ½é‡æ–°é‹ä½œï¼Œæ­¤éšæ®µ Lock éƒ½ç„¡æ³•å–å¾—\næœ€å¾Œå¦‚æœæœ‰é¤˜è£•å¯ä»¥è¨­è¨ˆå»¶é•· Lockï¼Œè®“æ¡æœ‰ Lock çš„ Client å¯ä»¥å»¶é•·æ‰‹ä¸­çš„ Lock\nä»¥ä¸Šæ˜¯æ‘˜éŒ„è‡ªå®˜ç¶²æ–‡ä»¶çš„æ•´ç†\nNodejs Package - Redlock å¯¦ä½œ çœ‹å®Œæ¼”ç®—æ³•ï¼Œä¾†çœ‹ä¸€ä¸‹ Nodejs ç‰ˆæœ¬çš„å¯¦ä½œ mike-marcacci/node-redlock\nä»–åœ¨ Redlock.prototype._lock éƒ¨åˆ†å¯¦ç¾ Lock æ©Ÿåˆ¶\næˆªå¹¾å€‹é—œéµç‰‡æ®µï¼Œè¼ªè©¢æ‰€æœ‰çš„ server\n1 2 3 return self.servers.forEach(function(server){ return request(server, loop); }); request ä¸»è¦å°è£ lock çš„ scriptï¼Œæ”¯æ´å¦‚æœåŒæ™‚å¤šå€‹ resource è¦é–å¯ä»¥ä¸€èµ·é–\n1 2 3 4 5 6 7 8 9 10 11 12 request = function(server, loop){ return server.eval( [ self.lockScript, resource.length, ...resource, value, ttl ], loop ); }; é€™ä¸€æ®µè€ƒé‡åˆ° drift å•é¡Œï¼Œæª¢æŸ¥ Lock çš„æœ‰æ•ˆæ™‚é–“ï¼Œä¸¦ä¸”åªæœ‰åœ¨å–å¾—å¤šæ•¸ Redis Server åŒæ„æ‰å¾€ä¸‹ç¹¼çºŒ\n1 2 3 4 5 6 7 8 // Add 2 milliseconds to the drift to account for Redis expires precision, which is 1 ms, // plus the configured allowable drift factor const drift = Math.round(self.driftFactor * ttl) + 2; const lock = new Lock(self, resource, value, start + ttl - drift, attempts); // SUCCESS: there is concensus and the lock is not expired if(votes \u0026gt;= quorum \u0026amp;\u0026amp; lock.expiration \u0026gt; Date.now()) return resolve(lock); ä¸»è¦é—œéµæ˜¯é€™å¹¾å€‹éƒ¨åˆ†ï¼Œå…¶é¤˜çš„å°±æ˜¯å°è£\nMartin Kleppmann çš„è³ªç–‘ ä¸­æ–·å°è‡´ Lock æœ‰æ•ˆåˆ¤æ–·éŒ¯èª¤ åœ¨åˆ†æ•£å¼ç³»çµ±è¨­è¨ˆä¸­ï¼Œæ™‚é–“æ˜¯ä¸€å€‹éå¸¸é›£ä»¥æŒæ¡çš„å› ç´ ï¼Œç¨‹åºå¯èƒ½å› ç‚ºå„ç¨®ç‹€æ³è€Œå°è‡´æ™‚é–“åºéŒ¯äº‚ï¼Œä¾‹å¦‚èªªç³»çµ±æ™‚é–“ä¸æº–ã€ç¶²è·¯å»¶é²ã€ç¨‹å¼é‹ä½œé‡åˆ°åƒåœ¾å›æ”¶ã€ä½œæ¥­ç³»çµ±åˆ‡æ› Process å°è‡´ä¸­æ–·ç­‰ï¼Œæ‰€ä»¥å„ç¨®æª¢æŸ¥æ©Ÿåˆ¶éƒ½æœ‰å¯èƒ½å› è€Œå‡ºç¾éŒ¯èª¤ï¼Œä¾‹å¦‚ä»¥ä¸‹çš„ä¾‹å­ Client1 å–å¾— Lock å¾Œ çµæœé‡åˆ° GC æš«åœé‹ä½œ Lock è¶…é TTL è‡ªå‹•é‡‹æ”¾ï¼Œæ­¤æ™‚ Client2 æˆåŠŸå–å¾— Lockï¼Œä¸¦æ›´æ–° DB ç´€éŒ„ æ¥è‘— Client å¾ GC ä¸­æ¢å¾©ï¼Œä»–ä»¥ç‚ºè‡ªå·±æ‰‹ä¸Šæœ‰ Lock å¯ä»¥å»æ›´æ–° DB é€™æ¨£å°±é•åäº† Lock çš„å®‰å…¨æ€§åŸå‰‡\nç›´è¦ºè§£æ³•æ˜¯åœ¨æ›´æ–° DB ä¹‹å‰ Client å†å»æª¢æŸ¥ Lock çš„æ™‚æ•ˆæ€§ï¼Œä½† GC å¯èƒ½å¡åœ¨æª¢æŸ¥å®Œä¹‹å¾Œçš„é‚£ä¸€å€‹é»ï¼Œæ‰€ä»¥è¨­å®šå†å¤šæª¢æŸ¥éƒ½æ˜¯æ²’ç”¨çš„\nå¯¦éš›è§£æ³•ä¹Ÿè »ç›´è¦ºçš„ï¼Œç³»çµ±å…¨åŸŸæœ‰å€‹ä¸æ–·éå¢çš„ç™¼è™Ÿæ©Ÿåˆ¶ï¼Œæ¯å–ä¸€æ¬¡ Lock å°±é…ä¸€å€‹æ•¸å­—ï¼Œåœ¨ DB æ›´æ–°çš„æ™‚å€™ï¼Œæª¢æŸ¥å°æ‡‰çš„æ•¸å­—æ˜¯ä¸æ˜¯æœ‰å¤§æ–¼ä¸Šæ¬¡æ›´æ–°çš„æ•¸å­—ï¼Œå°±å¯ä»¥é¿å…æ‰ä¸Šè¿°æåˆ°çš„å•é¡Œï¼Œå°±æ˜¯ Fencing æ©Ÿåˆ¶\nå¤ªå¿«æ¨‚è§€é ä¼°æ™‚é–“çš„è¤‡é›œæ€§ TTL çš„ã€Œæ™‚é–“ã€è¨ˆç®—æœ‰å¯¦ä½œå•é¡Œï¼ŒRedis ç›®å‰ä½¿ç”¨ gettimeofday è€Œé monotonic clock çš„æ™‚é–“\nå‰è€…æ˜¯ç³»çµ±æ™‚é–“ï¼Œé€™æ˜¯å¯ä»¥è¢«èª¿å‹•ï¼Œä¾‹å¦‚ NTP Server åŒæ­¥ / Admin æ‰‹å‹•èª¿æ•´ç­‰ï¼Œæ‰€ä»¥æ™‚é–“å¯èƒ½å¤§å¹…åº¦å‰å¾Œè·³å‹•\nè€Œå¾Œè€…æ˜¯æ¯ç•¶ timmer ç™¼å‡º interrupt å°± æŒçºŒéå¢æ°¸ä¸å›é ­ï¼Œæ‰€ä»¥åœ¨åˆ¤æ–·å…©å€‹é»çš„çµ•å°æ™‚é–“å·®ç”¨å¾Œè€…æœƒæ¯”è¼ƒç²¾æº–\nè©¦æƒ³å¦‚æœ Client1 å–å¾— Lock å¾Œ Redis æ™‚é–“è·³è½‰ç«‹åˆ» Lock å¤±æ•ˆï¼Œçµæœ Client2 åˆå¯ä»¥æ‹¿åˆ° Lockï¼Œå°±æœƒé•åå®‰å…¨æ€§åŸå‰‡\næ­¤å¤– Martin Kleppmann èªç‚º Redlock é è¨­å¤ªå¤šæ™‚é–“å› ç´ æ˜¯å¯é æœŸçš„ï¼Œåƒæ˜¯ç¶²è·¯å»¶é²ã€æ™‚é˜åç§»ç­‰å•é¡Œï¼Œä½†é€™ä¸æ˜¯åˆ†æ•£å¼æ¼”ç®—æ³•æ­£ç¢ºçš„è¨­è¨ˆæ–¹å¼ï¼Œæ‰€ä»¥ Redlock çš„å®‰å…¨æ€§æ˜¯å»ºç«‹åœ¨åŠåŒæ­¥ç³»çµ±ç•¶ä¸­(æ„å³å„ç¨®æ™‚é–“å› ç´ æ˜¯æœ‰ä¸Šé™ä¸”å¯ä»¥è¢«å‡è¨­çš„)ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„åˆ†æ•£å¼è¨­è¨ˆ\nantirez å†æ¬¡å›å¾© ä»¥ä¸Šå…©é»ä¸»è¦æ˜¯è¢«è³ªç–‘çš„éƒ¨åˆ†ï¼Œæ¥è‘—çœ‹ antirez å›è¦†\nç•¶è‡ªå‹•é‡‹æ”¾æ©Ÿåˆ¶å°è‡´ Lock çš„ Mutual Exlusive æ©Ÿåˆ¶å¤±æ•ˆæ™‚ åœ¨ Martin ç¬¬ä¸€é»è³ªç–‘ä¸­ï¼Œä»–è¦ºå¾—è¦åŠ ä¸Šéå¢çš„ Token ç•¶ä½œä¿è­·æ©Ÿåˆ¶ï¼Œé¿å… Client æ‰‹ä¸Š Token éæœŸé‚„å»æ›´æ–° Resourceï¼Œé”åˆ°å¼·ä¿è­‰æ€§\nè®“æˆ‘å€‘å…ˆå›éé ­ä¾†æƒ³ç‚ºä»€éº¼æˆ‘å€‘æœƒéœ€è¦åˆ†æ•£å¼ Lockï¼Œæ­£æ˜¯å› ç‚ºæˆ‘å€‘çš„é—œéµè³‡æºæœ¬èº«æ²’è¾¦æ³•ä¸€æ¬¡åªæœå‹™ä¸€å€‹è«‹æ±‚ (linearizable)ï¼Œå¦‚æˆ‘è‡ªèº«æ¡ˆä¾‹æ˜¯ API Server åŒæ™‚æœ‰å¤šå°\nè€Œ Martin æå‡ºçš„ç³»çµ±å…¨åŸŸæœ‰å€‹éå¢ Tokenï¼Œé—œéµè³‡æºåœ¨æ“ä½œæ™‚æœƒå…ˆå»æª¢æŸ¥ Tokenï¼Œé€™æœ¬èº«å°±æ˜¯å€‹ linearizable storeï¼Œè®“æ‰€ä»¥çš„æ“ä½œä¸å†ä½µç™¼è€Œè®Šæˆç·šæ€§é€ä¸€è™•ç†ï¼Œé€™æœ¬èº«å°±èˆ‡åˆ†æ•£å¼çš„ç¾æ³çŸ›ç›¾\nå†è€…å¦‚æœæœ‰å€‹éå¢ Token ç³»çµ±ï¼Œé‚£ Redlock åœ¨ç”¢ç”Ÿ Lock çš„ Value æ™‚ï¼Œç”¨é€™å€‹éå¢ Token å–ä»£åŸæœ¬çš„éš¨æ©Ÿå­—ä¸²ä¹Ÿæœ‰ä¸€æ¨£çš„æ•ˆæœ\nåˆæˆ–æ˜¯æ ¹æœ¬ä¸éœ€è¦éå¢å‡½æ•¸ï¼Œåªè¦æŠŠéš¨æ©Ÿå­—ä¸²ä¹Ÿè¨˜éŒ„åˆ°é—œéµè³‡æºä¸Šï¼Œåœ¨æ“ä½œæ™‚å»æ¯”å°å…ˆå¾Œå…©è€…æ˜¯å¦ç›¸åŒï¼ŒåŒæ¨£æœ‰ Fencing çš„æ•ˆæœ\nåŸºæ–¼æ™‚é–“çš„éå¤šç†æƒ³åŒ–å‡è¨­ ä½œè€…æ‰¿èª Redis æ‡‰è©²æ”¹ç”¨ monotonic timeï¼Œä½†æ˜¯çœ‹ä¾†é‚„æ²’æœ‰å€‹çµè«–æ˜¯å¦è¦ä¿®æ­£ Redis Repo - (#416) Use monotonic clock when availableï¼Œä¸»è¦å•é¡Œåœ¨æ–¼ä¸¦éæ‰€æœ‰ç³»çµ±éƒ½æ”¯æ´ monotonic time API\né—œæ–¼æ™‚é–“è·³å‹•çš„å•é¡Œï¼Œä½œè€…ä¸¦æ²’æœ‰çµ¦å‡ºå¾ˆæ˜ç¢ºçš„ç­”æ¡ˆï¼Œä½†çœ‹ä¾†åªèƒ½ç›¡é‡é¿å…(ä¾‹å¦‚ Admin ä¸è¦æ”¹å‹•ç³»çµ±æ™‚é–“)è€Œä¸æ˜¯å¾æ¼”ç®—æ³•çš„éƒ¨åˆ†æ”¹é€²ï¼Œå› ç‚ºç›®å‰ Redis é‚„ä¸æ˜¯ç”¨ monotonic time API\næ¥è‘—è€ƒé‡ä¸€å€‹æƒ…æ³\nå–å¾—ç•¶å‰æ™‚é–“ å–å¾— Lock è¨ˆç®—ç•¶å‰æ™‚é–“ æª¢æŸ¥ Lock æ˜¯å¦é‚„åœ¨æœ‰æ•ˆæœŸé–“ å¦‚æœæœ‰ Lockï¼Œå‰‡ç¹¼çºŒè™•ç† åœ¨æ­¥é©Ÿä¸€åˆ°ä¸‰ï¼Œä¸è«–æ˜¯ç¶²è·¯å»¶é²ã€ç¨‹åºä¸­æ–·ç­‰æ™‚é–“å•é¡Œï¼Œéƒ½æ²’æœ‰é—œä¿‚ï¼Œå› ç‚ºæ­¥é©Ÿå››æœƒå†æ¬¡æª¢æŸ¥ Lock\nä½†å¦‚æœæ˜¯åœ¨ç¬¬å››æ­¥åˆ°ç¬¬äº”æ­¥ä¹‹é–“ï¼Œé€™æ™‚å€™æ²’æœ‰ä»»ä½•æœ‰è‡ªå‹•é‡‹æ”¾æ©Ÿåˆ¶çš„åˆ†æ•£å¼ Lock å¯ä»¥ä¿è­‰ Mutual Exclusiveï¼Œåªèƒ½é é—œéµè³‡æºæœ¬èº«çš„æ©Ÿåˆ¶ï¼Œé€™å°±å›åˆ°ä¸Šä¸€æ­¥èªªçš„ Fencing æ©Ÿåˆ¶ï¼Œä¾‹å¦‚èªª DB å°±å¯«å…¥éå¢ Token æˆ–éš¨æ©Ÿå­—ä¸²ï¼Œè®“å¾Œè€…ä¸èƒ½æ›´æ–°\næ‰€ä»¥ Redlock å®‰å…¨å—ï¼Ÿ\nç­”æ¡ˆå–æ±ºæ–¼å°æ–¼å®‰å…¨çš„è¦æ±‚æœ‰å¤šé«˜ï¼Œ\né…ç½®å¤šå° Redis Server ä¸¦é–‹å•Ÿ fsync = always çš„ Redlock æ©Ÿåˆ¶ åœ¨ç³»çµ±æ™‚é–“æ²’æœ‰å¤§å¹…åº¦è·³å‹•çš„æƒ…æ³ä¸‹ Lock TTL ä¿è­‰å¤§æ–¼é—œéµè³‡æºçš„é‹è¡Œæ™‚é–“æˆ–æ˜¯åœ¨é—œéµè³‡æºè™•æœ‰ fencing æ©Ÿåˆ¶ ç¬¦åˆé€™ä¸‰é» Redlock å°±æ˜¯å®‰å…¨çš„\næ­£å› ç‚ºæˆ‘å€‘æ²’æœ‰å…¶ä»–æ–¹æ³•é¿å… Race Conditionï¼Œæ‰æœƒæ¡ç”¨ Redlock æˆ–æ˜¯å…¶ä»–æ¨‚è§€é–çš„è™•ç†æ©Ÿåˆ¶\n","date":"2020-01-14T05:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-01-14_redis-lock-redlock-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E8%88%87%E5%AF%A6%E4%BD%9C/","title":"Redis Lock (Redlock) åˆ†æ•£å¼ lock åŸç†åˆ†æèˆ‡å¯¦ä½œ"},{"content":"è¿‘æ—¥å› ç‚ºå…¬å¸å°ˆæ¡ˆï¼Œè¦æŠŠä¹‹å‰å¯«å¥½è™•ç†åœ–ç‰‡çš„ C++ code æ¬ç§»è‡³ç¶²é ä¸Šï¼Œè¶æ©Ÿæœƒæ¢ç´¢ Web Assemblyï¼Œæœªä¾†å¯ä»¥æŒçºŒç§»æ¤ç¾æœ‰çš„ C/C++ Libraryï¼Œå¢åŠ ç¨‹å¼çš„å¾©ç”¨æ€§èˆ‡å‰ç«¯çš„é–‹ç™¼è‡ªç”±åº¦\nWebassembly å…¶å¯¦ä¹Ÿä¸æ˜¯ä»€éº¼æ–°æŠ€è¡“äº†ï¼Œåœ¨ 2017 å¹´å·²ç¶“æ­£å¼æ¨å‡ºï¼Œä¸¦åœ¨å››å¤§ç€è¦½å™¨éƒ½èƒ½å¤ ä½¿ç”¨ï¼ŒNodejs ä¹Ÿæ”¯æ´ï¼Œä½†ç¶²è·¯ä¸Šç›¸å°çš„ä¸­æ–‡è¼ƒå°‘ï¼Œä¾‹å¦‚è¨˜æ†¶é«”æ“ä½œã€pass by reference ç­‰ç­‰è¼ƒå°‘æåŠï¼Œé€™ä¹Ÿæ˜¯è®“æˆ‘é ­ç–¼è¨±ä¹…çš„åœ°æ–¹ï¼ŒèŠ±äº†å…©å¤©ä¸æ–·è©¦éŒ¯ï¼Œè¶è·¨å¹´å‡æœŸæ•´ç†ä¸¦åˆ†äº«\nä»¥ä¸‹å…©å¤©æ˜¯ä¸»è¦åƒè€ƒçš„æ–‡ç« \nCreating a WebAssembly module instance with JavaScript\nEmscripting a C library to Wasm Passing and returning WebAssembly array parameters Webassembly(Wasm) ä¸»è¦ç›®çš„æ˜¯å°‡å…¶ä»–èªè¨€é€éç·¨è­¯æ–¹å¼è¼¸å‡ºç€è¦½å™¨å¯ä»¥é‹ä½œçš„ bytecodeï¼Œç›®å‰é™¤äº† C/C++ å¤–ï¼ŒRust ä¹Ÿæ˜¯å€‹ç†±é–€çš„ Wasm é–‹ç™¼èªè¨€ï¼Œå‘¨åœçš„ç”Ÿæ…‹ç³»èˆ‡å·¥å…·éˆéƒ½ç›¸å°å®Œå–„ï¼›\nä»¥ä¸‹çš„æ•™å­¸ä¸»è¦å°ˆæ³¨æ–¼ä½¿ç”¨ Emscriptenï¼ŒEmscripten åŠŸç”¨æ˜¯å°‡ C/C++ ç·¨è­¯æˆ Wasmï¼Œé™¤æ­¤ä¹‹å¤–æä¾› JS å«æ¥åˆ° Wasm é€™ç«¯çš„è™•ç†(è† æ°´ç¨‹å¼)ï¼Œä¾‹å¦‚èªª malloc / free / printf / cout ç­‰ç­‰ C/C++ çš„æ¨™æº–å‡½å¼åº«æ”¯æ´çš„å‡½å¼ï¼Œç›®å‰ Wasm ä¸èƒ½ç›´æ¥ Accessï¼Œåªèƒ½é€é JS å»æ“ä½œ WebAPIï¼Œé€™äº›éƒ½å¿…é ˆåœ¨ç·¨è­¯æ™‚è¢«ç´å…¥å¯¦ä½œï¼Œæ­¤å¤– Wasm ç›®å‰é‚„ä¸èƒ½åƒä¸€èˆ¬çš„ JS Library ç›´æ¥ include å°±èƒ½ä½¿ç”¨ï¼Œè€Œæ˜¯è¦è™•ç† Memory Mapping ç­‰ï¼Œé€™äº› Emscripten éƒ½æœƒè™•ç†å¥½\nä¸»è¦æ•™å­¸é …ç›®æœ‰\nä½¿ç”¨ Emscripten ç”¢ç”Ÿç¯„ä¾‹ code ç§»æ¤ä¹˜æ³•é‹ç®— C++ Code è¨˜æ†¶é«”æ“ä½œï¼Œé—œæ–¼ Pointer \u0026amp; Array Wasm ç¸½çµ ä½¿ç”¨ Emscripten ç”¢ç”Ÿç¯„ä¾‹ code å®‰è£ Emscripten Emscripten å®˜æ–¹å®‰è£æ­¥é©Ÿï¼ŒæŒ‰ç…§æ­¥é©Ÿå®‰è£æœ€æ–°ç‰ˆçš„ Emscriptenï¼Œç¢ºèªå®‰è£å®Œæˆ\nemcc \u0026ndash;version\nå®˜æ–¹åŸºç¤æ•™å­¸ Hello World ä»¥ä¸‹åƒè€ƒ å®˜æ–¹åŸºç¤æ•™å­¸ Hello Worldï¼Œä¸¦ç¿»è­¯(è§£é‡‹)æ¯å€‹æ­¥é©Ÿ\nç”¢ç”Ÿ hello_world.c 1 2 3 4 5 6 7 8 9 10 11 12 13 /* * Copyright 2011 The Emscripten Authors. All rights reserved. * Emscripten is available under two separate licenses, the MIT license and the * University of Illinois/NCSA Open Source License. Both these licenses can be * found in the LICENSE file. */ #include \u0026lt;stdio.h\u0026gt; int main() { printf(\u0026#34;hello, world!\\n\u0026#34;); return 0; } åŸ·è¡Œ\n$ emcc build/hello_world.c -o hello_world.html\næ­¤æ™‚æœƒè¼¸å‡ºä¸‰å€‹æª”æ¡ˆï¼Œhello_world.htmlã€hello_world.out.jsã€hello_world.wasm\n-o æŒ‡å®šè¼¸å‡ºçš„æª”æ¡ˆèˆ‡æª”åï¼Œå¦‚æœæ²’æœ‰æŒ‡å®šæœƒè¼¸å‡º a.out.jsã€a.wasmï¼›\n.html æª”æ˜¯ Emscripten æ–¹ä¾¿é–‹ç™¼è€…é™¤éŒ¯ç”¨çš„ç¶²é ï¼› .wasm æª”å³æ˜¯ binary æ ¼å¼çš„ assembly codeï¼Œäººé¡ç„¡æ³•é–±è®€ï¼› .js æª”æ˜¯å¾ŒçºŒèˆ‡ JS æ•´åˆæœƒéœ€è¦ç”¨åˆ°çš„æª”æ¡ˆï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ NodeJS åŸ·è¡Œ $ node hell_world.out.js\n-o å¦‚æœæœ‰æŒ‡å®š {file_name}.htmlï¼Œå‰‡æœƒç”Ÿæˆé…åˆçš„å‰ç«¯é é¢ï¼Œé¡¯ç¤º main function çš„åŸ·è¡Œçµæœ\næœ‰äº† html æª”ï¼Œå¯ä»¥ä½¿ç”¨ http server ç”¨ç€è¦½å™¨é–‹å•Ÿç¶²é ï¼Œä¾‹å¦‚ npm å¥—ä»¶ http-serverï¼Œåœ¨æœ¬åœ°ç«¯é–‹å•Ÿé é¢æŸ¥çœ‹çµæœ\nC++ çš„ code é›·åŒ\n1 2 3 4 5 6 #include \u0026lt;iostream\u0026gt; int main() { std::cout \u0026lt;\u0026lt; \u0026#34;hello, world!\u0026#34; \u0026lt;\u0026lt; std::endl; return 0; } ä¹˜æ³•é‹ç®—ä¸¦ç§»æ¤åˆ°ç¶²é ä¸Š ä¸Šè¿°çš„ hello_world ä¸»è¦æ˜¯æª¢æ¸¬ç’°å¢ƒèˆ‡å·¥å…·éŠæ˜¯å¦æ­£å¸¸ï¼Œæ¥è‘—é–‹å§‹æš–èº«ï¼Œç”¨ C++ å¯«ä¸€å€‹ç°¡å–®çš„æ•´æ•¸ä¹˜æ³•é‹ç®—ï¼Œè¼¸å…¥å…©å€‹æ•´æ•¸ï¼Œå›å‚³å…©æ•´æ•¸ç›¸ä¹˜çš„çµæœï¼Œè‘—é‡æ–¼å¦‚ä½•å°‡ Wasm æ•´åˆé€²å‰ç«¯ä¸­\nç”¢ç”Ÿ multiply.cpp 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #include \u0026lt;iostream\u0026gt; #include \u0026lt;emscripten/emscripten.h\u0026gt; extern \u0026#34;C\u0026#34; { EMSCRIPTEN_KEEPALIVE int multiply(int num1, int num2) { return num1 * num2; } int main() { int result = multiply(2, 5); std::cout \u0026lt;\u0026lt; result \u0026lt;\u0026lt; std::endl; return 0; } } é è¨­ Emscripten ç”¢ç”Ÿçš„ .js åªæœƒåŸ·è¡Œ main functionï¼Œå¦‚æœæƒ³è¦å‘¼å«å…¶ä»–éŸ“å¼å¿…é ˆåœ¨æ¬²è¼¸å‡º function å‰åŠ ä¸Š EMSCRIPTEN_KEEPALIVEï¼Œåœ¨ Comile æ™‚æŒ‡å®šåƒæ•¸ -s NO_EXIT_RUNTIME=1 é¿å… wasm åŸ·è¡Œ main function å¾Œç›´æ¥é€€å‡º\nå¦å¤–å¦‚æœæ˜¯ä½¿ç”¨ C++ è€Œä¸æ˜¯ Cï¼Œå»ºè­°åœ¨è¦è¼¸å‡ºçš„ function å‰åŠ ä¸Š extern \u0026quot;C\u0026quot;ï¼Œä¸»è¦æ˜¯æŒ‡å®šé€™ä¸€æ®µç¨‹å¼ç¢¼ç”¨ C çš„æ–¹å¼ç·¨è­¯ï¼Œé€™æ¨£è¼¸å‡ºçš„ function åç¨±æœƒä¿æŒåŸç‹€ï¼Œå¯ä»¥è©¦è‘—æ‹¿æ‰çœ‹çœ‹\n$ emcc build/multiply.cpp -s NO_EXIT_RUNTIME=1 -o multiply.js\næ­¤æ™‚æœƒè¼¸å‡º multiply.js \u0026amp; multiply.wasm\nå¦‚æœä¸ç¢ºå®š compiled å‡ºä¾†çš„æª”æ¡ˆèƒ½ä¸èƒ½é‹è¡Œï¼Œå»ºè­°å…ˆ -o {filename}.html ç¢ºèªå¯ä»¥é‹ä½œï¼Œæ¥è‘—å†è€ƒæ…®ç§»æ¤\nåœ¨ç¶²é ä½¿ç”¨ multiply.out.js ç¨ç«‹ç”¢ç”Ÿ index.html\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;ie=edge\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Document\u0026lt;/title\u0026gt; \u0026lt;script src=\u0026#34;./multiply.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; Module.onRuntimeInitialized = function() { console.log(Module); console.log(Module._main()); console.log(Module._multiply(2, 7)); }; \u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; è«‹æ‰“é–‹ Console \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç•¶æˆ‘å€‘æ‰“é–‹ Consoleï¼Œå¯ä»¥çœ‹åˆ° 10ï¼Œä»¥åŠ Module é€™å€‹ç”± multiply.js export çš„ Objectï¼Œç•¶æˆ‘å€‘æƒ³è¦ä½¿ç”¨ Module ç•¶ä¸­çš„åƒæ•¸ï¼Œéœ€è¦åŒ…åœ¨ onRuntimeInitialized listener ç•¶ä¸­ï¼Œç­‰ Module åˆå§‹åŒ–å®Œæˆæ‰èƒ½èª¿ç”¨ï¼ŒModule è£¡é ­åŒ…å«éå¸¸å¤šçš„åƒæ•¸èˆ‡ functionï¼Œå¾ŒçºŒæœƒå†ä»‹ç´¹\nè€Œæˆ‘å€‘è¼¸å‡ºçš„ function æœƒä¸»å‹•è¢«åŠ ä¸Š _ å‰ç¶´ï¼Œå¦‚æœè¦å‚³å…¥ int ç›´æ¥ç”¨ JS çš„ number å°±å¯ä»¥äº†\nç”šè‡³å¦‚æœç”¨ Module._multiply(2, \u0026quot;10\u0026quot;) éƒ½æœƒæˆåŠŸè¼¸å‡º 20ï¼Œå‚³å…¥åƒæ•¸æ™‚æœƒè‡ªå‹•åšå‹åˆ¥è½‰æ›ï¼Œå¦‚æœè¼¸å…¥ç´”å­—ä¸²å‰‡æœƒå›å‚³ 0\nè¨˜æ†¶é«”æ“ä½œï¼Œé—œæ–¼ Pointer \u0026amp; Array åœ¨ C/C++ ä¸­ï¼Œpointer å¾ˆå¸¸è¢«ç›´æ¥ç•¶ä½œåƒæ•¸å‚³éï¼Œè®“ sub function ç›´æ¥æ“ä½œ pointer æŒ‡å‘çš„è¨˜æ†¶é«”ä½ç½®ï¼Œfunction return å¾ŒåŸ function å¯ä»¥ç›´æ¥å–å€¼å‡ºä¾†ç”¨\nç›®æ¨™æ˜¯å¯¦ä½œä¸€å€‹ filter function biggerThanï¼Œåªæœ‰å¤§æ–¼ target çš„ element æœƒè¢«å¡é€² array_pointer æŒ‡å‘çš„è¨˜æ†¶é«”ä½ç½®ï¼Œsize æŒ‡å‘æœ€å¾Œçš„ array length\n1 2 // ç›®æ¨™ biggerThan([elements], elements.length, target, \u0026amp;array_pointer, \u0026amp;size) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #include \u0026lt;iostream\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;emscripten/emscripten.h\u0026gt; extern \u0026#34;C\u0026#34; { EMSCRIPTEN_KEEPALIVE void biggerThan(int *elementList, int elementListLength, int target, int **result, int *size) { *result = (int *)malloc(sizeof(target) * elementListLength); std::cout \u0026lt;\u0026lt; *result \u0026lt;\u0026lt; std::endl; for (int i = 0; i \u0026lt; elementListLength; i++) { if (elementList[i] \u0026gt; target) { (*result)[*size] = elementList[i]; *size = *size + 1; } } std::cout \u0026lt;\u0026lt; \u0026#34;size mem position:\u0026#34; \u0026lt;\u0026lt; *size \u0026lt;\u0026lt; \u0026#34;\\nresult mem position:\u0026#34; \u0026lt;\u0026lt; result[0] \u0026lt;\u0026lt; std::endl; } } $ emcc build/bigger_than.cpp -O1 -s NO_EXIT_RUNTIME=1 -o bigger_than.js\n-O1 æ˜¯æŒ‡åè¦ compiler optimize è¼¸å‡ºçµæœï¼Œ-O1 æ˜¯åˆæ­¥å„ªåŒ–ï¼Œ-O2 / -O3 æ˜¯æ›´é€²éšè€—æ™‚çš„å„ªåŒ–ï¼Œä½†è¦å°å¿ƒå„ªåŒ–å¯èƒ½æœƒç§»é™¤éœ€è¦çš„åŠŸèƒ½\næ¥è‘—æ˜¯ index.html\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;ie=edge\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Document\u0026lt;/title\u0026gt; \u0026lt;script src=\u0026#34;./bigger_than.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; Module.onRuntimeInitialized = function() { const elementList = new Int32Array([1, 2, 3, 4, 5, 6]); const elementListBuffer = Module._malloc( elementList.length * elementList.BYTES_PER_ELEMENT ); Module.HEAP32.set(elementList, elementListBuffer \u0026gt;\u0026gt; 2); const target = 2; const result = new Int32Array(1); const resultBuffer = Module._malloc( result.length * result.BYTES_PER_ELEMENT ); Module.HEAP32.set(result, resultBuffer / result.BYTES_PER_ELEMENT); const size = new Int32Array(1); const sizeBuffer = Module._malloc(size.length * size.BYTES_PER_ELEMENT); Module.HEAP32.set(size, sizeBuffer / size.BYTES_PER_ELEMENT); console.log( `mem position:\\nsizeBuffer: ${sizeBuffer} resultBuffer: ${resultBuffer}` ); Module._biggerThan( elementListBuffer, elementList.length, target, resultBuffer, sizeBuffer ); const sizeInMem = Module.HEAP32[sizeBuffer / Int32Array.BYTES_PER_ELEMENT]; const resultRef = Module.HEAP32[resultBuffer / Int32Array.BYTES_PER_ELEMENT]; const resultInMem = new Int32Array(sizeInMem); console.log( resultBuffer, resultRef, Module.HEAP32[resultRef / Int32Array.BYTES_PER_ELEMENT + 1] ); for (let i = 0; i \u0026lt; sizeInMem; i++) { resultInMem[i] = Module.HEAP32[resultRef / Int32Array.BYTES_PER_ELEMENT + i]; } console.log(sizeInMem, resultInMem); Module._free(resultBuffer); Module._free(sizeBuffer); Module._free(elementListBuffer); }; \u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; è«‹æ‰“é–‹ Console \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ArrayBuffer \u0026amp; TypedArray åœ¨é–‹å§‹ä¹‹å‰ï¼Œå¿…é ˆå…ˆäº†è§£ JS å¦‚ä½•è™•ç† binary dataï¼Œåœ¨ JS ä¸­ binary data æ˜¯ä»¥ ArrayBuffer è¡¨ç¤ºï¼ŒArrayBuffer åªèƒ½è®€ä¸èƒ½åšå…¶ä»–çš„æ“ä½œï¼Œåªèƒ½é€é TypedArray èˆ‡ Dataviewè½‰æ›ï¼Œè€Œ Wasm ä¸­æœƒç”¨åˆ°çš„æ˜¯ TypedArray\nTypedArray æœ‰è¨±å¤šä¸åŒé•·åº¦çš„é¡å‹ï¼Œå¦‚ Int8Array / Int16Arrayï¼Œæ•¸å­—ä»£è¡¨æ¯å€‹ element çš„ bit é•·åº¦\n1 2 3 4 5 6 const buffer = new ArrayBuffer(2); const i8 = new Int8Array(buffer); i8[0] = 100; i8[1] = 20; const i16 = new Int16Array(buffer); console.log(i16[0]); // 5220ï¼Œå› ç‚ºæ˜¯ 0x14 0x64 å¦‚æœå…©å€‹ Type Array å¾åŒä¸€å€‹ ArrayBuffer ç”Ÿæˆï¼Œå‰‡å…©è€…æ”¹å‹•éƒ½æœƒäº’ç›¸å½±éŸ¿ï¼Œå¦‚æœé‡åˆ°ä¸åŒé¡å‹äº’è½‰ï¼Œå‰‡é«˜ä½åœ¨å¾Œä½ä½åœ¨å‰ï¼Œæ‰€ä»¥ i16[0] = i8[1] * 2^8 + i8[0] åœ¨ C/C++ä¸­ï¼Œæœ‰å¤šç¨®ä¸åŒé•·åº¦çš„å‹åˆ¥ï¼Œä¾‹å¦‚ char / int / float / double åŠ ä¸Š signed / unsigned ç­‰ï¼Œå°±æœƒä¸€ä¸€å°ç…§åˆ° JS çš„ Typed Array Pass Array by pointer ç•¶æˆ‘å€‘è¦è®“ C++ è®€å–é™£åˆ—ï¼Œæˆ‘å€‘ä¸èƒ½ç›´æ¥å‚³éé™£åˆ—ï¼Œè€Œæ˜¯å…ˆåœ¨ JS ä¸­æŠŠé™£åˆ—æ”¾é€² Memory \u0026ndash;\u0026gt; æ¥è‘—å‚³é Memory ä¸­çš„ä½å€ \u0026ndash;\u0026gt; å¾ Memory ä½å€è®€å–é™£åˆ—çš„å…ƒç´ \nåœ¨ Wasm ä¸­ï¼Œä¸€é–‹å§‹åˆå§‹åŒ–æœƒéœ€è¦ Memory Objectï¼Œè¡¨æ˜æ•´å€‹ Wasm èƒ½å¤ ä½¿ç”¨å¤šå¤§çš„è¨˜æ†¶é«”ï¼Œæ¥è‘—æŠŠè³‡æ–™æ”¾é€²è¨˜æ†¶é«”ç•¶ä¸­ï¼Œä¸¦å–å¾—å­˜æ”¾çš„ä½å€ï¼Œå°‡ä½å€å¾ JS å‚³éçµ¦ C++ï¼ŒC++ å»ç›¸å°æ‡‰çš„è¨˜æ†¶é«”ç©ºé–“å°‡å€¼å–å‡º\nEmscripten ç°¡åŒ–é€™å€‹éç¨‹ï¼Œæ”¹ç”¨ _malloc å»å–å¾—è¨˜æ†¶é«”ç©ºé–“ï¼Œä¸¦ç”±å°æ‡‰é¡åˆ¥å¤§å°çš„ HEAP å¡å…¥ç©ºé–“ï¼Œæ­¤æ™‚æœƒæ‹¿åˆ°è¨˜æ†¶é«”ä½å€\n1 2 3 4 5 const elementList = new Int32Array([1, 2, 3, 4, 5, 6]); const elementListBuffer = Module._malloc( elementList.length * elementList.BYTES_PER_ELEMENT ); Module.HEAP32.set(elementList, elementListBuffer \u0026gt;\u0026gt; 2); é€™æ®µè©±çš„ç¿»è­¯æ˜¯\nç”¢ç”Ÿ [1, 2, 3, 4, 5, 6] é™£åˆ—ï¼Œæ¯å€‹å…ƒç´ æ˜¯ 32 bits (4 bytes) å¤§ï¼Œå‰›å¥½å°æ‡‰ C++ çš„ int å¤§å° ç´¢å–è¨˜æ†¶é«”ç©ºé–“ï¼Œ_malloc éœ€æŒ‡å®šè¦å¤šå¤§çš„ bytes ç©ºé–“ï¼Œæ­¤ä¾‹éœ€è¦ 6 * 4 = 24 bytesï¼ŒelementListBuffer æ­¤æ™‚ä»£è¡¨é€™å¡Šè¨˜æ†¶é«”çš„èµ·å§‹ä½ç½®ï¼Œæ¯é–“éš” 4 å€‹ bytes å°±æ˜¯é™£åˆ—çš„ä¸‹ä¸€å€‹å…ƒç´  å› ç‚ºæ¯å€‹å…ƒç´ æ˜¯ 32 bitsï¼Œæ‰€ä»¥ç”¨ HEAP32 å¡è³‡æ–™ï¼Œé€™é‚Š elementListBuffer \u0026raquo; 2 æ˜¯å› ç‚ºæ¯å€‹å„²å­˜å–®ä½æ˜¯ 4 bytesï¼Œ \u0026raquo; 2 ä»£è¡¨ / 4\nå¯ä»¥æƒ³åƒæ˜¯å¤§å°æŠ½å±œï¼ŒJS ä¸­æ“ä½œæœ€å°å–®ä½æ˜¯å–®ä¸€å€‹ byteï¼Œå¦‚æœæ˜¯ Int8Array å‰‡æ˜¯ä¸€å€‹æŠ½å±œå°æ‡‰ä¸€å€‹å–®ä½ï¼Œä½†å¦‚æœæ˜¯ Int32Arrayï¼Œå°±æ˜¯ä¸€å€‹æŠ½å±œå°æ‡‰å››å€‹å–®ä½ï¼Œæ‰€ä»¥ç·¨è™Ÿ(ä½å€)ä¹Ÿæœƒæ¯”å°æŠ½å±œå°‘å››åˆ†ä¹‹ä¸€ åœ¨ C++ ç•¶ä¸­ï¼Œè¦è¼ªè©¢ elementList é™£åˆ—çš„å€¼ï¼Œå°±åªè¦\n1 2 3 4 for (int i = 0; i \u0026lt; elementListLength; i++) { elementList[i].... } Pointer åœ¨ Wasm ä¸­ï¼Œpointer æ˜¯ 32 bitsï¼Œæ‰€ä»¥é‡å° result / size éƒ½æ˜¯ç”¨ Int32Arrayï¼Œå³ä½¿ size æ˜¯æ•´æ•¸è€Œé\u0026quot;é™£åˆ—\u0026quot;ï¼Œä½†æ˜¯ä¸€æ¨£ç”¨ Int32Array å®£å‘Š\nå…ˆçœ‹ sizeï¼Œå®£å‘Šæ–¹å¼ç›¸åŒï¼Œæœ€å¾Œè¦å–å€¼æ™‚ï¼ŒåŒæ¨£æ˜¯å» Memory ä¸­çš„ä½ç½®æ‰¾ï¼Œè¨˜å¾—ä¸€æ¨£è¦åšä½å€åº§æ¨™çš„åˆ‡æ›\n1 2 3 4 5 6 const size = new Int32Array(1); const sizeBuffer = Module._malloc(size.length * size.BYTES_PER_ELEMENT); Module.HEAP32.set(size, sizeBuffer / size.BYTES_PER_ELEMENT); // å–å€¼ const sizeInMem = Module.HEAP32[sizeBuffer / Int32Array.BYTES_PER_ELEMENT]; Pointer of pointer å†ä¾†æ˜¯æ¯”è¼ƒç‰¹åˆ¥çš„ resultï¼Œé€™å…¶å¯¦æ˜¯ä¸€å€‹ pointer of pointerï¼Œå…ˆçœ‹ C++ å¯¦ä½œ\n1 *result = (int *)malloc(sizeof(target) * elementListLength); åœ¨ JS å±¤æˆ‘ä¸¦æ²’æœ‰å…ˆå»ºç«‹æ•´å€‹é™£åˆ—ï¼Œè€Œæ˜¯åˆ°äº† C++ æ‰ç”¨ malloc æ–¹å¼å»ç´¢å–é™£åˆ—çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œæ­¤æ™‚æ–°å¢åŠ çš„è¨˜æ†¶é«”ç©ºé–“ JS ä¸¦ä¸çŸ¥é“åœ¨å“ªè£¡ï¼Œæ‰€ä»¥æˆ‘å¿…é ˆæƒ³è¾¦æ³•å›å‚³ï¼Œæ­¤æ™‚å¯ä»¥é€é return valueï¼Œæˆ‘é¸æ“‡ç›´æ¥ä¿®æ”¹ result çš„å€¼ï¼Œæš«å­˜è¨˜æ†¶é«”ä½å€ï¼Œå†ç”¨é€™å€‹ä½å€å»æ‰¾çœŸæ­£çš„é™£åˆ—æ‰€åœ¨è™•\n1 2 3 4 5 6 const resultRef = Module.HEAP32[resultBuffer / Int32Array.BYTES_PER_ELEMENT]; const resultInMem = new Int32Array(sizeInMem); for (let i = 0; i \u0026lt; sizeInMem; i++) { resultInMem[i] = Module.HEAP32[resultRef / Int32Array.BYTES_PER_ELEMENT + i]; } å”¸èµ·ä¾†å¾ˆæ“¾å£ï¼Œä½†ä¹Ÿå°±æ˜¯å¤šä¸€æ¬¡çš„è¨˜æ†¶é«”ä½å€çš„è½‰æ›\nfree æœ€å¾Œåˆ¥å¿˜äº†è¦é‡‹æ”¾ç´¢å–çš„è¨˜æ†¶é«”ï¼Œé¿å… Memory leak\n1 Module._free(resultBuffer); ç¸½çµ WebAssembly è®“ç¶²é é–‹ç™¼çš„ã€Œéƒ¨åˆ†åŠŸèƒ½ã€å¯ä»¥å¤–åŒ…çµ¦çµ¦å…¶ä»–èªè¨€ï¼Œè®“ç¶²é é–‹ç™¼çš„ç–†åŸŸèˆ‡æŠ€è¡“æ›´åŠ çš„å½ˆæ€§èˆ‡å…¼å®¹ï¼Œç”šè‡³æœªä¾†å¯ä»¥æœ‰æ›´å¤šçš„è·¨èªè¨€å”ä½œçš„å¯èƒ½ï¼Œååˆ†ä»¤äººæœŸå¾…\né€™ä¸€ç¯‡æ•™å­¸ä»‹ç´¹äº† Emscripten å·¥å…·ï¼Œèˆ‡ C/C++ ç·¨è­¯å‡ºçš„ Wasm å¦‚ä½•è·Ÿ JS äº’å‹•ï¼ŒåŒ…å«åŸºæœ¬çš„æ•´æ•¸é‹ç®—ã€é™£åˆ—æ“ä½œã€Pointer èˆ‡è¨˜æ†¶é«”å­˜å–\nä¸‹ä¸€ç¯‡é è¨ˆä»‹ç´¹ä¸ä½¿ç”¨ Emscriptenï¼Œç›´æ¥ç”¨ Clang ç·¨è­¯ Wasmï¼Œé‚„åŸåˆ°æœ€ç°¡å–®åŸå§‹çš„ç‹€æ…‹å»èªè­˜ Wasm\n","date":"2020-01-01T05:21:40.869Z","permalink":"https://yuanchieh.page/posts/2020/2020-01-01-webassembly-%E6%95%99%E5%AD%B8-%E5%9F%BA%E6%9C%AC%E9%81%8B%E7%AE%97%E9%99%A3%E5%88%97%E8%99%95%E7%90%86%E8%88%87%E6%8C%87%E9%87%9D/","title":"Webassembly æ•™å­¸ - åŸºæœ¬é‹ç®—ã€é™£åˆ—è™•ç†èˆ‡æŒ‡é‡"},{"content":"\nåšå®¢ä¾†é€£çµ\nå‰è¨€ ã€ŠåŸå­ç¿’æ…£ã€‹æ˜¯æœ¬å¯¦è­‰çš„æ›¸ç±ï¼Œçœ‹å®Œè¦ºå¾—å¾ˆå—ç”¨ä¹Ÿæ„Ÿè§¸è‰¯å¤šï¼Œæ‰€ä»¥æœƒç”¨è¼ƒå¤šçš„è‡ªèº«ç¶“é©—å»æ‡‰è­‰èˆ‡å¯¦è¸æ›¸ä¸­å…§å®¹ï¼Œæ‰“å®Œå¿ƒå¾—å¾Œç™¼ç¾ç¯‡å¹…é æ¯”è‡ªå·±æƒ³åƒä¸­é•·ï¼Œä¹Ÿæ¯”è¼ƒå¤šå€‹äººçš„æ­·ç¨‹ (é˜²é›·å®£å‘Š)\né€™å…©å€‹æœˆç”Ÿæ´»æœ‰äº›æ”¹è®Šï¼Œè·‘å®Œäººç”Ÿç¬¬ä¸€å ´å…¨é¦¬é¦¬æ‹‰æ¾(ä¹Ÿæ˜¯äººç”Ÿç¬¬ä¸€å ´é¦¬æ‹‰æ¾)ã€éƒ¨è½æ ¼å¾ Medium ç§»å‡ºè‡³ Hugo è‡ªå·± hostã€ç§Ÿå±‹å¾æ°¸å’Œæ¬è‡³ä¸‰é‡ï¼Œé€™ä¸‰ä»¶äº‹æƒ…ç®—æ˜¯ä¸‹åŠå¹´çš„äººç”Ÿé‡Œç¨‹ç¢‘ï¼Œåœ¨ç”Ÿæ´»ç¿’æ…£èˆ‡ç’°å¢ƒè½‰è®Šçš„éç¨‹ï¼Œå¯Ÿè¦ºè‡ªå·±åœ¨å¿ƒç†ç‹€æ…‹ä¸Šæœ‰äº›å¾®å¦™çš„æ¨¡å¼ï¼Œå¾Œä¾†çœ‹åˆ°é€™æœ¬æ›¸ã€ŠåŸå­ç¿’æ…£ã€‹ï¼Œä¸ç¦æƒ³èªªã€Œå°å•Š! å°±æ˜¯é€™æ¨£ã€\nè‡ªå·±ä¸€ç›´éå¸¸è‘—è¿·æ–¼è¡Œç‚ºç§‘å­¸çš„æ›¸ç±ï¼Œæˆ‘èªç‚ºå¤©ç”Ÿçš„åŸºå› æœƒå½±éŸ¿åœ¨ä¸åŒé ˜åŸŸæŠ•æ³¨çš„æ•ˆç‡ä»¥åŠæˆå°±å¤©èŠ±æ¿ï¼Œä½†å¾€å¾€å¸¸äººå¾ˆé›£å»é”åˆ°åŸºå› çš„æ¥µé™ï¼Œæˆ‘å€‘æ‡‰è©²æ›´å°ˆæ³¨æ–¼æˆ‘å€‘æ‰€èƒ½æ§åˆ¶çš„ - æ‰“é€ æ­£ç¢ºçš„å­¸ç¿’æ…‹åº¦èˆ‡ç©æ¥µæ­£å‘çš„å¿ƒæ…‹\né€™äº›å¹´é™¸çºŒçœ‹äº†ã€Šå¤§è…¦å–œæ­¡é€™æ¨£å­¸ã€‹ã€ã€Šåˆ»æ„ç·´ç¿’ã€‹åˆ°ç¾åœ¨æ¨è–¦çš„é€™æœ¬ã€ŠåŸå­ç¿’æ…£ã€‹ï¼Œå¾æœ€åŸºå±¤å¤§è…¦çš„ç”Ÿç†é‹ä½œæ–¹å¼ã€å„ç¨®è¡Œç‚ºç§‘å­¸å¯¦é©—åˆ°å„é ˜åŸŸçš„é ‚å°–äººæ‰ç ”ç©¶ï¼Œè®“æˆ‘æ›´ç›¸ä¿¡æ”¹è®Šæ²’æœ‰æƒ³åƒä¸­çš„å›°é›£ï¼Œåªè¦æ‰¾å°å­¸ç¿’çš„æ–¹æ³•\nåœ¨è‡ªå·±ç”Ÿæ´»ä¸­ä¹Ÿè©¦è‘—è½å¯¦æ›¸ä¸­çš„ç†å¿µï¼Œå»èª¿æ•´è‡ªå·±çš„å­¸ç¿’æ–¹å¼èˆ‡å¿ƒæ…‹ï¼Œé›–ç„¶æˆå°±æ–¹é¢é ä¸è¶³ä»¥èªªå˜´ï¼Œä½†è·Ÿå…©å¹´å‰çš„è‡ªå·±ç›¸æ¯”ï¼Œå»ä¹Ÿæˆé•·è¨±å¤š\næœ€è¿‘é–‹å§‹å¯Ÿè¦ºåˆ°è‡ªå·±åœ¨æŸäº›æ–¹é¢æœ‰äº†é€€æ­¥ï¼Œä¾‹å¦‚éƒ¨è½æ ¼æ›´æ–°çš„é »ç‡ä¸‹é™éå¸¸å¤šï¼Œå¾ä»¥å‰ä¸€å€‹æœˆå››ç¯‡åˆ°ç¾åœ¨ä¸€å€‹æœˆä¸€ç¯‡ï¼Œä¸€æ–¹é¢æ˜¯æœ‰æ„å¸Œæœ›ä¸‹é™è‡ªå·±ç™¼æ–‡çš„é »ç‡ï¼Œå¸Œæœ›è®“è‡ªå·±æœ‰æ›´é•·çš„å­¸ç¿’é€±æœŸå»é‘½ç ”æ›´é›£çš„å•é¡Œè€Œéç‚ºäº†ç™¼æ–‡è€Œç™¼æ–‡ï¼Œä½†å»ä¹Ÿæ…¢æ…¢é–‹å§‹å‡ºç¾äº†æ€ æƒ°ï¼Œçœ‹åˆ°ã€ŠåŸå­ç¿’æ…£ã€‹æ‰é©šè¦ºâ€ç¿’æ…£â€œçš„æ¨£è²Œï¼Œç™¼æ–‡é »ç‡ä¸‹é™çš„åŸå› æ˜¯å¯ä»¥è¢«æ‹†è§£ï¼Œä¹Ÿæ‰æœ‰å¯ä»¥è¢«æ”¹å–„çš„å¯èƒ½\næˆ‘å€‘éƒ½åœ¨ä¸æ–·çš„è¨­å®šç›®æ¨™ï¼Œå°è‡³è®€æ›¸è¨ˆç•«å¤§è‡³è²¡å¯Œè‡ªç”±ï¼Œå¸Œæœ›ç”¨è‡ªåˆ¶åŠ›å»èªªæœ(å¼·è¿«)è‡ªå·±åŸ¹é¤Šå‡ºæ­£ç¢ºçš„ç¿’æ…£ï¼Œä½†å¾€å¾€å …æŒä¸äº†å¤šä¹…å°±æ”¾æ£„äº†ï¼Œé€™æ˜¯å› ç‚ºæˆ‘å€‘å¿½ç•¥æ¢è¨ã€Œç¿’æ…£ã€çš„æœ¬è³ªï¼Œæ‰€ä»¥æ‰ç„¡æ³•ã€Œé¤Šæˆå¥½ç¿’æ…£èˆ‡æœçµ•å£ç¿’æ…£ã€\nå¦‚æœä½ è¦ºå¾—ã€Œæœƒæ”¾æ£„çš„äººå°±æ˜¯è‡ªå·±ä¸å¤ åŠªåŠ›ã€è‡ªåˆ¶åŠ›ä¸å¤ å¥½ã€ï¼Œåˆæˆ–æ˜¯ã€Œå…ƒæ—¦åˆ¶å®šäº†æ–°å¹´æ–°è¨ˆç•«å»æ¯æ¬¡æ’ä¸åˆ°è¾²æ›†å¹´å°±æ”¾æ£„çš„äººã€é€™æœ¬æ›¸å¯ä»¥å¸¶çµ¦ä½ ä¸åŒçš„æƒ³æ³•ï¼Œä¸¦æä¾›éå¸¸å¯¦ç”¨çš„æŠ€å·§\næ ¸å¿ƒç†å¿µ è¤‡åˆ©çš„åŠ›é‡æ¯”åŸå­å½ˆé‚„å¯æ€• æ¯å¤©é€²æ­¥ 1%ç´¯ç©ä¸€å¹´ä¹‹å¾Œå°±æ˜¯ 37å€çš„æˆé•·ï¼Œå …æŒæ¯å€‹å¾®å°çš„æ”¹å–„ï¼Œç´¯ç©èµ·ä¾†å°±æ˜¯é©šäººçš„æˆé•·ï¼Œé€™ä¹Ÿæ˜¯\u0026quot;åŸå­ atomic\u0026quot; åœ¨æ›¸åçš„å«ç¾©ï¼Œåœ¨ 2003 å¹´è‹±åœ‹è‡ªè¡Œè»Šå”æœƒé›‡ç”¨æ–°çš„æ•™ç·´ æˆ´å¤«ãƒ»å¸ƒèŠçˆ¾æ–¯ç¦å¾·ï¼Œåœ¨æ­¤å‰è‹±åœ‹è‡ªè¡Œè»ŠéšŠåœ¨éå¾€ä¸€ç™¾å¤šå¹´åªæ˜¯ä¸€éš»å¹³åº¸çš„è»ŠéšŠï¼Œå¸ƒèŠçˆ¾æ–¯ç¦å¾·æ±ºå®šåœ¨æ¯å€‹é¢å‘éƒ½å˜—è©¦åšå‡ºå¾®å¹…æ”¹å–„ï¼Œä¾‹å¦‚é‡æ–°è¨­è¨ˆåå¢Šè®“é¸æ‰‹æ›´å¥½åšã€è¨­æ³•å¢åŠ è¼ªèƒæ‘©æ“¦åŠ›ã€èª¿æ•´æ¯ä½é¸æ‰‹çš„è¨“ç·´æ¨¡å¼ç­‰ï¼Œç´¯ç©é€™äº›æ­£é¢çš„æ”¹è®Šå¾Œï¼Œè‹±åœ‹è»ŠéšŠåœ¨çŸ­çŸ­æ•¸å¹´å…§æ–¬ç²äº†ä¹é …å¥§é‹ç´€éŒ„èˆ‡å¤šé …ä¸–ç•Œç´€éŒ„\nå·²ç¶“æœ‰å¾ˆå¤šæˆåŠŸå­¸éƒ½åœ¨æ¢è¨è¤‡åˆ©çš„å¨åŠ›ï¼Œä½†é€™é‚Šæœ‰å€‹é‡é»æ˜¯\nå¾®å°\nå°ˆæ³¨æ–¼ç³»çµ±è€Œéç›®æ¨™ å¾€å¾€æˆ‘å€‘ç¿’æ…£åˆ¶å®šå¾ˆå¤šçš„ç›®æ¨™ï¼Œä¾‹å¦‚èªªå…¨é¦¬è¦å››å°æ™‚å…§è·‘å®Œ(ç ´å››)ï¼Œè¨­ç«‹é€™æ¨£çš„ç›®æ¨™æœƒå¸¶ä¾†ä¸€ç¨®å¿ƒç†æš—ç¤ºã€Œå¦‚æœæˆ‘ç ´å››äº†æ‰æœƒå¿«æ¨‚ï¼Œåä¹‹å‰‡ä¸å¿«æ¨‚ã€çš„å–®é¸é¡Œï¼Œå¦‚æœæ²’æœ‰é”æˆç›®æ¨™å°±æœƒå¾ˆæ²®å–ªï¼Œåä¹‹å³ä½¿é”æˆç›®æ¨™äº†ï¼Œä¹Ÿå°±æœƒå› æ­¤åœä¸‹è…³æ­¥ï¼›\nä½œè€…æè­°æˆ‘å€‘æ‡‰è©²å°ˆæ³¨æ–¼ç³»çµ±è€Œéç›®æ¨™\nç›®æ¨™æ˜¯æƒ³è¦é”åˆ°çš„æˆæœã€ç³»çµ±æ˜¯è®“ä½ é”åˆ°æˆæœçš„éç¨‹ ä¾‹å¦‚èªªä½ æ˜¯æ•™ç·´ï¼Œä½ çš„ç›®æ¨™æ˜¯æ‹¿ä¸‹å† è»ï¼Œä½ çš„ç³»çµ±æ˜¯æ‹›è˜çƒå“¡ã€å¸¶éšŠè¨“ç·´ã€åˆ¶å®šæ¯”è³½ç­–ç•¥ç­‰\né€™ä¸æ˜¯èªªç›®æ¨™ä¸é‡è¦ï¼Œæœ‰äº†å…·é«”çš„ç›®æ¨™æ‰æœ‰å¾ŒçºŒæ‰“é€ ç³»çµ±çš„å¯èƒ½ï¼Œä½†åªèšç„¦æ–¼ç›®æ¨™è€Œéç³»çµ±å®¹æ˜“éæ–¼çŸ­è¦–ï¼Œè€Œç¿’æ…£å°±æ˜¯å°ˆæ³¨æ–¼æ‰“é€ è‰¯å¥½çš„ç³»çµ±ï¼Œæ¯æ—¥æŠ•å…¥æ­£ç¢ºçš„äº‹æƒ…ï¼Œç´¯ç©èµ·ä¾†å°±ä¸å¤ªéœ€è¦æ“”å¿ƒæˆæœæœƒå¤ªå·® (æ­¤å¿ƒæ³•æˆ–è¨±åƒ…é™æ–¼å€‹äººè€Œéå…¬å¸ä½¿ç”¨)\nä»¥æˆ‘è‡ªèº«çš„ç¶“é©—ä¸€é–‹å§‹é¦¬æ‹‰æ¾ç·´ç¿’ç¢ºå¯¦ä¹Ÿæƒ³è¦æ‹¼ç ´å››ï¼Œç¶²è·¯ä¸Šæ‰¾äº†èœå–®é–‹å§‹æŒ‰è¡¨æ“èª²ï¼Œæ¯æ—¥çš„ç·´ç¿’ç¢ºå¯¦å¸¶ä¾†é€²æ­¥ï¼Œè¶Šæ¥è¿‘æ¯”è³½è·‘å¾—ä¹Ÿè¶Šå¿«ï¼Œä½†å¿ƒæƒ…ä¹Ÿè¶Šä¾†è¶Šä½è½ï¼Œç”šè‡³ä¸å¤ªæƒ³è·‘æ­¥äº†ï¼›\nå› ç‚ºä¸€æ–¹é¢ç›®æ¨™è¨­å®šçš„æœ‰é»é«˜ï¼Œæ²’æœ‰åƒåŠ éé•·è·‘ç¬¬ä¸€æ¬¡å°±æƒ³è¦æŒ‘æˆ°å…¨é¦¬é æ¯”æƒ³åƒä¸­å›°é›£ï¼Œå¦ä¸€æ–¹é¢ä¸€ç›´èšç„¦æ–¼ç›®æ¨™èˆ‡ç¾å¯¦çš„è½å·®å¯¦åœ¨è®“äººæ²®å–ªï¼Œå°è‡´å¾Œé¢åè€Œå€¦æ€ æˆç¸¾åˆæ›´å·®å¼·äººæ„\nè‡ªæˆ‘èº«ä»½èªåŒ - ä½ æƒ³è¦æˆç‚ºæ€æ¨£çš„äºº ç•¶æˆ‘å€‘åšä¸€ä»¶äº‹ä¸€å€‹æ±ºå®šï¼Œå¯ä»¥å†å¾€å›è¿½æº¯ã€Œæˆ‘å€‘è¦å¦‚ä½•åšã€ä»¥åŠã€Œç‚ºä»€éº¼æˆ‘å€‘è¦é€™æ¨£åšã€ï¼Œä¹Ÿå°±æ˜¯ Golden Circle æ‰€æè¿°çš„ What \u0026lt;-- How \u0026lt;-- Why\nåœ¨è¡Œç‚ºä¸Šä¹Ÿæ˜¯ï¼Œæˆæœ \u0026lt;-- ç³»çµ±(æ”¹è®Šéç¨‹) \u0026lt;-- èº«ä»½èªåŒï¼Œç¿’æ…£çš„é¤Šæˆè®“æˆ‘å€‘è‡ªç„¶è€Œç„¶å»åšæŸä»¶äº‹ï¼ŒæŒçºŒçš„åšï¼Œåœ¨åŸ·è¡Œçš„éç¨‹ä¸æ–·çš„åŠ å¼·ã€Œæˆ‘æ˜¯èª°ã€çš„æ„è±¡ï¼Œé€™åˆå›æ‡‰åˆ°ç‚ºä»€éº¼å°ˆæ³¨æ–¼ç³»çµ±æœ‰æ™‚æ¯”å°ˆæ³¨æ–¼ç›®æ¨™æ›´é‡è¦ï¼Œå› ç‚ºé€™é—œä¹åˆ°æˆ‘å€‘æœ€å¾Œæœƒæˆç‚ºæ€æ¨£çš„äººï¼›\nè€Œæˆ‘å€‘è‡ªèº«çš„èº«ä»½èªåŒï¼Œä¹Ÿæ±ºå®šäº†æˆ‘å€‘æ±ºå®šå»æ‰“é€ å°æ‡‰çš„ç¿’æ…£ï¼Œå…©è€…æ˜¯äº’ç›¸å½±éŸ¿çš„\nä½œè€…èˆ‰ä¸€å€‹æœ‰è¶£çš„ä¾‹å­ï¼Œæœ‰å€‹ç™®å›å­æ±ºå®šè¦æˆ’è¸äº†ï¼Œç•¶ä¸€å€‹äººéé¦™è¸çµ¦ä»–æ™‚ï¼Œå¦‚æœä»–å›ç­”ã€Œå°ä¸èµ·æˆ‘ä¸æŠ½ç…™ã€è·Ÿã€Œå°ä¸èµ·æˆ‘æ­£åœ¨æˆ’è¸ã€ï¼Œå‰è€…æˆ’è¸çš„æˆåŠŸæ©Ÿç‡æœƒé«˜å‡ºè¨±å¤šï¼Œå› ç‚ºä»–çš„èº«ä»½èªåŒå·²ç¶“æ˜¯ä¸æŠ½è¸çš„äººï¼Œæ‰€ä»¥ä¸æŠ½è¸çš„èˆ‰å‹•å°ä»–ä¾†èªªæ˜¯å¾ˆæ­£å¸¸çš„å›æ‡‰(æˆ–è“„æ„å¡‘é€ è‡ªå·±)ï¼›\nè€Œå¾Œè€…é‚„æ˜¯ä»¥æŠ½è¸è€…è‡ªå±…ï¼Œæ¯æ¬¡ä¸æŠ½è¸éƒ½æ˜¯ç¨®æ™æ‰ï¼Œå®¹æ˜“åˆå—åˆ°èª˜æƒ‘è€Œè¸ç™®å¾©ç™¼\nç¿’æ…£å½¢æˆ ç¿’æ…£çš„é¤Šæˆä¸»è¦æ˜¯å› ç‚ºå¤§è…¦çš„å¿ƒåŠ›æ˜¯æœ‰é™çš„ï¼Œæ¯æ¬¡ä¹Ÿåªèƒ½å°ˆæ³¨åœ¨ä¸€ä»¶äº‹æƒ…ä¸Šï¼Œä½†ç”Ÿæ´»ä¸­å¤§å¤§å°å°æœ‰é€™éº¼å¤šçš„æ±ºå®šè¦åšï¼Œå°è‡³æ¯å¤©åƒä»€éº¼ç©¿ä»€éº¼åˆ°å·¥ä½œä¸Šçš„å•†æ¥­æ±ºç­–ï¼Œæ‰€ä»¥å¤§è…¦ç‚ºäº†ç¯€çœè³‡æºï¼Œæ¼¸æ¼¸çš„ä¸€äº›ç†Ÿæ‚‰çš„äº‹æƒ…å°±æœƒç”¨å›ºæœ‰çš„æ¨¡å¼è™•ç†ï¼Œé€™äº›æ¨¡å¼å°±æˆäº†æˆ‘å€‘çš„ç¿’æ…£\nä½†ç¿’æ…£çš„é¤Šæˆæ˜¯æœ‰ä¸€å€‹è¿´è·¯\næç¤º -\u0026gt; æ¸´æœ› -\u0026gt; å›æ‡‰ -\u0026gt; çå‹µ\nå¿ƒç†å­¸å®¶åšäº†ä¸€é …å¯¦é©—ï¼Œå°‡è²“æ”¾åœ¨è¿·é¾çš„è¨­è¨ˆä¸­ï¼Œè¨­è¨ˆå¤šå€‹å‡ºå£ï¼Œå¿…é ˆæ‹‰ä¸‹å‡ºå£æ—çš„æ‹‰æ¡¿é–€æ‰æœƒé–‹ï¼ŒæˆåŠŸæ‰¾åˆ°å‡ºå£å¾Œæœƒæœ‰é£Ÿç‰©çš„çå‹µï¼Œå¿ƒç†å­¸å®¶è§€å¯Ÿåˆ°è²“å’ªéš¨è‘—ç·´ç¿’çš„æ¬¡æ•¸ï¼Œé–‹å§‹çŸ¥é“è¦æ‹‰æ‹‰æ¡¿ï¼Œèªå¾—æ­£ç¢ºå‡ºå£çš„é€Ÿåº¦ä¹Ÿè¶Šä¾†è¶Šå¿«\næ‰€ä»¥å°‡ç¿’æ…£çš„è¿´è·¯æ‹†è§£å¥—ç”¨åœ¨äººçš„ç”Ÿæ´»ä¸Š\næç¤ºï¼šæ‰‹æ©ŸéŸ¿äº†æœ‰æ–°è¨Šæ¯\næ¸´æœ›ï¼šæƒ³è¦çŸ¥é“è¨Šæ¯å…§å®¹\nå›æ‡‰ï¼šæ‹¿èµ·æ‰‹æ©Ÿ\nçå‹µï¼šæ»¿è¶³äº†çŸ¥é“è¨Šæ¯çš„æ¸´æœ›\nç•¶æˆ‘å€‘è¦å»ºç«‹å¥½ç¿’æ…£è·Ÿæˆ’é™¤å£ç¿’æ…£ï¼Œå°±è¦å¾é€™å››å€‹æ­¥é©Ÿä¸‹æ‰‹\næç¤º äººé¡å—åˆ°ç’°å¢ƒçš„å½±éŸ¿é æ¯”æƒ³åƒä¸­çš„å¤§ï¼Œä¾‹å¦‚èªªå•†åº—è²¨æ¶ä¸Šï¼Œè·Ÿè¦–ç·šç­‰é«˜çš„å•†å“å€éŠ·å”®é¡æ›´å¥½ï¼›åˆæˆ–æ˜¯åœ¨é›¶é£Ÿå€é¡¯çœ¼è™•æ“ºæ”¾å¥åº·é£Ÿå“ï¼Œä¸åšå…¶ä»–æ”¹å–„äººå€‘ä¹Ÿæœƒå‚¾å‘æ‹¿å–å¥åº·é£Ÿå“\næˆ‘å€‘åœ¨åšæ±ºå®šæ™‚å¾ˆå¤šæ™‚å€™éƒ½è™•æ–¼æ·ºå±¤æ„è­˜çš„ç‹€æ…‹ï¼Œé€™æ™‚å€™ç’°å¢ƒçš„æç¤ºå°±æœƒè‡ªç„¶è€Œç„¶å¼•å°æˆ‘å€‘ï¼Œæ‰€ä»¥æƒ³è¦å»ºç«‹å¥½ç¿’æ…£å°±è®“ä»–æ›´é¡¯è€Œæ˜“è¦‹ / æˆ’é™¤å£ç¿’æ…£å°±é€£çœ‹éƒ½ä¸è¦çœ‹åˆ°\nåƒæ˜¯ç¾ä»£äººå®¹æ˜“å—åˆ° 3C ç”¢å“çš„èª˜æƒ‘ï¼Œå³ä½¿æƒ³è¦é›†ä¸­ç²¾ç¥é‚„æ˜¯æœƒä¸æ–·çš„è¢«å¹²æ“¾ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯é€£çœ‹åˆ°éƒ½ä¸è¦çœ‹åˆ°ï¼Œèˆ‰ä¾‹ä¾†èªªåœ¨æ›¸æˆ¿çœ‹æ›¸å°±æŠŠæ‰‹æ©Ÿéºç•™åœ¨å®¢å»³ï¼Œé€£çœ‹éƒ½çœ‹ä¸åˆ°ï¼› å¦‚æœèªªæƒ³è¦åŸ¹é¤Šé‹å‹•ç¿’æ…£ï¼Œå°±åœ¨æ¯å¤©ç¡è¦ºå‰æŠŠé‹å‹•æœæ•´ç†å¥½ï¼Œæ”¾åœ¨ä¸€èµ·åºŠå°±æœƒçœ‹è¦‹çš„åœ°æ–¹ï¼Œéš”å¤©é†’ä¾†ä¸‹æ„è­˜å°±æœƒè¢«æç¤ºã€Œè©²é‹å‹•äº†ã€\nç’°å¢ƒ ç’°å¢ƒå°äººä¹Ÿæœ‰æç¤ºçš„åŠŸèƒ½ï¼Œä¾‹å¦‚èªªç¿’æ…£åœ¨æ²™ç™¼ä¸Šæ»‘æ‰‹æ©Ÿåƒé›¶é£Ÿï¼Œåªè¦ä¸€ååˆ°æ²™ç™¼ä¸Šå°±æœƒä¸è‡ªè¦ºæƒ³è¦å»æ‹¿é›¶é£Ÿï¼Œä½œè€…å»ºè­°ä¸€å€‹åœ°æ–¹å°±åªåšä¸€ä»¶äº‹ï¼Œæ›¸æ¡Œå°±åªç”¨ä¾†è¾¦å…¬è·Ÿè®€æ›¸ã€æ²™ç™¼å°±ç”¨ä¾†çœ‹é›»è¦–æ”¾é¬†ç­‰ç­‰ï¼Œä¸€å€‹ä½å­ä¸€ä»¶äº‹ï¼Œç•¶ä½ åˆ°äº†é‚£å€‹ç’°å¢ƒï¼Œè‡ªç„¶å°±æœƒåšåŸæœ¬ç†Ÿæ‚‰çš„äº‹æƒ…\nå¦‚æœæƒ³è¦å¾¹åº•æ”¹é ­æ›é¢ï¼Œæ›å€‹æ–°çš„ç’°å¢ƒæˆ–è¨±æ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡\næ¸´æœ› ç•¶äººé¡æ”¶åˆ°çå‹µæ™‚ï¼Œè…¦ä¸­æœƒåˆ†æ³Œã€Œå¤šå·´èƒºã€ï¼Œä¹Ÿå°±æ˜¯è®“äººé¡æ„Ÿåˆ°æ”¾é¬†å¿«æ¨‚çš„æ¿€ç´ ï¼Œä½†æ ¹æ“šç ”ç©¶è­‰å¯¦ï¼Œç•¶æ¸´æœ›çå‹µæ™‚è€Œå°šæœªæ”¶åˆ°çå‹µæ™‚ï¼Œä¹Ÿæœƒåˆ†æ³Œå¤šå·´èƒºï¼Œè€Œæ¸´æœ›ä¹Ÿæœƒæ¯”å¯¦éš›æ”¶åˆ°çå‹µæ™‚çš„å¿«æ¨‚æ›´å¼·çƒˆ\nç¶‘ç¶çå‹µ æ‰€ä»¥æˆ‘å€‘å¯ä»¥é€éç¶‘ç¶çå‹µï¼Œå°‡ä¸€å€‹ä¸æ€éº¼æœ‰å¸å¼•åŠ›çš„å¥½ç¿’æ…£æ†ç¶åœ¨ä¸€å€‹å–œæ­¡çš„ç¿’æ…£ä¸Šï¼Œä¾‹å¦‚èªªæœ‰å€‹å·¥ç¨‹å¸«å¸Œæœ›åŸ¹é¤Šé¨è…³è¸è»Šçš„é‹å‹•ç¿’æ…£ï¼ŒåŒæ™‚ä»–ä¹Ÿå¾ˆæ„›çœ‹ Netflixï¼Œæ‰€ä»¥ä»–æ±ºå®šçµåˆå…©è€…ï¼Œç•¶è…³è¸è»Šæ©Ÿè¸©åˆ°ä¸€å®šæ™‚é€Ÿä¹‹å¾Œï¼ŒNetflix æ‰æœƒé–‹å§‹æ’­æ”¾ï¼Œåä¹‹å°±æœƒæš«åœæ’­æ”¾\nå…¬å¼æ˜¯\nåšå®Œ [ç›®å‰ç¿’æ…£å¾Œ]ï¼Œæˆ‘å°‡åŸ·è¡Œ [æˆ‘éœ€è¦çš„ç¿’æ…£]\nåšå®Œ [æˆ‘éœ€è¦çš„ç¿’æ…£] å¾Œï¼Œæˆ‘æœƒåŸ·è¡Œ [æˆ‘æƒ³è¦çš„ç¿’æ…£]\nä¾‹å¦‚åˆä¼‘å›ä¾†å¾Œæ‰“é›»æœƒçµ¦ä¸‰å€‹å®¢æˆ¶ï¼Œæ‰“å®Œå¾Œå°±å¯ä»¥æ»‘æ‰‹æ©Ÿé€™æ¨£ï¼Œå°‡éœ€è¦è¢«åŸ¹é¤Šçš„ç¿’æ…£å®‰æ’åœ¨ä¸­é–“\nå°‹æ±‚åœ˜é«” äººå€‘éƒ½æœ‰å°‹æ±‚ æ­¸å±¬ çš„å¿ƒç†éœ€æ±‚ï¼Œæˆ‘å€‘ç¸½å¸Œæœ›æ‰¾åˆ°ä¸€å€‹èªåŒè‡ªæˆ‘çš„åœ˜é«”ï¼ŒåŒæ™‚æˆ‘å€‘ç‚ºäº†åŠ å¼·èªåŒä¹Ÿä¸çŸ¥ä¸è¦ºé–‹å§‹æ¨¡ä»¿åœ˜é«”ä¸­å¤§å¤šæ•¸äººçš„ç¿’æ…£ï¼Œå¸Œæœ›è—‰æ­¤ç²å¾—æŒè²ï¼Œæœ‰ç ”ç©¶ç™¼ç¾å¦‚æœèº«é‚Šæœ‰æœ‹å‹è®Šèƒ–äº†ï¼Œé‚£è‡ªå·±è®Šèƒ–çš„æ©Ÿç‡æœƒæé«˜ 1/3\nåŒæ¨£çš„æˆ‘å€‘å¯ä»¥é€éåŠ å…¥åœ˜é«”ä¾†åŸ¹é¤Šè‡ªå·±æ–°çš„ç¿’æ…£ï¼Œä½†éœ€è¦æ³¨æ„\nä½ å¸Œæœ›çš„ç¿’æ…£æ˜¯å¸¸æ…‹ ä½ è·Ÿé€™å€‹åœ˜é«”æœ¬èº«æœ‰å…±é€šé» æœ‰å€‹å…±é€šé»æˆ‘è¦ºå¾—è »é‡è¦çš„ï¼Œå¦‚æœæ²’æœ‰ä¸€é–‹å§‹å¾ˆé›£èå…¥ï¼Œå¾ŒçºŒè¦åŸ¹é¤Šç¿’æ…£å°±æœƒå¾ˆå›°é›£\næˆ‘è‡ªå·±æ˜¯åŠ å…¥äº†é¾èˆŸéšŠä¹‹å¾Œï¼Œç™¼ç¾å¤§å®¶éƒ½åœ¨è·‘é¦¬æ‹‰æ¾ï¼Œä¸çŸ¥ä¸è¦ºä¹Ÿèˆˆèµ·åŸ¹é¤Šè·‘æ­¥èˆˆè¶£çš„å¿µé ­ï¼Œé›–ç„¶ä¸æ˜¯è·Ÿé¾èˆŸéšŠä¸€èµ·ç·´è·‘ï¼Œä½†åœ¨ç¤¾ç¾¤åª’é«”ä¸Šåˆ†äº«äº’ç›¸åŠ æ²¹ï¼Œä¹Ÿæ˜¯æˆ‘ä¸€ç›´å …æŒä¸‹å»çš„å‹•åŠ›ä¹‹ä¸€\nå›æ‡‰ ç•¶ä½ åœ¨æˆ¿é–“æ’é™¤é›œå¿µï¼ŒæŠŠå‰ç½®ä½œæ¥­éƒ½æº–å‚™å¥½äº†ï¼Œæœ€çµ‚é˜»æ“‹ä½ å®Œæˆä»»å‹™çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ\næŸå¤§å­¸çš„æ•™æˆåšäº†ä¸€é …å¯¦é©—ï¼Œæƒ³è¦æ¢è¨å…©ç¨®æ¨¡å¼å°æ–¼æ‹ç…§æŠ€å·§çš„ç£¨ç·´\nA çµ„æ˜¯é‡çµ„ï¼Œä»¥é‡çš„åšæˆç¸¾çš„è¨ˆç®—æ–¹å¼ï¼Œä¸Šäº¤ 100 å¼µæ‹¿åˆ° Aï¼Œ90 å¼µæ‹¿åˆ° B ç­‰ç­‰ï¼›\nB çµ„æ˜¯è³ªçµ„ï¼Œå­¸æœŸæœ«ä¸Šäº¤ä¸€å¼µè‡ªèªç‚ºæœ€å®Œç¾çš„ç…§ç‰‡ï¼Œä»¥é€™å¼µä½œå“è©•åˆ†\næœ€å¾Œå“è³ªæ¯”è¼ƒå¥½çš„æ˜¯å“ªä¸€çµ„å‘¢ï¼Ÿ\næ•™æˆç™¼ç¾æ˜¯ Açµ„ï¼Œå› ç‚ºè¢«é¼“å‹µå¤§é‡æ‹æ”ï¼Œä¸€é–‹å§‹å¯èƒ½æ‹å‡ºä¸å¥½çš„ç…§ç‰‡ï¼Œä½†ä¸æ–·çš„è©¦éŒ¯éç¨‹ä¹Ÿæå‡äº†æ‹ç…§æŠ€å·§ï¼›\nB çµ„æ²’æœ‰è¦å®šä¸èƒ½å¤§é‡æ‹æ”ï¼Œä½†å› ç‚ºè¢«æš—ç¤ºè¦ã€Œè¿½æ±‚å®Œç¾ã€ï¼Œæ‰€ä»¥åè€Œæœƒæƒ³å¤ªå¤šï¼Œåè€Œç·´ç¿’çš„æ¬¡æ•¸ä¸‹é™ï¼Œæœ€çµ‚æˆæœåè€Œä¸é€™éº¼å®Œç¾\nç•¶ç„¶ç·´ç¿’ä¹Ÿä¸æ˜¯ç„¡è…¦çš„ä¸€ç›´åè¦†åš(è©³è¦‹ã€Šåˆ»æ„ç·´ç¿’ã€‹ä¸€æ›¸)ï¼Œä½†æ˜¯äººå€‘æœƒæœ‰å€‹å¤©æ€§æ˜¯è¿½æ±‚å®Œç¾ï¼Œå¦å‰‡å¯§é¡˜ä¸åšçš„å¿ƒæ…‹ï¼Œæ›¸ä¸­å¼•ç”¨ä¼çˆ¾æ³°çš„ä¸€å¥è©± è‡³å–„è€…ï¼Œå–„ä¹‹æ•µï¼Œå¯§å¯é–‹å§‹è¡Œå‹•ï¼Œæ…¢æ…¢ä¿®æ­£ï¼Œä¹Ÿä¸è¦ä¸€ç›´åŸ‹è‘—é ­è‹¦å¹¹ï¼Œå°±å¦‚åŒç²¾å¯¦å‰µæ¥­ï¼Œä½ æ‡‰è©²å…ˆå¾æœ€å°å¯è¡Œæ€§ç”¢å“é–‹å§‹ï¼Œå¾å¸‚å ´å¾—åˆ°åé¥‹ï¼Œåä¹‹äººçš„ç¿’æ…£é¤Šæˆä¹Ÿæ˜¯\nå…©åˆ†é˜æ³•å‰‡ ä½œè€…æå‡º å…©åˆ†é˜æ³•å‰‡ï¼Œä¸è¦æ€•ä¸å®Œç¾ï¼Œå‡è¨­ä½ æƒ³åŸ¹é¤Šåšä¼ç«‹æŒºèº«çš„ç¿’æ…£ï¼Œä¸éœ€è¦ä¸€é–‹å§‹å°±å¾ 3,50 ä¸‹é–‹å§‹ï¼Œå¾ 5 ä¸‹é–‹å§‹å°±å¥½ï¼Œç”šè‡³ 2 ä¸‹ä¹Ÿæ²’æœ‰é—œä¿‚ï¼Œé‡é»æ˜¯ é–‹å§‹è¡Œå‹•ï¼›\næƒ³è¦åŸ¹é¤Šè·‘æ­¥ä¸å¦‚å¾æé†’è‡ªå·±è¦åˆ°æˆ¶å¤–èµ°èµ°ï¼Œç­‰ç¿’æ…£å¾Œå†æ…¢æ…¢å¢åŠ å¼·åº¦ï¼Œä¸è¦å¤ªå¥½é«˜é¨–é ï¼Œå¾å…©åˆ†é˜é–‹å§‹å°±å¥½\nèª¿æ•´åŸ·è¡Œç¿’æ…£çš„æˆæœ¬ å¦‚æœå¸Œæœ›å»ºç«‹ç¿’æ…£ï¼Œæˆ‘å€‘æ‡‰è©²è¦é™ä½åŸ·è¡Œçš„æˆæœ¬ï¼Œä¸Šé¢çš„å…©åˆ†é˜æ³•å‰‡æ˜¯ç‚ºäº†é™ä½å¿ƒç†æˆæœ¬ï¼Œåœ¨åŸ·è¡Œé¢ä¸Šå¯ä»¥å°‡æ±è¥¿æ­¸ä½å¥½ï¼Œç•¶è¦åŸ·è¡Œæ™‚å°±å¯ä»¥ç«‹é¦¬è¡Œå‹•ä¸ç”¨åœ¨æ‰¾æ±æ‰¾è¥¿ï¼›\nåˆæˆ–æ˜¯åéä¾†ï¼Œè®“å£ç¿’æ…£çš„åŸ·è¡Œæˆæœ¬å¾ˆé«˜ï¼Œä½œè€…åˆ†äº«åˆ°ç‚ºäº†æˆ’é™¤ä¸æ–·æ»‘ç¤¾äº¤åª’é«”ï¼Œå¥¹èˆ‡å¦ä¸€å€‹å¥½å‹äº’ç›¸æ”¹å°æ–¹å¯†ç¢¼ï¼Œç­‰åˆ°é€±äº”æ‰å¯ä»¥è·Ÿå°æ–¹è¦æ–°çš„å¯†ç¢¼ç™»å…¥ï¼Œä»–ç™¼ç¾åˆ°é€™æ¨£çš„æ”¹è®Šå°±å¤§å¤§é™ä½ä»–å°ç¤¾äº¤åª’é«”çš„ä¾è³´\nçå‹µ æœ‰äº›æ™‚å€™å¥½ç¿’æ…£çš„çå‹µæ˜¯æœ‰å»¶é²æ€§ï¼Œä¾‹å¦‚èªªå¥èº«è¦éå€‹æ•¸é€±æ‰æœ‰æˆæ•ˆï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¥½ç¿’æ…£ä¸å®¹æ˜“æŒçºŒçš„é—œä¿‚ï¼Œä½†æˆ‘å€‘é‚„æ˜¯èƒ½é€éä¸åŒçš„æ–¹å¼å»æ”¹è®Š\nè¿´ç´‹é‡ç­–ç•¥ æœ‰å€‹æˆåŠŸçš„æ¥­å‹™åˆ†äº«åˆ°ï¼Œæ¯ç•¶ä»–æ‰“å®Œä¸€é€šé›»è©±çµ¦å®¢æˆ¶ï¼Œå°±æŠŠè¿´ç´‹é‡å¾ A æ¡¶æ¬ç§»åˆ° B æ¡¶ï¼Œé€éæŠ•å…¥è¿´ç´‹é‡ï¼Œä»–ä¸çŸ¥é“è¦æ‰“å¤šå°‘é€šé›»è©±æ‰æœƒæˆäº¤ä¸€é€šï¼Œä½†é€éæŠ•æ“²è¿´ç´‹é‡ï¼Œä»–çŸ¥é“è‡ªå·±æ¯æ¬¡çš„é›»è©±éƒ½æ˜¯æœ‰æˆæœçš„ï¼Œæ‰€ä»¥å°‡ç›®æ¨™å¯è¦–åŒ–æ˜¯å€‹å¾ˆå¥½è¿½è¹¤çš„æ–¹å¼\nå°æ™‚å€™æ¯æ¬¡æ‹¿åˆ°å¥½å¯¶å¯¶æ¨™ç« ä¹Ÿæ˜¯ç›¸åŒçš„é“ç†ï¼Œç¾åœ¨æœ‰è¨±å¤šçš„ App å¯ä»¥å¹«å¿™è¿½è¹¤ï¼Œä¾‹å¦‚è·‘æ­¥ä¹Ÿæœ‰è·‘æ­¥çš„é‡Œç¨‹ï¼Œæ¯æ¬¡çœ‹åˆ°è‡ªå·±çš„ç´¯ç©ï¼Œçœ‹åˆ°è‡ªå·±çš„æˆç¸¾ç©©å®šé€²æ­¥ï¼Œç¢ºå¯¦æœ‰å¾ˆå¤§çš„æ»¿è¶³\nå¦‚æœå¯ä»¥çš„è©±è®“ç›®æ¨™è¿½è¹¤å¾ˆé¡¯çœ¼ï¼Œé€™å°±æœƒå†è½‰è®Šæˆä¸‹ä¸€å€‹è¿´åœˆçš„æç¤º\nå•è²¬å¤¥ä¼´ ä¹Ÿå¯ä»¥æ‰¾å€‹å¤¥ä¼´ï¼Œå‘Šè¨´å°æ–¹è‡ªå·±çš„ç›®æ¨™å¾Œï¼Œç”±é›™æ–¹äº’ç›¸æé†’èˆ‡é¼“å‹µï¼Œé€éäººéš›é—œä¿‚çµ¦è‡ªå·±å£“åŠ›èˆ‡çè³ï¼Œæ˜¯å€‹ä¸éŒ¯çš„ä½œæ³•\nçµèª 1 2 3 4 è®“æç¤ºé¡¯è€Œæ˜“è¦‹ è®“ç¿’æ…£è®Šå¾—æœ‰å¸å¼•åŠ› è®“è¡Œå‹•è¼•è€Œæ˜“èˆ‰ è®“çè³ä»¤äººæ»¿è¶³ æœ€çµ‚äººç”Ÿå°±æ˜¯ç”±ä¸€é€£ä¸²å¾®å°çš„è¡Œç‚ºæ‰€ä¸²é€£ï¼Œå¦‚æœæˆ‘å€‘å¯ä»¥æ›´æœ‰æ„è­˜åœ°å»æ‰“é€ è‡ªå·±çš„æ½›æ„è­˜ï¼Œé‚£æˆ–è¨±é€™æ¨£èƒ½æ›´è²¼è¿‘æˆ‘å€‘æƒ³è¦çš„ç”Ÿæ´»ï¼Œçœ‹å®Œã€ŠåŸå­ç¿’æ…£ã€‹è®“æˆ‘é‡æ–°æ€è€ƒè‡ªå·±çš„ç”Ÿæ´»ï¼Œå‰›å¥½é©é€¢æ¬å®¶ï¼Œä¹Ÿæ˜¯å¾¹åº•æ‰“é€ æ–°ç¿’æ…£çš„é–‹ç«¯\n","date":"2019-12-14T05:21:40.869Z","permalink":"https://yuanchieh.page/posts/2019/2019-12-14-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97-%E5%8E%9F%E5%AD%90%E7%BF%92%E6%85%A3%E7%B4%B0%E5%BE%AE%E6%94%B9%E8%AE%8A%E5%B8%B6%E4%BE%86%E5%B7%A8%E5%A4%A7%E6%88%90%E5%B0%B1%E7%9A%84%E5%AF%A6%E8%AD%89%E6%B3%95%E5%89%87/","title":"[é–±è®€å¿ƒå¾—] ã€ŠåŸå­ç¿’æ…£ã€‹ç´°å¾®æ”¹è®Šå¸¶ä¾†å·¨å¤§æˆå°±çš„å¯¦è­‰æ³•å‰‡"},{"content":"ä»‹ç´¹ ä¸Šä¸€ç¯‡å®Œæˆäº†ç”¨ Terraform å¯¦ä½œå–®ä¸€å€åŸŸå®šæ™‚åŸ·è¡Œ Lambda çš„éƒ¨ç½²ï¼Œé€™ä¸€ç¯‡å°‡è½‰æˆ moduleï¼Œä¸¦ä½¿ç”¨ for loop / if conditionï¼Œä¸€æ¬¡éƒ¨ç½²åˆ°å¤šå€‹å€åŸŸï¼ŒåŒæ™‚æ¢ç´¢ Terraform æœ¬æ¬¡æ•™å­¸æ²’æœ‰ç”¨åˆ°å»ä¹Ÿå€¼å¾—ç•™æ„çš„åŠŸèƒ½\nModule - æ¨¡çµ„åŒ– å…ˆå‰æåˆ°ï¼Œåªè¦åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹ï¼Œä»»ä½•çš„ *.tf æª”æ¡ˆéƒ½æ˜¯ root moduleï¼Œåœ¨ $terraform apply æ™‚éƒ½æœƒè¢«åŸ·è¡Œï¼›\nå¦‚æœè¦ç¨ç«‹å‡ºå€‹åˆ¥çš„æ¨¡çµ„ï¼Œå¯ä»¥æ”¾åœ¨ä¸åŒå°ˆæ¡ˆä¸‹ï¼Œé€éæ”¾åœ¨ githubã€s3 ç­‰ remote æ–¹å¼è¼‰å…¥ï¼Œåˆæˆ–æ˜¯å–®ç´”ç¨ç«‹å‡ºä¸€å€‹è³‡æ–™å¤¾æ”¾ç½®ï¼Œç”¨è·¯å¾‘çš„æ–¹å¼è¼‰å…¥ï¼Œå…ˆé‡æ•´åŸæœ¬çš„å°ˆæ¡ˆè³‡æ–™å¤¾æ¶æ§‹\n1 2 3 4 5 6 7 8 9 10 11 12 --- |--- main.tf // é€²å…¥é» |--- input.tf // å®šç¾©åƒæ•¸ |--- output.tf // å®šç¾©è¼¸å‡º |--- modules // å­˜æ”¾æ‰€æœ‰çš„è·¯å¾‘ |--- lambda-api-test |--- main.tf // module çš„é€²å…¥é» |--- input.tf // module input |--- lambda-function.zip ... ä¸Šä¸€ç¯‡æ‰€æœ‰çš„è³‡æ–™ |--- global |--- global.tf é‡æ–°æ€è€ƒä¹‹å¾Œè¦éƒ¨ç½²çš„æ¶æ§‹ï¼Œglobal ç”¨ä¾†å­˜æ”¾å…¨åŸŸçš„è³‡æºï¼Œä¾‹å¦‚èªª IAM Role / DNS ç­‰è³‡æºï¼Œé€™éƒ¨åˆ†æœƒéœ€è¦å…ˆè¢«å‰µç«‹ï¼Œæ–¹ä¾¿å¾ŒçºŒçš„è³‡æºç¶å®šï¼›\næ¥è‘—æŠŠå„å€åŸŸç›¸åŒçš„æ¶æ§‹åŒ…æˆ module æ”¾ç½®åœ¨ modules åº•ä¸‹ï¼Œç¨‹å¼ç¢¼ç§»é™¤ IAM è³‡æºï¼Œå…¶é¤˜å¤§å¤šé›·åŒï¼Œåªæ˜¯è¦æ³¨æ„å¦‚æœæœ‰ç”¨åˆ° file ç›¸é—œçš„åƒæ•¸ï¼Œè¦æ”¹è®Šè·¯å¾‘ä½ç½®ç‚º ${path.module}ï¼Œå¦å‰‡æœƒæ‰¾ä¸åˆ°è³‡æºï¼›\n1 2 3 4 5 6 7 resource \u0026#34;aws_lambda_layer_version\u0026#34; \u0026#34;lambda-layer_fetch\u0026#34; { filename = \u0026#34;${path.module}/lambda_layer_payload.zip\u0026#34; layer_name = \u0026#34;lambda_layer_name\u0026#34; source_code_hash = \u0026#34;${filebase64sha256(\u0026#34;${path.module}/lambda_layer_payload.zip\u0026#34;)}\u0026#34; compatible_runtimes = [\u0026#34;nodejs10.x\u0026#34;] } å¦‚æœè¦å¼•ç”¨ moduleï¼Œä¹Ÿå°±æ˜¯ ./main.tf çš„å…§å®¹ç‚º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 locals { region = \u0026#34;us-east-1\u0026#34; } provider \u0026#34;aws\u0026#34; { profile = \u0026#34;default\u0026#34; region = \u0026#34;${locals.region}\u0026#34; } module \u0026#34;lambda-api-test_us-west-2\u0026#34; { source = \u0026#34;./modules/lambda-api-test\u0026#34; # depends_on = [\u0026#34;aws_iam_role.iam_for_lambda\u0026#34;] region = \u0026#34;${local.region}\u0026#34; lambda_variables-SLACK_URL = \u0026#34;slack url\u0026#34; iam_role_name = var.lambda_role_name } å®£å‘Š module ä¸¦é€éç›¸å°è·¯å¾‘æŒ‡å®š sourceï¼Œå…¶é¤˜çš„åƒæ•¸å°æ‡‰ module çš„ inputï¼›\nè¦æ³¨æ„ç›®å‰ v0.12 module ä¸æ”¯æ´ depends_onï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ IAM Role å‰µç«‹è¦ç¨ç«‹åˆ° global.tf å…ˆåŸ·è¡Œï¼Œä¸ç„¶ç›®å‰ç„¡æ³•å…ˆå»ºç«‹ IAM Role å†å»ºç«‹ module\nlocals locals ç”¨ä¾†å®£å‘Šå€åŸŸè®Šæ•¸ï¼Œå°±åƒæ˜¯å¯«ç¨‹å¼ä¸­åƒ…ç”¨æ–¼é™å®šç¯„åœå…§çš„è®Šæ•¸ï¼Œå¾ŒçºŒé€é local.{var} å–ç”¨\ndata source å¦‚æœæœ‰éœ€è¦è·¨æª”æ¡ˆè·¯å¾‘å­˜å–è³‡æºï¼Œåˆæˆ–æ˜¯è®€å–æŸäº›è³‡æ–™ä¾‹å¦‚ AWS æ‰€æœ‰çš„å¯éƒ¨ç½²å€åŸŸåˆ—è¡¨ï¼Œåˆæˆ–æ˜¯åŸ·è¡ŒæŸäº›æŒ‡ä»¤å¦‚å‘¼å« lambdaï¼Œå¯ä»¥å®£å‘Š data sourceï¼›\ndata source è·Ÿ resource æœ€å¤§å·®åˆ¥æ˜¯ data source æ˜¯å”¯è®€ï¼Œä¸¦å¤§å¤šæ•¸åŸ·è¡Œæ–¼ apply éšæ®µä¹‹å‰ï¼Œå¾ŒçºŒçš„è³‡æºå»ºç«‹éƒ½å¯ä»¥ä½¿ç”¨ï¼›\nè€Œ resource å‰‡æ˜¯æœƒè¢« $terraform æŒ‡ä»¤å½±éŸ¿è€Œå¢åŠ ã€åˆªé™¤ã€ä¿®æ”¹è³‡æºã€‚\nçœ‹åˆ° data source è®“æˆ‘ååˆ†çš„èˆˆå¥®! å› ç‚ºé€™ä»£è¡¨æˆ‘å€‘æœ‰æ›´å¥½çš„æ–¹å¼èˆ‡æ—¢æœ‰çš„æ¶æ§‹å…±å­˜\nå¦‚æœä½ æ“”å¿ƒå°å…¥ Terraform æœƒä¸å°å¿ƒç ´å£ç¾æœ‰çš„æ¶æ§‹ï¼Œå¯ä»¥é€é data source å»æ“·å–é‡è¦çš„è³‡æ–™åŒæ™‚ä¿è­‰ Terraform ä¸æœƒä¿®æ”¹æˆ–æ˜¯åˆªé™¤ï¼Œä¾‹å¦‚èªª DNSè¨­å®šã€IAM Role ç­‰ç­‰\ndata source å€‹åˆ¥å–ç”¨æ–¹å¼å¯ä»¥æŸ¥æ–‡ä»¶ï¼Œæœ€åŸºæœ¬å°±æ˜¯ç”¨ name ç•¶ä½œæœå°‹ä¾æ“šï¼Œä¾‹å¦‚èªªæˆ‘åœ¨ ./module/lambda-api-test/main.tf å¸Œæœ›å­˜å– ./global/global.tf æˆ–æ˜¯ä¸å­˜åœ¨æ–¼ terraform å°ˆæ¡ˆä¸‹çš„ IAM Roleï¼Œå¯ä»¥ç”¨\n1 2 3 4 5 6 7 8 9 10 11 # data \u0026#34;è³‡æºé¡å‹\u0026#34; \u0026#34;è³‡æºåç¨±\u0026#34; # { æœå°‹æ¢ä»¶èˆ‡åƒæ•¸ } data \u0026#34;aws_iam_role\u0026#34; \u0026#34;iam_for_lambda\u0026#34;{ name = \u0026#34;iam_role_name\u0026#34; } # å­˜å–ç¤ºç¯„ resource \u0026#34;aws_lambda_function\u0026#34; \u0026#34;lambda_main\u0026#34; { role = \u0026#34;${data.aws_iam_role.iam_for_lambda.arn}\u0026#34; .... } data source ä¹Ÿæ˜¯ç”¨ä¾†è·¨ module é–“å‚³éè³‡æºçš„æ–¹æ³•ï¼Œä½†è¦è‡ªå·±é‡æ¸… module çš„å…ˆå¾Œé †åº\næ¢ä»¶å¼ - for / if HCL æ˜¯å€‹å®£å‘Šå¼èªè¨€ï¼Œè®“æˆ‘å€‘å¯ä»¥ç”¨ high level æ–¹å¼å®£å‘Šæˆ‘å€‘çš„æ„åœ–ï¼Œè‡³æ–¼å¦‚ä½•å¯¦ä½œå°±ä¸ç”¨æˆ‘å€‘æ“å¿ƒï¼›\nä½†è·Ÿç¨‹åºå¼èªè¨€æ¯”èµ·ä¾†ï¼Œæ¢ä»¶åˆ¤æ–·èˆ‡è¿´åœˆç­‰é‚è¼¯åˆ¤æ–·èˆŠæ²’æœ‰å¦‚æ­¤çš„æ–¹ä¾¿ï¼Œä¸é HCL é‚„æ˜¯æ”¯æ´åŸºæœ¬çš„æ¢ä»¶åˆ¤æ–·èªæ³•ï¼Œé›–ç„¶æ²’é€™éº¼ç›´è§€ï¼Œä½†é‚„æ˜¯æœ‰è¾¦æ³•æ»¿è¶³å¤§å¤šæ•¸çš„æ‡‰ç”¨å ´æ™¯\ncount count æ˜¯æœ€æ—©æ”¯æ´çš„èªæ³•ï¼Œä¸»è¦æ˜¯é‡è¤‡å‰µå»ºè³‡æºï¼Œé€é count.index å–å¾—ç•¶ä¸‹ interation çš„ index\n1 2 3 4 resource \u0026#34;aws_iam_user\u0026#34; \u0026#34;example\u0026#34; { count = 3 name = \u0026#34;neo.${count.index}\u0026#34; } ä¹Ÿå¯ä»¥æ­é… listï¼Œå‹•æ…‹èª¿æ•´è®Šæ•¸\n1 2 3 4 5 6 7 8 9 variable \u0026#34;user_names\u0026#34; { description = \u0026#34;Create IAM users with these names\u0026#34; type = list(string) default = [\u0026#34;neo\u0026#34;, \u0026#34;trinity\u0026#34;, \u0026#34;morpheus\u0026#34;] } resource \u0026#34;aws_iam_user\u0026#34; \u0026#34;example\u0026#34; { count = length(var.user_names) name = var.user_names[count.index] } å¦‚æœæƒ³è¦ access è³‡æºçš„è¼¸å‡ºï¼Œå¯ä»¥é€é [index/*] æ–¹å¼å–å¾—\n1 2 3 4 output \u0026#34;all_arns\u0026#34; { value = aws_iam_user.example[*].arn description = \u0026#34;The ARNs for all users\u0026#34; } count æ­é…ä¸‰å…ƒé‹ç®—å¼ï¼Œå°±è®Šæˆäº†ç¾æˆçš„ if/else\n1 2 3 4 resource \u0026#34;aws_iam_user_policy_attachment\u0026#34; \u0026#34;neo_cloudwatch_full\u0026#34; { count = var.give_neo_cloudwatch_full_access ? 1 : 0 .... } count é™åˆ¶ ä¸èƒ½ç”¨æ–¼ inline block\næœ‰äº› resource æœ‰ inline blockï¼Œä¾‹å¦‚ auto scaling group å¯ä»¥æŒ‡å®š tagï¼Œæ­¤æ™‚çš„ tag ä¸èƒ½ä½¿ç”¨ count 1 2 3 4 5 6 resource \u0026#34;aws_autoscaling_group\u0026#34; \u0026#34;example\u0026#34; { .... tag { count = 3 (ç„¡æ³•ä½¿ç”¨) } } æ¡ç”¨ list æ™‚çš„å…ƒç´ å¢æ¸›\nå¦‚æœå‰µå»ºè³‡æºæ™‚æ˜¯ç”¨ list æ­é… countï¼Œå¿…é ˆæ³¨æ„ Terraform åœ¨å¾ŒçºŒæ›´æ–°è³‡æºæ™‚æ˜¯èªå®š list index è€Œéå…ƒç´ æœ¬èº« ä¾‹å¦‚åŸæœ¬æ˜¯ [\u0026rsquo;ele1\u0026rsquo;, \u0026rsquo;ele2\u0026rsquo;, \u0026rsquo;ele3\u0026rsquo;]ï¼Œæ­¤æ™‚å¸Œæœ›åˆªé™¤ ele2ï¼Œè®Šæˆ [\u0026rsquo;ele1\u0026rsquo;, \u0026rsquo;ele3\u0026rsquo;]\nä½†æ˜¯ Terraform æœƒè§£è®€æˆ åˆªé™¤ ele3ï¼Œä¸¦æ›´æ–° ele2 æˆ ele3ï¼Œé€™ä¸€é»å¿…é ˆç‰¹åˆ¥æ³¨æ„ï¼Œä¸ç„¶å°±è¦ä½¿ç”¨å…¶ä»–çš„è¿´åœˆæ–¹å¼\nfor_each for_each æ˜¯åœ¨ 0.12 åŠ å…¥ï¼Œå¯ä»¥è¼ªè©¢æŒ‡å®šçš„ collectionï¼Œä¸¦æ”¯æ´ inline block!\nå¦‚æœ collection ç‚ºç©ºå€¼å‰‡æ•ˆæœç­‰åŒæ–¼ count = 0\nå¦‚æœå¤šå€‹ resource æœ¬èº«è¿‘ä¹ä¸€è‡´å¯ä»¥ç”¨ countï¼Œä½†å¤§å¤šæ•¸æƒ…æ³è«‹ç”¨ for_each\né…åˆ dynamic å°±å¯ä»¥ç”¨æ–¼ inline blockï¼Œä»¥ä¸‹æ˜¯å»ºç«‹ security group æ™‚æŒ‡å®š ingress å¤šçµ„ port\n1 2 3 4 5 6 7 8 9 10 11 12 resource \u0026#34;aws_security_group\u0026#34; \u0026#34;example\u0026#34; { name = \u0026#34;example\u0026#34; dynamic \u0026#34;ingress\u0026#34; { for_each = var.service_ports content { from_port = ingress.value to_port = ingress.value protocol = \u0026#34;tcp\u0026#34; } } } for_each ä¹Ÿå¯ä»¥æ­é… map ä½¿ç”¨\n1 2 3 4 5 6 7 8 resource \u0026#34;azurerm_resource_group\u0026#34; \u0026#34;rg\u0026#34; { for_each = { a_group = \u0026#34;eastus\u0026#34; another_group = \u0026#34;westus2\u0026#34; } name = each.key location = each.value } é€é each åŠ ä¸Š key, value å–å¾—éœ€è¦çš„å€¼\nWarning! ç›®å‰ Terraform é‚„æœ‰å¹¾å€‹ä¸æ”¯æ´çš„åŠŸèƒ½ï¼Œä¾‹å¦‚èªª provider ä¸æ”¯æ´è®Šæ•¸ã€module ä¸æ”¯æ´ depends_onã€module ä¸æ”¯æ´ for loop\né€™ä¸‰å€‹åŠŸèƒ½ä¸æ”¯æ´è®“ multiple region éƒ¨ç½²æ™‚ç›¸ç•¶ä¸æ–¹ä¾¿ï¼Œmodule æ”¯æ´ for loop æœ‰åœ¨æ¥ä¸‹ä¾†çš„ Terraform roadmap ä¸­ï¼Œä½†é‚„ä¸ç¢ºå®šä½•æ™‚æœƒæ”¯æ´\nå¦åœ¨ Refactor æ™‚å‹™å¿…æ³¨æ„ï¼Œä¾‹å¦‚èªª resource name æ›´æ–°ï¼ŒTerraform å¤§å¤šæ•¸æœƒåˆªé™¤èˆŠè³‡æ–™ä¸¦é‡å»ºæ–°è³‡æ–™ï¼Œå³ä½¿æ”¹å€‹åç¨±è€Œå·²ï¼Œæ‰€ä»¥å‹™å¿…è¦ä»”ç´°çœ‹ $ terraform plan çš„çµæœï¼Œé¿å…é€ æˆä¸å¿…è¦çš„ downtime\næˆ–æ˜¯æœ‰å¹¾å€‹æ–¹å¼å¯ä»¥é¿å… downtime\nä¿®æ”¹ lifecycle ç‚º create_before_destroy æ¯å€‹ resource å¯ä»¥æŒ‡å®š lifecycleï¼Œcreate_before_destroy æœƒå…ˆå‰µå»ºæ–°è³‡æºå†åˆªé™¤èˆŠè³‡æºï¼Œé¿å… downtime 1 2 3 4 5 6 7 resource \u0026#34;azurerm_resource_group\u0026#34; \u0026#34;example\u0026#34; { # ... lifecycle { create_before_destroy = true } } å…¶ä»– lifecycle é‚„æœ‰ prevent_destroy ä¸æœƒTerraform è¢«åˆªé™¤ ä»¥åŠ ignore_changes æŒ‡å®šæŸäº›å±¬æ€§æ›´æ–°ä¸è§¸ç™¼ Terraform æ›´æ–°è³‡æº 2. ä½¿ç”¨ Terraform CLI æ”¹è®Š state åƒæ˜¯è¦ä¿®æ”¹ resource åç¨±ï¼Œå¯ä»¥é€éä¿®æ”¹ state è€Œéè³‡æºæœ¬èº«å³å¯ $ terraform state mvï¼Œç›¡é‡é€éæŒ‡ä»¤å»ä¿®æ”¹ stateï¼Œè€Œä¸æ˜¯æ‰‹å‹•ç›´æ¥æ”¹ tfstate\nçµèª å®Œæ•´ç¨‹å¼ç¢¼ï¼Œå¾Œä¾†æ±ºå®šå°‡ä¸Šä¸€ç¯‡çš„å…§å®¹æ•´ç†æˆ moduleï¼Œæ¥è‘— iam role éƒ¨åˆ†ç¨ç«‹å‡ºä¾†å‰µç«‹ï¼Œæ¥è‘—ç”¨ data source æ–¹å¼å¼•å…¥ï¼›\nå¤šå€åŸŸéƒ¨ç½²å¥—ç”¨ module ç¨ç«‹å®£å‘Šï¼Œå¯æƒœ for_each å°šæœªæ”¯æ´ module\nä»¥ä¸‹æ˜¯ slack çš„ log ç•«é¢\nå°æ–¼å°å…¥ Terraform è©•ä¼°è »æ­£é¢çš„ï¼Œä¸€ä¾†æœ‰ data source æˆ– import èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆï¼Œåˆå¯ä»¥ä¸æ“”å¿ƒæçˆ›æ•´å€‹æ¶æ§‹ï¼›\näºŒä¾†èªæ³•éƒ½æ…¢æ…¢å®Œæ•´ï¼Œå¯ä»¥æ‡‰ä»˜å¤§å¤šæ•¸çš„å ´æ™¯ï¼Œç¢ºå¯¦çœä¸‹å¾ˆå¤šçš„ç®¡ç†ä¸Šçš„å¿ƒåŠ›ï¼ŒæœŸå¾…ä¹‹å¾Œå¯ä»¥ç”¨ Terraform æ•´åˆ Kubernetesï¼Œä¸¦æ•´åˆ CI/CDï¼Œè®“é–‹ç™¼ã€æ•´åˆã€éƒ¨ç½²ã€ç¶­é‹å¯ä»¥æ›´é †æš¢\næ¥ä¸‹ä¾†è¦ç¹¼çºŒç†Ÿç·´ Terraformï¼Œå¸Œæœ›æŒ‘æˆ°æ•´åˆ Docker çš„è·¨å€åŸŸè·¨ Provider éƒ¨ç½²\n","date":"2019-11-04T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2019/2019-11-04-%E5%88%9D%E8%A9%A6-terraform-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E8%88%87%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%83%A8%E7%BD%B2-lambda-%E4%B8%8B/","title":"åˆè©¦ Terraform - åŸºæœ¬ä»‹ç´¹èˆ‡ç”¨ç¨‹å¼ç¢¼éƒ¨ç½² Lambda (ä¸‹)"},{"content":"ä»‹ç´¹ Terraform åœ¨ Github ä¸Šæœ‰ä¸€è¬ä¹åƒå¤šé¡†æ˜Ÿæ˜Ÿ(æˆªè‡ªç™¼æ–‡æ—¥)çš„é–‹æºå°ˆæ¡ˆï¼Œç”± HashiCorp é€™é–“å°ˆæ³¨æ–¼ DevOps å·¥å…·é–‹ç™¼çš„å…¬å¸æ‰€ç¶­è­·ï¼Œä¸»è¦é€é DSL ç·¨å¯«å®šç¾©æª”ï¼Œç®¡ç†è·¨é›²ç«¯æ¶æ§‹ï¼Œè®“æ¶æ§‹ä¹Ÿå¯ä»¥ç¨‹å¼ç¢¼åŒ–ï¼Œè¿‘ä¸€æ­¥æ›´å¥½çš„å”ä½œã€ç‰ˆæœ¬æ§åˆ¶ç­‰å¥½è™•ï¼Œé”åˆ° Infrastructure as code çš„ç›®æ¨™ã€‚\nTerraform å¯ä»¥é”åˆ°ä»¥ä¸‹å¹¾ä»¶äº‹ï¼š\næ¶æ§‹ä»£ç¢¼åŒ–\nTerraform æ¡ç”¨å®£å‘Šå¼ç¨‹å¼èªè¨€(declarative language)çš„ DSLï¼Œä½†åŒæ¨£æä¾›åŸºç¤çš„ç¨‹å¼èªè¨€è©²æœ‰çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è®Šæ•¸ã€è¼¸å…¥è¼¸å‡ºã€æ¨¡çµ„åŒ–ç­‰ï¼Œå…¶ä¸­æ¨¡çµ„åŒ–ä¹Ÿæ”¯æ´åŠ è¼‰å¤–éƒ¨æ¨¡çµ„ï¼Œä¸ç”¨æ“”å¿ƒé•å DRYï¼Œå…§å»ºä¸€äº›å‡½ç¤ºä¹Ÿéƒ½å¾ˆå¥½ç”¨ï¼› ç•¶ä½ æœ‰å¤šå€‹ç’°å¢ƒè¦éƒ¨ç½²æ™‚ï¼Œå¯ä»¥ç”¨åŒæ¨£çš„æ¶æ§‹ä½†æ˜¯ä¸åŒçš„æ©Ÿå™¨è¦æ ¼èˆ‡åƒæ•¸ï¼Œç®¡ç†ä¸Šå¾ˆæ–¹ä¾¿ è·¨å¹³å°æœå‹™\nAzure / GCP / AWS / Heroku éƒ½å¯ä»¥ï¼Œå…¶ä»–çš„å·¥å…·åŒ…å±±åŒ…æµ·ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶ Providers è‡ªå‹•ç®¡ç†æ¶æ§‹å‡ç´š\næ¶æ§‹ç•°å‹•æ™‚ï¼ŒTerraform æœƒè‡ªå‹•æ›´æ–°æˆ–æ›¿æ›æ­£ç¢ºçš„è³‡æºï¼ŒåŒæ™‚ä¹Ÿå¯ä»¥ä¸€éµåˆªé™¤ åœ˜éšŠå”ä½œ\næä¾›å¤šæ¨£çš„è§£æ±ºæ–¹æ¡ˆï¼Œå¯ä»¥ç”¨å®˜æ–¹çš„ Terraform Cloud æˆ– AWS S3 ç­‰ï¼Œåœ¨åœ˜éšŠå…§å…±åŒç®¡ç† èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆ\nTerraform æä¾›å…©ç¨®æ–¹å¼èˆ‡æ—¢æœ‰æ¶æ§‹æ•´åˆï¼Œä¸€æ˜¯ç¶­æŒå”¯è®€å‹æ…‹åªå­˜å–è³‡æº(ä¾‹å¦‚è®€ AWS arn ç¶å®šåˆ° Lambda ä¸Š)ã€äºŒæ˜¯ Import è³‡æºä¸€ä¸¦ç”± Terraform ç®¡ç†(å¢åŠ ã€åˆªé™¤ã€ä¿®æ”¹) DX å¾ˆå¥½\nDeveloper Experience é‚„ä¸è³´ï¼Œå®˜æ–¹çš„æ–‡ä»¶ã€æ•™å­¸ï¼Œä»¥åŠæ•´é«”çš„è¨­è¨ˆä¸Šéƒ½å¾ˆå‹å–„ï¼ŒéŒ¯èª¤ä¹Ÿæœƒå¾ˆç›´æ¥é¡¯ç¤ºå“ªä¸€è¡Œçš„å“ªä¸€éƒ¨åˆ†èªæ³•éŒ¯èª¤ï¼Œå­¸ç¿’ä¸Š Debug ä¸Šéƒ½å¾ˆå®¹æ˜“ï¼ŒHashiCorp å“¡å·¥æœ‰åˆ†äº«é€™æ˜¯ä»–å€‘åœ¨ 0.12 å¾ˆå¤§çš„ä¿®æ­£ï¼Œè®“ç”¨æˆ¶æ›´å¿«æ‰¾å‡ºéŒ¯èª¤æ˜¯ä»–å€‘é‡è¦–çš„ä¸€ç’° é€™æ¬¡ç›®æ¨™è·Ÿä¸Šæ¬¡çš„ CDK ç ”ç©¶ä¸€æ¨£ï¼Œéƒ¨ç½²ä¸€å€‹æ¯äº”åˆ†é˜åŸ·è¡Œçš„ Lambdaï¼Œä¸¦åˆ†ä½ˆåˆ°å¤šå€‹å€åŸŸï¼ŒCDK æ•™å­¸é€£çµ AWS-CDKæ•™å­¸â€Šâ€”â€ŠInfrastructore As Code ç”¨ç¨‹å¼ç¢¼ç®¡ç†æ¶æ§‹\näº‹å‰æº–å‚™ è«‹å…ˆå®‰è£ Terraformï¼Œä¸¦è¨­å®šå¥½ AWS configurationï¼Œä¹Ÿå¯ä»¥å…ˆç©éå®˜æ–¹æ•™å­¸ Terraform getting startedï¼› å¦ä¸€å€‹å¾ˆæ£’çš„åƒè€ƒè³‡æ–™ An Introduction to Terraformï¼Œç³»åˆ—æ–‡è¶…ä»”ç´°ä¹Ÿè¶…å¯¦ç”¨ï¼Œæ¯”å®˜æ–¹æ–‡ä»¶é‚„æ¨è–¦ï¼Œä½œè€…ä¹Ÿæœ‰å‡ºæ›¸ï¼Œæœ‰æ©Ÿæœƒæ‡‰è©²æœƒå…¥æ‰‹\néƒ¨ç½²å–®å€åŸŸçš„ Lambda èˆ‡ IAM Role å‰µå»ºä¸€å€‹æª”æ¡ˆï¼Œå…ˆå‘½åç‚º main.tf ï¼Œåœ¨ Terraform ä¸­æª”æ¡ˆåˆ†æˆ root module èˆ‡ moduleï¼Œæ²’æœ‰ç‰¹åˆ¥å®£å‘Šæ˜¯ module å‰‡ç‚º root moduleï¼Œç›®éŒ„ä¸‹å¯ä»¥æœ‰å¤šå€‹ root moduleï¼Œæª”æ¡ˆåç¨±æ²’æœ‰é€²å…¥é»å•é¡Œï¼Œåªè¦çµå°¾æ˜¯ .tf å³å¯\né¦–å…ˆç¬¬ä¸€æ­¥ï¼Œå…ˆéƒ¨ç½²å–®ä¸€å€åŸŸçš„ Lambdaï¼Œèˆ‡å»ºç«‹å°æ‡‰éœ€è¦çš„ IAM Roleï¼Œä»¥ä¸‹ç¨‹å¼ç¢¼ä¸»è¦åšå¹¾ä»¶äº‹\nå®£å‘Š aws éƒ¨ç½²çš„å€åŸŸ å»ºç«‹æ–°çš„ IAM role å‘½åç‚º iam_for_lambdaï¼Œä¸¦çµ¦äºˆèª¿ç”¨ lambda çš„æ¬Šé™ å»ºç«‹ IAM Policy å‘½åç‚º lambda_loggingï¼Œçµ¦äºˆ Cloudwatch log æ¬Šé™ å°‡ IAM Policy è³¦äºˆ IAM roleï¼Œlambda_logging çµ¦ iam_for_lambda ç­‰ç­‰ Lambda æœƒç”¨åˆ°ä¸€äº› node_modulesï¼Œå»ºç«‹ Lambda layer å‘½åç‚º lambda-layer_fetch å»ºç«‹ Lambda function aws_lambda_functionï¼Œç¶å®š lambda-layer_fetch èˆ‡åŸ·è¡Œè§’è‰² iam_for_lambda å¯«å®Œä»‹ç´¹ï¼Œå‰›å¥½ä¸€æ­¥å°ç…§ä¸€å¡Šç¨‹å¼ç¢¼ï¼Œå¦‚æœå° AWS æœ‰é»ç†Ÿæ‚‰çš„äººæ‡‰è©²å¯ä»¥å¾ˆå¿«ç†è§£èªæ³•ï¼Œå°¤å…¶æ˜¯è®Šæ•¸å‘½åè·Ÿå¾Œå°è¨­å®šå¾ˆé›·åŒï¼Œæ‰€ä»¥ä¸Šæ‰‹ç›¸ç•¶è¼•é¬†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 # æŒ‡å®šå¾ŒçºŒè³‡æºçš„æä¾›è€…æ˜¯å“ªå€‹å¹³å°çš„å“ªå€‹å€åŸŸ # provider æ²’æœ‰æŒ‡å®š alias ä»£è¡¨ç‚ºé è¨­ provider provider \u0026#34;aws\u0026#34; { profile = \u0026#34;default\u0026#34; region = \u0026#34;us-east-1\u0026#34; } # å»ºç«‹ IAM roleï¼Œå–åç‚º iam_for_lambda resource \u0026#34;aws_iam_role\u0026#34; \u0026#34;iam_for_lambda\u0026#34; { name = \u0026#34;iam_for_lambda\u0026#34; assume_role_policy = \u0026lt;\u0026lt;EOF { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;lambda.amazonaws.com\u0026#34; }, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Sid\u0026#34;: \u0026#34;\u0026#34; } ] } EOF } # å»ºç«‹ IAM Policyï¼Œä¸»è¦çµ¦ Cloudwatch Log æ¬Šé™ resource \u0026#34;aws_iam_policy\u0026#34; \u0026#34;lambda_logging\u0026#34; { name = \u0026#34;lambda_logging\u0026#34; path = \u0026#34;/\u0026#34; description = \u0026#34;IAM policy for logging from a lambda\u0026#34; policy = \u0026lt;\u0026lt;EOF { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Action\u0026#34;: [ \u0026#34;logs:CreateLogGroup\u0026#34;, \u0026#34;logs:CreateLogStream\u0026#34;, \u0026#34;logs:PutLogEvents\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:logs:*:*:*\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34; } ] } EOF } resource \u0026#34;aws_iam_role_policy_attachment\u0026#34; \u0026#34;lambda_logs\u0026#34; { role = \u0026#34;${aws_iam_role.iam_for_lambda.name}\u0026#34; policy_arn = \u0026#34;${aws_iam_policy.lambda_logging.arn}\u0026#34; } resource \u0026#34;aws_lambda_layer_version\u0026#34; \u0026#34;lambda-layer_fetch\u0026#34; { filename = \u0026#34;./lambda_layer_payload.zip\u0026#34; layer_name = \u0026#34;lambda_layer_name\u0026#34; source_code_hash = \u0026#34;${filebase64sha256(\u0026#34;lambda_layer_payload.zip\u0026#34;)}\u0026#34; compatible_runtimes = [\u0026#34;nodejs10.x\u0026#34;] } resource \u0026#34;aws_lambda_function\u0026#34; \u0026#34;lambda_main\u0026#34; { function_name = \u0026#34;global-api-lantency-test\u0026#34; filename = \u0026#34;./lambda_payload.zip\u0026#34; handler = \u0026#34;index.handler\u0026#34; runtime = \u0026#34;nodejs10.x\u0026#34; role = \u0026#34;${aws_iam_role.iam_for_lambda.arn}\u0026#34; source_code_hash = \u0026#34;${filebase64sha256(\u0026#34;lambda_payload.zip\u0026#34;)}\u0026#34; layers = [ \u0026#34;${aws_lambda_layer_version.lambda-layer_fetch.arn}\u0026#34; ] publish = true environment { variables = { REGION = \u0026#34;us-east-1\u0026#34; SLACK_URL = \u0026#34;https://hooks.slack.com/services/.....\u0026#34; } } } Provider æŒ‡å®šè³‡æºæ˜¯å¥—ç”¨åœ¨å“ªå€‹å¹³å°ï¼Œç›®å‰æ˜¯æŒ‡å®šåœ¨ us-east-1 AWS ä¸Šï¼Œå¦‚æœæ²’æœ‰æŒ‡å®š alias å‰‡ä»£è¡¨æ˜¯é è¨­çš„ provider\nResource å‘½åçš„æ–¹å¼æ˜¯\n1 2 3 resource è³‡æºé¡å‹ è³‡æºåç¨± { è³‡æºåƒæ•¸ } è³‡æºåƒæ•¸å°æ‡‰è³‡æºé¡å‹ï¼Œå¯ä»¥å¾æ–‡ä»¶ä¸­æ‰¾ç¯„ä¾‹èˆ‡å®šç¾©çš„æ–¹å¼ï¼Œè³‡æºçš„å®šç¾©ä¾è³´æ–¼ Provider å¹³å°çš„ä¸åŒï¼Œå¯ä»¥æŒ‡å®š providerï¼Œä¸æŒ‡å®šå‰‡ç”¨é è¨­\né™¤äº†å€‹åˆ¥çš„è³‡æºå®šç¾©å¤–ï¼Œåƒæœ‰äº›è³‡æºæœƒç›¸ä¾ï¼Œä¾‹å¦‚ Lambda è¦ç¶å®šç‰¹å®šçš„ IAM Roleï¼Œæ³¨æ„åˆ°é€™é‚Šçš„å¯«æ³•æ˜¯\n1 2 3 4 resource \u0026#34;aws_lambda_function\u0026#34; \u0026#34;lambda_main\u0026#34; { role = \u0026#34;${aws_iam_role.iam_for_lambda.arn}\u0026#34; .... } è¦å¼•ç”¨å…¶ä»–è³‡æºçš„åƒæ•¸ï¼Œéœ€è¦ç”¨\u0026quot;${è³‡æºé¡å‹.è³‡æºåç¨±.arn}\u0026quot;ï¼Œarn æ˜¯ AWS ç”¨ä¾†è­˜åˆ¥è³‡æºçš„å…¨åŸŸ IDï¼Œé€éé€™æ¨£çš„æ–¹å¼å°±èƒ½å¤ ç¶å®šè³‡æºï¼Œé€™é‚Šæˆ‘æŒ‡å®šè¦ç”¨ Lambda çš„ Execution Role æ˜¯ iam_for_lambda é€™å€‹ Roleã€‚\nå¦å¤–ç‚ºäº†æ•ˆç‡ï¼Œå®šç¾©çš„è³‡æºæœƒä¸¦è¡Œå»ºç«‹ï¼Œä½†æœ‰äº›è³‡æºæœ‰ç›¸ä¾æ€§ï¼ŒTerraform æœƒè‡ªå‹•è™•ç†ç›¸ä¾æ€§ï¼Œæ‰€ä»¥ä¸Šè¿°çš„è³‡æºç†è«–ä¸Šè¦ Policy \u0026gt; Role \u0026gt; Lambda Layer \u0026gt; Lambdaï¼Œä½†æˆ‘å€‘ä¸ç”¨å®£å‘Š Terraform æœƒè‡ªè¡Œè™•ç†ï¼› ä½†æœ‰æ™‚å€™ç›¸ä¾æ€§ä¸æ˜é¡¯æˆ–æ˜¯æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥é¡¯ç¤ºå®£å‘Š depends_onã€‚\nLambda Function å»ºç«‹å®Œæˆå¾Œï¼Œå¦‚æœåªæ˜¯è¦å–®ç´”æ›´æ”¹ Lambda å…§å®¹è€Œä¸èª¿æ•´æ¶æ§‹ï¼Œå¯ä»¥å®£å‘Š\n1 2 resource \u0026#34;aws_lambda_function\u0026#34; \u0026#34;lambda_main\u0026#34; { source_code_hash = \u0026#34;${filebase64sha256(\u0026#34;lambda_payload.zip\u0026#34;)}\u0026#34; source_code_hash æ˜¯æŒ‡èªªå¦‚æœ hash å€¼æ”¹è®Šå°±æ›´æ–° Lambda å…§å®¹ï¼Œè€Œ filebase64sha256() æ˜¯ Terraform çš„å…§å»ºå‡½ç¤ºï¼Œè‡ªå‹•ç”¨ sha 256 ç®—å‡ºæª”æ¡ˆ hash å€¼ä¸¦ç”¨ base64 ç·¨ç¢¼\né¡Œå¤–è©±ï¼ŒLambda çš„ zip file è¨˜å¾—è§£å£“ç¸®å¾Œä¸è¦æœ‰é¡å¤–çš„è³‡æ–™å¤¾ï¼Œä¸ç„¶æœƒå¤±æ•—ï¼Œæ­£ç¢ºæ‡‰è©²è¦æ˜¯\n1 2 --- lambda.zip |--- index.js éƒ¨ç½²æ¶æ§‹ ç·¨å¯«å¥½æ¶æ§‹ï¼Œæ­¤æ™‚è¦èª¿ç”¨ Terraform CLI ä¾†éƒ¨ç½²æ¶æ§‹ é¦–å…ˆåˆå§‹åŒ–ç’°å¢ƒèˆ‡è¼‰å…¥éœ€è¦çš„åŸ·è¡Œè³‡æº\n$ terraform init\nä¸€é–‹å§‹ Terraform ä¸¦ä¸çŸ¥é“å»ºç«‹çš„ Provider æ˜¯èª°ï¼Œç›´åˆ°åˆå§‹åŒ–æ‰æœƒä¸‹è¼‰å°æ‡‰çš„ Libraryï¼Œæ”¾åœ¨å°ˆæ¡ˆè·¯å¾‘åº•ä¸‹çš„ .terraform è³‡æ–™å¤¾ä¸‹\næˆåŠŸå¾Œï¼Œå°±å¯ä»¥éƒ¨ç½²æ¶æ§‹äº†\n$ terraform apply\næ­¤æ™‚ Terraform æœƒåˆ—å‡ºæ›´å‹•çš„è³‡æºï¼Œ+ ä»£è¡¨éœ€è¦æ–°å»ºçš„è³‡æºã€-ä»£è¡¨æœƒè¢«åˆªé™¤çš„è³‡æºã€~ä»£è¡¨æœƒè¢«æ›´æ–°çš„è³‡æºï¼Œæ³¨æ„è³‡æºæ›´æ–°å¯æ˜¯åˆªé™¤èˆŠçš„è³‡æºéƒ¨ç½²æ–°çš„è³‡æºï¼Œä¾ç…§å„å®¶ provider çš„ API è€Œæœ‰æ‰€ä¸åŒï¼Œéœ€è¦ç‰¹åˆ¥ç•™æ„ å¦‚æœç¢ºèªå°±è¼¸å…¥ \u0026ldquo;yes\u0026rdquo;ï¼Œç­‰ Terraform å¹«å¿™éƒ¨ç½²\né€™æ¨£å°±å®Œæˆäº†ï¼Œå¾ŒçºŒæœ‰ä»€éº¼èª¿æ•´å°±é‡è¤‡ $ terraform apply æ­¥é©Ÿï¼Œå¯ä»¥åˆ° AWS å¾Œå°ç¢ºèªè³‡æºçš„å»ºç«‹ç‹€æ³\nåŠ ä¸Š Cloudwatch é€™ä¸€æ®µé›·åŒï¼Œè£œä¸Š cloudwatch event rule / cloudwatch event targeï¼Œæœ€å¾Œåˆ¥å¿˜äº†è¦åŠ ç¶å®š lambda permission ä¸ç„¶è§¸ç™¼ Lambda æœƒå¤±æ•—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # add cloudwatch event resource \u0026#34;aws_cloudwatch_event_rule\u0026#34; \u0026#34;every_five_minutes\u0026#34; { name = \u0026#34;routine-api-request\u0026#34; description = \u0026#34;Routinely call global api lantency test\u0026#34; schedule_expression = \u0026#34;rate(5 minutes)\u0026#34; } resource \u0026#34;aws_cloudwatch_event_target\u0026#34; \u0026#34;api_request\u0026#34; { rule = \u0026#34;${aws_cloudwatch_event_rule.every_five_minutes.name}\u0026#34; target_id = \u0026#34;CallApiRequest\u0026#34; arn = \u0026#34;${aws_lambda_function.lambda_main.arn}\u0026#34; } # resource \u0026#34;aws_lambda_permission\u0026#34; \u0026#34;allow_cloudwatch_to_call_check_api\u0026#34; { statement_id = \u0026#34;AllowExecutionFromCloudWatch\u0026#34; action = \u0026#34;lambda:InvokeFunction\u0026#34; function_name = \u0026#34;${aws_lambda_function.lambda_main.function_name}\u0026#34; principal = \u0026#34;events.amazonaws.com\u0026#34; source_arn = \u0026#34;${aws_cloudwatch_event_rule.every_five_minutes.arn}\u0026#34; } Import ç¾æœ‰çš„ IAM Role å›éé ­èªªä¸€ä¸‹ä¹‹å‰æ¡ç”¨ AWS CDK çš„æœ€å¤§å•é¡Œï¼Œç•¶åˆç ”ç©¶æ™‚æ²’æœ‰çœ‹åˆ° AWS CDK èˆ‡ç¾æœ‰æ¶æ§‹çš„æ•´åˆï¼Œé€™å°è‡´å…¬å¸è¦æ¡ç”¨éœ€è¦å¾ˆå¤§çš„æ±ºå¿ƒï¼Œæˆ–æ˜¯åªèƒ½ç”¨åœ¨æ¸¬è©¦æˆ–æ–°çš„ç’°å¢ƒå»ºè¨­ï¼Œæ²’æœ‰è¾¦æ³• graceful è½‰ç§»ï¼Œé€™é»æˆ‘è¦ºå¾—å°æ–¼è¦å°å…¥æ–°æŠ€è¡“ä¾†èªªï¼Œæœ‰é»éº»ç…©ï¼Œå°¤å…¶æ˜¯æ¶æ§‹é€™éº¼é‡è¦çš„åœ°æ–¹ï¼›\nå¦ä¸€é»æ˜¯è§’è‰²çš„æ¬Šé™ç®¡ç†ï¼Œå…¬å¸éƒ½æœƒæœ‰é‡å°ä¸åŒçš„è·ä½çµ¦äºˆä¸åŒçš„æ¬Šé™ï¼ŒAWS CDK é è¨­å°±è¦ CreateRole ç­‰æ¬Šé™ï¼ŒåŸºæœ¬ä¸Šå¾ˆé›£ç›´æ¥è¦åˆ°é€™éº¼é«˜çš„æ¬Šé™ï¼Œä¹Ÿæ˜¯ç•¶åˆè¦åœ¨å…¬å¸å°ˆæ¡ˆå˜—è©¦ AWS CDK æœ€å¤§å¤±æ•—çš„åŸå› \nTerraform ç¾è¡Œæ”¯æ´ import æ—¢æœ‰çš„è³‡æºï¼Œä½†æ˜¯è³‡æºå…§å®¹è¦è‡ªå·±å¡«å¯«ï¼Œæœªä¾†å®£ç¨±æœƒæ”¯æ´è‡ªå‹•è¼‰å…¥å…§å®¹ï¼›\nexisted_role æ˜¯æˆ‘é å…ˆåœ¨ AWS å‰µå»ºçš„ IAM Roleï¼Œæ¬Šé™è·Ÿä¸Šé¢çš„ iam_for_lambda ä¸€æ¨£ï¼Œè¨˜å¾—è¦å…ˆåœ¨è¨­å®šæª”å®£å‘Šï¼Œæ¥è‘—åŸ·è¡ŒæŒ‡ä»¤å°±å®Œæˆäº†ï¼Œä¹‹å¾Œ terraform destroy ä¹Ÿæœƒä¸€ä¸¦åˆªé™¤ (éœ€è¦ç•™æ„)\n$ terraform import aws_iam_role.existed_role existed_role\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # existed iam role resource \u0026#34;aws_iam_role\u0026#34; \u0026#34;existed_role\u0026#34; { name = \u0026#34;existed_role\u0026#34; assume_role_policy = \u0026lt;\u0026lt;EOF { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;lambda.amazonaws.com\u0026#34; }, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Sid\u0026#34;: \u0026#34;\u0026#34; } ] } EOF } Variables - æŠ½é›¢åƒæ•¸ ç›®å‰çš„åƒæ•¸éƒ½æ˜¯å¯«æ­»çš„ï¼Œä¾‹å¦‚èªªéƒ¨ç½²çš„å€åŸŸã€Lambda åç¨±ç­‰ï¼ŒTerraform æ”¯æ´ variable å®šç¾©ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹å¹¾ç¨®é¡å‹\nstring boolean number set map object (ç­‰åŒæ–¼ mapï¼Œä½†æœƒè“‹é map) tuple å¦‚æœè¦åœ¨åƒæ•¸ä½¿ç”¨è®Šæ•¸çš„è©±ï¼Œå¿…é ˆè¦å…ˆåœ¨è³‡æºæª” .tf å®£å‘Š\n1 2 3 4 5 variable \u0026#34;image_id\u0026#34; { type = string default = \u0026#34;default å€¼\u0026#34; description = \u0026#34;The id of the machine image (AMI) to use for the server.\u0026#34; } type å¿…å¡«ï¼Œä½†æ˜¯ default è·Ÿ description ä¸ç”¨ï¼Œç•¶æ²’æœ‰ default ä¸”å¾ŒçºŒè®Šæ•¸æ²’æœ‰è³¦å€¼çš„è©±ï¼Œåœ¨ \u0026gt;$terraform apply æ™‚æœƒä¸­æ–·è¦æ±‚è¼¸å…¥\nåœ¨è³‡æºå®šç¾©æª”ä¸Šï¼Œå¯ä»¥æ¡ç”¨ var.è®Šæ•¸åç¨±\n1 2 3 4 provider \u0026#34;aws\u0026#34; { profile = \u0026#34;default\u0026#34; region = var.image_id } æ¥è‘—ï¼Œé€éä»¥ä¸‹å¹¾ç¨®æ–¹å¼è³¦å€¼çµ¦ variable\nç’°å¢ƒè®Šæ•¸ 1 2 $export TF_VAR_image_id=ami-abc123 $export TF_VAR_availability_zone_names=\u0026#39;[\u0026#34;us-west-1b\u0026#34;,\u0026#34;us-west-1d\u0026#34;]\u0026#39; terraform.tfvars æª”æ¡ˆä¸­ 1 2 image_id = \u0026#34;ami-abc123\u0026#34; availability_zone_names=[\u0026#34;us-west-1b\u0026#34;,\u0026#34;us-west-1d\u0026#34;] terraform.tfvars.json æª”æ¡ˆä¸­ 1 2 3 4 { \u0026#34;image_id\u0026#34;: \u0026#34;ami-abc123\u0026#34;, \u0026#34;availability_zone_names\u0026#34;: [\u0026#34;us-west-1a\u0026#34;, \u0026#34;us-west-1c\u0026#34;] } *.auto.tfvars æˆ–æ˜¯ *.auto.tfvars.jsonï¼Œé †åºæŒ‰ç…§æª”å åœ¨ CLI åŸ·è¡Œæ™‚æŒ‡å®š -var -var-file $terraform apply -var=\u0026ldquo;image_id=ami-abc123\u0026rdquo;\nå¦‚æœæœ‰åŒæ¨£çš„è®Šæ•¸åç¨±ï¼ŒæŒ‰ç…§ä¸Šé¢çš„è¦å‰‡é †åºå¾Œè€…è“‹éå‰è€…ï¼Œä¾‹å¦‚ -var æœƒè“‹éå…¶ä»–æª”æ¡ˆçš„å®£å‘Š\nOutput - è¼¸å‡ºåƒæ•¸ å°æ–¼ root module ä¾†èªªï¼Œè¨­å®š output æœƒåœ¨ \u0026gt; $terraform apply æ™‚æ‰“å°ï¼Œä¾‹å¦‚èªª EC2 Instance çš„ public DNSç­‰ï¼› å° module ä¾†èªªï¼ŒOutput ç­‰åŒæ–¼ function çš„ return valueï¼Œæ±ºå®šå“ªäº›è³‡æºè®“å¤–éƒ¨è®€å–\nåœ¨ç¯„ä¾‹ç¨‹å¼çš„ç›®éŒ„ä¸‹æœ‰ç¨ç«‹çš„ output.tf\n1 2 3 4 5 6 7 output \u0026#34;lambda-arn\u0026#34; { value = aws_lambda_function.lambda_main.arn } output è¼¸å‡ºåƒæ•¸åé¤ { value = è³‡æºé¡åˆ¥.è³‡æºå‘½å.è³‡æºå±¬æ€§ } æœƒåœ¨ apply æˆåŠŸå¾Œæ‰“å°å‡ºä¾†\n1 2 3 4 5 Apply complete! Resources: 2 added, 0 changed, 0 destroyed. Outputs: lambda-arn = arn:aws:lambda:us-east-1:..... State - Terraform å¦‚ä½•æŒç®¡æ¶æ§‹çš„æ›´å‹• ç•¶æ¶æ§‹ç•°å‹•çš„æ™‚å€™ï¼ŒTerraform å¦‚ä½•çŸ¥é“å‰å¾Œæ¶æ§‹çš„å·®ç•°å‘¢ï¼Ÿ æ¯æ¬¡åœ¨åŸ·è¡Œ $ terraform plan æ™‚ï¼Œå°ˆæ¡ˆç›®éŒ„åº•ä¸‹æœ‰ terraform.tfstate æª”æ¡ˆï¼Œç”¨ JSON æè¿°æ¶æ§‹ä¸­çš„æ‰€æœ‰è³‡æºï¼Œæ¯ç•¶ä¸‹æ¬¡åŸ·è¡Œ $ terraform plan æ™‚ï¼ŒTerraform æœƒæ ¹æ“š tfstate ä¸­çš„è³‡æº ID å–å¾—æœ€æ–°çš„è³‡è¨Šï¼Œæ¥è‘—èˆ‡æè¿°æª”åš diff æ±ºå®šå“ªéƒ¨åˆ†è³‡æºè¦æ›´æ–°\nç•¶æˆ‘å€‘è¦è·¨åœ˜éšŠå”ä½œæ™‚ï¼Œå°±éœ€è¦æŠŠ terraform æè¿°æª” + terraform.tfstate èˆ‡åœ˜éšŠå…±äº«ï¼Œæ­¤æ™‚æœƒæœ‰æœ‰ä¸‰å€‹è¦ç´ \nå…±äº«æª”æ¡ˆèˆ‡ç‰ˆæœ¬æ§åˆ¶\næª”æ¡ˆå…±äº«æ˜¯æœ€åŸºæœ¬çš„å”ä½œå¿…å‚™æ¢ä»¶ï¼ŒåŒæ™‚å°‡ç¨‹å¼ç¢¼åšç‰ˆæœ¬æ§åˆ¶ä¹Ÿæ˜¯å¾ˆå¿…è¦çš„åŠŸèƒ½ Lock æ©Ÿåˆ¶\nç•¶å…±äº«äº†ä¹‹å¾Œï¼ŒLock å°±è®Šæˆæ˜¯å¿…é ˆè€ƒé‡çš„å› ç´ ï¼Œé¿å…åœ˜éšŠåŒæ™‚å¤šäººåŒæ­¥ä¿®æ”¹ï¼Œé€ æˆå‰å¾Œè¡çªçš„ç‹€æ³ ç¨ç«‹ä¸åŒçš„ state ç‹€æ…‹\nåœ¨å¯¦éš›æ‡‰ç”¨ä¸Šï¼Œå¯èƒ½æœƒæœ‰ development / staging / production ä¸åŒç’°å¢ƒï¼Œå¸Œæœ›å…±ç”¨ç¨‹å¼ç¢¼å»ºç«‹é›·åŒçš„æ¶æ§‹ï¼Œä½†åˆå› ç‚ºç’°å¢ƒä¸åŒå¸Œæœ›æœ‰ä¸åŒçš„é…ç½®ï¼Œä¾‹å¦‚æ©Ÿå™¨å¤§å°æˆ– VPC ç­‰ï¼Œæ­¤æ™‚å°±éœ€è¦è€ƒé‡å¦‚ä½•ç¨ç«‹ä¸åŒç’°å¢ƒ åœ¨è·¨åŒåœ˜éšŠå”ä½œå¾ˆå®¹æ˜“æƒ³åˆ° git ï¼Œä½†åš´æ ¼ä¾†èªª git åªèƒ½æ»¿è¶³ç¬¬ä¸€é»ï¼Œæ‰€ä»¥åœ¨ Terraform å¯ä»¥æŒ‡å®šä¸åŒçš„ state ç®¡ç†æ–¹å¼ï¼Œé™¤äº†å®˜æ–¹çš„ Terraform Cloudï¼Œå¯ä»¥æ¡ç”¨ AWS S3 + DynamoDB é”åˆ°ä¸Šè¿°çš„æ¢ä»¶ï¼Œä¸¦é™„å¸¶ç‰ˆæœ¬æ§åˆ¶ï¼Œå†ä¹‹å¾Œæœƒæ›´è©³ç´°çš„æè¿°æ“ä½œæµç¨‹ï¼Œè©³æƒ…å¯ä»¥åƒè€ƒ How to manage Terraform state\nçµèª å°±é€™æ¨£å®Œæˆäº†å–®å€åŸŸçš„ Lambda éƒ¨ç½²èˆ‡æœ€åŸºæœ¬çš„ Terraform å­¸ç¿’ï¼Œä»¥ä¸‹æ˜¯é€™æ¬¡æ•™å­¸çš„ç¨‹å¼ç¢¼ terraform-investigation\nä¸‹ä¸€ç¯‡å°‡æ•´å€‹æ¶æ§‹æ¨¡çµ„åŒ–ï¼Œä¸¦ä¸€éµéƒ¨ç½²å¤šå€‹å€åŸŸ\n","date":"2019-10-30T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2019/2019-10-30-%E5%88%9D%E8%A9%A6-terraform-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E8%88%87%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%83%A8%E7%BD%B2-lambda-%E4%B8%8A/","title":"åˆè©¦ Terraform - åŸºæœ¬ä»‹ç´¹èˆ‡ç”¨ç¨‹å¼ç¢¼éƒ¨ç½² Lambda (ä¸Š)"},{"content":" ç•¶åˆåœ¨ Youtube çœ‹åˆ° Douglas ç‚ºæ›¸ç±åšå°è®€çš„å½±ç‰‡ï¼Œé‡æ–°ä»‹ç´¹æ¯å€‹ JS æ—¥å¸¸é–‹ç™¼çš„éƒ¨åˆ†ï¼Œå¾å‹åˆ¥é–‹å§‹ Number / Date / Function / Object / String / Array / ï¼¤ã„ï¼› å»¶ä¼¸åˆ° Promise / Exception / Generator / Async \u0026amp; Awaitï¼› æœ€å¾Œå¯«ä¸€å€‹è‡ªå‰µçš„èªè¨€ Neo è§£é‡‹ Transpiler çš„å·¥ä½œï¼ŒTokenizing / Parsing / Runtimesï¼›\nJavascript æ˜¯å€‹ç¥å¥‡ä¸”çŸ›ç›¾çš„å­˜åœ¨ï¼Œå®ƒæœ‰è¨±å¤šéŒ¯èª¤èˆ‡ä¸å¥½çš„è¨­è¨ˆï¼Œä½†é¿é–‹é€™äº›å‘ä»–åˆæ˜¯ä¸€é–€å…·å‚™å½ˆæ€§ã€å—åˆ°å»£å¤§ç†±æ„›çš„ç¨‹å¼èªè¨€ï¼Œå†æˆ‘è®€ä¾†ï¼ŒDouglas è©¦è‘—å¾å‰ä½œã€ŠJavaScript: The Good Partsã€‹æè¿°å¦‚ä½•é¿é–‹ JSçš„å‘æ“æŠ±æ­£ç¢ºçš„ JSç·¨å¯«æŠ€å·§ï¼Œåˆ°é€™æœ¬ã€ŠHow JavaScript Worksã€‹ï¼Œé‡æ–°å¸¶è®€è€…èªè­˜ JSã€å¦‚ä½•è®“ JS è®Šå¾—æ›´å¥½ -\u0026gt; å¦‚ä½•å¯«å‡ºæ›´å¥½ JS Codeï¼Œä¸¦è©¦è‘—å‚³éå‡ºè‡ªå·±çš„å¼·çƒˆåƒ¹å€¼è§€\nä¸‹å€‹ä¸–ä»£ç¨‹å¼èªè¨€çš„æ¨£è²Œ\næ˜¯çš„ï¼Œé€™æœ¬æ›¸é›·åŒæ–¼å‰ä½œï¼Œéƒ½è¡¨é”äº† Douglas å°æ–¼ JS ç·¨ç¨‹æŠ€è—çš„å¯©ç¾è§€èˆ‡åƒ¹å€¼è§€ï¼Œæ‰€ä»¥å…§å®¹æœ‰äº›å¯èƒ½æœƒèˆ‡ä¸»æµåƒ¹å€¼è§€è¡çªï¼Œå­°æ˜¯å­°éå°±è¦‹ä»è¦‹æ™ºäº†ï¼› ä½†é€™æœ¬æ›¸å¸¶çµ¦æˆ‘çš„è¡æ“Šæ˜¯å¦‚ä½•å»æ€è€ƒä¸€é–€ç¨‹å¼èªè¨€çš„è¨­è¨ˆï¼Œä»¥å¾€éƒ½åœ¨æ€è€ƒå¦‚ä½•å¯«å‡ºæ›´å¥½çš„èªæ³•è·Ÿæ¼”ç®—æ³•ï¼Œå¾æ²’æƒ³éç¨‹å¼èªè¨€çš„æœ¬èº«ä¹Ÿæ˜¯å·¥å…·ï¼Œè‡ªç„¶å°±æœ‰è¢«è¨è«–èˆ‡æ”¹é€²çš„ç©ºé–“ï¼Œè·Ÿå€‹ Douglas çš„è…³æ­¥å»æ€ç´¢ï¼Œè¦ºå¾—æ˜¯å€‹è »æ£’çš„æ€æƒ³è©¦ç…‰ï¼Œé€™æˆ–è¨±æ‰æ˜¯é€™æœ¬æ›¸æœ€æœ‰åƒ¹å€¼çš„åœ°æ–¹!\né‚£ä½ å¿ƒä¸­çš„ç¨‹å¼èªè¨€åˆæ˜¯æ€æ¨£çš„æ¨£è²Œå‘¢ï¼Ÿ\né€™æœ¬æ›¸é©åˆå° JS æœ‰ä¸€å®šèªè­˜çš„é–‹ç™¼è€…ï¼Œå¦‚æœæ˜¯æ–°æ‰‹å°±ä¸å»ºè­°é–±è®€ã€‚\nå‰è¨€ ä¸€èˆ¬çš„å·¥å…·æ›¸åœ¨å‰è¨€é€šå¸¸æ˜¯è¬›ä¸€äº› Terminology ã€å¯«ä½œç·£ç”±ã€é©åˆèª°é–±è®€ç­‰ï¼Œé€™æœ¬æ›¸ä¹Ÿä¸ä¾‹å¤–ï¼Œä½†æœ‰è¶£çš„æ˜¯ Douglas è£œå……äº†ä»–å°æŸäº›è‹±æ–‡å–®å­—é —æœ‰å¾®è©ï¼Œä¾‹å¦‚èªª oneï¼Œé€™å€‹å–®å­—é–‹é ­æ˜¯ Oï¼Œä½†ä¹Ÿå¾ˆåƒæ˜¯ 0ï¼Œä½†å…¶å¯¦ä»–è¡¨é”çš„æ˜¯ 1ï¼Œè€Œä¸”ç™¼éŸ³ /wÊŒn/ï¼Œæ–‡å­—å¤–åœ¨æ„è±¡è·Ÿå¯¦è³ªæ„ç¾©ä¸å»åˆï¼Œä¸”èˆ‡ç™¼éŸ³ä¹Ÿä¸ä¸€æ¨£ï¼Œå° Douglas ä¾†èªªé€™æ˜¯å€‹éå¸¸å·®çš„è¨­è¨ˆï¼Œæ‰€ä»¥ä»–ä¸»å¼µè¦æ”¹æˆ wunï¼Œè€Œæ•´æœ¬æ›¸çš„ one éƒ½ç”¨ wun å–ä»£ï¼ŒåŒ…å« wunceï¼› å¦ä¸€å€‹å–®å­— throughï¼Œé€™å€‹å­—æœ‰ä¸€åŠçš„å­—æ¯æ²’æœ‰ç™¼éŸ³ï¼Œæ‰€ä»¥ä»–çœç•¥ç‚º thruã€‚\nå¦ç™½èªªï¼Œä¸€é–‹å§‹çœ‹åˆ°è¦ºå¾—æœ‰é»ç„¡èŠï¼Œæƒ³èªªé€™æ˜¯æ²’äº‹æ‰¾ç¢´çš„æ¦‚å¿µå— XD ä½†çœ‹å®Œæ•´æœ¬æ›¸å¾Œï¼Œè¦ºå¾—è‡ªå·±æœç„¶é“è¡Œå¤ªæ·ºï¼ŒDouglas æƒ³è¡¨é”çš„æ˜¯\næ­£ç¢ºå‘½åå°±æ˜¯å¯«å¥½ç¨‹å¼çš„ç¬¬ä¸€æ­¥ï¼Œä¸ç•™çµ¦è‡ªå·±ä»»ä½•æ€ç¶­ä¸Šçš„æ¨¡ç³Šåœ°å¸¶\nä»»ä½•æœ‰æ¨¡ç³Šè§£é‡‹ç©ºé–“çš„åœ°æ–¹ï¼Œå°±æœƒæœ‰èª¤è§£è·ŸéŒ¯èª¤çš„ç”¢ç”Ÿï¼Œæ‰€ä»¥å¾æºé ­çš„å‘½åé–‹å§‹å°±æœçµ•é€™ç¨®å£ç¿’æ…£ï¼Œæ‰æ˜¯æ ¹æœ¬å¯«å¥½ç¨‹å¼çš„æ–¹æ³•ï¼ é€™æ¨£çš„ç²¾ç¥è²«ç©¿æ•´æœ¬æ›¸ç±ï¼Œç”¨æœ€æŒ‘å‰”çš„æ–¹å¼é‡æ–°æª¢è¦– JS çš„èªæ³•èˆ‡å¯¦ä½œè¨­è¨ˆã€‚\nHow Names Work åœ¨å‘½åä¸Šï¼ŒDouglas èªç‚ºç¨‹å¼èªè¨€æ‡‰è©²è¦æ”¯æ´ ç•¶ä½œè®Šæ•¸åç¨±çš„åˆæ³•å­—å…ƒï¼Œä½†ç›®å‰ JS æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥ä»–å»ºè­°ç”¨å°å¯«å­—æ¯é–‹é ­ä¸¦ç”¨ _ è›‡è¡Œå‘½åæ³•åˆ‡å‰²å¤šå€‹å–®å­—çš„è®Šæ•¸åç¨±ï¼› è‡³æ–¼ $ã€_ é–‹é ­å‰‡é¿å…ä½¿ç”¨ï¼Œé€™äº›æ‡‰è©²è¢«ä¿ç•™ç•¶ä½œ code generator ã€macro processor ä½¿ç”¨ã€‚\nåœ¨ JS ä¸­ï¼Œä¸€å¤§ä»¤äººå›°æƒ‘çš„åœ°æ–¹æ˜¯ function è·Ÿ constructor ç„¡æ³•å€åˆ†ï¼Œå¦‚æœ function ç”¨ new å‘¼å«å°±è®Šæˆ constructorï¼Œæ‰€ä»¥ Douglas å»ºè­° contructor ç”¨å¤§å¯«é–‹é ­ä½œç‚ºå€åˆ†ï¼Œä½†å¯ä»¥çš„è©±é€£ new éƒ½ä¸è¦ç”¨ï¼Œå¾ŒçºŒæœƒåœ¨è£œå……åšæ³•ã€‚\nHow Numbers Work é€™ä¹Ÿæ˜¯ JS å¾ˆå¸¸è¢«è©¬ç—…çš„èª¤è§£ 0.1 + 0.2 !== 0.3ï¼Œä½†å…¶å¯¦ JS æ˜¯åƒç…§ IEEE 754 å…¶ä¸­çš„é›™ç²¾åº¦æµ®é»æ•¸è¦ç¯„ï¼Œå…¶é¤˜å¦‚ Java ç­‰æ¡ç”¨åŒæ¨£çš„è¦ç¯„ä¹Ÿéƒ½æœƒæœ‰ä¸€æ¨£çš„å•é¡Œï¼Œç•¢ç«Ÿç”¨æœ‰é™çš„ bits æ€éº¼å¯èƒ½å°æ‡‰åˆ°ç„¡çª®çš„æœ‰ç†æ•¸å‘¢ï¼Œæ‰€ä»¥åœ¨ç²¾åº¦ä¸Šçš„ç¼ºé™·æ‰æœƒå°è‡´é€™æ¨£çš„çµæœã€‚\n1 è¦å°å¿ƒåˆ‡æ›å„²å­˜çš„æ•¸å€¼èˆ‡å¯¦éš›è¡¨ç¤ºçš„æ•¸å­—ï¼Œé€™å…©è€…æœƒæœ‰æ•¸å­¸å…¬å¼çš„å°æ‡‰é—œä¿‚ï¼Œä½†æ–‡å­—ä¸Šå®¹æ˜“ç”¢ç”Ÿèª¤è§£ JS åªæ”¯æ´å–®ä¸€ç¨®çš„æ•¸å­—å‹åˆ¥å°±æ˜¯ Numberï¼Œé€™æ˜¯å€‹è‰¯å¥½çš„è¨­è¨ˆï¼Œå› ç‚ºä¸éœ€è¦æ¶‰åŠæ•¸å­—å‹åˆ¥çš„è½‰æ›ï¼Œä¾‹å¦‚ int è½‰ float æˆ– double ç­‰ï¼Œåœ¨ç¾åœ¨æ©Ÿå™¨è¨˜æ†¶é«”éå¸¸å……è¶³çš„æƒ…æ³ä¸‹ï¼Œç¨‹å¼èªè¨€ä»¥é–‹ç™¼è€…å‹å–„çš„æ–¹å¼è¨­è¨ˆæœƒæ¯”è¼ƒé©åˆ\nNumber ä»¥ 64 bits å„²å­˜ï¼Œæ‹†åˆ†æˆ3å€‹éƒ¨åˆ†å„²å­˜ï¼Œsignificand æ˜¯ä»‹æ–¼ 0.5 ~ 1.0 çš„æ•¸å€¼\nsign(1) + exponent(11) + significand(52) è½‰æˆæ•¸å€¼ä»£è¡¨ (-1) ^ sign * 1.significand * 2^(exponent - 0x3ff)\nsign æ˜¯ä¸€å€‹ä½å…ƒè¡¨ç¤ºæ­£è² ï¼› exponent å‰‡æ˜¯ç”¨ 11å€‹ä½å…ƒè¡¨ç¤º 2çš„æ¬¡æ–¹å€ï¼Œç‚ºäº†è¡¨ç¤ºæ­£å€é–“åˆ°è² å€é–“æ‰€ä»¥é å®šæœ‰åå·®å€¼ (bias value 0x3ff)ï¼Œä¹Ÿå°±æ˜¯ exponent 0x000 ä»£è¡¨çš„å…¶å¯¦æ˜¯ (-1 * 0x3ff)ï¼› significand ç”¨å‰©é¤˜ 52 bit è¡¨ç¤ºï¼Œä½†å› ç‚ºæµ®é»æ•¸è¡¨ç¤ºè¡¨é”ç‚º 1.X * 2^n æ¬¡æ–¹ï¼Œå› ç‚º1å›ºå®šæœƒå­˜åœ¨ï¼Œæ‰€ä»¥å°±å¯ä»¥è¨˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œç®—æ˜¯é¡å¤–çš„ bonus bitï¼Œæ‰€ä»¥æœ€å¤§æ•¸å€¼è¡¨ç¤ºå¯ä»¥åˆ° 2^53 æ¬¡æ–¹\nå¹¾å€‹å¸¸è¦‹çš„æ•¸å­—å°æ‡‰ binary è¡¨ç¤º\n1 2 3 4 5 6 7 8 -0: 8000 0000 0000 0000 +0: 8000 0000 0000 0000 1ï¼š3ff0 0000 0000 0000 =\u0026gt; 2 ^ (0x3ff - 0x3ff) * 2^53 (åˆ¥å¿˜äº† bonus bit) = 1 æœ€å¤§æ•¸ï¼š 7fef ffff ffff ffff =\u0026gt; (2^54 -1) * 2^971 = 2 ^ (0x7fe - 0x3ff) * (2^54 - 1) ç‰¹æ®Šå­— ç„¡é™å¤§ï¼š0x7ff0 0000 0000 0000 NaNï¼š0x7ff + å¾Œé¢å‡ºç¾ä»»æ„é0çš„bitsï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ NaN !== NaN é ˆè¬¹è¨˜åªæœ‰åœ¨ Number.MAX_SAFE_INTEGER åˆ° Number.MIN_SAFE_INTEGER ä¹‹ä¸­çš„æ•´æ•¸æ‰æ˜¯ 1:1 mappingï¼Œä¹Ÿå°±æ˜¯ä¸€å€‹æ•¸å­—å°æ‡‰åˆ°ä¸€å€‹çœŸå¯¦çš„æ•¸å€¼ï¼Œåœ¨é€™å€‹å€é–“æ‰ä¿è­‰æ•¸å­¸é‹ç®—çš„æ­£ç¢ºæ€§ï¼Œè¶…éç¯„åœçš„æ•¸å€¼æœƒå–ªå¤±éƒ¨åˆ†ç²¾æº–æ€§ï¼Œä¾‹å¦‚\n1 Number.MAX_SAFE_INTEGER + 1 === Number.MAX_SAFE_INTEGER + 2 // true å¦‚æœè¦æª¢æŸ¥æ•¸å­—ï¼Œè«‹ç”¨ Number.{method}ï¼Œä¾‹å¦‚ Number.isNaNã€Number.isSafeInteger ç­‰\nHow Big Integers/Floating Point/Rationals Works å—é™æ–¼ Numberçš„ç²¾åº¦ï¼Œå¦‚æœåƒéŠ€è¡Œç³»çµ±ç­‰ä¸å®¹è¨±åŠé»å¤±çœŸçš„æ•¸å­¸é‹ç®—ï¼Œå°±å¿…é ˆè‡ªå·±é¡å¤–è™•ç†ï¼Œé€™éƒ¨åˆ† Douglas åˆ†åˆ¥å¯«äº† Big Integers / Floating Point / Rationals çš„è™•ç†ï¼ŒRationals æ˜¯æŒ‡ç”¨å…©å€‹ Big Integer ç›¸é™¤è¡¨ç¤ºçš„æ•¸å€¼ï¼Œå¯ä»¥æ›´ç²¾ç¢ºè¡¨ç¤ºæŸäº› Floating Pointï¼Œè©³ç´°å¯ä»¥çœ‹åŸå§‹ç¢¼ howjavascriptworksï¼Œæ›¸ä¸­é€™ä¸‰ç¯€éƒ½æ˜¯æ‹†è§£ç¨‹å¼ç¢¼è¬›è§£ï¼Œä½†æ˜¯æ’ç‰ˆçœ‹èµ·ä¾†æœ‰é»éº»ç…©ï¼Œä¸å¦‚è¢å¹•æ‹–æ‹‰çœ‹ä¾†å¾—æ–¹ä¾¿ã€‚\né€™é‚Š Douglas æ‹‹å‡ºä¸€å€‹è¨è«–ï¼Œä»–è¦ºå¾—å¤§æ•¸é‹ç®—ä¸æ‡‰è©²æ”¾é€²ç¨‹å¼èªè¨€çš„åŸç”Ÿæ”¯æ´ï¼Œè€Œæ˜¯è®“éœ€è¦çš„ç”¨æˆ¶è‡ªè¡Œå»æ¡ç”¨ Libraryï¼ŒJS ç”Ÿæ…‹åœˆå·²ç¶“æœ‰è‰¯å¥½ç¾è¡Œçš„è§£æ³•äº†ï¼Œå› ç‚ºç¨‹å¼èªè¨€æ‡‰è©²ç¶­æŒå°è€Œç¾ï¼Œæä¾›æœ€æ ¸å¿ƒçš„æ”¯æ´ï¼Œå…¶é¤˜çš„æ‡‰è©²æ˜¯é–‹æ”¾è®“ç”¨æˆ¶è‡ªè¡Œé¸æ“‡\nä½† BigInt å·²ç¶“åœ¨ Firefox/Chrome è©¦è¡Œäº† XD æˆ‘è‡ªå·±ä¹Ÿæ˜¯åå‘ Douglas çš„æƒ³æ³•ï¼Œç‚ºäº†å°‘éƒ¨åˆ†ç”¨æˆ¶ï¼Œè€Œè®“ JS å¾åŸæœ¬åªæœ‰ Number å¤šåŠ ä¸€å€‹æ•¸å­—å‹åˆ¥ï¼Œè¦ºå¾—æ²’æœ‰é€™éº¼å¼·çƒˆçš„å¿…è¦\nHow Booleans Work JS æ”¯æ´ Boolean å‹åˆ¥ï¼Œä¹Ÿå°±æ˜¯ typeof true / typeof false æœƒå›å‚³ booleanï¼Œä½†åœ¨æ¢ä»¶è¡¨é”å¼(if/for/\u0026amp;\u0026amp;/||ç­‰)ä¸­ï¼ŒJS æ”¯æ´ boolishï¼Œä¹Ÿå°±æ˜¯å°‡å…¶ä»–å‹åˆ¥è½‰æ›æˆ boolean å‹åˆ¥ï¼Œå°¤å…¶æ˜¯ä¸€äº›å½†æ‰­çš„ falsy å€¼ï¼Œä¾‹å¦‚ 0 / \u0026quot;\u0026quot; / undefined / null / NaNç­‰\nè‰¯å¥½çš„ç¿’æ…£æ˜¯åœ¨æ¢ä»¶è¡¨é”å¼ä¸­åªè¦ Booleanï¼Œè€Œä¸”åˆ¤æ–·å¼ç”¨ === è€Œé ==\nHow Array/Object Work Array æ˜¯ç”¨ä¾†è¡¨é”ä¸€å€‹é€£çºŒçš„è¨˜æ†¶é«”å€é–“ï¼Œä¸¦ä»¥æŸ size åˆ‡åˆ†æˆè‹¥å¹²ç­‰ä»½çš„é›†åˆï¼ŒArray åœ¨ JS ä¸­åªæ˜¯ä¸€å€‹ç‰¹æ®Šçš„ Objectï¼Œæ‰€ä»¥ typeof array === 'object'ï¼Œè¦ç¢ºå¯¦åˆ¤æ–·æ˜¯å¦ç‚ºé™£åˆ—è«‹ç”¨ Array.isArray\nåŸç”Ÿçš„ Array æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œä½†è¦æ³¨æ„ sort/reverse æ˜¯ in place ç™¼ç”Ÿï¼Œä¹Ÿå°±æ˜¯ä»–æ˜¯æ”¹è®ŠåŸArrayï¼Œç†è«–ä¸Šé€™å…©å€‹æ‡‰è©²è¦æ˜¯ pure function æ‰æ˜¯ï¼Œä½†å¯æƒœ ECMAScript ä¸¦æ²’æœ‰è¦ç¯„\né—œæ–¼ Object å¯ä»¥åˆ©ç”¨ Object Literal æ–¹å¼å‰µå»ºï¼ŒKey è¦æ¡ç”¨ Stringï¼ŒValue å¯ä»¥å…¶ä»–å‹åˆ¥åŒ…å« functionç­‰\n1 2 3 let my_obj = { ... } å¦å¤– Douglas ä¸å»ºè­°åœ¨ Object ä¸­å„²å­˜ undefinedï¼Œå› ç‚ºé€™æ¨£ç„¡æ³•å€åˆ†åˆ°åº•æ˜¯ Object ä¸å­˜åœ¨é€™å€‹ Key é‚„æ˜¯ Keyå­˜åœ¨ä½†å„²å­˜ undefined\nå› ç‚º JS æ²’æœ‰ç¹¼æ‰¿çš„æ¦‚å¿µï¼Œæˆ–æ˜¯èªªé€é Prototype Chain æ¨¡æ“¬ç¹¼æ‰¿çš„æ–¹å¼ï¼Œåœ¨ä½¿ç”¨ä¸Š Douglas å»ºè­°ç”¨ let new_object = Object.create(null)ï¼Œå› ç‚º null æ²’æœ‰ prototypeï¼Œæ‰€ä»¥å‰µå»ºçš„æ–°ç‰©ä»¶æ²’æœ‰å¤šé¤˜çš„ prototype éœ€è¦è€ƒé‡ï¼Œæ•´é«”ä¸Šæ¯”è¼ƒä¹¾æ·¨ï¼Œé‹è¡Œä¸Šä¹Ÿæ¯”è¼ƒæœ‰æ•ˆç‡ï¼› æœ€å¥½æ˜¯å†åŠ ä¸Š Object.freezeï¼Œè®“å…¶ä»–æ“ä½œè€…ç„¡æ³•ä»»æ„æ›´å‹• Object å±¬æ€§\nWeakmap æœ‰é»é¡ä¼¼æ–¼ Objectï¼Œä½†å¥½è™•æ˜¯å¯ä»¥ç”¨æ‹¿ Object reference ç•¶ä½œ Keyï¼Œå¦‚æœæœ‰äººè¦æ“ä½œå±¬æ€§å°±å¿…é ˆæœ‰ key è·Ÿ weakmapï¼Œå¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 function sealer_factory(){ const weakmap = new WeakMap(); return { sealer(object){ const box = Object.freeze(Object.create(null)); weakmap.set(box, object); return box; }, unsealer(box){ return weakmap.get(box); } } } å¯ä»¥å°‡ç‰©ä»¶å°è£è¼‰ weakmap ä¸­ï¼Œä¸¦å›å‚³ Key Object reference boxï¼Œåªæœ‰æ‹¿ weakmap è·Ÿ box æ‰èƒ½æ‹¿åˆ°ç•¶åˆå°è£çš„æ±è¥¿ã€‚\nHow Strings Work String åœ¨ JS ä¸­æ˜¯ä»¥ Immutable çš„é€£çºŒ 16 bit é™£åˆ—ï¼Œå¯ä»¥é€é String.fromCharCode ç”Ÿæˆ Stringï¼Œæ•¸å€¼ç¯„åœå¾ 0 ~ 65535ï¼› å¯ä»¥ç”¨ Array çš„æ–¹æ³•å»æ“ä½œ Stringï¼Œä¾‹å¦‚ my_string.indexOf(), my_string[0] ç­‰\nä½†ä¸–ç•Œèªè¨€ä½•å…¶å¤šç¨®ï¼Œéœ€è¦è¡¨ç¤ºçš„å­—é é ä¸æ­¢ 65536 ç¨®ï¼ŒUnicode ç·¨ç¢¼æ¨¡å¼ä¹Ÿå› æ­¤è€Œèª•ç”Ÿï¼Œç›®å‰ç¸½å…±è¦ç¯„äº†U+0000åˆ°U+10FFFF(20bits)ï¼Œå…±æœ‰1,112,064å€‹ç¢¼ä½ï¼ˆcode pointï¼‰ï¼Œç¢¼ä½ä»£è¡¨å„²å­˜çš„ä½å…ƒè¡¨ç¤ºæ–¹å¼ï¼Œå…¶ä¸€å°ä¸€è¡¨ç¤ºä¸€å€‹äººé¡é–±è®€çš„å­—å…ƒï¼› æ¥è‘—ä»¥ 65,536 ç‚ºå–®ä½ï¼Œå°‡ 1,112,064 åˆ‡å‰²æˆ 16å€‹å¹³é¢ï¼Œæ¯å€‹å¹³é¢å« 65536 å€‹ç¢¼ä½ï¼› å…¶ä¸­ç¬¬ 0 ç¢¼ä½ç¨±ç‚º BMPï¼Œä¹Ÿå°±æ˜¯åŸºç¤å¤šèªè¨€å¹³é¢ï¼Œå…¶ä»–ç¨±ç‚ºè¼”åŠ©å¹³é¢ã€‚\nUTF-16 ä»£è¡¨ç”¨ 16bits ç•¶ä½œå„²å­˜çš„æœ€å°å–®ä½ï¼Œç‚ºäº†è¦æ”¯æ´å…¨éƒ¨çš„ Unicode èªè¨€å¹³é¢ï¼ŒUTF-16æ”¹æ¡ç”¨ 2å€‹å–®ä½ä¾†å„²å­˜ä¸€å€‹ç¢¼ä½ï¼Œå°‡ 20bits åˆ‡å‰²ä¸Šä¸‹å…©å€‹ 10bitsï¼Œé«˜ä½å…ƒåŠ ä¸Š 0xD8ï¼Œä½ä½å…ƒåŠ ä¸Š 0xDC çµ„åˆ\n1 2 3 4 5 6 7 8 U+1F4A9 =\u0026gt; 0001 1111 0100 1010 0111 ----- å‰10ä½å…ƒï¼š 0001 1111 01 å¾Œ10ä½å…ƒï¼š 00 1010 0111 ----- è£œè¶³ 16 bits ä¸¦åŠ ä¸Šå°æ‡‰çš„é è¨­å€¼ 0001 1111 01 =\u0026gt; 0000 0000 0111 1101 + 0xD8 = 0xD83D 00 1010 0111 =\u0026gt; 0000 0000 1010 0111 + 0xDC = 0xDCA9 æ‰€ä»¥ U+1F4A9 åœ¨ UTF-16 å„²å­˜æ–¹å¼ç‚º 0xD83D 0xDCA9 UTF-16 åªæ˜¯ Unicode å¯¦éš›å„²å­˜æ–¹å¼çš„ä¸€ç¨®å¯¦ä½œï¼ŒåŒ…å«å¸¸è¦‹çš„ UTF-8 ä¹Ÿæ˜¯æŒ‡å¯¦ä½œæ–¹å¼\nåœ¨ JS ä¸­ï¼Œè¦è¡¨é” Unicode å¯ä»¥ç”¨\n1 2 3 4 5 \u0026#34;\\uD83D\\uDCA9\u0026#34; === \u0026#34;\\u{1F4A9}\u0026#34; //æˆ–æ˜¯ String.formCharCode(55357, 56489) === String.fromCharCode(128169) How Generators Work Douglas èªç‚º Generator æ˜¯å€‹å¥½æ±è¥¿ï¼Œä½†æ˜¯ JS å¯¦ä½œçš„å¤ªç³Ÿäº†ï¼Œä»–èªç‚ºåŸæœ¬çš„ JS å°±å¯ä»¥ç”¨ Closure å¯¦ä½œ Generatorï¼Œä½¿ç”¨ä¸Šç”¨åŸæœ¬çš„ Function è¡¨é”å¯ä»¥æ›´æ¸…æ¥šï¼› è€Œ JS å¾Œä¾†å°å…¥çš„ Generator åœ¨å‘½åä¸Šã€ç”¨æˆ¶æ“ä½œä¸Šéƒ½ä¸æ…ç†æƒ³ï¼Œå¯ä»¥å¾è¨€èªä¸­çœ‹å‡ºçš„ä»–ä¸å±‘èˆ‡æ†¤æ€’ XD\né€™æ˜¯æˆ‘å°‘æ•¸å®Œå…¨èªåŒçš„ç« ç¯€ï¼Œç›´æ¥çœ‹ç¨‹å¼ç¢¼æ¯”è¼ƒå¿« ä»¥ä¸‹æ˜¯ JS æ¨™æº–çš„ Generator\n1 2 3 4 5 6 7 8 9 10 11 12 function* counter(){ let count = 0; while(true){ count += 1; yield count; } } const gen = counter(); gen.next().value; gen.next().value; gen.next().value; ä»¥ä¸‹æ˜¯ Douglas èªç‚ºä¸ç”¨ standard ç·¨å¯«çš„ Generator\n1 2 3 4 5 6 7 8 9 10 11 12 function counter(){ let count = 0; return function counter_generator(){ count += 1; return count; } } const gen = counter(); gen() gen() gen() å¾å¹¾å€‹åœ°æ–¹å»çœ‹å‡ºç‚ºä»€éº¼ Standard Generator æ˜¯ç³Ÿç³•çš„èªè¨€è¨­è¨ˆ\nå½†æ‰­çš„å‘½å åœ¨ JS ä¸­ï¼Œfunction æ˜¯ first class citizenï¼Œå¤§å®¶ä¹Ÿéƒ½éå¸¸ç†Ÿæ‚‰æ–¼ High order functionï¼Œå°‡ function ç•¶ä½œåƒæ•¸æˆ–å›å‚³å€¼ä½¿ç”¨ï¼› ä»Šå¤© Standard Generator æ˜¯åœ¨ function å¾ŒåŠ å…¥ * æ¨™è¨˜ï¼Œä½†å…¶è¡Œç‚ºåˆè·Ÿ function ä¸åŒï¼Œä¾‹å¦‚ function æ˜¯ç”¨ return å›å‚³å€¼ï¼Œä½†æ˜¯ Generator æ˜¯ç”¨ yeild åå‘ OOP è¨­è¨ˆè€Œé FP ç•¶ç„¶è¦èµ° FP æˆ– OOP æ¯”è¼ƒåƒæ˜¯å€‹äººåå¥½ï¼Œä½†ä¾æ“š Standard Generatorï¼Œä½¿ç”¨ä¸Šå¿…é ˆå®£å‘Š while(true) ä¸¦æ­é… yeild å¯¦ä½œï¼ŒDouglas èªç‚ºæ‡‰è©²è¦ç›¡é‡æ¸›å°‘ Loop çš„ä½¿ç”¨ å›å‚³å€¼çš„æ“ä½œ ç”¨ Standard Generator åˆå§‹åŒ–å¾Œï¼Œè¦å‘¼å«ä¸‹ä¸€å€‹å€¼å¿…é ˆç”¨ gen.next().value å›åˆ°é¡ä¼¼ç¬¬ä¸€é»çš„è¨­è¨ˆéŒ¯èª¤ï¼Œä¸€å€‹ Generator Function æ²’æœ‰é¡¯ç¤º return çš„å€¼ï¼Œå±…ç„¶æ˜¯ä»¥ä¸€å€‹ç‰©ä»¶çš„å½¢å¼ï¼Œå‘¼å«å…¶ next functionï¼Œè€Œä¸”é‚„è¦åŠ ä¸Š .valueï¼Œé€™è¡¨é”çš„æ–¹å¼å¯¦åœ¨æ˜¯å¾ˆæ€ªç•°ï¼Œé é ä¸å¦‚ gen() ä¾†å¾—ç›´æ¥æ˜ç­ã€‚ Standard Generator è¢«æ‰¹è©•çš„å¾ˆå¾¹åº•ï¼Œä½†ç¢ºå¯¦ Douglas è¬›å¾—ä¹Ÿå¾ˆæœ‰é“ç†ï¼Œå¦‚æœæœ‰äººçœ‹éè³‡æ–™æˆ–æœ‰ä¸åŒçš„æ„è¦‹ï¼Œæ­¡è¿äº¤æµï½ æˆ‘ä¹Ÿå¾ˆå¥½å¥‡å…¶ä»–äººæˆ–æ˜¯ç•¶åˆèªè¨€æ¨™æº–åˆ¶å®šæ™‚æ˜¯å¦‚ä½•è©•é‡çš„\næ¥è‘— Douglas åˆ†äº«ä»–ä¸€å¥— Generator çš„çµ„åˆæŠ€ï¼Œé‚„è »å²å®³çš„ï¼Œæœ‰èˆˆè¶£å¯ä»¥å»æ›¸åº—ç¿»é–±ï¼Œé€™éƒ¨åˆ†ç¨‹å¼ç¢¼æ²’æœ‰è¢«æ”¾åˆ° Github ä¸Šã€‚\nHow Exceptions Work Exception æ¯”è¼ƒåå‘æŒ‡æ„å¤–ï¼Œä½†æ˜¯åœ¨ä¸€èˆ¬çš„ç³»çµ±è¨­è¨ˆå¸¸å¸¸æœƒæŠŠéŒ¯èª¤( Error )èˆ‡æ„å¤–æ··ç‚ºä¸€è«‡ï¼Œä¾‹å¦‚èªªæŸ¥è©¢æª”æ¡ˆæ™‚å¦‚æœæª”æ¡ˆä¸å­˜åœ¨ï¼Œé€™æ‡‰è©²æ˜¯å¯ä»¥è¢«é æœŸçš„éŒ¯èª¤ï¼Œæ‡‰è©²è¦ä¸€èˆ¬çš„æµç¨‹è™•ç†ï¼Œä½†æˆ‘å€‘é‚„æ˜¯æœƒç”¨ try catch ä¾†å‚³éé€™æ¨£å¯è¢«é æœŸçš„éŒ¯èª¤\nåœ¨ JS ä¸­ï¼ŒéŒ¯èª¤æ‹‹å‡ºä½¿ç”¨ throwï¼Œthrow å¯ä»¥æ­é…å„ç¨®å‹åˆ¥çš„å€¼ï¼Œä½¿ç”¨ä¸Šæœ€ç°¡å–®å°±ç”¨ Stringï¼Œæœ‰Error Object ä½†æ²’æœ‰å¤ªå¼·ä½¿ç”¨çš„å¿…è¦ï¼› åœ¨ Compile éç¨‹ä¸­ï¼Œæ¯å€‹ function éƒ½æœ‰ä¸€å€‹ catchmapï¼Œå¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œæœƒä¾åºå¾å‘¼å«çš„ function é–‹å§‹æ‰¾ catch æ©Ÿåˆ¶ï¼Œå¦‚æœæ²’æœ‰å‰‡æŒçºŒå¾€ä¸Šæ‰¾ caller\nä½¿ç”¨ try catch æœƒæœ‰å€‹å®‰å…¨é¢¨éšªæ˜¯å‡ä½¿ä½¿ç”¨å…©å€‹å¤–éƒ¨çš„ module A/Bï¼ŒA æœ‰ç¶²è·¯å­˜å–çš„åŠŸèƒ½ï¼Œè€Œ B ç”¨æ–¼å…§éƒ¨çš„åŠ è§£å¯†é‹ç®—ï¼Œå‡ä½¿æŸå¤©æˆ‘å€‘åœ¨èª¿ç”¨æ˜¯ç”¨ B è§£å¯†å¾Œå†å°‡å€¼å‚³çµ¦ A èµ°ç¶²è·¯å‚³è¼¸ï¼Œå‡ä½¿B æ‹‹å‡ºéŒ¯èª¤ throw private_key è€Œ A æœ‰è¨»å†Š catch æ„å¤–æ•ç²é€™å€‹éŒ¯èª¤ï¼Œé‚£å°±æœƒæœ‰è³‡å®‰ç–‘æ…®çš„é¢¨éšªäº†\n","date":"2019-10-02T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2019/2019-10-02-how-javascript-works%E8%AE%80%E5%BE%8C%E6%95%B4%E7%90%86-%E4%B8%8A/","title":"ã€ŠHow Javascript Worksã€‹è®€å¾Œæ•´ç† ä¸Š"},{"content":"ä»‹ç´¹ SDP æ˜¯ä¸€ç¨®æ¨™æº–åŒ–çš„è³‡è¨Šå‚³é”æ–¹å¼ï¼Œç”¨ä¾†è¡¨é”å¤šåª’é«”çš„å…§å®¹ã€å‚³è¼¸çš„ä½å€åŠå…¶ä»–å‚³éæ‰€éœ€çš„ metadataï¼Œä¸»è¦æ‡‰ç”¨å ´æ™¯æ–¼å¤šåª’é«”å‚³è¼¸çš„å‰ç½®æºé€šï¼Œä¾‹å¦‚èªªè¦–è¨Šæœƒè­°ã€VoIP(Voice over IP) é€šè©±ã€å½±éŸ³ä¸²æµç­‰æœƒè©±(Session) åœ¨è¦ç¯„ä¸­ä¸¦æ²’æœ‰å®šç¾© SDP è©²æ€éº¼è¢«å‚³è¼¸ï¼Œå¯ä»¥è‡ªç”±é¸ç”¨ HTTP / XMPP / RTSP / Email ç­‰å‚³è¼¸å”å®šç­‰\n\u0008# åè©å®šç¾©\nConference: å…©å€‹ä»¥ä¸Šçš„ç”¨æˆ¶æ­£åœ¨ç›¸äº’é€šä¿¡çš„é›†åˆ Session: æœ‰ä¸€å€‹ç™¼é€è€…ï¼Œä¸€å€‹æ¥æ”¶è€…ï¼Œå…©è€…é–“å»ºç«‹ä¸€æ¢å¤šåª’é«”ä¸²æµçš„é€šé“ï¼Œè³‡æ–™ç”±ç™¼é€è€…å¯„ç™¼åˆ°æ¥æ”¶è€… Session Descriptionï¼š è®“å…¶ä»–äººå¯ä»¥æˆåŠŸåŠ å…¥ Conference çš„è³‡è¨Š è¦æ±‚èˆ‡å»ºè­° SDP ä¸»è¦åŠŸç”¨ç‚ºå‚³éå¤šåª’é«”æœƒè©±ä¸­å¤šåª’é«”ä¸²æµçš„è³‡è¨Šï¼Œæºé€šæœƒè©±çš„å­˜åœ¨ / åŠè®“å…¶ä»–éåƒèˆ‡è€…çŸ¥é“å¦‚ä½•åŠ å…¥æ­¤æœƒè©±(ä¸»è¦ç”¨æ–¼å»£æ’­ multicast)ï¼Œå…§å®¹å¤§æ¦‚åˆ†æˆå¹¾å€‹\nåç¨±è·Ÿç›®çš„ æœƒè©±æœ‰æ•ˆçš„æ™‚é–“ æœƒè©±ä¸­æ¶µè“‹çš„å¤šåª’é«” è¦å¦‚ä½•æ¥æ”¶ä¸²æµçš„è³‡è¨Š (å¦‚ ä½å€ã€Portã€æ ¼å¼ç­‰) æœƒè©±éœ€è¦çš„å¸¶å¯¬è³‡è¨Š å€‹äººçš„è¯çµ¡è³‡æ–™ åª’é«”èˆ‡å‚³è¼¸è³‡è¨Š é€™éƒ¨åˆ†åŒ…å«äº†\nåª’é«”å½¢å¼ (å½±ç‰‡ã€è²éŸ³ç­‰) å‚³è¼¸å”å®š (RTP/UDP/IPç­‰) åª’é«”æ ¼å¼ (H. 264/MPEGç­‰) å¦å¤–é‚„æœƒåŒ…å«ä½å€èˆ‡åŸ å£çš„è³‡è¨Šï¼ŒSDP å‚³è¼¸å½¢å¼åŒ…å«å–®æ’­(unicast)è·Ÿå¤šæ’­(multicast)ï¼Œå¤šæ’­å‰‡åŒ…å«å¤šæ’­çš„ç¾¤çµ„ä½å€ï¼Œå–®æ’­å‰‡æ˜¯å–®ä¸€å°çš„ä½å€\næ™‚é–“è³‡è¨Š ä»»æ„æ•¸é‡çš„é–‹å§‹èˆ‡çµæŸæ™‚é–“çµ„åˆ é€±æœŸæ€§è¡¨ç¤º (å¦‚æ¯é€±ä¸‰æ—©ä¸Šåé»ä¸€å°æ™‚) æ™‚é–“è¡¨ç¤ºæ˜¯å…¨çƒçµ±ä¸€æ ¼å¼ï¼Œä¸åŒ…å«æ™‚å€æˆ–æ˜¯æ—¥å…‰ç¯€ç´„æ™‚é–“ ç§äººæœƒè©± SDP æœ¬èº«ä¸æ¶‰åŠ public æˆ– private sessionï¼Œå¦‚æœéœ€è¦åŠ å¯†æˆ–æ˜¯é™å®šï¼Œå‰‡åœ¨å‚³è¼¸æ™‚è‡ªè¡Œæ±ºå®š\nå…¶ä»– SDP æœ¬èº«å°±æ‡‰è©²å¤¾å¸¶è¶³å¤ çš„è³‡è¨Šè®“åƒèˆ‡è€…çŸ¥é“æ˜¯å¦è©²åŠ å…¥ sessionï¼Œä½†å¦‚æœæœ‰å…¶ä»–é¡å¤–è³‡è¨Šè¦å¤¾å¸¶ï¼Œå¯ä»¥æ”¾åœ¨å¦å¤–çš„ URI ä¸­ï¼›\nSDP Spec æ–‡å­—ç·¨ç¢¼ä¸Šï¼ŒSDP æ¡ç”¨ ISO 10646 å­—ç¬¦é›†ä¸¦ç”¨ UTF-8 ç·¨ç¢¼æ–¹å¼ï¼Œä½†æ˜¯åœ¨å±¬æ€§/æ¬„ä½ä¸Šæ¡ç”¨ UTF-8 çš„å­é›†åˆ US-ASCIIï¼Œåªæœ‰åœ¨æ–‡å­—æ¬„ä½å¯ä»¥ä½¿ç”¨å®Œæ•´çš„ ISO 10646 å­—ç¬¦é›†\nSDP æ˜¯ç”±é€™æ¨£æ ¼å¼çš„æ–‡å­—çµ„æˆ\n\u0026lt;type\u0026gt;=\u0026lt;value\u0026gt;\ntype å¿…é ˆæ˜¯å–®ä¸€å€‹å¤§å°å¯«å€åˆ†çš„å­—å…ƒï¼› value å‰‡æ˜¯ç›¸å°æ‡‰æœ‰çµæ§‹çš„æ–‡å­—ï¼Œå¤šå€‹å€¼å¯ä»¥ç”¨ç©ºç™½åˆ†éš”ï¼› åˆ‡è¨˜åœ¨ = å…©å´ä¸å¯ä»¥æœ‰ç©ºç™½\nSDP ä¸­åŒ…å«äº† session-level å€æ®µèˆ‡å¤šå€‹ media-level å€æ®µï¼Œsession-level å€æ®µä»¥ v= é–‹å§‹ï¼Œå…¶å±¬æ€§å¥—ç”¨åœ¨æ‰€æœ‰çš„ media å€æ®µä¸Šï¼Œä½†å¦‚æœ media å€æ®µæœ‰ç›¸åŒå±¬æ€§å‰‡æœƒè¢«è¦†è“‹ï¼› è€Œ media-level å‰‡æ˜¯ m=é–‹å§‹ç›´åˆ°ä¸‹ä¸€å€‹ media level å€æ®µé–‹å§‹\nåœ¨ SDP å®šç¾©çš„é †åºå¾ˆé‡è¦ï¼Œä¸»è¦æ˜¯å¹«åŠ©æ›´å¿«çš„éŒ¯èª¤åµæ¸¬èˆ‡å®¹æ˜“å¯¦ä½œ parser\næœ‰äº›æ¬„ä½æ˜¯å¿…å¡«æœ‰äº›æ˜¯é¸æ“‡æ€§ï¼Œä½†é‡é»æ˜¯ä¸€å®šè¦æŒ‰ç…§é †åºï¼Œé¸æ“‡æ€§æ¬„ä½ä»¥ * è¨»è¨˜ï¼Œå±¬æ€§æ¬„ä½å¤§è‡´ä»‹ç´¹å«ç¾©ï¼Œä¸æœƒå®Œæ•´ä»‹ç´¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Session description v= (protocol version) o= (originator and session identifier) s= (session name) i=* (session information) u=* (URI of description) e=* (email address) p=* (phone number) c=* (connection information -- not required if included in all media) b=* (zero or more bandwidth information lines) One or more time descriptions (\u0026#34;t=\u0026#34; and \u0026#34;r=\u0026#34; lines; see below) z=* (time zone adjustments) k=* (encryption key) a=* (zero or more session attribute lines) Zero or more media descriptions Time description t= (time the session is active) r=* (zero or more repeat times) Media description, if present m= (media name and transport address) i=* (media title) c=* (connection information -- optional if included at session level) b=* (zero or more bandwidth information lines) k=* (encryption key) a=* (zero or more media attribute lines a= å±¬æ€§æ©Ÿåˆ¶ä¸»è¦æ˜¯æ“´å±• SDPï¼Œç”±å„å€‹ä½¿ç”¨ SDP çš„å”å®šå»ä½¿ç”¨ æœ‰äº›å±¬æ€§æœ‰åˆ¶å¼çš„å«ç¾©ï¼Œæœ‰äº›å‰‡åŸºæ–¼æ‡‰ç”¨ç¨‹å¼çš„è§£è®€ï¼Œä¾‹å¦‚\næœ‰äº›å®šç¾©åœ¨ Session-level çš„å±¬æ€§å¦‚ é€£ç·šç›¸é—œ c= æˆ–æ˜¯å±¬æ€§ç›¸é—œ a= æœƒå¥—ç”¨åœ¨ Session åº•ä¸‹æ‰€ä»¥çš„ Mediaï¼Œé™¤éè¢«ç‰¹åˆ¥æŒ‡å®šè¦†å¯«\nå¦‚ä»¥ä¸‹ç¯„ä¾‹ï¼Œæ‰€æœ‰çš„ media éƒ½æœƒè¢«å† ä¸Š recvonly çš„å±¬æ€§\n1 2 3 4 5 6 7 8 9 10 11 12 v= 0 o=jdoe 2890844526 2890842807 IN IP4 10.47.16.5 s=SDP Seminar i=A Seminar on the session description protocol u=http://www.example.com/seminars/sdp.pdf e=j.doe@example.com (Jane Doe) c=IN IP4 224.2.17.12/127 t=2873397496 2873404696 a=recvonly m=audio 49170 RTP/AVP 0 m=video 51372 RTP/AVP 99 a=rtpmap:99 h263-1998/900000 æ–‡å­—æ¬„ä½å¦‚ session åç¨±å’Œè³‡è¨Šç­‰å¯ä»¥æ˜¯åŒ…å«ä»»æ„ä½å…ƒçµ„çš„å­—ä¸²é™¤äº†ä»¥ä¸‹ 0x00 Nul ã€ 0x0a (new line) ã€ 0x0d (carriage return) ï¼› å­—ä¸²ä»¥ CRLF(0x0d0a) ç•¶ä½œæ–·è¡Œï¼Œä½† parser ä¹Ÿæ‡‰è©²å°‡ newline è¦–ç‚ºæ–·è¡Œçš„æ¨™èªŒï¼› å¦‚æœæ²’æœ‰ a=charset å±¬æ€§æŒ‡å®šå­—ç¬¦é›†ï¼Œå‰‡é è¨­ç‚º ISO-10646 å­—ç¬¦é›†æ­é… UTF-8 ç·¨ç¢¼æ–¹å¼\nå¦‚æœæ˜¯åŒ…å« domain nameï¼Œå‰‡å¿…é ˆç¢ºä¿ç¬¦åˆ ASCII Compatible Encoding (ACE)ï¼Œä¹Ÿå°±æ˜¯è¦ç¶“éç·¨ç¢¼è·³è„«å­—å…ƒï¼Œå› ç‚ºæœ‰äº› SDP ç›¸é—œå”å®šå®šç¾©æ—©æ–¼åœ‹éš›åŒ– domain nameï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ UTF-8 è¡¨ç¤º\næ¬„ä½ä»‹ç´¹\nå”å®šç‰ˆæœ¬ (v=) æ²’æœ‰å…¶ä»–ç‰ˆæœ¬è™Ÿï¼Œå°±æ˜¯ v=0\nä¾†æº (o=) æè¿°Session çš„ç™¼èµ·è€…è³‡æ–™\n1 o=\u0026lt;username\u0026gt; \u0026lt;sess-id\u0026gt; \u0026lt;sess-version\u0026gt; \u0026lt;nettype\u0026gt; \u0026lt;addrtype\u0026gt;\u0026lt;unicast-address\u0026gt; sess-idï¼šæ•¸å­—çµ„æˆçš„å­—ä¸²ï¼Œç”± å››è€…çµ„æˆçš„å­—ä¸²å¿…é ˆæ˜¯å…¨åŸŸå”¯ä¸€çš„ (globally unique)ï¼Œsess-id çš„ç”¢ç”Ÿå¯è‡ªè¡Œå®šç¾©ï¼Œä½†å»ºè­°æ¡ç”¨ NTP æ ¼å¼çš„ timestamp ä¿è­‰å”¯ä¸€æ€§ sess-versionï¼šæ­¤ Session æè¿°çš„ç‰ˆè™Ÿï¼Œåœ¨æ”¹è®Š SDP å…§å®¹æ™‚ç¢ºä¿ç‰ˆè™Ÿæ˜¯éå¢çš„ï¼ŒåŒæ¨£å»ºè­°ç”¨ NTP æ ¼å¼ timestamp nettypeï¼šæ¡ç”¨ç¶²è·¯é¡å‹ addrtypeï¼šæŒ‡å®š address çš„é¡å‹ï¼Œä¾‹å¦‚ IP4 / IP6 ç­‰ unicast-addressï¼š å‰µå»º session æ©Ÿå™¨çš„ä½å€ï¼Œå¯ä»¥æ˜¯ domain name æˆ–æ˜¯ IP è¡¨ç¤ºæ³•ï¼Œä¸å¯ä½¿ç”¨ local ip å› ç‚ºä¸ç¢ºå®šå°æ–¹æ˜¯å¦åœ¨ local ç¯„åœå…§ å¦‚æœæœ‰éš±ç§å•é¡Œï¼Œ username / unicast-address å¯ä»¥è¢«æ··æ·†ï¼Œåªè¦ä¸å½±éŸ¿å…¨åŸŸå”¯ä¸€æ€§\nSession åç¨± (s=) æ–‡å­—æ¬„ä½ï¼Œè¡¨ç¤º Session åç¨±ï¼Œæ¯ä»½ Session description ä¸­åªèƒ½æœ‰ä¸€å€‹ï¼Œä¸èƒ½ç‚ºç©ºå€¼ä¸”å¿…é ˆæ¡ç”¨ ISO-10646 å­—å…ƒ (é™¤éæœ‰å¦å¤–æŒ‡å®šå­—ç¬¦é›†)ï¼Œå¦‚æœæ²’æœ‰è¦ç‰¹åˆ¥æŒ‡å®š Session åç¨±ï¼Œå¯ä»¥ç”¨ç©ºç™½ä»£æ›¿å¦‚ (s= )\nSession è³‡è¨Š (i=) æ–‡å­—æ¬„ä½ï¼Œæ¯ä»½ session description ä¸­æ¯å€‹ session æœ€å¤šåªèƒ½æœ‰ä¸€å€‹ï¼Œæ¯å€‹ media æœ€å¤šä¹Ÿåªèƒ½å®£å‘Šä¸€å€‹ï¼› é€™è³‡è¨Šä¸»è¦æ˜¯å¯«çµ¦äººé¡é–±è®€çš„ï¼Œç”¨ä¾†è¡¨ç¤º session æˆ–æ˜¯ media stream çš„ç”¨è™•\nURI (u=) é¸æ“‡æ€§æ¬„ä½ï¼Œç”¨ä¾†è¡¨ç¤ºé—œæ–¼Sessioné¡å¤–è³‡è¨Šçš„ä½å€é€£çµï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€å€‹ï¼Œå¿…é ˆæ”¾ç½®åœ¨ media æ¬„ä½ä¹‹å‰\nEmail åŠé›»è©±è™Ÿç¢¼ (e= , p=) è¯çµ¡äººçš„ email è·Ÿé›»è©±è™Ÿç¢¼\né€£ç·šè³‡è¨Š (â€œc=â€œ) c=\u0026lt;nettype\u0026gt; \u0026lt;addrtype\u0026gt; \u0026lt;connection-address\u0026gt; ä¸€ä»½ session description å¿…é ˆåŒ…å«ä¸€å€‹æˆ–æ˜¯ media description è‡³å°‘ä¸€å€‹\nnettypeï¼š æ¡ç”¨ç¶²è·¯é¡å‹ï¼ŒIN è¡¨ç¤º internetï¼Œä½†æœªä¾†å¯èƒ½æœ‰å…¶ä»–çš„æ”¯æ´ addrtypeï¼š ä½å€é¡å‹ï¼Œå¯ä»¥æ˜¯é IP å®¶æ—çš„ connection addressï¼š ä¾æ“šä½å€é¡å‹ï¼Œé¡¯ç¤ºä¸åŒçš„æ ¼å¼ å¦‚æœæ˜¯æ‡‰ç”¨åœ¨å¤šæ’­çš„å ´æ™¯ä¸‹ï¼ŒIPv4 éœ€è¦åœ¨ç¶²å€å¾ŒåŠ ä¸Š TTLï¼Œè€Œ IPv6 æ²’æœ‰ TTL çš„æ¦‚å¿µ åœ¨éšå±¤å¼çš„ç·¨ç¢¼ä¸‹ï¼Œè³‡æ–™ä¸²æµå¯èƒ½è¢«ä¾ç…§ä¸åŒé »å¯¬æ‹†åˆ†æˆä¸åŒçš„ä¾†æºï¼Œå¯ä»¥åœ¨ä½å€åŠ ä¸Šä¾†æºæ•¸é‡ï¼ŒIP ä½ç½®æœƒä»¥é€£çºŒçš„æ–¹å¼å‘ˆç¾ ä¾‹å¦‚èªª\n1 2 3 4 5 6 c=IN IP4 224.2.1.1/127/3 é€™ç­‰åŒæ–¼åœ¨ media description ä¸­å¦‚æ­¤è¡¨ç¤º c=IN IP4 224.2.1.1/127 c=IN IP4 224.2.1.2/127 c=IN IP4 224.2.1.3/127 é »å¯¬ (b=) é¡¯ç¤ºé è¨ˆä½¿ç”¨çš„é »å¯¬ï¼Œæ ¹æ“šä¸åŒçš„ bwtype æœ‰ä¸åŒå«æ„ b=\u0026lt;bwtype\u0026gt;:\u0026lt;bandwidth\u0026gt;\nCTï¼šconference total å…¨éƒ¨ Conference å¸¶å¯¬ä¸Šé™ï¼Œå¯èƒ½ä¸€å€‹ Conference åŒ…å«å¤šå€‹ sessionï¼Œå‰‡å»ºè­°æ‰€æœ‰ session ä½¿ç”¨çš„å¸¶å¯¬åŠ ç¸½åˆ ASï¼šapplication specifivc Timing (t=) t=\u0026lt;start-time\u0026gt; \u0026lt;stop-time\u0026gt; è¡¨ç¤º Session çš„é–‹å§‹çµæŸæ™‚é–“ å¦‚æœæ²’æœ‰æŒ‡å®š stop-timeï¼Œå‰‡ Session ç‚º unboundedï¼Œè¡¨ç¤ºåœ¨ start-time ä¹‹å¾Œ Session ä¸€ç›´ä¿æŒæ´»èº å¦‚æœé€£ start-time ä¹Ÿæ²’æŒ‡å®šï¼Œå‰‡è¡¨ç¤º Session æ˜¯æ°¸ä¹…å­˜åœ¨\nå»ºè­°ä¸è¦æ¡ç”¨ unbounded Sessionï¼Œå› ç‚º client ä¸çŸ¥é“ Session ä½•æ™‚çµæŸï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•æ’ç¨‹\né‡è¤‡æ¬¡æ•¸ (r=) r=\u0026lt;repeat interval\u0026gt; \u0026lt;active duration\u0026gt; \u0026lt;offsets from start-time\u0026gt; é€™æœƒæ­é… t åšä½¿ç”¨ï¼Œä¾‹å¦‚èªªä¸€å€‹ç¯€ç›®æ˜¯æ¯æ¬¡æ’­æ”¾ä¸€å°æ™‚ï¼Œæ–¼é€±ä¸€ 10am é–‹æ’­ï¼Œæ¥è‘—æ¯é€±äºŒ 11am æ¯é€±æ’­æ”¾æŒçºŒä¸‰å€‹æœˆï¼Œå‰‡è¡¨ç¤ºæ³•ç‚º\n1 2 3 4 t=3034423619 3042462419 r=604800 3600 0 90000 // æˆ–é€™æ¨£è¡¨ç¤º r=7d 1h 0 25h 3034423619 æ˜¯é–‹å§‹æ™‚é–“ï¼Œä¹Ÿå°±æ˜¯æŸé€±ä¸€ 10am 3042462419 æ˜¯çµæŸæ™‚é–“ï¼Œä¹Ÿå°±æ˜¯é–‹æ’­ä¸‰å€‹æœˆå¾Œçš„é€±äºŒ 11am\n7d æ˜¯æ’­æ”¾é–“éš”ï¼Œæ‰€ä»¥æ˜¯ 7å¤©çš„ç§’æ•¸ 1h æ˜¯æ’­æ”¾çš„æ™‚é•· 0 25h æ˜¯è·é›¢ start time çš„æ™‚é–“é–“éš”ï¼Œä¹Ÿå°±æ˜¯(é€±äºŒ 11am - é€±ä¸€ 10am)\nå¦‚æœæ˜¯ä»¥æœˆæˆ–å¹´é‡è¤‡çš„æ’­æ”¾ï¼Œå‰‡ä¸èƒ½ä½¿ç”¨ r è¡¨ç¤ºï¼Œéœ€è¦æ”¹ç”¨å¤šå€‹çš„ t è¡¨ç¤ºæ’­æ”¾æ™‚é–“\næ™‚å€ (z=) é€™æ¬„ä½æœƒå½±éŸ¿ t è·Ÿ r z=\u0026lt;adjustment time\u0026gt; \u0026lt;offset\u0026gt; \u0026lt;adjustment time\u0026gt; \u0026lt;offset\u0026gt; .... å¦‚æœæ˜¯ä¸€å€‹é‡è¤‡æ’­æ”¾çš„ Sessionï¼Œå¯èƒ½æœƒé‡åˆ°æ—¥å…‰ç¯€ç´„æ—¥ï¼Œæ‰€ä»¥è¦ä¸»å‹•æ¸›å»ä¸€å°æ™‚ï¼Œåˆå› ç‚ºä¸åŒçš„åœ‹å®¶èˆ‡åœ°å€å°æ–¼æ—¥å…‰ç¯€ç´„æ—¥çš„è¨ˆç®—ä¸åŒï¼Œæ‰€ä»¥ä¿ç•™è¡¨ç¤ºçš„å½ˆæ€§ï¼Œå¦‚ z=2882844526 -1h 2898848070 0 åœ¨é‡è¤‡æ’­æ”¾æ™‚é–“æ˜¯ 2882844526 è¦æ¸›å»ä¸€å°æ™‚ï¼Œä½†æ˜¯åœ¨ 2898848070 å°±æ¢å¾©æ­£å¸¸\nåŠ å¯†é‡‘é‘° (k=) å¦‚æœ SDP æ˜¯åœ¨å·²å®‰å…¨ä»¥åŠå¯è¢«ä¿¡ä»»çš„æ–¹å¼å‚³éä¸‹ï¼Œå¯ä»¥è€ƒæ…®å‚³éåŠ å¯†çš„é‡‘é‘°(åŠ å¯† media stream è€Œé session description æœ¬èº«)ï¼Œé€™å€‹æ¬„ä½ä¸å‚³é”åŠ å¯†çš„æ¼”ç®—æ³•ã€é‡‘é‘°é¡å‹ç­‰ï¼Œé€™äº›å…¨ç•™çµ¦æ¡ç”¨ SDPçš„å”å®šå»è¦ç¯„\nç›®å‰æ”¯æ´ä»¥ä¸‹å¹¾ç¨®å®šç¾©\nk=clear:\u0026lt;encryption key\u0026gt;ï¼škey æ²’æœ‰æ”¹è®Šé k=base64:\u0026lt;encoded encryption key\u0026gt;ï¼šç”¨ base64 å°‡ key ç·¨ç¢¼ k=uri:\u0026lt;URI to obtain key\u0026gt;ï¼šæŒ‡åå» URI æ‹¿ keyï¼Œé€šå¸¸ URI æœƒèµ°å®‰å…¨é€šé“ï¼Œä¾‹å¦‚ HTTPS ç­‰ k=promptï¼šé›–ç„¶ Session æœ‰åŠ å¯†ä½†æ˜¯ session description æ²’æœ‰æä¾› keyï¼Œç”¨æˆ¶è¦é¡å¤–å»ç´¢å– å†æ¬¡å¼·èª¿ SDP æœ¬èº«è¦æ˜¯åœ¨å®‰å…¨çš„æƒ…æ³ä¸‹æ‰èƒ½åŠ  k æ¬„ä½\nå±¬æ€§ (a=) 1 2 a=\u0026lt;attribute\u0026gt; a=\u0026lt;attribute\u0026gt;:\u0026lt;value\u0026gt; å±¬æ€§å€¼ä¸»è¦ç”¨ä¾†æ“´å±• SDPï¼Œå¯ä»¥ç”¨åœ¨ session level è£œå……å° conference çš„è³‡è¨Šï¼Œä¹Ÿå¯æ”¾åœ¨ media level å‚³é media stream çš„è³‡è¨Šï¼Œåœ¨ SDP æœƒæœ‰è‹¥å¹²çš„å±¬æ€§å€¼å®£å‘Š\nå±¬æ€§å€¼æœ‰å…©ç¨®å®£å‘Šæ–¹å¼\nFlagæ¦‚å¿µ (a=)ï¼Œä¾‹å¦‚ a=recvonly éµå€¼ (a=:)ï¼Œå¦‚ a=orient:landscape è‡³æ–¼å¦‚ä½•è™•ç†èˆ‡å®šç¾©å±¬æ€§å€¼ï¼Œæœ‰äº›å±¬æ€§æœ‰å®šç¾©çš„å«ç¾©ï¼Œå…¶é¤˜å‰‡æ‡‰ç”¨ç¨‹å¼å¯ä»¥å½ˆæ€§è™•ç†\nmedia description (m=) 1 m=\u0026lt;media\u0026gt; \u0026lt;port\u0026gt; \u0026lt;proto\u0026gt; \u0026lt;fmt\u0026gt; ... ä¸€ä»½ session description ä¸­å¯èƒ½å«æœ‰å¤šå€‹ media descriptionï¼Œæ¯ä¸€ä»½ media description å¾ m= é–‹å§‹ç›´åˆ°ä¸‹ä¸€å€‹ m=æˆ–æ˜¯ session description çµæŸ\nmedia é¡åˆ¥ï¼Œå¯ä»¥æ˜¯ audio / video / text ç­‰ port ä¸²æµå¾å“ªå€‹ port ç™¼é€ï¼Œé€™æœƒæ ¹æ“š connection infomation (c=) è€Œæ±ºå®šï¼Œå°æ–¼æŸäº›å‚³è¼¸å”å®šï¼Œå¦‚ rtp æœƒä½¿ç”¨å…©å€‹ port (RTP+RTCP)ï¼Œæ‰€ä»¥å®£å‘Šæ™‚æœƒæ˜¯ m=video 49170/2 RTP/AVP 31ï¼Œè¡¨ç¤º RTP ä½¿ç”¨ 49170 / RTCP ä½¿ç”¨ 49171ï¼› å¦‚æœ c æŒ‡å®šå¤šå€‹ IP ä½ç½®ï¼Œå‰‡ port æˆä¸€å°ä¸€æ˜ å°„é—œä¿‚ï¼Œå¦‚ 1 2 c=IN IP4 224.2.1.1/127/2 m=video 49170/2 RTP/AVP 31 å‰‡å› ç‚º RTP ä¸€æ¬¡ä½¿ç”¨å…©å€‹ portï¼Œé€™è¡¨ç¤º 224.2.1.1 ä½¿ç”¨ 49170ã€49171ï¼Œ224.2.1.2 ä½¿ç”¨ 49172ã€49173 proto æŒ‡å®šå‚³è¼¸å”å®šï¼Œå¸¸ç”¨çš„æœ‰ udp ã€ RTP/AVPã€RTP/SAVP ç­‰ fmt åª’é«”æ ¼å¼ï¼Œæœƒè·Ÿè‘— çš„å®šç¾©ï¼Œå¦‚æœ æ˜¯ udp å‰‡ éœ€è¦æŒ‡å®š audio / video / text / application / message ä¸€è€… SDP Attributes a=cat: ç”¨é€—é»åˆ†éš”ï¼Œç”¨ä¾†éæ¿¾ category a=keywds: é¡ä¼¼æ–¼ cat å±¬æ€§ï¼Œé€éé—œéµå­—ç¯©é¸æƒ³è¦çš„ session a=tool: è¡¨ç¤ºç”¨ä¾†å‰µå»º session å·¥å…·çš„åç¨±èˆ‡ç‰ˆè™Ÿ a=ptime: ç”¨ ms è¡¨ç¤ºä¸€å€‹å°åŒ…ä¸­åª’é«”çš„ç¸½æ™‚é•· a=maxptime: ç”¨ ms è¡¨ç¤ºä¸€å€‹å°åŒ…ä¸­åª’é«”çš„ç¸½æ™‚é•·ä¸Šé™ a=rtpmap: / [/] æ­é… media type(m=)å®£å‘Šï¼Œè£œå……RTPæ‰€æ¡ç”¨çš„ç·¨ç¢¼æ–¹å¼ï¼Œé›–ç„¶ RTP æª”æ¡ˆæœ¬èº«å°±æœƒåŒ…å« payload æ ¼å¼ï¼Œä½†æ˜¯å¸¸è¦‹åšæ³•æ˜¯é€éåƒæ•¸è¨­å®šå‹•æ…‹æ”¹è®Š ä¾‹å¦‚èªª u-law PCM coded single-channel audio sampled at 8 kHzï¼Œä»–çš„ encode æ–¹å¼å›ºå®šåªæœ‰ä¸€ç¨®ï¼Œæ‰€ä»¥ä¸éœ€è¦å¦å¤–å®£å‘Šrtpmap 1 2 3 4 5 m=audio 49232 RTP/AVP 0 ```bash ä½†å¦‚æœæ˜¯ `16-bit linear encoded stereo audio sampled at 16 kHz`ï¼Œå¸Œæœ›ç”¨ RTP/AVP payload æ ¼å¼ 98 çš„è©±ï¼Œå°±å¿…é ˆå¦å¤–å®£å‘Šè§£ç¢¼æ–¹å¼ m=audio 49232 RTP/AVP 98 a=rtpmap:98 L16/16000/2\n1 2 3 4 5 6 rtpmap å¯ä»¥é‡å° payload æ ¼å¼åšæ˜ å°„ï¼Œå¦‚ ```md m=audio 49230 RTP/AVP 96 97 98 a=rtpmap:96 L8/8000 a=rtpmap:97 L16/8000 a=rtpmap:98 L16/11025/2 åƒæ•¸å°æ‡‰çš„åƒæ•¸å¯ä»¥åƒè€ƒ [RTP Profile for Audio and Video Conferences with Minimal Control](https://tools.ietf.org/html/rfc3551) a=recvonly è¡¨æ˜å–®ç´”æ¥æ”¶ a=sendrecv å¯ä»¥æ¥æ”¶èˆ‡ç™¼é€ï¼Œæ­¤ç‚ºé è¨­å€¼ a=sendonly å–®ç´”ç™¼é€ a=inactive ä¸æ¥æ”¶ä¹Ÿä¸ç™¼é€åª’é«”ï¼ŒåŸºæ–¼ RTP ç³»çµ±çš„å³ä½¿æ˜¯ inactive ä¹Ÿè¦æŒçºŒç™¼é€ RTCP a=orient: ç”¨æ–¼ç™½æ¿æˆ–æ˜¯ä»‹ç´¹çš„å·¥å…·ï¼Œå¯ä»¥æŒ‡å®š portrait / landscape / seascape(ä¸Šä¸‹é¡›å€’çš„ landscape) a=framerate: video frame rate æœ€å¤§å€¼ï¼Œåªæœ‰ medial level çš„ video é¡å‹éœ€è¦ a=sdplang: SDP è³‡è¨Šæ¡ç”¨çš„èªè¨€ï¼Œå¦‚æœæœ‰å¤šç¨®èªè¨€å»ºè­°æ¯ç¨®èªè¨€éƒ½æ‹†æˆç¨ç«‹çš„ session description a=fmtp: ç”¨ä¾†å‚³é”æŸäº›ç‰¹å®šæ ¼å¼ï¼Œä¸”é€™äº›ç‰¹å®šæ ¼å¼ä¸éœ€è¦æ˜¯ SDP æ‰€èƒ½ç†è§£çš„ å®‰å…¨è€ƒé‡ SDP å¸¸ç”¨æ–¼ offer/answer æ¨¡å‹çš„ SIP ä¸­ï¼Œç”¨ä¾†æºé€šå–®æ’­çš„æœƒè©±æ©Ÿåˆ¶ï¼Œç•¶æ¡ç”¨é€™æ¨£çš„æ¨¡å¼æ™‚ï¼Œè¦è¨˜å¾—è€ƒé‡å”å®šæœ¬èº«çš„å®‰å…¨æ€§\nSDP åªæ˜¯ç”¨ä¾†æè¿°å¤šåª’é«”æœƒè©±çš„å…§å®¹ï¼Œæ¥æ”¶æ–¹è¦æ³¨æ„ session description æ˜¯å¦é€šéå¯ä¿¡ä»»çš„ç®¡é“èˆ‡ä¾†è‡ªå¯ä¿¡ä»»çš„ä¾†æºï¼Œå¦å‰‡ç¶²è·¯å‚³è¼¸éç¨‹å¯èƒ½é­é‡æ”»æ“Šï¼Œå¿…é ˆè¦è‡ªå·±æ‰¿æ“”å®‰å…¨ä¸Šçš„é¢¨éšª\nå¸¸ç”¨çš„å‚³è¼¸æ–¹å¼æ˜¯ SAPï¼ŒSAP æœ¬èº«æä¾›åŠ å¯†èˆ‡é©—è­‰æ©Ÿåˆ¶ï¼› ä¸éæœ‰äº›æƒ…æ³ä¸‹ç„¡æ³•æ¡ç”¨ï¼Œä¾‹å¦‚æ¥æ”¶è€…äº‹å‰ä¸çŸ¥é“ç™¼é€è€…çš„æ™‚å€™ï¼Œæ­¤æ™‚å°±è¦ç‰¹åˆ¥å°å¿ƒ parseï¼Œä¸¦æ³¨æ„æ¬Šé™çš„ç®¡æ§(åƒ…é–‹æ”¾æœ‰é™çš„è»Ÿé«”å¯ä»¥æ“ä½œ)\n","date":"2019-10-02T00:21:40.869Z","permalink":"https://yuanchieh.page/posts/2019/2019-10-02-sdp-spec-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/","title":"SDP Spec é–±è®€ç­†è¨˜"},{"content":"å¾Œç«¯å·¥ç¨‹å¸«æœ€åŸºæœ¬çš„æŠ€èƒ½è¦æ±‚æ˜¯è¨­è¨ˆç¬¦åˆ HTTP-based REST çš„APIï¼Œå·¥ä½œå…©å¹´å¤šå¿«ä¸‰å¹´ï¼Œè‡ªå·±è…¦ä¸­ç¬¬ä¸€åæ‡‰å¤§æ¦‚æœƒæ˜¯\næŠŠURLè¦–ç‚ºè³‡æºè·¯å¾‘çš„æè¿°ï¼ŒæŠŠå°æ‡‰çš„CRUD æ“ä½œå°æ‡‰è‡³ HTTP Methodï¼Œä¾‹å¦‚è¦ä¸‹ä¸€ç­†è¨‚å–®æ˜¯ POST /booking ï¼Œå–å¾—å–®ç­†è¨‚å–®æ˜¯ GET /booking/1\nä½†ä¸–ç•Œæ²’æœ‰é€™éº¼å–®ç´”ï¼Œå¦‚æœæ˜¯é‡åˆ°è¤‡é›œçš„æ“ä½œæ™‚ï¼Œé›£ä»¥é‹ç”¨ HTTP çš„ Methodå‹•è© + URL åè©çš„æ–¹å¼æè¿°ï¼Œé‚£è©²æ€éº¼è¾¦å‘¢ï¼Ÿ\nä¾‹å¦‚èªªæœ€è¿‘åœ¨å·¥ä½œä¸Šé‡åˆ°å¦‚ä½•è¨­è¨ˆä¸€æ¬¡åˆªé™¤å¤šç­†è³‡æ–™çš„APIè©²æ€éº¼è¾¦ï¼Ÿ\nå°‹æ‰¾ç­”æ¡ˆçš„éç¨‹ä¸­ï¼Œçœ‹åˆ° Google èˆ‡ Microsoft æœ‰å…¬é–‹ä»–å€‘çš„ API Design Guidelineï¼Œä¸¦åˆ†äº«å…¶ä¸­æ€è€ƒçš„çœ‰è§’ï¼Œå…¶ä¸­åŒ…å«äº†\nREST çš„åŸºç¤è§€å¿µ æ‡‰ä»˜è¤‡é›œå ´æ™¯çš„è€ƒé‡ éŒ¯èª¤ç¢¼çš„è™•ç† åƒæ•¸åç¨±èˆ‡ç‰ˆæœ¬æ§åˆ¶ API Design Guide | Cloud APIs | Google Cloud\nmicrosoft/api-guidelines\nä»¥ Google æ–‡ä»¶ç‚ºä¸»ï¼ŒMicrosoft æ–‡ä»¶ç‚ºè¼”ï¼Œæ•´ç†éå¾Œåˆ†äº«å€‹äººç­†è¨˜\nä¸€é» RESTÂ ä»‹ç´¹ Roy Fielding åœ¨è¥¿å…ƒ 2000å¹´æå‡ºäº† Representational State Transfer(REST ) ç¶²ç«™æ¶æ§‹è¨­è¨ˆè¦ç¯„ï¼ŒåŒæ™‚ä»–ä¹Ÿæ˜¯ URL / Http 1.0 / Http 1.1 æ¨™æº–åˆ¶å®šçš„åƒèˆ‡è€…ï¼Œæ‰€ä»¥ REST çš„æ¦‚å¿µå¾ˆè‡ªç„¶çš„èˆ‡ HTTP ç›¸ç•¶å»åˆï¼Œä¸€é–‹å§‹ RESTè¢«èª¤ä»¥ç‚ºæ˜¯ HTTP object modelä¸€ç¨® HTTPçš„å¯¦ä½œï¼Œä½†å¯¦éš›ä¸Š RESTæç¹ªçš„æ˜¯ä¸€å€‹æ­£ç¢ºæ¶æ§‹çš„ Web æ‡‰ç”¨ç¨‹å¼ï¼šç”¨æˆ¶é¸æ“‡é€£çµ(state transition)ï¼Œé€²è€Œå¾—åˆ°ä¸‹ä¸€å€‹çµæœ(representing the next state of the application) ï¼Œå…¶ä¸­æå‡ºäº† REST æ¶æ§‹éœ€è¦ç¬¦åˆä»¥ä¸‹å…­å¤§åŸå‰‡\nClient /Â Server ä¾æ“šé—œæ³¨é»åˆ†é›¢( Separation of Concern)ï¼Œå°‡ç”¨æˆ¶ä»‹é¢è·Ÿè³‡æ–™å„²å­˜åˆ‡å‰²ï¼Œæ–¹ä¾¿å…©è€…ç¨ç«‹é‹ä½œèˆ‡ç¶­è­·\nStateless æ¯ä¸€æ¬¡çš„é€£ç·šæœ¬èº«éƒ½æ”œå¸¶è¶³å¤ çš„è³‡è¨Šï¼Œè€Œä¸ç”¨ä¾è³´æ–¼ä¸Šä¸€æ¬¡é€£ç·šçš„ç‹€æ…‹ï¼Œå¢åŠ æœå‹™çš„å¯é æ€§èˆ‡æ“´å±•æ€§\nCache æ ¹æ“š Requestï¼ŒResponse å¯ä»¥æ±ºå®šæ˜¯å¦èƒ½è¢«ç·©å­˜ï¼Œå¢åŠ ä½¿ç”¨æ•ˆç‡\nUniform Interfaces å¦‚åŒç¨‹å¼è¨­è¨ˆï¼Œå…ƒä»¶é–“ä¹Ÿéœ€è¦åˆ¶å®šä»‹é¢(interface)è§£è€¦åˆèˆ‡æºé€šï¼Œé›–ç„¶æœƒé™ä½ä¸€äº›æ•ˆç‡ï¼Œä¸éå¢åŠ å…ƒä»¶ç¨ç«‹çš„é‹ä½œèˆ‡ç¶­è­·ï¼Œå…¶ä¸­åŒ…å«å››å€‹è¦ç¯„\nidentification of resourcesï¼šå®šä½åˆ°ç‰¹å®šè³‡æºä¸Šï¼Œè³‡æºå¯ä»¥æ˜¯åœ–ç‰‡ã€æ–‡å­—ã€ç‰¹å®šæœå‹™(å¦‚ä»Šå¤©åŠ å·å¤©æ°£)ã€ä¸€å€‹å¯¦é«”çš„äººç­‰ç­‰ manipulation of resources through representationsï¼šServer æä¾›å¯ä»¥æ“ä½œè³‡æºçš„æ–¹æ³•ï¼ŒåŒ…å«äº†æè¿°è³‡æºæœ¬èº«çš„meta-dataï¼Œä»¥åŠå¦‚ä½•æ“ä½œ dataçš„ Control data self-descriptive messagesï¼šè¨Šæ¯æœ¬èº«è³‡è¨Šé‡æ˜¯è¶³å¤ çš„ï¼Œåœ¨è·¨å…ƒä»¶ä¹‹é–“å¯ä»¥ä¸æ–·çš„è¢«å‚³éè€Œä¸éœ€è¦æœ‰é¡å¤–çš„è™•ç†(Stateless) hypermedia as the engine of application state(HATEOAS)ï¼š\næ¨¡æ“¬ç€è¦½ç¶²é ï¼ŒåŠ è¼‰å®Œé¦–é å¾Œï¼Œå¾ŒçºŒæ“ä½œéƒ½æ˜¯åˆ©ç”¨ç¶²é ä¸Šçš„è¶…é€£çµæ¢ç´¢ç¶²ç«™ï¼›\nå¥—ç”¨åŒæ¨£çš„é‚è¼¯è‡³ REST Serverï¼ŒResponse åŒ…å«é‡å°æ­¤è³‡æºæ¢ç´¢çš„é€£çµèˆ‡æ“ä½œæ–¹å¼ï¼Œå¦‚è·Ÿé†«å¸«é ç´„å¾Œï¼Œå›å‚³çµæœï¼ŒåŒæ™‚åŒ…å«æŸ¥è©¢é ç´„ã€æŸ¥è©¢é†«ç”Ÿè³‡æ–™ã€æ›´æ”¹é ç´„ç­‰æ“ä½œéƒ½ä¸€ä½µå›å‚³ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;appointment\u0026gt; \u0026lt;slot id = \u0026#34;1234\u0026#34; doctor = \u0026#34;mjones\u0026#34; start = \u0026#34;1400\u0026#34; end = \u0026#34;1450\u0026#34;/\u0026gt; \u0026lt;patient id = \u0026#34;jsmith\u0026#34;/\u0026gt; \u0026lt;link rel = \u0026#34;/linkrels/appointment/cancel\u0026#34; uri = \u0026#34;/slots/1234/appointment\u0026#34;/\u0026gt; \u0026lt;link rel = \u0026#34;/linkrels/appointment/addTest\u0026#34; uri = \u0026#34;/slots/1234/appointment/tests\u0026#34;/\u0026gt; \u0026lt;link rel = \u0026#34;self\u0026#34; uri = \u0026#34;/slots/1234/appointment\u0026#34;/\u0026gt; \u0026lt;link rel = \u0026#34;/linkrels/appointment/changeTime\u0026#34; uri = \u0026#34;/doctors/mjones/slots?date=20100104\u0026amp;status=open\u0026#34;/\u0026gt; \u0026lt;link rel = \u0026#34;/linkrels/appointment/updateContactInfo\u0026#34; uri = \u0026#34;/patients/jsmith/contactInfo\u0026#34;/\u0026gt; \u0026lt;link rel = \u0026#34;/linkrels/help\u0026#34; uri = \u0026#34;/help/appointment\u0026#34;/\u0026gt; \u0026lt;/appointment\u0026gt; Layered System ä¸€å€‹å®Œæ•´çš„ç³»çµ±å¯ä»¥ç”±å¤šå€‹å­å…ƒä»¶ç–ŠåŠ ï¼Œä¾‹å¦‚ Cache Server / Api Server / Proxy / Agent ç­‰ï¼Œæ¯å€‹å…ƒä»¶åƒ…å¯æ„è­˜åˆ°ç›¸é„°çš„å…ƒä»¶\nCode OnÂ Demand Client å¯ä»¥ä¾ç…§éœ€æ±‚åŠ è¼‰æ–°çš„ script åŸ·è¡Œ\né€™ä»£è¡¨ REST ä¸ä¸€å®šè¦ç¶å®š HTTPï¼Œåªæ˜¯ HTTPå¾ˆå·§å¦™çš„è·Ÿ RESTæ¦‚å¿µååˆ†è²¼è¿‘ï¼ŒRESTçš„æ¦‚å¿µä¹Ÿå¯ä»¥å°ç…§åˆ° HTTP å¯¦ä½œä¸Š(ç•¢ç«Ÿ Roy Fieldingéƒ½æœ‰åƒèˆ‡å…¶ä¸­\nå›éé ­ä¾†çœ‹å¸¸è¦‹çš„ RESTful APIå®šç¾©ï¼Œæ¯”è¼ƒåƒæ˜¯ REST + HTTP çš„æ··åˆç”¢ç‰©ï¼Œå¿«é€Ÿç¿»å®Œ Roy Fielding çš„ Architectural Styles and the Design of Network-based Software Architecturesï¼Œå…¶ä¸­çš„ 6.2 URI å®šç¾©æ˜¯ç‰¹å®šè³‡æºçš„è¡¨å¾µ (representation of the identified resource)ï¼Œæœ€ä¸€é–‹å§‹çš„ Web æ˜¯åœ¨å‚³è¼¸æ–‡ä»¶æˆ–è¶…é€£çµ(hypertext)ï¼Œæ‰€ä»¥ Resource å¸¸ç›´æ¥å°æ‡‰åˆ°æª”æ¡ˆæ–‡ä»¶ï¼Œè€Œ URI å‰‡å°æ‡‰åˆ°å¯¦éš›æª”æ¡ˆçš„è·¯å¾‘ï¼›é€™æœƒå¸¶ä¾†å¹¾å€‹ä¸å¥½çš„å½±éŸ¿ï¼Œä¾‹å¦‚èªªæ–‡ä»¶è¢«ä¿®æ”¹äº†è©²å¦‚ä½•è¡¨ç¤º / å¦‚ä½•è¡¨é”æœå‹™( Service )è€Œéæ–‡ä»¶æœ¬èº« ç­‰ç­‰ï¼›\nè‰¯å¥½çš„ Resource å®šç¾©æ‡‰è©²æ˜¯**ç›¡å¯èƒ½å›ºå®šä¸è®Š** ä¸” æŠ½è±¡æ–¼å¯¦éš›æª”æ¡ˆå„²å­˜æœ¬èº«ï¼Œè€Œæ˜¯ä¸€ç¨®é«˜å±¤ç´šçš„æ˜ å°„æ¦‚å¿µï¼Œç•¶ Server æ”¶åˆ°å¾Œå»æ‰¾å‡ºå°æ‡‰çš„å¯¦ä½œå…§å®¹ï¼Œæ›´é‡è¦çš„æ˜¯å‚³é”ä½¿ç”¨è€…çš„æ„åœ–ï¼Œæ‰€ä»¥ä¸€å€‹ Resource æ¦‚å¿µå¯èƒ½æ©«è·¨å¤šçš„æª”æ¡ˆï¼Œä¹Ÿå¯ä»¥å¤šå€‹ Resource æè¿°åŒä¸€å€‹æª”æ¡ˆ\nç”¨ URIæè¿°è³‡æºå¾Œï¼Œéœ€è¦å†åŠ ä¸Šç”¨æˆ¶å°æ–¼è³‡æºçš„æ“ä½œ(representation )ï¼Œå°±å¯ä»¥çµ„æˆèªæ„ (Semantic)ï¼Œå°æ‡‰å› HTTPï¼Œä¸åŒçš„æ“ä½œå°æ‡‰ä¸åŒçš„æ–¹æ³•( Method )ï¼Œå¦‚ GET è¡¨ç¤ºè¦å–å¾— URIæ‰€ä»£è¡¨è³‡æºçš„è³‡è¨Š / POST è¡¨ç¤ºå‰µå»º URIè³‡æºçš„å­è³‡æºç­‰ï¼Œå‰‡å®šç¾©åœ¨ HTTP 1.1 ç•¶ä¸­çš„ Method Definitions\nä»¥å€‹äººæ·ºè¦‹ï¼Œè«‡åˆ° REST Architecture æŒ‡çš„æ‡‰è©²æ˜¯ç¬¦åˆ Roy Fielding è¦ç¯„çš„ 6å¤§åŸå‰‡çš„ç¶²ç«™æ¶æ§‹è¨­è¨ˆï¼›\nè€Œç›®å‰å¸¸ç”¨çš„ RESTful API è¨­è¨ˆåŸå‰‡å‰‡æ˜¯ RESTä¸­çš„ Resource è§£é‡‹åŠ ä¸Š HTTP å°æ–¼ Method æ“ä½œçš„è£œå……ï¼Œå…©è€…æ··åˆçš„è¨­è¨ˆåŸå‰‡\nå›æ­¸ RESTful API / RESTÂ API æ ¹æ“š Google æ–‡ä»¶ï¼ŒRESTful API å®šç¾©ä¸»è¦æ˜¯ å¯å€‹åˆ¥å‘¼å«çš„ã€Œè³‡æºã€(API çš„ã€Œåè©ã€)ã€Œé›†åˆã€åšç‚ºæ¨¡å‹ã€‚ä¸åŒçš„è³‡æºæœ‰å„è‡ªçš„åƒç…§åç¨±ï¼Œä¹Ÿå°±æ˜¯æ‰€è¬‚çš„**[**è³‡æºåç¨±**](https://cloud.google.com/apis/design/resource_names?hl=zh-tw)**ï¼Œä¸¦ä¸”æ˜¯é€éä¸€å¥—ã€Œæ–¹æ³•ã€ä¾†æ“æ§\né€™æ¨£çš„ç†å¿µå¯ä»¥è¢«å¾ˆå¥½çš„å¥—ç”¨åœ¨ HTTP 1.1 ä¸Šï¼Œå› ç‚º URL å¯ä»¥ç”¨ä¾†æè¿°è³‡æºè·¯å¾‘ï¼ŒHTTP Method å¸¸ç”¨çš„ä¹Ÿå°±æ˜¯ GET / POST / PUT / PATCH / DELETEï¼Œæ­£å¥½å°æ‡‰è³‡æºçš„æ“ä½œï¼Œæ ¹æ“š Google æ–‡ä»¶ï¼Œæœ‰ 74%çš„å…¬é–‹ HTTP API éƒ½æ˜¯ä¾æ“š REST è¨­è¨ˆè¦ç¯„ï¼›\nHTTPè¢«å»£æ³›æ‡‰ç”¨ï¼Œä½†ä¹Ÿä¸æ˜¯å”¯ä¸€çš„è·¨é€²ç¨‹æºé€šçš„è¦ç¯„ï¼Œå¦‚æœæ˜¯å…¬å¸å…§ç¶²æˆ–æ˜¯è¦æ±‚æ›´ä½æºé€šä¸Šçš„overheadï¼Œæœƒæ¡ç”¨ RPC ( Googleæ¨å»£è‡ªå®¶çš„ gRPC)ï¼ŒREST ä¹Ÿå¯ä»¥è¢«å¥—ç”¨åœ¨é€™ä¸Šé¢\nè³‡æº Resource é¢å‘è³‡æºå°å‘è¨­è¨ˆçš„ APIï¼Œéœ€è¦å…ˆè¦åŠƒè³‡æºçš„å±¤ç´šï¼Œæ¯å€‹è³‡æºçš„ç¯€é»å¯ä»¥æ˜¯å–®å€‹è³‡æº(Resource)æˆ–æ˜¯åŒä¸€é …è³‡æºçš„é›†åˆ(Collection)\næ¯å€‹è³‡æºæˆ–é›†åˆå¿…é ˆæœ‰ç¨ç‰¹çš„ id å»å€åˆ†ï¼Œåœ¨å‘½åæ™‚ç›¡å¯èƒ½è¡¨é”æ¸…æ¥šï¼Œé¿å…ä½¿ç”¨ä»¥ä¸‹çš„åè©å¦‚ resource / object / item ç­‰ï¼›\nä¸”å‘½åæ™‚å·²è¤‡æ•¸åè©è¡¨ç¤ºï¼Œä¾‹å¦‚ /users/123/events/456\nä¾‹å¦‚ Gmail API æœƒæœ‰ä¸€ç¾¤ç”¨æˆ¶çš„é›†åˆï¼Œæ¯å€‹ç”¨æˆ¶åº•ä¸‹æœ‰è¨Šæ¯çš„é›†åˆ / æ¨™ç±¤çš„é›†åˆç­‰ç­‰\n-- user\n|\u0026mdash; message\n|\u0026mdash; label\nURL çš„é•·åº¦åœ¨Spec ä¸­æ²’æœ‰è¦ç¯„ï¼Œä½†åœ¨ç¾å¯¦ä¸­æœ‰äº›ç€è¦½å™¨æœƒæœ‰é•·åº¦é™åˆ¶ï¼Œå¯ä»¥çš„è©±é‚„æ˜¯ä¿æŒåœ¨ 2000 å­—å…ƒä»¥å…§æ¯”è¼ƒä¿éšª\nWhat is the maximum length of a URL in different browsers?\nMicrosoft æ–‡ä»¶ä¹Ÿæ˜¯æ¨™æ¦œé¡ä¼¼çš„å¯«æ³•ï¼Œä½†é¡å¤–å»ºè­°ä¸è¦è®“è³‡æ–™çš„å±¤ç´šè¶…éä¸‰å±¤ /collection/item/collection ï¼Œä¾‹å¦‚èªª /customers/1/orders/99/products å¯ä»¥åˆ†æ‹†æˆ /customers/1/orders + /orders/99/products\nå¦å¤–åœ¨ APIçš„è³‡æºå±¤ç´šä¸è¦åº•å±¤çš„è³‡æ–™çµæ§‹æœ‰å¤ªç·Šå¯†çš„é—œä¿‚ï¼Œä¾‹å¦‚ä½¿ç”¨é—œè¯æ€§è³‡æ–™åº«ä¸ä¸€å®šè¦å‰›å¥½å°æº– Tableï¼ŒAPI æ‡‰è©²æ˜¯è¦æ›´é«˜å±¤åº¦çš„æŠ½è±¡åŒ–ï¼Œé¿å…ä¹‹å¾Œè³‡æ–™åº«çš„æ›´å‹•è€¦åˆäº† APIçš„è³‡æºè·¯å¾‘ã€‚\næ“ä½œ Methods é¢å‘è³‡æºå°å‘è¨­è¨ˆçš„ API å´é‡æ–¼è³‡æºçš„æè¿°è€Œéæ“ä½œçš„æè¿°ï¼Œæ‰€ä»¥å¤§é‡è³‡æºçš„æè¿°åƒ…æœƒæ­é…æœ‰é™çš„æ“ä½œï¼Œæ¨™æº–çš„æ“ä½œæ˜¯ List / Get / Create / Update / Delete é€™äº”é …\næ“ä½œæœ‰å¯èƒ½ä¸æœƒæ˜¯ç«‹å³ç™¼ç”Ÿï¼Œéœ€è¦ä¸€æ®µæ™‚é–“æ‰æœƒç”Ÿæ•ˆï¼Œæ­¤æ™‚å¯ä»¥å›ä¸€å€‹é•·æ™‚æ“ä½œçš„è³‡æºï¼Œç”¨ä»¥æŸ¥è©¢é€²åº¦æˆ–æ˜¯ç‹€æ…‹ç­‰çš„æ–¹å¼ï¼Œæœ‰é»åƒæ˜¯å«è™Ÿå–é¤çš„é™æ§å™¨\nList å¿…é ˆä½¿ç”¨ GET Request ä¸èƒ½æœ‰ Body Response Body åŒ…å«ä»¥é™£åˆ—è¡¨ç¤ºçš„è³‡æºï¼Œèˆ‡å…¶é¤˜é¸æ“‡æ€§çš„æ“ä½œ(å¦‚åˆ†é æ“ä½œ) GET å¿…é ˆä½¿ç”¨ GET Request ä¸èƒ½æœ‰ Body Response Body å°æ‡‰åˆ°å®Œæ•´çš„è³‡æºæè¿° CREATE å¿…é ˆä½¿ç”¨ POST Request Body å¿…é ˆåŒ…å«æ–°å¢è³‡æºçš„å…§å®¹ å¦‚æœæ”¯æ´ client side æŒ‡å®š _idï¼Œå‰‡æä¾›è©²æ¬„ä½æ–¼ Request Bodyï¼Œä½†å¦‚æœç™¼ç”Ÿè¡çªéœ€å›å‚³ ALREADY_EXISTS Response Body å¯ä»¥ Update å¦‚æœæ˜¯éƒ¨ä»½æ›´æ–°ä½¿ç”¨ PATCH å¦‚æœæ˜¯å…¨éƒ¨æ›´æ–°(è¦†è“‹)ä½¿ç”¨ PUTï¼Œå¦‚æœ Request Body æ²’æœ‰å¤¾å¸¶çš„æ¬„ä½ï¼Œè¦–ç‚ºæ¸…é™¤è©²æ¬„ä½ å¦‚æœ Patchæ›´æ–°ä¸å­˜åœ¨è³‡æºï¼ŒAPI å¯ä»¥é¸æ“‡æ˜¯å¦æ”¯æ´ Upsertæ›´æ–°ä¸åˆ°å°±å‰µå»ºçš„åŠŸèƒ½ï¼Œå¦‚æœå¦å‰‡å›å‚³ NOT_FOUND Response Body å¿…é ˆæ˜¯æ›´æ–°å¾Œçš„è³‡æºæœ¬èº« Update åƒ…ç”¨æ–¼æ›´æ–°ï¼Œå¦‚æœæ˜¯å…¶é¤˜è¤‡é›œæ“ä½œå¦‚é‡æ–°å‘½åè³‡æºã€æ”¹è®Šè³‡æºè·¯å¾‘ç­‰ï¼Œè«‹ä½¿ç”¨å®¢è£½åŒ–æ“ä½œ å¦‚æœä»¥ JSON ç‚ºè³‡æ–™äº¤æ›æ ¼å¼ï¼ŒPatch æœ‰å…©ç¨®æ–¹æ³• JSON patch / JSON merge patchï¼Œåœ¨è³‡æ–™å„²å­˜ä¸­ï¼Œnull çš„å«ç¾©æœ‰äº›æ¨¡ç³Šåœ°å¸¶ï¼Œå¦‚æœ Request JSON æ¬„ä½å¤¾å¸¶ nullï¼Œé€™æ˜¯ä»£è¡¨ç§»é™¤è©²æ¬„ä½é‚„æ˜¯æ›´æ–°æ¬„ä½æˆç‚º null å‘¢ï¼Ÿ\nå¦‚æœ Header ä¸­çš„ Content-Type æ˜¯ application/merge-patch+json å‰‡ä»£è¡¨ null ç§»é™¤è©²æ¬„ä½ï¼Œæ­¤æ™‚éœ€æ³¨æ„è³‡æ–™çµæ§‹å°±ä¸å»ºè­°æ¬„ä½å„²å­˜ nullé¿å…æ··æ·†ï¼Œæ›´å¤šåƒè€ƒ RFC: JSON Merge Patchï¼›\nå¦‚æœå¸Œæœ›é‡å°æ¬„ä½æœ‰æ›´ç²¾ç¢ºçš„æ“ä½œæè¿°ï¼Œä¾‹å¦‚æ–°å¢ã€åˆªé™¤ã€å–ä»£ã€è¤‡è£½ã€æ¬ç§»ã€é©—è­‰(test)ç­‰ï¼Œå¯ä»¥åƒè€ƒ JSON patchï¼ŒContent-Type ç‚º application/json-patch+json ï¼Œç”¨é™£åˆ—è¡¨è¿°æ“ä½œçš„é›†åˆï¼Œæ“ä½œç¯„ä¾‹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 [ { \u0026#34;op\u0026#34;: \u0026#34;test\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/a/b/c\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;foo\u0026#34; }, { \u0026#34;op\u0026#34;: \u0026#34;remove\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/a/b/c\u0026#34; }, { \u0026#34;op\u0026#34;: \u0026#34;add\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/a/b/c\u0026#34;, \u0026#34;value\u0026#34;: [ \u0026#34;foo\u0026#34;, \u0026#34;bar\u0026#34; ] }, { \u0026#34;op\u0026#34;: \u0026#34;replace\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/a/b/c\u0026#34;, \u0026#34;value\u0026#34;: 42 }, { \u0026#34;op\u0026#34;: \u0026#34;move\u0026#34;, \u0026#34;from\u0026#34;: \u0026#34;/a/b/c\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/a/b/d\u0026#34; }, { \u0026#34;op\u0026#34;: \u0026#34;copy\u0026#34;, \u0026#34;from\u0026#34;: \u0026#34;/a/b/d\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/a/b/e\u0026#34; } ] DELETE å¿…é ˆä½¿ç”¨ DELETE ä¸èƒ½æœ‰ Request Body å¦‚æœæ˜¯ç«‹å³åˆªé™¤ï¼Œå‰‡ Response Body ç‚ºç©ºå€¼ å¦‚æœæ˜¯éœ€è¦é•·æ™‚é–“åŸ·è¡Œï¼Œå›å‚³ç›¸å°æ‡‰çš„é•·æ™‚æ“ä½œ å¦‚æœåªæ˜¯æŠŠè³‡æºæ¨™è¨˜åˆªé™¤è€Œéç¡¬åˆªé™¤ï¼Œå›å‚³æ›´æ–°çš„è³‡æº åˆªé™¤å¿…é ˆæ˜¯å†ªç­‰æ€§æ“ä½œï¼Œä¸è«–æ“ä½œå¹¾æ¬¡éƒ½å¿…æ˜¯æ˜¯åˆªé™¤è©²è³‡æºï¼Œä½†å›æ‡‰å…§å®¹å¯ä»¥æ”¹è®Šï¼Œç¬¬ä¸€æ¬¡ç¢ºå¯¦åˆªæ‰è³‡æºå›å¾©æˆåŠŸï¼Œå¾ŒçºŒåˆªé™¤å¯ä»¥å›è¦† NOT_FOUND Custom Method é™¤äº†ä¸Šè¿°äº”ç¨®æ“ä½œå¤–ï¼Œå¯èƒ½æœƒæœ‰äº›æ“ä½œä¸å†é€™äº”ç¨®ç¯„ç–‡ä¹‹ä¸­ï¼Œæ­¤æ™‚å°±å¯ä»¥è‡ªè¡Œå®šç¾©ï¼Œä¾‹å¦‚èªªå–æ¶ˆåˆªé™¤ã€å¤§é‡æ›´æ–°ç­‰\nè‡ªå®šç¾©çš„æ–¹æ³•é ˆä»¥Â : æ”¾åœ¨ URLçš„æœ€å¾Œæ–¹ï¼Œä¸”å¸¸è¦‹çš„æ­é…æ˜¯ç”¨ POSTï¼Œå› ç‚ºå¯ä»¥å¤¾å¸¶Bodyï¼›\nä½†ä¹Ÿå¯ä»¥è¦–æƒ…æ³ä½¿ç”¨å…¶ä»–çš„ HTTP Method (Patch ä¸å»ºè­°ä½¿ç”¨å¤–)ï¼Œä½†ä»é ˆéµå®ˆ HTTP Method ä½¿ç”¨çš„è¦ç¯„ï¼Œä¾‹å¦‚å†ªç­‰æ€§èˆ‡æ˜¯å¦èƒ½å¤¾å¸¶ Bodyç­‰\nGoogle æä¾›å¹¾ç¨®è‡ªå®šç¾©æ–¹æ³•çš„ç”¨é€”\n1. POST :cancel å–æ¶ˆæ“ä½œ\n2. GET :batchGet ä¸€æ¬¡æ€§å–å¾—å¤šç­†è³‡æ–™\n3. POST :move å°‡è³‡æºç§»åˆ°åˆ¥è™•\nbatchGet ä¹Ÿå¯ä»¥ä½¿ç”¨ POSTï¼Œä¾‹å¦‚ POST https://mybusiness.googleapis.com/v4/{name=accounts/*}/locations:batchGet` åœ¨ Body ä¸­æœ‰å°æŸ¥è©¢çš„å…§å®¹æœ‰æ›´è¿‘ä¸€æ­¥çš„æè¿°\nMicrosoft æè­°å°±æŠŠéåè©æ”¾é€² URLä¸­ï¼Œä¾‹å¦‚ä¸€å€‹è¨ˆç®—æ©Ÿçš„åŠ æ³• APIå¯ä»¥è¨­è¨ˆç‚º GET /add?operand1=99\u0026amp;operand2=1 ï¼Œå…¶é¤˜çš„å°±éµå®ˆ HTTP Method æ“ä½œæ–¹å¼ã€‚\nåœ¨ AWS æ–‡ä»¶ä¸­ï¼ŒCustom Method æ˜¯ä»¥ Query String æ–¹å¼å­˜åœ¨ï¼Œå¦‚ åˆªé™¤å¤šç­†ç‰©ä»¶/?delete ï¼Œå€‹äººæ˜¯è¦ºå¾—å®¹æ˜“èˆ‡å…¶ä»–çš„ Query String æ··æ·†ï¼Œåœ¨ Parsingä¸Šä¹Ÿæ¯”è¼ƒéº»ç…©é»ï¼Œä¸æ˜¯å¾ˆå–œæ­¡é€™æ¨£çš„ä½œæ³•\nå€‹äººåå¥½ Googleçš„åšæ³•ï¼Œè®“ URLçµ„æˆå…¨éƒ¨éƒ½æ˜¯åè©ï¼Œä¹¾æ·¨çš„è¡¨ç¤ºè³‡æ–™å±¤ç´šï¼ŒCustom Method å°±ä»¥ä¸€å€‹ç‰¹æ®Šçš„æ–¹å¼å®£å‘Šï¼Œå¯ä»¥è‰¯å¥½èˆ‡ REST APIå…±å­˜\nHTTP Media Type èˆ‡Â Header æœ€å¾Œåˆ¥å¿˜äº† Request èˆ‡ Response æ‡‰ç›¡é‡éµå®ˆ HTTPè¦ç¯„ï¼Œä½¿ç”¨æ­£ç¢ºçš„ Status Code èˆ‡ Headerï¼Œè®“ APIè¨­è¨ˆæ›´ç²¾ç¢ºï¼Œä¾‹å¦‚\näº¤æ›çš„è³‡æ–™æ ¼å¼ç‚º json å°±è¦å®£å‘Š Content-Type: application/json;charset=utf-8 200\n201(Created)Â : å»ºç«‹æ–°è³‡æº\n202(Accepted)ï¼šæ¥å—è«‹æ±‚ï¼Œä½†ä¸æ˜¯ç«‹å³ç™¼ç”Ÿ\n204 (No Content)ï¼šæ²’æœ‰è¦å›å‚³è³‡æ–™ Versioning åœ¨ç¶­è­· APIéç¨‹ï¼Œæœƒé‡åˆ°æ›´å‹•è³‡æ–™çµæ§‹æˆ–æ˜¯ä¿®æ”¹é‚è¼¯çš„åœ°æ–¹ï¼Œå¦‚æœå¯ä»¥çš„è©±åˆä¸å¸Œæœ›å½±éŸ¿åŸæœ‰ APIçš„æ“ä½œï¼Œæ­¤æ™‚å°±éœ€è¦åšç‰ˆæœ¬æ§åˆ¶ï¼Œç‰ˆè™Ÿçš„å‘½åå¯ä»¥åƒè€ƒ Semantic Version X.Y.Z æ–¹å¼è¡¨ç¤º\nX å¤§ç‰ˆè™Ÿè¡¨ç¤ºæœ‰ breaking changeï¼Œå‘å‰ä¸ç›¸å®¹ Y å°ç‰ˆè™Ÿè¡¨ç¤ºæœ‰æ–°å¢ functionï¼Œæˆ–æ˜¯æ›´å‹•æ˜¯å‘å‰ç›¸å®¹çš„ Z è£œä¸ç‰ˆè™Ÿè¡¨ç¤º Bug ä¿®æ­£ ä¸€èˆ¬ä¾†èªª API å°å¤–ç”¨å¤§ç‰ˆè™Ÿè¡¨ç¤ºï¼Œå¦‚ v1 / v2ï¼Œå°ç‰ˆè™Ÿè·Ÿè£œä¸ç‰ˆè™Ÿå‡ºç¾åœ¨æ–‡ä»¶çš„ç‰ˆæœ¬è™Ÿä¸Š\nversion å¸¸è¦‹å¯ä»¥æ”¾åœ¨å¹¾å€‹åœ°æ”¾\nURL ç•¶ä¸­ï¼Œæ”¾åœ¨ Domain å¾Œçš„ç¬¬ä¸€å±¤ï¼Œå¦‚ https://example.com/v1 å¤¾å¸¶åœ¨ Query Stringä¸­ï¼Œå¦‚ https://example.com?version=v1 æ”¾åœ¨ Custom Headerç•¶ä¸­ æ”¾åœ¨ Header Accept ä¸­ï¼Œå¦‚ application/vnd.adventure-works.v1+json åœ¨æ¡ç”¨ versioning æ™‚ï¼Œè¦è€ƒé‡åˆ° web cache çš„æ©Ÿåˆ¶ï¼Œé€šå¸¸ cache æ˜¯é‡å° URLï¼Œæ‰€ä»¥å‰å…©è€…æ¯”è¼ƒæ¨è–¦\nError å¸¸è¦‹ä½œæ³•æœƒå›å‚³éŒ¯èª¤ä»£ç¢¼ã€éŒ¯èª¤çš„ç°¡è¿°ã€éŒ¯èª¤çš„è©³ç´°å…§å®¹ï¼Œæ–¹ä¾¿é–‹ç™¼è€…åšéŒ¯èª¤è™•ç†ï¼Œä¾‹å¦‚ä»¥ä¸‹æ ¼å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 { \u0026#34;error\u0026#34;: { \u0026#34;code\u0026#34;: \u0026#34;BadArgument\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Multiple errors in ContactInfo data\u0026#34;, \u0026#34;target\u0026#34;: \u0026#34;ContactInfo\u0026#34;, \u0026#34;details\u0026#34;: [ { \u0026#34;code\u0026#34;: \u0026#34;NullValue\u0026#34;, \u0026#34;target\u0026#34;: \u0026#34;PhoneNumber\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Phone number must not be null\u0026#34; }, .... ] } } Code å¸¸è¦‹é‚„å¯ä»¥ç”¨æ•¸å­—è¡¨ç¤ºï¼Œæ–¹ä¾¿é–‹ç™¼è€…é€éæ–‡ä»¶å¿«é€ŸæŸ¥è©¢ï¼Œä½†ä¹Ÿä¸è¦å¿˜äº†å›å‚³è©²æ¬¡éŒ¯èª¤çš„å…§å®¹æè¿°\nåˆ¥å¿˜äº†è¦æ­é…æ­£ç¢ºçš„ HTTP éŒ¯èª¤ç¢¼ä½¿ç”¨\n400(Bad Request)ï¼šServerç„¡æ³•ç†è§£ï¼Œä¾‹å¦‚åƒæ•¸ç¼ºå°‘æˆ–éŒ¯èª¤\n401(Unauthorized)ï¼šæˆæ¬ŠéŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ Tokenå¤±æ•ˆç­‰\n403(Forbidden)ï¼šç„¡è¨ªå•æ¬Šé™ï¼Œæƒ³å–å¾—è¶…éç”¨æˆ¶æˆæ¬Šçš„è³‡æº\n404(Not Found)ï¼šæŸ¥ç„¡è³‡æº\nâ€¦..\n","date":"2019-09-18T00:08:40.869Z","permalink":"https://yuanchieh.page/posts/2019/2019-09-18-%E5%A6%82%E4%BD%95%E8%A8%AD%E8%A8%88-rest-api/","title":"å¦‚ä½•è¨­è¨ˆ REST API"},{"content":"æ–‡å­—ç‰ˆï¼šhttps://dev.to/pmlopes/javascript-on-graalvm-120f\nèº«ç‚ºä¸€åå·¥ç¨‹å¸«ï¼Œæƒ³è¾¦æ³•è®“è‡ªå·±çš„ç¨‹å¼ç¢¼åŸ·è¡Œçš„æ›´å¿«ï¼Œä¼¼ä¹æ˜¯ä¸€ç¨®å¤©æ€§ï¼Œç•¶æˆ‘å€‘æƒ³è¦å„ªåŒ– Node.js Server çš„åŸ·è¡Œé€Ÿåº¦æ™‚ï¼Œç¬¬ä¸€å°è±¡æ‡‰è©²éƒ½æ˜¯å¦‚ä½•å¯«å‡ºæ›´å¥½çš„ç¨‹å¼ç¢¼ã€ç”¨æ›´å¿«çš„æ¼”ç®—æ³•ï¼Œé€™äº›ç•¶ç„¶éƒ½æ˜¯å„ªåŒ–çš„ä¸€ç’°ï¼Œä½†å¦‚æœæ‹‰é ä¸€é»æƒ³ï¼Œæœ‰æ²’æœ‰è¾¦æ³•å»å„ªåŒ– Node.js Runtimeæœ¬èº«å‘¢Â ?!\nä½œè€…æåˆ°åœ¨è‘—åçš„ framework benchmark ä¸­ï¼ŒJS çš„åŸ·è¡Œæ•ˆç‡æ’åå¾ˆå¾Œé¢ï¼Œå¦‚æœç”¨ FlameChart åˆ†æï¼Œæœƒç™¼ç¾çµ•å¤§å¤šæ•¸çš„æ™‚é–“æ˜¯åœ¨åº•å±¤ä¹Ÿå°±æ˜¯ V8 Engine èˆ‡ Libuv ä¸Š\nå·¦åœ–ï¼šhttps://blog.zenika.com/2011/04/10/nodejs/ å³åœ–ï¼šæˆªè‡ªå½±ç‰‡\næ‰€ä»¥æˆ‘å€‘å†æ€éº¼å„ªåŒ– JS codeï¼Œå°±å¦‚åŒå†°å±±ä¸€è§’èˆ¬ï¼Œæ˜¯å¾ˆé›£å–å¾—éå¸¸å¤§å¹…åº¦çš„æ•ˆèƒ½æå‡ï¼Œé‚£è©²æ€éº¼è¾¦å‘¢ï¼Ÿ\nPaulo Lopes è¨­è¨ˆäº†ES4X å°ˆæ¡ˆï¼Œä¸»è¦æ˜¯ç”¨ GraalVM å–ä»£ V8 èˆ‡ Vert.x å–ä»£ Libuv ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å°‡åº•å±¤å¾ C/C++ å·¥å…·éŠæ›æˆäº† JVM ç‚ºä¸»çš„å·¥å…·éŠï¼Œæ ¹æ“šä½œè€…çš„ benchmarkï¼Œåœ¨ä¸åŒæ‡‰ç”¨é¢å¯æå‡ 120% ~ 700% çš„æ•ˆèƒ½\nRun your JavaScript server 700% faster!\nVert.x Vertx é¡ä¼¼æ–¼ Libuv çš„åŠŸèƒ½ï¼Œæä¾› Event-Driven èˆ‡ Non-blocking çš„æ¡†æ¶ï¼Œæä¾›å¦‚ TCP / File æ“ä½œ / DNS / HTTP / Timerç­‰ APIæ”¯æ´ï¼Œå…¶æ ¸å¿ƒæ¦‚å¿µæ˜¯é€é Event Loop æ–¹å¼é”åˆ°äº‹ä»¶é©…å‹•çš„é–‹ç™¼æ–¹å¼ï¼Œå¤§æ¦‚ç„éå»è·Ÿ Javascript çš„é–‹ç™¼ç†å¿µéå¸¸å»åˆï¼Œåƒæ˜¯\nCallback Function ç‚ºæ¯å€‹äº‹ä»¶è¨»å†Š Handlerï¼Œç­‰åˆ°äº‹ä»¶å®Œæˆå¾Œæ¨é€² Event Loop ç­‰å¾…åŸ·è¡Œï¼Œ Don't call us, we will call you.\nNever block EventÂ Loop é€™é»é›·åŒæ–¼ Node.jsï¼Œä½†æ˜¯æœ‰ä¸€é»ä¸åŒæ˜¯ Node.js æ¡ç”¨ Single Event Loopï¼Œä½†æ˜¯Vertx æ¡ç”¨ Multiple Event Loopï¼Œä¸»è¦æ˜¯æ›´æœ‰æ•ˆé‹ç”¨ multi-core çš„æ©Ÿå™¨ï¼›\né›–ç„¶æ¡ç”¨äº† Multiple Event Loopï¼Œä½†æ˜¯ç‚ºäº†é¿å… Context Switch èˆ‡å¢é€²æ€§èƒ½ï¼Œå¦‚æœ handler A åœ¨ Event Loop1 åŸ·è¡Œï¼Œå¾ŒçºŒçš„ Callback ä¹Ÿéƒ½ä½åœ¨ Event Loop1 åŸ·è¡Œ\nHow to run blockingÂ code ç¾å¯¦ä¸Šä¸å¯é¿å…é‚„æ˜¯æœƒéœ€è¦åŸ·è¡Œè€—æ™‚çš„é‹ç®—æˆ–æ˜¯é‹è¡Œç”¨ sync è¨­è¨ˆçš„å‡½å¼åº«ï¼Œé€™æ™‚å¯ä»¥ç”¨ executeBlockingï¼Œé¡ä¼¼æ–¼ Promiseçš„è¨­è¨ˆï¼Œä½†æœƒé‹ä½œåˆ°å¾ Worker Thread Pool å–å¾—çš„ Thread ä¸Šï¼Œé¿å…å¡ä½ Event Loop\nä½†æ–‡ä»¶æè¿°åˆ° executeBlocking é›–ç„¶æ˜¯ç”¨æ–¼ blocking code executionï¼Œä½†å»ºè­°è¶…é 10s çš„æ“ä½œé‚„æ˜¯å¦å¤–ç®¡ç† Thread\n1 2 3 4 5 6 7 vertx.executeBlocking(function (promise) { // Call some blocking API that takes a significant amount of time to return_ var result = someAPI.blockingMethod(\u0026#34;hello\u0026#34;); promise.complete(result); }, function (res, res_err) { console.log(\u0026#34;The result is: \u0026#34; + res); }); Concurrent composition éåŒæ­¥æ“ä½œä¸€å¤§è¦è§£æ±ºçš„å•é¡Œå°±æ˜¯æ“ä½œé †åºï¼ŒVertx æä¾›åƒ CompositeFuture.allã€CompositeFuture.any ç­‰ APIï¼Œå¾ JS è§’åº¦æ‡‰è©²éƒ½ä¸é™Œç”Ÿ\nç›´æ¥ä½¿ç”¨ Vertx çš„ JS æ–¹æ¡ˆæœ‰ä¸€å€‹å¾ˆå¤§çš„å•é¡Œ\nç›®å‰æ˜¯åŸºæ–¼ Nashorn é€™å¥— JS Engineï¼Œåƒ…æ”¯æ´åˆ° ES 5.1ä¸¦ä¸æ”¯æ´ ES6 ä»¥å¾Œçš„èªæ³•ï¼Œå¦‚æœ Library ç”¨ ES6 ä»¥å¾Œèªæ³•å¯«ä¹Ÿéƒ½ä¸æ”¯æ´\né€™ç®—æ˜¯è‡´å‘½å‚·äº†å§ï¼Œå¦‚æœä¸èƒ½æ•´åˆç¾åœ¨çš„ JS ç”Ÿæ…‹ç³»é‚£æ‡‰è©²å¾ˆå°‘äººæ•¢æ¡ç”¨é€™å¥—æ–¹æ¡ˆã€‚\næ‰€ä»¥ ES4X æ˜¯ä¸€å€‹å…¨æ–°åŸºæ–¼ Vertx é–‹ç™¼çš„ JS Runtimeï¼ŒåŠ å…¥äº† ES6+ çš„æ”¯æ´æ›´å¥½èˆ‡ç¾åœ¨ JSç”Ÿæ…‹ç³»æ•´åˆï¼Œæ‰€ä»¥ Promise / async-await ç­‰ç­‰éƒ½å¯ä»¥æ¡ç”¨ï¼ŒåŒæ™‚ Vertx çš„èªæ³•ä¹ŸåŒæ™‚æ”¯æ´ï¼Œä½œè€…æåˆ°ä¸‹ä¸€ç‰ˆçš„ Vertx æœƒæ£„ç”¨ç¾æœ‰çš„ Vertx JS æ”¹ç”¨ ES4Xã€‚\né¡Œå¤–è©±ï¼š\nä½œè€…äººå¾ˆå¥½ï¼Œåœ¨æ–‡ç« åº•ä¸‹æå•å¾ˆå¤šç–‘æƒ‘éƒ½åœ¨ 24 hr å…§å¾—åˆ°è§£ç­”ï¼ŒçœŸçš„æ˜¯å¾ˆæ„Ÿè¬\nGraalVM GraalVm æ˜¯ä¸€å€‹æä¾›å¤šèªè¨€çš„é‹è¡Œç’°å¢ƒï¼Œé€é Graal Compiler ç·¨è­¯æˆ Java Bytecode ä¸¦åŸ·è¡Œæ–¼ Java HotSpot VMä¸Šï¼Œæ‰€ä»¥å¯ä»¥å…¼å®¹æ–¼ JVM-based çš„èªè¨€å¦‚ Java/Scala/Kotlinç­‰ï¼›\né€é Truffer frameworkï¼Œå¯ä»¥å…¼å®¹å…¶ä»–çš„ç¨‹å¼èªè¨€ï¼Œå¦‚JS/Python/R/Rubyç­‰ç­‰\nè¨±å¤šç¨‹å¼èªè¨€éƒ½å¿…é ˆè¦æœ‰ä¸€å€‹è‰¯å¥½çš„é‹è¡Œç’°å¢ƒ Runtimeï¼Œä½†æ˜¯è¦æ‰“é€ ä¸€å€‹å®‰å…¨ã€é«˜æ•ˆçš„é‹è¡Œç’°å¢ƒæ˜¯éå¸¸å›°é›£ä¸”è€—æ™‚çš„ï¼Œä¾‹å¦‚èªª JSçš„ V8 Engine ä¹Ÿæ˜¯ Googleå¤šå¹´çš„æŠ•å…¥æ‰æœ‰é€™éº¼å¥½çš„æˆæœï¼Œå…¶ä»–èªè¨€ç›¸è¼ƒä¹‹ä¸‹æ²’æœ‰é€™éº¼å¤šè³‡æºï¼Œè‡ªç„¶é‹è¡Œçš„é€Ÿåº¦å°±å¾ˆæ…¢ï¼›\næ‰€ä»¥ GraalVMå¸Œæœ›é€éé€šç”¨åŒ–è™›æ“¬åŒ–æŠ€è¡“ï¼Œè®“ä¸åŒçš„ç¨‹å¼èªè¨€åªè¦ç”¨ Java é€éTruffle Framework å¯¦ä½œè©²èªè¨€çš„ ASTï¼Œå¾ŒçºŒçš„é‹è¡Œå°±äº¤çµ¦ GraalVMï¼Œé™ä½æ–°èªè¨€é–‹ç™¼çš„å›°é›£\né™¤äº†è®“åŸæœ¬çš„ç¨‹å¼èªè¨€åŸ·è¡Œå¾—æ›´å¿«ï¼Œæ¡ç”¨ GraalVMå¦ä¸€å¤§å¥½è™•æ˜¯å¯ä»¥æ··åˆèªè¨€(Polyglot)é–‹ç™¼ï¼Œä¾‹å¦‚ JSå…§ä½¿ç”¨ Rçš„å¥—ä»¶ï¼Œè®“ä¸åŒçš„èªè¨€ç™¼æ®å„è‡ªçš„é•·è™•ï¼Œè€Œä¸”æ•ˆèƒ½ä¸å—åˆ°è·¨èªè¨€çš„å½±éŸ¿ï¼Œå› ç‚ºä¸åŒçš„èªè¨€æœ€å¾Œéƒ½æ˜¯é€šé Truffle Framework ç”Ÿæˆ Graal Compiler äº†è§£çš„ASTï¼Œæœ€å¾Œ Compile å‡ºä¾†çš„æ©Ÿå™¨ç¢¼ä¸æœƒå› ç‚ºä¸åŒèªè¨€è€Œæœ‰æ‰€å·®ç•°\næ›´å¤šçš„ç´°ç¯€å¯ä»¥åƒè€ƒé€™æ”¯å½±ç‰‡\nå¯¦ä½œâ€Šâ€”â€Šç”¨ç¶²é é¡¯ç¤ºåœ–è¡¨ /æ¡ç”¨ GraalVM èˆ‡Â ES4X ç°¡å–®æ•´åˆå…©è€…çš„ Example Codeï¼Œç”¨ ES4X åŸ·è¡Œä¸€å€‹ Web Serverï¼Œä¸¦ç”¨ GraalVm ç•¶ä½œé‹è¡Œç’°å¢ƒï¼Œæ¡ç”¨ Rç¹ªè£½åœ–è¡¨ã€‚\nå®‰è£ åˆ° https://github.com/oracle/graal/releases/tag/vm-19.1.1 ä¸‹è¼‰å®‰è£æª”ï¼Œè§£å£“ç¸®å¾ŒåŠ å…¥è·¯å¾‘\n1 2 $ export PATH=\u0026lt;æª”æ¡ˆä½ç½®\u0026gt;/graalvm-ce-19.1.1/Contents/Home/bin:$PATH $ export JAVA_HOME=\u0026lt;æª”æ¡ˆä½ç½®\u0026gt;/Contents/Home è¨­å®šå¥½ä¹‹å¾Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å¹¾å€‹ commandï¼Œnode æ”¹æˆç”¨ GraalVMåŸ·è¡Œï¼Œé è¨­åƒ…æ”¯æ´ Java/Javascriptï¼Œå¦‚æœéœ€è¦å…¶ä»–èªè¨€å‰‡è¦ $gu install python ç­‰\n1 2 3 4 5 6 7 8 9 10 11 $ js runs a JavaScript console with GraalVM. $ node replacement for Node.js, using GraalVMâ€™s JavaScript engine. $ lli is a high-performance LLVM bitcode interpreter integrated with GraalVM. $ gu (GraalVM Updater) can be used to install language packs for Python, R, and Ruby. ç°¡å–®è©¦ä¸€ä¸‹è·¨èªè¨€çš„ç‰¹æ€§\n1 2 3 4 5 // å„²å­˜æˆ test.js var array = Polyglot.eval(\u0026#34;python\u0026#34;, \u0026#34;[1,2,42,4]\u0026#34;) console.log(array[2]); $ node --polyglot --jvm test.js ä½¿ç”¨ Ployglot.eval å¯ä»¥åŸ·è¡Œå…¶ä»–æŒ‡å®šèªè¨€çš„èªæ³•ï¼Œ\nå‰›åŸ·è¡Œæ™‚æœƒéœ€è¦èŠ±æ¯”è¼ƒå¤šçš„æ™‚é–“ warn upï¼Œæ‰€ä»¥å¦‚æœè¦ç•¶ä½œ Command line tool æˆ–å…¶ä»–ç”Ÿå‘½é€±æœŸçŸ­çš„æ‡‰ç”¨ç¨‹å¼ï¼Œå°±å»ºè­°ç¹¼çºŒä½¿ç”¨ Nodejs å³å¯ï¼›\né•·æ™‚é–“é‹è¡Œçš„è©±ï¼ŒGraalVM çš„æ•ˆèƒ½èˆ‡ V8 å…¶å¯¦æ˜¯å·®ä¸å¤šçš„ï¼Œä½†å¦‚æœå¤šè€ƒé‡è·¨èªè¨€çš„ç‰¹æ€§ï¼ŒGraalVM æœƒæ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡\nES4X å…ˆå®‰è£åˆå§‹åŒ–\n1 2 3 4 5 6 7 8 9 10 $ npm install -g es4x-pm $ mkdir test $ npm init $ es4x init // å®‰è£æ‰€éœ€å¥—ä»¶ $ npm install @vertx/unit --save-dev $ npm install @vertx/core --save-prod $ npm install @vertx/web --save-prod $ npm install index.jsï¼Œæ¥è‘—ç”¨ $npm run start åŸ·è¡Œ\n1 2 3 4 5 6 7 8 9 /// \u0026lt;reference types=\u0026#34;@vertx/core/runtime\u0026#34; /\u0026gt; // @ts-check vertx .createHttpServer() .requestHandler(async function (req) { req.response().end(\u0026#34;hello world.\u0026#34;); }) .listen(8080); éœ€æ³¨æ„ï¼Œå¦‚æœè¦é”åˆ°æœ€ä½³æ€§èƒ½çš„æå‡éœ€è¦ä½¿ç”¨å®ƒæä¾›çš„ web framework @vertx/webï¼Œå¦‚æœæ˜¯ä½¿ç”¨åƒ Express.jsåº•å±¤çš„ System API Call å°±ä¸æœƒèµ° Vertxï¼Œè€Œæ˜¯ç”¨ç•¶ä¸‹ Runtime ç’°å¢ƒçš„è™•ç†æ–¹å¼ (Node.js or GraalVM)ï¼Œç´°ç¯€é‚„éœ€è¦æ›´è¿‘ä¸€æ­¥ç†è§£å°ˆæ¡ˆæ‰èƒ½è§£é‡‹ï¼Œä¸éå¾ä½œè€…çš„æè¿°ç¾æ³æ˜¯å¦‚æ­¤ï¼Œæ‰€ä»¥èˆŠå°ˆæ¡ˆè¦ç§»æ¤æœƒé‡å¯«çš„é–€æª»\nå¦å¤–ç›®å‰ä¸æ”¯æ´ GraalVMçš„ Polyglotï¼Œå·²å›å ±çµ¦ä½œè€…éœ€è¦ç­‰ä»–å¯¦ä½œã€‚\nç¸½çµ è·³è„«æ¡†æ¶ï¼Œä»¥å‰æ²’æƒ³éé€éæ›¿æ› JS Runtime å¯ä»¥æ›å–æ€§èƒ½çš„æå‡ï¼Œä¹Ÿä¸æ›¾æ¥è§¸éåƒ GraalVMé€™æ¨£å¤šèªè¨€æ”¯æ´çš„ Runtimeï¼Œç´°ç¯€æœ‰è »å¤šé—œæ–¼ Compiler ç›¸é—œçš„çŸ¥è­˜ï¼Œè‡ªå·±å¾ˆå¤šéƒ½å¿˜äº†ï¼Œéœ€è¦åœ¨åŠ å¼·æ‰è¡Œ\nç¸½çµç›®å‰ä½¿ç”¨ GraalVMèˆ‡ ES4X\nGraalVM å¯ä»¥æ¸¬è©¦é€šé npm 90%çš„ packageï¼Œé™¤äº†ä¸€äº› native code ç·¨å¯«çš„ libraryï¼Œå…¶ä»–ä¸å¤ªéœ€è¦æ“”å¿ƒæ”¯æ´åº¦å•é¡Œï¼› GraalVM èªæ³•æ”¯æ´åˆ°æœ€æ–°çš„ ES2019/2020ï¼Œé€™é»é‚„è »ä¸éŒ¯çš„ GraalVM æ€§èƒ½å°æ¯”èˆ‡ V8ä¸å·®å¤šå°‘ï¼Œåªæ˜¯è¦ä¸€æ®µ warm up çš„æ™‚é–“ï¼Œå¦‚æœæœ‰è·¨èªè¨€æ•´åˆéœ€æ±‚ï¼Œå¯ä»¥è€ƒæ…®çœ‹çœ‹ ES4X å¯ä»¥çµåˆ Vert.x èˆ‡ GraalVMå„ªé»ï¼Œå¾—åˆ°å¤§é‡çš„æ€§èƒ½æå‡ï¼Œä½†æ˜¯å°ˆæ¡ˆé‚„æ²’ç©©å®šï¼Œéœ€è¦è€ƒé‡ï¼›\né–‹ç™¼ä¹Ÿå¿…é ˆç”¨ä»–çš„ Frameworkï¼Œä½¿ç”¨ Express.js / Koa.js ç­‰ç”¨æˆ¶ç„¡æ³•ç„¡ç—›è½‰ç§» ","date":"2019-08-18T11:31:29.945Z","permalink":"https://yuanchieh.page/posts/2019/2019-08-18-%E8%AE%93-node.js-%E8%B7%91%E5%BE%97%E6%9B%B4%E5%BF%AB-es4x-%E5%B0%88%E6%A1%88%E8%88%87graal-vm-%E4%BB%8B%E7%B4%B9/","title":"è®“ Node.js è·‘å¾—æ›´å¿«! ES4X å°ˆæ¡ˆèˆ‡Graal VM ä»‹ç´¹"},{"content":"åœ¨æœ€æ–°çš„ä¸€æœŸ Javascript Weekly ä¸­çœ‹åˆ° V8 éƒ¨è½æ ¼ 2019/07/09 çš„æ–‡ç« ï¼Œè£¡é ­æåˆ° ECMAScript Spec å°‡ Sorting æ”¹æˆ Stableï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ’åºä¸Šå…©å€‹å…ƒç´ é †åºç›¸åŒï¼Œå‰‡æœ€çµ‚æ’åºå®Œæˆçš„é™£åˆ—ä¸­çš„ç›¸åŒé †åºå…ƒç´ ï¼Œæœƒä¾ç…§åŸæœ¬çš„é †åºæ’åˆ—ï¼Œä¾‹å¦‚\n1 [{name: \u0026#39;a\u0026#39;, value: 2}, {name: \u0026#39;b\u0026#39;, value: 2}, {name: \u0026#39;c\u0026#39;, value: 1}] ä¾ç…§ value æ’åº ===\u0026gt;\n1 2 3 [{name: \u0026#39;c\u0026#39;, value: 1}, {name: \u0026#39;a\u0026#39;, value: 2}, {name: \u0026#39;b\u0026#39;, value: 2}] // a è·Ÿ b é †åºç›¸åŒï¼Œè€Œ a ç¶­æŒåœ¨ b ä¹‹å‰ å…ˆå‰çš„ Spec æ²’æœ‰ç‰¹åˆ¥å®šç¾©ï¼Œæ‰€ä»¥å„å¹³å°çš„å¯¦ä½œä¸åŒï¼Œä¹‹å¾ŒChrome 70+ èˆ‡ Nodejs 12+ é–‹å§‹æ”¯æ´ Stable Sortingï¼Œå…¶é¤˜çš„å¹³å°é‚„ä¸ç¢ºå®šã€‚\nTimSort Timsort\nä½œè€…åŸæ–‡\nhttp://svn.python.org/projects/python/trunk/Objects/listsort.txt\nåƒè€ƒè‡ªç¶­åŸºï¼ŒTim Sort åŸç†æ˜¯ç”± Tim Peter åŸºæ–¼ Merge Sort èˆ‡ Insertion Sortæ‰€è¨­è¨ˆçš„æ’åºæ¼”ç®—æ³•ï¼ŒTim è§€å¯Ÿåˆ°å¯¦éš›ä¸–ç•Œçš„é™£åˆ—å¤šåŠæ˜¯ç”±å¤šå€‹éƒ¨åˆ†æ’åºçš„æ•¸åˆ—æ‰€çµ„æˆï¼Œæ‰€ä»¥ Tim Sort æœƒå…ˆæ‰¾å‡ºé™£åˆ—ä¸­æ’åºå¥½çš„å­é™£åˆ—(ç¨±ç‚º run)ï¼Œä¸æ–·çš„åˆä½µ run ç›´åˆ°æ•´é«”æ’åºçµæŸï¼ŒåŸºæ–¼é€™æ¨£çš„åŸç†å¯ä»¥è¨­è¨ˆå‡ºæ›´å¥½çš„æ’åºæ¼”ç®—æ³•ã€‚\nä½œè€…æåˆ°ï¼Œrandom array æœ€ä½³çš„æ’åºæ³•è¢« bound åœ¨ O(nlog n) (æ–‡ä¸­æ˜¯ç”¨ O(n!)ï¼Œå…©è€…ç­‰åƒ¹)ï¼Œä½†æ˜¯ä¸åŒçš„ O(nlog n)ç­‰ç´šçš„ sorting æ¼”ç®—æ³•é›¢ O(log n) çš„æ¥µé™å€¼é‚„æ˜¯æœ‰å·®è·ï¼ŒTimsort å¤§æ¦‚è·é›¢æ¥µé™å€¼ 1%ï¼Œè€Œä¸€èˆ¬çš„ quick sort å‰‡æ˜¯ 39% ä¹‹é ï¼›\nèˆ‡åŸæœ¬ Python native çš„ sample sort ç›¸æ¯”å…©è€…å·®ç•°ä¸å¤§ï¼Œrandom array Timsort è¼ƒå·®ï¼Œä½†æ˜¯ Timsort é‡å°éƒ¨åˆ†æ’åºçš„é™£åˆ—è¡¨ç¾æ›´ä½³ã€‚\nç›®å‰ Pythonã€Android SDKã€Java SDKã€Chrome ã€Swift å…§éƒ¨çš„ sort() éƒ½æ¡ç”¨ Tim Sortï¼Œæ‡‰ç”¨éå¸¸å»£æ³›ã€‚\nåŸºæœ¬è§€å¿µ Understanding timsort, Part 1: Adaptive Mergesort\nç›´æ¥æ­»ç£• Wikiæœ‰é»çœ‹ä¸æ‡‚ï¼Œæ¯å€‹è‹±æ–‡å¥å­éƒ½æ‡‚ä½†å°±æ˜¯ç„¡æ³•ç†è§£èƒŒå¾Œè¨­è¨ˆçš„å«ç¾©ï¼Œç¶²è·¯ä¸Šçœ‹åˆ°é€™ç¯‡æœ€æ·ºé¡¯æ˜“æ‡‚çš„è§£é‡‹ï¼Œä»¥ä¸‹ç°¡å–®æ‘˜éŒ„é‡é»å¹«åŠ©ç†è§£ã€‚\nTim Sort è„«èƒæ–¼ Merge Sortï¼Œè©¦è‘—ç”¨é€™ä¸‰å€‹æ–¹å‘å»å„ªåŒ– Merge Sort\nè®“ merge éç¨‹æ›´å¿« è®“ merge æ¬¡æ•¸è®Šå°‘ åœ¨ç‰¹æ®Šæ¢ä»¶ä¸‹ç”¨æ›´å¥½çš„æ–¹å¼å–ä»£ Merge Sort è©¦æƒ³æœ‰å€‹é™£åˆ—\n{5, 6, 7, 8, 9, 10, 1, 2, 3}\nç”¨æ€æ¨£çš„æ–¹å¼å¯ä»¥ç”¨æœ€å°‘çš„ merge å®Œæˆæ’åºï¼Ÿ\nç›´è¦ºä¾†çœ‹ï¼ŒæŠŠé™£åˆ—æ‹†æˆå…©å€‹å·²ç¶“æŒ‰ç…§å‡åºæ’åºçš„é™£åˆ— {5,6,7,8,9,10} èˆ‡ {1,2,3} ç„¶å¾Œåˆä½µï¼Œåªéœ€è¦ä¸€æ¬¡ merge å°±å¯ä»¥å®Œæˆ\nå‡ä½¿æˆ‘å€‘å…ˆæå‡ºä¸€å€‹æ¼”ç®—æ³•ï¼šæ‰¾åˆ°é™£åˆ—é–‹é ­æœ€é•·çš„é€£çºŒå‡åºæ’åºçš„é™£åˆ—ï¼Œå…¶é¤˜ç•¶ä½œç¬¬äºŒå­é™£åˆ—ï¼Œä»¥éè¿´æ–¹å¼æŒçºŒè™•ç†\né€™å€‹æ¼”ç®—æ³•åˆ©ç”¨äº†å·²æ’åºçš„é™£åˆ—å»æ¸›å°‘ merge çš„æ¬¡æ•¸ï¼Œä½†æœ‰å€‹å•é¡Œ å¦‚æœé™£åˆ—å‰›å¥½æ˜¯å€’åºï¼Œå°±æœƒè½å…¥ worst case O(nÂ²) ï¼Œç¨±ä¸ä¸Šæ˜¯å€‹ç†æƒ³çš„æ’åºæ¼”ç®—æ³•ï¼Œæ‰€ä»¥å¯¦ä½œæ™‚æœƒè£œä¸Šå¦‚æœç™¼ç¾é€£çºŒçš„å­é™£åˆ—æ˜¯é™åºï¼Œå‰‡ in memory ååºã€‚\nå…ˆé€€å›æœ€åŸºæœ¬çš„ Merge Sort\n1 2 3 {{1}, {2}, {3}, {4}} {{1, 2}, {3, 4}} {{1, 2, 3, 4}} é€™æ˜¯ Merge Sort çš„æµç¨‹ï¼Œå°‡é™£åˆ—åˆ†æ‹†åˆ°ç‚ºä¸€ç„¶å¾Œåœ¨é€æ­¥ mergeï¼Œæˆ‘å€‘å°‡ç¬¬ä¸€æ­¥åˆ†æ‹†çš„éç¨‹æ”¹ç‚ºå·²æ’åºå¥½çš„å€é–“(ç¨±ç‚º Run)ï¼Œç„¶å¾Œé€²è¡Œ mergeã€‚\nTim Sort åœ¨ merge æ™‚æœƒç›¡é‡ Balanceï¼Œæ‰€ä»¥æœƒè¨­å®š minrunï¼Œå¦‚æœé€™æ¬¡çš„ RUN é•·åº¦å°æ–¼ minrunï¼Œå‰‡æœƒè£œè¶³åˆ° minruné•·åº¦å¾Œï¼Œæ¥è‘—ä½¿ç”¨ binary insertion sortï¼Œå¦‚ä½•é¸æ“‡ minrun æ˜¯å€‹å­¸å•ï¼Œä½œè€…æåˆ°ä¸€å€‹å¯¦å‹™ä¸Šçš„è¨­å®šæ˜¯\ntake the first 6 bits of N, and add 1 if any of the remaining bits are set\nN æ˜¯é™£åˆ—é•·åº¦ï¼Œæœ€ä¸»è¦æ˜¯å¸Œæœ›å¦‚æœé‡åˆ° random arrayï¼Œå‰‡N ç›¡å¯èƒ½è¢« minrun åˆ‡æˆ 2 æ¬¡æ–¹å€ RUNï¼Œåœ¨ merge æ™‚å¯ä»¥æœ€å¹³è¡¡ã€‚\nminRun æ˜¯å¸Œæœ›å‰©é¤˜çš„æ•¸å†åˆ†minrunçš„æ™‚å€™èƒ½ç›¡å¯èƒ½æ˜¯2çš„å†ªæ¬¡ï¼Œå¾ŒçºŒå†åšmergeçš„æ™‚å€™æ‰èƒ½å…©å…©åˆä½µæ•ˆç‡è¼ƒé«˜ï¼›\nå¯¦ä½œä¸Šæœƒä¸æ–·å°‡né™¤ä»¥äºŒ ç›´åˆ°n\u0026lt;MIN_MERGEï¼Œè€Œä¸­é–“åªè¦æœ‰ä»»ä½•ä¸€æ¬¡ä¸èƒ½è¢«2æ•´é™¤ï¼Œæœ€çµ‚çµæœå°±åŠ ä¸€ï¼Œé€™æ¨£å–çš„minRunæœƒè®“åˆ†çµ„æœ€æ¥è¿‘2å†ª\n(æ„Ÿè¬å…¬å¸åŒäº‹ Frank è£œå……)\nä¾‹å¦‚ N = 2112ï¼Œminrun = 32 æœƒåˆ‡æˆ 66å€‹RUNï¼Œå‰‡åˆä½µæ™‚æœ€å¾Œæœƒè®Šæˆ 2048 + 64ï¼Œå…©è€…éå¸¸ä¸å¹³è¡¡ï¼›\nä½†å¦‚æœ minrun æ˜¯ 33ï¼Œå‰‡æœƒè¢«åˆ‡æˆ 64å€‹RUNï¼Œåˆ‡å‰²æˆ 2çš„ n æ¬¡æ–¹å€‹æ•¸åˆä½µèµ·ä¾†å°±å¾ˆå¹³è¡¡ (perfect balanced)ã€‚\næ±ºå®šä½•æ™‚ merge? Tim Sort æœƒç”¨ä¸€å€‹ Stack æš«å­˜ RUNï¼Œä¸¦ä¸æ˜¯ä¸€é–‹å§‹å°±è¼ªè©¢æ•´å€‹é™£åˆ—ç”¢ç”ŸRUNï¼Œè€Œæ˜¯é€æ­¥é€²è¡Œï¼Œé¿å…è¦ç”¨æ‰éå¤šçš„è¨˜æ†¶é«”ã€‚\nåŸºæ–¼é€™å…©å€‹åŸå‰‡ï¼ŒTim Sort å¯¦ä½œä¸Šæœ‰å€‹å‡½å¼ merge_collapse ï¼Œé€™å€‹å‡½å¼ä¸»è¦åˆ¤æ–·ç›®å‰ Stack æœ€ä¸Šå±¤çš„ä¸‰å€‹ RUN æ˜¯å¦ç¬¦åˆä»¥ä¸‹è¦å‰‡\n1 2 1\\. A \u0026gt; B+C 2\\. B \u0026gt; C å¦‚æœç¬¦åˆï¼Œå‰‡å°‡ä¸‹ä¸€å€‹ RUN push åˆ° Stackä¸Šï¼Œåä¹‹å‰‡æ¯”è¼ƒ Aè·Ÿï¼£ï¼Œè¼ƒå°è€…èˆ‡ B mergeï¼Œä¾‹å¦‚\n1 2 A:30 B:20 C:10 A \u0026lt;= B + C æ‰€ä»¥ä¸ç¬¦åˆ merge_collapseï¼Œåˆå› ç‚º C \u0026lt; Aï¼Œæ‰€ä»¥ C è·Ÿ B merge è®Šæˆ A:30 BC: 30 é€éé€™æ¨£çš„æ–¹å¼ï¼Œè®“ä¿ç•™åœ¨ Stack ä¸Šçš„ RUN é•·åº¦å¹³è¡¡ï¼Œå¦ä¸€å€‹é‡é»æ˜¯åˆä½µåªèƒ½æ˜¯ A+(B+C) æˆ–æ˜¯ (A+B)+Cï¼Œå› ç‚ºè¦ä¿æŒ Stableï¼Œæ‰€ä»¥ merge ä¸€å®šè¦ç›¸é„°å…©å€‹ RUNã€‚\nå¦‚ä½• merge è¦å°‡å…©å€‹ç›¸é„°å­é™£åˆ—ï¼Œç”¨ in memory æ–¹å¼ merge åœ¨å¯¦ä½œä¸Šæœƒæœ‰å›°é›£ï¼Œå¯¦å‹™ä¸Šå› ç‚ºè¦é€ æˆå¤§é‡çš„ memory æ“ä½œå…¶å¯¦ä¹Ÿä¸æœƒæ¯”è¼ƒå¿«ï¼Œæ‰€ä»¥ Tim Sort ä½¿ç”¨ä¸€å¡Šæš«å­˜è¨˜æ†¶å€ï¼Œå¤§å°ç‚º (A,B) é™£åˆ—çš„æœ€å°é•·åº¦\nå¦‚æœ A \u0026lt; Bï¼Œå‰‡å…ˆå°‡ A æ”¾é€²æš«å­˜è¨˜æ†¶å€ï¼Œæœ€ç›´è¦ºçš„æ–¹å¼æ˜¯ A è·Ÿ B å¾é ­é–‹å§‹æ¯”å°ï¼Œå°çš„æ”¾é€² A çš„ä½ç½®ï¼Œç›´åˆ° A è·Ÿ B æ’åºå®Œæˆï¼Œå¦‚åŒä¸€èˆ¬ merge sort çš„åšæ³•ï¼Œåˆç¨±ç‚º one-pair-at-a-timeã€‚\nä½†å› ç‚º A è·Ÿ B éƒ½å·²ç¶“æ˜¯æ’åºå¥½çš„é™£åˆ—ï¼Œæ‰€ä»¥æœ‰å€‹å„ªåŒ–çš„æ–¹å¼æ˜¯æ‰¾å‡º B[0] åœ¨ Aé™£åˆ—æ’åºçš„ä½ç½®ï¼Œç„¶å¾ŒAè©²ä½ç½®ä¹‹å‰éƒ½æ˜¯å°æ–¼ B[0]ï¼Œæ‰€ä»¥å¯ä»¥æ•´æ®µæ”¾é€²å»ï¼Œæ¥è‘—æ‰¾å‰©é¤˜A[0]åœ¨ Bçš„ä½ç½®ï¼Œä¸æ–·è¼¾è½‰ç›´åˆ°æ’åˆ—çµæŸï¼Œä¹Ÿå°±æ˜¯ gollaping modeã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 A: [1,2,3,7,8,9] B: [4,5,6,8,9,10,11] A \u0026lt; Bï¼Œæ‰€ä»¥ A æ”¾å…¥æš«å­˜å€ temp å…ˆæ‰¾ B[0] åœ¨ A çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯åœ¨ A[2]ã€A[3]ä¹‹é–“ï¼Œå› ç‚º B[0] \u0026gt; A[2]ï¼Œä¹Ÿå°±æ˜¯ A[0]~A[2] å¯ä»¥ç›´æ¥æ”¾å›å»ï¼Œè®Šæˆ A: [1,2,3] B: [4,5,6,8,9,10,11] temp: [7,8,9] æ¥è‘—æ‰¾ temp[0] åœ¨ Bçš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ B[2]ã€B[3] ä¹‹é–“ï¼Œè®Šæˆ A: [1,2,3,4,5,6] B: [9,10,1] temp: [7,8,9] æ¥è‘—æ‰¾ B[0] åœ¨ temp çš„ä½ç½®ï¼ŒæŒçºŒåè¦† é€™å„ªåŒ–çš„æ–¹å¼å¤§å¤šæ•¸æ˜¯æœ‰æ­£å‘çš„æ•ˆæœï¼Œä½†å¦‚æœé‡åˆ° random arrayï¼Œå¯èƒ½æœƒæ¯”åŸæœ¬çš„ one-pair-at-a-time é‚„è¦æ…¢ï¼Œä½†ä½œè€…æåŠ\nIt\u0026rsquo;s generally true in this algorithm that we\u0026rsquo;re willing to gamble a little to win a lot, even though the net expectation is negative for random data\né¢¨éšªèˆ‡æ”¶ç›Šè©•ä¼°å¾Œï¼Œæ•´é«”é‚„æ˜¯æ­£å‘çš„ï¼Œæ‰€ä»¥å°±æ±ºå®šæ¡ç”¨ã€‚\nå¯¦å‹™ä¸Šæœ‰ä¸€å€‹å›ºå®šåƒæ•¸ MIN_GALLOP =7 èˆ‡è®Šå‹•åƒæ•¸ minGallopï¼Œä¸€é–‹å§‹æ¡ç”¨ one-pair-at-a-time modeï¼Œä¸€ç›´åˆ°æŸå€‹é™£åˆ—çš„é¦–ä½å…ƒç´ æŒçºŒå¤§æ–¼å¦ä¸€é™£åˆ—ï¼Œæ‰åˆ‡æ›åˆ° galloping modeï¼›\nå¦‚æœ galloping search(çœ‹å¾ŒçºŒ)æ‰¾åˆ°çš„å…ƒç´ ä½ç½®å°æ–¼MIN_GALLOP å‰‡é€€å› one-pair-at-a-time modeï¼Œåä¹‹å‰‡æŒçºŒç”¨ galloping modeï¼›\nå¦‚æœä¸€ç›´åœ¨ galloping searchï¼Œæœƒä¸‹ä¿® minGallopï¼Œä¹Ÿå°±æ˜¯æ›´å®¹æ˜“é€²å…¥ galloping mode çš„æ„æ€ã€‚\nåè¦†åŸ·è¡Œåˆ°å…©å€‹é™£åˆ—åˆä½µå®Œæˆ\næ‰¾å‡ºæŸæ•¸åœ¨å·²æ’åºé™£åˆ—ä¸­çš„ä½ç½® é€²å…¥ galloping mode æ™‚ï¼Œæœƒéœ€è¦ä¸æ–·çš„æŸ¥æ‰¾æŸæ•¸åœ¨å·²æ’åºé™£åˆ—çš„ä½ç½®ï¼Œå‡è¨­ A æ˜¯è¼ƒçŸ­çš„é™£åˆ—ï¼Œä¸€é–‹å§‹æ‰¾ A[0] åœ¨ Bé™£åˆ—æ‡‰æ’åºçš„ä½ç½®ï¼Œæœ€ç›´è¦ºçš„æ–¹å¼æ˜¯ç”¨ binary searchï¼Œä½†é€™é‚Šä½œè€…æ”¹æ¡ç”¨å¦ä¸€å€‹æ¼”ç®—æ³• galloping search(åˆç¨± expotential search)\nç›¸è¼ƒæ–¼ binary search ä¸æ–·å°åŠåˆ‡æŸ¥æ‰¾ï¼Œgalloping search æ˜¯æ¯”å° (2^k)th å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æ‰¾ 1, 3, 5, 7, 15 é€™æ¨£çš„æ–¹å¼ï¼Œç•¶æ‰¾åˆ° (2^(j-i)) \u0026lt; x \u0026lt; (2^j) æ™‚ï¼Œåœ¨æ”¹ç”¨ binary searchã€‚\næ¯”è¼ƒé€™å…©è€…ï¼Œ galloping search çš„æ™‚é–“è¤‡é›œåº¦æ˜¯ O(i)ï¼Œi æŒ‡çš„æ˜¯ x åœ¨æŸ¥è©¢é™£åˆ—çš„ä½ç½®ï¼Œå¦‚æœ i å¾ˆå‰é¢é‚£æ•ˆç‡å°±æœƒå¾ˆé«˜ï¼›\nbinary search æ™‚é–“è¤‡é›œåº¦ç‚º O(n)ï¼Œn æ˜¯æŸ¥è©¢é™£åˆ—çš„é•·åº¦ã€‚\nè€Œ n â‰¥ i ï¼Œæ‰€ä»¥å¾æ™‚é–“è¤‡é›œåº¦ä¾†çœ‹ galloping search æœƒæ¯” binary search é‚„è¦å¿«ä¸€äº›ã€‚\nä½†å¯¦éš›ä¸Šï¼Œå› ç‚ºé™£åˆ—æ˜¯éš¨æ©Ÿçš„ï¼Œæ¡ç”¨ galloping search å¯èƒ½æœƒæ¯” linear search æ…¢ï¼Œä½œè€…åˆ—å‡º galloping search å°æ¯” linear search çš„è¨ˆç®—èŠ±è²»ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ i=7 ä¹‹å‰ galloping search æœƒéœ€è¦æ›´å¤šçš„æ¯”è¼ƒæ¬¡æ•¸ï¼Œè€Œæ¯”è¼ƒæ˜¯å¾ˆèŠ±è¨ˆç®—è³‡æºçš„ï¼Œæ‰€ä»¥ MIN_GALLOPé è¨­æ˜¯ 7ã€‚\nç¸½çµæ¼”ç®—æ³• ç¨å¾®ç¸½çµä¸€ä¸‹ï¼ŒTimsort ç¶­è­·ä¸€å€‹ Stackï¼ŒStack ä¸Šæœƒ push å·²æ’åºçš„é€£çºŒå­é™£åˆ—ï¼Œä¸¦é€é merge_collapse åˆ¤æ–·æ˜¯å¦å…ˆ merge Stack ä¸Šçš„é™£åˆ—ï¼Œç›¡é‡ä¿æŒå­é™£åˆ—çš„é•·åº¦æ¥è¿‘ï¼›\nmerge éç¨‹ï¼Œå‰‡æ˜¯å‹•æ…‹åœ¨ one-pair-at-a-time èˆ‡ galloping mode ä¸­åˆ‡æ›ï¼Œç”¨æœ‰æ•ˆç‡çš„æ–¹å¼åˆä½µå…©å€‹å·²æ’åºå¥½çš„é™£åˆ—ï¼›\né€²å…¥ç¨‹å¼ç¢¼ æœ€çµ‚é‚„æ˜¯è¦çœ‹ä¸€ä¸‹ä»£ç¢¼ï¼ŒåŸä½œè€…æ˜¯ç”¨ Cå¯«ï¼Œå› ç‚º java code æ¯”è¼ƒå¥½é–±è®€åƒè€ƒ android TimSort å¯¦ä½œ\nluni/src/main/java/java/util/TimSort.java - platform/libcore - Git at Google\nä¹Ÿæœ‰ js ç‰ˆï¼Œä½†æ˜¯è¨»è§£è¼ƒå°‘\nmziccard/node-timsort\nminRunLength() å®šç¾©å¦‚ä½•æ±ºå®š minrunçš„å€¼\n1 2 3 4 5 int r = 0; // Becomes 1 if any 1 bits are shifted off while (n \u0026gt;= MIN_MERGE) { r |= (n \u0026amp; 1); n \u0026gt;\u0026gt;= 1; } return n + r; gallopLeft() ç”¨ galloping search æ‰¾å‡ºæœ€å·¦ â‰¤ element çš„ä½ç½®ï¼Œå› ç‚ºæ˜¯ pass æ•´å€‹ array çš„ referenceï¼Œæ‰€ä»¥æœƒæœ‰ base / hint å»å®šä½å…ƒç´ ï¼Œçœ‹èµ·ä¾†ç¨å¾®è¤‡é›œ\nmergeLo()ã€mergeHi() åˆ†åˆ¥å°æ‡‰ (A+B)+C / A+(B+C) å…©ç¨®æƒ…æ³ï¼Œé‚è¼¯é¡ä¼¼ï¼Œ outer æ®µè½å°±æ˜¯åœ¨ one-pair-at-a-time modeï¼Œåªæœ‰ä»»ä¸€é‚Šé™£åˆ—é€£çºŒå¤§æ–¼ minGallop æ‰æœƒåˆ‡åˆ° galloping modeï¼›\næ¥è‘—å† galloping modeï¼Œæ‰¾åˆ°çš„å…ƒç´ å¿…é ˆä½ç½®å¤§æ–¼ MIN_GALLOPï¼Œå¦å‰‡å°±æœƒè·³å‡º galloping modeï¼ŒåŒæ™‚ minGallopæœƒ +=2ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡å¾…åœ¨ one-pair-at-a-time mode æœƒæ›´ä¹…ã€‚\né€é minGallop èˆ‡ MIN_GALLOPï¼Œç¢ºä¿ merge åœ¨å…©ç¨®æ¨¡å¼ä¸­å–å¾—è¼ƒä½³çš„æ•ˆç‡ã€‚\nBUG å¦‚æœå†æŸ¥ TimSortï¼Œä½ å¯èƒ½æœƒæ‰¾åˆ°é€™ä¸€ç¯‡æ–‡ç« \nEnvisage: Engineering Virtualized Services\nä¸»è¦åœ¨è¬› java ç‰ˆçš„å¯¦ä½œï¼Œå¯èƒ½æœƒå‡ºç¾ OutMemeroyBound çš„å•é¡Œï¼Œä¸»è¦æ˜¯å› ç‚ºåœ¨ allocate Stack çš„é•·åº¦æ™‚ï¼Œæœƒæœ‰ä»¥ä¸‹æ¥µç«¯ç‹€æ³å°è‡´ Stack é•·åº¦é è¨­éçŸ­è€Œè¨˜æ†¶é«”ä¸å¤ ç”¨\nå•é¡Œå‡ºåœ¨timsortæœ¬èº«çš„ç´„æŸæ¢ä»¶\n1 2 1\\. runLen[i-2] \u0026gt; runLen[i-1] + runLen[i] 2\\. runLen[i-1] \u0026gt; runLen[i] åœ¨runLenç‚ºä»¥ä¸‹æƒ…æ³æ™‚ï¼Œ120, 80, 25, 20, 30ï¼Œ25\u0026lt;20+30æ‰€ä»¥é€²è¡Œrun[3]ï¼Œrun[4]åˆä½µï¼Œè®Šç‚ºï¼Œ120, 80, 45, 30\né€™æ™‚å€™ç”±æ–¼ 80\u0026gt;45+30, 45\u0026gt;30 æ¢ä»¶æ»¿è¶³äº†ï¼Œmergeå°±çµ‚æ­¢äº†\nä½†æ­¤æ™‚120\u0026lt;80+45æ˜¯ä¸æ»¿è¶³ç´„æŸæ¢ä»¶çš„ï¼Œä½†æˆ‘å€‘åªå°ä¸Šå±¤é€²è¡Œåˆ¤æ–·\nå¦‚æœï¼ˆç²¾å¿ƒç­–åŠƒï¼‰ä¸€äº›ç‰¹æ®Šæ•¸çµ„é€ æˆå¤§é‡é€™æ¨£çš„æƒ…æ³ï¼Œè€Œåœ¨åŸå§‹ç¢¼ä¸­ ç©ºé–“æ˜¯é€™æ¨£ç”³è«‹çš„\n1 2 3 4 5 int stackLen = (len \u0026lt; 120 ? 5 : len \u0026lt; 1542 ? 10 : len \u0026lt; 119151 ? 19 : 40); runBase = new int[stackLen]; runLen = new int[stackLen]; ä¸Šé¢stackLen,æ˜¯æ»¿è¶³ä¸Šé¢æåˆ°çš„ç´„æŸæ¢ä»¶è·ŸMIN_MERGEæƒ…æ³ä¸‹å»ä¼°è¨ˆçš„æœ€å¤§å¯èƒ½æ•¸é‡ï¼Œä½†å‰›ä¹Ÿèªªäº†ï¼Œåªå°ä¸Šå±¤é€²è¡Œåˆ¤æ–·ï¼Œæœƒæœ‰ä¾‹å¤–ç‹€æ³å°è‡´æ‰€éœ€è¦çš„å¤§å°å¯èƒ½è¶…å‡ºåŸæœ¬é æƒ³çš„ï¼Œè‡³æ–¼ä¿®å¾©çš„æ–¹å¼æ˜¯æŠŠæª¢æŸ¥æœ€å¾Œä¸‰å€‹runLenè®Šæˆæª¢æŸ¥æœ€å¾Œå››å€‹runLen\n1 2 3 4 5 6 7 8 9 10 11 private void newMergeCollapse() { while (stackSize \u0026gt; 1) { int n = stackSize - 2;** if ( (n \u0026gt;= 1 \u0026amp;\u0026amp; runLen[n-1] \u0026lt;= runLen[n] + runLen[n+1]) || (n \u0026gt;= 2 \u0026amp;\u0026amp; runLen[n-2] \u0026lt;= runLen[n] + runLen[n-1])) { if (runLen[n - 1] \u0026lt; runLen[n + 1]) n--; } else if (runLen[n] \u0026gt; runLen[n + 1]) { break; // Invariant is established } mergeAt(n); } } ä»¥ä¸Š Bug éƒ¨åˆ†ä¹Ÿæ˜¯ç”±å¼·è€…å…¬å¸åŒäº‹ Frank è£œå……ï¼Œæœ‰èˆˆè¶£è€…å¯ä»¥é»é€²å»çœ‹åŸæ–‡ï¼ŒåŸæ–‡åŒ…å«èªªæ˜äº†å¦‚ä½•ç”¨å·¥å…·èˆ‡æ–¹æ³•æ‰¾å‡ºå•é¡Œçš„ï¼Œä½†å› ç‚ºé‚„æ²’æœ‰åˆ°éå¸¸ç†è§£å°±ä¸å¤šåšèªªæ˜ã€‚\né€™ Bug å·²ç¶“è¢«ä¿®å¾©ï¼Œåœ¨ Python çš„ Bugå›å ±è¨è«–ä¸­ï¼ŒTim Peter æåˆ°å…¶å¯¦ç¾æœ‰çš„æ©Ÿå™¨æ²’æœ‰è¶³å¤ çš„ Memory å»ç”¢ç”Ÿé€™æ¨£çš„å•é¡Œï¼ŒJava ç‰ˆå¯¦ä½œä¹Ÿæ˜¯æœ‰ä¸€äº›æ”¹å‹•æ‰æœ‰è¾¦æ³•å¾©ç¾ï¼Œä¸éæœ€çµ‚åŸºæ–¼é‚è¼¯çš„å®Œæ•´æ€§ï¼Œé‚„æ˜¯å…ˆä¿®å¾©äº†æ­¤å•é¡Œï¼Œé¿å…æœªä¾†æœ‰å•é¡Œã€‚\nV8çš„å¯¦ä½œ Getting things sorted in V8\nå‰è¨€ åœ¨è©•ä¼°æ’åºæ¼”ç®—æ³•ä¸Šï¼Œæœƒè€ƒé‡æ¯”å°æ¬¡æ•¸è·Ÿè¨˜æ†¶é«”ç”¨é‡ï¼Œåœ¨å‹•æ…‹èªè¨€åŒ…å« JS ä¸­æ¯”å°æ¬¡æ•¸ç›¸å°é‡è¦ï¼Œå› ç‚ºåœ¨æ¯”å°çš„æ™‚å€™æœƒä½¿ç”¨åˆ°ç”¨æˆ¶å¯«çš„ç¨‹å¼ç¢¼\n1 2 3 4 5 6 7 8 const array = [4, 2, 5, 3, 1]; function compare(a, b) { // Arbitrary code goes here, e.g. `array.push(1);`. return a - b; } // A â€œtypicalâ€ sort call.array.sort(compare); æ¯”å°å‡½å¼å›å‚³ 0 ã€1(æˆ–å…¶ä»–æ­£å€¼)ã€-1(æˆ–å…¶ä»–è² å€¼)åˆ†åˆ¥ä»£è¡¨ ç­‰æ–¼ã€å¤§æ–¼ã€å°æ–¼ ï¼Œåœ¨æ¯”å°å‡½å¼ä¸­ç”¨æˆ¶å¯èƒ½æœƒæœ‰ Side-Effect æ“ä½œç­‰\n1 2 3 4 5 6 7 8 const array = [4, 2, 5, 3, 1]; array.push({ toString() { // Arbitrary code goes here, e.g. `array.push(1);`. return \u0026#39;42\u0026#39;; }}); // Sort without a comparison function.array.sort(); é è¨­çš„æ¯”å°å‡½å¼æœƒå…ˆå‘¼å« toString() è½‰æˆå­—ä¸²æ¯”å°\næ¥è‘—æŠŠ Spec å…ˆæ”¾åœ¨è…¦å¾Œï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯ Implementation-defined ï¼Œåœ¨ä¸€äº› Spec ä¿ç•™å¯¦ä½œå½ˆæ€§çš„éƒ¨åˆ†ï¼Œå·¥ç¨‹å¸«æœ‰æ©Ÿæœƒå»è‡ªç”±ç™¼æ®ï¼Œåšå‡ºç†æƒ³ä¸­ç”¨æˆ¶æœƒå¸Œæœ›çœ‹åˆ°çš„è¡Œç‚ºï¼Œä½†é€™éƒ¨åˆ†å„å€‹ JS Engine è¡Œç‚ºå·®ç•°å¾ˆå¤§ï¼Œä¾‹å¦‚èªªé‡ä¸Šäº† accessors(getter/setter) æˆ–prototype-chain ï¼Œå¼·çƒˆå»ºè­°ä¸è¦é€™æ¨£å¯«ç¨‹å¼ï¼Œé€™è£¡åƒ…ä½œèªªæ˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 const array = [0, 1, 2]; Object.defineProperty(array, \u0026#39;0\u0026#39;, { get() { console.log(\u0026#39;get 0\u0026#39;); return 0; }, set(v) { console.log(\u0026#39;set 0\u0026#39;); } }); Object.defineProperty(array, \u0026#39;1\u0026#39;, { get() { console.log(\u0026#39;get 1\u0026#39;); return 1; }, set(v) { console.log(\u0026#39;set 1\u0026#39;); } }); array.sort(); const object = { 1: \u0026#39;d1\u0026#39;, 2: \u0026#39;c1\u0026#39;, 3: \u0026#39;b1\u0026#39;, 4: undefined, __proto__: { length: 10000, 1: \u0026#39;e2\u0026#39;, 10: \u0026#39;a2\u0026#39;, 100: \u0026#39;b2\u0026#39;, 1000: \u0026#39;c2\u0026#39;, 2000: undefined, 8000: \u0026#39;d2\u0026#39;, 12000: \u0026#39;XX\u0026#39;, __proto__: { 0: \u0026#39;e3\u0026#39;, 1: \u0026#39;d3\u0026#39;, 2: \u0026#39;c3\u0026#39;, 6: undefined, }, } }; Array.prototype.sort.call(object); V8 åœ¨æ’åºå‰å¾Œçš„è™•ç† åœ¨ Specä¸­ï¼Œå°‡æ’åºçš„å…ƒç´ åˆ†æˆä¸‰éƒ¨åˆ†\nnon-undefined valueï¼Œé€™éƒ¨åˆ†æœƒå¥—ç”¨æ¯”å°å‡½å¼æ±ºå®šæ’åº undefined valueï¼Œæ”¾åœ¨æ’åºçš„æœ€å¾Œ holesï¼Œä¸å­˜åœ¨çš„å€¼ V8 åœ¨å¯¦ä½œä¸Šçš„æ­¥é©Ÿå¤§æ¦‚ç‚º\næ‰¾å‡º Array æˆ–æ˜¯ Object çš„ length è¨­è®Šæ•¸ numberOfUndefineds ç‚º 0 åœ¨ç¯„åœ [0, length) ä¸­\n- é‡åˆ° holes ä¸è™•ç†\n- é‡åˆ° undefined å°‡ numberOfUndefineds++- é‡åˆ° non-undefined valueï¼Œæ”¾åˆ°æš«å­˜é™£åˆ—ä¸Š æ¥è‘—ç”¨ TimSort å°æš«å­˜é™£åˆ—åšæ’åºï¼Œä¹‹å¾Œå°‡æš«å­˜æš«åˆ—å¯«å›åŸé™£åˆ—æˆ–ç‰©ä»¶ä¸­ï¼Œä¸¦åœ¨å¾Œé¢è£œè¶³ numberOfUndefineds æ•¸é‡çš„ undefinedï¼Œåˆªé™¤å‰©é¤˜çš„é•·åº¦(ç§»é™¤ hole)ï¼Œé€™æ¨£å°±å®Œæˆæ’åºäº†ã€‚\néå»çš„å¯¦ä½œ éå» V8 æ˜¯å°é™£åˆ—(length \u0026lt; 10) ç”¨ Insertion Sort å…¶é¤˜æ¡ç”¨ Quick Sortï¼Œè€Œ Quick Sort ä¸­åˆ†å‰²çš„å°é™£åˆ—é•·åº¦å°æ–¼ 10 ä¹Ÿæ˜¯ç”¨ Insertion Sortï¼›\nå› ç‚º Quick Sort æ˜¯æ¡ç”¨éè¿´çš„æ–¹å¼ï¼Œå°é™£åˆ—æ”¹ç”¨ Insertion Sort æ•ˆç‡è¼ƒå¥½ã€‚\nQuick Sort åœ¨é¸æ“‡ pivot çš„é»å¾ˆé‡è¦ï¼Œé¸ä¸å¥½å°±æœƒè·‘åˆ°æœ€å·®æƒ…æ³ O(nÂ²)ï¼ŒV8 æ¡ç”¨å…©ç¨®ç­–ç•¥ï¼š\n1. é¸æ“‡å­é™£åˆ—ä¸­ç¬¬ä¸€å€‹ã€æœ€å¾Œä¸€å€‹ã€ç¬¬ä¸‰å€‹æ•¸çš„ä¸­ä½æ•¸\n2. å°æ–¼å¤§çš„é™£åˆ—ï¼Œé¸æ“‡è¢«æ’åºéæ•¸åˆ—çš„ä¸­ä½æ•¸\nQuick Sort å„ªé»åœ¨æ–¼æ˜¯ In-Place æ’åºï¼Œä½†ç¼ºé»æœ‰å¯èƒ½æœƒè½åˆ° O(nÂ²)ã€‚\nç¾è¡Œå°±æ”¹æˆ TimSort äº†ã€‚\n","date":"2019-08-09T05:41:03.975Z","permalink":"https://yuanchieh.page/posts/2019/2019-08-09-v8-%E5%85%A7%E7%9A%84%E6%8E%92%E5%BA%8F%E6%BC%94%E7%AE%97%E6%B3%95-timsort/","title":"V8 å…§çš„æ’åºæ¼”ç®—æ³•â€Šâ€”â€ŠTimsort"},{"content":"\nåˆ’é¾èˆŸé‚å…¥ç¬¬äºŒå¹´ï¼Œé–‹å§‹ç¿’æ…£ä¸‰æœˆåˆ°å…­æœˆä»¥åˆ’é¾èˆŸç•¶ä½œä¸€å¹´çš„é–‹ç«¯ï¼Œé‡æ–°èª¿æ•´è‡ªå·±çš„å¿ƒæ…‹èˆ‡é«”æ…‹ï¼›\né‚éç¬¬ä¸€å¹´ç—›è‹¦çš„å…¥é–€æœŸï¼Œç¬¬äºŒå¹´æ¼¸å…¥ä½³å¢ƒï¼Œé–‹å§‹å¯ä»¥äº«å—åˆ’èˆ¹çš„æ¨‚è¶£èˆ‡æ¯”è³½çš„åˆºæ¿€ï¼Œä¹Ÿé–‹å§‹åœ¨é€™éç¨‹é«”æœƒåˆ°ä¸€äº›å…¶ä»–å¿ƒå¢ƒä¸Šçš„æˆé•·ï¼Œé—œæ–¼è‡ªä¿¡èˆ‡åœ˜éšŠé€™ä»¶äº‹ã€‚\nå‰æƒ…æè¦ é¾èˆŸç«¶è³½åœ¨ç«¯åˆç¯€æ™‚æœƒæœ‰å¤šå€‹åœ°æ–¹æ”¿åºœç¨ç«‹èˆ‰è¾¦ï¼Œä¾‹å¦‚æˆ‘å€‘éšŠä¸ŠåŒæ™‚åƒåŠ å°åŒ—å¸‚èˆ‡æ–°åŒ—å¸‚ï¼Œå…¶ä»–å¦‚æ–°ç«¹ã€å°å—ä¹Ÿéƒ½æœ‰è³½äº‹ï¼›\næ–°åŒ—å¸‚åªæœ‰å¤§å‹é¾èˆŸï¼Œèˆ¹ä¸Šæœ‰å¥ªæ¨™æ‰‹ã€é¼“æ‰‹ã€8å°æ§³æ‰‹ã€èˆµæ‰‹ï¼Œä»Šå¹´è³½åˆ¶æ˜¯å¥ªæ¨™æ‰‹åœ¨æ±ºè³½æ‰ä¸Šå ´ï¼›\nå°åŒ—å¸‚å‰‡éšŠä¼çœ¾å¤šï¼Œçµ„åˆ¥ä¹Ÿéå¸¸å¤šï¼Œé¡åˆ¥å†åˆ†æˆå¤§å‹é¾èˆŸè·Ÿå°å‹é¾èˆŸï¼Œå¤§å‹é¾èˆŸæœ‰ 10å°æ§³æ‰‹ï¼Œå°å‹å‰‡æœ‰ 5å°æ§³æ‰‹ï¼›\næ¯”è³½éƒ½æ˜¯åˆ’ 500å…¬å°ºï¼Œå¤§å‹é¾èˆŸæœ‰å¥ªæ¨™æ‰‹çœ‹å¥ªæ¨™æ™‚é–“ï¼Œä½†å¦‚æœå¥ªæ¨™å¤±æ•—å‰‡çœ‹èˆ¹å°¾é€šéçš„æ™‚é–“ï¼›\nå°å‹é¾èˆŸæ²’æœ‰å¥ªæ¨™æ‰‹ï¼Œæ¯”çš„æ˜¯èˆ¹é ­é€šéæ™‚é–“ï¼Œä½†å¦‚æœç™¼ç”Ÿæ‰æ§³æˆ–æ˜¯å…¶ä»–å¤±èª¤ï¼Œå‰‡çœ‹èˆ¹å°¾é€šéæ™‚é–“ï¼Œé€šå¸¸æ¯”è³½æ™‚æˆ‘å€‘æœƒèˆ¹å°¾é€šéæ‰åœã€‚\né—œæ–¼è‡ªä¿¡ é‚„è¨˜å¾—ç¬¬ä¸€å¤©åœ¨å°åŒ—å¸‚å¤§ä½³æ²³æ¿±å…¬åœ’é è³½çš„æ™‚å€™ï¼Œå°å‹é¾èˆŸç”·å­çµ„æ˜¯æ’åœ¨ 11 é»çš„è³½ç¨‹ï¼Œç•¶æ™‚æ­£è™•æ–¼é€†é¢¨é€†æµçš„ç‹€æ…‹ï¼Œå¤§æ¦‚æœƒæ˜¯é †é¢¨é †æµå…©å€çš„å®Œè³½æ™‚é–“ï¼ŒåŠ ä¸ŠåŸæœ¬å¤§ä½³çš„èˆ¹é‡æ§³ä¹Ÿé‡ï¼Œé›–ç„¶çŸ¥é“æ¯éš»éšŠä¼éƒ½é¢è‡¨ä¸€æ¨£çš„è™•å¢ƒï¼Œä½†æƒ³æƒ³ä¹Ÿæ˜¯è »å´©æ½°çš„ï¼Œå°æ¯å€‹äººä¾†èªªéƒ½æ˜¯é«”èƒ½ä¸Šèˆ‡ç²¾ç¥ä¸Šå¾ˆå¤§çš„æ¶ˆè€—ï¼›\nä½†æ•™ç·´åœ¨é›†åˆçš„æ™‚å€™å°±èªªï¼šã€Œç­‰ç­‰é€†é¢¨é€†æµæ˜¯è€åŠ›è³½ï¼Œæœƒåˆ’å¾ˆä¹…ï¼Œä½†ä¸ç”¨æ€•ï¼Œæˆ‘å€‘å¹³å¸¸æœ€é éƒ½åˆ’é 5å…¬é‡Œï¼Œä¸€å®šæ’å¾—å®Œçš„ï¼ã€\nè½åˆ°é€™çœ‹è‘—éšŠå‹ç›¸è¦–è€Œç¬‘ï¼Œä»Šå¹´éšŠä¸Šçš„è¨“ç·´æ¨¡å¼æ¯”è¼ƒæ³¨é‡è€åŠ›ï¼Œé‚„è¨˜å¾—åœ¨å››äº”æœˆé€²å…¥å‚™è³½æœŸæ™‚ï¼Œæ¯å¤©æ—©ä¸Šå›ºå®šæœƒå…ˆæ‹‰é•·è·é›¢æš–èº«ï¼Œå¾ä¸€é–‹å§‹ 500å…¬å°ºæ…¢æ…¢æ‹‰åˆ° 800ã€1200 åˆ° 2000å…¬å°ºï¼›\næœ‰ä¸€å¤©æ—©ä¸Šä¾‹è¡Œæš–èº«ï¼Œå¾ç¢§æ½­ç¢¼é ­å‡ºç™¼ç¹åˆ°ä¸Šæ¸¸å†ä¸€è·¯æ‹‰åˆ°åŠæ©‹ä¸‹ï¼Œå®Œæˆ 2000å…¬å°ºçš„æš–èº«ï¼Œçœ‹åˆ°åŠæ©‹å¿ƒè£¡è¦ºå¾—å·®ä¸å¤šè©²åœäº†å§ï¼Œä½†å¥‡æ€ªçš„æ˜¯æ•™ç·´æ€éº¼æ²’æœ‰åœçš„æ„æ€ï¼Œåªæœ‰ä¸€ç›´å–Šã€Œä¸è¦æ”¾ï¼Œç¹¼çºŒæ‹‰é•·ã€å¾Œä¾†èˆµæ‰‹ç¹äº†ä¸€åœˆå›é ­å¾åŠæ©‹å†åº¦å¾€ä¸Šæ¸¸å‡ºç™¼ï¼Œå¤§å®¶å¿ƒè£¡éƒ½è¦ºå¾—ä¸å¦™äº†ï¼Œæ˜¯ä¸æ˜¯æ•™ç·´ç®—æ•¸ä¸å¥½å“©ç¨‹æ•¸ç®—éŒ¯äº†ï¼Œä½†æ•™ç·´åœ¨å¤§å®¶ä¹Ÿä¸æ•¢å·æ‡¶ï¼Œåªèƒ½å’¬è‘—ç‰™ç¹¼çºŒæ‹¼ï¼›\né‚£æ™‚å€™è‚Œè‚‰å·²ç¶“é–‹å§‹é…¸ç—›ï¼Œå°¤å…¶æ˜¯è‚©è†€è¦è² è²¬å›æ§³è·Ÿå£“æ§³å…¥æ°´ï¼Œæ•´å€‹ä¸‰è§’è‚Œç·Šç¹ƒï¼Œèº«é«”å¥½åƒè¢«çŒæ°´æ³¥ä¸€æ¨£çš„æ²ˆé‡ï¼Œä½†æ²’æœ‰äººæ•¢åœä¸‹å‹•ä½œæˆ–æ˜¯åˆ†ç¥ï¼Œå› ç‚ºæ•™ç·´åœ¨èˆ¹é ­è™è¦–çœˆçœˆçš„æ³¨è¦–è‘—ä½ ï¼›\nå°±åƒåœ¨æ²™æ¼ è¡Œèµ°å¿«è¦å¤±æ°´è€Œæ­»çš„æ—…äººï¼Œæ¸´æœ›åœä¸‹ä¾†ä¼‘æ¯ï¼Œåœ¨é‚„æ²’åœä¸‹ä¾†çš„éç¨‹ï¼Œé–‹å§‹æœƒæ€è€ƒé€™æ¨£æœƒä¸æœƒå—å‚·ï¼Œé€ƒé¿æˆ–å·æ‡¶çš„å¿µé ­ç”¢ç”Ÿï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæœƒæƒ³è¦é€¼å‡ºæ›´å¥½è‡ªå·±å†å¤šæ’ä¸€ä¸‹ï¼Œå°±åœ¨å…©ç¨®å¿µé ­ä¸æ–·äº¤é›œçš„éç¨‹ï¼Œçµ‚æ–¼åˆ°äº†ï¼Œé‚„è¨˜å¾—é‚£å¤©åˆ’äº† 3200 å…¬å°ºï¼Œæ¯”ä¹‹å‰å¤šäº† 50%çš„é‡Œç¨‹ï¼›\nå¾Œé¢æ•™ç·´å°±é€æ­¥çªç ´å¤§å®¶å¿å—çš„æ¥µé™ï¼Œæœ€é ä¸€è¶Ÿåˆ’äº† 5000å…¬å°ºã€‚\nå›æƒ³åˆ°æ•´å€‹è¨“ç·´çš„éç¨‹ï¼Œèˆ‡èº«é‚Šçš„éšŠå‹å€‘ä¸€èµ·ç¶“æ­·éçš„é€™äº›è¨“ç·´ï¼Œçªç„¶è¦ºå¾—å¿ƒä¸­çš„ä¸å®‰èˆ‡æƒ¶æéƒ½æ•£å»ï¼ŒåŠ›æ°£ä¹Ÿæ…¢æ…¢æ¹§ä¸Šï¼Œå°‡éå»çš„ç©ç´¯åŒ–æˆæœ€è¸å¯¦çš„ä¿¡å¿ƒï¼Œç›¸ä¿¡è‡ªå·±ç›¸ä¿¡éšŠå‹ï¼Œå¾Œä¾†é è³½ä¹Ÿé †åˆ©é€šéï¼Œä»Šå¹´é–‹å§‹æ¯ä¸€æ§³éƒ½å¾ˆç©©å®šçš„æŠ“æ°´åˆ°æœ€å¾Œï¼Œå¾ˆç´¯ä½†ä¹Ÿå¾ˆéç™®ï¼Œä¸€è·¯æŒºé€²åŠæ±ºè³½èˆ‡æœ€çµ‚æ±ºè³½ï¼Œæœ€å¾Œæ‹¿ä¸‹ç¬¬å››åçš„æˆç¸¾ã€‚\næˆ‘ç›¸ä¿¡åœ¨ä»»ä½•é ˜åŸŸæƒ³è¦æˆåŠŸéƒ½å¿…é ˆè¦åŠ å€çš„ä»˜å‡ºï¼Œé€™äº›ä»˜å‡ºä¸å–®å–®å¸¶ä¾†å¯¦åŠ›çš„æå‡ï¼Œé‚„æœ‰å¿ƒæ…‹ä¸Šæ­£é¢çš„å½±éŸ¿ï¼›\né‹å‹•ç®—æ˜¯ç›¸å°å–®ç´”çš„é ˜åŸŸï¼ŒæŒçºŒçš„ç·´ç¿’ï¼Œå°±æœƒæŒçºŒçš„çœ‹è¦‹é€²æ­¥ï¼Œåˆ°äº†æ¯”è³½è¦ä¸Šå ´çš„é‚£ä¸€åˆ»ï¼Œæ‰‹ä¸Šç£¨å‡ºä¾†çš„ç¹­åŒ–æˆæ¡æ§³æœ€æœ‰åŠ›çš„è‡ªä¿¡ã€‚\nçœ‹è¦‹å…¶ä»–æ¯”æˆ‘å€‘å²å®³çš„éšŠä¼ï¼Œæœƒè‡ªçŸ¥å·®äº†ä¸€æˆªä½†ä¹Ÿä¸è‡´æ–¼æ°£é¤’ï¼Œåè€Œæœƒæ›´å°Šé‡ä»–å€‘çš„ä»˜å‡ºï¼Œå› ç‚ºä»–å€‘æ›´åŠ çš„åˆ»è‹¦èˆ‡åŠªåŠ›æ‰æœƒæœ‰äº†ä»Šå¤©çš„ä½³ç¸¾ï¼›\nçœ‹åˆ°å…¶ä»–å¯¦åŠ›ç¨å¼±çš„éšŠä¼ä¹Ÿä¸æœƒè¼•è¦–ï¼Œå› ç‚ºå¯èƒ½ä»–å€‘çš„ç”Ÿæ´»é‡å¿ƒä¸åœ¨é¾èˆŸä¸Šï¼Œå°±çæƒœèƒ½å¤ ä¸€åŒç«¶æŠ€çš„ç·£åˆ†ã€‚\né¾èˆŸæœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼æ•´éš»éšŠä¼æ²’æœ‰è‹±é›„ï¼Œä¸åƒæ£’çƒæˆ–ç±ƒçƒï¼Œé›–èªªæ˜¯åœ˜éšŠç«¶è³½ä½†å­£å¾Œè³½é‚„æ˜¯æœƒéœ€è¦çƒæ˜Ÿçš„æŒºèº«è€Œå‡ºï¼›\nä½†é¾èˆŸå°±æ˜¯ä¸€æ¦®ä¿±æ¦®ï¼Œæ•´é½ŠåŠƒä¸€çš„æ§³æ³•èˆ‡å‡è¡¡çš„åŠ›é‡æ‰èƒ½è´å¾—æ¯”è³½ï¼Œè€Œä¸”ä¸€æ¹Šå°±è¦æ¹Šæ»¿10äººæˆ–æ˜¯20äººï¼Œç›¸å°ä¸å¤ªå®¹æ˜“ï¼Œä½†ä¹Ÿå› ç‚ºé€™æ¨£æ¯”è³½èµ·ä¾†å¾ˆç†±é¬§ï¼Œä¹Ÿå¾ˆéç™®ã€‚\nå·¥å•†æ™‚é–“ æ–°åº—åŒå¿ƒæ•‘é›£éšŠé¾èˆŸéšŠæ­¡è¿å¤§å®¶çš„åŠ å…¥ï¼Œç›®å‰éƒ½æ˜¯ä¸‰æœˆä¸­æ—¬è¨“ç·´åˆ°ç«¯åˆç¯€ï¼Œå›ºå®šæ—©ä¸Š 5:20 ~ 6:30 æ–¼ç¢§æ½­ç·´ç¿’ï¼Œæœ‰èˆˆè¶£ç·´èº«é«”ç•¶é‹å‹•ï¼Œæˆ–æ˜¯æƒ³è¦äº«å—æ¯”è³½çš„äººéƒ½å¾ˆæ­¡è¿ï¼Œä¸éå°±æ˜å¹´è«‹æ—© XD\nOS. è¨“ç·´å¼·åº¦å¦‚æœèº«é«”ä¸é©é‚„æ˜¯å¯ä»¥ä¼‘æ¯ï¼Œä¸ç”¨æ“”å¿ƒæœƒæ“åˆ°å—å‚·ï¼Œä½†å°±æ˜¯è¦è‡ªå·±è©•ä¼°è·Ÿè¡¡é‡ï¼›\néšŠä¸Šä¹Ÿæœ‰åˆ†è€æ‰‹æ‹¼æ¯”è³½ï¼Œäººæ•¸å¤ æ–°äººä¹Ÿæœƒæ¹Šä¸€è‰˜ç·´ç¿’\nçµèª åˆæŒºéä¸€å¹´äº†ï¼Œä»Šå¹´éšŠä¸Šæ‹¿äº†ä¸å°‘åæ¬¡ï¼Œå¥³å­çµ„æˆç¸¾ä¾ç„¶äº®çœ¼ï¼Œå…¶ä»–çµ„åˆ¥ä¹Ÿç¨ç¨æœ‰æ‰€çªç ´äº†ã€‚\nåœ¨æ¯”è³½æœŸé–“å¾ˆæ„Ÿè¬æ‰€æœ‰çš„éšŠå“¡ï¼ŒåŒ…å«è¡Œæ”¿çš„å·¥ä½œäººå“¡èˆ‡è² è²¬é–‹è»Šæ¥é€çš„éšŠå‹ï¼Œé™¤äº†æ¯”è³½è¨“ç·´é‚„è¦å¹«å¿™å…¶ä»–é›œç‰©çœŸçš„å¾ˆè¾›è‹¦ï¼›\nå¦å¤–é‚„æœ‰åˆ°å ´æ²’æœ‰ä¸Šå ´æ©Ÿæœƒçš„éšŠå‹ï¼Œæ„Ÿè¬å¤§å®¶çŠ§ç‰²é€£å‡ä¸€åŒåˆ°å ´å¹«å¿™åŠ æ²¹ï¼Œè¦æ’èµ·ä¸€éš»éšŠä¼éœ€è¦å¾ˆå¤šäººçš„åŠªåŠ›èˆ‡ä»˜å‡ºï¼Œæ„Ÿè¬å¤§å®¶ã€‚\n","date":"2019-06-10T23:08:00.265Z","permalink":"https://yuanchieh.page/posts/2019/2019-06-10-%E9%BE%8D%E8%88%9F%E7%AC%AC%E4%BA%8C%E5%B9%B4-%E9%97%9C%E6%96%BC%E8%87%AA%E4%BF%A1/","title":"é¾èˆŸç¬¬äºŒå¹´â€Šâ€”â€Šé—œæ–¼è‡ªä¿¡"},{"content":"åˆ’é¾èˆŸé‚å…¥æ§³æ‰‹äºŒå¹´ç´šç”Ÿï¼Œé«”èƒ½èˆ‡åˆ’æ§³ä¸Šæ…¢æ…¢å¯ä»¥è·Ÿä¸Šå¤§å®¶ï¼Œé›–ç„¶é‚„æœ‰å¾ˆå¤šéœ€è¦èª¿æ•´çš„ç´°ç¯€èˆ‡ç£¨ç·´ï¼Œæ¯æ¬¡ç·´ç¿’ä¹Ÿéƒ½æ˜¯ç´¯å¾—åŠæ­»ï¼Œä½†ç¢ºå¯¦æ¯”è¼ƒå¾—å¿ƒæ‡‰æ‰‹äº›ï¼Œæ…¢æ…¢äº«å—é¾èˆŸçš„æ¨‚è¶£ï¼›\nä½†ä¸å¾—ä¸èªªä¸€é–‹å§‹ä»¥ç‚ºæ§³æ‰‹ï¼Œèº«ç‚ºèˆ¹ä¸Šçš„å‹•åŠ›è¼¸å‡ºæ˜¯æœ€ç´¯äººçš„ï¼Œå¹³å¸¸èˆµæ‰‹å¤§å“¥å€‘å²å®³åˆ°è®“æˆ‘åœ¨åˆ’æ§³æ™‚å®Œå…¨æ²’æ„Ÿå—åˆ°ä»–å€‘çš„å­˜åœ¨ï¼Œèª¤ä»¥ç‚ºèˆ¹æ¯”ä¾†å°±è©²ç›´ç›´çš„è·‘ï¼Œæ‰€ä»¥èˆµæ‰‹æ„Ÿè¦ºèµ·ä¾†å¾ˆè¼•é¬†ï¼Œä½†é€™ç¨®è§€å¿µéŒ¯å¾—é›¢è­œ!!\nåŒ…å«ä¸Šèª²çš„è³‡æ·±æ•™ç·´ é¦®å»ºå ‚æ•™ç·´ä¹Ÿæåˆ°ï¼Œç¾åœ¨å¾ˆå¤šåƒè³½éšŠä¼çš„æ•™ç·´ä¹Ÿæœ‰äº›åå·®çš„è§€å¿µï¼Œéƒ½ä¸å¤ªé‡è¦–ï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•è¨“ç·´èˆµæ‰‹ï¼Œå°è‡´æ¯”è³½æ™‚é€£å‡ºç¢¼é ­ã€åˆ°æ¯”è³½å®šé»éƒ½æœ‰å•é¡Œï¼Œæ›´ç”šè€…ç¿»èˆ¹ã€æ“¦æ’ç­‰å®‰å…¨å±éšªï¼Œé€™ä¹Ÿæ˜¯å°åŒ—å¸‚é«”è‚²å±€è¦è¾¦èˆµæ‰‹ç ”ç¿’ç‡Ÿçš„åˆè¡·ã€‚\nå¾ˆæ„Ÿè¬å°åŒ—å¸‚é«”è‚²å±€èˆ‰è¾¦å’ŒéšŠä¸Šè®“æˆ‘æœ‰æ©ŸæœƒåƒåŠ èˆµæ‰‹ç ”ç¿’ç‡Ÿï¼Œå¾èˆµæ‰‹çš„è§’åº¦å­¸ç¿’ï¼Œå¾æ–°å°é¾èˆŸé€™é …é‹å‹•æœ‰ä¸åŒçš„èªçŸ¥èˆ‡é«”æœƒï¼Œä¹Ÿè®“æˆ‘æ›´åŠ å´‡æ‹œé»˜é»˜ä»˜å‡ºçš„èˆµæ‰‹å¤§å“¥äº†ï¼Œä»¥ä¸‹æ˜¯åƒåŠ  2019 å¹´åº¦çš„èˆµæ‰‹ç ”ç¿’ç‡Ÿçš„ç­†è¨˜ã€‚\nå‡ºè™•ï¼šé¦®å»ºå ‚æ•™ç·´çš„ FBÂ ç›¸ç°¿\nèˆµæ‰‹çš„å·¥ä½œ èˆµæ‰‹ä¸»è¦æ“èˆµï¼Œåœ¨é¾å°¾æ§åˆ¶èˆ¹å‰é€²çš„æ–¹å‘ï¼Œèˆµåˆåˆ†æˆæ´»å‹•èˆµèˆ‡å›ºå®šèˆµï¼Œå›ºå®šèˆµåœ¨èˆ¹å°¾æœ‰å¤šä¸€å¡Šçµæ§‹è®“èˆµç©¿éï¼Œåœ¨èª¿æ•´æ–¹å‘æ™‚æœ‰å€‹æ”¯é»å¯ä»¥ç¨±ï¼›\nè€Œæ´»å‹•èˆµå‰‡ç„¡ï¼Œå¿…é ˆé è‡ªèº«çš„åŠ›é‡æˆ–èˆ¹æ¿ç•¶ä½œæ”¯é»ã€‚\nåœ¨æœ‰äº›æ¯”è³½èˆµæ‰‹å¯ä»¥åŠ©åˆ’ï¼Œæ•™ç·´è¡¨ç¤ºèˆµæ‰‹åŠ©åˆ’å²å®³çš„å¯ä»¥æŠµä¸Š3ï½4 åæ§³æ‰‹ï¼Œååˆ†çš„é©šäººã€‚\nèˆµæ˜¯åˆ©ç”¨æ“‹æ°´çš„æ–¹å¼ï¼Œè®“èˆ¹å°¾å—åŠ›ï¼Œé€²è€Œæ”¹è®Šèˆ¹é‹è¡Œçš„æ–¹å‘ï¼Œç•¶èˆ¹å°¾å—åˆ°å¾€å·¦çš„åŠ›é‡ï¼Œèˆ¹é ­è‡ªç„¶å°±æœƒç›¸å°å¾€å³ï¼Œåä¹‹äº¦ç„¶ï¼›\nå› ç‚ºä¸»è¦æ˜¯é€éæ°´çš„åä½œç”¨åŠ›ï¼Œæ‰€ä»¥èˆ¹åœ¨æœ‰å‹•åŠ›çš„æƒ…æ³ä¸‹æ‰èƒ½æ”¹è®Šæ–¹å‘ï¼Œæ‰€ä»¥åœ¨è½‰å½æ™‚ä¹Ÿæ˜¯è¦è«‹æ§³æ‰‹è¼•æ§³åˆ’ï¼›\nå¦‚æœå†æ²’æœ‰å‹•åŠ›ä¸‹ï¼Œé èˆµæ‰‹ä¸€äººæŒ–æ°´æˆ–æ¨æ°´ï¼Œé‚£æœƒååˆ†çš„ç´¯è€Œä¸”æ²’æ•ˆç‡ã€‚\nhttps://www.facebook.com/taipei2017/photos/pcb.1227131774129091/1227131447462457/?type=3\u0026amp;theater\nï¼ˆæ§³èˆ‡èˆµçš„å°æ¯”ï¼Œå‰›å¥½é€™ä½æ˜¯æˆ‘å¯¦éš›æ¼”ç·´çš„æŒ‡å°æ•™ç·´ï¼‰\nåæ»‘-èˆ¹ç‚ºä»€éº¼ä¸æœƒä¹–ä¹–èµ°ç›´ç·š åæ»‘åˆå¯åˆ†æˆäººåŠ›èˆ‡å¤©ç„¶å› ç´ \näººåŠ›å› ç´ ä¸»è¦åƒæ˜¯æ§³æ‰‹å·¦å³é›™æ–¹çš„é«”åŠ›èˆ‡åˆ’æ§³åŠ›é‡ä¸å‡ï¼›\nå¤©ç„¶å› ç´ çš„ç¨®é¡å°±å¾ˆå¤šï¼Œåƒæ˜¯é¢¨æµªã€æ½®æ±ã€æ°´åº•åœ°å½¢ç­‰éƒ½æœƒå—åˆ°å½±éŸ¿ã€‚\nåœ¨è¬›è§£çš„éç¨‹ä¸­ï¼Œæ•™ç·´æåˆ°æ°´æ˜¯æœ‰ç©ºé–“çš„ï¼Œç•¶æ§³æ‰‹æ’æ§³å…¥æ°´å¾€ä¸‹å¾€å¾Œæ¨æ™‚ï¼Œæ°´æœƒè¢«æ¨æ“ çš„ï¼Œä½†æ°´æ˜¯ä½”æ“šç©ºé–“çš„ï¼Œç•¶è§¸åº•æ™‚å°±æœƒå›å½ˆç”¢ç”Ÿæ¹§ï¼Œå¦‚æœæ°´æ·±ä¸å¤ å°±æœƒå‘ä¸Šæ¨æ“ ï¼Œå°è‡´èˆ¹çš„æ™ƒå‹•ï¼Œæœ‰ç¨®è¢«é»ä½çš„æ„Ÿè¦ºï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼åœ‹éš›è³½äº‹è¦å®šè³½é“æ°´æ·±ä¸€å®šè¦3ç±³æ·±ä»¥ä¸Š ï¼›\næ°´æµçš„éƒ¨åˆ†ï¼Œæ•™ç·´èˆ‰å¤§ä½³æ²³æ¿±å…¬åœ’ç‚ºä¾‹ï¼Œå¤§ä½³æ²³æ¿±å…¬åœ’ä½æ–¼åŸºéš†æ²³ä¸Šï¼Œæ°´æµæ˜¯å¾æ¾å±±å¾€åœ“å±±æ–¹å‘æµï¼Œå› ç‚ºæ²³é“å¤©ç„¶å½æ›²çš„ç·£æ•…ï¼Œæ°´æµåœ¨å¤–å´æœƒæ¯”è¼ƒæ¹æ€¥ï¼Œä¹Ÿå°±æ˜¯é è¿‘å¤§ç›´çš„æ–¹å‘ï¼Œæ‰€ä»¥3,4 æ°´é“çš„æ°´æµæœƒæ¯”è¼ƒå¿«ï¼Œèˆµæ‰‹å¦‚æœå¯ä»¥æ‰¾åˆ°é †æ°´æµçš„æ–¹å‘ï¼Œå°±å¯ä»¥è®“èˆ¹è·‘å¾—æ›´è¼•é¬†ï¼›\nä½†é™¤äº†æ°´æµå¤–ï¼Œæ½®æ±ä¹Ÿæœƒå½±éŸ¿ï¼Œå†æ¼²æ½®æ™‚å‰›å¥½èˆ‡æ°´æµæ–¹å‘ç›¸åï¼Œæœƒç”¢ç”Ÿå…©è‚¡åŠ›é‡çš„äº¤æœƒèˆ‡ç¢°æ’ï¼Œç¢ºåˆ‡çš„é»ä¸æ˜¯å¾ˆå›ºå®šï¼Œæ‰€ä»¥å°±å¾ˆé èˆµæ‰‹çš„ç¶“é©—ï¼Œæ•™ç·´è¡¨ç¤ºæœ‰äº›è³‡æ·±èˆµæ‰‹æ²’æœ‰æ³¨æ„ä¹Ÿæœƒæ ½åœ¨ä¸Šé ­ã€‚\næ•™ç·´ä¹Ÿæœ‰æåˆ°å»é¦™æ¸¯æ¯”è³½ï¼Œåœ¨å‡ºæµ·å£é™„è¿‘æœƒæœ‰å´æµªï¼Œåˆæˆ–æ˜¯æœ‰çš„å ´åœ°æœƒæœ‰æ°´è‰ï¼Œæ¯”è¼ƒæ…˜çš„å°±æœƒè¢«æ°´è‰çµ†ä½å½±éŸ¿æˆç¸¾ï¼Œä¸åŒçš„æ¯”è³½å ´åœ°æœ‰ä¸åŒçš„æ°´æ–‡ï¼Œé€™éƒ½æ˜¯èˆµæ‰‹éœ€è¦ä»”ç´°å»ç ”ç©¶ï¼Œæ‰¾å‡ºè³½é“ä¸Šæœ€é©åˆçš„ä½ç½®ã€‚\nå¯¦éš›ä¸‹æ°´ è¨“ç·´æœŸé–“æœ‰ä¸‹æ°´ç·´ç¿’å…­æ¬¡ï¼Œæ¯æ¬¡æ¯äººå¤§æ¦‚ç·´10â€“15åˆ†é˜ï¼Œä¸€ä¸‹æ°´é€£èµ°ç›´ç·šéƒ½æ˜¯å€‹å›°é›£ï¼Œå¾Œä¾†æ¯”è¼ƒçŸ¥é“èªªè¦æŠŠèˆµæ’æ·±ï¼Œè®“èˆµå—åŠ›å»è®“èˆ¹æŠ“ç›´ï¼Œä¸Šæ‰‹è¦æ¡å¥½ä½†åˆè¦æœ‰é»æ”¾é¬†ï¼Œå»æ„Ÿå—æ°´æµçš„ä½œç”¨ï¼›ä¸‹æ‰‹æ‰£ç·Šèˆ¹ç‰ˆï¼Œè®“èˆµå¯ä»¥é åœ¨èˆ¹é‚Šï¼Œæ–¹ä¾¿ä½¿åŠ›ï¼›\nä¸€å€‹æ“æ§çš„é‡é»æ˜¯æå‰ä¿®æ­£ï¼Œç•¶ç™¼ç¾èˆ¹å¾®å¾®åå‘æ™‚ï¼Œå°±è¦é–‹å§‹ä¿®æ­£ï¼Œæ­¤æ™‚æœƒæ¯”è¼ƒè¼•é¬†ï¼Œä¹Ÿä¸æœƒæ“‹å¤ªå¤šæ°´æ‹–ç´¯èˆ¹é€Ÿï¼Œå¦‚æœç•¶çœŸçš„åç§»æ™‚ï¼Œè¦åœ¨ä¿®æ­£å°±éå¸¸çš„å›°é›£ï¼Œå°¤å…¶æ˜¯å› ç‚ºèˆ¹æœ‰æ…£æ€§ï¼Œæ²’æœ‰æ§åˆ¶å¥½å°±æœƒæš´èµ°ï¼Œåœ¨åŸåœ°æ‰“è½‰ï¼Œæˆ‘å°±æ‰“è½‰äº†å¹¾æ¬¡ï¼Œå› ç‚ºè½‰å½æ™‚ä¾†ä¸åŠä¿®æ­£ï¼›\né€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¥³æ€§èˆµæ‰‹ä¸è¦‹å¾—æœƒè¼¸ç”·æ€§èˆµæ‰‹ï¼Œæ°´æ„Ÿå¥½èƒ½å¤ æå‰ä¿®æ­£ï¼Œå…¶å¯¦ä¸éœ€è¦åˆ°éå¸¸å¤§çš„åŠ›é‡ï¼Œåè€Œæ˜¯ç¶“é©—èˆ‡è‡¨å ´åæ‡‰æ¯”è¼ƒé‡è¦ã€‚\nä½†å¦‚æœæ²’æœ‰åŠæ™‚ä¿®æ­£ï¼Œæ•´è‰˜èˆ¹çš„åŠ›é‡ååˆ†å¯æ€•ï¼Œåœ¨å¤§è½‰å½æ™‚æˆ‘ç”¨å…¨èº«çš„åŠ›é‡æ‰æœ‰è¾¦æ³•å®šä½èˆ¹ï¼Œè½‰ä¸€å€‹å½10ç§’é˜å°±æ»¿èº«å¤§æ±—ï¼Œä¸‹æ‰‹æ‰£èˆ¹ç‰ˆçš„å¤§æ‹‡æŒ‡åˆ°ç¾åœ¨ä¸€é€±é‚„æœ‰é»é…¸ç·Šã€‚\nå¦å¤–å‰›å¥½åŸ¹è¨“é‚£å¹¾å¤©é¢¨æµªæ¯”è¼ƒå¤§ï¼Œæ‰€ä»¥åœ¨é€²å‡ºç¢¼é ­å°±ç›¸å°æ¯”è¼ƒå±éšªï¼Œå› ç‚ºèˆ¹åœ¨ä½é€Ÿå¾ˆå®¹æ˜“å—åˆ°è‡ªç„¶åæ»‘çš„å½±éŸ¿ï¼Œå‹•ä½œä¸å¤ ç²¾æº–å¾ˆå®¹æ˜“åˆè¢«æµªæ¨å›ç¢¼é ­å‡ºä¸ä¾†ï¼Œåˆæˆ–æ˜¯ç¬é–“è¢«æ‰“æ©«ç„¡æ³•æ“ä½œï¼Œä½†æ•™ç·´è¡¨ç¤ºå¾ˆæ…¶å¹¸åœ¨ç·´ç¿’æ™‚é‡åˆ°é¢¨æµªå¤§çš„ç‹€æ³ï¼Œæå‰ç·´ç¿’ç¸½æ¯”æ¯”è³½æ™‚æ‰‹å¿™è…³äº‚ä¾†çš„å¥½ã€‚\nå…¶ä»–è¨Šæ¯ æ•™ç·´æœ‰åˆ†äº«ä¸€äº›é¾èˆŸçš„è³‡è¨Šå¾ˆæœ‰è¶£ï¼Œåƒæ˜¯ä»–æœ‰å¸¶éšŠåƒåŠ å†°ä¸Šé¾èˆŸ\nå¦å¤–é‚„æœ‰æµ·ä¸Šé¾èˆŸï¼Œä¹‹å¾Œé¾èˆŸæœ‰æ©Ÿæœƒåˆ—å…¥å¥§é‹çš„æ­£å¼é …ç›®ï¼Œååˆ†çš„æœŸå¾…ã€‚\nçµèª èˆµèˆ¹çœŸçš„ä¸ç°¡å–®ï¼Œæ•´è‰˜èˆ¹çš„å‘½é‹èˆ‡æ–¹å‘å°±æ±ºå®šåœ¨èˆµæ‰‹ä¸­ï¼Œä¸å–®æ˜¯é«”èƒ½ä¸Šï¼Œæ›´æ˜¯å¿ƒéˆèˆ‡ç²¾ç¥ä¸Šçš„é›éŠã€‚\n","date":"2019-05-25T03:13:32.795Z","permalink":"https://yuanchieh.page/posts/2019/2019-05-25-%E9%BE%8D%E8%88%9F%E8%88%B5%E6%89%8B%E7%A0%94%E7%BF%92%E7%87%9F%E5%BF%83%E5%BE%97/","title":"é¾èˆŸèˆµæ‰‹ç ”ç¿’ç‡Ÿå¿ƒå¾—"},{"content":"å‰é™£å­åšå…¨çƒä¸åŒåœ°å€ API Server çš„éƒ¨ç½²ï¼Œå¸Œæœ›ç”¨æˆ¶åŸºæ–¼å»¶é²æ€§é¸æ“‡æœ€é è¿‘çš„ API Serverï¼Œé€é Route53 + API Gateway å¯¦ä½œéå¸¸ç°¡å–®ã€‚\nä½†é‡æ¸¬å»¶é²æ€§ï¼Œç†è«–ä¸Šåªèƒ½ç”± Client å‘å¤šå€‹ Server ç™¼é€ï¼Œæœ€å¾Œè©•æ¯”æ•´æ®µ Http Request å®Œæˆçš„æ™‚é–“ï¼›\nRoute53 èº«ç‚º DNS Serverï¼Œå¦‚æœæ˜¯å¾ DNS Server å»æ‰“ Serverï¼Œé‚£é‡æ¸¬çš„çµæœæ‡‰ç•¶æ˜¯ Route53 åˆ° Server çš„å»¶é²ï¼Œè€Œä¸èƒ½ä»£è¡¨ Client åˆ° Serverï¼›\nå¥½æ¯”èªª User åœ¨å°ç£ï¼ŒRoute53 Server åœ¨ç¾åœ‹ï¼ŒServer1 åœ¨ç¾è¥¿ï¼ŒServer2 åœ¨æ±äº¬ï¼Œé‚£å¾ Route53 è§’åº¦ä¸€å®šæ˜¯ç¾è¥¿çš„ Server1 æ¯”è¼ƒè¿‘ï¼Œä½†å° User ä¾†èªªæœƒæ˜¯æ—¥æœ¬çš„ Server2 æ¯”è¼ƒè¿‘æ‰æ˜¯ï¼›\nåˆå¦‚æœèªª Route53 æ˜¯å…¨çƒéƒ¨ç½²ï¼Œé‚£Route53 åˆå¦‚ä½•æ±ºå®š User è¦é€£åˆ°å“ªå€‹åœ°å€çš„ DNS ServerÂ ?Â åˆä¾‹å¦‚èªª CDNï¼ŒåŒæ¨£æœƒé‡åˆ°è¦å»å“ªå€‹ Local CDN Server æ¯”è¼ƒå¿«çš„å•é¡Œï¼Ÿ\nä»¥ä¸‹æ˜¯ç ”ç©¶é€™å€‹å•é¡Œçš„éç¨‹ã€‚\nHow Amazon Route 53 Uses EDNS0 to Estimate the Location of aÂ User åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼ŒRoute53 æ”¯æ´ DNS protocol é¡å¤–æ“´å…… EDNS0 ä¸­çš„edns-client-subnetã€‚\nDNS æŠ€è¡“ç™¼å±•æ–¼ 1980 å¹´ä»£ï¼Œç•¶æ™‚ protocol è¨­è¨ˆåªæœ‰ç•™ 512 bytes å¯ä»¥å¤¾å¸¶è³‡è¨Šï¼Œä½†éš¨è‘—æ™‚é–“æ¼”é€²ï¼Œäººå€‘å¸Œæœ›åŠ å…¥æ›´å¤šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚èªªæ›´å¤šçš„ IPv6ã€[DNSSEC](https://medium.com\nedns-client-subnet ä¸»è¦æ˜¯è®“ client å†ç™¼èµ· DNS resolve æ™‚å¯ä»¥åœ¨ query ä¸­å¤¾å¸¶è‡ªå·± IP çš„ subnetï¼Œè®“ DNS Server å¯ä»¥çŸ¥é“ client ç¢ºåˆ‡çš„ IP ä¾†æºè€Œä¸æœƒå† Recursive è§£æéç¨‹ä¸­è¢«ç½®æ›ï¼Œæ›´è©³ç´°è§£é‡‹æ–¼ä¸‹ä¸€ç¯€ï¼›\nå¦‚æœ client ä¸æ”¯æ´ edns-client-subnetï¼Œå‰‡ Route53 æœƒæ‹¿ IPç•¶ä½œä¾†æºä½ç½®åˆ¤æ–·ã€‚\nRoute53 æ˜¯é€é IP åˆ¤æ–·ç”¨æˆ¶çš„ä½ç½®ï¼Œä¸¦ç”¨æ­¤ä½ç½®ç•¶ä½œé‡æ¸¬çš„åŸºæº–ï¼ŒGeolocation / Latency based éƒ½æ˜¯å¦‚æ­¤ï¼›\nè€Œ IP ä½ç½®ä¾†æºå„ªå…ˆä½¿ç”¨ edns-client-subnetï¼Œå…¶æ¬¡ç”¨ source IPã€‚\nedns-client-subnet (ECS) æ‘˜è¦ä¸€äº› RFC å…§å®¹\nRFC 7871 - Client Subnet in DNS Queries\nDNS æŸ¥è©¢çš„æ–¹å¼æ˜¯ä¸€å±¤ä¸€å±¤çš„ï¼Œå¾æœ€é ‚ç´šçš„åŸŸåä¸€è·¯å‘ä¸‹ï¼Œä¾‹å¦‚èªª hello.example.comï¼Œå°±æœƒå¾Â .com Nameserver â†’ example.com Nameserver é€æ­¥æŸ¥è©¢ã€‚\nClient æœƒé€é Stub Resolver (å¯ç†è§£ä¸€å€‹ DNS Agent)ï¼Œé€é Intermediate Nameserver å‘ Authoritative Nameserver (æ¡æœ‰ DNS zones åŸŸåå€åŸŸ) ç™¼èµ·è«‹æ±‚ã€‚\nå…¶ä¸­ Intermediate Nameserver æœ‰å…©ç¨®ï¼š\nForwarding Resolverï¼šä¸æœƒéè¿´è§£æï¼Œåƒ…æœƒå‚³éçµ¦ä¸‹ä¸€å€‹ Recursive Resolverã€‚ Recursive Resolverï¼šéè¿´ domain chain ç›´åˆ°åŸŸåè§£æå®Œæˆï¼Œæœƒé€é cache å¿«é€Ÿè¿”å›æŸ¥è©¢ã€‚ ç›®å‰ä¾†èªªï¼ŒRecursive Resolver ä½¿ç”¨æ—¥ç›Šå¢åŠ ï¼Œå› ç‚ºé›†ä¸­åŒ–ç®¡ç†æœ‰å¹¾å€‹å„ªé» cache æ›´å¤šè³‡è¨Š ã€å¯©æŸ¥ç”¨æˆ¶çš„ DNSæŸ¥è©¢ ï¼Œä½†æ˜¯å‚³çµ±çš„ Recursive Resolver åœ¨éè¿´æŸ¥è©¢æ™‚ï¼Œæœƒå°‡ Source IP æ”¹æˆè‡ªå·±çš„ IPè€Œä¸æ˜¯ Client çš„ IPï¼Œä½† Recursive Resolver è·Ÿ Client å¯èƒ½éš”å¾ˆé (ç¶²è·¯æ‹“å¢£ä¸Šçš„è·é›¢)ï¼›\nå¦‚æœæ­¤æ™‚ Authoritative Nameserver å¸Œæœ›è§£æ Client IP æä¾›é‡èº«å®šåšçš„ DNS Answer (Tailored Response)ï¼Œå°±æ²’æœ‰è¾¦æ³•ï¼Œå› æ­¤åˆ¶å®š edns-subset-client è§£æ±ºæ­¤å•é¡Œã€‚\nOption Format 1 2 3 4 5 6 7 8 9 10 11 12 +0 (MSB) +1 (LSB) +---+---+---+---+---+---+---+---+---+---+---+---+---+ 0: | OPTION-CODE | +---+---+---+---+---+---+---+---+---+---+---+---+---+ 2: | OPTION-LENGTH | +---+---+---+---+---+---+---+---+---+---+---+---+---+ 4: | FAMILY | +---+---+---+---+---+---+---+---+---+---+---+---+---+ 6: | SOURCE PREFIX-LENGTH | SCOPE PREFIX-LENGTH | +---+---+---+---+---+---+---+---+---+---+---+---+---+ 8: | ADDRESS... | +---+---+---+---+---+---+---+---+---+---+---+---+---+ edns-subset-client protocol æ˜¯åŸºæ–¼ EDNS0 åˆ¶å®šï¼Œä»¥ä¸‹æ˜¯ä»–çš„ package å…§å®¹ï¼š\nOPTION-CODE\nå…©å€‹å…«ä½å…ƒçµ„ï¼Œå›ºå®šæ˜¯ 0x00 0x08 OPTION-LENGTH\nå…©å€‹å…«ä½å…ƒçµ„ï¼Œä»£è¡¨ payload é•·åº¦ FAMILY\nå…©å€‹å…«ä½å…ƒçµ„ï¼Œä»£è¡¨ address çš„ family (IANAæ¨™æº–)ï¼Œç›®å‰æ”¯æ´ IPv4è·Ÿ IPv6 SOURCE PREFIX-LENGTH\nAddress é®ç½©ï¼ŒClient ç”¨ä¾†æŒ‡å®šæŸ¥è©¢çš„ IP é®ç½© SCOPE PREFIX-LENGTH\nåŒæ¨£æ˜¯ Address é®ç½©ï¼Œä½†æ˜¯æ˜¯ç”± Response è¡¨ç¤º Address è¦†è“‹ç¯„åœã€‚ SOURCE PREFIX-LENGTH è·Ÿ SCOPE PREFIX-LENGTH é€™å…©å€‹åƒæ•¸ç›¸å°æ¯”è¼ƒé‡è¦\nç•¶ Client æˆ– Stub Resolver ç™¼èµ· name resolve æ™‚ï¼ŒæœƒæŒ‡å®š Address èˆ‡ SOURCE PREFIX-LENGTHï¼ŒSOURCE PREFIX-LENGTH ç®—æ˜¯å¸Œæœ›ä¿ç•™ Client IP éƒ¨åˆ†éš±ç§ï¼Œä¸è¦‹å¾—è¦å…¨éƒ¨éƒ½é€å¾€ Nameserverï¼›\nä½† SCOPE PREFIX-LENGTH å¿…é ˆè¨­ç‚º 0 å› ç‚ºé€™æ˜¯ç”¨åœ¨ Response ä¸Š ç•¶ Recursive Resolver æ”¶åˆ°æ™‚ï¼Œæœƒé€ SOURCE PREFIX-LENGTH é®ç½©æŸ¥è©¢ Cacheï¼Œå¦‚æœæœ‰å‰‡è¿”å›ï¼›æ²’æœ‰å‰‡ç¹¼çºŒæŸ¥è©¢ï¼Œæ­¤æ™‚éè¿´æŸ¥è©¢çš„ SOURCE PREFIX-LENGTH åƒ…å¯å°æ–¼ç­‰æ–¼ä¾†æºæŸ¥è©¢çš„ SOURCE PREFIX-LENGTH Authoritative Nameserver å¦‚æœå›å‚³çš„ SCOPE PREFIX-LENGTH å°æ–¼ SOURCE PREFIX-LENGTHï¼Œä»£è¡¨ä¸éœ€ç”¨æä¾›é€™éº¼å¤š bitsï¼›\nåä¹‹ SCOPE PREFIX-LENGTH \u0026gt; SOURCE PREFIX-LENGTHï¼Œå‰‡ä»£è¡¨éœ€è¦æä¾›æ›´å¤šå¾— bits æ‰èƒ½å¾—åˆ°æ›´ç²¾æº–çš„ Answerã€‚ Authoritative Nameserver è™•ç† Cache æ™‚è¦å¤šåŠ æ³¨æ„ï¼Œä¸å¯ä»¥æœ‰ Prefix overlapping ï¼Œé¿å…åŒ¹é…åˆ°çŸ­çš„ prefix å›å‚³éŒ¯èª¤çš„ RRsetsï¼›\nä¾‹å¦‚èªªåŸæœ¬çš„ cache æ˜¯ 1.2.0/20 Aï¼Œä½†æ­¤æ™‚å¤šåŠ äº† 1.2.3/24 Bï¼Œå°±éœ€è¦æ‹†æˆ 1.2.0/23, 1.2.2/24, 1.2.4/22, 1.2.8/21 Aï¼Œ1.2.3/24 Bï¼Œé¿å…ç–Šåˆã€‚ è³‡å®‰é¢¨éšª ç”Ÿæ—¥æ”»æ“Š\nå¦‚æœé§­å®¢å‘ Intermediate Nameserver ç™¼é€å¤§é‡çš„å‡ DNS Answerï¼Œå¦‚æœä¸å°å¿ƒè¢«å»åˆåˆ°ï¼ŒIntermediate Nameserver å°±æœƒå›å‚³è¢«é‡£é­šçš„IPï¼Œé€™å€‹å•é¡Œåœ¨åŸæœ¬çš„ DNS å°±æœƒå‡ºç¾ã€‚\nâ†’ Intermediate Nameserver å¿…é ˆå° DNS Answer åšæ¬„ä½æª¢æŸ¥ï¼Œæœ€å¥½æ”¯æ´ DNSSEC æ¸›è¼•å•é¡Œç™¼ç”Ÿæ©Ÿç‡ Cache æ±¡æŸ“\næ”¯æ´ ECS å¾Œï¼ŒCache æ©Ÿåˆ¶è®Šå¾—æ›´åŠ è¤‡é›œï¼Œæœƒéœ€è¦åŸºæ–¼ FAMILY / SCOPE PREFIX-LENGTH / ADDRESS Cacheï¼Œé€ æˆ Memory ç”¨é‡å¤§å¢ï¼›\nå¦‚æœé§­å®¢é‹ç”¨é€™ä¸€é»ï¼Œç”¨æ´ªæ°´æ”»æ“Šè£½é€ å¤§é‡ä¸å®¹æ˜“å‘½ä¸­ Cache çš„æŸ¥è©¢ï¼Œå° DNS Nameserver åš DDos æ”»æ“Šã€‚\nâ†’ Nameserver å¿…é ˆè‡ªè¡Œåšå¥½è©•ä¼° ç¤ºç¯„æ¡ˆä¾‹ Spec ä¸­æœ‰å€‹ç¤ºç¯„æ¡ˆä¾‹\n1. Stub Resolver (SR)ï¼ŒIPä½ç½®æ˜¯ 2001:0db8:fd13:4231:2112:8a2e:c37b:7334ï¼Œæº–å‚™é€é Recursive Resolver (RNS) æŸ¥è©¢ www.example.com\n2. RNS æ”¯æ´ ECSï¼ŒæŸ¥è©¢ www.example.com æ˜¯å¦åœ¨ cacheä¸­ï¼Œæ²’æœ‰å‰‡é–‹å§‹æŸ¥è©¢\n3. RNS å‘ root Nameserver .com æŸ¥è©¢ï¼Œå‘ root Nameserver æŸ¥è©¢ä¸éœ€è¦å¤¾å¸¶ ECS é¸é …\n4. æ¥è‘— RNS æº–å‚™å»æ‰¾ .example.com Authoritative Nameserver (ANS)\n5. RNS è¦å‚³éçš„å°åŒ…ï¼Œå¿…é ˆåŠ å…¥ ECS é¸é …\nOPTION-CODE: 8 OPTION-LENGTH: 0x0bï¼Œå›ºå®š 4 bytes + 7 bytes çš„ Address FAMILY: 0x00 0x02ï¼Œä»£è¡¨ IPv6 SOURCE PREFIX-LENGTH: 0x38ï¼Œé®ç½©ä»£è¡¨ /56 bits SCOPE PREFIX-LENGTH: 0x00ï¼Œé€™æ˜¯ Answer ç”¨çš„ ADDRESS: 0x20 0x01 0x0d 0xb8 0xfd 0x13 0x42ï¼Œä¹Ÿå°±æ˜¯å‰ 56 bits 6. ANS æ”¶åˆ°å¾Œï¼Œç”¢ç”Ÿçµæœ(Tailored Response)å›å‚³ï¼Œå…¶é¤˜å…§å®¹ç›¸åŒ\nSCOPE PREFIX-LENGTH: 0x30, ä»£è¡¨ /48 7. RNS æ”¶åˆ°å¾Œï¼Œæ¯”å° FAMILY, SOURCE PREFIX-LENGTH å’ŒADDRESSï¼Œå¦‚æœä¸å»åˆå‰‡æ‹‹æ£„\n8. RNS åŸºæ–¼ ADDRESS, SCOPE PREFIX-LENGTH å’Œ FAMILY åš cache\n9. RNS å›å‚³çµæœçµ¦ SRï¼Œæ­¤æ™‚ä¸éœ€è¦ ECS é¸é …\né€é digÂ æª¢é©— dig æ”¯æ´ edns-client-subnet åƒæ•¸ï¼Œè—‰æ­¤è§€å¯Ÿ dns å›å‚³çš„ A recordï¼ŒæŒ‡ä»¤ç‚º dig [@8](http://twitter.com/8 \u0026quot;Twitter profile for @8\u0026quot;).8.8.8 {æ¸¬è©¦ domain name} +subnet={æ¸¬è©¦çš„ ip} ï¼Œç¶²è·¯ä¸Šå¾ˆå¤šè³‡æ–™æ˜¯ä½¿ç”¨ +client={æ¸¬è©¦ ip} ï¼Œæˆ‘å¯¦æ¸¬æ˜¯ç”¨ +subnet æ‰å¯ä»¥ã€‚\nå‰é¢æåˆ°çš„ SCOPE PREFIX-LENGTH ï¼ŒRoute53 å›å‚³ 24ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šæä¾› 24 bits çš„ Address å°±å¯ä»¥å–å¾—æœ€ä½³è§£ã€‚\næ¸¬è©¦çš„ domain æ˜¯å…¬å¸å…§éƒ¨é€é Route53 èˆ‡ API Gateway æ¶è¨­ï¼Œä¸æ–¹ä¾¿å…¬é–‹ï¼Œä½†é€é VPN å–å¾—ä¸åŒå€åŸŸçš„ ipï¼Œä¾‹å¦‚æ—¥æœ¬ã€å°åº¦ã€åŠ æ‹¿å¤§ã€é˜¿æ ¹å»·ç­‰åœ°ï¼Œæ”¾å…¥ subnet åƒæ•¸å¾Œï¼ŒDNS å›å‚³çš„ ANSWER ç¢ºå¯¦è·Ÿè‘—åœ°å€è€Œæ”¹å‹•ï¼›\næœ‰é»å¼”è©­çš„æ˜¯å·´è¥¿ä¸èµ°åœ‹å…§åè€Œæ˜¯åˆ°æ³•åœ‹ Frankfurtçš„ä¼ºæœå™¨ï¼Œè€Œé˜¿æ ¹å»·æ˜¯åˆ°å·´è¥¿ SÃ£o Pauloçš„ä¼ºæœå™¨ï¼›\nGeoIP æŸ¥è©¢é€é Maxmindï¼Œä»–æœ‰æ¯æ—¥æŸ¥è©¢ä¸Šç·šï¼Œæ˜¯ç¶å®š IPé™åˆ¶ã€‚\n","date":"2019-04-29T00:18:14.937Z","permalink":"https://yuanchieh.page/posts/2019/2019-04-29-route53-latency-based-routing-%E6%A9%9F%E5%88%B6-dns-%E5%A6%82%E4%BD%95%E8%A9%95%E4%BC%B0%E5%BB%B6%E9%81%B2/","title":"Route53 Latency-Based Routing æ©Ÿåˆ¶â€Šâ€”â€ŠDNS å¦‚ä½•è©•ä¼°å»¶é²"},{"content":"æ¶æ§‹ä¸Šä½¿ç”¨ elb ç•¶ä½œ load balancer proxyï¼Œå¾Œç«¯æ¥ nodejs api serverï¼Œä½†æ˜¯å¶çˆ¾æ‹‹å‡º 502 éŒ¯èª¤ï¼Œelb log é¡¯ç¤ºè©²æ¬¡é€£ç·šæ²’æœ‰é€²åˆ° api serverï¼Œéº»ç…©çš„æ˜¯æ©Ÿå™¨ health check æ­£å¸¸ï¼Œçµ•å¤§å¤šæ•¸çš„ api æ¸¬è©¦ä¹Ÿéƒ½æ­£ç¢ºï¼ŒéŒ¯èª¤ä¸å¤ªå¥½å¾©ç¾ï¼Œç›´åˆ°å¾Œä¾†æ‰ç™¼ç¾æ˜¯ proxy èˆ‡ api server åœ¨ persistent connection çš„ time-out æ©Ÿåˆ¶æœ‰æ‰€ä¸åŒã€‚\nä»¥ä¸‹æ˜¯ç ”ç©¶ http 1.0 / 1.1 keep-alive / persistent connection æ©Ÿåˆ¶ï¼Œä¸¦é‡æ–°å¾©ç¾èˆ‡è§£æ±ºå•é¡Œã€‚\npersistent connection ç°¡ä»‹ https://en.wikipedia.org/wiki/HTTP_persistent_connection#/media/File:HTTP_persistent_connection.svg\nåƒè€ƒè‡ªç¶­åŸºç™¾ç§‘ï¼Œpersistent connection ä¸»è¦æ˜¯å¸Œæœ›åœ¨çŸ­æ™‚é–“å…§æœ‰å¤šå€‹ http request æ™‚ï¼Œå¯ä»¥é‡æ–°åˆ©ç”¨ tcp connectionï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡æ–°å»ºç«‹ tcpé€£ç·šï¼Œé™ä½ tcp handshaking æ™‚é–“ç­‰é–‹éŠ·ã€‚\nåœ¨ http 1.0 ä¸¦æ²’æœ‰æ­£å¼æ”¯æ´ä¸”é»˜èªé—œé–‰ï¼Œä½†æ˜¯è »å¤§å¤šæ•¸çš„ http agent éƒ½æœ‰æ”¯æ´ï¼Œåœ¨ header è¨»æ˜ Connection: keep-alive ï¼Œå¦‚æœ server ä¹Ÿæ”¯æ´æœƒæŠŠ header Connection å†æ¬¡å›å‚³ï¼›\nç›´åˆ° client æˆ– server æ±ºå®šæ–·ç·šæ‰æœƒç™¼é€ Connection: close æ–·é–‹é€£ç·šã€‚\nåœ¨ http 1.1 é»˜èªé–‹å•Ÿï¼Œå¦‚æœé—œé–‰ persistent connection å‰‡å¿…é ˆä¸»å‹•åœ¨ http request å¤¾å¸¶ Connection: close ã€‚\nåœ¨ reverse proxy ä¸­æˆ–æ˜¯ application server éƒ½å¯ä»¥è¨­ç½® keep-alive timeoutï¼Œæ±ºå®š server åœ¨é–’ç½®å¤šå°‘ç§’æ•¸å¾Œæ²’æœ‰æ”¶åˆ°æ–°çš„ http request å°±ä¸»å‹•æ–·é–‹é€£ç·šï¼Œä»¥ä¸‹é€é wireshark å¯¦éš›è§€å¯Ÿ persistent connectionã€‚\nserver.js çš„ç¨‹å¼ç¢¼å¾ˆç°¡å–®\n1 2 3 4 5 6 7 const http = require(\u0026#39;http\u0026#39;); const server = http.createServer((req, res) =\u0026gt; { res.end(); }); server.listen(3000); http 1.0 ï¼š client â† â†’Â server å¦‚æœç›´æ¥ä½¿ç”¨ nodejs http moduleæˆ–æ˜¯å…¶ä»–äºŒæ¬¡é–‹ç™¼çš„æ¨¡çµ„ï¼Œé è¨­æ˜¯æ¡ç”¨ http 1.1 ä¸”ä¸èƒ½ä¿®æ”¹ï¼Œæ­¤æ™‚å¿…é ˆä½¿ç”¨æ›´åº•å±¤çš„ net æ¨¡çµ„ç™¼é€ http 1.0 request\nServer å¾ˆæ˜ç¢ºçŸ¥é“æ­¤æ¬¡ connection æ²’æœ‰è¦å¾©ç”¨æ‰€ä»¥å°±å¯ä»¥ç›´æ¥æ–·é–‹é€£çµã€‚\nhttp 1.1: client â† â†’Â server http 1.1 request é è¨­æœƒä½¿ç”¨ persistent connectionï¼Œç¨‹å¼ç¢¼æŠŠä¸Šé¢çš„ Http/1.0 æ”¹æˆ Http/1.1 å³å¯ï¼Œè§€å¯Ÿ wireshark server çš„å›æ‡‰å°±æœ‰æ‰€ä¸åŒ\nè§€å¯Ÿåˆ° http 1.1 é è¨­æ”¯æ´ persistent connectionï¼Œæ‰€ä»¥ server æœƒç­‰åˆ° keep-alive timeout (nodejs 8.0 å¾Œé è¨­ 5ç§’)æ‰æœƒæ–·é–‹é€£çµï¼Œå¾å°åŒ…é¡¯ç¤ºæ˜¯ç”± client æ–·é–‹é€£çµã€‚\nç‚ºä»€éº¼ client æœƒä¸»å‹•é—œé–‰è€Œæ²’æœ‰èµ° persistent connection å‘¢ï¼Ÿ\nhttp 1.1: keep-alive åœ¨ nodejsä¸­ï¼Œhttp request å¦‚æœè¦ä½¿ç”¨ keep-aliveï¼Œå¿…é ˆé€é http agent ç™¼é€ï¼Œhttp agent æœƒç”Ÿæˆ socket pool ä¸¦æ§åˆ¶ socket çš„å¾©ç”¨èˆ‡é—œé–‰æ™‚æ©Ÿï¼›\nå¦‚æœä¸ä½¿ç”¨ http agentï¼Œå³ä½¿ header æˆ–é è¨­æ”¯æ´ keep-aliveï¼Œæ¯å€‹ request çµæŸå¾Œclientéƒ½æœƒä¸»å‹•ç™¼é€ [FIN,ACK] æ–·é–‹é€£çµã€‚\nè§€å¯Ÿåˆ° tcp å°‘äº†ä¸€æ¬¡å®Œæ•´çš„äº¤æ¡ (å»ºç«‹èˆ‡çµæŸ)ï¼Œçœäº† 9 å€‹ tcp packets ä¾†å›çš„æ™‚é–“ã€‚\nhttp 1.1: keep-alive timeout é è¨­ server æ˜¯äº”ç§’ï¼Œé‚£å¦‚æœ client ç¬¬äºŒå€‹ request è¶…éäº”ç§’ç™¼é€æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ\næ ¹æ“šè§€å¯Ÿçµæœï¼Œåœ¨ç¬¬ä¸€å€‹ request å®Œæˆå¾Œï¼Œæ¯éš”ä¸€ç§’(ç§’æ•¸å¯èª¿æ•´)æœƒå¾ client ç™¼é€ [ TCP Keep-Alive ] å°åŒ…ï¼Œäº”ç§’åˆ° server ä¸»å‹•æ–·é–‹é€£ç·šï¼›\nä¸‹ä¸€å€‹ http request å°±å¿…é ˆé‡æ–°å»ºç«‹ tcp é€£ç·šã€‚\nå°çµï¼š\næ²’æœ‰èµ° persistent connectionï¼Œé€šå¸¸æ˜¯ç”± server close connectionï¼Œå› ç‚º server æ±ºå®š response çš„é•·åº¦ï¼›\nä½†æ˜¯ persistent connection ä¸‹ï¼Œå¯èƒ½ç”± client æˆ– server ä»»ä¸€è€… close connectionï¼Œä¸éæ–°çš„ request é‚„æ˜¯ç”± client ç™¼èµ·ã€‚\nç¾åœ¨åŠ å…¥ Nginx Reverse Proxyï¼Œæ¨¡æ“¬å¹¾ç¨®æƒ…æ³\nNginx Proxyâ€Šâ€”â€Šä¸ä½¿ç”¨ KeepAlive å¾æœ€åŸºæœ¬çš„è¨­å®šæª”é–‹å§‹ï¼Œæœ€å–®ç´”è½‰ç™¼çš„å‹•ä½œ\næ¥è‘—ç”¨ docker åŸ·è¡Œ\ndocker run -v /Users/zhengyuanjie/Desktop/Nodejs/persistent-connection/ka_nginx.conf:/etc/nginx/nginx.conf -it -p 8080:80 nginx\nç›®å‰åˆ†æˆå…©æ®µ client \u0026lt;---\u0026gt; nginx \u0026lt;---\u0026gt; nodejs server\nåˆ†åˆ¥æŸ¥çœ‹ wireshark å°åŒ…\nå·¦åœ–ç‚º client â† â†’ nginx / å³åœ–ç‚º nginx â† â†’Â server\nå› ç‚º nginx keep-alive è¨­ç½® timeout ç‚º 65ç§’ï¼Œæ‰€ä»¥ client \u0026lt;---\u0026gt; nginx è™•æ–¼ persistent connectionï¼›\nä½†æ˜¯ nginx \u0026lt;---\u0026gt; server é€™æ®µæ˜¯æ¯æ¬¡ request éƒ½é‡æ–°å»ºç«‹ï¼Œé è¨­åˆ° server é€™æ®µ nginx ä¸æœƒå»ºç«‹ persistent connectionã€‚\nNginx Proxyâ€Šâ€”â€Šé–‹å•ŸKeepAlive ä¸” timeout å¤§æ–¼ nodejsÂ server ç°¡å–®ä¿®æ”¹ä¸€ä¸‹ nginx confï¼Œè®“ nginx \u0026lt;---\u0026gt; server é€™æ®µä¹Ÿèµ° persistent connection\nè§€å¯Ÿåˆ°ä¸€å€‹ç¾è±¡æ˜¯ client â† â†’ nginx å·²ç¶“ç”± client ä¸»å‹•æ–·é–‹é€£ç·šï¼Œä½†æ˜¯ nginx åˆ° server å»è¦ç­‰åˆ°å…¶ä¸­ä¸€è€… timeout æ‰æœƒæ–·é–‹é€£ç·šï¼Œé›™æ–¹éƒ½ä¸æœƒä¸»å‹•ç™¼é€ Connection:closeï¼›\nå¤šå€‹ client ç™¼é€ï¼Œn å€‹ client æœƒå»ºç«‹ n å€‹åˆ° nginx connectionï¼Œä½†æ˜¯ nginx â† â†’ server æœƒç”¨åŒä¸€æ¢ connection ã€‚\nå¶ç™¼çš„502 éŒ¯èª¤â€Šâ€”â€ŠKeep-Alive Race Condition Tuning NGINX behind Google Cloud Platform HTTP(S) Load Balancer\n** è§£å†³ AWS ELB å¶å‘çš„ 502 Bad Gateway é”™è¯¯_ - Timon Wong**\nThe NGINX timeout might be reached at the same time the load balancer tries to re-use the connection for another HTTP request, which breaks the connection and results in a 502 Bad Gateway response from the load balancer.\nçœ‹åˆ°å¹¾ç¯‡ç›¸é—œçš„å•é¡Œï¼Œä¸»è¦éƒ½æ˜¯ç™¼ç”Ÿ race conditionï¼ŒæŸä¸€æ–¹åœ¨å‰›å¥½æ”¶åˆ° [FIN, ACK] å¾Œåˆæ”¶åˆ°ä¸‹ä¸€å€‹ requestï¼Œå°è‡´äº† tcp connection error å›å‚³ [RST]ï¼›\nè§£æ±ºæ–¹æ³•é€šå¸¸æ˜¯æ‹‰é•· api server ç«¯çš„ keep-alive timeoutï¼Œè®“ load balancer è‡ªå·±æ–·é–‹ connectionã€‚\nTCP Close Connection Transmission Control Protocol - Wikipedia ç•¶ TCP æ±ºå®šè¦é—œé–‰é€£ç·šæ™‚ï¼Œéœ€è¦å››æ¬¡äº¤æ¡ï¼Œä¸»è¦æ˜¯ client â†’ server èˆ‡ server â† client å…©å€‹æ–¹å‘éƒ½æœ‰ä¸€çµ„çš„ FINÂ , ACK äº¤æ›ï¼Œæ‰èƒ½ç¢ºä¿èªªé—œé–‰é€£ç·šå¾Œå°æ–¹ä¸æœƒå†é€è³‡æ–™ï¼›\nå‡è¨­ç›®å‰æ˜¯ AÂ , B åœ¨é€šä¿¡\nA é€å‡ºäº† [FIN] è¡¨ç¤ºå³å°‡é—œé–‰ A â†’ B çš„ Connection B å› [ACK]ï¼Œè¡¨ç¤ºæ”¶åˆ°ï¼ŒA â†’ B å°±é—œé–‰äº† ä½†é€™æ™‚å€™ B â†’ A é‚„æ˜¯å¯ä»¥ç¹¼çºŒå‚³é€è³‡æ–™ï¼Œç›´åˆ° B é€å‡º [FIN] A å›å‚³ [ACK]ï¼Œtcp connection æ‰çœŸæ­£é—œé–‰ã€‚ é€™å€‹ç‹€æ…‹æ˜¯ half-open ï¼ŒæŸä¸€å€‹æ–¹å‘é—œé–‰ä½†å¦ä¸€å‘é‚„æ˜¯é€šçš„ã€‚\nåœ¨æŸäº›ç³»çµ±(Linux)çš„å¯¦ä½œä¸Šåƒ…æ”¯æ´ half-duplexï¼Œç•¶è¦é—œé–‰æŸä¸€å‘çš„ connection æ™‚æœƒé€£è®€å–éƒ½ä¸€ä½µé—œé–‰ï¼Œå¦‚æœé‚„æ²’è™•ç†å®Œæ‰€æœ‰çš„è³‡æ–™ï¼Œæ­¤æ™‚ host æœƒå›å‚³ RSTï¼Œå¦ä¸€æ–¹è¦–æ­¤æ¬¡ request å¤±æ•—ã€‚\nNginx å„ªåŒ– nginxä¼˜åŒ–\u0026ndash;åŒ…æ‹¬httpsã€keepaliveç­‰\nkeep-alive æœ‰å¹¾å€‹ç›¸é—œçš„åƒæ•¸ï¼Œå¯ä»¥ä¾æ“šæœå‹™å…§å®¹è€Œèª¿æ•´ï¼Œç°¡å–®ç­†è¨˜å¹¾å€‹é‡é»\nkeepalive_requests\nä¸€å€‹ persistent connection æœ€å¤§çš„æœå‹™ request æ•¸é‡ï¼Œè¶…éå‰‡å¼·è¿«é—œé–‰ keepalive_timeout\nconnection idle è¶…éæ™‚é–“å°±æœƒè¢«å¼·è¿«é—œé–‰ keepalive\næœ€å¤§åŒæ™‚ connection idle æ•¸é‡ï¼Œå¦‚æœè¶…éå‰‡ idle connection æœƒè¢«å›æ”¶ çµèª keep-alive å„ªé»åœ¨æ–¼é‡è¤‡åˆ©ç”¨ tcp connectionï¼Œä½†å¿…é ˆæ³¨æ„\nclient library çš„å¯¦è¸ï¼Œç¢ºèªæ˜¯å¦æœ‰ä¸»å‹•ç™¼é€ connection: close æ©Ÿåˆ¶ï¼Œå¦å‰‡ server éƒ½æœƒç­‰åˆ° timeout æ‰æ–·é–‹é€£ç·šï¼Œæœƒé€ æˆå¤ªå¤šä¸å¿…è¦çš„ idleã€‚ nginx â† â†’ server é€™æ®µçš„é•·é€£æ¥ timeout é›™æ–¹éƒ½å¯ä»¥æ‹‰é•·ï¼Œå¦‚æœ QPS (query per second) å¾ˆé«˜çš„è©±ï¼Œå¤šå€‹ client connection ä¹Ÿæœƒåˆ©ç”¨åŒä¸€æ¢ nginx â† â†’ server çš„ persistent connectionã€‚ å¦‚æœæœ‰ä½¿ç”¨ GCP / AWS load balancer å¶ç™¼ 502éŒ¯èª¤ï¼Œä¸” api server ç«¯æ²’æœ‰æ”¶åˆ°ä»»ä½•é€£ç·šç´€éŒ„ï¼Œå¤šåŠæ˜¯ keep-alive timeout å•é¡Œã€‚ è®“ client timeout å¤§æ–¼ server timeoutï¼Œå› ç‚º request æ˜¯ç”± client ç™¼èµ·ï¼Œå°±èƒ½æœ‰æ•ˆé¿å… keep-alive race conditionã€‚ ","date":"2019-04-08T23:46:01.643Z","permalink":"https://yuanchieh.page/posts/2019/2019-04-08-http-persistent-connection-%E7%A0%94%E7%A9%B6%E8%88%87-proxy-server-keep-alive-timeout-%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84-502-%E9%8C%AF%E8%AA%A4/","title":"Http persistent connection ç ”ç©¶èˆ‡ proxyâ€Šâ€”â€Šserver keep-alive timeout ä¸ä¸€è‡´çš„ 502 éŒ¯èª¤"},{"content":"ä»¥ä¸‹ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ Linux Kernel å…§å»ºçš„å·¥å…· tc ï¼Œå®Œæˆ\nç¶²è·¯æµé‡ç®¡åˆ¶ï¼Œç•¶ä¸€å°ä¸»æ©Ÿä¸Šæœ‰å¤šå€‹ç¶²è·¯æœå‹™ï¼Œå¸Œæœ›å¯ä»¥åˆ†é…ä¸åŒçš„ç¶²è·¯é »å¯¬ã€å°åŒ…å‚³é€çš„å„ªå…ˆåºç­‰ æ¨¡æ“¬æƒ¡åŠ£ç¶²è·¯ç’°å¢ƒä¸‹çš„ç‹€æ…‹ï¼Œä¾‹å¦‚å°åŒ…å»¶é²ã€éš¨æ©Ÿæ€§æ‰å°åŒ… ç’°å¢ƒå‰‡æ˜¯åœ¨ MacOS ç”¨ VMè·‘ Ubuntu 16.04ã€‚\nèƒŒæ™¯çŸ¥è­˜ä»‹ç´¹ NetworkÂ Layer tc æ˜¯åŸºæ–¼ç¶²è·¯åˆ†å±¤ä¸­çš„ Network Layer ç¶²è·¯å±¤é€²è¡Œå°åŒ…çš„æ§åˆ¶ï¼Œé‡å°å°åŒ…çš„ ip å…§å®¹é€²è¡Œç¯©é¸èˆ‡æ§åˆ¶ã€‚\nç¶²è·¯å±¤ï¼Œä¸»è¦é—œæ³¨æ–¼å¦‚ä½•å°‡æºç«¯çš„å°åŒ…é€éè·¯ç”±å™¨ï¼Œä¸€æ­¥æ­¥(hop)æ­£ç¢ºçš„å‚³é€åˆ°æ¥æ”¶ç«¯ï¼Œä¸­é–“çš„è·¯ç”±ç®—æ³•ç­‰ç•¥éä¸è«‡ï¼Œé€™é‚Šä¸»è¦é—œæ³¨æ–¼å£…å¡æ§åˆ¶èˆ‡æœå‹™è³ªé‡\nå£…å¡æ§åˆ¶ ( Congestion ControlÂ ) Congestion å£…å¡æ˜¯æŒ‡ ç•¶ä¸»æ©Ÿæ¥æ”¶çš„å°åŒ…é‡å¢åŠ ï¼Œå¤§æ–¼ç™¼é€çš„é‡ï¼Œæ­¤æ™‚æœƒè¢«æš«å­˜æ–¼ Bufferç·©å­˜å€ç•¶ä¸­ï¼Œä½†å¦‚æœå°åŒ…é‡å¡«æ»¿äº†ç·©å­˜å€ï¼Œå°±æœƒéºå¤±éƒ¨åˆ†å°åŒ…ï¼Œç¶²è·¯ä¹Ÿé–‹å§‹å£…æ“ ã€‚\né¿å…å£…å¡çš„æ–¹å¼æœ‰å¹¾ç¨®\nå¢åŠ ç¶²è·¯è™•ç†çš„èƒ½åŠ› æµé‡æ„ŸçŸ¥\nä¸»å‹•å°‡å°åŒ…ç¹é–‹å£…å¡å€åŸŸï¼Œèµ°å…¶ä»–åˆ©ç”¨ç‡è¼ƒä½çš„è·¯ç”±å™¨ï¼Œé€™æœƒéœ€è¦ä¿®æ”¹è·¯ç”±ç®—æ³•ï¼Œå°‡å¸¶å¯¬ã€å‚³é€å»¶é²ç­‰éƒ½ä¸€ä½µæ”¾å…¥ link state routing çš„æ¬Šé‡åˆ†é…ï¼Œæ±ºå®šå°åŒ…è©²é€å¾€å“ªå€‹è·¯ç”±å™¨ å‡†å…¥æ§åˆ¶\nå¦‚æœç™¼ç¾è² è¼‰éé«˜ï¼Œæ‹’çµ•æ–°çš„é€£ç·šå»ºç«‹ æµé‡èª¿ç¯€\nç•¶è·¯ç”±å™¨ç™¼ç¾æœ‰å£…å¡çš„å¯èƒ½ï¼Œå¯ä»¥ä¸»å‹•ç™¼å‡ºè¨Šæ¯ï¼Œå†å°åŒ…ä¸Šæ¨™è¨˜ï¼Œåˆæˆ–æ˜¯å‚³é€ choke package ï¼Œå‘ŠçŸ¥ç™¼é€è€…æ‡‰è©²è¦é™ä½ç™¼é€çš„é€Ÿåº¦ è² è¼‰è„«è½\nå¦‚æœè·¯ç”±å™¨ä¾†ä¸åŠè™•ç†å°åŒ…ï¼Œç‚ºäº†é¿å…å£…å¡æœƒç›´æ¥ä¸Ÿæ£„å°åŒ…ï¼›\nåšæ³•æœ‰ RED( Random Early Detection)ï¼Œç•¶æŸå€‹æš«å­˜å€è¶…éæŸå€‹é–¥å€¼ï¼Œå°±æœƒé–‹å§‹éš¨æ©Ÿä¸Ÿæ£„å°åŒ…ï¼Œæ­¤æ™‚ç™¼é€æ–¹å°±æœƒæ„è­˜åˆ°éœ€è¦æ”¾ç·©ç™¼é€é€Ÿåº¦ã€‚ æœå‹™è³ªé‡ (QoSï¼ŒQuality ofÂ Service) é™¤äº†å£…å¡æ§åˆ¶å¤–ï¼Œæ‡‰ç”¨ç¨‹å¼å°æ–¼ç¶²è·¯çš„è¦æ±‚ä¹Ÿæœƒæœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚èªªå¤§å‹æ–‡ä»¶éœ€è¦è¼ƒå¤§çš„å¸¶å¯¬ï¼Œä½†æ˜¯å»¶é²æ€§èˆ‡ç¶²è·¯æŠ–å‹•æ²’é€™å€‹æ•æ„Ÿï¼›\nä½†ç›¸å°çš„å½±éŸ³é »ç›´æ’­ï¼Œå°æ–¼ç¶²è·¯æŠ–å‹•å°±éå¸¸æ•æ„Ÿï¼Œæˆ–è¨±ä½ å¯ä»¥æ¥å—ä¸€å€‹å½±ç‰‡ç©©å®š delay 10ç§’é˜é–‹å§‹ï¼Œä½†ç„¡æ³•æ¥å—æ’­åˆ°ä¸€åŠå¡é “ã€‚\næœå‹™è³ªé‡æœ‰å…©ç¨®é¡åˆ¥\nIntegrated Service (ç¶œåˆæœå‹™)ï¼š\nåœ¨å°åŒ…å‚³é€çš„è·¯å¾‘ä¸Šï¼Œæ‰€æœ‰çš„è·¯ç”±å™¨éƒ½ä¿ç•™ä¸€å®šé¡åº¦çš„è³‡æºï¼Œå½¢æˆå°ˆç”¨ç«¯åˆ°ç«¯çš„æ•¸æ“šæµï¼Œå°±å¥½æ¯”å…¬è»Šå°ˆç”¨é“å°±åªèƒ½ç”±å…¬è»Šè¡Œé§›ï¼›\nå¥½è™•æ˜¯èƒ½å¤ å¾ˆç©©å®šçš„æœå‹™è³ªé‡ï¼Œä½†ç¼ºé»å°±æ˜¯éœ€è¦éå¸¸é¾å¤§çš„è³‡æºï¼Œä¸”æ•ˆç‡ä¸é«˜ï¼Œå…·é«”å”è­°å¯ä»¥åƒè€ƒ RSVPï¼Œä½†é€™å› ç‚ºé›£åº¦éé«˜å¹¾ä¹æ²’æœ‰å¯¦è¸ã€‚ Differential Service (å€åˆ†æœå‹™)ï¼š\nå°æ¯”æ–¼ç¶œåˆæœå‹™æä¾›æ•´æ®µç¶²è·¯çš„æœå‹™è³ªé‡ï¼Œå€åˆ†æœå‹™åƒ…æä¾›å–®å€‹è·¯ç”±å™¨çš„æœå‹™è³ªé‡ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯ä¸€æ¬¡çš„ hop é–“ç”±è©²è·¯ç”±å™¨ä¿ç•™è³‡æº(Per Hop Behavior)ï¼Œç­‰åˆ°ä¸‹ä¸€è·³å†ç”±ä¸‹ä¸€å€‹è·¯ç”±å™¨é ç•™è³‡æºï¼›\nåœ¨ IPv4 çš„å°åŒ…ä¸­ï¼Œheader åŒ…å«ä¸€å€‹æ¬„ä½ ToS( Type of Service)ï¼Œå…± 8 bitsï¼Œå‰ 6 bits è¡¨ç¤ºæœå‹™é¡å‹ï¼Œå¾Œ 2 bits è¡¨ç¤ºå£…å¡è¨Šæ¯ã€‚ ç‚ºäº†æä¾›æœå‹™è³ªé‡ï¼Œè·¯ç”±å™¨å¿…é ˆæ±ºå®šå°åŒ…ç™¼é€é †åº( Packet Scheduling )ä»¥åŠæ§åˆ¶æµé‡(Traffic Shaping æµé‡æ•´å½¢) çš„åŠŸèƒ½\nTraffic Shaping ä¸»è¦æ˜¯é‡å°çªç™¼æ€§æµé‡æ‰€æ¡å–çš„æ”¤å¹³æµé‡æ–¹å¼ï¼Œé¿å…ä¸€æ¬¡æ€§å¡æ»¿ç·©å­˜å€å°è‡´å°åŒ…æ‰è½ï¼Œå¸¸è¦‹çš„æ–¹å¼æœ‰å…©ç¨®\nLeaky Bucket\næœ‰ä¸€å€‹æ¼æ´çš„æ¡¶ï¼Œæ¡¶çš„å°ºå¯¸èˆ‡å‡ºå£çš„æœ€å¤§æµé€Ÿå›ºå®šï¼›\nåªè¦ä¸Šæ–¹æœ‰æ°´æ³¨å…¥ï¼Œæ¡¶å°±æœƒè‡ªå‹•å¾å‡ºå£å‡ºå»ï¼Œå¦‚æœæ³¨å…¥é€Ÿåº¦é«˜æ–¼å‡ºå£æµé€Ÿï¼Œå°±æœƒé–‹å§‹åœ¨æ¡¶ä¸­ç´¯ç©ï¼Œå¦‚æœæ»¿äº†å°±æº¢å‡ºã€‚ https://www.geeksforgeeks.org/leaky-bucket-algorithm/\n2. Token Bucket\næ¡¶å­å…§æ”¹å­˜æ”¾ Tokenï¼Œå¦‚æœæ¡¶å­æ»¿äº†å°±ä¸å†æ”¾ Tokenï¼›\nå¦‚æœæ­¤æ™‚æœ‰ packet è¦ç™¼é€ï¼Œå°±å¿…é ˆå¾æ¡¶å­ä¸­æ¶ˆè€—ä¸€å€‹ Tokenï¼Œå¦‚æœæ²’æœ‰ Token å‰‡ packet ä¸èƒ½ç™¼é€ã€‚\nå°æ¯” Leaky Bucketå„ªé»åœ¨æ–¼Â - Leaky Bucket æ¡¶å­æ»¿äº†æœƒé–‹å§‹ä¸Ÿå°åŒ…ï¼Œè€Œ Token Bucket å‰‡æ˜¯ä¸Ÿæ£„ Token\n- ç•¶æµé‡ä½æ™‚ï¼ŒToken Bucket æœ‰æ©Ÿæœƒå¯ä»¥ç´¯ç© Tokenï¼Œç­‰åˆ°é«˜å³°æ™‚ä¸€æ¬¡æ€§ä½¿ç”¨æ‰ï¼Œè€Œ Leaky Bucket ç„¡æ³•åšè³‡æºçš„ä¿ç•™\nhttps://gateoverflow.in/39720/gate2016-1-54\nPacket Scheduling ç•¶è·¯ç”±å™¨ä¸€æ¬¡æ”¶åˆ°å¤šå€‹æœå‹™è³ªé‡è«‹æ±‚çš„å°åŒ…æ™‚ï¼Œæœƒéœ€è¦ packet scheduling æ©Ÿåˆ¶è™•ç†ç™¼é€çš„å…ˆå¾Œé †åºï¼Œæœ€åŸºæœ¬çš„å°±æ˜¯ä¸€æ¢ FIFO çš„Queueï¼Œæ‰€ä»¥çš„å°åŒ…éƒ½æŒ‰é †åºæ’éšŠç™¼é€ï¼Œä½†æ˜¯é€™ç„¡æ³•æä¾›è‰¯å¥½çš„æœå‹™è³ªé‡ä¿è­‰ï¼›\nå¦ä¸€å€‹æ˜¯ Fair Queueing (å…¬å¹³éšŠåˆ—)ï¼Œæ¯å€‹ data flow éƒ½ç¨ç«‹ä¸€å€‹ queueï¼Œè·¯ç”±å™¨ä»¥è¼ªæ’­çš„æ–¹å¼ï¼Œè¼ªæµç™¼é€å°åŒ…ï¼›\nåœ¨æ­¤ä¹‹ä¸Šé‚„æœ‰ WFQ (åŠ æ¬Šå…¬å¹³éšŠåˆ—)ï¼Œæ¯å€‹ Queue æ¬Šé‡ä¸åŒï¼Œæ¬Šé‡é«˜çš„ç™¼é€é »ç‡æœƒé«˜æ–¼æ¬Šé‡ä½ã€‚\nå°çµï¼šNetwork Layer æä¾›å£…å¡æ§åˆ¶èˆ‡æœå‹™è³ªé‡çš„æ§åˆ¶ï¼Œè€Œæœå‹™è³ªé‡ä¸‹æµé‡æ•´å½¢èˆ‡å°åŒ…èª¿åº¦æ©Ÿåˆ¶çš„å¯¦ä½œï¼Œä¹Ÿå°±æ˜¯å¾ŒçºŒè¦ç”¨ tc æ§åˆ¶çš„éƒ¨åˆ†\nå¸¸ç”¨ç¶²è·¯æŒ‡ä»¤ æ‰¾å‡ºè£ç½®ä¸Šç›®å‰çš„ network interfaceï¼š\nNetwork Interface Card(ç¶²è·¯å¡) ä¸€ç«¯æ˜¯é€£æ¥é€šè¨Šä»‹è³ª(ä¹™å¤ªç¶²ã€Wifiç­‰)ï¼Œå¦ä¸€ç«¯å‰‡æ˜¯æä¾›ä¸»æ©Ÿçš„ç¶²è·¯æ“ä½œä»‹é¢(network interface) 1 2 3 4 5 // åœ¨ mac os ä¸Š $ networksetup -listallhardwareports // åœ¨ ubuntu ä¸Š $ ip link show 2. è§€å¯ŸæŸ network interface æµé‡\nåƒè€ƒæ­¤ç¯‡æ–‡ç«  18 commands to monitor network bandwidth on Linux serverï¼ŒæŒ‘é¸äº†å…©å€‹ä¸éŒ¯çš„å·¥å…· speedometer ç”¨é•·æ¢åœ–å³æ™‚è¡¨ç¾å°åŒ…æµé‡ã€tcptrack è§€å¯Ÿ tcp é€£ç·šç‹€æ…‹ï¼Œæ–¹ä¾¿å¾ŒçºŒå¯¦é©—é‡æ¸¬\n3. æ‰¾å‡º domain name å°æ‡‰çš„ ip\nå› ç‚º tc æ˜¯ç¶²è·¯å±¤å·¥å…·ï¼Œæ‰€ä»¥è¦ç¯©é¸å°åŒ…éœ€è¦é€é ip ï¼Œé€é $host {domain} æ‰¾å‡º ipã€‚\ntc åŸºæœ¬ä»‹ç´¹ tc çš„æµé‡æ§åˆ¶ä¸»è¦ç”±å››å€‹æ¦‚å¿µçµ„æˆ\nShaping ï¼šæ§åˆ¶å°åŒ…çš„å‚³è¼¸é€Ÿåº¦ Schedulingï¼šæ§åˆ¶å°åŒ…çš„ç™¼é€é †åº Policingï¼šæ”¶åˆ°å°åŒ…å¾Œçš„è™•ç†æ©Ÿåˆ¶ Droppingï¼šæµé‡è¶…éå¸¶å¯¬å¾Œçš„ä¸Ÿå°åŒ…æ©Ÿåˆ¶ å¯¦ä½œä¸Šæœ‰ä¸‰å€‹ç‰©ä»¶\nQdisc (queueing discipline)ï¼š\nç•¶ kernel æƒ³è¦é€é network interface ç™¼é€ package æ™‚ï¼Œæœƒå…ˆå…¨éƒ¨è¢«æ”¾åœ¨ queue ä¸Šé¢ï¼Œé è¨­æ˜¯ pfifoï¼Œä¸åšä»»ä½•è™•ç†å–®ç´”çš„ First-In First-Outã€‚ Class\næœ‰äº› qdisc å¯ä»¥å®šç¾© Classï¼ŒClass ä¸»è¦ç”¨æ–¼åšæµé‡çš„ç®¡åˆ¶ï¼Œæ”¯æ´ Class çš„ Qdisc åˆç¨±ç‚º classful qdiscï¼Œæ¯å€‹ Class åˆåŒ…å«è‡ªå·±å…§éƒ¨çš„ Queueï¼Œæ‰€ä»¥èƒ½çµ„æˆå±¤ç‹€çš„ç¶²è·¯æµé‡æ§åˆ¶ Filter\næ±ºå®š package è¦é€å¾€å“ªå€‹ classï¼Œæ¯å€‹ filter æ˜¯ç¶å®šåœ¨ qdisc ä¸Šã€‚ å¹¾ç¨® QdiscÂ ä»‹ç´¹ qdisc æœ‰éå¸¸å¤šç¨®ï¼Œé€™è£æŒ‘å¹¾å€‹ç°¡å–®ä»‹ç´¹ï¼Œå±†æ™‚å¯ä¾ç…§å±¬æ€§é¸æ“‡ä½¿ç”¨\nclassless qdisc pfifo / bfifo\né‡å° Packet / Byte Buffer å®¹é‡é™åˆ¶çš„ First-In First-Out Queueï¼Œé€™ç¨® queue ä¸¦ä¸æœƒå°å°åŒ…æœ‰é¡å¤–çš„æ“ä½œï¼Œæ”¶åˆ°å°±ä¾ç…§é †åºè½‰ç™¼ï¼Œè¶…é Buffer å°±ä¸Ÿæ‰ï¼Œé€™æ˜¯æœ€ç°¡å–®çš„ qdiscã€‚\nä½¿ç”¨ä¸Šå¦‚ sudo tc qdisc add dev enp0s5 root pfifo limit 1000 pfifo_fast\né è¨­çš„ qdiscï¼Œå…§å»ºæ˜¯ä¸‰æ¢ pfifo(ç¨±ç‚º band)ï¼Œæœƒä¾æ“š IPV4 header ä¸­çš„ ToS è½‰ç™¼åˆ°å°æ‡‰çš„ bandï¼Œå¦‚æœ band ä¸­æœ‰å°åŒ…ï¼Œæœƒå¾ä½é †ä½çš„ band é–‹å§‹ç™¼é€ï¼Œç›´åˆ°æ¸…ç©ºå¾Œä¾åºæ›é«˜é †ä½çš„ band classful qdisc tbf\nä¹Ÿå°±æ˜¯ Token Bucket å¯¦ä½œï¼Œä¸»è¦ç”¨æ–¼æµé‡æ•´æµå¢åŠ å¹³å‡æµé€Ÿ 0.5mbps é«˜å³° 1mbps+Bufferç©ºé–“ 5kb\ntc qdisc add dev eth0 handle 10: root tbf rate 0.5mbit burst 5kb peakrate 1mbit prio éå¸¸é¡ä¼¼æ–¼ pfifo_fastï¼ŒåŒæ¨£é è¨­æœ‰ä¸‰æ¢ bandï¼Œä½†å„ªé»æ˜¯å¯ä»¥è‡ªè¨‚ priomapï¼Œæ±ºå®š ToS è¦å°æ‡‰åˆ°å“ªå€‹ band (pfifo_fast ç„¡æ³•è‡ªå®š)ï¼›\nå¦å¤–ä¹Ÿæ”¯æ´ tc filterï¼Œç”¨å…¶ä»–çš„æ¢ä»¶æ±ºå®šå°åŒ…è½‰ç™¼åˆ°å“ªå€‹ bandã€‚ htb\nç”¨æ–¼æ§åˆ¶ outbound å¸¶å¯¬æµé‡ï¼ŒåŸºæ–¼ Token Bucket å¯¦ä½œ * è£œï¼š working-conserving scheduler:\næ¯ç¨® qdisc å¯åˆ†ç‚º working-conserving æˆ–æ˜¯ non-working-conservingï¼Œworking-conserving è¡¨ç¤ºä¸æœƒè®“è³‡æº idleä¸‹ä¾†ï¼›\nnon-working-conserving å‰‡æ˜¯æœƒåœ¨æŸäº›æ¢ä»¶ä¸‹å»¶é²ï¼Œå¯ç”¨æ–¼æ¶ˆé²æŠ–å‹• (jittering )æˆ–æ˜¯éœ€è¦é æœŸæ€§çš„æ’ç¨‹ã€‚\nä¾‹å¦‚èªª pfifo æ”¶åˆ°å°åŒ…å¾Œï¼Œå°±æœƒç«‹å³é€å‡ºï¼›\nå°æ‡‰çš„ tbf å°±æ˜¯ non-working-conservingï¼Œæ”¶åˆ°å°åŒ…å¾Œï¼Œæœƒçœ‹æ˜¯å¦æœ‰ token æ‰æœƒé€å‡ºå°åŒ…ï¼Œä¸¦ä¸ä¸€å®šæ˜¯ç«‹å³ç™¼ç”Ÿã€‚\ntcâ€Šâ€”â€Šå»¶é²å°åŒ… é€éåŸºæœ¬çš„ classless pfifo qdiscï¼Œå¯¦ä½œï¼š\né€éå°åŒ…å»¶é²ï¼Œæ”¾ç·© httpé€£ç·šåˆ° stackoverflow é€é bandwidth(å¸¶å¯¬)é™åˆ¶ï¼Œèª¿æ•´ aws s3 ä¸Šå‚³çš„é€Ÿåº¦ ä»¥ä¸‹æŒ‡ä»¤åƒè€ƒ\n1. åˆ—å‡ºç›®å‰æ‰€æœ‰çš„ network interface çš„è¨­å®š 1 2 3 $ tc qdisc ls qdisc noqueue 0: dev lo root refcnt 2 qdisc pfifo_fast 0: dev enp0s5 root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 tc-prio æ˜¯é è¨­çš„éšŠåˆ—è¦å‰‡ï¼Œå¦‚æœæœ‰ç¶å®šæ–°çš„éšŠåˆ—è¦å‰‡æœƒç›´æ¥è¦†è“‹éå»ã€‚\né è¨­ prio æœƒæœ‰ä¸‰å€‹ bandï¼Œè€Œ priomap å‰‡è¡¨ç¤ºå°æ‡‰ IP å°åŒ…ä¸­çš„ 4bits TOS æ¬„ä½ï¼Œå°‡å°åŒ…é€éè©² band ç™¼é€ã€‚\néœ€æ³¨æ„ enp0s5 æ˜¯æˆ‘è‡ªå·±çš„ network interfaceï¼Œè¨˜å¾—æ›¿æ›æˆè‡ªå·±è£ç½®ä¸Šçš„ network interface\nhttp://linux-ip.net/articles/Traffic-Control-HOWTO/classless-qdiscs.html\n2. é è¨­å°‡æ‰€æœ‰çš„æµé‡å°å‘ bandÂ 2 ç‚ºäº†é¿å…å…¶ä»–å°åŒ…è¢«å½±éŸ¿ï¼Œå…ˆå°‡æ‰€æœ‰çš„å°åŒ…éƒ½èµ° band 2(æŒ‡ä»¤è¨ˆæ•¸å¾0é–‹å§‹)\n1 $ sudo tc qdisc add dev enp0s5 root handle 1: prio bands 10 priomap 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 handle 1: æŒ‡çš„æ˜¯ç¶å®šåˆ° qdisc çš„ root\nbands 10: å¯ä»¥å‰µå»º 10çµ„ band\n3. è¨­å®šå°åŒ…å»¶é² $ sudo tc qdisc add dev enp0s5 parent 1:1 handle 10: netem delay 100ms 10ms\nnetem æ˜¯ tc çš„å·¥å…·ä¹‹ä¸€ï¼Œå¯ç”¨ä¾†å¢åŠ å»¶é²ã€æ‰å°åŒ…ã€é‡è¤‡å°åŒ…ç­‰æ¨¡æ“¬å·¥å…·ï¼Œnetem delay 100ms 10ms è¡¨ç¤ºæ¯å€‹å°åŒ…å»¶é² 100ms(+- 10ms) parent 1:1 è¡¨ç¤ºåœ¨ class id 1 åº•ä¸‹ï¼Œå»ºç«‹ä¸€å€‹ id ç‚º 1çš„å­ç¯€é»ï¼Œå› ç‚ºç•¶å‰çš„éšŠåˆ—æ²’æœ‰å¤šå±¤æ¬¡çš„ classè¨­è¨ˆï¼Œæ‰€ä»¥ 1:1 å°±å°æ‡‰åˆ° band 0 handle 10: è¡¨ç¤ºå‰µå»ºä¸€å€‹ class id ç‚º 10 çš„ç¯€é» é›–ç„¶ç›®å‰æœ‰å¢åŠ äº† band0 çš„å»¶é²ï¼Œä½†å› ç‚ºæ‰€æœ‰å°åŒ…éƒ½æ˜¯èµ° band2ï¼Œé‚„ä¸æœƒå—åˆ°å»¶é²çš„å½±éŸ¿ï¼Œå…ˆç”¨å·¥å…·é‡æ¸¬ç›®å‰çš„ç¶²è·¯å»¶é²ï¼Œé€™é‚Šæˆ‘æ˜¯ç”¨ curl\n1 $ curl -o/dev/null -w \u0026#34;\\\\n%{time_connect}:%{time_starttransfer}:%{time_total}\\\\n\u0026#34; -s [https://stackoverflow.com/](https://stackoverflow.com/) åœ¨è¨­å®šå‰ä¸å°ˆæ¥­é‡æ¸¬ç´„ç‚º 1.5 sã€‚\n4. åŠ å…¥éæ¿¾å™¨ï¼Œå°‡ç¬¦åˆæ¢ä»¶çš„å°åŒ…è½‰é€åˆ° bandÂ 0 $ sudo tc filter add dev enp0s5 protocol ip parent 1:0 prio 1 u32 match ip dst 151.101.0.0/16 match ip dport 443 0xffff flowid 1:1\nprotocol å¯ä»¥æŒ‡å®š ipv4Â , ipv6Â , tcp æˆ–udp prio queue çš„ filter åªèƒ½ç¶å®šåœ¨ 1:0 åº•ä¸‹ï¼Œæ‰€ä»¥ parent 1:0 æ˜¯å›ºå®šçš„ u32 æ˜¯ tc çš„å·¥å…·ï¼Œä¸»è¦æ˜¯é‡å° ip å…§æ–‡åšç¯©é¸ï¼Œä¾‹å¦‚ match ip dst è¡¨ç¤ºå°å°åŒ…çš„ç›®æ¨™ä½ç½®åç¯©é¸ï¼›\nå¯ä»¥è¨­ç½®å¤šå€‹ match æ¢ä»¶ flowid 1:1 è¡¨ç¤ºæ­¤ filter ç¶å®šåˆ° band 0 ä¸Š å¤šå€‹ filter å¯ä»¥ç¶å®šåˆ°åŒä¸€å€‹ band ä¸Š è¨­å®šå®Œä¹‹å¾Œï¼Œ éŸ¿æ‡‰æ™‚é–“è®Šæˆ 12ç§’!\nå› ç‚º netem æ˜¯é‡å° package åš delayï¼Œä¸€å€‹ http(s) request æœƒä¾†å›å¤šæ¬¡ï¼Œæ¯æ¬¡å‚³é€ä¸ç­‰å¤šçš„ packageï¼Œæ‰€ä»¥ æ¯å€‹ request delay æ™‚é–“æœƒé æ¯” 1s é•·ã€‚\nä½¿ç”¨ prio éå¸¸æ–¹ä¾¿çš„æ˜¯ï¼Œåº•ä¸‹çš„ band å¯ä»¥å†å¦å¤–æ›å…¶ä»–çš„ qdiscï¼Œä¾‹å¦‚èªªåŠ ä¸Š tbf å°±å¯ä»¥é™åˆ¶å¸¶å¯¬ï¼ŒåŠ ä¸Š netem å°±å¯ä»¥æµé‡æ•´å½¢ï¼Œè€Œä¸” band æ•¸é‡å¯ä»¥è‡ªè¡Œå®šç¾©ï¼Œç›¸ç•¶å¥½ç”¨ã€‚\ntcâ€Šâ€”â€Šå¸¶å¯¬é™åˆ¶ å‰›æ‰ä½¿ç”¨ pfifo qdiscï¼Œæ­é… netem åšåŸºæœ¬çš„æµé‡æ§åˆ¶ï¼Œä½†å¦‚æœéœ€è¦æ§åˆ¶å¸¶å¯¬ï¼Œå°±éœ€è¦ç”¨å…¶ä»–çš„ qdiscï¼Œé…ç½® Token Bucket æˆ–æ˜¯ Leaky Bucketã€‚\nä»¥ä¸‹ä½¿ç”¨ classful qdisc HCBã€‚\næ¸¬è©¦é™åˆ¶ aws s3 ä¸Šå‚³çš„å¸¶å¯¬\n1. åˆªé™¤èˆŠçš„ qdiscÂ è¨­å®š 1 $ sudo tc qdisc del dev enp0s5 root 2. å»ºç«‹Â htb 1 $ sudo tc qdisc add dev enp0s5 root handle 1:0 htb 3. åŠ å…¥ bandwidth é™åˆ¶ 1 $ sudo tc class add dev enp0s5 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps æ¯”å° s3 ä¸Šå‚³çš„å‰å¾Œï¼Œç™¼ç¾ä¸Šå‚³é€Ÿåº¦ç¢ºå¯¦è¢«é™åˆ¶åœ¨ 100kbps\nå¦‚æœå–®ç´”æƒ³è¦é™åˆ¶ä¸Šå‚³é€Ÿåº¦ï¼Œä¹Ÿå¯ä»¥ç”¨ tc-tbfï¼Œä½† htb å„ªé»æ˜¯ç”¨å±¤ç‹€æ¶æ§‹é™é€Ÿï¼Œleaf æœƒå—åˆ° root çš„é™åˆ¶ï¼Œä¾‹å¦‚åˆ†é…ä¸€æ¢å¸¶å¯¬ 10 Mbpsï¼Œå¯ä»¥åœ¨ä¹‹ä¸‹åˆ†é… 4 Mbps çµ¦æŸç¶²åŸŸ 6 Mbps çµ¦å…¶ä»–ç¶²åŸŸç­‰ç­‰ã€‚\nç­†è¨˜æœƒç”¨åˆ°çš„å…¶ä»–æŒ‡ä»¤\nä½¿ç”¨ dd å‰µå»ºæŒ‡å®šå¤§å°çš„æª”æ¡ˆ\nif: æª”æ¡ˆå…§å®¹ä¾†æºï¼Œ/dev/zero æ˜¯ç‰¹æ®Šæª”æ¡ˆï¼Œè®€å–æ™‚æœƒæä¾›ç„¡é™çš„ç©ºå­—å…ƒ\nof: æª”æ¡ˆå…§å®¹è¼¸å‡º\nbs: æ¯æ¬¡å¯«å…¥çš„å€å¡Šå¤§å° (byte)\ncount: ç¸½å…±å¯«å¤šå°‘å€‹å€å¡Š\n$dd if=/dev/zero of=file.txt count=1048576 bs=1024\né€™æ¨£æœƒç”¢å‡º file.txt æ–¼ç•¶å‰ç›®éŒ„ä¸¦ä½” 102MB aws-cli ä¸Šå‚³æª”æ¡ˆ\n$aws s3 cp file.txt s3://{bucket åç¨±}Â aws s3 åœ¨ä¸Šå‚³æª”æ¡ˆæœƒç”¨å¤šå€‹ thread èˆ‡ ipï¼Œæ‰€ä»¥è¦é™åˆ¶æ¯”è¼ƒå›°é›£ã€‚ åƒè€ƒè³‡æ–™ ç¶²è·¯ç›¸é—œåƒè€ƒè‡ªã€Šè®¡ç®—æœºç½‘ç»œ(ç¬¬5ç‰ˆ)ã€‹ä¸€æ›¸ã€‚\n","date":"2019-04-05T12:20:15.159Z","permalink":"https://yuanchieh.page/posts/2019/2019-04-05-linux-traffic-control-tc-%E7%A0%94%E7%A9%B6/","title":"Linux Traffic Control (tc) ç ”ç©¶"},{"content":"æœ€è¿‘åœ¨æ•™äººå¯«ç¨‹å¼ï¼Œç™¼ç¾è‡ªå·±é›–ç„¶æœ‰å¯«éƒ¨è½æ ¼çš„ç¿’æ…£ï¼Œä½†æ˜¯è¦å¦‚ä½•ç”¨å£èªè¡¨é”å»é‚„æœ‰å¾ˆå¤§ä¸€æ®µçš„è½å·®ï¼Œæ›´å›°é›£çš„æ˜¯ã€Œæˆ‘ä¸çŸ¥é“å¾ä½•æ•™èµ·ã€\nå…ˆå‰çœ‹åˆ°æœ‰äººåˆ†äº«åˆ° å¤§è…¦å…¶å¯¦æ˜¯å–„æ–¼è¨˜æ†¶ï¼Œå› ç‚ºæ€è€ƒå¤ªèŠ±èƒ½é‡ï¼Œæ‰€ä»¥å¤§è…¦ç¶“éåè¦†çš„ç·´ç¿’å°±æœƒå°‡æˆæœå…§åŒ–ç‚ºè¨˜æ†¶ï¼›\nè€Œæ•™å­¸å°±æ˜¯åŠ é€Ÿé€™å€‹éç¨‹ï¼Œä¸¦æä¾›å­¸ç¿’æ–¹æ›´æœ‰å‹•åŠ›ï¼Œå¸Œæœ›å¯ä»¥è‡ªå·±ä¸Šå®Œèª²å¾Œå¯ä»¥æ›´æ‡‚å¾—å¦‚ä½•æ•™å…¶ä»–äººç”¨å¿«æ¨‚çš„æ–¹å¼å­¸å¯«ç¨‹å¼XD\né›»è…¦ç§‘å­¸ Computer ScienceÂ åœ¨åšä»€éº¼ æåˆ°é›»è…¦ç§‘å­¸ï¼Œå¤§å®¶çš„åˆ»æ¿å°è±¡é€šå¸¸æ˜¯ ä¸€å€‹å¸¶è‘—åç¤¾æœƒäººæ ¼çš„å¸½Tç”·ç˜‹ç‹‚æ•²è‘—é›»è…¦å¯«ç¨‹å¼ï¼Œä½†å…¶å¯¦é›»è…¦ç§‘å­¸å°ˆæ³¨æ–¼ è§£æ±ºå•é¡Œ\n1 input -\u0026gt; [ ] -\u0026gt; output è¼¸å…¥æˆ‘å€‘æƒ³è¦è§£æ±ºçš„å•é¡Œï¼Œé€šéä¸­é–“é»‘ç›’å­çš„é‹ç®—ï¼Œæˆ‘å€‘å¾—åˆ°å•é¡Œçš„è§£æ³•ã€‚\næ•¸äººå•é¡Œ ä»Šå¤©å‡è¨­è¦æ•¸å¹¾å€‹äººä¾†ä¸Šèª²ï¼Œæˆ‘å€‘å¯ä»¥åœ¨é»‘æ¿ä¸Šï¼Œç”¨ã€Œæ­£ã€å­—ç¬¦è™Ÿè¡¨é”ï¼Œä¸€å€‹äººé ­ä»£è¡¨ä¸€æ¯”ï¼Œæœ€å¾Œç´¯ç©èµ·ä¾†çœ‹æœ‰å¤šå°‘äººï¼›\nä½†å¦‚æœæ²’æœ‰é»‘æ¿ï¼Œæˆ‘å€‘å¯ä»¥ç”¨æ‰‹æŒ‡é ­ä¾†æ•¸ï¼Œæ‰‹æŒ‡å‡èµ·ä»£è¡¨åŠ ä¸€ï¼Œä½†æ˜¯ä¸€éš»æ‰‹æŒ‡æœ‰äº”æ ¹æ‰‹æŒ‡é ­ï¼Œé€™æ¨£æˆ‘å€‘çš„ä¸Šé™åªèƒ½æ•¸åˆ°äº”ï¼Œé€™æ¨£ä¼¼ä¹æœ‰é»å°‘Â ?!\nå›éé ­ä¾†æ€è€ƒï¼Œåœ¨äººé¡ä¸–ç•Œå¸¸ç”¨ 10 é€²ä½åˆ¶ï¼Œä¸€å€‹ä½æ•¸åªèƒ½è¡¨é” 0â€“9ï¼Œä½†å¦‚æœæˆ‘å€‘åŠ å…¥é€²ä½çš„æ¦‚å¿µï¼Œä¾‹å¦‚ 123ï¼Œé€™ä»£è¡¨çš„æ˜¯\n123 =\u0026gt; 100 * 1 + 10 * 2 + 3 * 1 = 123\nåŒæ¨£çš„å¦‚æœæ•¸æ‰‹æŒ‡ç”¨ä¸åŒçš„ æ¨¡å¼ è¡¨é”ï¼Œä¾‹å¦‚èªªæ‰‹æŒ‡èˆ‰èµ·ä»£è¡¨ 1ï¼Œæ‰‹æŒ‡æ”¶ä¸‹ä»£è¡¨ 0ï¼Œä¸¦åŠ å…¥äº†é€²ä½çš„æ¦‚å¿µï¼Œé€™æ¨£çš„è©±æ•¸æ‰‹æŒ‡å¯ä»¥è¡¨é”çš„æ•¸å­—ç¯„åœè®Šå¾—æ›´å¤§äº†ï¼Œä¾‹å¦‚æˆ‘æƒ³è¦æ¯” 9å¯ä»¥ç”¨\n01001 =\u0026gt; 0*16 + 1*8 + 0*4 + 0*2 + 1*1 = 9(åé€²ä½)\næ•¸æ‰‹æŒ‡çš„è¡¨é”ç¯„åœç¬é–“å¾ 0â€“5 è®Šæˆ 0â€“31ï¼Œé€™ä¹Ÿå°±æ˜¯äºŒé€²ä½çš„è¡¨ç¤ºæ³•ã€‚\né™¤äº†ç”¨æ‰‹æŒ‡è¡¨ç¤ºï¼Œæˆ‘ä¹Ÿå¯ä»¥ç”¨æ‰‹æ©Ÿçš„æ‰‹é›»ç­’é–‹å…‰ä»£è¡¨ 0 / 1ï¼Œçœ¾æ‰€çš†çŸ¥ç›®å‰å¤§å¤šæ•¸é›»è…¦åªèƒ½åˆ†è¾¨ 0 / 1ï¼Œä¹Ÿå°±æ˜¯é›»æºçš„é–‹èˆ‡é—œï¼Œæˆ–æ›´ç²¾æº–çš„èªªæ˜¯é›»æ™¶é«”ç‹€æ…‹çš„è¡¨ç¤ºï¼›\nè€Œä½†ä¸€ä¸€å€‹ä½æ•¸ 0/1 æˆ‘å€‘ç¨±ç‚º ä½å…ƒ(binary / bit) ï¼Œäº”æ ¹æ‰‹æŒ‡é ­ä»£è¡¨æˆ‘å€‘ç”¨ 5å€‹ bitsä¾†é‹ç®—ï¼Œè€Œ 8 bits æœƒç¨±ç‚º ä½å…ƒçµ„(byte)ã€‚\nä½†å°äººé¡ä¾†èªªï¼Œå…©è€…æ•¸å­—æƒ³è¡¨é”çš„æ¦‚å¿µæ˜¯ä¸€æ¨£çš„ï¼Œä½† (äºŒé€²ä½)01001 é‚„æ˜¯ä¸å¤ªç›´è§€ï¼Œæ­¤æ™‚æˆ‘å€‘å¯é€éè½‰æ›å…¬å¼è®Šæˆæˆ‘å€‘å¥½ç†è§£çš„è¡¨ç¤ºæ³• (åé€²ä½) 9ã€‚\næ•¸å­—å¦‚ä½•è¡¨é”æ–‡å­— äººé¡é™¤äº†æ•¸å­—å¤–ï¼Œæˆ‘å€‘é‚„æƒ³è¦å‚³éæ–‡å­—è¨Šæ¯ï¼Œä¾‹å¦‚èªª ABCDâ€¦.ï¼Œå–®ç´”ç”¨å¤šå€‹0,1è©²å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ\nå‰›å‰›æåˆ°ï¼Œæˆ‘å€‘å¯ä»¥å°‡ 01001 è½‰æ›æˆ 9ï¼Œé‚£åŒæ¨£çš„æˆ‘å€‘ä¿®æ”¹è½‰æ›å…¬å¼ï¼Œå°±å¯ä»¥è¼¸å‡ºä¸åŒçš„çµæœã€‚\nåœ¨é›»è…¦ä¸–ç•Œä¸­ï¼Œæœ€åŸºç¤çš„ç·¨ç¢¼æ–¹å¼æ˜¯ ACIIï¼Œé€é 8 bits ç‚ºä¸€çµ„è¡¨ç¤ºï¼Œç¸½å…± å°æ‡‰128å€‹å¸¸ç”¨çš„ç¾åœ‹è¼¸å…¥å­—ï¼Œä¾‹å¦‚èªª A æ˜¯ç”¨ 65 è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯ 0100 0001ï¼Œç•¶é›»è…¦æ”¶åˆ°å¾Œæœƒè‡ªå‹•ä»¥ 8å€‹bitç‚ºå–®ä½åˆ‡å‰²ï¼Œé€éä¸€å¼µè½‰æ›è¡¨ï¼Œå°‡äºŒé€²ä½è½‰æ›æˆæ–‡å­—ã€‚\n73 72 33 =\u0026gt; æ”¶åˆ°é€™ä¸‰å€‹å­—ç”¨ ascii è½‰æ›æœƒè®Šæˆä»€éº¼å‘¢ ? =\u0026gt; HI!\nä½†å¦‚æœæ˜¯ç¹é«”è¼¸å…¥ï¼Œä¸­æ–‡å­—é é è¶…é 128å€‹ï¼Œåˆæˆ–æ˜¯å…¶ä»–åœ‹å®¶ä¸åŒèªè¨€ï¼Œascii é¡¯ç„¶é é ä¸å¤ ç”¨ï¼Œå¾Œä¾†å‡ºç¾äº† unicode è¬åœ‹ç·¨ç¢¼ï¼Œç”¨æ›´å¤šçš„ bits è¡¨é”ä¸€å€‹å­—ï¼Œè§£æ±ºæ–‡å­—é¡¯ç¤ºçš„å•é¡Œã€‚\næ•¸å­—å¦‚ä½•è¡¨é”åœ–åƒ åŒæ¨£æ˜¯æ”¶åˆ°å¾ˆå¤šçš„ 0/1ï¼Œé€™æ™‚å€™æˆ‘å€‘éœ€è¦ä¸åŒçš„è½‰æ›æ–¹å¼ï¼Œå¸¸è¦‹çš„è‰²ç¢¼ç³»çµ±æ˜¯ RGBï¼Œç”¨ä¸‰å€‹æ•¸å­— è¡¨é”ç´…ã€ç¶ ã€è—çš„æ·±æ·ºç¨‹åº¦ï¼Œå¾0â€“255ï¼Œä¸‰è€…æ··åˆå°±è®Šæˆäº†è‰²å½©ï¼›\nç‚ºäº†è¡¨é” 0â€“255ï¼Œæˆ‘å€‘éœ€è¦ 8 bitsã€‚\næ‰€ä»¥å‰›æ‰çš„ (73, 72, 33) åœ¨ ascii ä¸­ä»£è¡¨ HI!ï¼Œä½†æ˜¯åœ¨ RGBä¸­ä»£è¡¨çš„æ˜¯æ·ºé»ƒè‰²ã€‚\nåœ¨è¢å¹•ä¸Šï¼Œä¸€å¼µåœ–ç‰‡å…¶å¯¦è¿‘çœ‹æ˜¯ç”±è¨±å¤šè¨±å¤šçš„åƒç´  pixelçµ„æˆï¼Œä¸€å€‹pixelé¡¯ç¤ºä¸€å€‹é¡è‰²ï¼Œä¹Ÿå°±æ˜¯3å€‹ä¸€çµ„çš„8bitsã€‚\nè€Œå½±ç‰‡ï¼Œå‰‡æ˜¯ç”±ä¸€å¼µå¼µåœ–ç‰‡é€£çºŒå¿«é€Ÿæ’­æ”¾æ‰€æ§‹æˆã€‚\næŠ½è±¡åŒ– å‰›æ‰æåˆ°äº†é›»è…¦ç”¨äºŒé€²ä½ï¼Œä½†ç‚ºäº†äººé¡çš„éœ€æ±‚ï¼Œæˆ‘å€‘åˆæŠŠ 0/1 è½‰æ›æˆä¸åŒçš„è¡¨ç¤ºæ³•ï¼Œä¾‹å¦‚èªªæœ‰ åé€²ä½è½‰æ›æˆæ˜“è®€çš„æ•¸å­—ã€asciiè½‰æ›æˆæ–‡å­—ã€RGBè½‰æ›æˆé¡è‰²ï¼Œé€™å€‹è½‰æ›çš„éç¨‹æˆ‘å€‘ç¨±ç‚ºã€ŒæŠ½è±¡åŒ–ã€\næŠ½è±¡åŒ–çš„æ¦‚å¿µåœ¨é›»è…¦ç§‘å­¸éå¸¸çš„åŸºæœ¬èˆ‡é‡è¦ï¼ŒæŠ½è±¡åŒ–æ˜¯æŒ‡\næˆ‘å€‘ä¸ç”¨ç®¡åº•å±¤çš„å¯¦ä½œæ–¹å¼ï¼Œæ³¨é‡æ–¼æ¦‚å¿µä¸Šçš„è¡¨é”\nä¾‹å¦‚èªª ä¸€å€‹åƒç´ æ˜¯ç”± 3 byte çµ„æˆ -\u0026gt; å¤šå€‹åƒç´ å¯ä»¥çµ„åˆæˆä¸€å¼µåœ– -\u0026gt; å¤šå¼µåœ–å¿«é€Ÿæ’­æ”¾å¯ä»¥çµ„æˆä¸€éƒ¨å‹•ç•«ï¼Œé€éä¸€å±¤ä¸€å±¤çš„æŠ½è±¡åŒ–ï¼Œå¯ä»¥åšåˆ°æ›´å¤šçš„äº‹æƒ…ã€‚\nåŒæ¨£çš„ï¼Œå¹³å¸¸æˆ‘å€‘åœ¨ä½¿ç”¨è¨ˆç®—æ©Ÿç®—æ•¸å­¸ã€ä¸Šç¶²å‚³è¨Šæ¯ã€çœ‹åœ–ç‰‡çœ‹å½±ç‰‡ï¼Œæˆ‘å€‘å®Œå…¨ä¸ç”¨å»ç®¡èƒŒå¾Œæ˜¯ç”¨å¤šå°‘å€‹ 0/1 å»è¡¨ç¤ºï¼Œåªè¦é›»è…¦å¯ä»¥è‡ªå‹•å¹«æˆ‘å°‡ binary è½‰æ›æˆæˆ‘éœ€è¦çš„é¡¯ç¤ºå°±å¥½äº†ã€‚\nç¸½çµä»¥ä¸Šï¼Œé›»è…¦æœ€çµ‚åªçœ‹å¾—æ‡‚ 0/1 ï¼Œè€Œå°æ–¼äººé¡æœ‰æ„ç¾©çš„æ˜¯ æ•¸å­—ã€æ–‡å­—ã€åƒç´ ç­‰ï¼Œå¯ä»¥é€éä¸åŒçš„è½‰æ›æ–¹å¼æ§‹æˆä¸åŒçš„è¡¨é” Expressionï¼Œä¹Ÿå°±æ˜¯ Input / Output çš„æ ¼å¼ã€‚\næ¼”ç®—æ³• å‰›æ‰æåˆ°ï¼Œé›»è…¦ä¸»è¦åŠŸèƒ½æ˜¯åœ¨æ–¼è§£æ±ºå•é¡Œ\ninput -\u0026gt; [ algorithm ] -\u0026gt; output\nä¸­é–“çš„é‹ç®—éç¨‹ç¨±ä¹‹ç‚º æ¼”ç®—æ³• algorithm\né›»è©±ç°¿æ‰¾äºº ä»Šå¤©æ¡Œä¸Šæœ‰ä¸€æœ¬é›»è©±ç°¿ï¼Œè£¡é¢æŒ‰ç…§è‹±æ–‡å­—æ¯é †åºæ’åˆ—ï¼Œå¸Œæœ›å¯ä»¥æ‰¾åˆ°ã€ŒMike Smithã€çš„é›»è©±è™Ÿç¢¼ï¼Œæ­¤æ™‚æˆ‘å€‘å¯ä»¥æ€éº¼åš?\nå¾ç¬¬ä¸€é ï¼Œä¸€å€‹ä¸€å€‹æŸ¥é–±ï¼Œä½†é€™æœƒéå¸¸èŠ±æ™‚é–“ï¼Œå°¤å…¶æ˜¯é›»è©±ç°¿å¦‚æ­¤å¤§ä¸€æœ¬ å…©é å…©é ç¿»ï¼Œå¦‚æœç¿»åˆ°éé ­å°±åœ¨å¾€å›ç¿»ä¸€é ï¼Œé€™å€‹åšæ³•æœƒæ¯”ç¬¬ä¸€å€‹çœä¸‹ä¸€åŠçš„æ™‚é–“ ç›´æ¥ç¿»åˆ°é›»è©±ç°¿çš„ä¸­é–“ï¼Œå¦‚æœç›®æ¨™çš„è‹±æ–‡å­—æ¯é †åºåœ¨å¾ŒåŠæ®µï¼Œæˆ‘åªè¦ç¿»å¾ŒåŠæ®µçš„é›»è©±ç°¿å°±å¥½ï¼Œå¦ä¸€åŠç›´æ¥ä¸Ÿæ‰ï¼Œåè¦†é€™å€‹éç¨‹ï¼Œå°±å¯ä»¥éå¸¸å¿«æ‰¾åˆ°ï¼›\né€™ä¹Ÿå°±æ˜¯ äºŒå…ƒæœå°‹æ³• Binary Search åœ¨é›»è…¦ç§‘å­¸ä¸­ï¼Œé€šå¸¸æˆ‘å€‘æœƒèªªç¬¬ä¸€ç¨®æ˜¯æš´åŠ›è§£ï¼Œå°±æ˜¯ç”¨æœ€ç›´è§€æœ€åŸå§‹çš„æ–¹å¼è§£æ±ºå•é¡Œï¼›\nä½†é€šå¸¸é€™æ¨£æš´åŠ›è§£æ•ˆç‡éƒ½ä¸é«˜ï¼Œæœƒé–‹å§‹é€æ­¥å„ªåŒ–ï¼Œå„ªåŒ–æœ‰å¾ˆå¤§çš„æ–¹å‘æ˜¯ æ‹†åˆ†æ“Šç ´ devide and conquerï¼Œå°‡å¤§å•é¡Œæ‹†è§£æˆå°å•é¡Œï¼Œä¸¦é€éæŒçºŒè§£æ±ºå°å•é¡Œå°±å¯ä»¥å¾—åˆ°æœ€å¾Œçš„ç­”æ¡ˆï¼›\nä¾‹å¦‚èª¬ç¿»é›»è©±ç°¿ï¼Œæˆ‘å…ˆå¾ä¸­é–“å°åˆ‡ï¼Œå•é¡Œé‡(éœ€è¦æŸ¥é–±çš„é›»è©±æ•¸)å°±å‰©ä¸€åŠäº†ï¼Œå†æŒçºŒå°åˆ‡ï¼Œå•é¡Œè¶Šä¾†è¶Šå°ï¼Œç›´åˆ°æ‰¾å‡ºç­”æ¡ˆã€‚\næˆ‘å€‘å¯ä»¥ç”¨æ•¸å­¸å‡½å¼åœ–å½¢è¡¨é”æ¼”ç®—æ³•çš„æ•ˆç‡ï¼Œx è»¸ä»£è¡¨å•é¡Œéœ€è¦èŠ±è²»çš„æ­¥é©Ÿï¼Œè€Œyè»¸ä»£è¡¨å•é¡Œçš„æ•¸é‡\nä»¥é›»è©±ç°¿æ‰¾äººç‚ºä¾‹ï¼Œyè»¸ä»£è¡¨çš„æ˜¯é›»è©±ç°¿çš„åšåº¦ï¼Œxè»¸çš„è©±èˆ‰ç¬¬ä¸€ç¨®æ¼”ç®—æ³•ä¾†èªªï¼Œä»£è¡¨èª¬é›»è©±ç°¿å¤šåšï¼Œæ¼”ç®—æ³•å°±éœ€è¦ç¿»é–±å¤šå°‘é æ‰èƒ½è§£æ±ºå•é¡Œã€‚\né€™é‚Šåƒ…ç°¡ç•¥å¸¶å‡º æ¼”ç®—æ³•è¤‡é›œåº¦çš„æ¦‚å¿µ\nPseudocode å‰›æ‰ä¸‰ç¨®æ¼”ç®—æ³•éƒ½æœ‰ä¸€å€‹è§£æ±ºå•é¡Œçš„æµç¨‹ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ å½ä»£ç¢¼ pseudocode ï¼Œç”¨ä¸€ç¨®é¡ä¼¼æ–¼è‰ç¨¿çš„æ¦‚å¿µï¼Œè¡¨é”æˆ‘å€‘å¯¦éš›è§£æ±ºå•é¡Œæ­¥é©Ÿã€‚\nåœ–ç‰‡å‡ºè‡ªæ–¼å½±ç‰‡å…§å®¹\né€™è£¡å¯ä»¥ç´°æ‹†æˆå››å€‹éƒ¨åˆ†\nFunctionï¼š ä»£è¡¨æŸç¨®å‹•ä½œ pick up / open / look / call / quit Condition åˆ¤æ–·æ©Ÿåˆ¶ if / else if Boolean Expression å¯¦éš›åˆ¤æ–·çš„æ¢ä»¶ if Smith is earlier in book Loop æŒçºŒçš„åšæŸä»¶äº‹ go back to step 2 Variable æš«å­˜çµæœçš„è®Šæ•¸ Thread (é€²éš) å¤šå·¥è™•ç† Events (é€²éš) äº‹ä»¶è§¸ç™¼ Letâ€™s Write SomeÂ Scratch! Scratch - Imagine, Program, Share\nScratch æ˜¯ MIT é–‹æºçš„ä¸€å¥—ç”¨åœ–å½¢ä»‹é¢ç¨‹å¼èªè¨€ç·¨è¼¯å™¨ï¼Œé€éæ‹–æ‹‰çš„æ–¹å¼ï¼Œç”¨æœ€ç°¡å–®çš„æ–¹å¼å°±å¯ä»¥å¯«ç¨‹å¼ï¼Œçœ‹åˆ°æŸäº›ç¯„ä¾‹ï¼Œè¦ºå¾—åŠŸèƒ½å¾ˆå®Œæ•´ï¼Œèƒ½å¤ ç™¼æ®çš„ç©ºé–“ååˆ†çš„å¤§ã€‚\nä»¥ä¸‹æŒ‘é¸å¹¾å€‹ç¯„ä¾‹åšèªªæ˜\nScratch è¨»å†Šå¾Œä¸»è¦æœ‰ä¸‰å€‹å€å¡Šï¼Œå³é‚Šçš„åŸ·è¡Œçµæœé ã€ä¸­é–“çš„ç¨‹å¼é‚è¼¯ã€å·¦é‚Šçš„ç¨‹å¼å…ƒä»¶ï¼Œè¨­è¨ˆçš„éƒ½ç›¸ç•¶ç›´è¦ºã€‚\nåœ¨é–‹å§‹ Scratch æ™‚ï¼Œéƒ½æœƒé€éç¶ è‰²çš„æ——å¹Ÿç¬¦è™Ÿé–‹å§‹ï¼Œæ‰€ä»¥ç¨‹å¼ç¢¼æœƒå…ˆæ”¾ä¸Šåœ–æ©˜è‰²å€å¡Šé–‹å§‹åŸ·è¡Œï¼Œå¾ŒçºŒä¾ç…§ç©æœ¨çš„é †åºï¼ŒåŸ·è¡Œä½ è¨­è¨ˆçš„æ¼”ç®—æ³•ï¼Œä¾‹å¦‚æœ€åŸºæœ¬çš„ã€ŒHello, World!ã€\nHello, World! æ˜¯ç¨‹å¼ç•Œåœ¨å˜—è©¦æ–°äº‹ç‰©çš„ç¬¬ä¸€å€‹æ…£ä¾‹æ¸¬è©¦ï¼Œä¸»è¦æ˜¯å› ç‚ºæŸä½å¤§ç¥å¯«äº†ä¸€æœ¬éå¸¸çŸ¥åçš„æ›¸ï¼Œè£¡é ­çš„ç¬¬ä¸€å€‹ç¯„ä¾‹å°±æ˜¯ Hello, World! ï¼Œå¾ŒçºŒå°±æ¼”è®Šæˆä¸€ç¨®æ–‡åŒ–ã€‚\nLoop æˆ‘å¸Œæœ›ç™¼å‡ºå–µè²4æ¬¡ï¼Œä¸­é–“ç›¸éš”ä¸€ç§’é˜ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹æœ‰å…©ç¨®å¯«æ³•\nå·¦é‚Šæ˜¯å¾ˆç›´è¦ºçš„å¯«æ³•ï¼Œæˆ‘è¦ Meow å››æ¬¡æˆ‘å°±è¤‡è£½è²¼ä¸Šå››æ¬¡ï¼Œä½†é€™æ¨£æœ€å¤§çš„ç¼ºé»æ˜¯å¦‚æœè¦åæ¬¡åŒæ¨£çš„äº‹æƒ…å°±è¦åšåæ¬¡â€¦. ï¼Œåˆæˆ–æ˜¯æˆ‘æƒ³è¦è®Šæˆ Woofï¼Œå°±éœ€è¦æ”¹åæ¬¡ï¼›\né‡åˆ°é‡è¤‡åšæŸä»¶äº‹æ•¸æ¬¡ï¼Œå¯ä»¥æ”¹ç”¨ Loop çš„æ¦‚å¿µï¼Œè®“ç¨‹å¼è‡ªå‹•é‡è¤‡è€Œä¸ç”¨ä¸€å€‹ä¸€å€‹çš„è‡ªå·±æ‰‹å‹•ä½œã€‚\nDonâ€™t Repeat Yourself (DIY)\næ˜¯å¯«ç¨‹å¼ä¸€å€‹å¾ˆé‡è¦çš„åŸå‰‡ã€‚\nCondition é€™è£¡æˆ‘å¯«çš„é‚è¼¯æ˜¯\nå®šç¾©ä¸€å€‹è®Šæ•¸ counterï¼Œåœ¨é–‹å§‹åŸ·è¡Œå¾Œå°‡ counter è¨­ç‚º 0ï¼Œæ¥è‘—ç•¶æ¯æ¬¡æŒ‰ä¸‹ Space å¾Œï¼Œé¡¯ç¤º counter æ•¸å€¼ï¼Œæ¥è‘—å°‡ counter æ¯æ¬¡éƒ½åŠ  1ï¼›\nå¦‚æœç›®å‰ counter \u0026gt; 10ï¼Œå°±ä¸è¦ç™¼å‡ºè²éŸ³ï¼Œåä¹‹ Meow ä¸€è²ã€‚\nFunction é¡ä¼¼æ–¼ä¸Šé¢çš„äº‹æƒ…ï¼Œä½†æˆ‘é€™æ™‚å€™å¸Œæœ›å¯ä»¥ç›®å‰ counter å¤šå°‘å°± meow å¹¾æ¬¡ï¼Œæ­¤æ™‚æˆ‘å€‘éœ€è¦ Function çš„å¹«å¿™ï¼›\nå…ˆå®šç¾©ä¸€å€‹è‡ªå·±å®¢è£½çš„ Blockï¼Œé€™å€‹ Function çš„å…§å®¹å°±æ˜¯ Repeat Meow æ•¸æ¬¡ï¼Œæ¬¡æ•¸ç”±åƒæ•¸ n æ±ºå®šã€‚\nç•¶ç„¶ä¹Ÿå¯ä»¥ç›´æ¥æŠŠ repeat é‚£ä¸€æ•´æ®µç›´æ¥å¡åˆ° else ç•¶ä¸­ï¼Œä½†æ˜¯Function çš„å¥½è™•æ˜¯å¯ä»¥å°‡æŸäº›è¡Œç‚ºå¾ç¨‹å¼ç¢¼ä¸­æŠ½å–å‡ºä¾†ï¼Œé€™æ¨£å¯ä»¥è®“ç¨‹å¼ç¢¼æ›´å¥½ç†è§£ï¼Œé–±è®€åˆ° MeowManyTimes å¯ä»¥å¾å­—é¢ä¸Šçš„æ„æ€å¾ˆç›´è¦ºæƒ³åˆ°é€™æ˜¯è·Ÿç™¼å‡º Meow æœ‰é—œã€‚\n","date":"2019-02-19T00:00:17.464Z","permalink":"https://yuanchieh.page/posts/2019/2019-02-19-cs50-lecture-0/","title":"CS50â€Šâ€”â€Šlecture 0"},{"content":"æœ€è¿‘é™¸é™¸çºŒçºŒåœ¨çœ‹ AWS re:invent 2018 çš„å½±ç‰‡ï¼Œä¸»è¦å°ˆæ³¨æ–¼ CI/CDéƒ¨åˆ†ï¼Œä¸å¾—ä¸èªªçœ‹å®ŒçœŸçš„æ˜¯éå¸¸æŒ¯å¥®äººå¿ƒå•Šï¼\nä»¥å¾€åœ¨åšæ¶æ§‹è¨­è¨ˆï¼Œå¯èƒ½æ˜¯å…ˆç•«å€‹æ¶æ§‹åœ–ï¼Œæ¥è‘—æ‰“é–‹ç¶²é ç™»å…¥ AWS Consoleï¼Œçœ‹è¦é–‹å¹¾å° EC2 ã€VPC æ¶æ§‹ã€ ALB è¨­å®šã€CDN è¨­å®šã€é–‹ S3 Bucket ç­‰ç­‰ï¼ŒåŸºæœ¬ä¸Šå¤§å¤šçš„äº‹æƒ…éƒ½æ˜¯é€éç¶²é å®Œæˆï¼Œæˆ–æ˜¯ä½¿ç”¨ Command Line Tool å®Œæˆï¼›\nä½†é€™æ¨£çš„ç¼ºé»æ˜¯å¦‚æœå…¬å¸çªç„¶æƒ³è¦é‡å»ºä¸€ä»½åŒæ¨£çš„æ¶æ§‹ç•¶ä½œ staging ç’°å¢ƒï¼Œåˆæˆ–æ˜¯å¾€å¾Œéœ€è¦æ”¹å‹•æ¶æ§‹ï¼Œæ­¤æ™‚å¿…é ˆè‡ªå·±åŒæ­¥æ–‡ä»¶ã€ä¿®æ”¹æ¶æ§‹åœ–ç­‰ç­‰ï¼Œåœ¨ç®¡ç†ä¸Šæœ‰ç›¸ç•¶å¤šä¸æ–¹ä¾¿çš„åœ°æ–¹ã€‚\nç‚ºä»€éº¼ä¸ç”¨ç¨‹å¼ç¢¼ä¾†ç®¡ç† é€™ä¹Ÿå°±æ˜¯é€™ç¯‡è¦åˆ†äº«çš„æ–¹æ³•ï¼Œä½¿ç”¨ AWS-CDKï¼ŒAWS-CDK æ˜¯ä¸€å€‹ nodejs çš„ packageï¼Œå®‰è£å¾Œç•¶ä½œ cli tool ä½¿ç”¨ï¼›\nåœ¨ AWS-CDK ä¸‹æä¾›å„å€‹ AWS æ—¢æœ‰æœå‹™çš„å¥—ä»¶(å¦‚ lambda ã€ S3 ç­‰)ï¼Œç›®å‰æä¾› C#ã€Javascriptã€Typescriptã€Javaï¼Œé–‹ç™¼æ™‚å¼•å…¥é€™äº›å¥—ä»¶å°±å¯ä»¥ä½¿ç”¨äº†ã€‚\né€éç¨‹å¼ç¢¼ç®¡ç†ï¼Œæˆ‘è¦ºå¾—æœ‰å¹¾å€‹å¥½è™•\næ›´å¥½çš„å°è£èˆ‡çµæ§‹\nå¦‚æœæ˜¯ç”¨ç¶²é åšè¨­å®šï¼ŒåŸºæœ¬ä¸Šè¡Œç‚ºåªèƒ½é€éæ–‡ä»¶ä¾†æºé€šï¼Œå¦‚æœæ˜¯ç”¨ shell script æˆ–è¨±ä¹Ÿå¯ä»¥åšåˆ°ä¸€éƒ¨åˆ†çš„è‡ªå‹•åŒ–ï¼Œä½†æ•´é«”ç†è§£ä¸Šé‚„æœ‰è »å¤šä¸æ–¹ä¾¿ä¹‹è™•ï¼Œæ›´åˆ¥èªªç¶­è­·çš„äººå¯«æ³•å¯èƒ½ä¸åŒï¼Œé€ æˆç¶­è­·çš„å›°é›£ï¼›\nä½¿ç”¨ AWS-CDKï¼Œä»–æœ¬èº«æ˜¯ç”¨ OO çš„æ¦‚å¿µå°è£æ—¢æœ‰çš„ AWS æœå‹™ï¼Œå®˜æ–¹ä¹Ÿæœ‰æä¾›å·¥å…·å¹«åŠ©åˆå§‹å°ˆæ¡ˆï¼Œä¹Ÿçµ¦äºˆä¸€å®šçš„ç¨‹å¼ç¢¼æ¶æ§‹å»ºè­°ï¼Œå¾Œäººæ¥æ‰‹ä¸€å®šæœƒå¥½ç†è§£éå¸¸å¤š ç‰ˆæœ¬æ§åˆ¶\néš¨è‘—å…¬å¸ç™¼å±•ï¼Œå¯èƒ½æœƒæ›´å‹•æ¶æ§‹ï¼Œé€éä»£ç¢¼ç®¡ç†å·¥å…·å¯ä»¥å”åŠ©è‰¯å¥½ç®¡ç†æ¶æ§‹çš„æ¼”é€²ï¼ŒRollback ä¹Ÿå¯ä»¥æœ‰ä¾æ“š (ä¾‹å¦‚è²»ç”¨çˆ†æ‰çš„æ™‚å€™â€¦) è·¨å€åŸŸéƒ¨ç½²\nå¦‚æœä½ æƒ³è¦è·¨å€åŸŸéƒ¨ç½²åŒæ¨£çš„æ¶æ§‹ï¼Œç”¨ç¶²é æ“ä½œæ‡‰è©²æœƒéå¸¸é ­ç—›ï¼Œè€Œä¸”å®¹æ˜“å‡ºç¾äººå·¥éŒ¯èª¤ï¼›\nç”¨ç¨‹å¼ç¢¼å°±æ˜¯å¤šä¸€è¡ŒæŒ‡å®šå€åŸŸï¼Œ DONE! AWS-CDK åº•å±¤å…¶å¯¦æ˜¯å°‡ç¨‹å¼ç¢¼è½‰æˆ Cloud Formationï¼ŒAWS è‡ªå®šç¾©çš„æœå‹™å®šç¾©èªæ³•ï¼Œå¯ä»¥ç†è§£æˆ AWSæœå‹™çš„ Assembly Codeã€‚\nï¼ŠWARNINGï¼šç›®å‰ç™¼æ–‡æ™‚é–“ 2019/01/27 é‚„ä¸å»ºè­°ä½¿ç”¨æ–¼æ­£å¼ç’°å¢ƒï¼Œä½†å› ç‚ºä»–åº•å±¤æ˜¯è½‰æˆ Cloud Formationï¼Œç†è«–ä¸Šè½‰æ›ä¸å‡ºéŒ¯æ‡‰è©²å°±è »ç©©çš„ï¼Œç›®å‰æ¸¬è©¦å°šæœªé‡åˆ° Bug\nåœ¨é–‹å§‹ Codingä¹‹å‰ï¼Œå»ºè­°ä½¿ç”¨ AWS-CDK ä¹‹å‰è¦å…ˆç†Ÿæ‚‰ AWS æœå‹™ï¼Œä¾‹å¦‚ä½ æƒ³ä¸² Lambda å»ºè­°å…ˆè‡³å°‘çœ‹éæ–‡ä»¶ã€ç”¨ç¶²é ç‰ˆå®Œæ•´æ“ä½œéä¸€æ¬¡ï¼Œå› ç‚ºæœ‰å¾ˆå¤šåƒæ•¸å¯¦éš›ç”¨éæ‰çŸ¥é“æ€éº¼å¡«å¯«ï¼Œç›®å‰å®˜æ–¹ç¶²ç«™æœ‰è‰¯å¥½çš„æ–‡ä»¶ï¼Œä½†é€™äº›æ–‡ä»¶åƒ…é™æ–¼åƒæ•¸èªªæ˜ï¼Œå¦‚æœæ²’å¯¦éš›ç”¨éä¸æœƒçŸ¥é“åƒæ•¸è¨­å®šå¾Œçš„å¯¦è³ªæ„ç¾©èˆ‡ç”¨é€”ï¼›\nå¦å¤–ç›®å‰æˆ‘æŸ¥äº†ä¸€ä¸‹æ²’æœ‰å¤ªå¤šå¯¦æˆ°åˆ†äº«ï¼Œåªæœ‰ä¸€äº›åŸºæœ¬çš„ä¸²æ¥èˆ‡æ“ä½œï¼Œæ‰€ä»¥åœ¨æœå‹™é–“çš„ä¸²æ¥è »å¤šæ˜¯ Try-And-Error ç©å‡ºä¾†çš„ï¼Œä¹Ÿæ˜¯æˆ‘æƒ³å¯«é€™ç¯‡æ–‡ç« çš„ç›®çš„ï¼Œå¹«åŠ©å¤§å®¶ä¸Šæ‰‹ã€‚\næœ¬ç¯‡æ¯”è¼ƒé©åˆå·²ç¶“åœ¨ä½¿ç”¨ AWS æœå‹™ä¸€æ®µæ™‚é–“ï¼Œå¸Œæœ›å¯ä»¥ç”¨æ›´å¥½æ–¹å¼ç®¡ç†æ¶æ§‹çš„å·¥ç¨‹å¸«ï¼›\nå¾ŒçºŒæœƒä½¿ç”¨ Typescript ç•¶ä½œç¯„ä¾‹ï¼Œä¸éæ¦‚å¿µéƒ½æ˜¯ä¸€æ¨£çš„ã€‚\næœ€å¾Œå†æ¬¡æé†’ï¼Œå› ç‚ºé‚„åœ¨ pre-release éšæ®µï¼Œå¦‚æœä½ ç™¼ç¾ä»¥ä¸‹ç¨‹å¼ç¢¼æœ‰èª¤æˆ–ç„¡æ³•åŸ·è¡Œï¼Œç…©è«‹ç•™è¨€ã€‚\nå®‰è£ AWS-CDKÂ èˆ‡å°ˆæ¡ˆåˆå§‹åŒ– cdkworkshop.com\nåœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹ç¢ºä¿å®Œæˆå®˜ç¶²çš„ prerequest æ­¥é©Ÿ\nå®‰è£äº† aws-cli å®Œæˆ iam role è¨­å®šï¼Œå¯¦é©—æ€§è³ªå…ˆé–‹ admin æ¬Šé™æ¯”è¼ƒæ–¹ä¾¿ å®Œæˆ aws configure å®‰è£ Nodejs v8.12 ä»¥ä¸Š å®‰è£ aws-cdkï¼Œ npm install -g aws-cdk@0.22.0 aws-cdk ä¸»è¦æä¾›å¹¾å€‹æŒ‡ä»¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // ç”¨æ–¼åˆå§‹åŒ–å°ˆæ¡ˆï¼Œå¯ä»¥æŒ‡å®šèªè¨€ $ cdk init // æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„ stack (å¾ŒçºŒä»‹ç´¹ä»€éº¼æ˜¯ stack) $ cdk ls // æŸ¥çœ‹ç›®å‰ç¨‹å¼ç¢¼è½‰æ›çš„ cloud formation $ cdk synth // æŸ¥çœ‹ç›®å‰æ¶æ§‹çš„è®Šå‹• $ cdk diff // éƒ¨ç½² $ cdk deploy // åˆå§‹åŒ–ç’°å¢ƒ $ cdk bootstrap ç›®å‰æˆ‘ç¿’æ…£ä½¿ç”¨ Typescript é–‹ç™¼ï¼Œæ­é… VSCode æœ‰é€£å¥½çš„è‡ªå‹•æç¤ºéå¸¸æ–¹ä¾¿ã€‚\nå¯¦æˆ°ï¼šéƒ¨ç½² Scheduled Event è§¸ç™¼Â Lambda Letâ€™s write some code~Â é€™æ¬¡åšä¸€å€‹éƒ¨ç½²åˆ°å¤šå€‹å€åŸŸï¼Œå®šæœŸ 2 åˆ†é˜å»æ‰“ https://www.president.gov.tw/ çœ‹å°ç£ç¸½çµ±åºœé é¢åœ¨å…¨çƒçš„ç¶²é å›æ‡‰é€Ÿåº¦ï¼Œæ¥è‘—ç™¼è¨Šæ¯åˆ° slack é »é“ã€‚\nåˆ°å°ˆæ¡ˆç›®éŒ„ä¸‹ï¼ŒåŸ·è¡Œ \u0026gt; cdk init appâ€Šâ€”â€Šlanguage=typescript\næ¥è‘—åŒå€‹ç›®éŒ„ä¸‹ï¼Œæˆ‘å€‘éœ€è¦é–‹å…©å€‹ shellï¼Œä¸€å€‹ shell åŸ·è¡Œ \u0026gt; npm run watch ï¼Œä¸»è¦æ˜¯ç‚ºäº†è‡ªå‹•è½‰è­¯ typescript æˆ javascript æ‰å¯ä»¥è®“ nodejs åŸ·è¡Œï¼›\nå¦ä¸€å€‹ shell ç”¨ä¾†åŸ·è¡Œå¾ŒçºŒçš„ cmdã€‚\nåœ¨ç›®éŒ„ä¸‹æœƒæœ‰å¸¸è¦‹çš„ nodejs å°ˆæ¡ˆæª”æ¡ˆï¼Œæœ‰å…©å€‹è³‡æ–™å¤¾æ¯”è¼ƒé‡è¦ /bin ã€ /libï¼›\n/lib ä¸»è¦æ˜¯æ”¾æ¶æ§‹å®šç¾©ï¼Œåˆå§‹åŒ–ä¹‹å¾Œæœƒæœ‰ä¸€å€‹ aws-cdk-stack.tsï¼Œåœ¨ AWS-CDKä¸­ï¼Œ stack ä»£è¡¨çš„å°±æ˜¯ä¸€å€‹æ¶æ§‹çš„ classï¼Œä¾‹å¦‚èªªç›®å‰è¦è¨­è¨ˆçš„æ¶æ§‹å°±æ˜¯ (scheduled event + lambda)ï¼Œé€™å°±æ˜¯ä¸€å€‹å°å‹çš„æ¶æ§‹ï¼›\nå¾ŒçºŒå¯ä»¥è®“å°æ¶æ§‹çµ„åˆæˆå¤§æ¶æ§‹ï¼Œå°±çœ‹éœ€æ±‚æ±ºå®šå¦‚ä½•å°è£ã€‚\n/bin ä¸»è¦æ˜¯æ”¾ appï¼Œä¹Ÿå°±æ˜¯æœ€çµ‚æ¶æ§‹çš„æª”æ¡ˆï¼Œä¸»è¦æ˜¯æ•´åˆStack åˆå§‹åŒ–èˆ‡éƒ¨å±¬çš„æ–¹å¼ï¼Œå®šç¾©åœ¨ aws-cdk.ts ä¹‹ä¸­ã€‚\naws-cdk-stack.ts æ˜¯ä¸æ˜¯æ¯”æƒ³åƒä¸­çš„æ¸…æ™°ç°¡å–®å•Šï¼Œè¼‰å…¥å°æ‡‰æ¨¡çµ„å®£å‘Šå³å¯ï¼Œè€Œä¸” lambda å¯ä»¥åƒç…§æœ¬åœ°ç«¯çš„è³‡æ–™å¤¾ï¼Œè‡ªå‹•å¹«å¿™æ‰“åŒ…èˆ‡éƒ¨ç½²è¶…æ–¹ä¾¿çš„ï¼›\nå¦å¤– aws-cdk æ–‡ä»¶ä¸€å€‹å¥½è™•æ˜¯éƒ½æœ‰æŠŠå°æ‡‰çš„åƒæ•¸æ–‡ä»¶å°ç…§å¥½ï¼Œæ‰€ä»¥æŸ¥èµ·ä¾†è »å¿«çš„ï¼Œä½†æ˜¯åƒæ•¸é‡éå¸¸å¤§Â â€¦..\nStack åœ¨åˆå§‹åŒ–éœ€è¦ç¶å®šæ˜¯åœ¨å“ªå€‹ appä¸‹ï¼Œä»¥åŠç¨ç«‹çš„ IDï¼Œé€™å¾ŒçºŒæœƒå†ç¶²é ä¸­çœ‹åˆ°ã€‚\naws-cdk.ts åŸºæœ¬ä¸Šå°±æ˜¯åˆå§‹åŒ– Stack ä¸¦å®šç¾©éƒ¨ç½²çš„å€åŸŸï¼Œå¦å¤–çš„ lambda èˆ‡ slack å°±çœ‹ git repo åƒè€ƒï¼Œä¸å†è´…è¿°ã€‚\nç¨‹å¼ç¢¼å®Œæˆå¾Œï¼ŒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ\næª¢æŸ¥\n\u0026gt; cdk list æŸ¥çœ‹Appä¸‹çš„æ‰€æœ‰ Stackï¼Œæ¥è‘—é‡å°å„å€‹ stack ä¸‹ \u0026gt; cdk synth AwsCdkStack2 ï¼Œå¤§æ¦‚æª¢æŸ¥æœ‰æ²’æœ‰ error èˆ‡ cloud formation å®šç¾©ã€‚ éƒ¨ç½²\n\u0026gt; cdk deployÂ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œä»–å¯èƒ½æœƒè·³å‡ºéœ€è¦åŸ·è¡Œ \u0026gt;cdk bootstrap {å°ˆæ¡ˆid/region} çš„éŒ¯èª¤ï¼Œå…¶ä»–çš„è©±å°±ç­‰ä»–æ…¢æ…¢éƒ¨ç½²ï¼› cdk éƒ¨ç½²æ™‚æœ‰è‰¯å¥½çš„æ‰“å°è¨Šæ¯ï¼Œæœ€æ£’çš„æ˜¯ cdk æœƒè‡ªå‹•è™•ç† aws æœå‹™ iam role çš„æ¬Šé™ï¼Œå¦‚æœæœ‰è™•ç†éæ¬Šé™è¨­å®šå°±çŸ¥é“é€™éå¸¸çš„é ­ç—› XDÂ å› ç‚º AWS æœå‹™åˆ‡å¤ªç´°äº†ï¼Œå¥½è™•æ˜¯å¯è¨­å®šçš„éå¸¸ç²¾æº–ï¼Œä½†ç¼ºé»å°±æ˜¯æŸ¥æ‰¾èµ·ä¾†å¾ˆé ­ç—›ï¼Œé€šå¸¸éƒ½è¦è·‘å€‹å¹¾æ¬¡çœ‹éŒ¯èª¤log è£œæ¬Šé™ã€‚\nä»¥ä¸‹æ˜¯ç¶²é èˆ‡ Slack å›æ‡‰çš„æˆªåœ–\nlambda\nSlack è¨Šæ¯ï¼Œçœ‹ä¾†æ­æ´²å›æ‡‰æ™‚é–“æœ€é•·ï¼Œæ±åŒ—äºæœ€å¿«ï¼Œçµæœæ˜¯ä¹Ÿä¸å¤ªæ„å¤– XD\næœ€å¾Œé™„ä¸Šå®Œæ•´å°ˆæ¡ˆçš„ github\nsj82516/aws-cdk-demo\nåˆªé™¤ Stack å‡è¨­æˆ‘æƒ³è¦ç§»é™¤ç¾è¥¿çš„éƒ¨ç½²ï¼Œä¸è¦ç›´æ¥å¾ç¨‹å¼ç¢¼åˆªé™¤Stack é‡æ–° deploy ï¼Œæˆ‘å¯¦æ¸¬çš„çµæœé€™æ¨£æ˜¯ä¸æœƒå¹«ä½ æŠŠæ±è¥¿åˆªæ‰çš„ï¼Œè¦æ”¹ç”¨ä»¥ä¸‹æ­¥é©Ÿ\n\u0026gt; cdk destroy AwsCdkStack æ¥è‘—æ‰å¾ç¨‹å¼ç¢¼åˆªé™¤ çµèª åœ¨é›²ç«¯æœå‹™ä¸­ï¼ŒAWS ä¸å¾—ä¸èªªæ˜¯é€™å€‹è¡Œæ¥­çš„é ˜é ­ç¾Šï¼Œè€Œä¸”å°±æŠ€è¡“ä¸Šå€‹äººè¦ºå¾—é ˜å…ˆ GCP ä¸å°‘ï¼ŒåŸºç¤æœå‹™ä¸å¥½èªªï¼Œä½†æ˜¯åœ¨è·¨æœå‹™çš„æ•´åˆä¸Šï¼ŒAWS åšå¾—éå¸¸è‰¯å¥½ï¼Œé€™æˆ–è¨±æ‰æ˜¯ä¼æ¥­ç”¨ä¹æ‰€åœ¨ä¹çš„æœªä¾†ï¼Œæ•´å¥— solution è€Œä¸æ˜¯å–®å€‹å–®å€‹æœå‹™é‚„è¦è‡ªå·±æ…¢æ…¢æ•´ã€‚\næœ‰äº† AWS-CDK è¦åˆ†äº«ã€é‡ç”¨æ¶æ§‹å°±æ¥µåº¦æ–¹ä¾¿ï¼Œä¹‹å¾Œå†ä¾†åšä¸€ç³»åˆ—åŸºæ–¼ AWS-CDK çš„ AWS æ¶æ§‹ç ”ç©¶èˆ‡åˆ†äº«ã€‚\n","date":"2019-01-27T03:29:50.283Z","permalink":"https://yuanchieh.page/posts/2019/2019-01-27-aws-cdk%E6%95%99%E5%AD%B8-infrastructore-as-code-%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E7%AE%A1%E7%90%86%E6%9E%B6%E6%A7%8B/","title":"AWS-CDKæ•™å­¸â€Šâ€”â€ŠInfrastructore As Code ç”¨ç¨‹å¼ç¢¼ç®¡ç†æ¶æ§‹"},{"content":"Forcing a device to disconnect from WiFi using a deauthentication attack\nå…§å®¹åƒè€ƒ @Brandon Skerritt çš„å‰µä½œï¼Œä»¥ä¸‹åƒ…ç‚ºå€‹äººè½‰è­¯æˆä¸­æ–‡ï¼ŒåŸ·è¡Œå¹³å°å¾ä½œè€…çš„ Kali Linux æ”¹ç‚º Macï¼Œç´€éŒ„ä¸€äº›åŸ·è¡Œçš„ç´°ç¯€ã€‚\nç·£ç”± https://www.itcodemonkey.com/article/4742.html\nç•¶ Suppliant(çµ‚ç«¯è£ç½®) å¸Œæœ›èˆ‡ AP å»ºç«‹ Wifi é€£ç·šæ™‚ï¼Œéœ€è¦ç¶“éå››æ¬¡ Handshakeï¼Œè€Œåœ¨ç¬¬ä¸‰æ¬¡äº¤æ¡æ™‚ Suppliant æœƒè¼¸å…¥ Wifiå¯†ç¢¼ï¼Œé€™å€‹ Wifi å¯†ç¢¼æœƒç¶“éåŠ å¯†ï¼Œå¦‚æœå¯†ç¢¼æ­£ç¢ºå‰‡æˆåŠŸå»ºç«‹é€£ç·šï¼Œåä¹‹å‰‡æ–·é–‹é€£ç·šã€‚\nè€Œ deauthentication attack åˆ©ç”¨é€™æ¨£çš„äº¤æ¡ç‰¹æ€§ï¼Œåœ¨ç¬¬ä¸‰æ­¥å‡è£æ˜¯ AP å›è¦†çµ¦ Supplianté©—è­‰éŒ¯èª¤ï¼Œå› æ­¤å¼·è¿«è£ç½®æ–·é–‹ Wifi é€£ç·šï¼Œé€™ä¸¦ä¸æ˜¯é€éä»€éº¼æ¼æ´æ”»æ“Šï¼Œè€Œæ˜¯ Wifi å‚³è¼¸å”å®šåŸæœ‰çš„æ©Ÿåˆ¶ã€‚\né€™æ¨£çš„æ©Ÿåˆ¶ä½¿å¾— Wifi éå¸¸çš„ä¸å®‰å…¨ï¼Œdeauthentication attack å¯ä»¥ä¸­æ–·ä»»æ„è£ç½®çš„ Wifié€£ç·šï¼Œé€™å¾€å¾€åªæ˜¯æ”»æ“Šçš„ç¬¬ä¸€æ­¥ï¼›\nä¸€èˆ¬è£ç½® Wifi æ–·ç·šå¾Œï¼Œæœƒç”¨åŒæ¨£çš„å¯†ç¢¼å†æ¬¡å˜—è©¦èˆ‡ APå»ºç«‹é€£ç·šï¼Œè€Œæ­¤æ™‚ Wifi ç„¡ç·šé€šè¨Šçš„æ©Ÿåˆ¶ï¼Œæœƒä½¿å¾—ç›¸é„°çš„ç”¨æˆ¶ä¹Ÿå¯ä»¥å·è½åˆ°é€™äº›å°åŒ…ï¼Œé€²è€Œæ‹†è§£å°åŒ…ï¼Œå¾ä¸­æš´åŠ›ç ´è§£ AP çš„å¯†ç¢¼ï¼›\nåˆæœƒæ˜¯é‚ªæƒ¡çš„ç”¨æˆ¶å½é€ ä¸€å€‹å‡çš„ APï¼Œå…¶ä»–äººä¸æ˜æ‰€ä»¥å°±å‚»å‚»çš„é€£ç·šï¼Œé€éç°¡å–®çš„é‡£é­šï¼Œå°±å¯ä»¥å®Œæˆ Middle man attackã€‚\nçœ‹ä¼¼é‚ªæƒ¡çš„å·¥å…·ï¼Œä½†ä¸è¦ç”¨åœ¨ç ´å£ä¹Ÿèƒ½ç”¨åœ¨è‡ªä¿ä¸Šï¼Œåœ¨ 2015 å¹´çˆ†å‡ºå¤šèµ· Airbnb é€é Wifi Cam å·çªºä½æˆ¶ï¼Œä½œè€…å¯«äº†ä¸€å€‹ script å¯ä»¥è‡ªå‹•æ–·é–‹æ‰€æœ‰çš„ Wifi Cam\nDetect and disconnect WiFi cameras in that AirBnB you\u0026rsquo;re staying in\nåŒä½œè€…é‚„å¯«äº†å¯ä»¥è‡ªå‹•æ–·é–‹ Google Glass çš„ Script\nFind a Google Glass and kick it from the network\n*è­¦å‘Š é€™é …æœ‰åŠ›çš„å·¥å…·å¯ä»¥ç”¨ä¾†ä¿è­·å€‹äººéš±ç§ï¼Œä½†ä½œè€…ä¸é¼“å‹µç”¨æ–¼éæ³•æˆ–æ˜¯æƒ¡æ„çš„æ”»æ“Š!\nDeauthentication Attack é¦–å…ˆè¦ç¢ºèªå…©ä»¶äº‹\næº–å‚™è¦æ–·é–‹çš„è£ç½® è©²è£ç½®é€£çµçš„ Router åŸæœ¬æ˜¯å¸Œæœ›æ‰¾åˆ°å°æ‡‰çš„ Cmd Tool åœ¨ Mac å¹³å°ä¸Šï¼Œä½†å¾Œä¾†åƒè€ƒæ­¤æ–‡ç« \nWPA wifi cracking on a MacBook Pro with deauth\nå¯ä»¥ç›´æ¥ç”¨ JamWifi GUI Toolï¼Œæ‰“é–‹å¾Œé–‹å§‹ Scanï¼ŒScan å¾Œå¯ä»¥æ‰¾åˆ° AP ä¸¦é€é MAC Address æŒ‡å®šè£ç½®æ–·ç·šï¼Œæˆ‘åœ¨å®¶è£¡å˜—è©¦éæ˜¯å¯è¡Œçš„ã€‚\nåœ¨åŒç¯‡æ–‡ç« ä¸­æœ‰æåˆ°å¾ŒçºŒç ´è§£ Wifi å¯†ç¢¼çš„æ–¹å¼ï¼Œé€é deauthentication attack æ–·é–‹è£ç½®ï¼Œæ¥è‘—é–‹ tcpdump ç›£è½æ‰€æœ‰çš„å°åŒ…ï¼›\næ¥è‘—ç”¨ cap2hccapxå°‡ tcpdump çš„è³‡æ–™è½‰æ›æ ¼å¼ï¼›\næœ€å¾Œç”¨ hashcat é¡ä¼¼æš´åŠ›ç ´è§£çš„æ–¹å¼ï¼Œå˜—è©¦é‚„åŸè¢« hashed éçš„å¯†ç¢¼ï¼Œé€™è£¡ä»–çš„æ¼”ç®—æ³•å¯ä»¥è¼¸å…¥ wordlistï¼Œç¶²è·¯ä¸Šæœ‰äººæä¾›å¸¸è¦‹çš„ wifi å¯†ç¢¼ï¼Œé›–ç„¶èªª wifi å¯†ç¢¼çš„å®Œå…¨å­—å…ƒ(a-zA-Z0â€“9)å¯èƒ½æ€§æ˜¯ 62 ^ 8 ä»¥ä¸Šï¼Œä½†æ˜¯åˆ©ç”¨äººé¡çš„æƒ°æ€§ï¼Œå…¶å¯¦å¯èƒ½çš„çµ„åˆæ²’æœ‰é€™éº¼å¤šï¼Œé€™å¯ä»¥çœä¸‹éå¸¸å¤§é‡çš„è¨ˆç®—æ™‚é–“ã€‚\nberzerk0/Probable-Wordlists\n_Version 2 is live! Wordlists sorted by probability originally created for password generation and testing - make sureâ€¦_github.com\nå¯ä»¥çœ‹ä¸€ä¸‹è‡ªå·±çš„å¯†ç¢¼æœ‰æ²’æœ‰åœ¨ä¸Šé¢ XD\nè¨­å®šå¯†ç¢¼ä¸è¦ç”¨ 12345678 æˆ–æ˜¯ 0000000 ï¼Œå¦å¤–è¦è¨˜å¾—å¸¸æ›å¯†ç¢¼\n","date":"2019-01-20T01:12:22.083Z","permalink":"https://yuanchieh.page/posts/2019/2019-01-20-%E5%A6%82%E4%BD%95%E7%94%A8%E8%A7%A3%E9%99%A4%E6%8E%88%E6%AC%8A%E6%94%BB%E6%93%8A%E5%BC%B7%E8%BF%AB%E8%A3%9D%E7%BD%AE%E6%96%B7%E7%B7%9A-wifi-%E9%80%A3%E7%B7%9A/","title":"å¦‚ä½•ç”¨è§£é™¤æˆæ¬Šæ”»æ“Šå¼·è¿«è£ç½®æ–·ç·š Wifi é€£ç·š"},{"content":"é–‹å§‹å­¸æ³¡èŒ¶ä¹Ÿå­¸äº†ä¸‰å€‹æœˆï¼Œæƒ³èªªåŸ¹é¤Šèˆˆè¶£æœ€å›°é›£çš„å…¶å¯¦æ˜¯ç¬¬ä¸€æ­¥ï¼Œåœ¨å­¸èŒ¶çš„éç¨‹æœ‰äº›ç¶“æ­·è »æœ‰è¶£ï¼Œè¦ºå¾—åˆ†äº«å‡ºä¾†ä¾›å…¶ä»–äººå°èŒ¶è‘‰æ„Ÿåˆ°å¥½å¥‡çš„è·¯äººï¼Œè·Ÿæˆ‘ä¸€èµ·å…¥é–€é«”é©—å–èŒ¶çš„æ¨‚è¶£ã€‚\né¦–å…ˆè¦æ¾„æ¸…ä¸€ä»¶äº‹ï¼Œå–èŒ¶åœ¨å°ç£çš„åˆ»æ¿å°è±¡å¯èƒ½æ˜¯è€äººçš„è¡Œç‚ºï¼Œä½†æˆ‘è‡ªå·±è¦ºå¾—å–èŒ¶æ˜¯ä¸€ç¨®é£²å“ï¼Œé‡é»å°±æ˜¯å–å¾—é–‹å¿ƒï¼Œæ¥è‘—æ‰æ˜¯è¿‘ä¸€æ­¥ç´°ç´°å“åšå…¶ä¸­æ»‹å‘³ï¼Œèˆ‡èƒŒå¾Œçš„å…¸æ•…èˆ‡æ–‡åŒ–ï¼›\nå–èŒ¶è·Ÿå–å’–å•¡æ‡‰è©²éƒ½æ˜¯ä»¶å¾ˆæ£’çš„ä¼‘é–’ï¼Œä¸éç¢ºå¯¦å–èŒ¶é¢¨æ°£åœ¨å¹´è¼•ä¸€è¼©ä¼¼ä¹ä¸å¤ªç››è¡Œï¼Œç•¥æ„Ÿå¯æƒœ XD\nå¦‚ä½•é–‹å§‹ æˆ‘æœ¬äººæ˜¯å®Œå…¨é›¶ç¶“é©—ï¼Œå°æ™‚å€™ä¹Ÿåªæ˜¯è€çˆ¸æœƒæ³¡çƒé¾èŒ¶ï¼Œé£¯å¾Œè·Ÿè¦ªæˆšåè‘—é–’èŠï¼Œä½†å…¶å¯¦å°±æ²’æœ‰å¾ˆè¬›ç©¶\nå¾Œä¾†éš»èº«åˆ°å°åŒ—å·¥ä½œï¼Œè¦ºå¾—åœ¨å·¥ä½œä¹‹é¤˜å¯ä»¥åŸ¹é¤Šä¸åŒçš„èˆˆè¶£ï¼Œæ‰€ä»¥è‡¨æ™‚èµ·æ„å°±ä¸Šç¶²æ‹œ Googleï¼Œä¸€å€‹äººå°±ç¡¬è‘—é ­çš®å ±åäº†å°åŒ—æ›¸é™¢çš„èŒ¶è—èª²ç¨‹\nèŒ¶è—èª²ç¨‹ - è‡ºåŒ—æ›¸é™¢\nä¸€æœŸå…­å ‚èª² 3600å…ƒï¼Œç›®å‰æ˜¯ä¸Šæ—è‰æ›¸è€å¸«çš„èª²ç¨‹ï¼Œè€å¸«éå¸¸æœ‰è¶£ï¼Œä¸Šèª²æœƒå¾æœ€åŸºæœ¬çš„èŒ¶å¸­èˆ‡èŒ¶å…·ä»‹ç´¹èµ·ï¼Œé€™è£¡å°±ä¸ä¸€ä¸€ç´°è¬›ï¼Œæ¥è‘—å¾ŒçºŒä¸Šèª²è€å¸«æœƒä¾ç…§å­¸ç”Ÿé€²åº¦ï¼Œä¸Šä¸åŒçš„èŒ¶é¡ï¼Œæœ€åŸºæœ¬çš„å…­å¤§èŒ¶ ç¶ ã€ç™½ã€é»ƒã€é’ã€ç´…ã€é»‘ï¼Œç›®å‰æˆ‘ä¸Šåˆ°ç¬¬äºŒæœŸä¸Šäº†å‰é¢å››ç¨®ï¼Œåœ¨å­¸ç¿’èŒ¶é¡æ™‚è€å¸«æœƒæº–å‚™æ›¸é¢è³‡æ–™ä»‹ç´¹å…¸æ•…èˆ‡ç”¢åœ°ç­‰ï¼Œä»¥åŠè£½èŒ¶çš„éç¨‹ï¼Œè®“å­¸å“¡æœ‰æ›´å…¨é¢çš„äº†è§£ï¼›\næ¥è‘—æœƒè©¦èŒ¶ï¼Œä¸‰å…¬å…‹èŒ¶è‘‰ç”¨é‘‘å®šæ¯æ³¡å…©åˆ†é˜(ä»¿é–“æœ‰ä¸åŒçš„æ™‚é–“)ï¼Œæ¥è‘—ä¸€ä¸€å“èŒ¶ã€‚\nèŒ¶è‘‰ä»‹ç´¹ å…ˆè·³å‡ºä¾†ä»‹ç´¹ä¸€ä¸‹èŒ¶è‘‰ï¼ŒèŒ¶è‘‰åŸºæœ¬å¯ä»¥åˆ† èŒ¶æ¨¹ç¨®èˆ‡è£½ç¨‹\nèŒ¶æ¨¹ç¨®æ˜¯åŸæ–™ï¼Œä¾‹å¦‚èªªå¸¸è½åˆ°çš„é‡‘è±(å°èŒ¶åäºŒè™Ÿ)ã€ç´…ç‰(å°èŒ¶åå…«è™Ÿ)ã€éµè§€éŸ³ã€é’å¿ƒå¤§å³ç­‰ï¼Œé€™äº›æ˜¯èŒ¶æ¨¹ç¨®ï¼› æ¥è‘—æ‰€è¬‚çš„ç¶ èŒ¶ã€ç´…èŒ¶ã€çƒé¾èŒ¶(é’èŒ¶)ã€éµè§€éŸ³ã€åŒ…ç¨®èŒ¶ä»£è¡¨çš„æ˜¯ä¸åŒçš„å·¥è—è£½ç¨‹ï¼Œå¤§æŠµä¸Šæ˜¯ç™¼é…µç¨‹åº¦çš„ä¸åŒï¼Œç¶ èŒ¶èµ°ç„¡ç™¼é…µç›´æ¥æ®ºé’ï¼Œæ‰€ä»¥å¼·èª¿çš„æ˜¯é¦™å‘³ï¼›å…¶é¤˜ä¸åŒçš„ç™¼é…µåº¦èˆ‡ç„™ç«æ±ºå®šèŒ¶çš„ä¸åŒé¢¨å‘³ï¼Œä¹‹å¾Œç­‰æˆ‘äº†è§£å¾Œå†ç´°èªªã€‚\næ‰€ä»¥ä½ å¯èƒ½æœƒå–åˆ° é‡‘è±åšçš„ç¶ èŒ¶ã€ç´…èŒ¶æˆ–çƒé¾èŒ¶ï¼Œæ‰€ä»¥ä¸‹æ¬¡äººå®¶è«‹ä½ å–çƒé¾èŒ¶ä¹Ÿå¯ä»¥å•æ˜¯å“ªç¨®èŒ¶æ¨¹ç¨®ï¼Œé€™ä¹Ÿæœƒæ±ºå®šèŒ¶è‘‰çš„é¢¨å‘³\nèŒ¶è(ä¹Ÿå°±æ˜¯èŒ¶æ¨¹ä¸Šçš„èŠ½è‘‰)ï¼Œè£½èŒ¶çš„åŸæ–™æœƒå½±éŸ¿æˆèŒ¶çš„é¢¨å‘³ï¼Œè€ŒèŒ¶æ¨¹çš„ç”Ÿé•·å—åˆ°åœ°ç†æ°£å€™çš„å½±éŸ¿ï¼Œæ‰€ä»¥æœ‰äº›çŸ¥åçš„åœ°é»æœƒæ¨™è¨˜å¦‚æ¢¨å±±çƒé¾ã€é˜¿é‡Œå±±çƒé¾ï¼›\nå¦å¤–æ¡èŒ¶çš„æ™‚æ©Ÿå¾ˆé‡è¦ï¼Œæ‰€è¬‚ã€Œæ˜¥èŒ¶åšé¦™ã€å†¬èŒ¶åšæ°´ã€ï¼Œæ˜¥å†¬å…©å­£çš„èŒ¶è‘‰å“è³ªé€šå¸¸æœ€å¥½ï¼Œåƒ¹æ ¼ç•¶ç„¶ä¹Ÿæœ€è²´ã€‚\næ‰€ä»¥è²·èŒ¶è‘‰è¨˜å¾—å• ä»€éº¼è£½ç¨‹ã€ä»€éº¼èŒ¶æ¨¹ç¨®ã€ä»€éº¼æ™‚å€™æ¡æ”¶ã€å¹´ä»½å¤šä¹…ã€ç™¼é…µåº¦å¦‚ä½•ç¨®ç¨®ï¼Œç”šè‡³ç•¶å¤©æ¡æ”¶çš„æ™‚é–“è·Ÿæ°£å€™éƒ½æœƒå½±éŸ¿\nä¸Šèª²ä¸»è¦æ˜¯å­¸ä¸åŒçš„èŒ¶ï¼Œä¾‹å¦‚èªªç™½èŒ¶ï¼Œåˆå¯ç´°åˆ†ä¸åŒç­‰ç´š ç™½æ¯«éŠ€é‡ã€ç™½ç‰¡ä¸¹ã€è²¢çœ‰ç­‰ï¼Œè¦å­¸æœƒåˆ†è¾¨å°±éœ€è¦ä¸æ–·çš„æ¯”è¼ƒèˆ‡å­¸ç¿’ï¼Œä»”ç´°å»å“åšå…¥é¼»çš„é¦™æ°£èˆ‡å…¥å–‰çš„éŸ»å‘³ï¼Œé€™éƒ¨åˆ†æˆ‘çœŸçš„å°±å¾ˆå¼±ï¼Œè€å¸«å¸¸å¸¸èªªæˆ‘æ˜¯ä¸æ˜¯èˆŒé ­å£æ‰Â â€¦ XDÂ ä½†æˆ‘é‚„æ˜¯æ¨‚åœ¨å…¶ä¸­é˜¿ï¼Œè‡³å°‘æ…¢æ…¢æœ‰åœ¨é€²æ­¥ï¼Œå¦å¤–æœ‰è¶£çš„æ˜¯æ¯å€‹åŒå­¸çš„é¦™å‘³è¨˜æ†¶éƒ½ä¸åŒï¼Œæœ‰äº›äººæœƒæè¿°èŠ±é¦™æœé¦™ï¼Œä½†å…¶å¯¦æˆ‘éƒ½è½ä¸æ‡‚ï¼Œå› ç‚ºæˆ‘å®Œå…¨æ²’æœ‰èéâ€¦\næ³¡ä¸åŒçš„èŒ¶ï¼Œå†æ­é…ä¸åŒçš„èŒ¶å£ºã€èŒ¶æ¯ã€ä¸åŒçš„æ°´æº«ã€æ²–æ³¡æ™‚é–“ã€å›æ²–æ¬¡æ•¸ç­‰ï¼Œéƒ½æœ‰ä¸åŒçš„é¢¨å‘³ï¼Œä¸Šèª²çš„å¦ä¸€å€‹å¥½è™•æ˜¯è€å¸«æœ‰å¤šç¨®çš„èŒ¶å…·ï¼Œä»¥åŠåŒå­¸é–“å¯ä»¥å½¼æ­¤äº¤æµã€‚\næ•´é«”ä¸Šå“èŒ¶å…¶å¯¦è »å€‹äººï¼Œå°±æ˜¯è¦å¤šçœ‹å¤šå–ï¼Œé€æ­¥æ‰¾å‡ºè‡ªå·±å–œæ„›çš„èŒ¶ã€‚\nè²·èŒ¶å…·ï¼ ä¸Šèª²ä¸Šäº†ä¸€æœŸæ±ºå®šå…¥å‘ï¼Œä½†æ˜¯èº«ç‚ºåˆå¿ƒè€…ï¼Œæœ€ç…©çš„å°±æ˜¯å®Œå…¨æ²’æœ‰ç¶“é©—ä¸çŸ¥é“æ€éº¼æŒ‘ï¼Œäº”èŠ±å…«é–€çš„å™¨å…·è©²æ€éº¼è²·ï¼Œå°¤å…¶æ˜¯çœ‹åˆ°åƒ¹ä½ä¹Ÿä¸çŸ¥é“æ˜¯é«˜æ˜¯ä½ï¼Œä¸æƒ³è²·å¤ªå·®ä½†åˆä¸æƒ³ç•¶ç›¤å­ï¼Œä¸€æ•´å€‹è¶…ç³¾çµçš„ XD\né‚£å°±æˆ‘å€‹äººç¶“é©—ï¼Œçµ¦å¤§å®¶ä¸€äº›åƒè€ƒï¼Œæˆ‘æ˜¯åœ¨æ·˜å¯¶é›™åä¸€è²·çš„ï¼Œå°ç£ä¹Ÿæœ‰å¾ˆå¤šèŒ¶è¡Œæˆ–æ˜¯é¶¯æ­Œéƒ½æœ‰è³£ï¼Œä¹‹å‰å»å°å—è·¯éå¾ˆå¤šé–“ç¥ç§˜çš„æ›¸å±€ä¹Ÿæœ‰åœ¨è³£\nç¬¬ä¸€æŠŠæœ±æ³¥å£ºè²· 1500 å°å¹£ï¼Œæˆ‘åœ¨è‡ºç£å• 2000 å·¦å³æ˜¯åŸºæœ¬æ¬¾ï¼Œé€™äº›æ˜¯æ‰‹ä½œå£ºçš„åƒ¹ç¢¼ï¼Œå¦‚æœæ˜¯æ©Ÿå™¨åšåœ¨é¶¯æ­Œé€›æ™‚å¤§æ¦‚å°±3ã€500ä¸€æ”¯ï¼›\nèé¦™æ¯ã€å“èŒ—æ¯ã€å…¬é“æ¯æ˜¯ç“·å™¨ï¼Œå¤§æ¦‚ä¸€å€‹æ¯å­100å…ƒå·¦å³ï¼›\nå…¶ä»–çš„èŒ¶é‡ã€èŒ¶å‰‡å°±çœ‹å€‹äººï¼Œä¹Ÿå¤§ç´„1ã€200è€Œå·²ã€‚\nç¸½å…±åŠ ç¸½å¤§æ¦‚2500~3000 æå®šåŸºæœ¬çš„èŒ¶å…·çµ„ï¼Œç•¶ç„¶åªæ˜¯å…¥é–€çš„é–‹å§‹Â â€¦â€¦\næ›´ï¼šèŒ¶æµ·å–œæ­¡ç»ç’ƒè³ªæ„Ÿçš„è©±ï¼Œå»ºè­°è²·é›™å±¤éš”ç†±çš„ç»ç’ƒèŒ¶æµ·ï¼Œä¸ç„¶å¾ˆç‡™æ‰‹\næˆ‘æœ‰å•è€å¸«æ€éº¼æŒ‘å£ºï¼Œè€å¸«å°±æ˜¯èªªçœ‹å¾—é †æ‰‹èŠ±å¾—ä¸‹å»å°±è²·ï¼Œé€™çœŸçš„éƒ½è¦ä¸€ç›´è²·ä¸€ç›´è©¦æ‰çŸ¥é“ã€‚\næ³¡èŒ¶çš„å™¨çš¿å¤§æ¦‚å…©ç¨®è“‹æ¯è·ŸèŒ¶å£ºï¼Œæè³ªå¯åˆ† ç“·å™¨ã€æœ±æ³¥ã€ç´«ç ‚ã€é™¶ï¼Œæè³ªå¤§è‡´ä¸Šå› ç‚ºå­”éš™çš„å¤§å°ï¼Œæœƒå°èŒ¶è‘‰æœ‰ä¸åŒçš„ä¿®é£¾ï¼›\nåƒæ˜¯ç“·å™¨å­”éš™éå¸¸å°ï¼Œæ‰€ä»¥æœ€èƒ½é‚„åŸèŒ¶çš„åŸå‘³ï¼Œä¸åŠ åˆ†ä¸æ¸›åˆ†ï¼Œè©¦èŒ¶çš„æ™‚å€™æœ€å¥½ç”¨ç“·å™¨ï¼›\nä½†æœ‰äº›èŒ¶ç«å‘³å¤ªé‡ï¼Œæˆ–æ˜¯æœ‰äººåå¥½åœ“æ½¤å£æ„Ÿæœƒç”¨å…¶ä»–çš„èŒ¶å™¨ï¼Œå› ç‚ºå­”éš™æœƒå¸é™„èŒ¶å‘³ï¼Œæ‰€ä»¥å‘³é“ä¸æœƒå¤ªè¡ã€‚\nè²·èŒ¶è‘‰ è²·èŒ¶è‘‰ä¸€é–‹å§‹è¦å…¥é–€å¥½é›£å•Šï¼Œä¹‹å‰æœ‰å»æœ¨æŸµçš„èŒ¶åœ’èµ°èµ°ï¼Œå¯æ˜¯çœ‹åˆ°èŒ¶è¡Œå°±ä¸å¤ªæ•¢é€²å»ï¼Œå¯èƒ½è·Ÿä¸€èˆ¬çš„æ¶ˆè²»ç¿’æ…£å»é€›ç™¾è²¨å…¬å¸ã€å¤§è³£å ´ä¸åŒï¼Œåƒ¹æ ¼çœ‹èµ·ä¾†ä¸é€æ˜ä¸æ•¢é€²å»ï¼Œæœ¬ä¾†æœ‰æƒ³è¦ç¶²è³¼å°±å¥½ï¼ŒBUT\nèŒ¶è‘‰ä¸€å®šè¦è©¦å–ï¼Œä¸è¦éš¨ä¾¿è²·ï¼\nè¦å¦‚ä½•è©•æ–·èŒ¶çš„å¥½å£èˆ‡å°æ‡‰çš„åƒ¹æ ¼å‘¢Â ?Â æˆ‘åœ¨ä¸€æœ¬æ›¸ä¸Šé¢å¯«åˆ°\nã€Œå°ç£èŒ¶è¾²æ¯å°æ–¤ç”Ÿç”¢çš„èŒ¶è‘‰æ‰€éœ€è¦è² æ“”çš„æˆæœ¬æ©Ÿå™¨æ¡æ”¶ç´„ 270å…ƒï¼Œæ‰‹å·¥å‰‡æ˜¯ 500~1000å…ƒã€\nå¦‚æœå†ç®—ä¸ŠåŠ å·¥ã€é€šè·¯ã€è¡ŒéŠ·ç­‰æˆæœ¬ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ˜ç¢ºåƒ¹æ ¼ä½†è‡³å°‘æœ‰å€‹åº•ï¼Œé€šå¸¸æ›ç®—ä¸€æ–¤ç´„ 2000 å…ƒä¸Šä¸‹ï¼Œä½†æ¯æ¬¡è²·å¤§ç´„éƒ½æ˜¯ 75g / 150g çš„ä»½é‡ï¼Œä¹Ÿå°±æ˜¯ 400~500 å…ƒä¸€ç½æˆ‘è¦ºå¾—æ˜¯åˆç†çš„åƒ¹æ ¼ï¼Œä¹Ÿéƒ½æ²’æœ‰è¸©é›·éï¼›\nä½æ–¼é€™å€‹æ¨™æº–å¯èƒ½æ˜¯æ··èŒ¶ï¼Œæ‘»å…¥ä¸åŒåœ‹å®¶å¦‚è¶Šå—çš„èŒ¶è‘‰ï¼Œé€™éƒ¨åˆ†å› ç‚ºèŒ¶è‘‰å±¬æ–¼åŠ å·¥é£Ÿå“ï¼Œæ‰€ä»¥ç•¶åŸæ–™ä½æ–¼æŸå€‹æ¯”ä¾‹å¯ä»¥ä¸å¯«ç”¢åœ°ä½•è™•ï¼Œå°å¿ƒä¸è¦å—é¨™ã€‚\nä¸åŒèŒ¶é¡æœ‰ä¸åŒé¢¨å‘³ï¼Œä½†æ˜¯å¤§æŠµä¸Šå¥½èŒ¶å¿…é ˆè¦å…¥å–‰èˆ’æœã€æœƒç”Ÿæ´¥ä¸æœƒæ¾€ï¼Œåƒéµè§€éŸ³ç­‰æœ‰æ™‚ç„™ç«ä¸­æœƒæœ‰å¾ˆå¼·çƒˆçš„ç«å‘³(æ•æˆ‘è©çª®)ï¼Œé‚£ç¨®å‘³é“ä¸è¦‹å¾—å¤§å®¶èƒ½æ¥å—ï¼Œä½†å¥½èŒ¶å°±æ˜¯ä¸æœƒæ¾€ï¼Œå…¥å–‰å¾Œå£æ°´æœƒåˆ†æ³Œ(ç”Ÿæ´¥)ï¼Œéäº†å¹¾ç§’å”‡é½’ä¾ç„¶ç•™é¦™ï¼›\né€™ç®—æ˜¯æœ€åŸºæœ¬çš„æ¨™æº–ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯å°‘å…‹æ•¸é•·æ™‚é–“æ²–æ³¡ (ä¸‰å…‹äº”åˆ†é˜)ï¼Œç­‰èŒ¶æ³¡ä¹…äº†åˆæ”¾æ¶¼ï¼Œå¥½è™•å£è™•ä¸€è¦½ç„¡éºã€‚\nå–åˆ°ä¸å¥½çš„èŒ¶è‘‰å°èº«é«”ä¸å¥½ï¼Œä¾‹å¦‚æˆ‘ä¹‹å‰å°±å–åˆ°åˆ®èƒƒï¼Œä¸å¥½çš„é«”é©—å¯èƒ½ä¹Ÿæœƒä¸­æ–·èˆˆè¶£çš„åŸ¹é¤Šï¼Œå€‹äººå»ºè­°ä¸æ•¢å»èŒ¶è¡Œè²·çš„è©±å¯ä»¥å»èŒ¶é¤¨ï¼Œåœ¨å°åŒ—çš„æ°¸åº·è¡—æœ‰éå¸¸å¤šé–“ï¼Œå…§ç”¨ä¸€å£ºå¤§æ¦‚200ä¸Šä¸‹ï¼Œå–œæ­¡åœ¨è²·\nå€‹äººä¹‹å‰å»éå°å—çš„å£¹äºŒèŒ¶å ‚ï¼Œå‰›å¥½æ˜¯æœ‹å‹ä»‹ç´¹ï¼Œåº—ä¸»å¾ˆç´°å¿ƒä»‹ç´¹ï¼Œå¯ä»¥è©¦åˆ°ä¸åŒçš„å°ç£æœ‰æ©ŸèŒ¶ï¼Œå…ˆå»èµ°è¨ªæœƒæ˜¯ä¸éŒ¯çš„é«”é©—ã€‚\nå°åŒ—éƒ¨åˆ†å¤§å¤šä½æ–¼æ°¸åº·è¡—ï¼Œç­‰æˆ‘èµ°è¨ªéå¾Œå†ä¾†æ¨è–¦\næ¥è‘—æ˜¯å»èŒ¶è—åšè¦½æœƒï¼Œæˆ‘é€™æ¬¡å‰›å¥½ 2019/1/4â€“7 åœ¨ä¸–è²¿æœ‰å±•è¦½ï¼Œå»èµ°è¨ªå°±ç¡¬è‘—é ­çš®åä¸‹ä¾†å–èŒ¶ï¼Œé–‹å§‹æœ‰ç¦®è²Œåœ°è«‹æ•™ï¼Œåº—å®¶é€šå¸¸éƒ½é¡˜æ„è·Ÿä½ ä»‹ç´¹ï¼Œç•¢ç«Ÿå±•è¦½å¤§å¤šæ˜¯æ¨å»£ç‚ºä¸»ï¼ŒéŠ·å”®æ˜¯å…¶æ¬¡ï¼Œé€™æœƒæ˜¯è²·èŒ¶è‘‰èˆ‡æ›´èªè­˜èŒ¶è‘‰çš„å¥½æ©Ÿæœƒï¼Œé€™æ¬¡å»å°±è©¦åˆ°æˆ‘å€‹äººéå¸¸å–œæ­¡çš„èŒ¶ï¼Œé †æ‰‹å°±è²·é»å›å®¶å–\nåˆ†äº«ä¸€ä¸‹æˆ‘å€‹äººå£å‘³ï¼Œå°ç£èŒ¶å¤§å¤šæ˜¯çƒé¾è·Ÿå°‘è¨±ç´…èŒ¶ï¼Œå…¶ä»–èŒ¶ç¨®ç½•è¦‹ï¼Œä½†æ˜¯ç›®å‰å¸‚å ´å°ç£çš„é«˜å±±çƒé¾éƒ½æ˜¯è¼•ç™¼é…µï¼Œå‘³é“ä¸å¤ªæ˜¯æˆ‘å–œæ­¡çš„ï¼Œè€Œä¸”æœ‰é»æœƒåˆ®èƒƒï¼Œä¸å¤ªèˆ’æœ\nå¾Œä¾†å–åˆ°ç”Ÿæ´»å±…èŒ¶è¡Œçš„è€æ¨¹ç¨®ç´…èŒ¶ï¼Œå–å¾—å°±è »å–œæ­¡çš„ï¼Œè€Œä¸”åé¤˜æ³¡å‘³é“ä¸æ¸›ï¼Œååˆ†åœ“æ½¤ç”˜ç”œï¼Œä¹Ÿæ˜¯é€™æ”¤çš„æ”¤ä¸»è·Ÿæˆ‘èªªæ…¢æ…¢å–ä¸è¦æ€¥è‘—èµ°ï¼Œå³ä½¿æˆ‘è²·çš„ä¸å¤šä»–ä¾ç„¶ç†±æƒ…çš„ä»‹ç´¹ï¼Œå¾ˆæ„Ÿè¬é€™ä½æ”¤ä¸»\n#æ›´ï¼šå¾Œä¾†è€å¸«æœ‰å¸¶æˆ‘å€‘å»æ¡ƒåœ’é¾œå±±çš„ç›Šå£½èŒ¶å» åƒè¨ªï¼Œé«”é©—è£½ä½œæ±æ–¹ç¾äººèŒ¶ï¼Œæ•´å€‹éç¨‹ååˆ†æœ‰è¶£ï¼Œå¾ä¸€é–‹å§‹åƒè§€èŒ¶åœ’ï¼Œçœ‹çœ‹å‚³èªªä¸­çš„å°ç¶ è‘‰èŸ¬ï¼Œæ¥è‘—å°±åƒèˆ‡æ›¬è / æ‰æ»çš„éç¨‹ï¼Œçœ‹è‘—èŒ¶èå¾é®®ç¶ æ…¢æ…¢èå‡‹ï¼Œå¾æ¿ƒåšçš„è‰å‘³è½‰è®Šæˆé’è˜‹æœé¦™ï¼Œæ²’æœ‰å¯¦éš›è£½èŒ¶æ²’æœ‰æƒ³åƒåˆ°é€™æ¨£ç¾å¦™çš„é¢¨å‘³æµè½‰çš„éç¨‹ï¼Œå¾æ—©ä¸Šä¹é»ä¸€è·¯å¿™åˆ°æ™šä¸Šåä¸€é»ï¼Œå¾Œä¾†è¦è¶•è»Šæµªèã€æ®ºèã€æˆåœ˜çš„éç¨‹å°±æ²’æœ‰åƒèˆ‡ï¼Œå¹¾å¤©å¾Œæ”¶åˆ°è¦ªæ‰‹åšçš„æ±æ–¹ç¾äººèŒ¶æœ‰æ»¿æ»¿çš„å›æ†¶èˆ‡æ„Ÿå‹•ï¼\né€™é‚Šä¹Ÿæ¨è–¦ç›Šå£½èŒ¶å» çš„èŒ¶è‘‰å–”ï¼Œçœ‹è‡‰æ›¸ä¹Ÿæœ‰å¾ˆå¤šåƒè¨ªæ´»å‹•ï¼Œæœ‰èˆˆè¶£å¯ä»¥æŸ¥æŸ¥çœ‹ï½\nçŸ¥è­˜è£œçµ¦ç«™ æˆ‘è »å–œæ­¡å¾æœ‰ç³»çµ±æ€§æ–¹å¼é–‹å§‹å­¸ç¿’ï¼Œæ‰¾è€å¸«æˆ–æ˜¯çœ‹æ›¸å°±éå¸¸çš„é©åˆï¼Œæ—è‰æ›¸è€å¸«æœ‰æ¨è–¦å…©æœ¬ä»‹ç´¹è‡ºç£çƒé¾èŒ¶çš„æ›¸ï¼Œå…¶ä¸­ä¹Ÿæœ‰èŒ¶è‘‰ä»‹ç´¹ï¼ŒåŒ…å«èŒ¶çš„è‹¦å‘³ã€é¦™å‘³ã€æ¾€å‘³æ˜¯æ€éº¼ä¾†çš„ï¼Œå¤§æŠµçš„è£½ç¨‹ä¹‹é¡çš„ï¼Œçœ‹å®Œå°±æœƒæœ‰å€‹åˆæ­¥å°è±¡\nçƒé¾èŒ¶çš„ä¸–ç•Œï¼šå…¨æ–¹ä½èŒ¶è·äºº30é¤˜å¹´å¿ƒè¡€çµæ™¶ï¼Œå¾ç¨®èŒ¶ã€è£½èŒ¶ã€é£²èŒ¶ï¼Œå‘Šè¨´ä½ çƒé¾èŒ¶é¢¨å‘³çš„ç§˜å¯†\nå°ç£èŒ¶ç¬¬ä¸€å ‚èª²ï¼šé ‚å°–èŒ¶äººæ•™ä½ å–èŒ¶ä¸€å®šè¦çŸ¥é“çš„äº‹ï¼\nå¦å¤–æ˜¯è½åˆ°èŒ¶å‹æ¨è–¦çš„å°ˆæ¥­èŒ¶è‘‰è«–å£‡\nè‡ºç£ T4U èŒ¶è—è«–å£‡ - Powered by Discuz!\nè£¡é¢æœ‰å„å¼èŒ¶è‘‰çš„è¨è«–ï¼Œç›®å‰ä»åœ¨åŠªåŠ›çˆ¬æ–‡ä¸­\næœ€å¾Œè£œå……ä¸€é»ï¼ŒèŒ¶è‘‰æœ‰è³å‘³æœŸä½†æ²’æœ‰ä¿å­˜æœŸï¼Œä¹Ÿå°±æ˜¯æœ‰äº›èŒ¶è‘‰åœ¨æŸäº›å¹´ä»½æœƒæ¯”è¼ƒå¥½å–ï¼Œé€šå¸¸æ¸…é¦™å‹ç•¶å¹´åº¦æœƒæ¯”è¼ƒå¥½ï¼Œå…¶é¤˜çš„æ”¾ä¹…äº†å‘³é“æœƒã€Œè½‰ã€ï¼Œä½†åªè¦ç”¨å¤¾éˆè¢‹é™°ä¹¾ä¿å­˜ï¼Œæ”¾å€‹å¹¾åå¹´éƒ½ä¸æˆå•é¡Œï¼Œå¦‚æœæ­¤æ™‚çš„å‘³é“ä¸å–œæ­¡ï¼Œå†çµ¦ä»–ä¸€é»æ™‚é–“ï¼Œéä¸€é™£å­èªªä¸å®šå°±åˆèƒƒå£äº†ã€‚\nç¸½ä¹‹å°±æ˜¯é¼“èµ·å‹‡æ°£ï¼Œå¤šå–å¤šçœ‹å¤šå•ï¼Œå¯ä»¥å»ç¾ä»£çš„èŒ¶é¤¨è©¦è©¦ï¼Œä¹Ÿå¯ä»¥åœ¨æœ‰å±•è¦½å»ã€‚\nçµèª å–èŒ¶å°±æ˜¯è¦æ‰¾å¾—é©åˆçš„èŒ¶ï¼Œç”¨é–‹å¿ƒçš„å¿ƒæƒ…å–èŒ¶ï¼Œè¬›ç©¶ä»€éº¼çš„å€’æ˜¯å…¶æ¬¡ (è½‰è¿°å‰è¼©æ‰€è¨€\né€™ç¯‡ç®—æ˜¯å‰›å…¥é–€ä¸ä¹…çš„å¿ƒå¾—ï¼Œå¦‚æœ‰éŒ¯èª¤ç…©è«‹ç³¾æ­£ï¼Œé•·è·¯æ¼«æ¼«ï¼Œé¡˜èŒ¶é¦™ä¸€è·¯ç›¸éš¨\n","date":"2019-01-05T14:35:28.013Z","permalink":"https://yuanchieh.page/posts/2019/2019-01-05-%E8%8F%9C%E9%B3%A5%E8%8C%B6%E5%AE%A2-%E5%BE%9E%E8%B7%AF%E4%BA%BA%E5%88%B0%E5%85%A5%E9%96%80/","title":"èœé³¥èŒ¶å®¢-å¾è·¯äººåˆ°å…¥é–€"},{"content":"é€™ä»½æ˜¯åœ¨ 2018/11/20 ç”± V8 Team é‡‹å‡ºçš„æ–‡ä»¶ï¼Œä¸»è¦æè¿°ç”¨ä¸€ç¨®æ–°çš„Async éŒ¯èª¤è¿½è¹¤æ©Ÿåˆ¶ï¼Œæ­¤æ–°æ©Ÿåˆ¶åƒ…é©ç”¨æ–¼ async await ï¼Œpromise chainå‰‡æ²’æœ‰æ•ˆæœï¼Œç›®å‰éœ€è¦é€é --harmony-await-optimization flag å•Ÿç”¨é€™é …åŠŸèƒ½ã€‚\nä»¥ä¸‹å…§å®¹èˆ‡åœ–ç‰‡æ‘˜éŒ„æ–¼è©²æ–‡ä»¶ã€‚\nç·£ç”± åƒè€ƒä¸‹åˆ—ç¨‹å¼ç¢¼\n1 2 3 4 5 6 7 8 9 10 async function foo(x) { await bar(x); } async function bar(x) { await x; throw new Error(\u0026#34;Let\u0026#39;s have a look...\u0026#34;); } foo(1).catch(e =\u0026gt; console.log(e.stack)); å¦‚æœé‹è¡Œåœ¨ V8 7.1 ç‰ˆæœ¬ï¼Œæœƒç™¼ç¾ error.stack åƒ…æœƒå°å‡ºéƒ¨åˆ†éŒ¯èª¤è³‡è¨Š\n1 2 Error: Let\u0026#39;s have a look... at bar (\u0026lt;anonymous\u0026gt;:7:9) è€Œèª¿ç”¨è€… foo å‰‡æ¶ˆå¤±ç„¡è¹¤ï¼Œé€™æ˜¯å› ç‚ºå¾ JSVMè§’åº¦ï¼Œç•¶ bar å› ç‚º await x è€Œæš«åœåŸ·è¡Œï¼Œæ¥è‘—å¾ microtask queue æ¢å¾©åŸ·è¡Œå¾Œï¼Œåœ¨ stack ä¸Šå·²ç¶“æ²’æœ‰å…¶ä»– function äº†\nç›®å‰å¯ä»¥é–‹ Chrome Dev Inspector ( \u0026gt; node --inspect)ï¼ŒåŸ·è¡ŒåŒæ¨£çš„ç¨‹å¼ï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´çš„ error stackï¼Œä½†é€™æœƒæœ‰å¾ˆå¤§çš„æ€§èƒ½å½±éŸ¿ï¼Œæ‰€ä»¥åªå»ºè­°åœ¨é–‹ç™¼ä¸­ä½¿ç”¨ã€‚\nè§£æ³• ç›®å‰çš„å›°å¢ƒæ˜¯ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå› ç‚ºéåŒæ­¥ç‰¹æ€§è¦è¿½è¹¤å®Œæ•´çš„éŒ¯èª¤æ£§ä¸å®¹æ˜“ã€‚\næ­£å¥½ await æœƒåœæ­¢ç›®å‰çš„ function é‹ä½œï¼Œæ‰€ä»¥ä¸ä½†å¯ä»¥çŸ¥é“ç›®å‰åœåœ¨ä»€éº¼åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥çŸ¥é“æ˜¯å¾å“ªè£¡è¢«å‘¼å«ï¼›\né€™ç‰¹æ€§è·Ÿ promise chainç›¸åŒï¼Œå› ç‚º promise é€éÂ .then é€£çµï¼Œæ‰€ä»¥èƒ½å¤ è¼•é¬†ååºé‡å»ºå‡º function å‘¼å«ç›¸ä¾ã€‚\nå…ˆè¡Œæ¢ä»¶ æˆ‘å€‘å¿…é ˆé‹ç”¨ promise chainï¼Œæ‰èƒ½æœ‰è¶³å¤ çš„æ¢ä»¶æ‰¾å‡ºå®Œæ•´ stack traceï¼›\nä½†å¦‚æœ promise æ˜¯è¢«å¦ä¸€å€‹ promise resolved (åœ¨ fulfill æ–¹æ³•ä¸­ return å¦ä¸€å€‹promise)ï¼Œé€™æ¨£ promise chain é–“å°±æ²’æœ‰ç›´æ¥çš„ä¾æ“šï¼Œå¿…é ˆç­‰åˆ°ä¸‹ä¸€å€‹ tick [PromiseResolveThenableJob](https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob) åŸ·è¡Œæ™‚æ‰çŸ¥é“é€™å…©å€‹ promise æ˜¯æœ‰ç›¸ä¾çš„ã€‚\né€™æ˜¯ç›®å‰ ES2017 çš„è¦ç¯„æ‰€å¸¶ä¾† await éº»ç…©ä¹‹è™•\n1 2 3 4 5 6 7 8 const _.promise_ = @createPromise(); @resolvePromise(.promise, x); const _.throwaway_ = @createPromise(); @performPromiseThen(_.promise_, res =\u0026gt; @resume(_.generator_object_, res), err =\u0026gt; @throw(_.generator_object_, err), _.throwaway_); @yield(_.generator_object_, _.outer_promise_); ç›®å‰ await éƒ½å¿…é ˆç”¨å¦ä¸€å€‹ promiseÂ .promise é‡æ–°åŒ…è£ï¼Œå³ä½¿ x æœ¬èº«å·²ç¶“æ˜¯promiseï¼Œå•é¡Œåœ¨æ–¼Â .generator_object èˆ‡ x æ²’æœ‰ç›´æ¥çš„é—œé€£ï¼›\nè€Œæ˜¯å¿…é ˆç­‰åˆ°ä¸‹å€‹ tick PromiseResolveThenableJob å°‡Â .promise â† â†’ x èˆ‡Â .promise â† â†’Â .generator_object æ‰èƒ½é—œè¯ã€‚\næ‰€ä»¥ç›®å‰éœ€è¦é¡å¤–å»ºç«‹ x â† â†’Â .promise çš„é—œè¯ æˆ–æ˜¯ æŸ¥è©¢ microtask queueï¼Œå…©è€…éƒ½éœ€è¦é–‹éŠ·ã€‚\nå¥½åœ¨æœ€è¿‘æœ‰ææ¡ˆè¦ä¿®æ”¹æ­¤éƒ¨åˆ†ï¼Œå°‡å¤šé¤˜Â .promise åˆªé™¤\nconst .promise = @promiseResolve(x);\nconst .throwaway = @createPromise();\n@performPromiseThen(.promise,\nres =\u0026gt; @resume(.generator_object, res),\nerr =\u0026gt; @throw(.generator_object, err),\n.throwaway);\n@yield(.generator_object, .outer_promise);\næœ€ä¸»è¦å·®åˆ¥åœ¨ constÂ _.promise_ = @promiseResolve(x); ï¼Œä½¿ç”¨ promiseResolve å¦‚æœ x æœ¬èº«æ˜¯ native promise å°±ä¸æœƒé¡å¤–å†åŒ…ä¸€å±¤ï¼Œå¯ä»¥åœ¨ V8 v7.2 --harmony-await-optimization é–‹å•Ÿæ­¤åŠŸèƒ½ã€‚\næ¦‚è¦½ æ¥ä¸‹ä¾†æ˜¯ V8 å…§éƒ¨çš„ await Promiseå¯¦è¸ï¼Œé€éä¸Šè¿°çš„ Spec ä¿®æ”¹å¾Œï¼Œé”åˆ° async stack trace ç›®æ¨™ã€‚\né‡å°ä»¥ä¸‹çš„ç¨‹å¼ç¢¼ï¼Œç•«å‡ºå¯¦éš› V8 çš„ Call Stack\n1 2 3 4 5 6 7 8 9 10 async function foo(x) { await bar(x); } async function bar(x) { await x; throw new Error(\u0026#34;Let\u0026#39;s have a look...\u0026#34;); } foo(1).catch(e =\u0026gt; console.log(e.stack)); å› ç‚º bar(x) ä¸­ await (1)ï¼Œè€Œ 1 ä¸æ˜¯ promise æ‰€ä»¥éœ€è¦é€é Promise().resolve(1) å¤šåŒ…ä¸€å±¤ï¼Œæ‰€ä»¥åœ¨ Call stack ä¸Š bar è¢« await fulfilled å‘¼å«ï¼›\nã€Œå¦‚æœ async stack åŠŸèƒ½é–‹å•Ÿã€ï¼Œæ­¤æ™‚æœƒå»æœå°‹ â€œcurrent microtaskâ€æ‰¾åˆ° åŒ…è£xçš„PromiseReactionJob ï¼Œæ‰¾åˆ°çš„è©±å°±æœƒé †å‹¢æ‰¾åˆ° generator object ï¼Œé€™å€‹ object ä¹Ÿå°±æ˜¯ async function æ‰€è½‰åŒ–è€Œä¾†çš„ï¼ŒåŒæ™‚åŒ…å« async function çš„ promise referenceã€‚\nå¦ä¸€ç¨®åšæ³• å¦ä¸€ç¨®åšæ³•å‰‡æ˜¯ await ç”¢ç”Ÿçš„å…§éƒ¨ promise (Â .promise)æœ‰è¾¦æ³•æ‰¾åˆ°å¤–éƒ¨ promise (ä¹Ÿå°±æ˜¯ async functionï¼Œ JSPromise)ï¼Œå¦‚æœå…¨éƒ¨éƒ½æ˜¯ç”¨ async await ä¸²é€£ï¼Œå¯ä»¥æ‰¾åˆ° PromiseReaction ï¼Œè£¡é ­åŒ…å«å…©å€‹ç‰¹æ®Šçš„é–‰åŒ… Await Rejected è·Ÿ Await Fulfilled ï¼Œå…©è€…å…±åŒåˆ†äº«ä¸€å€‹ Object AwaitContext ï¼Œé€™å€‹AwaitContext æ˜¯å¦ä¸€å€‹å†ç­‰å¾… JSPromise çš„JSGenerator Object ï¼Œä¹Ÿå°±æ˜¯ function fooã€‚\né€™éƒ¨åˆ†å…§éƒ¨å¯¦è¸çœ‹å¾—æœ‰é»æšˆé ­è½‰å‘ï¼Œç›®å‰å°±æ˜¯å¤§è‡´æœ‰å€‹æ¨¡ç³Šæ¦‚å¿µã€‚\nError.stack ç›®å‰ Error.stack é‚„ä¸æ˜¯å®˜æ–¹æ¨™æº–ï¼Œç›®å‰å·²ç¶“ææ¡ˆè™•æ–¼ stage-1 çš„è‰æ¡ˆ\ntc39/proposal-error-stacks\né€™éƒ¨å½±ç‰‡æ˜¯æ–‡ä»¶çš„é™„å±¬ referenceï¼Œä¸»è¦åˆ†äº« Nodejs ä¸­å¦‚ä½•ä½¿ç”¨async stack traceã€‚\nä»¥ä¸‹ç‚ºæ¸¬è©¦ç¨‹å¼ç¢¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function p(){ return new Promise((res, rej) =\u0026gt; setTimeout(()=\u0026gt; res(1), 1000)) } async function one(){ await p(); throw new Error(\u0026#34;err\u0026#34;); } async function two(){ await one(); } async function three(){ await two(); } async function four(){ await three(); } four().catch(error =\u0026gt; console.log(error.stack)); ä½¿ç”¨ç›®å‰çš„ Nodejs v11.5.0 åŸ·è¡Œï¼Œæ‰“å°çš„çµæœæ˜¯\n1 2 Error: err at one (/Users/.../Desktop/test.js:7:8) æ•´å€‹ call stack åªå‰© function one è€Œå·²ï¼Œé€™æ¨£è¦ debug ç›¸ç•¶å›°é›£ã€‚\næ­¤æ™‚å¯ä»¥é–‹å•Ÿ inspectorï¼Œ \u0026gt; nodeâ€Šâ€”inspect-brk=0.0.0.0:9229 test.js\næ¥è‘—æ‰“é–‹ chrome dev toolï¼Œè¨˜å¾—æ‰“é–‹ Discover network targetsï¼Œé»æ“Šé€²å»æœƒè·³å‡ºä¸‹æ–¹çš„ debugè¦–çª—ï¼Œæ¥è‘—è¦æ‰“é–‹ Pause on caught rejection ä¸ç„¶å‡ºéŒ¯å°±æœƒçµæŸäº†\nå¦‚åŒä¸Šé¢æ‰€èªªï¼Œé€™ç¨®æ–¹æ³•åªé©ç”¨æ–¼é–‹ç™¼ã€‚\næ–°çš„ zero-cost async stackÂ trace ç›®å‰éœ€è¦ V8 v7.2 ä¸¦é€é flag æ‰èƒ½é–‹å•Ÿæ­¤åŠŸèƒ½ï¼Œæ‰€ä»¥ç¾åœ¨è¦å…ˆä¸‹è¼‰ v8-canaryç‰ˆçš„ Nodejsï¼Œå¹³å¸¸éƒ½æ˜¯ç”¨ nvm ç®¡ç†å¤šå€‹ Nodejs ç‰ˆæœ¬ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼ä¸‹è¼‰\n1 $ NVM_NODEJS_ORG_MIRROR=[https://nodejs.org/download/v8-canary](https://nodejs.org/download/v8-canary) nvm install node å¯ä»¥é€é nodeçš„ REPL ç’°å¢ƒåŸ·è¡Œ \u0026gt; process.versions çœ‹ V8çš„ç‰ˆè™Ÿã€‚\næ¥è‘—åŸ·è¡Œ\n1 $ node --async-stack-traces test.js æ‰“å°çµæœå°±æœƒæ˜¯\n1 2 3 4 5 Error: err at one (/Users/zhengyuanjie/Desktop/test.js:7:8) at async two (/Users/zhengyuanjie/Desktop/test.js:11:2) at async three (/Users/zhengyuanjie/Desktop/test.js:15:9) at async four (/Users/zhengyuanjie/Desktop/test.js:19:9) çµèª ä¹‹å¾Œçœ‹ä¾†è¦èŠ±æ™‚é–“é‡æ–°å­¸ C/C++ï¼Œé€™æ¨£æ‰èƒ½çœ‹æ‡‚ V8 èˆ‡ JS Binding ç­‰åº•å±¤çš„ Nodejs å¯¦ä½œã€‚\n","date":"2019-01-01T10:27:29.899Z","permalink":"https://yuanchieh.page/posts/2019/2019-01-01-v8-zero-stack-async-stack-trace-%E7%A0%94%E7%A9%B6/","title":"V8 Zero Stack Async Stack Trace ç ”ç©¶"},{"content":"è¿‘æœŸçœ‹ä¸åˆ°å°‘é—œæ–¼ async / await çš„å¥½æ–‡ç« ï¼Œé€™è£¡ç‰¹åˆ¥æ‘˜éŒ„å…©ç¯‡ç¸½çµ\nAsynchronous stack traces: why await beats Promise#then() å°æ¯”æ–¼ç›´æ¥ä½¿ç”¨ Promise Chainï¼Œä½¿ç”¨ async / await é™¤äº†èªæ³•ä¸Šæ›´åŠ å‹å–„ï¼Œæ›´é‡è¦çš„æ˜¯ JS Engine åº•å±¤æœ‰å„ªåŒ–ï¼Œå°¤å…¶æ˜¯åœ¨ stack traceçš„æ™‚å€™ã€‚\nawait X() è·Ÿ Promise æœ€å¤§å·®åˆ¥åœ¨æ–¼åŸ·è¡Œæ™‚æœƒç›´æ¥æš«åœ function é‹ä½œï¼Œç›´åˆ° await çš„ promise XçµæŸå¾Œæ‰ç¹¼çºŒåŸæœ¬çš„ functionï¼›\nè‡³æ–¼ promise.then(X) å‰‡æ˜¯æŠŠ X æ”¾ä¸Š callback chainä¸Šï¼ŒåŸ function å°±çµæŸäº†ã€‚\né€™é»å·®ç•°æœ‰è‘—é‡å¤§çš„æ”¹è®Šï¼Œè«‹çœ‹ä»¥ä¸‹ç¯„ä¾‹\n1 2 3 const a = () =\u0026gt; { b().then(() =\u0026gt; c()); }; function a åŸ·è¡Œæ™‚ï¼Œæœƒç›´æ¥å‘¼å« function bï¼Œè€Œ b().then å‰‡æ˜¯å°‡ () =\u0026gt; c() åŒ¿å function æ”¾ä¸Š callback chainï¼Œç„¶å¾Œ a å°±çµæŸäº†ï¼Œæ‰€ä»¥ function a çš„ context ä¹Ÿè·Ÿè‘—æ¶ˆå¤±ï¼›\nè©¦æƒ³å¦‚æœæ­¤æ™‚ b æˆ– c æ‹‹å‡ºéŒ¯èª¤ï¼Œç†è«–ä¸Šè¦é™¤éŒ¯æˆ‘å€‘æœƒå¸Œæœ›çœ‹åˆ°å®Œæ•´çš„ call stackï¼Œä½†æ˜¯ a æ—©å°±çµæŸæ‹‹æ£„äº† contextï¼Œæ‰€ä»¥ V8 è¦é¡å¤–å°‡ a çš„ context å‚³çµ¦ promise b è·Ÿ function cï¼Œé€™æ¨£å‡ºéŒ¯æ‰æœ‰è¾¦æ³•è¿½æœ¬æº¯æºï¼Œé€™äº›æ˜¯é¡å¤–çš„è² æ“”ã€‚\næ”¹æˆ async / await å°±ä¸ä¸€æ¨£äº†\n1 2 3 4 const a = async () =\u0026gt; { await b(); c(); }; ç•¶ b æˆ– c å‡ºéŒ¯æ™‚ï¼Œå› ç‚ºé‚„åœ¨ function a çš„ contextæ‰€ä»¥å¯ä»¥å¾ˆå¿«é€Ÿè¿½è¹¤ï¼Œä¸éœ€è¦é¡å¤–çš„æˆæœ¬ã€‚\nå°çµ å¾ˆå¤š ES6èªæ³•éƒ½æ˜¯ syntax sugarï¼Œä½†æ˜¯ async / await å¸¶äº†æ›´ä¸ä¸€æ¨£çš„æ”¹è®Šï¼Œä½œè€…çµ¦å…©é»å»ºè­°\nç›¡é‡ç”¨ async / await é¿å…ä¸å¿…è¦çš„ transpileï¼Œé€é babel-preset-env ä¾†é¿å… Deploying ES2015+ Code in Production Today\nå»¶ä¼¸å‰›æ‰çš„å°çµç¬¬äºŒé»ï¼ŒJS Code å¦‚æœè¦è·‘åœ¨ç€è¦½å™¨ä¸Šä¸å¯é¿å…è¦ç”¨ babel transpile æˆ–æ˜¯åŠ ä¸Šå„ç¨® polifillï¼Œä½†ç¾åœ¨å·²ç¶“æ˜¯ 2018äº†ï¼\nå¾ˆå¤šç€è¦½å™¨å·²ç¶“è‰¯å¥½æ”¯æ´ ES 2015 +ï¼Œæ‰€ä»¥ babel transpile é–‹å§‹è®Šå¾—ä¸æ˜¯é€™éº¼å¿…è¦ï¼Œé€™ç¯‡æ–‡ç« æ·±å…¥æ¢è¨ å¦‚ä½•å¹³è¡¡èˆŠæ™‚ä»£ babel transpileçš„ legacy js èˆ‡ modern jsã€‚\né€™å€‹è­°é¡Œçš„è§£æ³•æ˜¯ \u0026lt;script type=â€moduleâ€\u0026gt; ï¼Œå¦‚æœç€è¦½å™¨æ”¯æ´ ESM Moduleï¼Œé‚£ä»–å°±å¯ä»¥æ”¯æ´ async / await ã€ classã€ arrow function ã€ fetch ç­‰ç­‰\nä»¥ä¸‹æ˜¯ can i use çš„æ”¯æ´ç¨‹åº¦åˆ†ä½ˆ\nCan I use\u0026hellip; Support tables for HTML5, CSS3, etc\nChrome / Safari / Firefox / Edge è¿‘å…©ã€ä¸‰å€‹ç‰ˆæœ¬éƒ½è‰¯å¥½æ”¯æ´ï¼ŒIEå°±ç®—äº†â€¦..\né–‹ç™¼é‡é» é–‹ç™¼æ™‚ä½¿ç”¨ ES 2015+ èªæ³•é–‹ç™¼ï¼Œé€éæ‰“åŒ…å·¥å…·(webpack ã€ gulpç­‰)ä¾†å‘¼å« babel ç”¢ç”Ÿå…©ä»½ç¨‹å¼ç¢¼ï¼š main.mjsã€ main.es5.js\n.mjs æ˜¯æŒ‡æ”¯æ´ ES Module çš„ js file å‰¯æª”åï¼›è€Œå¦ä¸€å€‹å°±æ˜¯ transpile çµ¦éæ™‚ç€è¦½å™¨ä½¿ç”¨çš„ ES5 èªæ³•ã€‚\nbabel config å¯ä»¥åƒè€ƒä½œè€…åœ¨å…§æ–‡æä¾›çš„ï¼Œä¸»è¦å°±æ˜¯æ”¹ target èˆ‡ output æª”å\n1 2 3 4 5 6 7 **targets**:{ **browsers**:[ \u0026#39;\u0026gt; 1%\u0026#39;, \u0026#39;last 2 versions\u0026#39;, \u0026#39;Firefox ESR\u0026#39;, ], } 1 2 3 4 5 6 7 8 9 **targets**:{ **browsers**:[ \u0026#39;Chrome \u0026gt;= 60\u0026#39;, \u0026#39;Safari \u0026gt;= 10.1\u0026#39;, \u0026#39;iOS \u0026gt;= 10.3\u0026#39;, \u0026#39;Firefox \u0026gt;= 54\u0026#39;, \u0026#39;Edge \u0026gt;= 15\u0026#39;, ], }, åœ¨ html pageä¸­ï¼Œå¼•ç”¨ js æ”¹æˆ\n1 2 3 4 5 6 \u0026lt;!-- Browsers with ES module support load this file. --\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;main.mjs\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;!-- Older browsers load this file (and module-supporting --\u0026gt; \u0026lt;!-- browsers know \\*not\\* to load this file). --\u0026gt; \u0026lt;script nomodule src=\u0026#34;main.es5.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; èˆŠç‰ˆç€è¦½å™¨çœ‹ä¸æ‡‚ type=â€moduleâ€ å°±æœƒå¿½ç•¥ï¼Œæ”¹æˆè¼‰å…¥å¦ä¸€å€‹ moduleï¼›\nåä¹‹ç¾ä»£ç€è¦½å™¨å°±è¼‰å…¥ main.mjsã€‚\né™åˆ¶èˆ‡æ³¨æ„äº‹é … éœ€æ³¨æ„ä»¥ä¸‹å¹¾é»äº‹é …\nå¦‚æœç€è¦½å™¨è¦ä½¿ç”¨Â .mjsï¼Œè¨˜å¾— server response header è¦åŠ  content-type:text/javascript ï¼Œå¦å‰‡ç„¡æ³•ä»”å…¥ ES Module è¡Œç‚ºé¡ä¼¼æ–¼ \u0026lt;script defer\u0026gt; ï¼Œä¹Ÿå°±æ˜¯æœƒç­‰åˆ° document parse å®Œæˆæ‰æœƒåŸ·è¡Œï¼Œå¦‚æœæœ‰éœ€è¦ç«‹å³åŸ·è¡Œçš„éœ€æ±‚ï¼Œå°±è¦æŠŠ code æ‹†å‡ºä¾† Module æ˜¯è·‘åœ¨ strict mode ï¼Œæ‰€ä»¥è¦èªæ³•ç­‰æ”¯æ´åš´æ ¼æ¨¡å¼ Module è¡Œç‚ºèˆ‡ä¸€èˆ¬ script ç•¥æœ‰ä¸åŒï¼Œä¾‹å¦‚è®Šæ•¸ä¸æœƒå…¨å±€æ±¡æŸ“\nä¾‹å¦‚èªª var a = 123 ï¼Œåœ¨ script ä¸­å¯ä»¥ç”¨ window.a ä¾†è®€å–ï¼Œä½†æ˜¯ Module ä¸æœƒã€‚ æ³¨æ„ Safari 10 ä¸æ”¯æ´ nomoduleï¼Œæ‰€ä»¥è¦å¦å¤–è£ polyfill å¦‚æœ node_modules æœ‰ç”¨åˆ° ES2015+ moduleï¼Œè¨˜å¾— babel config éœ€è¦é¡å¤–è™•ç† è£œæ›´ æœ€è¿‘çœ‹åˆ°çš„å¥½æ–‡ç« ï¼Œä½ çœŸçš„çŸ¥é“ Babel Transpile éå¾Œçš„ç¨‹å¼ç¢¼é•·æ€æ¨£å—ï¼Ÿ\nAvoiding Babelâ€™s Production Bloat\né€™ç¯‡æ–‡ç« æäº†å¹¾å€‹åƒ class / destructure / generator ç­‰èªæ³•å¦‚ä½•è¢« Babel è½‰è­¯æˆ ES5çš„èªæ³•ï¼Œæ•´å€‹ç¨‹å¼ç¢¼çš„è¤‡é›œåº¦èˆ‡é«”ç©éƒ½é©šäººçš„æˆé•·ï¼›\nå¦‚æœç¶²ç«™ä¸»è¦åœ¨èˆŠå‹ç€è¦½å™¨ï¼Œæœ€å¥½æ˜¯è€ƒæ…®ç”¨èˆŠçš„èªæ³•ã€‚\nå¥½è™• Module Size\nç¯€çœç´„ 50%! Parse TIme\nç¯€çœç´„ 55%! ","date":"2018-12-28T01:39:30.852Z","permalink":"https://yuanchieh.page/posts/2018/2018-12-28-%E6%84%9B%E7%94%A8-async-await-%E8%80%8C%E9%9D%9E-promise/","title":"æ„›ç”¨ async await è€Œé promise!"},{"content":"JS åŸºæ–¼äº‹ä»¶é©…å‹•ï¼Œå¤§é‡çš„ Promise å……æ–¥åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œå…¶å¾Œåœ¨ ES2017 åŠ å…¥äº† async/ await èªæ³•ç³–å¾Œï¼Œè®“éåŒæ­¥ä»£ç¢¼æ›´åŠ ç°¡æ½”èˆ‡ç›´è¦ºï¼›\nä½†æ˜¯ async / await ä¸å–®å–®æ˜¯èªæ³•ç³–ï¼Œå¾ä¸€é–‹å§‹æœƒæœ‰ä¸å°çš„ overheadï¼Œv8 team ä¸æ–·çš„å„ªåŒ–åˆ°ä»Šæ—¥èˆ‡åŸç”Ÿçš„ Promise chain æ•ˆèƒ½ä¸ç›¸ä¸Šä¸‹ï¼Œç”šè‡³ä½¿ç”¨ async / await æ•ˆèƒ½æ›´å„ªæ–¼ Promise chain äº†!\nä»¥ä¸‹å…§å®¹æ•´ç†è‡ª\nhttps://v8.dev/blog/fast-async#fn2\nåœ–ç‰‡ä¾†è‡ª v8Â å®˜ç¶²\nV8 åœ¨åŸ·è¡Œ async awaitæ™‚ï¼Œæœƒé€šéä¸€å€‹è½‰æ›ï¼Œæµç¨‹å¤§æ¦‚æ˜¯\nå…ˆå°‡ await è½‰æˆ promise åŠ ä¸Š Handlers åœæ­¢ function é‹ä½œä¸¦å›å‚³ implicit_promise å…¶ä¸­çš„åƒæ•¸ promise ç›®çš„æ˜¯ async function æœƒç­‰åˆ° await å®Œæˆæ‰æœƒä¸‹ä¸€æ­¥ ï¼›\nè€Œ throwaway promise å‰‡å¦æœ‰ä»–ç”¨ï¼Œç¨å¾Œæœƒè§£é‡‹\næ‰€ä»¥æ•´é«”ä¸Šä¸€å€‹ aysnc / await æœƒé€ æˆ 2å€‹é¡å¤–çš„ JSPromise ä»¥åŠ 3å€‹é¡å¤–çš„ Mircorticks!\nå„ªåŒ– å–æ¶ˆå° await function å¤šåŒ…ä¸€å±¤Â Promise å¤§å¤šæ•¸ await å¾Œé¢æ¥çš„éƒ½æ˜¯ promiseï¼Œé‚£ç‚ºä»€éº¼è¦åœ¨å¤šæµªè²»ä¸€å€‹ Promise å‘¢ï¼Ÿ\nç›´æ¥æ”¹ç”¨ promiseResolve()ï¼Œå¦‚æœåŸæœ¬æ˜¯ Promise å°±ç›´æ¥å›å‚³ï¼Œå¦‚æœä¸æ˜¯åœ¨å¤šåŒ…ä¸€å±¤ Promiseï¼Œå¦‚æ­¤å°±å¯èƒ½å„ªåŒ–æ‰ä¸€å€‹ Promise é‚„å…©å€‹ MicroTasksï¼\nç›´æ¥å›å‚³Promise è·Ÿå¤šåŒ…ä¸€å±¤ Promise æœ‰ä»€éº¼å·®åˆ¥å‘¢ï¼Ÿ\nåƒè€ƒgithub issue è¨è«–çš„å…¶ä¸­ä¸€å€‹æ¡ˆä¾‹\n**Normative: Reduce the number of ticks in async/await by MayaLekova\n1 2 3 4 5 6 7 8 9 10 11 async function f() { let promise = Promise.resolve(1); promise.then = function(...args) { console.log(\u0026#39;then called\u0026#39;); return Promise.prototype.then.apply(this, args); }; let result = await promise; return result; } f().then(v =\u0026gt; console.log(v)); å¯ä»¥è©¦è‘—åœ¨ Chrome 71 è·Ÿ 73(ç¾ç‚º Canaryç‰ˆ)åŸ·è¡Œï¼Œæœƒç™¼ç¾ 73 å„ªåŒ–éå¾Œä¸æœƒå†å° then called ï¼Œå› ç‚ºå°‘äº†ç”¨ Promise å¤šåŒ…ä¸€å±¤ï¼Œå·²ç¶“ resolved çš„ promise å°±æœƒç›´æ¥å›å‚³è€Œä¸æœƒåœ¨ call ä¸€æ¬¡ then functionã€‚\né€™éƒ¨åˆ†æœƒå½±éŸ¿å° Promise åš Monkey Patch çš„ç”¨æˆ¶ï¼Œæ‰€ä»¥åœ¨ github issue ä¸‹æœ‰ä¸åŒçš„è¨è«–ï¼Œå¯ä»¥çœ‹åˆ°ç¶­è­·è€…å°æ–¼èªè¨€åŠŸèƒ½ä¸Šèˆ‡ä¸€è‡´æ€§ä¸Šçš„å–æ¨ï¼Œå¤§è‡´ä¸Šå°±æ˜¯ä¸é¼“å‹µå° Promise.then åš Monkey Patchçš„æ“ä½œã€‚\nå»æ‰ internal promise ï¼šthrowaway åœ¨æ–‡ç« ä¸­æåˆ° throwaway ä¹‹æ‰€ä»¥å­˜åœ¨æ˜¯ç‚ºäº†æ»¿è¶³ Spec å°æ–¼performPromiseThen APIçš„æ“ä½œÂ (only there to satisfy the API constraints of the internal performPromiseThen operation in the spec.)\nå¾Œä¾†åˆ° Twitter ç™¼å•ï¼Œä½œè€…å›è¦†èªªã€ŒItâ€™s still there only when async hooks are enabled (in Node.js)â€Šâ€”â€Šthey attach some internal data on it.ã€\næ‰€ä»¥åœ¨ Nodejsé‚„æœƒä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ Browser å°±ä¸æœƒäº†ï¼Œé€™éƒ¨åˆ†çœ‹ä¾†ä¸ç”¨å¤ªåœ¨æ„ã€‚\nNodejs v8Â çš„å°Bug Nodejs åœ¨ version 8 æœ‰å·åšå„ªåŒ–ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ­¥çœæ‰ï¼Œå¦‚æœç™¼ç¾æ˜¯ await æ¥promise å°±ä¸æœƒå¤šåŒ…ä¸€å±¤ï¼Œå¯ä»¥ç”¨ v8 / v10 å°æ¯”è·‘ä¸‹åˆ—ç¨‹å¼\n1 2 3 4 5 6 7 8 const p = Promise.resolve(); (async () =\u0026gt; { await p; console.log(\u0026#39;after:await\u0026#39;); })(); p.then(() =\u0026gt; console.log(\u0026#39;tick:a\u0026#39;)) .then(() =\u0026gt; console.log(\u0026#39;tick:b\u0026#39;)); æœƒç™¼ç¾ version 8 çš„æ‰“å°çµæœæ˜¯ after:await -\u0026gt; tick:a -\u0026gt; tick:b ï¼Œè€Œ version 10 å‰‡æ˜¯ç¬¦åˆç›®å‰ Specçš„ tick:a -\u0026gt; tick:b -\u0026gt; after:await ã€‚\nversion 8 å› ç‚º p å·²ç¶“æ˜¯ resolved promiseæœƒåŸ·è¡ŒåŸ·è¡Œï¼›version 10 å¤šåŒ…ä¸€å±¤ Promise å°±æœƒç­‰åˆ°ä¸‹ä¸€æ¬¡ microtask queue åŸ·è¡Œæ™‚æœŸæ‰æœƒåŸ·è¡Œã€‚\né–‹ç™¼é‡é» è«‹ä½¿ç”¨åŸç”Ÿ JS Engine æä¾›çš„ Promiseï¼Œè€Œä¸æ˜¯å…¶ä»– JS Library çš„ Promiseæˆ–é Promise é¡å‹çš„å‡½ç¤ºï¼Œé€™æ¨£åœ¨åº•å±¤æœƒæœ‰æ›´å¥½çš„æ•ˆèƒ½å„ªåŒ– ( çœäº†å…©å€‹ Microtaskèˆ‡ä¸€å€‹å¤šé¤˜çš„ Promise )\n","date":"2018-12-25T13:06:04.006Z","permalink":"https://yuanchieh.page/posts/2018/2018-12-25-v8-%E5%A6%82%E4%BD%95%E5%84%AA%E5%8C%96-async-/-await/","title":"V8 å¦‚ä½•å„ªåŒ– async / await"},{"content":"Stripe æ˜¯ä¸€é–“åœ‹éš›çš„é‡‘æµæ”¯ä»˜å…¬å¸ï¼Œæä¾› client (Web / Android / iOSç­‰)æ”¯ä»˜ä»‹é¢èˆ‡ server-side APIï¼Œç”¨æœ€çŸ­çš„æ™‚é–“å°±å¯ä»¥è®“æœå‹™æ¥ä¸Šé‡‘æµï¼›\næ”¯æ´æ”¯ä»˜æ–¹å¼æœ‰Visa/Master Cardç­‰å¤šé–“ä¿¡ç”¨å¡æ”¯ä»˜ã€Google Pay ã€Apple Payç­‰ç­‰ï¼›\nå…¶ä¸­é‡‘æµäº¤æ˜“æœå‹™ï¼š\nå…¥é–€æœƒå“¡æœå‹™Payment(äº¤æ˜“)ã€Billing(é–‹ç«‹ç™¼ç¥¨)ã€Connect(ä¸­é–“å•†ï¼Œå‘Aæ”¶éŒ¢ä¸¦è½‰çµ¦Bå¤šå°‘éŒ¢)ï¼› å…¶ä»–éœ€è¦å¤šèŠ±éŒ¢çš„åŠ å€¼æœå‹™ï¼š\nSigma(æ”¯æ´SQLç”¢ç”Ÿå ±è¡¨)ã€Altas(ç¾åœ‹é–‹å…¬å¸)ã€Radar(é‡‘èè©é¨™åµæ¸¬ï¼Œé è¨­æœ‰æ”¯æ´ä½†ä»˜è²»æœ‰é€²éšåŠŸèƒ½) é‚€è«‹åˆ¶çš„åŠ å€¼æœå‹™ï¼š\nTerminal(æ•´åˆç¡¬é«”Readerï¼Œé™å®šæŒæœ‰è©²ç¡¬é«”æ‰èƒ½äº¤æ˜“)ã€Issuing(å¯ä»¥è‡ªå·±ç™¼å¡ï¼ŒStripe æä¾›è™›æ“¬å¡èˆ‡å¯¦é«”å¡ç™¼é€) é€™æ¬¡ä¸»è¦å˜—è©¦ Payment / Billing çš„ä¸²æ¥ï¼Œå…§å®¹åƒè€ƒè‡ªå®˜æ–¹æ–‡ä»¶ï¼ŒåŒ…å« client-side(æ¡ç”¨ React) èˆ‡ server-side(æ¡ç”¨ Nodejs SDK)ï¼Œä¸å¾—ä¸èªª Stripeå°æ–¼é–‹ç™¼è€…éå¸¸å‹å–„ï¼Œæ–‡ä»¶éå¸¸å¥½æ‡‚ä¸”å„å¼èªè¨€èˆ‡æ’ä»¶SDKéƒ½æ”¯æ´å®Œæ•´ï¼Œæ‰€ä»¥åªéœ€è¦å°‡SDKæ›æ‰æˆ‘æƒ³ä»¥ä¸‹çš„æ¦‚å¿µéƒ½æ˜¯ç›¸åŒçš„ã€‚\n2018/11: å…¨çƒåœ°å€éƒ½å¯ä»¥ä»˜æ¬¾ï¼Œåªæ˜¯è¦é–‹é€š stripeå¸³æˆ¶åªæœ‰26å€‹åœ‹å®¶ï¼Œç›®å‰ä¸æ”¯æ´å°ç£\nä¸»è¦ä»‹ç´¹ Payment / Billing çš„æ¦‚å¿µï¼Œä»¥åŠè©¦åœ–ç†è§£ StripeèƒŒå¾Œçš„é‹è¡Œæ©Ÿåˆ¶\nPayment åˆ†æˆå…©æ­¥é©Ÿï¼Œåœ¨client-side ç½®å…¥ stripe ä»˜è²»å…ƒä»¶(å¦‚ html form)ï¼Œç”¨æˆ¶è¼¸å…¥å¾Œæœƒç”¢ç”Ÿ tokenè½‰äº¤çµ¦ serverï¼Œæ¥è‘— server ç”¨æ­¤ tokené©—è­‰ä¸¦å¯¦éš›æ‰£æ¬¾\nåœ¨Stripe ä¸­ï¼Œå®ƒå®šç¾©å¾ˆå¤šç‰©ä»¶ï¼Œæ¯å€‹ç‰©ä»¶éƒ½æœ‰å„è‡ªåƒæ•¸èˆ‡å°è£çš„ç”¨æ³•ï¼Œæ‰€ä»¥æ–‡ä»¶éå¸¸çš„ OOPï¼Œæ‰€ä»¥å°é–‹ç™¼è€…ä¾†èªªå¾ˆå¥½ç†è§£èˆ‡ä¸Šæ‰‹\nCheckout Checkout æ˜¯ä¸€å€‹ Stripe æä¾›ç°¡åŒ–éå¾Œçš„ Paymentæ–¹å¼ï¼Œ é–‹ç™¼è€…åªè¦æ¥ä¸Š Stripe æä¾›çš„ Client SDKï¼Œç”¨æˆ¶çš„äº¤æ˜“ç´°ç¯€å°±æœƒç›´æ¥ä¸Ÿçµ¦ Stripe è™•ç†ä¸¦ä»¥ Tokenæ–¹å¼å›å‚³ï¼Œé–‹ç™¼è€…å†å» Server Side æ‹¿ Tokenåšå¾ŒçºŒçš„æ‡‰ç”¨ã€‚\næ•´åˆ Stripe Client-sideæœ‰å…©ç¨®æ¨¡å¼ Simpleã€Custom\nSimple ç”¨ä¸€å€‹ \u0026lt;form/\u0026gt; å®šç¾©å¦‚ä½•è½‰äº¤çµ¦tokençµ¦ serverï¼Œæ¥è‘—å…§éƒ¨åµŒå…¥ stripe script ä¸¦å®šç¾©åƒæ•¸ï¼Œæœ€åŸºæœ¬çš„å¹¾å€‹åƒæ•¸\n1 \u0026lt;form action=\u0026#34;your-server-side-code\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;script src=\u0026#34;https://checkout.stripe.com/checkout.js\u0026#34; class=\u0026#34;stripe-button\u0026#34; data-key=\u0026#34;YOUR_KEY\u0026#34; data-amount=\u0026#34;999\u0026#34; data-name=\u0026#34;COMPANY\u0026#34; data-description=\u0026#34;Example charge\u0026#34; data-image=\u0026#34;https://stripe.com/img/documentation/checkout/marketplace.png\u0026#34; data-locale=\u0026#34;auto\u0026#34; data-currency=\u0026#34;hkd\u0026#34;\u0026gt; \u0026lt;/script\u0026gt;\u0026lt;/form\u0026gt; å°ï¼Œå°±é€™éº¼ç°¡å–®å°±å®Œæˆäº†ï¼Œæ¥è‘—å°±æ˜¯åˆ° formå®šç¾©çš„ server api æ”¶ tokenè³‡æ–™\nCustom å¦‚æœå¸Œæœ›æœ‰æ›´ç´°ç·»çš„ç”¨æˆ¶é«”é©—ï¼Œä¾‹å¦‚å®¢è£½åŒ–è‡ªå·±çš„ä»˜è²»è¡¨å–®ã€é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ç­‰ï¼Œå°±éœ€è¦è‡ªå·±å®¢è£½åŒ–ï¼Œé€™éƒ¨åˆ†ä¹Ÿååˆ†çš„ç°¡å–®ï¼Œç”¨ vanilla js ä¹Ÿå¯ä»¥è¼•é¬†å®Œæˆ\né€™éƒ¨åˆ†ç¨‹å¼ç¢¼å¯ä»¥åƒè€ƒæ–‡ä»¶\nåƒæ•¸è¨­å®š ä»¥ä¸Šçš„ Simple/Custome å°±æ˜¯ä¸€å€‹åŸºæœ¬çš„ Elementï¼Œè£¡é ­å®šç¾©çš„ data-* å±¬æ€§å‰‡æœƒæ±ºå®šç”¢ç”Ÿçš„ Checkout ç‰©ä»¶å±¬æ€§ï¼Œå¸¸è¦‹çš„å±¬æ€§æœ‰\ndata-key [required] ç•¶å¸³è™ŸæˆåŠŸæ¿€æ´»å¾Œï¼Œæœƒæœ‰å…©çµ„ key / secret çµ„åˆï¼Œåˆ†åˆ¥æ˜¯ live / test ï¼Œå°æ‡‰å°±æ˜¯æ­£å¼æ©Ÿèˆ‡æ¸¬è©¦æ©Ÿçš„æ¦‚å¿µ token / source [required in custom mode]\né€™å…©å€‹å°æ‡‰ callback functionï¼Œåˆ†åˆ¥å°æ‡‰æ”¶åˆ° Token / Sourceï¼ŒTokenä¸»è¦æ˜¯serverå¯ä»¥å–å¾—ç”¨æˆ¶çš„éƒ¨åˆ†ä¿¡ç”¨å¡è³‡æ–™ï¼ŒSourceå‰‡æ˜¯ä»£è¡¨ç”¨æˆ¶çš„å…¶ä»–ä»˜æ¬¾æ–¹å¼(é€™äº›è³‡æ–™çš„å–å¾—è¦é€éå¾ŒçºŒçš„åƒæ•¸è¨­å®š) data-name / data-description / data-image / data-locale / data-amount [highly recommend]\nå°æ‡‰æœƒé¡¯ç¤ºåœ¨ stripe ä»˜è²»é é¢çš„è³‡è¨Šï¼Œlocaleæ˜¯è¨­å®šè¡¨å–®èªè¨€ data-zip-code / data-billing-address [highly recommend] ç”¨æˆ¶çš„åœ°å€ç›¸é—œï¼ŒStripeæ¨è–¦å‘ç”¨æˆ¶ç´¢å– zip-codeï¼Œzip-codeå¯ä»¥åœ¨å¾Œå°è¨­å®šç•¶ä½œ Radarçš„é©—è­‰æ¢ä»¶ï¼Œç¦æ­¢å¯ç–‘çš„Payment data-email / open / close [optional]Â é‚„æœ‰ä¸€äº›æ¬„ä½å¯ä»¥å®šç¾©å°±ç¿»æ–‡ä»¶äº†ï¼Œopen / closeå‰‡æ˜¯ callback functionæœƒåœ¨è¡¨å–®é–‹å•Ÿèˆ‡é—œé–‰æ™‚å€™å‘¼å«ï¼ŒåŒæ¨£åªç”¨æ–¼ custom mode ç‰¹åˆ¥æ³¨æ„ï¼Œé–‹ç™¼è€…å®Œå…¨ä¸éœ€è¦æ¥è§¸åˆ°ç”¨æˆ¶çš„ä¿¡ç”¨å¡è³‡æ–™ï¼Œåœ¨æ²’æœ‰è¬¹æ…è©•ä¼°ä¹‹å‰ï¼Œä¸è¦å¦„æƒ³å„²å­˜ç”¨æˆ¶ä¿¡ç”¨å¡è³‡æ–™ï¼\nå› ç‚ºå¦‚æœè¦ã€Œåˆæ ¼ã€å„²å­˜ç”¨æˆ¶ä¿¡ç”¨å¡è³‡æ–™ï¼Œå¿…é ˆé PCI-DSS åœ‹éš›ä¿¡ç”¨å¡çµ„ç¹”è¯åˆè¦ç¯„çš„æ”¯ä»˜å®‰å…¨èªè­‰ï¼Œä½†é€™éƒ¨åˆ†è¦ç¯„åš´æ ¼ï¼Œè€Œä¸”å¿…é ˆå®šæœŸåšæ¼æ´æƒæ\næ‰€ä»¥ Stripe ä¹Ÿæåˆ°ä»–å€‘ç‚ºäº†è®“é–‹ç™¼è€…ä¾¿åˆ©ï¼Œæ‰€ä»¥ä¿¡ç”¨å¡è³‡æ–™éƒ½é‚„æ˜¯é€šéä»–å€‘ï¼Œåƒ…å›å‚³ Tokenå½¢å¼ä¾›å¾ŒçºŒæ‰£æ¬¾ä½¿ç”¨ï¼Œä¸ç”¨å†å¤šç…©æƒ±é€™äº›è³‡å®‰ä¸Šçš„å•é¡Œ\nServer-side å‰ç«¯å–å¾— Token å¾Œï¼Œå°±å¯ä»¥å¾€ server ä¸Ÿï¼Œé€™å€‹ Tokenæ˜¯ä¸€æ¬¡æ€§æ‰£æ¬¾ä½¿ç”¨ï¼Œæ­¤å¤–å°±ç­‰åŒæ–¼ Sourceçš„æ•ˆåŠ›ï¼Œä¹Ÿå°±æ˜¯ç”¨æ–¼å¯¦éš›æ‰£æ¬¾çš„æ”¯ä»˜æ–¹å¼ï¼Œå¾ŒçºŒæœƒè©³ç´°ä»‹ç´¹ä»€éº¼æ˜¯ Source\nä»¥ä¸Šæ˜¯æœ€åŸºæœ¬çš„ Checkout ä¿¡ç”¨å¡ä»˜æ¬¾ï¼Œå› ç‚ºä¿¡ç”¨å¡æ˜¯ç«‹å³æ‰£æ¬¾å°±èƒ½çŸ¥é“çµæœï¼Œä½†å¦‚æœéœ€è¦æ”¯æ´å¦‚éŠ€è¡Œè½‰å¸³ç­‰å…¶ä»–éœ€è¦ç”¨æˆ¶é¡å¤–æˆæ¬Šèˆ‡æ”¯ä»˜çš„æµç¨‹ï¼Œå°±éœ€è¦ä»¥ä¸‹æ›´è¤‡é›œçš„è¨­è¨ˆ\nå¤šå…ƒæ”¯ä»˜æ–¹å¼ Stripeé€éç”¢ç”Ÿ Source ç‰©ä»¶ä»£è¡¨ä¸åŒçš„æ”¯ä»˜æ–¹å¼ï¼Œæ”¯ä»˜æ¦‚å¿µä¸Šå¯ä»¥åˆ†æˆ\nä»˜æ¬¾æ˜¯åŒæ­¥èˆ‡éåŒæ­¥å®Œæˆ(async vs sync) éŒ¢å¦‚ä½•å¾ç”¨æˆ¶è½‰å‡º(push vs pull) æ˜¯å¦å¯é‡è¤‡ä½¿ç”¨(reusable)\nä¾‹å¦‚èªªä¿¡ç”¨å¡å°±æ˜¯ sync + pull ï¼Œç•¶ç”¨æˆ¶è¼¸å…¥ä¿¡ç”¨å¡å¾Œï¼Œå°±æœƒç«‹åˆ»åŸ·è¡Œæ‰£æ¬¾å‹•ä½œ(sync)ï¼Œå°±ç›´æ¥å¾ç”¨æˆ¶å¸³æˆ¶æ‰£æ¬¾æˆ–æ˜¯ç”¢ç”Ÿæ”¯ä»˜ç´€éŒ„(pull)\nè€ŒåƒéŠ€è¡Œç”¢ç”Ÿè™›æ“¬å¸³è™Ÿæä¾›ATMä»˜æ¬¾æ˜¯ async + pushï¼Œç”¨æˆ¶å¯èƒ½åœ¨éå¹¾å¤©æ‰å»ä»˜æ¬¾(async)ï¼Œè€Œç”¨æˆ¶æœ¬èº«éœ€è¦ä¸»å‹•å»ç”¢ç”Ÿæ”¯ä»˜çš„å‹•ä½œ(èµ°åˆ°ATMå‰é¢ï¼Œä¹Ÿå°±æ˜¯ push)\nå…¶ä»–é‚„æœ‰å¤šç¨®åœ°åŸŸæ€§çš„æ”¯ä»˜æ–¹å¼ï¼Œå› ç‚ºä¸ç†Ÿæ‚‰å°±ä¸å†å¤šæ•˜è¿°ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶\nSource ç‰©ä»¶å»ºç«‹åˆå§‹åŒ–ç‚º source.pendingï¼Œæœ‰ webhook å¯ä»¥æ¥æ”¶ç‹€æ…‹çš„æ”¹è®Šï¼Œç•¶ç”¨æˆ¶æˆæ¬Šå¾Œæœƒè§¸ç™¼source.chargeable ã€ç”¨æˆ¶æ‹’çµ•æˆæ¬Šsource.failed ã€éæœŸsource.canceled\nSource æ­¤æ™‚åƒ…ä»£è¡¨æ”¯ä»˜æ–¹å¼ï¼Œå¯¦éš›çš„æ”¯ä»˜è¦é€é Source å»ºç«‹ Charge ç‰©ä»¶ï¼ŒCharge ç‰©ä»¶åŒæ¨£æœ‰å¹¾å€‹ webhook å¯ä»¥ä¸²æ¥ï¼ŒéåŒæ­¥æ”¯ä»˜åˆå§‹åŒ–æœƒæ˜¯ç­‰å¾…ç”¨æˆ¶æ”¯ä»˜charge.pending ã€æˆåŠŸæ”¶åˆ°ç”¨æˆ¶æ”¯ä»˜charge.succeeded ã€èˆ‡æ”¯ä»˜å¤±æ•—charge.failed\nwebhook éƒ¨åˆ†å‰‡æ˜¯åœ¨å¾Œå°è¨­å®šã€‚\nä»¥ä¸‹æ“·å–å®˜æ–¹æ¡ˆä¾‹ï¼Œåƒ…ä½œæ–¼ç†è§£ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 stripe.createSource({ type: \u0026#39;ach_credit_transfer\u0026#39;, currency: \u0026#39;usd\u0026#39;, owner: { email: \u0026#39;jenny.rosen@example.com\u0026#39;, },}).then(function(result) { // é€™è£¡æœƒå›å‚³ SourceåŸºæœ¬è³‡æ–™å¦‚ idç­‰ // é‚„æœ‰ç”¨æˆ¶éœ€è¦çŸ¥é“çš„è½‰å¸³è³‡è¨Šå¦‚éŠ€è¡Œå¸³è™Ÿ }); // æ›webhookï¼ŒæŒ‡å®šsource.chargeable app.post(\u0026#34;/webhook/to/source.chargable\u0026#34;, (req, res) =\u0026gt; { console.log(req.body.read) }) æŸäº›æ”¯ä»˜æ–¹å¼æ˜¯å¯ä»¥å¤šæ¬¡æ‰£æ¬¾ï¼Œä¾‹å¦‚ä¿¡ç”¨å¡ï¼ŒStripe æä¾› Customer æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å‰µå»ºä¸€å€‹ Customer ä»£è¡¨ç”¨æˆ¶ï¼Œæ¥è‘—å°‡ Source ç¶å®šåˆ°è©²ç”¨æˆ¶ä¸Šï¼Œä¸€å€‹ç”¨æˆ¶å¯ä»¥ç¶å®šå¤šå€‹ Sourceï¼Œåˆ°æ™‚å€™å¦‚æœè¦æ‰£æ¬¾å¯ä»¥å¾ Sourceä¸­é¸æ“‡å…¶ä¸­ä¸€å€‹ï¼Œç›¸ç•¶çš„æ–¹ä¾¿\néœ€æ³¨æ„ Source å¿…é ˆæ˜¯ chargable æ‰å¯ä»¥æ‰£æ¬¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // å»ºç«‹ customer stripe.customers.create({ email: \u0026#34;paying.user@example.com\u0026#34;, source: \u0026#34;src_18eYalAHEMiOZZp1l9ZTjSU0\u0026#34;, }, function(err, customer) { // asynchronously called }); // å¦‚æœè¦æ‰£æ¬¾çš„è©± stripe.charges.create({ amount: 1099, currency: \u0026#34;eur\u0026#34;, customer: \u0026#34;cus_AFGbOSiITuJVDs\u0026#34;, source: \u0026#34;src_18eYalAHEMiOZZp1l9ZTjSU0\u0026#34;, // å¯ä»¥ä¸æŒ‡å®š sourceï¼Œæœƒè‡ªå‹•æ‰¾ customer é è¨­çš„ source }, function(err, charge) { // asynchronously called }); å°çµ! çœ‹åˆ°æ˜¯ä¸æ˜¯æœ‰é»æšˆé ­è½‰å‘äº†å‘¢ï¼Œèªªå¥½çš„ Stripe å¾ˆç°¡å–®å‘¢ï¼ŸÂ æˆ–è¨±é€™ä¹Ÿæ˜¯ç¨® simplicity but not simpleï¼Œè¦æä¾›å¤šå…ƒçš„æ”¯ä»˜æ–¹å¼å‹¢å¿…å¸¶ä¾†é‚è¼¯çš„è¤‡é›œæ€§ï¼Œä½†æ˜¯æˆ‘è¦ºå¾— Stripe é€é OOPæ¢³ç†æ•´å€‹é‡‘èæ”¯ä»˜çš„éç¨‹ï¼Œå¸¶ä¾†æ¥µæ£’çš„ Developer Experienceèˆ‡ User Experienceï¼Œæ¥éå°ç£çš„ç´…è—ç¶ ä½ å°±æœƒçŸ¥é“Stripe æœ‰å¤šæ£’äº†\nå»¢è©±ä¸å¤šèªªï¼Œè®“æˆ‘ä¾†é‡æ–°æ•´ç†ä¸€ç¿»\næœ€ä¸€é–‹å§‹æçš„ Checkout ä¿¡ç”¨å¡æ”¯ä»˜å–å¾—çš„Tokenï¼Œç®—æ˜¯ Sourceçš„ç°¡åŒ–ç‰ˆï¼Œæˆ‘çŒœç›®çš„æ˜¯ç‚ºäº†è®“æœ€å¿«é€Ÿæ¥ä¸²å¥½é‡‘æµçš„ä½œæ³•ï¼Œè€Œä¸”ä¿¡ç”¨å¡çš„æ”¯ä»˜è¡Œç‚ºç®—æ˜¯æœ€ç°¡å–®çš„ã€‚\nBillings ç”¨æ–¼é‡è¤‡æ€§æ‰£æ¬¾èˆ‡é–‹ç«‹ç™¼ç¥¨\nç™¼ç¥¨ç‹€æ…‹æµç¨‹ Invoiceï¼Œä»£è¡¨ç™¼ç¥¨çš„ç‰©ä»¶ï¼Œä¸€å¼µç™¼ç¥¨å¯ä»¥å¤šç­†æ¬¾é … InvoiceItemsï¼Œå› ç‚ºä¸åŒçš„è²¡å‹™è¦åŠƒè€Œæœ‰æ¯”è¼ƒå¤šçš„ç‹€æ…‹å¯ä»¥è¨­\nåˆå§‹åŒ–ç‚º draft ï¼Œæ­¤æ™‚ç™¼ç¥¨çš„è¨­å®šéƒ½é‚„å¯ä»¥åšèª¿æ•´ï¼Œç¢ºå®šå¾Œæˆ–æ˜¯é è¨­ä¸€å€‹å°æ™‚å¾Œæœƒè®Šæˆ open ï¼›\nåˆªé™¤å°±è®Šæˆ deleted open å‰‡ä»£è¡¨ç™¼ç¥¨ç¢ºèªäº†ï¼Œå¦‚æœç”¨æˆ¶ä»˜æ¬¾äº†å¯ä»¥èª¿æ•´ç‚º paid ï¼Œå¯ä»¥é¸æ“‡è§¸ç™¼å¾ŒçºŒçš„ç™¼ç¥¨å¯„é€ç­‰æµç¨‹ï¼›\nå¦‚æœç™¼ç¾ç”¨æˆ¶ç ´ç”¢ä¹‹é¡ç„¡æ³•æ”¯ä»˜ï¼Œå¯ä»¥åœ¨å¾Œå°å°‡æ­¤ç­†ç™¼ç¥¨è¨­å®šç‚º uncollectible ï¼›\nå¦‚æœç™¼ç¥¨æœ‰èª¤éœ€è¦ä½œå»¢ï¼Œå‰‡è¨­ç‚º Void ä¸€æ¬¡æ€§é–‹ç«‹ç™¼ç¥¨ one-offÂ invoices 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 var stripe = require(\u0026#34;stripe\u0026#34;)(\u0026#34;sk_test_AyGgRZ5ZZkIETGtHDI3f1GAE\u0026#34;); // å…ˆå»ºç«‹ç™¼ç¥¨ stripe.invoiceItems.create({ customer: \u0026#34;cus_DqZrTNCO4puf2p\u0026#34;, amount: 2500, currency: \u0026#34;usd\u0026#34;, description: \u0026#34;One-time setup fee\u0026#34; }, function(err, invoiceItem) { // é‡å°æŸå€‹ç”¨æˆ¶åº•ä¸‹æ‰€æœ‰çš„InvoiceItemsé–‹ç«‹ç™¼ç¥¨ stripe.invoices.create({ customer: \u0026#34;cus_4fdAW5ftNQow1a\u0026#34;, auto_advance: true // auto-finalize this draft after ~1 hour }, function(err, invoice) { // asynchronously called }); }); auto_advance ç®—æ˜¯å¾ˆé‡è¦çš„åƒæ•¸ï¼ŒStripe é è¨­åœ¨ Invoice å‰µå»ºä¹‹å¾Œæœƒæœ‰è‡ªå‹•åŒ–çš„å‹•ä½œï¼Œå¦‚ä¸€å°æ™‚å¾Œè‡ªå‹•è½‰æˆ open**ï¼Œä¸¦æœƒå‘ç”¨æˆ¶è‡ªå‹•æ‰£æ¬¾ (é è¨­ Source)æ¥è‘—è½‰æˆ** paidï¼Œä¸¦Email ç™¼é€ Receipt èˆ‡ Invoiceï¼›\nå¦‚æœä¸æƒ³è¦è¨˜å¾—è¨­ç‚º false\nåœ¨é–‹ç«‹ç™¼ç¥¨ä¸Š Stripe éˆæ´»æ€§é —é«˜ï¼Œæ¯ä¸€ç­† InvoiceItem å¯ä»¥è¨­å®šè²»ç”¨/æŠ˜æ‰£/ç¨…ç‡ï¼ŒInvoiceItem å¯ä»¥æŒ‡å®šæ‰€å±¬çš„ Invoiceï¼Œæˆ–æ˜¯é è¨­æ­¸é¡åˆ°è©²ç”¨æˆ¶çš„ä¸‹ç­† open çš„Invoiceä¸­\nè¨‚é–±åˆ¶æ‰£æ¬¾æœå‹™ subscription æœ‰äº›é›²ç«¯æœå‹™éƒ½æ˜¯ä»¥å¹´æˆ–æ˜¯æœˆçš„è¨‚é–±æ”¶è²»åˆ¶åº¦ï¼ŒStripe ä¸­å¯ä»¥å®šç¾© Product èˆ‡ Planï¼Œä¾‹å¦‚èªªæœ‰ä¸€å€‹ Product æ˜¯ SaaSæœå‹™\n1 2 3 4 5 6 7 const product = stripe.products.create({ name: \u0026#39;My SaaS Platform\u0026#39;, type: \u0026#39;service\u0026#39;, metadata: { // store anything you want } }); é‡å°é€™å€‹ Productï¼Œå¯èƒ½æœƒæœ‰è¨±å¤šçš„æ”¶è²»æ–¹å¼ Planï¼Œå¯èƒ½æ˜¯æœˆç¹³/å­£ç¹³/å¹´ç¹³æˆ–æ˜¯æœ‰ä¸åŒçš„é©ç”¨æœŸé™ã€ä¹Ÿå¯èƒ½æœ‰å¤šç¨®åœ‹å®¶çš„ä¸åŒå®šåƒ¹ç­‰è¨­å®š\n1 2 3 4 5 6 7 const plan = stripe.plans.create({ product: \u0026#39;prod_CbvTFuXWh7BPJH\u0026#39;, nickname: \u0026#39;SaaS Platform USD\u0026#39;, currency: \u0026#39;usd\u0026#39;, interval: \u0026#39;month\u0026#39;, amount: 10000, }); Stripe æ”¯æ´åˆ†å±¤æ”¶è²»ï¼Œå¯ä»¥æŒ‡å®šå¤šç¨®æ¨¡å¼ï¼Œä¾‹å¦‚ ç•¶è¶…éä¸€å€‹é¡åº¦ï¼Œæ¯å€‹å•†å“è®Šå¤šå°‘éŒ¢ / åˆæˆ–æ˜¯åˆ†å¤šéšå±¤ï¼Œè¶…ééƒ¨åˆ†ç®—è©²åƒ¹æ ¼çš„éšæ¢¯å½¢æ”¶è²»\nç•¶å…ˆå‰çš„ Customeæƒ³è¦è³¼è²·æ™‚ï¼Œæœƒå‰µå»ºä¸€å€‹è¨‚é–± Subscription çš„ç‰©ä»¶ï¼Œä¸¦æ±ºå®šè¦è¨‚é–±çš„ Planï¼Œå¦‚æœè¦ä¸€å€‹è¨‚é–±å¤šå€‹ Planï¼Œé€™äº› Planå¿…é ˆå¹£åˆ¥ç›¸åŒä¸”æ”¶è²»å€é–“ä¸€è‡´ï¼›\n1 const subscription = stripe.subscriptions.create({ customer: \u0026#39;cus_4fdAW5ftNQow1a\u0026#39;, coupon: \u0026#39;free-period\u0026#39;, tax_percent: 6.34, trial_end: 1542721841, items: [{ plan: \u0026#39;plan_CBXbz9i7AIOTzr\u0026#39; }, { plan: \u0026#39;plan_IFuCu48Snc02bc\u0026#39;, quantity: 2, }],}); æ­¤å¤–ï¼Œé‚„æœ‰Coupon å¯ä»¥è¨­å®šï¼Œæ”¯æ´ä¸€æ¬¡æ€§ / æ°¸ä¹…æ€§ / æ¯æ¬¡æ‰£æ¬¾ç”¨ï¼Œé‚„æœ‰ %è·Ÿæ•¸é‡çš„è¨­å®šï¼Œç›¸ç•¶æœ‰å½ˆæ€§\n1 const coupon = stripe.coupons.create({ duration: \u0026#39;once\u0026#39;, id: \u0026#39;free-period\u0026#39;, percent_off: 100,}); å»ºç«‹ subscription åœ¨æ²’æœ‰åœæ­¢ä¹‹å‰ï¼ŒStripe æœƒè‡ªå‹•ä¾ç…§æ™‚é–“å®šæœŸæ‰£æ¬¾ï¼Œä¸¦è‡ªå‹•é–‹ç«‹ç™¼ç¥¨(å¯é—œé–‰)ï¼Œç›¸ç•¶çš„æ–¹ä¾¿ã€‚\nå‡ç´šæˆ–é™ç´š å¦‚æœç”¨æˆ¶è¨‚é–±äº†æ™®é€šç‰ˆï¼Œåœ¨æœˆä¸­æ™‚çªç„¶æƒ³å‡ç´šåˆ°å°ˆæ¥­ç‰ˆï¼Œè©²æ€éº¼è™•ç†å‘¢ï¼Ÿ\nå¯ä»¥é¸æ“‡å°‡è©²ç”¨æˆ¶çš„ subscription ç‰©ä»¶ä¿®æ”¹ï¼Œæ›´æ–°è¨‚é–±çš„ Plan\n1 2 3 4 5 6 7 8 stripe.subscriptions.update(\u0026#39;sub_49ty4767H20z6a\u0026#39;, { cancel_at_period_end: false, items: [{ id: subscription.items.data[0].id, plan: \u0026#39;plan_CBb6IXqvTLXp3f\u0026#39;, }], proration_date: proration_date // Optionalï¼Œè©³çœ‹ä¸‹æ–¹æµç¨‹ }); æ›´æ–°å®¹æ˜“ï¼Œä½†æ˜¯å¯¦éš›çš„æ‰£æ¬¾æµç¨‹å¿…é ˆå°æ‡‰æ¥­å‹™é‚è¼¯çš„è™•ç†ï¼Œä¹Ÿå°±æ˜¯æ”¶è²»çš„æ–¹å¼ï¼›\nä¾‹å¦‚å¹¾ç¨®æ¡ˆä¾‹\n1/1é–‹å§‹è¨‚é–± PlanA $30/moï¼Œæ¥è‘—å† 1/15 å‡ç´šåˆ° PlanB $45/mo\nå› ç‚ºéƒ½æ˜¯æ¯æœˆæ‰£æ¬¾ï¼Œæ‰€ä»¥ Stripe é è¨­æœƒåœ¨ 2/1 é–‹å§‹æ”¶ PlanB ä¹Ÿå°±æ˜¯ $45å…ƒï¼Œæ‰€ä»¥ç†è«–ä¸Šæ‡‰è©²åœ¨ 2/1æ‰å°‡ç”¨æˆ¶å‡ç´šåˆ° PlanBçš„æœå‹™ åŒä¸Šï¼Œä½†æ˜¯ç”¨æˆ¶å¸Œæœ› 1/15å°±å‡ç´šåˆ°PlanB\né€™æ™‚å€™æœ‰å…©ç¨®åšæ³•\na. è‡ªå·±æ‰‹å‹•é–‹ç«‹ Invoiceï¼Œé–‹ç«‹Invoiceç•¶ä¸‹å°±æœƒæ‰£æ¬¾ä¸¦ç”¢ç”Ÿç™¼ç¥¨\nb. è¨­ç«‹ Prorationï¼Œé€™æ˜¯ Stripe æä¾›çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨ update subscription æ™‚æŒ‡å®š proration_data ï¼ŒStripe æœƒåœ¨ä¸‹ä¸€æ¬¡æ”¶è²»æ™‚é–“å¤šé–‹ç«‹é€™éƒ¨åˆ†çš„é‡‘é¡ å¦‚æœç”¨æˆ¶å¾æœˆä»˜è²»æ”¹æˆå¹´ä»˜è²»ï¼Œæœƒç«‹å³æ‰£æ¬¾ å¦‚æœ1/1å·²ç¶“æ‰£æ¬¾ PlanAçš„éŒ¢ï¼Œç”¨æˆ¶ 1/15å–æ¶ˆï¼ŒStripe é è¨­ä¸æœƒé€€æ¬¾ï¼›\nä¹Ÿå¯ä»¥è¨­å®š cancel_at_period_endï¼Œè®“ç”¨æˆ¶åœ¨æœˆåº•æ‰å–æ¶ˆè³‡æ ¼ï¼›\nå¦‚æœæœ‰é¡å¤–ç”¢ç”Ÿçš„ä»£ä»˜æ¬¾é …æœï¼Œå¿…é ˆè¦æ‰‹å‹•æ¸…é™¤ Invoiceæ‰ä¸æœƒåœ¨æœˆåº•å¤šæ‰£æ¬¾ä¸€æ¬¡ å°çµäºŒ åŒæ•´ä¸€ä¸‹ Invoice / Invoice Item / Product / Plan / Subscription é—œä¿‚\nç¸½çµ å¦‚æœè¦ä¸€æ¬¡æ€§ä»˜è²»ï¼Œå‰‡å¯ä»¥ä½¿ç”¨ Paymentï¼Œä¸” Payment ä¸éœ€è¦ç¶å®š Customerï¼ŒåŒæ¨£æœƒé–‹ç«‹ç™¼ç¥¨ï¼›\nä»¥ä¸‹æ›´è¤‡é›œçš„æ‰£æ¬¾æ–¹å¼æ–¹å¼è¦å…ˆåœ¨ Stripe å»ºç«‹ Customerï¼Œå¯ä»¥åˆ©ç”¨ Invoiceï¼Œåˆ†æ¬¡å»ºç«‹ Invoice Itemï¼Œæœ€å¾Œå†ä¸€æ¬¡é–‹åœ¨ä¸€å¼µ Invoice ä¸‹å®Œæˆæ‰£æ¬¾ï¼›\nåˆæˆ–æ˜¯å»ºç«‹ Product èˆ‡å°æ‡‰çš„ä»˜è²»æ©Ÿåˆ¶ Planï¼Œä¸¦ç”¨ Customer è§’è‰²è¨‚é–± Subscriptionï¼Œ Stripeæœƒè™•ç†å®šæœŸæ‰£æ¬¾ç­‰æ©Ÿåˆ¶ï¼›\nçµåˆ Coupon å¯ä»¥æä¾›å½ˆæ€§çš„æŠ˜åƒ¹æ©Ÿåˆ¶ã€‚\nç¸½é«”ä¸Š Stripe æœ€è®“æˆ‘è¦ºå¾—æ–¹ä¾¿çš„æ˜¯ Dashboard å¯ä»¥è¨­å®šï¼Œé€™æ¨£å°±å¯ä»¥å°‘è“‹ä¸€å€‹å¾Œå°è‡ªå·±éº»ç…©ï¼Œè€Œä¸”æŠŠCustomer / Payment / Billing ç­‰åˆ†é–€åˆ¥é¡ï¼Œä»¥åŠå€‹åˆ¥å­é …ç›®ï¼Œéå¸¸å¥½ç®¡ç†é‡‘æµæœå‹™ã€‚\n","date":"2018-11-17T07:53:08.683Z","permalink":"https://yuanchieh.page/posts/2018/2018-11-17-stripe-%E4%B8%B2%E9%87%91%E6%B5%81%E6%95%99%E5%AD%B8-%E4%B8%8A/","title":"Stripe ä¸²é‡‘æµæ•™å­¸ (ä¸Š)"},{"content":"åœ¨ MongoDBä¸­ï¼Œå…¶ Isolation èˆ‡ SQLæ¨™æº–å®šç¾©çš„ Isolation Levelä¸åŒï¼Œç•¢ç«ŸNoSQLæ³¨é‡æ–¼æµ·é‡è®€å¯« ã€é›†ç¾¤å¼çš„æ‡‰ç”¨å ´æ™¯ï¼Œè‡ªç„¶æ‰€é¢å°çš„å•é¡Œä¹Ÿå°±å·®ç•°å¾ˆå¤šï¼Œä½†ä¹Ÿå› æ­¤åœ¨é¢è‡¨ Concurrency æ™‚çš„è®€å¯«ä¿è­‰å•é¡Œï¼Œä»¥ä¸‹æ˜¯é–±è®€å®˜æ–¹æ–‡ä»¶ä¸¦æ•´ç†çš„çµæœã€‚\nRead Isolation, Consistency, and Recency - MongoDB Manual\nIsolation level æ­£å¦‚åŒ SQL ä¸åŒçš„ Isolation è©¦åœ–åœ¨æ¯ä¸€å±¤è§£æ±ºä¸åŒçš„å•é¡Œ (dirty read/ unrepeatable read / phantom read) çš„å•é¡Œï¼ŒåŒæ¨£åœ¨ MongoDBä¸­ä¹Ÿæœ‰å¹¾ç¨®Isolation level\nRead Uncommitted Client å¯ä»¥è®€å–é‚£äº›å¯«å…¥ä½†å°šæœªæŒä¹…åŒ–çš„è³‡æ–™\nClient æœƒè®€å–åˆ°å°šæœª durable çš„è³‡æ–™ï¼Œä»¥åŠå¯«å…¥MongoDBå¾Œåœ¨è©²å¯«å…¥Client æ”¶åˆ°æˆåŠŸè¨Šæ¯ä¹‹å‰\n( A writes â†’ MongoDB accept â†’ B read Aâ€™s write â†’ A accept success) å¦‚æœæ˜¯å¤šè¡Œå¯«å…¥çš„æ“ä½œ(å¦‚ updateMany)ï¼ŒClient å¯èƒ½æœƒè®€åˆ°æ›´æ–°æœªå®Œå…¨çš„æ–‡æª” (å¦‚æœä¸€æ¬¡æ›´æ–°äº”å€‹æ–‡æª”ï¼Œå¯èƒ½è®€åˆ°ä¸‰å€‹æ›´æ–°å¾Œæ–‡æª”ï¼Œä½†æ¯å€‹æ–‡æª”å¦‚æœæ›´æ–°å¤šå€‹æ¬„ä½ï¼ŒMongoDBä¿è­‰ä¸æœƒè®€å–åˆ°éƒ¨åˆ†æ›´æ–°æ¬„ä½çš„æ–‡æª”) Client å¯èƒ½è®€åˆ°ä¹‹å¾Œè¢«roll back çš„æ•¸æ“š é€™æ˜¯é è¨­çš„ Isolation Level\nåœ¨ MongoDB 4.0ä¹‹å¾Œæ‰åŠ å…¥ å¤šæ–‡æª”çš„ transaction ä¿è­‰ï¼Œåœ¨æ²’æœ‰ transaction ä¿è­‰ä¸‹å¤šæ–‡æª”è®€å–æœƒæœ‰å¹¾å€‹å•é¡Œ\nNon-point-in-time read\nA read d1 ~ d5 â†’ B update d3 â†’ A å¯èƒ½æœƒè®€åˆ°Bæ›´æ–°çš„ d3\nä¹Ÿå°±æ˜¯åœ¨è®€å–ç™¼ç”Ÿçš„è©²æ™‚æ©Ÿé»æ²’æœ‰ç”¢ç”Ÿ snapshotï¼Œå¯ä»¥ç†è§£æˆ unrepeatable read Non-serializable operations\nA read d1 â†’ B write d2 â†’ B write d1 â†’ A read d2Â å°æ–¼ d1 ä¾†èªªï¼Œæ˜¯ A å…ˆè®€æ¥è‘—æ› B å¯« / å°æ–¼ d2 ä¾†èªªï¼Œæ˜¯ Bå¯«å†æ› Aè®€ï¼›\né€™å€‹æƒ…æ³å°è‡´å…©è€…çš„è®€å¯«ç›¸ä¾é †åºå‰›å¥½é¡›å€’ï¼Œæ‰€ä»¥æ²’è¾¦æ³•åºåˆ—åŒ–è®€å¯«é †åº Miss match read\n**åŒæ¨£æ˜¯è®€å–ä¸­æœ‰æ›´æ–°ç™¼ç”Ÿï¼Œå¯èƒ½æœƒå°è‡´æ›´æ–°çš„æ–‡æª”èˆ‡è®€å–çš„æ¢ä»¶ç™¼ç”ŸéŒ¯ç½®ï¼ŒåŸæœ¬ç¬¦åˆæ¢ä»¶çš„å¯èƒ½æ›´æ–°å¾Œä¸ç¬¦åˆç¨®ç¨® Cursor Snapshot ç”¨ cursor è®€å–åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½æœƒå°‡åŒä¸€å€‹æ–‡æª”è¿”å›å¤šæ¬¡ï¼Œå› ç‚ºåŒæœŸé–“æ–‡æª”å¯èƒ½å› ç‚ºæ›´æ–°ç­‰å› ç´ è€Œæ”¹è®Šäº†ä½ç½®\nä½†å¦‚æœæ–‡æª”ä¸­æœ‰ unique keyï¼Œå‰‡åŒå€‹æ–‡æª”åƒ…æœƒè¿”å›ä¸€æ¬¡\nReal TimeÂ Order å…è¨±åŒä¸€å€‹æ–‡æª”çš„å¤šçµ„ thread è®€å¯«å®›å¦‚å–®ä¸€ thread è®€å¯«ä¸€èˆ¬ï¼Œäº¦å³åœ¨åŒä¸€å€‹æ–‡æª”ä¸­æœƒä»¥åºåˆ—åŒ–æ–¹å¼åŸ·è¡Œè®€å¯«è«‹æ±‚\nCausal Consistency å› æœä¸€è‡´æ€§ï¼Œä¾‹å¦‚åˆªé™¤ç¬¦åˆæŸç‰¹å®šæ¢ä»¶çš„æ–‡æª”ï¼Œæ¥è‘—è®€å–åŒæ¨£æ¢ä»¶ï¼Œå¾Œè€…ç‹€æ³ä¾è³´æ–¼å‰è€…ï¼Œæ–¼æ˜¯å‰å¾Œå…©è€…ä¾¿æœ‰äº†å› æœé—œä¿‚ï¼›\nMongoDB 3.6+ æä¾› writeConcern:majority / readConcern:majory å¤–åŠ å› æœæ€§çš„ä¿è­‰\nRead your writes\nå¯«å…¥å¾Œç·Šæ¥è‘—è®€å–å¯«å…¥çš„è³‡æ–™ Monotonic reads\nè®€å–è³‡æ–™çš„çµæœä¸å¯ä»¥æ˜¯æ¯”ä¸Šä¸€æ¬¡è®€å–çµæœæ›´æ—©çš„çµæœ\nä¾‹å¦‚ w1 â†’ w2 â†’ r1 â†’ r2ï¼Œw2 ç›¸ä¾æ–¼ w1ï¼Œr1 é€™è£ç›¸ä¾æ–¼ w2 ï¼Œé‚£éº¼ r2 ä¸å¯èƒ½è®€å–åˆ° w1 çš„çµæœ Monotonic writes\nå› æœåºå…ˆæ–¼å…¶ä»–å¯«å…¥è€…å¿…ç„¶å…ˆç™¼ç”Ÿå¯«å…¥\nä¹Ÿå°±æ˜¯ w1 â†’ w2ï¼Œw1 / w2 ä¹‹é–“å¯èƒ½é‚„æœ‰å…¶ä»–çš„å¯«å…¥æ“ä½œï¼Œä½†æ˜¯ w1 å¿…ç„¶æ¯” w2 æ—©åŸ·è¡Œ Writes follow reads\nè¦åœ¨è®€å–ä¹‹å¾Œå¯«å…¥çš„å¯«å…¥äº‹ä»¶å¿…ç„¶ç™¼ç”Ÿæ–¼è®€å–ä¹‹å¾Œ\nä¹Ÿå°±æ˜¯ r1 â†’ w1ï¼Œå‰‡r1 å¿…ç„¶ç™¼ç”Ÿæ–¼ w1 ä¹‹å‰ Write Concern èˆ‡ ReadÂ Concern æˆªè‡ª MongoDB å®˜æ–¹æ–‡ä»¶\nhttps://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/\nMongoDB åœ¨è®€å¯«æœ‰ä¸åŒçš„ Isolation Levelå¯ä»¥è¨­å®šï¼Œä¹Ÿå°±æ˜¯ Read Concern / Write Concernï¼Œä¸åŒçš„Levelå°æ‡‰ä¸åŒçš„ä¸€è‡´æ€§èˆ‡å¯ç”¨æ€§çš„è€ƒé‡ï¼Œäº¤éŒ¯å¾Œæœ‰å¤šç¨®çµ„åˆç‹€æ³ï¼ŒIsolation level å¯ä»¥å®šç¾©åœ¨é€£ç·š sessionã€Transactionã€å–®æ¬¡æ“ä½œ\nWrite Concern Write Concern ä¸»è¦æ˜¯æŒ‡ ç•¶ Client é€å‡ºå¯«å…¥è«‹æ±‚å¾Œï¼ŒServeræœƒåœ¨ä»€éº¼æ¢ä»¶ä¸‹å›æ‡‰Client å·²ç¶“æˆåŠŸå¯«å…¥äº†ï¼Œç¸½å…±æœ‰ä¸‰å€‹åƒæ•¸å¯ä»¥ä½¿ç”¨\nw:Â å¯«å…¥ä¿è­‰æ¢ä»¶ j:Â Booleanï¼Œæ˜¯å¦å¯«å…¥ disk journal å¾Œæ‰è¿”å› wtimeout:Â å¤šä¹…å¾Œç™¼ç”Ÿtimeouté¿å…é–æ­»ï¼Œ0 ä»£è¡¨ä¸éœ€è¦ timeout è¨­è¨ˆ å…¶ä¸­ w åˆæœ‰å¹¾ç¨®é¸é …\n\u0026lt;number\u0026gt;: å°æ‡‰å¹¾å€‹ mongod server æ”¶åˆ°å¯«å…¥è«‹æ±‚æ‰æœƒå›æ‡‰æˆåŠŸè¨Šæ¯\n0 ä»£è¡¨ä¸éœ€è¦å›æ‡‰ï¼Œä½†å¯èƒ½æœƒå›å‚³ network / socket ç›¸é—œéŒ¯èª¤\n1 é è¨­å€¼ï¼Œå¯«å…¥è«‹æ±‚è¢« standalone mongod æˆ–æ˜¯ primary æ”¶åˆ°\nè¶…é 1 åƒ…é©ç”¨æ–¼ replica setï¼Œä¹Ÿå°±æ˜¯ primary + secondary ç¸½å…±å¹¾å€‹æ”¶åˆ°æ‰æœƒå›æ‡‰æˆåŠŸ majority\næ“æœ‰æŠ•ç¥¨æ¬Šçš„ç¯€é»*éåŠæ•¸éƒ½æ”¶åˆ°å¯«å…¥è«‹æ±‚ï¼Œå°æ‡‰çš„ j è®Šæ•¸å¦‚æœæ²’æœ‰å®£å‘Šå‰‡çœ‹ç³»çµ±çš„é è¨­å€¼ [writeConcernMajorityJournalDefault](https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.writeConcernMajorityJournalDefault \u0026quot;writeConcernMajorityJournalDefault\u0026quot;)Â Arbiter é›–ç„¶æœ‰æŠ•ç¥¨æ¬Šï¼Œä½†æ˜¯ä¸ç®—åœ¨å…¶ä¸­ï¼Œå› ç‚ºæ²’æœ‰å„²å­˜è³‡æ–™ \u0026lt;tag\u0026gt;\nåœ¨è¨­å®š replica set å¯ä»¥æŒ‡å®š tagï¼Œæ­¤è™•çš„ tag è¡¨ç¤ºå¯«å…¥è«‹æ±‚è¢«é€å¾€ç¬¦åˆçš„ replica set Read Concern local æœ€ä½çš„è®€å–ä¿è­‰ï¼Œè®€åˆ°çš„è³‡æ–™ä¸ä¿è­‰å·²ç¶“è¢« majority å¯«å…¥ä¸”å¯èƒ½è³‡æ–™æœƒ rollback\navailable åŸºæœ¬ä¸Šè·Ÿ localä¸€æ¨£ï¼Œåªæœ‰åœ¨ shard cluster çš„æ™‚å€™ available æ˜¯æœ€ä½å»¶é²çš„è®€å–è«‹æ±‚ï¼Œä¸¦ä¸æœƒæ›´æ–° shardingä¸­çš„ä¸­ç¹¼è³‡æ–™(does not contact the shardâ€™s primary nor the config servers for updated metadata.)\nå› æ­¤å¯èƒ½æœƒè®€å–åˆ° orphaned document (æŸäº›è³‡æ–™å·²ç¶“æ¬ç§»åˆ°å…¶ä»–chunkä½†æ˜¯åœ¨åŸå§‹ä½ç½®å› ç‚ºéŒ¯èª¤æˆ–æ˜¯æ„å¤–shutdownå°è‡´æ²’æœ‰æ¸…é™¤ï¼Œéœ€è¦é¡å¤–æ¸…é™¤ cleanupOrphaned\nmajority ä¿è­‰è®€å–åˆ°çš„è³‡æ–™æ˜¯è¢«replica set ä¸­çš„å¤šæ•¸ç¢ºèªéï¼Œä¸”ä¸æœƒ rollbackï¼Œæ³¨æ„æ˜¯ acknowledge è€Œä¸ä¸€å®šæ˜¯ durableï¼Œè¦å°æ‡‰çœ‹writeConcern!\nå¦‚æœæ˜¯åœ¨å¤šæ–‡æª”transactionä¸­ï¼Œé™¤é writeConcern æ˜¯ majorityï¼Œå¦å‰‡ åŒåœ¨ transaction ä¸­çš„ readConcern ä¸èƒ½æä¾›ä¿è­‰ã€‚\nä½†éœ€è¦æ³¨æ„ majority åƒ…èƒ½ç¢ºä¿è®€å–è³‡æ–™ä¸æœƒ rollbackï¼Œä½†æ˜¯ä¸ä¿è­‰èƒ½è®€åˆ°æœ€æ–°è³‡æ–™\nå®˜æ–¹å»ºè­°åœ¨ primary-secondary-arbiter PSAæ¶æ§‹ä¸‹é—œé–‰ majorityï¼Œå› ç‚ºè¤‡è£½ä¸æœƒåˆ° arbiterï¼Œæ‰€ä»¥è¦é”åˆ° majorityæ¢ä»¶å°±æ˜¯ primary-secondary å…©å°éƒ½æˆåŠŸå¯«å…¥æ‰ç®—æˆåŠŸï¼Œæœƒçµ¦ç³»çµ±å¸¶ä¾†æ¯”è¼ƒå¤§çš„è² æ“”ï¼Œå®¹éŒ¯æ€§ä¹Ÿè®Šå·®*\nlinearizable åŸºæ–¼ majority æä¾›æ›´å¼·çš„ä¿è­‰ï¼Œä¿è­‰å¯«å…¥å¾Œçš„è®€å–éƒ½ä¸æœƒè®€åˆ°æ›´èˆŠçš„è³‡æ–™ï¼Œé™¤äº†é¸æ“‡è®€å–çš„ç¯€é»å¤–ï¼Œé‚„æœƒå»è·Ÿå¤šæ•¸ç¯€é»ç¢ºèªï¼Œä¹‹å¾Œæ‰è¿”å›å€¼ï¼Œæ‰€ä»¥æ•ˆèƒ½éœ€æ±‚åˆé«˜å‡ºä¸€æˆªï¼›\nç‚ºä»€éº¼é‚„éœ€è¦è·Ÿå¤šæ•¸ç¯€é»åœ¨ç¢ºèªå‘¢ï¼Ÿ\nä¸»è¦æ˜¯æ€• network partitioningï¼Œä¹Ÿå°±æ˜¯å› ç‚ºç¶²è·¯å»¶é²è€Œå°è‡´åŸæœ¬çš„ replica set è¢«åˆ†å‰²ï¼Œä¾‹å¦‚åŸæœ¬ 3å°è®Šæˆ 1 + 2ï¼Œè€Œ 2å°ä¸€çµ„çš„éƒ¨åˆ†å› ç‚ºé‚„ç¬¦åˆå¤šæ•¸å¯ä»¥ç”¢ç”Ÿæ–°çš„ primaryï¼Œæ­¤æ™‚å¦‚æœæœ‰äººå»è®€(majority) 1é‚£ä¸€å°å°±å¯èƒ½å–å¾—èˆŠè³‡æ–™ï¼Œå› ç‚º 1å¾¹åº•è·Ÿå…¶ä»–ç¯€é»åˆ†é›¢ï¼›\nåŠ ä¸Š linearizableå¯ä»¥é¿å…æ‰æ­¤å•é¡Œï¼Œè©³ç´°å¯åƒè€ƒæ­¤å•ç­” https://stackoverflow.com/questions/42615319/the-difference-between-majority-and-linearizable\nsnapshot åªåœ¨å¤šæ–‡æª” transaction ä¸­ç”Ÿæ•ˆï¼Œæ–‡æª”æ²’æœ‰éå¤šæ•˜è¿°ï¼Œä½†æ¨æ•²æ‡‰è©²ä¹Ÿå°±æ˜¯ä¿è­‰åœ¨åŒä¸€å€‹ transaction ä¸­ä¸æœƒè®€å–åˆ° transaction ä¹‹å¾Œçš„æ›´å‹•ã€‚\nè®€å–çš„å¯¦ä¾‹èªªæ˜ æˆªè‡ª MongoDBÂ å®˜æ–¹æ–‡ä»¶\nreadConcern: majority t0Â : primary æ”¶åˆ°å¯«å…¥è«‹æ±‚ï¼Œå› ç‚ºé€™æ™‚ primary å€¼é‚„æ˜¯ write_prev t1ï¼šsecondary1 æ”¶åˆ°å¯«å…¥åŒæ­¥è«‹æ±‚ï¼Œæ­¤æ™‚ primary / secondary é‚„æ˜¯ write_prev t2ï¼šsecondary2 æ”¶åˆ°å¯«å…¥åŒæ­¥è«‹æ±‚ï¼Œæ­¤æ™‚å€¼ä¹Ÿéƒ½é‚„æ˜¯ write_prev t3ï¼šå› ç‚ºwriteConcernæ˜¯ majorityï¼Œæ­¤æ™‚ primary æ”¶åˆ° secondary1çš„å›è¦†ï¼Œæ­¤æ™‚ primaryæ‰è®Šæˆ write_newï¼Œä¸¦ä¸”å›å¾© client å¯«å…¥æˆåŠŸï¼Œä½†æ˜¯ secondary1 é‚„æ˜¯åœç•™åœ¨ write_prev t4ï¼šprimary æ”¶åˆ° secondary2 å›è¦† t5ï¼šsecondary1æ”¶åˆ° primary1ï¼Œæ­¤æ™‚ snapshotæ‰æ›´æ–°ç‚º write_new t5ï¼šsecondary2 å‹•ä½œåŒä¸Š readConcern: local t0ï¼šprimary æ­¤æ™‚å€¼æ˜¯ write_new t1ï¼šsecondary1 æ­¤æ™‚å€¼æ˜¯ write_new t2ï¼šsecondary2 æ­¤æ™‚å€¼æ˜¯ write_new readConcern: majority è®€å–æ™‚æ˜¯é€é snapshotï¼Œæ ¹æ“šæ­¤ç¯‡æ–‡ç« MongoDB readConcern åŸç†è§£æ æŒ‡å‡º\nMongoDB ä¼šèµ·ä¸€ä¸ªå•ç‹¬çš„snapshot çº¿ç¨‹ï¼Œä¼šå‘¨æœŸæ€§çš„å¯¹å½“å‰çš„æ•°æ®é›†è¿›è¡Œ snapshotï¼Œå¹¶è®°å½• snapshot æ—¶æœ€æ–° oplogçš„æ—¶é—´æˆ³ï¼Œå¾—åˆ°ä¸€ä¸ªæ˜ å°„è¡¨\nåªæœ‰ç¡®ä¿ oplog å·²ç»åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹æ—¶ï¼Œå¯¹åº”çš„ snapshot æ‰ä¼šæ ‡è®°ä¸º commmitedï¼Œç”¨æˆ·è¯»å–æ—¶ï¼Œä»æœ€æ–°çš„ commited çŠ¶æ€çš„ snapshot è¯»å–æ•°æ®ï¼Œå°±èƒ½ä¿è¯è¯»åˆ°çš„æ•°æ®ä¸€å®šå·²ç»åŒæ­¥åˆ°çš„å¤§å¤šæ•°èŠ‚ç‚¹ã€‚\nçµèª é€™ç¯‡ä¸»è¦æ•´ç†èˆ‡ç†è§£ä¸€äº›å®˜æ–¹æ–‡ä»¶çš„è³‡æ–™èˆ‡è¨­å®šï¼Œä¸¦æ²’æœ‰ä»€éº¼å¤ªé‡å¤§çš„çµè«–ï¼Œæ›´é€²ä¸€æ­¥å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œæ¢åˆ—åœ¨ Causal Consistency ä¸‹çš„ä¸åŒè®€å¯«ä¿è­‰\nCausal Consistency and Read and Write Concerns - MongoDB Manual\nè¨»è¨˜ æ“æœ‰æŠ•ç¥¨æ¬Š åœ¨MongoDBçš„ Replica setä¸­ï¼Œåªæœ‰ä»¥ä¸‹å¹¾ç¨®ç‹€æ…‹æœ‰æŠ•ç¥¨æ¬Š (voting node)\nprimary secondary startup2ï¼šç¯€é»è¼‰å…¥æˆå“¡çš„è¨­å®šæª”æ­£å¼æˆç‚º replica setçš„ä¸€å“¡ä¸¦é–‹å§‹åˆå§‹åŒ–åŒæ­¥èˆ‡ç´¢å¼•å»ºç«‹ recoveringï¼šç•¶ç¯€é»å°šæœªæº–å‚™è®€å–è«‹æ±‚æ™‚ï¼Œç­‰åˆ° client è¦ºå¾—okä¾¿æœƒè½‰ç‚º secondaryï¼Œé€™éƒ¨åˆ†æ²’æœ‰æ˜èªª recovering ä¸­åšäº†ä»€éº¼ arbiter rollbackï¼šç•¶èˆŠçš„ primary å› ç‚ºæŸäº›å› ç´ è¢«å‰”é™¤ï¼Œä¹‹å¾Œé¸å‡ºäº†æ–°çš„ primaryï¼ŒèˆŠçš„ primary å¾Œä¾†æ¢å¾©åŒæ­¥ç™¼ç¾æœ‰äº›å¯«å…¥ç•¶åˆæ²’æœ‰åŒæ­¥ï¼Œæ­¤æ™‚èˆŠçš„ primaryæœƒé¸æ“‡ rollback é€™äº›æ²’æœ‰åŒæ­¥çš„è³‡æ–™ ç›®å‰ MongoDBçš„ replica setæœ€å¤šåªèƒ½æœ‰ 50å€‹æˆå“¡ï¼Œå…¶ä¸­æœ€å¤šåªèƒ½æœ‰ 7 åæˆå“¡æœ‰æŠ•ç¥¨æ¬Šï¼›å…¶ä»–æ²’æœ‰æŠ•ç¥¨æ¬Šçš„æˆå“¡å¯ä»¥ç•¶ä½œå‚™ä»½æˆ–æ˜¯è®€å–è«‹æ±‚çš„ç¯€é»ã€‚\nReplica SetÂ å®¹éŒ¯æ€§å•é¡Œ replica set è¦å®šæ˜¯è¦åœ¨è¶…éå¤šæ•¸çš„å½¢æ³ä¸‹æ‰èƒ½é‹ä½œï¼Œæ‰€ä»¥æœ€ä½å¿…é ˆè¦æœ‰ä¸‰å€‹å¯æŠ•ç¥¨ç¯€é»æ‰èƒ½æˆç«‹ï¼Œè©¦æƒ³ä»¥ä¸‹ç‹€æ³\n3å°æ©Ÿå™¨ï¼Œå¯ä»¥å®¹éŒ¯ä¸€å°ï¼Œéœ€è¦ä¿è­‰ 67%çš„æ©Ÿå™¨é‹ä½œæ­£å¸¸ 4å°æ©Ÿå™¨ï¼Œä¹Ÿæ˜¯åƒ…å¯å®¹éŒ¯ä¸€å°ï¼Œéœ€è¦ä¿è­‰ 75%çš„æ©Ÿå™¨é‹ä½œæ­£å¸¸ é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼æœƒæ¨è–¦ä½¿ç”¨å¥‡æ•¸å°çš„æ©Ÿå™¨ï¼›\nåœ¨ PSAä¸‹ï¼ŒArbiter ä¸èƒ½åŒæ­¥è³‡æ–™ï¼Œæ‰€ä»¥ write: majority å¿…é ˆåŒæ­¥å¯«å…¥ primary + secondaryï¼Œæ‰€ä»¥ç³»çµ±å®¹éŒ¯å°±è®Šå·®ï¼ŒåŒæ™‚åŠ é‡æ©Ÿå™¨çš„è² æ“”ã€‚\n","date":"2018-10-14T01:39:58.591Z","permalink":"https://yuanchieh.page/posts/2018/2018-10-14-mongodb-isolation-%E8%88%87-transaction/","title":"MongoDB Isolation èˆ‡ Transaction"},{"content":"Amazon S3 Performance Tips \u0026amp; Tricks + Seattle S3 Hiring Event | Amazon Web Services\nAWS S3 ç”¨ä¾†åšéœæ…‹è³‡æºç®¡ç†ï¼Œå¯ä»¥ç”¨ä¾†å„²å­˜éå¸¸å¤§é‡çš„è³‡æ–™ä¸”æœ‰å¾ˆé«˜ä¿æŒæ€§(duribility:99.9999999%)çš„ä¿è­‰ï¼›\nåœ¨é€™ç¯‡å®˜æ–¹çš„éƒ¨è½æ ¼ä¸­è¨˜è¼‰è‘—S3å…§éƒ¨çš„ä¸€äº›å„²å­˜æ©Ÿåˆ¶ä»¥åŠå„ªåŒ–çš„å°æŠ€å·§ã€‚\nå¦‚æœæ˜¯æ¯ç§’ API Requestå°æ–¼ 50è€…ï¼Œå…¶å¯¦ä¸å¤ªæœƒæœ‰å½±éŸ¿ï¼ŒS3 æœ‰è‡ªå‹•çš„ç›£æ§ç¨‹åº(Agent)ï¼Œè©¦è‘—å»å¹³è¡¡è³‡æºèˆ‡å¢åŠ ç³»çµ±çš„å¹³å‡é™„è¼‰ã€‚\nS3åœ¨å…§éƒ¨ç¶­è­·äº†ä¸€å¼µ Mapï¼ŒMapå°æ‡‰çš„Key æ˜¯ Bucket ä¸­ç‰©ä»¶çš„åç¨±ï¼ŒS3æœƒç”¨ç‰©ä»¶çš„åˆå§‹åç¨±ç•¶ä½œ Keyï¼›\nå¯¦éš›ç‰©ä»¶çš„å„²å­˜æœƒè¢«åˆ†æ•£åˆ°ä¸åŒçš„ paritionä¸­ï¼Œè€Œ S3ç‚ºäº†æä¾›ä¾ç…§æŒ‰å­—å…¸é †åºæ’åˆ—çš„APIï¼Œ åœ¨åš partitioning çš„ä¾æ“šåŒæ¨£æ˜¯é€é Bucketçš„ç‰©ä»¶åˆå§‹åç¨±ï¼›\næ‰€ä»¥å¦‚ä½•å– Bucketçš„ç‰©ä»¶åç¨±å°±æ˜¯å½±éŸ¿æ€§èƒ½çš„é—œéµï¼Œåœ¨S3å…§éƒ¨ Mapçš„key\nbucketname/keyname ï¼ŒS3æœƒè‡ªå‹•å–å‰ç¶´\næœ‰äº›äººæœƒç¿’æ…£ç”¨ user ID / game ID/ æ—¥æœŸ / éå¢æ•¸å­—ç­‰ï¼Œé€™äº› Keyçš„å…±é€šç‰¹æ€§æ˜¯å‰ç¶´é¡ä¼¼ï¼Œé€™ç•¶ä½œS3 Keyæœƒå°è‡´å¹¾å€‹å•é¡Œ\n1. å‚¾å‘å„²å­˜åœ¨åŒä¸€å€‹ partitionä¸­\n2. æ‰€æœ‰çš„ partition æœƒæœ‰æ¼¸å†·çš„æ•ˆæœï¼Œä¾‹å¦‚ç”¨æ—¥æœŸå„²å­˜ï¼Œé€šå¸¸è¶Šè¿‘çš„æ—¥æœŸè³‡æ–™è¶Šå®¹æ˜“å­˜å–ï¼Œä¹Ÿå°±æ˜¯partition çš„ä½¿ç”¨é‡ä¸å¹³å‡\nä»¥ä¸‹å°±æ˜¯ä¸å¥½çš„ç¤ºç¯„\n1 2 3 4 5 6 7 8 9 2134857/gamedata/start.png 2134857/gamedata/resource.rsrc 2134857/gamedata/results.txt 2134858/gamedata/start.png 2134858/gamedata/resource.rsrc 2134858/gamedata/results.txt 2134859/gamedata/start.png 2134859/gamedata/resource.rsrc 2134859/gamedata/results.txt æœ‰å€‹éå¸¸ç°¡å–®çš„æ–¹æ³•å¯ä»¥åšåˆ°ï¼Œä¹Ÿå°±æ˜¯åœ¨é–‹é ­åŠ  hashï¼Œæˆ–æ˜¯å°‡æ—¥æœŸå­—ä¸²åè½‰ï¼Œç¸½ä¹‹è¦ç¢ºä¿å‰å…©åˆ°ä¸‰ä½æ˜¯ä¸é‡è¤‡å­—ä¸²ä¸”å¯«å…¥çš„ç‰©ä»¶æ•¸é›·åŒ\n1 2 3 4 5 6 7 8 9 7584312/gamedata/start.png 7584312/gamedata/resource.rsrc 7584312/gamedata/results.txt 8584312/gamedata/start.png 8584312/gamedata/resource.rsrc 8584312/gamedata/results.txt 9584312/gamedata/start.png 9584312/gamedata/resource.rsrc 9584312/gamedata/results.txt S3æœƒè‡ªå‹•è­˜åˆ¥ prefixä¸¦åˆ†æ•£åˆ°ä¸åŒçš„ partition\n/7\n/8\n/9\nè‡³æ–¼ prefix çœŸæ­£åˆ°åº•å¦‚ä½•å–å€¼æ–‡ç« ä¸¦æ²’æœ‰èªªæ˜ï¼Œåƒ…æåˆ° prefix ç†è«–ä¸Šåªæœ‰å…©åˆ°ä¸‰ä½å³å¯ï¼Œæ ¹æ“šå¦ä¸€ç¯‡ AWSå®˜æ–¹æ–‡ç«  Request Rate and Performance Guidelinesï¼Œæ‡‰ç”¨ç¨‹å¼å­˜å–S3çš„APIé™åˆ¶ç‚º\n3,500 PUT/POST/DELETE and 5,500 GET requests per second per prefix in a bucket\næ‰€ä»¥ hex hash ä¸‰ä½ï¼Œæœ€å¤§è®€å–å€¼å¯é” 16 * 16 * 16 * 5500 GET API Call /per secondï¼Œé€™ç†è«–ä¸Šå¯ä»¥æ»¿è¶³çµ•å¤§å¤šæ•¸çš„ç”¢å“éœ€æ±‚äº†ï¼›\nç”šè‡³å¤§å¤šæ•¸çš„ç”¢å“é‚„ä¸éœ€è¦ prefixçš„å‘½åå„ªåŒ–ã€‚\n","date":"2018-09-25T21:34:31.149Z","permalink":"https://yuanchieh.page/posts/2018/2018-09-25-%E7%AD%86%E8%A8%98-aws-s3-%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E5%B0%8F%E6%92%87%E6%AD%A5-amazon-s3-performance-tips-tricks/","title":"[ç­†è¨˜] AWS s3 æ€§èƒ½æå‡å°æ’‡æ­¥ â€” Amazon S3 Performance Tips \u0026 Tricks"},{"content":"åœ¨æ•¸ä½å…§å®¹çš„æ™‚ä»£ï¼Œå½±éŸ³çš„é–±è®€æ¯”ä¾‹ä¹Ÿè¶Šä¾†è¶Šé«˜ï¼Œç›¸é—œçš„ç›´æ’­èˆ‡å½±éŸ³ä¸²æµæœå‹™è¶Šä¾†è¶Šå¤šï¼Œè€Œå…¶ä¸­æœ€å¸¸ä½¿ç”¨çš„ä¸²æµæŠ€è¡“è¦æ ¼ä¾¿æ˜¯HLSï¼›\nè¿‘æ—¥å·¥ä½œä¸Šé–‹å§‹ä½¿ç”¨ä¸å°‘HLSæœå‹™ï¼Œæ±ºå®šè‡ªå·±ç¿»Specææ‡‚æ•´å€‹æŠ€è¡“æ¶æ§‹ï¼Œä¸¦æ•´ç†æˆç­†è¨˜åˆ†äº«ã€‚\nç›®å‰é è¨ˆæœƒå¯«å€‹å…©ç¯‡ï¼š\nä¸Šç¯‡(æ­¤ç¯‡)ä»‹ç´¹ HLS Specå…§å®¹\nä¸‹ç¯‡ä»‹ç´¹å½±éŸ³è™•ç†ç›¸é—œçš„è¦ç¯„èˆ‡å·¥å…·ä½¿ç”¨\nå…¨æ–‡å…§å®¹åŸºæ–¼æ–‡ä»¶ https://www.rfc-editor.org/rfc/rfc8216.txt ï¼Œä½†å…§æ–‡ç‚ºè‡ªå·±é–±è®€å¾Œä¸¦é‡çµ„ï¼Œå¦‚æœæœ‰ä¸æ¸…æ¥šæˆ–æ˜¯ç­†èª¤ä¹‹è™•ï¼Œå†éº»ç…©ç•™è¨€å›‰\nç°¡ä»‹èˆ‡æ¦‚è«– RFC 8216 ä¸»è¦æ˜¯ä»‹ç´¹ HTTP Live Streaming (HLS)ï¼Œä¸»è¦å®šç¾©è³‡æ–™çš„æª”æ¡ˆæ ¼å¼èˆ‡Server/Clientæ‡‰è©²æœ‰çš„ç›¸å°æ‡‰è¡Œç‚º ï¼Œç›®å‰çš„æœ€æ–°ç‰ˆæœ¬ç‚º 7ã€‚\nHLS æä¾›ç©©å®šã€çœèŠ±è²»çš„æ–¹å¼æ¨é€é€£çºŒæ€§æˆ–é•·æ™‚æ®µçš„å½±ç‰‡ï¼Œæœ‰å¹¾å€‹ç‰¹æ€§\næ¥æ”¶æ–¹å¯ä»¥æ ¹æ“šç¶²è·¯ç‹€æ³èª¿æ•´ä¸åŒè§£æåº¦ æ”¯æ´åŠ å¯† åŒå€‹å½±éŸ³å…§å®¹ä¸åŒçš„æ’­æ”¾æ¢ä»¶ï¼Œä¾‹å¦‚å­—å¹•åˆ‡æ› åŸºæ–¼HTTPï¼Œå¯ä»¥æœ‰è‰¯å¥½çš„Cacheæ©Ÿåˆ¶(çœèŠ±è²»çš„åŸå› ) HLS å¤§è‡´ä¸Šæ˜¯å°‡å½±ç‰‡åˆ‡æˆå°å¡Šç‹€ï¼Œä¸¦é€éæ’­æ”¾æ¸…å–®æ¨é€ï¼ŒClient æ”¶åˆ°åˆ‡æˆå¡Šç‹€çš„å½±ç‰‡ç‰‡æ®µå¾Œå°±å¯ä»¥ç›´æ¥æ’­æ”¾ï¼Œè€Œä¸éœ€ç­‰åˆ°æ•´å€‹å½±ç‰‡è¼‰å®Œæ‰å¯ä»¥æ’­ï¼›\nè€Œæ¯å€‹ç‰‡æ®µéƒ½å¯ä»¥è¢«Cacheåœ¨CDNï¼Œæ–¹ä¾¿æ¨é€åˆ°å…¨ä¸–ç•Œã€‚\nå°å¡Šç‹€çš„å½±ç‰‡ç¨±ç‚º Media Segmentï¼Œå¸¸ç”¨çš„æ ¼å¼ç‚º ts / fmp4\næ’­æ”¾æ¸…å–®å‰‡æ˜¯ Playlistï¼Œæ ¼å¼ç‚º m3u8\nHLS æœ‰å…©ç¨® Playlist æ ¼å¼: Master Playlist èˆ‡ Media Playlist\nMaster Playlist ä¸»è¦æ˜¯ç‚ºäº†æä¾›å¤šç¨®è§£æåº¦ã€ç¿»è­¯å­—å¹•çš„æ’­æ”¾æ¸…å–® (Media Playlist)ï¼Œç•¶ Client (å¦‚æ’­æ”¾å™¨)ä¾æ“šç¶²è·¯æ¢ä»¶èˆ‡ç”¨æˆ¶é¸æ“‡ç­‰ï¼Œå‰‡é¸æ“‡æ”¯æ´çš„æ’­æ”¾æ¸…å–®ä¸‹è¼‰å½±ç‰‡æª”\nMaster Playlist ä¸»è¦é‡å°ç›¸åŒå…§å®¹æä¾›ä¸åŒçš„ Streamingï¼Œä¾‹å¦‚ä¸åŒçš„è§£æåº¦ã€ä¸åŒçš„åœ‹å®¶æœ‰ä¸åŒçš„å­—å¹•ç­‰\n1 2 3 4 5 6 7 8 9 #EXTM3U #EXT-X-STREAM-INF:BANDWIDTH=1280000,AVERAGE-BANDWIDTH=1000000 http://example.com/low.m3u8 #EXT-X-STREAM-INF:BANDWIDTH=2560000,AVERAGE-BANDWIDTH=2000000 http://example.com/mid.m3u8 #EXT-X-STREAM-INF:BANDWIDTH=7680000,AVERAGE-BANDWIDTH=6000000 http://example.com/hi.m3u8 #EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=\u0026#34;mp4a.40.5\u0026#34; http://example.com/audio-only.m3u8 å¤§æ„æ˜¯åœ¨å¹³å‡æµé‡6000000æ™‚æ’­æ”¾ hi.m3u8ï¼Œåœ¨æ¯”è¼ƒä½é»çš„1000000æ’­æ”¾ low.m3u8ï¼Œå¦‚æœæ˜¯é‡å°éŸ³æª”è€Œå·²å‰‡æ’­ audio-only.m3u8ã€‚\nMedia Playlist å°±æ˜¯ Master Playlistä¸­ StreamingæŒ‡å®šçš„ä¸²æµæ’­æ”¾æ¸…å–®ï¼Œä¸»è¦èªªæ˜è¦æ’­æ”¾çš„ç‰‡æ®µURIã€æ’­æ”¾æ™‚é•·ã€å¦‚ä½•è§£ç¢¼å½±ç‰‡æˆ–æ˜¯è§£å¯†å…§å®¹ç­‰ç­‰\n1 2 3 4 5 6 7 8 9 #EXTM3U #EXT-X-TARGETDURATION:10 #EXTINF:9.009, http://media.example.com/first.ts #EXTINF:9.009, http://media.example.com/second.ts #EXTINF:3.003, http://media.example.com/third.ts é€™å€‹ Media Playlist èªªæ˜äº†å¤§ç´„æœ€å¤§å€‹Media Segmentsæ’­æ”¾æ™‚é•·ç‚º10ç§’ï¼›\nç¬¬ä¸€å€‹ç‰‡æ®µ URI æ˜¯ http:â€¦/first.ts é•·åº¦ç‚º 9ç§’ï¼›\nç¬¬ä¸€å€‹ç‰‡æ®µæ’­å®Œæ›ç¬¬äºŒå€‹ç‰‡æ®µï¼Œä»¥æ­¤é¡æ¨ã€‚\nMedia Segments Media Playlist æ˜¯ç”±å¤šå€‹ Media Segments è€Œçµ„æˆï¼Œæ¯å€‹Media Segments éƒ½æ˜¯å¿…é ˆè¨»æ˜æª”æ¡ˆä¾†æº(URI)ï¼Œä¸”åŸºæœ¬ä¸Šéœ€è¦æ˜¯èˆ‡å‰ä¸€å€‹Media Segments ç›¸é€£çºŒçš„å…§å®¹ï¼Œä¹Ÿå°±æ˜¯ 1 æ’­å®Œæ› 2 ï¼Œ2 æ’­å®Œæ› 3 çš„æ¦‚å¿µï¼Œé™¤éæœ‰é¡¯ç¤ºå®£å‘Šå…©å€‹Media Segments æ˜¯ä¸é€£çºŒçš„ã€‚\nä»»ä¸€å€‹Media Segments éƒ½å¿…é ˆå¸¶æœ‰è¶³å¤ çš„è³‡è¨Šè®“æ’­æ”¾å™¨å¯ä»¥è§£ç¢¼ï¼Œåœ¨ä¸åŒæ ¼å¼ä¸‹ï¼Œæœ‰äº›æ ¼å¼çš„åˆå§‹åŒ–ç‰‡æ®µ(Media Initialization Segments) æ˜¯ç›¸åŒçš„ï¼Œé€™æ™‚å€™å¯ä»¥å®£å‘Š EXT-X-MAP æŒ‡å®šï¼Œå¾ŒçºŒçš„Media Segments å°±å¯ä»¥å…±ç”¨ã€‚\nä»¥ä¸‹å¸¸è¦‹çš„æ”¯æ´æ ¼å¼æœ‰\nMPEG-2 Transport Stream Fragmented MPEG-4 Packed Audio(éŸ³è¨Š) WebVTT(å­—å¹•) å‰å…©è€…æ˜¯ä¸åŒçš„å½±éŸ³ç·¨ç¢¼æ ¼å¼ï¼ŒMPEG-2è¢«å»£æ³›æ‡‰ç”¨æ–¼æœ‰ç·šé›»è¦–ã€DVDç­‰ï¼Œè€ŒMPEG-4 æ˜¯åŸºæ–¼ MPEG-2 æ”¹è‰¯ï¼Œå„è‡ªæœ‰ä¸åŒçš„æ ¼å¼èˆ‡ Media Initialization Segments çš„æ ¼å¼ã€‚\nWebVTTé€šå¸¸éœ€è¦é¡å¤–çš„ EXT-TIMESTAMP-MAP å»èˆ‡å½±éŸ³æ’­æ”¾æ ¡æ™‚ã€‚\nPlaylist Playlist çš„æª”åå¿…é ˆæ˜¯Â .m3u8 /Â .m3u ï¼Œä¸¦ä¸”å›å‚³çš„ HTTP Response Content-Typeå¿…é ˆç‚º application/vnd.apple.mpegur æˆ–æ˜¯ audio/mpegurl ï¼›\nç·¨ç¢¼å¿…é ˆæ¡ç”¨ utf-8 ï¼Œé™¤äº† CR / LF å¤–ä¸èƒ½æœ‰å…¶ä»– utf-8å®šç¾©çš„æ§åˆ¶ç¢¼ã€‚\nåœ¨Playlistä¸­ï¼Œæ¯ä¸€è¡Œå¯ä»¥æ˜¯ URI / ç©ºç™½æˆ–æ˜¯ç”± # é–‹é ­çš„å­—ä¸²ï¼›\nç‰¹åˆ¥æ³¨æ„ # é–‹é ­çš„å­—ä¸²å¯ä»¥æ˜¯æ¨™ç±¤æˆ–æ˜¯è¨»è§£ï¼Œæ¨™ç±¤åƒæ˜¯ #EXT-X é–‹é ­ï¼Œä¸”å€åˆ†å¤§å°å¯«(æ¨™ç±¤å…¨å¤§å¯«)\nURI éƒ¨åˆ†å¯ä»¥æ˜¯ç›¸å°è·¯å¾‘ï¼Œç›¸å°æ–¼ Playlist çš„URIã€‚\næ¥è‘—ä»‹ç´¹Playlistçš„çµ„æˆæ¨™ç±¤ï¼Œé€™éƒ¨åˆ†ä¸»è¦æ˜¯ç¯€éŒ„ Specå…§å®¹ï¼Œå› ç‚ºæ˜¯åè©å®šç¾©æœ‰é»æ¯ç‡¥ï¼Œæœ‰èˆˆè¶£å¯ä»¥æ·±å…¥æŸ¥è©¢ï¼Œå¾ŒçºŒæœƒæœ‰å¯¦éš›ç¯„ä¾‹ã€‚\nBasic Tags Playlist å¯åˆ†æˆ Media Playlist èˆ‡ Master Playlistï¼Œä»¥ä¸‹ç‚ºå…©è€…å…±ç”¨çš„æ¨™ç±¤ã€‚\nEXTM3U\næŒ‡å®šæª”æ¡ˆç‚º Extented M3Uï¼Œå¿…é ˆæ˜¯æª”æ¡ˆçš„ç¬¬ä¸€è¡Œ(é›·åŒæ–¼htmlçš„ DOCTYPE) EXT-X-VERSION\næŒ‡å®šç‰ˆè™Ÿï¼Œç›®å‰æœ€æ–°ç‰ˆç‚º 7ï¼Œæ•´ä»½ Playliståªæ‡‰è©²å‡ºç¾ä¸€æ¬¡ã€‚ Media SegmentsÂ Tags Media Segments Tag æœƒæ‡‰ç”¨æ–¼ä¸‹ä¸€å€‹ Media Segment æˆ–æ˜¯å¾ŒçºŒæ‰€æœ‰çš„Media Segment ä¸Šã€‚\nEXTINF\nè¨»æ˜è©² Media Segmentçš„æ™‚é–“é•·åº¦ï¼Œé€™å€‹æ¨™ç±¤æ˜¯å¿…é ˆçš„ã€‚\næ ¼å¼ç‚º #EXTIF:\u0026lt;duration\u0026gt;,[\u0026lt;title\u0026gt;]Â duration å–®ä½ç‚ºç§’ï¼Œå»ºè­°ç”¨æµ®é»æ•¸è¡¨ç¤ºï¼Œå¦‚æœç‰ˆè™Ÿå°æ–¼ä¸‰æ‰ä½¿ç”¨æ•´æ•¸ EXT-X-BYTERANGE\nè¨»è¨˜è©² Media Segmentåªæˆªå–æŸç¯„åœè€Œéæ•´å€‹å®Œæ•´æª”æ¡ˆ\næ ¼å¼ç‚º #EXT-X-BYTERANGE:\u0026lt;n\u0026gt;[@\u0026lt;o\u0026gt;]Â if( o ) {\no ä»£è¡¨ byte offsetï¼Œnè¡¨ç¤ºå¾oé–‹å§‹å–å¹¾å€‹ byte\n} else {\no å–ä¸Šä¸€å€‹ Media Segmentçš„çµå°¾\n} EXT-X-DISCONTINUITY\nå…ˆå‰èªªæ¯å€‹ Media Segment éƒ½å¿…é ˆæ˜¯é€£çºŒçš„ï¼Œä½†å¦‚æœæª”æ¡ˆæ ¼å¼ã€å½±éŸ³è»Œ(Track)çš„æ•¸å­—/å‹åˆ¥ç­‰ã€timestamp æœ‰æ”¹è®Šï¼Œå°±å¿…é ˆè¦é¡¯ç¤ºå®£å‘Š EXT-X-KEY\nMedia Segment å¯ä»¥è¢«åŠ å¯†ï¼Œè€Œ#EXT-X-KEYå‰‡æ˜¯å®£å‘Šè§£å¯†çš„æ–¹å¼ EXT-X-MAP\nå®šæ‡‰ Media Initialization Segments ä¾†æºï¼Œæ•ˆåŠ›æ‡‰ç”¨æ–¼æ¯å€‹Media Segment ä¸Šï¼›\næ ¼å¼ç‚º #EXT-X-MAP:\u0026lt;Attribute-List\u0026gt; EXT-X-PROGRAM-DATE-TIME\nå®£å‘Šç¬¬ä¸€å€‹Media Segment çš„çµ•å°æ™‚é–“ï¼Œæ ¼å¼ç‚º ISO-8601ï¼Œé ˆåŒ…å«æ™‚å€ï¼Œä¾‹å¦‚ #EXT-X-PROGRAM-DATE-TIME:2010â€“02â€“19T14:54:23.031+08:00 EXT-X-DATERANGE\næŒ‡å®šè©²æ™‚é–“ç¯„åœå…§çš„å±¬æ€§å®šç¾©ï¼Œé€™éƒ¨åˆ†æˆ‘çœ‹ä¸æ‡‚åœ¨å¹¹å˜›OTZ Media PlaylistÂ Tags EXT-X-TARGETDURATION\nå–®å€‹ Media Segments çš„ EXTINTæœ€å¤§å€¼ï¼Œå–®ä½ç‚ºç§’ï¼Œæ ¼å¼æ˜¯æ•´æ•¸ï¼Œæ­¤æ¨™ç±¤ç‚ºå¿…å¡«ã€‚ EXT-X-MEDIA-SEQUENCE\nè¨»è¨˜ç¬¬ä¸€å€‹Media Segmentçš„åºè™Ÿï¼Œå¦‚æœä¸å­˜åœ¨å‰‡é è¨­ç‚º0ï¼›\næ­¤æ¨™ç±¤éœ€å‡ºç¾æ–¼æ‰€æœ‰Media Segments ä¹‹å‰ EXT-X-DISCONTINUITY-SEQUENCE\nç”¨æ–¼å¤šå€‹ä¸²æµåŒæ­¥çš„åºè™Ÿã€‚ EXT-X-ENDLIST\nä¸æœƒæœ‰æ›´å¤šçš„ Media Segmentè¢«åŠ å…¥ Playlistä¸­ï¼Œå¯ä»¥å‡ºç¾åœ¨æ¸…å–®çš„å„è™• EXT-X-PLATLIST-TYPE\nå¯ä»¥æ˜¯ EVENT æˆ–æ˜¯ VOD\nEVENT è¡¨ç¤º Media Segment æœƒæŒçºŒåŠ åˆ° Playlistä¹‹å¾Œ\nVODè¡¨ç¤º Playlist ä¸æœƒæ”¹è®Šäº† EXT-X-I-FRAMES-ONLY\næ¯å€‹ Media Segmentéƒ½æ˜¯ç¨ç«‹çš„I-Frameï¼Œå½±ç‰‡çš„ç·¨ç¢¼èˆ‡å‰å¾Œæ²’æœ‰ç›¸ä¾æ€§ï¼Œå¯ç”¨æ–¼å¿«è½‰ã€å¿«é€Ÿå€’å¸¶ã€é—œéµå½±æ ¼ç­‰å ´æ™¯ï¼Š Master PlaylistÂ Tags EXT-X-MEDIA\nè¨»æ˜åœ¨ä¸åŒçš„å ´æ™¯(ä¾‹å¦‚ç´”éŸ³æª”/è‹±æ–‡å­—å¹•/æ³•æ–‡å­—å¹•ç­‰)ä¸‹æ’­æ”¾ä¸åŒçš„ Media Playlistï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„Renditionï¼Œä½†é€™äº›Playlistéƒ½å¿…é ˆæ˜¯ç›¸åŒçš„å…§å®¹ï¼›\nå…¶ä¸­æœ‰è¨±å¤šå±¬æ€§å¯ä»¥è¨­å®š\nTYPE:å¯ä»¥æ˜¯AUDIO/VIDEO/SUBTITLE/CLOSE-CAPTIONS(éš±è—å­—å¹•)\nURI:å°æ‡‰çš„Media Playlist è³‡æºä½ç½®\nLANGUAGE\nASSOC-LANGUAGEï¼šç”¨æ–¼å…¶ä»–åœ°æ–¹çš„èªè¨€æŒ‡å®šï¼Œå¦‚èªéŸ³ vs æ–‡å­—\nDEFAULTï¼šé è¨­æ’­æ”¾æ­¤Playlist\nGROUP-IDï¼šè‡ªå®šç¾©çš„åç¨±\nç­‰ç­‰ EXT-X-STREAM-INF\nå®£å‘Š Variant Streamï¼Œå±¬æ€§æœ‰\nBANDWITDHï¼šåŠ ç¸½Media Playlistçš„æœ€å¤§ Segment Bit rate\nAVERAGE-BANDWITDHï¼šå¹³å‡æ¯ç§’å¹¾å€‹bits\nCODESï¼šç·¨è§£ç¢¼æ ¼å¼\nVIDEOï¼šå…¶å€¼éœ€å°æ‡‰#EXT-X-MEDIA çš„GROUP-ID ï¼Œä¸”è©²#EXT-X-MEDIA çš„TYPEå¿…é ˆæ˜¯ VIDEO\nAUDIOï¼šç‹€æ³é›·åŒ\n#EXT-X-STREAM-INFèˆ‡#EXT-X-MEDIA ç›¸è¼”ç›¸æˆ EXT-X-I-FRAME-STREAM-INF EXT-X-SESSION-DATA\nä»»æ„çš„ Sessionå€¼ EXT-X-SESSION-KEY\né å…ˆåŠ è¼‰åœ¨ Media Playlistå®£å‘Šçš„ EXT-X-KEYçš„å€¼ Media or Master PlaylistÂ Tags EXT-X-INDEPENDENT_SEGMENTS\nè¨»è¨˜æ¯å€‹Media Segments å¯ä»¥å–®ç¨decodeè€Œä¸éœ€è¦å…¶ä»– segmentçš„è³‡è¨Š\nå¦‚æœå‡ºç¾åœ¨Master Playlistå°æ‰€æœ‰ Media Playlistéƒ½æœ‰æ•ˆ EXT-X-START\nå¾ä½•è™•é–‹å§‹æ’­æ”¾æ¸…å–®\néœ€æŒ‡å TIME-OFFSETå±¬æ€§ï¼Œæ­£å€¼ä»£è¡¨å¾å½±ç‰‡é–‹é ­é–‹å§‹ç®—ï¼Œè² å€¼å‰‡å¾å½±ç‰‡å°¾ç«¯é–‹å§‹ç®—\nTIME-OFFSETå€¼ä¸å¯è¶…éå½±ç‰‡çš„é•·åº¦ï¼Œå¦‚æœè¶…éå‰‡æ­£å€¼å¾å°¾éƒ¨ç®—è€Œè² å€¼å¾é ­ç®—(ä¸€å€‹å¾ªç’°çš„æ¦‚å¿µ) ä»¥ä¸Šæ˜¯æ‰€æœ‰çš„æ¨™ç±¤ï¼Œä¹Ÿä¸æ˜¯æ¯å€‹æ„æ€éƒ½å¾ˆå¥½ç†è§£ï¼Œå¾ŒçºŒç›¡é‡ä»¥ç¯„ä¾‹èªªæ˜\nKey files EXT-X-KEYçš„URIå±¬æ€§æ¨™è¨˜Keyçš„æª”æ¡ˆä½ç½®ï¼Œç”¨æ–¼è§£å¯†Media Segmentsï¼›\nç›®å‰çš„åŠ å¯†æ–¹å¼å¯æ”¯æ´ AES-128ï¼Œå¦‚æœæ¡ç”¨æ­¤åŠ å¯†æ–¹å¼ï¼Œå‰‡éœ€è¦ IVå€¼ï¼Œç”¨æ–¼å¢å¼·AES-128åŠ å¯†çš„åˆå§‹å€¼ã€‚\nClient / Server Responsibilities ç¬¬å…­ç« ä¸»è¦å®šç¾©Server / Client é‡åˆ°ä¸åŒæ¨™ç±¤çš„è™•ç†è¡Œç‚ºï¼Œç®—æ˜¯ä¸Šé¢çš„å¤§çµ±æ•´ï¼Œä»¥åŠå¯¦åšä¸Šçš„å¼•å°èªªæ˜ã€‚\nServer è² è²¬ç”¢ç”ŸPlaylistèˆ‡æä¾›Media Segments\nå¯¦éš›å¦‚ä½•ç”¢ç”Ÿä¾†æºåª’é«”æª”ä¸å† Specç¯„ç–‡ä¸­ï¼Œè€ŒServerå¿…é ˆè² è²¬æŠŠä¾†æºåª’é«”æª”åˆ†å‰²æˆé€£çºŒä¸”æ™‚é•·å°æ–¼ç¸½ç›®æ¨™æ™‚é•·çš„Media Segmentsï¼Œéœ€æ³¨æ„ç•¶Serveråˆ†å‰²æª”æ¡ˆæ™‚éœ€è¦åˆ‡åœ¨ packet / key frame ä¸Šï¼›\næ¥è‘—é‡å°æ¯å€‹Media Segmentåˆ†é…ç‰¹å®šçš„URIï¼Œå¦‚æœServeræ”¯æ´ Byte-Range GETå‰‡å¯ä»¥åœ¨Playlistä¸­ä½¿ç”¨ EXT-X-BYTERANGE\nç•¶Media Segment è¢«é‹ç”¨åœ¨ Playlistä¸­ï¼ŒServerå¿…é ˆç¢ºä¿è³‡æºå¯ä»¥è¢«å–å¾—ä¸”ä¸æœƒå‡ºéŒ¯ï¼Œä¸”ä¸‹è¼‰å¿…é ˆæ˜¯ç«‹å³ä¸‹è¼‰è€Œé Streaming\nå¦‚æœTYPEæ˜¯ VODï¼ŒServer ç”¢ç”Ÿå‡º Playlistå°±ä¸æ‡‰è©²ä¿®æ”¹ï¼›\nå¦‚æœTYPE æ˜¯ EVENTï¼Œå·²ç¶“ç”¢ç”Ÿçš„Playlistä¹Ÿä¸èƒ½ä¿®æ”¹ï¼Œåªèƒ½åœ¨Playlistä¹‹å¾Œç¹¼çºŒå¢åŠ è¡Œæ•¸ã€‚\nå¦‚æœMedia Playlistæ²’æœ‰åŒ…å« EXT-X-ENDLISTï¼Œå‰‡Server å¿…é ˆæä¾›åŒ…å«æ–°çš„Media Segments ä¾†æ›´æ–°Playlistï¼Œè€Œæä¾›çš„æ™‚é–“å¿…é ˆç­‰ 0.5 ~ 1.5 ç›®æ¨™æ™‚é–“å…§ï¼Œå› ç‚ºé€™æ¨£æ‰èƒ½æœ€å¤§åŒ–åˆ©ç”¨ç¶²è·¯æ•ˆèƒ½ã€‚\nClient ç•¶Client æ”¶åˆ°Master Playlist ï¼Œå¯ä»¥é¸æ“‡ä¸€å€‹ Variant Stream æ’­æ”¾ï¼ŒClient å¿…é ˆæª¢æŸ¥ç‰ˆè™Ÿèˆ‡æ¨™ç±¤çš„èªæ³•ï¼Œå¦‚æœä¸åˆå‰‡åœæ­¢æ’­æ”¾ï¼Œä½†ç‚ºäº†æ›´å¥½çš„å‘å‰ç›¸å®¹ï¼Œé‡åˆ°ç„¡æ³•è­˜åˆ¥çš„æ¨™ç±¤æˆ–å±¬æ€§å€¼å°±è‡ªå‹•å¿½ç•¥ã€‚\nå¦‚æœ Media Playlist TYPE æ˜¯ Event ä¸”æ²’æœ‰ EXT-X-ENDLIST å‰‡å¿…é ˆå®šæœŸé‡è¼‰ Playlist ä»¥ä¾¿ç²å–æœ€æ–°çš„ Media Segmentsï¼Œä½†ç‚ºäº†ä¸å¸¶çµ¦Serveréå¤šè² æ“”ï¼Œé‡æ–°ç²å–çš„æ™‚é–“å·®å¿…é ˆåœ¨è‡³å°‘ä¸€å€çš„ target durationï¼Œå¦‚æœç¬¬ä¸€æ¬¡é‡è¼‰å¾Œæ²’æœ‰æ›´æ–°å‰‡è‡³å°‘ç­‰åŠå€‹target duration å†é‡è©¦ã€‚\né€™éƒ¨åˆ†å…§å®¹å¾ˆå¤šï¼Œæœ‰èˆˆè¶£å¯ä»¥æ…¢æ…¢ç¿»ï¼Œä¸»è¦å°±æ˜¯è¬›å¦‚ä½•è¼‰å…¥è³‡æºèˆ‡é‡åˆ°æ¨™ç±¤è¦æ€éº¼è™•ç†ç­‰ç­‰\nExamples Example Playlists for HTTP Live Streaming | Apple Developer Documentation\nSpec ä¸­ä¹Ÿæœ‰ç¯„ä¾‹ï¼Œä½†é€™é‚Šæˆ‘æ“·å–Apple Developer çš„ç¯„ä¾‹\nå®‰æ’å»£å‘Š 1 2 3 4 5 6 7 8 9 #EXTM3U #EXT-X-TARGETDURATION:10 #EXT-X-VERSION:4 #EXT-X-MEDIA-SEQUENCE:0 #EXTINF:10.0,ad0.ts #EXTINF:8.0,ad1.ts #EXT-X-DISCONTINUITY #EXTINF:10.0,movieA.ts #EXTINF:10.0,movieB.ts æ³¨æ„åœ¨ ad1.ts èˆ‡ movieA.ts ä¸­æœ‰å€‹ #EXT-X-DISCONTINUITY ï¼Œå› ç‚º Ad è·Ÿ Movie å‹¢å¿…æ˜¯å…©å€‹ä¸åŒçš„ç‰‡æ®µï¼Œæ‰€ä»¥å¿…é ˆåŠ å…¥æ‰ä¸æœƒå› ç‚º timestamp éŠœæ¥ä¸ä¸Šè€Œå°è‡´æ’­æ”¾éŒ¯èª¤ï¼\nMaster Playlist with Alternative Audio 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #EXTM3U #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\u0026#34;aac\u0026#34;,NAME=\u0026#34;English\u0026#34;, \\\\ DEFAULT=YES,AUTOSELECT=YES,LANGUAGE=\u0026#34;en\u0026#34;, \\\\ URI=\u0026#34;main/english-audio.m3u8\u0026#34; #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\u0026#34;aac\u0026#34;,NAME=\u0026#34;Deutsch\u0026#34;, \\\\ DEFAULT=NO,AUTOSELECT=YES,LANGUAGE=\u0026#34;de\u0026#34;, \\\\ URI=\u0026#34;main/german-audio.m3u8\u0026#34; #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\u0026#34;aac\u0026#34;,NAME=\u0026#34;Commentary\u0026#34;, \\\\ DEFAULT=NO,AUTOSELECT=NO,LANGUAGE=\u0026#34;en\u0026#34;, \\\\ URI=\u0026#34;commentary/audio-only.m3u8\u0026#34; #EXT-X-STREAM-INF:BANDWIDTH=1280000,CODECS=\u0026#34;...\u0026#34;,AUDIO=\u0026#34;aac\u0026#34; low/video-only.m3u8 #EXT-X-STREAM-INF:BANDWIDTH=2560000,CODECS=\u0026#34;...\u0026#34;,AUDIO=\u0026#34;aac\u0026#34; mid/video-only.m3u8 #EXT-X-STREAM-INF:BANDWIDTH=7680000,CODECS=\u0026#34;...\u0026#34;,AUDIO=\u0026#34;aac\u0026#34; hi/video-only.m3u8 #EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=\u0026#34;mp4a.40.5\u0026#34;,AUDIO=\u0026#34;aac\u0026#34; main/english-audio.m3u8 å¦‚æœå¸Œæœ›å¯ä»¥è®“Video ä¾æ“šä¸åŒçš„é »å¯¬åˆ‡æ›ï¼Œè€ŒéŸ³æª”æ ¹æ“šä¸åŒçš„èªè¨€é¸æ“‡åˆ‡æ›ï¼Œå°±å¯ä»¥åƒè€ƒé€™å€‹ç¯„ä¾‹\n#EXT-X-MEDIA å®šç¾©äº†Renditionï¼Œé€éLANGUAGEæŒ‡å®šèªè¨€ï¼Œæ¥è‘—TYPEè¡¨æ˜ç‚ºAUDIOè²éŸ³æª”ï¼ŒGROUP-IDè‡ªå–ç‚º aacï¼›\nè€Œ#EXT-X-STREAM-INF å®šç¾©çš„æ˜¯ Variant Streamï¼ŒAUDIOæŒ‡å®šç‚º aacï¼Œä¹Ÿå°±æ˜¯å°æ‡‰ #EXT-X-MEDIA çš„GROUP-IDï¼Œå…¶URIå‰‡æŒ‡å®šæ’­æ”¾ videoã€‚\nå¯ä»¥çœ‹å‡ºå¸¸ç”¨çš„æ¨™ç±¤å°±é‚£å¹¾å€‹ï¼Œæœ‰äº›æ¨™ç±¤æˆ‘ä¾†å›çœ‹äº†å¹¾æ¬¡é‚„æ˜¯çœ‹ä¸æ‡‚ï¼Œåƒæ˜¯ EXT-X-DATERANGEå°±å¾ˆé›£æ‡‚ï¼Œç¯„ä¾‹ä¹Ÿéƒ½æ²’ç”¨ä¸Šï¼Œå¦‚æœæœ‰äººçŸ¥é“å¯¦éš›ä¸Šçš„æ‡‰ç”¨èˆ‡åŸç†å†éº»ç…©ç•™è¨€äº†OTZ\nçµèª æ•´ä»½Spec æ­»å—‘å®Œå¾ˆå¤šéƒ¨ä»½ä¹Ÿé‚„æ˜¯æ‡µæ‡µæ‡‚æ‡‚ï¼Œä½†è‡³å°‘æœ‰å€‹å…¨å±€çš„èªçŸ¥èˆ‡ä»‹ç´¹ï¼Œä¸‹ä¸€ç« å¾å½±ç‰‡è™•ç†åˆ°Playlistä¿®æ”¹ï¼Œä¾†çœ‹å¯¦éš›æ‡‰ç”¨çš„è™•ç†ã€‚\nè¨»è¨˜ å½±ç‰‡ç·¨ç¢¼ åƒè€ƒç¶­åŸºç™¾ç§‘\nè¦–è¨Šå£“ç¸®åœ–åƒé¡å‹ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦\nå½±åƒæ˜¯ä¸€å¹€ä¸€å¹€çš„åœ–ç‰‡é€£çºŒå¿«é€Ÿæ’­æ”¾ï¼Œä½†å¦‚æœå„²å­˜æ™‚æŠŠæ¯ä¸€å¹€éƒ½ç”¨åœ–ç‰‡æ–¹å¼å„²å­˜è³‡æ–™é‡æœƒéå¸¸å¤§ï¼Œä½†æ˜¯å½±ç‰‡å¾€å¾€ä¸€æ®µæ™‚é–“çš„å ´æ™¯é›·åŒï¼Œå¦‚æœæˆ‘å¯ä»¥å…ˆè¨˜ç¬¬ä¸€å¼µåœ–ï¼Œå…¶é¤˜å»è¨ˆç®—ç¬¬äºŒå¼µèˆ‡ç¬¬ä¸€å¼µå·®å¤šå°‘çš„æ¦‚å¿µå»å„²å­˜ï¼Œå°±å¯ä»¥é¿å…å„²å­˜éå¤šç›¸åŒå†—ä½™çš„æ•¸æ“š\nä½†å› ç‚ºè¦é¿å…æ‰äº†ä¸€é»è³‡æ–™å°±å…¨æ¯€ï¼Œä¿ç•™ä¸€äº›å½ˆæ€§æ‰€ä»¥æœƒåœ¨ä¸åŒæ™‚åˆ»å®‰æ’å–å…¨åœ–çš„æ™‚æ©Ÿã€‚\nå½±ç‰‡å£“ç¸®é€éå»ºç«‹ I-Frame / P-Frame / B-Frameæ–¹å¼\nI-Frame é—œéµå½±æ ¼ï¼ŒåŸºæœ¬ä¸Šå°±å„²å­˜ä¸¦å£“ç¸®æ•´å¼µåœ–ï¼Œä½œç‚ºå…¶ä»–Frameè§£ç¢¼çš„ä¾æ“š\nP-Frameå‰‡åƒ…å„²å­˜èˆ‡ä¸Šä¸€å€‹ I Frameå·®ç•°çš„åƒç´ \nB-Frameå‰‡ç‚ºå‰å¾Œé æ¸¬åœ–åƒï¼Œæœƒåƒè€ƒå‰ä¸€å€‹ I-Frame èˆ‡å¾Œä¸€å€‹ P-Frame\næ‰€ä»¥å¤§è‡´æœƒé•·æˆ IBB..PIBB..Pï¼Œå– I-Frame / B-Frame çš„é »ç‡å¯ä»¥åœæ•´\nå½±éŸ³æª”èˆ‡ FFMpeg æ•™å­¸ï¼šffmpeg-libav-tutorial\n","date":"2018-09-24T09:54:09.34Z","permalink":"https://yuanchieh.page/posts/2018/2018-09-24-hls-%E6%95%99%E5%AD%B8-%E4%B8%8A-%E5%BE%9E%E9%96%B1%E8%AE%80spec-%E9%96%8B%E5%A7%8B/","title":"HLS æ•™å­¸ (ä¸Š) â€” å¾é–±è®€Spec é–‹å§‹"},{"content":"åœ¨å¤§é‡è³‡æ–™éœ€è¦å„²å­˜ä¸‹ï¼Œå¯ä»¥å°‡ MongoDBåš Sharding èˆ‡ Replica Set è¨­ç½®ï¼Œå¢åŠ DBçš„ååé‡èˆ‡å¯ç”¨æ€§ã€‚\nåƒè€ƒ MongoDBçš„å®˜ç¶²ï¼Œå¯ä»¥å¾ˆç°¡å–®çš„å°±æ¶èµ· Shard Cluster æ¶æ§‹ï¼Œä»¥ä¸‹ç°¡å–®è¨˜éŒ„å¯¦ä½œéç¨‹ã€‚\nç›®å‰ä½¿ç”¨ v3.4ï¼Œä¸æ¡ç”¨æœ€æ–°ç‰ˆ 4.0 æ˜¯å› ç‚ºå…¬å¸ç’°å¢ƒç”¨ 3.4ï¼Œä½†çœ‹äº†æ–‡ä»¶å¥½åƒå·®ä¸å¤ªå¤šã€‚\nWebinar: Everything You Need to Know about Sharding\nå¼·çƒˆå»ºè­°çœ‹å®Œé€™éƒ¨ä¸€å°æ™‚çš„å½±ç‰‡ï¼Œæ•´å€‹è§€å¿µéå¸¸æ¸…æ¥šã€‚\nè³‡æ–™åº«è¨­å®šå¿…é ˆå¾æœ€ä¸€é–‹å§‹çš„\nã€Œæœƒæœ‰å¤šå°‘è³‡æ–™è¦å„²å­˜ï¼Ÿ çµæ§‹å¤§æ¦‚æ˜¯å¦‚ä½•ï¼Ÿ éœ€è¦ä¿å­˜å¤šä¹…æˆ–æ˜¯æœ‰ä»€éº¼æ¥­å‹™éœ€æ±‚ï¼Ÿå¯«å…¥æœƒå¤§æ¦‚æ˜¯æ€æ¨£æƒ…æ³ï¼Ÿè®€å–åˆæœƒæ˜¯å¦‚ä½•ï¼Ÿæœƒéœ€è¦é«˜ååé‡åˆæˆ–æ˜¯ä½å»¶é²å—ï¼Ÿã€\né€™äº›å› å­æœƒæ ¹æœ¬æ€§æ±ºå®šè³‡æ–™åº«çš„è¨­è¨ˆï¼ŒåŒ…å« æ˜¯å¦è¦ sharding / databaseã€collectionã€index å¦‚ä½•è¨­è¨ˆï¼Œç”šè‡³æ˜¯ä¸»æ©Ÿçš„è¦æ ¼èˆ‡åœ°é»é¸æ“‡ã€‚\næ¶æ§‹åœ– æˆªåœ–è‡ªå®˜ç¶²\nä¸»è¦æœ‰ä¸‰å€‹éƒ¨åˆ†ï¼š\nMongosï¼šå°å¤–é€£æ¥ DB Client æ¥æ”¶å°DBçš„è®€å¯«ï¼Œæ¥è‘—å†æ ¹æ“š Config Server æ±ºå®šåˆ°å“ªå€‹ Shard è®€å¯«(æœƒcacheä½æŸ¥è©¢çµæœ) Config Serverï¼šç´€éŒ„ metadataèˆ‡è³‡æ–™åœ¨å“ªå€‹ shard ä¸Šï¼Œ3.4ä¹‹å¾Œå¿…é ˆæ˜¯replica set æ¶æ§‹ Shardï¼šåˆ†ç‰‡å„²å­˜è³‡æ–™è™•ï¼Œå»ºè­°æ¡ç”¨ replica set æ¶æ§‹ æœ€åŸºæœ¬è¦é–‹ 1å° Mongos / 3 å° Config Server / 2 çµ„Shard Replica Set å…± 11å°ï¼Œåˆ†äº«ä¸€ä¸‹æˆ‘åœ¨ AWS ä¸Šé–‹ 11å° t2.nano é… EBS ä¸€å¤©å¤§æ¦‚å…©ç¾é‡‘ã€‚\nä»¥ä¸‹é è¨­æ¯å°æ©Ÿå™¨éƒ½å®‰è£å¥½ mongo@3.4\nå¯¦ä½œ Config server å› ç‚ºæœ‰äº›è¨­å®šæª”å¯«æˆ config fileæ¯”è¼ƒæ–¹ä¾¿ï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„ mongo.conf\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # mongod.conf # for documentation of all options, see: # [http://docs.mongodb.org/manual/reference/configuration-options/](http://docs.mongodb.org/manual/reference/configuration-options/) # where to write logging data. systemLog: destination: file logAppend: true path: /var/log/mongodb/mongod.log # Where and how to store data. storage: dbPath: /home/ec2-user/fs journal: enabled: true # how the process runs processManagement: fork: true # fork and run in background pidFilePath: /var/run/mongodb/mongod.pid # location of pidfile # network interfaces net: port: 27017 bindIp: 172.31.26.157,127.0.0.1 # Listen to local interface only, comment to listen on all interfaces. sharding: clusterRole: configsvr replication: replSetName: config_replica ä¸‰å€‹åƒæ•¸è¦æ³¨æ„ï¼Œå…¶ä»–éƒ½æ˜¯é è¨­å€¼\nshardingï¼š\né—œæ–¼shardingçš„è¨­å®šï¼Œè¨˜å¾—config server éƒ½å¿…é ˆè¨­æˆclusterRole: configsvr replicationï¼š\næ¯å€‹replica set éƒ½è¦ä¸€çµ„ nameåˆ†è¾¨ netï¼š\næ³¨æ„ bindIp é™¤äº† 127.0.0.1 å¤–ï¼Œé‚„è¦åŠ ä¸€å€‹å…¶ä»–æ©Ÿå™¨å¯ä»¥æŸ¥æ‰¾çš„ipï¼Œå› ç‚ºreplica set æ©Ÿå™¨é–“å¿…é ˆè¦å¯ä»¥æºé€šï¼Œé€™é‚Šæˆ‘æ˜¯ç”¨å…§éƒ¨IP\nå¦å¤– 127.0.0.1ä¹Ÿè¦ä¿ç•™ï¼Œæœ‰äº›æ¬Šé™æ“ä½œå¿…é ˆç”¨ localhost(å¦‚é—œé–‰Server) å•Ÿå‹• server æŒ‡ä»¤æ˜¯\nsudo mongod \u0026ndash;config mongo.conf \u0026ndash;fork \u0026ndash;syslog\nåŠ  â€”-forkæ˜¯ç‚ºäº†è·‘åœ¨èƒŒæ™¯ï¼Œä¸‰å° config server éƒ½ä¸€æ¨£ï¼Œæ¥è‘—é¸ä¸€å°ç•¶ä½œ Primaryï¼Œé€²å…¥å¾Œåš replica set è¨­å®š\né€™éƒ¨åˆ†å› ç‚ºæˆ‘çœ‹ä¸€é–‹å§‹çš„config ä¸èƒ½å¯«åœ¨ä¸€èµ·ï¼Œå¿…é ˆè¦ mongodå•Ÿå‹•å¾Œå†åŸ·è¡Œï¼Œæˆ‘æ˜¯å¦å¤–å¯«scriptï¼Œæ¥è‘—ç›´æ¥å–‚é€² mongo shell åŸ·è¡Œ\nreplica.jsï¼Œ_idå°æ‡‰æ˜¯å‰›æ‰çš„ replicaSetNameï¼Œmemberså°±æ˜¯ä¸‰å° config serverï¼Œæ³¨æ„è¦æ˜¯å¯ä»¥é€£ç·šçš„ ipã€‚\n1 2 3 4 5 6 7 8 9 rs.initiate({ _id: \u0026#34;config_replica\u0026#34;, configsvr: true, members: [ {_id: 0, host: \u0026#34;172.31.26.157:27017\u0026#34;}, {_id: 1, host: \u0026#34;172.31.23.205:27017\u0026#34;}, {_id: 2, host: \u0026#34;172.31.16.98:27017\u0026#34;}, ] }) æŒ‡ä»¤æ˜¯\nmongo \u0026lt; replica.js\nSharding Cluster é€™éƒ¨åˆ†ä¹Ÿå·®ä¸å¤šï¼Œåªå·®åœ¨ mongo.confçš„sharding åƒæ•¸\nsharding:\nclusterRole: shardsvr\nå‰©ä¸‹çš„ replica set è¨­å®šéƒ½è·Ÿ config server ä¸€æ¨£\nMongos æ¥ä¸‹ä¾†æ˜¯Mongosï¼ŒåŒæ¨£ç”¨mongo.conf å•Ÿå‹• mongos\n1 2 3 // mongos.conf sharding: configDB: config_replica/172.31.26.157:27017,172.31.23.205:27017,172.31.16.98:27017 åŸ·è¡ŒæŒ‡ä»¤\nsudo mongos \u0026ndash;config mongos.conf \u0026ndash;fork \u0026ndash;syslog\næ¥è‘—å°±æ˜¯è¨­å®š shardingï¼Œé€™é‚Šä¸€æ¨£å¯«å€‹ js script\nsh.addShard( \u0026ldquo;/,,\u0026rdquo;)\n\u0026hellip;. æœ‰å¹¾å€‹åŠ å¹¾å€‹\né€™æ¨£å°±å®Œæˆäº†\næ¥è‘—å¯ä»¥ç™»å…¥ mongo shell æª¢æŸ¥\n1 sh.status() å½±ç‰‡å»ºè­°å°‡ mongos èˆ‡ APP Server æ”¾åœ¨ä¸€èµ·\nè¨­å®š Sharding æ¶è¨­å¥½äº†ä¹‹å¾Œï¼Œæ¥è‘—å°±æ˜¯è¦è¨­å®š sharding æ©Ÿåˆ¶ï¼Œç›®å‰å¯ä»¥é‡å°æŸå€‹DBçš„æŸå€‹Collection çš„ Key åš hash shard / range shardï¼Œ\nrange shard æ˜¯ç•¶ key åœ¨æŸå€‹ç¯„åœå…§å°±å¾€å“ªé‚Šå¡ï¼›\nhash shard å‰‡æ˜¯æœƒæŠŠ key åš hash æ¯”è¼ƒå®¹æ˜“åˆ†æ•£ã€‚\n// ä»¥ä¸‹æŒ‡ä»¤åœ¨ mongo shell\n// é¦–å…ˆå•Ÿå‹•sharding\nsh.enableSharding(\u0026quot;\u0026quot;)\n// é‡å°æŸå€‹ collection è¨­å®š\nsh.shardCollection(\u0026quot;.\u0026quot;, { : })\n1 2 3 // example sh.shardCollection(\u0026#34;test.test2\u0026#34;, {\u0026#34;name\u0026#34;: \u0026#34;hashed\u0026#34;}) sh.shardCollection(\u0026#34;test.test\u0026#34;, {\u0026#34;name\u0026#34;: 1}) å¿…é ˆæ³¨æ„åˆ°å¦‚æœåœ¨sharding å‰collectionè£¡é¢å°±æœ‰å€¼ï¼Œè¦å…ˆå»ºç«‹ index æ‰å¯ä»¥è¨­å®š shardã€‚\næŸ¥çœ‹ç‹€æ…‹å¯ä»¥ç”¨ sh.status()\næ³¨æ„äº‹é … æœ‰è »å¤šå°ç´°ç¯€èˆ‡é™åˆ¶è¦æ³¨æ„\nChunk Sizeï¼š Chunk æ˜¯åˆ†ç‰‡å„²å­˜çš„ä¸€å€‹å–®ä½ï¼Œæ¯ç•¶æœ‰å¯«å…¥ç´€éŒ„æ™‚æœƒå¡åˆ°Chunkä¸­ï¼Œå¦‚æœè¶…éChunk Size ï¼ŒBalancer å¹³è¡¡å™¨å°±æœƒæŠŠChunk æ‹†æˆå…©åŠåˆ†æ•£åˆ°ä¸åŒçš„Shardå»\næ‰€ä»¥å¦‚æœ Chunk size å¤ªå°æœƒé€ æˆéåº¦é »ç¹çš„æ‹†åˆ†èˆ‡æ¬é·ï¼Œå°è‡´æ€§èƒ½ä½è½ï¼›\nå¦‚æœChunk size éå¤§å‰‡æœƒé€ æˆè³‡æ–™åˆ†æ•£ä¸å‡å‹»\n1 2 3 // in Mongos server -\u0026gt; mongo shell use config db.settings.save( { _id:\u0026#34;chunksize\u0026#34;, value: \u0026lt;sizeInMB\u0026gt; } ) ç‰¹åˆ¥æ³¨æ„ï¼ŒMongoDBåˆå§‹åŒ–çš„ chunk size ç‚º 1ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„å¯«å…¥ä¸€é–‹å§‹éƒ½æœƒå¾€ä¸€å€‹ chunk å¡ï¼Œå°è‡´å¾ŒçºŒçš„å†å¹³è¡¡å¾ˆæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥å»ºè­°è¦èª¿æ•´ numInitialChunks æˆ–æ˜¯è‡ªè¡Œåˆå§‹åŒ– chunk sizeã€‚\nhttps://docs.mongodb.com/manual/reference/method/sh.shardCollection/\nhttps://docs.mongodb.com/manual/tutorial/create-chunks-in-sharded-cluster/\nsharding key: å·²çŸ¥ chunk è¶…ésize æœƒç”± Balancer è² è²¬å¹³è¡¡ï¼Œå¦‚æœå¯ä»¥åœ¨ä¸€é–‹å§‹é¸å¥½ä¸€é»çš„ sharding key å°±èƒ½é¿å…å¤ªå¤šæ¬¡çš„æ‹†åˆ†èˆ‡å¹³è¡¡ï¼Œè®“è³‡æ–™å‡å‹»çš„æ•£ä½ˆã€‚\né¸æ“‡ range shardï¼Œè¦é¿å…é¸æ“‡æœƒéå¢çš„Keyï¼Œä¾‹å¦‚é è¨­çš„_id ï¼Œé è¨­_id æ˜¯æœƒéš¨è‘— timestamp è€Œéå¢ï¼Œé€™æœƒå°è‡´æ’å…¥æ–°è³‡æ–™éƒ½åªæœƒæ’åˆ°åŒä¸€å€‹ chunk ä¸­ï¼Œå‹¢å¿…è¦ä¸æ–·çš„æ‹†åˆ†ï¼\nå¦‚æœè¦ç”¨ _idï¼Œå°±å¾ˆé©åˆç”¨ hash shardï¼Œå› ç‚ºé€é hash function éå¢çš„keyä¹Ÿæ¯”è¼ƒæœƒè¢«å‡å‹»åˆ†æ•£ï¼›\nåœ¨é…ç½® hash shardä¸Šï¼Œå¦‚æœä¸€é–‹å§‹ collection æ˜¯ç©ºçš„ï¼ŒMongoDBå¯ä»¥è¨­å®š numInitialChunksè¦åˆå§‹åŒ–å¤šå°‘å€‹ chunkï¼›\nä½†è¦è¨˜å¾— key ä¸èƒ½æ˜¯ float ï¼Œå› ç‚º hash function æœƒæŠŠ key å…ˆè½‰ä¹˜ 64 bit intï¼Œæ‰€ä»¥ 2.1 / 2.2 / 2.9 éƒ½æœƒè¢«åˆ†æ•£åˆ°åŒä¸€å€‹ chunk ä¸Šã€‚\nåƒè€ƒå½±ç‰‡çš„æ­¥é©Ÿï¼Œ\nå¦‚æœé¸å‰‡ data center id ä¸æ˜¯å¥½çš„idï¼Œå› ç‚ºå¯èƒ½é€ æˆè³‡æ–™ä¸å¹³å‡ å¦‚æœé¸æ“‡ timestamp ä¸æ˜¯å¥½ id ï¼Œå› ç‚ºæ˜¯éå¢ï¼Œæ‰€ä»¥æ–°å¢æœƒæ’åˆ°åŒä¸€å€‹ chunk å¦‚æœé¸æ“‡ hash(timestamp) ä¸æ˜¯å¥½ idï¼Œå› ç‚ºè®€å–æ™‚æœƒéœ€è¦åˆ°å¤šå€‹ shard é¸æ“‡ device_id é…åˆ hash shard æ˜¯å€‹ä¸éŒ¯é¸æ“‡(å‡è¨­ device_id æ˜¯å›ºå®šçš„ä¸”æ¯å€‹ device ç”Ÿæˆå·®ä¸å¤šçš„è³‡æ–™) ä½†å¦‚æœè®€å–å¤§å¤šæ˜¯è¦è®€æŸå€‹è£ç½®è¿‘æœŸæŸå€‹æ™‚é–“çš„è³‡æ–™ï¼Œé‚£æ”¹ç”¨ (device_id, timestamp) çš„çµ„åˆ key æœ€ç†æƒ³ã€‚ 1. Cardinality é«˜åº¦ç•°è³ªæ€§\n2. Write distributed å¯«å…¥åˆ†å¸ƒå‡å‹»\n3. Query isolation è®€å–å¯ä»¥é›†ä¸­æ–¼åŒä¸€å€‹ shard\n4. reliability å¦‚æœæŸå€‹shardæ›äº†ï¼Œç›¡é‡ä¸è¦å½±éŸ¿åˆ°æ‰€æœ‰çš„æœå°‹\n5. Index locality ç›¡é‡è®“è®€å–å¯ä»¥å¥—ç”¨æœ€å¤šçš„ç´¢å¼•\næ³¨æ„ï¼šshard key è¨­å®šäº†å°±ä¸èƒ½æ”¹è®Šï¼Œå¦‚æœè¦æ”¹å°±å¿…é ˆé‡æ–° shardingï¼Œå‹™å¿…è¬¹æ…ã€‚\næŒ‡ä»¤é™åˆ¶ æ ¹æ“šæ–‡ä»¶ ï¼Œé‡å°å–®ä¸€æ–‡æª”æ“ä½œå¦‚ updateOne / deleteOneå¿…é ˆé™„å¸¶ shard keyï¼›\n$group ä¸èƒ½ä½¿ç”¨ï¼Œå¿…é ˆæ”¹ç”¨ mapReduce / aggregate æ–¹æ³•ã€‚\næ¯å€‹ shard key éƒ½å¿…é ˆæ˜¯ indexæˆ–æ˜¯ compound indexçš„prefixï¼ŒåŒæ™‚å¯ä»¥è¨­å®šç‚º uniqueï¼Œä½†å¿…é ˆéµå®ˆ\n1. å¦‚æœè©²æ–‡æª”å·²ç¶“ shardedï¼Œä¸èƒ½æŠŠå…¶ä»–æ¬„ä½è¨­ç‚º unique\n2. å¦‚æœå…¶ä»–æ¬„ä½æ˜¯ uniqueï¼Œå‰‡ç„¡æ³•å°æ­¤æ–‡æª” shard\nç¸½ä¹‹ï¼Œè¦unique åªèƒ½æ˜¯ shard keyæ¬„ä½ã€‚\nTag-Aware Shard é™¤äº†range shard / hash shardä¹‹å¤–ï¼Œé‚„å¯ä»¥é‡å°å€‹åˆ¥ shard åšæ¨™è¨˜ï¼Œæ¥è‘—å°±å¯ä»¥é€éæ¢ä»¶è¨­å®šè®“æŸäº›è³‡æ–™å›ºå®šå„²å­˜åœ¨è©²shardä¸Šï¼Œé€™æ¨£æœ€å¤§çš„å¥½è™•æ˜¯å¯ä»¥åšåœ°ç†ä½ç½®å„ªåŒ– ï¼Œä¾‹å¦‚ç¾åœ‹ç”¨æˆ¶å°±å¯ä»¥è®€å¯«åœ¨ç¾åœ‹å€çš„ shardä¸Šã€‚\n1. å…ˆå¢åŠ Tag\nsh.addShardTag(, \u0026ldquo;EU\u0026rdquo;)\n2. æŒ‡å®š tag shard çš„æ¢ä»¶ï¼Œå¯ä»¥è¨­ç½®å¤šå€‹\n1 2 3 4 5 6 7 8 9 10 11 12 sh.addTagRange( \u0026#34;chat.messages\u0026#34;, { \u0026#34;country\u0026#34; : \u0026#34;US\u0026#34;, \u0026#34;userid\u0026#34; : MinKey }, { \u0026#34;country\u0026#34; : \u0026#34;US\u0026#34;, \u0026#34;userid\u0026#34; : MaxKey }, \u0026#34;NA\u0026#34; ) sh.addTagRange( \u0026#34;chat.messages\u0026#34;, { \u0026#34;country\u0026#34; : \u0026#34;DE\u0026#34;, \u0026#34;userid\u0026#34; : MinKey }, { \u0026#34;country\u0026#34; : \u0026#34;DE\u0026#34;, \u0026#34;userid\u0026#34; : MaxKey }, \u0026#34;EU\u0026#34; ) æ¥è‘— mongodb å°±æœƒè‡ªå‹•å¹³è¡¡\nåƒè€ƒè³‡æ–™ éå¸¸è©³ç´°çš„ç°¡ä¸­æ–‡ç« ï¼šhttp://www.cnblogs.com/zhoujinyi/p/4635444.html\nå‚™è¨» æ ¹æ“šå®˜ç¶²ï¼Œæœ€å¥½è¦æœ‰å®‰å…¨è¨­å®šèˆ‡è§’è‰²é…ç½®ï¼Œå¯¦ä½œä¸Šå¿…é ˆè¦ç‰¹åˆ¥ç•™æ„ã€‚\n","date":"2018-09-08T07:53:36.68Z","permalink":"https://yuanchieh.page/posts/2018/2018-09-08-mongodb-shard-cluster-%E6%9E%B6%E8%A8%AD/","title":"MongoDB Shard Cluster æ¶è¨­"},{"content":"ä»¥å‰åªæ³¨é‡æŠŠåŠŸèƒ½å¯«å‡ºä¾†è€Œå·²ï¼Œæ…¢æ…¢åœ°é–‹å§‹ç¶­è­·å¾Œç™¼ç¾ä¸€é–‹å§‹çš„ç³»çµ±è¦åŠƒå¾ˆé‡è¦ï¼ŒåŒ…å«åŸºæœ¬çš„ Loggin / Debugging / Error Handlingï¼Œä»¥åŠæ˜¯å¦èƒ½å°‡æ¯å€‹ç‰©ä»¶å‡½å¼ä¹¾æ·¨æ‹†åˆ†[é¿å…éå¤šå‰¯ä½œç”¨ç„¡æ³•ç·¨å¯«æ¸¬è©¦](https://medium.com\næ­¤æ¬¡ä¸»è¦ç ”ç©¶ Express èˆ‡ Koa æ¡†æ¶ä¸‹ç·¨å¯«å¦‚ä½•åšéŒ¯èª¤è™•ç†ã€‚\nåŸæœ¬çš„å¯«æ³• åœ¨æœ€ä¸€é–‹å§‹ä½¿ç”¨Promiseæ™‚ï¼Œéƒ½ç¿’æ…£å€‹åˆ¥Promise.catch è™•ç†éŒ¯èª¤ï¼›\nä¹‹å¾Œç”¨ä¸Šäº† async / await ï¼Œä¹Ÿéƒ½ç¿’æ…£ç”¨ try{}catch(){} å€‹åˆ¥è™•ç†ï¼›\n1 2 3 4 5 6 7 8 9 10 11 function handle(req, res) { Promise1().then(data =\u0026gt; ....).catch(err =\u0026gt; handleError(err)) } async function handle(ctx){ try{ await Promise1() }catch(err){ hanleError(err) } } é€™æ¨£çš„å¯«æ³•ç¼ºé»åœ¨æ–¼æ¯å€‹å‡½å¼éƒ½å¿…é ˆé‡è¤‡ä¸€æ¨£çš„äº‹æƒ…(ä¸æ–· try catch)ï¼Œæ­¤å¤–å›å‚³ http status code / error message å¾ˆå¤šéƒ½æœƒé‡è¤‡ï¼Œä¹Ÿæ˜¯æ­¤æ¬¡æƒ³è¦æ”¹è®Šçš„å•é¡Œï¼Œå¸Œæœ›æ”¹ä»¥çµ±ä¸€æ‹‹å‡ºéŒ¯èª¤ä¸¦è¨»å†Šä¸€å€‹Middlewareå°ˆé–€è™•ç†éŒ¯èª¤ã€‚\næ”¹å–„å¯«æ³• Koa å…ˆä¾†çœ‹Koaå¦‚ä½•å¯¦ä½œï¼Œä»¥ä¸‹æ˜¯ä¸€èˆ¬ä½¿ç”¨æ–¹å¼\n1 2 3 4 5 6 const Koa = require(\u0026#39;koa\u0026#39;); const app = new Koa(); app.use(async (ctx, next){...}); app.listen(3000); ç•¶æˆ‘å€‘å‰µå»ºä¸€å€‹ Koa çš„ instance appå¾Œï¼Œæ¥è‘—å°±æœƒç”¨ app.use è¨»å†Šæ‰€æœ‰çš„ Middlewareï¼Œæœ€å¾Œå°±æ˜¯ app.listen å•Ÿå‹•\nåœ¨ Koa åŸå§‹ç¢¼ç•¶ä¸­ï¼Œ new Koa()ä¸­é‡è¦çš„ä¸€æ®µåŸå§‹ç¢¼æ˜¯\nreturn fnMiddleware(ctx).then(handleResponse).catch(onerror);\nKoa è™•ç†çš„é †åºæ˜¯ fnMiddlewareå°‡ app.use()è¨»å†Šçš„å…¨éƒ¨Middlewareè½‰æˆ Promise chain -\u0026gt; hanldeResponse(å‘¼å« res.endé€å‡º http respond) / onerror (è™•ç†éŒ¯èª¤)\nPromise chain(è‡ªå®šç¾©çš„) æ˜¯æŒ‡ç•¶ Koa Middleware å‘¼å« next() æœƒéè¿´å‘¼å«ä¸‹ä¸€å€‹ Middlewareï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡æ–‡ç«  Koa2 æºç¢¼è§£æâ€Šâ€”â€Šç°¡æ½”ç¾éº—çš„æ¡†æ¶\né€™éƒ¨åˆ†çš„éŒ¯èª¤è™•ç†åˆå¯æ‹†æˆå…©å¡Šï¼Œä¸€å€‹æ˜¯ appå±¤ç´š ä¸€å€‹æ˜¯ ctx å±¤ç´šï¼›\nåœ¨åŸå§‹ç¢¼ä¸­ /koa/application.jsï¼Œæœ‰é è¨­åŸºæœ¬çš„ onerrorçš„éŒ¯èª¤è™•ç†ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ‰“å°å‡ºä¾†ï¼Œé€™éƒ¨åˆ†æ˜¯é€é appæœ¬èº«ç¹¼æ‰¿ Event Emitterå±¬æ€§ä¸¦è¨»å†Š app.on(â€œerrorâ€) äº‹ä»¶å¾Œè™•ç†\nå¦ä¸€æ–¹é¢ç•¶ Server ç™¼ç”ŸéŒ¯èª¤ Client éƒ½æœƒæ”¶åˆ° Internal Server Error å›æ‡‰ï¼Œæ˜¯åœ¨ ctx.onerror è™•ç†ï¼Œä¸¦ app.emit(â€œerrorâ€)ï¼Œå®šç¾©æ–¼ /koa/context.js ä¸­ï¼›\nå°æ‡‰ä¸åŒçš„Http Status Code æœ‰ä¸åŒçš„å›æ‡‰ï¼Œé€™æ˜¯åŸºæ–¼statuses æ¨¡çµ„å®šç¾©çš„ã€‚\né€™è£¡æ¯”è¼ƒæ··äº‚çš„æ˜¯ app.onerror èˆ‡ ctx.onerror å‘¼å«æ™‚é–“æ˜¯äº¤éŒ¯çš„\nfnMiddleware(ctx).then(handleResponse).catch(onerror); çš„ onerror æ˜¯ (error) =\u0026gt; ctx.onerror(error) ctx.onerror æœƒ respond é è¨­çš„éŒ¯èª¤è™•ç†èˆ‡ app.emit(â€œerrorâ€) app.emit(â€œerrorâ€) æ˜¯ç”± app.onerror å»æ¥æ”¶ï¼Œé€™éƒ¨åˆ†å¯ä»¥è‡ªè¨‚ app.on(â€œerrorâ€, ()=\u0026gt;{è‡ªè¡Œè™•ç†}) å®˜æ–¹æ–‡ä»¶æœ‰å¯«åˆ°éŒ¯èª¤è™•ç†ï¼Œç”¨æˆ¶å¯è¨»å†Š error äº‹ä»¶å°±æœƒæ”¹ç”±ç”¨æˆ¶è‡ªå·±è™•ç†\napp.on(\u0026ldquo;error\u0026rdquo;, (err, ctx) =\u0026gt; {\u0026hellip;.})\nBUT!! é€™é‚Šçš„ ctx æ˜¯æ‹¿ä¾†çœ‹ context è³‡è¨Šï¼Œå¦‚æœæ˜¯å¸Œæœ›å®¢è£½åŒ–å›å‚³çš„éŒ¯èª¤æ˜¯æ²’è¾¦æ³•çš„å–”ï¼\nå› ç‚ºéŒ¯èª¤çš„ç‹€æ…‹ç¢¼èˆ‡å…§æ–‡ Reponse æ˜¯åœ¨ ctx.onerror å°±è™•ç†æ‰ã€‚\næ‰€ä»¥å¦‚æœè¦è‡ªå·±è™•ç†æ•´å€‹éŒ¯èª¤ï¼Œå¿…é ˆæ”¹ç”¨ Middleware ï¼Œè¨˜å¾—ç¬¬ä¸€å€‹å°±è¨»å†ŠéŒ¯èª¤è™•ç†æ‰å¯ä»¥æ•ç²æ‰€æœ‰çš„éŒ¯èª¤ï¼Œå¦‚ä»¥ä¸‹\nExpress Express å°æ¯” Koa æ˜¯å€‹æ¯”è¼ƒå…¨é¢çš„æ¡†æ¶ï¼Œå…§å«äº†åŸºæœ¬çš„ Middleware / Routerï¼Œç™¼é€Response æ–¹å¼ä¹Ÿä¸åƒ Koa æ˜¯æœ€å¾Œæ¡†æ¶å¹«ä½ ç™¼é€ï¼›\nè€Œæ˜¯å¿…é ˆè‡ªå·±ç”¨ res.send() ä¹‹é¡çš„èªæ³•è‡ªè¡Œç™¼é€ã€‚\nRouting æ©Ÿåˆ¶ è©³è«‹è«‹åƒè€ƒ expressæºç åˆ†æä¹‹Router\nåœ¨Express å¯¦ä¾‹åŒ–ä¹‹å¾Œæœ‰ä¸€å€‹ Router Instanceï¼Œæ¥è‘—æ¯å€‹è·¯ç”±æœƒå°æ˜ ä¸€å€‹ Routeï¼Œä¸€å€‹è·¯ç”±ä¸­å¯èƒ½æœ‰å¤šå€‹Middleware ç¨±ç‚º Layerï¼Œè³‡æ–™çµæ§‹å°±æ˜¯é™£åˆ—å„²å­˜ã€‚\nç•¶ä¸€å€‹ Request è¿‘ä¾†æœƒæµéä¾ç…§ Route ä¸­çš„è¨»å†Šé †åºæµé Layer ï¼Œæ¯å€‹Layer åˆ¤æ–·æ˜¯å¦ Match URLï¼Œå¦‚æœ Match å‰‡è™•ç†ï¼Œç™¼ç”ŸéŒ¯èª¤å‰‡èµ°éŒ¯èª¤è™•ç†\nç‰¹åˆ¥æ³¨æ„ æ­£å¸¸è™•ç†èˆ‡éŒ¯èª¤è™•ç†è·¯å¾‘æ˜¯åˆ†é–‹\n1 2 app.use((err, req, res, next)=\u0026gt;{}) å°æ‡‰æ˜¯ Layer.handle_error app.use((req, res, next)=\u0026gt;{}) å°æ‡‰æ˜¯ Layer.handle_request ç•¶ç™¼ç¾æœ‰ Middleware å‘¼å«äº† next(err)å¾Œï¼Œå°±é–‹å§‹èµ°éŒ¯èª¤è™•ç†ï¼Œä¹Ÿå°±æ˜¯å¾Œé¢çš„ Layer éƒ½æ˜¯å‘¼å« Layer.handle_error !\nåœ¨éŒ¯èª¤è™•ç†Express æ¡ç”¨ next(err) åœ¨Middleware é–“å‚³ééŒ¯èª¤ï¼Œæ‰€ä»¥ç•¶ Middleware æˆ–æ˜¯ Routing ä¸­æœ‰éŒ¯èª¤ä¸èƒ½ç›´æ¥æ‹‹å‡ºæˆ–ä¸è™•ç†ï¼Œå¿…é ˆè¦ç”¨ try{..}catch(error){next(error)} è™•ç†ï¼›\nä½†é€™æ¨£å°±æœƒå¾ˆéº»ç…©ï¼Œå› ç‚ºéƒ½å¿…é ˆç”¨ try catch åŒ…èµ·ä¾†ï¼ŒåŒç†åƒæ˜¯åŸç”Ÿçš„ Nodejs module å¦‚ fs éƒ½æ²’æœ‰ Promiseç‰ˆï¼Œæ‰€ä»¥éƒ½è¦è‡ªå·±å† Promisify å¾Œå‘¼å«ä¸€æ¨£çš„é“ç†(éº»ç…©)ã€‚\n(Using Async Await in Express with Node 9 æœ‰æåŠ)\nå¾Œä¾†çœ‹åˆ°ä¸€å€‹è » Hacking çš„æ–¹å¼ï¼Œexpress-async-errorsï¼Œä»–æœƒè¤‡å¯«Express/Layer.handle æ–¹æ³•ï¼ŒæŠŠæ¯å€‹ Routing Function çš„éŒ¯èª¤çµ±ä¸€ç”¨ next(error) å‚³é\nä»–è™•ç†çš„æ–¹å¼ä¹Ÿæ˜¯å¾ˆå¦™ï¼Œç°¡åŒ–å¾Œå¯ä»¥é€™æ¨£ç¤ºæ„\n1 2 3 let pE = async () =\u0026gt; {throw new Error(\u0026#34;error\u0026#34;)} let fn = pE.call() if(fn \u0026amp;\u0026amp; fn.catch) fn.catch(err =\u0026gt; console.log(err)) ä¹Ÿå°±æ˜¯å¦‚æœç™¼ç¾è¨»å†Šåœ¨Layerä¸­çš„Function æ˜¯ Async Functionï¼ŒAsync Function åŸ·è¡Œå¾Œæœƒå›å‚³ Promiseï¼Œæ¥è‘—å°±æ˜¯ç”¨ fn \u0026amp;\u0026amp; fn.catch åˆ¤æ–·æ˜¯å¦ç‚º Promiseï¼Œå¦‚æœæ˜¯å‰‡å¹«å¿™è£œä¸ŠÂ .catch((err) =\u0026gt; next(err)) ï¼Œè »è°æ˜çš„ä½œæ³•ã€‚\næ ¹æ“š Express Routing æ©Ÿåˆ¶ï¼ŒErrorHandling åœ¨ Express å¿…é ˆå®£å‘Šåœ¨æœ€å¾Œé¢\nçµèª å°±å€‹äººè§€é»ï¼ŒKoa ç›¸æ¯” Express ç¢ºå¯¦æ˜¯å€‹æ›´é€²æ­¥çš„æ¡†æ¶ï¼Œæœ€ä¸»è¦æ˜¯åœ¨ Middleware æ§‹å»ºèˆ‡åŸ·è¡Œä¸Šï¼ŒKoa æ˜¯å…ˆè½‰æˆé¡ä¼¼ Promise Chainï¼Œä¸¦é è¨­æœ‰åš Error Handlingï¼›\né€™æ¯”è¼ƒç¬¦åˆç¾åœ¨ä»¥ Promise ç‚ºåŸºç¤æ§‹å»ºçš„æ‡‰ç”¨ç¨‹å¼ï¼Œä¹Ÿä½¿å¾— Middleware è¨­è¨ˆèˆ‡éŒ¯èª¤è™•ç†ç›´è§€å¾ˆå¤šã€‚\nè€ŒExpress å¿…é ˆå¾ˆå½†æ‰­çš„ä½¿ç”¨ next(err)å‚³éï¼Œå°æ¯”å°±æœ‰é»åƒ callback hell çš„ error æ”¾åœ¨ function ç¬¬ä¸€ä½çš„å‚³çµ±å¯«æ³•ï¼›\nå¦å¤–æˆ‘ä¹Ÿæ˜¯ç¾åœ¨æ‰çŸ¥é“ app.use((err,req,res,next)=\u0026gt;{â€¦}) /app.use((req,res,next)=\u0026gt;{â€¦}) å·®ä¸€å€‹åƒæ•¸åœ¨ Express ä¸­å‘¼å«æ™‚æ©Ÿå®Œå…¨ä¸åŒï¼Œæ•´å€‹éŒ¯èª¤è™•ç†å¼„çš„æœ‰é»ä¸å¤ªç›´è§€ã€‚\nçœ‹åˆ°Github Issue è¨è«–æœ‰æåˆ° Express@5 æœƒåŠ å…¥æ›´å¥½çš„ async /await æ”¯æ´ï¼Œåˆ°æ™‚å†ä¾†çœ‹çœ‹åŸå§‹ç¢¼çš„æ›´å‹•ã€‚\n","date":"2018-08-27T07:20:36.575Z","permalink":"https://yuanchieh.page/posts/2018/2018-08-27-express-%E8%88%87-koa-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E9%8C%AF%E8%AA%A4/","title":"Express èˆ‡ Koa å¦‚ä½•è™•ç†éŒ¯èª¤"},{"content":"Postgresql å¯ä»¥ç”¨æ¬„ä½ jsonb å‹åˆ¥å„²å­˜ json æ ¼å¼çš„è³‡æ–™ï¼Œä¸¦æä¾›ä¸å°‘å…§å»ºçš„å‡½å¼å¯ä»¥å”åŠ©æŸ¥è©¢ï¼Œä»¥ä¸‹ç¨å¾®æ•´ç†ä¸€äº›å¸¸ç”¨çš„æƒ…æ™¯ã€‚\nç¤ºç¯„è³‡æ–™åº« DB Fiddle - SQL Database Playground\nåŸºæœ¬å°±æ˜¯æ˜¯ Orders / Products å…©å¼µè¡¨ï¼ŒOrders ä¸­è³‡æ–™ç”¨ data jsonb æ ¼å¼å­˜å„²ï¼ŒProducts å‰‡æ˜¯å¸¸è¦çš„æ¬„ä½å®šç¾©ã€‚\nOrders è³‡æ–™å¤§ç´„é•·é€™æ¨£\n1 2 3 4 5 6 { \u0026#34;id\u0026#34;: 1, \u0026#34;cost\u0026#34;: 200, \u0026#34;products\u0026#34;: [{\u0026#34;id\u0026#34;: 1, \u0026#34;nums\u0026#34;: 5}, {\u0026#34;id\u0026#34;: 2, \u0026#34;nums\u0026#34;: 3}], \u0026#34;details\u0026#34;: {\u0026#34;title\u0026#34;: \u0026#34;memo\u0026#34;} } æ“ä½œ JSON å¦‚æœæ˜¯è¦åš json çš„æ¬„ä½ç´¢å–ï¼Œå¯ä»¥ç”¨ -\u0026gt; ï¼Œå¦‚æœè¦å›å‚³å­—ä¸²çµæœç”¨ -\u0026gt;\u0026gt;\nä¾‹å¦‚èªª data-\u0026gt;â€™detailsâ€™-\u0026gt;\u0026gt;â€™titleâ€™ å°±æœƒå›å‚³ â€œmemoâ€\né™£åˆ—ä¹Ÿå¯ä»¥æŒ‡å®šå“ªå€‹ä½ç½®ï¼Œä¾‹å¦‚ data-\u0026gt;â€™productâ€™-\u0026gt;0-\u0026gt;â€™idâ€™\nä½¿ç”¨ä¸Šå¦‚æœæ˜¯ key ç”¨ ` å–®å¼•è™Ÿæ‹¬è‘—ï¼Œå¦‚æœæ˜¯é™£åˆ—ä½ç½®æ‰ä¸éœ€è¦ï¼Œä¸ç„¶æœƒä¸€ç›´å›å‚³ null\nå¦å¤–è¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯-\u0026gt;\u0026gt; éƒ½æ˜¯å›å‚³å­—ä¸²ï¼Œæ‰€ä»¥å¦‚æœè¦è·Ÿå…¶ä»–é¡å‹åšæ¯”å°ï¼Œéœ€è¦è‡ªå·±åšæ ¼å¼è½‰æ›ï¼Œä¾‹å¦‚ Cast( data-\u0026gt;\u0026gt;â€idâ€ as int ) = id æ‹¿ data.id è·Ÿ int å‹åˆ¥çš„è‡ªå¢ä¸»éµåšæ¯”å°\né™£åˆ—é•·åº¦ å¦‚æœæ˜¯æƒ³è¦çŸ¥é“é™£åˆ—çš„é•·åº¦æ˜¯å¤šå°‘ï¼Œå¯ä»¥ç”¨ jsonb_array_elements\nä¾‹å¦‚ jsonb_array_length(data-\u0026gt;â€™productsâ€™) \u0026gt; 2 ï¼Œé€™æœƒç›´æ¥å›å‚³ int\nKey æ˜¯å¦å­˜åœ¨ æœ‰ä¸‰ç¨®ç”¨æ³•ï¼Œ?â€™æ¯”å°keyâ€™ ?|[â€™æ¯”å°key1â€™, â€™æ¯”å°key2â€™] ?\u0026amp;[â€™æ¯”å°key1â€™, â€™æ¯”å°key2â€™] ï¼Œçµæœå›å‚³ boolean\nä¾‹å¦‚æ‰¾å‡º data ä¸­åŒ…å«`detail`æ¬„ä½çš„è³‡æ–™\nselect * from Orders where data?â€™detailâ€™;\n?| å‰‡æ˜¯å¾Œè€…é™£åˆ—ä¸­åªè¦å‘½ä¸­ä¸€å€‹å°±ç‚º trueï¼Œ?\u0026amp; å‰‡æ˜¯è¦é™£åˆ—ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½å­˜åœ¨æ‰æ˜¯ trueã€‚\næ”¤å¹³é™£åˆ— ç®—æ˜¯åšç¬¬ä¸€æ­£è¦åŒ–ï¼Œæˆ‘å¸Œæœ›é€é Join Products è¨ˆç®—æ¯ç­†è¨‚å–®çš„ç¸½é¡ï¼Œä½†å› ç‚º Orders ä¸­çš„ data-\u0026gt;product æ˜¯é™£åˆ—ï¼Œæ‰€ä»¥éœ€è¦ jsonb_array_elements ï¼Œjsonb_array_elements æœƒç›´æ¥å›å‚³ set\nselect jsonb_array_elements(data-\u0026gt;â€™productsâ€™) as product_item from Orders; é€™æ¨£å°±å¯ä»¥åšåˆ°ç¬¬ä¸€æ­£è¦åŒ–\næ¥è‘—è »ç¥å¥‡çš„æ˜¯å¯ä»¥ç›´æ¥å°‡ Order èˆ‡ jsonb_array_elements åš CROSS JOIN\n1 2 3 4 5 select Orders.id, Sum(Cast(product_item-\u0026gt;\u0026gt;\u0026#39;nums\u0026#39; as int) \\* Products.price) from Orders, jsonb_array_elements(data-\u0026gt;\u0026#39;products\u0026#39;) as product_item left join Products on Cast(product_item-\u0026gt;\u0026gt;\u0026#39;id\u0026#39; as int) = Products.id group by Orders.id; ä½†çµæœç«Ÿç„¶ä¸æ˜¯é æœŸçš„ç¬›å¡çˆ¾ç© N*Mï¼Œè€Œæ˜¯æœƒè‡ªå‹•å¹«ä½ æŠŠå±¬æ–¼è©²è¨‚å–®çš„ product å°æ‡‰å¥½ï¼Œåˆ°ç¾åœ¨é‚„æƒ³ä¸é€æ€éº¼æœƒé€™æ¨£ã€‚\njson vsÂ jsonb Postgresql æ”¯æ´å…©ç¨®åˆæ³• json å¯æ’å…¥çš„æ ¼å¼ json jsonb ï¼Œä½†å…©è€…æœ‰äº›å¾®çš„å·®ç•°\njson\nä»¥ç´”æ–‡å­—å‹æ…‹æ’å…¥ï¼ŒåŒ…å«ç©ºç™½ã€æ›è¡Œï¼ŒåŒæ™‚ä¿æŒåŸæœ¬çš„éµå€¼é †åº jsonb\nä»¥äºŒé€²åˆ¶æ–¹å¼å„²å­˜ï¼ŒæœƒæŠŠé‡è¤‡çš„éµå€¼å»é™¤(å¾Œè€…è¦†è“‹å‰è€…) jsonb æ”¯æ´ indexï¼Œåœ¨æ’å…¥æ™‚éœ€è¦è¼ƒé•·çš„æ™‚é–“ï¼Œä½†æ˜¯æŸ¥è©¢é€Ÿåº¦è¼ƒå¿«ï¼Œæ˜¯æ¯”è¼ƒé€šç”¨çš„é¸æ“‡æ ¼å¼ã€‚\nä½†å¦‚æœæœ‰éœ€è¦ä¿æŒåŸæœ¬éµå€¼é †åºã€æˆ–æ˜¯å–®ç´”æƒ³ä¿ç•™åŸæœ¬çš„ json æ ¼å¼æ‰ä½¿ç”¨ json æ ¼å¼\nåƒè€ƒè³‡æ–™\nhttps://my.oschina.net/swingcoder/blog/489769ã€https://stackoverflow.com/questions/22654170/explanation-of-jsonb-introduced-by-postgresql\nçµèª æœ‰çœ‹åˆ°ä¸€äº›å¯¦é©—æ˜¯æŠŠ Postgresql ç•¶ä½œ NoSQL ä½¿ç”¨ï¼Œä½†å€‹äººè¦ºå¾—é‚„æ˜¯åç©ç¥¨æ€§è³ªï¼Œé—œè¯å¼è³‡æ–™åº«é‚„æ˜¯éµå®ˆæ­£è¦åŒ–è¨­è¨ˆï¼Œåƒ…æŠŠ json ç•¶ä½œé¡å¤–çš„å½ˆæ€§å°±å¥½\n","date":"2018-08-23T08:36:20.503Z","permalink":"https://yuanchieh.page/posts/2018/2018-08-23-postgresql-json-%E6%93%8D%E4%BD%9C/","title":"PostgreSQL json æ“ä½œ"},{"content":"å¹³å¸¸å–œæ­¡æ°´ä¸Šæ´»å‹•ï¼Œä½†æ²’ç‰¹åˆ¥å–œæ­¡æ¸¸æ³³ï¼Œæ‰€ä»¥æ³³æŠ€ã€æ°´æ€§éƒ½å¾ˆå·®ï¼Œä¸€é–‹å§‹å…ˆå¾æ·å¼é‡æ–°å­¸èµ·ï¼Œå…©å€‹ç¦®æ‹œåŠ å¼·å¾Œå­¸æœƒæ›æ°£å‹‰å¼·å¯ä»¥éŠå®Œ50å…¬å°ºï¼Œæ¥è‘—å°±ç›´æ¥æŒ‘æˆ°æ•‘ç”Ÿå“¡è¨“ç·´ï¼ŒçœŸçš„æ˜¯ç”Ÿä¸å¦‚æ­»å•ŠXD\nè¨“ç·´èœå–® è¨“ç·´å¤§æ¦‚åˆ†æˆè‡ªæ•‘èˆ‡æ•‘äººï¼›\nè‡ªæ•‘ ä¸€é–‹å§‹æœ€åŸºæœ¬çš„æ¼‚æµ®ï¼Œåˆå¯åˆ†æˆæ°´æ¯æ¼‚ã€ä¿¯è‡¥æ¼‚ã€ä»°æ¼‚ã€ç›´ç«‹å¼æ¼‚æµ®ï¼›\nå…ˆç·´ç¿’å»ºç«‹è‡ªèº«æµ®åŠ›ï¼Œä»¥åŠæ›æ°£ï¼Œåœ¨æ›æ°£éç¨‹ä¸­å‹•ä½œè¦è¼•ï¼Œå·®ä¸å¤šå˜´å·´æµ®å‡ºæ°´é¢å¯ä»¥æ›æ°£å°±å¥½ï¼Œä¸è¦å¤ªç”¨åŠ›æ•´å€‹èƒ¸å£æµ®å‡ºï¼Œé¿å…åä½œç”¨åŠ›éå¤§åè€Œèº«é«”æœƒæ›´æ²‰\næ¥è‘—æ˜¯è¸©æ°´ ï¼Œä¹Ÿå°±æ˜¯ç«‹æ³³ï¼Œè®“èº«é«”ä¿æŒåœ¨åŸåœ°é ­éœ²å‡ºæ°´é¢ï¼Œæœ‰å‰ªåˆ€å¼è¸©æ°´ã€è›™å¼è¸©æ°´ã€æ”ªè›‹å¼è¸©æ°´ï¼Œé€™æ™‚å€™åŸºæœ¬ä¸Šæ˜¯æ”¾é¬†ä¼‘æ¯çš„æ™‚å€™ï¼Œè€Œä¸”é ­æµ®å‡ºæ°´é¢æ‰å¯ä»¥è½åˆ°æ•™ç·´çš„æŒ‡ä»¤\nå†ä¾†æ˜¯å€Ÿç‰©å»ºç«‹æµ®åŠ›ï¼Œå¦‚æœæ˜¯ç©¿è‘—è¡£æœè½æ°´ï¼Œå¯ä»¥é‹ç”¨è¡£ç‰©åšç·Šæ€¥æ°£å›Šï¼Œå»ºç«‹è‡ªèº«æµ®åŠ›ç­‰å¾…æ•‘æ´\næ•‘äºº ç•¶æˆ‘å€‘è§€å¯Ÿåˆ°æœ‰æººè€…æ™‚ï¼Œå…ˆå‡è¨­æ²’æœ‰å¤šé¤˜çš„å·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œåªèƒ½ä¾é æˆ‘å€‘è‡ªèº«çš„èƒ½åŠ›å»æ•‘æ´æ™‚ï¼Œæ•´å€‹æƒ…å¢ƒæœƒæ˜¯\nå¾å²¸é‚Šæˆ–æ± é‚Šå…¥æ°´ï¼Œæ¥è‘—æ¸¸æ³³éå»æ¥è¿‘æººè€…ï¼Œè§€å¯Ÿæººè€…ä¸¦æ¥è¿‘ä»–ï¼Œæ¥è‘—æƒ³è¾¦æ³•å°‡ä»–å¸¶å›å²¸ä¸Šï¼Œå¦‚æœé‡åˆ°åæŠ—æˆ–æŠ“æŠ±è¦æƒ³è¾¦æ³•æ™è„«ï¼Œå¸¶ä¸Šå²¸å¾Œè¦åšæ€¥æ•‘ç­‰å¾ŒçºŒè™•ç½®ã€‚\nåŸºæœ¬ä¸Šæ•´å¥—SOPæ˜¯\nå…¥æ°´æ³• -\u0026gt; å¾é è™•æ¥è¿‘æººè€… -\u0026gt; æ¥è¿‘æ³• -\u0026gt; å¸¶äººæ³• -\u0026gt; (å¦‚æœæººè€…æ™æ‰)è§£è„«æ³•ã€é˜²è¡›æ³• -\u0026gt; èµ·å²¸æ³• -\u0026gt; æ•‘æººå…«å¤§æ­¥é©Ÿ -\u0026gt; å¾ŒçºŒæ€¥æ•‘è™•ç†\nä¹Ÿå°±æ˜¯æˆ‘å€‘ä¸»è¦çš„è¨“ç·´èœå–®\nå…¥æ°´æ³• åˆåˆ†æˆéœå¼å…¥æ°´ï¼Œé©ç”¨æ–¼æ°´åŸŸä¸ç†Ÿæ‚‰æˆ–æ˜¯å‚·æ‚£æœ‰é ¸æ¤å—å‚·ä¹‹ç–‘æ…®æ™‚æ¡ç”¨ï¼Œå…¥æ°´æ™‚ä¸èƒ½æ¿€èµ·æ°´èŠ±ï¼›\nå¹³è·³å¼å…¥æ°´ï¼Œæœ‰é»åƒç«‹å®šè·³å¹³é£›å‡ºå»ï¼Œé›™æ‰‹äº¤ç–Šå¤§è‡‚è²¼ç·Šè€³æœµå£“é ­ï¼Œå…¥æ°´æ·ºå‡ºæ°´å¿«ï¼Œæœ‰å€‹åˆé€Ÿåº¦å¯ä»¥å¿«é€Ÿæ¥è¿‘æººè€…ï¼›\nè·¨æ­¥å¼å…¥æ°´ï¼Œé©ç”¨æ–¼æ°´æ·±è™•ï¼›æµ·é‚Šæœ‰æµªæ™‚ç”¨è·³èºå¼å…¥æ°´é™ä½æ°´é˜»ï¼›åœ¨æ•‘ç”Ÿè‰‡ä¸Šç”¨èƒŒæ»¾å¼å…¥æ°´ã€‚\næ¥è¿‘æººè€… ç•¶å¾å²¸é‚Šå…¥æ°´å¾Œï¼Œè·é›¢æººè€…æœ‰2ã€30å…¬å°ºä»¥ä¸Šï¼Œæ­¤æ™‚æœƒæ¡å–æŠ¬é ­æ·ã€æŠ¬é ­è›™ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ·ã€è›™å¼çš„æŠ¬é ­ç‰ˆï¼Œå› ç‚ºã€Œæ‰€æœ‰å‹•ä½œçœ¼ç›éƒ½ä¸èƒ½é›¢é–‹æººè€…ã€é¿å…æ°´æµæˆ–æ˜¯æ²ˆåˆ°æ°´åº•æ‰¾ä¸åˆ°\næŠ¬é ­è›™åŸºæœ¬ä¸Šæ¯”è¼ƒç°¡å–®ï¼Œä½†æ˜¯æŠ¬é ­æ·å°±æ¯”æ·å¼ç´¯å¾—å¤šå¾ˆå¤šï¼Œå› ç‚ºé ­æŠ¬èµ·è…³ç›¸å°ä¸‹æ²‰ï¼Œä¸€é–‹å§‹åˆ’æ‰‹æŠ“æ°´éƒ½æœƒååˆ†è²»å‹\næ¥è¿‘æ³• ç•¶é è¿‘æººè€… 2å…¬å°ºå·¦å³è¦å´èº«è§€å¯Ÿï¼Œç¢ºå®šå¥½è‡ªèº«å®‰å…¨ã€å‘¨åœç’°å¢ƒèˆ‡æººè€…ç‹€æ…‹å¾Œæ‰å¾ŒçºŒå‹•ä½œï¼Œé¿å…å±éšªç™¼ç”Ÿæˆ–æ˜¯è¢«æººè€…æŠ“æŠ±ã€‚\nå¦‚æœæººè€…ç„¡æ„è­˜å°±ç›´æ¥æŠ“æ‰‹è½‰å›ä»°é¢å¾€å›å¸¶ï¼Œç›¸å°æ–¼æººè€…çš„ç›¸å°ä½ç½®é‚„æœ‰æ­£é¢è¿‚è¿´æ¥è¿‘ã€èƒŒé¢æ¥è¿‘ã€æ°´ä¸­æ°´åº•æ¥è¿‘\nä¸»è¦å°±æ˜¯å°‡æººè€…è½‰å›ä»°é¢ï¼Œç”¨åŸºæœ¬ä»°å¸¶å‹•ã€‚\nè§£è„«æ³• æººè€…å› ç‚ºæ±‚ç”Ÿæ„å¿—è‡ªç„¶æœƒå››è™•æŠ“æŠ±ç‰©é«”ï¼Œä½†æ•‘æ´è·¯ä¸Šæœ€æ€•è¢«æŠ“æŠ±ï¼Œå› ç‚ºæœƒæ¶ˆè€—é›™æ–¹åŠ›æ°£ä¸”éå¸¸å±éšªï¼Œä¸€ä¸å°å¿ƒé€£è‡ªå·±çš„å‘½éƒ½è³ ä¸Šå»\né‡åˆ°æŠ“æŠ±ï¼Œæœ‰åˆ†æˆè¢«æŠ“ä½æ‰‹è…•æ™‚çš„å–®æ‰‹è§£è„«ï¼Œè¢«æººè€…æ­£é¢ç’°æŠ±çš„æ­£é¢æ¨è‚˜è§£è„«èˆ‡èƒŒé¢ç’°æŠ±çš„èƒŒé¢æ¨è‚˜è§£è„«ï¼›\nåŸºæœ¬ä¸Šéƒ½æ˜¯å…ˆå¾ªæ©Ÿå¸æ°£ï¼Œæ¥è‘—æ’¥æ°´ä¸‹æ²‰ï¼Œå› ç‚ºæººè€…æ˜¯ä¸‹æ„è­˜æƒ³è¦å»ºç«‹æµ®åŠ›ï¼Œæ‰€ä»¥ä½ åè€Œä¸‹æ²‰ä»–ä¸€æ€•å°±æœƒé¬†æ‰‹äº†ï¼Œå¦‚æœä¸è¡Œå‰‡æ”¶ä¸‹å·´é ä½æ‰‹è‚˜ä¸Šæ–¹ç”¨åŠ›æ¨å³å¯æ™è„«\né˜²è¡›æ³• é˜²è¡›æ³•æ¯”è¼ƒæ˜¯ç¢°åˆ°æººè€…æ’²ä¸Šä¾†ä½†é‚„æ²’æœ‰è¢«ç·ŠæŠ±ä½æ™‚ä½¿ç”¨ï¼Œé€£çºŒå‹•ä½œå¾å–®æ‰‹é˜»æ“‹-\u0026gt;é›™æ‰‹é˜»æ“‹-\u0026gt;é›™æ‰‹ä¸‹å£“-\u0026gt;å–®è…³è¹¬é›¢ï¼›\nåŸºæœ¬ä¸Šå°±æ˜¯å°æ‡‰æººè€…çš„è‡ªç„¶åæ‡‰è€Œæœ‰çš„é…å¥—æªæ–½\nå¸¶äººæ³• æ¥è¿‘æ³•å°‡æººè€…è½‰æˆä»°é¢æ‹–å‹•å¾Œï¼Œç‚ºäº†æ›´å¥½æ§åˆ¶æººè€…ï¼Œé€šå¸¸æœƒç”¨æŠ±èƒ¸å¼å¸¶äººï¼Œé€™å¤§æ¦‚æ˜¯æ•´å€‹æ•‘æººç’°ç¯€æœ€ç‚ºç´¯äººçš„å‹•ä½œï¼Œæ•‘è€…æ¡ç”¨å´æ³³ç”¨è…°å°‡æººè€…é ‚è‘—ï¼Œæ¥è‘—ç”¨åå‰ªå¤¾æ°´å›åˆ°å²¸é‚Šï¼Œè€ƒè©¦å¤¾å®Œ25å…¬å°ºå®Œå…¨ç«™ä¸èµ·ä¾†â€¦.\nèµ·å²¸æ³• åˆåˆ†æˆæ·±æ°´æ·ºæ°´ï¼Œæººè€…æœ‰ç„¡æ„è­˜ï¼Œä¸»è¦æœ‰é¦¬éå¼ã€èƒŒè² å¼ã€æ‹–æ‹‰å¼ã€æ·±æ°´èµ·å²¸æ³•ç­‰\næ•‘æººå…«å¤§æ­¥é©Ÿèˆ‡æ€¥æ•‘ èº«ç‚ºæ•‘ç”Ÿå“¡éƒ½è¦é€šé16å°æ™‚å—è¨“çš„åŸºç¤æ€¥æ•‘èª²ç¨‹ï¼Œä¸¦å­¸ç¿’æ•‘æººå…«å¤§æ­¥é©Ÿï¼›\né€šå¸¸æ•‘ç”Ÿå“¡ç¬¬ä¸€ç·šä¸»è¦é é˜²ä¼‘å…‹ï¼Œçµ¦äºˆä¿æš–ã€æ­¢è¡€åŒ…ç´®é€™äº›ï¼Œç‚ºäº†é¿å…äºŒåº¦èˆ‡é ¸æ¤å‚·å®³ï¼Œæœ‰å­¸ç¿’æ“ä½œé•·èƒŒæ¿ç­‰ä½¿ç”¨\nå¦‚ä½•èº«ç‚ºä¸€å€‹è‰¯å¥½çš„æººè€… ç•¶ç„¶æˆ‘å€‘éƒ½ä¸å¸Œæœ›æ„å¤–ç™¼ç”Ÿï¼Œä½†ç¸½æ˜¯å¯èƒ½æœƒæœ‰ç™¼ç”Ÿçš„é¢¨éšªï¼Œèˆ‡å…¶é€ƒé¿ä¸å¦‚èŠ±é»å¿ƒæ€æº–å‚™ï¼Œä»¥å‚™ä¸æ™‚ä¹‹éœ€ï¼›\nä»¥ä¸€å€‹æ•‘ç”Ÿå“¡å—è¨“å®Œï¼Œç¨å¾®ç”¨ä¸åŒçš„è§’åº¦ä¾†åˆ†äº«å“ªäº›æººè€…æœ€å®¹æ˜“è¢«æ•‘ä¸Šä¾†ï¼Œé€™äº›æƒ³æ³•ä¸»è¦æ˜¯çµåˆè‡ªå·±å—è¨“çš„å¿ƒå¾—èˆ‡æ•™ç·´çš„æŒ‡å°ï¼Œå¦‚æœæœ‰éºæ¼æˆ–æ˜¯éŒ¯èª¤å†è«‹æŒ‡æ•™\nåœ¨äººå¤šä¸”æœ‰å–®ä½å”å‹¤çš„åœ°æ–¹ç©æ°´\nåœ¨æ¸¸æ³³æ± ç©æ°´ç›¸å°è »å®‰å…¨ï¼Œå¦‚æœè¦åˆ°é‡å¤–æœ€å¥½æ˜¯æˆç¾¤çµä¼´ï¼Œä¸”åˆ°æœ‰æ•‘ç”Ÿå–®ä½å”å‹¤çš„åœ°æ–¹ï¼Œåƒæ˜¯çƒä¾†çš„ç´…æ²³è°·å°±æ˜¯æ–°åº—åŒå¿ƒæ•‘é›£éšŠå¤æ—¥å”å‹¤åœ°é»ï¼›\nåœ¨é€™äº›åœ°æ–¹ç©æ°´çš„å¥½è™•é™¤äº†æœ‰åˆæ ¼çš„æ•‘ç”Ÿå“¡å¤–ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿç›¸å°æœƒæº–å‚™æ•‘ç”Ÿå™¨æï¼Œå¦‚æ•‘ç”Ÿåœˆã€æ‹‹ç¹©è¢‹ã€é­šé›·æµ®æ¨™ã€å……æ°£å¼æ±½è‰‡ã€æ•‘ç”Ÿæ¿ç­‰\nå¦‚æœæ˜¯è‡ªå·±å‡ºå»ç©ï¼Œæ³³æŠ€ä¸å¤ªå¥½æˆ–æ˜¯æ°´åŸŸä¸ç†Ÿæ‚‰ã€Œå‹™å¿…æ”œå¸¶æµ®æ¨™ã€ï¼Œä¹‹å‰æºªè¨“åˆ°ç¢§æ½­ï¼Œæ•´å€‹æ°´æº«åˆ†æˆä¸‰å±¤ï¼Œæœ‰æ™‚é‡åˆ°åœ°ä¸‹æ°´æ¹§æ³‰åˆæœƒå¿½å†·å¿½ç†±ï¼Œçµæœæˆ‘å°±æ¸¸ä¸€æ¸¸æŠ½ç­‹äº†ï¼Œä¸€æ–¹é¢æœ‰æ•™ç·´åœ¨æ—é‚Šé —å®‰å¿ƒï¼Œå¦ä¸€æ–¹é¢å…ˆæŠ“åˆ°æµ®æ¨™å»ºç«‹æµ®åŠ›ï¼Œå°±å¯ä»¥æŠ½ç­‹è‡ªè§£ï¼›\næ‰€ä»¥å­¸æœƒå»ºç«‹æµ®åŠ›å¾ˆé‡è¦ï¼Œå¸¶æµ®æ¨™é å¤–ç‰©å¯ä»¥å¾ˆè¼•é¬†çš„æµ®èµ·ä¾†ï¼Œæˆ–æ˜¯å­¸æœƒåŸºæœ¬çš„æ°´æ¯æ¼‚æˆ–æŠ½ç­‹è‡ªè§£ä¹Ÿéƒ½å¾ˆé‡è¦ å‘ˆä¸Šé‡é›£æ™‚ä¸è¦å¤ªç·Šå¼µï¼Œä¸è¦æŠ“æŠ±æ•‘ç”Ÿå“¡\nåœ¨æœ€å¾Œè€ƒè©¦æ™‚æ•™ç·´æœ‰æ¨¡æ“¬æŠ“æŠ±ï¼ŒåŸæœ¬æŠ“æŠ±å‰é«”åŠ›å¤§æ¦‚é‚„æœ‰80%ï¼ŒæŠ“æŠ±ä¸€æ¬¡è§£è„«å¾Œç›´æ¥å‰©20%ï¼Œå¦‚æœä¸æ˜¯åœ¨è€ƒè©¦é€”ä¸­æˆ‘å¤§æ¦‚å°±ç›´æ¥è½è·‘äº†OTZÂ ä¸€æ–¹é¢æ˜¯æˆ‘è‡ªèº«é«”åŠ›æ³³æŠ€é‚„ä¸å¤ å¥½ï¼Œå¦ä¸€æ–¹é¢çœŸçš„è¦å¸¶äººåˆè¦é˜²è¡›æººè€…çœŸçš„æœƒå¾ˆç´¯ï¼Œæ‰€ä»¥ç›¸å°çš„å¦‚æœæººè€…ç„¡æ„è­˜äº†åè€Œæ¯”è¼ƒé‚„å¥½ï¼Œæœ‰æ„è­˜çš„è©±å°±é…åˆï¼Œæ‰å¯ä»¥å¤§å¹…å¢åŠ è‡ªå·±çš„ç”Ÿå­˜æ©Ÿæœƒï¼›\nå¦‚æœæ˜¯åœ¨æœ‰å”å‹¤å–®ä½çš„åœ°æ–¹æˆ²æ°´ï¼Œéƒ½æœƒè¢«æœ‰å¦¥ç•¶çš„æ•‘ç”Ÿç”¨å…·ï¼Œé€™äº›æ•‘ç”Ÿç”¨å…·å¯ä»¥ç¯€çœæ•‘ç”Ÿå“¡å¾ˆå¤§éƒ¨åˆ†çš„é«”åŠ›ï¼Œç›¸å°ä¹Ÿå¯ä»¥é™ä½å¤§å®¶æººæ°´çš„é¢¨éšª ç¸½çµï¼š\næŒ‘é¸å®‰å…¨çš„åœ°æ–¹æˆ²æ°´ -\u0026gt; ä¸å¹¸å‡ºäº‹å¤§è²æ±‚æ•‘ -\u0026gt; å»ºç«‹è‡ªèº«æµ®åŠ› -\u0026gt; ä¿æŒå†·éœä¸è¦äº‚æŠ“æŠ±\n28å¤©çš„èª²ç¨‹ï¼Œä¸€åˆ°å…­æ—©ä¸Šäº”é»åˆ°ä¸ƒé»æ“ç·´ï¼Œç·´ç¿’å‹•ä½œèˆ‡é•·æ³³é›éŠé«”åŠ›ï¼Œé€±æ—¥å…¨å¤©å­¸ç¿’æ€¥æ•‘èˆ‡åˆ°é‡å¤–æºªè¨“èˆ‡æµ·è¨“\næºªè¨“æµ·è¨“ æºªè¨“æµ·è¨“çœŸçš„å¾ˆç‰¹åˆ¥ï¼Œä¹‹å‰æˆ‘æ²’æœ‰å¤ªå¤šåˆ°é‡å¤–æ¸¸æ³³çš„ç¶“é©—ï¼Œåˆ°äº†æºªè¨“æ•™ç·´ä¸€ä¸‹æ°´é•·æ³³å°±æ˜¯ä¸€å€‹å¤šå°æ™‚â€¦.Â çœŸçš„æ˜¯è¶…ç´šç´¯ï¼Œè€Œä¸”è¦åœ¨è¸©ä¸åˆ°åº•ä¹Ÿçœ‹ä¸åˆ°åº•çš„åœ°æ–¹å°éŠå‹•ä½œï¼Œå¿ƒè£¡ç¸½æ˜¯ä¸è¸å¯¦ï¼Œæœ€å¾Œæºªè¨“å°±æŠ½ç­‹äº†\næµ·è¨“å‰‡æ˜¯å› ç‚ºæµ®åŠ›å¤§æ¯”è¼ƒè¼•é¬†é»ï¼Œé›–ç„¶æ°´å–åˆ°è¶…ç—›è‹¦ï¼Œåˆè‹¦åˆé¹¹å–‰åš¨è¶…ç—›ï¼Œä½†æ•´é«”è¼•é¬†ä¸€äº›ï¼Œä¹Ÿæ²’æœ‰æŠ½ç­‹ï¼Œä¸éå› ç‚ºæœ‰æµªæ‰€æœ‰åŒæœŸå­¸å“¡æœ‰äººå°±åäº†\né™¤äº†æŠ˜ç£¨çš„é•·æ³³å¤–ï¼Œå¾ŒçºŒçš„èª²ç¨‹å°±æ˜¯æ“ä½œæ•‘ç”Ÿç”¨å…·ï¼Œç·´ç¿’æ‹‹æ•‘ç”Ÿåœˆã€å­¸ç¿’æ”¶ç¹©ï¼Œé‚„æœ‰å……æ°£å¼çš®è‰‡ä¹‹é¡çš„ï¼Œéå¸¸å¥½ç©\næœ€å¾Œä¸‹åˆéƒ½æœƒæµ®æ½›ä¸€å€‹å¤šå°æ™‚çµæŸæ•´å¤©çš„è¨“ç·´\nçµèª åƒåŠ æ•‘ç”Ÿå“¡è¨“ç·´ä¸»è¦æ˜¯å¸Œæœ›çµ¦è‡ªå·±ä¸€å€‹ç£¨ç·´çš„æ©Ÿæœƒï¼Œåœ¨éç¨‹ä¸­å­¸ç¿’åˆ°å¾ˆå¤šæ•‘ç”Ÿçš„çŸ¥è­˜ï¼ŒçœŸçš„éå¸¸æ„Ÿè¬æ•™ç·´å€‘æ¯å¤©éƒ½é™ªæˆ‘å€‘æ—©èµ·ï¼Œé™¤äº†æˆèª²å¤–é‚„å¾ˆä»”ç´°çš„ç³¾æ­£æˆ‘å€‘çš„å§¿å‹¢ï¼Œåˆ°é‡å¤–å—è¨“å°±æœ‰ä¸€ç¾¤æ•™ç·´åŒ…åœè‘—å­¸å“¡ï¼Œä¸€é‚Šå®‰å…¨æˆ’è­·ä¸€é‚Šåš´å²çš„ç£ä¿ƒä¸¦æŒ‡å°æˆ‘å€‘\nåŸå‰‡ä¸ŠéšŠä¸Šæ¯å¹´ä¸ƒå…«æœˆé–‹å…©æœŸï¼Œæ‰€ä»¥æœ‰èˆˆè¶£ä¹Ÿè¦ç­‰åˆ°æ˜å¹´å›‰XDÂ ä¹‹å¾Œæ˜å¹´è·Ÿè‘—éšŠä¸Šå»å”å‹¤ï¼Œå¸Œæœ›ä¹Ÿæœ‰ç‚ºç¤¾æœƒè²¢ç»çš„æ©Ÿæœƒã€‚\n","date":"2018-08-21T12:28:19.157Z","permalink":"https://yuanchieh.page/posts/2018/2018-08-21-%E6%96%B0%E5%BA%97%E5%90%8C%E5%BF%83%E6%95%91%E9%9B%A3%E9%9A%8A-52%E6%9C%9F%E6%95%91%E7%94%9F%E5%93%A1%E8%A8%93%E7%B7%B4%E5%BF%83%E5%BE%97/","title":"æ–°åº—åŒå¿ƒæ•‘é›£éšŠ 52æœŸæ•‘ç”Ÿå“¡è¨“ç·´å¿ƒå¾—"},{"content":"Â ä¹‹å‰å¯«æ¸¬è©¦å› ç‚ºæ²’æœ‰æ³¨æ„ç´°ç¯€ï¼Œå°è‡´éå¸¸é›£ç·¨å¯«å–®å…ƒæ¸¬è©¦ï¼›\næ”¹ä»¥ End-to-Endæ¸¬è©¦ï¼Œç›´æ¥ç”¨docker é–‹DBè¼¸å…¥å‡è³‡æ–™ï¼Œæ¥è‘—åŸ·è¡Œ Server App å°APIä¸€éš»ä¸€éš»æ¸¬è©¦ã€‚\né€™æ¨£çš„å¥½è™•æ˜¯æ¸¬è©¦æ–¹æ³•èˆ‡æœ€çµ‚APIèª¿ç”¨çš„çµæœæ˜¯ä¸€æ¨£çš„ï¼Œä½†ç¼ºé»å°±æ˜¯è€—æ™‚è¼ƒä¹…ï¼Œä¸”é‚Šå¯«æ¸¬è©¦çš„æˆæœ¬å¾ˆé«˜ï¼Œè¦åšåˆ°TDDä¹‹é¡çš„é–‹ç™¼æ–¹å¼éå¸¸å›°é›£ã€‚\nå¦ä¸€æ–¹é¢ä¹‹å‰ç”¨ Mochaï¼Œä¹Ÿç®—æ˜¯ Nodejs æœ€å¤§å®—ä½¿ç”¨çš„æ¸¬è©¦æ¡†æ¶ï¼Œæä¾›æœ€åŸºæœ¬çš„æ¸¬è©¦ç’°å¢ƒèˆ‡èªæ³•å®šç¾©ï¼Œå…¶é¤˜çš„æ–·è¨€ã€Mockingéƒ½è¦è‡ªå·±å¦å¤–æƒ³è¾¦æ³•ï¼›\né€™æ¬¡æ”¹ç”¨jestï¼Œç”±FBé–‹æºå¯ä¾›å‰å¾Œç«¯çš„æ¸¬è©¦æ¡†æ¶ï¼Œæ­¤æ¬¡é †ä¾¿åˆ†äº«å¦‚ä½•å»ºæ§‹ç¨‹å¼ç¢¼æ‰æ–¹ä¾¿å¯«æ¸¬è©¦çš„å°å°å¿ƒå¾—ã€‚\nJest å¦‚ä½•ä½¿ç”¨ Jest ä½¿ç”¨ä¸Šæœ‰é»åƒ Mocha + Chaiï¼Œé™¤äº†æ¸¬è©¦ç’°å¢ƒå¤–é‚„ä»¥è‡ªå®šç¾©çš„æ–·è¨€ï¼Œæä¾›å¤šç¨®ç·¨å¯«èªæ„åŒ–çš„æ¸¬è©¦æƒ…å¢ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 // ./sum.js function sum(a, b) { return a + b; } module.exports = sum; // ./sum.test.js const sum = require(â€˜./sumâ€™); test(â€˜adds 1 + 2 to equal 3â€™, () =\u0026gt; { expect(sum(1, 2)).toBe(3); }); // åŸ·è¡Œ\n\u0026gt; jest\nå¦ä¸€é»æ–¹ä¾¿çš„æ˜¯ Jestå°æ–¼ Callbackã€Promiseã€Async/Awaitæ”¯æ´ç›¸ç•¶å¥½ï¼Œç•¶åˆåœ¨Mochaä¸­æäº†ä¸€é™£å­â€¦.\né‚Šå¯«æ¸¬è©¦çš„å°ç´°ç¯€ ä½¿ç”¨Mockï¼Œé€éé è¨­æƒ…æ™¯èˆ‡å‡è³‡æ–™ï¼Œä¸ç”¨æ¶è¨­è¤‡é›œçš„ç’°å¢ƒæˆ–æ˜¯çœŸçš„ç™¼å‡ºéåŒæ­¥è«‹æ±‚ï¼Œå°±å¯ä»¥é”åˆ°æ¸¬è©¦çš„æ•ˆæœï¼›\nåœ¨ä½¿ç”¨Mockä¹‹å‰ï¼Œæœ‰ä¸€é»è¦æ³¨æ„ ç›¡é‡æŠŠAPIåŒ…æˆå‡½å¼æˆ–æ•´ç†æˆç‰©ä»¶æ–¹æ³•è€Œéç›´æ¥å‘¼å«\nä¾‹å¦‚èªªåœ¨è¨­è¨ˆAPI: GET /user/:userId\n1 2 3 4 5 6 7 8 9 // ä¸è¦é€™æ¨£ç›´æ¥å‘¼å« mongoose æ–¹æ³• function getUserById(){ let user = await mongoose.findById(â€¦.) }// æ‹†é–‹æˆç¨ç«‹çš„å‡½å¼ï¼Œæ–¹ä¾¿å¾ŒçºŒåš Mock function getUserById(){ let user = await getUserByIdInModel(id) }function getUserByIdInModel(){ return mongoose.findById(â€¦) } å°‡éåŒæ­¥è«‹æ±‚æ•´ç†åŒ…æˆå‡½å¼åœ¨èª¿ç”¨æœ‰å¹¾å€‹å¥½è™•\n1. è§£è€¦ï¼Œå¤šä¸€å±¤æŠ½è±¡åŒ–\nè©¦æƒ³ä»Šå¤©æ˜¯ç”¨MongoDBç•¶ä½œè³‡æ–™åº«ï¼Œä½†å¦‚æœæŸå¤©éœ€è¦æ›æˆ PostgreSQLï¼ŒæŠŠè³‡æ–™åº«èª¿ç”¨å¯«æ­»åœ¨ APIé‚è¼¯ä¸­æœƒå°è‡´æ•´ä»½ç¨‹å¼ç¢¼éœ€è¦é‡å¯«ï¼›\nä½†å¦‚æœæ‹†é–‹æˆç¨ç«‹å‡½å¼ï¼Œå°±åªè¦æ”¹å‡½å¼èª¿ç”¨çš„DB Clientèˆ‡å°æ‡‰åŸæœ¬çš„å›å‚³è³‡æ–™æ ¼å¼å³å¯(è¦ªèº«ç¶“é©—\n2. æ–¹ä¾¿ç·¨å¯«æ¸¬è©¦\néåŒæ­¥è«‹æ±‚æœ¬èº«ä¹Ÿå¯ä»¥ç¨ç«‹å¯«æ¸¬è©¦ (å¦‚æœéœ€è¦çš„è©±\næ¥è‘—çœ‹ Jestå¦‚ä½•ç”Ÿæˆå‡è³‡æ–™ã€‚\nMock ç”¢ç”Ÿå‡è³‡æ–™å¯ä»¥åˆ†ç‚º func\nå‡è¨­æˆ‘å€‘åŸæœ¬çš„ç¨‹å¼ç¢¼ç‚º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // index.js const api = require(â€˜./apiWrapperâ€™); const Obj = require(â€˜./objectWrapperâ€™);exports.callAPI = async function(t){ let content = await api.readFile(t) return content }exports.callObject = async function(){ let obj = new Obj(â€œjayâ€) return obj.sayHi() } // ./util/apiWrapper.js const fs = require(â€˜mz/fsâ€™);exports.readFile = async function(params){ return fs.readFile(â€œ./test.txtâ€); } // ./model/objWrapper.js module.exports = class Test{ constructor(name){ this.name = name }sayHi(){ return \\`hi from ${this.name}\\` } } åŸºæœ¬ä¸Šå°±æ˜¯index.jså°å¤–è¼¸å‡ºå…©å€‹å‡½å¼ï¼Œæ­¤å…©å€‹å‡½å¼å…§æœ‰éåŒæ­¥è«‹æ±‚èˆ‡å‰µå»ºç‰©ä»¶çš„æ–¹æ³•ï¼Œé€šå¸¸å€‹äººè³‡æ–™å¤¾ç›®éŒ„æ˜¯å…±ç”¨çš„éåŒæ­¥API Callæœƒå«åš utilï¼Œå¦‚æœæ˜¯è³‡æ–™åº«ç›¸é—œçš„ç‰©ä»¶å‰‡æ˜¯ modelã€‚\næ¥è‘—çœ‹æ¸¬è©¦æª” index.test.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 const index = require(â€œ./indexâ€) jest.mock(â€œ./util/apiWrapperâ€) jest.mock(â€œ./model/objectWrapperâ€) test(â€œmock api testâ€, async ()=\u0026gt;{ let res = await index.callAPI(1); expect(res).toBe(â€œjestâ€); }) test(â€œmock api test2â€, async ()=\u0026gt;{ let res = await index.callAPI(2); expect(res).toBe(â€œjest2â€); }) test(â€œmock obj testâ€, async ()=\u0026gt;{ let res = await index.callObject(); expect(res).toBe(â€œhi from jestâ€); }) é€™è£¡å…ˆå®šç¾©äº†ä¸‰å€‹æ¸¬è©¦æƒ…å¢ƒï¼Œä¸¦é€é jest.mock()é¡¯å¼å®£å‘Š Mockæª”æ¡ˆçš„ä½ç½®ï¼›\næ¥è‘—æ³¨æ„ mocké è¨­æœ‰å›ºå®šçš„è³‡æ–™è·¯å¾‘èˆ‡å‘½åè¦å‰‡ã€‚\n1 2 3 4 5 6 index.js index.test.js â€” util | â€” â€” apiWrapper.js | â€” â€” __mocks__ | â€” â€” apiWrapper.js éœ€æ³¨æ„mockè¦å®šç¾©åœ¨æª”æ¡ˆçš„åŒå±¤ mocks è³‡æ–™å¤¾ä¸‹ï¼Œä¸¦ä¸”æª”åéœ€è¦ä¸€è‡´ä¸”è¼¸å‡ºåŒæ¨£çš„å‡½å¼åã€‚\nå¦‚æœæ˜¯è¦ mock å¦‚ â€˜fsâ€™ç­‰åŸç”Ÿæ¨¡çµ„ï¼Œç›´æ¥å®šç¾©åœ¨å°ˆæ¡ˆæœ€ä¸Šå±¤çš„ __mocks__ä¸­å³å¯ã€‚\nåœ¨ jest.fn()ä¸­ï¼Œæœ‰éœ€å¤š mockè³‡æ–™çš„æ–¹å¼ 1. mockImplementation(fn)ï¼Œå¯ä»¥å–å¾—å‡½å¼èª¿ç”¨çš„åƒæ•¸ï¼Œä¸¦æ±ºå®šå¦‚ä½•å›å‚³\n1 2 3 4 5 6 7 // ./util/__mocks__/apiWrapper.js exports.readFile = jest.fn().mockImplementation(params =\u0026gt; { if(params == 1){ return â€œjestâ€ } return â€œjest2â€ }) 2. mockReturnValueOnce ä¸€æ¬¡æ€§çš„å›å‚³å€¼\n1 2 3 jest.fn() .mockReturnValueOnce(10) .mockReturnValueOnce(â€˜xâ€™) 3. mockReturnValue å›ºå®šçš„å›å‚³å€¼\næœ‰å®šç¾©ä¸¦å®£å‘Šä½¿ç”¨ mockï¼Œjeståœ¨åŸ·è¡ŒåŸè…³æœ¬æ™‚æœƒæ”¹å‘¼å«è¢« mockè¦†å¯«å®šç¾©çš„å‡½å¼ jest.fn()ï¼Œé”åˆ°ç”¢ç”Ÿå‡è³‡æ–™çš„æ•ˆæœï¼ŒåŒæ™‚ç´€éŒ„ fn()å‘¼å«çš„æ¬¡æ•¸èˆ‡å‚³éçš„åƒæ•¸ï¼›\nç‰©ä»¶å‰‡åŒæ¨£ä¹Ÿæ˜¯é€éæ”¹å¯«ç‰©ä»¶çš„å‘¼å«æ–¹æ³•ã€‚\nå…¶é¤˜çš„åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œhttps://github.com/sj82516/very-simple-jest-example\n","date":"2018-08-06T10:42:40.623Z","permalink":"https://yuanchieh.page/posts/2018/2018-08-06-%E4%BD%BF%E7%94%A8-jest-%E5%81%9Aapi-%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E7%9A%84%E7%AF%84%E4%BE%8B%E8%88%87%E7%B4%B0%E7%AF%80/","title":"ä½¿ç”¨ Jest åšAPI å–®å…ƒæ¸¬è©¦çš„ç¯„ä¾‹èˆ‡ç´°ç¯€"},{"content":"è³‡æ–™åº«æ—¥ç©æœˆç´¯è³‡æ–™é‡é€æ­¥æ”€å‡ï¼ŒMySQLåœ¨ä¸€èˆ¬æŸ¥è©¢æ˜¯é€éå…¨è¡¨æœå°‹ï¼Œæ‰€ä»¥å¤§é‡çš„è³‡æ–™æœƒå°è‡´æŸ¥è©¢ç­‰æ–¹å¼è¶Šä¾†è¶Šæ…¢ï¼›\nMySQLæä¾›ç´¢å¼•å»ºç½®ï¼Œä¸€èˆ¬çš„ç´¢å¼•é€é B+ Treeï¼Œåœ¨è¨˜æ†¶é«”ä¸­å¿«é€ŸæŸ¥æ‰¾è³‡æ–™æ‰€åœ¨ä½ç½®ï¼Œå°‡æœå°‹å¾ O(n) ç´„*é™è‡³O(log n)ï¼Œç´¢å¼•æ”¯æ´Where / Order by / Rangeä¸­çš„æ¢ä»¶åˆ¤æ–·ã€‚\nä»¥ä¸‹ç”¢ç”ŸUser / Orderå…©å¼µç™¾è¬ç­†è³‡æ–™çš„Table\n1. ä¸¦è©¦è‘—ç”¨Explain åˆ†æSQLèªæ³•\n2. é€éç´¢å¼•è¨­å®šæ¯”è¼ƒå‰å¾Œçš„æŸ¥è©¢é€Ÿåº¦å„ªåŒ–\nTable 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 CREATE TABLE \u0026#39;users\u0026#39; ( \u0026#39;id\u0026#39; int(11) NOT NULL AUTO_INCREMENT, \u0026#39;uuid\u0026#39; char(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL, \u0026#39;age\u0026#39; int(11) DEFAULT NULL, \u0026#39;firstName\u0026#39; varchar(255) DEFAULT NULL, \u0026#39;lastName\u0026#39; varchar(255) DEFAULT NULL, \u0026#39;createdAt\u0026#39; datetime NOT NULL, \u0026#39;updatedAt\u0026#39; datetime NOT NULL, PRIMARY KEY (\u0026#39;id\u0026#39;), ) ENGINE=InnoDB AUTO_INCREMENT=1000001 DEFAULT CHARSET=utf8mb4; CREATE TABLE \u0026#39;orders\u0026#39; ( \u0026#39;id\u0026#39; int(11) NOT NULL AUTO_INCREMENT, \u0026#39;uuid\u0026#39; char(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL, \u0026#39;cost\u0026#39; int(11) DEFAULT NULL, \u0026#39;user_id\u0026#39; int(11) DEFAULT NULL, \u0026#39;user_uuid\u0026#39; varchar(255) DEFAULT NULL, \u0026#39;tradeNo\u0026#39; varchar(255) DEFAULT NULL, \u0026#39;createdAt\u0026#39; datetime NOT NULL, \u0026#39;updatedAt\u0026#39; datetime NOT NULL, PRIMARY KEY (\u0026#39;id\u0026#39;) ) ENGINE=InnoDB AUTO_INCREMENT=750001 DEFAULT CHARSET=utf8mb4; Explain Explainå¯ä»¥ç”¨æ–¼åˆ†æ SELECT / DELETE / UPDATE / INSERT / REPLACE èªå¥ï¼Œæ¢åˆ—å‡ºåŸ·è¡ŒSQLèªå¥æ™‚æœƒä½¿ç”¨åˆ°çš„ Tableèˆ‡æ¬„ä½è³‡è¨Šï¼Œå¯¦éš›å›å‚³çš„æ¬„ä½æœ‰\nselect_type:Â SELECTæŸ¥è©¢çš„ç‹€æ…‹ï¼Œå¸¸è¦‹æœ‰å¹¾ç¨®å‹åˆ¥ SIMPLEï¼šç°¡å–®æŸ¥è©¢ PRIMARYï¼šä¸»æŸ¥è©¢ï¼Œç›¸å°æ–¼å­æŸ¥è©¢Subquery UNIONï¼šåœ¨UNIONèªå¥ä¸­çš„éé¦–å€‹SELECT SUBQUERYï¼šå­æŸ¥è©¢\nå¦‚æœéSELECTå‰‡ç‚ºå…¶ä»–å‹•è©å¦‚DELETE table:Â ä¹Ÿå°±æ˜¯ä½¿ç”¨çš„Tableåç¨± partitions:\nå¦‚æœæœ‰ä½¿ç”¨ partitionåŠŸèƒ½æ‰æœƒé¡¯ç¤º type:Â type åƒæ•¸éå¸¸é‡è¦ï¼Œé€™æœƒæ±ºå®šæ­¤æ¬¡SQLèªå¥ä½¿ç”¨ç´¢å¼•ç‹€æ³ï¼Œç”±å„ªè‡³åŠ£é †åºä»‹ç´¹\nconst / system\næŸ¥è©¢ç”¨ä¸Šprimary / unique keyï¼Œä¹Ÿå°±æ˜¯æ¢ä»¶å‰›å¥½åŒ¹é…ä¸€å€‹è¡Œï¼Œå› ç‚ºåªè®€å–ä¸€è¡Œæ‰€ä»¥é€Ÿåº¦æœ€å¿«ï¼›\nsystemæ˜¯ç‰¹æ®Šé¡çš„constï¼Œç”¨æ–¼æŸ¥è©¢ systemç›¸é—œçš„è¡¨ï¼Œå¦‚\nexplain select * from 'proxies_priv' where user=â€™rootâ€™ eq_ref :ç”¨æ–¼å¤šè¡¨ joinä¸‹ï¼Œå¦‚æœåœ¨æ¢ä»¶åˆ¤æ–· = ä¸Šç”¨äº†PRIMARY KEY æˆ–UNIQUE NOT NULLä¹Ÿå°±æ˜¯æ¢ä»¶å‰›å¥½åŒ¹é…ä¸€å€‹è¡Œ\næ­¤ç¯„ä¾‹çš„ join selectå°±æ˜¯ç”¨ä¸Šeq_refå› ç‚º user.idæ˜¯ primary key\nexplain select * from orders left join users on users.id = orders.user_id where orders.cost \u0026gt; 100;\nref\nç”¨æ–¼å¤šè¡¨ joinä¸‹ï¼Œå¦‚æœæ˜¯ç”¨leftmost prefix keyæˆ–æ˜¯é [eq_ref](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html#jointype_eq_ref) æ¢ä»¶ä¸­çš„keyï¼Œä¹Ÿå°±æ˜¯å¯èƒ½æœƒåŒ¹é…å¤šè¡ŒÂ index_mergeï¼š\nå¦‚æœæŸ¥è©¢ç”¨ä¸Šå¤šå€‹keyï¼Œä¾‹å¦‚\nexplain select id from users where id = 2 or id=100 or uuid=â€™21d9dadb-038f-427d-8ef1-c2b3aa0994e6';\n(id / uuid éƒ½æ˜¯ index) range å°‡keyç”¨æ–¼ç¯„åœæŸ¥è©¢ï¼Œå¦‚ = \u0026lt;\u0026gt; \u0026gt; \u0026gt;=`, \u0026lt; \u0026lt;=, IS NULL \u0026lt;=\u0026gt; BETWEEN, LIKE IN()`Â indexï¼š\nå…¨è¡¨ç´¢å¼•æª¢ç´¢ï¼Œå¸¸ç”¨æ–¼ç´¢å¼•å¯è¦†è“‹æŸ¥è©¢æ¬„ä½ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ°ç£ç¢Ÿè®€å–è³‡æ–™\nALLï¼š\næœ€å·®çš„æŸ¥è©¢æ–¹å¼ï¼Œå…¨è¡¨æœå°‹ possible_keysï¼š\nå¯èƒ½æœƒç”¨ä¸Šçš„key keyï¼š\nå¯¦éš›ç”¨ä¸Šçš„key key_lenï¼š\nå¯¦éš›keyä½¿ç”¨çš„æ¯”å°é•·åº¦ refï¼š\nç”¨åœ¨èˆ‡ç´¢å¼•æ¯”å°çš„å¸¸æ•¸æˆ–æ¬„ä½ï¼Œå¦‚\nexplain delete from users where id=1; refå€¼ç‚º constï¼Œå› ç‚ºæ˜¯1ï¼›\nå¦‚æœæ¯”å°çš„æ˜¯æ¬„ä½å‰‡æœƒå‡ºç¾æ¬„ä½åï¼Œå¦‚ index_search.orders.user_id rowsï¼š\nMySQLé è¨ˆè¦è®€å–çš„è¡Œæ•¸ filteredï¼š\nMySQLæ ¹æ“šæ¢ä»¶é è¨ˆæœƒç¯©é¸æ‰çš„æ¯”ä¾‹ï¼Œä»¥ç™¾åˆ†æ¯”é¡¯ç¤ºï¼Œæ‰€ä»¥æœ€å¤§å€¼ç‚º100ï¼Œä¹Ÿå°±æ˜¯æ¯å€‹ rowséƒ½ç”¨ä¸Š Extraï¼š\né¡å¤–è£œå……ï¼Œæœ‰å¹¾å€‹å€¼éœ€è¦ç•™æ„\nï¼ŠUsing filesortï¼š\nMySQLåœ¨æ’åºä¸Šéœ€è¦åšé¡å¤–çš„è™•ç†ï¼Œæœƒè€—è²»å¤§é‡çš„æ€§èƒ½ã€‚\n* Using Whereï¼š\næœ‰åŠ å…¥æ¢ä»¶åˆ¤æ–·ï¼Œå¦‚æœä¸æ˜¯è¦åˆ»æ„æƒå…¨è¡¨ï¼Œç†è«–ä¸Šéƒ½æœƒå‡ºç¾é€™å€‹å€¼ï¼›\nå¦‚æœExtraæ²’æœ‰å‡ºç¾Using Where ä¸” typeç‚º ALL/ indexï¼Œå°å¿ƒå°±è½å…¥äº†å…¨è¡¨æƒæã€‚\n* Using indexï¼š\nç´¢å¼•æœå°‹ä¸”è¦†è“‹ç´¢å¼•ï¼Œå°±ä¸ç”¨å†é¡å¤–è®€å–å¯¦éš›çš„row è³‡æ–™ã€‚ å¯¦éš›ä½¿ç”¨ æˆ‘é€é nodejså¡å…¥ç™¾è¬ç­†å‡è³‡æ–™ï¼Œå¯ä»¥åƒè€ƒé€£çµå–å¾—\nRIGHT JOIN å’Œ LEFTÂ JOINå·®ç•° users / orders Tableç›®å‰åªæœ‰ idæ˜¯ primary keyï¼Œæ¯”å°ä»¥ä¸‹å…©å€‹èªå¥ï¼Œå…©è€…åŸ·è¡Œé€Ÿåº¦å¤©å·®åœ°é \nexplain select * from users left join orders on orders.user_id = users.id;\nexplain select * from users right join orders on orders.user_id = users.id;\nMySQLå…§éƒ¨æœƒæŠŠRIGTH JOINè½‰æ›æˆLEFT JOINï¼Œæ‰€ä»¥å…¶å¯¦å°±æ˜¯æ¯”è¼ƒå…ˆåŸ·è¡Œ users é‚„æ˜¯ ordersï¼Œåœ¨å…§éƒ¨ JOINæ˜¯å¤šå±¤ for loopæŸ¥æ‰¾ä¸¦æ¯”å° on çš„æ¢ä»¶åˆ¤æ–·ï¼›\nåœ¨é€™å€‹æ¡ˆä¾‹ä¸­ï¼Œ å¾Œè€…çš„åŸ·è¡Œé€Ÿåº¦æœƒé å¿«æ–¼å‰è€…å› ç‚ºå¾Œè€…å…ˆloop ordersï¼Œæ¥è‘—æ‹¿ orders.user_idå» usersä¸­æ¯”å°users.idï¼Œè€Œ user.idæ˜¯ primary keyæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ï¼›\nåä¹‹ orders.user_idæ²’æœ‰ç´¢å¼•ï¼Œåªèƒ½å…¨è¡¨æƒæã€‚\nexplain select * from users right join orders on orders.user_id = users.id;\nexplain select * from users right join orders on orders.user_id = users.id;\nå­æŸ¥è©¢ å¦‚æœæˆ‘æƒ³è¦æ¢åˆ—æ‰€æœ‰è¨‚å–®æ•¸è¶…éå…©ç­†çš„ç”¨æˆ¶ï¼Œä¸¦åŒæ™‚é¡¯ç¤º{ç”¨æˆ¶æ‰€æœ‰è³‡æ–™ï¼Œè¨‚å–®æ•¸}ï¼Œå¯èƒ½æœ‰å¹¾ç¨®åšæ³•\nå¾usersÂ , temp tableå–è³‡æ–™ï¼Œtemp table æ˜¯æš«å­˜ è¨‚å–®æ•¸è¶…é2çš„ tableï¼Œå…©è€…åš INNER JOINÂ select users.*, temp.order_count from (select user_id, count(distinct orders.id) as order_count from orders group by orders.user_id having order_count \u0026gt; 2) temp INNER JOIN users on users.id = temp.user_id; orders å…ˆINNER JOIN usersï¼Œæ¥è‘—æ‰è¨ˆç®—è¨‚å–®æ•¸\nselect users.*, count(distinct orders.id) as order_count from orders INNER JOIN users on users.id = orders.user_id group by orders.user_id having order_count \u0026gt; 2; ç¬¬ä¸€é»çš„å•é¡Œæ˜¯åœ¨å­æŸ¥è©¢ (select user_id, count(distinct orders.id) as order_count ä¸å¯é¿å…çš„è¦è·‘ä¸€æ¬¡å…¨è¡¨æœå°‹ï¼Œä½†æ˜¯æš«å­˜æˆ temp TableåšINNER JOIN åˆæœƒåœ¨è·‘ä¸€æ¬¡ï¼Œç­‰åŒæ–¼å…¨è¡¨æœå°‹ orderså…©æ¬¡\n1\nç‚ºäº†é¿å…å¤šä¸€æ¬¡ç„¡è¬‚çš„å…¨è¡¨æœå°‹ï¼Œå…ˆJOINåœ¨ GROUP BY æ•ˆç‡å°±å¥½å¾ˆå¤šã€‚\n2\n","date":"2018-07-30T10:14:40.633Z","permalink":"https://yuanchieh.page/posts/2018/2018-07-30-mysql-explain%E5%88%86%E6%9E%90%E8%88%87index%E8%A8%AD%E5%AE%9A%E6%9F%A5%E8%A9%A2%E5%84%AA%E5%8C%96/","title":"MySQL Explainåˆ†æèˆ‡Indexè¨­å®šæŸ¥è©¢å„ªåŒ–"},{"content":"å‰é™£å­åœ¨çœ‹ Cloudflareä¸€äº›ç›¸é—œè¨­å®šï¼Œå‰›å¥½çœ‹åˆ° DNSSECé€™å€‹æŠ€è¡“åè©ï¼Œä»¥ä¸‹æ˜¯èªè­˜å¾Œçš„ç­†è¨˜ã€‚\nåƒè€ƒè³‡æ–™ï¼š\nhttps://www.cloudflare.com/dns/dnssec/how-dnssec-works/Â http://www.cc.ntu.edu.tw/chinese/epaper/0022/20120920_2206.html\nDNSèˆ‡DNSSEC DNSï¼ŒåŸŸåç³»çµ±ï¼Œç”¨ä¾†å°‡äººé¡å¥½è¨˜æ†¶çš„æ–‡å­—åŸŸåè½‰æ›ç‚º ipä½ç½®ï¼Œå°±å¥½åƒé›»è…¦ä¸–ç•Œçš„é›»è©±ç°¿ä¸€èˆ¬ï¼›\nä½†æ˜¯DNSæœ€å¤§å•é¡Œåœ¨æ–¼ï¼Œå–å¾—ç´€éŒ„å¾Œå»æ²’æœ‰é©—è­‰ç´€éŒ„æ˜¯å¦æ­£ç¢ºæˆ–æ˜¯è¢«ç«„æ”¹çš„æ–¹æ³•ï¼Œé€™ä¹Ÿæ˜¯ DNSSEC(Domain Name System Security Extensions) çš„å‡ºç¾ã€‚\næ•¸ä½ç°½ç«  DNSSECæ˜¯é€éæ•¸ä½ç°½ç« çš„æ–¹å¼ï¼Œç¢ºä¿DNSæŸ¥è©¢çš„ç´€éŒ„æ²’æœ‰è¢«ç«„æ”¹ï¼Œæ‰€ä»¥å…ˆä¾†ç°¡å–®ä»‹ç´¹ä»€éº¼æ˜¯æ•¸ä½ç°½ç« ã€‚\nç°½ç« ï¼Œæ˜¯ç‚ºäº†ç¢ºä¿æ¶ˆæ¯ä¸è¢«ç«„æ”¹æ€§èˆ‡ä¸å¯èª£è³´æ€§ ï¼Œåƒæ˜¯å¥‘ç´„è¦ä¸€è©¦å…©ä»½ï¼Œé›™æ–¹ç¢ºèªå¥½å…§å®¹ï¼Œæœ€çµ‚ç°½å­—ç•«æŠ¼ï¼›\nå‡è¨­æŸå¤©ç”²æ–¹ç«„æ”¹äº†å¥‘ç´„å…§å®¹ï¼Œä¹™æ–¹å¯ä»¥æ‹¿å‡ºç•¶åˆä¿ç•™çš„å¥‘ç´„åé§ï¼›\nåˆæˆ–æ˜¯ä¹™æ–¹æƒ³è¦å¦èªå¥‘ç´„ï¼Œä½†æ˜¯ç”²æ–¹åŒæ¨£å¯ä»¥æ‹¿å‡ºå¥‘ç´„ä¸­çš„ä¹™æ–¹ç°½ç« è­‰æ˜ã€‚\nç”² \u0026ndash;\u0026gt; è‡ªå·±ç”¢ç”Ÿå…¬é‘°èˆ‡ç§é‘°ï¼Œå…¬é‘°å¯ä»¥è®“æ‰€æœ‰äººå–å¾—ï¼Œç§é‘°è¦ä¿è­·å¥½\nä»Šå¤©ç”²è¦çµ¦ä¹™ä¸€ä»½æ–‡ä»¶ Docï¼Œç‚ºäº†æ¯”å°ç”¨ hashç”¢ç”Ÿé›œæ¹Šå€¼H\næ¥è‘—ç”²å°‡é›œæ¹Šå€¼Hç”¨ç§é‘°åŠ å¯†æˆ H_encryptedï¼ŒH_encrypted ä¹Ÿå°±æ˜¯æ•¸ä½ç°½ç« \nç”²å°‡ {Doc,H_encrypted} äº¤ç”±ä¸™è½‰äº¤çµ¦ä¹™ï¼Œæ­¤æ™‚ä¸™å·æ”¹äº† Doc\nä¹™æ”¶åˆ°å¾Œï¼Œå°‡ Docä¾ç…§ç´„å®šçš„hashç”¢ç”Ÿå‡ºé›œæ¹Šå€¼ H\u0026rsquo;\næ¥è‘—ç”¨ç”²çš„å…¬é‘°è§£é–‹ H_encrypted =\u0026gt; Hï¼Œç™¼ç¾H\u0026rsquo; != Hï¼Œç™¼ç¾å…§å®¹è¢«ç«„æ”¹äº†ï¼\n-\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026ndash;\nå‡è¨­å‰›æ‰ Docæ²’æœ‰è¢«ç«„æ”¹ï¼Œä¹™æ–¹é©—è­‰ä¸¦ç¢ºèªæ”¶åˆ°ç”²å‚³éçš„è¨Šæ¯\nä½†æ˜¯æŸæ—¥ç”²æƒ³è¦åæ‚”èªªæ²’æœ‰ç°½ç½²éè©²ä»½åˆç´„\næ­¤æ™‚ä¹™ä¸€æ¨£æ‹¿ç”²çš„å…¬é‘°è§£å¯†æ•¸ä½ç°½ç« ï¼Œæ¥è‘—æ¯”å° Docé€éhashçš„é›œæ¹Šå€¼ï¼Œç™¼ç¾æ˜¯ä¸€æ¨£çš„ï¼Œå› ç‚ºå…¬é‘°/ç§é‘°æ˜¯ç¨ä¸€ç„¡äºŒ(éå¸¸é›£ç¢°æ’)ï¼Œåªæœ‰å…¬é‘°å¯ä»¥è§£é–‹ç§é‘°åŠ å¯†çš„å…§å®¹(åä¹‹äº¦ç„¶)ï¼Œæ‰€ä»¥ç¯¤å®š Docæ˜¯ç”²ç°½ç½²çš„ã€‚\nDNSSEC 1.DNSç´€éŒ„æœ‰å¤šç¨®å‹åˆ¥ï¼Œå‡è¨­æ˜¯å®£å‘ŠAAAAå‹åˆ¥ï¼Œä¹Ÿå°±æ˜¯å°‡åŸŸåå°æ‡‰IPv6çš„ç´€éŒ„ï¼Œæ¯ä¸€ç­†è¨˜éŒ„ç¸®å¯«ç‚ºRRï¼›\nè€Œåœ¨ç°½ç½²éç¨‹ï¼ŒæœƒæŠŠåŒæ¨£å‹åˆ¥çš„ç´€éŒ„æ•´åˆç‚ºä¸€çµ„ï¼Œä¹Ÿå°±æ˜¯é€™é‚Šçœ‹åˆ°çš„RRsetã€‚\n2. æ¥è‘—å°‡RRsetç”¢ç”Ÿæ•¸ä½ç°½ç« ï¼Œä¹Ÿå°±æ˜¯RRSIGï¼Œæ¥è‘—å›è¦†DNSç´€éŒ„æ™‚ï¼Œç¸½å…±è¦çµ¦ä¸‰æ¨£æ±è¥¿\n{RRset / RRSIG / Public ZSK}\nPublic ZSKä¹Ÿå°±æ˜¯DNS Serverçš„å…¬é‘°ã€‚\nç”¨æˆ¶å°±å¯ä»¥æ‹¿ Public ZSKè§£é–‹ RRSIGï¼Œæ¯”å° RRsetï¼Œå°±å¯çŸ¥é“è©²RRsetæ˜¯å¦çœŸçš„ä¾†è‡ªDNS Server\nå¦‚ä½•ç¢ºä¿ Public ZSKæ˜¯æ²’æœ‰è¢«ç«„æ”¹ é€™åˆå¯ä»¥å¥—ç”¨æ•¸ä½ç°½ç« äº†ï¼Œå­DNS Serveræœƒå‘çˆ¶ DNS Server æäº¤ä»–çš„ Public ZSKï¼›\nçˆ¶DNS Serverå°±ç•¶ä½œ {å­DNS Server â†’ Public ZSK} ç•¶ä½œæ˜¯ä¸€ç­† RRSet(åˆç¨±DSï¼ŒDelegation Signer)\næ¥è‘—ä¸€æ¨£ç”¨è‡ªå·±çš„å…¬é‘°(Public KSK)ç°½ç½²æ•¸ä½ç°½ç« \nä½†å•é¡Œé‚„æ˜¯åœ¨ï¼Œè¦å¦‚ä½•åœ¨ç¢ºä¿ Public KSKæ˜¯æ­£ç¢ºçš„å‘¢ï¼Ÿ\né€™æœƒç„¡é™éè¿´æ•¸ä½ç°½ç« ç›´åˆ° DNS Root Serverï¼Œé€™ä¹Ÿæ˜¯ä¿¡ä»»éŠ(Chain of Trust)ã€‚\næœ‰èˆˆè¶£çœ‹dnsè§£ææœƒèµ°éäº›è·¯å¾‘å¯ä»¥ç”¨ä¸‹åˆ—å·¥å…·ï¼Œåƒæ˜¯ google.comï¼Œæœƒå…ˆåˆ° root dns server -\u0026gt;Â .com dns server -\u0026gt; google.com dns server -\u0026gt; return AA record\nTrace DNS Delegation\né‚£æˆ‘å€‘å¯ä»¥å…¨ç›¤ç›¸ä¿¡ RootÂ Serverå—? é€™ç¯‡æ–‡ç« èªªæ˜äº†æ•´å€‹Root Serveråœ¨ç™¼å¸ƒå…¬é‘°/ç§é‘°çš„åš´è¬¹æ€§ï¼Œé ‚ç´šåŸŸåå•†(.com,Â .edu,Â .orgÂ â€¦)ä»–å€‘çš„å°ˆæ¥­ç¶­è­·æ•´å€‹ç¶²è·¯å®‰å…¨çš„å¯é æ€§èˆ‡å¯ä¿¡åº¦ã€‚\nThe DNSSEC Root Signing Ceremony | Cloudflare\n","date":"2018-07-30T10:14:21.565Z","permalink":"https://yuanchieh.page/posts/2018/2018-07-30-dnssec-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%BB%8B%E7%B4%B9/","title":"DNSSEC åŸºæœ¬åŸç†ä»‹ç´¹"},{"content":"Nodejsåº•å±¤æ˜¯äº‹ä»¶é©…å‹•ï¼Œé€é Event Loopè™•ç†éåŒæ­¥(non-blocking)æ“ä½œï¼Œè®“è²»æ™‚çš„I/Oæ“ä½œå¯ä»¥äº¤ç”±libuvå»å‘¼å«ç³»çµ±äº‹ä»¶é©…å‹•çš„ system apiæˆ–æ˜¯ç”¨ multi threadæ–¹å¼è™•ç†ï¼Œè€ŒMain threadå‰‡æŒçºŒè™•ç†requestæˆ–å…¶ä»–é‹ç®—ã€‚\n1 // copy from nodejs å®˜ç¶² â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€\u0026gt;â”‚ timers â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚ pending callbacks â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚ idle, prepare â”‚ (internal use)â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ incoming: â”‚â”‚ â”‚ poll â”‚\u0026lt;â”€â”€â”€â”€â”€â”¤ connections, â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ data, etc. â”‚â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚ check â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â””â”€â”€â”¤ close callbacks â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ç°¡è€Œè¨€ä¹‹ï¼ŒEvent Loopæœ‰è¨±å¤šä¸åŒçš„éšæ®µ(phase)ï¼Œæ¯å€‹phase æ˜¯å€‹é™£åˆ—ï¼Œç•¶å®ŒæˆéåŒæ­¥æ“ä½œå¾Œï¼Œæœƒå°æ‡‰å°‡ callback task pushåˆ° phaseä¸­ï¼›\nNodejsæœƒä¸æ–·çš„è¼ªè©¢ Event Loopä¸¦åŒæ­¥åŸ·è¡Œcallback taskï¼Œç›´åˆ° Event Loopä¸Šéƒ½æ²’æœ‰ taskä¸” Main threadä¹Ÿéƒ½åŸ·è¡Œå®Œæˆï¼Œå°±æœƒé€€å‡ºã€‚\nNodejsä¸€äº›éåŒæ­¥æ“ä½œå°æ‡‰çš„ phaseå¦‚ä¸‹\n1.setTimeout å±¬æ–¼ timersÂ 2. pending callbacksä¸»è¦è™•ç†ç³»çµ±éŒ¯èª¤ callback\n3. poll éšæ®µå‰‡æ˜¯å‘ç³»çµ±å–å¾— IOäº‹ä»¶\n4.setImmediate å±¬æ–¼ check\n5.é—œé–‰äº‹ä»¶å¦‚ socket.on(â€˜closeâ€™,Â â€¦) å‰‡å±¬æ–¼ close\nprocess.nextTick æ˜¯åœ¨æ¯å€‹phaseçµæŸå‰åŸ·è¡Œï¼Œ Promise å±¬æ–¼ microtaskï¼ŒåŒæ¨£åŸ·è¡Œæ–¼æ¯å€‹phaseçµæŸä¹‹å‰ï¼Œä¸”åœ¨ process.nextTickä¹‹å‰ï¼›\næ‰€ä»¥è¦å°å¿ƒï¼Œä¸èƒ½è¦éè¿´å‘¼å«process.nextTickï¼Œæœƒå°è‡´æ•´å€‹Event Loopå¡ä½ï¼Œå› ç‚ºæ¯å€‹process.nextTickéƒ½æœƒåœ¨phaseçµæŸå‰åŸ·è¡Œã€‚\nä»¥ä¸Šå¤§è‡´ä»‹ç´¹ï¼Œå¯¦éš›é‹ä½œè¤‡é›œè¨±å¤šï¼Œé™„è¨»åƒè€ƒè³‡æ–™ï¼š\n1. https://www.eebreakdown.com/2016/09/nodejs-eventemitter.html\n2. https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/\n3. https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\n4. åœ¨ç€è¦½å™¨ä¸­ç‹€æ³è·ŸNodejsåŸ·è¡Œç’°å¢ƒä¸å¤ªç›¸åŒ https://github.com/kaola-fed/blog/issues/234#code-analysis-b-a\nä½†æˆ‘çœ‹é€™å€‹æœ‰ä»€éº¼ç”¨? åªè¦æˆ‘çŸ¥é“æ€éº¼å¯«éåŒæ­¥ç¨‹å¼ç¢¼ï¼Œäº†è§£åº•å±¤ Event LoopåŸ·è¡Œé †åºæœ‰ä»€éº¼æ„ç¾©å—?\né›–ç„¶èªªå­¸ç¿’ä¸è©²å¸¶æœ‰å¤ªå¼·çƒˆçš„åŠŸåˆ©æ€§ï¼Œè¿½æ ¹ç©¶åº•æœ¬èº«å°±æ˜¯å€‹æ¨‚è¶£ï¼Œä½†é€™å€‹å•é¡Œè‘—å¯¦å›°æ“¾æˆ‘é —ä¹…ï¼Œåœ¨é€™å…©å¤©çœ‹åˆ°äº† dataloader é©šç‚ºå¤©äººçš„ Libraryï¼Œä»¥ä¸‹æ­£æ–‡é–‹å§‹ã€‚\ndataloaderçš„ç”¨é€” dataloaderä¸»è¦ç”¨æ–¼è§£æ±ºGraphqlçš„N+1å•é¡Œï¼Œç¨å¾®ç°¡å–®ä»‹ç´¹ä¸€ä¸‹\nGraphqlæ˜¯ FBæå‡ºçš„æŠ€è¡“ï¼Œç”¨ä¾†ç•¶ä½œæ–°ä¸€ä»£çš„å‰å¾Œç«¯APIäº¤äº’ä»‹é¢ï¼Œä¸»è¦æ˜¯å°‡æœå°‹çš„èƒ½åŠ›äº¤é‚„çµ¦å‰ç«¯æ§åˆ¶ï¼Œå¾Œç«¯å°±è¢«å‹•é…åˆï¼›\næ”¹å–„ä»¥å¾€ RESTful APIåœ¨ GETä¸Šéº»ç…©çš„åœ°æ–¹ï¼Œä»¥ä¸‹ç‚ºç¤ºç¯„\nå‡è¨­æœ‰ User / Post / Commentï¼Œ\nUser 1 \u0026lt;-\u0026gt; m Postï¼ŒUserå¯ä»¥å‰µå»ºå¤šå€‹Post\nUser 1 \u0026lt;-\u0026gt; n Comment m \u0026lt;-\u0026gt; 1 Postï¼ŒUserå¯ä»¥åœ¨Postä¸‹ç™¼å¸ƒ Comment\nå‡è¨­ä»Šå¤©æˆ‘å€‘è¦é¡¯ç¤ºæŸç”¨æˆ¶çš„æ‰€æœ‰è²¼æ–‡ï¼Œä»¥RESTä¾†è¬›å¯èƒ½æ˜¯\n/user/:userId/post\nå¦‚æœè¦æŸç”¨æˆ¶ä¸‹æ‰€æœ‰è²¼æ–‡å¸¶è©•è«–\n/user/:userId/post/comment\nå¦‚æœæ˜¯æŸç”¨æˆ¶æŸè²¼æ–‡çš„æ‰€æœ‰è©•è«–\n/user/:userId/post/:postId/comment\n\u0026hellip;\u0026hellip;\næ‰€ä»¥åœ¨æŸ¥è©¢ä¸Šï¼Œå‰ç«¯å¤šä¸€å€‹éœ€æ±‚å¾Œç«¯å°±è¦å¤šä¸€éš»APIï¼Œæœ‰é»éº»ç…©\nå¦‚æœè¦çœè‘—ç”¨åŒä¸€å€‹APIå¤–åŠ queryä¾†åˆ¤æ–·ï¼Œå°±è®Šæˆè³‡æ–™å±¤æˆ–é‚è¼¯å±¤ä¸€æ¨£è¦è™•ç†\n-\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;-\nè€ŒGraphql å‰‡æ¼‚äº®å¾ˆå¤šï¼Œå‰ç«¯å®šç¾©å¥½éœ€è¦çš„è³‡æ–™æ ¼å¼ï¼Œå¾Œç«¯å°±æœƒå°ç…§å›å‚³(å¥—ä»¶è¼”åŠ©)\n1 2 3 4 5 6 7 8 9 10 { User { name, id, Post { title, Comment { content, User ....... } ä¸è«–æ˜¯è¦å–å¾— Userï¼ŒUser -\u0026gt; Postï¼Œ User -\u0026gt; Post -\u0026gt; Commentç„¡é™éè¿´ï¼Œéƒ½æ˜¯éå¸¸ç°¡å–®çš„ä¸€ä»¶äº‹\nå¾Œç«¯å‰‡æ˜¯å°æ‡‰å¥½è³‡æ–™æ“·å–ï¼ŒGraphqlåœ¨å¾Œç«¯æœƒéæ¿¾æŠŠå‰ç«¯éœ€è¦çš„æ¬„ä½å›å‚³ï¼Œå¤§å¹…é™ä½ç¶²è·¯ payloadï¼Œéå¸¸çš„ç°¡æ½”æœ‰åŠ›ã€‚\nå¦‚æœæ˜¯æœ‰å¤§é‡æŸ¥è©¢çš„æ‡‰ç”¨ç¨‹å¼ï¼Œæˆ–æ˜¯æœ‰è·¨è£ç½®æ‡‰ç”¨ï¼Œå¯ä»¥è€ƒæ…®å°å…¥ Graphqlï¼Œç¾åœ¨ä¾†èªªæ–¹æ¡ˆéƒ½å·²ç¶“éå¸¸æˆç†Ÿäº†ã€‚\nGraphql N+1å•é¡Œ ä½†æ˜¯åœ¨è®€å–å·¢ç‹€è³‡æ–™çš„éç¨‹ä¸­ï¼ŒGraphqlæœƒç™¼ç”ŸN+1å•é¡Œï¼Œä¾‹å¦‚å–å¾—æ‰€æœ‰ç”¨æˆ¶ä¸‹çš„æ‰€æœ‰æ–‡ç« {User{Post}} ï¼Œé€™æ™‚å€™å› ç‚ºæ¶æ§‹è¨­è¨ˆçš„é—œä¿‚ï¼ŒGraphqlæœƒå…ˆè®€å–æ‰€æœ‰çš„Userï¼Œæ¥è‘—å†é‡å°å€‹åˆ¥Userå»è®€å–Postï¼›\næ‰€ä»¥è³‡æ–™åº«è®€å–æœƒè®Šæˆ 1 æ¬¡è®€å–å…¨éƒ¨ User + Næ¬¡å€‹åˆ¥Userè®€å–Postï¼Œä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 SELECT \\* FROM User; --\u0026gt; å›å‚³äº† [1,2,3,4] SELECT \\* FROM Post WHERE user_id = 1; SELECT \\* FROM Post WHERE user_id = 2; .... \\---\u0026gt; è¼ƒç‚ºç†æƒ³æƒ…æ³ SELECT \\* FROM User; --\u0026gt; å›å‚³äº† [1,2,3,4] SELECT \\* FROM Post WHERE user_id in (1,2,3,4); \\---\u0026gt; æœ€ç†æƒ³ SELECT \\* FROM User LEFT JOIN Post on Post.userId = User.id; è€Œdataloaderæä¾›çš„è§£æ³•ç›¸ç•¶ç¾å¦™ï¼Œåœ¨æ‡‰ç”¨å±¤ç¨ä½œæ”¹è®Šï¼Œä¸å½±éŸ¿åŸæœ¬graphql / ä¸å¹²æ¶‰è³‡æ–™åº«æ“ä½œï¼Œå°‡ N+1é€²åŒ–æˆç¬¬äºŒå„ªåŒ–çš„æŸ¥è©¢æ¢ä»¶ã€‚\ndataloader ä»‹ç´¹ dataloaderä½œè€…\ndataloader ä¸»è¦åšå…©ä»¶äº‹ batch \u0026amp; cache ï¼Œå› ç‚ºåœ¨è™•ç† http requestä¸Šï¼Œç‚ºäº†ä¸Šè³‡æ–™ä¸éæœŸï¼Œå¤§å¤šä¸æœƒç”¨ä¸Š cacheï¼Œæ‰€ä»¥é€™è£¡åƒ…ä»‹ç´¹ batchã€‚\ndataloaderæä¾›çš„è§£æ³•æ˜¯å°‡ç•°æ­¥æ“ä½œåˆä½µï¼Œä¸¦åœ¨Event Loopçš„ä¸€å€‹phaseçµæŸå¾Œç”¨ process.nextTick åŸ·è¡Œã€‚\nå…ˆçœ‹dataloaderèªªæ˜ç¯„ä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 var DataLoader = require(\u0026#39;dataloader\u0026#39;) var userLoader = new DataLoader(keys =\u0026gt; myBatchGetUsers(keys)); /* myBatchGetUsersæ˜¯è‡ªè¨‚çš„å‡½å¼ï¼Œæ¥æ”¶è¢«dataloader batchèµ·ä¾†çš„keysï¼Œå›å‚³ç­‰åŒkeysé•·åº¦çš„Promise */ userLoader.load(1) .then(user =\u0026gt; userLoader.load(user.invitedByID)) .then(invitedBy =\u0026gt; console.log(`User 1 was invited by ${invitedBy}`)); // Elsewhere in your application userLoader.load(2) .then(user =\u0026gt; userLoader.load(user.lastInvitedID)) .then(lastInvited =\u0026gt; console.log(` User 2 last invited $ { lastInvited } `)); /* userLoader.load(1) ä»£è¡¨è¦è¼‰å…¥ï¼Œé€™æœƒè¢« dataloader batchèµ·ä¾†ï¼Œæœ€å¾Œå†keys =\u0026gt; myBatchGetUsers(keys)ä¸€ä½µè™•ç† */ // æ¥è‘—ä¾†çœ‹ç¨‹å¼ç¢¼ï¼Œç¸½å…±324è¡Œï¼Œå¤§æ¦‚æœ‰100è¡Œæ˜¯è¨»è§£â€¦ éå¸¸ç²¾ç°¡å·§å¦™çš„è¨­è¨ˆ load(key: K): Promise \u0026lt; V \u0026gt; { var promise = new Promise((resolve, reject) =\u0026gt; { // Enqueue this Promise to be dispatched. this._queue.push({ key, resolve, reject }); // åœ¨queue é‡æ–°å¡«è£æ™‚è§¸ç™¼ if (this._queue.length === 1) { if (shouldBatch) { // If batching, schedule a task to dispatch the queue. enqueuePostPromiseJob(() =\u0026gt; dispatchQueue(this)); } else { // Otherwise dispatch the (queue of one) immediately. dispatchQueue(this); } } }); return promise; } load()åŸ·è¡Œå¾Œæ˜¯å›å‚³ä¸€å€‹Promiseï¼Œæ³¨æ„é—œéµçš„ä¸€è¡Œ this._queue.push({...}) ï¼Œé€™å€‹å›å‚³çš„Promise resolveæ–¹æ³•æ˜¯è¢«pushåˆ° _queueä¸Šï¼Œè€Œ_queueæ˜¯ dataloaderä¸€é–‹å§‹å‰µå»ºæ™‚å»ºç«‹çš„ç©ºé™£åˆ—ã€‚\nenqueuePostPromiseJob 1 2 3 4 5 6 7 8 9 10 11 12 var enqueuePostPromiseJob = typeof process === \u0026#39;object\u0026#39; \u0026amp;\u0026amp; typeof process.nextTick === \u0026#39;function\u0026#39; ? function(fn) { if (!resolvedPromise) { resolvedPromise = Promise.resolve(); } resolvedPromise.then(() =\u0026gt; process.nextTick(fn)); } : setImmediate || setTimeout; // Private: cached resolved Promise instance var resolvedPromise; resolvedPromiseå°±æ˜¯ç”¨ä¾†æš«å­˜çš„ Promise.resolve()ï¼Œç”¨ä¾†åŸ·è¡ŒresolvedPromise.then(() =\u0026gt; process.nextTick(fn)) ï¼Œfn æ˜¯å‰›æ‰çš„ () =\u0026gt; dispatchQueue(this) ï¼›\nå¦‚æœç’°å¢ƒæœ‰ process.nextTickå‰‡ç”¨ï¼Œä¸ç„¶ç”¨ setImmediate / setTimeout ä¹Ÿå¯ä»¥!\né€™è£¡ä½œè€…æ‰“ä¸Šäº†25è¡Œçš„è¨»è§£ï¼Œå¤§æ„æ˜¯èªªï¼š\nECMAScript é‹ç”¨ Job / Job Queueæè¿°ç•¶ä¸‹åŸ·è¡ŒçµæŸå¾Œçš„å·¥ä½œé †åºå®‰æ’ï¼›\n(å°ç…§Nodejsä¹Ÿå°±æ˜¯Event Loopçš„å¯¦ä½œ)ï¼ŒNodejsç”¨ process.nextTickå¯¦ä½œ Jobçš„æ¦‚å¿µï¼Œç•¶å‘¼å«äº† Promise.then å‰‡æœƒåœ¨ global Jobsqueueä¸­åŠ å…¥ PromiseJobsé€™æ¨£çš„ä¸€å€‹ Jobã€‚\ndataloaderæœƒæ‰“åŒ…åŒä¸€å€‹åŸ·è¡Œçš„å¹€(frame) ä¸­çš„æ“ä½œï¼ŒåŒ…å«åœ¨è™•ç†PromiseJobs queues ä¹‹é–“çš„ loadä¹Ÿæœƒè¢«ä¸€ä½µæ‰“åŒ…ã€‚\né€™ä¹Ÿæ˜¯ç‚ºä»€éº¼è¦ç”¨resolvedPromise.then(() =\u0026gt; process.nextTick(fn)) ï¼Œç¢ºä¿åœ¨æ‰€æœ‰çš„ PromiseJobsä¹‹å¾ŒåŸ·è¡Œ (*å‚™è¨»ä¸€)ï¼›\né€™ä¸€æ®µä¸»è¦æ˜¯å› æ‡‰cacheè™•ç†ï¼Œå¦‚æœæœ‰é–‹å•Ÿcacheï¼ŒåŸ·è¡Œéå¾Œä¸€æ¬¡dataloaderæœƒä»¥ Promise.resolveå„²å­˜çµæœï¼Œä¹Ÿå°±æ˜¯å¾ŒçºŒä¸ç®¡èª¿ç”¨å¹¾æ¬¡éƒ½æ˜¯ç«‹åˆ»å›è¦†çµæœï¼›\næ‰€ä»¥ä¸‹åˆ—çµæœ 1 / 5 /6 æœƒè¢«batchåœ¨åŒä¸€å€‹phaseåŸ·è¡Œï¼Œè€Œ4æœƒåˆ°ä¸‹ä¸€å€‹loopå»\n1 2 3 4 5 6 7 8 9 10 testLoader.load(1).then(t =\u0026gt; console.log(\u0026#34;1 got \u0026#34;, t)) Promise.resolve().then(() =\u0026gt; { testLoader.load(5) }).then(() =\u0026gt; { testLoader.load(6) }) setTimeout(() =\u0026gt; { testLoader.load(4) }) è€Œç€è¦½å™¨æ²’æœ‰å‘Nodejsä¸­æä¾› microtask(process.nextTick)ï¼Œåªèƒ½ç”¨ macrotask(setImmediate / setTimeout)å–ä»£ï¼Œä½†æœƒæœ‰æ€§èƒ½ä¸Šçš„å½±éŸ¿ã€‚\ndispatchQueueBatch 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 var keys = queue.map(({ key }) =\u0026gt; key); var batchPromise = batchLoadFn(keys); batchPromise.then(values =\u0026gt; { queue.forEach(({ resolve, reject }, index) =\u0026gt; { var value = values[index]; if (value instanceof Error) { reject(value); } else { resolve(value); } }); }) dispatchQueue å¤šåšä¸€äº›åˆ¤æ–·ï¼Œæœ€å¾Œå‘¼å«dispatchQueueBatchï¼›\nåœ¨æ­¤è™•å–å‡ºæ‰€æœ‰ä½”å­˜åœ¨queueä¸Šçš„keysï¼Œä¸¦å‘¼å«batchLoadFnï¼Œä¹Ÿå°±æ˜¯åœ¨ new Dataloader((keys)=\u0026gt;{â€¦}) æ‰€å®šç¾©çš„ï¼ŒåŸ·è¡Œå¾Œå°±å°æ‡‰queueä¸Šçš„ resolveï¼Œä¹Ÿå°±æ˜¯æŠŠå€¼å›å‚³çµ¦ userLoader.load(k).then(value =\u0026gt;Â â€¦.) åšå¾ŒçºŒçš„è™•ç†ã€‚\nç¸½çµä¸€ä¸‹ï¼Œè¦ä½¿ç”¨æ™‚å…ˆå»ºç«‹ dataloaderï¼Œä¸¦æ±ºå®šå°æ‡‰çš„ batch loaderè©²å¦‚ä½•è™•ç†ï¼Œé€šå¸¸å°±æ˜¯æ”¾è³‡æ–™åº« batchè™•ç† new Dataloader((keys) =\u0026gt; customBatchLoader(keys)) ï¼›\næ¥è‘—å®šç¾©æ“ä½œï¼Œ loader.load(key).then(value =\u0026gt; {}) ï¼›\ndataloaderå…§éƒ¨é€é enqueuePostPromiseJob æ©Ÿåˆ¶ï¼Œå°‡ä¸€å€‹åŸ·è¡Œå¹€å…§å®šç¾©çš„æ“ä½œéƒ½åŒ¯é›†èµ·ä¾†ï¼Œä¸¦åœ¨ Event Loop phaseæœ€å¾ŒåŸ·è¡Œï¼›\næœ€å¾Œå…§éƒ¨å‘¼å« dispatchQueueBatch ï¼Œä¹Ÿå°±æ˜¯å¯¦éš›èª¿ç”¨ customBatchLoader çš„åœ°æ–¹ï¼Œæœ€å¾Œ resolve ç•¶åˆå®£å‘Šçš„ loader.load() ã€‚\ndataloaderç°¡å–®ç¯„ä¾‹ æ‰“å°çµæœï¼Œæ³¨æ„ setTimeoutæœƒåœ¨ä¸‹ä¸€å€‹loopåŸ·è¡Œï¼Œè€ŒPromise.resolve()å‰‡åœ¨åŒä¸€å€‹ phaseè¢«è™•ç†æ‰ã€‚\n1 2 3 4 5 6 batched by dataloader: [ 1, 2, 3, 5 ] content: [ 1, 2, 3, 5 ] 1 got 2 [2,3] got [ 3, 4 ] batched by dataloader: [ 4 ] content: [ 4 ] å°æ‡‰æˆ‘å€‘è¦è§£æ±ºçš„N+1å•é¡Œï¼Œå› ç‚ºGraphqlæ€éº¼è™•ç†åº•å±¤å‘¼å«ç®—æ˜¯å€‹é»‘ç›’å­ï¼Œä»¥ä¸‹æ˜¯å¤§æ¦‚ç¤ºæ„\n1. åŸæœ¬Graphqlçš„ N + 1å•é¡Œ\n1 2 3 let userList = await db.getUsers() let post1 = await db.getPostByUserId(userList[0].id) let post2 = await db.getPostByUserId(userList[1].id) \u0026hellip;\u0026hellip;\n2. å¦‚æœç”¨dataloaderè½‰æ›\n1 2 3 4 5 6 7 8 9 10 11 let userList = await db.getUsers() // postè«‹æ±‚é›†ä¸­æˆ let postLoader = new Dataloader((keys) =\u0026gt; { let res = await db.getPostListByUserId(keys) return Promise.all(res.map(r =\u0026gt; Promise.resolve(r))) }) // ç…§èˆŠä¸€å€‹ä¸€å€‹å®šç¾©é‚„æ˜¯å¯ä»¥ let post1 = await postLoader.load(userList[0].id) let post2 = await postLoader.load(userList[1].id) çµèª åŸæœ¬ä»¥ç‚º N+1å•é¡Œè¦è§£æ±ºå¿…é ˆæ·±å…¥åˆ°æ”¹å¯«è³‡æ–™åº«çš„SQLï¼Œä¾‹å¦‚è½‰æˆ SELECT INï¼Œä½†æ²’æƒ³åˆ°æœ‰å€‹å¦‚æ­¤ç°¡æ½”åˆæ¼‚äº®çš„è§£æ³•ï¼Œè€Œä¸”ä¸é™å®šç”¨ä»€éº¼è³‡æ–™åº«ï¼ŒçœŸçš„æ˜¯å¤ªæ£’äº†ã€‚\næ·±å…¥åº•å±¤ç†è§£åŸç†ï¼ŒæŠ½è±¡åˆè²»æ™‚ï¼Œä½†æˆ‘æƒ³é€™æ¨£çš„æŠ•è³‡æ˜¯å€¼å¾—çš„ï¼Œä¸ç¦å†æ¬¡æ„Ÿå˜†é€™å€‹Libraryçš„ç²¾å¦™ï¼ŒI dont know JS OTZã€‚\nå‚™è¨» ç¯‡å¹…æœ‰é»é•·ï¼Œæ‰€ä»¥æŠŠä¸€äº›ç´°ç¯€æ”¾åœ¨é€™è£¡\nç¢ºä¿åœ¨æ‰€æœ‰çš„ PromiseJobsä¹‹å¾ŒåŸ·è¡Œ é€™éƒ¨åˆ†è¦æ·±å…¥äº†è§£ Nodejs åŸ·è¡Œ microtaskèˆ‡macrotaskçš„é †åº\nPromise.resolve ().then (() =\u0026gt; {\nconsole.log (2);\n}).then (() =\u0026gt; {\nconsole.log (9);\nprocess.nextTick (() =\u0026gt; {\nconsole.log (7);\n});\nPromise.resolve ().then (() =\u0026gt; {\nconsole.log (8);\n});\n});\nprocess.nextTick (() =\u0026gt; {\nconsole.log (1);\n});\nPromise.resolve ().then (() =\u0026gt; {\nconsole.log (3);\n}).then (() =\u0026gt; {\nconsole.log (6);\n});\nsetImmediate (() =\u0026gt; {\nconsole.log (5);\n});\nsetTimeout (() =\u0026gt; {\nconsole.log (4);\n});\n////// æ‰“å°çµæœ\n1\n2\n3\n9\n6\n8\n7 \u0026ndash;\u0026gt; ç­‰åŒæ–¼ dataloader ç¬¬ä¸€æ¬¡ batchè§¸ç™¼çš„æ™‚æ©Ÿ\n4\n5\né€™éƒ¨åˆ†è »æœ‰è¶£çš„ï¼Œä¸€é–‹å§‹Event Loopæœƒå…ˆå¾ nextTick queueé–‹å§‹ï¼Œæ‰€ä»¥1æœƒå…ˆæ‰“å°ï¼›\næ¥è‘—è™•ç† Promise.resolve()çš„ promise queueï¼Œä¹Ÿå°±æ˜¯2 3ï¼›\næ¥è‘— 2 3åˆ†åˆ¥åˆç¹¼çºŒå¾€å¾Œresolve 9 6ï¼›\n8ä¹‹æ‰€ä»¥åœ¨7ä¹‹å‰æ˜¯å› ç‚º Nodejsæ­¤æ™‚å†è™•ç† promise queueï¼Œæ‰€ä»¥æœƒå„ªå…ˆè™•ç†promiseï¼Œè™•ç†å®Œæˆå¾Œæ‰æœƒå†è™•ç† nexttickï¼›\nç­‰ microtaskéƒ½è™•ç†å®Œï¼Œæ‰æœƒé€²åˆ°å…¶ä»–timer phaseèˆ‡å¾ŒçºŒçš„phaseè™•ç†ã€‚\né€™ä¹Ÿæ˜¯ç‚ºä»€éº¼enqueuePostPromiseJob è¦ç”¨ promise.resolve(()=\u0026gt;process.nextTick(()=\u0026gt;dispatchQueue(this))) ï¼Œå°æ‡‰å¦‚æœ Promise.resolve().then().then() ä¸­çš„ Promiseéƒ½æ˜¯ resolveäº†å°±æœƒè‡ªå‹•åœ¨åŒä¸€å€‹ batchè™•ç†ï¼Œå°å°ä¹Ÿå°±æ˜¯æ‰“å° 7 çš„ä½ç½®ã€‚\nå¦‚æœé–‹å•Ÿäº† dataloader cacheï¼Œdataloader æ˜¯ç›´æ¥å„²å­˜ resolved promiseï¼Œæ€§èƒ½æœƒæœ‰é¡¯è‘—çš„æå‡ã€‚\n","date":"2018-07-16T12:35:50.102Z","permalink":"https://yuanchieh.page/posts/2018/2018-07-16-%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E7%90%86%E8%A7%A3-nodejs-event-loopdataloader-%E6%BA%90%E7%A2%BC%E8%A7%A3%E8%AE%80%E8%88%87%E5%88%86%E6%9E%90%E5%A6%82%E4%BD%95%E8%A7%A3%E6%B1%BA-graphql-n-1%E5%95%8F%E9%A1%8C/","title":"ç‚ºä»€éº¼è¦ç†è§£ Nodejs Event Loopï¼šDataloader æºç¢¼è§£è®€èˆ‡åˆ†æå¦‚ä½•è§£æ±º Graphql N+1å•é¡Œ"},{"content":"ç¶²é ç€è¦½æ™‚å‡ºç¾HTTPSçš„ç¶ è‰²é–çœ‹äº†ä»¤äººæ”¾å¿ƒï¼Œé€™ä¼¼ä¹ä»£è¡¨è‘—æˆ‘å€‘åœ¨ç¶²ç«™ç€è¦½çš„è³‡æ–™æœ‰å—åˆ°ã€Œå®Œæ•´çš„åŠ å¯†ä¿è­·ã€ï¼Œä¸ç”¨æ“”å¿ƒè³‡æ–™è¢«å·çªºèˆ‡è¢«èª¿åŒ…ç­‰ç­‰MitMä¸­é–“äººæ”»æ“Šçš„é¢¨éšªï¼Œä½†äº‹å¯¦ç•¶ç„¶æ²’æœ‰é€™éº¼ç°¡å–®ã€‚\nåœ¨ç”³è«‹SSLæ†‘è­‰æ™‚æ˜¯ç¶å®šåŸŸåç”³è«‹ï¼Œç†è«–ä¸Š DNSè§£æåŸŸåå¾Œç›´æ¥æŒ‡å‘Serveræ‰€åœ¨IPï¼Œä¹Ÿå°±æ˜¯Clienté€éHTTPSåœ¨ç´¢å–æ†‘è­‰ã€é©—è­‰æ†‘è­‰ã€èˆ‡ Serverå…±åŒç”Ÿæˆå°ç¨±åŠ å¯†é‡‘é‘°å¾Œï¼Œå¯¦éš›å°‡è³‡æ–™åŠ å¯†å‚³è¼¸åˆ°Serverçš„æ•´æ®µç¶²è·¯éç¨‹æ˜¯å—åˆ°å®Œæ•´çš„ä¿è­·ã€‚\nä½†æ˜¯ç¾åœ¨å¾ˆå¤šç¶²ç«™ç‚ºäº†æ•ˆèƒ½ä¸Šèˆ‡å®‰å…¨æ€§ä¸Šçš„è€ƒé‡ï¼Œæ¡ç”¨äº†å‘ Cloudflareé€™æ¨£çš„ DNSä»£ç®¡ / CDNæœå‹™ï¼›\nClient â† â†’ Cloudflare â† â†’ Server\nCloudflareåœ¨å…¨çƒå„å¤§æ´²éƒ¨ç½²å¤šå€‹è³‡æ–™ä¸­å¿ƒï¼Œæœƒè‡ªå‹•å°‡DNS / Cachedè³‡æ–™æ•£ä½ˆåˆ°å¤šç¯€é»ä¸Šï¼Œä¸¦æä¾›å¤šé …å„ªè³ªæœå‹™ï¼Œå¦‚\nå¾åœ°ç†ä½ç½®æœ€è¿‘çš„ç¯€é»å›è¦† Clientæ‰€éœ€è³‡æ–™ï¼Œä¹‹å‰æ›¾çœ‹éå¯¦æ¸¬å¤šå®¶DNS/CDNæœå‹™å•†çš„è³‡æ–™ï¼ŒCloudflareå›æ‡‰é€Ÿåº¦æ˜¯æœ€å¥½çš„ï¼› åœ¨Cloudflareå¾Œå°è§€å¯Ÿåˆ°ç¶²ç«™æœ‰è¿‘å…«æˆçš„æµé‡æ˜¯å‘½ä¸­Cacheå¾ Cloudflareç›´æ¥å›è¦† Clientï¼Œé™ä½Server è² æ“”èˆ‡æµé‡ï¼Œå†Serverä»¥æµé‡è¨ˆè²»çš„ä¸»æ©Ÿè¨—ç®¡ä¸‹ç¯€çœå¾ˆå¤§çš„æˆæœ¬ã€‚ DDosé˜²è­·èˆ‡ç™½/é»‘ipåå–®å»ºç«‹ ä½†æ˜¯æ¡ç”¨ Cloudflareæœ‰äº›è³‡å®‰ä¸Šçš„ç–‘æ…®ï¼Œä¹Ÿæ˜¯æ­¤æ¬¡ç­†è¨˜çš„å…§å®¹\nä¸»è¦ç´€éŒ„\n1. æ¡ç”¨Cloudflareé¢¨éšªåœ¨å“ª\n2. ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬\næ¡ç”¨Cloudflareé¢¨éšªåœ¨å“ª Client â†â†’ Cloudflare å…ˆå‰æåˆ°Cloudflareæœƒæ“‹åœ¨ Clientèˆ‡ Serverä¹‹é–“ï¼Œå¦‚æœå•Ÿç”¨CDNæœå‹™ç‚ºäº†è§£æç·©å­˜è³‡æ–™ï¼ŒCloudflare æœƒéœ€è¦åœ¨ä»–é€™å±¤ç›´æ¥è§£å¯†ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ç”¨å…è²»ç‰ˆ Cloudflareæœƒæä¾› Universal (shared)çš„æ†‘è­‰ï¼Œé€™æ˜¯ç°½ç™¼æ–¼ Cloudflareæ©Ÿæ§‹åº•ä¸‹ï¼›\nå¦‚æœè¦ç”¨è‡ªå·±åŸŸåç°½ç™¼çš„æ†‘è­‰ï¼Œå¿…é ˆé€éCloudflareè³¼è²·æˆ–æ˜¯ä¸Šå‚³è‡ªå·±è³¼è²·çš„æ†‘è­‰èˆ‡ç§é‘° ï¼Œé€™å…©é …éƒ½å¿…é ˆæ¡ç”¨ä»˜è²»æ–¹æ¡ˆï¼›\nä½†é€™æ¨£çœ‹ä¾† Cloudflare å°±æ˜¯æ¸¾ç„¶å¤©æˆçš„ MitMä¸­çš„ä¸­é–“äººï¼Œä½†æ˜¯æˆ‘å€‘é¸æ“‡ç›¸ä¿¡ä»–ï¼Œæœ‰çœ‹åˆ°ä¸€äº›è¬ è¨€æ˜¯èªª CloudflareèƒŒå¾Œæœ‰ç¾åœ‹çš„ NSAåœ‹å®¶å®‰å…¨å±€æŠŠæŒï¼Œæ‰€ä»¥è³‡æ–™å¯èƒ½æœ‰æ´©æ¼çš„ç–‘æ…®ï¼Œç•¢ç«Ÿ Cloudflareå¯ä»¥çœ‹åˆ°æ‰€æœ‰è§£å¯†å¾Œçš„è³‡æ–™ã€‚\nçœ‹åˆ°ä¸€äº›è¨è«–æ˜¯åŠä¿¡åŠç–‘ï¼ŒæŠ€è¡“æ€§ä¸Šä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æµé‡éƒ½æœƒå°å‘ç¾åœ‹çš„æœå‹™å™¨ï¼Œä½†é‚„æ˜¯æœ‰å¿…è¦ç•™å€‹å¿ƒçœ¼ï¼Œç•¢ç«Ÿå…ˆå‰ä¹Ÿæ˜¯æœ‰ FBIè¦æ±‚ Apple è§£é–Iphoneçš„ç¶“æ­·ï¼Œåœ‹å®¶æ©Ÿå™¨å†è™•ç†é€™ç¨®æ³•å¾‹ã€è³‡å®‰ã€å€‹è³‡ç­‰è­°é¡Œç¢ºå¯¦è »æ™æ‰çš„ã€‚\nTim Cook says Apple\u0026rsquo;s refusal to unlock iPhone for FBI is a \u0026lsquo;civil liberties\u0026rsquo; issue\n(é›–ç„¶Apple åœ¨ä¸­åœ‹ä¹Ÿæœè»Ÿäº†Â :/)\næ‰€ä»¥å¦‚æœè¦æœ‰ç·©å­˜æ©Ÿåˆ¶ä¸”éå¸¸åœ¨æ„ Client â†’ Server å¿…é ˆå…¨ç¨‹èµ°HTTPSä¸”ä½¿ç”¨è‡ªå®¶æ†‘è­‰ä¸è¢«ä»»ä½•äººåœ¨ä¸­é€”è§£å¯†è³‡æ–™ï¼Œå°±é©åˆè‡ªå»ºCache Server ä¸é©åˆç”¨Cloudflareã€‚\nCloudflare â†â†’Â Server å¾Cloudflareåˆ°Serveré€™æ®µæœ‰ä¸åŒå±¤ç´šçš„è¨­å®šï¼Œå¯ä»¥æ–¼å¾Œå°è¨­å®š\nOffï¼š\nå…¨éƒ¨èµ°HTTP Flexibleï¼š\nClient â†’ Cloudflare èµ°HTTPSï¼Œè€ŒCloudflare â†’ Server èµ°HTTP Fullï¼š\nCloudflare â†’ Server èµ°HTTPSï¼Œä½†æ˜¯ Cloudflareä¸æœƒé©—è­‰æ†‘è­‰ã€‚\nServeréœ€è¦é–‹å•Ÿ443 port æ‰èƒ½è™•ç†ã€‚ Full(strict)ï¼š\nå‘ˆä¸Šï¼Œä½†æ˜¯Cloudflareæœƒå‘CAé©—è­‰æ†‘è­‰çš„æ­£ç¢ºæ€§ï¼Œé€™éƒ¨åˆ†éœ€è¦æ­é…è¨­å®š Origin Certificates ï¼Œå¯ä»¥ç”± Cloudflare ç”¢ç”Ÿæˆ–æ˜¯è‡ªå·±ç”¢ç”Ÿå¾Œä¸Šå‚³ã€‚\nCloudflareæœ¬èº«ä¹Ÿæ˜¯åˆæ ¼çš„CAï¼Œæ‰€ä»¥å¾€å¥½è™•æƒ³æ˜¯ä¸Šå‚³æ†‘è­‰æ˜¯å¯ä»¥è¢«ä¿¡ä»»çš„ï¼Œä½†åŒæ¨£çš„é›è›‹éƒ½åœ¨åŒä¸€å€‹ç±ƒå­è£¡æœ¬èº«å°±æ˜¯å€‹é¢¨éšªï¼Œç®—æ˜¯ä¸€é«”å…©é¢ã€‚ ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬ æ‰€ä»¥é™¤äº†Clientè¦æœ‰HTTPSä¿è­·ï¼Œåœ¨Serveré€™æ®µä¹Ÿå»ºè­°è¦é–‹å•Ÿ Fullä»¥ä¸Šçš„é˜²è­·æªæ–½ï¼ŒServeréƒ¨åˆ†ç”¨ Letâ€™s Encrypt å…è²»ç°½ç½²ï¼Œä¸¦åŒæ™‚é–‹å•Ÿ 80 / 443 portï¼Œä¾†èª¿æ•´å°æ‡‰Cloudflareçš„SSLä¿è­·æªæ–½ã€‚\n1. åƒ…é–‹å•Ÿ Cloudflare DNSï¼š é€™æ™‚å€™æ‰“ https://domain.com æœƒå‡ºç¾è‡ªå·±ç°½ç™¼çš„æ†‘è­‰ï¼Œåƒæˆ‘æ˜¯ç”¨ Letâ€™s Encrypt ç°½ç½²çš„æ†‘è­‰\n2. é–‹å•Ÿ Cloudflare CDNæœå‹™ï¼š é€™æ™‚å€™åŒæ¨£çš„ https://domain.com æœƒè‡ªå‹•è®Šæˆ Cloudflare Universal æ†‘è­‰\nä»¥ä¸Šæ˜¯ Client \u0026lt;\u0026ndash;\u0026gt; Cloudflareé€™æ®µ\nä»¥ä¸‹ç”¨ \u0026gt; sudo tcpdump -nn -i eth0 'tcp and (not port 22)' æŸ¥çœ‹å°åŒ…ï¼Œæ’é™¤port 22 ä¸»è¦æ˜¯é¿å… ssh å°åŒ…å¹²æ“¾è§€å¯Ÿ\n3. SSL è¨­ç‚ºÂ Flexible å¾ Cloudflare(ç”¨ whois 172.68.47.149æŸ¥è©¢å¾Œç¢ºèª) åˆ° Serveræ˜¯èµ° 80 port\n4. SSL è¨­ç‚º Full / FullÂ (strict) å¾Œå°è¨­å®šåˆ‡æ›å¾Œç­‰å€‹ä¸‰ã€äº”ç§’å°±ç«‹å³æ”¹èµ° port 443\n5. æ¸¬è©¦æ†‘è­‰æª¢æŸ¥ Full (strict)å·®åˆ¥åœ¨æ–¼æœƒæª¢æŸ¥æ†‘è­‰æ˜¯å¦ç‚ºå…¬é–‹çš„ç¬¬ä¸‰æ–¹CAé ’å¸ƒçš„åˆæ³•æ†‘è­‰ï¼Œé‚£å°±ä¾†ç¢ºèªä¸€ä¸‹æª¢æŸ¥çš„æ©Ÿåˆ¶æ˜¯å¦OKã€‚\na. åœ¨ Full ç‹€æ…‹ä¸‹æ”¹ç”¨å…¶ä»–ç¶²åŸŸçš„SSLæ†‘è­‰ =\u0026gt; å¯ä»¥!\nb. åœ¨ Full (strict) ç‹€æ…‹ä¸‹æ”¹ç”¨å…¶ä»–ç¶²åŸŸçš„SSLæ†‘è­‰ =\u0026gt; ä¸è¡Œï¼Œæœƒæª¢æŸ¥\nå¦‚æœæ˜¯è‡ªç°½æ†‘è­‰ï¼Œè¨˜å¾—è¦ä¸Šå‚³ CSRåˆ°Cloudflareï¼Œä¸ç„¶ä¸€æ¨£æœƒå‡ºéŒ¯ã€‚\nçµè«– åƒ…ä½¿ç”¨ Cloudflare DNSæœå‹™ï¼ŒClientæœƒçœ‹åˆ°è‡ªå®¶æä¾›çš„æ†‘è­‰ é–‹å•Ÿ Cloudflare CDNæœå‹™ï¼Œå…è²»ç‰ˆè½‰ç‚º Cloudflare Universal SSLæ†‘è­‰ï¼›\nå¦‚è¦æ›¿æ›ç‚ºè‡ªå·±Domainç°½ç½²çš„æ†‘è­‰ï¼Œéœ€è¦ä»˜è²»æ–¹æ¡ˆ é–‹å•Ÿ Cloudflare CDNï¼Œæœƒè®“ Cloudflareæˆç‚ºä¸­é–“äººï¼Œè³‡æ–™æœ‰è¢«å¤–éœ²çš„ç–‘æ…® è¨˜å¾—é–‹å•Ÿ SSL ç‚º Full(strict)ï¼Œä¿è­· Cloudflare åˆ° Serveré€™æ®µ ","date":"2018-07-11T01:37:07.542Z","permalink":"https://yuanchieh.page/posts/2018/2018-07-11-https%E4%B8%8D%E4%BB%A3%E8%A1%A8%E5%AE%89%E5%85%A8cloudflare-ssl-%E7%A0%94%E7%A9%B6%E5%BE%9Eserver%E5%88%B0cloudflare/","title":"HTTPSä¸ä»£è¡¨å®‰å…¨ï¼šCloudflare SSL ç ”ç©¶å¾Serveråˆ°Cloudflare"},{"content":"ä»Šå¤©çœ‹åˆ°ä¸€éƒ¨ä¸éŒ¯çš„å½±ç‰‡ï¼Œä¸»é¡Œæ˜¯ã€Œåˆ©ç”¨Async Pattern æå‡JSåœ¨å¤šæ ¸å¿ƒä¸Šçš„åŸ·è¡Œé€Ÿåº¦ã€ï¼Œç´°æ‹†å€‹ä¸‰å€‹å°ç¯€\n1. ç”¨Async IIFE è§£æ±ºä»»å‹™é–“ç›¸ä¾èˆ‡ä¸¦è¡Œçš„å•é¡Œ\n2. ç”¨High Order Functionæ¦‚å¿µè¨­è¨ˆ Semaphoreï¼Œæ§åˆ¶åŒæ™‚ä¸¦è¡Œçš„ä»»å‹™æ•¸\n3. é€éWorker è®“ä»»å‹™è·‘åœ¨å€‹åˆ¥Threadä¸Šï¼Œå¢åŠ å¤šæ ¸å¿ƒçš„æ•ˆèƒ½åˆ©ç”¨ã€‚\nConcurrency vs Parallelism Concurrency ä¸¦è¡Œæ˜¯æŒ‡ å¤šå€‹TaskåŸ·è¡Œæ™‚é–“æœ‰é‡ç–Šï¼Œä¹Ÿå°±æ˜¯èªªTask1åŸ·è¡Œä¸­æ™‚Task2ä¹Ÿé–‹å§‹åŸ·è¡Œï¼Œç®—æ˜¯ä¸€å€‹æ¦‚å¿µæ€§è³ªä¸Šçš„å®šç¾©ï¼Œå³ä½¿åªæœ‰å–®ä¸€æ ¸å¿ƒä¹Ÿå¯ä»¥é€éTime Sharing é”åˆ° Concurrencyã€‚\nParallelism ä¸¦ç™¼ï¼Œå¼·èª¿çš„æ˜¯å¤šå€‹Taskè¢«åˆ†é…åˆ°å¤šå€‹å¯¦é«”CPUä¸Šï¼ŒåŒæ™‚ä¸”ç¨ç«‹åŸ·è¡Œã€‚\nAsync IIFE Cross Stitching: Elegant Concurrency Patterns for JavaScript\næœ€åŸºæœ¬ä½¿ç”¨ async/await å°±æ˜¯ä¸€è¡Œä¸€è¡Œå¯«ï¼Œå¦‚\nawait task1();\nawait task2();\nawait task3();â€¦\nä½†å¦‚æœä¸åŒ taskä¹‹é–“å¯èƒ½æœ‰ç›¸äº’ä¾è³´ï¼Œå¦‚ task2 ä¸¦é ˆç­‰åˆ° task1çµæŸæ‰èƒ½é€²è¡Œ/ ä½†ä¹Ÿæœ‰äº› taskäº’ç›¸ç¨ç«‹å¯ä»¥ä¸¦è¡Œï¼Œå¦‚æœå–®ç´”ä¸€è¡Œä¸€è¡Œ async/await æœƒæµªè²»ç­‰å¾…çš„æ™‚é–“ã€‚\nå›°é›£çš„é»åœ¨æ–¼ä»»å‹™è¤‡é›œï¼Œå¦‚ä½•æ¼‚äº®åœ°è¡¨ç¤ºä»»å‹™é–“çš„å…ˆå¾Œé †åºç›¸ä¾ï¼Œä¸¦è®“ä¸¦è¡Œæœ€å¤§åŒ–\næ‰€ä»¥ä½œè€…æåˆ°å¯ä»¥ç”¨ async iife ï¼Œä¹Ÿå°±æ˜¯ async function ç«‹å³åŸ·è¡Œå‡½å¼ï¼Œasync function ä¸è«–ä½•æ™‚éƒ½æœƒå›å‚³ Promiseï¼Œå³ä½¿å¤±æ•—ä¹Ÿæ˜¯å›å‚³ Promise.rejectï¼›\nä»¥ä¸‹æ˜¯æˆ‘åƒè€ƒä½œè€…ç¯„ä¾‹ç¨‹å¼ç¢¼æ”¹å¯«çš„ï¼Œä¸»è¦æ¯”å°åŸå…ˆçš„åšæ³•èˆ‡async iifeçš„å·®åˆ¥ï¼ŒæŒ‘æˆ°ä»»å‹™é–“ç›¸ä¾çš„ç‹€æ…‹å¦‚ä¸‹\nåŸæœ¬å°±æœ‰çš„å¯«æ³•æ˜¯æè¿°Taskæ©«å‘çš„ä¸¦è¡Œï¼Œæ‰€ä»¥æˆ‘å€‘æœƒç”¨ Promise.all([])å°‡ TaskB/TaskCä¸¦è¡Œè™•ç†ï¼Œä½†æ˜¯é€™ç¨®å¯«æ³•å¯è®€æ€§å·®ï¼Œè€Œä¸”æ¶æ§‹çš„æ–¹å‘ä¹Ÿæ˜¯ä¸å¥½çš„ï¼Œå› ç‚º Taskç›¸ä¾æ‡‰è©²æ˜¯å‚ç›´ ï¼Œåƒæ˜¯ TaskDæ˜æ˜å°±åªè¦ç­‰ TaskCå®Œæˆå°±å¯ä»¥é–‹å§‹åŸ·è¡Œï¼Œä½†å› ç‚ºå¯«æ³•æ‰€ä»¥è¦ç­‰åˆ° TaskBä¹ŸåŸ·è¡Œå®Œæˆå¾Œï¼ŒTaskDèˆ‡TaskEæ‰ä¸¦è¡Œè™•ç†ã€‚\næ‰€ä»¥ä½¿ç”¨ async iife æœ€å¤§å¥½è™•å³æ˜¯æ¯å€‹Taskçš„ç›¸ä¾æ€§éƒ½è¢«å°è£çš„å¾ˆç›´è§€ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ Promiseä¸€å®£å‘Šå°±åŸ·è¡Œçš„ç‰¹æ€§ï¼Œåƒæ˜¯\n1 let taskA = (async ()=\u0026gt; { await timePromise(1000); console.log(â€œTaskA doneâ€)})() æ­¤æ™‚taskAå·²ç¶“é–‹å§‹åŸ·è¡Œäº†ï¼Œä½†æ˜¯å¾ŒçºŒçš„codeå› ç‚º await taskAé‚„æ˜¯è¦ç­‰taskAçµæŸæ‰èƒ½ç¹¼çºŒï¼Œæ‰€ä»¥ä¸€æ¨£å¯ä»¥åšåˆ°æµç¨‹çš„æ§åˆ¶ï¼›\né€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ taskB/taskCé€™æ¨£å¯«å¯ä»¥ä¸¦è¡Œè™•ç†ï¼Œæ¥è‘—taskDå› ç‚ºåªç›¸ä¾taskCæ‰€ä»¥åœ¨ç¯„ä¾‹ä¸­æœƒæ¯”taskBæ›´æ—©çµæŸï¼Œéå¸¸æ¼‚äº®çš„å¯«æ³•ã€‚\nå¦å¤–åˆ†äº«ä¸€å€‹ç•¶åˆç–‘æƒ‘çš„é»ï¼štaskCåœ¨ taskD / taskEè¢«å‘¼å«å…©æ¬¡ï¼Œæœƒä¸æœƒå°±åŸ·è¡Œå…©æ¬¡?!Â ç­”æ¡ˆæ˜¯ä¸æœƒï¼Œå› ç‚ºtaskCæœ¬èº«æ˜¯Promiseï¼ŒåŸ·è¡Œå®Œä¸€æ¬¡å¾Œå°±æœƒè½‰æˆ Promise.fufilled(or rejected) ï¼Œå¦‚æœå¾ŒçºŒè¦ç”¨ await taskCå–å€¼å°±æœƒç«‹å³å›å‚³çµæœã€‚\nHigh OrderÂ Function é«˜éšå‡½å¼ï¼Œå®šç¾©æ˜¯å¯æ¥å—å‡½å¼ç•¶ä½œåƒæ•¸çš„å‡½å¼æœ¬èº«ï¼Œå¦‚éå¾€åœ¨æ•¸å­¸ä¸Šå­¸åˆ°çš„ f(g(x))ï¼Œåœ¨JSä¸­çµåˆclosure å°±å¯ä»¥æœ‰éå¸¸å¤šçš„æ‡‰ç”¨ã€‚\nSemaphore ä¿¡è™Ÿæ©Ÿï¼Œç”¨ä¾†æ§åˆ¶æœ‰é™çš„è³‡æºé‡ï¼Œä½œè€…åˆ©ç”¨ä¿¡è™Ÿæ©Ÿï¼Œè¨­è¨ˆé™åˆ¶æœ€å¤§ä¸¦è¡Œæ•¸çš„æ©Ÿåˆ¶\nnybblr/semaphorejs\nç¨‹å¼ç¢¼åªæœ‰40è¡Œå·¦å³ä½†è »ç²¾å¦™çš„ï¼Œä½¿ç”¨ä¸Š ï¼š\n1 2 3 4 s = Semaphore(3) s(async _ =\u0026gt; {console.log(â€œstartâ€); await timePromise(3000); console.log(â€œdoneâ€)}) s(async _ =\u0026gt; {console.log(â€œstartâ€); await timePromise(3000); console.log(â€œdoneâ€)}) ..... å°æ‡‰ç¨‹å¼ç¢¼ï¼ŒSemaphore(3) å°‡ taskä¸Šé™è¨­ç‚º 3ï¼Œæ¥è‘—å›å‚³ä¸€å€‹é«˜éšå‡½å¼ã€‚\nä»”ç´°çœ‹é€™å€‹é«˜éšå‡½å¼çš„ç¬¬ä¸€è¡Œawait acquire();\n1 2 3 4 5 6 7 8 9 10 11 12 let dispatch = () =\u0026gt; { if (counter \u0026gt; 0 \u0026amp;\u0026amp; tasks.length \u0026gt; 0) { counter--; tasks.shift()(); } }; let acquire = () =\u0026gt; new Promise(resolve =\u0026gt; { tasks.push(resolve); setImmediate(dispatch); }); æœ€æœ‰è¶£çš„åœ°æ–¹è«éæ–¼ä½œè€…ç”¨ acquire / dispatch é”åˆ°æ•¸é‡ä¸Šçš„æ§åˆ¶ï¼Œacquire å°‡ Promise.resolve() æ¨ä¸Šäº† taské™£åˆ—ï¼Œæ¥è‘—è§¸ç™¼ dispatchï¼Œè€Œdispatchåªæœ‰åœ¨æœªé”ä¸Šé™å‰å¯ä»¥åŸ·è¡Œ task.shift()çš„ functionï¼Œé€™è£¡ä¹Ÿå°±æ˜¯Promise.resolve()ï¼Œé€éé€™å€‹æ©Ÿåˆ¶å°±å¯ä»¥å»å¡ await acquire() ã€‚\nWeb Worker and MultiÂ Thread JSæœ¬èº«åŸ·è¡Œæ–¼ Main Threadä¸Šï¼Œå…¶é¤˜éåŒæ­¥APIæ˜¯ç”±åº•å±¤ç€è¦½å™¨çš„Web APIæˆ– Nodejs Libuvç­‰æ”¯æ´ï¼Œæœ€å¾Œé€é event loop å°‡ callback è¿”å› Main Thread åŸ·è¡Œï¼›\nä½†å¦‚æœéœ€è¦ç”¨JSåŸ·è¡Œè²»æ™‚çš„æ“ä½œè€Œæ²’æœ‰åº•å±¤å‡½å¼çš„æ”¯æ´(å¦‚è‡ªå·±ç·¨å¯« Addon)ï¼Œç¾åœ¨å¯ä»¥é€é Web Workeråˆ†é–‹ Threadï¼Œé¿å…é˜»æ“‹ Main Threadã€‚\nç¨‹å¼ç¢¼è«‹åƒè€ƒï¼šhttp://jsfiddle.net/sj82516/uqcFM/350/\n","date":"2018-06-27T04:03:50.027Z","permalink":"https://yuanchieh.page/posts/2018/2018-06-27-jonathan-martin-async-patterns-to-scale-your-multicore-javascript-elegantly-%E7%B8%BD%E7%B5%90%E8%88%87%E8%A9%A6%E9%A9%97/","title":"Jonathan Martin: Async patterns to scale your multicore JavaScript elegantly ç¸½çµèˆ‡è©¦é©—"},{"content":"2018/03/13ï¼ŒåƒåŠ äº†æ–°åº—åŒå¿ƒæ•‘é›£éšŠçš„é¾èˆŸè¨“ç·´åœ˜ï¼Œæ¯å¤©æ¸…æ™¨ 05:30 ~ 06:30 åœ¨ç¢§æ½­æ“ç·´ï¼Œå‡æ—¥ä¸åœä¸€è·¯ç·´åˆ° 2018/06/15 ç¸½è¨ˆ99å¤©çš„è¨“ç·´ï¼Œå€‹äººå‡ºå¸­äº† 90å¤©ã€‚\næ¥è‘—æ˜¯ 2018/06/16~2018/06/18ç‚ºæœŸä¸‰å¤©çš„æ¯”è³½ï¼Œæœ€çµ‚æ‹¿ä¸‹äº† å°åŒ—å¸‚å…¬é–‹å°å‹ç”·å­çµ„ç¬¬å…­åçš„æˆç¸¾ã€‚\näº‹éš”ä¸€é€±ï¼Œç¨å¾®èª¿æ•´ä¸€ä¸‹ä½œæ¯èˆ‡æ€ç·’ï¼Œè¨˜éŒ„ä¸€äº›é—œæ–¼åˆ’é¾èˆŸè¨“ç·´åˆ°æ¯”è³½çš„ä¸€äº›å¿ƒè·¯æ­·ç¨‹ã€‚\nphoto creditÂ : éšŠä¸Šçš„æ˜å¾·æ•™ç·´èˆ‡å—å»·å¤§å“¥ï¼Œæ„Ÿè¬ä»–å€‘ä¸æ™‚å¹«å¤§å®¶ç•™ä¸‹ç¾å¥½çš„å›æ†¶\nç‚ºæœŸç´„ä¸‰å€‹æœˆçš„è¨“ç·´ï¼Œå¤§è‡´å¯ä»¥æ‹†æˆä¸‰å€‹éšæ®µï¼š\nåŸºç¤é«”èƒ½æ“ç·´ / ä¸‹èˆ¹ç·´ç¿’ / è³½å‰æº–å‚™æœŸ\nåŸºç¤é«”èƒ½æ“ç·´ é¦–å…ˆè¦è²æ˜ä¸€ä»¶å¾ˆå¤šäººéƒ½æœƒå•çš„äº‹ï¼šã€Œåˆ’é¾èˆŸæ‰‹è‡‚æœƒä¸æœƒè®Šå¾ˆå£¯ï¼Ÿã€\néš¨æ‰‹ç•«ç•«ï¼Œä¸è¦å¤ªåœ¨æ„(PS. æ§³é¢æœƒèˆ‡èˆ¹ç·£å‚ç›´ï¼Œæ­¤ç‚ºç¤ºæ„)\nä½†å…¶å¯¦åˆ’é¾èˆŸä¸»è¦æ˜¯å…¨èº«æ€§çš„é‹å‹•ï¼Œä¸€èˆ¬é¾èˆŸåå®šä½å¾Œå‰æ–¹æœ‰å¡Šè…³è¸æ¿å¯ä»¥æ’è‘—(ä¸Šåœ–)\næ¥è‘—ç™¼åŠ›çš„éç¨‹æ˜¯èº«é«”ç›¡é‡å¾€å‰è¶´ï¼Œä¸‹æ‰‹(é èˆ¹çš„å¤–å´)æ‰“ç›´ï¼Œæ¥è‘—å¤§è…¿ç™¼åŠ›=\u0026gt;è½‰è…°ä¸¦å¾€å¾Œæ‹‰/ä¸Šæ‰‹ä¸‹å£“ï¼Œæ¥è‘—æ°´å°±æœƒè¢«å¾Œæ¨ï¼Œæ ¹æ“šåä½œç”¨åŠ›èˆ¹å°±æœƒå‰é€²ã€‚\nåˆ’é¾èˆŸé å¾—æ˜¯å…¨èº«åŠ›é‡å»å¸¶å‹•ï¼Œé‡é»æ˜¯æ§³å…¥æ°´å¾Œåˆ’è·è¦æ‹‰é•·ï¼Œä¹Ÿå°±æ˜¯èº«é«”è¦è¶´å¾—å¤ ä¸‹å» =\u0026gt; èº«é«”åå½ˆåŠ é€Ÿåº¦è¦èµ·ä¾†ï¼Œé€™æ¨£åˆ’èµ·ä¾†æ‰å¤ åŠ›ã€‚\næ‰€ä»¥åˆ’é¾èˆŸæ¯”è¼ƒåƒå¤§è…¿**ã€**èƒŒéƒ¨è‚Œç¾¤ã€æ ¸å¿ƒè‚Œç¾¤ã€è‚©è†€ã€æŸ”è»Ÿåº¦! ï¼Œå¦å¤–å°±æ˜¯å¿ƒè‚ºè€åŠ›é€™å¹¾å€‹éƒ¨åˆ†ï¼Œåè€ŒäºŒé ­è‚Œ/èƒ¸è‚Œå°±ä¸å¤ªæœƒç”¨ä¸Šã€‚\nç¬¬ä¸€å€‹æœˆè¨“ç·´ä¸»è¦æ˜¯åŸºç¤é«”èƒ½è¨“ç·´ï¼Œæš–èº«å®Œè·‘å€‹3kï¼Œæ¥è‘—å°±æ˜¯æ•™ç·´å¸¶æ ¸å¿ƒè¨“ç·´èˆ‡æ·±è¹²ï¼Œæ¥è‘—å°±æ˜¯åœ¨å²¸ä¸ŠåšåŸºæœ¬çš„å‹•ä½œç·´ç¿’ã€‚\næœ‰ç©ºæª”æœƒåˆ°èˆ¹ä¸Šç·´ç¿’ï¼Œä¸å¾—ä¸èªªä¸‹èˆ¹å¾Œæ„Ÿè¦ºå®Œå…¨ä¸åŒï¼Œä¸‹èˆ¹ç¬¬ä¸€ä»¶äº‹æ•™ç·´è¦æˆ‘å€‘æ„Ÿå—ã€Œèˆ¹çš„å¾‹å‹•ã€èˆ‡ã€Œèº«é«”çš„å¾‹å‹•ã€\nä¸æ‹¿æ§³ï¼Œå–®ç´”çš„æŠŠèº«é«”å¾€å‰è¶´ç„¶å¾Œå‡ºåŠ›è¹¬ -\u0026gt; æŠŠèº«é«”æ‹‰ç›´ï¼Œä¹Ÿå°±æ˜¯æ‹†è§£å‹•ä½œåªåšä¸‹åŠéƒ¨ï¼Œæ•™ç·´åœ¨ç¤ºç¯„çš„æ™‚å€™ï¼Œä¸€è¹¬æ•´è‰˜èˆ¹å°±å¾€å‰æ»‘å‹•äº†ä¸€æ®µã€‚\næ•™ç·´è¡¨ç¤ºå…ˆå­¸æœƒåŸºæœ¬åŠŸå¾ˆé‡è¦ï¼Œå› ç‚ºåˆ’èˆ¹ä¸€é–‹å§‹éŒ¯èª¤å§¿å‹¢éƒ½æ˜¯é æ‰‹è‡‚å°è‚Œè‚‰ç¾¤æ‹‰ï¼Œå¿˜äº†èº«é«”çš„ç¯€å¥èˆ‡å¾‹å‹•ï¼Œå³ä½¿æ˜¯å¥èº«å£¯æ¼¢ä¹Ÿä¸å¯èƒ½å–®ç”¨æ‰‹è‡‚è‚Œè‚‰åˆ’å®Œå…¨ç¨‹ï¼Œé‡é»æ˜¯ç”¨å¤§è…¿/èƒŒ/è…°é€™äº›å¤§è‚Œè‚‰ç¾¤å¸¶å‹•ï¼Œæ‰å¯ä»¥åˆ’å¾—é•·é ã€‚\né€™å¤§æ¦‚æ˜¯ç¬¬ä¸€éšæ®µè¨“ç·´ï¼Œä¸»è¦æ˜¯å¹«å¤§å®¶æš–èº«èª¿æ•´èº«é«”ç‹€æ³ï¼Œæˆ‘å€‹äººå¹³å¸¸æœ‰é‹å‹•å¥èº«çš„ç¿’æ…£ï¼Œæ˜¯æ²’æœ‰ç‰¹åˆ¥å¥å£¯ä½†é«”åŠ›é‚„ç®—è¡Œï¼Œå¯æ˜¯ä¹‹å‰é‹å‹•å®Œéƒ½æ²’æœ‰æ”¶æ“çš„ç¿’æ…£ï¼Œæ‰€ä»¥èº«é«”çš„æŸ”è»Ÿåº¦å¾ˆå·®ï¼Œåœ¨èˆ¹ä¸Šè¨“ç·´éç¨‹å°±æœƒä¸€ç›´è¢«æ•™ç·´å”¸ã€Œé‚£å€‹èª°æ€éº¼ä¸è¶´ä¸‹å»ä¸€é»ã€ å…§å¿ƒåªèƒ½OSæˆ‘çš„å¤§è…¿å…§å´éƒ½æ‹‰åˆ°å¿«æ’•è£‚äº†ï¼›\nåŒè¡Œçš„å¥³ç”Ÿåè€Œè¡¨ç¾éƒ½å¾ˆå¥½ï¼Œè¦ºå¾—è‡ªå·±è¡¨ç¾æœ‰é»æ‰æ¼†\nä¸éæ¯æ—¥ç·´ç¿’å®Œï¼Œæ•™ç·´éƒ½æœƒå¸¶æ”¶æ“ï¼Œä¹–ä¹–è·Ÿè‘—ç·´ç¿’æŒçºŒäº†å…©å€‹æœˆçµ‚æ–¼ è¶´ ä¸‹ å» äº†ã€‚\nä¸‹èˆ¹ç·´ç¿’ é€™å€‹éšæ®µæ¯æ—¥å°±ç›´æ¥ä¸‹èˆ¹ç·´ç¿’äº†ï¼Œå…ˆç¨å¾®ä»‹ç´¹ä¸€äº›é¾èˆŸçš„åŸºæœ¬çŸ¥è­˜ã€‚\né¾èˆŸåˆ†å¤§é¾/å°é¾ï¼Œå¤§é¾æ˜¯ 20äººåº§ï¼Œå°é¾å‰‡æ˜¯ 10äººåº§ï¼Œå¦å¤–å¤šä¸€å€‹èˆµæ‰‹ï¼Œæ¯”è³½æ™‚å°é¾é¾é ­æœƒå¤šä¸€ä½é¼“æ‰‹ï¼Œè€Œå¤§é¾å‰‡æ˜¯å†å¤šä¸€ä½å¥ªæ¨™æ‰‹ã€‚\nå€‹äººéƒ¨åˆ†ï¼Œèˆ¹åˆ†å·¦å³æ§³ï¼Œæˆ‘å€‹äººæ˜¯è¢«æ•™ç·´å®‰æ’æ–¼å·¦æ§³ï¼Œä¹Ÿå°±æ˜¯é¢å°é¾é ­æ–¹å‘çš„å·¦å´ï¼Œæœ‰äº›åˆ’äº†æ•¸å¹´ä»¥ä¸Šçš„è€æ‰‹å¯ä»¥å·¦å³æ§³éƒ½åˆ’ã€‚\næ¯”è³½è·é›¢æˆ‘å€‘æ˜¯åˆ’ 500å…¬å°ºï¼Œæ•´è¶Ÿä¸‹ä¾†ç´„éœ€è¦180æ§³å·¦å³ï¼Œæ™‚é–“å¤§æ¦‚åœ¨2~4åˆ†é˜ï¼Œæ™‚é–“ç¯„åœä¹‹æ‰€ä»¥æ‹‰é€™éº¼å¤§æ˜¯å› ç‚ºåˆ’èˆ¹æœƒå—åˆ°æ°´æµèˆ‡é¢¨å‘å½±éŸ¿ï¼Œé †æµè·Ÿé€†æµæ™‚é–“å¯ä»¥å·®åˆ°å…©å€ä¹‹å¤šã€‚\nå‰›å‰›èªªæ¯”è³½å®Œæ•´æ˜¯éœ€è¦åˆ’ 180æ§³ï¼Œä½†æˆ‘å€‘åœ¨ä¸€é–‹å§‹ç·´ç¿’åˆ’å€‹30æ§³å°±æ‰‹ç— è…°ç— ï¼Œä¸€é–‹å§‹æœ€é ä¹Ÿéƒ½åˆ’100å…¬å°ºè€Œå·²ï¼Œå¿ƒæƒ³ My God 500å…¬å°ºä¹Ÿå¤ªé™é äº†å§ã€‚\nç•¶æ™‚æ•™ç·´å°±æ˜¯å¾ˆæœ‰è€å¿ƒçš„æŒ‡å°ï¼Œä¸æ–·çš„ä¿®æ­£å§¿å‹¢ï¼Œèˆ¹ä¸Šè³‡æ·±çš„å¤§å“¥å¤§å§ä¹Ÿéƒ½å¾ˆç†±æƒ…çš„çµ¦äºˆæŒ‡é»ï¼Œä¸å¾—ä¸èªªåˆ’èˆ¹çš„å§¿å‹¢æ‹†è§£æ­¥é©Ÿå°±é ‚å¤šäº”å…­é …ï¼Œä½†æ˜¯è¦çœŸçš„ç†Ÿç·´éœ€è¦èŠ±éå¸¸å¤šçš„æ™‚é–“èˆ‡ç²¾åŠ›ï¼Œå°¤å…¶æ˜¯é¾èˆŸæ˜¯åœ˜é«”é‹å‹•ï¼Œéœ€è¦å¤§å®¶çš„å‹•ä½œ/ç¯€å¥ä¸€è‡´èˆ¹æ‰èƒ½é †é †çš„å‰è¡Œï¼Œé€Ÿåº¦æ‰æœƒå¿«ã€‚\né€™æ™‚å€™æ…¢æ…¢çš„æœ‰é–‹å§‹æ„Ÿå—åˆ°èˆ¹èˆ‡èº«é«”çš„å¾‹å‹•ï¼Œç¨å¾®åˆ†äº«å€‹æ•™ç·´å¸¸ç”¨çš„è©ã€Œæ’èˆ¹ã€ä¹Ÿå°±æ˜¯æ§³å¾€ä¸‹å£“ã€èº«é«”å¾Œæ‹‰é€™å€‹ç™¼åŠ›çš„å‹•ä½œï¼Œæ•™ç·´è¡¨ç¤ºé€™æ„Ÿè¦ºå¾ˆåƒæ˜¯æ’ç«¿è·³ï¼Œæ’åˆ°ä¸€å€‹é»èº«é«”å°±ç«‹åˆ»åšå‡ºåæ‡‰ã€‚\nå¾Œä¾†æœƒæ„Ÿè¦ºåˆ°æ’çš„åŠ›é‡åœ¨æ–¼èº«é«”æ–œå´è¶´åˆ°æ¥µè‡´ï¼Œå¤§è…¿èˆ‡èƒ¸è…”å¹¾ä¹é åœ¨ä¸€å¡Šï¼Œé‚£æ™‚å€™å› ç‚ºå·²ç¶“æ²’æœ‰æ›´å¤šä¼¸å±•çš„ç©ºé–“æ‰€ä»¥æœ‰å€‹å¼µåŠ›æ”¯æ’ï¼Œæ„Ÿè¦ºçœŸçš„æ˜¯æŠŠèº«é«”æ’èµ·ä¾†ã€‚\nè³½å‰æº–å‚™ åœ¨äº”æœˆå°±é–‹å§‹è¦å‚™è³½äº†ï¼Œç·´ç¿’é–‹å§‹æŒ‰ç…§æ¯”è³½åˆ†çµ„ç·´ç¿’ï¼Œæˆ‘å°±è¢«åˆ†é…åˆ°ç”·å­çµ„ä¸€åŒç·´ç¿’ï¼Œæ¯æ—¥è¨“ç·´çš„èœå–®åŠ é‡å¾ˆå¤š\n1. 800 å…¬å°ºæš–èº«\n2. 1200 å…¬å°ºè² é‡è¨“ç·´\n3. 500 å…¬å°ºæ¨¡æ“¬æ¯”è³½\n4. 5 30 æ§³æ³•ç·´ç¿’æ•¸çµ„\nåˆ†äº«ä¸€ä¸‹æˆ‘å€‘çš„æ§³æ³•\nèµ·æ­¥æ§³ï¼š\nå› ç‚ºèˆ¹ä¸€é–‹å§‹æ˜¯éœæ­¢çš„ï¼Œæ‰€ä»¥é¦–è¦ä¹‹é‡å°±æ˜¯æŠŠèˆ¹é€Ÿæ‹‰èµ·ä¾†ï¼Œæ­¤æ™‚çš„èµ·æ­¥æ§³å¿…é ˆç”¨å…¨èº«çš„åŠ›é‡å¸¶ï¼Œç”¨å…¨åŠ›æŠŠè…°è½‰å´ã€‚ åŠ åŠ›æ§³ï¼š\nä¸»è¦ä¹Ÿæ˜¯ç”¨å…¨èº«åŠ›é‡å¸¶ï¼ŒåŒ…å«æ‰‹è‡‚ä¹ŸæœƒåŠ åŠ›ï¼Œæ­¤æ™‚æ§³é€Ÿæœƒæ‹‰å¿«åˆ°ç´„1.4ç§’ä¸€æ§³ï¼Œä¸»è¦å°±æ˜¯ç”¨æ–¼è¡åˆºï¼ŒåŒå˜—è©¦èµ·æ­¥æ§³ä¹‹å¾Œèˆ‡æœ€å¾Œçµ‚é»å‰è¡åˆºã€‚ é•·æ§³\næ‰£é™¤èµ·æ­¥èˆ‡åŠ åŠ›ï¼Œå‰©é¤˜å°±æ˜¯é•·æ§³ï¼Œä¸»è¦é èº«é«”å¸¶å‹•æ­¤æ™‚æ‰‹è‡‚æœƒæ”¾é¬†ï¼Œå„²å‚™æ¥ä¸‹ä¾†è¡åˆºçš„åŠ›é‡ï¼Œå¤§ç´„æ˜¯7åˆ†åŠ›å·¦å³ï¼Œå› ç‚ºæ¯”è³½500å…¬å°ºä¸å¯èƒ½å…¨ç¨‹è¡åˆºï¼Œæ‰€ä»¥é•·æ§³æ§³é€Ÿæœƒæ”¾åˆ°ç´„ 2ç§’ä¸€æ§³ï¼Œä½†æ­¤æ™‚å°±è¦é èº«é«”å®Œå…¨çš„ä¼¸å±•è®“æ§³è·è®Šé•·ï¼Œç¶­æŒèˆ¹é€Ÿã€‚ æˆ‘å€‘åˆ’æ˜¯5å€‹èµ·æ­¥æ§³ =\u0026gt; 30å€‹åŠ åŠ›æ§³ =\u0026gt; é•·æ§³ 100æ§³ =\u0026gt; 50å€‹åŠ åŠ›æ§³ã€‚\næ¯”è³½å ´åœ°æˆ‘å€‘å ±äº†å…©çµ„ï¼Œåˆ†åˆ¥æ˜¯å°åŒ—å¸‚å¤§ä½³æ²³æ¿±å…¬åœ’èˆ‡æ–°åŒ—å¸‚å¾®é¢¨é‹æ²³ï¼Œå°åŒ—èˆ‡æ–°åŒ—çš„èˆ¹æ˜¯ä¸ä¸€æ¨£çš„ï¼Œå‰è€…æ˜¯æœ¨èˆ¹å¾ˆæ²‰ï¼Œå¾Œè€…æ˜¯å¡‘è† è£½å¾ˆè¼•ï¼Œä¹Ÿæ˜¯å¹³å¸¸ç·´ç¿’çš„èˆ¹ã€‚\næˆ‘å€‘çš„ä¸»è¦ç›®æ¨™æ“ºåœ¨å°åŒ—å¸‚ï¼Œæ‰€ä»¥å¹³å¸¸éƒ½æœƒè² é‡ç·´ç¿’ï¼Œåˆ’çš„é˜»åŠ›å¤§æ¦‚æ˜¯2~3å€ã€‚\nphoto creditï¼šå·¦é‚Šå°åŒ—å¸‚ï¼Œå³é‚Šæ–°åŒ—å¸‚\nä½†ä¸€é–‹å§‹ç·´ç¿’è¶…å´©æ½°ï¼Œå› ç‚ºå¼·åº¦æ‹‰å‡çš„å¾ˆå¤šï¼Œå¾å››æœˆä¸€é–‹å§‹åªèƒ½3/50æ§³åˆ’ï¼Œé€æ­¥çˆ¬å‡åˆ°æš–èº«å°±è¦æ»‘800å…¬å°ºç´„300æ§³ï¼Œå¼·åº¦æ”€å‡çš„å¾ˆå¯æ€•ï¼Œæœ‰æ™‚å€™ç·´ç¿’æ•™ç·´éƒ½æœƒèªªè·Ÿä¸ä¸Šå¯ä»¥æ”¶æ§³ä¼‘æ¯ï¼Œå…§å¿ƒé–‹å§‹æ™æ‰ï¼Œä½†æœ€å¾Œé‚„æ˜¯å’¬è‘—ç‰™åŠªåŠ›ç·Šè·Ÿï¼Œéš¨è‘—è‚Œè‚‰è·Ÿè‘—é©æ‡‰ï¼Œæ…¢æ…¢çš„ä¹Ÿé–‹å§‹è·Ÿä¸Šå¤§å¤¥çš„æ­¥èª¿ã€‚\nå …æŒï¼Œæ˜¯æˆ‘å”¯ä¸€èƒ½åšåˆ°çš„äº‹ XD\nä½†åªèƒ½èªªå‹‰å¼·è·Ÿä¸Šç¯€å¥ï¼Œä½†æ˜¯æ•´é«”åˆ’èˆ¹çš„åŠ›é‡é‚„æ˜¯è¼¸å‰è¼©å¾ˆå¤šï¼Œå¾å¾Œå´è§€å¯Ÿåˆ’èˆ¹æ¨æ°´çš„åŠ›é‡ï¼Œå‰è¼©å€‘éƒ½æ˜¯ è½Ÿï½è½Ÿï½è½Ÿéå¸¸å¤§åŠ›ï¼Œæˆ‘å‰‡æ˜¯ å‘¼ï½å‘¼ï½å‘¼è€Œå·²ï¼Œå§¿å‹¢ä¹Ÿé‚„æœ‰ç´°ç¯€éœ€è¦å¾®èª¿ï¼Œä½†ä¹Ÿä¾†ä¸åŠäº†\nåˆ†äº«ä¸€äº›è¶£äº‹ï¼Œé€™æ®µæœŸé–“å¯ä»¥æ˜é¡¯æ„Ÿå—è‚Œè‚‰åœ¨é•·å¤§ï¼Œæ‰€ä»¥é£Ÿé‡ä¹Ÿè®Šæˆå…©å€ï¼Œæ—©é¤åƒå…©ä»½ã€ä¸‹åˆé–‹å§‹åƒé»å¿ƒï¼Œä¼™é£Ÿè²»ç˜‹ç‹‚çš„æ”€å‡ï¼›\nå¦å¤–å› ç‚ºåˆ’èˆ¹å¤§è…¿è¹¬å±è‚¡æœƒç¨å¾®æŒªç§»ï¼Œå¾ˆå¤šäººéƒ½æœƒæº–å‚™è»Ÿå¢Šé¿å…ç£¨ç ´å±ï¼Œä¸€é–‹å§‹ä¸çŸ¥é“å°±æœ‰ç£¨ç ´ï¼Œçµæœå°±è«‹å‡ä¼‘é¤Šï¼Œä¹‹å¾Œå¶ç„¶ç™¼ç¾å››è§’è¤²å››åˆ†äº”è£‚ï¼Œçœ‹ä¾†æ˜¯å› ç‚ºå¤ªæ¿€çƒˆæ‰€ä»¥ç ´å¾—äº‚ä¸ƒå…«ç³ŸXDÂ è·åŒ…è¡¨ç¤ºå¿ƒç–¼ã€‚\næ¯”è³½!! ç¶“éä¸‰å€‹æœˆçš„å‚™æˆ°ï¼Œçµ‚æ–¼è¦åœ¨ç«¯åˆé€£å‡ä¸‰å¤©é€²è¡Œæ¯”è³½ï¼Œæ ¹æ“šæ•™ç·´ç©ç¬‘è©±èªªã€ŒéšŠä¸Šæ˜¯é è€äººèˆ‡å¥³äººåƒé£¯ã€å› ç‚ºé•·é’çµ„è·Ÿå¥³å­çµ„å¾€å¹´æ¯”è³½è¡¨ç¾äº®çœ¼ï¼Œç”·å­çµ„å°±ç¨å¾®å·®å¼·äººæ„ï¼Œä»Šå¹´æ±ºå®šå´›èµ·åŠªåŠ›å¥®æˆ°ã€‚\nä¸å¾—ä¸èªªç¬¬ä¸€æ¬¡ä¸Šå ´æ¯”è³½çœŸçš„è¶…ç·Šå¼µï¼Œä½†å¥½åœ¨å¹³å¸¸è¨“ç·´å¤ ï¼Œä¸€é³´æ§å°±ç…§è‘—ç·´ç¿’çš„æ­¥èª¿ä¸€æ§³ä¸€æ§³ä¾†ï¼Œä½†å› ç‚ºç·Šå¼µè®“å¿ƒè·³åŠ é€Ÿæ›´å¿«å‘¼å¸ä¹Ÿæ¯”è¼ƒçŸ­ä¿ƒï¼Œåˆ’åˆ°å¾Œä¾†æœ‰é»å–˜ä¸éæ°£ï¼Œä½†é‚„å¥½éƒ½æœ‰æ’éçµ‚é»æ‰æ–·æ°£OTZ\næ¯”è³½çš„è©±ä¸€é–‹å§‹æ˜¯æ¯çµ„å–å‰äºŒæ™‰ç´šï¼Œç”·å­çµ„é †åˆ©é€²åˆ°å‰å…«å¼·ï¼Œä½†æ˜¯åœ¨æ¶å‰å››æ™‚è¼¸äº†0.5ç§’ç„¡ç·£å‰å››ï¼Œæœ€çµ‚æ¶5~8æ‹¿ä¸‹ç¬¬å…­åçš„æˆç¸¾ï¼Œæœ‰ä¸€å€‹å°çç›ƒèˆ‡çç‹€ä¸€ç´™ï¼Œä½†æ˜¯æ²’æœ‰çé‡‘ï¼›\nè€Œå¥³å­çµ„åœ¨æ–°åŒ—å¸‚æ‹¿ä¸‹ç¬¬äºŒåä½³ç¸¾! æœ‰å¤§å¤§çš„çç›ƒèˆ‡12è¬çé‡‘å•Šï¼\nä»Šå¹´å»¶çºŒäº†éšŠä¸Šå„ªè‰¯å‚³çµ±XD\nåˆ†äº«ä¸€å€‹å°æ•…äº‹ï¼Œå› ç‚ºå¦ä¸€ä½è³‡æ·±çš„æ•™ç·´è‚©è†€æœ‰é»å—å‚·ï¼Œæ‰€ä»¥æˆ‘è·Ÿä»–æ˜¯è¼ªæµä¸Šå ´æ¯”ï¼Œåœ¨æ¶å‰å››é‚£å ´æ˜¯ç”±æˆ‘ä¸Šå ´æ¯”ï¼Œç†è«–ä¸Šåªè¦é€²äº†å‰å››éƒ½æœƒæœ‰çé‡‘ï¼Œä½†æ˜¯æœ€çµ‚ä»¥ 0.5ç§’å°è¼¸å°æ‰‹å°±è¦ºå¾—æŒºè‡ªè²¬ï¼Œä¸ç¦åœ¨æƒ³å¦‚æœæ˜¯æ•™ç·´ä¸Šå ´æ˜¯ä¸æ˜¯æˆ‘å€‘å°±æŒºé€²æ±ºè³½äº†?\nå¾Œä¾†æˆ‘ä¹Ÿä¸»å‹•è·Ÿæ•™ç·´è©¢å•é€™ä»¶äº‹ï¼Œä½†æ•™ç·´å®‰æ…°èªªç¸½æ˜¯è¦è¨“ç·´æ–°äººä¸Šå ´ï¼Œä¸ç„¶ç·´äº†ä¸‰å€‹æœˆéƒ½æ²’æœ‰ä¸Šå ´ä¹Ÿä¸è¡Œç­‰ç­‰ï¼Œå¾ˆæ„Ÿè¬æ•™ç·´çš„ä¿¡ä»»ä¸¦é¡˜æ„çµ¦æˆ‘æ©Ÿæœƒä¸Šå ´\nå¿ƒå¾— æˆ‘éå¾€æ²’æœ‰åƒåŠ éé«”è‚²åœ˜éšŠç·´ç¿’ï¼Œå¾ˆæ„Ÿè¬æ–°åº—åŒå¿ƒæ•‘é›£éšŠçš„æ•™ç·´èˆ‡éšŠå“¡å€‘éƒ½å¾ˆç†±æƒ…ï¼Œé›–ç„¶å¹´é½¡å±¤å°ºåº¦å¾ˆå¤§(19~6X)ï¼Œä½†æ˜¯å¤§å®¶å› ç‚ºå°é¾èˆŸæœ‰èˆˆè¶£ä¸€åŒé›†çµç·´ç¿’ï¼Œç‚ºäº†çˆ­å–æ¦®è€€ä¸€èµ·åŠªåŠ›ï¼Œæœ€çµ‚ä¹Ÿå–å¾—ä¸éŒ¯çš„æˆç¸¾ã€‚\næ•´å€‹è¨“ç·´éç¨‹æœ‰æ±—æ°´ä¹Ÿæœ‰æ­¡ç¬‘ï¼Œä¹Ÿæ„Ÿè¬æ•™ç·´ä¿¡ä»»æˆ‘ä¹Ÿé¡˜æ„æ´¾æˆ‘ä¸Šå ´ï¼Œå¿ƒä¸­ç•™ä¸‹çš„ä¸€é»éºæ†¾å°±çœ‹æ˜å¹´æœ‰æ²’æœ‰æ©Ÿæœƒä¾†åŠªåŠ›ã€‚\næ•´è¶Ÿä¸‰å€‹æœˆçš„é‡Œç¨‹å°±å‘Šä¸€æ®µè½ï¼ŒçµæŸæ¯æ—¥4:30å‰èµ·åºŠçš„æ—¥å­ï¼Œé‚„åœ¨åŠªåŠ›èª¿æ•´ä½œæ¯ä¸­XD\nPS. ä»¥ä¸Šè¨€è«–åƒ…ä»£è¡¨å€‹äººé«”æ‚Ÿï¼Œå¦å¤–é¾èˆŸåˆ’æ³•ä¹Ÿæ˜¯æˆ‘ç¸½çµæ•™ç·´çš„è¨“ç·´ï¼Œå…¶ä¸­å¯èƒ½æœ‰äº›ç´°ç¯€æ¼è¬›å¦‚æœ‰éŒ¯èª¤æ­¡è¿å‘ŠçŸ¥ã€‚\næœ€å¾Œå·¥å•†ä¸€ä¸‹éšŠä¸Šå…¶é¤˜æ´»å‹•ï¼Œé¾èˆŸå°±è¦æ˜å¹´ä¸‰æœˆè¦‹å›‰ï½\nä¸»è¦æœ‰æ¸¸æ³³ç­è·Ÿæ•‘ç”Ÿå“¡ç­å¯ä»¥åƒåŠ \næ–°åº—åŒå¿ƒæ•‘é›£éšŠ\n","date":"2018-06-23T10:11:14.727Z","permalink":"https://yuanchieh.page/posts/2018/2018-06-23-%E9%BE%8D%E8%88%9F%E6%AF%94%E8%B3%BD%E5%88%9D%E9%AB%94%E9%A9%97-%E4%B8%80%E4%BA%9B%E9%97%9C%E6%96%BC%E8%A8%93%E7%B7%B4%E6%AF%94%E8%B3%BD%E7%9A%84%E5%BF%83%E8%B7%AF%E6%AD%B7%E7%A8%8B/","title":"é¾èˆŸæ¯”è³½åˆé«”é©— â€” ä¸€äº›é—œæ–¼è¨“ç·´ã€æ¯”è³½çš„å¿ƒè·¯æ­·ç¨‹"},{"content":"æœ€è¿‘çªç„¶å¥½å¥‡å¦‚ä½•åšLBSæœå‹™ï¼Œæœ€åŸºæœ¬çš„æ‡‰ç”¨å ´æ™¯å°±æ˜¯æ‰¾å‡ºæŸç¶“ç·¯åº¦ä½ç½®å…§æ–¹åœ“è·é›¢å¤šå°‘å…§çš„æ‰€æœ‰è³‡æ–™ï¼Œæ‰€ä»¥å°±ä¾†ç ”ç©¶ä¸€ä¸‹MySQLå¦‚ä½•è™•ç†åœ°ç†ä½ç½®ã€‚\nSpatial Reference Systems(SRSs) ç©ºé–“åƒè€ƒç³»çµ± Spatial Reference Systems in MySQL 8.0\næ‰€æœ‰çš„å¹¾ä½•ç‰©ä»¶å¦‚é»/ç·š/é¢ï¼Œéƒ½å¿…é ˆå®šç¾©åœ¨åŒä¸€å€‹åº§æ¨™ç³»çµ±ï¼Œä¾‹å¦‚èªªåœ¨XYè»¸å¹³é¢ä¸Šæœ‰ä¸€é»(1,2)ï¼Œä½†æ˜¯åº§æ¨™ç³»çµ±å¯èƒ½æ˜¯ä¸€å€‹è¶³çƒå ´/æˆ–æ˜¯ä¸€å°ç­†é›»è¢å¹•ï¼Œè¶³çƒå ´ä¸Šçš„åº§æ¨™(1,2)è·Ÿè¢å¹•ä¸Šçš„åº§æ¨™(1,2)æ˜¯æˆªç„¶ä¸åŒä¸”ç„¡å¾æ¯”è¼ƒèµ·çš„ã€‚\næ‰€ä»¥åœ¨å®šç¾©å¹¾ä½•ç‰©ä»¶æ™‚ï¼Œå¿…é ˆè¦åŒæ™‚å®£å‘Šè©²ç‰©ä»¶æ‰€å±¬çš„åº§æ¨™ç³»çµ±ï¼Œä¹Ÿå°±æ˜¯ SRID(spatial reference system identifier)ï¼ŒMySQLå’Œå…¶ä»–çš„DBMSéƒ½å¿…é ˆåœ¨ç›¸åŒçš„SRIDä¸‹æ‰èƒ½å¤ é€²è¡Œå¹¾ä½•é‹ç®—ã€‚\nåœ¨MySQL 8.0ä¸­æ”¯æ´è¶…é5000ç¨®SRSsï¼Œå¸¸è¦‹çš„æœ‰å…©ç¨®ï¼š\nSRID 3857ï¼š\nå°‡åœ°çƒè¡¨é¢æŠ•å½±è‡³å¹³é¢ä¸Šï¼Œå±¬æ–¼ç¬›å¡çˆ¾åº§æ¨™ç³»( Cartesian 2D CS)ï¼Œä¹Ÿå°±æ˜¯XYè»¸ç›¸äº’å‚ç›´ä¸”å–®ä½é•·åº¦ä¸€è‡´ã€‚\nå¸¸ç”¨æ–¼ç¶²é ä¸Šçš„åœ°åœ–ç³»çµ±ï¼Œå¦‚Google Map / Open Street Mapç­‰ SRID 4326ï¼š\nå±¬æ–¼çœŸå¯¦ç©ºé–“åº§æ¨™ç³»çµ±ï¼Œå°‡åœ°çƒè¦–ç‚ºæ©¢åœ“é«”ï¼Œä¹Ÿå°±æ˜¯è½‰æ›æˆç¶“ç·¯åº¦ï¼Œåº§æ¨™è»¸å½¼æ­¤ä¸æ˜¯å‚ç›´çš„ï¼Œç¶“åº¦æœ€å¾Œéƒ½åœ¨å—åŒ—æ¥µå½™æ•´ã€‚\nå¸¸ç”¨æ–¼GPS èªæ³•ä½¿ç”¨ DB Fiddle - SQL Database Playground\nå‰µå»ºæ¬„ä½ä¸Šï¼Œå¯ä»¥å®šç¾© GEOMETRYå‹åˆ¥ï¼Œæ¬„ä½å¯ä»¥æŒ‡å®š SRIDï¼Œéœ€è¦ç´¢å¼•å¯åŠ ä¸Š SPATIAL INDEX(g)ï¼ŒInnoDB/MyISAMéƒ½æ”¯æ´ã€‚\nåœ¨æ’å…¥æ¬„ä½æœ‰å…©ç¨®åšæ³•ï¼Œä¸€ç¨®æ˜¯ç›´æ¥ä½¿ç”¨å¹¾ä½•å½¢åˆ¥ï¼Œä¸€ç¨®æ˜¯é€é ST_GeomFromText å¾å­—ä¸²è½‰æ›ï¼Œç›®å‰åªæœ‰çœ‹åˆ°å¾Œè€…å¯ä»¥æŒ‡å®š SRID\nInsert into geom VALUES(Point(1,1), â€œwordâ€);Â Insert into geom2 VALUES(ST_GeomFromText(â€˜POINT(1 1)â€™, 4326), â€œhelloâ€); Insert into geom2 VALUES(ST_GeomFromText(â€˜POLYGON((0 0, 0 2, 2 2, 2 0, 0 0))â€™, 4326), â€œzipâ€); MySQLæ”¯æ´å¤šç¨®å¹¾ä½•å½¢åˆ¥ï¼Œä¾‹å¦‚Point / Line / Polygonç­‰ã€‚\né‹ç®—ä¸ŠMySQL 8.0æ”¯æ´å¤šç¨®å‡½å¼ï¼Œå‡½å¼çš†å·² ST_é–‹é ­ï¼Œä¾‹å¦‚\nç®—å…©é»è·é›¢\nSELECT ST_Distance((SELECT g from geom2 where name=â€™helloâ€™), ST_GeomFromText(â€˜POINT(0 0)â€™, 4326)) AS distance;\nåˆ¤æ–·æ˜¯å¦åœ¨æŸç¯„åœå…§ (helloæ˜¯ point å‹åˆ¥ï¼Œzip æ˜¯ polygonå‹åˆ¥ï¼Œåˆ¤æ–·)\nSELECT ST_Within((SELECT g from geom2 where name=â€™helloâ€™), (SELECT g from geom2 where name=â€™zipâ€™))\nè£œï¼šç¶“ç·¯åº¦è·é›¢æ›ç®— åœ¨SRID 4326ä¸­ï¼Œåœ°çƒæ˜¯åæ©¢åœ“ç‹€ï¼Œäººå€‘ç‚ºäº†æ–¹ä¾¿é€éç¶“ç·¯åº¦ç”¨ç¶²æ ¼åšåŠƒåˆ†ï¼Œåˆ†è¾¨åœ°ç†ä½ç½®çš„åˆ¤åˆ¥ï¼Œæ‰€ä»¥è¦å°‡ç¶“ç·¯åº¦æ›ç®—å›å¯¦éš›çš„è·é›¢éœ€è¦æœ‰å…¬å¼çš„è½‰æ›ã€‚\nLearn How Far It Is From One Latitude Line to the Next\nç¶“åº¦æ›ç®— ç¶“åº¦å·®æœƒéš¨è‘—å¾€å—åŒ—æ¥µè€Œéæ¸›è‡³é›¶ï¼Œåœ¨èµ¤é“å¤§ç´„æ˜¯ 111.321kmï¼Œè€Œå—åŒ—ç·¯ 40åº¦å‰‡ç‚º 85 kmã€‚\nç·¯åº¦æ›ç®— ç·¯åº¦é–“åŸºæœ¬ä¸Šæ˜¯å¹³è¡Œï¼Œæ‰€ä»¥æ¯å–®ä½ç·¯åº¦å·®ä¹‹é–“éƒ½æ˜¯ç›¸è¿‘çš„ï¼Œåªæ˜¯å› ç‚ºåœ°çƒåæ©¢åœ“æ‰€ä»¥é«˜ç·¯åº¦è·é›¢è¶Šé•·ã€‚\nåƒæ˜¯åœ¨èµ¤é“æ¯ä¸€åº¦ç·¯åº¦å·®å¯¦éš›è·é›¢æ˜¯ 110.567 kmï¼Œåœ¨å›æ­¸ç·šé™„è¿‘å‰‡æ˜¯ 110.948kmï¼Œå¦‚æœæ˜¯åœ¨å—åŒ—æ¥µå‰‡æ˜¯ 111.169 kmï¼Œå¹³å‡å¤§ç´„å¯ä»¥å– 111 kmã€‚\næ‰€ä»¥å¦‚æœè¦ç”¨ç¶“ç·¯åº¦å·®æ›ç®—å¯¦éš›è·é›¢ï¼Œå¯ä»¥ç”¨ haversine å…¬å¼ï¼Œè©³ç´°å…§å®¹å¯ä»¥åƒè€ƒ Wiki\nç›®å‰ä¹Ÿå­˜åœ¨å¤šç¨®æ›ç®—å…¬å¼ï¼Œä¸åŒçš„é‹ç®—è¤‡é›œåº¦å¸¶ä¾†ä¸åŒçš„é‹ç®—æº–ç¢ºåº¦ï¼Œå¯ä»¥å†å¤šåŠ ç ”ç©¶ã€‚\nHaversine formula - Wikipedia\nåœ¨MySQL 5.7ä¸­æ”¯æ´åº¦ä¸Šæ²’æœ‰é€™éº¼å¥½ï¼Œæ‰€ä»¥çƒå‹è·é›¢è½‰æ›å…¬å¼éœ€è¦è‡ªè¡Œæ›ç®—ï¼Œè©³ç´°å¯ä»¥åƒè€ƒæ­¤ç¯‡ https://mysqlserverteam.com/mysql-5-7-and-gis-an-example/\n","date":"2018-06-21T22:15:22.655Z","permalink":"https://yuanchieh.page/posts/2018/2018-06-21-mysql-%E9%97%9C%E6%96%BC%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E7%9A%84%E5%84%B2%E5%AD%98%E8%88%87%E9%81%8B%E7%AE%97/","title":"MySQL é—œæ–¼åœ°ç†ä½ç½®çš„å„²å­˜èˆ‡é‹ç®—"},{"content":"æœ€è¿‘æœ‰å€‹éœ€æ±‚æ˜¯å¸Œæœ›å¯ä»¥å°‡å„ç¶²ç«™çš„é€€æ¬¾ç´€éŒ„åŒæ­¥åˆ°Google Sheetä¸Šï¼Œæ–¹ä¾¿PMèˆ‡è²¡å‹™éƒ¨é–€è¿½è¹¤ï¼Œç›¸æ¯”æ–¼è‡ªå»ºç¶²ç«™ï¼ŒGoogle Sheet æœ‰æ–¹ä¾¿çš„åŒæ­¥ç·¨è¼¯ / åŒ¯å‡ºåŒ¯å…¥ / ç™»å…¥æ¬Šé™ç®¡ç†ç­‰ï¼Œå°±ä¸å¿…è‡ªå·±é‡é€ è¼ªå­ï¼Œè€Œä¸”ä¹Ÿä¸è¦‹å¾—é€ å¾—å‡ºä¾†(æ±—\næ•´ç¯‡åˆ†æˆå…©éƒ¨åˆ†ï¼Œç¬¬ä¸€æ˜¯ç ”ç©¶Google OAuth2 APIæˆæ¬Šéƒ¨åˆ†ï¼Œç¬¬äºŒæ˜¯Google Sheet APIã€‚\nGoogle OAuth2Â APIæˆæ¬Š Google APIæˆæ¬Šæœ‰å…©ç¨®æ–¹å¼\nOAuth 2.0ï¼š\nå¦‚æœæ˜¯æ¶‰åŠç”¨æˆ¶éš±ç§è³‡æ–™ï¼Œå°±å¿…é ˆèµ°OAuth 2.0æˆæ¬Šæ–¹å¼å–å¾—ç”¨æˆ¶æˆæ¬Šï¼›\nä¾‹å¦‚èªª Drive / Sheet / Doc / Google+Â â€¦ ç­‰ç­‰ã€‚ API keysï¼š\nå¦‚æœæ˜¯å–®ç´”ä½¿ç”¨Googleæä¾›çš„å°å¤–æœå‹™ï¼Œä¾‹å¦‚ Map / URL Shortener / Geocoding ç­‰ã€‚\nAPI Keysä½¿ç”¨è »ç°¡å–®çš„ï¼Œä¹Ÿä¸æ˜¯é€™æ¬¡ä½¿ç”¨é‡é»ï¼Œå°±ä¸å¦å¤–è´…è¿°ã€‚ é€™æ¬¡è¦ä½¿ç”¨ Sheet API å°±éœ€èµ° OAuth 2.0æˆæ¬Šï¼ŒGoogle æ”¯æ´å¤šç¨®OAuth 2.0 æˆæ¬Šæ–¹å¼ï¼š\nServer-Side WebÂ App APPä¸»å‹•è§¸ç™¼ï¼Œè®“ç”¨æˆ¶ç™»å…¥Googleå¸³è™Ÿä¸¦æˆæ¬Šï¼Œæ¥è‘—é€é redirect æˆ–å…¶ä»–æ–¹å¼å–å¾—codeï¼Œæœ€å¾Œç”¨codeå»æ›tokenã€‚\né€™ä¹Ÿæ˜¯å°çµ‚ç«¯ç”¨æˆ¶æœ€ç‚ºå¸¸è¦‹çš„æˆæ¬Šæ–¹å¼ã€‚\nFrom Google\nApplications on limited-input devices é©ç”¨æ–¼åœ¨æ²’æœ‰è¢å¹•æˆ–æ˜¯è¼¸å…¥çš„è£ç½®ï¼Œä¾‹å¦‚åˆ—å°æ©Ÿã€TVç­‰åµŒå…¥å¼è£ç½®\nFrom Google\né€™è£¡åŒæ¨£æ˜¯ Appä¸»å‹•è§¸ç™¼ï¼Œä½†è®Šæˆå›å‚³ä¸€å€‹URLé€£çµï¼Œç”¨æˆ¶å¿…é ˆå¦å¤–æ‰¾æ”¯æ´ç€è¦½å™¨è£ç½®è¼¸å…¥URLä¸¦æˆæ¬Šï¼›\né€™è£¡å› ç‚º App(ex. TV)è·Ÿç”¨æˆ¶æˆæ¬Šçš„è£ç½®(ex. æ‰‹æ©Ÿ)ä¸åŒï¼Œå…©è€…è¾¨è­˜ç”¨æˆ¶æ–¹å¼é€é device code(â€œcodeâ€ \u0026amp; URL -\u0026gt; User)ï¼ŒAppé€épollingä¸æ–·é–“éš”è«‹æ±‚Googleæ‰èƒ½çŸ¥é“è©² device code çš„ç”¨æˆ¶æ˜¯å¦å·²ç¶“æˆæ¬Šï¼Œå¾ŒçºŒæµç¨‹å°±ç›¸åŒã€‚\nä½†é ˆæ³¨æ„æ­¤æµç¨‹æˆæ¬Šçš„æ¬Šé™ä¸å¤šï¼Œéœ€è¦å…ˆè©•ä¼°ï¼Œå› ç‚ºæˆ‘å°ˆæ¡ˆéœ€è¦ Sheet APIæˆæ¬Šï¼Œé€™å€‹æˆæ¬Šæµç¨‹å°±ä¸æ”¯æ´ï¼Œæ‰€ä»¥ç„¡æ³•æ¡ç”¨ã€‚\nServer-to-Server From Google\nåœ¨Google APIs Consoleä¸­çš„æ†‘è­‰æ¬„ä½ï¼Œé™¤äº†APIé‡‘é‘° / OAuth 2.0 ç”¨æˆ¶ç«¯ ID ï¼Œç¬¬ä¸‰å€‹èƒ½å¤ å‰µå»ºçš„å°±æ˜¯ æœå‹™å¸³æˆ¶é‡‘é‘°ï¼Œæœå‹™å¸³è™Ÿåƒæ˜¯å‰µå»ºä¸€å€‹æ–°çš„ç”¨æˆ¶ï¼Œåªæ˜¯æ­¤ç”¨æˆ¶æ˜¯è¢«ç”¨æ–¼ Server ç«¯æˆæ¬Šï¼Œä¸¦é€é IAM ç®¡ç†æ¬Šé™ã€‚\né€éæœå‹™å¸³è™Ÿæœ€å¤§å¥½è™•æ˜¯æ‡‰ç”¨ç¨‹å¼æ˜¯æˆæ¬Šæ–¼æœå‹™å¸³è™Ÿï¼Œè€Œéå€‹é«”ç”¨æˆ¶ï¼Œåƒæ˜¯é‡åˆ°äººå“¡æµå‹•å°±ä¸éœ€è¦æ‰‹å‹•åœ¨ç®¡ç†æˆæ¬Šï¼›\nè€Œä¸”ä¹Ÿä¸éœ€è¦åœ¨ Clientåˆè¦è·³å‡ºç”¨æˆ¶æˆæ¬Šé é¢ï¼Œéå¸¸é©åˆç”¨æ–¼å°å…§çš„å°ˆæ¡ˆé–‹ç™¼(æ­¤æµç¨‹åˆç¨±ç‚º two-legged OAuth)ã€‚\nä¹Ÿæ˜¯æˆ‘å€‘é€™æ¬¡æœƒå˜—è©¦çš„æµç¨‹ä¹‹ä¸€ã€‚\nLong LiveÂ Token æˆæ¬Šå¾ŒGoogleæœƒå›å‚³tokenï¼Œä½†tokenéƒ½æ˜¯çŸ­æœŸçš„åªæœ‰ä¸€å°æ™‚çš„å£½å‘½ï¼ŒGoogleä¸¦ä¸åƒFBï¼Œä¸æœƒæ ¸ç™¼é•·æœŸç„¡é™æœŸçš„Token ï¼Œåä¹‹Googleæ˜¯ä¸æ–·çš„é€é refresh tokenæ©Ÿåˆ¶ï¼Œä¸æ–·çš„æ ¸ç™¼çŸ­æœŸTokenï¼Œè€Œrefreshæ¬¡æ•¸æ˜¯æ²’æœ‰é™åˆ¶ï¼Œä¹Ÿä¸éœ€è¦ç”¨æˆ¶å†æ¬¡æˆæ¬Šï¼Œæ‰€ä»¥å¯ä»¥é•·æœŸå„²å­˜èµ·ä¾†ä½¿ç”¨ã€‚\nä½†å¿…é ˆæ³¨æ„ï¼Œå¦‚æœç™¼ç”Ÿä»¥ä¸‹å¹¾é» refresh tokenæ©Ÿåˆ¶æœƒå¤±æ•ˆ\n1. ç”¨æˆ¶å–æ¶ˆå°æ‡‰ç”¨ç¨‹å¼çš„æˆæ¬Š\n2. refresh tokenè¶…é6å€‹æœˆæ²’æœ‰ä½¿ç”¨\n3. ç”¨æˆ¶æ›´æ”¹å¸³è™Ÿå¯†ç¢¼ä¸”refresh tokenå«Gmailçš„æ¬Šé™\n4. ç”¨æˆ¶æ“æœ‰å¤ªå¤šrefresh tokenï¼Œç›®å‰æ˜¯æ¯å€‹æ‡‰ç”¨ç¨‹å¼æ¯ç”¨æˆ¶ä¸Šé™50å€‹refresh tokenã€‚\n5. ç”¨æˆ¶æœ¬èº«ä¹Ÿå­˜åœ¨è‘—refresh tokenç¸½æ•¸ä¸Šé™ï¼Œä½†æ–‡ä»¶åªå¯«åˆ°æ­£å¸¸ç‹€æ³ä¸æœƒç™¼ç”Ÿï¼Œæ²’æœ‰æ˜è¬›å¤šå°‘ã€‚\nå¯¦ä½œ é€™ä¸€æ­¥ä¸»è¦æ˜¯å…ˆå–å¾— access tokenèˆ‡ refresh tokenã€‚\nNode.js Quickstart | Sheets API | Google Developers\nGoogle Sheet APIæœ‰å€‹ Node.js å¿«é€Ÿä¸Šæ‰‹èªªæ˜ï¼Œä¸¦ç”¨ google-api-nodejs-clientï¼Œé‹è¡Œå¾Œæœƒåœ¨çµ‚ç«¯æ©Ÿå‡ºç¾æˆæ¬ŠURLï¼Œé»æ“Šå¾Œå°±å¯ä»¥å–å¾—tokenã€‚\nä½†æˆ‘å€‹äººä¸æ„›google-api-nodejs-client çš„å¯«æ³•ï¼Œå› ç‚ºæ˜¯æ¡ç”¨å±¤å±¤ Callbackçš„æ–¹å¼ï¼Œé‚„ä¸å¦‚è‡ªå·±æ¥REST APIä¾†å¾—æ¸…çˆ½ã€‚\nscopeéƒ¨åˆ†éœ€è¦å–å¾— [https://www.googleapis.com/auth/drive](https://www.googleapis.com/auth/drive) [https://www.googleapis.com/auth/spreadsheets](https://www.googleapis.com/auth/spreadsheets)\nOAuth 2.0 for Web Server Applications å–å¾—æˆæ¬Šæ–¹å¼ é€™å€‹åšæ³•æœƒé€éç€è¦½å™¨å–å¾—ç”¨æˆ¶æˆæ¬Šï¼Œä¸¦å„²å­˜ refresh_tokenï¼Œæ–¹ä¾¿å¾ŒçºŒServerå‘¼å«APIä½¿ç”¨ã€‚\néœ€æ³¨æ„Google OAuth2ç™»å…¥æ–‡ä»¶ä¸¦æ²’æœ‰æ˜è¬›å¦‚ä½•å–å¾—refresh_tokenï¼Œæ‰€ä»¥æŸ¥äº†ä¸€ä¸‹ä½œæ³•\nNot receiving Google OAuth refresh token\næ–‡ç« ä¸­çš„è§£ç­”èªªè¦ approval_prompt=force\u0026amp;access_type=offline æˆ‘å˜—è©¦æ˜¯ä¸è¡Œçš„ï¼Œå¾Œä¾†é©—è­‰çµæœæ˜¯å¿…é ˆåœ¨ redirect URLä¸­åŒæ™‚åŠ å…¥prompt=consent\u0026amp;access_type=offline\né€™éƒ¨åˆ†æ¯”è¼ƒç°¡å–®å¸¸è¦‹ï¼Œå°±ä¸è´…è¿°ã€‚\nServer-to-Server å–å¾—æˆæ¬Š é€™éƒ¨åˆ†Googleæ–‡ä»¶å¼·çƒˆå»ºè­°ä½¿ç”¨sdkè€Œé REST APIï¼Œä¸»è¦æ˜¯å› ç‚ºServer-to-Serveræ˜¯é€éåŠ å¯†JSON Web Tokens (JWTs)å¯¦ä½œï¼Œå¦‚æœå‡ºéŒ¯å®¹æ˜“æœ‰è³‡å®‰é¢¨éšªï¼Œä½†ç¯„ä¾‹é‚„æ˜¯æ¡ç”¨æ¥ REST API\né¦–å…ˆå…ˆåˆ° Google APIs Console åŠ å…¥æ†‘è­‰ï¼Œé€™æ¬¡è¦åŠ å…¥çš„æ˜¯æœå‹™å¸³è™Ÿé‡‘é‘°ï¼Œè¨˜å¾—è¦ä¸‹è¼‰ jsonæª”çš„é‡‘é‘°æª”æ¡ˆ 2. æ¥è‘—åˆ° IAMç®¡ç†æ¬Šé™ï¼Œæ‰¾åˆ°å‰›æ‰çš„æœå‹™å¸³è™Ÿ Emailï¼Œé¡ä¼¼æ–¼Â â€¦.@â€¦.iam.gserviceaccount.comï¼Œä¸¦åŠ å…¥ã€ŒService Management ç®¡ç†å“¡ã€æ¬Šé™ï¼Œæ‰èƒ½æ“ä½œAPIã€‚\n3. è¨˜å¾—æ¯”å‰›æ‰çš„æœå‹™å¸³è™ŸåŠ å…¥è¡¨å–®çš„å…±åŒç·¨è¼¯è€…ã€‚\nå·¦åœ–ç‚ºIAMç®¡ç† / å³åœ–ç‚ºè¡¨å–®å…±ç”¨è¨­å®š\néœ€æ³¨æ„ Server-to-Serverä¸æœƒæœ‰ refresh_tokenï¼ŒtokenéæœŸå°±å¿…é ˆé‡æ–°ç”¢ç”ŸJWTä¸¦å–å¾—æ–°çš„tokenã€‚\næ–‡ä»¶ä¸­æœ‰æåˆ°ï¼Œéƒ¨åˆ†APIå¯ä»¥ç”¨JWTè€Œä¸ç”¨access tokenå°±å¯ä»¥å‘¼å«ï¼Œä½†åŒæ¨£åªæœ‰éƒ¨åˆ†æ”¯æ´ï¼Œæ‰€ä»¥é¿å…è¸©å‘é‚„æ˜¯çµ±ä¸€ç”¨ access tokenã€‚\nSheet APIÂ ä½¿ç”¨ Introduction to the Google Sheets API | Sheets API | Google Developers\nGoogle Sheet APIæœ‰å…©å€‹éƒ¨åˆ†ï¼š\n1. å–®ç´”è®€è·Ÿå¯«æ˜¯åœ¨ spreadsheets.valuesåº•ä¸‹\n2. å…¶é¤˜è¡¨å–®çš„å±¬æ€§(åˆä½µæ¬„ä½ã€æ›´æ”¹æ¬„ä½é¡è‰²ç­‰)ç­‰åœ¨ spreadsheetsåº•ä¸‹\né€™æ¬¡åªæœ‰å–®ç´”çš„è®€å¯«ï¼Œæ‰€ä»¥å°±åªç ”ç©¶ä¸Šè€…ã€‚\næ“ä½œè¡¨å–®APIï¼Œé¦–å…ˆéœ€è¦å…ˆå‰µå»ºä¸€å€‹ Googleè¡¨å–®ï¼Œé€£çµå¤§æ¦‚æœƒæ˜¯\nhttps://docs.google.com/spreadsheets/d/1dMJâ€¦../edit#gid=0\n1dMJâ€¦. ä»£è¡¨æ˜¯è¡¨å–®çš„IDï¼Œè€Œ gid={id}å‰‡æ˜¯å…§é çš„IDï¼Œåœ¨APIç”¨å…§é åç¨±ç›´æ¥æè¿°å¦‚ sheet1(ä¹Ÿæ”¯æ´ä¸­æ–‡å¦‚ è¡¨å–®ä¸€)ï¼›\næ•´é«”ä¸ŠAPIæ“ä½œå¯ä»¥ è®€/å¯«/å¯«å…¥æ–‡ä»¶æœ€å¾Œ(Append)/æ¸…é™¤ï¼Œæ¯ç­†APIéƒ½å¯ä»¥æŒ‡å®šç¯„åœå¦‚ A1:A5 ï¼Œå°±è·Ÿä¸€èˆ¬è¡¨å–®æ“ä½œé¡ä¼¼ã€‚\nç¨‹å¼ç¢¼è«‹åƒè€ƒ\nsj82516/google-sheet-api-test\nåœ¨æ’å…¥æ¬„ä½çš„éƒ¨åˆ†(APIå¦‚ append / update)ï¼Œæœ‰å€‹åƒæ•¸å¯ä»¥æŒ‡å®šGoogle Sheetå¦‚ä½•è™•ç†è¼¸å…¥çš„æ¬„ä½(valueInputOption)ï¼Œå¯ä»¥æŒ‡å®šç‚ºï¼š\n1. RAWï¼Œä¸è™•ç†å®Œå…¨ä¾ç…§è¼¸å…¥\n2. USER_ENTEREDï¼ŒæŒ‰ç…§ä¸€èˆ¬ Google Sheetè¼¸å…¥è™•ç†ï¼Œå¦‚ =MAX(A1:A2) å°±æœƒè‡ªå‹•è½‰æˆå…¬å¼ï¼Œå­—ä¸²å¦‚æœç¬¦åˆæ ¼å¼æœƒè¢«è½‰è£½æˆæ•¸å­—ç­‰ã€‚\n3. INPUT_VALUE_OPTION_UNSPECIFIEDï¼Œæœ‰è¶£çš„æ˜¯é€™å€‹é è¨­å€¼ä¸èƒ½ç”¨ï¼ŒAPIæœƒå ±éŒ¯ã€‚\nå¦ä¸€å€‹åƒæ•¸æ˜¯è™•ç† Concurrency å•é¡Œï¼ŒInsertDataOptionå¯ä»¥æŒ‡å®šç•¶é‡åˆ°æ’å…¥æ–°æ¬„æ™‚é‡ä¸Šæ‰‹å‹•æ›´æ–°æ™‚ï¼Œé¸æ“‡è¦†è“‹ OVERWRITE æˆ–æ˜¯æ’å…¥åœ¨æ–°æ¬„ä½ INSERT_ROWSã€‚\né€™æ¬¡åªæœ‰ç°¡å–®ç”¨åˆ° read / append é€™å…©å€‹APIï¼Œreadå¯ä»¥æŒ‡å®šç¯„åœï¼Œappendè »æœ‰è¶£çš„å¦‚æœæœ‰æ‰‹å‹•æ’å…¥æ–°æ¬„ï¼Œæˆ–æ˜¯æ‰‹å‹•Deleteæ•´å€‹è¡¨å–®ï¼Œä¸‹æ¬¡ appendæœƒè‡ªå‹•æ­£ç¢ºçš„ä½ç½®é–‹å§‹ï¼Œé€™é»å€’ä¸éœ€è¦æ“”å¿ƒã€‚\nå…¶é¤˜çš„å¯«å…¥/æ›´æ–°/åˆªé™¤éƒ½æ²’ç”¨ä¸Šï¼Œä¸éåœ¨æ–‡ä»¶ä¸­çš„åƒè€ƒç¶²é æœ‰æä¾›æ¸¬è©¦å¾ˆæ–¹ä¾¿ã€‚\nè£œæ›´ï¼šæ’å…¥æ–°è¡Œæ–¼è¡¨å–®æœ€ä¸Šå±¤ é€éappendæ˜¯å°‡æ–°è¡Œæ’åœ¨è¡¨å–®æœ€ä¸‹å±¤ï¼Œä½†å¾ˆå¤šæ™‚å€™æˆ‘å€‘å¸Œæœ›å¾Œé¢çš„è³‡æ–™å‡ºç¾åœ¨æœ€ä¸Šå±¤ï¼ŒæŸ¥äº†ä¸€ä¸‹SOï¼Œæœ‰å€‹è§£æ³•æ˜¯å…ˆå‰µå»ºæ–°è¡Œå†å°‡å€¼æ›´æ–°é€²å»\nPush Notification è©¦æƒ³å¦‚æœè¡¨å–®æœ‰æ–°å¢è³‡æ–™ï¼Œå¯ä»¥è‡ªå‹•é€šçŸ¥Serverå°±èƒ½è™•ç†ä¸€äº›æ›´é€²éšçš„éœ€æ±‚ï¼›Google Drive API æä¾› Push Notificationï¼Œè€Œè¡¨å–®èº«ç‚º Driveä¸‹çš„å…¶ä¸­ä¹‹ä¸€æª”æ¡ˆå‹æ…‹ï¼Œä¹Ÿæœ‰æ”¯æ´æ­¤åŠŸèƒ½ï¼Œé‚£å°±ä¾†ç ”ç©¶ä¸€ä¸‹å§ã€‚\nPush Notifications | Drive REST API | Google Developers\nåƒè€ƒ Files: watch æ–‡ä»¶èªªæ˜ï¼Œä»¥ä¸‹ç‚ºæ“ä½œæ­¥é©Ÿ\nå®šç¾©å¥½callback urlä¸¦é€šéç¶²åŸŸé©—è­‰ï¼š\nå› ç‚ºæ˜¯webhooké—œä¿‚ï¼Œæ‰€ä»¥å¿…é ˆå®šç¾©å¥½ Googleå›å‘¼çš„ callback urlï¼Œé€™éƒ¨åˆ†éœ€è¦å† Google API Console \u0026gt; æ†‘è­‰ \u0026gt; ç¶²åŸŸé©—è­‰ç”³è«‹ï¼Œç¶²åŸŸé©—è­‰æœ‰å¤šç¨®æ–¹å¼ï¼Œæœ€ç°¡å–®æ˜¯Googleæœƒæä¾›ä¸€ä»½htmlä¸¦æŒ‡å®šè¦æ”¾åœ¨ç¶²åŸŸçš„å°æ‡‰è·¯å¾‘ä¸‹ï¼Œç”¨æ–¼é©—è­‰ç¶²åŸŸæ˜¯å±¬æ–¼æœ¬äººçš„ã€‚ å‘¼å«API 1 2 3 4 5 axios.post(\\`https://www.googleapis.com/drive/v2/files/${spreadsheet_id}/watch\\`, { type: \u0026#39;web_hook\u0026#39;, id: \u0026#39;channelIdAndShouldBeUnique\u0026#39;, address: \\`${domain}/drive/webhook\\` }); address æ”¾ callback urlï¼Œidå‰‡æ˜¯è‡ªè¡Œå®šç¾©channelï¼Œåˆ°æ™‚å€™å›å‘¼ç”¨æ–¼é©—è­‰ï¼Œtypeå›ºå®šç‚º web_hookã€‚\nGoogleå›å‘¼æ˜¯ç”¨POSTï¼Œä½†æ˜¯å…§å®¹æ˜¯æ”¾åœ¨headerï¼Œä»¥ x-goog- é–‹é ­çš„æ¨™é ­ï¼Œåè€Œbodyä¸­æ²’æœ‰è³‡æ–™ã€‚\nä½†ä¸å¾—ä¸èªªGoogleçš„Push Notificationæœ‰é»å¼±ï¼Œå› ç‚ºä»–åªæœƒå›å‚³å“ªå€‹æª”æ¡ˆæ”¹äº†ã€channel IDç­‰ï¼Œä½†ä¸æœƒæœ‰å¯¦è³ªçš„æ”¹è®Šå…§å®¹ï¼Œä¾‹å¦‚è¡¨å–®çš„å“ªä¸€è¡Œä¿®æ”¹ã€å“ªä¸€è¡Œæ–°å¢ç­‰ç­‰ï¼›\nä¸éä¹Ÿæ˜¯ï¼Œå› ç‚ºé€™æ˜¯å»£æ³›çš„Driveæª”æ¡ˆç•°å‹•é€šçŸ¥ï¼Œæ‰€ä»¥ä¸æœƒæœ‰å¤ªç´°ç·»çš„å…§å®¹å‘ˆç¾ã€‚\nç¸½çµ ä»¥ä¸Šæ˜¯Google OAuth2 æˆæ¬Šæ¨¡å¼ç ”ç©¶ï¼Œä»¥åŠç°¡å–®çš„Google Sheet APIç ”ç©¶ï¼Œè©•ä¼°å¾Œç¬¦åˆå°ˆæ¡ˆçš„éœ€æ±‚\n1. Serverä¸»å‹•appendéå¢è³‡æ–™\n2. ä¿ç•™Googleè¡¨å–®åŸå§‹åŠŸèƒ½\n3. å–å¾—Googleè¡¨å–®ç•°å‹•è§¸ç™¼\nå› ç‚ºæ˜¯å°å…§å°ˆæ¡ˆï¼Œæ‰€ä»¥æ˜¯æ¡ç”¨ Server-to-Serveræˆæ¬Šæ–¹å¼ã€‚\nå¯æƒœä¸èƒ½å¾—çŸ¥æ›´é€²ä¸€æ­¥çš„ç•°å‹•ï¼Œåªèƒ½è‡ªå·±é‡æ–°æŠ“è³‡æ–™ï¼Œåœ¨Serverç«¯é‡æ–°æ¯”å°ã€‚\nå¦å¤–Google Sheeté‚„å¯ä»¥é€é App Scriptæ’å…¥è³‡æ–™ï¼Œå®¢è£½åŒ–å‰ç«¯ï¼Œä¹‹å¾Œæœ‰ç©ºå†ä¾†ç ”ç©¶ã€‚\n","date":"2018-06-01T13:03:55.867Z","permalink":"https://yuanchieh.page/posts/2018/2018-06-01-google-sheet-api-%E8%88%87google-oauth2-api%E6%8E%88%E6%AC%8A%E7%A0%94%E7%A9%B6/","title":"Google Sheet API èˆ‡Google OAuth2 APIæˆæ¬Šç ”ç©¶"},{"content":"Transaction äº¤æ˜“æ©Ÿåˆ¶ï¼Œå¯ä»¥è®“å–®ä¸€æˆ–å¤šç­†æ“ä½œèšåˆç‚ºå–®ä¸€çš„åŸå­æ€§æ“ä½œï¼Œä¸€æ¬¡æ€§æˆåŠŸå¯«å…¥æˆ–å¤±æ•—å›æ»¾ï¼Œé¿å…è³‡æ–™åº«å‡ºç¾è³‡æ–™ä¸ä¸€è‡´çš„ç‹€æ³ã€‚\nIsolationï¼Œé—œè¯å¼è³‡æ–™åº«çš„åŸºæœ¬è¦ç´ ä¹‹ä¸€ï¼Œæè¿°ç•¶åŒæ™‚æœ‰å¤šç­†è«‹æ±‚è¦è®€å¯«åŒä¸€ç­†è³‡æ–™æ™‚çš„è™•ç†ç‹€æ³ã€‚\nä»¥ä¸‹åƒè€ƒ ã€ŠDesigning Data-Intensive Applicationã€‹ç¬¬ä¸ƒç« èˆ‡\né€é Payment Service èˆ‡ DB Isolation Level æˆç‚ºè«é€†ä¹‹äº¤\nè¶Šé«˜å±¤ç´šçš„Isolationæå‡è³‡æ–™çš„ä¸€è‡´æ€§ï¼Œä½†ä¹Ÿå¸¶ä¾†æ•ˆèƒ½ä¸Šçš„æè€—ï¼Œä»¥ä¸‹æ•´ç†å¯¦éš›æ‡‰ç”¨é‚è¼¯èˆ‡å°æ‡‰é©åˆçš„ Isolationè¨­è¨ˆã€‚\nDirty Write è¤‡å¯«å…¶ä»–å°šæœªcommit çš„ transaction æ›´æ–°ã€‚\nDirty Read è®€å–åˆ°å…¶ä»–Transaction æ›´æ–°ä½†å°šæœª commit çš„å€¼ã€‚\nRead Skew (Non Repeatable Read) åœ¨åŒä¸€å€‹ transactionä¸­ï¼Œè®€å–çš„å€¼æœƒå—åˆ°å…¶ä»–commitçš„ transaction æ›´æ–°å½±éŸ¿ã€‚\nPhantom Read ç•¶å…¶ä»–transaction æ’å…¥æˆ–åˆªé™¤è³‡æ–™ï¼Œæœƒå½±éŸ¿åŒä¸€ transactionä¸­å…ˆå¾Œçš„è®€å–ã€‚\nLost Update å…©å€‹Transactionéƒ½æ˜¯èµ° å…ˆè®€å–æŸå€¼ -\u0026gt; åŸºæ–¼æŸå€¼é‹ç®— -\u0026gt; æ›´æ–°åŸè³‡æ–™ ï¼Œä¾‹å¦‚èªªè³¼ç¥¨æµç¨‹ï¼Œå¿…é ˆå…ˆæª¢æŸ¥ç¥¨ç¨®çš„å‰©é¤˜ç¥¨åˆ¸ï¼Œå¦‚æœæœ‰å‰©å°±å»ºç«‹è¨‚å–®ä¸¦æ‰£é™¤åé¡ã€‚\né€™ç‹€æ³å¦‚åŒ ç¥¨åˆ¸å‰›å¥½å‰©ä¸€å¼µï¼ŒT1 / T2 åŒæ™‚è®€å–ç™¼ç¾ç¥¨åˆ¸å‰›å¥½ç‚ºä¸€ï¼Œå…©è€…éƒ½ä»¥ç‚ºå½¼æ­¤å¯ä»¥è²·ç¥¨ï¼Œæ¥è‘— T1 / T2 å…ˆå¾Œå°‡ç¥¨åˆ¸æ•¸é‡æ”¹ç‚ºé›¶ï¼Œé›–ç„¶æœ€å¾Œç¥¨åˆ¸ç‚ºé›¶ä½† T1/T2å»åˆ†åˆ¥æ¶ˆè€—äº†å…©æ¬¡ã€‚\nè§£æ³• å°‡èªæ³•æ”¹æˆ compare-and-setï¼Œå°‡åŸå…ˆè®€å–åˆ°çš„å€¼å¸¶å›æ›´æ–°æ™‚çš„åˆ¤æ–·å¼ä¸­åˆä½µæˆå–®ä¸€SQLï¼Œå¦‚ Update ticket where ticket.num = 1 ï¼Œé€™æ¨£è¼ƒæ™šæ›´æ–°çš„ transactionå°±æœƒæ›´æ–°ä¸åˆ°å¤±æ•— rollbackã€‚ åœ¨MySQLä¸­ä½¿ç”¨ selectÂ â€¦ for update ï¼Œé€™æ˜¯ exclusive row lockï¼Œç•¶å–å¾—é–å¾Œå…¶ä»– transaction å¦‚æœè¦ select lock in share mode / selectÂ ... for update / update / deleteéƒ½ä¸èƒ½å–å¾—é–ï¼Œç›´åˆ° commitï¼›\nå¾è€Œé¿å…ä¸¦è¡Œè®€å–çš„éŒ¯èª¤ã€‚\n(å°æ¯”å¯ä»¥ä¸¦è¡Œè®€å–çš„æ˜¯ selectÂ â€¦ for share ï¼Œä½†åŒæ¨£æœƒæ’æ–¥å¯«é–) ä½¿ç”¨ select for update å°±å¯ä»¥é¿å… t2 åœ¨ä¸çŸ¥é“ t1æ›´æ–°çš„æƒ…æ³ä¸‹æ›´æ–°ï¼Œå› ç‚º t2 çš„ select for update å¿…é ˆç­‰åˆ° t1æ›´æ–°å¾Œæ‰èƒ½è®€å–ï¼Œè§£æ±º Lost update å•é¡Œ\nWrite Skew AndÂ Phantom Write Skewæ˜¯ Lost Updateæ›´å»£æ³›åœ°é›†åˆï¼ŒåŒæ¨£æ˜¯è®€å–å¾Œä¿®æ”¹ï¼Œä½†Write Skewè®€å–èˆ‡ä¿®æ”¹çš„å°è±¡å¯ä»¥æ˜¯ä¸åŒçš„(è‹¥ç›¸åŒå‰‡ç‚º Lost Update)ã€‚\nä¾‹å¦‚èªªï¼š\næœ‰å¼µ æœƒè­°å®¤çš„è¡¨ï¼Œä¸Šé¢è¨˜éŒ„å“ªäº›æœƒè­°å®¤è¢«ä½”ç”¨çš„æ™‚é–“ç´€éŒ„å¦‚ (id1, from 12:00 to 13:00)ï¼Œç•¶ T1 / T2 åŒæ™‚æƒ³è¦é ç´„åŒä¸€é–“æœƒè­°å®¤åŒä¸€å€‹æ™‚æ®µï¼Œåœ¨æƒéå…©è€…éƒ½ä»¥ç‚ºæ²’æœ‰è¢«ä½”ç”¨å°±æ’å…¥æ–°ç´€éŒ„ï¼Œçµæœå°±ç™¼ç”Ÿå…©ç­†é ç´„è¡çªã€‚\nåˆæˆ–æ˜¯ éŠæˆ²æš±ç¨±ä¸å¯é‡è¤‡ï¼ŒT1/T2æƒéå…¨éƒ¨ç”¨æˆ¶åç¨±æ²’æœ‰ç™¼ç”Ÿé‡è¤‡ï¼Œæ’å…¥å¾Œæ‰ç™¼ç¾ T1/T2çš„å€¼æ˜¯é‡è¤‡çš„ã€‚\nä¸Šé¢å…©å€‹ç¯„ä¾‹æ˜¯ç„¡æ³•é€é Lost Updateæä¾›çš„è§£æ³•ï¼Œå› ç‚ºæ²’æœ‰ä¸€å€‹ç‰¹å®šçš„ row å¯ä»¥å» lockã€‚\næ•´é«”ä¸Šç™¼ç”ŸWrite Skewçš„æ¢ä»¶æ˜¯\n1. Select æŸäº›è³‡æ–™\n2. ä¾æ“šä¸Šä¸€æ­¥çš„è³‡æ–™åšåˆ¤æ–·\n3. Update / Delete ä¸€äº›è³‡æ–™\nWrite Skew å°±æ˜¯ç™¼ç”Ÿæ–¼ 2,3 æ­¥ä¹‹é–“åœ¨é‡è¤‡ç¬¬ä¸€å‹•æœƒç™¼ç¾Selectçµæœæ˜¯ä¸ä¸€æ¨£çš„ï¼Œä¹Ÿå°±æ˜¯phantom read çš„å‡ºç¾ã€‚\nè§£æ³•ï¼š ä½¿ç”¨ serializable isolationã€‚\nåœ¨MySQL Inno DB serializableä¸­ ï¼Œselectæ˜¯ç”¨è¡¨ç´šå…±äº«é–ï¼Œä¹Ÿå°±æ˜¯ select å¾Œå…¶ä»– selecté‚„æ˜¯å¯ä»¥ç”¨ï¼Œä½†æ˜¯å…¨è¡¨ä¸èƒ½æ’å…¥æ›´æ–°ç­‰ Materializing conflicts å…·è±¡åŒ–è¡çª\nWrite Skewæ˜¯Lost Updateçš„è¶…é›†åˆï¼Œæ›è¨€ä¹‹å¦‚æœå¯ä»¥å°‡ Write Skew å•é¡Œé™ç¶­æˆ Lost Updateï¼Œå°±å¯ä»¥å¾ range lock é™ç‚º row lockæå‡æ€§èƒ½ã€‚ æœƒç”¢ç”Ÿ Write Skew åœ¨æ–¼æ’å…¥/åˆªé™¤æ™‚æ²’æœ‰ç‰¹å®šçš„é–å¯ä»¥é å…ˆé–ä½è©²è¡Œï¼Œæ›è¨€ä¹‹å¦‚æœå¯ä»¥é å…ˆé–åˆ°å°±å¯ä»¥é¿å…å•é¡Œã€‚\nä¾‹å¦‚èªªæœƒè­°å®¤è³‡æ–™ï¼Œå‡è¨­æˆ‘å€‘å…ˆå°‡æ‰€æœ‰çš„æœƒè­°å®¤èˆ‡æ™‚é–“è¡¨å…¨éƒ¨æ’å…¥è³‡æ–™åº«ä¸­ï¼Œé€™æ¨£ç•¶æœ‰ transaction è¦é ç´„æœƒè­°å®¤ï¼Œå°±å¯ä»¥ç”¨ select for update æŸè¡Œè³‡æ–™ï¼Œå°±ä¸æœƒæœ‰å…¶ä»–äººË‹ä¸¦è¡Œé ç´„åŒä¸€é–“åŒä¸€å€‹æ™‚æ®µçš„æœƒè­°å®¤ã€‚\nä½†é€™ä¸æ˜¯è¬ç”¨è§£ï¼Œæœ‰äº›ç‹€æ³ä¸èƒ½é å…ˆçª®èˆ‰æ‰€æœ‰å¯èƒ½ã€‚\né€™é»åœ¨æ–‡ç« ä¸­ï¼Œæœ‰å€‹ç¯„ä¾‹æœ‰ç”¨ä¸ŠSerializableï¼Œ é€€è²»ä½¿ç”¨ChargeRefund ä¸€å¼µè¡¨ç´€éŒ„ï¼Œè€ŒOrderåœ¨å¦ä¸€å¼µè¡¨ï¼Œæ¯æ¬¡è¦ç”¢ç”Ÿé€€è²»æ™‚å°±å¿…é ˆå…ˆ è®€å–è¨‚å–®ç›¸é—œçš„æ‰€æœ‰Refundè¨ˆç®—é¡åº¦ï¼Œå¦‚æœè¨‚å–®é‚„æœ‰è¶³å¤ é¤˜é¡æ‰æœƒå‰µå»ºæ–°çš„ ChargeRefund é€™æ™‚å€™ç¬¦åˆWrite Skewç™¼ç”Ÿè¦ç´ ï¼Œæ‰€ä»¥ä»–å€‘æ˜¯ç”¨ Serializable å»è§£ï¼›\næˆ‘å€‘ç¶²ç«™æ˜¯æœƒå°‡ç›®å‰è¨‚å–®é€€è²»é¤˜é¡ç´€éŒ„åœ¨Orderä¸Šï¼Œæ‰€ä»¥åªè¦é€éselect for udpate å»é–è©²ç­†è¨‚å–®å°±å¥½ï¼Œä¸éœ€è¦ç”¨åˆ° Serializableã€‚\n3. åŠ å…¥åˆ¤åˆ¥æ¢ä»¶\nåˆ©ç”¨ Consistence ç‰¹æ€§ åŒæ¨£åœ¨æœƒè­°å®¤å•é¡Œï¼Œå¦‚æœå‰µå»ºå€‹ unique cluster index (room_id, startAt, endAt) æˆ–è¨±å°±å¯ä»¥ç”¨é—œé€£å¼è³‡æ–™åº«æœ¬èº«ç‰¹æ€§å»è§£æ±ºï¼Œä½†åŒæ¨£ä¸æ˜¯è¬ç”¨è§£\næœ‰è¶£çš„æ˜¯ï¼ŒSerializable åœ¨ MySQLä¸­ä¸æ˜¯çœŸæ­£çš„åºåˆ—åŒ–åŸ·è¡Œ Transactionï¼Œä»–é‚„æ˜¯å¯ä»¥ä¸¦è¡Œè™•ç†çš„ï¼Œæ–‡ä»¶ä¸­æœ‰æåˆ°Â ã€ŒThis level is like REPEATABLE READ, but InnoDB implicitly converts all plain SELECT statements to SELECTÂ â€¦ FOR SHARE if autocommit is disabled.ã€\næ‰€ä»¥è¦é¿å… Write Skewï¼Œé‚„æ˜¯è¦å»æ€è€ƒè¦é–å¤šå°‘å€é–“ï¼Œæˆ–æ˜¯é–æ•´å¼µè¡¨ï¼Œå–®å–®æ”¹æˆ Serializableæ˜¯æ²’è¾¦æ³•è§£æ±ºå•é¡Œçš„\nåœ¨ MySQL InnoDBä¸­ï¼Œselect for update / select lock in share mode åœ¨ Repeatable Readä¸‹ï¼ŒæœƒåŠ ä¸Š Next Key Lockï¼ŒNext Key Lockç­‰åŒæ–¼ row lock åŠ ä¸Š gap lockï¼Œgapå‰‡æ˜¯æ ¹æ“š index æ‹†åˆ†å€æ®µï¼Œé€²è€Œå¯ä»¥åˆ†å€é–å®šï¼Œé˜»æ“‹å¹»è®€çš„ç™¼ç”Ÿï¼› è€Œselect for update åœ¨æ²’æœ‰ where æ¢ä»¶ä¸‹åŸºæœ¬ä¸Šå°±ç­‰åŒæ–¼table lockã€‚\nåœ¨ç ”ç©¶éç¨‹ä¸­ï¼Œæœ‰æ–‡ç« æåˆ° SQL Standard å°æ–¼ isolation levelå®šç¾©æ¨¡ç³Šï¼Œå„å®¶è³‡æ–™åº«çš„å¯¦ä½œä¹Ÿç•¥æœ‰å·®ç•°ï¼Œæ‰€ä»¥ç›¸å°æ–¼æ¡ç”¨é è¨­çš„ isolation levelï¼Œå¯¦éš›äº†è§£ locking æ©Ÿåˆ¶æ¯”è¼ƒå¯¦åœ¨ã€‚\nç¸½çµï¼š åœ¨æ›¸ä¸­æœ‰æåˆ° SQLæ¨™æº–å°æ–¼ isolation levelçš„å®šç¾©æ˜¯ä¸å¤ªæ˜ç¢ºçš„ï¼Œå°è‡´å„å€‹è³‡æ–™åº«éƒ½æœƒå®šç¾©å„è‡ªçš„isolation levelï¼Œè€Œä¸”éƒ½æœƒæœ‰äº›å¾®çš„å·®ç•°ï¼›\næ‰€ä»¥èˆ‡å…¶ç›²ç›®çš„å»ä½¿ç”¨å¸¸è¦‹çš„å››ç¨® isolation levelï¼Œæ›´é‡è¦çš„äº‹é‡å°æ¥­å‹™é‚è¼¯å»åˆ†æåˆ°åº• concurrency ç™¼ç”Ÿçš„ç‹€æ³ä»¥åŠå¦‚ä½•é˜²æ­¢ race conditionã€‚\n","date":"2018-05-28T09:29:27.191Z","permalink":"https://yuanchieh.page/posts/2018/2018-05-28-%E8%B3%87%E6%96%99%E5%BA%AB-isolation-level-%E8%88%87%E5%AF%A6%E9%9A%9B%E6%87%89%E7%94%A8%E6%83%85%E5%A2%83%E8%99%95%E7%90%86/","title":"è³‡æ–™åº« Isolation level èˆ‡å¯¦éš›æ‡‰ç”¨æƒ…å¢ƒè™•ç†"},{"content":"The Twelve-Factor App æ˜¯ç”±ä¸€ç¾¤æœ‰è±å¯Œç¶“é©—çš„å·¥ç¨‹å¸«ï¼Œæ•´ç†é–‹ç™¼ä¸€å€‹Webæ‡‰ç”¨ç¨‹å¼(æˆ–æ˜¯æ‰€è¬‚çš„SAAS software-as-a-service)é–‹ç™¼æ–¹é‡ï¼ŒåŸºæ–¼ä»¥ä¸‹å¹¾å€‹æ–¹å‘\nè¨­å®šæ˜ç¢ºï¼Œé™ä½æ–°äººåŠ å…¥å°ˆæ¡ˆçš„ä¸Šæ‰‹æˆæœ¬ æœ€å¤§åŒ–å¯ç§»æ¤æ€§ é©åˆéƒ¨ç½²åˆ°é›²ç«¯å¹³å° é™ä½é–‹ç™¼èˆ‡éƒ¨ç½²çš„å·®ç•°æ€§ï¼Œå¢åŠ æŒçºŒéƒ¨ç½²çš„æ•æ· å®¹æ˜“æ“´å±•(scale up) åŸºæ–¼ä¸Šè¿°å¹¾å€‹è¦é»ï¼Œæ•´ç†æˆ12é …è¦ç´ ï¼Œè€Œç¬¦åˆé€™ 12è¦ç´ çš„æ‡‰ç”¨ç¨‹å¼å‰‡ç¨±ç‚ºtwelve-factor app (å¾Œæ–‡æœƒæ¡ç”¨æ­¤åè©)ï¼Œç€è¦½éå¾Œè »æœ‰è¶£çš„ï¼Œç¨å¾®æ‘˜è¦ä¸¦æå‡ºè‡ªå·±åœ¨å¯¦è¸ä¸Šçš„æƒ³æ³•(ä¸»è¦æ˜¯Nodejsï¼Œä½œè€…çœ‹ä¾†æ¯”è¼ƒæ„›ç”¨Pythonç•¶ç¯„ä¾‹)ã€‚\nç‚ºé¿å…æ­§ç¾©æˆ–è‹±æ–‡æ°´æº–ä¸ä½³ï¼Œæœ‰äº›é—œéµå­—æœƒä¸­è‹±å¤¾é›œï¼Œæˆ–æ˜¯ç›´æ¥é¡¯ç¤ºè‹±æ–‡å–®å­—ã€‚\n1. Codebase ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ä¸€ä»½Codebaseï¼Œä½†å¯ä»¥æœ‰å¤šä»½éƒ¨ç½² (One codebase tracked in revision control, manyÂ deploys) åŸå§‹ç¢¼å¿…é ˆä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œå¦‚ Git / Subversion / Mercurialï¼Œæ¯ä»½APPåªèƒ½æœ‰ä¸€å€‹Code Repoï¼Œä½†å¯ä»¥æœ‰ä¸€ä»½Code Repoå¯ä»¥åŸ·è¡Œå¤šä»½ä¸”ç‰ˆæœ¬ä¸ä¸€æ¨£çš„éƒ¨ç½² Deployï¼›\n2. Dependencies å‘½ç¢ºå®šç¾©èˆ‡éš”é›¢ç›¸ä¾(Explicitly declare and isolate dependencies) è¨±å¤šèªè¨€ç¨‹å¼éƒ½æœ‰å°æ‡‰çš„å‡½å¼åº«(library)ç®¡ç†å·¥å…·ï¼Œä¾‹å¦‚Rubyæœ‰Rubygemsã€Perlæœ‰CPANã€NodeJSæœ‰NPM(æˆ–Yarn)ï¼Œåœ¨å®‰è£ä¸Šæœ‰ç³»çµ±å±¤ç´šæˆ–æ˜¯è¢«ä¾·é™æ–¼å°ˆæ¡ˆç›®éŒ„ä¸‹(åˆç¨± bundling / Vendoring)\nä¸€å€‹æ­£ç¢ºçš„æ‡‰ç”¨ç¨‹å¼ã€Œä¸æ‡‰è©²ä¾è³´ç³»çµ±å±¤ç´šçš„å‡½å¼åº«ã€ï¼Œæ‡‰è©²è¦åœ¨å®£å‘Šæ–‡ä»¶æ˜ç¢ºçš„å®£å‘Šæ‰€æœ‰ä¾è³´çš„å‡½å¼åº«ï¼›\nä¸¦ç¢ºä¿å‡½å¼åº«ä¸æœƒå½±éŸ¿å…¨åŸŸç’°å¢ƒï¼Œä¸¦ç¶­æŒéš”é›¢ã€‚ä¾‹å¦‚NPMåœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ package.json ï¼Œé è¨­å®‰è£ä¹Ÿæ˜¯åœ¨è©²å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ node_modules ä¸­ã€‚\næ˜ç¢ºå®šç¾©çš„å¥½è™•æ˜¯å°æ–°äººå‹å–„ï¼Œåªè¦ç€è¦½å®£å‘Šæ–‡ä»¶å°±å¯ä»¥å¾—çŸ¥æ‰€æœ‰ç›¸ä¾çš„å‡½å¼åº«ï¼Œè€Œä¸”é€šå¸¸å‡½å¼åº«ç®¡ç†å·¥å…·éƒ½æœ‰è‡ªå‹•å®‰è£çš„æŒ‡ä»¤ï¼Œå¦‚ npm install\nå¦å¤–å°ˆæ¡ˆä¹Ÿä¸éš±å¼ä¾è³´ç³»çµ±å·¥å…·ï¼Œä¾‹å¦‚ curl ã€ImageMagick ç­‰ï¼Œå› çˆ²å³ä¾¿é€™äº›å·¥å…·åœ¨å¤§å¤šç³»çµ±éƒ½å­˜åœ¨ï¼Œä½†ä¸èƒ½ä¿è­‰æ‡‰ç”¨ç¨‹å¼é‹è¡Œçš„ç’°å¢ƒæœ‰å®‰è£ï¼›\nå¦‚æœéœ€è¦ï¼Œå‰‡è€ƒæ…®å°‡ç³»çµ±å·¥å…·ä¹Ÿæ‰“åŒ…é€²æ‡‰ç”¨ç¨‹å¼ä¸­ã€‚\n3. Config å°‡è¨­å®šå„²å­˜æ–¼ç’°å¢ƒä¸­(Store config in the environment) configæ˜¯é‚£äº›æœƒä¾æ“šéƒ¨ç½²ç’°å¢ƒè€Œæœ‰æ‰€ä¸åŒçš„è³‡æ–™ï¼Œä¾‹å¦‚è³‡æ–™åº«é€£ç·šè³‡æ–™/ AmazonS3ç­‰å¤–éƒ¨æœå‹™çš„æ©Ÿæ•è³‡æ–™ / hostnameç­‰ï¼Œæ‰€ä»¥ä¹Ÿä¸æœƒæ”¾å…¥ç‰ˆæœ¬æ§åˆ¶å·¥å…·è¿½è¹¤ã€‚\nå¿…é ˆæ³¨æ„ï¼Œç¨‹å¼ç¢¼èˆ‡è¨­å®šæª”ã€Œ**å¿…é ˆåš´æ ¼åˆ†é›¢ã€ï¼Œ**ç¨‹å¼ç¢¼æ˜¯æ‰€æœ‰éƒ¨ç½²éƒ½åŒä¸€ä»½ï¼Œä¸¦ä¸”ä¸æ‡‰è©²åŒ…å«ä»»ä½•æ©Ÿæ•è³‡æ–™ã€‚\nè¨±å¤šç¨‹å¼èªè¨€æœ¬èº«æœ‰åå¥½çš„è¨­å®šæ–‡ä»¶æ ¼å¼ï¼Œå¦‚ xml / yml / json ç­‰ï¼Œç‚ºäº†æ–¹ä¾¿æœ€å¥½æ˜¯ä½¿ç”¨å„²å­˜æ–¼ç’°å¢ƒè®Šæ•¸ä¸­ã€‚\næ­¤å¤–ï¼Œç’°å¢ƒè®Šæ•¸æ‡‰è©²æ˜¯æ¯å€‹ç’°å¢ƒç¨ç«‹æ–¼å½¼æ­¤ï¼Œæ‰€ä»¥ä¸éœ€è¦åƒ Railsç”¨ â€œproductionâ€ / â€œtestâ€/ â€œdevelopmentâ€ åœ¨ç´°æ‹†å®šç¾©ç’°å¢ƒè®Šæ•¸ã€‚\n\u0026gt;\u0026gt; ä½†é€™è£æ¯”è¼ƒtrickyçš„æ˜¯å…¬å¸å°ˆæ¡ˆ stage / prodéƒ½æ˜¯è·‘åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šï¼Œæ²’è¾¦æ³•ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œéƒ½æ˜¯æ¡ç”¨ config.js ç•¶ä½œè¨­å®šæ–‡ä»¶\n4. BackingÂ services å°‡æ”¯æ´æœå‹™ç•¶ä½œé™„åŠ çš„è³‡æº(Treat backing services as attached resources) é€™è£¡çš„Backing servicesæ³›æŒ‡æ‡‰ç”¨ç¨‹å¼ç›¸ä¾çš„å¤–éƒ¨æœå‹™ï¼Œä¾‹å¦‚è³‡æ–™åº«ã€å¯„ä¿¡æœå‹™å•†ã€å¿«å–è³‡æ–™åº«ç­‰\ntwelve-factor app æ‡‰è©²æ˜¯å¯ä»¥åœ¨æŠ½æ›å¤–éƒ¨æ”¯æ´æœå‹™è€Œä¸éœ€è¦æ›´å‹•ç¨‹å¼ç¢¼ï¼Œåªéœ€è¦æ”¹è®Šè¨­å®šæª”ä¸¦é‡å•Ÿè€Œå·²ï¼›\nä¾‹å¦‚èªªå°‡è³‡æ–™åº«å¾æœ¬æ©Ÿç«¯çš„MySQLæ›¿æ›æˆé›²ç«¯ Amazon RDSã€‚\n5. Build, release,Â run åš´æ ¼å€åˆ†å»ºåˆ¶èˆ‡åŸ·è¡Œæ­¥é©Ÿ(Strictly separate build and runÂ stages) ç•¶åŸå§‹ç¢¼è¦è½‰æ›æˆéƒ¨ç½²çš„ç¨‹åºæ™‚ï¼Œæœƒç¶“éä¸‰å€‹æ­¥é©Ÿ\n1. å»ºç½® buildï¼š\nå°‡ç¨‹å¼ç¢¼è½‰æ›æˆå¯åŸ·è¡Œçš„åŒ…è£¹(Bundle)ï¼Œé€™æ­¥é©ŸæœƒæŠ“å–å¤–éƒ¨ç›¸ä¾çš„å‡½å¼åº«ä¸¦ç·¨è­¯äºŒé€²åˆ¶æª”æ¡ˆç­‰ã€‚\n2. ç™¼å¸ƒ releaseï¼š\nå°‡buildå¥½çš„å¯åŸ·è¡ŒåŒ…è£¹ï¼Œä¸¦çµåˆè©²éƒ¨ç½²ç’°å¢ƒçš„è¨­å®šæª”\n3. åŸ·è¡Œ runï¼š\nåŸ·è¡Œreleaseéšæ®µæ‰“åŒ…å¥½çš„ç¨‹å¼ã€‚\næ¯ä»½releaseéƒ½å¿…é ˆæœ‰ç‰¹å®šçš„ç·¨è™Ÿï¼Œä¸è«–æ˜¯æ—¥æœŸæ ¼å¼ 2011â€“04â€“06â€“20:32:17 æŠ‘æˆ–æ˜¯éå¢ç‰ˆå¥½ v100 ï¼Œæ–¹ä¾¿å¾ŒçºŒæœ‰å•é¡Œå¯ä»¥å›æ»¾ã€‚\næ­¤å¤–ç•¶ç™¼å¸ƒreleaseå¾Œä¸èƒ½æœ‰ä»»ä½•æ›´å‹•ï¼Œåªèƒ½é€éç™¼å¸ƒæ–°çš„releaseã€‚\nå»ºç½®éšæ®µé€šå¸¸æ˜¯ç•¶å·¥ç¨‹å¸«è¦ºå¾—æœ‰æ–°çš„ç¨‹å¼ç¢¼æ›´å‹•éœ€è¦éƒ¨ç½²ï¼Œå‰‡ä¸»å‹•è§¸ç™¼çš„ï¼Œæ‰€ä»¥åœ¨å»ºç½®éšæ®µå¯ä»¥åŸ·è¡Œç›¸å°è¤‡é›œçš„æŒ‡ä»¤èˆ‡æ“ä½œï¼Œç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚é‚„å¯ä»¥æœ‰å·¥ç¨‹å¸«æ‰‹å‹•ä¿®å¾©ï¼›\nä½†ç›¸å°åœ¨åŸ·è¡Œéšæ®µï¼Œå¯èƒ½æ˜¯è‡ªå‹•åŒ–åŸ·è¡Œå¦‚æ‡‰ç”¨å´©æ½°å¾Œè‡ªå‹•é‡å•Ÿï¼Œæ‰€ä»¥åœ¨åŸ·è¡Œéšæ®µæ‡‰è©²è¦è¶Šç°¡æ½”è¶Šå¥½ã€‚\n6. Processes åŸ·è¡Œç„¡ç‹€æ…‹çš„å–®åŸ·è¡Œç·’æˆ–å¤šåŸ·è¡Œç·’(Execute the app as one or more stateless processes) ä¸€å€‹æ‡‰ç”¨ç¨‹å¼å¯èƒ½æœ‰å–®å€‹æˆ–å¤šå€‹åŸ·è¡Œç·’ï¼Œtwelve-factor app æ‡‰è©²æ˜¯statelessä¸” share-nothing ï¼Œéœ€è¦é•·æœŸä¿å­˜çš„è³‡æ–™å¯ä»¥æ”¾åœ¨å¤–éƒ¨æœå‹™å¦‚è³‡æ–™åº«æˆ–CDNä¸­\nç¨‹åºçš„è¨˜æ†¶é«”æˆ–æ˜¯æª”æ¡ˆç³»çµ±åªèƒ½ç•¶ä½œæš«æ™‚çš„æ“ä½œç©ºé–“ï¼Œä¾‹å¦‚ä¸‹è¼‰æª”æ¡ˆã€æ“ä½œã€æ¥è‘—å°‡çµæœå„²å­˜æ–¼è³‡æ–™åº«ä¸­ï¼Œæ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç¢ºä¿è¢«æš«å­˜åœ¨å¿«å–èˆ‡æª”æ¡ˆç³»çµ±çš„è³‡æ–™åœ¨æœªä¾†ä¸æœƒè¢«ç”¨ä¸Šï¼›\nå› ç‚ºåœ¨å¤šåŸ·è¡Œç·’ä¸‹ï¼ŒæœªçŸ¥çš„è«‹æ±‚å¯èƒ½è¢«ä¸åŒçš„åŸ·è¡Œç·’æ‰€åŸ·è¡Œï¼Œå³ä½¿æ˜¯å–®åŸ·è¡Œç·’ç¨‹å¼ç•¶ç³»çµ±å´©æ½°æ™‚å¿«å–è·Ÿæª”æ¡ˆç³»çµ±çš„è³‡æ–™éƒ½å¯èƒ½æ¶ˆå¤±ã€‚\næœ‰äº›æ‡‰ç”¨ç¨‹å¼æœƒæ¡ç”¨ sticky-session ç¢ºä¿åŒä¸€å€‹ç”¨æˆ¶è¢«åŒä¸€å€‹åŸ·è¡Œç·’æ‰€æœå‹™ï¼Œé€™æ˜¯é•åè¦ç¯„çš„ã€‚\næœ‰æ™‚æ•ˆæ€§çš„æš«å­˜ç‹€æ…‹è³‡æ–™(å¦‚session)å¯ä»¥æ”¾åœ¨åƒRedis / Memcachedé€™é¡çš„è³‡æ–™åº«ä¸­ã€‚\n7. PortÂ binding é€éç¶å®šåŸ å£å°å¤–é–‹æ”¾æœå‹™(Export services via portÂ binding) æ‡‰ç”¨ç¨‹å¼æœ‰äº›æ™‚å€™è¢«åŸ·è¡Œåœ¨å…¶ä»–å®¹å™¨ä¸­ï¼Œä¾‹å¦‚ PHPæœå‹™å¯èƒ½åŸ·è¡Œæ–¼ Apache HTTPD / Javaæœå‹™ åŸ·è¡Œæ–¼ Tomcatä¸‹ï¼Œä½†æ˜¯ twelve-factor app æ‡‰è©²æ˜¯æœå‹™ç›´æ¥ç¶å®šåŸ å£ä¸¦è™•ç†è«‹æ±‚ã€‚\né€™é€šå¸¸éƒ½æœ‰å‡½ç¤ºåº«å¯ä»¥æ”¯æ´ï¼Œä¾‹å¦‚ pythonçš„ Tornado / Ruby çš„ Thin ç­‰ï¼Œé€™ä½¿å¾—æ•´ä»½æ‡‰ç”¨ç¨‹å¼éƒ½æ˜¯åœ¨ user-spaceåŸ·è¡Œï¼Œä¸”å…¨éƒ¨åŒ…å«åœ¨åŸå§‹ç¢¼ä¸­ã€‚\nHTTPåªæ˜¯å…¶ä¸­ä¸€å€‹å¯ä»¥ç¶å®šåŸ å£çš„å”å®šï¼Œå…¶ä»–åƒæ˜¯ XMPP / Redis Protocol ç­‰æœå‹™éƒ½éœ€åƒç…§æ­¤è¦ç¯„ã€‚\n8. Concurrency é€éåŸ·è¡Œç·’æ¨¡å‹æ“´å±•(Scale out via the processÂ model) æ‡‰ç”¨ç¨‹å¼åœ¨åŸ·è¡Œç·’ç®¡ç†ä¸Šæœ‰å¤šç¨®æ–¹å¼ï¼Œä¾‹å¦‚ Apache æœƒåœ¨æ”¶åˆ°è«‹æ±‚æ™‚é–‹ä¸€éš»æ–°çš„å­åŸ·è¡Œç·’(Process)è·‘ phpæ‡‰ç”¨ï¼Œè€ŒJavaå‰‡æ˜¯é€éJVMå…ˆä¿ç•™ä¸€å¤§å¡ŠCPU/Memoryè³‡æºæ¥è‘—é€éå…§éƒ¨åˆ†é…ç·šç¨‹(Thread)é”åˆ°ä¸¦è¡Œæ•ˆæœã€‚\nåœ¨ twelve-factor app ä¸­ï¼ŒåŸ·è¡Œç·’æ˜¯ç¬¬ä¸€å…¬æ°‘ï¼Œé–‹ç™¼è€…å¯ä»¥æ±ºå®šç”±å“ªä¸€å€‹åŸ·è¡Œç·’è·‘ä»»å‹™ï¼Œä¾‹å¦‚ HTTPè«‹æ±‚åŸ·è¡Œåœ¨ WebåŸ·è¡Œç·’ä¸Š / èƒŒæ™¯æœå‹™å‰‡è·‘åœ¨ WorkeråŸ·è¡Œç·’ä¸Š\nçœ‹èªªæ˜ä½œè€…èˆ‰ Foreman ç•¶åšä¾‹å­(ä¸‹åœ–è¼”åŠ©èªªæ˜)ï¼Œé€™æ¨£çš„å¥½è™•æ˜¯é‡è¦çš„ä»»å‹™å¯ä»¥åˆ†é…è¼ƒå¤šçš„è³‡æº\nä½†é€™ä¸¦ä¸æ’é™¤åŸ·è¡Œç·’å…§éƒ¨å¤šå·¥è™•ç†ã€VMå…§éƒ¨è™•ç†ç·šç¨‹åˆ†é…ã€åˆæˆ–æ˜¯åƒ éåŒæ­¥/äº‹ä»¶è§¸ç™¼çš„NodeJSï¼Œä½†æ˜¯å–®ä¸€VMèƒ½å¤ å®¹é‡æœ‰é™ï¼Œæ‡‰ç”¨ç¨‹å¼é ˆå¯æ‹“å±•å¤šå€‹åŸ·è¡Œç·’åˆ°å¤šå°å¯¦é«”ä¸»æ©Ÿä¸Šã€‚\né€™æ¨£çš„è¨­è¨ˆåœ¨éœ€è¦æ°´å¹³æ“´å±•æ™‚æœƒå¤§æ”¾ç•°å½©ï¼Œshare-nothing / å¯æ°´å¹³æ‹†åˆ†çš„åŸ·è¡Œç·’åœ¨å¢åŠ æ›´å¤šä¸¦è¡Œ(Concurrency)æ™‚ååˆ†åœ°ç°¡å–®ã€‚\nåœ¨ pm2 åŒæ¨£å¯ä»¥åšåˆ°åŒæ¨£çš„äº‹æƒ…ã€‚\næœ€å¾Œä¸€æ®µæåˆ°ï¼Œtwelve-factor app should never daemonize or write PID files. Instead, rely on the operating systemâ€™s process manager (such as systemd, a distributed process manager on a cloud platform, or a tool like Foreman in development)\næŠ€è¡“åè©å¤ªå¤šç›´æ¥è²¼åŸæ–‡ï¼Œè¿½è¹¤å®Œç›¸é—œå…§æ–‡é€£çµå¤§è‡´ä¸Šæƒ³è¦èªªæ˜ã€Œæ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç®¡å¥½é–‹ç™¼æ‡‰ç”¨ç¨‹å¼å°±å¥½ï¼Œå…¶é¤˜çš„åŸ·è¡Œäº¤çµ¦å·¥å…·å³å¯ã€\nä¹Ÿå°±æ˜¯ KISS(Keep it simple, stupid) çš„è¨­è¨ˆç†å¿µã€‚\ndaemonæ˜¯è™•æ–¼èƒŒæ™¯ã€ä¸äºˆç”¨æˆ¶äº’å‹•çš„åŸ·è¡Œç¨‹å¼ï¼Œå…¶çˆ¶é€²ç¨‹ç‚º init (åœ¨ linux ä¸­ç‚ºç³»çµ±å•Ÿå‹•å¾Œç¬¬ä¸€å€‹é€²ç¨‹ï¼ŒPIDç·¨è™Ÿç‚º1)ï¼Œinitæœƒä¸€ç›´å­˜åœ¨åˆ°é›»è…¦é—œæ©Ÿç‚ºæ­¢ï¼›\nç•¶æœ‰ä»»ä½•çˆ¶é€²ç¨‹å…ˆè¡Œé—œé–‰è€Œå­é€²ç¨‹ä»ç„¶åŸ·è¡Œæ™‚ï¼Œinitæœƒè½‰ç‚ºé€™äº›å­é€²ç¨‹çš„çˆ¶é€²ç¨‹ï¼Œæ‰€ä»¥å¸¸è¦‹å•Ÿå‹•daemonä½œæ³•ä¹Ÿéƒ½æ˜¯åœ¨çˆ¶é€²ç¨‹ forkå‡ºå­é€²ç¨‹å¾Œé€€å‡ºï¼Œæ­¤æ™‚å­é€²ç¨‹å°±æ˜¯daemon processäº†ã€‚\nåƒè€ƒ Nodejs Daemon å‡½å¼åº«å°±æ˜¯æ­¤ä½œæ³•ï¼Œç”¨ child_process.spawn é—œé–‰ stdin ä¸¦é‡å° stdout / stderr èˆ‡å…¶ä»–è¨­å®šï¼Œå¦é–‹æ–°çš„é€²ç¨‹ã€‚\nindexzero/daemon.node\n9. Disposability å¿«é€Ÿå•Ÿå‹•+å„ªé›…é—œé–‰=\u0026gt;å¢å¼·ç¨‹å¼å¯é æ€§ (Maximize robustness with fast startup and graceful shutdown) æ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç›¡å¯èƒ½é™ä½å•Ÿå‹•æ™‚é–“ï¼Œé€™æ¨£æ‰å¯ä»¥åœ¨å¿«é€Ÿæ“´å±• / ä¿®æ”¹è¨­å®šæ™‚å¿«é€Ÿå•Ÿç”¨æœå‹™ï¼›\nç•¶æ‡‰ç”¨ç¨‹å¼æ”¶åˆ°SIGTERMè¨Šè™Ÿæ™‚ï¼Œæ‡‰ç•¶å„ªé›…çš„é—œé–‰ï¼Œä¹Ÿå°±æ˜¯åœæ­¢è™•ç†æ–°çš„è«‹æ±‚ä¸¦å°‡ç¾æœ‰çš„è«‹æ±‚è™•ç†å®Œæˆæ‰é€€å‡ºã€‚\næ‡‰ç”¨ç¨‹å¼éœ€è¦è™•ç†éé è­¦çš„é—œé–‰ï¼Œä¾‹å¦‚ç¡¬é«”å£æ‰ç­‰ï¼Œé€™æ™‚å€™æœ€å¥½æœ‰å¯é çš„queueing backend ä¾‹å¦‚Beanstalkdï¼Œç•¶æ‡‰ç”¨ç¨‹å¼çµ‚æ­¢æˆ–è¶…æ™‚å¯ä»¥è‡ªå‹•å°‡ä»»å‹™é‡æ–°è¿”å› queueä¸­ã€‚\n10. Dev/prodÂ parity ç›¡å¯èƒ½ä¿æŒç’°å¢ƒä¸€è‡´ (Keep development, staging, and production as similar as possible) å› ç‚ºä¸€äº›æ­·å²ç·£ç”±ï¼Œé–‹ç™¼ç’°å¢ƒèˆ‡æ­£å¼ç’°å¢ƒå¯èƒ½æœ‰å¹¾ç¨®å·®ç•°å­˜åœ¨\n1. æ™‚é–“ï¼šé–‹ç™¼ç’°å¢ƒå¯èƒ½æŒçºŒé–‹ç™¼äº†æ•¸å¤©åˆ°æ•¸å€‹æœˆæ‰åŒæ­¥åˆ°æ­£å¼ç’°å¢ƒ\n2. äººï¼šé–‹ç™¼å·¥ç¨‹å¸«è² è²¬é–‹ç™¼ï¼Œè€Œç¶­é‹å·¥ç¨‹å¸«éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ\n3. å·¥å…·ï¼šæœ¬åœ°ç«¯å¯èƒ½ç”¨SQLite è€Œ æ­£å¼ç’°å¢ƒå‰‡ç”¨ MySQL\ntwelve-factor app å‰‡æ˜¯è¦ç¸®çŸ­ä¸Šé¢çš„å·®è·\n1. ç¸®çŸ­æ™‚é–“ï¼šé–‹ç™¼åˆ°éƒ¨ç½²åœ¨æ•¸å°æ™‚ç”šè‡³æ•¸åˆ†é˜ä¹‹é–“\n2. äººï¼šé–‹ç™¼è€…æ‡‰è©²ç·Šå¯†çš„åƒèˆ‡æ­£å¼ç’°å¢ƒéƒ¨ç½²\n3. å·¥å…·ï¼šç›¡å¯èƒ½ç”¨åŒæ¨£çš„å·¥å…·éŠ\nç’°å¢ƒå®£å‘Šå·¥å…·å¦‚ Chef / Puppet çµåˆè¼•é‡çš„è™›æ“¬åŒ–ç’°å¢ƒå·¥å…·å¦‚ Docker / Vagrant å¯ä»¥å¤§å¹…åŒæ­¥é–‹ç™¼èˆ‡æ­£å¼ç’°å¢ƒã€‚\n11. Logs ç”¨ä¸²æµè™•ç†Log( Treat logs as eventÂ streams) twelve-factor app æœ¬èº«ä¸æ‡‰è©²å»ç®¡ç†æˆ–ç…©æƒ± Logæ‡‰è©²è¦å„²å­˜åœ¨å“ªè£¡ï¼ŒåŸ·è¡Œä¸­çš„ç¨‹å¼æ‡‰ç•¶ç›´æ¥è¼¸å‡ºåˆ° stdout ï¼Œåœ¨æœ¬åœ°é–‹ç™¼ä¸Šå·¥ç¨‹å¸«å¯ä»¥ç›´æ¥åœ¨çµ‚ç«¯æ©Ÿä»‹é¢çœ‹åˆ°æ‰€æœ‰çš„æ‰“å°è¨Šæ¯ï¼›\nè€Œåœ¨æ­£å¼ç’°å¢ƒä¸Šï¼ŒLogæ‡‰è©²è¢«åŸ·è¡Œç’°å¢ƒè™•ç†ï¼Œå½™æ•´æ‰€æœ‰çš„Logåˆ°ä¸åŒçš„åœ°æ–¹å„²å­˜æˆ–æ˜¯åˆ°Hadoop/Hive åšæ›´é€²ä¸€æ­¥çš„è³‡æ–™è™•ç†ï¼Œæœ‰é–‹æºå·¥å…·å¯ä»¥ä½¿ç”¨å¦‚ Logplex / Fluentdï¼Œå€¼å¾—æ³¨æ„æ˜¯æ‡‰ç”¨ç¨‹å¼æœ¬èº«ä¸çŸ¥é“Logå…¶ä»–è¨­å®šã€‚\nåœ¨Nodejsé–‹ç™¼ä¸­ï¼Œpm2 æœ‰æä¾›åŸºæœ¬çš„Logï¼Œä½†å¦‚æœè¦æ›´é€²éšçš„è™•ç†å°±é‚„æ˜¯è¦ç”¨ bunyan / winston Log å‡½å¼åº«ï¼Œä½†é€™å°±æœƒé•ååŸå‰‡ï¼Œå› ç‚ºè®Šæˆæ˜¯æ‡‰ç”¨ç¨‹å¼è¦è‡ªå·±è™•ç†Logçš„éƒ¨åˆ†ã€‚\né™¤éè‡ªå·±å¦å¤–é–‹ç™¼ä¸€å¥—ç›´æ¥æ¥ stdout / stderr çš„ä¸²æµå·¥å…·(å¥½åƒå¯ä»¥è©¦è©¦çœ‹?!)ã€‚\n12. Admin processes åŸ·è¡Œä¸€æ¬¡æ€§ç®¡ç†ä»»å‹™ (Run admin/management tasks as one-off processes) ä¸€æ¬¡æ€§çš„ç®¡ç†ä»»å‹™å¦‚ è³‡æ–™åº«Schemaæ›´å‹• / ç‰¹å®šä»»å‹™è…³æœ¬ / ä½¿ç”¨REPLåŸ·è¡Œä»»æ„çš„ç¨‹å¼ç¢¼ç­‰ï¼Œé€™äº›ä¸€æ¬¡æ€§çš„ç®¡ç†ä»»å‹™æ‡‰ç•¶ä¸€åŒæ”¾å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸¦èˆ‡æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ç›¸åŒçš„å·¥å…·éŠèˆ‡è¨­å®šæª”ã€‚\n==========\nä»¥ä¸Šåªæ˜¯å€‹äººçš„æ¿ƒç¸®ç¸½çµï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹åŸè³‡æ–™ç¶²ç«™ã€‚\n","date":"2018-05-19T07:02:08.523Z","permalink":"https://yuanchieh.page/posts/2018/2018-05-19-the-twelve-factor-app-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/","title":"The Twelve-Factor App é–±è®€ç­†è¨˜"},{"content":"æ˜¨å¤©åœ¨ Android æ‰‹æ©Ÿä¸Šç”¨ Youtube åˆ†äº«å½±ç‰‡åˆ° LINE èŠå¤©å®¤çµ¦æœ‹å‹ï¼Œçªç„¶éˆæ©Ÿä¸€å‹•è¦ºå¾— APP æœ‰é€™éº¼æ–¹ä¾¿çš„åˆ†äº«æ©Ÿåˆ¶ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥åœ¨ Chrome ç”¨ Extension æ–¹å¼æ•´åˆç¤¾ç¾¤åˆ†äº«ï¼ŒæŒ‰ä¸€å€‹æŒ‰éˆ•å°±å¯ä»¥æŠŠç•¶å‰é é¢çš„é€£çµæˆ–æ–‡å­—å¿«é€Ÿåˆ†äº«ï¼›\næ­£å¥½ä¹‹å‰ä¹Ÿæ²’æœ‰é–‹ç™¼é Chrome extensionï¼Œæ­£å¥½æ‹¿ä¾†ç·´ç·´æŠ€è¡“ï¼Œä½†æœä¸å…¶ç„¶åœ¨ Chrome extension shop æœ‰çœ‹åˆ°å¾ˆå¤§é‡çš„ç¤¾äº¤åˆ†äº«å·¥å…·äº† OTZÂ ä½†é‚„æ˜¯ä¸æ­»å¿ƒæƒ³è¦è‡ªå·±å‹•æ‰‹ç©ç©çœ‹\nåƒè€ƒè³‡æ–™ï¼š\nChrome team æœ¬èº«çš„å®˜æ–¹æ•™å­¸é‚„ä¸è³´\nGetting Started Tutorialâ€Šâ€”â€ŠGoogle Chrome\nå¼·è€… ç¾…æ‹‰æ‹‰åœ¨ 2016 å¹´ IThome éµäººè³½çš„ç³»åˆ—æ–‡ï¼Œå‰åŠæ®µæŠŠå®˜æ–¹æ•™å­¸ç¿»è­¯ï¼Œå¾ŒçºŒåŠ ä¸Šä½œè€…å€‹äººé–‹ç™¼åˆ†äº«ï¼Œéå¸¸æ£’çš„æ•™å­¸ã€‚\nChrome Extension é–‹ç™¼èˆ‡å¯¦ä½œ ç³»åˆ—æ–‡ç« åˆ—è¡¨ â€”â€ŠiT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤© ä»¥ä¸‹ç‚ºå€‹äººé–‹ç™¼ç°¡ç•¥èˆ‡ç°¡åŒ–éå¾Œçš„ç­†è¨˜ï¼Œæ‰€ä»¥è¦çœ‹è©³ç´°ç‰ˆé‚„æ˜¯çœ‹ä¸Šé™„å…©å€‹æ–‡ä»¶\nåŸºæœ¬ä»‹ç´¹ åŸºæœ¬ä¸Šé–‹ç™¼ Chrome extension è·Ÿå¯«ç¶²é å¾ˆé¡ä¼¼ï¼Œåªæ˜¯æ”¹äº†æª”æ¡ˆçµæ§‹ã€ç™¼å¸ƒæ©Ÿåˆ¶ã€API èª¿ç”¨å¤šå¢åŠ äº† chrome.* å‡½å¼\nåœ¨ extension é–‹ç™¼ä¸­ï¼Œç›®éŒ„ä¸‹å¿…é ˆå…ˆå®£å‘Š manifest.jsonï¼Œè£¡é ­æœƒè¨»æ˜ extension çš„åç¨±/icon/æ‰€éœ€æ¬Šé™ç­‰è³‡æ–™ï¼Œé‚„æœ‰ä¸åŒæ™‚æ©Ÿå°æ‡‰åŸ·è¡Œçš„ä¸åŒè…³æœ¬\nåŸºæœ¬ä¸Šé–‹ç™¼æœƒæœ‰å¹¾å€‹é é¢å¯ä»¥é¸æ“‡\nbackground page èƒŒæ™¯é é¢ï¼š\nåŸºæœ¬ä¸Šæ˜¯å¸¸é§ï¼Œå¾å®‰è£æ’ä»¶ä¹‹å¾Œå°±ä¸€ç›´åŸ·è¡Œåˆ°æ’ä»¶è¢«ç§»é™¤(ä¸å®Œå…¨æ­£ç¢ºçš„æè¿°ï¼Œä½†åŸºæœ¬ä¸Šå¯ä»¥é€™æ¨£ç†è§£)\næ‰€ä»¥æœƒåœ¨ background æŒ‡å®šçš„ script ä¸­åŸ·è¡Œå¥—ä»¶å®‰è£æˆ–æ›´æ–°ï¼Œåˆæˆ–æ˜¯åˆå§‹åŒ–çš„ä¸€äº›ç¨‹åº popup page å½ˆå‡ºé é¢ï¼š\nä¹Ÿå°±æ˜¯å³ä¸Šè§’çš„å°åœ–æ¨™ï¼Œé»æ“Šå¾Œç”¢ç”Ÿçš„é é¢ï¼Œåˆç´°åˆ†æˆ browser-action / page-actionï¼›\nbrowser-action ä»£è¡¨ Extesion æ˜¯æ™®éæ€§åœ¨æ¯å€‹ç¶²ç«™éƒ½å¯ä»¥ç”¨ï¼Œè€Œ page-action å‰‡ä»£è¡¨åªé‡å°æŸäº›ç‰¹å®šç¶²ç«™ä½¿ç”¨ï¼Œå¹³å¸¸æœƒè‡ªå‹•å‘ˆç¾ç°æš—çš„ icon ç›´åˆ°é¡¯ç¤ºå®£å‘Š pageAction.show()ï¼Œåƒæ˜¯ vue-devtool åªæœ‰åœ¨ç¶²ç«™ä½¿ç”¨ vue.js æ‰èƒ½ä½¿ç”¨ã€‚ option page é¸é …é é¢ï¼š\næ‡‰ç”¨ç¨‹å¼å¦‚æœå¤ªéæ–¼è¤‡é›œï¼Œå¸Œæœ›æœ‰å€‹é¸é …é å¯ä»¥ä¾›å®¢æˆ¶å®¢è£½åŒ–è¡Œç‚ºï¼Œå¯ä»¥æ¡ç”¨ content scriptï¼š\nåœ¨ Extension ä¸­ï¼Œåªè¦æœ‰ç´¢å–æ¬Šé™å°±å¯ä»¥å°æ¯å€‹é é¢æ³¨å…¥ content scriptï¼Œé€²è¡Œ DOM æ“ä½œç­‰ä¸€èˆ¬ js script æœƒåŸ·è¡Œçš„å‹•ä½œï¼Œå¯ä»¥çœ‹æˆåˆæ³•çš„ XSS æ³¨å…¥ã€‚ å¯¦æˆ°åˆ†äº« sj82516/quick-share\nå®šç¾©èˆ‡è¼‰å…¥å…¶ä»– script å¯ä»¥åƒè€ƒ manifest.jsonï¼Œé€™è£¡æˆ‘ç”¨äº†\nbackgroundï¼ševent.jsï¼Œä¸»è¦è¨»å†Šèˆ‡å®šç¾©å³éµæŒ‰ä¸‹å‡ºç¾çš„é¸å–®è¡Œç‚º\npopup pageï¼šåˆ†æˆ popup.html / popup.jsï¼Œä¸»è¦æ˜¯å®šç¾©ç€è¦½å™¨å³ä¸Šè§’çš„å·¥å…·åˆ—è·³å‡ºè¦–çª—è¡Œç‚ºï¼Œä¸¦å®šç¾©ç‚º browser-action\nå› ç‚ºå³éµè¡Œç‚ºè·Ÿ popup è¡Œç‚ºé¡ä¼¼ï¼Œæ‰€ä»¥æˆ‘å°‡è¡Œç‚ºæ”¶æ•´æˆ util/handleShare.jsï¼Œéœ€æ³¨æ„åœ¨ background ä¸­è¦ä½¿ç”¨å…¶ä»– script å¿…é ˆå®£å‘Šåœ¨ manifest.json ä¸­ï¼›\n1 2 3 4 \u0026#34;background\u0026#34;: { \u0026#34;scripts\u0026#34;: [\u0026#34;util/handleShare.js\u0026#34;, \u0026#34;event.js\u0026#34;], \u0026#34;persistent\u0026#34;: true } è€Œåœ¨ popup page å‰‡ä»¥ \u0026lt;script src=\u0026quot;util/handleShare\u0026quot;\u0026gt;åŠ å…¥ html ä¸­å³å¯ã€‚\nå¦é–‹æ–°é ã€Popup script èˆ‡ Content script æºé€š ç¤¾ç¾¤åª’é«”åˆ†äº«å¿…é ˆå¦é–‹è©²ç¶²ç«™çš„æ–°é é¢ï¼ŒåŒæ™‚ç‚ºäº†å¯ä»¥è‡ªå‹•æŠŠåç™½é¸å–çš„æ–‡å­—è‡ªå‹•æ’å…¥ï¼Œåœ¨é–‹å•Ÿæ–°é ï¼Œé¦–å…ˆè¦è¨­æ³•å–å¾—æ–°é é¢çš„ Tabï¼Œä¹‹å¾Œè¦åŸ·è¡Œ content script\n1 2 3 4 5 6 7 8 9 10 11 12 13 // å…ˆå–å¾—æ‰€æœ‰çš„åˆ†é è³‡æ–™ï¼Œå¯ä»¥é€é tab çš„ url / title æ‰¾åˆ°æŒ‡å®šé é¢ chrome.tabs.query({ active: true }, function(tabs){}) // å¿…é ˆç¢ºä¿åˆ†é å·²ç¶“åŠ è¼‰å®Œæˆï¼Œé€™æ¨£ content script æ‰æœ‰ç”¨ chrome.tabs.onUpdated.addListener(function (tabId, info) { if (tabId == factoryTab.id \u0026amp;\u0026amp; info.status == \u0026#39;complete\u0026#39;) { // åœ¨è©²åˆ†é æ³¨å…¥ content script chrome.tabs.executeScript(factoryTab.id, { file: \u0026#34;content/share.js\u0026#34; }) .... ä¸Šé¢æœ‰å€‹å° tricky æ˜¯å¿…é ˆè¦ç­‰åˆ°æ–°åˆ†é åŠ è¼‰å®Œæˆæ‰å¯ä»¥åŸ·è¡Œ chrome.tabs.executeScript ï¼Œå¦å‰‡æœƒå‡ºç¾ tab is closed ä¹‹é¡çš„éŒ¯èª¤è¨Šæ¯!\nåœ¨è·¨ script å‚³è¼¸è³‡æ–™ä¸€æ¬¡æ€§å¯ä»¥ä½¿ç”¨sendMessage(tabId, message)/ chrome.runtime.onMessage.addListener((message, sender, sendResponse)=\u0026gt;{})Â å…¶é¤˜æ–¹å¼å¯ä»¥åœ¨æŸ¥è©¢æ–‡ä»¶ã€‚\nçµèª é–‹ç™¼ä¸€å€‹ç°¡å–®çš„ Chrome Extension è »æœ‰è¶£çš„ï¼Œä½†ä¹Ÿæ„å¤–ç™¼ç¾ Extension çš„å¨åŠ›æ¥µç‚ºå¼·å¤§ï¼Œå°¤å…¶æ˜¯å¯ä»¥æ³¨å…¥ content script é€™å¡Šï¼Œæ‰€ä»¥æœå°‹ä¸€ä¸‹ chrome store å¯ä»¥æ‰¾åˆ°ä¾‹å¦‚å¯†ç¢¼ç®¡ç†å·¥å…·ç­‰æ‡‰ç”¨ï¼Œçªç„¶è¦ºå¾—ä¸€é™£å®³æ€•å› ç‚ºæ•´å€‹ DOM éƒ½è¢«æ‘¸å…‰äº†ï¼Œç”šè‡³ cookie å†ä¸å°å¿ƒæˆæ¬Šå‡ºå»å¾Œä¹Ÿéƒ½å¯ä»¥è¢«è®€å–ï¼Œåœ¨å®‰è£æ’ä»¶ä¸Šå‹™å¿…å°å¿ƒå•Šï¼ å°¤å…¶æ˜¯æ²’æœ‰é–‹æºã€éå®˜æ–¹çš„æ’ä»¶æ›´éœ€è¦å°å¿ƒã€‚\nä¸éæˆ‘ä¸Šå‚³çš„æ’ä»¶è¢« Google èªå®šç‚º Spam ä¸çµ¦ä¸Šæ¶â€¦â€¦\n","date":"2018-05-15T09:56:14.414Z","permalink":"https://yuanchieh.page/posts/2018/2018-05-15-chrome-extension-%E9%96%8B%E7%99%BC%E5%88%86%E4%BA%AB/","title":"Chrome extension é–‹ç™¼åˆ†äº«"},{"content":"è‡³å¾çœ‹äº†ã€Šå¨›æ¨‚è‡³æ­»ã€‹é€™æœ¬æ›¸å¾Œï¼Œé–‹å§‹æ€è€ƒã€Œå¤–åœ¨ç’°å¢ƒèˆ‡å…§åœ¨åŸºå› å¦‚ä½•å½±éŸ¿äººé¡æ€ç¶­ã€é€™é¡å‹çš„è­°é¡Œ\nã€Šå¨›æ¨‚è‡³æ­»ã€‹å¤§è‡´ä¸Šæ˜¯åœ¨æè¿°äººé¡æ€è€ƒæ–¹å¼å—åˆ°ä¸åŒåª’ä»‹ï¼Œå°åˆ·å¼ç´™æœ¬èˆ‡é›»è¦–çš„å½±éŸ¿ï¼Œè€Œæœ‰ä¸åŒçš„è½‰è®Šï¼›\né›»è¦–æ™‚ä»£å……æ–¥è‘—å¤§é‡çš„è¨Šæ¯ï¼Œè¿«ä½¿äººå€‘æ€è€ƒé–‹å§‹è®ŠçŸ­ä¿ƒï¼Œåœ¨ç¶²è·¯ã€ç¤¾ç¾¤æ™‚ä»£é€™å€‹å½±éŸ¿è¶Šç™¼åŠ‡çƒˆï¼Œæ‰€ä»¥æ‰æœ‰äº†é‡‘é­šè…¦ä¸€è©\né †è‘—é€™å€‹è­°é¡Œï¼Œè¿‘ä¸‰é€±çœ‹äº†æ‰€è¬‚ åçƒæ‰˜é‚¦ç³»åˆ—ä¸‰éƒ¨æ›²\nã€Šæˆ‘å€‘ã€‹ã€Š1984ã€‹ã€Šç¾éº—æ–°ä¸–ç•Œã€‹ï¼Œæ‰€è¬‚åçƒæ‰˜é‚¦å³æ˜¯å°æ–¼å‚³çµ±çš„ç¾å¥½èˆ‡å¹¸ç¦æå‡ºå¼·çƒˆçš„è³ªç–‘ï¼Œä¸¦ä»¥è«·åˆºçš„æ–‡å­—ä¾†æ¢è¨äººå€‘è¿½æ±‚çš„å®Œç¾ç”Ÿæ´»ã€‚\nã€Šæˆ‘å€‘ã€‹ é€™æœ¬ä»¥ç¬¬ä¸€äººç¨±è¦–è§’ï¼Œç”¨çŸ­ç¯‡æ—¥è¨˜çš„æ–¹å¼æ¨å‹•åŠ‡æƒ…ï¼Œå¤§é«”ä¸Šæè¿°ä¸€å€‹å¤§ä¸€çµ±å¸åœ‹ï¼Œäººå€‘åªè¿½æ±‚ç†æ€§ã€ç›´ç·šã€å…¬å¼åŒ–çš„ç”Ÿæ´»ï¼Œæ¯å€‹å…¬æ°‘éƒ½æ˜¯ç‚ºäº†å¤§ä¸€çµ±å¸åœ‹è€Œå­˜åœ¨ï¼Œæ²’æœ‰å¤ªå¤šå€‹äººçš„æ€ç¶­ï¼›\næ•´å€‹å¸åœ‹æ˜¯ä»¥ç§‘æŠ€ç‚ºå°å‘ï¼Œä¸¦ç”¨ä¸€å€‹ç»ç’ƒç½©é™åˆ¶å¸åœ‹å±…æ°‘çš„ç§»å‹•ï¼Œç»ç’ƒç½©ä¹‹å¤–ä¿ç•™é‡ç”Ÿçš„å¢æ—ä»¥åŠéè‘—åŸå§‹ç”Ÿæ´»çš„é‡äººã€‚\nä¸»è§’æ˜¯å¸åœ‹ä¸­çš„é¦–å¸­é£›èˆ¹è¨­è¨ˆå¸«ï¼Œé£›èˆ¹è¨­è¨ˆç›®çš„æ˜¯ç‚ºäº†å°‡é€™ç¨®ç¾å¥½ç†æ€§çš„ç¤¾æœƒç†å¿µæ•£ä½ˆåˆ°å…¨å®‡å®™ï¼Œä¸»è§’ä¸€é–‹å§‹ä»¥æ­¤ç‚ºæ¦®ï¼Œæ·±ä¿¡äººæ´»è‘—å°±æ˜¯ç‚ºäº†å¤§ä¸€çµ±çš„å¸åœ‹è€Œå­˜åœ¨ï¼Œä¸è©²æœ‰å…¶ä»–å€‹äººçš„æƒ³æ³•ï¼›\nä½†å¾Œä¾†é‡ä¸Šäº†ä¸€ä½å¥³è§’ï¼Œå› ç‚ºæˆ€æ„›çš„è¡å‹•ï¼Œé–‹å§‹æœ‰äº†è‡ªå·±çš„æ€æƒ³ï¼Œè€Œæ€æƒ³æ˜¯ä¸€ç¨®ç½ªã€‚\næ•´æœ¬æ›¸èªªå¯¦åœ¨æˆ‘çœ‹èµ·ä¾†ä¹Ÿç•¥é¡¯å†—é•·èˆ‡æ²ˆæ‚¶ï¼Œå› ç‚ºå…¶å¯¦æ•…äº‹ç·šä¸è¤‡é›œã€è¦é—¡è¿°çš„é“ç†ä¹Ÿè »ç›´è§€ï¼Œä½œè€…èŠ±è »å¤šç« ç¯€åè¦†çš„æè¿°é¡ä¼¼çš„äº‹ä»¶ï¼Œåƒæ˜¯æ„›æƒ…ã€å€‹äººå›é€†æ€æƒ³çš„èŒèŠ½ã€ç¤¾æœƒå¤–åœ¨ç’°å¢ƒå¤§ä¸€çµ±è¦ç¯„é–“çš„æ‹‰æ‰¯ã€‚\nã€Š1984ã€‹ æç¹ªé«˜å£“çµ±æ²»çš„è»æ¬Šå¸åœ‹ï¼Œè€å¤§å“¥ç”¨å„ç¨®æ–¹å¼æ´—è…¦ã€æ”¹å¯«æ­·å²ï¼Œæ›¸ä¸­å¹¾å¥è©±æ·±åˆ»åˆ‡ä¸­è¦å®³\nã€Œèª°æ§åˆ¶éå»å°±æ§åˆ¶æœªä¾†ï¼Œèª°æ§åˆ¶ç¾åœ¨å°±æ§åˆ¶éå»ã€‚ã€\nä¸»è§’çš„å·¥ä½œä¾¿æ˜¯é…åˆé»¨çš„æ”¿ç­–ç«„æ”¹æ‰€æœ‰æ–‡æ›¸ç´€éŒ„ï¼Œä»Šå¹´ç”Ÿç”¢éƒ¨åªç”Ÿç”¢äº†å…©åƒé “ç³§é£Ÿæ²’æœ‰é”åˆ°æ”¿æ²»å£è™Ÿçš„å¢é‡50%ï¼Œæ²’é—œä¿‚æ”¹å»å¹´ç´€éŒ„å°±å¥½ï¼›\nç•¶æ‰€æœ‰æ–‡æ›¸ã€å ±ç´™éƒ½è¢«ç«„æ”¹ï¼Œå”¯ä¸€çš„çœŸç›¸åªç•™åœ¨ä½œè€…è…¦ä¸­ï¼Œä½†é€™çœŸç›¸å°±çœŸçš„æ˜¯ã€ŒçœŸç›¸ã€å—?!\nä¸»è§’å¾Œä¾†æ„›ä¸Šäº†ä¸€ä½å›é€†çš„é’æ˜¥æœŸå°‘å¥³(è‡³å°‘è§’è‰²æç¹ªèµ·ä¾†å¾ˆåƒ)ï¼Œåˆ°æœ€å¾Œå› ç‚ºæ„›æƒ…è€Œä»˜å‡ºä»£åƒ¹ï¼Œä¸»è§’ä¸€é–‹å§‹ä»¥ç‚ºä¸è«–è‚‰é«”å¦‚ä½•æŠ˜ç£¨ï¼Œåªè¦å¤ å …æŒå°±å¯ä»¥ä¿è­·å¿ƒä¸­çš„ä¸€æ–¹æ·¨åœŸï¼›\nä½†æ˜¯ç›£æ§å–®ä½é–‹å§‹ç”¨å„ç¨®é…·åˆ‘æŠ˜ç£¨ä¸»è§’çš„æ€æƒ³ï¼Œæœ€å¾Œç‹ ç‹ åœ°æŠŠæ„›æƒ…ä¹Ÿé€£æ ¹æ‹”èµ·ï¼Œä½œè€…æè¿°çš„ååˆ†å¯«å¯¦ï¼Œéå¸¸çš„é»‘æš—â€¦.\nã€Šç¾éº—æ–°ä¸–ç•Œã€‹ è·Ÿå‰å…©æœ¬æ›¸æè¿°æ–¹å¼æ°å¥½ç›¸åï¼Œä½†æ›´ä»¤äººæ¯›éª¨æ‚šç„¶ï¼›\næ›¸ä¸­æè¿°äººé¡ç”±åŸºå› åŸ¹é¤Šæ‰€æ‰¹æ¬¡è£½é€ ï¼Œåœ¨å‡ºç”Ÿæ™‚åŸºå› å°±å·²ç¶“æ±ºå®šå¥½ä½ çš„æ‰€æœ‰å¤–è§€ã€æ€æƒ³åŒ…å«ç¤¾ç¶“åœ°ä½ï¼Œå‡ºç”Ÿå¾Œæœ‰æ‰€è¬‚çš„ã€Œåˆ¶ç´„ã€ï¼Œé€éç¡çœ å­¸ç¿’æ³•ä¸æ–·æ´—è…¦ï¼Œä¾‹å¦‚èªª è¨å­ç´…è‰²ï¼Œåœ¨5â€“7æ­²æ¯å¤©æ™šä¸Šæ’­æ”¾5000æ¬¡ï¼Œè‡ªç„¶è€Œç„¶é•·å¤§å¾Œå·²ç¶“ç„¡æ³•æ–¹ä¾¿ç‚ºä»€éº¼æœƒè¨å­ç´…è‰²ï¼Œåªæœƒè¦ºå¾—ã€Œå¾ˆè‡ªç„¶å°±è©²è¨å­ç´…è‰²ã€\næ•´å€‹ä¸–ç•Œè¢«ç®¡æ²»è€…æ‰€è¦ç¯„ï¼Œæ•´é«”ç¤¾æœƒå®šæœŸæä¾›ã€Œç´¢éº»ã€ï¼Œä¸€ç¨®è¿·å¹»é¡ä¼¼æ–¼æ¯’å“ï¼Œå››è™•çš†æœ‰éŸ³æ¨‚ã€ä¸ç”¨ç…©æƒ±ç³§é£Ÿï¼Œæ²’æœ‰å‚·ç—›æ²’æœ‰è€åŒ–ï¼Œé€™ä¼¼ä¹å°±æ˜¯ã€Œç¾éº—çš„æ–°ä¸–ç•Œã€\nå¾Œä¾†æ•…äº‹æ¨æ¼”åˆ°é‡äººä¿ç•™å€ï¼Œé›™æ–¹çš„æ€æƒ³é–‹å§‹è¡çªï¼Œåˆ°åº•è¦ç—›è‹¦çš„è‹¦é›£é‚„æ˜¯ç¾å¥½çš„å’Œè«§?Â é‡äººä¸æ–·ç”¨èå£«æ¯”äºåŠ‡æœ¬çš„å°è©ä¾†è¡¨é”å€‹äººæ€æƒ³å°æ–¼çœŸå–„ç¾ã€è‹¦é›£çš„å …æŒç­‰å‚³çµ±ç¾å¾·ï¼Œä¾†è«·åˆºèˆ‡å°æŠ—æ–°ä¸–ç•Œä¸­çš„æ”¾è•©ã€åŠæ™‚è¡Œæ¨‚ã€è¢«è¦ç¯„å¥½å—åˆ°åˆ¶ç´„çš„ç¤¾æœƒã€‚\né€™å¹¾æœ¬æ›¸å»ºè­°åœ¨é¢¨å…‰æ˜åªšçš„æˆ¶å¤–çœ‹ï¼Œå› ç‚ºå¾ˆé»‘æš—XD\né€™å¹¾æœ¬æ›¸æç¹ªçš„ç¤¾æœƒéƒ½å¾ˆä¸åŒï¼Œä½†éå¸¸é©šäººçš„ä¸€è‡´æ€§å°±æ˜¯\n1. è¦–å€‹äººæ€æƒ³ç‚ºçŠ¯ç½ª\n2. å‰å¥ªæ„›æƒ…ï¼Œä½†æœ‰è¶£çš„å°±æ˜¯ä¸»è§’éƒ½æ˜¯é€éæ„›æƒ…æ‰¾åˆ°è‡ªæˆ‘çš„æ€æƒ³\n3. å»é™¤å®¶åº­ï¼Œå®Œå…¨å»é™¤è¦ªå­é–“çš„ç¾ˆçµ†\n4. æ‹’çµ•å€‹äººç¨è™•ï¼Œå¼·èª¿ç¤¾æœƒçš„å’Œè«§èˆ‡ä¸€è‡´\nä½†æˆ‘å–œæ­¡é€™ç¨®è«·åˆºçš„ç­†æ³•ï¼Œå› ç‚ºä»–å¯ä»¥æœ€å¤§ç¨‹åº¦çš„æ¿€ç™¼æˆ‘æƒ³æè¡›æ€æƒ³ã€è‡ªç”±ã€æ„›æƒ…ç­‰ï¼Œæ›¸ä¸­ç¤¾æœƒæ‰€æ’æ–¥æˆ–ç¦æ­¢çš„ä¸æ­£å¥½æ˜¯èº«è€Œç‚ºäººæœ€é‡è¦çš„å› å­å—?!\nåªæ˜¯çœŸçš„å¾ˆé»‘æš—ï¼Œå°¤å…¶æ˜¯ã€Š1984ã€‹æœ€å¾Œä¸€éƒ¨åˆ†â€¦. å°å¿ƒæœç”¨\nä¸‰æœ¬æ›¸çœ‹ä¾†ï¼Œæˆ‘å…¶å¯¦æœ€å–œæ­¡ã€Šç¾éº—æ–°ä¸–ç•Œã€‹ï¼Œå‰é™£å­æœ‰é‡åˆ°ä½ˆé“è€…åœ¨å‚³æ•™ï¼Œä»–å•æˆ‘ã€Œå¦‚æœå¯ä»¥åˆ°å¤©å ‚ç„¡æ†‚ç„¡æ…®ï¼Œæ²’æœ‰ç—›è‹¦ï¼Œä½ æ‡‰è©²ä¹Ÿæœƒæƒ³å»å§?ã€\né‚£æ™‚å€™æˆ‘æ„£ä½äº†å¿«30ç§’ï¼Œä»–åªå¥½è¨•è¨•åœ°èªªã€Œå°å˜›ï¼Œæ²’æœ‰äººå–œæ­¡åœ¨å‡¡é–“ç—›è‹¦çš„ç”Ÿæ´»â€¦. ã€\nç•¶æ™‚æˆ‘çŒ¶è±«çš„é»å°±æ˜¯ ä»€éº¼æ˜¯æ°¸ç”Ÿ? ä»€éº¼æ˜¯å¤©å ‚?Â ç„¡æ†‚ç„¡æ…®æ²’æœ‰è‹¦ç—›è½èµ·ä¾†å¾ˆå¥½ï¼Œä½†é€™æ¨£é‚„å­˜æ´»è‘—æ˜¯è¦å¹¹å˜›?! åˆæˆ–æ˜¯åœ¨é€™ç¨®ç‹€æ…‹ä¸‹æ€éº¼çŸ¥é“è‡ªå·±é‚„æ´»è‘—?!Â æœƒä¸æœƒå°±è®Šæˆæ˜¯ä¸€å€‹ç¾éº—æ–°ä¸–ç•Œ?!\né€™æˆ–è¨±å°±æ˜¯æˆ‘ç¾åœ¨æ²’æœ‰å®—æ•™ä¿¡ä»°çš„åŸå› ï¼Œåˆæˆ–æ˜¯ç¾åœ¨çš„è‡ªå·±æ²’æœ‰å¤ªå¤šè‹¦ç—›çš„ç¶“æ­·ï¼Œæ‰€ä»¥ä¸æœƒä¹Ÿä¸æƒ³å»æ€è€ƒé€™é¡çš„å•é¡Œï¼ŒåªçŸ¥é“ç¾åœ¨æ¯å¤©æ´»è‘—å¯ä»¥å·¥ä½œã€å¯ä»¥é‹å‹•ã€å¯ä»¥é–±è®€ã€å¯ä»¥æ€è€ƒå°±è »å……å¯¦çš„ï¼Œæˆ‘ä¹Ÿä¸æ˜¯æŠ–Mä¹Ÿä¸æƒ³ä¸€ç›´è™•æ–¼è‹¦ç—›çš„ç‹€æ…‹XD\nä½†å°±æ˜¯ä¸æœƒå»æƒ³éè‘—ç„¡æ†‚ç„¡æ…®çš„ç”Ÿæ´»ï¼Œå°±è¦ºå¾—å¾ˆå½†æ‰­å§\næˆ‘é‚„æ˜¯æä¸æ‡‚ä¿¡ä»°å®—æ•™ï¼Œåˆæˆ–æ˜¯å„æ–¹æ•™ç¾©ä¸­çš„ã€Œå¤©å ‚ã€ã€Œè¥¿æ–¹æ¥µæ¨‚ä¸–ç•Œã€åˆ°åº•æ˜¯æ€æ¨£çš„åœ°æ–¹? éˆé­‚è™•æ–¼é‚£ç¨®ç‹€æ…‹ä¸‹åˆå¯ä»¥å¹¹å˜›å‘¢? æ°¸ç”Ÿåˆ°åº•æ˜¯æ€æ¨£çš„ç‹€æ…‹?\næœ‰é»ä¸è§£ä½†ä¹Ÿæ²’æœ‰å¾ˆåœ¨æ„\nä¸Šå¤©çµ¦äº†ä¸€å‰¯ç‰Œï¼Œåä¸Šå°æ¡Œå°±ç›¡èˆˆçš„è³­åˆ°æœ€å¾Œå§\n* ä¹‹å¾Œæƒ³çœ‹ã€Šäººé¡å¤§æ­·å²ã€‹ã€Šäººé¡å¤§å‘½é‹ã€‹ã€Šæ§ç ²é‹¼éµèˆ‡ç´°èŒã€‹ï¼Œç”¨ä¸åŒçš„è§’åº¦ä¾†æ€è€ƒé€™å€‹è­°é¡Œ\n","date":"2018-05-06T02:11:33.686Z","permalink":"https://yuanchieh.page/posts/2018/2018-05-06-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97%E6%88%91%E5%80%911984%E7%BE%8E%E9%BA%97%E6%96%B0%E4%B8%96%E7%95%8C%E5%8F%8D%E7%83%8F%E6%89%98%E9%82%A6%E4%B8%89%E9%83%A8%E6%9B%B2/","title":"[é–±è®€å¿ƒå¾—]ã€Šæˆ‘å€‘ã€‹ã€ã€Š1984ã€‹ã€ã€Šç¾éº—æ–°ä¸–ç•Œã€‹åçƒæ‰˜é‚¦ä¸‰éƒ¨æ›²"},{"content":"MySQLÂ :: MySQL 5.7 Reference ManualÂ :: 13.1.18.6 Using FOREIGN KEY Constraints\næ•´ç†é–±è®€MySQL v5.7çš„FOREIGN KEY Constraintsæ–‡ä»¶ï¼Œä¸¦é‡å°ç´°ç¯€åœ¨DB FiddleåŠ ä¸Šç¯„ä¾‹ï¼Œå¾ŒçºŒFOREIGN KEYç¸®å¯«FKã€‚\nFKé™åˆ¶å¯ä¿è­‰è³‡æ–™é—œè¯é–“çš„å®Œæ•´æ€§ï¼Œé—œä¿‚æ˜¯å»ºç«‹child TableæŒ‡å®šè¦èˆ‡ parent Tableçš„æŸæ¬„ä½å»ºç«‹é—œè¯ï¼ŒFOREIGN KEY å¿…é ˆåœ¨ child Tableä¸­æŒ‡å®šï¼Œchild / parentéœ€ä½¿ç”¨ç›¸åŒçš„DBå¼•æ“ä¸”ä¸å¯ç‚º TEMPORARY Tableã€‚\nåœ¨å®£å‘Šèªæ³•ä¸Šï¼Œå¯ä»¥é€é [CONSTRAINT symbol ] æŒ‡å®šé€™ç­†é—œè¯é™åˆ¶çš„åç¨±ï¼Œä½†é ˆæ³¨æ„åç¨±ä¸å¯é‡è¤‡å¦å‰‡æœƒå‡ºéŒ¯ï¼›\nå¦‚æœæ“”å¿ƒå°±ä¸è¦å®£å‘Š CONSTRAINTè®“ DB Engineè‡ªå‹•ç”¢ç”Ÿ\nDB Fiddle - SQL Database Playground\nFOREIGN KEYÂ è³‡æ–™å‹åˆ¥ æœ‰è¶£çš„æ˜¯ï¼ŒMySQLæ–‡ä»¶åªèªªparentä¸­çš„è³‡æ–™æ¬„ä½èˆ‡child FOREIGN KEYæ¬„ä½çš„è³‡æ–™å‹åˆ¥å¿…é ˆé¡ä¼¼è€Œéä¸€è‡´ï¼Œåˆå¯ç´°åˆ†æˆä¸‰é¡\nintegerï¼š\n_Size \u0026amp; Signå¿…é ˆç›¸åŒï¼Œä¾‹å¦‚èªª TINYINT / INT å°±æ˜¯ä¸ä¸€æ¨£çš„ stringï¼š\né•·åº¦ä¸ä¸€å®šè¦ç›¸åŒï¼Œå› ç‚ºä¸è«–æ˜¯parenté•·æˆ–æ˜¯childé•·ï¼ŒFOREIGN KEYåœ¨æ’å…¥æ™‚å¿…é ˆparentå­˜åœ¨è©²ç­†è³‡æ–™ï¼›\næ‰€ä»¥åœ¨æ’å…¥ä¸å¯è¶…éæ¬„ä½é•·åº¦èˆ‡è³‡æ–™å¿…é ˆå­˜åœ¨çš„å…©å€‹æ¢ä»¶ä¸‹ï¼Œå­—ä¸²é•·åº¦çš„é™åˆ¶å°±ä¸æ˜¯é€™éº¼å¿…è¦ å°æ–¼éä½å…ƒå‹åˆ¥çš„å­—ä¸²ï¼Œcharacter set å’Œ collationå¿…é ˆç›¸åŒ FOREIGN KEYÂ é™åˆ¶ é™¤äº†ä¸Šè¿°çš„è³‡æ–™å‹åˆ¥é™åˆ¶å¤–ï¼ŒMySQLç‚ºäº†æœå°‹ä¸Šé¿å… full table scan\nparent çš„æ¬„ä½å¿…é ˆæ˜¯ã€ŒæŸIndexä¸­çš„ç¬¬ä¸€æ¬„ä½ã€ï¼Œä¾‹å¦‚ index(id) / index(id, uid,Â â€¦.)ï¼Œå› ç‚ºMySQLçš„Indexé †åºæ˜¯ç”±å·¦è‡³å³ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤šæ¬„ä½Indexåªè¦è©²æ¬„ä½æ˜¯åœ¨ç¬¬ä¸€é †ä½ä¹Ÿå¯ä»¥ç•¶ä½œå»ºç«‹ FKçš„æ¬„ä½ã€‚\nå‡è¨­ä¸ç¬¦åˆæ¢ä»¶ï¼Œæœƒç›´æ¥å‡ºéŒ¯ç„¡æ³•å»ºç«‹child Tableã€‚ child çš„FKæ¬„ä½å¿…é ˆæ˜¯ã€ŒæŸIndexä¸­çš„ç¬¬ä¸€æ¬„ä½ã€ï¼Œå¦‚æœæ²’æœ‰æœƒè‡ªå‹•å‰µå»ºã€‚ FKå¯ä»¥æ˜¯å¤šæ¬„ä½ï¼Œä½†åŒæ¨£è¦ç¬¦åˆã€ŒæŸIndexä¸­çš„å‰é¢é †ä½ã€ åˆå› ç‚ºFKå¿…é ˆå»ºç«‹Indexï¼Œæ‰€ä»¥åƒ TEXT / BLOB å°±ä¸å¯èƒ½æ˜¯ FKé¸é …ã€‚ é—œè¯æ“ä½œ åœ¨å®šç¾©FKæ™‚å¯ä»¥æŒ‡å®šé—œè¯æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¦‚æœ parentçš„å°æ‡‰FKæ¬„ä½ç™¼ç”Ÿæ”¹è®Š(UPDATE / DELETE)æ™‚ child FKæ¬„ä½è©²æ€éº¼æ‡‰å°ï¼Œç¸½å…±æœ‰å¹¾ç¨®å®šç¾©ï¼š\nCASCADE:\nå¦‚æœæ˜¯ parentç´€éŒ„è¢«åˆªé™¤äº†ï¼Œé‚£å°æ‡‰FKçš„chlidç´€éŒ„ä¹Ÿä¸€ä½µåˆªé™¤ï¼›\nå¦‚æœæ˜¯ parent FKæ›´æ–°äº†æ–°å€¼ï¼Œå‰‡child å°æ‡‰çš„FKæœƒæ›´æ–°ã€‚ SET NULL:\nåˆªé™¤æ›´æ–° parentéƒ½æœƒå°è‡´ childçš„ FKç´€éŒ„è¨­ç‚º Nullï¼Œå¦‚æœè¨­å®šç‚º SET NULL è¨˜å¾— ã€Œchild FK æ¬„ä½ä¸è¦åŠ  NOT NULL æœƒè¡çªã€ã€‚ RESTRICT:\nåªè¦childä¸­æœ‰åŒ…å«è©² FKå€¼ï¼Œå®Œå…¨ä¸èƒ½åˆªé™¤è©²ç­†parentæˆ–æ›´æ–° parentçš„FKæ¬„ä½ã€‚ NO ACTION:Â åœ¨MySQLç­‰åŒæ–¼ RESTRICTã€‚ SET DEFAULT:\nåœ¨MySQL InnoDBä¸­ä¸æ”¯æ´ã€‚ DB Fiddle - SQL Database Playground\nå¢åŠ æˆ–åˆªé™¤FK å¯ä»¥é€é ALTER TABLE ä¾†å¢åŠ FKï¼Œé€é DROP TABLE æŒ‡å®šåˆªé™¤FKï¼Œä½†å¦‚æœç•¶åˆæ²’æœ‰ä½¿ç”¨ CONSTRAINT å®£å‘ŠFKçš„åç¨±ï¼Œå¯ä»¥ç”¨ SHOW CREATE TABLE å–å¾—Tableè³‡æ–™ï¼Œå³å¯å¾—çŸ¥ç³»çµ±è‡ªå‹•å‰µå»ºçš„FKåç¨±ã€‚\næš«æ™‚é—œé–‰ FK CONSTRAITS ç•¶ä½¿ç”¨ mysqldump æ™‚ï¼Œç‚ºäº†æ–¹ä¾¿é‡å»ºè³‡æ–™MySQLæœƒè‡ªå‹•å…ˆé—œé–‰FK CONSTRAITSçš„é™åˆ¶\nmysql\u0026gt; SET foreign_key_checks = 0;\nmysql\u0026gt; SOURCE dump_file_name;\nmysql\u0026gt; SET foreign_key_checks = 1;\nä½†å¿…é ˆæ³¨æ„ï¼Œå³ä½¿é—œé–‰äº†åœ¨å‰µå»º FKæ™‚ä»ç„¶ä¸å¯ä»¥é•èƒŒ FKè³‡æ–™å‹åˆ¥çš„é©—è­‰ï¼Œä¸ç„¶ä¸€æ¨£æœƒå™´éŒ¯èª¤!\né—œé–‰é™åˆ¶å¾Œåˆªé™¤/æ›´æ–°éƒ½ä¸æœƒæª¢æŸ¥ parentæ˜¯å¦å­˜åœ¨å°æ‡‰è³‡æ–™ï¼Œå³ä½¿é‡æ–°é–‹å•Ÿé™åˆ¶æª¢æŸ¥ä¹Ÿä¸æœƒå›æº¯ï¼Œæ‰€ä»¥å‹™å¿…å°å¿ƒã€‚\n","date":"2018-04-24T10:16:08.524Z","permalink":"https://yuanchieh.page/posts/2018/2018-04-24-mysql-foreign-key-constraints-%E6%95%B4%E7%90%86/","title":"MySQL FOREIGN KEY Constraints æ•´ç†"},{"content":"ä¸Šé›†:Designing Data-Intensive Applications ä¸Š\néš¨è‘—è»Ÿé«”æ‡‰ç”¨ç¨‹å¼çš„ç™¼å±•ï¼Œæ‡‰ç”¨çš„ä¾·é™(bottleneck)å¾CPUç§»è½‰è‡³è³‡æ–™çš„è™•ç†ï¼Œè³‡æ–™çš„å·¨é‡ã€è¤‡é›œæ€§èˆ‡æ”¹è®Šçš„é€Ÿåº¦è®Šæˆæ£˜æ‰‹çš„å•é¡Œï¼Œä¹Ÿå°±æ˜¯ä½œè€…æ‰€å®šç¾©çš„ã€ŒData-Intensiveã€è³‡æ–™å¯†é›†çš„æ‡‰ç”¨ç¨‹å¼ã€‚\nç¬¬äºŒéƒ¨åˆ†ä¸»è¦æ¢è¨åˆ†æ•£å¼å„²å­˜è³‡æ–™æœƒé‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•ï¼Œåˆ†æ•£å¼ç³»çµ±æœ‰å¹¾å¤§å„ªé»ï¼š\nScalabilityï¼š\nå¤§å¹…å¢åŠ ç³»çµ±çš„ä¹˜è¼‰èƒ½åŠ› Fault Tolerance / High Availability(HA)ï¼š\nç•¶å–®ä¸€ç¯€é»å¤±æ•ˆæ™‚ï¼Œä¸å½±éŸ¿ç³»çµ±çš„é‹ä½œ Latencyï¼š\nå¦‚æœç”¨æˆ¶æ•£ä½ˆå…¨çƒï¼Œå¯ä»¥é€éå¤šç¯€é»éƒ¨ç½²ä½¿ç”¨æˆ¶åœ°ç†ä½ç½®æœ€è¿‘çš„è³‡æ–™ä¸­å¿ƒï¼Œé™ä½ç¶²è·¯å»¶é² Ch5. Replication Replication ä¹Ÿå°±æ˜¯å°‡ç›¸åŒçš„è³‡æ–™é€éç¶²è·¯è¤‡è£½åˆ°å¤šå°æ©Ÿå™¨ä¸Šï¼Œæœ‰å¹¾å€‹å¥½è™•\n1. è®“ç”¨æˆ¶å¯ä»¥å–å¾—åœ°ç†ä½ç½®æœ€è¿‘çš„è³‡æ–™\n2. å³ä½¿éƒ¨åˆ†æ©Ÿå™¨å¤±æ•ˆï¼Œç³»çµ±ä¹Ÿå¯ä»¥ç¹¼çºŒæ­£å¸¸é‹ä½œ\n3. å¢åŠ æ©Ÿå™¨ è®€ çš„è² è¼‰èƒ½åŠ›\nåœ¨æ¶æ§‹ä¸Šæœ‰ä¸‰ç¨® Single-Master / Multi-Master / Leaderlessï¼ŒReplicationå¸¶ä¾†è¨±å¤šå¥½è™•ï¼Œä½†æ˜¯åœ¨ç³»çµ±å¯¦ä½œé¢æœƒæœ‰å–å¤šçš„è¡¡é‡ï¼Œä¾‹å¦‚èªªè¤‡æœ¬æ˜¯è¦åŒæ­¥é‚„æ˜¯éåŒæ­¥ã€å¦‚ä½•è™•ç†éŒ¯èª¤çš„è¤‡æœ¬ç¯€é»ã€æœ€çµ‚ä¸€è‡´æ€§çš„æ›²è§£ã€read-your-writesã€monotonic-readsä¿è­‰ç­‰å•é¡Œã€‚\nLeaders and Followers æ¯å€‹æ“æœ‰è³‡æ–™åº«å‚™ä»½è³‡æ–™çš„ç¯€é»ç¨±ç‚º replicaï¼Œç‚ºäº†è®“æ¯ç­†å¯«å…¥éƒ½å¯ä»¥è¢«åŒæ­¥åˆ°replicaä¸Šï¼Œå¸¸ç”¨çš„æ¶æ§‹ç‚º leader-baseï¼Œä¹Ÿå°±æ˜¯Leader è² è²¬è³‡æ–™çš„å¯«å…¥ï¼Œä¸¦å°‡è³‡æ–™åŒæ­¥åˆ° Followerä¸­ä¿æŒåŒæ­¥ã€‚\né€™ç¨®replicationæ¶æ§‹è¢«å»£æ³›ä½¿ç”¨ï¼ŒåŒ…å«Oracle / PostgreSQL / MySQL / Kafkaç­‰ã€‚\nSync andÂ Async ç•¶Leaderæ¥æ”¶åˆ°å¯«å…¥ï¼Œé€™æ™‚å€™è¦æ±ºå®šèªªæ˜¯å¦ç­‰åˆ°åŒæ­¥å®Œå…¨éƒ¨çš„ followeræ‰å›å‚³æˆåŠŸï¼Œå¦‚æœæ˜¯å…¨éƒ¨ followerèªªæˆåŠŸæ‰æˆåŠŸä¾¿æ˜¯ Syncï¼Œè‹¥éå‰‡ Asyncï¼Œä¹Ÿå¯ä»¥è¨­å®šè¶…éæŸæ•¸é‡ follower è®Šæˆ Semi-Asyncï¼›\nSyncå¥½è™•æ˜¯ç¢ºä¿followeréƒ½æ“æœ‰æœ€æ–°çš„è³‡æ–™ï¼Œé¿å…ç”¨æˆ¶åœ¨followerè®€å–åˆ°éæœŸè³‡æ–™ï¼Œä½†ç¼ºé»å°±æ˜¯å¦‚æœä¸€å€‹ followerå¡ä½äº†å°±æœƒé˜»æ“‹æ•´å€‹ç³»çµ±é‹ä½œï¼Œç³»çµ±å®¹éŒ¯èƒ½åŠ›å°±å¤§å¹…ä¸‹é™ï¼›\nAsyncå¥½å£è™•å‰‡å‰›å¥½ç›¸æ³•ï¼Œå¯«å…¥å›æ‡‰é€Ÿåº¦å¿«ï¼Œç³»çµ±å®¹éŒ¯å¥½ä½†ç”¨æˆ¶å¯èƒ½æœƒè®€å–åˆ°éæœŸçš„è³‡æ–™ã€‚\né€šå¸¸ä¾†èªªLeader-baseç³»çµ±éƒ½æ˜¯ä»¥Asyncç‚ºä¸»ï¼Œå› ç‚ºè®€å–éæœŸè³‡æ–™é€™é»å¾ŒçºŒæœ‰å…¶ä»–æ–¹å¼å¯ä»¥å½Œè£œã€‚\nHandle NodeÂ Outages ç•¶ç¯€é»å‡ºéŒ¯è¦é‡æ–°æ¢å¾©æ™‚ï¼Œæœƒæœ‰ä¸åŒçš„ç‹€æ³ï¼Œåˆå¯æ‹†æˆ Leader / Followerä¾†è™•ç†\nFollowerå‡ºéŒ¯è¦æ¢å¾©æˆ–æ˜¯åŠ å…¥æ–°ç¯€é»æ¯”è¼ƒå®¹æ˜“ï¼Œåªè¦è³‡æ–™è¨˜éŒ„æœ‰è¿½ä¸ŠLeaderæœ€æ–°è³‡æ–™å³å¯\nä½†æ˜¯Leaderå‡ºéŒ¯å°±éå¸¸éº»ç…©ï¼Œå¿…é ˆè¦å…ˆ åˆ¤å®šLeaderæ­»äº¡(é€šå¸¸é€éTimeout) -\u0026gt; é¸å‡ºæ–°çš„Leader -\u0026gt; æ•´å€‹ç³»çµ±æ‰¿èªæ–°çš„Leaderï¼Œä¸¦å°‡å¯«å…¥è«‹æ±‚è½‰å°åˆ°æ–°çš„Leaderä¸Šï¼Œé€™è£¡æœƒæœ‰å¹¾å€‹å®¹æ˜“å‡ºéŒ¯çš„åœ°æ–¹\nä¾‹å¦‚èªª èˆŠçš„Leaderå¦‚æœæ˜¯æ¡ç”¨Asyncï¼Œæœ‰å¯èƒ½æœƒæœ‰éƒ¨åˆ†å¯«å…¥å°šæœªåŒæ­¥åˆ°å‚™ä»½ä¸­æ‰€ä»¥æœƒéºå¤±ï¼Œåœ¨Githubæ¡ç”¨MySQLæ¡ˆä¾‹ä¸­å°±ç™¼ç”Ÿéæ‰è³‡æ–™çµæœ Primary Keyé‡è¤‡çš„ç¾è±¡ï¼›\nåˆæˆ–æ˜¯ç¨‹å¼æ²’è¨­è¨ˆå¥½ï¼Œæ„å¤–é¸å‡ºå¤šå€‹Leaderï¼Œç”¢ç”Ÿäººæ ¼åˆ†è£‚(Split brain)ï¼›\nTimeoutè¨­å®šä¹Ÿå¾ˆé‡è¦ï¼Œå¤ªçŸ­æœƒå°è‡´ç¶²è·¯æ³¢å‹•å°±é€ æˆä¸å¿…è¦çš„Leaderåˆ‡æ›ï¼Œå¤ªé•·å‰‡éºå¤±çš„è³‡æ–™å¯èƒ½æœƒå¾ˆå¤šï¼Œé€™éƒ¨åˆ†å¾ˆéº»ç…©ï¼›\nåŸºæ–¼é€™äº›ç†ç”±ï¼Œä½œè€…æåˆ°ç¾åœ¨æœ‰è »å¤šå…¬å¸éƒ½æ¡ç”¨äººå·¥è™•ç†çš„æ–¹å¼ã€‚\nImplementation of Replication Logs Statement-based replication\næœ€ç°¡å–®çš„æ–¹å¼æ˜¯ç›´æ¥å°‡æ¯ç­†å¯«å…¥éƒ½passåˆ° replicaä¸Šï¼Œä½†é€™æœƒæœ‰å¹¾å€‹å£è™•ï¼Œå¦‚ NOW() / RAND()ç­‰å‡½å¼æœƒå› ç‚ºåŸ·è¡Œçš„æ™‚å€™å€¼è€Œæœ‰æ‰€ä¸åŒã€Auto-Incrementä¹Ÿæœƒæœ‰æ‰€å·®ç•°ï¼Œæ­¤å¤–é‚„å¿…é ˆä¿è­‰è¤‡è£½çš„éç¨‹å¯«å…¥è³‡æ–™é †åºå¿…é ˆç›¸åŒã€‚ Write-ahead log (WAL) shipping\nå°‡WALçš„è³‡æ–™ç›´æ¥è¤‡è£½åˆ°replicaå°±ä¸æœƒæœ‰ä¸Šè¿°çš„å•é¡Œï¼Œä½†ç¼ºé»æ˜¯logç›¸ç•¶åº•å±¤ï¼Œä¹Ÿå°±æ˜¯æœƒè·Ÿç³»çµ±çš„å„²å­˜å¼•æ“åµŒå¥—å¾ˆæ·±ï¼Œè·¨ç³»çµ±ä¸æ˜“ã€‚ Logical (row-based) log replication Problems with Replication Lag Reading Your Own Writes\nç•¶ç”¨æˆ¶æ›´æ–°è³‡æ–™åˆ°Leaderä¸Šï¼Œå¦‚æœè©²ç”¨æˆ¶é¦¬ä¸Šéœ€è¦è®€å–è©²ç­†è³‡æ–™ï¼Œå¯èƒ½Followeré‚„æ²’æœ‰æ”¶åˆ°è¤‡è£½å›å‚³äº†éæœŸçš„è³‡æ–™ï¼›\nè§£æ±ºæ–¹æ³•æœ‰Â é€éæ‡‰ç”¨ç¨‹å¼è¿½è¹¤æ™‚é–“ï¼Œç•¶åœ¨æ›´æ–°å¾Œçš„ä¸€å®šæ™‚é–“å…§å¾Leaderè®€å–è³‡æ–™ã€\nç”¨æˆ¶ç´€éŒ„æ›´æ–°è³‡æ–™çš„æ™‚é–“ï¼Œç”±è³‡æ–™åº«ç¢ºä¿å¾replicaå–å‡ºæ­£ç¢ºçš„è³‡æ–™ Monotonic Reads\nç•¶ç”¨æˆ¶å¾å¤šå€‹replicaè®€å–è³‡æ–™ï¼Œå¯èƒ½æŸäº›replicaåŒæ­¥æ¯”è¼ƒæ…¢å°è‡´ç”¨æˆ¶è®€å–å¤šæ¬¡è³‡æ–™å»ä¸åŒï¼›\nå¯ä»¥ç¶å®šç”¨æˆ¶åœ¨åŒä¸€å€‹replicaè®€å–è³‡æ–™ï¼Œé¿å…ä¸ä¸€è‡´çš„è³‡æ–™ç‹€æ³å‡ºç¾ã€‚ Consistent Prefix Reads\nåŒæ¨£æ˜¯å› ç‚ºreplicaåŒæ­¥æœ‰æ™‚é–“å·®ï¼Œç”¨æˆ¶å¯èƒ½æœƒè®€åˆ°é †åºéŒ¯äº‚çš„è³‡æ–™ï¼Œä¾‹å¦‚å•é¡Œå‹¢å¿…åœ¨ç­”æ¡ˆä¹‹å‰å‡ºç¾(æœ‰å•é¡Œæ‰èƒ½æœ‰å›ç­”) Multi-Leader Replication å¤šLeaderçš„æ¶æ§‹ç³»çµ±å®¹éŒ¯æ€§æ›´å¥½ã€å¯«å…¥çš„æ€§èƒ½ä¹Ÿå¯ä»¥ææ˜‡ï¼Œä½†ç¼ºé»æ˜¯è³‡æ–™è¡çªçš„æƒ…æ³æœƒå¾ˆå¤šï¼Œç•¶ç™¼ç”Ÿè¡çªæ™‚å¾ˆå¤šæ™‚å€™å¿…é ˆç”±æ‡‰ç”¨ç¨‹å¼ä¾†è§£æ±ºã€‚\nLeaderless Replication å¯«å…¥å’Œè®€å–éƒ½ä¸€æ¬¡ä½¿ç”¨å¤šå€‹ç¯€é»ï¼Œé€éé‡ä¾†ä¿è­‰è³‡æ–™çš„æ­£ç¢ºæ€§èˆ‡ç³»çµ±å®¹éŒ¯æ€§ï¼Œä¾‹å¦‚ç¸½å…±æœ‰5å€‹node(n)ï¼Œåªè¦æˆ‘å€‘å¯ä»¥å¯«å…¥3å€‹ä»¥ä¸Šç¯€é»(w)èˆ‡è®€å–æ™‚è®€åˆ°3å€‹ç¯€é»ä»¥ä¸Š(r)ï¼Œåœ¨ç¬¦åˆ w + r \u0026gt; nçš„æƒ…æ³ä¸‹ï¼Œå°±å¯ä»¥ä¿è­‰æœƒè®€å–åˆ°æœ€æ–°çš„è³‡æ–™ï¼Œæ­¤æ™‚ç³»çµ±å¯ä»¥å®¹å¿ n-w å€‹ç¯€é»å¤±æ•ˆã€‚\nhttps://tech.liuchao.me/2017/12/ddia-5/\nCh6. Partition Partitionåˆ†ç‰‡ä¸»è¦æ˜¯æå‡ç³»çµ±çš„Scalabilityï¼Œç•¶å¤§é‡çš„è³‡æ–™å¯ä»¥è¢«å¹³å‡åˆ†æ•£åˆ°ç¯€é»ä¸Šï¼Œå¯«å…¥å’Œè®€å–ã€Œç†è«–ä¸Šã€å°±å¯ä»¥éš¨è‘—ç¯€é»æ•¸æˆç·šæ€§æˆé•·ï¼›\nåœ¨å¯¦ä½œä¸Šï¼ŒPartitionå¸¸èˆ‡Replicationåšæ­é…ï¼Œå°‡è³‡æ–™åˆ†ç‰‡ä¸¦è¤‡è£½åˆ°å…¶ä»–ç¯€é»ä¸Šå¢åŠ å®¹éŒ¯ç©ºé–“\nhttps://tech.liuchao.me/2017/12/ddia-6/\næœ‰å€‹è‰¯å¥½çš„è³‡æ–™åˆ†ç‰‡æ©Ÿåˆ¶å¾ˆé‡è¦ï¼Œå¦‚æœåˆ†ç‰‡çš„æ–¹å¼ä¸å¤ è™Ÿï¼Œå¦‚é‡ä¸Š hot-keyç”¢ç”Ÿæ­ªæ–œskewedï¼Œå°è‡´è³‡æ–™ä¸å¹³å‡åˆ†æ•£åˆ°ç¯€é»ä¸Šï¼Œæœƒå°è‡´ç³»çµ±çš„æ€§èƒ½ç„¡æ³•å¾—åˆ°é¡¯è‘—çš„æå‡ï¼Œä»¥ä¸‹æœ‰å…©ç¨®å¸¸è¦‹çš„åˆ†ç‰‡æ©Ÿåˆ¶\nPartitioning by KeyÂ Range ä¸€ç¨®å¸¸è¦‹çš„åšæ³•æ˜¯å°‡ Keyæ’åºä¸¦å°‡æŸé€£çºŒæ®µçš„Keyåˆ†ç‰‡ï¼Œé€™ç¨®åšæ³•å¥½è™•æ˜¯ç°¡å–®å¯¦ä½œã€å¦‚æœè¦ç¯„åœæœå°‹è³‡æ–™å¾ˆæ–¹ä¾¿ï¼›\nç¼ºé»æ˜¯å®¹æ˜“æœƒæœ‰ hot-keyçš„å•é¡Œã€‚\næ‰€ä»¥åœ¨å¥—ç”¨ä¸Šéœ€è¦ç‰¹åˆ¥æ³¨æ„æ‡‰ç”¨ç¨‹å¼æœ¬èº«çš„è³‡æ–™Keyç‰¹æ€§ï¼Œä¾‹å¦‚èªªæ„Ÿæ¸¬å™¨æ”¶é›†ç³»çµ±ï¼Œæ¡ç”¨ timestamp ç•¶ä½œkeyå¯ä»¥ä½¿å¾ŒçºŒæ—¥æœŸç¯„åœæŸ¥è©¢éå¸¸å®¹æ˜“ï¼Œä½†ç¼ºé»æ˜¯ç•¶å¤©çš„å¯«å…¥éƒ½æœƒé›†ä¸­åœ¨åŒä¸€å€‹partitionä¸Šï¼›\nå¯ä»¥è€ƒæ…®æ”¹æˆç”¨ æ„Ÿæ¸¬å™¨ç·¨è™Ÿï¼Œé€™æ¨£å¯«å…¥å°±å¯ä»¥å¹³å‡åˆ†æ•£ï¼Œä½†ç›¸å°å°±è®Šæˆç¯„åœè®€å–æ¯”è¼ƒéº»ç…©ã€‚\nPartitioning by Hash ofÂ Key å¯ä»¥é€é hash functionå°‡keyè½‰æˆå¯å¹³å‡åˆ†æ•£çš„é›œæ¹Šå€¼ï¼Œå¥½è™•æ˜¯å¯«å…¥å¯ä»¥æ›´å¹³å‡åˆ†æ•£ï¼Œä½†ç¼ºé»å°±æ˜¯å¤±å»äº†ç¯„åœæœå°‹ï¼›\nCassandraå˜—è©¦é€éçµ„åˆKeyä¾†èåˆä¸Šé¢å…©ç¨®æ–¹å¼ï¼ŒKeyçš„å‰åŠæ®µç”¨Hashæ±ºå®špartitionä½ç½®ï¼Œpartitionä¸­å‰‡ä¾ç…§Keyçš„å¾ŒåŠæ®µæ’åºå¢å¼·ç¯„åœæœå°‹ï¼›\nä¾‹å¦‚èªª(user_id, update_timestamp)ï¼Œé€éuser_idåˆ†æ•£ç”¨æˆ¶çš„è³‡æ–™ï¼Œä½†å¦‚æœæœ‰éœ€è¦å–å¾—æŸç”¨æˆ¶çš„ç¯„åœè³‡æ–™æ›´æ–°å°±å¯ä»¥ç”¨update_timestampã€‚\nPartitioning and Secondary Indexes å…ˆå‰æçš„æ˜¯é€é Primary Keyï¼Œä½†å¦‚æœè¦æŸ¥è©¢ Secondary Keyå°±æœƒé‡åˆ°ä¸åŒçš„å•é¡Œï¼Œä¾‹å¦‚èªª æ±½è»Šè³‡æ–™æ˜¯ {carIdÂ , nameÂ , color}ç­‰ï¼Œä¸»éµæ˜¯carIdä¸¦ä¾æ­¤ä¾†åˆ†ç‰‡ï¼Œä½†å¦‚æœç”¨æˆ¶è¦æŸ¥è©¢ color = â€˜redâ€™çš„è»Šå­å°±éœ€è¦å¦å¤–è™•ç†\nPartitioning Secondary Indexes byÂ Document åœ¨å€‹åˆ¥partitionä¸­è‡ªè¡Œç¶­è­·å„è‡ªè³‡æ–™çš„ Secondary index tableï¼Œæ‰€ä»¥ç”¨æˆ¶çš„è®€å–è«‹æ±‚éœ€è¦é€åˆ°æ¯å€‹partitionä¸­ä¸¦æ•´åˆï¼Œä¹Ÿå°±æ˜¯ scatter /gatherã€‚\nç¼ºé»å°±æ˜¯è®€å–æ•ˆç‡å¾ˆå·®ï¼Œå› ç‚ºå¯èƒ½æŸäº›partitionå›å¾©æ¯”è¼ƒæ…¢æ•´å€‹è«‹æ±‚å°±æœƒè¢«å¡ä½ã€‚\nhttps://tech.liuchao.me/2017/12/ddia-6/\nPartitioning Secondary Indexes byÂ Term èˆ‡å…¶å€‹åˆ¥partitionåˆ†åˆ¥ç¶­è­·Secondary index(local)ï¼Œå¯ä»¥å°‡ç›¸åŒçš„Secondary indexç´€éŒ„çµ±ä¸€å„²å­˜åœ¨æŸç‰¹å®špartitionä¸­ï¼Œé€éè®€å–è©²ç´€éŒ„ï¼Œå†å»æ‰€æœ‰ç´€éŒ„æ‰€åœ¨çš„partitionè®€å–è³‡æ–™å³å¯ã€‚\nè‡³æ–¼è©²ç­† Secondary indexè¦è¨˜éŒ„åœ¨å“ªå¯ä»¥é€éå‰è¿°çš„å…©ç¨®æ–¹å¼åˆ†æ•£åˆ°ä¸åŒnodeä¸Šã€‚\nhttps://tech.liuchao.me/2017/12/ddia-6/\né€™ç¨®æ–¹å¼æå‡è®€å–çš„æ•ˆèƒ½ï¼Œä½†ç¼ºé»æ˜¯å¯«å…¥è®Šå¾—ååˆ†è¤‡é›œï¼Œä¿®æ”¹å–®ä¸€ç­†è³‡æ–™éœ€è¦åŒæ­¥æ›´æ–°ä¸åŒpartitionä¸­çš„ Secondary Indexï¼Œé€™åœ¨åˆ†æ•£å¼ä¸­æœƒæœ‰å¾ˆå¤šéš±è—çš„å•é¡Œã€‚\nRebalancing Partitions å¦‚æœç³»çµ±é™„è¼‰å¢åŠ ï¼Œå¯èƒ½æœƒéœ€è¦å¢åŠ  partitionçš„æ©Ÿå™¨æˆ–æ˜¯ç§»é™¤å‡ºéŒ¯çš„æ©Ÿå™¨ç­‰ï¼Œé€™æ™‚å€™æœƒéœ€è¦é‡æ–°èª¿æ•´partitionï¼Œå°‡è³‡æ–™é‡æ–°å¹³è¡¡åˆ°æ‰€æœ‰æ©Ÿå™¨ä¸Šã€‚\nå¹³è¡¡çš„æ–¹å¼æœ‰\nhash mod Nï¼š\nç›´æ¥æŠŠ hash key mod {æ‰€æœ‰æ©Ÿå™¨æ•¸}å³å¯ï¼Œä½†ç¼ºé»æ˜¯å¢åŠ ä¸€å°æ©Ÿå™¨å°±æœƒæœ‰å¤§é‡è³‡æ–™éœ€è¦æ¬ç§»ï¼Œé€ æˆä¸å¿…è¦çš„è² æ“” Fixed number of partitionsï¼š\nå°‡æ‰€æœ‰è³‡æ–™åˆ‡æˆå¾ˆå¤šä»½ï¼Œä¸¦å¹³å‡åˆ†æ•£åˆ°æ©Ÿå™¨ä¸Šï¼Œä¾‹å¦‚èªª 10å°æ©Ÿå™¨å¯ä»¥å°‡è³‡æ–™åˆ†æˆ 1000ä»½ï¼Œå¹³å‡æ¯å°è² æ“” 100ä»½è³‡æ–™ï¼›\næ­¤æ™‚å¦‚æœæœ‰æ–°æ©Ÿå™¨åŠ å…¥ï¼Œé€™10å°æ©Ÿå™¨æ¯å°æŠ½9~10ä»½æ¬ç§»å³å¯ï¼Œå¦‚æœè¦ç§»é™¤èˆŠæ©Ÿå™¨åä¹‹ï¼›\né€™ç¨®æ–¹å¼æœ‰æ•ˆé™ä½ä¸å¿…è¦çš„è³‡æ–™æ¬ç§»ã€‚ Dynamic partitioning ä½¿ç”¨ Key-range partitionä¸å¤ªæ–¹ä¾¿ï¼Œå¦‚æœä¸€é–‹å§‹è¨­å®šéŒ¯èª¤ï¼Œæœƒå°è‡´è³‡æ–™å¤ªéé›†ä¸­æ–¼éƒ¨åˆ†ç¯€é»ï¼Œå¦‚æœè¦é‡æ–°è¨­å®šåˆæœƒå¾ˆéº»ç…©ï¼›\næ‰€ä»¥æŸäº›è³‡æ–™åº«(HBaseã€RethinkDB)å…§éƒ¨æä¾›å‹•æ…‹åˆ†å‰²çš„æ–¹æ³•ï¼Œç•¶ç™¼ç¾ partitionè³‡æ–™è¶…éæŸå€‹sizeï¼Œæœƒè‡ªå‹•åˆ†å‰²ä¸¦æŠŠè³‡æ–™åˆ†æˆå…©å€‹partitionï¼›\nå¦‚æœè³‡æ–™å¤§é‡åˆªé™¤ï¼Œä¹Ÿæœƒè‡ªå‹•åˆä½µæˆå–®ä¸€å€‹partitionï¼›\næ¯å€‹partitionåˆ†æ•£åˆ°ä¸€å€‹ç¯€é»ä¸Šï¼Œè€Œä¸€å€‹ç¯€é»å¯èƒ½å„²å­˜å¤šå€‹partitionã€‚\nDynamic partitionå¯æ”¯æ´ key-range partitionå’Œ hash-key partitionã€‚\nRequest Routing ç•¶ç”¨æˆ¶è¦ç™¼é€è«‹æ±‚ï¼Œå¦‚ä½•å¾—çŸ¥è©²å¾€å“ªå€‹ç¯€é»ç™¼é€å‘¢?Â é€™å€‹å•é¡Œé€šç¨±ç‚º_service discovery_ ï¼Œä»»ä½•é€éç¶²è·¯çš„è»Ÿé«”éƒ½æœƒé‡ä¸Šæ­¤å•é¡Œï¼Œå°¤å…¶æ˜¯åˆ†æ•£å¼ç³»çµ±ã€‚\nä¸»è¦è§£æ³•æœ‰ä¸‰ç¨®æ–¹å¼ï¼Œ\nclientéš¨æ©Ÿç™¼é€è«‹æ±‚åˆ°æŸç¯€é»ï¼Œæ¯å€‹ç¯€é»éƒ½æœ‰åˆ†ç‰‡ä¾æ“šçš„ç´€éŒ„ï¼›\nçµ±ä¸€ä¸€å€‹è² è²¬routingçš„ç¯€é»ï¼›\nclientç«¯è‡ªè¡Œåˆ¤æ–·ç´€éŒ„åˆ†ç‰‡çš„ä¾æ“šã€‚\nCh8. The Trouble with Distributed Systems Faults and PartialÂ Failures åˆ†æ•£å¼ç³»çµ±å‚³éè³‡è¨Šéƒ½æ˜¯é ç¶²è·¯ï¼Œä½†ç¶²è·¯çš„æœ¬èº«æ˜¯ä¸å¯é çš„ï¼Œæ‰€ä»¥åˆ†æ•£å¼ç³»çµ±æœ€å¤§çš„ç–‘æ…®ä¾¿æ˜¯æœƒæœ‰éƒ¨åˆ†éŒ¯èª¤çš„ç”¢ç”Ÿï¼Œåœ¨æŸäº›æ™‚åˆ»æˆ‘å€‘ç„¡æ³•å¾—çŸ¥æ“ä½œæ˜¯å¦å®Œå…¨æˆåŠŸï¼Œæ‰€ä»¥åœ¨è¨­è¨ˆä¸Šå¿…é ˆè€ƒé‡é€™ä¸€é»ï¼Œè¨­è¨ˆå‡ºå¯å®¹å¿éŒ¯èª¤(Fault-Tolerance)çš„ç³»çµ±ã€‚\nUnreliable Networks è«‡è«–ä¸€äº›ç¶²è·¯çš„ä¸å¯é æ€§ï¼Œå°æ¯”Telephone circuit ç”¨ç¡¬é«”èˆ‡å›ºå®šé »å¯¬çš„é€£ç·šæ–¹å¼å‚³è¼¸è³‡æ–™ï¼ŒTCPç‚ºäº†å¢é€²ç¸½é«”ä½¿ç”¨é‡æœƒæœ‰flow controlå°è‡´å‚³è¼¸é€Ÿåº¦ç„¡æ³•ä¼°æ¸¬ã€‚\nUnreliable Clocks æ™‚é–“åœ¨é›»è…¦ç³»çµ±æ‰®æ¼”é‡è¦è§’è‰²ï¼Œå¤§è‡´æœ‰å…©å€‹æ™‚é–“å±¬æ€§ å€é–“(Durationï¼Œå¦‚è¨ˆç®—requestæ™‚é–“)ã€ç¢ºåˆ‡æ™‚é–“(points in timeï¼ŒéŒ¯èª¤çš„æ™‚é–“log)ï¼Œå†åˆ†æ•£å¼ç³»çµ±ä¸­æ™‚é–“å¾ˆtrickyï¼Œå› ç‚ºæºé€šä¸æ˜¯å³æ™‚çš„ï¼Œé€éç¶²è·¯å‚³éè¨Šæ¯æœƒç”¢ç”Ÿä¸å¯é æ¸¬çš„å»¶é²ï¼›\nå†è€…æ¯å°é›»è…¦éƒ½æœ‰å„è‡ªçš„çŸ³è‹±éœ‡ç›ªå™¨è¨ˆç®—æ™‚é–“ï¼Œå› ç‚ºå„ç¨®ç‰©ç†æ€§è³ªä¸Šçš„å·®ç•°å°è‡´ç„¡æ³•å®Œå…¨ç²¾æº–åŒæ­¥æ¯å°é›»è…¦çš„æ™‚é–“ã€‚\nMonotonic Versus Time-of-Day Clocks Time-of-day clocks(åˆç¨± wall time)ï¼š\nè¿”å›æ—¥æ›†æ™‚é–“ï¼Œé€šå¸¸æ˜¯é€éNTPåŒæ­¥æ™‚é–“ï¼Œä½†å¦‚æœé›»è…¦æ™‚é–“å¤ªå¿«æˆ–å¤ªæ…¢ï¼ŒåŒæ­¥ä¹‹å¾Œå¯èƒ½æœƒç”¢ç”Ÿæ™‚é–“è·³èºï¼Œç”¢ç”Ÿä¸€äº›å¾Œéºç—‡(å¦‚è³‡æ–™åº«å¯«ç´€éŒ„çš„è·³é‡å°è‡´è³‡æ–™ä¸ä¸€è‡´) Monotonic clocksï¼š\né©åˆç”¨ä¾†æ¸¬é‡æ™‚é–“å€é–“ï¼Œã€Œå¯¦éš›ä¸Šä»–æŒ‡çš„æ˜¯ç³»çµ±å•Ÿå‹•å¾Œæµé€çš„æ™‚é–“ï¼Œé€™æ˜¯ç”±è®Šæ•¸jiffiesä¾†ç´€éŒ„çš„ã€‚ç³»çµ±æ¯æ¬¡å•Ÿå‹•æ™‚jiffiesåˆå§‹åŒ–ç‚º0ï¼Œæ¯ä¾†ä¸€å€‹timer interruptï¼ŒjiffiesåŠ 1ï¼Œä¹Ÿå°±æ˜¯èªªä»–ä»£è¡¨ç³»çµ±å•Ÿå‹•ä¹‹å¾Œæµé€tickæ•¸**ã€\n**(å‡ºè™•ï¼š[Timerå­¦ä¹ ]wall timeå’Œmonotonic time)ä½†ä¹Ÿå› ç‚ºå¦‚æ­¤ï¼Œæ‰€ä»¥è·¨ç³»çµ±é–“æ¯”è¼ƒMonotonic clocksæ˜¯æ²’æœ‰æ„ç¾©çš„ã€‚ Timestamps for orderingÂ events å‡æƒ³ç³»çµ±æœ‰2å€‹Nodeï¼Œç•¶å…©å€‹å®¢æˆ¶Aã€BåŒæ™‚å°åŒä¸€ç­†è³‡æ–™åšæ”¹å¯«ï¼Œä½†æ˜¯Açš„Requestå…ˆåˆ°Node 1è€Œ Bå…ˆåˆ°Node 2ï¼Œå†è™•ç†ä½µç™¼æ™‚åˆ†æ•£å¼ç³»çµ±é€šå¸¸æ¡ç”¨LWW(Last-Write-Win)ï¼Œæ‰€ä»¥æ›´æ–°å¾ŒNode 1èˆ‡Node 2è³‡æ–™å°±æœƒä¸åŒæ­¥\nProcess Pauses è©¦æƒ³ä¸€å€‹å±éšªçš„æƒ…æ³ï¼Œè³‡æ–™åº«æ¡ç”¨Single-Leaderæ¶æ§‹ï¼ŒLeaderéœ€è¦å›ºå®šä¸€æ®µæ™‚é–“é€šçŸ¥æ‰€æœ‰Follower Leaderé‚„æ´»è‘—ï¼Œä½†å¦‚æœLeaderçš„åŸ·è¡Œå¡ä½äº†éä¸€æ®µæ™‚é–“æ²’æœ‰é€šçŸ¥ï¼Œå…¶é¤˜Followeré¸å‡ºæ–°çš„Leaderå¾ŒåŒæ™‚èˆŠLeaderå¾©æ´»ï¼Œç”¢ç”Ÿäº†é›™Leaderçš„åˆ†æ­§å±€é¢\nåœ¨ä»¥ä¸‹æƒ…æ³æœƒç”¢ç”Ÿç¨‹å¼åŸ·è¡Œè¢«ç„¡é æœŸå¡ä½ï¼Œå¦‚åƒåœ¾å›æ”¶(GC)ï¼Œé€™æœƒå°è‡´ç¨‹å¼é‹ä½œç›´æ¥å¡æ­»ç›´åˆ°åƒåœ¾å›æ”¶çµæŸï¼›\nåœ¨è™›æ“¬æ©Ÿä¸­VMä¹Ÿæœ‰å¯èƒ½è¢«æš«æ™‚çµ‚æ­¢åŸ·è¡Œã€åˆæˆ–æ˜¯åœ¨CPUåˆ‡æ›ä»»å‹™æ™‚ç³»çµ±è² è¼‰éå¤šè€Œå»¶é²ç­‰ç­‰å› ç´ \nResponse time guarantees ä¸Šè¿°å•é¡Œç”¢ç”Ÿæ–¼ æ‡‰ç”¨ç¨‹å¼ä¸çŸ¥é“åŸ·è¡Œæ™‚æœƒé‡åˆ°æ€æ¨£çš„çªç™¼çµ‚æ­¢ç‹€æ³ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥ä¿è­‰çªç™¼çµ‚æ­¢çš„æ™‚é–“æ˜¯å¯é æ¸¬çš„ï¼Œå°±å¯ä»¥é€éè¨­è¨ˆé¿å…å•é¡Œï¼Œä½†å•é¡Œå°±æ˜¯å¦‚ä½•ä¿è­‰å›æ‡‰æ™‚é–“?\nRTOS(real-time Operating System)ä¿è­‰CPUçš„æ™‚é–“åˆ‡å‰²æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å¯ä»¥å¾—çŸ¥æœ€ç³Ÿç‹€æ³æ‡‰ç”¨ç¨‹å¼æœƒè¢«çµ‚æ­¢å¤šä¹…ï¼›\nä½†RTOSé–‹ç™¼å¾ˆè²´ï¼Œé€šå¸¸ç”¨æ–¼é«˜åº¦å®‰å…¨çš„ç³»çµ±è¨­è¨ˆå¦‚é£›è¡Œç³»çµ±ï¼Œè€Œä¸”RTOSæœƒé™åˆ¶æ‡‰ç”¨ç¨‹å¼å¯ç”¨çš„Libraryã€å¯«æ³•ç­‰ï¼Œä¸é©ç”¨æ–¼ä¸€èˆ¬è³‡æ–™åº«ç³»çµ±ã€‚\nThe Truth Is Defined by theÂ Majority åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œæ¯å€‹ç¯€é»åªèƒ½é€éç¶²è·¯æ”¶ç™¼è³‡æ–™ä¾†ç¢ºèªå½¼æ­¤çš„ç‹€æ…‹ï¼Œä½†æœ‰æ™‚å€™ç¯€é»é‹ä½œæ­£å¸¸ä½†åœ¨èˆ‡å…¶ä»–ç¯€é»çš„ç¶²è·¯æºé€šä¸Šå‡ºäº†å•é¡Œï¼Œæˆ–æ˜¯é‡ä¸ŠGCæ•´å€‹ç¯€é»å¡ä½ç­‰ï¼Œå°±æœ‰ä¸€æ¨£æœƒè¢«å…¶ä»–ç¯€é»èª¤èªç‚ºã€Œæ­»äº¡ã€\næ­£å› ç‚ºåˆ†æ•£å¼ç³»çµ±è§£æ±ºäº†å–®ä¸€ç¯€é»å¤±æ•ˆçš„å•é¡Œï¼Œå¤±æ•ˆçš„æ±ºå®šå‰‡ä¾è³´å¤šæ•¸çš„ç¯€é»çš„æ±ºå®šã€‚\nByzantine Faults å…ˆå‰æè¿°éƒ½æ˜¯ä»¥ç¯€é»å¤±æ•ˆç‚ºä¸»ï¼Œä½†å¦‚æœç¯€é»æœƒã€Œèªªè¬Šã€å‘¢? Byzantine Generals Problem æ‹œå åº­å°‡è»å•é¡Œå³æ˜¯æè¿°å¤šç¯€é»åœ¨ä¸çŸ¥é“å½¼æ­¤çš„æƒ…æ³ä¸‹å¦‚ä½•ç¢ºä¿å›å¾’ä¸æœƒå½±éŸ¿æ­£ç¢ºæ€§\næ‹œå åº­å°†å†›é—®é¢˜ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦\nçµè«–å¤§è‡´æ˜¯åªè¦å‡ºéŒ¯çš„çµé»ä¸è¶…é 1/3å³å¯ä¿è­‰æ•´é«”çš„æ­£ç¢ºæ€§ã€‚\n","date":"2018-04-19T04:08:48.494Z","permalink":"https://yuanchieh.page/posts/2018/2018-04-19-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8B/","title":"[æŠ€è¡“ç­†è¨˜] Designing Data-Intensive Applications ä¸‹"},{"content":"éš¨è‘—è»Ÿé«”æ‡‰ç”¨ç¨‹å¼çš„ç™¼å±•ï¼Œæ‡‰ç”¨çš„ä¾·é™(bottleneck)å¾CPUç§»è½‰è‡³è³‡æ–™çš„è™•ç†ï¼Œè³‡æ–™çš„å·¨é‡ã€è¤‡é›œæ€§èˆ‡æ”¹è®Šçš„é€Ÿåº¦è®Šæˆæ£˜æ‰‹çš„å•é¡Œï¼Œä¹Ÿå°±æ˜¯ä½œè€…æ‰€å®šç¾©çš„ã€ŒData-Intensiveã€è³‡æ–™å¯†é›†çš„æ‡‰ç”¨ç¨‹å¼ï¼›\nä½œè€…å‰è¨€æåŠ åœ¨ç¾ä»ŠBuzzwordæ»¿å¤©é£› Big Data / NoSQL / Web Scale blablablaï¼Œèº«ç‚ºæŠ€è¡“äººå“¡æ‡‰è©²æ›´é€å¾¹çš„äº†è§£è³‡æ–™å„²å­˜çš„åŸºæœ¬è§€å¿µï¼Œé€™äº›æ‰æ˜¯æ°¸æ†ä¸è®Šçš„åŸºçŸ³ï¼›\næœ‰äº†æ¸…æ¥šçš„æ¦‚å¿µï¼Œæ‰èƒ½åœ¨ä¸åŒçš„æ‡‰ç”¨å ´æ™¯å¥—ç”¨æœ€é©åˆçš„è§£æ³•ï¼Œè€è©±ä¸€å¥\næ²’æœ‰éŠ€å½ˆ\næ­¤æ›¸åˆ‡æˆä¸‰å¤§éƒ¨åˆ†ï¼šè³‡æ–™ç³»çµ±çš„åŸºæœ¬çµ„æˆ(Foundation of Data Systems)ã€åˆ†æ•£å¼è³‡æ–™å„²å­˜(Distributed Data)ã€å–å¾—è³‡æ–™(Derived Data)ï¼›\nä½œè€…ç« ç¯€è¨­è¨ˆå¾ªåºæ¼¸é€²ï¼Œå…ˆå®šç¾©åŸºæœ¬ç”¨èªèˆ‡è³‡æ–™ç³»çµ±çš„è¨­è¨ˆç†å¿µèˆ‡å¯¦ä½œæ–¹å¼ï¼Œæ¥è‘—åŠ æ·±å…§å®¹ä¸”ä¸æ–·çš„å¼•ç”¨å‰é¢æ‰€è¿°èªªçš„è§€å¿µï¼›\nä»¥ä¸‹æ˜¯æˆ‘ç°¡å–®ç­†è¨˜æœ¬æ›¸2/3çš„å…§å®¹ï¼ŒDerived Dataç›®å‰æœ‰é»çœ‹ä¸æ‡‚æ‰€ä»¥å°±å…ˆæš«æ™‚è·³é OTZ\nCh 1. Reliable / Scalable / Maintainable å†è¨è«–ç³»çµ±è¨­è¨ˆæ™‚ï¼Œå°±å¿…é ˆå…ˆåå•ã€Œæƒ³è¦è¨­è¨ˆå‡ºç¬¦åˆæ€æ¨£éœ€æ±‚çš„ç³»çµ±ã€\nä½œè€…æå‡ºä¸‰å¤§è»Ÿé«”è¨­è¨ˆçš„æ ¸å¿ƒ\nReliable é‹ä½œéœ€èˆ‡ä½¿ç”¨è€…é æœŸçš„ç›¸åŒ å¯ä»¥å®¹å¿ç”¨æˆ¶ä»¥éé æœŸæ–¹å¼æ“ä½œç³»çµ± æ•ˆèƒ½éœ€å¥½åˆ°å¯ä»¥æ‡‰ä»˜ç”¨æˆ¶éœ€æ±‚ é˜²æ­¢éæˆæ¬Šç™»å…¥èˆ‡æ¿«ç”¨ åŸºæœ¬ä¸Šå°±æ˜¯è¦èƒ½å¤ åœ¨ä¸€å®šçš„éŒ¯èª¤å®¹å¿ä¸‹é‹ä½œæ­£å¸¸ï¼Œå¸¸è¦‹çš„éŒ¯èª¤æœ‰\nç¡¬é«”éŒ¯èª¤ï¼š\nä½œè€…æåŠåƒç¡¬ç¢Ÿçš„ MTTF(å¹³å‡æ™‚é–“å‡ºéŒ¯)æ˜¯10~50å¹´ï¼Œå¦‚æœä½ çš„è³‡æ–™ä¸­å¿ƒæœ‰10,000é¡†ç¡¬ç¢ŸåŸºæœ¬ä¸Šé æœŸæ˜¯æ¯å¤©éƒ½æœƒå£ä¸€é¡†!Â =\u0026gt; å¸¸è¦‹è§£æ³•æ˜¯ï¼šå¢åŠ ç¡¬é«”å†—ä½™ã€ä½¿ç”¨RAIDã€é¡å¤–ä¾›é›»è¨­å‚™ã€ç•°åœ°å‚™ä»½ç­‰ è»Ÿé«”éŒ¯èª¤ äººç‚ºéŒ¯èª¤ Scalable éš¨è‘—ç”¨æˆ¶å¢åŠ ï¼Œç³»çµ±éœ€è¦è² æ“”çš„è³‡æ–™ä¹Ÿæˆå¹¾ä½•å¢é•·ï¼Œæ‰€ä»¥éœ€è¦ç³»çµ±çš„æ“´å……æ€§å»å›ç­”ã€Œæˆ‘å€‘å¦‚ä½•å¢åŠ é‹ç®—è³‡æºä¾†æ‡‰ä»˜å¢é•·çš„æµé‡?ã€\nå†å›ç­”æ­¤å•é¡Œä¹‹å‰ï¼Œå¿…é ˆå…ˆçŸ¥é“å¦‚ä½•æè¿°ã€Œæ­¤åˆ»ç³»çµ±çš„è² è¼‰é‡ã€ï¼Œæ ¹æ“šä¸åŒçš„ç³»çµ±è¨­è¨ˆæœ‰ä¸åŒçš„è¡¡é‡æ–¹å¼ï¼Œä¾‹å¦‚å¸¸è¦‹çš„ request per seconds / è³‡æ–™åº«è®€å¯«æ¯” / æœ€å¤§åŒæ™‚ä¸Šç·šäººæ•¸ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾å‡ºä¸åŒçš„ã€Œé—œéµé™„è¼‰ä¿‚æ•¸(Key Load Parameters)ã€ï¼›\nè¡¡é‡æ€§èƒ½éƒ¨åˆ†å¯ä»¥é€é percentileè¿½è¹¤ï¼Œåˆ†æå›æ‡‰é€Ÿåº¦çš„ç™¾åˆ†æ¯”åœ–ï¼ŒAmazonæœ‰åšä¸€å€‹æœ‰è¶£çš„åˆ†ææŒ‡å‡º æœ€æ…¢çš„Requestæ„å¤–ç™¼ç¾æ˜¯æœ€æœ‰åƒ¹å€¼çš„å®¢æˆ¶ï¼Œå› ç‚ºå¾€å¾€ä»–å€‘çš„Requestå¤¾å¸¶æœ€å¤šçš„è³‡è¨Šï¼Œæ‰€ä»¥ä¹Ÿå°è‡´é€Ÿåº¦æœ€æ…¢ï¼›\nä½œè€…èˆ‰ Twitteråœ¨2012å¹´åšç”¨æˆ¶ç™¼é€è¨Šæ¯ç‚ºä¾‹ï¼š\nTwitter æœ‰å…©å€‹ä¸»è¦æ“ä½œ\n1. ç™¼ tweetï¼š\nç”¨æˆ¶ç™¼é€æ–°è¨Šæ¯(4.6K req/secï¼Œé«˜å³°è¶…é 12K req / sec)\n2. Home timelineï¼š\nç”¨æˆ¶æŸ¥çœ‹ä»–å€‘è¿½è¹¤çš„å°è±¡æ¶ˆæ¯åˆ— (300k req/sec)\nåœ¨è¨­è¨ˆä¸Šæœ‰å…©ç¨®æ–¹å¼ï¼š\n1. ç™¼tweetæ™‚å°±æ˜¯å–®ç´”æ’å…¥æ–°çš„ä¸€ç­†ç´€éŒ„ï¼Œå¦‚æœæœ‰ç”¨æˆ¶è¦è®€home timelineå°±åš DB Joinå–å‡ºæ‰€æœ‰è¿½è¹¤å°è±¡çš„è¨Šæ¯\n2. é‡å°æ¯ä½ç”¨æˆ¶éƒ½Cache home timelineï¼Œå¦‚æœæœ‰ç”¨æˆ¶æ–°å¢tweetå°±åŠ åˆ°å°æ‡‰è¿½è¹¤ç”¨æˆ¶çš„cacheä¸­\nTwitterå¾Œä¾†å¾æ–¹æ³•ä¸€è½‰è‡³æ–¹æ³•äºŒï¼ŒåŸå› æ˜¯å› ç‚ºæ–¹æ³•äºŒçš„è®€å–timelineé€Ÿåº¦å¿«äº†å…©å€‹ç´šåˆ¥ï¼Œæ‰€ä»¥å‚¾å‘æ–¼ èŠ±å¤šé»æ™‚é–“åœ¨å¯«å…¥ä»¥ç¯€çœé¾å¤§çš„è®€å–æ™‚é–“ã€‚\nå°æ–¼Twitterä¾†èªªï¼Œç”¨æˆ¶çš„è¿½è¹¤æ•¸å°±æ˜¯é—œéµé™„è¼‰ä¿‚æ•¸ **ï¼Œ**ä½†æ¯ä½ç”¨æˆ¶çš„è¿½è¹¤æ•¸èˆ‡è¢«è¿½è¹¤æ•¸å·®ç•°ååˆ†çš„å¤§ï¼Œå°¤å…¶æ˜¯åäººï¼Œæ‰€ä»¥Twitterå¾Œä¾†æ¡ç”¨å…©ç¨®æ–¹æ³•æ··ç”¨ï¼Œä¸€èˆ¬ç”¨æˆ¶æ¡ç”¨æ–¹æ³•äºŒï¼Œè€Œåäººå‰‡å¦å¤–è™•ç†ã€‚\nMaintainable è»Ÿé«”æœ€å¤§çš„èŠ±è²»ä¸åœ¨æ–¼å»ºç½®ï¼Œè€Œåœ¨æ–¼ç¶­è­·ï¼Œæ­¤è™•åˆæ‹†æˆä¸‰å€‹å­é …ç›®\nOperability\né€éä¸€äº›æ–¹å¼å¯ä»¥è®“è»Ÿé«”æ›´å¥½ç¶­é‹ï¼Œä¾‹å¦‚ ç›£æ§ç³»çµ±å¥åº·ã€éŒ¯èª¤è¿½è¹¤ç³»çµ±ã€å®šæœŸæ›´æ–°ç³»çµ±ã€éš”é›¢ä¸åŒç³»çµ±ç­‰ Simpilicity\néš¨è‘—ç³»çµ±ç‡Ÿé‹ä¸å¯é¿å…åŠŸèƒ½ä¸€ç›´åŠ ï¼Œç³»çµ±ä¹Ÿç›¸å°è·Ÿè‘—è¤‡é›œï¼Œé€™è£¡çš„ç°¡æ˜“æ€§ä¸æ˜¯èªªè¦å»å‰Šæ¸›åŠŸèƒ½ï¼Œè€Œæ˜¯**é¿å…ä¸å¿…è¦çš„è¤‡é›œæ€§ï¼Œ**é€™è£è¤‡é›œæ€§çš„å®šç¾©æ˜¯ã€Œä¼åœ–åŠ å…¥å¯¦ä½œå±¤é¢çš„è§£æ³•è€Œè·Ÿè§£æ±ºå•é¡Œç„¡é—œã€ï¼Œè¦é¿å…è¤‡é›œæ€§å°±å¿…é ˆé€é **æŠ½è±¡åŒ–(Abstraction)ï¼Œ**ä¾‹å¦‚èªªé«˜éšèªè¨€ç†ç•¶ä¸éœ€è¦ç†æœƒCPUçš„æš«å­˜å™¨ç­‰æ“ä½œï¼Œå› ç‚ºèªè¨€æœ¬èº«å·²ç¶“é€éæŠ½è±¡åŒ–éš±è—äº†ä¸å¿…è¦çš„å¯¦ä½œè¤‡é›œæ€§ã€‚ Evolvability\néœ€æ±‚æœƒåŠ ã€åŠŸèƒ½æœƒæ”¹ï¼Œæ‰€ä»¥ç³»çµ±å¿…é ˆä¿ç•™å½ˆæ€§é¢å°æ”¹è®Šã€‚ Ch 2. Data Models and Query Languages é€™ä¸€ç« æ¢è¨è³‡æ–™å„²å­˜çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ Relation / Document / Graph Data Modelï¼Œè³‡æ–™å„²å­˜çš„å½¢å¼å¾ˆé‡è¦ï¼Œé€™æœƒæ±ºå®šæ€§å½±éŸ¿äº†æ‡‰ç”¨ç¨‹å¼çš„ç·¨å¯«ä»¥åŠåº•å±¤å„²å­˜æ–¹å¼çš„ä¸åŒï¼›\nRelation Data Modelæœ€ç‚ºå¸¸è¦‹ï¼Œå°‡è³‡æ–™çš„é—œè¯ä»¥tupleçš„é›†åˆå„²å­˜(ä¹Ÿå°±æ˜¯SQLçš„row)ï¼Œä½†æ˜¯ç¾ä»Šçš„ç¨‹å¼èªè¨€éƒ½æ˜¯ç‰©ä»¶å°å‘ï¼Œæ‰€ä»¥è¦åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­æ“ä½œè³‡æ–™å°±å¿…é ˆé€éORMå°‡è³‡æ–™è½‰æ›ç‚ºç‰©ä»¶å½¢å¼ï¼›\né€™ä¹Ÿæ˜¯ç‚ºä»€éº¼æœƒæœ‰ Document Data Modelï¼Œå› ç‚ºè³‡æ–™(åœ¨æ²’æœ‰è¤‡é›œé—œè¯ä¸‹)çš„æœ¬èº«å°±æ˜¯å€‹æ–‡æœ¬ç‰©ä»¶ï¼Œé€™è£¡çš„Documentåå‘æ–¼æè¿°å¯ä»¥ç”¨ JSON / XML çµæ§‹åŒ–èªè¨€æè¿°çš„è³‡æ–™æ ¼å¼ï¼Œä¾‹å¦‚ å±¥æ­· {name: â€œhelloâ€, age: 25,Â â€¦.}ã€‚\nä½†ç¾å¯¦ä¸Šè³‡æ–™æœ¬èº«æœ‰ä¸åŒçš„é—œè¯æ€§ï¼Œæœ‰One to Many ä¹Ÿæœ‰ Many to Manyï¼ŒåŸºæœ¬ä¸Šæ¡ç”¨ä½•ç¨®Data Modelå¯ä»¥å¾è³‡æ–™é›†å¤šå°å¤šçš„é—œè¯æ€§è¤‡é›œåº¦ä¾†æ±ºå®šï¼›\nå¦‚æœè³‡æ–™åƒ…æœ‰å°‘éƒ¨åˆ†å¤šå°å¤šé—œè¯ï¼Œå¯ä»¥é¸æ“‡æ¡ç”¨Document Data Modelï¼Œå› ç‚ºç›¸å°æ‡‰ç”¨ç¨‹å¼çš„ä»£ç¢¼æ¯”è¼ƒå¥½å¯«ï¼Œä¸éœ€å¤šä¸€å±¤ORMè½‰æ›ã€å°‘æœ‰çš„å¤šå°å¤šå¯ä»¥ç”¨æ‡‰ç”¨ç¨‹å¼ä»£ç¢¼è‡ªå·±å¯¦è¸JoinåŠŸèƒ½ï¼›\nå¦‚æœæ³¨é‡ç‰©ä»¶çš„å¤šå°å¤šé—œè¯æ€§å‰‡å¯ç”¨ Relation Data Modelï¼›\nå¦‚æœç‰©ä»¶çš„é—œè¯æ€§ç›¸ç•¶è¤‡é›œå¯ä»¥è€ƒæ…® Graph Data Modelï¼Œé€™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¸åˆ°æ­¤è§€å¿µï¼Œè³‡æ–™æ¨¡å‹æ”¹ä»¥åœ–å½¢åŒ–æ–¹å¼å‘ˆç¾ï¼Œè³‡æ–™å¯åˆ†æˆverticeèˆ‡edgeï¼Œverticeæ¯”è¼ƒåƒæ˜¯å„²å­˜å–®é«”çš„è³‡æ–™ï¼Œè€Œedgeå‰‡å„²å­˜verticeé–“çš„é—œä¿‚ï¼Œé€éåœ–å½¢åŒ–çš„ç‰¹æ€§å¯ä»¥è¡¨é”ç›¸ç•¶è¤‡é›œã€éè¿´çš„é—œä¿‚ï¼Œé€™éƒ¨åˆ†å¯ä»¥åƒè€ƒæˆ‘ä¹‹å‰å˜—è©¦ neo4jçš„ç­†è¨˜ã€‚\nç•¶ç„¶ä¸Šè¿°åªæ˜¯å–®ç´”ä»¥è³‡æ–™é—œè¯èˆ‡å°æ‡‰çš„æ¨¡å‹ä¾†è¡¡é‡ï¼Œç¾å¯¦çš„æŠ€è¡“æ¡ç´éœ€è¦æœ‰æ›´å…¨é¢é€šç›¤çš„è€ƒé‡ã€‚\né€™ä¸€ç« æ¯”è¼ƒæ˜¯åœ¨è¬›å¤ï¼ŒæŠŠéå»æ›¾å‡ºç¾éçš„è³‡æ–™æ¨¡å‹èˆ‡å°æ‡‰çš„Queryèªè¨€éƒ½ç¨å¾®å¸¶åˆ°ã€‚\næœ€å¾Œç­†è¨˜ä¸€é»è »æœ‰è¶£çš„è§€é»ï¼Œä½œè€…æåˆ° Document Databaseéƒ½æœƒè¢«èª¤ç¨±ç‚º schemalessï¼Œä½†å…¶å¯¦æ›´æº–ç¢ºèªªæ³•æ˜¯ schema-on-readï¼Œé›–ç„¶DBæ²’æœ‰é¡¯æ€§çš„è³‡æ–™æ¬„ä½ï¼Œä½†æ˜¯åœ¨æ‡‰ç”¨ç¨‹å¼è®€å–æ™‚ä¸€æ¨£æœƒæœ‰è³‡æ–™çš„æ¶æ§‹ï¼Œå°æ‡‰çš„æ˜¯Relation Databaseçš„schema-on-writeï¼›\nschema-on-readæœ‰é»åƒæ˜¯å‹•æ…‹èªè¨€ï¼Œè³‡æ–™çš„æª¢æŸ¥åœ¨æ‡‰ç”¨ç¨‹å¼æœ¬èº«ï¼›è€Œschema-on-writeåƒéœæ…‹èªè¨€çš„å‹åˆ¥æª¢æŸ¥ï¼Œåœ¨å¯«å…¥æ™‚å°±å…ˆæª¢æŸ¥äº†ã€‚\nCh 3. Storage and Retrieval é€™ç« ç¯€ç®—æ˜¯æˆ‘è¦ºå¾—æœ€æœ‰è¶£çš„ä¸€ç« ï¼Œä¸»è¦è«‡åˆ°è³‡æ–™åº«åº•å±¤å¦‚ä½•å°‡è³‡æ–™å­˜å…¥ç¡¬ç¢Ÿä¸­ï¼Œä»¥åŠå¦‚ä½•å¿«é€Ÿçš„é€éç´¢å¼• Index å¾ç¡¬ç¢Ÿå–å‡ºè³‡æ–™ï¼›\né¦–å…ˆä½œè€…ç”¨shell scriptç·¨å¯«æœ€ç°¡å–®çš„è³‡æ–™åº«\ndb_set () { echo â€œ$1, $2â€ \u0026raquo; database}\ndb_get () { grep â€œ^$1,â€ database | sed -e â€œs/^$1,//â€ | tail -n 1}\n$ db_set 123 â€˜{name: â€œ123â€}â€™\n$ db_get 123\næ¡ç”¨é¡ä¼¼ CSVæ ¼å¼çš„ éµ-å€¼å„²å­˜ï¼Œå°‡æ–°çš„è³‡æ–™ä¸æ–·appendåˆ°æ–‡ä»¶ä¸Šï¼Œæœ€å¾Œæœå°‹æ™‚å¾æ–‡ä»¶æœ€æœ«çš„è³‡æ–™é–‹å§‹æ‰¾èµ·ï¼›\né€™æ¨£å¯«çš„æ•ˆèƒ½å¾ˆå¥½ï¼Œå› ç‚ºå–®ç´”appendè³‡æ–™é€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯è®€å–å‰‡éœ€è¦O(n)çš„æ™‚é–“ï¼›\nç‚ºäº†å¢åŠ è®€å–çš„æ•ˆèƒ½ï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹ç´¢å¼•ï¼Œåœ¨è¨˜æ†¶é«”ä¸­ç”¨Hash Tableè³‡æ–™çµæ§‹ï¼Œå„²å­˜éµå°æ‡‰æ¬„ä½åœ¨ç¡¬ç¢Ÿçš„å„²å­˜ä½ç½®ï¼ŒåŠ é€Ÿè®€å–çš„æ•ˆèƒ½ã€‚\né›–ç„¶é€™çœ‹èµ·ä¾†å¾ˆç°¡å–®ï¼Œä½†å¯¦éš›ä¸Šå»ä¹Ÿæœ‰è³‡æ–™åº«æ˜¯æ¡ç”¨æ­¤è¨­è¨ˆæ–¹å¼ï¼Œå¦‚ Bitcaskã€‚\nå…ˆå‰æåˆ°é€™ç¨®åšæ³•æ˜¯ä¸æ–·å°‡æ–°è³‡æ–™appendåˆ°ç¡¬ç¢Ÿæ–‡ä»¶ä¸Šï¼Œå³ä½¿åŒæ¨£çš„éµä¹Ÿæ˜¯ï¼Œä½†æ˜¯é€™æ¨£æ–‡ä»¶ç¸½ä¸èƒ½ç„¡æ­¢ç›¡çš„å¢åŠ ä¸‹å»ï¼Œæ‰€ä»¥æœƒæœ‰æ‰€è¬‚çš„ compact process å£“å¯¦ç¨‹åºï¼Œä¹Ÿå°±æ˜¯é‡æ•´èˆŠçš„æ–‡ä»¶ï¼Œå°‡å†—ä½™é‡è¤‡çš„éµå»é™¤åªä¿ç•™æœ€æ–°çš„ç´€éŒ„ï¼Œæ¸›å°‘ä¸å¿…è¦çš„éæ™‚è³‡æ–™å„²å­˜ç©ºé–“ã€‚\nä½†ä¸Šè¿°æ–¹å¼æœ‰å…©å€‹ç¼ºé»Â ç´¢å¼•å¿…é ˆå°æ–¼è¨˜æ†¶é«”ç¸½é‡å¦å‰‡æ€§èƒ½æœƒå¾ˆå·® ä¸æ”¯æ´ç¯„åœè®€å– Sorted StringÂ Table åœ–ç‰‡ä¾†æºï¼šhttps://tech.liuchao.me/2017/11/ddia-3/\næ‰€ä»¥å¾Œä¾†æœ‰æå‡ºæ–°çš„ä½œæ³• Sorted String Table (ç°¡ç¨± SSTable)ï¼Œå·®åˆ¥åœ¨æ–¼ç´¢å¼•æ”¹é€é ä¾ç…§å­—ä¸²é †åºæ’åºå¾Œçš„è³‡æ–™çµæ§‹å„²å­˜ï¼Œé€™æœ‰é»åƒæ˜¯å­—å…¸ç´¢å¼•ï¼Œç•¶æˆ‘å€‘è¦æŸ¥ä¸€å€‹å–®å­— hello æˆ‘å€‘å¯ä»¥é€éå‰å¾Œçš„å­—å»æ‰¾åˆ°ç›¸è¿‘çš„ä½ç½®ï¼›\næ‰€ä»¥å¦‚æœåœ¨è¨˜æ†¶é«”ä¸­æ‰€ä»¥åªæœ‰ he / holaï¼Œé‚£æˆ‘å€‘è‡³å°‘çŸ¥é“ hello å‹¢å¿…åœ¨æ­¤å…©å€‹ä½ç½®ä¸­é–“ï¼Œé€é é †åºè®€ sequential read å¯ä»¥éå¸¸å¿«çš„åœ¨ç¡¬ç¢Ÿä¸­æ‰¾åˆ°è³‡æ–™ã€‚\nä½œè€…å¼·èª¿ é †åºè®€å¯«å°æ–¼ç¡¬ç¢Ÿçš„æ•ˆèƒ½æœ‰å¾ˆå¤§çš„å¹«åŠ©ï¼Œå³ä½¿æ˜¯SSD\nB Tree ä½†æ˜¯SSTableä¸¦ä¸æ˜¯æœ€å¸¸ç”¨çš„è³‡æ–™ç³»çµ±å„²å­˜çš„æ–¹å¼ï¼Œè€Œæ˜¯B Treeï¼ŒB Treeæ˜¯å€‹å¹³è¡¡äºŒå‰æ¨¹ï¼Œæ¯ç¯€é»ç´€éŒ„å¤šå€‹å€é–“å€¼èˆ‡å°æ‡‰çš„å­ç¯€é»ï¼Œæ¯å€‹å­ç¯€é»å‰‡ç´€éŒ„ä¸€æ®µé€£çºŒå€¼ã€‚\nåœ–ç‰‡é€£çµï¼šhttps://tech.liuchao.me/2017/11/ddia-3/\nåœ¨å„²å­˜æ–¹å¼ä¸Šä¸æ˜¯æ¡ç”¨append onlyï¼Œè€Œæ˜¯å°‡å„²å­˜ç©ºé–“åˆ‡å‰²å›ºå®šå¤§å°çš„ Pageï¼Œä¸¦æŠŠç¯€é»çš„è³‡æ–™æ”¾å…¥ï¼Œå¦‚æœæœ‰æ–°çš„è³‡æ–™ç”¢ç”Ÿæœƒè¦†å¯«èˆŠçš„Pageï¼Œé€™é»èˆ‡SSTableå¤§å¤§ä¸åŒã€‚\nåœ¨å¯¦ä½œä¸Šï¼ŒB Treeå› ç‚ºæœƒå…ˆå°‡Pageè³‡æ–™æš«å­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œç‚ºäº†é¿å…è³‡æ–™éºå¤±æœƒåœ¨è³‡æ–™å¯«å…¥æ™‚å…ˆå°‡è³‡æ–™ç´€éŒ„åˆ°append-only çš„WAL(Write-Ahead Log)ï¼Œæ‰€ä»¥ä¸€ç­†è³‡æ–™å¯«å…¥å…¶å¯¦æœƒæœ‰å…©æ¬¡å¯«å…¥ç¡¬ç¢Ÿå‹•ä½œã€‚\nB Tree å°æ¯” SSTable å¥½è™•åœ¨æ–¼\nè³‡æ–™å†—é¤˜å°‘ æ‰¾å°‹ä¸å­˜åœ¨çš„éµå€¼æ¯”è¼ƒå¿«(SSTableå¿…é ˆæŸ¥å®Œæ‰€æœ‰èˆŠè³‡æ–™æ‰å¯ä»¥ç¢ºå®š) ä¸éœ€è¦ compact processå»é‡æ•´è³‡æ–™ï¼Œä½œè€…æåˆ°é›–ç„¶ compact processé€šå¸¸åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä½†ä½ æ°¸é ç„¡æ³•é æœŸä½•æ™‚ç³»çµ±æœƒçˆ†é‡ï¼Œä¹Ÿå°±æ˜¯èªªå¥½æ­»ä¸æ­»å¤§é‡è®€å¯«æ™‚å¡åˆ°ç³»çµ±åœ¨ compact processå°±æ¬²å“­ç„¡æ·šï¼Œç›¸å°ä¾†èªª B Treeçš„ç³»çµ±é™„è¼‰æ¯”è¼ƒå¯é æœŸï¼›\nSSTableå¥½è™•åœ¨æ–¼ B Treeåˆ‡å‰²Pageå®¹æ˜“æœ‰ç©ºé–“çš„ç ´ç¢åŒ–èˆ‡æµªè²»ï¼Œä¸”éƒ¨åˆ†è³‡æ–™æ›´æ–°ä¹Ÿå¿…é ˆæ›´å‹•å°æ‡‰çš„Pageï¼› Column-Base ä¸€èˆ¬è³‡æ–™åº«åœ¨OLTPä¸­éƒ½æ˜¯ä»¥row-basedç‚ºå°å‘çš„ï¼›\nä½†æ˜¯åœ¨OLAPä¸­ï¼Œæˆ‘å€‘å¸¸æœƒå°‡å¤šå€‹DBè³‡æ–™å½™æ•´åˆ°çµ±ä¸€çš„è³‡æ–™å€‰å„²ä¸­ï¼Œæ‰€ä»¥è³‡æ–™é‡éå¸¸é¾å¤§ï¼Œä¸”æ¯ç­†requestä¹Ÿéƒ½è¦é‹ç®—éå¸¸å¤§é‡çš„è³‡æ–™ï¼Œé€™æ™‚å€™æœ‰å€‹æ–°çš„åšæ³•ä»¥column-baseå„²å­˜è³‡æ–™ï¼Œé€™æ¨£æœ€å¤§å¥½è™•åœ¨æ–¼åŒä¸€å€‹columné€šå¸¸è³‡æ–™é‡è¤‡æ€§é«˜ï¼Œä¾‹å¦‚é¡è‰²å°±é‚£å¹¾ç¨®ã€ç”¢å“IDå¯èƒ½ä¹Ÿæœƒé‡è¤‡ï¼Œé€™ç¨®ç‰¹æ€§å¯ä»¥ä½¿ è³‡æ–™å£“ç¸® å¾—åˆ°éå¸¸å¥½çš„æ•ˆæœï¼›\nä½†ç¼ºé»å°±æ˜¯å¯«å…¥å¾ˆéº»ç…©ã€‚\nåœ¨åº•å±¤ç´€éŒ„ä¸Šï¼ŒB Treeç„¡æ³•å¥—ç”¨åœ¨å£“ç¸®æ¬„ä½ä¸Šï¼Œå› ç‚ºç´¢å¼•æ˜¯ç´€éŒ„row-basedçš„éµï¼Œæ‰€ä»¥å¤šå€‹columnæ¬„ä½æ›´å‹•æœƒå°è‡´éå¤šçš„Pageéƒ½è¦ä¸€å¹¶åˆ·æ–°ï¼›\næ‰€ä»¥æœƒæ¡ç”¨ SSTableç•¶ä½œå¯«å…¥ç¡¬ç¢Ÿçš„è³‡æ–™å„²å­˜æ–¹å¼ï¼Œæ¯æ¬¡å¯«å…¥éƒ½ç”¢ç”Ÿæ–°æª”æ¡ˆã€‚\nCh 4. Encoding and Evolution åœ¨ç³»çµ±çš„æ¼”é€²ä¸Šï¼Œéœ€è¦æ³¨æ„ç›¸å®¹æ€§å•é¡Œï¼Œå¯åˆ†æˆ\nãƒ»å‘å¾Œç›¸å®¹ï¼šæ–°çš„codeå¯èƒ½è®€å–åˆ°èˆŠè³‡æ–™\nãƒ»å‘å‰ç›¸å®¹ï¼šèˆŠçš„codeå¯èƒ½è®€å–åˆ°æ–°è³‡æ–™\nç¨‹å¼åœ¨è™•ç†è³‡æ–™ä¸Šæœƒæœ‰å…©ç¨®å½¢å¼\nä¸€ç¨®æ˜¯ in memoryï¼Œåƒæ˜¯ object / array / intç­‰ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿CPUåšé‹ç®—ï¼›\nå¦ä¸€ç¨®åœ¨éœ€è¦å¯«å…¥æª”æ¡ˆæˆ–æ˜¯é€éç¶²è·¯å‚³è¼¸æ™‚ï¼Œéœ€è¦é‡æ•´æˆå­—ä¸²çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯encode\nå¸¸è¦‹çš„ encodeå½¢å¼æœ‰éå¸¸å¤šç¨®ï¼ŒåŒ…å«JSON / XML /CSVï¼Œç‚ºäº†è®“è³‡æ–™å¯ä»¥ç”¨æœ€å°å®¹é‡å‚³éï¼Œä½œè€…ä»‹ç´¹äº†æ•¸ç¨®åŸºæ–¼JSONçš„encode / decodeæŠ€è¡“ï¼Œåœ¨encodeçš„éç¨‹ä¸­è¦æ³¨æ„è³‡æ–™æ ¼å¼èˆ‡å‹åˆ¥éœ€è¦å¯ä»¥decodeã€‚\nåŸæœ¬JSONåŸå§‹è³‡æ–™ 66 bytesï¼Œé€éä¸åŒçš„binary encodeæŠ€è¡“æœ€çµ‚å¯ä»¥å£“ç¸®åˆ° 34 bytes!\nä¸‹é›† æŠ€è¡“ç­†è¨˜ Designing Data-Intensive Applications ä¸‹ï¼Œç¬¬äºŒéƒ¨åˆ†ä¸»è¦æ¢è¨åˆ†æ•£å¼å„²å­˜è³‡æ–™æœƒé‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•ï¼Œåˆ†æ•£å¼ç³»çµ±æœ‰å¹¾å¤§å„ªé»\n","date":"2018-03-28T10:23:52.066Z","permalink":"https://yuanchieh.page/posts/2018/2018-03-28-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8A/","title":"[æŠ€è¡“ç­†è¨˜] Designing Data-Intensive Applications ä¸Š"},{"content":"ä¸€é–‹å§‹æœƒæƒ³è®€é€™æœ¬æ›¸æ˜¯å› ç‚ºçœ‹åˆ°å­¸é•·çš„å¿ƒå¾—æ–‡ï¼Œç°¡ç•¥æåˆ°å°åˆ·æ™‚ä»£çš„æ€æƒ³æ¯”è…³æ·±å±¤å®Œæ•´ï¼Œè€Œé›»è¦–(ç¶²è·¯)æ™‚ä»£å‰‡æ˜¯ç‰‡æ–·ç‘£ç¢ï¼›\nç•¶åˆçœ‹å®Œå¿ƒå¾—ä¸å¤ªèªåŒï¼Œå› ç‚ºæˆ‘æœƒç›´è¦ºåœ°èªç‚ºèªªã€Œåª’é«”åªæ˜¯è¼‰å…·ï¼Œé‡é»æ˜¯äººçš„æ€æƒ³ã€ï¼Œä¹Ÿå°±æ˜¯è†šæ·ºçš„äººä¸è«–åœ¨å“ªå€‹æ™‚ä»£éƒ½æ˜¯è†šæ·ºçš„ï¼›\nå¾Œä¾†èˆ‡å­¸é•·ç•™è¨€è¨è«–ä¸€ä¸‹ï¼Œç™¼ç¾é€™æœ¬æ›¸çš„è«–è¿°é æ¯”æˆ‘æƒ³åƒçš„æ·±é ï¼Œä»Šæ—¥æ‹œè®€å¾Œæ·±æ„Ÿé«”æ‚Ÿè‡ªå·±çš„è†šæ·ºï¼Œæ‰€ä»¥ç‰¹æ­¤ç´€éŒ„è®€å¾Œæ„Ÿã€‚\nè‡ªæˆ‘èƒŒæ™¯ä¸¦éå‚³æ’­åª’é«”ç›¸é—œï¼Œéå»ä¹Ÿé®®å°‘æ¥è§¸æ­¤é¡å‹çš„æ›¸ï¼Œæ‰€ä»¥çœ‹èµ·ä¾†è »ç¡¬çš„ï¼Œå»åˆå¾ˆéç™®ï¼Œæ­£å› ç‚ºå°‘æ¥è§¸æ‰€ä»¥åœ¨æ¥æ”¶ä¸€äº›æ–°è§€é»æ™‚æœƒååˆ†çš„éœ‡æ’¼ã€‚\næ›¸ç±èƒŒæ™¯ é€™æ¬¡æˆ‘è²·çš„æ˜¯20é€±å¹´å†ç‰ˆçš„ç‰ˆæœ¬ï¼Œæ­¤æ›¸å‡ºç‰ˆæ–¼1985å¹´ä»£ï¼Œè™•æ–¼é›»è¦–è“¬å‹ƒç™¼å±•çš„ä¸–ä»£ï¼Œä½œè€… æ³¢èŒ²æ›¼æ˜¯è‘—åçš„åª’é«”æ–‡åŒ–ç†è«–å®¶ï¼Œè«‡è«–åˆ°åª’é«”å—åˆ°è¼‰å…·ç§‘æŠ€çš„ä¸åŒï¼Œå°è‡´äººé¡æ–‡åŒ–ä¸Šèˆ‡æ€æƒ³ä¸Šçš„æƒ¡è¡Œè½‰è®Šï¼Œé›–ç„¶é€™æœ¬æ›¸æ˜¯è«–è¿°é›»è¦–æ™‚ä»£ï¼Œä½†æ˜¯å…¶è§€é»åœ¨ç¶²è·¯æ™‚ä»£æ›´å€¼å¾—å»çœæ€ã€‚\né€™æœ¬æ›¸æˆ‘è‡ªå·±æ‹†æˆä¸‰å€‹éƒ¨åˆ†\nåª’é«”å‚³æ’­æ–¹å¼å°æ–¼æ€æƒ³çš„å½±éŸ¿ï¼š\nå‰å…©å€‹ç« ç¯€ä½œè€…èˆ‰äº†ä¸€äº›æ¡ˆä¾‹èªªæ˜ï¼Œé †ä¾¿é‡é‡çš„æ‰“è‡‰æˆ‘å‰›æ‰çš„å‡è¨­ å°åˆ·å¼æ€æƒ³ é›»è¦–å¼æ€æƒ³ åª’é«”å‚³æ’­æ–¹å¼å°æ–¼æ€æƒ³çš„å½±éŸ¿ ä¸åŒçš„åª’é«”åå¥½ç‰¹å®šçš„å…§å®¹ï¼Œå¾è€Œå¾—ä»¥æ”¯é…æ–‡åŒ–ï¼Œä½œè€…èˆ‰ä¾‹åˆ° åŸå§‹çš„ç…™éœ§è¨Šæ¯æŠ€è¡“æ˜¯æ²’è¾¦æ³•å‚³éå“²ç†ï¼Œå› ç‚ºé™£é™£çš„ç…™éœ§ä¸å¤ è¤‡é›œï¼Œæ‰€ä»¥ã€Œå½¢å¼æœƒæ’æ–¥å…§å®¹ã€\nåŒæ¨£çš„åœ¨é›»è¦–è¢å…‰å¹•ä¸Šï¼Œå¦‚æœç¸½çµ±å€™é¸äººæ˜¯å€‹135å…¬æ–¤çš„è¶…é‡é«”é‡ï¼Œç†è«–ä¸Šå€‹äººæ€æƒ³å…§å®¹ä¸è©²ç”¨å…¶å¤–è¡¨ä¾†è¡¡é‡ï¼Œä½†æ˜¯é€éè¦–è¦ºå½±åƒå‚³é”å°±ä¸å…æœƒæŠ¹æ®ºå…¶è¨€è«–çš„ç²¾å¦™ï¼ŒåŒç†ã€Œå½¢å¼æœƒæ’æ–¥å…§å®¹ã€\næ­¤å¤–ï¼Œã€ŒçœŸç†æ¦‚å¿µçš„è¡¨é”å’Œè¡¨é”å½¢å¼å”‡é½’ç›¸ä¾ã€ï¼Œä¾‹å¦‚èªªåœ¨åšç ”ç©¶å ±å‘Šæ™‚æ›¸é¢æ–‡ç»çš„å¯ä¿¡åº¦é æ¯”å£èªæ–‡ç»ä¾†å¾—é«˜ï¼Œå› ç‚ºæ›¸é¢æ–‡å­—æ¯”è¼ƒå®¹æ˜“é©—è­‰ã€é§æ–¥ä¸”å®¢è§€ï¼›\næ‰€ä»¥äº‹å¯¦é™³è¿°å½¢å¼çš„é‡è¦ç¨‹åº¦éƒ½è¦–å‚³åª’çš„å½±éŸ¿åŠ›é‡è€Œå®šã€‚\nå°åˆ·å¼æ€æƒ³ ä½œè€…å®šç¾©äº†ä¸€å€‹ã€Œé—¡é‡‹æ™‚ä»£ã€ï¼Œé—¡é‡‹æ˜¯ç¨®æ€ç¶­æ¨¡å¼ï¼Œä¸€ç¨®å­¸ç¿’æ–¹å¼èˆ‡è¡¨é”é€”å¾‘ï¼ŒåŒ…å«è‘—å„ªç•°çš„æ¦‚å¿µã€æ¨ç†å’Œæ¢ç†æ€è€ƒèƒ½åŠ›ã€å´‡å°šç†æ€§å’Œç§©åºã€å®¢è§€æ€ç¶­ç­‰ç­‰ï¼›\nä½œè€…æè¿°æ—è‚¯å’Œé“æ ¼æ‹‰æ–¯çš„ä¸ƒå ´è‘—åè¾¯è«–ï¼Œæ•´å€‹é›„è¾¯çš„éç¨‹é”ä¸ƒå°æ™‚ä¹‹ä¹…!è¨è«–å…§å®¹æ¶µè“‹äº†æ­·å²äº‹ä»¶ã€æ”¿æ²»è­°é¡Œã€å»¢å¥´æ”¿ç¶±ç­‰ï¼Œè¬›è©å…§å®¹è™•è™•åæ‡‰å°åˆ·å¼æ€ç¶­ï¼ŒåŒ…å«è«–è­‰èˆ‡åè­‰ã€ä¸»å¼µèˆ‡å°ç«‹ä¸»å¼µã€åŸºæ–¼æ–‡æœ¬çš„æ‰¹è©•å’Œæª¢é©—å°æ‰‹çš„æªè¾­ï¼Œè½çœ¾ä¸å–®éœ€è¦æœ‰è±å¯Œçš„èƒŒæ™¯çŸ¥è­˜ï¼Œé‚„éœ€è¦æœ‰å°æ–¼å…¬çœ¾äº‹å‹™åƒèˆ‡çš„ç†±æƒ…èˆ‡ç†æ€§çš„æ‰¹åˆ¤æ€è€ƒï¼Œè€Œé€™ç¾¤è½çœ¾åœ¨ç•¶æ™‚ä¸æ˜¯å°‘æ•¸çš„è²´æ—èè‹±ï¼Œè€Œæ˜¯ä¸‹è‡³è²©å¤«èµ°å’éƒ½æœ‰é€™æ¨£çš„æ€ç¶­èƒ½åŠ›ã€‚\næ­£å› ç‚ºä½¿ç”¨ç´”æ–‡å­—è¡¨é”ï¼Œé‡é»è‘—é‡åœ¨æ–‡å­—ä¹˜è¼‰çš„æ„å¿µï¼Œæ‰€ä»¥å…§å®¹å¾€å¾€æ›´åŠ åš´è‚…èˆ‡è±å¯Œï¼Œä¸è«–æ˜¯ä½œè€…æˆ–é–±çœ¾éƒ½ç¿’æ…£ç†æ€§æ€è€ƒå»ç†è§£å†·éœçš„æŠ½è±¡å…§å®¹ï¼Œä¸¦ç”¨åš´è‹›çš„æ…‹åº¦å»æª¢è¦–å…§å®¹å‰å¾Œçš„ä¸€è‡´æ€§èˆ‡åˆç†æ€§ã€‚\né›»è¦–å¼æ€æƒ³ åä¹ä¸–ç´€ä¸­æœŸï¼Œé›»å ±æ”¹è®Šå‚³éè³‡è¨Šçš„æ–¹å¼ï¼Œä»¥æ¥µå¿«çš„é€Ÿåº¦è·¨è¶Šæµ©ç€šçš„è·é›¢ï¼Œé€™æ”¹è®Šäº†ä»¥å¾€å°åˆ·æ™‚ä»£è¿½æ±‚ç†æ€§çš„è¨´æ±‚ï¼Œè½‰è®Šæˆè¿½æ±‚æ™‚æ•ˆæ€§ã€èª‡é£¾æ€§çš„æ–°èï¼›\nä½œè€…æå‡ºæ‰€è¬‚çš„è¡Œå‹•è³‡è¨Šæ¯”ï¼Œæ„å³æ”¶åˆ°çš„è³‡è¨Šæœƒæœ‰å¤šå¤§çš„æ¯”ä¾‹å°è‡´è¡Œå‹•çš„æ”¹è®Šï¼Œåœ¨å°åˆ·æ™‚ä»£é€™å…©è€…çš„æ¯”è¼ƒé›·åŒï¼›\nä½†æ˜¯åœ¨é›»å ±æ™‚ä»£ä¹‹å¾Œï¼Œå› ç‚ºè³‡è¨Šå¤§é‡ç”¢ç”Ÿèˆ‡ç ´ç¢åŒ–ï¼Œäººå€‘é¢å°è³‡è¨Šéå‰©ï¼Œå°è‡´é¢è‡¨ç¤¾æœƒèˆ‡æ”¿æ²»è¡Œç‚ºèƒ½åŠ›ä¹Ÿé€æ­¥è¡°å¼±ï¼Œä¾‹å¦‚èªª è¦æ€éº¼ä¿è­·ç’°å¢ƒã€å¦‚ä½•é™ä½æ ¸æˆ°é¢¨éšªã€é€šè²¨è†¨è„¹ç‡ã€å¤±æ¥­ç‡èˆ‡çŠ¯ç½ªç‡ç­‰å•é¡Œï¼Œé›–ç„¶ç¾ä»Šæ–°èè™Ÿç¨±åœ‹éš›åŒ–ï¼Œæˆ‘å€‘å¸¸å¸¸åœ¨é›»è¦–éƒ½å¯ä»¥çœ‹åˆ°å„åœ‹çš„æ–°èå ±å°ï¼Œä½†æ“æœ‰é€™äº›ç ´ç¢åŒ–çš„è³‡è¨Šé ‚å¤šæ˜¯èŒ¶é¤˜é£¯å¾Œçš„è©±é¡Œï¼Œä½†ä¸èƒ½ææ˜‡æˆ‘å€‘çš„æ€ç¶­é€²è€Œå»ç”¨è¡Œå‹•è§£æ±ºå•é¡Œã€‚\n**ã€Œçµ¦æˆ‘å¨›æ¨‚ï¼Œå…¶é¤˜å…è«‡ã€\n**é€™æ˜¯æ›¸æœ¬çš„å…¶ä¸­ä¸€å€‹ç« ç¯€åï¼Œé—¡è¿°åœ¨é›»è¦–è«–è¿°ä¸­å¨›æ¨‚æ˜¯å”¯ä¸€çš„è¡¨ç¾æ„è­˜å½¢æ…‹ï¼Œä»¥è¾¯è«–ç¯€ç›®ç‚ºä¾‹ï¼Œè¾¯è«–çš„éç¨‹åœ¨æ–¼æ€è€ƒä¸¦åé§å°æ–¹è«–è¿°ï¼Œä½†æ˜¯é€™æ¨£ã€Œæ€è€ƒã€çš„éç¨‹åœ¨é›»è¦–ç¯€ç›®ä¸Šæ˜¯ä¸è¨å¥½çš„ï¼Œæ‰€ä»¥å¾ˆé›£åœ¨é›»è¦–è¾¯è«–ç¯€ç›®ä¸Šçœ‹åˆ°ã€Œè®“æˆ‘æƒ³æƒ³ã€ã€ã€Œä½ èªªçš„â€¦æ˜¯ä»€éº¼æ„æ€ã€ã€ã€Œä½ çš„è³‡æ–™æ˜¯å¼•è¿°å“ªäº›ä¾†æºã€ç­‰è«–è¿°ï¼Œå› ç‚ºé€™æœƒæ‹–æ…¢ç¯€ç›®é€Ÿåº¦ï¼Œä¹Ÿå®¹æ˜“è®“è§€çœ¾æ„Ÿåˆ°ç„¡èŠï¼Œä½†ååé€™äº›å»æ˜¯æ‰¹åˆ¤æ€è€ƒé‡è¦çš„éç¨‹ï¼›\nå–è€Œä»£ä¹‹çš„æ˜¯è¡¨æ¼”è—è¡“ä¸”å¨›æ¨‚æ„Ÿåè¶³çš„æ¼”èªªï¼Œå°±å¥½æ¯” 1984å¹´çš„é›»è¦–ç¸½çµ±è¾¯è«–æœƒï¼Œæ¯å€‹å€™é¸äººå¯ç™¼è¨€äº”åˆ†é˜ä¸¦è³ªå•å°æ‰‹ä¸€åˆ†é˜ï¼Œè©¦å•é€™éº¼çŸ­çš„æ™‚é–“å¦‚ä½•é—¡è¿°ã€Œä½ å°ä¸­ç¾æ´²çš„å¤–äº¤æ”¿ç­–ç‚ºä½•ã€é€™æ¨£çš„å•é¡Œå‘¢?\næ‰€ä»¥å€™é¸äººæ³¨é‡çš„ä¸å†æ˜¯å¦‚ä½•è¡¨è¿°è‡ªå·±çš„ç†å¿µï¼Œæ›´é‡è¦çš„æ˜¯å¦‚ä½•åœ¨çŸ­çŸ­çš„æ•¸åˆ†é˜å…§å»ºç«‹ã€Œå°è±¡ã€\næœ€å¾Œä½œè€…æåˆ° æ•™è‚²å°±æ˜¯å¨›æ¨‚ï¼Œé€™æ˜¯å€‹åè«·çš„æ¨™é¡Œï¼Œåœ¨åæ€è²åé æ’­çš„é›»è¦–æ•™è‚²ç¯€ç›® èŠéº»è¡—ï¼Œä½œè€…æå‡ºé›»è¦–æ•™è‚²ç‚ºäº†è¿åˆé›»è¦–ç¯€ç›®çš„ç‰¹æ€§æœ‰å¹¾å¤§ç‰¹è‰²ï¼š\néš¨æ™‚å¯ä»¥åŠ å…¥ã€ä¸å¾—ä»¤äººå¿ƒç”Ÿç–‘æƒ‘ã€é é é¿é–‹é—¡é‡‹ï¼Œæ‰€ä»¥æˆ‘å€‘åªèƒ½åœ¨èŠéº»è¡—ä¸­å­¸åˆ°ç ´ç¢åŒ–çš„çŸ¥è­˜ï¼Œå¯èƒ½å¹¾å€‹å–®å­—ã€å¹¾å¥ç‰‡èªï¼Œä½†æˆ‘å€‘æ°¸é å­¸ä¸æœƒçœŸæ­£çš„å­¸ç¿’æ–¹æ³•ï¼Œå› ç‚ºå­¸ç¿’æ–¹æ³•æœ€åŸºæœ¬çš„ä¾¿æ˜¯é•·æœŸæ€ç´¢æŸå€‹é›£é¡Œï¼Œä½†é›»è¦–ç¯€ç›®æœ¬èº«å°±æ˜¯ç‚ºäº†å¨›æ¨‚ï¼Œå¼·åŠ æ•™è‚²ç›®çš„æ–¼ä¸Šé ­æ ¹æœ¬é”ä¸åˆ°æ•ˆæœï¼Œåªèƒ½è‡ªæ¬ºæ¬ºäººã€‚\nç•¶ç„¶æœ‰ä¸€é»å¾ˆé‡è¦ï¼Œä½œè€…ä¸¦ä¸æ’æ–¥å¨›æ¨‚ï¼Œä½†æ˜¯ç•¶æ‰€æœ‰å½¢å¼éƒ½ä»¥å¨›æ¨‚å‘ˆç¾å°±éå¸¸å¯æ€•\nçµèª ä½œè€…åœ¨æ›¸ä¸­åè¦†æåˆ°å…©æœ¬æ›¸ ã€Š1984ã€‹ã€ã€Šç¾éº—æ–°ä¸–ç•Œã€‹ï¼Œå…©è€…éƒ½æ˜¯åœ¨è«‡è«–æ°‘çœ¾æœƒæœ‰å¢®è½çš„è¶¨å‹¢ï¼Œå‰è€…ç†å¿µæ˜¯é«˜å£“æ”¿åºœä½¿æ°‘çœ¾å±ˆæœï¼›å¾Œè€…æåŠæˆ‘å€‘ç„¡éœ€å¤–åŠ›çµ‚å°‡æ¯€æ–¼è‡ªèº«æ‰€æ„›ï¼Œåœ¨é€™é›»è¦–æ™‚ä»£ï¼Œä½œè€…èªåŒèµ«èƒ¥é» ã€Šç¾éº—æ–°ä¸–ç•Œã€‹çš„è§€é»ï¼Œç¾åœ¨æˆ‘å€‘ä¸ç”¨æ“”å¿ƒçœŸç›¸æœƒè¢«éš±è—ï¼ŒçœŸæ­£è©²æ“”å¿ƒçš„æ˜¯çœŸç›¸è¢«ç¹ç‘£çš„å°äº‹çµ¦æ·¹æ²’ã€‚\n","date":"2018-03-27T12:10:32.066Z","permalink":"https://yuanchieh.page/posts/2018/2018-03-27-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97-%E5%A8%9B%E6%A8%82%E8%87%B3%E6%AD%BB/","title":"[é–±è®€å¿ƒå¾—] å¨›æ¨‚è‡³æ­»"}]