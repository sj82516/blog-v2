<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="斯斯有好幾種，UUID 總共有 v1~v5，本篇將從 RFC 文件開始，並介紹 js 中 uuid 的實作方式，幫助大家找到適合的 UUID 方案"><title>UUID 原理與實作分析 - 該如何挑選適合的 UUID 版本</title><link rel=canonical href=https://yuanchieh.page/posts/2020/2020-12-01-uuid-%E5%8E%9F%E7%90%86%E8%88%87%E5%AF%A6%E4%BD%9C%E5%88%86%E6%9E%90-%E8%A9%B2%E5%A6%82%E4%BD%95%E6%8C%91%E9%81%B8%E9%81%A9%E5%90%88%E7%9A%84-uuid-%E7%89%88%E6%9C%AC/><link rel=stylesheet href=/scss/style.min.ff300df33b80e2ac49809c825614392ed1c7b27591d65d3c4043602cd162e25f.css><meta property="og:title" content="UUID 原理與實作分析 - 該如何挑選適合的 UUID 版本"><meta property="og:description" content="斯斯有好幾種，UUID 總共有 v1~v5，本篇將從 RFC 文件開始，並介紹 js 中 uuid 的實作方式，幫助大家找到適合的 UUID 方案"><meta property="og:url" content="https://yuanchieh.page/posts/2020/2020-12-01-uuid-%E5%8E%9F%E7%90%86%E8%88%87%E5%AF%A6%E4%BD%9C%E5%88%86%E6%9E%90-%E8%A9%B2%E5%A6%82%E4%BD%95%E6%8C%91%E9%81%B8%E9%81%A9%E5%90%88%E7%9A%84-uuid-%E7%89%88%E6%9C%AC/"><meta property="og:site_name" content="Yuanchieh"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2020-12-01T08:21:40+00:00"><meta property="article:modified_time" content="2020-12-01T08:21:40+00:00"><meta name=twitter:title content="UUID 原理與實作分析 - 該如何挑選適合的 UUID 版本"><meta name=twitter:description content="斯斯有好幾種，UUID 總共有 v1~v5，本篇將從 RFC 文件開始，並介紹 js 中 uuid 的實作方式，幫助大家找到適合的 UUID 方案"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-82837682-4","auto"),ga("send","pageview"))</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82837682-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-82837682-4")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars0.githubusercontent.com/u/6858460?s=460&amp;v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Yuanchieh</a></h1><h2 class=site-description>生命是長期而持續的累積</h2></div></header><ol class=social-menu><li><a href=https://github.com/sj82516 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#rfc-4122>RFC 4122</a><ol><li><a href=#412--layout-and-byte-order>4.1.2. Layout and Byte Order</a></li><li><a href=#413--version>4.1.3. Version</a></li><li><a href=#414--timestamp>4.1.4. Timestamp</a></li><li><a href=#415--clock-sequence>4.1.5. Clock Sequence</a></li><li><a href=#416--node>4.1.6. Node</a></li><li><a href=#421--basic-algorithm>4.2.1. Basic Algorithm</a></li><li><a href=#43--algorithm-for-creating-a-name-based-uuid>4.3. Algorithm for Creating a Name-Based UUID</a></li><li><a href=#45--node-ids-that-do-not-identify-the-host>4.5. Node IDs that Do Not Identify the Host</a></li><li><a href=#6--security-considerations>6. Security Considerations</a></li></ol></li><li><a href=#uuidjs-實作拆解>uuid.js 實作拆解</a><ol><li><a href=#uuid-v1-實作>UUID v1 實作</a></li></ol></li><li><a href=#後記作者提交-proposal-給-tc39>後記：作者提交 proposal 給 tc39</a><ol><li><a href=#tifu-by-using-mathrandom-文章重點摘要>TIFU by using Math.random() 文章重點摘要</a><ol><li><a href=#prng-實作>PRNG 實作</a></li></ol></li></ol></li><li><a href=#其他>其他</a></li><li><a href=#結論>結論</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/algorithm/>Algorithm</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2020/2020-12-01-uuid-%E5%8E%9F%E7%90%86%E8%88%87%E5%AF%A6%E4%BD%9C%E5%88%86%E6%9E%90-%E8%A9%B2%E5%A6%82%E4%BD%95%E6%8C%91%E9%81%B8%E9%81%A9%E5%90%88%E7%9A%84-uuid-%E7%89%88%E6%9C%AC/>UUID 原理與實作分析 - 該如何挑選適合的 UUID 版本</a></h2><h3 class=article-subtitle>斯斯有好幾種，UUID 總共有 v1~v5，本篇將從 RFC 文件開始，並介紹 js 中 uuid 的實作方式，幫助大家找到適合的 UUID 方案</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 01, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>UUID 是一個被大量使用的演算法，分散式地產生大量<code>不重複且固定為 128 bit</code>的 ID，分散式是指說多台機器每秒同時產生多筆 UUID，有極大概率這些 UUID 都不會發生重複，不需要有一台機器居中負責 ID 的管控與發放，反例像是 MySQL 資料庫中的 auto increment id</p><p>先提重點，如何選擇 UUID v1 ~ v5，參考 <a class=link href=https://stackoverflow.com/questions/20342058/which-uuid-version-to-use target=_blank rel=noopener>Which UUID version to use?</a></p><ol><li><strong>v4</strong>: 完全隨機，沒有特殊需求選這個，根據 uuid.js 統計有 <code>77%</code> 用戶選擇這個</li><li><strong>v1</strong>: 組成包含 timestamp 與機器識別碼(MAC Address)，如果需要識別由哪一台機器在什麼時間點產生可以選這個，根據 uuid.js 統計有 <code>21%</code> 用戶選擇這個</li><li><strong>v5 & v3</strong>: 可以指定 Namespace 與 Name，相同的 Namespace 與 Name 會產生相同的 UUID，v3 雷同 v5，差別在於 v5 會採用 SHA1 當作 Hash function 而 v3 採用 MD5，除了相容性等考量，否則請優先採用 v5，根據 uuid.js 統計有 <code>1%</code> 用戶選擇這個</li><li><strong>v2</strong>: 不採用，連 RFC 文件也只有帶到定義，沒有實作規範</li></ol><p>需要特別注意，如果是使用 <a class=link href=https://github.com/uuidjs/uuid target=_blank rel=noopener>uuid.js</a> 的 v1，uuid 實作是沒有採用 MAC Address，所以如果有識別同一台機器產生的 uuid 的需求，需要自己另外實作，後面有更詳盡的補充</p><p>以下將摘要 <a class=link href=https://tools.ietf.org/html/rfc4122 target=_blank rel=noopener>RFC 4122 - A Universally Unique IDentifier (UUID) URN Namespace </a>，並比對每週有將近四百萬下載的 uuid.js 實作，有詢問作者一些細節，他也非常熱心補充很多有棒的資料，會一並整理分享</p><h2 id=rfc-4122>RFC 4122</h2><p>UUID 共有 128 bits，以下是 v1 實作規範</p><h3 id=412--layout-and-byte-order>4.1.2. Layout and Byte Order</h3><p><img src=/post/img/20201201/uuid.png loading=lazy><br>以下將介紹每個欄位的組成</p><h3 id=413--version>4.1.3. Version</h3><p>UUID 版本夾在 time_hi_and_version 最高效位元(most significant)中 4~7 bit，所以從 UUID string 就能看出版號</p><h3 id=414--timestamp>4.1.4. Timestamp</h3><p>Timestamp 總共是 60 bits，對於 UUID v1 來說是 UTC 時間且自 1582/10/15 00:00:00 (the date of Gregorian reform to the Christian calendar) 開始計算，如果機器沒有 UTC 時間，可以採用 local time，但是要確保 local time 是穩定的</p><h3 id=415--clock-sequence>4.1.5. Clock Sequence</h3><p>如果系統時間發生倒轉，或是 Node ID 發生改變，則會增加碰撞的可能性，所以透過 Clock Sequence 來紀錄，如果發現產生過的 UUID 採用的 Timestamp 比當下的時間還要晚時 (意即 Clock 時間被倒轉)，則 clock sequence 遞增，初始化則隨機產生</p><p>另外如果 Node ID 發生改變，那最好也將 clock sequence 隨機重置，降低碰撞的風險</p><p>需注意 clock sequence 的設定最好是在系統啟動後設定一次就不要再改變，降低跨系統產生碰撞的風險</p><h3 id=416--node>4.1.6. Node</h3><p>Node ID 採用 <code>IEEE 802 MAC address</code>，如果有多個 MAC Address 任一挑一個有用的即可，如果沒有則隨機產生</p><p>以上是 v1 的欄位意義，v3、v5 則是把 Name 加上 Namespace 取雜湊，接著分配至上述的欄位中，v4 則全部隨機產生</p><h3 id=421--basic-algorithm>4.2.1. Basic Algorithm</h3><p>接著看最基本的演算法實作流程</p><ol><li>取得系統級別的全域鎖</li><li>讀取系統設定檔，包含 clock_seq / node id / timestamp</li><li>計算出 timestamp</li><li>取得 node id</li><li>如果保存 node id 與讀取的 node id 不同，重新設定 clock_seq</li><li>當前 timestamp 小於保存的 timestamp，clock_seq + 1</li><li>將目前計算的值保存回去</li><li>釋放鎖</li><li>將目前的 timestamp / clock_seq / node id 組合出 uuid</li></ol><p>如果要高頻率製造 uuid，會遇到以下幾個效能貧頸與對應解法</p><ol><li><code>每次存系統讀取資料很沒效率</code>:<br>僅需要再系統啟動時讀取一次進 memory 即可，假設系統沒有穩定儲存空間，則每次都要隨機產生 clock_seq，這會導致碰撞機率增加，應該要盡量避免；如果確定 node id 都不會變，也可以不用保存直接返回即可</li><li><code>system clock 粒度不見得有到 100-nanoseconds</code>:<br>System Clock Resolution：如果產生頻次不高，則直接將系統時間放大到 100-nano 的粒度即可，但如果系統單一時間產生過多 uuid，實作必須返回錯誤，或是暫停產生，直到系統時間正常，如果要提高粒度，也可以是在同一個系統時間內累計產生的 uuid 個數，</li><li><code>每次要回寫系統資料很沒效率</code><br>只需要定時更新儲存資料即可，將 timestamp 設定在比至今產生的 UUID 使用的 timestamp 大一點，但又不要大到超過 reboot 時的所需要的啟動時間，目的在於降低 clock sequence 重置的機會，在下方的建議實作中是每 10 秒寫入一次</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=n>timestamp</span> <span class=o>&gt;=</span> <span class=n>next_save</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;state&#34;</span><span class=p>,</span> <span class=s>&#34;wb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>fwrite</span><span class=p>(</span><span class=o>&amp;</span><span class=n>st</span><span class=p>,</span> <span class=k>sizeof</span> <span class=n>st</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* schedule next save for 10 seconds from now */</span>
</span></span><span class=line><span class=cl>      <span class=n>next_save</span> <span class=o>=</span> <span class=n>timestamp</span> <span class=o>+</span> <span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li><code>跨進程分享狀態很沒效率</code><br>如果跨進程共享狀態很耗資源，可以每個進程切割一塊時間區段個別產生 uuid ，直到時間區段用完才去要新的</li></ol><h3 id=43--algorithm-for-creating-a-name-based-uuid>4.3. Algorithm for Creating a Name-Based UUID</h3><p>v3 跟 v5 主要是在某一特定的 Namespace 下針對 Name 產生對應的 UUID，有以下特性</p><ol><li>相同的 namespace 相同的 name，不同系統時間一樣有相同的 uuid</li><li>相同 namespace 下不同 name，uuid 不同</li><li>相同 name 不同 namespace，uuid 不同</li><li>如果兩個 uuid 相同，則代表 namespace / name 相同</li></ol><p>UUID 欄位則是透過 Name + Namespace 雜湊後的值去派發</p><h3 id=45--node-ids-that-do-not-identify-the-host>4.5. Node IDs that Do Not Identify the Host</h3><p>如果 MAC Address 不能使用，有幾種做法能保證 Node ID 的獨一性</p><ol><li>去跟 IEEE 聲請獨立區段的位址，在文件編寫時期價格是 US$550</li><li>使用密碼學強度的隨機碼取最低位 47 bit，最高 bit 設定為 1，主要是避開 IEEE 中 MAC Address 的區段<blockquote><p>常見做法是在 buffer 中隨機累積一段資料，接著用 SHA1 或 MD5 取 48 bits，然後把最高 bit 設定為 1</p></blockquote></li></ol><h3 id=6--security-considerations>6. Security Considerations</h3><p>UUID 並不保證隨機性，所以不會很難猜，所以不能拿來做跟安全性有關的業務</p><blockquote><p>Do not assume that UUIDs are hard to guess</p></blockquote><p>以上大概挑個重點帶過</p><h2 id=uuidjs-實作拆解>uuid.js 實作拆解</h2><p>以下將閱讀<a class=link href=https://github.com/uuidjs/uuid target=_blank rel=noopener>uuid.js github repo</a>的原始碼，在開始看 v1~v5 的實作前，先看一個用於產生隨機數的重要函式 <a class=link href=https://github.com/uuidjs/uuid/blob/master/src/rng.js target=_blank rel=noopener>rng.js</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>crypto</span> <span class=nx>from</span> <span class=s1>&#39;crypto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>rnds8Pool</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span> <span class=c1>// # of random values to pre-allocate
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>poolPtr</span> <span class=o>=</span> <span class=nx>rnds8Pool</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>rng</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>poolPtr</span> <span class=o>&gt;</span> <span class=nx>rnds8Pool</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>16</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>crypto</span><span class=p>.</span><span class=nx>randomFillSync</span><span class=p>(</span><span class=nx>rnds8Pool</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>poolPtr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>rnds8Pool</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>poolPtr</span><span class=p>,</span> <span class=p>(</span><span class=nx>poolPtr</span> <span class=o>+=</span> <span class=mi>16</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>程式碼很短，主要就是產生一個 rnds8Pool 陣列，隨機塞入數值，最後每次回傳 16 bit，如果這一段 rnds8Pool 都回傳了，就在一次產生新的隨機亂數</p><p>這可以保證產生 <code>Generates cryptographically strong pseudo-random data.</code>，來自 Nodejs 官方文件的保證，也是 uuid 不會有高碰撞機率的保證，切記 Math.random 不足夠隨機，拿來使用問題會很多</p><h3 id=uuid-v1-實作>UUID v1 實作</h3><p>以下挑重點說，不得不說作者的程式碼以及註解寫得很乾淨，直接標明實作對應的 RFC 段落</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>seedBytes</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>random</span> <span class=o>||</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>rng</span> <span class=o>||</span> <span class=nx>rng</span><span class=p>)();</span>
</span></span></code></pre></td></tr></table></div></div><p>先產生隨機數備用，在前面文件介紹中，有用到隨機產生的都會從 seedBytes 中提取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>node</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>node</span> <span class=o>=</span> <span class=nx>_nodeId</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>|</span> <span class=mh>0x01</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>這裡可以看到，實作中的 <code>node_id是每次啟動時隨機產生</code>，這符合文件 4.1.6，沒有採用 MAC Address 自己亂數產生也可以；<br>同時這一段我有特別留一個 Issue 詢問作者，為什麼不照文件規範去拿機器的 MAC Address，他回答到<code>基於隱私問題</code>，而且如果 Node ID 跟 Clock Seq 每次都隨機產生也是符合文件規範的</p><blockquote><p>I believe that this comes close to the idea of the spec while avoiding the privacy problems that come with trying to derive a stable node ID from hardware.</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>clockseq</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Per 4.2.2, randomize (14 bit) clockseq
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>clockseq</span> <span class=o>=</span> <span class=nx>_clockseq</span> <span class=o>=</span> <span class=p>((</span><span class=nx>seedBytes</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=nx>seedBytes</span><span class=p>[</span><span class=mi>7</span><span class=p>])</span> <span class=o>&amp;</span> <span class=mh>0x3fff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>沒有 clockseq 就亂數產生</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Per 4.2.1.2 Throw error if too many uuids are requested
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>nsecs</span> <span class=o>&gt;=</span> <span class=mi>10000</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s2>&#34;uuid.v1(): Can&#39;t create more than 10M uuids/sec&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果實作者發現短時間內有太大量的 uuid 產生，需要拋出錯誤或是暫停 uuid 生成避免碰撞</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// `time_low`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>tl</span> <span class=o>=</span> <span class=p>((</span><span class=nx>msecs</span> <span class=o>&amp;</span> <span class=mh>0xfffffff</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10000</span> <span class=o>+</span> <span class=nx>nsecs</span><span class=p>)</span> <span class=o>%</span> <span class=mh>0x100000000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>tl</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>24</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>tl</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>tl</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=nx>tl</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// `time_mid`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>tmh</span> <span class=o>=</span> <span class=p>((</span><span class=nx>msecs</span> <span class=o>/</span> <span class=mh>0x100000000</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10000</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xfffffff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>tmh</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=nx>tmh</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// `time_high_and_version`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=p>((</span><span class=nx>tmh</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>24</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x10</span><span class=p>;</span> <span class=c1>// include version
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>tmh</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>產生 time 相關欄位</p><p>v4 實作相當簡單，就是保留 version，其餘塞隨機數；
v3,v5 大同小異，所以作者寫了一個 v35.js ，重點大概就這麼幾行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Compute hash of namespace and value, Per 4.3
</span></span></span><span class=line><span class=cl><span class=c1>// Future: Use spread syntax when supported on all platforms, e.g. `bytes =
</span></span></span><span class=line><span class=cl><span class=c1>// hashfunc([...namespace, ... value])`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>16</span> <span class=o>+</span> <span class=nx>value</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>bytes</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>namespace</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>bytes</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>bytes</span> <span class=o>=</span> <span class=nx>hashfunc</span><span class=p>(</span><span class=nx>bytes</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>把 namespace 跟 value 合起來然後 hash 過，接著就按照文件塞到對應的位置</p><h2 id=後記作者提交-proposal-給-tc39>後記：作者提交 proposal 給 tc39</h2><p>作者在 PR 中有說到他提了一個 proposal 給 tc39 <a class=link href=https://github.com/tc39/proposal-uuid#arent-v1-uuids-better-because-they-are-guaranteed-to-be-unique target=_blank rel=noopener>proposal-uuid</a>，目前還在 stage 0，希望把 uuid 產生變成 js 的規範，主要是有太多錯誤且粗心的實作，例如使用 Math.random 等，這邊引用一篇非常棒的文章指出為什麼 Math.random 不好 <a class=link href=https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d target=_blank rel=noopener>TIFU by using Math.random()</a>，以下將摘錄重點</p><h3 id=tifu-by-using-mathrandom-文章重點摘要>TIFU by using Math.random() 文章重點摘要</h3><blockquote><p>TIFU => Today I Fucked Up</p></blockquote><p>作者公司採用 microservice，但他們希望可以追蹤每個 request 在 service 中交互結果，所以需要有一個全域的 request id，需要一個隨機生成演算法產生足夠隨機的 id</p><p>所謂的足夠隨機包含兩點</p><ol><li>足夠大的 identifier space：有足夠多的組合與可能性</li><li>足夠隨機的 identifier generation：有了足夠多的 identifier space，還需要足夠隨機的生成機制</li></ol><p>作者決定用長度 22 的 base 64，也就是 space 有 64^22 這麼大，generation 則是用 decent pseudo-random number generator (PRNG) 常見的演算法，V8 即是採用這一套，如果足夠隨機，那這樣的空間足以<code>預計每秒產生一百萬次也要三百年才會碰撞</code>，多麼的美好</p><p>最後作者兜出來的程式碼如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ALPHABET</span> <span class=o>=</span> <span class=s1>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>random_base64</span> <span class=o>=</span> <span class=kd>function</span> <span class=nx>random_base64</span><span class=p>(</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>rand</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=nx>ALPHABET</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>str</span> <span class=o>+=</span> <span class=nx>ALPHABET</span><span class=p>.</span><span class=nx>substring</span><span class=p>(</span><span class=nx>rand</span><span class=p>,</span> <span class=nx>rand</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看起來一點問題都沒有，也是大家常見的隨機生成做法</p><p>但是在不久後同事發現 ID 碰撞了 💥</p><blockquote><p>“Anyone who considers arithmetical methods of producing random digits is, of course, in a state of sin.” From John von Neumann
意即要透過數學方式產生真正隨機根本是不可能</p></blockquote><h4 id=prng-實作>PRNG 實作</h4><p>簡單看一下偽隨機數的生成方式之一 PRNG (pseudo random number generator)
<img src=https://miro.medium.com/max/700/1*_rpSUn6ekuZvXJnT5bWUbw.png loading=lazy>
來自原文的圖片</p><p>簡單來說就是會有一個初始的 Seed，接著按照數學公式算出一個對應的位置，所以只有經過幾次輪轉，所以要用 finite state 產生隨機數是不可能的，只要 PRNG 持續產生，那最終輸出會重複出現 <code>Periodic</code>，作者比遇到， PRNG 就像一本壓縮的密碼本本包含著一串數字，Seed 像是你挑某一頁開始看，接著一路往下翻，到書尾再從書首開始看起，終將輪迴</p><p>不過只要 Cycle 的長度長到在有限時間內不會發生即可，這也決定 PRNG 演算法品質，稱之為 <code>full-cycle generator</code></p><blockquote><p>If a PRNG’s state has a k-bit representation, the cycle length is less than or equal to 2ᵏ. A PRNG that actually achieves this maximum cycle length is called a full-cycle generator.</p></blockquote><p>良好的 PRNG 會盡可能達到 2ᵏ 上限</p><p>後面有一段再說明 Chrome 當時的 Math.random 演算法錯誤，所以實際上 590 million 就會發生循環，更糟糕的是基於生日悖論，產生僅僅 3 萬次就會有 50% 的碰撞機會 (50% chance of collision after generating just 30,000 identifiers.)</p><p>最後的結論是如果要<code>採用偽隨機生成數請用 CSPRNG(cryptographically secure PRNG)</code>，或是採用系統核心基於外部噪音、網路封包等產生的真隨機數 <code>urandom</code></p><h2 id=其他>其他</h2><p>今天路過看到一篇關於 UUID 的好文 <a class=link href=https://medium.com/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B-uuid-2748df80aa7e target=_blank rel=noopener>閒談軟體架構：UUID</a>，主要更深入探討如果把 UUID 當作資料庫的 Key 對於效能的影響，主目的是希望能達到 <code>分散式產生遞增的 Key</code>，UUID v1 算是有符合這個要求，但因為有做過 timestamp 的拆分，導致 Java 實作在比對時會有點問題<br>可以自己客製化 UUID 的格式，或乾脆自創，參考其他實作如 Twitter Snowflake(已 deprecated) 或是 <a class=link href=https://firebase.googleblog.com/2015/02/the-2120-ways-to-ensure-unique_68.html target=_blank rel=noopener>Firebase Push ID</a>，大抵上都脫離不了 <code>timestamp 加上亂數或是加上機器識別碼</code>的做法</p><h2 id=結論>結論</h2><p>ID 是常用的屬性，用來抽象化指向某個物件/事件，選擇正確的方式產生 ID，才不會對於系統產生效能貧頸，透過學習 UUID 的實作過程，看到分散式產生 ID 的方式，尤其是在大數據時代，快速產生獨一(且遞增)的 ID 尤為基礎且重要，而在之中<code>隨機性</code>在整個過程扮演著很關鍵的角色</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/2022/2022-06-01-%E5%88%B7%E9%A1%8C%E9%95%B7%E7%9F%A5%E8%AD%98mercle-tree-%E8%AD%98%E5%88%A5%E5%AD%90%E6%A8%B9%E7%9B%B8%E5%90%8C%E8%88%87%E5%90%A6/><div class=article-details><h2 class=article-title>【刷題長知識】Mercle tree 識別子樹相同與否</h2></div></a></article><article><a href=/posts/2022/2022-05-23-%E7%AE%97%E6%B3%95segment-tree-%E8%88%87-binary-indexed-tree-%E8%A7%A3%E9%A1%8C%E6%95%B4%E7%90%86/><div class=article-details><h2 class=article-title>【算法】Segment Tree 與 Binary Indexed Tree 解題整理</h2></div></a></article><article><a href=/posts/2020/2020-11-17-sketch-data-structure-bloom-filter-%E4%BB%8B%E7%B4%B9%E8%88%87%E5%AF%A6%E4%BD%9C/><div class=article-details><h2 class=article-title>Sketch Data Structure - Bloom Filter 介紹與實作</h2></div></a></article><article><a href=/posts/2020/2020-11-03-raft-%E6%BC%94%E7%AE%97%E6%B3%95%E4%BB%8B%E7%B4%B9%E8%88%87in-search-of-an-understandable-consensus-algorithm%E6%91%98%E8%A6%81/><div class=article-details><h2 class=article-title>Raft 演算法介紹與《In Search of an Understandable Consensus Algorithm》摘要</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//yuanchieh.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Yuanchieh</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.17.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>