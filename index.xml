<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Yuanchieh</title><link>https://yuanchieh.page/</link><description>Recent content on Yuanchieh</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Wed, 17 May 2023 00:21:40 +0000</lastBuildDate><atom:link href="https://yuanchieh.page/index.xml" rel="self" type="application/rss+xml"/><item><title>ã€Šå½¼å¾—åŸç†ã€‹èˆ‡ã€Šå½¼å¾—è™•æ–¹ã€‹å¿ƒå¾—åˆ†äº«</title><link>https://yuanchieh.page/posts/2023/2023-05-17-%E5%BD%BC%E5%BE%97%E5%8E%9F%E7%90%86%E8%88%87%E5%BD%BC%E5%BE%97%E8%99%95%E6%96%B9%E5%BF%83%E5%BE%97%E5%88%86%E4%BA%AB/</link><pubDate>Wed, 17 May 2023 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-05-17-%E5%BD%BC%E5%BE%97%E5%8E%9F%E7%90%86%E8%88%87%E5%BD%BC%E5%BE%97%E8%99%95%E6%96%B9%E5%BF%83%E5%BE%97%E5%88%86%E4%BA%AB/</guid><description>&lt;p>&lt;code>å½¼å¾—åŸç†&lt;/code>æ˜¯å½¼å¾—åšå£«è§€å¯Ÿçœ¾å¤šä½æ•ˆçµ„ç¹”æ‰€å¾—å‡ºçš„çµè«– &lt;sup>1&lt;/sup>&lt;/p>
&lt;blockquote>
&lt;p>åªæœ‰å‡é·çš„æ©Ÿæœƒå¤ å¤šå¤ é »ç¹ï¼Œæœ€çµ‚äººå€‘éƒ½æœƒæŠµå¾—ä¸é©ä»»çš„è·ä½&lt;/p>
&lt;/blockquote>
&lt;p>é€™äº›ä¸é©ä»»çš„äººåšå‡ºä¸æ°ç•¶çš„æ±ºç­–ï¼Œå°è‡´æ•´å€‹çµ„ç¹”çš„æ•ˆèƒ½èˆ‡ç”¢å‡ºååˆ†ä½è½ï¼Œä½†æœ‰è¶£çš„æ˜¯é€™äº›ä¸é©ä»»çš„äººä¸æ˜¯åˆ»æ„æ“ºçˆ›ï¼Œç”šè‡³åœ¨ä»–å€‘å‡è·ä¹‹å‰éƒ½æ˜¯&lt;code>å„ªç§€ä¸”é©ä»»çš„å“¡å·¥&lt;/code>&lt;sup>2&lt;/sup>ï¼Œåˆ°åº•ç™¼ç”Ÿæ‰æœƒç”¢ç”Ÿé€™æ¨£çš„æ‚²åŠ‡ï¼Ÿæˆ‘å€‘åˆè©²å¦‚ä½•é¿å…é€™æ¨£çš„æ‚²åŠ‡ç™¼ç”Ÿå‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="é€ æˆå½¼å¾—åŸç†çš„åŸå› ">é€ æˆå½¼å¾—åŸç†çš„åŸå› &lt;/h2>
&lt;p>ä¸»è¦æœ‰å…©å€‹&lt;/p>
&lt;ol>
&lt;li>æ‰¾å·¥ä½œçš„æŠ€èƒ½èˆ‡å¯¦éš›å·¥ä½œçš„æŠ€èƒ½ç„¡é—œ&lt;sup>3&lt;/sup>&lt;br>
ç•¶ä¸»ç®¡è·ä½ç©ºç¼ºæ™‚ï¼Œåº•ä¸‹æœ‰ä¸€æ‰¹å·¥ç¨‹å¸«ï¼Œé€™æ™‚å€™æœƒæ€éº¼å¾ä¸­é¸æ‹”å‡ºé©åˆçš„äººé¸ç•¶ä½œä¸»ç®¡ï¼Ÿæ˜¯é€éå¹´è³‡ã€è³‡æ­·é‚„æ˜¯èº«ç‚ºå·¥ç¨‹å¸«çš„å·¥ä½œèƒ½åŠ› ?!&lt;br>
ä¸»ç®¡å¿…é ˆæœ‰è‰¯å¥½çš„æºé€šèˆ‡ç®¡ç†èƒ½åŠ›ï¼Œå¦‚æœç”¨ä¸Šè¿°çš„å¹¾ç¨®æ–¹å¼éƒ½å¯èƒ½é¸å‡ºä¸é©ä»»çš„ä¸»ç®¡ï¼Œä¾‹å¦‚å¯«ç¨‹å¼é€Ÿåº¦å¾ˆå¿«çš„å·¥ç¨‹å¸«å‡ä¸Šä¸»ç®¡å¾Œä¾ç„¶è¦ªåŠ›è¦ªç‚ºï¼Œä¸æ‡‚çš„ç®¡ç†èˆ‡åˆ†é…å·¥ä½œï¼Œæ•´é«”çš„ç”¢èƒ½åªæœƒä¸‹é™&lt;br>
æ‰€ä»¥ç•¶&lt;code>ææ‹”çš„è©•ä¼°æ–¹å¼èˆ‡å¯¦éš›å·¥ä½œçš„æŠ€èƒ½è„«é‰¤&lt;/code>ï¼Œå°±å®¹æ˜“æœ‰ä¸é©ä»»çš„ç‹€æ³&lt;/li>
&lt;li>å½¼å¾—è‹¦æ¨‚è«–&lt;sup>4&lt;/sup>&lt;br>
&lt;code>å¦‚æœæŸç¨®è¡Œç‚ºå¸¶ä¾†æ­£é¢å›é¥‹ï¼Œé‚£æœªä¾†è©²è¡Œç‚ºå°±æœƒæŒçºŒç™¼ç”Ÿ&lt;/code>ï¼Œå¾å‹•ç‰©å¯¦é©—(å¦‚å¤å…¸åˆ¶ç´„)ï¼Œåˆ°äººé¡çš„ç¤¾æœƒåŒ–éç¨‹éƒ½æ˜¯å¦‚æ­¤
æˆ‘å€‘å¾å°å°±è¢«çŒè¼¸æˆç¸¾ã€é‡‘éŒ¢èˆ‡åœ°ä½çš„é‡è¦ï¼Œé€æ¼¸å…§åŒ–æˆæˆ‘å€‘çš„åƒ¹å€¼è§€å°±æ˜¯è¦ä¸æ–·çš„å¾€éšå±¤ä¸Šçˆ¬ï¼Œå¦‚æœä¸å¾€ä¸Šçˆ¬åè€Œæœƒè¢«å’è²¬&lt;br>
è¡ç”Ÿçš„å•é¡Œæ˜¯ã€Œç•¶æˆ‘å€‘å‡é·å¾Œç™¼ç¾ä¸é©ä»»ï¼Œé€šå¸¸ä¸æœƒæœ‰å¾€å¾Œé€€çš„æƒ³æ³•ã€ï¼Œåªèƒ½ç„¡é™çš„ä¸Šæ”€ç›´åˆ°ä¸é©ä»»ç‚ºæ­¢&lt;/li>
&lt;/ol>
&lt;h3 id="å½¼å¾—åŸç†çœ‹ä¼¼ä¾‹å¤–ä½†å…¶å¯¦ä¸æ˜¯ä¾‹å¤–">å½¼å¾—åŸç†çœ‹ä¼¼ä¾‹å¤–ä½†å…¶å¯¦ä¸æ˜¯ä¾‹å¤–&lt;/h3>
&lt;p>æœ‰æ²’æœ‰é•åå½¼å¾—åŸç†çš„å­˜åœ¨ï¼Ÿä¹Ÿå°±æ˜¯èªªã€Œäººé€£çºŒç²å¾—ææ‹”ä½†é‚„æ˜¯ä¾ç„¶é©ç”¨çš„éšæ®µã€ï¼Œä½œè€…æå‡ºå¹¾å€‹å¾ˆæœ‰è¶£çœ‹ä¼¼ä¾‹å¤–ä½†ä¸æ˜¯ä¾‹å¤–çš„æ¡ˆä¾‹&lt;sup>5&lt;/sup>&lt;/p>
&lt;ol>
&lt;li>é›è‚‹å‡é·&lt;br>
æœ‰æ™‚å€™æœƒçœ‹åˆ°æŸäº›èƒ½åŠ›ä¸è¶³çš„äººä¾ç„¶å¯ä»¥ç²å¾—ã€Œå‡é·ã€ï¼Œä½†é€™ç¨®å±¬æ–¼æ˜å‡æš—é™ï¼Œæ›å€‹æ›´å¥½çš„é ­éŠœä½†å…¶å¯¦æ‹”é™¤å¯¦è³ªçš„è² é¢å½±éŸ¿åŠ›&lt;/li>
&lt;li>å€’ç½®å½¼å¾—ï¼šé‡è¦–ç¨‹åºå‹éæ–¼çµæœ&lt;br>
å¸¸è¦‹æ–¼è¡Œæ”¿äººå“¡ï¼Œç˜‹ç‹‚çš„å¡«å¯«å„ç¨®è¡¨æ ¼å»ä¸æ€è€ƒé€™å°æ–¼çµæœæ˜¯å¦æœ‰å¹«åŠ©ï¼Œé€™èˆ‡çµ„ç¹”çš„æ–‡åŒ–æœ‰é—œï¼Œå¦‚æœçµ„ç¹”&lt;code>åœ¨æ„å“¡å·¥çš„ç©©å®šæ€§å‹éæ–¼èƒ½åŠ›&lt;/code>ï¼Œé‚£å°±æœƒé€ æˆé€™å€‹æƒ…æ³åŠ£åŒ–&lt;/li>
&lt;li>é©ä»»é«˜å³°ï¼šåœ¨è‡ªå·±ä½ç½®ç™¼æ®å“è¶Šçš„äººå¯èƒ½åªæ˜¯é”åˆ°é ‚å³°æ²’æœ‰ä½ç½®å¯ä»¥å‡é·&lt;br>
åœ¨æŸäº›é ˜åŸŸæœ‰äº›äººçˆ¬åˆ°é ‚å³°ä¾ç„¶é©ä»»ï¼Œä½†å¯èƒ½ä¸å®‰ä»½è·¨è¶³å…¶ä»–é ˜åŸŸè®“è‡ªå·±æœ€çµ‚ä¸é©ä»»ï¼Œä¾‹å¦‚å¸Œç‰¹å‹’æ˜¯å¥½çš„æ”¿æ²»å®¶ï¼Œä½†ä¸æ˜¯å¥½çš„å…ƒå¸¥&lt;/li>
&lt;li>éšç´šå»è§’è³ªï¼šç•¶è¡¨ç¾å¤ªå¥½åè€Œæœ‰å¯èƒ½è¢«èªç‚ºä¸é©ä»»ï¼Œå› ç‚ºå¯¦åŠ›å¥½åˆ°è¶³ä»¥æ“¾äº‚æ•´å€‹éšå±¤çš„ç©©å®š&lt;/li>
&lt;li>å­æ‰¿çˆ¶æ¥­&lt;/li>
&lt;/ol>
&lt;h3 id="å½¼å¾—åŸç†çœ‹å©šå§»sup11sup">å½¼å¾—åŸç†çœ‹å©šå§»&lt;sup>11&lt;/sup>&lt;/h3>
&lt;p>ç¤¾æœƒåƒ¹å€¼å°è‡´å…©æ€§å°æ–¼å½¼æ­¤çš„æœŸå¾…éé«˜ï¼Œå°è‡´è‡ªå·±æˆç‚ºä¸é©ä»»çš„ä¼´ä¾¶ï¼Œé€²è€Œå°è‡´ä¸å¹¸ç¦çš„å©šå§»&lt;/p>
&lt;blockquote>
&lt;p>ç°å§‘å¨˜é›–ç„¶é€éé­”æ³•è®Šæ¼‚äº®å«çµ¦ç‹å­ï¼Œä½†æœ‰æ²’æœ‰å¯èƒ½å› ç‚ºå®¶ä¸–èƒŒæ™¯ä¸åŒï¼Œç‹å­å¾ˆå¿«å°±å—ä¸äº†ç°å§‘å¨˜ä¸æ‡‚ç¦®ä¿—èˆ‡ä¸Šæµæ–‡åŒ– ?! åè€Œä½¿å¾—é€™å ´å©šå§»ä»¥æ‚²åŠ‡æ”¶å ´&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç—‡ç‹€">ç—‡ç‹€&lt;/h2>
&lt;p>æœ€å¾Œç•¶äººæŠµé”ä¸é©ä»»è·ä½æ™‚ï¼Œç¨±ç‚º&lt;code>ã€Œæœ€çµ‚è·ä½ç—‡å€™ç¾¤ã€&lt;/code>ï¼Œä»¥ä¸‹ä¾†çœ‹å„ç¨®ç›¸é—œçš„ç—‡ç‹€&lt;/p>
&lt;h3 id="å¤–é¡¯çš„ç—‡ç‹€">å¤–é¡¯çš„ç—‡ç‹€&lt;/h3>
&lt;p>é–‹å§‹ç”¨ä¸€äº›å¤–åœ¨ã€è™›ç„¡ç¸¹ç·²çš„äº‹æƒ…ä¾†æ©é£¾è‡ªå·±çš„ç„¡èƒ½ï¼Œæ¢åˆ—å¹¾å€‹è »æœ‰è¶£ä¸”å¸¸è¦‹çš„ç—‡ç‹€&lt;sup>6&lt;/sup>&lt;/p>
&lt;ul>
&lt;li>è®Šæ…‹è¾¦å…¬æ¡Œï¼šå·¨å¤§åŒ–è¾¦å…¬æ¡Œã€æª”æ¡ˆç™–&lt;/li>
&lt;li>é¡§å½±è‡ªæ†ï¼šå–œæ­¡å›æ†¶ç•¶å¹´ (é‚„åœ¨é©ä»»éšæ®µ)&lt;/li>
&lt;li>åœ–è¡¨ç‹‚ç†±&lt;/li>
&lt;li>åè¦†ç„¡å¸¸&lt;/li>
&lt;li>ç”¨å¤–è¡¨è©•æ–·äº‹æƒ…&lt;/li>
&lt;li>å£è‹¥æ‡¸æ²³ä¸çŸ¥æ‰€äº‘&lt;/li>
&lt;li>è‡ªå‰µåè©è‡ªæˆ‘è§£é‡‹&lt;/li>
&lt;/ul>
&lt;p>~ä½ çš„ä¸»ç®¡åˆä¸­äº†å¹¾é …å‘¢~&lt;/p>
&lt;h3 id="å…§åœ¨ç—‡ç‹€">å…§åœ¨ç—‡ç‹€&lt;/h3>
&lt;p>èƒƒæ½°ç˜ã€é«˜è¡€å£“ã€ä¾¿ç§˜ã€è…¹ç€‰ç­‰å£“åŠ›é€ æˆçš„æ–‡æ˜ç—…ï¼Œå¸¸å‡ºç¾åœ¨æ‰€è¬‚çš„ã€ŒæˆåŠŸäººå£«ã€èº«ä¸Šï¼Œé€™æ™‚å€™å¯èƒ½æœƒæ¡ç”¨æ²»æ¨™ä¸æ²»æœ¬çš„æ–¹å¼ï¼Œä¾‹å¦‚è½‰ç§»ç„¦é»åŸ¹é¤Šæ–°çš„èˆˆè¶£ç­‰ï¼Œä½†çœŸæ­£å•é¡Œæ˜¯ã€Œä¸é©ä»»ã€å°è‡´çš„å£“åŠ›éå¤§&lt;/p>
&lt;p>Pansci æœ€è¿‘çš„å½±ç‰‡ &lt;a class="link" href="https://www.youtube.com/watch?v=cE9JacHPxPY" target="_blank" rel="noopener"
>ç§‘å­¸å¯¦è­‰ã€Œå¿ƒæƒ…ä¸ä½³çœŸçš„æœƒé€ æˆæ¶ˆåŒ–ã€çš®è†šç™¼ç‚ã€å¿ƒè¡€ç®¡å¥åº·å•é¡Œã€ï¼Œä½†ç‚ºä»€éº¼ï¼Ÿ&lt;/a>ä½è­‰äº†å¿ƒæƒ…èˆ‡èº«é«”ç–¾ç—…çš„é—œè¯&lt;/p>
&lt;h2 id="å¦‚ä½•é¿å…ä¸é©ä»»çš„ç‹€æ³">å¦‚ä½•é¿å…ä¸é©ä»»çš„ç‹€æ³&lt;/h2>
&lt;p>ä¸»è¦åˆ†æˆå…©å€‹é¢å‘ï¼Œä¸€å€‹æ˜¯ã€Œå€‹äººè¦èªæ¸…ä¸æ‡‰è©²ç„¡ç¶«å¾€ä¸Šæ”€çˆ¬éšå±¤ã€ä»¥åŠã€Œç®¡ç†è€…æ‡‰è©²é¿å…å‡é·ä¸é©ä»»äººé¸ã€&lt;/p>
&lt;h3 id="å€‹äººç¯‡">å€‹äººç¯‡&lt;/h3>
&lt;p>å‰é¢æåˆ°å½¼å¾—è‹¦æ¨‚è«–ï¼Œäººè¢«ç¤¾æœƒåŸ¹é¤Šæˆåªèƒ½å¾å¤–åœ¨ç²å¾—å‹•æ©Ÿèˆ‡å¿«æ¨‚ï¼Œä½†æœ€é«˜å±¤æ¬¡æ‡‰è©²æ˜¯è¦ã€Œè‡ªæˆ‘è‚¯å®šã€ï¼Œé€™èƒŒå¾Œéœ€è¦æœ‰æ˜ç¢ºçš„å€‹äººç›®æ¨™ã€æ¸…æ™°çš„è¨ˆç•«é‚å‘ç›®æ¨™ã€æœ‰å¯é‡åŒ–çš„æŒ‡æ¨™æ™‚åˆ»æ³¨æ„é›¢ç›®æ¨™çš„è·é›¢ï¼Œæœ€çµ‚é€éè‡ªæˆ‘çš„æª¢è¦–ä¾†è‚¯å®šè‡ªå·±&lt;sup>7&lt;/sup>&lt;br>
æ“ºè„«å¤–åœ¨çš„åƒ¹å€¼è§€æ‰èƒ½å¸¶ä¾†çœŸæ­£çš„å¿«æ¨‚ï¼Œä¹Ÿå°±é¿å…æ‰ç„¡è¬‚çš„æ”€æ¯”èˆ‡ä¸é©ä»»çš„æ©Ÿæœƒ&lt;/p>
&lt;p>å¦‚ä½•è®“äººç”Ÿä¿æŒå¿«æ¨‚æ˜¯å€‹å¤§å“‰å•ï¼Œã€Šå½¼å¾—è™•æ–¹ã€‹åœ¨å€‹äººç¯‡åªæœ‰ç¨å¾®é»å‡ºä¸€äº›å¸¸è¦‹çš„ä½œæ³•ï¼Œä¾‹å¦‚é‹å‹•ã€éœå¿ƒã€ç›¤é»è‡ªå·±ç†±æ„›çš„äº‹æƒ…ã€è¨­å®šå€‹äººç›®æ¨™ç­‰&lt;/p>
&lt;p>å¯¦éš›é¢å°å‡é·æ™‚ï¼Œå¯ä»¥ç”¨å…©ç¨®å½¼å¾—é é˜²æ€§æ²»ç™‚ä¾†æ€è€ƒ&lt;/p>
&lt;ul>
&lt;li>è² é¢æ€è€ƒ&lt;sup>8&lt;/sup>&lt;br>
ä½¿ç”¨ã€Œæƒ³æƒ³æœªä¾†è¦è·Ÿä¸»ç®¡çš„ä¸»ç®¡å…±äº‹ã€å‡é·å¾Œçš„å·¥ä½œèˆ‡ç”Ÿæ´»å‹æ…‹æ˜¯å¦æƒ³è¦ï¼Ÿç•¶æœ‰äº†æ›´å¤šçš„éŒ¢æƒ³è¦åšä»€éº¼ï¼ŸçœŸçš„éœ€è¦å‡é·æˆ–æ›´å¤šçš„éŒ¢å—ï¼Ÿã€æ±ºå®šæ˜¯å¦è¦å‡é·&lt;/li>
&lt;li>å‡æ€§ä¸é©ä»»&lt;sup>9&lt;/sup>&lt;br>
åœ¨ä¸€äº›ç„¡æå°ˆæ¥­èƒ½åŠ›çš„å°æ¯›ç—…çŠ¯éŒ¯ï¼Œè®“åˆ¥äººèª¤ä»¥ç‚ºå·²ç¶“åˆ°é”ä¸é©ä»»ï¼Œé¿é–‹å‡é·æ©Ÿæœƒï¼Œåˆ‡è¨˜&lt;code>ä¸å¯ä»¥ç›´æ¥å›çµ•å‡é·&lt;/code>é€™æœƒè®“äººè¦ºå¾—æ²’æœ‰ä¸Šé€²å¿ƒç­‰è² é¢è§€æ„Ÿï¼Œè¦ç”¨æ¯”è¼ƒè¿‚è¿´çš„æ‰‹æ®µé”åˆ°ä¸å‡é·çš„ç›®çš„&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœå·²ç¶“å‡é·åˆ°ä¸é©ä»»éšç´šï¼Œå¯ä»¥ç”¨å½¼å¾—å®‰æ…°åŠ‘ä¾†ç·©è§£ç—‡ç‹€&lt;/p>
&lt;ul>
&lt;li>æ°¸ç„¡æ­¢ç›¡çš„æº–å‚™ï¼šé€ƒé¿å¯¦éš›åŸ·è¡Œ&lt;/li>
&lt;li>å°ˆç²¾æå¾®æœ«ç¯€çš„å°äº‹&lt;/li>
&lt;li>ä»¥å½¢è±¡è“‹éå·¥ä½œè¡¨ç¾&lt;/li>
&lt;li>åšè·Ÿå·¥ä½œå®Œå…¨ç„¡é—œçš„äº‹æƒ…&lt;/li>
&lt;li>æˆç‚ºè·å‹™ä»£ç†äººï¼šé¿å…äº†åŸæœ¬ä¸é©ä»»çš„è·ä½ï¼Œä¹Ÿä¸ç”¨æ‰¿æ“”ç¾æœ‰ä»£ç†è·ä½çš„è²¬ä»»&lt;/li>
&lt;/ul>
&lt;h3 id="ç®¡ç†è€…ç¯‡">ç®¡ç†è€…ç¯‡&lt;/h3>
&lt;p>ç®¡ç†è€…é¦–è¦ä¹‹é‡æ˜¯æ˜å®šç›®æ¨™èˆ‡è·ä½æ‰€éœ€çš„èƒ½åŠ›ï¼Œæ‰èƒ½ä¾æ­¤ä¾†è©•æ–·äººé¸æ˜¯å¦é©åˆï¼Œå¯ä»¥é€éè©¦è¡Œå‡é·ã€æš—ä¸­è€ƒæ ¸ã€æå‰åŸ¹é¤Šèƒ½åŠ›ç­‰æ–¹å¼ï¼Œå…ˆ&lt;code>ç¢ºä¿äººé¸æœ‰è¶³å¤ èƒ½åŠ›æ‰å‡é·&lt;/code>&lt;sup>9&lt;/sup>&lt;/p>
&lt;p>å¾€å¾Œé€€ä¸€æ­¥ï¼Œå‡é·åªæ˜¯ç®¡ç†è€…æ¿€å‹µå“¡å·¥çš„ä¸€ç¨®æ–¹å¼ï¼Œé€™é‚Šéœ€è¦äº†è§£åˆ°å“¡å·¥å·¥ä½œçš„å‹•æ©Ÿå› ç´ ï¼Œé€™é»åœ¨ã€Šä½ å¦‚ä½•è¡¡é‡ä½ çš„äººç”Ÿã€‹æ›¸ä¸­æœ‰ç‰¹åˆ¥è‘—é‡ &lt;code>é›™å› ç´ ç†è«–&lt;/code> &lt;sup>12&lt;/sup>&lt;/p>
&lt;blockquote>
&lt;p>é›™å› ç´ ç†è«–ï¼šè–ªæ°´åªæ˜¯ã€Œä¿å¥å› ç´ ã€ï¼Œå……å…¶é‡è®“ä½ ä¸è¨å­å·¥ä½œè€Œã€Œå…§åœ¨å‹•æ©Ÿã€æ‰æœƒè®“å·¥ä½œæ›´å¿«æ¨‚&lt;/p>
&lt;/blockquote>
&lt;p>æ›´è¿‘ä¸€æ­¥ä¾†èªªï¼Œ&lt;code>æ¶ˆæ»…ä¸å¿«æ¨‚ä¸æœƒä½¿ä½ å¿«æ¨‚!&lt;/code>ï¼Œé€™æ˜¯ä¸€å€‹è »æœ‰è¶£çš„è§€å¿µï¼Œæ›´é€²ä¸€æ­¥èªªæ˜å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://www.youtube.com/watch?v=s6g68rXh0go" target="_blank" rel="noopener"
>äººç”ŸçœŸæ­£çš„å¿«æ¨‚æ˜¯ä»€éº¼ï¼Ÿå¤§å¤šæ•¸äººéƒ½ç†è§£éŒ¯äº†&amp;hellip; â–º è½è½å“ˆä½›æ•™æˆæ€éº¼èªª - Dr. Arthur Brooks é˜¿ç‘ŸÂ·å¸ƒé­¯å…‹æ–¯&lt;/a>&lt;/p>
&lt;p>æ”¤é–‹æ‰€æœ‰çš„çå‹µè¾¦æ³•ï¼ŒåŒ…å«è–ªæ°´ã€å‡é·ã€æå‡åœ°ä½ã€ç¸¾æ•ˆè€ƒæ ¸ã€å“¡å·¥åˆ†æ½¤å¤–ï¼Œé‚„æœ‰è®šç¾ã€æˆæ¬Šã€å¼·åŒ–å“¡å·¥èƒ½åŠ›ç­‰æ–¹å¼&lt;sup>10&lt;/sup>ï¼Œéœ€è¦å¦¥å–„ä¾ç…§å“¡å·¥èƒ½åŠ›èˆ‡éšæ®µçµ¦èˆ‡å°æ‡‰çš„çå‹µå¦‚ &lt;a class="link" href="https://jctraining.co/situational-leadership-introduction/" target="_blank" rel="noopener"
>æƒ…å¢ƒå¼é ˜å°&lt;/a>ï¼Œ&lt;code>å–®ç´”ç”¨è–ªè³‡æˆ–å‡é·ä¸æ˜¯è‰¯å¥½çš„æ¿€å‹µè¾¦æ³•&lt;/code>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å½¼å¾—åšå£«åœ¨æ›¸ä¸­ç”¨æ¯”è¼ƒè«·åˆºè¾›è¾£çš„å£å»åœ¨æè¿°ï¼Œä¸¦å‰µé€ ä¸€å †å½¼å¾—å‰ç¶´çš„è©å½™ä¾†è«·åˆºç¾è±¡ï¼Œè®€èµ·ä¾†è »æœ‰è¶£çš„ï¼Œçœ‹åˆ°æŸä¸€äº›äººç‰©è¨­å®šèˆ‡å ´æ™¯è·Ÿä»¥å‰çš„å·¥ä½œç¶“é©—å»åˆä¸å…æœƒå¿ƒä¸€ç¬‘ï¼Œä½†çœ‹çœ‹åˆ¥äººæƒ³æƒ³è‡ªå·±ï¼Œä¹Ÿåœ¨æ€è€ƒè‡ªå·±æ˜¯å¦ä¸€ç›´è¢«å¤–åœ¨æ‰€é©…å‹•ï¼ŒæŠ‘æˆ–æ˜¯è‡ªå·±å·²ç¶“æˆç‚ºå½¼å¾—è€Œä¸è‡ªçŸ¥ (å¸Œæœ›é‚„æ²’)&lt;/p>
&lt;p>æ•´ç†ä¸Šé€™å…©æœ¬æ›¸è »å€¼å¾—ä¸€èµ·çœ‹ï¼Œã€Šå½¼å¾—è™•æ–¹ã€‹é€™æœ¬æ›¸å…§å®¹å€‹äººè¦ºå¾—æ¯”è¼ƒå–®è–„ï¼Œåªèƒ½èªªèœ»èœ“é»æ°´å¼æŠŠå¸¸è¦‹çš„ä½œæ³•æé»å‡ºä¾†ï¼Œä½†å…§å®¹æ¯”è¼ƒå°‘éœ€è¦å†å¾€ä¸‹é‘½ç ”&lt;/p>
&lt;hr>
&lt;h2 id="é™„éŒ„">é™„éŒ„&lt;/h2>
&lt;p>ç›®å‰å˜—è©¦ç”¨å¡ç‰‡ç›’ç­†è¨˜ &lt;a class="link" href="https://app.heptabase.com/w/2f64499816932c964fa39d53516e9a6fbda23bd863906fc1a04be9e9422ac40c" target="_blank" rel="noopener"
>heptabaseã€Šå½¼å¾—åŸç†ã€‹èˆ‡ã€Šå½¼å¾—è™•æ–¹ã€‹ç­†è¨˜&lt;/a>ï¼Œç›¡é‡æœƒæŠŠæ‘˜è¦å…§å®¹å°æ‡‰çš„æ›¸é é™„ä¸Šï¼Œæ–¹ä¾¿å›é ­æŸ¥é–±&lt;/p>
&lt;ol>
&lt;li>ã€Šå½¼å¾—åŸç†ã€‹p42&lt;/li>
&lt;li>ã€Šå½¼å¾—åŸç†ã€‹p48&lt;/li>
&lt;li>ã€Šå½¼å¾—åŸç†ã€‹p7&lt;/li>
&lt;li>ã€Šå½¼å¾—è™•æ–¹ã€‹p104&lt;/li>
&lt;li>ã€Šå½¼å¾—åŸç†ã€‹p54&lt;/li>
&lt;li>ã€Šå½¼å¾—åŸç†ã€‹p162&lt;/li>
&lt;li>ã€Šå½¼å¾—è™•æ–¹ã€‹p75&lt;/li>
&lt;li>ã€Šå½¼å¾—åŸç†ã€‹p219&lt;/li>
&lt;li>ã€Šå½¼å¾—è™•æ–¹ã€‹p189&lt;/li>
&lt;li>ã€Šå½¼å¾—è™•æ–¹ã€‹p213&lt;/li>
&lt;li>ã€Šå½¼å¾—è™•æ–¹ã€‹p30&lt;/li>
&lt;li>ã€Šä½ å¦‚ä½•è¡¡é‡ä½ çš„äººç”Ÿã€‹p54&lt;/li>
&lt;/ol></description></item><item><title>æ–°æ‰‹ç§Ÿå€Ÿéœ²ç‡Ÿè»Šèˆ‡ä¸‰å¤©å…©å¤œä¹‹æ—…</title><link>https://yuanchieh.page/posts/2023/2023-05-15-%E6%96%B0%E6%89%8B%E7%A7%9F%E5%80%9F%E9%9C%B2%E7%87%9F%E8%BB%8A%E8%88%87%E4%B8%89%E5%A4%A9%E5%85%A9%E5%A4%9C%E4%B9%8B%E6%97%85/</link><pubDate>Mon, 15 May 2023 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-05-15-%E6%96%B0%E6%89%8B%E7%A7%9F%E5%80%9F%E9%9C%B2%E7%87%9F%E8%BB%8A%E8%88%87%E4%B8%89%E5%A4%A9%E5%85%A9%E5%A4%9C%E4%B9%8B%E6%97%85/</guid><description>&lt;p>ä¹‹å‰å°æ–¼éœ²ç‡Ÿè»Šé‡ç‡Ÿä¸€ç›´å……æ»¿è‘—æƒ³åƒï¼Œæƒ³åƒè‡ªå·±å¯ä»¥å¾ˆè²¼è¿‘å¤§è‡ªç„¶ï¼Œç¡é†’æ‰“é–‹è»Šé–€å°±å¯ä»¥æ²ˆæµ¸åœ¨æµ·è²ã€å±±æ—ä¹‹ä¸­ï¼Œæœ€è¿‘æ’å‡ºä¸‰å¤©å…©å¤œç§Ÿå€Ÿ &lt;a class="link" href="https://www.facebook.com/GGV.studio/?locale=zh_TW" target="_blank" rel="noopener"
>GoodGoodVan&lt;/a>ï¼Œç°¡å–®åˆ†äº«ä¸€äº›å¿ƒå¾—èˆ‡å„ªåŠ£ï¼Œä»¥åŠç°¡æ˜“çš„è¡Œç¨‹è¡¨ä¾›å¤§å®¶åƒè€ƒ
&lt;img src="https://yuanchieh.page/post/2023/img/0515/car.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>ä¸»è¦æƒ³ä¸€å¤©çœ‹æµ·ä¸€å¤©çœ‹å±±ï¼Œæ‰€ä»¥ç¬¬ä¸€å¤©æŒ‘æˆ°è»Šæ³Šå¤–æ¾³è»Šç«™ï¼Œç¬¬äºŒå¤©å®šéœ²ç‡Ÿåœ° &lt;a class="link" href="https://www.easycamp.com.tw/Store_2419.html" target="_blank" rel="noopener"
>å¤è«¾ç‡Ÿç‡Ÿåœ°&lt;/a>&lt;/p>
&lt;h2 id="å„ªé»">å„ªé»&lt;/h2>
&lt;ol>
&lt;li>è²¼è¿‘å¤§è‡ªç„¶&lt;br>
æˆ‘å€‘ç¬¬ä¸€å¤©åœåœ¨å¤–æ¾³è»Šç«™å°é¢çš„åœè»Šä½ï¼Œä¸€æ—©æ‰“é–‹å°±çœŸçš„æ˜¯çœ‹æµ·è½æµªè²ï¼Œåœ¨å¤è«¾ç‡Ÿç‡Ÿåœ°æ™šä¸Šå¯ä»¥çœ‹å¤œæ™¯ã€æ—©ä¸Šå°±æ˜¯çœ‹çœ‹æ²³æ™¯ï¼Œéå¸¸è¿·äºº&lt;/li>
&lt;li>é‹ªä¸Šç‡ˆå…·æ°£æ°›æ»¿åˆ†&lt;br>
ç¬¬ä¸€å¤©æ™šä¸Šæœ‰åˆ°å¤–æ¾³æ²™ç˜ä¸Šååï¼Œé‹ªä¸Šç‡ˆå…·æ•ˆæœåè¶³ï¼Œå¹è‘—æµ·é¢¨è²¼è‘—éŸ³æ¨‚ååˆ†æ„œæ„
&lt;img src="https://yuanchieh.page/post/2023/img/0515/ocean.png"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;h3 id="è»Šå­æœƒä¸æœƒä¸å¥½é–‹">è»Šå­æœƒä¸æœƒä¸å¥½é–‹&lt;/h3>
&lt;p>èº«ç‚ºä¸€å€‹æœˆé ‚å¤šåªé–‹ä¸€æ¬¡ iRent çš„é–‹è»Šå°ç™½ï¼Œä¸€é–‹å§‹ç§Ÿè»Šæœ‰é»æ€• Veryca (GoodGoodVan è»Šå‹)æœƒä¸æœƒå¤ªå¤§å°ä¸å¥½é–‹ï¼Œä½†å¯¦éš›é–‹äº†ä¸‰å¤©è¦ºå¾—æ²’ä»€éº¼å•é¡Œï¼Œé™¤äº†ç¢ºå¯¦è»Šèº«æ¯”è¼ƒé•·æ‰€ä»¥å€’è»Šæ¯”è¼ƒå›°é›£ï¼Œä½†å…¶é¤˜ä¸Šè·¯ã€åœè»Šéƒ½æ²’æœ‰å•é¡Œ&lt;/p>
&lt;p>ç”šè‡³æˆ‘è¦ºå¾—æ²¹é–€è¸©èµ·ä¾†æ¯” Toyota çš„ Yaris æœ‰åŠ› ğŸ˜† è€Œä¸”è»Šèº«æ¯”è¼ƒé«˜è¦–é‡è·Ÿåå§¿ä¹Ÿæ¯”è¼ƒèˆ’æœä¸€äº›ï¼Œåªæ˜¯åœ¨è½‰å½æ™‚é›¢å¿ƒåŠ›æœ‰é»æ˜é¡¯ç¨å¾®ä¸ç©©ï¼Œå…¶é¤˜ç‹€æ³éƒ½å¾ˆ OKï¼Œé–‹ä¸Šé«˜é€Ÿå…¬è·¯ä¹Ÿéƒ½æ²’ä»€éº¼ç‹€æ³&lt;/p>
&lt;h2 id="ç¼ºé»">ç¼ºé»&lt;/h2>
&lt;p>èªªå®Œå„ªé»ä¾†è¬›ä¸€äº›ç§Ÿè»Šå‰æ²’æ³¨æ„åˆ°çš„ç¼ºé»&lt;/p>
&lt;ol>
&lt;li>
&lt;p>éš±è”½æ€§è¼ƒå·®ï¼Œæ·ºçœ è€…å®¹æ˜“æœƒè¢«åµé†’&lt;br>
ç¬¬ä¸€å¤©æ˜¯è»Šæ³Šå¤–æ¾³è»Šç«™ï¼Œå‰›å¥½é‚£é‚Šæœ‰é…’å§é–‹æ¯”è¼ƒæ™šï¼Œæ‰€ä»¥éƒ½æœƒæœ‰äººè²è·Ÿèµ°å‹•è²ï¼Œå¾…åœ¨è»Šå…§å› ç‚ºéš”éŸ³ä¹Ÿæ²’æœ‰å¾ˆå¥½ï¼Œæ‰€ä»¥åªè¦æœ‰äººèµ°å‹•å°±æœƒè¢«åµé†’ä¸€ä¸‹ï¼Œç¡çœ å“è³ªä¸å¤ªå¥½ï¼›&lt;br>
ç¬¬äºŒå¤©åˆ°å¤è«¾ç‡Ÿç‡Ÿåœ°å‰›å¥½ç•¶å¤©åªæœ‰æˆ‘å€‘ä¸€çµ„å®¢äººï¼Œå¾ˆå®‰éœæ‰€ä»¥ç¡ä¸å¾—éŒ¯ï¼Œä½†å¦‚æœæœ‰å…¶ä»–çµ„ä¸€èµ·éœ²ç‡Ÿå°±ä¸ç¢ºå®šç¡çœ å“è³ªäº†&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è»Šå…§ç©ºæ°£ä¸æµé€š &lt;br>
GoodGoodVan å¾Œåº§åªæœ‰ä¸€æ‰‡å¯ä»¥å¤–æ¨çš„å°å¤–çª—ï¼Œå…¶é¤˜å¹¾é¢éƒ½ä¸èƒ½é–‹ï¼Œæ‰€ä»¥ç©ºæ°£å¾ˆä¸æµé€šï¼Œåœ¨å±±ä¸Šé‚„å¥½å¹³åœ°æ™šä¸Šå°±æœ‰é»æ‚¶ç†±&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®¤å…§å†·æ°£éå¸¸åµåŸºæœ¬ä¸èƒ½ç”¨ &lt;br>
å®¤å…§å†·æ°£å¿…é ˆæ¥é›»æ‰èƒ½å•Ÿå‹•ï¼Œä½†éå¸¸åµæˆ‘è¦ºå¾—ç¡è¦ºè¦é–‹æ ¹æœ¬ç¡ä¸è‘—ï¼Œç›´æ¥çœ‹å½±ç‰‡æ¯”è¼ƒå¯¦éš›
&lt;div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
&lt;iframe src="https://player.vimeo.com/video/827246024" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="vimeo video" webkitallowfullscreen mozallowfullscreen allowfullscreen>&lt;/iframe>
&lt;/div>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¾Œåº§çš„åºŠä¸å¥½ç¡&lt;br>
åºŠæ˜¯å¾Œåº§æ‰“å¹³ç›´æ¥ç¡ï¼Œä½†å¾Œåº§ä¸æ˜¯å®Œå…¨å¹³æ•´ï¼Œæ‰€ä»¥ç¡èµ·ä¾†è…°çš„éƒ¨åˆ†ç°ç©ºå…¶å¯¦ä¸å¤ªå¥½ç¡ï¼Œå¾Œä¾†æœ‰é‹ªå€‹ç¡è¢‹æ‰ç¨å¾®å¥½ä¸€äº›&lt;br>
æœ‰çœ‹ä¸€äº›æ¯”è¼ƒå¥½çš„éœ²ç‡Ÿè»Šè»Šæ¬¾æœƒæœ‰é¡å¤–çš„åºŠæ¿è·Ÿç¡å¢Šï¼Œé€™æ¨£æ¯”è¼ƒå¹³æ•´æ‡‰è©²æ‰æœƒæ¯”è¼ƒå¥½ç¡ï¼›åºŠçš„å°ºå¯¸å¤§æ¦‚å…©å€‹æˆäºº (170 cm) å‰›å‰›å¥½ï¼Œåœ¨é«˜ä¸€é»è…³å°±æœƒæ‡¸ç©ºäº†&lt;br>
&lt;img src="https://yuanchieh.page/post/2023/img/0515/bed.png"
loading="lazy"
>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæœ‰å¸¸åœ¨éœ²ç‡Ÿçš„ï¼Œç¼ºé»1 æ‡‰è©²ä¸æ˜¯å•é¡Œ / è‡³æ–¼ç¼ºé»2ã€3é–‹åˆ°å±±å€æ¯”è¼ƒæ¶¼çˆ½çš„åœ°æ–¹ä¹Ÿä¸æ˜¯å•é¡Œï¼Œç¼ºé»4 å°±è¦è‡ªå·±æº–å‚™ç¡å¢Šæˆ–æœ¬èº«æ˜“ç¡é«”è³ªæ‰èƒ½å¤ å…‹æœ&lt;/p>
&lt;h2 id="å…¶ä»–é›œè¨˜">å…¶ä»–é›œè¨˜&lt;/h2>
&lt;h3 id="è¡Œç¨‹ç°¡æ˜“æµæ°´å¸³">è¡Œç¨‹ç°¡æ˜“æµæ°´å¸³&lt;/h3>
&lt;p>Day1&lt;/p>
&lt;ol>
&lt;li>10 é»åœ¨æ·¡æ°´ç«™å–è»Š&lt;/li>
&lt;li>å…ˆå›å®¶è¼‰è¡Œæï¼Œç›´æ¥åˆ°å®œè˜­ &lt;a class="link" href="https://goo.gl/maps/G9VjX29ZmpLvSTg67" target="_blank" rel="noopener"
>å±‹å°æ‹‰éºµ&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/zKhZiaJcp1opo2ZGA" target="_blank" rel="noopener"
>å·æ¹¯&lt;/a>æ³¡ Spa åŠ è‡ªåŠ©æ™šé¤ï¼ŒSpa æœ‰å¤šç¨®å£å‘³çš„æº«æ³‰è »å¥‡ç‰¹ï¼Œæ™šé¤é‚„ç®—ä¸éŒ¯&lt;/li>
&lt;li>å¤œå®¿å¤–æ¾³è»Šç«™å°é¢åœè»Šå ´ï¼Œæœ‰é»ç†±æœ‰é»åµï¼Œå»ºè­°åœéå»ä¸€é»çš„å…¬å»æ¯”è¼ƒå®‰éœä¸€äº›&lt;/li>
&lt;/ol>
&lt;p>Day2&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/xAkRVzWnk5WCLsdw5" target="_blank" rel="noopener"
>é‡‘è»Šç”ŸæŠ€é¤Šæ®–ä¸­å¿ƒ&lt;/a>çœ‹ä¸€äº›æµ·æ´‹ç”Ÿç‰©é‚„ä¸éŒ¯&lt;/li>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/yYn8QHYLGxxruQ5ZA" target="_blank" rel="noopener"
>æ¨‚è‰²å±±&lt;/a> çœ‹ç©æœ¨ä½œå“ï¼Œå ´é¤¨ä¸å¤§ä½†è »æœ‰è¶£çš„ï¼Œè »å¤šæœ‰è¶£çš„æ”¶è—è·Ÿä½œå“&lt;/li>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/7Kr16ScVoAfUq5uS8" target="_blank" rel="noopener"
>å—æ–¹æ¾³æ¼æ¸¯&lt;/a> åƒåˆé¤è·Ÿè²·æ™šä¸Šé£Ÿæï¼Œå¤§æ¨ç”Ÿè¦ååˆ†çš„ç”œç¾ï¼Œé †ä¾¿è²·äº†è›¤è £å’Œå°ç« é­šï¼Œéå¸¸åˆ’ç®—&lt;/li>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/CUFkMdZsjBDRuyFh6" target="_blank" rel="noopener"
>å¤è«¾ç‡Ÿç‡Ÿåœ°&lt;/a>ä¸Šå±±çš„è·¯æœ‰é»å°æœ‰é»æŠ–ï¼Œä½†å±±ä¸Šçš„é¢¨æ™¯å¾ˆä¸éŒ¯ï¼Œç‡Ÿåœ°ä¹Ÿå¾ˆä¹¾æ·¨&lt;/li>
&lt;/ol>
&lt;p>Day3
ç°¡å–®è²·å€‹ä¼´æ‰‹ç¦®å°±å›ç¨‹&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/yd8UcSXQvC21sSuj7" target="_blank" rel="noopener"
>æ©˜ä¹‹é„‰&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://goo.gl/maps/PfV9nVNwsbR6So6s5" target="_blank" rel="noopener"
>æ½­é…µå¤©&lt;/a>&lt;/li>
&lt;li>åœ¨æ—é‚Šçš„&lt;a class="link" href="https://goo.gl/maps/4o4RMRFyeA1HVtna6" target="_blank" rel="noopener"
>é¾æ½­å®¢æ£§&lt;/a>åƒåˆé¤é‚„ä¸éŒ¯&lt;/li>
&lt;/ol>
&lt;h2 id="äº‹å‰æº–å‚™">äº‹å‰æº–å‚™&lt;/h2>
&lt;h3 id="éœ²ç‡Ÿè³‡è¨Š">éœ²ç‡Ÿè³‡è¨Š&lt;/h3>
&lt;ol>
&lt;li>åœ¨å°ç£ä¸€è¬›åˆ°éœ²ç‡Ÿå°±å¿…é ˆæåˆ° &lt;a class="link" href="https://www.google.com/maps/d/u/0/viewer?mid=1Q3JWYBEf6JQC8M4ei6cEojTesjg&amp;amp;ll=24.155626587627594%2C120.16868115000004&amp;amp;z=7" target="_blank" rel="noopener"
>è»ŠåºŠå¤©åœ°&lt;/a>ï¼Œå‡ºç™¼å‰åœ¨ä¸Šé¢æ±æ‰¾æ‰¾è¥¿æ‰¾æ‰¾æ‰æ‰¾åˆ°ç›®å‰çš„ä½ç½®&lt;/li>
&lt;li>éœ²ç‡Ÿåœ°ç§Ÿå€Ÿæ˜¯é€é&lt;a class="link" href="https://www.easycamp.com.tw/" target="_blank" rel="noopener"
>éœ²ç‡Ÿæ¨‚&lt;/a>ï¼Œä¸éé —å°·å°¬çš„å¹³å°ä¹‹å‰æœ‰ç™¼ç”Ÿéå€‹è³‡å¤–æ´©æˆ‘è€å©†æœ‰é‡åˆ°è©é¨™&amp;hellip; ä½†å› ç‚ºé‚„ç®—æ–¹ä¾¿æ‰€ä»¥æˆ‘å€‘é€™æ¬¡ä¹Ÿé‚„æ˜¯ç”¨é€™å€‹å¹³å°è¨‚è³¼&lt;/li>
&lt;li>Youtube é »é“ &lt;a class="link" href="https://www.youtube.com/watch?v=yvxj4Ps7uOA" target="_blank" rel="noopener"
>æ†‚å¨˜é§•é§›Outdoor&lt;/a>ï¼Œç•¶åˆæœƒæœ‰è»Šæ³Šçš„æƒ³æ³•ä¹Ÿæ˜¯å› ç‚ºçœ‹åˆ°é€™éƒ¨å½±ç‰‡ï¼Œæ‰æƒ³èªªæ‰¾å€‹åœ°é»è»Šæ³Šçœ‹çœ‹&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>è»Šæ³Šï¼šç›´æ¥ç¡è»Šä¸Šï¼Œåœåœ¨åœè»Šå ´ä¹‹é¡çš„åœ°æ–¹ï¼Œé€šå¸¸é™„è¿‘åªæœƒæœ‰å»æ‰€è€Œä¸æœƒæœ‰æ·‹æµ´çš„åœ°æ–¹&lt;/p>
&lt;/blockquote>
&lt;h3 id="goodgoodvan-ç›¸é—œ">GoodGoodVan ç›¸é—œ&lt;/h3>
&lt;p>ç§Ÿå€Ÿä¸‰å¤©å…©å¤œè²»ç”¨æ˜¯å‡æ—¥ 5800 + å¹³æ—¥ 4800 - çºŒå€Ÿå„ªæƒ  1000 å…± 9600ï¼Œå¦å¤– 5000 å…ƒæŠ¼é‡‘ï¼›&lt;br>
å–é‚„è»Šåœ°é»æ˜¯åœ¨é—œæ¸¡æ·é‹ç«™ï¼Œæ¯”è¼ƒå‹å–„æ˜¯ 10:00 a.m. ç§Ÿå€Ÿå¯ä»¥ç¬¬ä¸‰å¤© 10:00 p.m. å›è»Š (ç•¶å¤©ä¸‹è¨‚çš„å„ªæƒ )ï¼Œé€™æ¨£ç¬¬ä¸‰å¤©å°±ä¸æœƒå¤ªè¶•å¯ä»¥æ…¢æ…¢å›ç¨‹&lt;/p>
&lt;p>æ•´é«”ç§Ÿå€Ÿé‚„ç®—æ»¿æ„ï¼Œæœ‰é™„è´ˆè—ç‰™å–‡å­ã€æ°£æ°›ç‡ˆå…·ã€é‹å…·å¡å¼çˆï¼Œåªè¦è‡ªå·±åœ¨æº–å‚™ç¢—ç­·ã€é£Ÿæå³å¯ï¼Œä½†ä»–å€‘çš„é‹å…·æœ‰é»è€èˆŠå¯ä»¥çš„è©±å»ºè­°è‡ªå‚™
&lt;img src="https://yuanchieh.page/post/2023/img/0515/all.png"
loading="lazy"
>&lt;/p>
&lt;p>ä¹‹å‰çœ‹ä»–å€‘æœ‰ä¸Š&lt;a class="link" href="https://cars.tvbs.com.tw/car-news/110591" target="_blank" rel="noopener"
>ç¯€ç›®åˆ†äº«&lt;/a>ï¼Œ&lt;a class="link" href="https://www.instagram.com/goodgoodvan/" target="_blank" rel="noopener"
>IG ç¶“ç‡Ÿ&lt;/a>çš„ä¹Ÿä¸éŒ¯&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>èº«ç‚ºéœ²ç‡Ÿå°ç™½ï¼Œä¸‰å¤©å…©å¤œçš„è»Šéœ²é«”é©—è¦ºå¾—é‚„ä¸è³´ï¼Œæ™‚é–“å†é•·å¯èƒ½å°±è®Šæˆä¸€ç¨®æŠ˜ç£¨ XD åŒæ™‚ä¹Ÿè§£é–ä¸€å€‹æˆå°±ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†ä¾†ç§Ÿå…¶ä»–æ›´å¥½çš„éœ²ç‡Ÿè»Šé«”é©—çœ‹çœ‹&lt;/p></description></item><item><title>MongoDB Clustered Collection èˆ‡ Benchmark å¯¦é©—</title><link>https://yuanchieh.page/posts/2023/2023-05-05-mongodb-clustered-collection-%E8%88%87-benchmark-%E5%AF%A6%E9%A9%97/</link><pubDate>Fri, 05 May 2023 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-05-05-mongodb-clustered-collection-%E8%88%87-benchmark-%E5%AF%A6%E9%A9%97/</guid><description>&lt;p>æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡å¾ˆä¸éŒ¯çš„æ–‡ç« &lt;a class="link" href="https://medium.com/@hnasr/mongodb-internal-architecture-9a32f1403d6f" target="_blank" rel="noopener"
>MongoDB internal Architecture&lt;/a>ï¼Œä¸»è¦åœ¨æè¿° MongoDB Storage Engine çš„æ¼”é€²&lt;/p>
&lt;p>å…¶ä¸­åœ¨ 5.3 æ¯”è¼ƒå¤§çš„æ”¹è®Šæ˜¯å¼•å…¥äº† &lt;code>Clustered Collection&lt;/code> èª¿æ•´äº† Storage Engine å„²å­˜çš„æ©Ÿåˆ¶ï¼Œé€™ä¹Ÿé€£å¸¶å½±éŸ¿ MongoDB åœ¨ Collection ä¸Šçš„æ•ˆèƒ½è¡¨ç¾ï¼Œä»¥ä¸‹å¾æ–‡ç« ä¸­æ‘˜è¦ Storage Engine æ¼”é€²ï¼Œä¸¦é€é Benchmark å»é©—è­‰çœ‹çœ‹å¯¦éš›çš„è¡¨ç¾&lt;/p>
&lt;h2 id="mongodb-storage-engine-æ¼”é€²">MongoDB Storage Engine æ¼”é€²&lt;/h2>
&lt;h3 id="mmapv1">MMAPv1&lt;/h3>
&lt;p>æœ€ä¸€é–‹å§‹ MongoDB çš„ Storage Engine æ˜¯ MMAPv1ï¼Œæ¡ç”¨ B+Tree æ¶æ§‹ä»¥ &lt;code>_id&lt;/code> ç‚º primary keyï¼Œleaf node å„²å­˜ &lt;code>DiskLoc&lt;/code> ç›´æ¥æŒ‡å‘å„²å­˜æ–¼ç¡¬ç¢Ÿä¸Šçš„ä½ç½®(é€é file name + offset)
&lt;img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_5Io7l_SDSP_HSeH1iYaQ.png"
loading="lazy"
>&lt;/p>
&lt;p>MMAPv1 çš„å„ªé»æ˜¯æŸ¥è©¢é€Ÿåº¦å¾ˆå¿«ï¼Œåªéœ€è¦ O(logN) åœ¨ B+Tree æ‰¾åˆ° leaf node + O(1) å»ç¡¬ç¢Ÿè®€å–è³‡æ–™å³å¯&lt;/p>
&lt;p>ä½†æœ‰å¹¾å€‹é‡å¤§ç¼ºé»&lt;/p>
&lt;ol>
&lt;li>å› ç‚ºæ˜¯å„²å­˜å¯¦éš› Disk ä½ç½®ï¼Œæ‰€ä»¥ç•¶ &lt;code>document å› ç‚º insert / update / delete è€Œæ”¹è®Š Disk ä½ç½®&lt;/code> æ™‚ï¼Œå°±éœ€è¦å¤§è¦æ¨¡çš„æ”¹å¯« DiskLoc é€ æˆæ•ˆèƒ½çš„å½±éŸ¿&lt;/li>
&lt;li>å„²å­˜æ™‚æ²’æœ‰å£“ç¸®&lt;/li>
&lt;li>ä¸€é–‹å§‹åªæä¾› database level / collection level çš„ lockï¼Œé€™ä¹Ÿå°è‡´åœ¨ parallel åŸ·è¡Œä¸Šæ•ˆç‡ä¸é«˜&lt;/li>
&lt;/ol>
&lt;p>æœ€çµ‚åœ¨ &lt;a class="link" href="https://www.mongodb.com/docs/v6.0/release-notes/4.2-compatibility/" target="_blank" rel="noopener"
>MongoDB v4.2 å°±å…¨é¢ç§»é™¤äº†&lt;/a>&lt;/p>
&lt;h3 id="wiredtiger">WiredTiger&lt;/h3>
&lt;p>MongoDB åœ¨ 2014 å¹´æ”¶è³¼äº† &lt;a class="link" href="https://source.wiredtiger.com/11.0.0/index.html" target="_blank" rel="noopener"
>WiredTiger&lt;/a> é€™å€‹ Storage Engineï¼Œä¸¦æ–¼ 3.0 åŠ å…¥æ–¼ 3.2 è®Šæˆé è¨­çš„ Storage Engine&lt;/p>
&lt;p>åœ¨å„²å­˜ä¸ŠåŒæ¨£æ˜¯æ¡ç”¨ B+Tree çµæ§‹ï¼Œä½†é€™æ™‚å€™ &lt;code>_id&lt;/code> ä¸æ˜¯ Clustered Index Key è€Œæ˜¯åœ¨å…§éƒ¨ &lt;code>WiredTiger æœƒè‡ªå‹•ç‚ºæ¯å€‹ document è¨­å®š recordId ç•¶ä½œå„²å­˜æ’åºçš„ä¾æ“š&lt;/code>&lt;/p>
&lt;p>æ‰€ä»¥ &lt;code>_id&lt;/code> è·Ÿå…¶ä»– secondary index ç›¸åŒï¼Œéƒ½æ˜¯å…ˆåœ¨è‡ªå·±çš„ B+Tree ä¸ŠæŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°æ‡‰çš„ recordId å¾Œå†å» &lt;code>recordId Clustered Index&lt;/code> æœå°‹&lt;/p>
&lt;p>&lt;img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*urhOmzoY-JvXggjwRm9V-w.png"
loading="lazy"
>&lt;/p>
&lt;p>ä¹Ÿå› æ­¤ WiredTiger çš„ç¼ºé»æ˜¯æŸ¥è©¢è®Šæ…¢ä¸€äº›ï¼Œå› ç‚ºéœ€è¦æœå°‹å…©æ¬¡ B+Tree æ‰èƒ½å» Disk æ’ˆè³‡æ–™&lt;/p>
&lt;p>ä½†æœ‰å¹¾é …å„ªé»&lt;/p>
&lt;ol>
&lt;li>Insertã€Updateã€Delete æ•ˆèƒ½æ¯” MMAPv1 ç©©å®š&lt;/li>
&lt;li>æä¾› document level lockï¼Œå¤§å¹…æ”¹å–„ parallel æ•ˆèƒ½&lt;/li>
&lt;li>å£“ç¸® BSON åœ¨å„²å­˜ï¼Œæ¸›å°‘ Disk ç”¨é‡ä»£è¡¨å¯æ”¾é€² buffer pool çš„è³‡æ–™ç­†æ•¸ä¹Ÿå¢åŠ &lt;/li>
&lt;/ol>
&lt;p>æ ¹æ“šé€™ç¯‡æ–‡ç«  &lt;a class="link" href="http://smalldatum.blogspot.com/2015/07/linkbench-for-mysql-mongodb-with-cached.html" target="_blank" rel="noopener"
>Linkbench for MySQL &amp;amp; MongoDB with a cached database&lt;/a> çš„å¯¦é©—å¯ä»¥çœ‹åˆ° MongoDB WiredTiger åœ¨æŸ¥è©¢èˆ‡å¯«å…¥éƒ½åŠæ‰“å…¶ä»–çš„ Storage Engine
&lt;img src="http://3.bp.blogspot.com/-Hrkm07TpHYY/VZqVFtZrgaI/AAAAAAAABm4/LQEN2-HfQDw/s1600/image%2B%25288%2529.png"
loading="lazy"
>&lt;/p>
&lt;p>æœ‰è¶£çš„æ˜¯ MySQL å¯«å…¥ã€æŸ¥è©¢åŠæ‰“ MongoDB XD&lt;br>
åœ¨å–®æ©Ÿçš„ç’°å¢ƒä¸‹çœ‹èµ·ä¾†è€ç‰Œ RDBMS æ¯”è¼ƒå²å®³ï¼Œåªæ˜¯å¯¦éš›é¸æ“‡é‚„éœ€è¦å†è€ƒé‡åˆ° scalability ç­‰ç‹€æ³&lt;/p>
&lt;h3 id="wiredtiger-clustered-collection-åŸç†">WiredTiger Clustered Collection åŸç†&lt;/h3>
&lt;p>æ¥è‘—åˆ°äº† MongoDB 5.3 çš„ Clustered Collectionï¼Œå‰›å‰›æœ‰æåˆ°å¯¦éš›å…§éƒ¨å„²å­˜ä¾æ“šæ˜¯ç”¨ &lt;code>recordId&lt;/code> æ’åºï¼Œé‚£å¦‚æœç›´æ¥æ‹¿ &lt;code>_id ç•¶ä½œ Clustered Index çš„ key&lt;/code> æ˜¯ä¸æ˜¯å°±èƒ½æ›´åŠ é€Ÿå¯«å…¥è·ŸæŸ¥è©¢çš„æ•ˆç‡ï¼Ÿé€™æ­£æ˜¯ Clustered Collection æ‰€æ¡ç”¨çš„æ–¹å¼ï¼Œç›´æ¥æ‹¿ _id ç•¶ä½œ Clustered Index&lt;/p>
&lt;p>&lt;img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOQO6cVCj9PJ-HOWP6zmfw.png"
loading="lazy"
>&lt;/p>
&lt;p>æ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼Œåœ¨å»ºç«‹ Clustered Collection å°±å¿…é ˆæŒ‡å®šç”¨ _id å»ºç«‹ï¼ŒåŒæ™‚å¿…é ˆæ˜¯ unique&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">client&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;collection&amp;#34;&lt;/span>&lt;span class="o">].&lt;/span>&lt;span class="n">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">:clustered_index&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">:key&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="ss">:_id&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">:unique&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="kp">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ ¹æ“š&lt;a class="link" href="https://www.mongodb.com/docs/upcoming/core/clustered-collections/" target="_blank" rel="noopener"
>æ–‡ä»¶ Clustered Collections&lt;/a>æ‰€è¿°æœ‰å¹¾å€‹å„ªé»&lt;/p>
&lt;ol>
&lt;li>å¤§å¹…åº¦å¢åŠ  _id æœå°‹é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯ range scan ä¸Šï¼Œå› ç‚ºå°‘äº†ä¸€æ¬¡å»æŸ¥æ‰¾ recordId index&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Faster queries on clustered collections without needing a secondary index, such as queries with range scans and equality comparisons on the clustered index key.&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>å¢åŠ  CRUD çš„æ•ˆèƒ½&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Clustered collections have additional performance improvements for inserts, updates, deletes, and queries.&lt;/p>
&lt;/blockquote>
&lt;p>ä½†ä¹Ÿä¸æ˜¯å…¨ç„¶æ²’æœ‰å£è™•&lt;/p>
&lt;ol>
&lt;li>Secondary Index leaf node æœƒå„²å­˜ Clustered Index çš„ keyï¼Œè€Œå› ç‚ºå‰é¢æåˆ°åŸæœ¬ collection Clustered Index æ˜¯ç”¨ recordId(8byte)ï¼Œè€Œ _id é è¨­æ˜¯ 12byteï¼Œæ‰€ä»¥å°±ç›´æ¥å½±éŸ¿äº† Secondary Index çš„ size (å¢åŠ ç´„ 20%)&lt;/li>
&lt;li>&lt;code>_id æ˜¯ç”¨æˆ¶å¯ä»¥é è¨­ï¼Œå¦‚æœè¨­éŒ¯å¯èƒ½æœƒè®“æ•ˆèƒ½è®Šå·®&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ•´é«”ä¾†èªªç›®å‰ MongoDB Clustered Collection å„²å­˜æ–¹å¼æœ‰é»æ¥è¿‘ MySQLï¼ŒåŒæ¨£éƒ½æ˜¯&lt;/p>
&lt;ol>
&lt;li>æŒ‡å®š Primary Key ç•¶ä½œ Clustered Index å½±éŸ¿å¯¦éš›å„²å­˜çš„æ–¹å¼&lt;/li>
&lt;li>Secondary Index leaf node æŒ‡å‘ Clsutered Index&lt;/li>
&lt;/ol>
&lt;p>åŒæ¨£çš„å¦‚æœ _id æ˜¯æ¡ç”¨ UUID ç­‰äº‚åºï¼Œä¹ŸåŒæ¨£æœƒæœ‰æ•ˆèƒ½ä¸Šçš„å½±éŸ¿ï¼Œé€™éƒ¨åˆ†å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://www.percona.com/blog/uuids-are-popular-but-bad-for-performance-lets-discuss/" target="_blank" rel="noopener"
>UUIDs are Popular, but Bad for Performance â€” Letâ€™s Discuss&lt;/a>ï¼Œé€™é»å¾ŒçºŒ benchmark æœƒé©—è­‰&lt;/p>
&lt;h2 id="benchmark">Benchmark&lt;/h2>
&lt;p>é€éä»¥ä¸‹å¹¾å€‹å¯¦é©—ä¾†å¯¦éš›æª¢é©—ä¸€ä¸‹ MongoDB v6.0.5 Clustered Collection çš„æ•ˆèƒ½&lt;/p>
&lt;ol>
&lt;li>æ¯”å° CRUD åœ¨ Clustered Collection vs ä¸€èˆ¬ Collection å·®ç•°&lt;br>
é æœŸ CRUD åœ¨ Clustered Collection æ‡‰è©²è¦è¼ƒå¥½&lt;/li>
&lt;li>é‡å° Secondary Indexï¼Œæ¯”è¼ƒå¯¦éš›å¤§å°èˆ‡æ•ˆèƒ½&lt;br>
é æœŸ Secondary Index åœ¨ Clustered Collection å„²å­˜ç©ºé–“è¦æ¯”è¼ƒå¤§ï¼Œå¦‚æœå°ºå¯¸æ²’æœ‰å¤§åˆ°è¨˜æ†¶é«”å¡ä¸ä¸‹çš„ç‹€æ³ï¼Œæ•ˆèƒ½éƒ¨åˆ†é æœŸæ˜¯å·®ä¸å¤š&lt;/li>
&lt;li>_id æ”¹ç”¨ UUID å°æ–¼å¯«å…¥æ•ˆèƒ½çš„å½±éŸ¿&lt;br>
é æœŸ Clustered Collection æœƒæœ‰æ¯”è¼ƒå·®çš„è¡¨ç¾ï¼Œå› ç‚ºåº•å±¤å„²å­˜çµæ§‹çš„é—œä¿‚&lt;/li>
&lt;/ol>
&lt;p>ç›¸é—œç¨‹å¼ç¢¼åœ¨ &lt;a class="link" href="https://github.com/sj82516/mongodb-bm-cluster-collection" target="_blank" rel="noopener"
>sj82516/mongodb-bm-cluster-collection&lt;/a>&lt;/p>
&lt;h3 id="insert-æ¯”è¼ƒ">Insert æ¯”è¼ƒ&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0505/insert.png"
loading="lazy"
>&lt;/p>
&lt;p>å¯¦é©—æ¯å€‹ iteration æº–å‚™ 100 è¬ç­†è³‡æ–™ä¸¦ç”¨ insert_many æ‰¹æ¬¡å¯«å…¥ 1000 ç­†ï¼Œç¸½å…±æ’å…¥ 2000 è¬ç­†ï¼›å¯¦é©—çµ„æ˜¯ clustered collection ä½†å°ç…§çµ„ä¸æ˜¯&lt;/p>
&lt;p>å¾åœ–è¡¨ä¾†çœ‹ Clustered Collection æœ‰ç¨å¾®æ¯”è¼ƒå¥½ä½†æ²’æœ‰åˆ°éå¸¸æ˜é¡¯çš„è®ŠåŒ–&lt;/p>
&lt;h3 id="search-æ¯”è¼ƒ">Search æ¯”è¼ƒ&lt;/h3>
&lt;p>æ¸¬è©¦éç¨‹æœ‰ç™¼ç¾ä¸€å€‹ MongoDB çš„ bug &lt;a class="link" href="https://jira.mongodb.org/browse/SERVER-76905" target="_blank" rel="noopener"
>Performance Issue about Clustered Collection : where there are more than one _id search condition, the search would fallback to COLLSCAN&lt;/a>ï¼Œä¸»è¦æ˜¯ find æ¢ä»¶ä¸­æœ‰å¤šå€‹ _id æ™‚ index æœƒæ²’æœ‰åƒåˆ° clustered index å°è‡´æŸ¥è©¢éå¸¸æ…¢&lt;/p>
&lt;p>ä½†æœ‰è¶£çš„æ˜¯ secondary index ç›®å‰æ¸¬è©¦æ˜¯æ²’æœ‰é€™å€‹å•é¡Œçš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> user system total real
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cluster search 1.011011 0.095830 1.106841 ( 27.275139)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">normal search 0.405232 0.034662 0.439894 ( 0.449653)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user system total real
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cluster email search 0.417697 0.035939 0.453636 ( 0.556692)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">normal email search 0.407986 0.027175 0.435161 ( 0.487835)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° cluster search æ…¢åˆ°çˆ†ï¼Œdelete_many æœ‰åŒæ¨£çš„ issue&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0505/index_issue.png"
loading="lazy"
>
æœ¬ä¾†ä»¥ç‚ºæ˜¯ä¸æ˜¯ driver å•é¡Œï¼Œä½†å¯¦éš›ç”¨ Mongo Compass å®˜æ–¹ GUI tool å»åˆ†ææŸ¥è©¢ï¼Œç¢ºå¯¦ç™¼ç¾åªè¦ $in è£¡é¢çš„æ¢ä»¶è¶…éä¸€ç­†å°±æœƒè®Šæˆ COLLSCAN&lt;/p>
&lt;h3 id="secondary-index-å¤§å°">Secondary Index å¤§å°&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0505/sec.png"
loading="lazy"
>&lt;/p>
&lt;p>å¯ä»¥çœ‹å‡ºåŒæ¨£çš„ documents ä¸‹ Secondary Index åœ¨ Clustered Index ç¢ºå¯¦è®Šå¤§å¿« 25%&lt;/p>
&lt;h3 id="uuid-å¯«å…¥çš„å½±éŸ¿">UUID å¯«å…¥çš„å½±éŸ¿&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0505/uuid.png"
loading="lazy"
>&lt;br>
å¯¦é©—æ¯å€‹ iteration æº–å‚™ 100 è¬ç­†è³‡æ–™ä¸¦ç”¨ insert_many æ‰¹æ¬¡å¯«å…¥ 1000 ç­†ï¼Œå…©å€‹ collection éƒ½æ˜¯ clustered collectionï¼Œå¯¦é©—çµ„ _id è¨­å®šç‚º UUID&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ° UUID å°æ–¼æ•ˆèƒ½çš„è² é¢å½±éŸ¿ååˆ†å·¨å¤§&lt;/p>
&lt;h2 id="å»¶ä¼¸é–±è®€">å»¶ä¼¸é–±è®€&lt;/h2>
&lt;p>ä»¥ä¸‹æ˜¯æˆ‘åœ¨é–±è®€æ™‚æƒ³åˆ°çš„ä¸€äº›é¡å¤–å•é¡Œï¼Œè¦ºå¾—è »æœ‰è¶£ä¹Ÿé †ä¾¿è¨˜éŒ„ä¸€ä¸‹&lt;/p>
&lt;h3 id="ç‚ºä»€éº¼-wiredtiger-ä¸€é–‹å§‹ä¸æ”¯æ´-clustered-index">ç‚ºä»€éº¼ WiredTiger ä¸€é–‹å§‹ä¸æ”¯æ´ Clustered Index&lt;/h3>
&lt;p>æ—¢ç„¶æœ‰é€™éº¼å¤§çš„å¥½è™•ï¼Œç‚ºä»€éº¼ä¸€é–‹å§‹ä¸æ”¯æ´å‘¢ï¼Ÿåœ¨é€™å€‹ google group discuss æœ‰ç¨å¾®å¸¶åˆ° &lt;a class="link" href="https://groups.google.com/g/mongodb-dev/c/8dhOvNx9mBY" target="_blank" rel="noopener"
>Purpose of a separate index storage for primary id for MongoDB&lt;/a>&lt;/p>
&lt;p>ç†è§£èµ·ä¾†æ¯”è¼ƒåƒæŠ€è¡“å‚µï¼Œä¸€é–‹å§‹ MMAPv1 æ˜¯ä½¿ç”¨ DiscLocï¼Œå¾Œä¾† WiredTiger æ”¹æˆç”¨ RecordId è€Œä¸æ˜¯ç›´æ¥ç¶æ­» Disk ä½ç½®&lt;/p>
&lt;blockquote>
&lt;p>the origin of this decision was the MMAPv1 storage engine. There, indexes would map keys to &lt;code>'DiskLoc' values, containing a pair of 32-bit integers representing the file number in the database and offset in that file.&lt;/code> Since then we have replaced DiskLoc by a RecordId that does not represent a physical location, but rather a logical document number.&lt;/p>
&lt;/blockquote>
&lt;p>å¦å¤–å°±æ˜¯ MongoDB å°æ–¼ Primary Key ä½¿ç”¨æœ‰é¡å¤–çš„ç”¨é€”ï¼ŒåŒ…å« Shardingï¼Œæ‰€ä»¥å¯¦ä½œæ¯”æƒ³åƒä¸­è¤‡é›œ
å¦å¤–ä¹Ÿæœ‰æåˆ°å³ä½¿æœ‰æ•ˆèƒ½ä¸Šçš„æå‡ä½†å°æ–¼ Secondary Index æ˜¯æœ‰è² é¢å½±éŸ¿&lt;/p>
&lt;blockquote>
&lt;p>we could gain efficiency (both time and space) by using the primary key directly to index the data. However, as MongoDB puts few restrictions on the primary key, it is common for these primary keys to have a non-trivial size. &lt;code>This in turn means that all secondary indexes become less efficient. Some users have many indexes, so they'd be negatively affected by such a change.&lt;/code> &amp;hellip;&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>æ•´é«”ä¾†èªª Clustered Collection å¯«å…¥æ•ˆèƒ½ç¢ºå¯¦æœ‰å¥½ä¸Šä¸€äº›ï¼Œæœå°‹éƒ¨åˆ†å› ç‚ºæœ‰ bug æš«æ™‚é‚„ä¸ç¢ºå®šï¼Œè€Œ Secondary Index é«”ç©æœƒæœ‰æ„Ÿçš„è®Šå¤§ï¼›ç›®å‰æ•´é¡Œè©•ä¼°ä¸‹ä¾†ä¸å»ºè­°æ¡ç”¨ Clustered Collectionï¼Œäº›å¾®çš„æ•ˆç›Šæ¯”ä¸ä¸Šé€™äº›é¢¨éšªèˆ‡å‰¯ä½œç”¨&lt;/p></description></item><item><title>æ¢è¨ Golang å¯¦ä½œé¡ä¼¼ç¹¼æ‰¿çš„ä¸åŒåšæ³•</title><link>https://yuanchieh.page/posts/2023/2023-04-27-%E6%8E%A2%E8%A8%8E-golang-%E5%AF%A6%E4%BD%9C%E9%A1%9E%E4%BC%BC%E7%B9%BC%E6%89%BF%E7%9A%84%E4%B8%8D%E5%90%8C%E5%81%9A%E6%B3%95/</link><pubDate>Thu, 27 Apr 2023 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-04-27-%E6%8E%A2%E8%A8%8E-golang-%E5%AF%A6%E4%BD%9C%E9%A1%9E%E4%BC%BC%E7%B9%BC%E6%89%BF%E7%9A%84%E4%B8%8D%E5%90%8C%E5%81%9A%E6%B3%95/</guid><description>&lt;p>Golang æœ¬èº«ä¸æ”¯æ´ç¹¼æ‰¿ï¼ŒåŸå› åœ¨å®˜æ–¹çš„ QnA æœ‰å›ç­”ï¼Œèˆ‡å…¶å°ˆæ³¨åœ¨ &lt;code>type æœ¬èº«çš„é—œä¿‚ï¼Œé‚„ä¸å¦‚æ³¨é‡åœ¨ interface èƒ½å¦æ»¿è¶³ç‰¹å®šçš„è¡Œç‚º&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>Types can satisfy many interfaces at once, without the complexities of traditional multiple inheritance.&lt;/p>
&lt;/blockquote>
&lt;p>è€ŒåŠé–“å¤§å¤šçš„ Golang ç¹¼æ‰¿å¯¦ä½œéƒ½æ˜¯é€é embedded struct é€é &lt;code>composition æ¨¡æ“¬ inheritance&lt;/code>ï¼Œå¦‚é€™ç¯‡ &lt;a class="link" href="https://learnku.com/articles/32295" target="_blank" rel="noopener"
>ç§’æ‡‚ go è¯­è¨€çš„ç»§æ‰¿&lt;/a> æˆ–é€™ä¸€ç¯‡ &lt;a class="link" href="https://www.geeksforgeeks.org/inheritance-in-golang/" target="_blank" rel="noopener"
>Inheritance in GoLang&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åŠ¨ç‰©ç±»
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">class&lt;/span> &lt;span class="nx">Animal&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">public&lt;/span> &lt;span class="nx">String&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">public&lt;/span> &lt;span class="nx">String&lt;/span> &lt;span class="nx">subject&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">void&lt;/span> &lt;span class="nf">eat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">String&lt;/span> &lt;span class="nx">food&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;å–œæ¬¢åƒï¼š&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">food&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;,å®ƒå±äºï¼š&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">subject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// çŒ«ç±»ã€‚ çŒ«ç±»ç»§æ‰¿åŠ¨ç‰©ç±»
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">class&lt;/span> &lt;span class="nx">Cat&lt;/span> &lt;span class="nx">extends&lt;/span> &lt;span class="nx">Animal&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// çŒ«è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nx">age&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">void&lt;/span> &lt;span class="nf">sleep&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;ä»Šå¹´&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">age&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;å²äº†ï¼Œç‰¹åˆ«å–œæ¬¢ç¡è§‰&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">public&lt;/span> &lt;span class="nx">class&lt;/span> &lt;span class="nx">Test&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">public&lt;/span> &lt;span class="nx">static&lt;/span> &lt;span class="nx">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">String&lt;/span>&lt;span class="p">[]&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºä¸€ä¸ªåŠ¨ç‰©å®ä¾‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">Animal&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">new&lt;/span> &lt;span class="nf">Animal&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;åŠ¨ç‰©&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">subject&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;åŠ¨ç‰©ç§‘&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">eat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;è‚‰&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºä¸€ä¸ªçŒ«å®ä¾‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">Cat&lt;/span> &lt;span class="nx">cat&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">new&lt;/span> &lt;span class="nf">Cat&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;å’ªå’ª&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">subject&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;çŒ«ç§‘&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">age&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">eat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;é±¼&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">sleep&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">åŸæ–‡ä½œè€…&lt;/span>&lt;span class="err">ï¼š&lt;/span>&lt;span class="nx">pureyb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">è½¬è‡ªé“¾æ¥&lt;/span>&lt;span class="err">ï¼š&lt;/span>&lt;span class="nx">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//learnku.com/articles/32295
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">ç‰ˆæƒå£°æ˜&lt;/span>&lt;span class="err">ï¼š&lt;/span>&lt;span class="nx">è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰&lt;/span>&lt;span class="err">ã€‚&lt;/span>&lt;span class="nx">å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒ&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="nx">éå•†ä¸šè½¬è½½è¯·ä¿ç•™ä»¥ä¸Šä½œè€…ä¿¡æ¯å’ŒåŸæ–‡é“¾æ¥&lt;/span>&lt;span class="err">ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¦ä½œä¸Š subclass (cat) å°‡ superclass (animal) embeddedï¼Œç•¶ subclass å‘¼å«æ²’æœ‰å®šç¾©çš„ method æ™‚ï¼Œæœƒå»èª¿ç”¨ superclass çš„ methodï¼Œä¾‹å¦‚ä¸Šé¢æ¡ˆä¾‹ä¸­ cat.eat æ˜¯èª¿ç”¨ animal.eat&lt;/p>
&lt;p>ä½†é€™æ¨£å°±çœŸçš„æ»¿è¶³ç¹¼æ‰¿çš„æ¢ä»¶äº†å—ï¼Ÿ&lt;/p>
&lt;h2 id="ç‚ºä»€éº¼æˆ‘å€‘æœƒéœ€è¦ç¹¼æ‰¿">ç‚ºä»€éº¼æˆ‘å€‘æœƒéœ€è¦ç¹¼æ‰¿&lt;/h2>
&lt;p>å›æ­¸åŸé»ï¼Œæˆ‘å€‘æœƒåœ¨ä»€éº¼æ™‚å€™åå¥½&lt;code>ç¹¼æ‰¿&lt;/code>å¤§éæ–¼çµ„åˆé€™æ¨£çš„å¯¦ä½œæ–¹å¼ ?&lt;br>
å°±æˆ‘è‡ªå·±çš„ç¿’æ…£æ˜¯&lt;/p>
&lt;ol>
&lt;li>å‹åˆ¥ä¹‹é–“æœ‰å¾ˆæ˜ç¢º &lt;code>is-a&lt;/code> çš„é—œè¯&lt;/li>
&lt;li>å¯¦ä½œä¸Šå¤§å¤šçš„è¡Œç‚ºç›¸åŒï¼Œåªæœ‰éƒ¨åˆ†çš„è¡Œç‚ºä¸åŒï¼Œæœƒéœ€è¦å¥—ç”¨ &lt;a class="link" href="https://refactoring.guru/design-patterns/template-method" target="_blank" rel="noopener"
>æ¨£æ¿æ–¹æ³• Template Method&lt;/a> æ™‚&lt;/li>
&lt;/ol>
&lt;p>ä¾‹å¦‚æ±½è»Šã€æ©Ÿè»Šéƒ½æ˜¯äº¤é€šå·¥å…·ï¼Œä»–å€‘éƒ½å¯ä»¥æä¾›å¾ A ç§»å‹•åˆ° B çš„æœå‹™ï¼Œä½†ä»–å€‘é¨ä¹˜çš„æ–¹å¼ä¸åŒ&lt;/p>
&lt;p>å¦å¤–åœ¨å¯¦ä½œç¹¼æ‰¿æ™‚ï¼Œåˆ¥å¿˜äº† SOLID åŸå‰‡ä¸­çš„ Liskov æ›¿æ›åŸå‰‡ï¼Œè¡Œç‚ºä¸Š subclass æ‡‰è©²è¦èƒ½å¤ æ›¿æ› superclass æ‰€å‡ºç¾çš„åœ°æ–¹&lt;/p>
&lt;p>æ›´å…·é«”æè¿°ç¹¼æ‰¿åœ¨å¯¦ä½œä¸Šçš„éœ€æ±‚&lt;/p>
&lt;ol>
&lt;li>Liskov æ›¿æ›åŸå‰‡ï¼šsubclass æ›¿æ› suplerclass ä¸æ‡‰è©²æœ‰å‹åˆ¥ä¸Šçš„éŒ¯èª¤&lt;/li>
&lt;li>æ¨£æ¿æ–¹æ³•ï¼šsuperclass å®šç¾©å‘¼å«æµç¨‹ï¼Œè€Œ subclass å¯ä»¥è¤‡å¯«éƒ¨åˆ†æ–¹æ³•&lt;/li>
&lt;li>method propagateï¼šç•¶å‘¼å« subclass ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œæœƒå¾€ superclass å»æŸ¥æ‰¾&lt;/li>
&lt;/ol>
&lt;p>æˆ‘å€‘ä¾†æª¢è¦–ä¸Šé¢çš„ä½œæ³•ä»¥ä¸Šéœ€æ±‚&lt;/p>
&lt;blockquote>
&lt;p>å‡è¨­ Animal æœ‰ä¸€å€‹ method æ˜¯ wakeUpï¼ŒwakeUp å›ºå®šæœƒ yell &amp;amp; eatï¼Œä½†ä¸åŒçš„å‹•ç‰©æœ‰ä¸åŒçš„ yell æ–¹å¼èˆ‡ eat å…§å®¹&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a class="link" href="https://go.dev/play/p/5qvgb4obPI7" target="_blank" rel="noopener"
>go playground&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// You can edit this code!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Click here and start typing.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Animal&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Animal&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Wakeup&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">yell&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">eat&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Animal&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">yell&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;default yell&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Animal&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">eat&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;default eat&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Cat&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Animal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Cat&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">yell&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;meow meow&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Cat&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">eat&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cat eat meat&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Cat&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Animal&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;BigCat&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wakeup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// output
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// default yell
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// default eat
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å’¦?! è¼¸å‡ºç«Ÿç„¶ä¸æ˜¯å‘¼å« cat.yell() å’Œ cat.eat()ï¼Œåè€Œæ˜¯å‘¼å«åˆ° animal.yell() / animal.eat()ï¼Œå°æ¯” Ruby çš„åŸ·è¡Œçµæœ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Animal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">wakeup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">yell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">eat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">yell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;default yell&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">eat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;default eat&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Cat&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">Animal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">yell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;meow meow&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">eat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;cat eat meat&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cat&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Cat&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cat&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wakeup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># meow meow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cat eat meat&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç©¶ç«Ÿæ˜¯å“ªè£¡å‡ºéŒ¯äº† ?!&lt;/p>
&lt;h3 id="æ³¨æ„-golang-embedded-struct-åŸ·è¡Œçš„è§’è‰²">æ³¨æ„ Golang embedded struct åŸ·è¡Œçš„è§’è‰²&lt;/h3>
&lt;p>æ›´å…·é«”çš„æè¿°å¯ä»¥åƒè€ƒæ­¤ç¯‡ &lt;a class="link" href="https://www.dolthub.com/blog/2023-02-22-golangs-fake-inheritance/?fbclid=IwAR1r4GTbS7Sz3sQEbRAL43Y4ieOhFiu8zUA5Uecn8-HQtK6aHFLBKS3aRCs" target="_blank" rel="noopener"
>Type embedding: Golang&amp;rsquo;s fake inheritance&lt;/a>ï¼Œç•¶æˆ‘å€‘åˆ©ç”¨ method propagate æ‰¾åˆ° superclass å®šç¾©çš„æ–¹æ³•æ™‚ï¼Œè¦æ³¨æ„ &lt;code>æ­¤æ™‚åŸ·è¡Œçš„è§’è‰²æ˜¯ superclass è€Œä¸æ˜¯ subclass!&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œwakeup æ˜¯å®šç¾©åœ¨ Animal ç•¶ä¸­ï¼ŒCat å‘¼å« wakeup æœ€å¾Œæ˜¯ç”¨ Animal å»åŸ·è¡Œï¼Œè€Œç•¶ Animal åŸ·è¡Œ wakeup æ™‚å°±æ˜¯å‘¼å« Animal.yell / Animal.eat
&lt;img src="https://yuanchieh.page/post/2023/img/0427/embedded_struct.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="é€é-interface-èˆ‡é‡æ–°èª¿æ•´-embedded-æ–¹å‘">é€é Interface èˆ‡é‡æ–°èª¿æ•´ Embedded æ–¹å‘&lt;/h2>
&lt;p>å…ˆä¸Šçµè«–ï¼Œå°‡ subclass è¦å€‹åˆ¥å¯¦ä½œçš„æ–¹æ³•æŠ½æˆ interfaceï¼Œä¸¦æ”¹å°‡ subclass embedded åˆ° superclass ä¸­ï¼Œåƒè€ƒ &lt;a class="link" href="https://go.dev/play/p/dBORnj5bVmD" target="_blank" rel="noopener"
>go playground&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// You can edit this code!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Click here and start typing.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ISubClass&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Temp1&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Temp2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SuperClass&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sub&lt;/span> &lt;span class="nx">ISubClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SuperClass&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Method&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sub&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Temp1&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sub&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Temp2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SubClass1&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Temp1&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">temp3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;temp1 from SubClass1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Temp2&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;temp2 from SubClass1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SubClass2&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Temp1&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;temp1 from SubClass2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Temp2&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;temp2 from SubClass2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cls1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">SuperClass&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sub&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">SubClass1&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cls2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">SuperClass&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sub&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">SubClass2&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cls1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Method&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cls2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Method&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£åšå°±æ»¿è¶³äº†&lt;/p>
&lt;ol>
&lt;li>Liskov æ›¿æ›åŸå‰‡ï¼šä¸åŒçš„ subclass éƒ½ä¾é™„åœ¨ SuperClassï¼Œæ‰€ä»¥ç›´æ¥æ›¿æ›æ²’å•é¡Œ&lt;/li>
&lt;li>Template methodï¼šSuperclass é€é interface å‘¼å« subclass method&lt;/li>
&lt;li>method propagateï¼šé€™å€‹æ¯”è¼ƒ trickyï¼Œå› ç‚ºæ˜¯ç›´æ¥å‘¼å« Superclassï¼Œæ‰€ä»¥ä¹Ÿæ²’æœ‰ method propagate çš„å•é¡Œ&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šæ»¿è¶³æˆ‘å€‘å‰é¢ä¸€é–‹å§‹å°æ–¼ç¹¼æ‰¿çš„å®šç¾©ï¼Œä½†æœ‰å¹¾å€‹ä¾·é™&lt;/p>
&lt;ol>
&lt;li>å› ç‚ºæˆ‘å€‘åè½‰ embedded struct çš„ä½ç½®ï¼Œæ‰€ä»¥ &lt;code>subclass ä¸èƒ½å‘¼å« superclass ä»»ä½•çš„æ–¹æ³•æˆ–åƒæ•¸ï¼Œåªèƒ½å¾ superclass å‘¼å« subclass&lt;/code>ï¼Œé€™é»æˆ‘è¦ºå¾—æ¯”è¼ƒé‚„å¥½ï¼Œå¦‚æœå‘¼å«æ–¹å‘äº¤éŒ¯åè€Œå¾ˆäº‚&lt;/li>
&lt;li>subclass çš„å‹åˆ¥ä¸æ˜ç¢ºï¼Œå› ç‚ºéƒ½æ›åœ¨ superclass ä¸‹ï¼Œå¦‚æœè¦åˆ¤æ–·å‹åˆ¥éœ€è¦é¡å¤–è™•ç†&lt;/li>
&lt;li>subclass ä¸èƒ½æœ‰å®¢è£½åŒ–çš„ Public Methodï¼Œæœƒè¢« interface ä¾·é™ï¼Œä¾‹å¦‚æˆ‘åªæœ‰ SubClass1 æƒ³è¦æœ‰ Temp3 çš„ public methodï¼Œè®Šæˆ interface ä¹Ÿè¦å¢åŠ å¦å‰‡ç„¡æ³•å‘¼å«&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ISubClass&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Temp3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Temp3&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;temp3 from SubClass1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Temp3&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// SubClass2 è¢«è¿«ä¹Ÿè¦å¢åŠ ï¼Œåå‰‡ç„¡æ³•æ»¿è¶³ interface
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å¦‚æœ-subclass-æƒ³è¦å‘¼å«-superclass-æ–¹æ³•">å¦‚æœ subclass æƒ³è¦å‘¼å« superclass æ–¹æ³•&lt;/h3>
&lt;p>ä¾·é™ç¬¬ä¸€é»æåˆ°å› ç‚º embedded ç›®å‰æ˜¯æ›åœ¨ superclass ä¸‹ï¼Œåéä¾†å°±æ˜¯ subclass ç„¡æ³•å‘¼å« superclassï¼Œå¦‚æœå¸Œæœ› subclass å‘¼å« superclass çš„æ–¹æ³•ï¼Œå°±éœ€è¦åƒ Template Method ç”± superclass ä¸»å‹•å‘¼å«ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SuperClass&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">SubClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SubClass&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ShowName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æƒ³è¦å–å¾— SuperClass Name å±¬æ€§
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ç„¡æ³•é€™æ¨£å­˜å–!!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;prefix&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">////// èª¿æ•´åšæ³• /////////
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">SuperClass&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">SubClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ”¹å¾ superclass è™•ç†ï¼ŒæŠŠ name pass çµ¦ subclass
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SuperClass&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ShowName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pfxName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ParseName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SubClass&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SubClass&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ParseName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æƒ³è¦å–å¾— SuperClass Name å±¬æ€§
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ç„¡æ³•é€™æ¨£å­˜å–!!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>ä»¥ä¸Šæä¾›ä¸åŒçš„æ€è·¯ï¼Œé€éæ”¹è®Š embedded struct çš„ä¸åŒå±¤ç´šï¼Œæœƒæœ‰ä¸åŒçš„æ•ˆæœ&lt;/p>
&lt;ol>
&lt;li>subclass embedded superclassï¼šsubclass å¯ä»¥ä»»æ„å®šç¾© public methodï¼Œä½†ç„¡æ³•å¯¦ä½œ Template method&lt;/li>
&lt;li>superclass embedded subclassï¼šå¯ä»¥å¯¦ä½œ Template methodï¼Œä½† subclass ç„¡æ³•æœ‰é¡å¤–çš„ public methodï¼Œé™¤éæ“´å…… interface&lt;/li>
&lt;/ol>
&lt;p>å†ä»”ç´°æƒ³æƒ³æ–¹æ³•äºŒï¼Œåœ¨å…¶ä»– OOP language ä¸­ï¼Œå¥—ç”¨ Template method æ™‚ subclass å®šç¾©çš„ method å¯ä»¥ç›´æ¥å­˜å– superclass å®šç¾©çš„åƒæ•¸ï¼Œä½†æ˜¯åœ¨ Golang ä¸­æ˜¯ç„¡æ³•åšåˆ°çš„&lt;/p>
&lt;p>æ‰€ä»¥åœ¨ Golang ä¸­è¦ä»¿é€  Template method åè€Œæœƒæ¯”è¼ƒåƒ Strategy patternï¼Œsuperclass éœ€è¦æŠ½æ›æŸäº›è¡Œç‚º (ç­–ç•¥)ï¼Œé‚£å°±é€éä¸åŒçš„ç­–ç•¥è¨­è¨ˆä¸¦åœ¨åˆå§‹åŒ–æ™‚å¸¶å…¥&lt;/p>
&lt;blockquote>
&lt;p>æ•´é«”å¯¦ä½œé‚„æ˜¯ç”¨ &lt;code>çµ„åˆä¾†ä»£æ›¿ç¹¼æ‰¿&lt;/code>ï¼Œåœ¨ä½¿ç”¨ Golang ä¸Šå»ºè­°é‚„æ˜¯ä¸è¦ç”¨ç¹¼æ‰¿çš„æ¦‚å¿µå»æ€è€ƒæœƒè®“å¯¦ä½œæ¯”è¼ƒé †&lt;/p>
&lt;/blockquote></description></item><item><title>Vector DB åˆæ¢èˆ‡ Weaviate DB æ•™å­¸</title><link>https://yuanchieh.page/posts/2023/2023-04-24-vector-db-%E5%88%9D%E6%8E%A2%E8%88%87-weaviate-db-%E6%95%99%E5%AD%B8/</link><pubDate>Mon, 24 Apr 2023 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-04-24-vector-db-%E5%88%9D%E6%8E%A2%E8%88%87-weaviate-db-%E6%95%99%E5%AD%B8/</guid><description>&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/klTvEwg3oJ4"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>ç•¶æˆ‘å€‘å¸Œæœ›æ‰“é€ ä¸€å€‹åŸºæ–¼èªæ„ç›¸ä¼¼çš„æ–‡å­—æœå°‹æ™‚ï¼Œä¸€èˆ¬çš„ä½œæ³•æ˜¯å°‡æ–‡å­—é€é AI model è½‰æˆ embeddeding vectorï¼Œé€éè¨ˆç®— vector distance (cosine distancing) æ‰¾å‡ºè·é›¢æœ€ç›¸è¿‘çš„æ–‡å­— kNN (k nearest neighbors)ï¼Œä¾‹å¦‚ &lt;a class="link" href="https://github.com/openai/openai-cookbook/blob/main/examples/Semantic_text_search_using_embeddings.ipynb" target="_blank" rel="noopener"
>OpenAI çš„ demo codeï¼šSemantic_text_search_using_embeddings&lt;/a>&lt;/p>
&lt;p>ç•¶è³‡æ–™é‡å°çš„æ™‚å€™ï¼Œé€™æ¨£åšä¸æœƒæœ‰ä»€éº¼å•é¡Œï¼Œä½†ä»”ç´°çœ‹ç›®å‰çš„æ¯”å°æ–¹å¼æ˜¯æŠŠè¼¸å…¥è·Ÿè³‡æ–™é›†çš„è³‡æ–™æ¯ä¸€ç­† vector éƒ½åš distance è¨ˆç®—ï¼Œæ‰€ä»¥è¤‡é›œåº¦æœƒæ˜¯ &lt;code>O(N)ï¼ŒN æ˜¯è³‡æ–™é›†æ•¸é‡&lt;/code>ï¼Œå¦‚æœè³‡æ–™é‡ä¸€å¤§ï¼Œé€™å‹¢å¿…æœƒæ˜¯é€ æˆç“¶é ¸&lt;/p>
&lt;p>Vector DB å°±æ˜¯è¦è§£æ±ºé€™æ¨£çš„å•é¡Œï¼Œä¸»è¦é€é&lt;/p>
&lt;ul>
&lt;li>æ”¹ç”¨ ANN (approximate nearest neighbors) å–ä»£ kNNï¼Œç”¨ç›¸ä¼¼åº¦æŸ¥è©¢æ›å–åŸ·è¡Œé€Ÿåº¦&lt;/li>
&lt;li>æä¾› database åŠŸèƒ½ï¼ŒåŒ…å«æŒä¹…åŒ–ä¿å­˜ã€æ°´å¹³æ“´å±• (sharding)ã€é«˜å¯ç”¨æ€§ã€API å°è£ç­‰åŠŸèƒ½&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0424/vector_db.png"
loading="lazy"
>&lt;/p>
&lt;p>ç›®å‰æœå°‹å¸‚é¢ä¸Šæœ‰å¹¾å€‹å¸¸è¦‹çš„é¸æ“‡&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.pinecone.io/" target="_blank" rel="noopener"
>Pinecone&lt;/a>ï¼šé–‰æºå°ˆæ¡ˆï¼Œå°±å…ˆç•¥éä¸ç”¨&lt;/li>
&lt;li>&lt;a class="link" href="https://milvus.io/" target="_blank" rel="noopener"
>Milvus&lt;/a>ï¼šç´” vector DBï¼Œçœ‹èµ·ä¾†åœ¨åŸºç¤å»ºè¨­ (scalingã€availability) ç­‰åšå¾—æ¯”è¼ƒå®Œæ•´&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/weaviate/weaviate" target="_blank" rel="noopener"
>Weaviate&lt;/a>ï¼šæœ‰ module å¯ä»¥æ”¯æ´ AI model æ•´åˆï¼Œä¹Ÿæ”¯æ´ç´” vector DB ä½¿ç”¨&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.trychroma.com/" target="_blank" rel="noopener"
>Chroma&lt;/a>ï¼šFireship demo ç”¨&lt;/li>
&lt;/ul>
&lt;p>é€™æ¬¡ Demo é¸æ“‡ç”¨ Weaviateï¼Œä¸»è¦æ˜¯æœ‰æ”¯æ´ module ç›´æ¥æ•´åˆ AI modelï¼Œé€™æ¨£æˆ‘å°±ä¸ç”¨å¦å¤–æƒ³ embedding vector è©²å¦‚ä½•ç”¢ç”Ÿ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0424/weaviate-module-diagram.svg"
loading="lazy"
>&lt;/p>
&lt;h2 id="weaviate-db-åŸºæœ¬ä»‹ç´¹">Weaviate DB åŸºæœ¬ä»‹ç´¹&lt;/h2>
&lt;p>Weaviate DB æœ‰ä»¥ä¸‹å¹¾å€‹ç‰¹è‰²&lt;/p>
&lt;ul>
&lt;li>ä¾¿åˆ©æ€§ï¼š&lt;br>
module æ”¯æ´å¸¸è¦‹çš„ AI modelï¼ŒåŒ…å« transformerã€openai ç­‰ï¼Œé€éåƒæ•¸å¯ä»¥ç›´æ¥èª¿æ•´ï¼Œä½†æœ‰äº› AI model éƒ¨åˆ†éœ€è¦è‡ªå·±æ¶è¨­ serverï¼ŒWeaviate DB æ ¸å¿ƒä¸¦ä¸åŒ…å« AI modelï¼Œåªæ˜¯æœƒç›´æ¥é€é interface èª¿ç”¨
&lt;img src="https://weaviate.io/assets/images/weaviate-module-apis-3a56351def9cd3a66f6cd0186875d2c4.svg"
loading="lazy"
>&lt;/li>
&lt;li>æœå°‹èˆ‡éæ¿¾ï¼š&lt;br>
é™¤äº† vector æœå°‹å¤–ï¼Œåœ¨æ–‡å­—ä¸Šæœƒçµåˆ inverted index å¢åŠ æœå°‹çš„ç²¾æº–åº¦èˆ‡æ•ˆç‡ï¼Œä¸¦æä¾› &lt;code>filter å¯ä»¥é€éå±¬æ€§ç¯©é¸&lt;/code>&lt;/li>
&lt;li>API æ¥å£æ”¯æ´ REST èˆ‡ GraphQL&lt;/li>
&lt;li>æ“´å……æ€§ï¼š &lt;br>
æœƒæä¾› Sharding èˆ‡ High Availability (å¾Œè€…é‚„åœ¨é–‹ç™¼ä¸­)&lt;/li>
&lt;/ul>
&lt;h3 id="å„²å­˜æ¦‚å¿µ">å„²å­˜æ¦‚å¿µ&lt;/h3>
&lt;p>ä»¥ &lt;code>Class&lt;/code> ç‚ºç®¡ç†å–®ä½ï¼Œå¯ä»¥ç†è§£æˆ table æˆ– collection çš„æ¦‚å¿µï¼Œæ¯å€‹ class æœ‰è‡ªå·± vectorize çš„æ©Ÿåˆ¶ã€sharding è¨­å®šç­‰ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;class&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// The name of the class in string format
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;description&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// A description for your reference
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;vectorIndexType&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;hnsw&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// Defaults to hnsw, can be omitted in schema definition since this is the only available type for now
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;vectorIndexConfig&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span> &lt;span class="c1">// Vector index type specific settings, including distance metric
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;vectorizer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text2vec-contextionary&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// Vectorizer to use for data objects added to this class
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;moduleConfig&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text2vec-contextionary&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;vectorizeClassName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="c1">// Include the class name in vector calculation (default true)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="c1">// An array of the properties you are adding, same as a Property Object
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// The name of the property
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;description&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// A description for your reference
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;dataType&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="c1">// The data type of the object as described above. When creating cross-references, a property can have multiple data types, hence the array syntax.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s2">&amp;#34;string&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;moduleConfig&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// Module-specific settings
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;text2vec-contextionary&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;skip&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// If true, the whole property will NOT be included in vectorization. Default is false, meaning that the object will be NOT be skipped.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;vectorizePropertyName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// Whether the name of the property is used in the calculation for the vector position of data objects. Default false.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;indexInverted&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="c1">// Optional, default is true. By default each property is fully indexed both for full-text, as well as vector search. You can ignore properties in searches by explicitly setting index to false.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;invertedIndexConfig&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;shardingConfig&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span> &lt;span class="c1">// Optional, controls behavior of class in a multi-node setting, see section below
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯å€‹ Class å…§åŒ…å«å¤šå€‹ Object ä»¥ json æ ¼å¼å„²å­˜ï¼ŒObject å…§çš„å±¬æ€§ (Property) æ”¯æ´&lt;a class="link" href="https://weaviate.io/developers/weaviate/config-refs/datatypes" target="_blank" rel="noopener"
>å¤šç¨®æ ¼å¼&lt;/a>ï¼Œé¡å¤–æœ‰æä¾›åœ°ç†ä½ç½®ã€æ—¥æœŸã€é›»è©±è™Ÿç¢¼(æœ‰é»ä¸è§£?!)ï¼Œå…¶ä¸­åœ°ç†ä½ç½®åœ¨æŸ¥è©¢ä¸Šé‚„æ”¯æ´æ–¹åœ“å…§çš„ç¯©é¸&lt;/p>
&lt;p>Class schema æ˜¯éœæ…‹çš„ï¼Œå¦‚æœè¦å¢æ¸›æ¬„ä½éœ€è¦é€é API ä¿®æ”¹ï¼Œè€Œä¸åƒæŸäº› NoSQL æ˜¯å‹•æ…‹å¯«å…¥çš„&lt;/p>
&lt;h3 id="ç‰©ç†å„²å­˜ä»¥-shard-ç‚ºå–®ä½">ç‰©ç†å„²å­˜ä»¥ Shard ç‚ºå–®ä½&lt;/h3>
&lt;p>ä¸€å€‹ Class åœ¨ç‰©ç†å„²å­˜ä¸Šæœ‰å¤šå€‹ &lt;a class="link" href="https://weaviate.io/developers/weaviate/concepts/storage" target="_blank" rel="noopener"
>Shard&lt;/a>ï¼Œæ¯å€‹ Shard æœƒåŒ…å« vector index / object store / inverted indexï¼Œå…¶ä¸­ vecotr index ç›®å‰æ˜¯ç”¨ HNSWï¼Œå…¶é¤˜å…©å€‹æ˜¯ç”¨ LSMTree å„²å­˜&lt;/p>
&lt;h2 id="demo---æ‰“é€ ç°¡æ˜“çš„æ–‡å­—æŸ¥è©¢">Demo - æ‰“é€ ç°¡æ˜“çš„æ–‡å­—æŸ¥è©¢&lt;/h2>
&lt;p>ç¨‹å¼ç¢¼åœ¨ &lt;a class="link" href="https://github.com/sj82516/weaviate-db-demo" target="_blank" rel="noopener"
>sj82516/weaviate-db-demo&lt;/a>ï¼Œåœ¨æœ¬åœ°ç«¯å•Ÿå‹• Weaviate DB ä¸¦åšç°¡æ˜“çš„æ–‡å­—æŸ¥è©¢&lt;/p>
&lt;h3 id="é€é-docker-compose-å•Ÿå‹•">é€é docker-compose å•Ÿå‹•&lt;/h3>
&lt;p>é€™é‚Šæˆ‘å€‘åªåšæ–‡å­—æœå°‹çš„éƒ¨åˆ†ï¼Œé¸ç”¨ transformer ç•¶ä½œ AI modelï¼Œå¯ä»¥æŸ¥çœ‹&lt;a class="link" href="https://weaviate.io/developers/weaviate/modules" target="_blank" rel="noopener"
>ä¸åŒçš„ modules&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3.4&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">weaviate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">semitechnologies/weaviate:1.18.3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;8080:8080&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">QUERY_DEFAULTS_LIMIT&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">20&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;true&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">PERSISTENCE_DATA_PATH&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;./data&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">DEFAULT_VECTORIZER_MODULE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">text2vec-transformers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ENABLE_MODULES&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">text2vec-transformers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">TRANSFORMERS_INFERENCE_API&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://t2v-transformers:8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">CLUSTER_HOSTNAME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;node1&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">t2v-transformers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">semitechnologies/transformers-inference:sentence-transformers-multi-qa-MiniLM-L6-cos-v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ENABLE_CUDA&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># set to 1 to enable&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># NVIDIA_VISIBLE_DEVICES: all # enable if running with CUDA&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å»ºç«‹-class-èˆ‡åŒ¯å…¥è³‡æ–™">å»ºç«‹ Class èˆ‡åŒ¯å…¥è³‡æ–™&lt;/h3>
&lt;p>Class schema å¯ä»¥ä¸»å‹•å®£å‘Šï¼Œæˆ–æ˜¯è®“ Weaviate DB è‡ªå‹•å¹«å¿™å»ºç«‹ (æœ‰é»åƒ Elasticsearch)ï¼Œé€™é‚Šå»ºç«‹äº†ä¸€å€‹ Class ä¸¦æŒ‡å®š module ç”¨ text-transformer&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Schema&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">ClassCreator&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">WithClass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">models&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Class&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Class&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">className&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;all books I have&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Vectorizer&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;text2vec-transformers&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ModuleConfig&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;text2vec-transformers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Properties&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">models&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Property&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">DataType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŒ¯å…¥è³‡æ–™å¯ä»¥æ‰¹æ¬¡åŒ¯å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">objects&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">models&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Class&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">className&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Properties&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Hello World Blue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;program&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Class&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">className&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Properties&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Hello World Red&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;program&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Class&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">className&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Properties&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Hello World Yellow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;science&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Batch&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">ObjectsBatcher&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithObjects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">objects&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithConsistencyLevel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">replication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConsistencyLevel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ALL&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æœå°‹èˆ‡ç¯©é¸">æœå°‹èˆ‡ç¯©é¸&lt;/h3>
&lt;p>å®Œæ•´æŸ¥è©¢æœ‰ä¸‰å€‹éƒ¨åˆ† æœå°‹ + ç¯©é¸ + æ¬„ä½éæ¿¾&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ–‡å­—æœå°‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">nearText&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GraphQL&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">NearTextArgBuilder&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æœå°‹çš„é—œéµå­—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">WithConcepts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">concepts&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®“å‘é‡å¾€æŸå€‹æ–¹å‘é è¿‘
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">WithMoveTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">graphql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MoveParameters&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Force&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Concepts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;Yellow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç¯©é¸æ©Ÿåˆ¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">where&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">filters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Where&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithPath&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">}).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithOperator&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Equal&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithValueText&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;program&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// é¸æ“‡æ¬„ä½å›å‚³
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">fields&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">graphql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Field&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é¡å¤–çš„æ¬„ä½ï¼Œç®—æ˜¯ metadata
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;_additional&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Fields&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">graphql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Field&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;distance&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// GraphQL Request
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GraphQL&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithClassName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">className&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithNearText&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nearText&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithWhere&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">where&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithFields&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fields&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Errors&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Errors&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Get&amp;#34;&lt;/span>&lt;span class="p">].(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})[&lt;/span>&lt;span class="nx">className&lt;/span>&lt;span class="p">].([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jsonbody&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Marshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do error check
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">books&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Book&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">jsonbody&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">books&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do error check
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">book&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">books&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">book&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ searching æœå°‹ä¸­ï¼Œå¦‚æœæ˜¯ text Weaviate DB æœƒç”¨ inverted index èˆ‡ vector æœå°‹ &lt;code>WithNearText&lt;/code>ï¼Œæ‰¾å‡ºçš„çµæœæœƒçµ¦å‡ºå°æ‡‰çš„ distance&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nearText&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GraphQL&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">NearTextArgBuilder&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithConcepts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">concepts&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithMoveTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">graphql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MoveParameters&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Force&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Concepts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;Yellow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>concepts æœå°‹çš„æ–‡å­—é™£åˆ—&lt;/li>
&lt;li>WithMoveTo é¡å¤–æŒ‡å®šæœå°‹è¦ç‰¹åˆ¥æ¥è¿‘å“ªäº›é—œéµå­—&lt;br>
åƒæ•¸å¯åƒè€ƒ &lt;a class="link" href="https://weaviate.io/developers/weaviate/api/graphql/vector-search-parameters" target="_blank" rel="noopener"
>Vector search parameters&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä¹Ÿå¯ä»¥é‡å°å±¬æ€§åšç¯©é¸ï¼Œä¾‹å¦‚æˆ‘åªè¦ object ä¸­ type = program çš„è³‡æ–™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">where&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">filters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Where&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithPath&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">}).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithOperator&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Equal&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">WithValueText&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;program&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœå°‹çš„çµæœå¤§æ¦‚æ˜¯ (Yellow è¢«ç¯©é¸æ‰)&lt;/p>
&lt;blockquote>
&lt;p>{Hello World Blue {b9f93a34-6cbd-45b3-afc3-f82e9d1d0da8 0.54240143}}&lt;br>
{Hello World Red {6575290e-53cc-4ab9-8d39-330e5a47b0d1 0.55338395}}&lt;/p>
&lt;/blockquote>
&lt;h2 id="ann-æ¼”ç®—æ³•hnsw-ä»‹ç´¹">ANN æ¼”ç®—æ³•ï¼šHNSW ä»‹ç´¹&lt;/h2>
&lt;p>&lt;img src="https://d33wubrfki0l68.cloudfront.net/00e2d0033d5802e0016a442757bb9ee603e02d2b/caebb/images/hnsw-2.jpg"
loading="lazy"
>
HNSW (Hierarchical Navigable Small World) æ˜¯ä¸€ç¨® ANN æ¼”ç®—æ³•ï¼Œä¸»è¦æ˜¯å€Ÿé¡ å€Ÿé¡ probability skip listï¼Œé€éåˆ†å±¤æŸ¥è©¢ï¼Œå…ˆå¾æœ€ä¸Šå±¤æœ€ç¨€ç–çš„ layer é–‹å§‹æ‰¾æœ€ç›¸è¿‘çš„é„°å±…ï¼Œæ¥è‘—å¾€ä¸‹ä¸€å±¤æ‰¾è©²é„°å±…çš„æœ€ç›¸è¿‘é„°å±…ï¼Œä¸€ç›´åˆ°æœ€åº•å±¤ (layer 0)&lt;/p>
&lt;blockquote>
&lt;p>æŸ¥è©¢è¤‡é›œåº¦é™è‡³ log (N)&lt;/p>
&lt;/blockquote>
&lt;p>é€™éƒ¨åˆ†æœ‰å…©å€‹åƒæ•¸å¯ä»¥æ³¨æ„&lt;/p>
&lt;ul>
&lt;li>efConstruction: æ±ºå®šæ¯æ¬¡æŸ¥è©¢å›å‚³çš„é„°å±…æ•¸é‡ï¼Œæ•¸é‡è¶Šå¤šæŸ¥è©¢è¶Šç²¾æº–ï¼Œä½†æ˜¯æ•ˆç‡è¶Šå·®&lt;/li>
&lt;li>maxConnections: æ±ºå®šæ¯å€‹ point å¯ä»¥é€£æ¥çš„ edge æ•¸é‡ï¼ŒåŒæ¨£æ˜¯æ•¸é‡è¶Šå¤šè¶Šç²¾æº–&lt;/li>
&lt;/ul>
&lt;h3 id="å¦‚ä½•æ±ºå®š-point-è¦æ’å…¥å“ªä¸€å±¤">å¦‚ä½•æ±ºå®š point è¦æ’å…¥å“ªä¸€å±¤&lt;/h3>
&lt;p>é€™éƒ¨åˆ†ä¾¿æ˜¯é€éæ©Ÿç‡æ‰€æ±ºå®šï¼Œè¶Šä¸Šå±¤æ©Ÿç‡è¶Šä½
&lt;img src="https://d33wubrfki0l68.cloudfront.net/a93d856af84ab39170d4a056a5a05ff63bf23552/8e259/images/hnsw-8.jpg"
loading="lazy"
>&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>å¿«é€Ÿç­è§£äº†ä¸€ä¸‹ Vector DBï¼Œæœªä¾†å¦‚æœæœ‰éœ€è¦åšå‘é‡æŸ¥è©¢ä½¿ç”¨ä¸Šæ‡‰è©²æœƒè »æ–¹ä¾¿çš„ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒåœ¨è©•ä¼°ä¸€ä¸‹ &lt;a class="link" href="https://milvus.io/docs/overview.md" target="_blank" rel="noopener"
>Milvus&lt;/a>ï¼Œçœ‹èµ·ä¾†åŸºç¤å»ºè¨­æ¯” Weaviate DB æ›´å®Œå–„ã€Github ä¸Šç†±åº¦ä¹Ÿæ›´é«˜ã€ä¹Ÿæ”¯æ´æ›´å¤šçš„ ANN æ¼”ç®—æ³•&lt;/p>
&lt;p>å¦å¤– Elasticsearch åœ¨ 8.0 ä¹Ÿæœ‰æ”¯æ´ vector searchï¼Œå¦‚æœä»¥ç¶“æœ‰åœ¨ç”¨ ES ä¹Ÿå¯ä»¥ç›´æ¥ç•¶ä½œ Vector DB ä½¿ç”¨&lt;/p></description></item><item><title>åœ¨ Clean Architecture ä¸‹ transaction è©²å¦‚ä½•å¯¦ä½œçš„å•é¡Œç™¼æƒ³ (Golang èˆ‡ Ruby å¯¦ä½œ)</title><link>https://yuanchieh.page/posts/2023/2023-04-21-%E5%9C%A8-clean-architecture-%E4%B8%8B-transaction-%E8%A9%B2%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C%E7%9A%84%E5%95%8F%E9%A1%8C%E7%99%BC%E6%83%B3-golang-%E8%88%87-ruby-%E5%AF%A6%E4%BD%9C/</link><pubDate>Fri, 21 Apr 2023 02:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-04-21-%E5%9C%A8-clean-architecture-%E4%B8%8B-transaction-%E8%A9%B2%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C%E7%9A%84%E5%95%8F%E9%A1%8C%E7%99%BC%E6%83%B3-golang-%E8%88%87-ruby-%E5%AF%A6%E4%BD%9C/</guid><description>&lt;p>åœ¨å¥—ç”¨ Clean Architecture (å¾ŒçºŒç°¡ç¨± CA)éç¨‹ï¼Œæœ€å¸¸è¨è«–çš„å•é¡Œè«éæ–¼ã€ŒTransaction å¦‚æœè·¨å¤šå€‹ repositoryï¼Œè©²æ€éº¼è™•ç†ï¼Ÿå¦‚æœ Transaction ç”± Use Case æ§åˆ¶æœƒä¸æœƒé•å CA åŸå‰‡ï¼Ÿå¦‚æœæ”¾åˆ° Repository é‚£æœ‰ä¸€äº›åˆ¤æ–·çš„é‚è¼¯æ˜¯ä¸æ˜¯ä¹Ÿæ··é›œé€²å»ï¼Ÿã€&lt;br>
é€™å€‹å•é¡Œç¢ºå¯¦æœ‰é»æ£˜æ‰‹ï¼Œç¶²è·¯ä¸Šä¹Ÿå¸¸çœ‹åˆ°å„ç¨®ä¸åŒçš„ä½œæ³•ï¼Œæ±ºå®šä»Šå¤©é‡æ–°æ•´ç†ä¸€ä¸‹ï¼Œæª¢è¦–ä¸åŒçš„ä½œæ³•èˆ‡è€ƒé‡ï¼Œä¸¦é€éå¯¦éš›çš„æ¡ˆä¾‹å»é©—è­‰ä¸åŒä½œæ³•çš„å„ªåŠ£ï¼Œä½¿ç”¨å‹•æ…‹èªè¨€ Ruby / éœæ…‹èªè¨€ Golang ç¢ºä¿å¯¦ä½œæ˜¯çœŸå¯¦å¯è¡Œ&lt;/p>
&lt;p>ç›®å‰æƒ³åˆ°çš„é©—è­‰å ´æ™¯ç‚º&lt;/p>
&lt;blockquote>
&lt;p>ã€Œç”¨æˆ¶ã€å¸³è™Ÿæœ‰é»æ•¸ï¼Œé€éé»æ•¸è³¼è²·ã€Œå•†å“ã€ä¸¦æˆç«‹å°æ‡‰çš„ã€Œè¨‚å–®ã€
å•†å“å¿…é ˆæœ‰è¶³å¤ æ•¸é‡ã€ç”¨æˆ¶é»æ•¸å¿…é ˆæœ‰è¶³å¤ çš„é»æ•¸æ‰å¯ä»¥æˆç«‹è¨‚å–®
ä»¥ä¸Šè¡Œç‚ºå¿…é ˆåŒ…å«åœ¨ä¸€å€‹ transaction ä¸­&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¤–éƒ¨çš„å¹¾ç¨®åšæ³•">å¤–éƒ¨çš„å¹¾ç¨®åšæ³•&lt;/h2>
&lt;h3 id="1-ç”±-usecase-æ§åˆ¶å› ç‚º-usecase-æ‰çŸ¥é“æ‰€æœ‰çš„-context">1. ç”± UseCase æ§åˆ¶ï¼Œå› ç‚º Usecase æ‰çŸ¥é“æ‰€æœ‰çš„ Context&lt;/h3>
&lt;p>é€™éƒ¨åˆ†èªªæ³•æ˜¯å¾ã€ŠClean Architecture å¯¦ä½œç¯‡ã€‹ç¬¬ 84 é æ‰€æˆªå–çš„å…§å®¹ï¼Œä½œè€…æåˆ°åªæœ‰ Usecase æœ‰è¶³å¤ çš„ä¸Šä¸‹æ–‡å»åˆ¤æ–·é€™å¹¾å€‹ repository æ“ä½œæ˜¯å¦è©²æ”¾åˆ°åŒä¸€å€‹ transactionï¼Œ&lt;a class="link" href="https://github.com/thombergs/buckpal/blob/master/src/main/java/io/reflectoring/buckpal/account/application/service/SendMoneyService.java?fbclid=IwAR03bRjdRX_AWnkJ8mGrfp61AFOdnw_Pr8gqLmx6YAqjIDWQknN0yQh0NUg" target="_blank" rel="noopener"
>ç¯„ä¾‹ code&lt;/a> å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@UseCase&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Transactional&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SendMoneyService&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">SendMoneyUseCase&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">sendMoney&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SendMoneyCommand&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">AccountId&lt;/span> &lt;span class="n">sourceAccountId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sourceAccount&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">orElseThrow&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;expected source account ID not to be empty&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">AccountId&lt;/span> &lt;span class="n">targetAccountId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">targetAccount&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">orElseThrow&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;expected target account ID not to be empty&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">accountLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lockAccount&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sourceAccountId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">sourceAccount&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">withdraw&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMoney&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">targetAccountId&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">accountLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">releaseAccount&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sourceAccountId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">accountLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lockAccount&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">targetAccountId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">targetAccount&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">deposit&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMoney&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">sourceAccountId&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">accountLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">releaseAccount&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sourceAccountId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">accountLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">releaseAccount&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">targetAccountId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½œè€…ç›´æ¥ä½¿ç”¨ framework æä¾›çš„ annotation @Transaction æŠŠæ‰€æœ‰çš„æ“ä½œéƒ½æ”¾åˆ°åŒä¸€å€‹ Transaction ä¸­&lt;/p>
&lt;h3 id="2-æ‡‰è©²æ”¾åˆ°-repository-ä¸­æœ‰å…¶ä»–çš„éœ€æ±‚ç”¨-callback-function-è£œå……">2. æ‡‰è©²æ”¾åˆ° repository ä¸­ï¼Œæœ‰å…¶ä»–çš„éœ€æ±‚ç”¨ callback function è£œå……&lt;/h3>
&lt;p>é€™æ˜¯æˆ‘åœ¨ Coscup è½åˆ°çš„ &lt;a class="link" href="https://github.com/chatbotgang/go-clean-arch" target="_blank" rel="noopener"
>golang ç‰ˆæœ¬ CA å¯¦ä½œ&lt;/a>ï¼Œä½œè€…ä¸€é–‹å§‹æƒ³è¦çš„è§£æ³•æ˜¯usecase æ§åˆ¶ lockï¼Œrepository æ§åˆ¶ transaction&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">BarterService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ExchangeGoods&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span> &lt;span class="nx">ExchangeGoodsParam&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. Claim an event to exchange goods X and Y
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lockServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">claim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">X&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ttl&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. Check ownership of request good
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// 3. Check the target good exist or not
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// 4. Exchange ownership of two goods
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// .......
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 5. Disclaim the event
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lockServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">disclaim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">X&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">CheckOwnerIDsAndUpdateGoods&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span> &lt;span class="nx">CheckOwnerIDsAndUpdateGoodsParam&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">updatedGoods&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">beginTx&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">finishTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. Get goods again
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getGoodByIDandOwnerID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">G1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">G1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OnwerID&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ...}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getGoodByIDandOwnerID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">G2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">G2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OnwerID&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ...}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. Update Goods
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">goods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updatedGood&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">updateGood&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">updateGoods&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updatedGoods&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">updatedGoods&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">updatedGood&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">updatedGoods&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†åœ¨é€™å€‹ issue ä¸­æœ‰äººè£œå……ä¸åŒçš„ä½œæ³• &lt;a class="link" href="https://github.com/chatbotgang/go-clean-arch/issues/13" target="_blank" rel="noopener"
>Is there a race condition bug?&lt;/a>ï¼Œå¦ä¸€å€‹äººæåˆ° &lt;code>lock æ¯”è¼ƒä¸åƒå•†å‹™é‚è¼¯ï¼Œæ¯”è¼ƒåƒå¯¦ä½œçš„ç´°ç¯€ï¼Œæ‰€ä»¥ä»–æœƒæƒ³è¦æ”¾åˆ° repository ä¸­&lt;/code>ï¼Œè€Œå•†å‹™é‚è¼¯å°±ç”¨ callback function æ–¹å¼å‚³å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">BarterService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ExchangeGoods&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span> &lt;span class="nx">ExchangeGoodsParam&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">goodRepo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">UpdateTwoGoods&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">G1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">G2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g2&lt;/span> &lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. Check ownership of request good
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ......
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. Check the target good exist or not
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ......
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 3. Exchange ownership of two goods
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ......
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">UpdateTwoGoods&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id2&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updateFn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">beginTx&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">finishTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. Fetch required data
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">g1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getGoodByID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ... }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">g2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getGoodByID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id2&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ... }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. Apply business logic (usecase)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">g1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">updateFn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g2&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ... }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">g1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="é‡æ–°æ€è€ƒ">é‡æ–°æ€è€ƒ&lt;/h2>
&lt;p>é‡æ–°æŠ½è±¡åŒ–ä¸€ä¸‹é‡åˆ°çš„å›°å¢ƒ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">usecase
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1. å¾ repo è®€å–ï¼ŒåŒæ™‚è¦ lock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2. é‡å°è®€å–çš„æ•¸å€¼åˆ¤æ–·
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3. æ ¹æ“šåˆ¤æ–·ï¼Œå°‡çµæœå¯«å› repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4. ä»¥ä¸Šä¸‰æ­¥è¦åœ¨åŒä¸€å€‹ transaction
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡æ–°å¯©æ€ CA çš„æ¢ä»¶ï¼Œæœ‰å¹¾é»è¦å‰‡æˆ‘å€‘æ‡‰è©²è¦éµå®ˆ&lt;/p>
&lt;ol>
&lt;li>repository æ‡‰è©²åªåŒ…å«å„²å­˜å±¤çš„æ“ä½œï¼Œä¸æ‡‰è©²æœ‰å•†å‹™é‚è¼¯&lt;/li>
&lt;li>usecase ä¸æ‡‰è©²çŸ¥é“å¤ªå¤š repository ç´°ç¯€ï¼Œæˆ–æ›å€‹è§’åº¦ï¼Œç•¶æŠ½æ› repository æ™‚æ‡‰è©²è¦å¾ˆå®¹æ˜“ï¼Œä¸æ”¹è®Š usecase çš„å¯¦ä½œ&lt;/li>
&lt;/ol>
&lt;p>æ ¹æ“šä»¥ä¸Šçš„æ¢ä»¶ï¼Œä¾†æ¸¬è©¦å…©ç¨®æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>usecase æ§åˆ¶ lock èˆ‡ transaction&lt;/li>
&lt;li>repository ç”¨ callback function æ³¨å…¥å•†å‹™é‚è¼¯
å…©è€…å¯¦ä½œèµ·ä¾†çš„æ„Ÿè¦º&lt;/li>
&lt;/ol>
&lt;h2 id="å¯¦ä½œæ¯”è¼ƒ">å¯¦ä½œæ¯”è¼ƒ&lt;/h2>
&lt;p>åƒè€ƒç¨‹å¼ç¢¼ &lt;a class="link" href="https://github.com/sj82516/clean-architecture-transaction-issue" target="_blank" rel="noopener"
>clean-architecture-transaction-issue&lt;/a>&lt;/p>
&lt;h3 id="æ–¹æ³•ä¸€use-case-æ§åˆ¶-transaction-èˆ‡-lock">æ–¹æ³•ä¸€ï¼šuse case æ§åˆ¶ transaction èˆ‡ lock&lt;/h3>
&lt;p>é¦–å…ˆåœ¨ &lt;a class="link" href="https://github.com/sj82516/clean-architecture-transaction-issue/blob/1e5f66cf6df40b38a3df7c510d58e845a58493be/usecase/purchase_product.rb#L11" target="_blank" rel="noopener"
>usecase ä¸­æ§åˆ¶&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transaction&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">user_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find_by_id_with_lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">product&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">product_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find_by_id_with_lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">product_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">price&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">can_purchase?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">can_purchase?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># to test race condition&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">sleep&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">points&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="n">total&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stock&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">order&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">product_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">product&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">order_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šæš´éœ²äº†è »å¤šé—œæ–¼ DB çš„ç´°ç¯€ï¼ŒåŒ…å« transaction / lock / commitï¼Œä½†æ‰€æœ‰çš„å•†æ¥­é‚è¼¯ä¹Ÿéƒ½åœ¨ usecase ä¸­ï¼›&lt;br>
ä½†æ•´é«”å‚·å®³æ‡‰è©²ä¸ç®—åˆ°å¤ªåš´é‡ï¼Œä¸»è¦æ˜¯ä¹Ÿæ²’æœ‰ç›´æ¥è·Ÿ DB è€¦åˆï¼Œå¦‚æœæŠ½æ›æˆå…¶ä»– NoSQL é ‚å¤š transaction / commit method ç•™ç©ºï¼Œä¸æœƒç›´æ¥é•å CA ä¾è³´æ–¹å‘çš„åŸå‰‡&lt;/p>
&lt;h3 id="æ–¹æ³•äºŒç”±-repository-æ§åˆ¶-transaction">æ–¹æ³•äºŒï¼šç”± repository æ§åˆ¶ transaction&lt;/h3>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/clean-architecture-transaction-issue/blob/1e5f66cf6df40b38a3df7c510d58e845a58493be/usecase/purchase_product.rb#L32" target="_blank" rel="noopener"
>ç”± repository æ§åˆ¶ transaction&lt;/a>ï¼Œå•†å‹™é‚è¼¯ç”¨ block æ–¹å¼å‚³å…¥ï¼Œå…¶é¤˜çš„é‚è¼¯éƒ½åœ¨ repository ä¸­&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># usecase&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">run_in_repo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">aggregate_root_repository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">purchase_product&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">price&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">next&lt;/span> &lt;span class="kp">false&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">can_purchase?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">next&lt;/span> &lt;span class="kp">false&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">can_purchase?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># repository&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">AggregateRootRepository&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">Repository&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">purchase_product&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;SELECT * FROM users WHERE id = ? FOR UPDATE&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">first&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">User&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;points&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;SELECT * FROM products WHERE id = ? FOR UPDATE&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">product_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">first&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">product&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;price&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;stock&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_pass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">yield&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">is_pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;INSERT INTO orders (user_id, product_id, count) VALUES (?, ?, ?)&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">price&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;UPDATE users SET points = ? WHERE id = ?&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">points&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">total&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;UPDATE products SET stock = ? WHERE id = ?&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stock&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">product&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">commit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šçš„å•†å‹™é‚è¼¯åªæœ‰åˆ¤æ–·æ˜¯å¦å¯ä»¥è³¼è²·ï¼Œå…¶é¤˜çš„ DB æ“ä½œå°è£åœ¨ repository ä¸­ï¼Œé€™é‚Šå–åå«åš Aggregate Root æ˜¯æƒ³å‘¼æ‡‰ DDD è£¡é¢çš„æƒ³æ³•ã€Œç”± Aggregate Root æ“ä½œä¿è­‰åº•ä¸‹å¤šå€‹ Aggregate çš„ä¸€è‡´æ€§ã€ï¼Œéˆæ„Ÿæ˜¯ä¾†è‡ªä¹‹å‰ä¸Š Teddy çš„èª²ç¨‹èˆ‡ &lt;a class="link" href="https://www.facebook.com/groups/teddy.tw/permalink/5329440543789659/" target="_blank" rel="noopener"
>FB è¨è«–&lt;/a>&lt;/p>
&lt;h3 id="æ¯”è¼ƒå…©è€…å·®ç•°">æ¯”è¼ƒå…©è€…å·®ç•°&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>usecase ä¹¾æ·¨ç¨‹åº¦(æ–¹æ³•äºŒå‹)ï¼š&lt;/strong>&lt;br>
è »æ˜é¡¯ä½œæ³•å¾ˆä¹¾æ·¨ï¼ŒæŠŠæ‰€æœ‰çš„ DB lock / transaction éƒ½å°è£å¾—ä¸€ä¹¾äºŒå‡ˆï¼Œè€Œå•†å‹™é‚è¼¯é‚„æ˜¯ä¿ç•™åœ¨ usecase ä¸­å‘¼å«&lt;/li>
&lt;li>&lt;strong>æ“´å……æ€§(æ–¹æ³•ä¸€å‹)ï¼š&lt;/strong>&lt;br>
å¦‚æœæœªä¾†å•†å‹™é‚è¼¯è®Šå¾—æ›´è¤‡é›œï¼Œæœ‰å¯èƒ½ DB æŸ¥å®Œè³‡æ–™è¦å¢åŠ æ–°çš„æ¯”å°ï¼Œä¾‹å¦‚ã€Œé«˜ç´šæœƒå“¡æœ‰æ›´å¤šçš„æŠ˜åƒ¹ã€ã€ã€Œç‰¹æ®Šå•†å“è²· 10 é€ 1ã€ç­‰ç­‰ï¼Œæ–¹æ³•äºŒéœ€è¦ä¸æ–·çš„å¢åŠ  function å‚³å…¥ï¼Œè€Œæ–¹æ³•ä¸€å› ç‚ºéƒ½æ˜¯åœ¨ usecase æ“ä½œï¼Œæ‰€ä»¥ç›´æ¥å¢åŠ å°±å¥½ï¼Œç›¸å°å¥½æ“´å……&lt;/li>
&lt;li>&lt;strong>å¯æ¸¬è©¦æ€§(æ–¹æ³•ä¸€å‹)ï¼š&lt;/strong>
æˆ‘è¦ºå¾—å…©å€‹ä½œæ³•æœ€å¤§çš„å·®ç•°æ˜¯&lt;code>å¯æ¸¬è©¦æ€§&lt;/code>ï¼Œæ¸¬è©¦å¯ä»¥ç”¨ integration test é€£ DB ä¸€èµ·æ¸¬ / æˆ–æ˜¯ unit test æŠŠå…¶ä»–ç›¸ä¾çš„ç‰©ä»¶ mock æ‰ï¼›
integration æ¸¬è©¦éƒ¨åˆ†å…©è€…æ²’å¤ªå¤šå·®ç•° (åƒè€ƒ &lt;a class="link" href="https://github.com/sj82516/clean-architecture-transaction-issue/blob/master/main_spec.rb" target="_blank" rel="noopener"
>main_spec.rb&lt;/a>)ï¼›&lt;br>
ä½†æ˜¯ unit test å°±æœ‰å¾ˆå¤§çš„å·®ç•° (åƒè€ƒ &lt;a class="link" href="https://github.com/sj82516/clean-architecture-transaction-issue/blob/master/usecase_spec.rb" target="_blank" rel="noopener"
>usecase.rb&lt;/a>)ï¼Œå› ç‚ºæ–¹æ³•ä¸€çš„ repository æ–¹æ³•éƒ½æ˜¯ public è®“ usecase å‘¼å«ï¼Œæ‰€ä»¥å¾ˆå¥½ mockï¼Œä½†æ–¹æ³•äºŒç›®å‰æˆ‘æƒ³ä¸åˆ°æ¯”è¼ƒå¥½çš„æ–¹æ³•æ¸¬è©¦ï¼Œå› ç‚º callback function (block) æ˜¯åœ¨ repo ä¸­å‘¼å«ï¼Œé‚£æˆ‘ç›´æ¥ mock æ‰ä¸å°±ä»€éº¼éƒ½æ¸¬ä¸äº†äº† ?!!&lt;/li>
&lt;/ol>
&lt;h2 id="çµè«–">çµè«–&lt;/h2>
&lt;p>å³ä½¿ usecase æœƒæ¯”è¼ƒæ··äº‚ä¸€äº›ï¼Œæˆ‘é‚„æ˜¯é¸æ“‡æ–¹æ³•ä¸€&lt;/p>
&lt;p>(golang ç‰ˆæœ¬å¾…è£œ)&lt;/p></description></item><item><title>ã€Šæœ€æœ‰ç”Ÿç”¢åŠ›çš„ä¸€å¹´ã€‹è®€æ›¸å¿ƒå¾—èˆ‡å€‹äººå¯¦è¸</title><link>https://yuanchieh.page/posts/2023/2023-04-01-%E6%9C%80%E6%9C%89%E7%94%9F%E7%94%A2%E5%8A%9B%E7%9A%84%E4%B8%80%E5%B9%B4%E8%AE%80%E6%9B%B8%E5%BF%83%E5%BE%97%E8%88%87%E5%80%8B%E4%BA%BA%E5%AF%A6%E8%B8%90/</link><pubDate>Sat, 01 Apr 2023 02:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-04-01-%E6%9C%80%E6%9C%89%E7%94%9F%E7%94%A2%E5%8A%9B%E7%9A%84%E4%B8%80%E5%B9%B4%E8%AE%80%E6%9B%B8%E5%BF%83%E5%BE%97%E8%88%87%E5%80%8B%E4%BA%BA%E5%AF%A6%E8%B8%90/</guid><description>&lt;p>æœ‰å¥½ä¸€é™£å­è¦ºå¾—è‡ªå·±èŠ±äº†è »å¤šæ™‚é–“åœ¨å­¸ç¿’ä¸Šï¼Œå‡æ—¥ä¹Ÿæœƒè¦åŠƒè®€æ›¸å¯«ç¨‹å¼ï¼Œä½†ç¸½è¦ºå¾—è‡ªå·±ä¸¦æ²’æœ‰çœŸæ­£ç©ç´¯æˆ–å¾ˆå·¨å¹…çš„æˆé•·ï¼Œé€™äº›åŠªåŠ›èˆ‡ä»˜å‡ºå¥½åƒæ˜¯åœ¨æ»¿è¶³è‡ªå·±çš„ç„¦æ…®ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„ç”¢ç”Ÿæ”¹è®Šèˆ‡æˆå°±&lt;/p>
&lt;p>ç›´åˆ°çœ‹äº†ã€Šæœ€æœ‰ç”Ÿç”¢åŠ›çš„ä¸€å¹´ã€‹ï¼Œæ‰ç™¼ç¾è‡ªå·±ä¹‹å‰åœ¨å®‰æ’å­¸ç¿’é …ç›®èˆ‡è¦åŠƒä¸Šï¼Œæœ‰äº†æ€ç¶­ä¸Šçš„èª¤å·®ï¼Œè©¦è‘—å¥—ç”¨æ›¸ä¸­çš„ä½œæ³•ï¼Œé€æ­¥èª¿æ•´å‡ºè‡ªå·±å¯¦è¸çš„æ–¹å¼ï¼Œè¦ºå¾—ç”Ÿç”¢åŠ›ä¸Šé–‹å§‹æœ‰ä¸€äº›æ­£å‘çš„è®ŠåŒ–&lt;/p>
&lt;p>ä»¥ä¸‹åˆ†äº«æ›¸ä¸­çš„ä¸€äº›è§€å¿µèˆ‡åšæ³•ï¼Œä¸¦åˆ†äº«è‡ªå·±å¦‚ä½•å¯¦è¸èˆ‡ä¸€äº›æ„Ÿæƒ³&lt;/p>
&lt;h2 id="ä¸‰å€‹è§€å¿µ">ä¸‰å€‹è§€å¿µ&lt;/h2>
&lt;h3 id="è§€å¿µä¸€ç”Ÿç”¢åŠ›çš„é‡é»æ˜¯æˆå°±è€Œä¸æ˜¯å®Œæˆå¤šå°‘äº‹">è§€å¿µä¸€ï¼šç”Ÿç”¢åŠ›çš„é‡é»æ˜¯ã€Œæˆå°±ã€ï¼Œè€Œä¸æ˜¯å®Œæˆå¤šå°‘äº‹&lt;/h3>
&lt;p>ä½œè€…åˆ†äº«åˆ°ä¸€æåˆ°ç”Ÿç”¢åŠ›å¤§å®¶é—œæ³¨çš„å¾€å¾€æ˜¯æˆ‘å¦‚ä½•åœ¨ä¸€å®šçš„æ™‚é–“å®Œæˆå¤šå°‘äº‹ï¼Œä½†çœŸæ­£é‡è¦çš„æ˜¯ã€Œä½ å®Œæˆçš„å¤šå°‘çš„æˆå°±ã€ (p19)&lt;/p>
&lt;p>æˆå°±èˆ‡ä¸€èˆ¬äº‹é …çš„å€åˆ†åœ¨æ–¼&lt;code>æˆå°±æ˜¯ç”¢ç”Ÿé‡å¤§æ”¹è®Šèˆ‡æ„ç¾©çš„äº‹æƒ…&lt;/code>ï¼Œå°±å¥½æ¯”èªªæ€¥è¿«æ€§èˆ‡é‡è¦æ€§çŸ©é™£ï¼Œå¦‚æœä½ ä¸€ç›´åœ¨è™•ç†ç·Šæ€¥å»ä¸é‡è¦çš„é›œäº‹ï¼Œä¾‹å¦‚å›å› Email ã€åƒåŠ ä¸å¿…è¦çš„æœƒè­°ï¼Œçœ‹èµ·ä¾†å®Œæˆå¾ˆå¤šäº‹ä½†çœŸæ­£é‡è¦çš„äº‹æƒ…éƒ½æ²’æœ‰è¢«è™•ç†ï¼Œæ‰€ä»¥ä½œè€…æåˆ°é‡é»è¦æ”¾åœ¨ã€Œæˆå°±ã€è€Œéå®Œæˆäº‹é …çš„æ•¸é‡&lt;/p>
&lt;blockquote>
&lt;p>å¿…é ˆæ„è­˜åˆ°ï¼šä¸æ˜¯æ¯ä»¶äº‹éƒ½åŒç­‰çš„é‡è¦&lt;/p>
&lt;/blockquote>
&lt;h3 id="è§€å¿µäºŒæˆå°±æ˜¯è¦é€£çµè‡ªå·±çš„åƒ¹å€¼è§€æ‰¾å‡ºé‡è¦ä¸”æœ‰å‹•åŠ›çš„äº‹é …">è§€å¿µäºŒï¼šæˆå°±æ˜¯è¦é€£çµè‡ªå·±çš„åƒ¹å€¼è§€ï¼Œæ‰¾å‡ºé‡è¦ä¸”æœ‰å‹•åŠ›çš„äº‹é …&lt;/h3>
&lt;p>å»¶çºŒæˆå°±çš„å®šç¾©ï¼Œé€™æœƒä¾ç…§æ¯å€‹äººçš„åƒ¹å€¼è§€è€Œæœ‰æ‰€ä¸åŒï¼Œè€Œæ‰¾å‡ºè‡ªå·±äººç”Ÿçš„åƒ¹å€¼è§€æ˜¯ä¸€ä»¶å¾ˆé‡è¦ä½†æˆ‘è¦ºå¾—ä¸æ˜¯é€™éº¼ç°¡å–®ã€å…·é«”çš„äº‹æƒ…&lt;/p>
&lt;p>ä½œè€…é€™é‚Šæä¾›ä¸€å€‹æœ‰è¶£çš„æ€è€ƒæ–¹å¼ã€Œæƒ³åƒè‡ªå·±çªç„¶æ¯å¤©å¤šäº†å…©å°æ™‚ï¼Œä½ æœƒæ‹¿ä¾†åšä»€éº¼ï¼Ÿã€ æé«˜ç”Ÿç”¢åŠ›ç„¡éæ˜¯æƒ³ç‚ºè‡ªå·±è³ºåˆ°æ›´å¤šçš„æ™‚é–“èˆ‡ç²¾åŠ›ï¼Œé‚£é€™å¤šå‡ºä¾†çš„æ™‚é–“æ€éº¼é‹ç”¨ï¼Œå°±æœƒåæ˜ è‡ªå·±çš„åƒ¹å€¼è§€èˆ‡æ’åºæ–¹å¼ (p33)&lt;/p>
&lt;p>å¦ä¸€å€‹å»ºè­°æ˜¯å¯ä»¥å±…é«˜è‡¨ä¸‹ï¼Œå¾ç”Ÿæ´»çš„ä¸åŒé¢å‘å»åæ€ï¼Œå¦‚é ­è…¦(å­¸ç¿’)ã€èº«é«”ç‹€æ…‹ã€æƒ…æ„Ÿã€è·æ¶¯ã€è²¡å‹™ã€äººéš›é—œä¿‚ã€ä¼‘é–’æ¨‚è¶£ (p208)ï¼Œé€™é‚Šå‘¼æ‡‰åˆ°å¦ä¸€ç¯‡å¯«æ—¥è¨˜çš„æ–¹å¼ &lt;a class="link" href="https://medium.com/pm%E7%9A%84%E7%94%9F%E7%94%A2%E5%8A%9B%E5%B7%A5%E5%85%B7%E7%AE%B1/%E5%AF%AB%E6%97%A5%E8%A8%98%E7%9A%84%E7%AD%96%E7%95%A5-%E6%97%A5%E8%A8%98%E5%88%B0%E5%BA%95%E8%A6%81%E5%AF%AB%E5%93%AA%E4%BA%9B%E5%85%A7%E5%AE%B9-3f5107418eed" target="_blank" rel="noopener"
>æœ±é¨-å¯«æ—¥è¨˜çš„ç­–ç•¥ 1 : æ—¥è¨˜åˆ°åº•è¦å¯«å“ªäº›å…§å®¹ï¼Ÿ&lt;/a>ï¼Œç”¨å®Œæ•´çš„è§’åº¦å»æª¢è¦–æ¯”è¼ƒä¸æœƒæœ‰éºæ¼&lt;/p>
&lt;h3 id="è§€å¿µä¸‰çµ‚çµæ™‚é–“ç®¡ç†ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›æ‰æ˜¯é‡é»">è§€å¿µä¸‰ï¼šçµ‚çµæ™‚é–“ç®¡ç†ï¼Œç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›æ‰æ˜¯é‡é»&lt;/h3>
&lt;p>ä½œè€…æåˆ°æ™‚é–“ç¶“æ¿Ÿæ˜¯å› ç‚ºå·¥å» çš„èˆˆèµ·ï¼Œäººå€‘çš„æ”¶å…¥ç›´æ¥èˆ‡å·¥ä½œæ™‚é–“æ›é‰¤ï¼Œåšå¤šå°‘æ™‚é–“æ‹¿å¤šå°‘å ±é…¬&lt;/p>
&lt;p>ä½†ç¾åœ¨çš„ç¤¾æœƒæ˜¯æ³¨é‡ç”¢å‡ºï¼Œ&lt;code>èƒ½å¤ ä¸€å€‹å°æ™‚å®Œæˆçš„æˆå°±ç‚ºä»€éº¼è¦ç”¨å…©å€‹å°æ™‚ ?!&lt;/code>ï¼Œè€Œè¦åœ¨æ›´çŸ­çš„æ™‚é–“åšåˆ°ç›¸åŒçš„æˆå°±ï¼Œå°±éœ€è¦é«˜åº¦çš„ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›çš„æŠ•å…¥ï¼Œé€™æ­£ä¹Ÿæ˜¯æˆ‘å€‘æ‰€èƒ½æ§åˆ¶çš„&lt;/p>
&lt;p>ä½œè€…æ›¾ç¶“å¯¦é©—éä¸€é€±å·¥ä½œ 90 å°æ™‚ vs ä¸€é€±å·¥ä½œ 20 å°æ™‚ï¼Œç™¼ç¾ 90 å°æ™‚çš„ç”¢å‡ºåªæ¯” 20 å°æ™‚å¤šä¸€äº›ï¼ŒåŸå› æœ‰å¹¾å€‹&lt;/p>
&lt;ol>
&lt;li>æ™‚é–“å¤ªé•·ç”Ÿç”¢åŠ›æœƒåš´é‡ä¸‹æ»‘&lt;/li>
&lt;li>å˜—è©¦å£“ç¸®ç›®æ¨™æ™‚é–“ï¼Œåè€Œæœƒè®“è‡ªå·±ç”¨æ›´é«˜çš„å°ˆæ³¨åŠ›å®Œæˆ&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>åˆ‡è¨˜ï¼Œå¿™ç¢Œä¸ç­‰æ–¼æœ‰æ•ˆç‡&lt;/p>
&lt;/blockquote>
&lt;p>ä¹‹å‰çš„æˆ‘æœ‰é»è¸©åˆ°è‘—å€‹å‘ï¼Œåªé—œæ³¨åˆ°è‡ªå·±èŠ±å¾ˆå¤šæ™‚é–“ï¼Œå»æ²’æ„è­˜åˆ°è‡ªå·±å°ˆæ³¨åŠ›èˆ‡ç”Ÿç”¢åŠ›ï¼Œå°è‡´åœ¨çå¿™&lt;/p>
&lt;h2 id="ä¸‰å€‹å¯¦è¸æ–¹å¼">ä¸‰å€‹å¯¦è¸æ–¹å¼&lt;/h2>
&lt;p>ä½œè€…åˆ†äº«äº† 20 å¤šå€‹æ”¹å–„ç”Ÿç”¢åŠ›å¯¦é©—ï¼Œé€™é‚Šæˆ‘æŒ‘ 3 å€‹è¦ºå¾—æœ€æœ‰æ•ˆæœçš„&lt;/p>
&lt;h3 id="å¯¦è¸ä¸€æ‰¾å‡ºç”Ÿç†é»ƒé‡‘æ™‚æ®µ">å¯¦è¸ä¸€ï¼šæ‰¾å‡ºç”Ÿç†é»ƒé‡‘æ™‚æ®µ&lt;/h3>
&lt;p>å»¶çºŒè§€å¿µä¸‰ï¼Œé…åˆå€‹äººçš„ä½œæ¯ï¼Œäººæ¯å¤©çš„ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›åœ¨ä¸åŒçš„æ™‚é–“é»éƒ½æœƒæœ‰ä¸åŒçš„è¡¨ç¾ï¼Œæ‰€ä»¥è¦æ‰¾å‡ºè‡ªå·±çš„ &lt;code>é»ƒé‡‘æ™‚æ®µ&lt;/code>ï¼Œå°‡æœ€é‡è¦çš„äº‹æƒ…åœ¨æœ€ä½³çš„æ™‚æ®µè™•ç†ï¼Œé€™å°±æ˜¯æ‰€è¬‚çš„ç®¡ç†ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›&lt;/p>
&lt;p>ä½œè€…æ˜¯å»ºè­°èŠ±ä¸€é€±çš„æ™‚é–“ï¼Œæ¯å€‹å°æ™‚å°±ç´€éŒ„ 1) ç²¾åŠ›èˆ‡å°ˆæ³¨åŠ›çš„ç‹€æ…‹ 2) å®Œæˆçš„äº‹é … 3) æ˜¯å¦æœ‰æ‹–å»¶çš„ç‹€æ³ (p67)
è¿½è¹¤ä¸€æ®µæ™‚é–“ï¼Œå°±èƒ½æŒæ¡è‡ªå·±çš„ç”Ÿç†ç‹€æ³&lt;/p>
&lt;p>å¦å¤–æœ‰å¹¾å€‹æ–¹æ³•å¯ä»¥æ”¹å–„è‡ªå·±çš„ç”Ÿç†ç‹€æ³ï¼Œä¾‹å¦‚ ç¡åˆ°è‡ªç„¶é†’ / æˆ’ç³– / é‹å‹• / å†¥æƒ³ç­‰ï¼Œé€™éƒ¨åˆ†æ¯”è¼ƒç‚ºäººç†ŸçŸ¥å°±ä¸å¦å¤–è´…è¿°&lt;/p>
&lt;h3 id="å¯¦è¸äºŒå®‰æ’æœ€é‡è¦çš„ä¸‰ä»¶äº‹">å¯¦è¸äºŒï¼šå®‰æ’æœ€é‡è¦çš„ä¸‰ä»¶äº‹&lt;/h3>
&lt;p>æ¯å¤©ä¸è¦å®‰æ’å¤ªå¤šçš„äº‹æƒ…ï¼Œåªè¦å®‰æ’&lt;code>3~5 ä»¶é‡è¦çš„äº‹&lt;/code>å°±å¥½ï¼Œé€™å€‹æ•¸é‡çš„äº‹é …å¯ä»¥è¨˜åœ¨è…¦ä¸­ï¼Œå°±ä¸ç”¨é¡å¤–çš„ä»»å‹™ç®¡ç†å·¥å…· (p51)&lt;/p>
&lt;p>é€™é»å€‹äººä¹Ÿéå¸¸æœ‰æ„Ÿï¼Œä¹‹å‰æ›¾ç¶“è©¦è‘—ç”¨ trello / asana / google calendar æƒ³è¦å»ç®¡ç†å€‹äººå·¥ä½œäº‹é …ï¼Œç™¼ç¾åˆ°é ­ä¾†&lt;code>èŠ±åœ¨ä»»å‹™äº‹é …è¦åŠƒçš„ç²¾åŠ›é é«˜æ–¼å¯¦éš›åŸ·è¡Œçš„æŠ•å…¥&lt;/code>ï¼Œé€™é»ä¹Ÿå›å‘¼åˆ°è§€å¿µä¸€ï¼Œæˆ‘çœŸæ­£è¦æˆå°±çš„æ‡‰è©²æ˜¯å·¥ä½œé …ç›®ï¼Œè€Œä¸æ˜¯è¦åŠƒå·¥ä½œé …ç›®æœ¬èº«&lt;/p>
&lt;h3 id="å¯¦è¸ä¸‰å€åˆ†æ™‚é–“ç®¡ç†---å‰µä½œè€…èˆ‡ç®¡ç†è€…">å¯¦è¸ä¸‰ï¼šå€åˆ†æ™‚é–“ç®¡ç† - å‰µä½œè€…èˆ‡ç®¡ç†è€…&lt;/h3>
&lt;p>è§€å¿µä¸‰æåˆ°æ™‚é–“ç®¡ç†ç›¸å°ä¸æ˜¯é€™éº¼é‡è¦ï¼Œå¿ƒä¸­å¯èƒ½æœƒæœ‰å€‹ç–‘æƒ‘ã€Œæˆ‘åœ¨å…¬å¸å°±æœ‰å¾ˆå¤šæœƒè­°è¦é–‹ï¼ŒçœŸçš„ä¸éœ€è¦æ™‚é–“ç®¡ç†å—ï¼Ÿã€é€™é‚Šä½œè€…å¼•è¿° YC å‰µè¾¦äºº Paul Graham çš„æ™‚é–“ç®¡ç†æ–¹å¼ &lt;a class="link" href="http://www.paulgraham.com/makersschedule.html" target="_blank" rel="noopener"
>manager&amp;rsquo;s schedule and the maker&amp;rsquo;s schedule&lt;/a>ï¼Œä»–å°‡æ™‚é–“ç®¡ç†åˆ†æˆå…©ç¨®æ¨¡å¼ ç®¡ç†è€…æ¨¡å¼èˆ‡å‰µä½œè€…æ¨¡å¼&lt;/p>
&lt;ul>
&lt;li>ç®¡ç†è€…æ¨¡å¼ï¼šéœ€è¦èˆ‡ä»–äººæ™‚å¸¸é–‹æœƒã€å›è¦† Email çš„ç®¡ç†é¡å‹äº‹é …ï¼Œé€šå¸¸æœƒä»¥ä¸€å€‹å°æ™‚ç‚ºå–®ä½åˆ‡åˆ†ï¼Œä¸¦æ’å…¥ä¸åŒçš„è­°ç¨‹&lt;/li>
&lt;li>å‰µä½œè€…æ¨¡å¼ï¼šå°ˆæ³¨æ–¼è‡ªå·±çš„ç”¢å‡ºï¼Œä¾‹å¦‚ä½œå®¶æˆ–ç¨‹åºå“¡ï¼Œé€šå¸¸æœƒä»¥æ›´å¤§çš„æ™‚é–“å€æ®µ (ä¸€å€‹ä¸Šåˆæˆ–ä¸‹åˆ) å®‰æ’è‡ªå·±çš„å·¥ä½œ&lt;/li>
&lt;/ul>
&lt;p>è¦å…ˆè­˜åˆ¥è‡ªå·±å±¬æ–¼å“ªç¨®é¡å‹çš„å·¥ä½œè€…ï¼Œæ¥è‘—ç”¨å°æ‡‰çš„æ–¹å¼å®‰æ’å·¥ä½œé …ç›®ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ··åˆæ¨¡å¼ï¼Œä¾‹å¦‚ä½œè€…åˆ†äº«ä»–æ—©ä¸Šæ˜¯å‰µä½œè€…æ¨¡å¼ï¼Œä¸‹åˆæ¡ç”¨ç®¡ç†è€…æ¨¡å¼&lt;/p>
&lt;p>é€™é‚Šå»¶ä¼¸è¨è«– Paul Graham &lt;a class="link" href="http://www.paulgraham.com/makersschedule.html" target="_blank" rel="noopener"
>åŸæ–‡&lt;/a> ä¸­å¹¾å€‹æœ‰è¶£çš„è«–é»&lt;/p>
&lt;ol>
&lt;li>èº«ç‚ºå‰µä½œè€…ï¼Œä¸è¦å°çœ‹ä¸€å€‹å°å°çš„æœƒè­°æ€éº¼æ‰“æ–·ä½ çš„å·¥ä½œæµï¼Œè©¦è‘—æƒ³æƒ³ç•¶æŸä¸€å¤©éƒ½æ²’æœ‰é–‹æœƒé‚£ç”Ÿç”¢åŠ›æ˜¯å¤šéº¼é©šäºº&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>I find one meeting can sometimes affect a whole day. A meeting commonly blows at least half a day, by breaking up a morning or afternoon. (&amp;hellip;..)
Don&amp;rsquo;t your spirits rise at the thought of having an entire day free to work, with no appointments at all?&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>å¦‚æœä½ æ˜¯ç®¡ç†è€…è¦å¸¶é ˜ä¸€ç¾¤å‰µä½œè€…ï¼Œè¦å°å¿ƒè‡ªå·±çš„å®‰æ’æœƒè­°çš„æ–¹å¼æ˜¯ä¸æ˜¯æ°ç•¶çš„&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Each type of schedule works fine by itself. Problems arise when they meet. Since most powerful people operate on the manager&amp;rsquo;s schedule, they&amp;rsquo;re in a position to make everyone resonate at their frequency if they want to.&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>Paul Graham åœ¨ç®¡ç† YC æŠ•è³‡çš„åœ˜éšŠï¼Œæ˜¯é€é office hour æä¾›æŠ•è³‡çš„åœ˜éšŠä¸»å‹•é ç´„æ™‚æ®µï¼Œé€™æ¨£åœ˜éšŠå¯ä»¥ä¸»å‹•é¸æ“‡é©åˆçš„æ™‚é–“ (maker style)ï¼Œè€Œä¸æ˜¯è¢«å‹•çš„æ¥å—é ç´„ (manager style)ï¼›&lt;br>
å°æ–¼ Paul Graham æœ¬äººä¾†èªªï¼Œä»–æŠŠæ‰€æœ‰çš„ office hour éƒ½æ’åœ¨è‡ªå·±å·¥ä½œæ—¥çš„æœ€å¾Œï¼Œåˆ‡åˆ†å‡ºè‡ªå·±çš„ç®¡ç†è€…èˆ‡å‰µä½œè€…æ™‚é–“&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>By using the classic device for simulating the manager&amp;rsquo;s schedule within the maker&amp;rsquo;s: office hours. &amp;hellip;.
These chunks of time are at the end of my working day. (&amp;hellip;..)
Because they come at the end of my day these meetings are never an interruption.&lt;/p>
&lt;/blockquote>
&lt;h2 id="è‡ªæˆ‘å¯¦è¸">è‡ªæˆ‘å¯¦è¸&lt;/h2>
&lt;p>ä»¥ä¸‹åˆ†äº«æˆ‘è‡ªå·±çš„ç”Ÿç”¢åŠ›ç®¡ç†æ–¹å¼ï¼Œä¸»è¦é€é Heptabase é€™å¥—ç­†è¨˜è»Ÿé«”ï¼Œä½¿ç”¨ Heptabase çš„å¥½è™•æ˜¯ï¼Œæˆ‘å¯ä»¥ç”¨åœ–å½¢åŒ–çš„æ–¹å¼ä¸€ç›®ç­ç„¶ç›¸é—œçš„ç´€éŒ„&lt;br>
æˆ‘ä¸»è¦æœƒåˆ†æˆ å¹´ / å­£ / æœˆ / é€± / æ—¥ï¼Œæˆ‘æœƒå¸Œæœ›å››è€…çš„ç›®æ¨™æ˜¯ç’°ç’°ç›¸æ‰£ï¼Œç•¶æˆ‘åœ¨å®‰æ’æ¯æ—¥å·¥ä½œäº‹é …ï¼Œæœƒæƒ³è¦çŸ¥é“é€™æœ‰æ²’æœ‰ç·Šæ‰£æˆ‘æ¯é€±çš„ç›®æ¨™ï¼Œè€Œæ¯é€±çš„ç›®æ¨™åˆ¶è¨‚æ™‚è¦ç·Šæ‰£æ¯æœˆçš„ç›®æ¨™ï¼Œä»¥æ­¤é¡æ¨&lt;br>
&lt;img src="https://yuanchieh.page/post/2023/img/0401/overview.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="ç›®æ¨™ç®¡ç†">ç›®æ¨™ç®¡ç†&lt;/h3>
&lt;p>åœ¨åˆ¶å®šæ¯å¹´çš„ç›®æ¨™ä¸Šï¼Œå»å¹´æˆ‘è·Ÿè€å©†èŠ±äº†ä¸€å¤©çš„æ™‚é–“ï¼Œæ¡ç”¨ &lt;a class="link" href="https://yearcompass.com/" target="_blank" rel="noopener"
>Year Compass&lt;/a>æ¨¡æ¿ï¼Œæˆ‘è¦ºå¾—è »ä¸éŒ¯çš„ï¼Œè¦†è“‹çš„ç¯„åœè »å®Œæ•´&lt;/p>
&lt;p>åœ¨åˆ¶å®šå¹´åº¦ç›®æ¨™æˆ‘ç›®å‰é‚„æ²’æœ‰å¾ˆæ¸…æ™°çš„ç•«é¢ï¼Œä½†æœƒè©¦è‘—ç”¨æ¯”è¼ƒå…·é«”çš„æè¿°å»è£œå……ï¼Œä¾‹å¦‚èªªä»Šå¹´å¹´åº¦ç›®æ¨™æœ‰ä¸€å€‹æ˜¯ã€Œé›¢é–‹ç¾åœ¨çš„å…¬å¸ï¼Œå»æ›´æœ‰åˆ¶åº¦çš„åœ°æ–¹ã€ï¼Œç•¶åˆè¨­ç«‹æ™‚æˆ‘å¿ƒä¸­æ²’æœ‰ä¸€å€‹æ˜ç¢ºçš„å¤¢æƒ³å…¬å¸ï¼Œåªç”¨æ›´æœ‰åˆ¶åº¦å»æ¶µè“‹ï¼Œä½†æˆ‘æœ‰è£œå……å¹¾å€‹ç´°é …å»æç¹ªï¼ŒåŒ…å«&lt;/p>
&lt;ul>
&lt;li>ç”¢å“ç™¼å±•çš„åˆ¶åº¦ï¼Œæ˜¯å¦æœ‰æ¸…æ¥šçš„ product roadmapã€åœ¨ç”¢å“çš„åŠŸèƒ½é–‹ç™¼é€±æœŸæ˜¯å¦å®Œæ•´&lt;/li>
&lt;li>å°ˆæ¡ˆç®¡ç†æµç¨‹ï¼Œæ˜¯å¦ä¸€å †éš•çŸ³è·Ÿ BDD (Boss Driven Design)&lt;/li>
&lt;/ul>
&lt;p>é‡å°æ¯æ—¥ä»»å‹™ä¸Šï¼Œæˆ‘æ˜¯ç›´æ¥ç”¨ Heptabase æœ€è¿‘æ”¯æ´çš„ Journal card å»è¦åŠƒ
&lt;img src="https://yuanchieh.page/post/2023/img/0401/daily.png"
loading="lazy"
>&lt;/p>
&lt;ul>
&lt;li>æ‹†æˆå…©å€‹æ™‚æ®µå·¥ä½œå‰èˆ‡å·¥ä½œä¸­ï¼Œå„å®‰æ’ 3 ~ 5 å€‹é …ç›®&lt;/li>
&lt;li>æå‰å±•é–‹æœªä¾†å¹¾å¤©çš„å¡ç‰‡ï¼Œæƒ³åˆ°å°±å…ˆå¯«æˆå…·é«”çš„åŸ·è¡Œé …ç›®ï¼Œä¸è¦ç•¶å¤©è¦åŸ·è¡Œæ™‚æ‰æƒ³å¯¦ä½œçš„ç´°ç¯€&lt;br>
ä¾‹å¦‚èªªä»Šå¤©å®‰æ’åˆ·é¡Œï¼Œå¯ä»¥çš„è©±å‰ä¸€å¤©å°±æŠŠé¡Œç›®æŒ‘å‡ºä¾† / å¦‚æœä»Šå¤©è¦çœ‹æ›¸ï¼Œå°±å…ˆæŠŠæ›¸çš„é ç¢¼æˆ–ç« ç¯€æ¨™è¨˜å‡ºä¾†ï¼Œæœ‰å…·é«”çš„é …ç›®è®“åŸ·è¡Œæ™‚æœƒæ›´é †æš¢&lt;/li>
&lt;li>æŠŠå¡ç‰‡æ”¤é–‹ï¼Œç•¶ç™¼ç¾è‡ªå·±æœ‰é»ç™¼æ•£æ™‚æé†’è‡ªå·±å›ä¾†çœ‹å¡ç‰‡çš„å…§å®¹&lt;/li>
&lt;li>æ¯å¤© reviewï¼Œç°¡å–®ç´€éŒ„è‡ªå·±åŸ·è¡Œç‹€æ³ï¼Œä»¥åŠèŠ±è²»åœ¨æ¯å€‹ä»»å‹™ä¸Šçš„æ™‚é–“&lt;/li>
&lt;/ul>
&lt;h4 id="ä»£è¾¦äº‹é …ç®¡ç†">ä»£è¾¦äº‹é …ç®¡ç†&lt;/h4>
&lt;blockquote>
&lt;p>è”¡åŠ å°¼å…‹æ•ˆæ‡‰(Zeigarnik effect) : ä¸å®Œæ•´æˆ–è¢«ä¸­æ–·çš„ä»»å‹™ï¼Œæœƒå¸¶çµ¦æˆ‘å€‘å¾ˆå¤§çš„å¿ƒç†å£“åŠ›&lt;/p>
&lt;/blockquote>
&lt;p>é€™æ˜¯å€‹è »æœ‰è¶£çš„å¿ƒç†å¯¦é©—ï¼Œè”¡åŠ å°¼å…‹ç™¼ç¾é¤å»³æœå‹™ç”Ÿå°æ–¼æœªçµå¸³çš„è¨‚å–®æœ‰å¾ˆå¥½çš„è¨˜æ†¶ï¼Œä½†åªè¦è¨‚å–®ä¸€çµå¸³å®Œæˆï¼Œå°±æœƒå¾ˆé›£å›æƒ³èµ·&lt;br>
ä½œè€…æåˆ°ç•¶å¿ƒä¸­æœ‰ä¸€å€‹æƒ³æ³•æˆ–ä»£è¾¦äº‹é …æ™‚ï¼Œäººå€‘æœƒå¾ˆæ€•å¿˜è¨˜ï¼Œæ‰€ä»¥æœƒä¸€ç›´çµ¦è‡ªå·±å¿ƒç†å£“åŠ›ï¼Œå°è‡´å¤§è…¦çš„æ€ç·’ä¹Ÿå—åˆ°å½±éŸ¿ï¼Œæ­¤æ™‚æœ€å¥½çš„æ–¹å¼æ˜¯å¯«ä¸‹ä¾†ï¼Œç•¶å¤§è…¦æ„è­˜åˆ°é€™ä»¶äº‹å·²ç¶“è¢«ç´€éŒ„ï¼Œå°±æœƒé‡‹æ”¾å¿ƒç†å£“åŠ›ï¼Œæ›´å°ˆæ³¨åœ¨å…¶ä»–äº‹æƒ…ä¸Š&lt;/p>
&lt;p>é€™å€‹ç†è«–åœ¨ã€Šå¡ç‰‡ç›’ç­†è¨˜ã€‹ä¹Ÿæœ‰æèµ·ï¼Œæˆ‘ç›®å‰çš„åšæ³•æ˜¯ç•¶ç ”ç©¶æŸå€‹ä¸»é¡Œå‡ºç¾æœ‰è¶£çš„åˆ†æ”¯æ™‚ï¼Œå…ˆé–‹æˆå¡ç‰‡æ¨™è¨˜æˆ todoï¼Œæ¥è‘—å…ˆå°ˆæ³¨åœ¨åŸæœ¬çš„ä¸»é¡Œç ”ç©¶ï¼Œé¿å…å¤ªéæ–¼ç™¼æ•£&lt;/p>
&lt;p>è€Œé€™å€‹ todo æ¸…å–®å°±æœƒè®Šæˆæˆ‘å®‰æ’å·¥ä½œæ™‚å¯ä»¥æª¢ç´¢çš„é …ç›®ï¼ŒHeptabase æœ‰ tag çš„åŠŸèƒ½ (å¤§éƒ¨åˆ†çš„ç­†è¨˜è»Ÿé«”æ‡‰è©²éƒ½æœƒæœ‰)
&lt;img src="https://yuanchieh.page/post/2023/img/0401/tag.png"
loading="lazy"
>
å¦å¤–æ¨è–¦ tag çš„ç”¨æ³•ï¼Œæˆ‘æ˜¯åƒè€ƒ &lt;a class="link" href="https://www.playpcesor.com/2021/12/2021evernote-notion-obsidian.html" target="_blank" rel="noopener"
>é›»è…¦ç©ç‰© - 2021è¦†ç›¤ï¼šå¦‚ä½•ç”¨æ¨™ç±¤ç®¡ç†ä¸Šè¬å‰‡ç­†è¨˜ï¼ŸEvernote, Notion, obsidian éƒ½é©ç”¨&lt;/a>ï¼Œtag æ‡‰è©²æ˜¯ä»¥åŠŸèƒ½æ€§ç‚ºå°å‘è€Œéå…§å®¹ï¼Œtodo å°±æ˜¯ä¸€ç¨®åŠŸèƒ½æ€§ï¼Œä»£è¡¨å°šæœªå®Œæˆçš„ä»£æ’äº‹é …&lt;/p>
&lt;p>é™¤äº†æ‰“ä¸Š todo tagï¼Œæˆ‘æœƒå¦å¤–æ¨™è¨˜ä»»å‹™çš„é¡å‹èˆ‡é›£æ˜“åº¦ï¼Œä¸»è¦æ˜¯æˆ‘æœƒå¸Œæœ›å‡è¡¡çš„åŸ·è¡Œï¼Œæˆ‘ä¸å¸Œæœ›æŸå€‹ç¦®æ‹œéƒ½åœ¨é–±è®€è€Œæ²’æœ‰ç”¢å‡ºã€æˆ–æ˜¯éƒ½æŒ‘ç°¡å–®çš„ä»»å‹™è€Œæ²’æœ‰é«˜é›£åº¦çš„ä»»å‹™åŸ·è¡Œ&lt;/p>
&lt;h3 id="å¯¦è¸å¾Œçš„åæ€">å¯¦è¸å¾Œçš„åæ€&lt;/h3>
&lt;blockquote>
&lt;p>ä¸è¦é«˜ä¼°ä¸€å¤©æ‰€èƒ½é”åˆ°çš„æˆå°±ï¼Œä¹Ÿä¸è¦ä½ä¼°ä¸€å¹´æ‰€èƒ½ç´¯ç©çš„æ•ˆæœã€‚&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨å¥—ç”¨ä»»å‹™è¦åŠƒçš„é€™æ®µæ™‚é–“ï¼Œåˆåœ¨é‡æ–°é«”æœƒäº†é€™å¥è©±ï¼Œæˆ‘ç™¼ç¾æˆ‘åœ¨åˆ¶å®šå¹´ã€å­£çš„ç›®æ¨™æ™‚æœƒè¨‚çš„å¤ªå°ï¼Œè€Œåœ¨æœˆã€é€±ã€æ—¥åˆä¼åœ–ä¸€æ¬¡åšåˆ°å¤ªå¤šäº‹ï¼Œå°¤å…¶æ˜¯ä¸€é–‹å§‹æ¯æ—¥ä»»å‹™éƒ½é–‹å¤ªå¤§ï¼Œå°è‡´ä¸æ–·åœ°å»¶æœŸ&lt;/p>
&lt;p>ç›®å‰è©¦è·‘äº†ä¸‰é€±ï¼Œé è¨ˆæœƒèª¿æ•´äº†å¹¾å€‹æ–¹å‘&lt;/p>
&lt;ol>
&lt;li>ç›®æ¨™åŠ ä¸Šé ä¼°æ™‚é–“èˆ‡å¯¦éš›èŠ±è²»æ™‚é–“ï¼Œå»æ”¶æ–‚è‡ªå·±å¯ä»¥å®Œæˆçš„é …ç›®&lt;/li>
&lt;li>ä¿ç•™å½ˆæ€§ï¼Œé™¤äº†å®‰æ’ä¸€æ•´å¤©éƒ½ä¸è¦å·¥ä½œå¤–ï¼Œå†æ’å¦ä¸€å¤©ä¸è¦é å…ˆè¦åŠƒé …ç›®ï¼Œä¿ç•™å½ˆæ€§çµ¦è‡ªå·±æ¶ˆåŒ–å»¶é²çš„é …ç›®&lt;/li>
&lt;li>è‡ªæˆ‘ retroï¼Œå¢åŠ è‡ªå·±å–œæ­¡ / ä¸å–œæ­¡ / æƒ³è¦ / ä¸æƒ³è¦çš„ç’°ç¯€ï¼Œå»æ›´è¿‘ä¸€æ­¥çŸ¥é“è‡ªå·±é©åˆçš„é …ç›®&lt;/li>
&lt;/ol>
&lt;p>ã€Œæ‹‰é«˜è‡ªå·±çš„æ ¼å±€ï¼Œç‚ºè‡ªå·±è¨­å®šé©åˆçš„å¹´åº¦èˆ‡å­£åº¦ç›®æ¨™ã€é€™ä»¶äº‹æˆ‘é‚„åœ¨æ‘¸ç´¢ï¼Œç›®å‰é‚„æ˜¯ä»¥è‡ªå·±ä¸è¶³çš„çŸ¥è­˜æ¼æ´å»åŠ å¼·ç‚ºä¸»ï¼Œå¸Œæœ›é€éæŒçºŒçš„ retro å¯ä»¥æ”¶æ–‚å‡ºé©åˆè‡ªå·±çš„é•·é ç›®æ¨™&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å„ªåŒ–è‡ªå·±çš„ç”Ÿç”¢åŠ›æœƒæ˜¯ä¸€å€‹æŒçºŒçš„éç¨‹ï¼Œã€Šæœ€æœ‰ç”Ÿç”¢åŠ›çš„ä¸€å¹´ã€‹é€™æœ¬æ›¸æˆ‘è¦ºå¾—æä¾›ä¸€å€‹å¾ˆå¥½çš„åŸºåº•ï¼Œå¯ä»¥åœ¨é€™ä¹‹ä¸Šæ‰“é€ å‡ºå±¬æ–¼è‡ªå·±çš„ç”Ÿç”¢åŠ›æµç¨‹ï¼Œæœªä¾†æœƒæŒçºŒçš„å„ªåŒ–ï¼Œæœ‰ä»€éº¼æœ‰è¶£çš„ç™¼ç¾æœƒæŒçºŒçš„è¿­ä»£ï¼Œå¦‚æœæœ‰ä¸åŒçš„åšæ³•æˆ–æ˜¯å·¥å…·çš„æ¨è–¦ï¼Œä¹Ÿæ­¡è¿ç•™è¨€~&lt;/p></description></item><item><title>Rails éƒ¨ç½²å„ªåŒ–: é­”æ”¹ data-migration å¯¦ä½œ post sync æ©Ÿåˆ¶</title><link>https://yuanchieh.page/posts/2023/2023-03-28-rails-%E9%83%A8%E7%BD%B2%E5%84%AA%E5%8C%96-%E9%AD%94%E6%94%B9-data-migration-%E5%AF%A6%E4%BD%9C-post-sync-%E6%A9%9F%E5%88%B6/</link><pubDate>Tue, 28 Mar 2023 02:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-03-28-rails-%E9%83%A8%E7%BD%B2%E5%84%AA%E5%8C%96-%E9%AD%94%E6%94%B9-data-migration-%E5%AF%A6%E4%BD%9C-post-sync-%E6%A9%9F%E5%88%B6/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å…¬å¸ç•¶å‰æ˜¯é€é GitOps ArgoCD é€™å¥—å·¥å…·ä¾†ç®¡ç†æŒçºŒéƒ¨ç½²çš„æµç¨‹ï¼ŒArgoCD æœ‰å€‹æ–¹ä¾¿çš„ hook æ©Ÿåˆ¶ &lt;code>pre sync&lt;/code> å’Œ &lt;code>post sync&lt;/code>ï¼Œå¯ä»¥åœ¨æ©Ÿå™¨éƒ¨ç½²å‰èˆ‡éƒ¨ç½²å¾ŒåŸ·è¡Œå°æ‡‰çš„è…³æœ¬&lt;/p>
&lt;p>åœ¨æˆ‘å€‘åŸæœ¬çš„ Rails éƒ¨ç½²æ©Ÿåˆ¶ï¼Œæœƒæ–¼ pre sync éšæ®µåŸ·è¡Œ&lt;/p>
&lt;ul>
&lt;li>&lt;code>db:migration&lt;/code>ï¼šè² è²¬ DB schema æ”¹å‹•&lt;/li>
&lt;li>&lt;code>data:migration&lt;/code>ï¼š&lt;a class="link" href="https://github.com/ilyakatz/data-migrate" target="_blank" rel="noopener"
>data-migrate&lt;/a> è² è²¬è·‘ä¸€äº› Rails script å›è£œè³‡æ–™ç­‰
é¿å… API server ä¸Šç·šå› ç‚ºæœ‰é«’è³‡æ–™æˆ–éŒ¯èª¤çš„ DB schema è€ŒåŸ·è¡ŒéŒ¯èª¤&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ db/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ data =&amp;gt; data migration at presync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ migrate =&amp;gt; schema change
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†æœ‰æ™‚å€™æˆ‘å€‘æœƒéœ€è¦åœ¨æ©Ÿå™¨éƒ¨ç½²å®Œæˆå¾Œè§¸ç™¼ scriptï¼Œä¾‹å¦‚èªªç•¶æˆ‘å€‘æ–°å¢äº† sidekiq job éœ€è¦è§¸ç™¼æ™‚ï¼Œå¿…é ˆç­‰åˆ° sidekiq server éƒ½æ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬æ‰å¯ä»¥è§¸ç™¼ï¼Œå¦å‰‡æœƒ sidekiq server æœƒèªä¸å¾—æ–°çš„ job&lt;/p>
&lt;p>ç°¡è€Œè¨€ä¹‹ï¼Œæˆ‘å€‘æœƒéœ€è¦åœ¨ pre sync æœ‰ä¸€å¥— data-migrationï¼Œåœ¨ post sync ä¹Ÿéœ€è¦åœ¨ä¸€å¥— data-migrationï¼Œä½†åŒä¸€å¥— data-migration æ˜¯ä¸èƒ½ç›´æ¥ç”¨åœ¨å…©å€‹è§¸ç™¼é»ï¼ŒåŸ·è¡Œæ™‚æœƒç„¡æ³•å€åˆ†å“ªäº› migration script è©²åœ¨ä»€éº¼æ™‚é–“é»è§¸ç™¼&lt;/p>
&lt;p>åŒ–æˆå…·é«”çš„éœ€æ±‚æ˜¯æä¾›ä¸€å¥—åŸºæ–¼ data-migration çš„ post sync è§¸ç™¼æ©Ÿåˆ¶ï¼Œå¸Œæœ›å°è£å‡ºé¡ä¼¼æ–¼ data-migration çš„æ•ˆæœ&lt;/p>
&lt;ol>
&lt;li>é€éæŒ‡ä»¤å¯ä»¥ç°¡å–®ç”¢ç”Ÿ migration script template &lt;code>$ $ bin/rails generate post_sync hello_post_sync&lt;/code>&lt;/li>
&lt;li>åŸ·è¡ŒæŒ‡ä»¤ &lt;code>$ bin/rake post_sync:migrate&lt;/code>&lt;/li>
&lt;li>ç´€éŒ„åœ¨ DB ä¸­é¿å… script åè¦†åŸ·è¡Œ&lt;/li>
&lt;li>ä¸å½±éŸ¿ç¾æœ‰çš„ pre sync æ©Ÿåˆ¶&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ db/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ data =&amp;gt; data migration at presync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ migrate =&amp;gt; schema change
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ post_sync =&amp;gt; data migration at post sync
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸‹å°‡ä»‹ç´¹é€é rails generator ç°¡å–®é­”æ”¹é”åˆ°æˆ‘å€‘è¦çš„æ•ˆæœ&lt;/p>
&lt;h2 id="å¯¦ä½œ">å¯¦ä½œ&lt;/h2>
&lt;h3 id="1-é€é-generator-ç”¢ç”Ÿ-migration-script-template">1. é€é Generator ç”¢ç”Ÿ migration script template&lt;/h3>
&lt;p>é€é &lt;a class="link" href="https://guides.rubyonrails.org/generators.html" target="_blank" rel="noopener"
>Rails Generator&lt;/a> åŸºæ–¼æ¨¡æ¿ç”¢ç”Ÿå°æ‡‰çš„æª”æ¡ˆï¼Œé€é generator ç”¢ç”Ÿ generator &lt;code>$ bin/rails generate generator initializer&lt;/code>&lt;/p>
&lt;p>åœ¨ generator ä¸­å¯ä»¥å®šç¾©ç”¢ç”Ÿæª”æ¡ˆçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å¾ CLI åƒä¸åŒçš„åƒæ•¸&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">InitializerGenerator&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">Rails&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Generators&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">NamedBase&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">source_root&lt;/span> &lt;span class="no">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">expand_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;templates&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__dir__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">copy_initializer_file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">copy_file&lt;/span> &lt;span class="s2">&amp;#34;initializer.rb&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;config/initializers/&lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">.rb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">create_helper_file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">create_file&lt;/span> &lt;span class="s2">&amp;#34;app/helpers/&lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">_helper.rb&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;lt;&amp;lt;-FILE
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">&lt;/span>&lt;span class="n">module&lt;/span> &lt;span class="c1">#{class_name}Helper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">attr_reader&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="c1">#{plural_name}, :#{plural_name.singularize}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">FILE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>file_name æ˜¯å¾ Rails::Generators::NamedBase ç¹¼æ‰¿è€Œä¾†ï¼Œå¾ CLI è®€å–ï¼Œä¾‹å¦‚ &lt;code>$ bin/rails generate initializer core_extensions&lt;/code> file_name å°±æ˜¯ core_extensions&lt;/li>
&lt;li>copy_file è¤‡è£½æª”æ¡ˆ&lt;/li>
&lt;li>create_file ç›´æ¥è¼¸å…¥æª”æ¡ˆå…§å®¹&lt;/li>
&lt;li>å…¶ä»–æ›´å¤šæœ‰è¶£çš„ method &lt;a class="link" href="https://guides.rubyonrails.org/generators.html#generator-methods" target="_blank" rel="noopener"
>10 Generator methods&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="generator-å¯¦ä½œ">Generator å¯¦ä½œ&lt;/h4>
&lt;p>ç›®æ¨™æ˜¯æ‰“é€ ä¸€å€‹é¡ä¼¼ data-migrate çš„ generatorï¼Œå„²å­˜åœ¨ç¨ç«‹çš„ folder ä¸‹ï¼Œä¸¦æœ‰è‘— timestamp çµå°¾çš„æª”æ¡ˆ&lt;/p>
&lt;p>åœ¨é–±è®€ &lt;a class="link" href="https://github.com/ilyakatz/data-migrate/blob/86f10f277deaf9aac4844f12ffea727442690d47/lib/data_migrate/config.rb#L20-L23" target="_blank" rel="noopener"
>data-migrate åŸå§‹ç¢¼æ™‚&lt;/a>ï¼Œçœ‹åˆ°å¯ä»¥é‡å° data_migrations script çš„ folder é€²è¡Œèª¿æ•´&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">@data_migrations_path = &amp;#34;db/data/&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥éˆæ©Ÿä¸€å‹•å°±æƒ³èªªåœ¨ generator ä¸­å¦‚æœå¯ä»¥å‹•æ…‹ç½®æ›ï¼Œä¸¦è§¸ç™¼ data-migrate å°±å¯ä»¥ç”¢ç”Ÿæ–°çš„æª”æ¡ˆåˆ°å°æ‡‰çš„è³‡æ–™å¤¾ä¸‹ï¼Œè€Œä¸æœƒæ±¡æŸ“æ–¼æœ¬çš„ data-migrate&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># lib/generators/post_sync_generator.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="n">post&lt;/span> &lt;span class="n">syncGenerator&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">Rails&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Generators&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">NamedBase&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">copy_initializer_file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">DataMigrate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_migrations_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">POST_SYNC_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Rails&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Generators&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">invoke&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;data_migration&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>data-migrate æœ¬èº«å°±æœ‰æä¾› data_migration çš„ generatorï¼Œè€Œä¸”å¯ä»¥ç›´æ¥åœ¨ generator ä¸­è§¸ç™¼å¦ä¸€å€‹ generatorï¼Œå†åŠ ä¸Š file_name å¯ä»¥å¾ CLI è®€å–ï¼Œé€™æ¨£å°±å¯ä»¥ä¸²èµ·ä¾†&lt;/p>
&lt;p>æˆæœæ˜¯è¼¸å…¥ &lt;code>$ rails generate post_sync xxxx_xxx&lt;/code>ï¼Œæœƒåœ¨æŒ‡å®šçš„è·¯å¾‘ä¸‹ç”¢ç”Ÿ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ rails/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ db/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ data/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”‚ â””â”€â”€ 20210408091311_migration.rb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ post_sync/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ 20210429100009_post_sync.rb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-è¨»å†Š-rake-æŒ‡ä»¤">2. è¨»å†Š Rake æŒ‡ä»¤&lt;/h3>
&lt;p>ç•¶æˆ‘å€‘å¸Œæœ›é€é CLI è§¸ç™¼ç‰¹å®šæŒ‡ä»¤æ™‚ï¼Œå¯ä»¥é€é &lt;a class="link" href="https://github.com/ruby/rake" target="_blank" rel="noopener"
>Rake&lt;/a>ï¼Œè™•ç†ä»»å‹™èˆ‡ä»»å‹™é–“ç›¸ä¾æ€§çš„ gem å¥—ä»¶&lt;/p>
&lt;p>é€™é‚Šçš„ç”¨æ³•ç›¸ç•¶ç°¡å–®ï¼ŒåŒæ¨£å»æ”¹ migrations_pathï¼Œä¸¦è§¸ç™¼åŸæœ¬ data migrate çš„ Rake task å³å¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># lib/tasks/post_sync.rake&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">namespace&lt;/span> &lt;span class="ss">:post_sync&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">task&lt;/span> &lt;span class="ss">:migrate&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">DataMigrate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_migrations_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">POST_SYNC_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Rake&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Task&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;data:migrate&amp;#39;&lt;/span>&lt;span class="o">].&lt;/span>&lt;span class="n">invoke&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-é¿å…-timestamp-collision">3. é¿å… timestamp collision&lt;/h3>
&lt;p>å‰é¢æˆ‘å€‘é€é generator èˆ‡ rake æˆåŠŸç”¢ç”Ÿ migration script template èˆ‡åŸ·è¡Œ post syncï¼Œä¸¦ä¸”åœ¨æª”æ¡ˆè·¯å¾‘ä¸Šèˆ‡åŸæœ¬çš„ data migration åˆ†é–‹&lt;/p>
&lt;p>ä½†ç›®å‰é‚„æœ‰å€‹å•é¡Œæ˜¯æœ€å¾Œ data-migrate ç´€éŒ„ script æ˜¯å¦æ›¾ç¶“è·‘é&lt;code>é‚„æ˜¯åœ¨åŒä¸€å¼µ DB table&lt;/code> ä¸­ï¼Œé€™é‚Šæ²’æœ‰ config å¯ä»¥ç›´æ¥èª¿æ•´&lt;/p>
&lt;p>å¾Œä¾†è·ŸåŒäº‹è¨è«–å¾Œï¼Œæ±ºå®šæ‰‹å¯«ä¸€å€‹æª¢æŸ¥åœ¨ CI åŸ·è¡Œæ™‚ç¢ºèª db/data è·Ÿ db/post_sync ä¸‹çš„ timestamp æ²’æœ‰é‡è¤‡&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="n">post&lt;/span> &lt;span class="n">syncChecker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">CHECK_FOLDER&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">DataMigrate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_migrations_path&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">POST_SYNC_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="nb">self&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">is_collision?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="n">pre&lt;/span> &lt;span class="n">sync_versions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">post&lt;/span> &lt;span class="n">sync_versions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">CHECK_FOLDER&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_migration_versions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="no">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">Rails&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">pre&lt;/span> &lt;span class="n">sync_versions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="n">pre&lt;/span> &lt;span class="n">sync_versions&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">post&lt;/span> &lt;span class="n">sync_versions&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">present?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">list_migration_versions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">path&lt;/span>&lt;span class="p">:)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Dir&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">parse_version&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">filename&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">filename&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="n">compact&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ref: https://github.com/ilyakatz/data-migrate/blob/2dd90c495b4d57e4dc700e3f9be149c7e2b93b57/lib/data_migrate/data_migrator_five.rb#L44&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">parse_version&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">filename&lt;/span>&lt;span class="p">:)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sr">/(\d{14})_(.+)\.rb$/&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">present?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¤¾åœ¨æ¸¬è©¦ä¸­åŸ·è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># spec/unit/lib/post_sync_checker_spec.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s1">&amp;#39;rails_helper&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">describe&lt;/span> &lt;span class="s2">&amp;#34;post syncChecker&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:version&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mi">12345678901234&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:file_paths&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">::&lt;/span>&lt;span class="n">post&lt;/span> &lt;span class="n">syncChecker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">CHECK_FOLDER&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">Rails&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">version&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">_test.rb&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">context&lt;/span> &lt;span class="s2">&amp;#34;when there are two file with same version&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">before&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_paths&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">each&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">file_path&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">File&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">CREAT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">after&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_paths&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">each&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">file_path&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s1">&amp;#39;should failed&amp;#39;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">post&lt;/span> &lt;span class="n">syncChecker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_collision?&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kp">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s2">&amp;#34;check when running test&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">post&lt;/span> &lt;span class="n">syncChecker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_collision?&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kp">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>é€™æ˜¯ä¸€å€‹å°å°çš„å·¥å…·ï¼Œä¸éåœ¨å°æ–¼æ•´å€‹éƒ¨ç½²æµç¨‹æœ‰é‚„ä¸éŒ¯çš„å¹«åŠ©&lt;/p></description></item><item><title>Elasticsearch æ“ä½œï¼š Golang Opensearch SDK ä½¿ç”¨ç­†è¨˜</title><link>https://yuanchieh.page/posts/2023/2023-03-17-elasticsearch-%E6%93%8D%E4%BD%9C-golang-opensearch-sdk-%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/</link><pubDate>Fri, 17 Mar 2023 02:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-03-17-elasticsearch-%E6%93%8D%E4%BD%9C-golang-opensearch-sdk-%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>Elasticsearch æ˜¯å¸¸ç”¨ä¾†åšå…¨æ–‡æœå°‹çš„ NoSQL Databaseï¼Œå…¬å¸åœ¨ä½¿ç”¨ä¸Šæœ‰è‡ªæ¶ä¹Ÿæœ‰ç”¨ AWS Opensearch è¨—ç®¡æœå‹™
è¦ç‰¹åˆ¥ç•™æ„çš„æ˜¯ Opensearch æ˜¯ AWS è‡ªå·± fork ç¶­è­·ï¼Œå…©è€…ä¸å®Œå…¨å…¼å®¹ï¼Œè‡³å°‘åœ¨ &lt;code>client sdk é€£ç·šæ˜¯ä¸å…¼å®¹çš„!&lt;/code> åŸæœ¬ä½¿ç”¨ &lt;a class="link" href="https://github.com/elastic/go-elasticsearch" target="_blank" rel="noopener"
>Golang Elasticsearch å®˜æ–¹ SDK v7.17&lt;/a> è¦é€£ç·š Opensearch å›ç›´æ¥æ‹‹éŒ¯&lt;/p>
&lt;blockquote>
&lt;p>error: the client noticed that the server is not a supported distribution of Elasticsearch&lt;/p>
&lt;/blockquote>
&lt;p>ä¸€äº›ç›¸é—œçš„æ–‡ç«  &lt;a class="link" href="https://towardsaws.com/elasticsearch-the-server-is-not-a-supported-distribution-of-elasticsearch-252abc1bd92" target="_blank" rel="noopener"
>[Elasticsearch] The Server Is Not A Supported Distribution Of Elasticsearch&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Since the AWS Elasticsearch Service has incompatible APIs with Elasticsearch itself, either by missing APIs or has incompatible format, we do not support it.&lt;/p>
&lt;/blockquote>
&lt;p>Beef æ‡‰è©²å¯ä»¥å¾€å‰è¿½æº¯å¹¾å¹´å‰ Elasticsearch è¦ºå¾— AWS åœ¨ç™½å«–é–‹æºç¤¾ç¾¤é€²è€Œæ›´æ”¹æˆæ¬Šï¼Œä½¿å¾— AWS æ±ºå®šè‡ªå·±ç¶­è­· Opensearch (æ–°è &lt;a class="link" href="https://www.ithome.com.tw/news/143812" target="_blank" rel="noopener"
>AWSåˆ†å‰Elasticsearché‡æ–°å‘½åç‚ºOpenSearch&lt;/a>)&lt;/p>
&lt;p>ä½†æœ‰è¶£çš„æ˜¯æˆ‘æ¸¬è©¦äº†ä¸€äº›å ´æ™¯ï¼ŒAWS Opensearch client SDK å¯ä»¥é€£ç·š Elasticsearch (ä»¥ä¸‹ç°¡ç¨± ES) èˆ‡ Opensearch serverï¼Œæ‰€ä»¥ä»¥ä¸‹å°±ç”¨ &lt;a class="link" href="https://github.com/opensearch-project/opensearch-go" target="_blank" rel="noopener"
>Opensearch cliend SDK&lt;/a> æ“ä½œ ESï¼Œå¾ŒçºŒä¸æœƒé‡å° ES æœ¬èº«æœ‰å¤ªå¤šä»‹ç´¹ï¼Œå¯ä»¥åƒè€ƒä¹‹å‰çš„å¹¾ç¯‡æ–‡ç«  &lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-07-15-elasticsearch-%E6%95%99%E5%AD%B8-api-%E6%93%8D%E4%BD%9C/" target="_blank" rel="noopener"
>Elasticsearch æ•™å­¸ - API æ“ä½œ&lt;/a> å’Œ &lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-07-08-elasticsearch-%E7%B3%BB%E7%B5%B1%E4%BB%8B%E7%B4%B9%E8%88%87%E8%A9%95%E4%BC%B0/" target="_blank" rel="noopener"
>Elasticsearch ç³»çµ±ä»‹ç´¹èˆ‡è©•ä¼°&lt;/a>&lt;/p>
&lt;h2 id="client-sdk-ä½¿ç”¨">Client SDK ä½¿ç”¨&lt;/h2>
&lt;p>ä»¥ä¸‹ä½¿ç”¨æœƒè¦†è“‹å¹¾å€‹å ´æ™¯&lt;/p>
&lt;ol>
&lt;li>å»ºç«‹ Client é€£ç·š&lt;/li>
&lt;li>å»ºç«‹ Index&lt;/li>
&lt;li>æ’å…¥ Document&lt;/li>
&lt;li>æœå°‹ Document&lt;/li>
&lt;li>å»ºç«‹ Mapping&lt;/li>
&lt;li>åˆªé™¤ Index&lt;/li>
&lt;/ol>
&lt;p>å®Œæ•´åŸå§‹ç¢¼åƒè€ƒ &lt;a class="link" href="https://github.com/sj82516/elasticsearch-golang" target="_blank" rel="noopener"
>https://github.com/sj82516/elasticsearch-golang&lt;/a>ï¼Œæˆ–æ˜¯åƒè€ƒ &lt;a class="link" href="https://opensearch.org/docs/latest/clients/go/" target="_blank" rel="noopener"
>Opensearch å®˜æ–¹æ–‡ä»¶&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// connect to elasticsearch
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">opensearch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opensearch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Addresses&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;http://localhost:9200&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// create index
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indices&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// create document
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">createThenSearch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// refresh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indices&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Refresh&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">createThenSearch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// create document
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">createDocument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">`{&amp;#34;key&amp;#34;: &amp;#34;key1&amp;#34;, &amp;#34;title&amp;#34;:&amp;#34;Test my first document&amp;#34;, &amp;#34;number&amp;#34;: 5}`&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">createDocument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">`{&amp;#34;key&amp;#34;: &amp;#34;key1.child&amp;#34;, &amp;#34;title&amp;#34;:&amp;#34;Test my first document&amp;#34;, &amp;#34;number&amp;#34;: 5}`&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// refresh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indices&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Refresh&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// search document by text field
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;document&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;search by title:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">r&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;key1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;search by key:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">r&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;child&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;search by key:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">createDocument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">document&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IndexRequest&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Index&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Body&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">document&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">searchResponse&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Hits&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Value&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;value&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="s">`json:&amp;#34;total&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Hits&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Score&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;_score&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Source&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Key&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;key&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Title&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;title&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Number&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;number&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="s">`json:&amp;#34;_source&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="s">`json:&amp;#34;hits&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="s">`json:&amp;#34;hits&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">searchResponse&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;match&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">body&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Marshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">searchReq&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SearchRequest&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Index&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Body&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">body&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">searchReq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="nx">searchResponse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDecoder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šæ˜¯å¤§è‡´çš„ API æ“ä½œï¼Œå‘¼å«èµ·ä¾†ä¸å¤ªéº»ç…©ï¼Œåªæ˜¯æ–‡ä»¶æœ‰é»ç°¡é™‹éœ€è¦ä¸åœçš„æŸ¥æ‰¾ï¼Œå»ºè­°å¯ä»¥é–‹è‘— Kibana çš„å¾Œå°å°æ‡‰æŸ¥è©¢èˆ‡å›æ‡‰ï¼Œæœ‰ hint è »æ–¹ä¾¿çš„
&lt;img src="https://yuanchieh.page/post/2023/img/0319/kibana.png"
loading="lazy"
>&lt;/p>
&lt;p>æœ‰å…©å€‹åœ°æ–¹éœ€è¦ç‰¹åˆ¥ç•™æ„&lt;/p>
&lt;ol>
&lt;li>å¦‚æœæ˜¯æœ¬åœ°ç«¯æ¸¬è©¦ï¼Œè¨˜å¾—åœ¨ create document å¾Œ &lt;code>client.Indices.Refresh()&lt;/code> å¼·åˆ¶ refresh indexï¼Œå› ç‚º ES æ”¶åˆ°å»ºç«‹è«‹æ±‚å¾Œéœ€è¦ä¸€æ®µæ™‚é–“è™•ç†æ‰èƒ½å¤ æŸ¥è©¢ï¼Œæ‰€ä»¥è¦å¼·åˆ¶ refresh æ‰èƒ½ç›´æ¥æŸ¥!&lt;/li>
&lt;li>é è¨­ ES çš„ string è¼¸å…¥éƒ½æœƒæ˜¯ &lt;code>text å‹åˆ¥&lt;/code>ï¼Œè€Œ text å‹åˆ¥æœƒç¶“é tokenize ã€analyzer åŠ å·¥å¾Œæ”¯æ´&lt;code>å…¨æ–‡æœå°‹&lt;/code>ï¼Œé€™å…¶ä¸­çš„è™•ç†åŒ…å«äº†å»é™¤å†—è©è´…å­—ã€æ–·è©ç­‰ç­‰ï¼›&lt;br>
æ‰€ä»¥åƒæ˜¯æˆ‘åŸæœ¬é æœŸ &lt;code>key&lt;/code> é€™å€‹æ¬„ä½æ˜¯å®Œå…¨åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯æŸ¥è©¢æ™‚è¦å®Œæ•´çš„å‘½ä¸­ï¼Œä½†å› ç‚ºé è¨­æ˜¯å…¨æ–‡æœå°‹ï¼Œæ‰€ä»¥æœƒæŠŠæ²’æœ‰å®Œå…¨åŒ¹é…çš„çµæœä¹Ÿå›å‚³ï¼Œå¦‚åœ–ä¸‹æˆ‘æŸ¥è©¢ &amp;ldquo;key&amp;rdquo;=&amp;ldquo;key1&amp;rdquo;ï¼Œçµæœé€£ &amp;ldquo;key1.child&amp;rdquo; éƒ½å›å‚³äº†
&lt;img src="https://yuanchieh.page/post/2023/img/0319/search_text.png"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœè¦è§£æ±ºé€™å€‹å•é¡Œçš„è©±ï¼Œéœ€è¦åœ¨ Index å»ºç«‹å¾Œå¢åŠ  Mappingï¼ŒMapping æ˜¯æŒ‡å®š Index æ¯å€‹æ¬„ä½çš„è™•ç†æ–¹å¼ï¼Œå¯ä»¥åˆ‡æ›ä¸åŒçš„å‹åˆ¥ã€æŒ‡å®šæ˜¯å¦è¦è¢« indexing ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">createMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mapping&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">`{&amp;#34;properties&amp;#34;:{&amp;#34;key&amp;#34;:{&amp;#34;type&amp;#34;:&amp;#34;keyword&amp;#34;}}}`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indices&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">opensearchapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IndicesPutMappingRequest&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Index&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Body&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mapping&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">res&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€è¦ç‰¹åˆ¥ç•™æ„ Mapping å¿…é ˆè¦åœ¨ Index ç‚ºç©ºçš„æƒ…æ³ä¸‹æ‰èƒ½ç”Ÿæ•ˆï¼Œå¦‚æœå·²ç¶“æœ‰ document å°±ä¸è¡Œï¼Œéœ€è¦é‡æ–°å»ºç«‹&lt;/p>
&lt;p>ä»¥ä¸‹æŸ¥è©¢ &amp;ldquo;key&amp;rdquo;=&amp;ldquo;key1&amp;rdquo; æˆåŠŸå›å‚³ä¸€ç­†è³‡æ–™
&lt;img src="https://yuanchieh.page/post/2023/img/0319/search_keyword.png"
loading="lazy"
>&lt;/p></description></item><item><title>ç ”ç©¶å¾®æœå‹™ä¸‹çš„æˆæ¬Šè¨­è¨ˆ - Google Zanzibar èˆ‡ Open Policy Agent</title><link>https://yuanchieh.page/posts/2023/2023-01-28-%E7%A0%94%E7%A9%B6%E5%BE%AE%E6%9C%8D%E5%8B%99%E4%B8%8B%E7%9A%84%E6%8E%88%E6%AC%8A%E8%A8%AD%E8%A8%88-google-zanzibar-%E8%88%87-open-policy-agent/</link><pubDate>Sat, 28 Jan 2023 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-01-28-%E7%A0%94%E7%A9%B6%E5%BE%AE%E6%9C%8D%E5%8B%99%E4%B8%8B%E7%9A%84%E6%8E%88%E6%AC%8A%E8%A8%AD%E8%A8%88-google-zanzibar-%E8%88%87-open-policy-agent/</guid><description>&lt;p>ä¸Šä¸€ç¯‡ &lt;a class="link" href="https://yuanchieh.page/posts/2023/2023-01-20-%E9%A9%97%E8%AD%89%E8%88%87%E6%8E%88%E6%AC%8A%E7%9A%84%E5%B7%AE%E5%88%A5%E6%B7%BA%E8%AB%87-oauth-2.0-%E8%88%87-openid-connect/" target="_blank" rel="noopener"
>é©—è­‰èˆ‡æˆæ¬Šçš„å·®åˆ¥ï¼Œæ·ºè«‡ OAuth 2.0 èˆ‡ OpenID Connect&lt;/a> æ·ºè«‡åˆ° OAuth 2.0 èˆ‡ OIDC çš„å·®ç•°ï¼Œæˆ‘å€‘æ˜¯ä»¥ Client çš„è§’åº¦å»ç†è§£å¦‚æœåƒç¬¬ä¸‰æ–¹å–å¾—é©—è­‰èˆ‡æˆæ¬Šï¼Œä½†å¦‚æœä»Šå¤©æˆ‘å€‘è¦ Google ä¸€æ¨£è‡ªå·±è™•ç†æˆæ¬Šçš„è¨­è¨ˆï¼Œæ€è€ƒçš„æ–¹å¼å°±æœƒæœ‰æ‰€ä¸åŒ&lt;/p>
&lt;p>åƒè€ƒä»¥ä¸‹çš„æ–‡ç« ï¼Œåˆ†äº«é€™å¹¾å¤©ç ”ç©¶å¾®æœå‹™ä¸‹è©²å¦‚ä½•è¨­è¨ˆé©—è­‰çš„æ©Ÿåˆ¶&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.osohq.com/post/microservices-authorization-patterns" target="_blank" rel="noopener"
>Best Practices for Authorization in Microservices&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://research.google/pubs/pub48190/" target="_blank" rel="noopener"
>Zanzibar: Googleâ€™s Consistent, Global Authorization System&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://youtu.be/R6tUNpRpdnY" target="_blank" rel="noopener"
>How Netflix Is Solving Authorization Across Their Cloud [I] - Manish Mehta &amp;amp; Torin Sandall, Netflix&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.openpolicyagent.org/" target="_blank" rel="noopener"
>Open Policy Agent&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>çœ‹åˆ°ç¶²è·¯ä¸Šæœ‰æ™‚æœƒç¸®å¯« (Authentication -&amp;gt; &lt;code>AuthN&lt;/code> / Authorization -&amp;gt; &lt;code>AuthZ&lt;/code>)ï¼Œä»¥ä¸‹ä¹Ÿæœƒç”¨æ­¤ç¸®å¯«&lt;/p>
&lt;h2 id="ä¸€-æ‰€è¬‚çš„æˆæ¬Šé©—è­‰-authorization">ä¸€. æ‰€è¬‚çš„æˆæ¬Šé©—è­‰ Authorization&lt;/h2>
&lt;p>å…·é«”ä¾†èªªï¼Œæˆæ¬Šè¨­å®šä¸»è¦æ˜¯åˆ¤æ–·&lt;/p>
&lt;blockquote>
&lt;p>{æŸäºº} æ˜¯å¦å¯ä»¥é‡å° {æŸè³‡æº} åŸ·è¡Œ {æŸæ“ä½œ}&lt;/p>
&lt;/blockquote>
&lt;p>ç¾ä»Šæœ‰ä¸‰ç¨®ä¸»æµç®¡ç†æˆæ¬Šçš„æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>RBAC&lt;/li>
&lt;li>ABAC&lt;/li>
&lt;li>ReBAC&lt;/li>
&lt;/ol>
&lt;h4 id="1-rbac">1. RBAC&lt;/h4>
&lt;p>åˆ¶å®š Role ä¸¦ç¶å®šå°æ‡‰çš„æ¬Šé™ï¼Œä¾‹å¦‚ AWS IAMï¼Œæ¡ˆä¾‹å¦‚ â€œå¦‚æœç”¨æˆ¶æ˜¯ Admin æ¬Šé™æ‰å¯ä»¥ç€è¦½æ­¤é é¢â€œ&lt;br>
ä½†æ˜¯æ¬Šé™å°±ç›´æ¥ç¶æ­» Roleï¼Œå¦‚æœåŒå€‹ Role ä¸‹çªç„¶æƒ³è¦åœ¨æ‹†åˆ†æ›´ç´°çš„æ§åˆ¶ï¼Œå°±è¦å¢åŠ æ–°çš„ Role&lt;/p>
&lt;h4 id="2-abac">2. ABAC&lt;/h4>
&lt;p>é€é Attribute ç¶å®šå°æ‡‰çš„æ¬Šé™ï¼Œä¾‹å¦‚ â€œå¦‚æœç”¨æˆ¶æ˜¯ 10 æœˆä»¥å‰è¨»å†Šï¼Œå¯ä»¥äº«æœ‰ xxx å„ªæƒ â€œï¼ŒAttribute åˆ¶å®šç›¸å°å°±å½ˆæ€§è¨±å¤šï¼Œ&lt;a class="link" href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/introduction_attribute-based-access-control.html" target="_blank" rel="noopener"
>AWS IAM ä¹Ÿå¯ä»¥ç”¨ ABAC è¨­å®š&lt;/a>&lt;/p>
&lt;h4 id="3-rebac">3. ReBAC&lt;/h4>
&lt;p>ç•¶è§’è‰²æˆ–è³‡æºæ˜¯æœ‰å±¤ç‹€çš„ç¹¼æ‰¿é—œä¿‚æ™‚ï¼Œå¯ä»¥é€éæè¿° Relation æ–¹å¼ä¾†åˆ¶å®šæ¬Šé™ï¼Œä¾‹å¦‚ â€œGroup A åŒ…å« Group Bï¼Œå°æ˜æ˜¯ Group B æˆå“¡ï¼ŒæŸå€‹æª”æ¡ˆæ˜¯ Group A æ‰€æœ‰æˆå“¡éƒ½å¯ä»¥è®€å–ï¼Œå‰‡å°æ˜ä¹Ÿæ‡‰è©²è¦å¯ä»¥è®€å–â€œ&lt;/p>
&lt;h2 id="äºŒ-å¾®æœå‹™ä¸‹çš„é©—è­‰æ¶æ§‹">äºŒ. å¾®æœå‹™ä¸‹çš„é©—è­‰æ¶æ§‹&lt;/h2>
&lt;p>åœ¨ monolithic æ¶æ§‹ä¸‹ï¼Œå› ç‚º DB éƒ½åœ¨ä¸€å¡Šï¼Œæ‰€ä»¥ authorization å¯ä»¥ç›´æ¥ query æª¢æŸ¥å³å¯ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¦‚æœç”¨æˆ¶æ˜¯ admin &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_admin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="sr">//&lt;/span> &lt;span class="n">xxxx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¦‚æœç”¨æˆ¶æ˜¯è³‡æºæ“æœ‰è€…&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">id&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">document&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">onwer_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="sr">//&lt;/span> &lt;span class="n">xxxx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é©—è­‰è®Šæˆæ˜¯å•†æ¥­é‚è¼¯çš„ä¸€éƒ¨åˆ†&lt;/p>
&lt;p>ä½†å¦‚æœä»Šå¤©æ˜¯åœ¨ microservice æƒ…æ³ä¸‹ï¼Œè©²å¦‚ä½•åˆ¤æ–·ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™å¯ä»¥æ“ä½œå‘¢ï¼Ÿ å¤§è‡´æœ‰ä»¥ä¸‹ä¸‰ç¨®æ–¹æ³•&lt;/p>
&lt;h3 id="1-å°‡è³‡æ–™æ”¾åœ¨åŸä½é€é-api-å‘¼å«">1. å°‡è³‡æ–™æ”¾åœ¨åŸä½ï¼Œé€é API å‘¼å«&lt;/h3>
&lt;p>å‡è¨­ä»Šå¤©ç¨ç«‹ä¸€å€‹ document serviceï¼Œæ¯å€‹ document éš¸å±¬æ–¼æŸå€‹çµ„ç¹” org ä¸‹ï¼Œè€Œ org ç®¡ç†æ˜¯å±¬æ–¼ user service çš„ç¯„ç–‡
å‰‡ user service å¯ä»¥é–‹ä¸€æ¢ API å°ˆé–€æŸ¥è©¢ user æ‰€éš¸å±¬çš„ org
&lt;img src="https://yuanchieh.page/post/2023/img/0128/service_api.png"
loading="lazy"
>
é€™æ˜¯æœ€ç°¡å–®ä¸”æœ‰æ•ˆçš„æ–¹å¼ï¼Œä½†å¦‚æœæœå‹™è¶Šè®Šè¶Šå¤šï¼Œå‰‡æœƒæœ‰å¹¾å€‹å•é¡Œ&lt;/p>
&lt;ul>
&lt;li>æœå‹™é–“åˆ¤ç«¯å¯èƒ½æœ‰é‡è¤‡å‘¼å« (ä¾‹å¦‚ document å¾€ä¸Šå¤šä¸€å±¤ folderï¼Œè®Šæˆè¦åˆ¤æ–· user æ˜¯å¦æœ‰æ¬Šé™æ“ä½œ document èˆ‡ folder)&lt;/li>
&lt;li>API å‘¼å«æœƒæœ‰å»¶é²&lt;/li>
&lt;li>å¦‚æœé©—è­‰æ–¹å¼æ”¹è®Šï¼Œå¤šå€‹ service ä¹Ÿè¦è·Ÿè‘—æ”¹å‹• (ä¾‹å¦‚ service A / service B éƒ½æ˜¯ç”¨ org é©—è­‰ï¼Œä½†ä¹‹å¾Œçªç„¶è®Šæˆè¦ç”¨ user æœ¬èº«é©—è­‰)&lt;/li>
&lt;/ul>
&lt;h3 id="2-åœ¨-gateway-æ³¨å…¥æˆæ¬Šé©—è­‰æ‰€éœ€çš„è³‡æ–™">2. åœ¨ Gateway æ³¨å…¥æˆæ¬Šé©—è­‰æ‰€éœ€çš„è³‡æ–™&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0128/gateway.png"
loading="lazy"
>
æ—¢ç„¶æœå‹™éƒ½éœ€è¦ user org é€™å€‹è³‡è¨Šï¼Œé‚£æˆ‘å€‘åœ¨ request è¿‘ä¾†æ™‚å°±é€é gateway æŠŠ user è³‡è¨Šå¡å¥½å¡æ»¿ï¼Œå¥½è™•æœ‰&lt;/p>
&lt;ul>
&lt;li>æ¸›å°‘å¤šé¤˜ requestï¼Œæ‰€æœ‰ä¸‹æ¸¸çš„ service éƒ½èƒ½è®€å–åˆ° user org åƒæ•¸&lt;/li>
&lt;li>å¦‚æœæˆæ¬Šçš„åƒæ•¸å¾ˆæœ‰é™ï¼Œä¾‹å¦‚åªæœ‰åˆ‡åˆ†å¹¾ç¨® roleï¼Œé‚£ gateway æœƒæ˜¯æœ€æ–¹ä¾¿çš„&lt;/li>
&lt;/ul>
&lt;p>ç¼ºé»æ˜¯ Gateway æœƒéœ€è¦çŸ¥é“æ‰€æœ‰ service éœ€è¦çš„è³‡æ–™ï¼Œå¦‚æœä»Šå¤©é©—è­‰æ–¹å¼æ”¹è®Š Gateway ä¹Ÿè¦è·Ÿè‘—æ”¹è®Š&lt;/p>
&lt;h3 id="3-ç¨ç«‹çš„æˆæ¬Šé©—è­‰æœå‹™">3. ç¨ç«‹çš„æˆæ¬Šé©—è­‰æœå‹™&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0128/authz_service.png"
loading="lazy"
>
æœ‰ä¸€å€‹ç¨ç«‹çš„ AuthZ serviceï¼Œå…¶ä»– service æ”¶åˆ° request éƒ½ç›´æ¥å‘ AuthZ service é©—è­‰æˆæ¬Šï¼Œå°‡&lt;code>é©—è­‰èˆ‡å•†æ¥­é‚è¼¯æ‹†é–‹ä¸¦é›†ä¸­ç®¡ç†æˆæ¬Šé‚è¼¯&lt;/code>&lt;br>
ç‰¹åˆ¥é©ç”¨æ–¼å¾®æœå‹™çœ¾å¤šä¸”éœ€è¦äº’ç›¸æºé€šçš„æƒ…æ³ / æœ‰ç¬¬ä¸‰æ–¹å» å•†è¦åˆ†äº«è³‡æ–™æ™‚ï¼Œä¾‹å¦‚ Google / Airbnb / Netflix&lt;/p>
&lt;p>ç¼ºé»æ˜¯&lt;/p>
&lt;ul>
&lt;li>AuthZ service èˆ‡å…¶é¤˜ Service çš„å…§å®¹è€¦åˆï¼Œå› ç‚º AuthZ service ä¸¦é ˆçŸ¥é“æ‰€æœ‰çš„ resourceï¼Œæ‰èƒ½å°æ‡‰è¨­å®šæ¬Šé™ï¼Œä¾‹å¦‚ document / folder ç­‰&lt;/li>
&lt;li>å¤šä¸€çµ„æœå‹™è¦ç¶­è­·&lt;/li>
&lt;/ul>
&lt;p>å¤§éƒ¨åˆ†çš„å…¬å¸æ‡‰è©²éƒ½ä¸éœ€è¦å¦‚æ­¤è¤‡é›œï¼Œé€šå¸¸ä¹Ÿæ²’æœ‰ç¨ç«‹çš„åœ˜éšŠåœ¨ç¶­è­·é©—è­‰æˆæ¬Šï¼Œä½†å¯ä»¥å€Ÿé¡ Google è¨­è¨ˆçš„ Zanzibar èˆ‡ CNCF çš„é–‹æºå°ˆæ¡ˆ Open Policy Agent (OPA) ä¾†çœ‹å¤§å‹è»Ÿé«”æ¡ç”¨çš„æˆæ¬Šæª¢æŸ¥æ–¹æ³•&lt;/p>
&lt;h2 id="ä¸‰-google-ä¸­å¿ƒåŒ–-authz-æœå‹™---zanzibar">ä¸‰. Google ä¸­å¿ƒåŒ– AuthZ æœå‹™ - Zanzibar&lt;/h2>
&lt;p>Zanzibar æ˜¯ä¸­å¿ƒåŒ–çš„ AuthZ æœå‹™ï¼Œæä¾›çµ±ä¸€çš„ data model èˆ‡ config language (æè¿° ReBAC çš„è¦å‰‡)ï¼Œä»–æœ‰ä»¥ä¸‹çš„è¡¨ç¾&lt;/p>
&lt;ul>
&lt;li>æ•ˆèƒ½ï¼šå»¶é² p95 &amp;lt; 10ms&lt;/li>
&lt;li>è¦æ¨¡ï¼šæ•¸åå„„çš„è¦å‰‡ / æ¯ç§’ç™¾è¬ç­‰ç´š requestï¼Œå›Šæ‹¬ Calendar, Cloud, Drive, Maps, Doc ç­‰&lt;/li>
&lt;li>å¯ç”¨æ€§ï¼š99.999%&lt;/li>
&lt;/ul>
&lt;p>å¯¦éš›è¨­å®šå¯èƒ½åƒä»¥ä¸‹åœ–ç¤º (é google å®˜æ–¹ï¼Œåƒè€ƒè‡ª &lt;a class="link" href="https://zanzibar.academy/" target="_blank" rel="noopener"
>zanzibar.academy&lt;/a>)
&lt;img src="https://yuanchieh.page/post/2023/img/0128/demo.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="ç‚ºä»€éº¼éœ€è¦ä¸­å¿ƒåŒ–çš„-authz-æœå‹™">ç‚ºä»€éº¼éœ€è¦ä¸­å¿ƒåŒ–çš„ AuthZ æœå‹™&lt;/h3>
&lt;ol>
&lt;li>æä¾›çµ±ä¸€çš„èªæ„å’Œç”¨æˆ¶é«”é©—&lt;/li>
&lt;li>ç•¶å¤šå€‹æ‡‰ç”¨ç¨‹å¼äº’äº¤ç›¸éŒ¯æ™‚ï¼Œæ›´å®¹æ˜“å¯¦ä½œ&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ä¾‹å¦‚ç™¼é€ Gmail æ™‚æœƒå¹«ä½ æª¢æŸ¥é™„ä»¶ä¸­çš„ Google Doc æ”¶ä»¶äººæ˜¯å¦æœ‰æ¬Šé™è®€å–&lt;/p>
&lt;/blockquote>
&lt;h3 id="tuple-æè¿°ç‰©ä»¶èˆ‡ç‰©ä»¶çš„é—œä¿‚æˆ–ç‰©ä»¶èˆ‡ç”¨æˆ¶çš„é—œä¿‚">Tuple: æè¿°ã€Œç‰©ä»¶èˆ‡ç‰©ä»¶çš„é—œä¿‚ã€æˆ–ã€Œç‰©ä»¶èˆ‡ç”¨æˆ¶çš„é—œä¿‚ã€&lt;/h3>
&lt;p>Zanzinbar æœ‰è‡ªå·±ä¸€å¥—æè¿°è¦å‰‡çš„èªè¨€ï¼Œæ¯æ¢è¦å‰‡ç¨±ç‚ºä¸€å€‹ tupleï¼Œå¯ä»¥æè¿°&lt;/p>
&lt;ol>
&lt;li>user U has relation R to object O&lt;/li>
&lt;li>set of users S has relation R to object O&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹æ˜¯è«–æ–‡çš„æ¡ˆä¾‹&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>doc:readme#owner@10&lt;/code> User 10 is an owner of doc:readme &lt;br>
&lt;code>group:eng#member@11&lt;/code> User 11 is a member of group:eng&lt;br>
&lt;code>doc:readme#viewer@group:eng#member&lt;/code> Members of group:eng are viewers of doc:readme&lt;br>
&lt;code>doc:readme#parent@folder:A#...&lt;/code> doc:readme is in folder:A&lt;/p>
&lt;/blockquote>
&lt;p>å¾ŒçºŒ Client å°±å¯ä»¥é€é check API æŒ‡å®š user + operation + object è«‹æ±‚é©—è­‰&lt;/p>
&lt;h3 id="ä¸€äº›å¯¦ä½œçš„å›°é›£èˆ‡å…‹æœæ–¹å¼">ä¸€äº›å¯¦ä½œçš„å›°é›£èˆ‡å…‹æœæ–¹å¼&lt;/h3>
&lt;p>é€šç¯‡è«–æ–‡ä¸»è¦åœ¨è¬›è¨­è¨ˆ Zanzibar çš„æŒ‘æˆ°ï¼Œå› ç‚ºé©—è­‰æœå‹™éœ€è¦æ»¿è¶³&lt;/p>
&lt;ul>
&lt;li>Flexibility è®“å¤šç¨®æœå‹™éƒ½èƒ½è¨­è¨ˆè‡ªå·±çš„é©—è­‰è¦å‰‡&lt;/li>
&lt;li>Correctness é©—è­‰æ˜¯æ ¸å¿ƒçš„ç”¨æˆ¶éš±ç§ä¿è­·æ‰€ä»¥åˆ¤æ–·çµæœä¸€å®šè¦æ­£ç¢º&lt;/li>
&lt;li>Low Latency å› ç‚ºå¤§å¤šæ•¸çš„ Request éƒ½éœ€è¦é©—è­‰&lt;/li>
&lt;li>Scale å› ç‚º Request æœƒéå¸¸é »ç¹ (è«‹æ±‚æ¯ç§’ç™¾è¬ä¸”æ©«è·¨æ•´å€‹åœ°çƒ)&lt;/li>
&lt;li>High Availability å› ç‚ºæ¯å€‹æœå‹™éƒ½æœƒä¾è³´é©—è­‰æœå‹™&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸‹æå¹¾é»æ¯”è¼ƒæœ‰è¶£çš„å›°é›£èˆ‡å…‹æœæ–¹å¼&lt;/p>
&lt;h4 id="1-è¨­å®šçš„æœ€çµ‚ä¸€è‡´æ€§">1. è¨­å®šçš„æœ€çµ‚ä¸€è‡´æ€§&lt;/h4>
&lt;p>ç•¶ ACL (Access Control List) ç™¼ç”Ÿæ”¹è®Šæ™‚ï¼Œæ“ä½œçš„é †åºå¿…é ˆåš´æ ¼éµå®ˆï¼Œå¦å‰‡æœƒä¸å°å¿ƒæŠŠèˆŠçš„ ACL å¥—ç”¨åˆ°æ–°çš„ç‰©ä»¶ä¸Š / èˆŠ ACL å½±éŸ¿åˆ°æ–°çš„å…§å®¹ (åŒç‰©ä»¶)ï¼Œå¦å‰‡æœƒæœ‰ä»¥ä¸‹éŒ¯èª¤&lt;/p>
&lt;ul>
&lt;li>ex1. Alice ç§»é™¤ Bob æ¬Šé™ (1)ï¼Œæ­¤æ™‚æ–°å¢ç‰©ä»¶ O (2) ç¹¼æ‰¿ä¸Šå±¤æ¬Šé™ï¼Œå‰‡ Bob ä¸æ‡‰è©²æ“æœ‰ O çš„æ¬Šé™ (3)
&lt;ul>
&lt;li>å¦‚æœ 2 æ¯” 1 å…ˆå¥—ç”¨ï¼Œå‰‡ Bob å°±ä¸å°å¿ƒæœ‰äº† O çš„æ¬Šé™ (2 &amp;gt; 1)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ex2. Alice ç§»é™¤ Bob æ¬Šé™ (1)ï¼Œæ­¤æ™‚ç‰©ä»¶ O æ–°å¢å…§å®¹ (2)ï¼Œå‰‡ Bob ä¸æ‡‰è©²çœ‹åˆ°æ–°çš„å…§å®¹ (3)
&lt;ul>
&lt;li>å¦‚æœ 2 æ¯” 1 å…ˆå¥—ç”¨ï¼Œä¸” Bob åœ¨ 1 ä¹‹å‰è®€å–åˆ°æ–°çš„å…§å®¹ (å¥—ç”¨é †åºï¼š2 &amp;gt; 3 &amp;gt; 1)ï¼Œä½†ç†è«–ä¸Šä»–ä¸æ‡‰è©²çœ‹åˆ°æ–°çš„å…§å®¹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸Šå•é¡Œç¨±ç‚º &lt;code>new enemy problem&lt;/code>ï¼ŒZanzibar é€é external consistency èˆ‡ snapshot reads with bounded staleness è§£æ±ºæ­¤å•é¡Œ&lt;/p>
&lt;ul>
&lt;li>external consistency&lt;br>
ç•¶æ“ä½œ Tx åœ¨æ“ä½œ Ty ä¹‹å‰ï¼Œå‰‡ç•¶ T æ™‚çœ‹åˆ° Ty ç”Ÿæ•ˆæ™‚ï¼Œå‰‡ Tx å¿…å®šç”Ÿæ•ˆï¼ŒZanzibar æ˜¯é€é Google Spanner å„²å­˜ï¼Œä»°è³´ data storage çš„ç‰¹æ€§ä¿è­‰&lt;/li>
&lt;li>snapshot reads with bounded staleness&lt;br>
ç•¶ç‰©ä»¶æ›´æ–°æ™‚ (ex2-2)ï¼Œç•¶ä¸‹ç‰ˆæœ¬æœƒå°æ‡‰ä¸€å€‹ç¨±ç‚º zookie token ä¸¦è¨˜éŒ„ç•¶ä¸‹çš„æ™‚é–“ï¼›ä¹‹å¾Œ client request éƒ½å¿…é ˆå¸¶ä¸Š zookieï¼Œåªè¦è®€å–çš„æ™‚å€™æ¯”å° zookie æ™‚é–“å°æ–¼ç­‰æ–¼å„²å­˜å±¤æ›´æ–°çš„æ™‚é–“ (ex2-3)ï¼Œå‰‡ä»£è¡¨æ›´æ–°å…ˆå‰çš„ ACL (ex2-1)éƒ½å·²ç¶“è¢«å¥—ç”¨&lt;/li>
&lt;/ul>
&lt;h4 id="2-leopard-indexing">2. Leopard Indexing&lt;/h4>
&lt;p>å› ç‚ºæ¬Šé™åˆ¤å®šå¯èƒ½æ˜¯åµŒå¥—å¾ˆå¤šå±¤ (Group A åŒ…å« Group B åŒ…å« Group C &amp;hellip;.)ï¼Œé€™æ¨£åœ¨åˆ¤æ–·ä¸Šæœƒæœ‰éœ€è¦ traverse å¾ˆå¤šç¯€é» (åœ–å­¸å•é¡Œ)ï¼ŒZanzibar è¨­è¨ˆ Leopard Indexingï¼Œå°‡ group å±¤ç´šæ”¤å¹³ä¸¦å„²å­˜åœ¨ memory ä¸­ï¼Œé€™æ¨£é™ä½äº†æœå°‹çš„è¤‡é›œåº¦&lt;/p>
&lt;h4 id="3-æŠŠè¼ƒæ…¢çš„è«‹æ±‚ç™¼çµ¦ä¸åŒçš„-server-request-hedging">3. æŠŠè¼ƒæ…¢çš„è«‹æ±‚ç™¼çµ¦ä¸åŒçš„ server (Request Hedging)&lt;/h4>
&lt;p>Zanzibar æœƒæœ‰ä¸€å€‹é–¥å€¼ï¼Œç•¶ç™¼ç¾è«‹æ±‚æ¯”è¼ƒæ…¢æ™‚ï¼Œæœƒç™¼é€çµ¦å…¶ä»–å›æ‡‰é€Ÿåº¦æ¯”è¼ƒå¿«çš„ serverï¼Œå„ªåŒ–ç‰¹åˆ¥æ…¢çš„è«‹æ±‚ (é€šå¸¸ä¹Ÿä»£è¡¨ç‰¹åˆ¥è¤‡é›œ)&lt;/p>
&lt;hr>
&lt;p>å…¶ä»–é‚„åŒ…å«ä¸€äº› Cache è¨­è¨ˆ / æ•´é«”æ¶æ§‹ / å°å¤–é–‹æ”¾ API ç­‰ï¼Œé€™é‚Šå°±å…ˆä¸è´…è¿°ï¼Œä¾†çœ‹ä¸€ä¸‹ç¬¬ä¸‰æ–¹æä¾›çš„ Zanzibar like é›²ç«¯æœå‹™ï¼Œéƒ¨è½æ ¼è·Ÿæ•™å­¸å¯«å¾—éƒ½å¾ˆå¥½&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://authzed.com/" target="_blank" rel="noopener"
>authzed-A managed permissions database for everyone&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://auth0.com/blog/auth0-fine-grained-authorization-developer-community-preview-release" target="_blank" rel="noopener"
>auth0&lt;/a>ï¼Œé‚„åœ¨ preview éšæ®µï¼Œä½†ä»–å€‘çš„æ•™å­¸ä¸éŒ¯&lt;/li>
&lt;li>&lt;a class="link" href="https://www.osohq.com/" target="_blank" rel="noopener"
>oso&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="å››-é‡å°-cloud-native-çš„-solution---open-policy-agent">å››. é‡å° cloud native çš„ solution - Open Policy Agent&lt;/h2>
&lt;p>ç•¶æˆ‘å€‘æŠŠç›®å…‰å¾æ‡‰ç”¨ç¨‹å¼ç§»é–‹ï¼Œæ•´å€‹ç³»çµ±æ¶æ§‹è™•è™•éƒ½éœ€è¦é©—è­‰çš„æœå‹™&lt;/p>
&lt;ul>
&lt;li>æŸå€‹ç¶²åŸŸçš„æµé‡æ˜¯å¦å¯ä»¥é€²ä¾† / å‡ºå»&lt;/li>
&lt;li>æŸå°æ©Ÿå™¨é–‹ç™¼è€…æ˜¯ä¸æ˜¯å¯ä»¥ ssh&lt;/li>
&lt;li>DB æ˜¯ä¸æ˜¯å¯ä»¥è¢«ç¬¬ä¸‰æ–¹å» å•† access&lt;/li>
&lt;/ul>
&lt;p>Open Policy Agent (ç°¡ç¨± OPA) é‡å° cloud native æ¶æ§‹è¨­è¨ˆé©—è­‰è¦å‰‡çš„è§£æ³•ï¼Œ&lt;code>ä¸­å¿ƒåŒ–ç®¡ç†é©—è­‰è¦å‰‡èˆ‡å…¶ä»–é‚è¼¯è§£è€¦ï¼Œæ•´å€‹æ¶æ§‹çµ±ä¸€ä¸€å¥—é©—è­‰è¦å‰‡èªè¨€&lt;/code>ï¼Œæ”¯æ´ Kubernetes / Envoy / Terraform (æ±ºå®šç”¨æˆ¶æ˜¯å¦èƒ½ç”¨ tf èª¿æ•´æŸç¨®è³‡æº) / Kafka ç­‰ï¼Œä¹Ÿé–‹æ”¾ HTTP API æ‰€ä»¥æ‡‰ç”¨ç¨‹å¼å±¤ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¦å¤–ä¹Ÿæœ‰æä¾› Golang Libary èˆ‡ WASM å¯ä»¥æ•´åˆ&lt;/p>
&lt;p>æµç¨‹å¤§æ¦‚æ˜¯
&lt;img src="https://yuanchieh.page/post/2023/img/0128/opa-service.svg"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>Client ç™¼å‡ºè«‹æ±‚&lt;/li>
&lt;li>OPA agent æ ¹æ“šè«‹æ±‚æ‰¾åˆ°å°æ‡‰çš„ policy (ç”¨ rego èªè¨€æ’°å¯«)ï¼Œçµåˆ data åˆ¤æ–· client æ˜¯å¦æœ‰è¶³å¤ æ¬Šé™&lt;/li>
&lt;/ol>
&lt;p>å¯¦éš›çš„ policy åˆ¶å®šå¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">package&lt;/span> &lt;span class="n">httpapi&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">authz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># bob is alice&amp;#39;s manager, and betty is charlie&amp;#39;s.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">subordinates&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;alice&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[],&lt;/span> &lt;span class="s2">&amp;#34;charlie&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[],&lt;/span> &lt;span class="s2">&amp;#34;bob&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;alice&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="s2">&amp;#34;betty&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;charlie&amp;#34;&lt;/span>&lt;span class="p">]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">default&lt;/span> &lt;span class="n">allow&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="n">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Allow users to get their own salaries.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">allow&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;finance&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;salary&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Allow managers to get their subordinates&amp;#39; salaries.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">allow&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">some&lt;/span> &lt;span class="n">username&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;finance&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;salary&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">subordinates&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">_&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">username&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è«‹æ±‚é¡ä¼¼æ–¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-py" data-lang="py">&lt;span class="line">&lt;span class="cl">&lt;span class="n">input_dict&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1"># create input to hand to OPA&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;input&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;user&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">http_api_user&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">http_api_path_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># Ex: [&amp;#34;finance&amp;#34;, &amp;#34;salary&amp;#34;, &amp;#34;alice&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="c1"># HTTP verb, e.g. GET, POST, PUT, ...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ask OPA for a policy decision&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (in reality OPA URL would be constructed from environment)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rsp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">requests&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://127.0.0.1:8181/v1/data/httpapi/authz&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">json&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">input_dict&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">rsp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="s2">&amp;#34;allow&amp;#34;&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>data éƒ¨ä»½ä¸ä¸€å®šè¦å¯«æ­»ï¼Œè€Œæ˜¯å¯ä»¥å¾å¤–éƒ¨çš„ DB æ’ˆå–æˆ–æ˜¯æ“·å– request ä¸­çš„ jwt tokenï¼Œåƒè€ƒ &lt;a class="link" href="https://www.openpolicyagent.org/docs/latest/external-data/" target="_blank" rel="noopener"
>External Data&lt;/a>ï¼Œç®—æ˜¯è »æœ‰å½ˆæ€§çš„&lt;/p>
&lt;p>ä»¥ä¸Šçš„æ©Ÿåˆ¶æ˜¯è½åˆ° Netflix çš„åˆ†äº« &lt;a class="link" href="https://www.youtube.com/watch?v=R6tUNpRpdnY&amp;amp;list=WL&amp;amp;index=18" target="_blank" rel="noopener"
>How Netflix Is Solving Authorization Across Their Cloud [I] - Manish Mehta &amp;amp; Torin Sandall, Netflix&lt;/a>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>é©—è­‰æ¯”æˆ‘æƒ³åƒä¸­çš„è¤‡é›œè¨±å¤šï¼ŒGoogle è¨­è¨ˆäº† Zanzibar / Netflix éƒ¨åˆ†æ¡ç”¨çš„ Open Policy Agent æ©Ÿåˆ¶ï¼Œå‰è€…é‡å°è² è²¬çš„å·¢ç‹€è¦å‰‡èˆ‡æ¥µå¤§è¦æ¨¡çš„é©—è­‰éœ€æ±‚ã€å¾Œè€…å‰‡é‡å° Cloud Native ç’°å¢ƒçµ±ä¸€äº†æ¶æ§‹å±¤çš„é©—è­‰è¦å‰‡&lt;/p></description></item><item><title>é©—è­‰èˆ‡æˆæ¬Šçš„å·®åˆ¥ï¼Œæ·ºè«‡ OAuth 2.0 èˆ‡ OpenID Connect</title><link>https://yuanchieh.page/posts/2023/2023-01-20-%E9%A9%97%E8%AD%89%E8%88%87%E6%8E%88%E6%AC%8A%E7%9A%84%E5%B7%AE%E5%88%A5%E6%B7%BA%E8%AB%87-oauth-2.0-%E8%88%87-openid-connect/</link><pubDate>Fri, 20 Jan 2023 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2023/2023-01-20-%E9%A9%97%E8%AD%89%E8%88%87%E6%8E%88%E6%AC%8A%E7%9A%84%E5%B7%AE%E5%88%A5%E6%B7%BA%E8%AB%87-oauth-2.0-%E8%88%87-openid-connect/</guid><description>&lt;p>é©—è­‰ - ç¢ºèªä½¿ç”¨è€…èº«ä»½ã€æˆæ¬Š - å…è¨±æŸäººé‡å°æŸäº›è³‡æºæ“ä½œæŸäº›è¡Œç‚ºï¼Œå…©è€…åœ¨å°æ–¼è‡ªå»ºç¶²ç«™å¯èƒ½æ˜¯ç­‰åŒä¸€ä»¶äº‹ï¼Œç•¶æˆ‘è®“ user A ç™»å…¥é€šéé©—è­‰ï¼Œé‚£ä¹Ÿå°±ç­‰åŒæˆæ¬Š user A å¯ä»¥æ“ä½œä»–è‡ªå·±çš„è³‡æº&lt;/p>
&lt;p>ä½†ä»Šå¤©å¦‚æœé©—è­‰çš„æœå‹™ã€ç®¡ç†è³‡æºçš„æœå‹™ã€ä»£æ›¿ç”¨æˆ¶æ“ä½œè³‡æºçš„ç¬¬ä¸‰æ–¹æœå‹™éƒ½æ˜¯ç¨ç«‹æ™‚ï¼Œé©—è­‰èˆ‡æˆæ¬Šå°±æœ‰å¾ˆå¤§çš„å€åˆ¥ï¼Œä»¥ä¸‹å…§å®¹èˆ‡æˆªåœ–åƒè€ƒè‡ª&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=996OiexHze0&amp;amp;t=77s" target="_blank" rel="noopener"
>OAuth 2.0 and OpenID Connect (in plain English)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=M4JIvUIE17c" target="_blank" rel="noopener"
>ID Tokens vs Access Tokens - Do you know the difference?!&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="é—œæ–¼ç™»å…¥èˆ‡-oauth-20">é—œæ–¼ç™»å…¥èˆ‡ OAuth 2.0&lt;/h2>
&lt;p>æœ€é™½æ˜¥çš„ç™»å…¥æ©Ÿåˆ¶è«éæ–¼ client æä¾› account / password çµ¦ serverï¼Œserver é€²å»è³‡æ–™åº«æ¯”å°ï¼ŒæˆåŠŸå‰‡è¨­å®š cookie or session
&lt;img src="https://yuanchieh.page/post/2023/img/0120/simple_login.png"
loading="lazy"
>&lt;/p>
&lt;p>é€™æ¨£çš„æŠ€è¡“æœ‰å¹¾å€‹ç¼ºé»&lt;/p>
&lt;ol>
&lt;li>å®‰å…¨æ€§ï¼šå¦‚æœç”¨æˆ¶å¤šå€‹ç¶²ç«™éƒ½ç”¨ç›¸åŒçš„å¸³å¯†ï¼Œå‰‡ä¸€å€‹ç¶²ç«™è¢«æ”»ç ´å‰‡æ¯å€‹ç¶²ç«™éƒ½å¯èƒ½é­æ®ƒ&lt;/li>
&lt;li>ç¶­è­·æ€§ï¼šæ¯å€‹ç¶²ç«™éƒ½éœ€è¦ç¶­è­·ç”¨æˆ¶çš„è³‡æ–™&lt;/li>
&lt;/ol>
&lt;p>ç¬¬äºŒå€‹å•é¡Œæ˜¯å¦‚æœæŸæœå‹™å¸Œæœ›ä»£æ›¿ç”¨æˆ¶æ“ä½œå¦ä¸€å€‹æœå‹™ (Delegated authorization)ï¼Œå¦‚æœé€éå¸³å¯†éå¸¸å±éšªï¼Œä¹Ÿæ²’æœ‰æ¬Šé™çš„é™åˆ¶ï¼Œä¾‹å¦‚ Yelp æ›¾ç¶“è·Ÿç”¨æˆ¶è¦å¸³å¯†å»ç™»å…¥ Email
&lt;img src="https://yuanchieh.page/post/2023/img/0120/old_oauth.png"
loading="lazy"
>&lt;/p>
&lt;p>OAuth 2.0 ä¹Ÿå°±æ˜¯åœ¨é€™æ¨£çš„æ™‚ç©ºèƒŒæ™¯èª•ç”Ÿ&lt;/p>
&lt;h3 id="oauth-20-ç°¡å–®ä»‹ç´¹">OAuth 2.0 ç°¡å–®ä»‹ç´¹&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0120/access-token-scenario.png"
loading="lazy"
>
Authorization server èˆ‡ Resource server æœ‰ä¸€å¥—é©—è­‰èˆ‡æˆæ¬Šç¯„åœç®¡ç†çš„æ©Ÿåˆ¶ï¼ŒClient app å–å¾— Resource Owner (user æœ¬äºº) çš„æˆæ¬Šå¾Œï¼Œå°±å¯ç”¨ Access token ä»£ç‚ºå‘ Resource server ç™¼èµ·æ“ä½œ&lt;/p>
&lt;p>ä¸»è¦æœ‰å››ç¨®æµç¨‹&lt;/p>
&lt;ol>
&lt;li>Authorization Code flow&lt;/li>
&lt;li>implicit flow&lt;/li>
&lt;li>account / password flow&lt;/li>
&lt;li>client credential flow&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹åƒ…ä»‹ç´¹ç¬¬ä¸€ç¨®&lt;/p>
&lt;h4 id="authorization-code-flow">Authorization Code flow&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0120/code_flow.png"
loading="lazy"
>
åŸºæœ¬æµç¨‹ç‚º&lt;/p>
&lt;ol>
&lt;li>User é€é Client App æŒ‡å®šè¦é€éç¬¬ä¸‰æ–¹ç™»å…¥&lt;/li>
&lt;li>ç¬¬ä¸‰æ–¹ Auth Server é¡¯ç¤ºæˆæ¬Šé é¢&lt;/li>
&lt;li>User åŒæ„æˆæ¬Šå¾Œï¼ŒAuth Server å¤¾å¸¶ code è½‰å°åˆ° Client App&lt;/li>
&lt;li>Client App é€é code + client å°ˆå±¬è³‡è¨Šå‘ Auth Server æ› access token&lt;/li>
&lt;li>Client App æ‹¿åˆ° access tokenï¼Œå°±å¯ä»¥å‘ Resource Server ç™¼èµ·æ“ä½œ&lt;/li>
&lt;/ol>
&lt;p>ç‰¹åˆ¥æ³¨æ„åˆ° channel çš„æ¦‚å¿µï¼Œé€™é‚Šåˆ†æˆ&lt;/p>
&lt;ul>
&lt;li>front channel&lt;/li>
&lt;li>back channel&lt;/li>
&lt;/ul>
&lt;p>front channel æŒ‡çš„æ˜¯åœ¨å‰ç«¯ï¼Œå› ç‚ºé€™éƒ¨åˆ†çš„æµç¨‹æš´éœ²åœ¨å®¢æˆ¶ç«¯ï¼Œå®‰å…¨æ€§ç›¸å°è¼ƒä½ï¼Œä¾‹å¦‚ç€è¦½å™¨æ’ä»¶çš„å´éŒ„ç­‰ï¼›
back channel æŒ‡çš„æ˜¯å¾Œç«¯ï¼Œå› ç‚º server æ˜¯åœ¨æˆ‘å€‘æŒæ§æ‰€ä»¥å®‰å…¨æ€§ç›¸å°é«˜&lt;/p>
&lt;p>æ‰€ä»¥ä»»ä½•æ±è¥¿å¾ front channel è½‰åˆ° back channel éƒ½éœ€è¦å†æ¬¡é©—è­‰ï¼Œä¾‹å¦‚ front å›å‚³ codeï¼Œæ­¤æ™‚ code å¿…é ˆåœ¨ back channel è·Ÿ Authorization server æ› access token&lt;/p>
&lt;p>å¦‚æœ front channel ç›´æ¥å›å‚³ access tokenï¼Œå‰‡æœ‰å¯èƒ½è¢«æ›¿æ›çš„é¢¨éšª&lt;/p>
&lt;h2 id="oauth-20-èˆ‡-openid-connect">OAuth 2.0 èˆ‡ OpenID Connect&lt;/h2>
&lt;p>åœ¨ä¸€é–‹å§‹æˆ‘å€‘éƒ½æœƒç”¨ OAuth 2.0 é©—è­‰èˆ‡æˆæ¬Šä¸€ä¸¦è™•ç†ï¼Œä¾‹å¦‚ &lt;a class="link" href="https://developers.google.com/identity/protocols/oauth2/scopes#oauth2" target="_blank" rel="noopener"
>Google OAuth 2.0 å¯ä»¥æŒ‡å®š Scope&lt;/a> &lt;code>https://www.googleapis.com/auth/userinfo.profile &lt;/code>ï¼Œä½†éš¨è‘—é©—è­‰çš„éœ€æ±‚è¶Šä¾†è¶Šæ˜ç¢ºï¼ŒåŒ…å«æ‰‹æ©Ÿé©—è­‰ç™»å…¥ç­‰ï¼Œæ‰€ä»¥å°±åˆåŸºæ–¼ OAuth 2.0 æ“´å±•æ¨å‡ºäº† OpenID Connect&lt;/p>
&lt;h3 id="openid-connect">OpenID Connect&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0120/id-token-scenario.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>User é€é Client App æŒ‡å®šè¦é€éç¬¬ä¸‰æ–¹ç™»å…¥&lt;/li>
&lt;li>ç¬¬ä¸‰æ–¹ Auth Server é¡¯ç¤ºæˆæ¬Šé é¢&lt;/li>
&lt;li>User åŒæ„æˆæ¬Šå¾Œï¼ŒAuth Server å¤¾å¸¶ id token å›åˆ° Client App&lt;/li>
&lt;li>Client App é©—è­‰ id token å¾Œå°±å¯ä»¥æ‹¿åˆ°ç”¨æˆ¶åŸºæœ¬è³‡æ–™&lt;/li>
&lt;li>å¦‚æœ‰é¡å¤–éœ€è¦ï¼ŒClient App å¯ä»¥ç”¨ id token å‘¼å« Auth Server API (/userinfo å¦‚ Google &lt;code>https://openidconnect.googleapis.com/v1/userinfo&lt;/code>ã€ Line &lt;code>https://api.line.me/oauth2/v2.1/userinfo&lt;/code>) æ‹¿é¡å¤–çš„ç”¨æˆ¶è³‡è¨Š&lt;/li>
&lt;/ol>
&lt;p>ä¹çœ‹ä¹‹ä¸‹ OpenID Connect è·Ÿ OAuth 2.0 æµç¨‹å¾ˆåƒï¼Œä½†æœ‰å€‹æœ€å·¨å¤§çš„å·®ç•°&lt;/p>
&lt;blockquote>
&lt;p>OpenID Connect æ‹¿åˆ°çš„ id token å¯ä»¥ç›´æ¥è§£æä¸¦è®€å–ç”¨æˆ¶è³‡è¨Šï¼›
è€Œ OAuth 2.0 æ‹¿åˆ°çš„ access token ä¸¦ä¸æ˜¯ Client App è¦è§£è®€ï¼Œè€Œæ˜¯å–®ç´”é€çµ¦ Resource Server é©—è­‰&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥å¾é©—è­‰è§’åº¦ï¼ŒServer é€é OpenID Connect å¯ä»¥ç›´æ¥è§£æ id tokenï¼Œè€Œä¸ç”¨å¤šæ‰“ä¸€æ¬¡ Api å»è¦ç”¨æˆ¶çš„è³‡æ–™&lt;/p>
&lt;p>æ‰€ä»¥ &lt;code>OpenID Connect æœ‰æ˜æ–‡è¦å®š token å¿…é ˆæ˜¯ jwt æ ¼å¼&lt;/code>ï¼ŒClient App æ”¶åˆ°å¾Œè¦æ‹¿ Auth Server public key æª¢æŸ¥æ ¸ç™¼å–®ä½æ˜¯å¦æ­£ç¢º (æ•¸ä½ç°½ç« çš„æ¦‚å¿µ)&lt;br>
è€Œ &lt;code>OAuth 2.0 ç”¨çš„ access token ä¸ä¸€å®šè¦æ˜¯ jwtï¼Œä»»æ„çš„ string éƒ½å¯ä»¥ï¼Œåªè¦ Auth Server è·Ÿ Resource Server èªå¾—å°±å¥½&lt;/code>&lt;/p>
&lt;h3 id="ç‚ºä»€éº¼ä¸æ‹¿-id-token-ç•¶ä½œ-access-token">ç‚ºä»€éº¼ä¸æ‹¿ id token ç•¶ä½œ access token&lt;/h3>
&lt;ol>
&lt;li>OAuth 2.0 æœ‰è¦ç¯„ sender contraintï¼Œé™å®š client å¯ä»¥ç™¼é€ access tokenï¼Œå¦‚æœæœ‰å¯¦ä½œé‚£å³ä½¿ token è¢« hacker å·èµ°ä¹Ÿæ²’é—œä¿‚ï¼Œå› ç‚ºç™¼é€åˆ° Resource server æœƒè¢«æ“‹ä¸‹ä¾†&lt;/li>
&lt;li>Access Token æœ‰æ›´å¤šçš„æª¢æŸ¥ï¼ŒåŒ…å« scope (ID token æ²’æœ‰) / Aud / token format validation&lt;/li>
&lt;/ol>
&lt;h3 id="ç‚ºä»€éº¼ä¸æ‹¿-access-token-ç•¶ä½œ-id-token">ç‚ºä»€éº¼ä¸æ‹¿ access token ç•¶ä½œ id token&lt;/h3>
&lt;ol>
&lt;li>access token ä¸æ˜¯è¦çµ¦ client è§£æï¼Œè€Œæ˜¯çµ¦ resource serverï¼Œclient æœ€å¥½æŠŠ access token ç•¶ä½œä»»æ„å­—ä¸²&lt;/li>
&lt;li>ä¸¦æ²’æœ‰çµ±ä¸€æ¨™æº–å–å¾—ç”¨æˆ¶è³‡è¨Š&lt;/li>
&lt;/ol>
&lt;h2 id="ä½¿ç”¨-jwt-çš„ä¸€äº›è³‡å®‰è€ƒé‡">ä½¿ç”¨ JWT çš„ä¸€äº›è³‡å®‰è€ƒé‡&lt;/h2>
&lt;p>å› ç‚º Token æ˜¯æ¡ç”¨ JWTï¼Œåœ¨æ ¸ç™¼èˆ‡é©—è­‰ä¸Šè¦ç‰¹åˆ¥æ³¨æ„ï¼Œå¦å‰‡æœƒæœ‰è³‡å®‰ä¸Šçš„æ¼æ´&lt;/p>
&lt;h4 id="1-å‹™å¿…æª¢æŸ¥-iss--aud--exp-ç­‰åŸºæœ¬è¨Šæ¯">1. å‹™å¿…æª¢æŸ¥ iss / aud / exp ç­‰åŸºæœ¬è¨Šæ¯&lt;/h4>
&lt;p>&lt;a class="link" href="https://www.rfc-editor.org/rfc/rfc7519#section-4" target="_blank" rel="noopener"
>RFC 7591&lt;/a> ä¸­çš„ payload ä¿ç•™å­—æ®µé€šå¸¸éƒ½æ˜¯éœ€è¦é©—è­‰çš„ï¼ŒåŒ…å«&lt;/p>
&lt;ul>
&lt;li>iss (issuer)ï¼šèª°æ ¸ç™¼çš„ token&lt;/li>
&lt;li>aud (audience)ï¼šèª°æ‡‰è©²æ”¶åˆ°æ­¤ token&lt;/li>
&lt;li>sub (subject)ï¼štoken æ ¸ç™¼çš„ç›®çš„&lt;/li>
&lt;li>exp (expiration)ï¼štoken ä½•æ™‚éæœŸ&lt;/li>
&lt;li>nbf (Not Before)ï¼štoken ä½•æ™‚é–‹å§‹ç”Ÿæ•ˆ&lt;/li>
&lt;li>iat (issued at)ï¼štoken æ ¸ç™¼çš„æ™‚é–“&lt;/li>
&lt;li>jti (JWT id)ï¼šjwt IDï¼Œåªæœ‰åœ¨å¯èƒ½ç™¼ç”Ÿç¢°æ’æ‰éœ€è¦&lt;/li>
&lt;/ul>
&lt;h4 id="2-å‹™å¿…ç§»é™¤-alg-none-æ”¯æ´">2. å‹™å¿…ç§»é™¤ alg: none æ”¯æ´&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0120/algo_none_atk.png"
loading="lazy"
>
JWT çš„åˆæ³•æ€§éœ€è¦é€é signature å»é©—è­‰ï¼Œè€Œ Hacker å¯èƒ½æŒ‡å®š alg: &amp;ldquo;none&amp;rdquo; è·³éé©—è­‰ï¼Œå¦‚æœå¯¦ä½œæ²’å¯«å¥½å°±æœƒçœŸçš„è¢«è·³éï¼›
&lt;a class="link" href="https://github.com/jwt/ruby-jwt/blob/d795d5fc6e6893542df3cbf484fe8be3b3ffac78/lib/jwt/decode.rb#L54" target="_blank" rel="noopener"
>çœ‹äº†ä¸€ä¸‹ Ruby å¯¦ä½œæ²’æœ‰é€™å€‹å•é¡Œï¼Œæœƒå»æª¢æŸ¥ alg æœ‰æ²’æœ‰åœ¨æŒ‡å®šçš„ç¯„åœå…§&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">valid_alg_in_header?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">allowed_algorithms&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">any?&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">alg&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">alg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">valid_alg?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">alg_in_header&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3-å°å¿ƒ-alg-è¢«èª¿æ•´">3. å°å¿ƒ alg è¢«èª¿æ•´&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/2023/img/0120/replace_atk.png"
loading="lazy"
>
åŒæ¨£æ˜¯ alg è¢«èª¿æ•´ï¼Œå¦‚æœå¾éå°ç¨±åŠ å¯†è¢«æ”¹æˆå°ç¨±åŠ å¯†ï¼Œå¯¦ä½œä¸æ°ç•¶å¯èƒ½å°±æœƒè¢«ç¹éï¼Œè¨˜å¾—è¦åˆ†æ¸…æ¥šéå°ç¨±åŠ å¯†çš„ key èˆ‡å°ç¨±åŠ å¯†çš„ key&lt;/p>
&lt;h2 id="single-sign-on-sso-èˆ‡-oauth-20--openid-connect-é—œä¿‚">Single Sign On (SSO) èˆ‡ OAuth 2.0 / OpenID Connect é—œä¿‚&lt;/h2>
&lt;p>æˆ‘å€‘å¸¸æœƒçœ‹åˆ° SSO èˆ‡ OAuth 2.0 / OIDC å‡ºç¾ï¼ŒSSO ä¸»è¦æ˜¯æè¿°ä¸€ç¨®æ¦‚å¿µï¼Œç”¨æˆ¶åªéœ€è¦ä¸€çµ„å¸³å¯†ç™»å…¥é©—è­‰æ©Ÿæ§‹ï¼Œå¤šå€‹æœå‹™éƒ½ç”¨æ­¤é©—è­‰æ©Ÿæ§‹é©—æ˜èº«ä»½&lt;/p>
&lt;blockquote>
&lt;p>authentication method that enables users to securely authenticate with multiple applications and websites by using just one set of credentials.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ OAuth 2.0 / OpenID Connect éƒ½æ˜¯ SSO çš„ä¸€ç¨®å¯¦ä½œï¼Œå…¶ä»–å¸¸è¦‹åšæ³•åŒ…å« SAML / LDAP ç­‰&lt;/p>
&lt;p>åƒè€ƒè‡ª &lt;a class="link" href="https://www.onelogin.com/learn/how-single-sign-on-works" target="_blank" rel="noopener"
>How Does Single Sign-On Work?&lt;/a>&lt;/p></description></item><item><title>é–‹ç™¼ç°¡æ˜“çš„ Protobuf plugin</title><link>https://yuanchieh.page/posts/2022/2022-11-26-%E9%96%8B%E7%99%BC%E7%B0%A1%E6%98%93%E7%9A%84-protobuf-plugin/</link><pubDate>Sat, 26 Nov 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-11-26-%E9%96%8B%E7%99%BC%E7%B0%A1%E6%98%93%E7%9A%84-protobuf-plugin/</guid><description>&lt;p>æœ€è¿‘å·¥ä½œé‡å¿ƒè½‰å¾€ Golang èˆ‡ gRPC server é–‹ç™¼ï¼Œæœ€è®“æˆ‘æ„Ÿåˆ°ç¥å¥‡çš„æ˜¯é€é proto å®£å‘Šä¸­çš„ optionsï¼Œæ­é…ä¸åŒçš„ protobuf plugin å¯ä»¥ gen å‡ºå°æ‡‰çš„æª”æ¡ˆï¼ŒåŒ…å« &lt;a class="link" href="https://github.com/solo-io/protoc-gen-openapi" target="_blank" rel="noopener"
>OpenAPI Doc&lt;/a> / &lt;a class="link" href="https://grpc.io/docs/languages/go/quickstart/" target="_blank" rel="noopener"
>ä¸åŒç¨‹å¼ç¢¼èªè¨€å¯¦ä½œçš„ gRPC server&lt;/a> / &lt;a class="link" href="https://pkg.go.dev/github.com/sourcegraph/prototools/cmd/protoc-gen-json" target="_blank" rel="noopener"
>JSON æª”&lt;/a>ï¼Œä¸ç¦è®“æˆ‘å¥½å¥‡é€™äº›ç¥ç§˜çš„ Protobuf options èˆ‡èƒŒå¾Œç”¢ç”Ÿæª”æ¡ˆçš„ Protobuf plugin åˆ°åº•æ˜¯æ€éº¼é‹ä½œ ?!&lt;/p>
&lt;p>ä»¥ä¸‹æ–‡ç« å°‡æœƒé€éä¸€å€‹ç°¡å–®æ¡ˆä¾‹ - protoc-gen-http-client åˆ©ç”¨ proto ç”¢ç”Ÿå°æ‡‰ Golang http client request çš„ç¨‹å¼ç¢¼ï¼Œæœƒæ¶µè“‹&lt;/p>
&lt;ol>
&lt;li>protobuf èˆ‡ plugin çš„äº’å‹•æ©Ÿåˆ¶&lt;/li>
&lt;li>å¦‚ä½•å¾ command è®€å–åˆ° plugin è¨­å®š&lt;/li>
&lt;li>å¦‚ä½•è¨­è¨ˆ protobuf extension&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹å…§å®¹ä¸»è¦åƒè€ƒè‡ª&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://rotemtam.com/2021/03/22/creating-a-protoc-plugin-to-gen-go-code/" target="_blank" rel="noopener"
>Creating a protoc plugin to generate Go code with protogen&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="1-protobuf-èˆ‡-plugin-çš„äº’å‹•æ©Ÿåˆ¶">1. Protobuf èˆ‡ plugin çš„äº’å‹•æ©Ÿåˆ¶&lt;/h2>
&lt;h3 id="prerequisite">prerequisite&lt;/h3>
&lt;p>é¦–å…ˆæˆ‘å€‘è¦å®‰è£ protoc ä»¥åŠ protoc-gen-go&lt;/p>
&lt;ul>
&lt;li>å®‰è£ protoc &lt;a class="link" href="https://grpc.io/docs/protoc-installation/" target="_blank" rel="noopener"
>https://grpc.io/docs/protoc-installation/&lt;/a>&lt;/li>
&lt;li>å®‰è£ protoc-gen-go æ–¹ä¾¿é–‹ç™¼ plugin &lt;a class="link" href="https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen#GeneratedFile" target="_blank" rel="noopener"
>https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen#GeneratedFile&lt;/a>
&lt;ul>
&lt;li>&lt;code>$ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å‰è€…æ˜¯ protobuf çš„ compilerï¼Œå¾Œè€…æ˜¯ protobuf golang plugin è² è²¬å¾ protobuf ç”¢å‡ºå°æ‡‰çš„ golang code&lt;br>
ç¢ºä¿ terminal å¯ä»¥åŸ·è¡Œ $ protoc / $ protoc-gen-go&lt;/p>
&lt;h3 id="äº’å‹•æ©Ÿåˆ¶">äº’å‹•æ©Ÿåˆ¶&lt;/h3>
&lt;p>ä¸€èˆ¬æˆ‘å€‘åœ¨ä½¿ç”¨ protoc ç”¢ç”Ÿæª”æ¡ˆæŒ‡ä»¤æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>$ protoc &amp;ndash;go_out=paths=source_relative:. &amp;ndash;proto_path=. example/proto/*.proto&lt;/p>
&lt;/blockquote>
&lt;p>æŒ‡å®š protoc å»è¼‰å…¥å‘¼å«å°æ‡‰çš„ plugin ï¼Œplugin å¿…é ˆæ˜¯&lt;/p>
&lt;ol>
&lt;li>shell å¯ä»¥åŸ·è¡Œçš„ binary file&lt;/li>
&lt;li>å‘½åæ ¼å¼å›ºå®šæ˜¯ &lt;code>proto-gen-${plugin name}&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>protoc æŒ‡ä»¤æœ‰å¹¾å€‹åƒæ•¸&lt;/p>
&lt;ol>
&lt;li>&lt;code>${plugin name}_out&lt;/code> è§£æè¦åŸ·è¡Œçš„ pluginï¼Œå¦‚é€é --go_out æŒ‡å®šäº† proto-gen-go çš„åŸ·è¡Œï¼Œä¸¦æŒ‡å®šè¼¸å‡ºçš„è³‡æ–™å¤¾ä½ç½®&lt;/li>
&lt;li>&lt;code>${plugin name}_opt&lt;/code> plugin åƒæ•¸&lt;/li>
&lt;li>&lt;code>--proto-path=&lt;/code> æŒ‡å®š input proto çš„è³‡æ–™å¤¾ä½ç½®&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœ plugin name æœ‰å¤šå€‹å­—æ¯ï¼Œå¯ä»¥ç”¨ &lt;code>-&lt;/code> åˆ†éš”å¦‚ protoc-gen-grpc-gateway å¦‚æ­¤å‘½å&lt;/p>
&lt;h3 id="å»ºç«‹å°ˆæ¡ˆ-protoc-gen-http-client">å»ºç«‹å°ˆæ¡ˆ protoc-gen-http-client&lt;/h3>
&lt;p>åƒè€ƒç¨‹å¼ç¢¼ï¼š&lt;a class="link" href="https://github.com/sj82516/protoc-gen-go-http-client/tree/feat/go-gen-p1" target="_blank" rel="noopener"
>phase1&lt;/a>&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥ï¼Œç”¢ç”Ÿ protoc plugin ä¸¦æˆåŠŸç”¢ç”Ÿç©ºæ®¼æª”æ¡ˆï¼Œåƒè€ƒç›®éŒ„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">protoc-gen-go-http-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ main.go // plugin code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ example // ç¯„ä¾‹ proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â””â”€â”€ proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”œâ”€â”€ test.proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”œâ”€â”€ test.pb.go // protoc-gen-go ç”¢ç”Ÿçš„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â””â”€â”€ test_http.go // è‡ªè£½ plugin ç”¢ç”Ÿçš„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ go.mod // è¨˜å¾— module å‘½åå¿…é ˆæ˜¯ protoc-gen-xxxx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨é–‹ç™¼ä¸Šæˆ‘å€‘ä¸»è¦é€é golang programï¼Œä¸¦æ¡ç”¨ &lt;a class="link" href="https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen" target="_blank" rel="noopener"
>protobuf golang package&lt;/a> å”åŠ©é–‹ç™¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Files&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Generate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">generateFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// generateFile generates a _http.pb.go file containing gRPC service definitions.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">generateFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">File&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">filename&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFilenamePrefix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;_http.pb.go&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewGeneratedFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoImportPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// Code generated by protoc-gen-go-http-client. DO NOT EDIT.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;package &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoPackageName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;func main() {&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">srv&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoName&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;Get&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// it&amp;#39;s get&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°¡å–®å¸¶éç¨‹å¼ç¢¼&lt;/p>
&lt;ul>
&lt;li>L7 æœƒæ‹¿åˆ°è¼¸å…¥çš„ proto fileï¼Œæˆ‘å€‘å¯ä»¥ä¸€å€‹ä¸€å€‹æª”æ¡ˆè™•ç†&lt;/li>
&lt;li>L19~L20 æ˜¯ç”¢ç”Ÿè¼¸å…¥æª”æ¡ˆ&lt;/li>
&lt;li>L27,28 æ˜¯é‡å° proto è£¡é¢çš„ service / message è¼ªè©¢&lt;/li>
&lt;li>é€é &lt;code>g.P()&lt;/code> æˆ–æ˜¯ stdout &lt;code>fmt.Println&lt;/code> éƒ½æœƒæŠŠ string å…§å®¹å¯«å…¥è¼¸å‡ºçš„æª”æ¡ˆä¸­&lt;/li>
&lt;/ul>
&lt;h4 id="å®‰è£ä¸¦æ¸¬è©¦">å®‰è£ä¸¦æ¸¬è©¦&lt;/h4>
&lt;p>é–‹ç™¼å¾Œå¯ä»¥ç›´æ¥åœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹å®‰è£&lt;/p>
&lt;blockquote>
&lt;p>$ go install&lt;/p>
&lt;/blockquote>
&lt;p>æ­¤æ™‚å°æ‡‰åœ¨ $GOBIN æ‡‰è©²æœƒæœ‰å°æ‡‰çš„ binary fileï¼Œå¦‚æœ shell $PATH æœ‰æ­£ç¢ºæŒ‡å®šé‚£ $ protoc-gen-http-client å¯ä»¥æ­£ç¢ºåŸ·è¡Œ&lt;/p>
&lt;p>æ­¤æ™‚ protoc å°±å¯ä»¥è¼‰å…¥ http-client çš„ pluginï¼Œçœ‹åˆ° .go file ç”¢ç”Ÿ&lt;/p>
&lt;blockquote>
&lt;p>$ protoc &amp;ndash;go-http-client_out=. &amp;ndash;go-http-client_opt=&amp;ldquo;paths=source_relative&amp;rdquo; &amp;ndash;go_out=. &amp;ndash;go_opt=paths=source_relative example/proto/*.proto&lt;/p>
&lt;/blockquote>
&lt;h2 id="2-å¦‚ä½•å¾-command-è®€å–åˆ°-plugin-è¨­å®š">2. å¦‚ä½•å¾ command è®€å–åˆ° plugin è¨­å®š&lt;/h2>
&lt;p>åƒè€ƒç¨‹å¼ç¢¼ï¼š&lt;a class="link" href="https://github.com/sj82516/protoc-gen-go-http-client/tree/feat/go-gen-p2" target="_blank" rel="noopener"
>phase2&lt;/a>&lt;/p>
&lt;p>è®“æˆ‘å€‘åœ¨åŸ·è¡Œ protoc æŒ‡ä»¤æ™‚ï¼Œé †ä¾¿å¸¶ä¸ŠæŒ‡å®šåƒæ•¸ä¾†è¨­å®š http client request çš„ url &lt;code>base-url&lt;/code>&lt;/p>
&lt;p>ä¸»è¦ç¨‹å¼ç¢¼æ”¹å‹•é€é flag å–å¾—åƒæ•¸&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">flags&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">baseUrl&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;base_url&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;flags from command&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">opts&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>$ protoc &amp;ndash;go-http-client_out=. &amp;ndash;go-http-client_opt=paths=source_relative,base_url=api.com example/*.proto&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ protoc-gen-go ä¸­ï¼Œå¯ä»¥æŒ‡å®š &lt;code>paths&lt;/code> åƒæ•¸ï¼ŒæŒ‡å®šè¼¸å‡ºçš„è³‡æ–™å¤¾ä½ç½® (èˆ‡ go_out ä¸€èµ·å½±éŸ¿)ï¼Œåƒè€ƒ &lt;a class="link" href="https://developers.google.com/protocol-buffers/docs/reference/go-generated#invocation" target="_blank" rel="noopener"
>Compiler Invocation&lt;/a>&lt;/p>
&lt;h2 id="3-å¦‚ä½•è¨­è¨ˆ-protobuf-extension">3. å¦‚ä½•è¨­è¨ˆ Protobuf extension&lt;/h2>
&lt;p>åƒè€ƒç¨‹å¼ç¢¼ï¼š&lt;a class="link" href="https://github.com/sj82516/protoc-gen-go-http-client/tree/feat/go-gen-p3" target="_blank" rel="noopener"
>phase3&lt;/a>&lt;/p>
&lt;p>æ¥è‘—æˆ‘å€‘è¦ä¾†å¢åŠ  plugin çš„ Protobuf extensionï¼Œåœ¨ proto file ä¸­æŒ‡å®š options è®“ plugin ç”¢ç”Ÿå°æ‡‰è¡Œç‚º&lt;/p>
&lt;p>æˆ‘å€‘ä¸»è¦åœ¨&lt;/p>
&lt;ol>
&lt;li>service ä¸­å¢åŠ  method / path çš„æŒ‡å®š&lt;/li>
&lt;li>message ä¸­å¢åŠ  field default value æŒ‡å®š&lt;/li>
&lt;/ol>
&lt;h3 id="3-1-å¢åŠ -proto-extension">3-1 å¢åŠ  proto extension&lt;/h3>
&lt;p>é¦–å…ˆè¦é‡å° protobuf ä¸åŒçš„çµæ§‹å» extendï¼Œå¾ä¸Šåˆ°ä¸‹æœ‰ file &amp;gt; service / message &amp;gt; method/field&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-proto" data-lang="proto">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// options.proto
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c1">// package name è¦æŒ‡å‘ proto æ‰€åœ¨ä½ç½®ï¼Œè€Œä¸æ˜¯ golang å°ˆæ¡ˆç›®éŒ„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">option&lt;/span> &lt;span class="n">go_package&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;github.com/sj82516/protoc-gen-go-http-client/protos&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">HttpClientMethodOptions&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">extend&lt;/span> &lt;span class="nc">google&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">protobuf.MethodOptions&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="n">HttpClientMethodOptions&lt;/span> &lt;span class="n">method_opts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2050&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">extend&lt;/span> &lt;span class="nc">google&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">protobuf.FileOptions&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="n">HttpClientFileOptions&lt;/span> &lt;span class="n">file_opts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2048&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—åœ¨ example ä¸­å°±å¯ä»¥ä½¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-proto" data-lang="proto">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// test.proto
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">import&lt;/span> &lt;span class="s">&amp;#34;example/http-client/options.proto&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">User&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">[(&lt;/span>&lt;span class="n">field_opts&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="k">default&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">HelloService&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">GetUser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hello&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">option&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">method_opts&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">option&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">method_opts&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;/user&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="p">};&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šæœ‰å¹¾é»æ¯”è¼ƒ tricky&lt;/p>
&lt;ol>
&lt;li>protobuf import è·Ÿ golang package åˆ†é–‹ï¼Œè½èµ·ä¾†å¾ˆç›´è¦ºä½†æˆ‘ä¸€é–‹å§‹ææ··äº†æ‰€ä»¥å¡å¾ˆä¹…ï¼Œå°¤å…¶æ˜¯è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ protobuf extension è¦&lt;code>æ‰‹å‹•ä¸‹è¼‰ proto file åˆ°è‡ªå·±çš„è³‡æ–™å¤¾ä¸­&lt;/code>ï¼Œåƒè€ƒ &lt;a class="link" href="https://grpc-ecosystem.github.io/grpc-gateway/docs/tutorials/adding_annotations/#using-protoc" target="_blank" rel="noopener"
>gRPC gatewate æ–‡ä»¶ï¼šwe need to copy some dependencies into our proto file structure.&lt;/a>&lt;/li>
&lt;li>å¦‚æœæœ‰ç”¨ä¸Š protoc-go-gen å‰‡å°æ‡‰çš„ proto extension åŒè·¯å¾‘è¦æœ‰ compiled .pb.go æª”æ¡ˆå¦å‰‡æœƒå‡ºéŒ¯&lt;/li>
&lt;/ol>
&lt;p>è³‡æ–™å¤¾çµæ§‹å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">protoc-gen-go-http-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ example
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”œâ”€â”€ http-client // ä»»ä½•ç¬¬ä¸‰æ–¹çš„ proto extension éƒ½éœ€è¦è‡ªå·±è¤‡è£½
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â””â”€â”€ options.proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â””â”€â”€ proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”œâ”€â”€ test.proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â””â”€â”€ test.pb.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ protos
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ options.proto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ options.pb.go // éœ€è¦ compiled å‡º .pb.goï¼Œå¦å‰‡
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åªæ˜¯å‰›å¥½æˆ‘çš„ protobuf plugin è·Ÿ example æ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾ä¸‹ï¼Œä½†å¦‚æœå…©è€…æ˜¯åˆ†é–‹çš„å°ˆæ¡ˆä¹Ÿè¦æŒ‰ç…§ç›¸åŒçš„æ–¹å¼&lt;br>
å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://github.com/grpc-ecosystem/grpc-gateway/tree/main/protoc-gen-openapiv2" target="_blank" rel="noopener"
>protoc-gen-openapiv2&lt;/a>&lt;/p>
&lt;h3 id="3-2-èª¿æ•´-plugin-è®€å–-options">3-2 èª¿æ•´ plugin è®€å– options&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// parse option
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Options&lt;/span>&lt;span class="p">().(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">descriptorpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MethodOptions&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">options&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">proto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetExtension&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">customProto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">E_MethodOpts&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// wrap as client
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">customProto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpClientMethodOptions&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;get&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;func %s() {&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoName&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;res, err := http.Get(\&amp;#34;https://%s%s\&amp;#34;)\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">baseURL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;target := %s{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆªå–éƒ¨åˆ†ç¨‹å¼ç¢¼ï¼Œä¸»è¦æ˜¯é€é protogen package å°±å¯ä»¥å–å¾—å€‹åˆ¥ proto çµæ§‹ä¸­çš„ options&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>é€é protoc plugin è®“ proto file å¯ä»¥èº«å…¼å¤šè·ï¼Œç•¶ä½œæ•´å€‹å°ˆæ¡ˆçš„æ ¸å¿ƒå®šç¾©æª”ï¼Œå¦‚æ¶èµ· gRPC server åŒæ™‚èƒ½é †ä¾¿ç”¢å‡ºå°æ‡‰çš„ api docï¼Œé€éè‡ªå·±æ’°å¯«å€‹å° demo æ›´ç†è§£å…¶ä¸­çš„åŸç†é‚„è »æœ‰è¶£çš„&lt;/p></description></item><item><title>æ·ºè«‡ Clean Architecture å¯¦ä½œ - Port Mapping æ–¹å¼</title><link>https://yuanchieh.page/posts/2022/2022-09-11-%E6%B7%BA%E8%AB%87-clean-architecture-%E5%AF%A6%E4%BD%9C-port-mapping-%E6%96%B9%E5%BC%8F/</link><pubDate>Sun, 11 Sep 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-09-11-%E6%B7%BA%E8%AB%87-clean-architecture-%E5%AF%A6%E4%BD%9C-port-mapping-%E6%96%B9%E5%BC%8F/</guid><description>&lt;p>åœ¨ä¸€æœˆåˆæ™‚ä¸Š Teddy çš„ DDD èª²ç¨‹æ™‚ï¼Œç¬¬ä¸€æ¬¡è¦‹è­˜åˆ° DDD çµåˆ Clean Architectureï¼Œå¯ä»¥å°‡è¨­è¨ˆè·Ÿå¯¦ä½œå®Œç¾çš„çµåˆï¼Œæ‰“é€ å‡ºå½ˆæ€§ã€æ˜“æ‡‚ã€å¥½ç¶­è­·çš„ç¨‹å¼ç¢¼ï¼Œå°±ä¸€ç›´å° Clean Architecture å¾ˆæ„Ÿèˆˆè¶£ (&lt;a class="link" href="https://gitlab.com/-/ide/project/TeddyChen/dddcleankanban/tree/master/-/board/" target="_blank" rel="noopener"
>èª²ç¨‹ ezKanban åŸå§‹ç¢¼&lt;/a>)ï¼›&lt;br>
å¾Œä¾†åœ¨ 2022 Coscup ä¸Šè½åˆ°å¼·è€… Jalex åˆ†äº« &lt;a class="link" href="https://slides.com/jalex-chang/go-clean-arch-cresclab" target="_blank" rel="noopener"
>Clean Architecture in Go: The Crescendo Way&lt;/a> æä¾›äº†å¦ä¸€ç¨®å¯¦ä½œçš„æ–¹å¼ï¼›&lt;br>
æœ€å¾Œåœ¨çœ‹ã€Clean Architecture å¯¦ä½œç¯‡ã€‘æ™‚ï¼Œä½œè€…åˆæä¾›å¦ä¸€ç¨®æ–¹å¼ä»¥å…­è§’æ¶æ§‹ç‚ºåŸºåº•çš„å¯¦ä½œ&lt;/p>
&lt;p>åœ¨çœ‹äº†é€™å¹¾ç¨®ä¸åŒå¯¦ä½œçš„è§’åº¦å¾Œï¼Œæ•´ç†ä¸€ä¸‹å¯¦ä½œ Clean Architecture ä¸­ä¸åŒå±¤è½‰æ›çš„å–æ¨&lt;/p>
&lt;h2 id="clean-architecture-çš„è§£è®€">Clean Architecture çš„è§£è®€&lt;/h2>
&lt;p>ã€Clean Architectureã€‘ä¸€æ›¸è«‡äº†éå¸¸å¤šçš„è§€å¿µï¼Œæ•´ç†å¾Œè‡ªå·±çš„è§£è®€æ˜¯ &lt;code>æ¶æ§‹æ˜¯ç‚ºäº†é™ä½å¾ŒçºŒçš„é–‹ç™¼ã€ç¶­é‹æˆæœ¬ä¸¦æœ€å¤§åŒ–å·¥ç¨‹å¸«çš„ç”¢èƒ½&lt;/code>ï¼Œè€Œåœ¨é€™æ¨£çš„åŸå‰‡ä¸‹æå‡ºäº†ä»¥ä¸‹çš„ä¾è³´åŸå‰‡&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0911/dep.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>é›¢ IO è¶Šé çš„å…ƒä»¶è¶Šæ˜¯æ ¸å¿ƒï¼Œè€Œæ ¸å¿ƒä¸æ‡‰è©²å› ç‚ºå¤–å±¤çš„æ”¹è®Šè€Œå—åˆ°å½±éŸ¿ï¼Œå°±å¥½æ¯”èªªç”¨æˆ¶ä¸æœƒåœ¨æ„è³‡æ–™åº«æ˜¯ç”¨ MySQL é‚„æ˜¯ MongoDB (IO)ï¼Œä»–åªæœƒåœ¨æ„ä»–è³¼è²·çš„å“é …èˆ‡æŠ˜æ‰£å°ä¸å° (æ¥­å‹™è¦å‰‡)&lt;/li>
&lt;li>ä¾è³´çš„ç‰©ä»¶ä¸å¯ä»¥è·¨å±¤ï¼Œæ‰€ä»¥ Adapter ä¸èƒ½ç›´æ¥å­˜å– Entity&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥å¾å…§è€Œå¤–ï¼Œå¯ä»¥åˆ†æˆ Entity (Domain Object) / Use Case / Adapter (Controller, Gateway, Repository - å¸¸æŒ‡ DB å„²å­˜å±¤) ç­‰&lt;/p>
&lt;h3 id="å…­è§’æ¶æ§‹">å…­è§’æ¶æ§‹&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0911/hex.png"
loading="lazy"
>
ç”± Alistair Cockburn æå‡ºçš„å…­è§’æ¶æ§‹ï¼Œå‰›å¥½èˆ‡ Clean Architecture è§€é»å‘¼æ‡‰ï¼Œå¤–éƒ¨ IO (Adapter) å¦‚æœè¦èˆ‡å…§å±¤ (Entity / Use Case) äº’å‹•å¿…é ˆé€šé &lt;code>Port&lt;/code>ï¼Œé€™äº› Port æœƒé€éä¾è³´åè½‰ç•¶ä½œéš”é›¢å±¤ï¼Œé¿å…å…§å±¤è¢«å¤–å±¤çš„è®Šå‹•è€Œæ”¹è®Š&lt;/p>
&lt;p>Port æ–¹å‘ä¾ç…§æ ¸å¿ƒçš„å°æ‡‰æœ‰å…©ç¨®&lt;/p>
&lt;ol>
&lt;li>In å¾å¤–å±¤å‘¼å«æ ¸å¿ƒ&lt;/li>
&lt;li>Out æ ¸å¿ƒå‘¼å«å¤–å±¤ (é€é interface)&lt;/li>
&lt;/ol>
&lt;h2 id="è·¨å±¤çš„æºé€šåŸå‰‡">è·¨å±¤çš„æºé€šåŸå‰‡&lt;/h2>
&lt;p>åœ¨ã€Clean Architectureã€‘ä¸€æ›¸ä¸­ï¼Œæåˆ°å¦‚æœè·¨å±¤çš„è©±&lt;code>å…§å±¤çš„ç‰©ä»¶æ˜¯ä¸å¯ä»¥ç›´æ¥è¢«è¼¸å‡ºåˆ°æ›´å¤–å±¤&lt;/code>ï¼Œä¾‹å¦‚ Entity åªèƒ½åœ¨ Use Case ä½¿ç”¨ï¼Œå¦‚æœè¦å‚³åˆ° Controller , Gatewayï¼Œå¿…é ˆå†è½‰ä¸€å±¤ DTO (data to object)ï¼Œåä¹‹å¾å¤–å±¤å¾€å…§å‚³ä¹Ÿæ˜¯ï¼Œé€™æ˜¯ç‚ºäº†ç¬¦åˆ &lt;code>SRP å–®ä¸€è·è²¬&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚ä¸€èˆ¬çš„ web requestï¼Œæœƒå¾ Controller å–å¾—åƒæ•¸ -&amp;gt; Use Case + Entity è™•ç†æ¥­å‹™é‚è¼¯ -&amp;gt; Controller å›å‚³çµæœï¼Œæ­¤æ™‚å¦‚æœ Controller åœ¨é¡¯ç¤ºçµæœç›´æ¥ä¾è³´æ–¼ Entityï¼Œé‚£ Entity å°±æœƒå¯èƒ½å› ç‚º API è¦å¤šå›å‚³æŸå€‹æ¬„ä½è€Œå—åˆ°æ”¹å‹•ï¼Œé•åæœ€ä¸€é–‹å§‹çš„åŸå‰‡&lt;/p>
&lt;p>ä½†æ˜¯å¦‚æœæ¯ä¸€å±¤ä¹‹é–“éƒ½éœ€è¦ DTO è½‰æ›ï¼Œé‚£ç¨‹å¼ç¢¼æœƒå¾ˆå¤šé‡è¤‡å®£å‘Šï¼Œå› ç‚ºæˆ‘å€‘é€é&lt;code>é‡è¤‡å–ä»£è€¦åˆ&lt;/code>ï¼Œåœ¨ã€Clean Architecture å¯¦ä½œç¯‡ã€‘æœ‰æ•´ç†å¹¾ç¨®æ–¹å¼ï¼Œä¾›å¤§å®¶å–æ¨&lt;/p>
&lt;h3 id="1-no-mapping-è·¨å±¤ä¸è½‰æ›">1. No Mapping è·¨å±¤ä¸è½‰æ›&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0911/no_mapping.jpeg"
loading="lazy"
>
å…ˆçœ‹è·¨å±¤å®Œå…¨ä¸è½‰æ›çš„æ–¹å¼ï¼Œåƒè€ƒæˆ‘ç”¨ golang å¯¦ä½œçš„ç‰ˆæœ¬ &lt;a class="link" href="https://github.com/sj82516/clean-architecture-mapping/tree/feat/no-mapping/internal" target="_blank" rel="noopener"
>github/no-mapping&lt;/a>ï¼Œé€™é‚Šæˆ‘çš„ Entity å®£å‘Šæ··é›œäº† Controller çš„ json tag èˆ‡ ORM çš„ tag&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Entity
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Order&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Model&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34; gorm:&amp;#34;autoincrement&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;price&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;count&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CreatedAt&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Use Case
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">CreateOrderService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">withTax&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mf">1.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">withTax&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreatedAt&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">saveOrder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SaveOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">o&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨å¾ŒçºŒçš„ Controller / Gateway ä¸­ï¼Œå°±ç›´æ¥ä½¿ç”¨ Entity&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Repo å„²å­˜è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="nx">OrderRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SaveOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Controller ç›´æ¥ç”¨ Entity å–å¾— API request å…§å®¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸¦å‚³å…¥ UseCase ä¸­
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">OrderController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">CreateOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">srv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCreateOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">repo&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">order&lt;/span> &lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShouldBindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">order&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusBadRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">order&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusOK&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å„ªç¼ºé»">å„ªç¼ºé»&lt;/h4>
&lt;p>å¦‚æœæ˜¯å¾ˆå–®ç´”çš„ CRUDï¼ŒAPI / DB çš„è³‡æ–™æ ¼å¼éƒ½ä¸€æ¨¡ä¸€æ¨£æ‰æœƒä½¿ç”¨ï¼Œæ¸›å°‘ä¸å¿…è¦çš„è·¨å±¤è½‰æ›ï¼›&lt;/p>
&lt;p>ä½†ç¼ºé»æ˜¯å¦‚æœ API / DB æ ¼å¼é–‹å§‹åˆ†æ­§ï¼ŒEntity å°±æœƒå—åˆ°æ±¡æŸ“ï¼Œå‡ºç¾éƒ¨åˆ†æ¬„ä½åªæœ‰åœ¨ç‰¹å®šç”¨é€”ä½¿ç”¨ï¼Œè€Œä¸æ˜¯è·Ÿæ¥­å‹™é‚è¼¯æœ‰é—œï¼Œå°±åƒæ˜¯ CreatedAt æ¬„ä½åªæ˜¯ç‚ºäº† DB ç´€éŒ„ï¼Œå»å‡ºç¾åœ¨æ¥­å‹™é‚è¼¯ä¸Šä¸å¤ªåˆç†ï¼›&lt;br>
å†åŠ ä¸Šå¦‚æœæœªä¾†ä¸ç”¨ json è€Œèµ° gRPCï¼Œé‚£ Entity å°±è¦é‡æ–°æ”¹ tagï¼Œå› ç‚º IO è®ŠåŒ–è€Œæ”¹å‹• Entity é•åäº† Clean Architecture åŸå‰‡&lt;/p>
&lt;p>æ‰€ä»¥å»ºè­°é‚„æ˜¯å°‘ç”¨&lt;/p>
&lt;h3 id="2-two-way-mapping">2. Two way mapping&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0911/two-way_mapping.jpeg"
loading="lazy"
>
&lt;a class="link" href="https://github.com/sj82516/clean-architecture-mapping/tree/feat/two-way-mapping" target="_blank" rel="noopener"
>github/two-way mapping&lt;/a> å‰‡æ˜¯ Controller / Gateway ç¨ç«‹å®£å‘Šè‡ªå·±çš„ç‰©ä»¶ï¼Œå»ºç«‹å‡º Entityå¾Œå†å‚³å…¥ Use Case ä¸­&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Order&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Repo ç¨ç«‹ DAO å®šç¾©
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">OrderDAO&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Id&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`gorm:&amp;#34;autoincrement&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CreatedAt&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="nx">OrderRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SaveOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç”¨ Entity å»è½‰æ› DAO
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">orderDao&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">OrderDAO&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">orderDao&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Controller ç¨ç«‹ Request Object
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">OrderController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">CreateOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">srv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCreateOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">repo&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç¨ç«‹ DTO
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">type&lt;/span> &lt;span class="nx">CreateOrderRequest&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;price&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;count&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="nx">CreateOrderRequest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShouldBindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusBadRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// DTO é‡å»º Entity
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">order&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">order&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusOK&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° Entity è®Šå¾—å¾ˆä¹¾æ·¨ï¼Œè€Œ Controller / Gateway è¦è‡ªå·±è² è²¬ DTO çš„è½‰æ›ï¼Œè®“è·è²¬è®Šå¾—æ›´æ˜ç¢º&lt;/p>
&lt;h4 id="å„ªç¼ºé»-1">å„ªç¼ºé»&lt;/h4>
&lt;p>é€™ç®—æ˜¯è »å¹³è¡¡çš„è¨­è¨ˆæ–¹å¼ï¼Œé©åˆç”¨åœ¨ &lt;code>Use Case -&amp;gt; Adapter&lt;/code> é€™ä¸€å±¤ï¼Œå¯ä»¥çœ‹åˆ° Jalex å¤§å¤§åœ¨ DB å„²å­˜å±¤æ˜¯ç”¨ Two way mapping çš„æ–¹å¼ &lt;a class="link" href="https://github.com/chatbotgang/go-clean-arch/blob/develop/internal/adapter/repository/postgres/good_repository.go" target="_blank" rel="noopener"
>go-clean-arch&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// DAO å¦å¤–å®šç¾©
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">repoGood&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`db:&amp;#34;id&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`db:&amp;#34;name&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">OwnerID&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`db:&amp;#34;owner_id&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CreatedAt&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span> &lt;span class="s">`db:&amp;#34;created_at&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">UpdatedAt&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span> &lt;span class="s">`db:&amp;#34;updated_at&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç›´æ¥æ‹¿ Good (Entity) ç•¶ä½œåƒæ•¸
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">updateGood&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span> &lt;span class="nx">sqlContextGetter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">good&lt;/span> &lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Good&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">where&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">And&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Eq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">repoColumnGood&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">good&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">update&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">repoColumnGood&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">good&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">repoColumnGood&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OwnerID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">good&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OwnerID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">repoColumnGood&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UpdatedAt&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// build SQL query
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="p">..&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// execute SQL query
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="p">..&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updatedGood&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">barter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Good&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">row&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">updatedGood&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-full-mapping">3. Full Mapping&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0911/full_mapping.jpeg"
loading="lazy"
>
&lt;a class="link" href="https://github.com/sj82516/clean-architecture-mapping/tree/feat/full-mapping" target="_blank" rel="noopener"
>github/full-mapping&lt;/a> é€™æ¬¡åš´æ ¼éµå®ˆ Clean Architectureï¼Œåœ¨ two-mapping ä¸Šå¢åŠ &lt;code>è·¨å±¤éƒ½è¦æœ‰ DTO çš„è½‰æ›&lt;/code>ï¼Œæ‰€ä»¥ Controller -&amp;gt; Use Case ä¸èƒ½ç›´æ¥ç”¨ Entityï¼Œå¤šå®£å‘Šä¸€å€‹ Command Object&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// CreateOrder Use Case æ”¹åƒ CreateOrderCommand ç•¶ä½œåƒæ•¸è€Œé Entity
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">CreateOrder&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">command&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">CreateOrderCommand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">CreateOrderCommand&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// New Command å¯ä»¥è² è²¬é©—è­‰åƒæ•¸
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewCreateOrderCommand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">price&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">CreateOrderCommand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">price&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">CreateOrderCommand&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;params error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">CreateOrderCommand&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">price&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">count&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">CreateOrderService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">command&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">in&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateOrderCommand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">in&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateOrderOutput&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Order&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">command&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">command&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">withTax&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mf">1.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">withTax&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èˆ‡ Adapter äº’å‹•ä¹Ÿæ˜¯é€é cmd è€Œéç›´æ¥å‚³å…¥ Entity
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">cmd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSaveOrderCommand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">now&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">saveOrder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SaveOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">output&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">in&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCreateOrderOutput&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">output&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¤–éƒ¨ä½¿ç”¨ä¸Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Controller å‘¼å« Command Object
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">OrderController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">CreateOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">srv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCreateOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">repo&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">type&lt;/span> &lt;span class="nx">CreateOrderRequest&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;price&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;count&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="nx">CreateOrderRequest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShouldBindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusBadRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€é new cmd å»äº’å‹•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">cmd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">in&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCreateOrderCommand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">output&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusOK&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Adapter éƒ¨åˆ†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">OrderDAO&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Id&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`gorm:&amp;#34;autoincrement&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CreatedAt&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="nx">OrderRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SaveOrder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SaveOrderCommand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">orderDao&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">OrderDAO&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Price&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Price&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Total&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Total&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">orderDao&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å„ªç¼ºé»-2">å„ªç¼ºé»&lt;/h4>
&lt;p>å¤šäº†ä¸€å€‹ CreateOrderCommand æœ€å¤§å¥½è™•æ˜¯å¯ä»¥é€²ä¸€æ­¥åˆ†æ•£è·è²¬ï¼Œç”± Port ç‰©ä»¶å”åŠ©&lt;code>é©—è­‰è³‡æ–™&lt;/code>ï¼Œé€™æ¨£ Use Case å¯ä»¥å°ˆå¿ƒé©—è­‰æ¥­å‹™è¦å‰‡ï¼Œè€ŒåŸºæœ¬çš„è³‡æ–™é©—è­‰å¯ä»¥ç”± Port (ä¹Ÿå°±æ˜¯ CreateOrderCommand) è² è²¬&lt;/p>
&lt;p>å…¶ä»–åœ°æ–¹é©—è­‰è³‡æ–™çš„è€ƒé‡é»&lt;/p>
&lt;ol>
&lt;li>Use Case: è¦é©—è­‰è³‡æ–™åŒæ™‚é©—è­‰æ¥­å‹™è¦å‰‡ï¼Œé€™æ¨£æœƒæ¯”è¼ƒè¤‡é›œï¼Œè®“ Use Case å°ˆæ³¨æ¥­å‹™è¦å‰‡æœƒæ¯”è¼ƒå¥½&lt;/li>
&lt;li>Controller: ä¸é©åˆé©—è­‰è³‡æ–™ï¼Œå¦‚æœæœ‰å…¶ä»–åœ°æ–¹è¦å‘¼å« Use Case é‚£é©—è­‰è¦å‰‡è¦åœ¨é‡è¤‡å¯«ä¸€æ¬¡&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>è³‡æ–™é©—è­‰ vs æ¥­å‹™è¦å‰‡&lt;br>
æ¥­å‹™è¦å‰‡é€šå¸¸æŒ‡çš„æ˜¯èˆ‡ Entity æœ¬èº«ç‹€æ…‹æœ‰é—œï¼Œä¾‹å¦‚ &lt;code>è½‰å¸³é¤˜é¡ä¸å¯ç‚ºç©º&lt;/code>ï¼Œè‡³æ–¼è³‡æ–™é©—è­‰æ¯”è¼ƒæ˜¯ä¸€èˆ¬æ€§çš„è¦å‰‡æª¢æŸ¥ä¾‹å¦‚ Email æ ¼å¼ã€é‡‘é¡ä¸å¯å°æ–¼é›¶ç­‰&lt;/p>
&lt;/blockquote>
&lt;p>ç¼ºé»å°±æ˜¯å¦‚æœæ˜¯ CRUD çš„è©± DTO æœƒå¯«èµ·ä¾†å¾ˆç‘£ç¢ï¼Œå»ºè­°æ˜¯åœ¨ Controller -&amp;gt; Use Case é€™ä¸€å±¤ä½¿ç”¨&lt;/p>
&lt;h3 id="å°ä½œå¼Š">å°ä½œå¼Š&lt;/h3>
&lt;p>ä¸Šè¿°çš„æ¡ˆä¾‹æˆ‘å€‘åªæœ‰ç®¡è¼¸å…¥ï¼Œç•¶ Controller è¦å‘¼å« Use Case æ™‚ è¼¸å…¥åƒæ•¸ç”¨ç¨ç«‹çš„ Command Object&lt;/p>
&lt;p>ä½†æ˜¯ Use Case å›å‚³å€¼é‚„æ˜¯ç”¨ Entityï¼Œé€™é‚„æ˜¯é•åäº† Clean Architecture ç‰©ä»¶ä¸å¯è·¨å±¤åŸå‰‡ï¼Œé€™é‚Šä¸»è¦æ˜¯æ–¹ä¾¿ä½¿ç”¨ï¼Œé€™ä¹Ÿæ˜¯ã€Clean Architecture å¯¦ä½œç¯‡ã€‘ä½œè€…åœ¨ p. 112 å»ºè­°çš„åšæ³•&lt;/p>
&lt;p>å¦‚æœ in / out port çš„è¼¸å…¥è¼¸å‡ºéƒ½è¦æœ‰ DTOï¼Œå»ºè­°åƒè€ƒ Teddy çš„å¯¦åš &lt;a class="link" href="https://gitlab.com/TeddyChen/dddcleankanban/-/blob/master/board/src/main/java/ntut/csie/sslab/kanban/board/usecase/service/GetBoardContentService.java" target="_blank" rel="noopener"
>dddcleankanban&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åœ¨ Use Case ä¸­å›å‚³ output è€Œé Entity
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setBoardId&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">input&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBoardId&lt;/span>&lt;span class="o">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">setBoardMemberDtos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">boardMemberDtos&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">setWorkflowDtos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">workflowDtos&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">setCommittedWorkflowDtos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">committedWorkflowDtos&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">setCardDtos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">cardDtosInBoard&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="n">output&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0911/overview.png"
loading="lazy"
>
ç¸½çµæ•´é«”æ¶æ§‹å¤§è‡´æ˜¯&lt;/p>
&lt;ol>
&lt;li>Controller æœ‰ç¨ç«‹çš„ Request / Response Object&lt;/li>
&lt;li>Controller æœƒå»å»ºç«‹ In Port Commandï¼Œä¸¦å‘¼å« Use Case&lt;/li>
&lt;li>Use Case å¯¦ä½œ In Port Interfaceï¼Œå¤–ç•Œæ˜¯èˆ‡ Interface ç›¸ä¾&lt;/li>
&lt;li>é€é Out Port èˆ‡ Repository æºé€š&lt;/li>
&lt;li>Repository å®šç¾© DAO å„²å­˜è³‡æ–™åˆ° DB&lt;/li>
&lt;li>å› ç‚º return éƒ½å·æ‡¶ç”¨ Entityï¼Œæ‰€ä»¥å¤§å®¶éƒ½èˆ‡ Entity ç›¸ä¾&lt;/li>
&lt;/ol>
&lt;p>æ¡ç”¨ Clean Architecture å¯ä»¥è®“æ¯ä¸€å±¤è®Šå¾—æ›´ç¨ç«‹ã€æ›´å¥½æ¸¬è©¦ï¼Œé–‹ç™¼çš„æ¨¡å¼ä¹Ÿå¯ä»¥æ›´å›ºå®šï¼Œåœ¨åœ˜éšŠå¢åŠ äººæ•¸æ™‚ä¹Ÿæ›´å¥½ä¸Šæ‰‹ï¼Œå¢åŠ ç”Ÿç”¢åŠ›&lt;/p>
&lt;p>å‰›å¥½å…¬å¸çš„å°ˆæ¡ˆä¸€é‚Šæ˜¯ Railsï¼Œæ¡†æ¶æœ¬èº«å°±å¸¶æœ‰å¾ˆå¼·çƒˆçš„æ¶æ§‹é¢¨æ ¼ï¼›å¦ä¸€é‚Šå¾®æœå‹™ç”¨ Golang å¯¦ä½œ Clean Architecture è©¦è‘—è®“æ¡†æ¶èˆ‡æ¶æ§‹è§£è€¦ï¼Œç®—æ˜¯è »æœ‰è¶£çš„è¡çªèˆ‡ç›¸äº’å°è­‰&lt;/p></description></item><item><title>ã€ç¨‹å¼è¨­è¨ˆã€‘è¬¹æ…ä½¿ç”¨ Mixin - æ·ºè«‡ RoR Module ä½¿ç”¨çš„é™·é˜±</title><link>https://yuanchieh.page/posts/2022/2022-08-27-%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%E8%AC%B9%E6%85%8E%E4%BD%BF%E7%94%A8-mixin-%E6%B7%BA%E8%AB%87-ror-module-%E4%BD%BF%E7%94%A8%E7%9A%84%E9%99%B7%E9%98%B1/</link><pubDate>Sat, 27 Aug 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-08-27-%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%E8%AC%B9%E6%85%8E%E4%BD%BF%E7%94%A8-mixin-%E6%B7%BA%E8%AB%87-ror-module-%E4%BD%BF%E7%94%A8%E7%9A%84%E9%99%B7%E9%98%B1/</guid><description>&lt;p>å¹³æ—¥åœ¨å…¬å¸ä½¿ç”¨ RoR é–‹ç™¼ï¼Œéå¾€ code base åœ¨è·¨ class æ™‚ç‚ºäº†æ–¹ä¾¿æœƒæŠ½å‡ºä¸€å€‹åç‚º &lt;code>XXFunction::SharedMethod&lt;/code> çš„ moduleï¼Œè®“å¤šå€‹ class ç›´æ¥ include ä½¿ç”¨ï¼Œä½†å¾ŒçºŒåœ¨é–±è®€æ™‚ç™¼ç¾ module èˆ‡ class è·è²¬ä¸æ¸…æ¥šï¼Œå°è‡´é–±è®€æ™‚è¦ä¸æ–·åœ°å¤šå€‹æª”æ¡ˆåˆ‡æ›ï¼Œæœ€å¯æ€•æ˜¯ instance variable åœ¨ module / class éƒ½æœƒè®€å¯«ï¼Œå¼·è€¦åˆçš„æƒ…æ³ä¸‹ä»»æ„çš„æ”¹å‹•éƒ½æœ‰å¯èƒ½ç ´å£åŸæœ¬çš„è¨­è¨ˆ&lt;/p>
&lt;p>å› æ­¤æœ‰äº†é€™ç¯‡çš„æ–‡ç« èª•ç”Ÿï¼Œæ¢è¨ Module åœ¨ RoR ä¸­è©²å¦‚ä½•æ­£ç¢ºåœ°ä½¿ç”¨ï¼Œæ‰å¯ä»¥å†äº«æœ‰ code reuse çš„ä¾¿åˆ©å»ä¸é€ æˆå¯è®€æ€§ / ç¶­è­·æ€§ä¸Šçš„å›°æ“¾&lt;/p>
&lt;p>ä»¥ä¸‹æ–‡ç« å¤§é‡åƒè€ƒ&lt;/p>
&lt;ul>
&lt;li>Gitlab ä¸Šçš„è¨è«– &lt;a class="link" href="https://docs.gitlab.com/ee/development/module_with_instance_variables.html" target="_blank" rel="noopener"
>Rails module using instance variable is harmful&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.cloudbees.com/blog/good-module-bad-module" target="_blank" rel="noopener"
>Good Module or Bad Module&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.cloudbees.com/blog/when-to-be-concerned-about-concerns" target="_blank" rel="noopener"
>When To Be Concerned About Concerns&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="module-ç°¡ä»‹">Module ç°¡ä»‹&lt;/h2>
&lt;p>Module åœ¨ Rudy ä¸­æ˜¯ä¸€å€‹é¡ä¼¼ class çš„å­˜åœ¨ï¼Œæ˜¯ class / method / constant çš„é›†åˆä½†ä¸å¯ä»¥è¢« initiailizeï¼Œä¸»è¦çš„åŠŸèƒ½æœ‰å…©å€‹&lt;/p>
&lt;h4 id="1-namespace">1. Namespace&lt;/h4>
&lt;p>å¦‚æœæœ‰å…©å€‹ class åœ¨ä¸åŒçš„ context ä¸­å»æœ‰é¡ä¼¼çš„å‘½åï¼Œå¯ä»¥ç”¨ Module ç•¶ä½œå‰ç¶´éš”é–‹ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">FeatureA&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">Hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">FeatureB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">Hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">FeatureA&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">FeatureB&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Hello&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2-code-reuse">2. Code Reuse&lt;/h4>
&lt;p>åœ¨ Ruby ä¸­ç¹¼æ‰¿åªèƒ½å¤  &lt;code>å–®ä¸€ç¹¼æ‰¿&lt;/code>ï¼Œç¹¼æ‰¿è¨­è¨ˆçš„ç†å¿µåå‘æ˜¯ &lt;code>is-a&lt;/code>ï¼›&lt;br>
å¦‚æœæƒ³æ›´å»£æ³›çš„è³¦äºˆ class æŸç¨®èƒ½åŠ› &lt;code>could-do&lt;/code>ï¼Œé‚£ç”¨ module çš„æ–¹å¼æœƒæ›´åŠ çš„é©åˆï¼Œåœ¨ module åµŒå…¥çš„æ•¸é‡ä¸Š Ruby ä¸¦æ²’æœ‰é™åˆ¶ (åƒè€ƒ &lt;a class="link" href="https://railsbook.tw/chapters/08-ruby-basic-4" target="_blank" rel="noopener"
>é¡åˆ¥ï¼ˆClassï¼‰èˆ‡æ¨¡çµ„ï¼ˆModuleï¼‰&lt;/a>)&lt;/p>
&lt;p>æœ€åŸºæœ¬çš„ä¾‹å­æ˜¯ Ruby Core Module &lt;a class="link" href="https://ruby-doc.org/core-2.5.0/Comparable.html" target="_blank" rel="noopener"
>&lt;code>Comparable&lt;/code>&lt;/a>ï¼Œç•¶ class include Module å¾Œåªè¦å¯¦ä½œ &lt;code>&amp;lt;=&amp;gt;&lt;/code> methodï¼Œå°±å¯ä»¥ä½¿ç”¨ Comparable å®šç¾©çš„åŠŸèƒ½å¦‚ &lt;code>&amp;lt;ã€&amp;gt;ã€==ã€between?&lt;/code> ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SizeMatters&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Comparable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">attr&lt;/span> &lt;span class="ss">:str&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">&amp;lt;=&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">other&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">str&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">&amp;lt;=&amp;gt;&lt;/span> &lt;span class="n">other&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">str&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">inspect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@str&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">SizeMatters&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Z&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">SizeMatters&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;YY&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s1&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">s2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ¿«ç”¨-module-çš„å£å‘³é“">æ¿«ç”¨ Module çš„å£å‘³é“&lt;/h2>
&lt;p>ä»‹ç´¹äº† Module çš„åŠŸç”¨ï¼Œä¾†çœ‹ä¸€ä¸‹åœ¨æ¿«ç”¨çš„æƒ…æ³ä¸‹é€ æˆçš„å‰¯ä½œç”¨&lt;/p>
&lt;h3 id="è‡­å‘³-1-ç›¸ä¾æ€§è®Šæˆéš±å¼é™ä½æ˜“è®€æ€§">è‡­å‘³ 1. ç›¸ä¾æ€§è®Šæˆéš±å¼ï¼Œé™ä½æ˜“è®€æ€§&lt;/h3>
&lt;p>è©¦æƒ³ä»Šå¤©åªæ˜¯ç‚ºäº†é™ä½ class çš„ç¨‹å¼ç¢¼è¡Œæ•¸ï¼Œè€Œå–®ç´”æŠŠ code æŠ½åˆ° Module æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">AfterSignupController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Wicked&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Wizard&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">SetAdmin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">MailAfterSuccessfulCreate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">FooBarFighters&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">MyHero&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰“é–‹äº†ä¸€å€‹æª”æ¡ˆï¼Œçµæœç™¼ç¾ class ä¸­æ‰€æœ‰çš„ method éƒ½åœ¨åˆ¥çš„ module å…§ï¼Œé€™æ™‚å€™è¦æ‰¾åˆ°å°æ‡‰çš„ module åœ¨å“ªå°±å¾ˆéº»ç…©&lt;/p>
&lt;p>æ›´å¯æ€•çš„æ˜¯ç•¶ä½ æ‰¾åˆ°å¾Œï¼Œä½ æ€éº¼æ”¹ä¿è­‰åœ¨æœ‰ class ä¾è³´çš„æƒ…æ³ä¸‹ï¼Œæ”¹å‹• Module æœƒä¸æœƒå£æ‰ï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>Extracting methods into a module to only turn around and include them is worse than pointless.&lt;/code> It&amp;rsquo;s actively damaging to the readability of your codebase.&lt;/p>
&lt;/blockquote>
&lt;h3 id="è‡­å‘³-2-åš´é‡è€¦åˆå¦‚æœå…±ç”¨-instance-variable-æœƒè®“æƒ…æ³æ›´ç³Ÿ">è‡­å‘³ 2. åš´é‡è€¦åˆï¼Œå¦‚æœå…±ç”¨ Instance Variable æœƒè®“æƒ…æ³æ›´ç³Ÿ&lt;/h3>
&lt;p>åˆ†äº«ä¸€ä¸‹ç›®å‰é‡åˆ°çš„æ¡ˆä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">SharedFunction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">update_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">var&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">print&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">var&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">var2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">SharedFunction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">var2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># è€¦åˆé»1: class å¿…é ˆå…ˆ initial varï¼Œå¦å‰‡ update_method å°±æœƒå‡ºéŒ¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># è€¦åˆé»2: å¿…éœ€è¦çŸ¥é“ module method å‘¼å«é †åºï¼Œè®Šæˆæ˜¯è¦çŸ¥é“ module æ‰€æœ‰ç´°ç¯€æ‰èƒ½ä½¿ç”¨ï¼Œç¼ºå°‘å°è£çš„æ„ç¾©&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">update_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">update_var&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># è€¦åˆé»3. var é€™é‚Šä¹Ÿæœ‰æ©Ÿæœƒè®Šå‹•ï¼Œæœªä¾†åœ¨æ‰¾ var çš„å€¼åˆ°åº•æ˜¯ä»€éº¼æœƒå¾ˆå›°é›£&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">attr_accessor&lt;/span> &lt;span class="n">var&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹å‡º module åœ¨ä½¿ç”¨ instance variable å¾Œæœƒæœ‰å¾ˆå¤šè€¦åˆçš„åœ°æ–¹ï¼ŒåŒ…å« initialzie çš„æ™‚æ©Ÿ / æš´éœ²éå¤šç´°ç¯€ç­‰å•é¡Œ&lt;/p>
&lt;h3 id="å£å‘³é“3-å¤šå€‹-module-é–“å¯èƒ½æœƒæœ‰å‘½åè¡çª">å£å‘³é“3. å¤šå€‹ Module é–“å¯èƒ½æœƒæœ‰å‘½åè¡çª&lt;/h3>
&lt;p>å¦‚æœä»Šå¤©å…©å€‹ Module å‘½åé‡è¤‡æ€éº¼è¾¦ï¼Ÿ åœ¨ Ruby ä¸­æœƒä¾ç…§ç¹¼æ‰¿éˆæ±ºå®šå¥—ç”¨åˆ°çš„ methodï¼Œä½†å¯èƒ½ä¸ç¬¦åˆ caller çš„é æœŸï¼Œé€™é‚Šå¯ä»¥åƒè€ƒå‰ç«¯ React åœˆçš„è¨è«– &lt;a class="link" href="https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html" target="_blank" rel="noopener"
>Mixins Considered Harmful&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">A&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">method_a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">B&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">method_b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¦‚æœ module B ä¸å°å¿ƒä¹Ÿå®šç¾©äº† method_aï¼Œå°±æœƒè¦†è“‹éå»&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">C&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="n">A&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="n">B&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¦‚ä½•è§£æ±º">å¦‚ä½•è§£æ±º&lt;/h2>
&lt;h3 id="å»ºè­°-1-composition-over-inheritance">å»ºè­° 1. Composition over Inheritance&lt;/h3>
&lt;p>Module æŸç¨®ç¨‹åº¦æ˜¯å¤šé‡ç¹¼æ‰¿ï¼Œä¹Ÿå¯ä»¥ç”¨ class.ancestors çœ‹åˆ° included Module åœ¨ç¹¼æ‰¿éˆä¸Šï¼Œè¦è§£æ±ºé€™æ¨£çš„è‡­å‘³å¯ä»¥æ”¹ç”¨ &lt;code>Composition&lt;/code>&lt;/p>
&lt;p>Composition æ˜¯æŒ‡èªªæŠŠé¡ä¼¼çš„è¡Œç‚ºå°è£æˆ classï¼Œç›´æ¥åœ¨åŸæœ¬çš„ class ä¸­ä½¿ç”¨ï¼Œé€™å¸¶ä¾†çš„å¥½è™•æ˜¯&lt;/p>
&lt;ol>
&lt;li>class æœ‰æ›´å¥½çš„å°è£æ€§ï¼Œåªæœ‰ public method å¯ä»¥è¢«ä½¿ç”¨ (åœ¨ Ruby ä¸­ä¸å®Œå…¨æ­£ç¢º)&lt;/li>
&lt;li>class å¯ä»¥ç¨ç«‹æ¸¬è©¦&lt;/li>
&lt;/ol>
&lt;p>ä¾‹å¦‚ä»¥ä¸‹ï¼ŒåŸæœ¬ tracking ç›¸é—œçš„è¡Œç‚ºè¢«æŠ½åˆ° module ä¸­ï¼Œè¦çŸ¥é“ notify_next! å®šç¾©åœ¨å“ªå°±å¿…é ˆæ‰¾æ‰€æœ‰çš„ module åŒ…å«ç¹¼æ‰¿çš„ class&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Todo&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">ActiveRecord&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Base&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Other todo implementation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">EventTracking&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">EventTracking&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">extend&lt;/span> &lt;span class="no">ActiveSupport&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Concern&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">included&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">has_many&lt;/span> &lt;span class="ss">:events&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">before_create&lt;/span> &lt;span class="ss">:track_creation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">after_destroy&lt;/span> &lt;span class="ss">:track_deletion&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">notify_next!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">private&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">track_creation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†ç¾åœ¨ tracking è®Šæˆ class &lt;code>EventPlanning&lt;/code>ï¼Œå¥½è™•æ˜¯ä¸ç”¨çŒœ &lt;code>notify_next!&lt;/code> åœ¨å“ªå€‹ moduleï¼Œè·è²¬èˆ‡ç´°ç¯€éƒ½å°è£åœ¨ EventPlanning è£¡é¢ï¼Œè¦æ”¹å‹•åªè¦ç¢ºä¿ç›¸ä¾çš„ classï¼Œå°±ä¸ç”¨ç‰¹åˆ¥æ“”å¿ƒï¼Œè€Œä¸”é‚„æœ‰æ¸¬è©¦ä¿è­·&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Todo&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">ActiveRecord&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Base&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Other todo implementation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">has_many&lt;/span> &lt;span class="ss">:events&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">before_create&lt;/span> &lt;span class="ss">:track_creation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">after_destroy&lt;/span> &lt;span class="ss">:track_deletion&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">notify_next!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">EventPlanning&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">events&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">notify_next!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å»ºè­°-2-è¨­è¨ˆ-module-æ™‚æœ‰æ˜ç¢ºçš„è·è²¬ä¸¦ç¢ºä¿æš´éœ²çš„ç´°ç¯€">å»ºè­° 2. è¨­è¨ˆ Module æ™‚æœ‰æ˜ç¢ºçš„è·è²¬ï¼Œä¸¦ç¢ºä¿æš´éœ²çš„ç´°ç¯€&lt;/h3>
&lt;p>åƒè¬ä¸è¦ç‚ºäº† reuse code è€Œæ”¾æ£„ Object Oriented çš„æ€è€ƒï¼Œè¦ç¢ºä¿æ¯ä¸€å€‹ Module è¢«è¨­è¨ˆçš„å«ç¾©ï¼Œå…·é«”ä¾†èªªå°±æ˜¯&lt;/p>
&lt;ol>
&lt;li>include çš„ class å¿…é ˆå¯¦ä½œä»€éº¼åŠŸèƒ½ (æ±ºå®šè€¦åˆé»)&lt;/li>
&lt;li>Module å¯ä»¥æä¾› class æ€æ¨£çš„é¡å¤–åŠŸèƒ½&lt;/li>
&lt;/ol>
&lt;p>è®“æˆ‘å€‘çœ‹å¹¾å€‹æ¼‚äº®çš„ Module è¨­è¨ˆ&lt;/p>
&lt;h4 id="ç¯„ä¾‹enumerable">ç¯„ä¾‹ï¼šEnumerable&lt;/h4>
&lt;p>&lt;a class="link" href="https://ruby-doc.org/core-3.1.2/Enumerable.html" target="_blank" rel="noopener"
>Enumerable&lt;/a> æ˜¯æä¾›é›†åˆé¡å‹çš„ class æœ‰æ–¹ä¾¿éæ­· (iterate) çš„æ–¹æ³•&lt;/p>
&lt;ol>
&lt;li>include class å¿…é ˆå¯¦ä½œ &lt;code>each&lt;/code>&lt;/li>
&lt;li>Module å¯ä»¥æä¾› class &lt;code>map / select / sort / count&lt;/code> ç­‰ iterator è©²æœ‰çš„åŠŸèƒ½&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Foo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Enumerable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">each&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">Foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">each_entry&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">element&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="nb">p&lt;/span> &lt;span class="n">element&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Enumerable èˆ‡ class è€¦åˆé»åªæœ‰ each é€™å€‹ methodï¼Œå®Œå…¨æ²’æœ‰ instance variable ç­‰å…¶ä»–è€¦åˆï¼Œéå¸¸ä¹¾æ·¨&lt;/p>
&lt;h3 id="å»ºè­°-3-å¦‚æœè¦ç”¨-instance-variable-è«‹ç¢ºä¿åªæœ‰-module-è‡ªå·±ä½¿ç”¨">å»ºè­° 3. å¦‚æœè¦ç”¨ instance variable è«‹ç¢ºä¿åªæœ‰ Module è‡ªå·±ä½¿ç”¨&lt;/h3>
&lt;p>å¦‚æœ Module é‚„æ˜¯éœ€è¦ä½¿ç”¨ instance variable ä¹Ÿæ²’é—œä¿‚ï¼Œç¢ºä¿ class ä¸æœƒç”¨åˆ°å³å¯&lt;/p>
&lt;h4 id="ç¯„ä¾‹sidekiqworker">ç¯„ä¾‹ï¼šSidekiq::Worker&lt;/h4>
&lt;p>è®“æˆ‘å€‘çœ‹ä¸€å€‹ç¨å¾®è¤‡é›œçš„æ¡ˆä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">HardWorker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Sidekiq&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Worker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sidekiq_options&lt;/span> &lt;span class="ss">queue&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;critical&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">retry&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">perform&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># do some work&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">HardWorker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perform_async&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ include Sidekiq::Workerï¼Œå¯ä»¥æ‰‹å‹•èª¿æ•´åƒæ•¸ sidekiq_optionsï¼Œé€™é‚Šå¯¦ä½œå°±æœƒå»ºç«‹ instance variable&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sidekiq_options_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_sidekiq_options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">opts&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†å¾ˆæ˜é¡¯é€™å€‹ variable åœ¨ class æ˜¯å®Œå…¨ä¸æœƒç”¨åˆ°ï¼Œåªæœ‰ module å…§éƒ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æ²’æœ‰å•é¡Œ&lt;/p>
&lt;p>å¦å¤–ç•¶æˆ‘å€‘å¾€ä¸‹è¿½ perform_async æ™‚ï¼Œå¯ä»¥çœ‹åˆ°&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">perform_inline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Setter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{})&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perform_inline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šå‡ºç¾ä¸€å€‹ module å…§éƒ¨å®šç¾©çš„ class &lt;code>Setter&lt;/code>ï¼Œå¯ä»¥çœ‹åˆ°å¯¦éš›ç™¼é€çš„é‚è¼¯åœ¨é€™é‚Šï¼Œé€é class å°è£å¥½è™•æ˜¯ä¸æ€•è¢«å…¶ä»–äººä¸å°å¿ƒè¤‡å¯«æˆ–æ”¹å‹•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">Test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">module_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">private&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;module private&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">private&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;class private&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">A&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">module_method&lt;/span> &lt;span class="sr">//&lt;/span> &lt;span class="s2">&amp;#34;class private&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>module å…§çš„ method æœƒè¢«è¦†å¯«ï¼Œä½†å¦‚æœæ”¹ç”¨ class æŒ‡å®šå°±ä¸æœƒ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">Test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">module_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="no">ModuleClass&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">private&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">ModuleClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;module private&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">private&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;class private&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">A&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">module_method&lt;/span> &lt;span class="sr">//&lt;/span> &lt;span class="s2">&amp;#34;module private&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çˆ­è­°-rails-activesupportconcern">çˆ­è­° Rails ActiveSupport::Concern&lt;/h2>
&lt;p>ActiveSupport::Concern æ˜¯ Rails ä¸­è »æœ‰è¶£çš„è¨­è¨ˆï¼Œé¡ä¼¼æ–¼ Module ä½†æœ‰å¢åŠ æ›´å¤šçš„ &lt;code>é­”æ³•&lt;/code>ï¼Œå¯ä»¥æŠŠå¤ªå¤§çš„ orm class ä»¥ module çš„å½¢å¼åˆ†æ‹†å‡ºå»ï¼Œç®—æ˜¯ orm ç‰ˆçš„ Moduleï¼Œåœ¨ä½¿ç”¨çš„å¿ƒæ³•èˆ‡ä¸Šè¿°é›·åŒï¼Œå°±ä¸è´…è¿°ï¼Œä¹Ÿå¯ä»¥åƒè€ƒ &lt;a class="link" href="https://blog.appsignal.com/2020/09/16/rails-concers-to-concern-or-not-to-concern.html" target="_blank" rel="noopener"
>Rails Concerns: To Concern Or Not To Concern&lt;/a>&lt;/p>
&lt;p>åŸºæœ¬ä¸Šä¹Ÿéƒ½æ˜¯æåˆ° &lt;code>å¦‚æœ module èˆ‡ class ç”¢ç”Ÿäº† circular dependency&lt;/code>ï¼Œå¦‚æœæœ‰äººæ²’æ³¨æ„åˆ°ç›´æ¥æ”¹ classï¼Œé‚£ module å°±å¯èƒ½æœƒå£æ‰ï¼›è§£æ³•åŒæ¨£æ˜¯é™ä½ä¾è³´çš„æ©Ÿæœƒï¼Œè®“ module åšçš„äº‹æƒ…ç°¡å–®ä¸€äº›&lt;/p>
&lt;p>ä½†æœ‰è¶£çš„æ˜¯ &lt;a class="link" href="https://twitter.com/jubiweb/status/964346236588494848" target="_blank" rel="noopener"
>DHH æœ¬äººçœ‹èµ·ä¾†å¾ˆå–œæ­¡é€™æ¨£çš„å¯«æ³•&lt;/a> ï¼Œæˆ–è¨±é€™ä¹Ÿæ˜¯ä¸€ç¨® convention over configuration çš„é«”ç¾ XD ä½†è »å¤šäººæŠ±æŒåå°ç«‹å ´ï¼Œå°±å¤§å®¶æ–Ÿé…Œä½¿ç”¨&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>Ruby æ˜¯ä¸€é–€æœ‰è¶£çš„ç‰©ä»¶å°å‘èªè¨€ï¼Œæ‰€æœ‰çš„æ±è¥¿éƒ½æ˜¯ç‰©ä»¶ï¼Œæ‰€ä»¥åœ¨è¨­è¨ˆä¸Šå¦‚æœå¤šä½¿ç”¨ç‰©ä»¶å°å‘çš„æ€ç¶­å»è¨­è¨ˆï¼Œæœƒè®“ç¨‹å¼ç¢¼æ›´å¥½ç¶­è­·&lt;/p>
&lt;p>å¦å¤–ç™¼ç¾å¾ˆå¤šäººéƒ½æœƒæŠŠ &lt;code>DRY (Dont repeat yourself)&lt;/code> ç•¶ä½œè–æ—¨ï¼Œçœ‹åˆ°ä¸€é»é»é‡è¤‡å°±æœƒå¿ä¸ä½æŠ½å…±ç”¨ï¼Œä½†æ²’æœ‰è€ƒæ…®åˆ°&lt;code>æŠ½å…±ç”¨çœ‹èµ·ä¾†é¿å…äº†é‡è¤‡ä»£ç¢¼ï¼Œä½†é€™æ¨£é€ æˆäº†æ„å¤–çš„è€¦åˆ&lt;/code>ï¼Œåœ¨ç†è§£ Clean Architecture å¾Œæœƒç™¼ç¾å¾ˆå¤šçœ‹ä¼¼é‡è¤‡éƒ½æ˜¯&lt;code>éš±æ€§çš„é‡è¤‡&lt;/code>ï¼Œå…¶å¯¦æ²’æœ‰å¿…è¦æŠ½å…±ç”¨å°è‡´è€¦åˆçš„å­˜åœ¨ï¼Œé€™é»æœªä¾†æœ‰æ©Ÿæœƒå†å»¶ä¼¸æ¢è¨&lt;/p>
&lt;p>åœ¨ä½¿ç”¨ Module ä¸Šï¼Œè«‹ç¢ºä¿&lt;/p>
&lt;ol>
&lt;li>çœŸçš„éœ€è¦ç”¨ module åœ¨ç”¨ï¼Œå¦å‰‡ç”¨ composition + class æœƒè®“ç”Ÿæ´»æ›´ç°¡å–®&lt;/li>
&lt;li>Module è¨­è¨ˆä¸Šè¦ç¢ºå®šæš´éœ²çš„ç´°ç¯€èˆ‡è€¦åˆé»&lt;/li>
&lt;li>ä½¿ç”¨ instance variable è¦å°å¿ƒï¼Œè«‹é™ç¸®åœ¨ module å…§ä½¿ç”¨&lt;/li>
&lt;/ol></description></item><item><title>ã€åˆ·é¡Œé•·çŸ¥è­˜ã€‘Mercle tree è­˜åˆ¥å­æ¨¹ç›¸åŒèˆ‡å¦</title><link>https://yuanchieh.page/posts/2022/2022-06-01-%E5%88%B7%E9%A1%8C%E9%95%B7%E7%9F%A5%E8%AD%98mercle-tree-%E8%AD%98%E5%88%A5%E5%AD%90%E6%A8%B9%E7%9B%B8%E5%90%8C%E8%88%87%E5%90%A6/</link><pubDate>Wed, 01 Jun 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-06-01-%E5%88%B7%E9%A1%8C%E9%95%B7%E7%9F%A5%E8%AD%98mercle-tree-%E8%AD%98%E5%88%A5%E5%AD%90%E6%A8%B9%E7%9B%B8%E5%90%8C%E8%88%87%E5%90%A6/</guid><description>&lt;p>ä»Šå¤©åœ¨è§£ &lt;a class="link" href="https://leetcode.com/problems/binary-tree-longest-consecutive-sequence-ii/" target="_blank" rel="noopener"
>549. Binary Tree Longest Consecutive Sequence II&lt;/a>ï¼Œåœ¨è©•è«–å€ç™¼ç¾æœ‰è¶£çš„è§£æ³• Merkle Treeï¼Œèªªä¾†è§£æ³•ä¹Ÿå¾ˆå–®ç´”ï¼Œå°±æ˜¯ tree ç¯€é»æœƒ (å·¦å­æ¨¹çš„ hash value + å³å­æ¨¹çš„ hash value + è‡ªå·±çš„ hash value) å†å–ä¸€æ¬¡ hash value ä»£è¡¨æ•´æ£µ treeï¼Œæ‰€ä»¥éœ€è¦ O(n) çš„æ™‚é–“è¤‡é›œåº¦èˆ‡ç©ºé–“è¤‡é›œåº¦ï¼Œn ç‚ºç¯€é»æ•¸&lt;/p>
&lt;p>&lt;img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Hash_Tree.svg/310px-Hash_Tree.svg.png"
loading="lazy"
>&lt;br>
åœ–ç‰‡ä¾†è‡ª wiki&lt;/p>
&lt;p>#549 ç¨‹å¼ç¢¼å¤§è‡´æ˜¯ï¼Œä»¥ä¸‹ä»£ç¢¼çš„ä¾†æºæ˜¯ &lt;a class="link" href="https://leetcode.com/problems/find-duplicate-subtrees/discuss/106030/Python-O%28N%29-Merkle-Hashing-Approach" target="_blank" rel="noopener"
>awice-Python, O(N) Merkle Hashing Approach&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">findDuplicateSubtrees&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">from&lt;/span> &lt;span class="nn">hashlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">sha256&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">hash_&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">S&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sha256&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">S&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">S&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexdigest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">merkle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;#&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">merkle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_right&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">merkle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">merkle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hash_&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">m_left&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">m_right&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">merkle&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">merkle&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">defaultdict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">merkle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">nodes&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€é hash value æ¯”å°å…©å€‹ subtree æ˜¯å¦ç›¸åŒï¼Œä»¥ä¸Šè§£æ³•è¦å°å¿ƒæœ‰ hash collision å•é¡Œï¼Œæœ€å¥½é‡æ–°æª¢æŸ¥ä¸€ä¸‹æ¯”è¼ƒä¿éšª&lt;/p>
&lt;p>Merkle Tree åœ¨ç¾å¯¦ä¸­æœ‰ä»€éº¼æ‡‰ç”¨å‘¢ï¼Ÿ ä»¥ä¸‹å…§å®¹åƒè€ƒè‡ªÂ Â &lt;a class="link" href="https://medium.com/geekculture/understanding-merkle-trees-f48732772199" target="_blank" rel="noopener"
>Understanding Merkle Trees&lt;/a>&lt;br>
ä¸»è¦æœƒå‡ºç¾åœ¨æ¨¹ç‹€çµæ§‹ä¸”éœ€è¦å¿«é€Ÿæ‰¾å‡ºé€™å…©æ£µ Tree / Subtree å·®ç•°ä¹‹è™•ï¼Œä¾‹å¦‚&lt;/p>
&lt;ul>
&lt;li>Git åœ¨ pull request éœ€è¦å¿«é€ŸçŸ¥é“æ˜¯å¾å“ªå€‹ git commit tree é–‹å§‹ä¸åŒ / file tree ä¸­æœ‰å“ªäº›æª”æ¡ˆæœ‰ç•°å‹•éœ€è¦åŒæ­¥&lt;/li>
&lt;li>Blockchain ä¸­éœ€è¦çŸ¥é“äº¤æ˜“éˆä¸Šçš„æŸç­†äº¤æ˜“æ˜¯å¦å­˜åœ¨æ–¼è©²å€å¡Šä¸­&lt;/li>
&lt;li>åˆ†æ•£å¼è³‡æ–™åº«ä¸­åœ¨åŒæ­¥è³‡æ–™æ™‚ï¼Œè¦ç¢ºèªå“ªéƒ¨åˆ†è³‡æ–™æœ‰è½å·®éœ€è¦åŒæ­¥ï¼Œå¦‚ Dynamo DB ä¸­&lt;/li>
&lt;/ul>
&lt;p>è®“æˆ‘å€‘æ›´æ·±å…¥çœ‹ä¸€ä¸‹ Git å…§éƒ¨å¯¦ä½œ&lt;/p>
&lt;h1 id="git-internals---git-objects">Git Internals - Git Objects&lt;/h1>
&lt;p>&lt;a class="link" href="https://git-scm.com/book/en/v2/Git-Internals-Git-Objects" target="_blank" rel="noopener"
>https://git-scm.com/book/en/v2/Git-Internals-Git-Objects&lt;/a>&lt;/p>
&lt;p>è®“æˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ Git å…§éƒ¨æ€éº¼å„²å­˜è³‡æ–™ï¼ŒGit å…§éƒ¨æœ‰ä¸€å€‹ key-value databaseï¼Œè£¡é¢æœƒå„²å­˜ hash key èˆ‡å°æ‡‰çš„å…§å®¹ (Object)ï¼ŒåŒ…å«çš„é¡å‹æœ‰æª”æ¡ˆ (blob) / è³‡æ–™å¤¾ (tree) / commit éƒ½æœƒä»¥é€™æ¨£çš„æ–¹å¼å„²å­˜ï¼Œä¸åŒçš„é¡å‹æœƒ hash function çš„åƒæ•¸æœƒæœ‰æ‰€ä¸åŒï¼Œä½†éƒ½æ˜¯é€é SHA-1 ç”¢ç”Ÿ&lt;/p>
&lt;p>ä»¥ä¸Šçš„å…§å®¹æœƒå„²å­˜åœ¨Â &lt;code>.git/object&lt;/code>Â çš„è·¯å¾‘&lt;/p>
&lt;h3 id="blob-objects">Blob Objects&lt;/h3>
&lt;p>æª”æ¡ˆåŒ…å«æ–‡å­—åœ–æª”ç­‰éƒ½æ˜¯ blob å½¢å¼ï¼Œæˆ‘å€‘å¯ä»¥é€é&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>$git hash-object&lt;/code>Â å°‡æŒ‡å®šçš„æª”æ¡ˆæˆ–å…§å®¹å„²å­˜åˆ° git database ä¸­ï¼Œä¸¦å–å¾— hash code&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>$git cap-file&lt;/code>Â è¼¸å…¥å°æ‡‰çš„ hash code å¯ä»¥å–å‡ºå°æ‡‰çš„å…§å®¹&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å¦‚å®˜æ–¹æ¡ˆä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ mkdir &lt;span class="nb">test&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;test content&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> git hash-object -w --stdin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">d670460b4b4aece5915caf5c68d12f560a9fe3e4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ find .git/objects -type f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">test&lt;/span> content
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ .git/objects ä¸‹å¯ä»¥çœ‹åˆ°Â &lt;code>d6/70460b4b4aece5915caf5c68d12f560a9fe3e4&lt;/code>ï¼Œgit æœƒæŠŠ 40 ç¢¼ hash code æ‹†æˆ 2 + 38ï¼Œå‰ 2 ç¢¼è®Šæˆè³‡æ–™å¤¾åç¨±ï¼‹å¾Œ 38 ç¢¼è®Šæˆæª”æ¡ˆåç¨±ï¼Œå¦‚æœè©¦è‘—ç›´æ¥è®€å– file æœƒç™¼ç¾ç„¡æ³•è­˜åˆ¥ï¼Œä¸»è¦æ˜¯ Git æœƒç”¨ zlib å£“ç¸®å…§å®¹&lt;/p>
&lt;h3 id="tree-objects">Tree Objects&lt;/h3>
&lt;p>è³‡æ–™å¤¾åœ¨ Git ä¸­ä»¥ Tree çš„æ ¼å¼å„²å­˜ï¼Œå…¶å…§å®¹æœƒå„²å­˜è·¯å¾‘ä¸‹ tree / blob çš„ hash code&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ mkdir -p test1/test2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span> &amp;gt; test1/test2/test.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git add .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git commit -m &lt;span class="s2">&amp;#34;init&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p master^&lt;span class="o">{&lt;/span>tree&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">040000&lt;/span> tree b5a59142d85435f6a41a972e376a422fc6b2df93 test1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p b5a59142d85435f6a41a972e376a422fc6b2df93
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">040000&lt;/span> tree 33dacd7d9ac656ddebea4ecfc8ab9a87b37c2736 test2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p 33dacd7d9ac656ddebea4ecfc8ab9a87b37c2736
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> blob d800886d9c86731ae5c4a62b0b77c437015e00d2 test.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ &lt;code>master^{tree}&lt;/code>æ˜¯ä»£è¡¨ master branch çš„ç›®éŒ„ï¼Œå…§å®¹å„²å­˜ç¬¬ä¸€å±¤çš„æ‰€æœ‰æª”æ¡ˆèˆ‡è³‡æ–™å¤¾ test1ï¼Œæ¥è‘—ä¸€å±¤ä¸€å±¤å¾€ä¸‹æ‰¾å°±èƒ½æ‰¾åˆ° test.txt&lt;/p>
&lt;ul>
&lt;li>å¦‚æœæˆ‘å€‘æ›´æ–° test.txt æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;456&amp;#34;&lt;/span> &amp;gt; test1/test2/test.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p master^&lt;span class="o">{&lt;/span>tree&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">040000&lt;/span> tree ff1e53b4ff4c130ece8c9f12cdcc3f2613a779e7 test1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p b5a59142d85435f6a41a972e376a422fc6b2df93
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">040000&lt;/span> tree 33dacd7d9ac656ddebea4ecfc8ab9a87b37c2736 test2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p e9e2bd5dfa2916e3b1cba933bd9250a9822406e4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> blob 4632e068d5889f042fe2d9254a9295e5f31a26c7 test.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° test.txt å› ç‚ºå…§å®¹æ”¹è®Šè€Œ SHA key ä¹Ÿæ”¹è®Šï¼ŒåŒæ¨£çš„ test1 ã€test2 å°æ‡‰çš„ tree object SHA key å·²ç¶“è®Šæˆäº†ï¼Œæ‰€ä»¥åªè¦åº•ä¸‹çš„ blob æ”¹è®Š tree SHA keyä¹Ÿæœƒè·Ÿè‘—æ”¹è®Š&lt;/p>
&lt;p>æˆ‘æš«æ™‚æ²’æœ‰æ‰¾åˆ°ç›´æ¥æŠŠè³‡æ–™å¤¾è½‰æˆ hash code ä¸¦å„²å­˜çš„æ–¹å¼ï¼Œåœ¨æ–‡ä»¶ä¸­åªæœ‰è¨˜è¼‰ç•¶åœ¨ staging å€å¢åŠ æª”æ¡ˆæ™‚ï¼Œgit æœƒå¹«å¿™å»ºç«‹ index èˆ‡ tree&lt;/p>
&lt;h4 id="æ¯æ¬¡è®Šå‹•-git-éƒ½æœƒå„²å­˜æ•´ä»½æª”æ¡ˆå…§å®¹é€™æ¨£-gitobjects-å°±æœƒè¶…è‚¥">æ¯æ¬¡è®Šå‹• git éƒ½æœƒå„²å­˜æ•´ä»½æª”æ¡ˆå…§å®¹ï¼Œé€™æ¨£ .git/objects å°±æœƒè¶…è‚¥ï¼Ÿ&lt;/h4>
&lt;p>æ²’éŒ¯ï¼Œæœƒéå¸¸è‚¥ï¼Œæ‰€ä»¥ git æä¾›æŒ‡ä»¤å¯ä»¥æ¸…é™¤æª”æ¡ˆå¤ªèˆŠçš„è³‡æ–™ï¼Œåƒè€ƒ &lt;a class="link" href="https://stackoverflow.com/questions/5613345/how-to-shrink-the-git-folder" target="_blank" rel="noopener"
>How to shrink the .git folder&lt;/a>ï¼Œåœ¨ git æ–‡ä»¶ä¸­æœ‰æ›´è©³ç´°æè¿° &lt;a class="link" href="https://git-scm.com/book/zh-tw/v2/Git-Internals-Maintenance-and-Data-Recovery" target="_blank" rel="noopener"
>10.7 Git Internals - Maintenance and Data Recovery&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ git repack -a -d --depth&lt;span class="o">=&lt;/span>&lt;span class="m">250&lt;/span> --window&lt;span class="o">=&lt;/span>&lt;span class="m">250&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="commit-objects">Commit Objects&lt;/h3>
&lt;p>åœ¨ git ä¸­ commit å„²å­˜æ˜¯æ¨¹ç‹€çµæ§‹ï¼Œç•¶åŸ·è¡Œ $ git commit æ™‚ï¼Œgit æœƒç”¢ç”Ÿ commit object ä¸¦è¨˜éŒ„ commit è¨Šæ¯ / æ™‚é–“ / ä½œè€…èˆ‡ parent commitï¼Œå¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ git add .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git commit -m &lt;span class="s2">&amp;#34;init&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git remove .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git commit -m &lt;span class="s2">&amp;#34;delete&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit 8864a737bf54b251c878655c263dc9b1e16640e2 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> delete
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit ff226f74f095fd1acb5c965583688be28ad3bbb4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cat-file -p 8864a737bf54b251c878655c263dc9b1e16640e2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tree 4b825dc642cb6eb9a060e54bf8d69288fbee4904
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">parent ff226f74f095fd1acb5c965583688be28ad3bbb4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">author Yuanchieh &amp;lt;sj82516@gmail.com&amp;gt; &lt;span class="m">1654239635&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">committer Yuanchieh &amp;lt;sj82516@gmail.com&amp;gt; &lt;span class="m">1654239635&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">delete
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="sha-key-å¦‚ä½•é‹ç®—">SHA key å¦‚ä½•é‹ç®—&lt;/h3>
&lt;p>åœ¨æ–‡ä»¶æœ€å¾Œæœ‰è£œå……å¦‚ä½•è¨ˆç®— blob çš„ SHA keyï¼Œé€™é‚Šåƒè€ƒé¾å“¥æ•™å­¸Â ã€&lt;a class="link" href="https://gitbook.tw/chapters/using-git/how-to-calculate-the-sha1-value" target="_blank" rel="noopener"
>å†·çŸ¥è­˜ã€‘é‚£å€‹é•·å¾—å¾ˆåƒäº‚ç¢¼ SHA-1 æ˜¯æ€éº¼ç®—å‡ºä¾†çš„ï¼Ÿ&lt;/a>Â &lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¼•å…¥ SHA-1 è¨ˆç®—å‡½å¼åº«&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s2">&amp;#34;digest/sha1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¦è¨ˆç®—çš„å…§å®¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Hello, 5xRuby&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¨ˆç®—å…¬å¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">input&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;blob &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="se">\0&lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="no">Digest&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">SHA1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexdigest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¾—åˆ° &amp;#34;4135fc4add3332e25ab3cd5acabe1bd9ea0450fb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>ç¸½çµï¼šåœ¨ Git ä¸­æª”æ¡ˆèˆ‡ Commit éƒ½æ˜¯ä»¥æ¨¹ç‹€çµæ§‹å„²å­˜ï¼Œåªè¦ç¯€é»ä¸‹çš„å­ç¯€é»æœ‰è®Šå‹•ï¼Œå¾€ä¸Šä¸€è·¯åˆ°è·Ÿç¯€é»çš„ Hash key éƒ½æœƒè·Ÿè‘—æ”¹è®Šï¼Œé€é Mercle Tree å°±å¯ä»¥åœ¨ O(N) æ‰¾åˆ°è®Šå‹•çš„åœ°æ–¹&lt;/p>
&lt;/blockquote>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>åˆ·é¡Œæœ‰æ™‚å€™æœ‰è¶£çš„ä¸æ˜¯å–®ç´”ç­”æ¡ˆå¯«å‡ºä¾†ï¼Œè€Œæ˜¯çœ‹åˆ°è¨è«–å€æœ‰å„ç¨®ç‰›é¬¼è›‡ç¥çš„å¼·å¤§è§£æ³•ï¼Œè¨±å¤šè³‡æ–™çµæ§‹æˆ–æ¼”ç®—æ³•åœ¨æ—¥å¸¸çš„ç³»çµ±ä¸­éƒ½æ‰®æ¼”é‡è¦çš„è§’è‰²&lt;/p></description></item><item><title>ã€ç®—æ³•ã€‘Segment Tree èˆ‡ Binary Indexed Tree è§£é¡Œæ•´ç†</title><link>https://yuanchieh.page/posts/2022/2022-05-23-%E7%AE%97%E6%B3%95segment-tree-%E8%88%87-binary-indexed-tree-%E8%A7%A3%E9%A1%8C%E6%95%B4%E7%90%86/</link><pubDate>Mon, 23 May 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-05-23-%E7%AE%97%E6%B3%95segment-tree-%E8%88%87-binary-indexed-tree-%E8%A7%A3%E9%A1%8C%E6%95%B4%E7%90%86/</guid><description>&lt;p>ç•¶éœ€è¦åœ¨æŸä¸€é™£åˆ—ä¸­ï¼Œæ±‚æŸä¸€æ®µå€é–“çš„æ•¸å€¼å’Œæˆ–æ˜¯æœ€å°å€¼ï¼Œå¦‚æœæ˜¯éœæ…‹è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯é™£åˆ—å…§å®¹ä¸æœƒå†æ”¹è®Šï¼Œæˆ‘å€‘å¯ä»¥ç”¨ &lt;code>prefix sum&lt;/code> åœ¨ constant time å–å¾—çµæœ&lt;/p>
&lt;p>ä½†å¦‚æœé™£åˆ—çš„å€¼æœƒæ”¹è®Šï¼Œå°±éœ€è¦æ¯æ¬¡éƒ½é‡æ–°è¨ˆç®— prefix sumï¼Œæ­¤æ™‚çš„æ™‚é–“è¤‡é›œåº¦æœƒæ˜¯ O(N)ï¼Œæœ‰æ²’æœ‰æ›´å¿«çš„æ–¹æ³•å‘¢ï¼Ÿ&lt;/p>
&lt;p>é€™é‚Šæœ‰å…©å€‹ç›¸ä¼¼çš„æ¨¹ç‹€çµæ§‹ &lt;code>Segment Tree / Binary Indexed Tree&lt;/code> (åˆç¨± Fenwick Tree) å¯ä»¥ç”¨ &lt;code>O(logN)&lt;/code> è§£æ±ºå‹•æ…‹å€é–“å’Œçš„å•é¡Œï¼Œå…¶ä¸­ Segment Tree å¯ä»¥æ›´å»£æ³›è§£æ±ºå€é–“æ¥µå€¼çš„å•é¡Œ&lt;/p>
&lt;p>ç›¸é—œé¡Œç›®&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://leetcode.com/problems/range-sum-query-mutable/" target="_blank" rel="noopener"
>307. Range Sum Query - Mutable&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://leetcode.com/problems/range-sum-query-2d-mutable/" target="_blank" rel="noopener"
>308. Range Sum Query 2D - Mutable&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://leetcode.com/problems/count-of-smaller-numbers-after-self/" target="_blank" rel="noopener"
>315. Count of Smaller Numbers After Self&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://leetcode.com/problems/count-of-range-sum/" target="_blank" rel="noopener"
>327. Count of Range Sum&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="segment-tree">Segment Tree&lt;/h2>
&lt;p>æ•™å­¸å½±ç‰‡ï¼š&lt;a class="link" href="https://www.youtube.com/watch?v=xztU7lmDLv8" target="_blank" rel="noopener"
>Segment Tree Data Structure - Min Max Queries&lt;/a>&lt;/p>
&lt;p>Segment Tree èˆ‡ BIT çš„æ¦‚å¿µé›·åŒï¼ŒåŸæœ¬æˆ‘ç”¨ prefix sum é‡åˆ°æ›´æ–°æ™‚è¦ç”¨ O(n) æ•´å€‹é‡å»ºï¼Œä½†å¦‚æœæˆ‘æŠŠ&lt;code>å€é–“åˆ‡å°ï¼Œæ¯æ¬¡æ›´æ–°åªè¦å½±éŸ¿åˆ°éƒ¨åˆ†å€é–“&lt;/code>ï¼Œå°æ‡‰çš„è®€å–è¦ç¯©é¸ç¬¦åˆçš„å€é–“è®€å–ï¼Œå¦¥å”å¾Œ &lt;code>è®€å–èˆ‡æ›´æ–°éƒ½æ§åˆ¶åœ¨ log(N)&lt;/code>ï¼Œä½†å€é–“è©²æ€éº¼åˆ‡ä»¥åŠå¦‚ä½•å¯¦ä½œå‘¢ï¼Ÿ é€™å°±æ˜¯ Segment Tree èˆ‡ BIT ä¸åŒä¹‹è™•&lt;/p>
&lt;p>Segment Tree ç”¨é™£åˆ—å„²å­˜å€é–“å€¼ï¼Œéœ€è¦&lt;code>å…©å€é¡å¤–è¨˜æ†¶é«”ç©ºé–“&lt;/code>ï¼ŒåŸé™£åˆ—æ”¾åœ¨æ–°é™£åˆ—çš„æœ€å¾Œï¼Œæ¥è‘—å¾€å‰è·Ÿæ–°å€é–“ (parent = idx/2)ï¼Œå¦‚ä¸‹åœ– (å¾å½±ç‰‡æˆªåœ–è€Œä¾†)&lt;br>
&lt;img src="https://yuanchieh.page/post/2022/img/0522/segment_tree.png"
loading="lazy"
> &lt;br>
æ‰€ä»¥å€é–“æ˜¯ 2 -&amp;gt; 4 -&amp;gt; 8 é€™æ¨£å¾€ä¸Šç–ŠåŠ &lt;/p>
&lt;p>åˆå§‹åŒ–ç¨‹å¼ç¢¼ç‚º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SegmentTree&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">SegmentTree&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">offset_&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">offset_&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å…ˆæŠŠåŸé™£åˆ—æ”¾åœ¨æœ€å¾Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// parent = å·¦ child + å³ child
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">offset_&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="nf">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å› ç‚ºæœ‰ç§»å‹•ï¼Œæ‰€ä»¥è¦åŠ ä¸Š offset_
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">nodeIdx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">diff&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeIdx&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ›´æ–°æ™‚è¦æ›´æ–°å…¨éƒ¨çš„ parent
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nodeIdx&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeIdx&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">diff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeIdx&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€é &lt;code>O(N)&lt;/code> å³å¯å®Œæˆåˆå§‹åŒ–ï¼Œæˆ‘å€‘å°‡åŸé™£åˆ—æ”¾åœ¨æœ€å¾Œï¼Œä¸¦å¾€ä¸Šç–ŠåŠ å‡ºå¤šå€‹å€é–“ï¼ŒUpdate éœ€è¦ &lt;code>O(logN)&lt;/code>ï¼Œå› ç‚ºè¦å¾€å‰æŠŠç›¸é—œçš„å€é–“éƒ½è¦æ›´æ–°ä¸€æ¬¡&lt;/p>
&lt;p>æ¥è‘—é‡é»æ˜¯ range queryï¼Œå‚³å…¥ left / right (é–‰å€é–“) è¦åœ¨ &lt;code>O(logN)&lt;/code> è§£æ±ºï¼Œé‡é»ï¼Œ&lt;/p>
&lt;ul>
&lt;li>å¦‚æœæˆ‘å€‘æŸ¥æ‰¾çš„ç¯„åœæœƒæ¶µè“‹å®Œæ•´å€é–“ï¼Œå¾€ä¸Šæ‰¾å€é–“å€¼&lt;/li>
&lt;li>åä¹‹ï¼Œå‰‡å–å¾—ç•¶ä¸‹çš„å€¼ï¼Œä¸¦å¾€ä¸‹ä¸€å€‹å€é–“é‚é€²
&lt;img src="https://yuanchieh.page/post/2022/img/0522/segment_tree_explain.png"
loading="lazy"
>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">sumRange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">left&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">right&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">left&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nodeRightIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">right&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">nodeRightIndex&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æœæ˜¯å·¦æŒ‡é‡ï¼Œä¸”æŒ‡åˆ°å€é–“å³å´ï¼Œç•¶ä¸‹å–å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeLeftIndex&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeLeftIndex&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æœæ˜¯å³æŒ‡é‡ï¼Œä¸”æŒ‡åˆ°å€é–“å·¦å´ï¼Œç•¶ä¸‹å–å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">nodeRightIndex&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeRightIndex&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeRightIndex&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeRightIndex&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæƒ³è¦æŸ¥è©¢æ•´æ®µå€é–“çš„æŒ‡æ¨™ç§»å‹•ï¼Œæˆ‘å€‘å¯ä»¥è§€å¯Ÿå‡ºä¸€å€‹é‡é»&lt;/p>
&lt;blockquote>
&lt;p>å¶æ•¸ index éƒ½åœ¨å€é–“çš„å·¦å´ / å¥‡æ•¸ index æ˜¯åœ¨å€é–“çš„å³å´&lt;/p>
&lt;/blockquote>
&lt;p>å› ç‚ºæˆ‘å€‘æ˜¯ç”¨ left / right å»æ‰¾å€é–“å’Œï¼Œæ‰€ä»¥æˆ‘å€‘è¦æ‰¾&lt;code>left å¾€å³æ‰¾èˆ‡ right å¾€å·¦æ‰¾çš„å…±åŒå€é–“&lt;/code>ï¼Œç¸½å…±åˆ†æˆ 4 ç¨®æƒ…æ³è€ƒæ…®&lt;/p>
&lt;ol>
&lt;li>left æŒ‡å‘å¶æ•¸ï¼š&lt;br>
ä»£è¡¨æˆ‘å€‘æœƒ&lt;code>æ‹¿æ•´å€‹å€é–“&lt;/code>ï¼Œå› ç‚ºå€é–“çš„å·¦å´æ˜¯å¶æ•¸ï¼Œç•¶ç›®å‰ left å°±æŒ‡å‘å¶æ•¸ï¼Œä»£è¡¨è¦å–å‡ºæ•´å€‹å€é–“&lt;/li>
&lt;li>left æŒ‡å‘å¥‡æ•¸ï¼š&lt;br>
ä»£è¡¨æˆ‘å€‘&lt;code>ä¸å¯ä»¥æ‹¿å€é–“ç•¶ä½œä»£è¡¨ï¼Œå› ç‚ºå¥‡æ•¸æ˜¯å€é–“çš„å³å´&lt;/code>ï¼Œå†å¾€ä¸‹å°±åˆ°å¦ä¸€å€‹å€é–“ï¼Œæ‰€ä»¥æˆ‘å€‘è¦ç›´æ¥å–å€¼&lt;/li>
&lt;li>right æŒ‡å‘å¶æ•¸ï¼š &lt;br>
right è·Ÿ left é‚è¼¯å‰›å¥½ç›¸åï¼Œæˆ‘å€‘&lt;code>åªèƒ½æ‹¿ right å¾€å·¦çš„å€é–“ï¼Œå› ç‚ºå¶æ•¸æ˜¯ parent å·¦å´&lt;/code>ï¼Œå†å¾€ä¸‹ç§»å°±åˆ°ä¸‹å€‹å€é–“ï¼Œæ‰€ä»¥è¦æ‹¿ç•¶å‰å€¼&lt;/li>
&lt;li>right æŒ‡å‘å¥‡æ•¸ï¼š&lt;br>
å› ç‚º&lt;code>å¥‡æ•¸æ˜¯å€é–“çš„å³å´&lt;/code>ï¼Œä»£è¡¨æˆ‘å€‘å¯ä»¥æ‹¿æ•´å€‹å€é–“ç‚ºç•¶å‰å€¼&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šåœ–ç‚ºä¾‹&lt;/p>
&lt;ol>
&lt;li>å·¦æŒ‡é‡æŒ‡å‘ -2ï¼Œæ­¤æ™‚æ˜¯å€é–“çš„å³å´ï¼Œç¬¦åˆæ¢ä»¶ 2ï¼Œæ‹¿å®Œ -2 å¾€ä¸‹ä¸€å€‹å€é–“èµ° / å³æŒ‡é‡åªåœ¨å€é–“å³å´ç¬¦åˆæ¢ä»¶4ï¼Œå¾€ä¸Šä¸€å€‹å€é–“&lt;/li>
&lt;li>å·¦æŒ‡é‡æŒçºŒæŒ‡å‘å€é–“å·¦å´ç¬¦åˆæ¢ä»¶1ã€å³æŒ‡é‡æŒ‡å‘å€é–“å³å´ç¬¦åˆæ¢ä»¶4ï¼Œä¸€è·¯å¾€ä¸ŠæŒ‡åˆ°åŒä¸€å€‹å€å¡Šï¼Œç›´æ¥æ‹¿å®Œæ•´æ®µå€é–“ (8~-5)&lt;/li>
&lt;/ol>
&lt;p>å½±ç‰‡åƒè€ƒè³‡æ–™æ˜¯å·¦é–‰å³é–‹çš„è¨ˆç®—æ–¹å¼ï¼Œä½†é€™æ¨£æˆ‘è¦ºå¾—å†å–å‡ºå€é–“å’Œæ¯”è¼ƒä¸å¥½åšï¼Œæ‰€ä»¥åƒè€ƒ leetcode è§£ç­”èª¿æ•´æˆç›®å‰çš„é–‰å€é–“ç®—æ³•&lt;/p>
&lt;h3 id="307-range-sum-query---mutable-å®Œæ•´è§£æ³•">307. Range Sum Query - Mutable å®Œæ•´è§£æ³•&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SegmentTree&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">SegmentTree&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">offset_&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">offset_&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">offset_&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="nf">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nodeIdx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">diff&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeIdx&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nodeIdx&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeIdx&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">diff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeIdx&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">sumRange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">left&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">right&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">left&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nodeRightIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">right&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">nodeRightIndex&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeLeftIndex&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeLeftIndex&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">nodeRightIndex&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">nodeRightIndex&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeRightIndex&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeLeftIndex&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodeRightIndex&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">offset_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">nodes_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">NumArray&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NumArray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tree_&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SegmentTree&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nums&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="nf">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tree_&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">sumRange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">left&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">right&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">tree_&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sumRange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">right&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">SegmentTree&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">tree_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Your NumArray object will be instantiated and called as such:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * NumArray* obj = new NumArray(nums);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * obj-&amp;gt;update(index,val);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * int param_2 = obj-&amp;gt;sumRange(left,right);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="binary-index-tree">Binary Index Tree&lt;/h2>
&lt;p>1994 å¹´çš„è«–æ–‡ &lt;a class="link" href="https://citeseerx.ist.psu.edu/viewdoc/download;jsessionid=B6DEEDCB6E5C3DE95856CE6E24EB8C53?doi=10.1.1.14.8917&amp;amp;rep=rep1&amp;amp;type=pdf" target="_blank" rel="noopener"
>A New Data Structure for Cumulative
Frequency Tables&lt;/a> / æˆ‘è¦ºå¾—è¬›å¾—å¾ˆå¥½çš„å½±ç‰‡ &lt;a class="link" href="https://www.youtube.com/watch?v=uSFzHCZ4E-8" target="_blank" rel="noopener"
>Fenwick Tree (Binary Index Tree) - Quick Tutorial and Source Code Explanation&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0522/bit.png"
loading="lazy"
>
é€™å¼µåœ–æ˜¯å¾è«–æ–‡æˆªåœ–è€Œä¾†ï¼Œå¯¦ä½œæŠ€å·§éå¸¸å·§å¦™ï¼Œä»–åˆ©ç”¨ &lt;code>Last Significant Bit (LSB) ä¾†æ±ºå®šå€é–“çš„ç¯„åœ&lt;/code>ï¼Œå¦‚æœ LSB æ˜¯ xxx1ï¼Œå‰‡åªå„²å­˜ç•¶å‰ä¸€å€‹æ•¸ï¼Œå¦‚æœ LSB æ˜¯ xx10ï¼Œå‰‡å„²å­˜ç•¶å‰å…©å€‹æ•¸ï¼Œä»¥æ­¤é¡æ¨ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ° &lt;code>1, 3 ç­‰åªæœƒå„²å­˜ç•¶å‰ 1 å€‹æ•¸ã€8 æœƒå„²å­˜å¾€å‰ 8 å€‹æ•¸&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0522/bit_update.png"
loading="lazy"
>
æ‰€ä»¥æ›´æ–°æ™‚æœƒéœ€è¦æ›´æ–°æ‰€æœ‰ç›¸é—œå€é–“ï¼Œä¸Šé¢é€™å¼µåœ–æ˜¯ä»£è¡¨ç•¶ä½ æ›´æ–° index i æ™‚ï¼Œéœ€è¦å¾€ä¸Šèª¿æ•´çš„ bit indexï¼Œä¾‹å¦‚æ›´æ–° idx 1 æ™‚ï¼Œå› ç‚º bit[2]ã€bit[4]ã€bit[8] éƒ½æœ‰åŒ…å« idx 1ï¼Œæ‰€ä»¥éƒ½è¦ä¸€ä½µæ›´æ–°&lt;/p>
&lt;p>å¯¦ä½œæ–¹é¢éå¸¸ç°¡å–®ï¼Œé€é &lt;code>2 è£œæ•¸ i &amp;amp; -i å³å¯å–å¾— LSB&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 1: 0001
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//-1: 1111
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 1 &amp;amp; -1 =&amp;gt; 0001
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 6: 0110
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//-6: 1010
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 6 &amp;amp; -6 =&amp;gt; 0010
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">getParent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è®“æˆ‘å€‘çœ‹æŸ¥è©¢æœƒè®Šå¾—å¦‚ä½•ï¼š
&lt;img src="https://yuanchieh.page/post/2022/img/0522/bit_iterate.png"
loading="lazy"
>
åœ–ç‰‡è¡¨é”å¦‚æœä½ è¦æŸå€‹ prefix sumï¼Œä½ å¿…é ˆå¾€å‰è¼ªè©¢çš„ indexï¼Œä¾‹å¦‚è¦æ‰¾ idx 1~9 çš„ prefix sumï¼Œå‰‡éœ€è¦ &lt;code>bit[9] + bit[8]&lt;/code>ï¼Œæ­é…ä¸Šä¸€å¼µåœ– bit[9] åªæœ‰å„²å­˜ idx 9 é€™å€‹å…ƒç´ ï¼Œè€Œ bit[8] å„²å­˜äº† idx 1-8 å€‹å…ƒç´ &lt;/p>
&lt;p>å¯¦ä½œæ–¹é¢åŒæ¨£é€é 2 è£œæ•¸ï¼Œåªæ˜¯è®Šæˆå¾€ä¸‹æ¸›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">getNextInterval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ•´é«”å¯¦ä½œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">BIT&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BIT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// index å¾ 1 é–‹å§‹æ¯”è¼ƒå¥½è¨ˆç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">bit_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">arr_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆå§‹åŒ–åªè¦å¾€ä¸‹ä¸€å€‹ parent åŠ 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¾Œé¢ iterate æœƒç–Šä¸Šå»
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">bitIdx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bit_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">bitIdx&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">arr_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getParent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bitIdx&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">bit_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bit_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">bit_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">bitIdx&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="nf">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">diff&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">arr_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">arr_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ›´æ–°è¨˜å¾—è¦å…¨éƒ¨åŒ…å«çš„å€é–“éƒ½æ›´æ–°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">bit_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bit_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">diff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getParent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">prefixSum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å–å€¼è¦å¾€å‰æ¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">bit_&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getNextInterval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">bit_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">arr_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getParent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getNextInterval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">NumArray&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NumArray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tree_&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BIT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nums&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="nf">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tree_&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">sumRange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">left&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">right&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">tree_&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">prefixSum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">tree_&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">prefixSum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BIT&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">tree_&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å°çµbit-vs-segment-tree">å°çµï¼šBIT vs Segment Tree&lt;/h3>
&lt;p>æ•´ç†ä¸€ä¸‹å…©è€…&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ¯”è¼ƒ&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>æ“ä½œ&lt;/td>
&lt;td>Segment Tree&lt;/td>
&lt;td>Binary Index Tree&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>è¨˜æ†¶é«”ç©ºé–“&lt;/td>
&lt;td>2 * n&lt;/td>
&lt;td>n&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>åˆå§‹åŒ–&lt;/td>
&lt;td>O(n)&lt;/td>
&lt;td>O(n)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æŸ¥è©¢&lt;/td>
&lt;td>O(logN)&lt;/td>
&lt;td>O(logN)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ›´æ–°&lt;/td>
&lt;td>O(logN)&lt;/td>
&lt;td>O(logN)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ­¤å¤–ï¼Œä½¿ç”¨ä¸Šå…©è€…æœ‰å…±åŒä¾·é™ &lt;code>æ–°å¢ / ç§»é™¤å…ƒç´ éœ€è¦é‡æ–°åˆå§‹åŒ–&lt;/code>&lt;/p>
&lt;h4 id="å…©è€…å·®ç•°">å…©è€…å·®ç•°&lt;/h4>
&lt;p>å…©è€…éƒ½å¯ä»¥è§£æ±º #307 é€™é“é¡Œç›®ï¼Œä½†çœ‹ä¼¼ç›¸åŒä½†é‚„æ˜¯æœ‰å·®ç•°ä¹‹è™•ï¼Œç°¡å–®ä¾†èªª &lt;code>Segment Tree ç”¨é€”æ›´å»£ï¼ŒBIT åªèƒ½è§£æ±º Prefix Sum è¨ˆç®—&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚ Segment Tree é‚„å¯ä»¥è§£æ±º&lt;code>å€é–“æœ€å°å€¼/å€é–“æœ€å¤§å€¼&lt;/code>ï¼Œè€Œ BIT æ˜¯åšä¸åˆ°çš„ï¼Œç‚ºä»€éº¼ï¼Ÿ&lt;/p>
&lt;p>å› ç‚º BIT ä¸¦ä¸æ˜¯å„²å­˜æ¯ä¸€å€‹å€¼ï¼Œè€Œæ˜¯åœ¨åˆå§‹åŒ–å°±ä»¥å€é–“çš„å½¢å¼ä¿å­˜ï¼Œå¦‚æœæ˜¯&lt;code>åŠ æ³•é€™ç¨® invertible ç®—æ³•&lt;/code>ï¼Œæ„å³æˆ‘å€é–“å„²å­˜ (a+b), æˆ‘å¯ä»¥é€é (a+b) - a é‚„åŸ b çš„å€¼ï¼›&lt;br>
ä½†æ±‚æ¥µå€¼æ˜¯ non invertableï¼Œå¦‚æœè¦ç”¨ BIT æ±‚æ¥µå€¼ï¼Œé‚£éº¼åœ¨å€é–“è¨ˆç®—æ™‚å°±ç”¨å„²å­˜æ¥µå€¼ï¼Œé€™æ¨£æ›´æ–°æ™‚å°±æœƒå‡ºéŒ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">åŸé™£åˆ—ï¼š[3, 2]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BIT: [, 3, 3(ä¿å­˜å€é–“æ¥µå€¼)]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update (0, 1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BIT: [, 1, ?] =&amp;gt; ç„¡æ³•è¨ˆç®—
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥ BIT ç”¨é€”æ¯”è¼ƒä¾·é™ï¼Œä½†å„ªé»æ˜¯è¨˜æ†¶é«”ç©ºé–“å°ï¼Œè€Œä¸” bitwise çš„è¨ˆç®—é€Ÿåº¦æœƒå¿«æ›´å¤š&lt;/p>
&lt;p>æœ‰ä¸€ç¯‡è«–æ–‡å¯«å¯ä»¥ç”¨å…©å€‹ BIT å¯¦ä½œå€é–“æ¥µå€¼çš„æŸ¥è©¢ï¼Œçµæœé‚„æ˜¯æ¯” Segment Tree å¿«ä¸Šè¨±å¤šï¼Œå¯ä»¥åƒè€ƒçœ‹çœ‹ &lt;a class="link" href="https://www.researchgate.net/profile/Mircea-Dima/publication/282222122_Efficient_Range_Minimum_Queries_using_Binary_Indexed_Trees/links/5d5ba500299bf1b97cf7961a/Efficient-Range-Minimum-Queries-using-Binary-Indexed-Trees.pdf?origin=publication_detail" target="_blank" rel="noopener"
>Efficient Range Minimum Queries - using Binary Indexed Trees&lt;/a>&lt;/p></description></item><item><title>ã€MySQLã€‘Lock èˆ‡ Index é—œä¿‚å’Œ Deadlock åˆ†æ</title><link>https://yuanchieh.page/posts/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/</link><pubDate>Mon, 25 Apr 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/</guid><description>&lt;p>é—œæ–¼ MySQL Lock ä¾†ä¾†å›å›å¯«äº†ä¹Ÿæœ‰å¹¾ç¯‡ï¼Œæ¯æ¬¡çœ‹éƒ½æœ‰ä¸åŒçš„ç™¼ç¾ï¼Œé€™æ¬¡ç‚ºäº†æº–å‚™å…¬å¸å…§éƒ¨åˆ†äº«ï¼Œé‡æ–°å†ç¿»é–±ä¸€æ¬¡åˆæ‰¾åˆ°ä¸€äº›æ–°çš„æœ‰è¶£ç™¼ç¾ï¼Œä»¥ä¸‹å°‡ç›¡å¯èƒ½å®Œæ•´çš„è§£æ MySQL Lock èˆ‡ Index çš„é—œä¿‚ï¼Œæ€æ¨£çš„æŸ¥è©¢æœƒæ‹¿åˆ°æ€æ¨£çš„é–ï¼Œä»¥åŠæ€æ¨£çš„æŸ¥è©¢åˆå¯èƒ½äº’ç›¸ Deadlock&lt;/p>
&lt;p>æ–‡ç« ä¸»è¦å—å•Ÿç™¼æ–¼ &lt;a class="link" href="https://www.aneasystone.com/archives/2018/04/solving-dead-locks-four.html" target="_blank" rel="noopener"
>è§£å†³æ­»é”ä¹‹è·¯ï¼ˆç»ˆç»“ç¯‡ï¼‰ - å†è§æ­»é”&lt;/a>ï¼Œå°æ‡‰çš„å¯¦é©—å¯ä»¥çœ‹ç¨‹å¼ç¢¼ &lt;a class="link" href="https://github.com/sj82516/mysql-deadlock-test" target="_blank" rel="noopener"
>sj82516/mysql-deadlock-test&lt;/a>ï¼Œå…ˆèªªçµè«–ï¼Œ&lt;code>åœ¨ DML (æ›´æ–°ã€åˆªé™¤ã€æ’å…¥)çš„æ“ä½œä¸­ï¼ŒLock æœƒèˆ‡å¥—ç”¨çš„ Index æœ‰é—œ&lt;/code>ï¼Œåœ¨ MySQL ä¸­ Index æœ‰å¹¾ç¨®&lt;/p>
&lt;ol>
&lt;li>Clustered Index:&lt;br>
é€šå¸¸æ˜¯ Primary Key&lt;/li>
&lt;li>Unique Secondary Index:&lt;br>
å¦‚æœæ²’æœ‰ Primary Keyï¼Œå‰‡ Unique Secondary Index æœƒæ˜¯ Clustered Indexï¼Œè¡Œç‚ºèˆ‡ Clustered Index é›·åŒï¼Œä¸é¡å¤–è´…è¿°&lt;/li>
&lt;li>Non Unique Secondary Index&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹å°‡é‡é»åˆ†æ Clustered Index / Non Unique Secondary Index å°æ–¼ MySQL æ“ä½œæœ‰ä»€éº¼ä¸åŒçš„å½±éŸ¿ï¼Œåœ¨ Read Committed ç°¡ç¨± RC) èˆ‡ Repeatable Read (ç°¡ç¨± RR) ä¸‹åˆæœ‰æ€æ¨£çš„ä¸åŒè¡Œç‚ºï¼Œå¯¦é©—é è¨­æ˜¯ 5.7 + Repeatable Read (MySQL é è¨­)&lt;/p>
&lt;h2 id="clustered-index">Clustered Index&lt;/h2>
&lt;p>å…ˆä¾†ä¸€é¡Œç°¡å–®çš„æš–èº«é¡Œï¼Œä»¥ä¸‹å…©å€‹ Transaction ç‚ºä»€éº¼æœƒ Deadlock
&lt;img src="https://yuanchieh.page/post/2022/img/0425/01.png"
loading="lazy"
>
è¦æ»¿è¶³ Deadlock éœ€è¦æœ‰å››å€‹æ¢ä»¶&lt;/p>
&lt;ul>
&lt;li>no preemption&lt;/li>
&lt;li>hold and wait&lt;/li>
&lt;li>mutual exclusion&lt;/li>
&lt;li>circular waiting&lt;/li>
&lt;/ul>
&lt;p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼ŒMySQL åœ¨ RR ä¸‹è¦ update æœƒå…ˆå–å¾— exclusive lockï¼Œå…©å€‹ Transaction æ‰‹ä¸Šéƒ½æ‹¿äº†å°æ–¹æƒ³è¦çš„è³‡æºå»ä¹Ÿä¸éƒ½æœƒå…ˆæ”¾é–‹æ‰‹ä¸Šçš„é–ï¼Œå°è‡´ Deadlock
&lt;img src="https://yuanchieh.page/post/2022/img/0425/01_2.png"
loading="lazy"
>&lt;/p>
&lt;p>ç›´æ¥å¾åœ–ç‰‡å¾ˆå®¹æ˜“çœ‹å‡ºå½¼æ­¤ Deadlockï¼Œä½†æ­£å¼ç’°å¢ƒä¸­å¤šç­† Transaction äº¤é›œï¼Œè©²å¦‚ä½•æ‰¾å‡º Deadlock å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="1-å¦‚ä½•-debug-deadlock">1. å¦‚ä½• Debug Deadlock&lt;/h3>
&lt;p>MySQL æœ‰å¹¾å€‹ç›¸é—œåƒæ•¸&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_deadlock_detect" target="_blank" rel="noopener"
>innodb_deadlock_detect&lt;/a>: æ˜¯å¦åµæ¸¬ deadlockï¼Œé è¨­é–‹å•Ÿ&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_lock_wait_timeout" target="_blank" rel="noopener"
>innodb_lock_wait_timeout&lt;/a>: å¦‚æœæ²’æœ‰é–‹å•Ÿ Deadlock detectï¼Œå»ºè­°è¨­å®šè¼ƒçŸ­çš„ wait timeout å¦å‰‡æœƒä¸€ç›´ç­‰åˆ°&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_print_all_deadlocks" target="_blank" rel="noopener"
>innodb_print_all_deadlocks&lt;/a>: å°‡æ‰€æœ‰ Deadlock éŒ¯èª¤è¼¸å‡ºè‡³ error log&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæ²’æœ‰è¼¸å‡º Deadlock errorï¼Œå¯ä»¥ç”¨ &lt;code>&amp;gt; SHOW ENGINE INNODB STATUS&lt;/code> è¼¸å‡ºï¼Œå…¶ä¸­æœ‰å…©å€‹å€å¡Š deadlock é¡¯ç¤ºæœ€è¿‘ä¸€ç­† deadlock éŒ¯èª¤ï¼Œtransaction å‰‡æœƒé¡¯ç¤ºç›®å‰åœ¨ç­‰å¾… lock çš„ transaction&lt;/p>
&lt;h4 id="11-å¯¦éš›é–±è®€-deadlock">1.1 å¯¦éš›é–±è®€ Deadlock&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">LATEST DETECTED DEADLOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-04-26 09:33:29 0x40de5bc700
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (1) TRANSACTION:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TRANSACTION 9597, ACTIVE 3 sec starting index read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql tables in use 1, locked 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MySQL thread id 1034, OS thread handle 278338676480, query id 14980 172.17.0.1 root updating
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb">`UPDATE teachers SET teachers.age = 10 WHERE teachers.id = 5`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (1) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9597 lock_mode X locks rec but not gap waiting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex 8000000000000005; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 00000000257c; asc %|;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 23000001c017d1; asc # ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 1; hex 62; asc b;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 80000010; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: SQL NULL;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) TRANSACTION:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TRANSACTION 9596, ACTIVE 3 sec starting index read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql tables in use 1, locked 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MySQL thread id 1033, OS thread handle 278608463616, query id 14979 172.17.0.1 root updating
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb">`UPDATE teachers SET teachers.age = 6 WHERE teachers.id = 1`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) HOLDS THE LOCK(S):
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 lock_mode X locks rec but not gap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex 8000000000000005; asc ;; -&amp;gt; indexï¼Œç”¨ 16 é€²ä½è¡¨ç¤ºï¼Œé€™é‚Šæ˜¯æŒ‡ id: 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 00000000257c; asc %|;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 23000001c017d1; asc # ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 1; hex 62; asc b;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 80000010; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: SQL NULL;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 &lt;span class="sb">`lock_mode X locks rec but not gap waiting`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex 8000000000000001; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 00000000257d; asc %};;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 22000001cc02e5; asc &amp;#34; ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 1; hex 61; asc a;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 8000000f; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: SQL NULL;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* WE ROLL BACK TRANSACTION (2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™éƒ¨åˆ†å…§å®¹åƒè€ƒ &lt;a class="link" href="https://juejin.cn/post/6844903943516979213" target="_blank" rel="noopener"
>MySQLæ­»é”é—®é¢˜å¦‚ä½•åˆ†æ&lt;/a>ï¼Œé‡é»çœ‹é€™ä¸€æ®µ&lt;/p>
&lt;blockquote>
&lt;p>RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 lock_mode X locks rec but not gap waiting &lt;code>å°ˆæŒ‡ row lock&lt;/code>&lt;br>
Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
0: len 8; hex 8000000000000001; asc ;; &lt;code>-&amp;gt; indexï¼Œç”¨ 16 é€²ä½è¡¨ç¤ºï¼Œé€™é‚Šæ˜¯æŒ‡ id: 1&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>ï¼Œæˆ‘å€‘å¯ä»¥å¾ log ä¸­çœ‹å‡ºæ“ä½œ / æ‰‹ä¸Šçš„ lock / ç­‰å¾…çš„ lock / &lt;code>Lock åœ¨å“ªä¸€å€‹ row&lt;/code>&lt;/p>
&lt;h3 id="2-å–å¾—-lock-çš„é †åºæ€§">2. å–å¾— Lock çš„é †åºæ€§&lt;/h3>
&lt;p>å¦‚æœæŸ¥è©¢çš„æ¢ä»¶å‘½ä¸­å¤šç­†ï¼Œé‚£ Lock æœƒæ€éº¼å–å¾—å‘¢ï¼Ÿ æ¥è‘—çœ‹ä»¥ä¸‹æ¡ˆä¾‹
&lt;img src="https://yuanchieh.page/post/2022/img/0425/02.png"
loading="lazy"
>&lt;/p>
&lt;p>æ ¹æ“š &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/update.html" target="_blank" rel="noopener"
>MySQL æ–‡ä»¶&lt;/a>ï¼Œæœƒæ ¹æ“š Order By çš„æŒ‡å®šæ¢ä»¶èˆ‡ Index æœ¬èº«é †åºæ€§ä¸€è¡Œä¸€è¡Œé–èµ·ä¾†&lt;/p>
&lt;blockquote>
&lt;p>If an UPDATE statement includes an ORDER BY clause, the rows &lt;code>are updated in the order specified by the clause&lt;/code>. This can be useful in certain situations that might otherwise result in an error. Suppose that a table t contains a column id that has a unique index. The following statement could fail with a duplicate-key error, depending on the order in which rows are updated&lt;/p>
&lt;/blockquote>
&lt;p>å¾ Deadlock Log å¯ä»¥æ¸…æ¥šçœ‹åˆ° id 2 / id 5 è¢«äº’ç›¸é–ä½&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 278 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9676 lock_mode X waiting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex &lt;span class="sb">`8000000000000002`&lt;/span>; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 278 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9675 lock_mode X waiting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex &lt;span class="sb">`8000000000000005`&lt;/span>; asc ;;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="21-å»ºç«‹-index-æ™‚æ±ºå®šé †åº">2.1 å»ºç«‹ Index æ™‚æ±ºå®šé †åº&lt;/h4>
&lt;p>ç•¶&lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/create-index.html" target="_blank" rel="noopener"
>å»ºç«‹ MySQL Index&lt;/a> ä¹Ÿå¯ä»¥æŒ‡å®šé †åºï¼Œä½†éœ€è¦æ³¨æ„ MySQL 5.7 æœƒå¿½è¦– (å…¨éƒ¨éƒ½æ˜¯ asc) åªæœ‰åœ¨ MySQL 8.0 ä»¥ä¸Šæ‰æ”¯æ´ï¼Œæ‰€ä»¥ä»¥ä¸‹æ¡ˆä¾‹åªç™¼ç”Ÿåœ¨ MySQL 8.0&lt;/p>
&lt;p>æˆ‘å€‘å¯ä»¥é€é &lt;code>USE INDEX()&lt;/code> æŒ‡å®šåŸ·è¡Œæ™‚çš„ Index
&lt;img src="https://yuanchieh.page/post/2022/img/0425/02_01.png"
loading="lazy"
>&lt;/p>
&lt;blockquote>
&lt;p>(5.7 æ–‡ä»¶) A key_part specification can end with ASC or DESC. These keywords are permitted for future extensions for specifying ascending or descending index value storage. Currently, they &lt;code>are parsed but ignored&lt;/code>; index values are always stored in ascending order.&lt;/p>
&lt;/blockquote>
&lt;h4 id="22-æ°å·§å…©å€‹-index-é †åºç›¸ä»¿">2.2 æ°å·§å…©å€‹ Index é †åºç›¸ä»¿&lt;/h4>
&lt;p>2.1 æ¡ˆä¾‹ä¸­æˆ‘å€‘å¾ˆåˆ»æ„è®“ Index åŒä¸€å€‹æ¬„ä½æ¬„ä½ä½†é †åºå‰›å¥½ç›¸åï¼Œä½†å¦‚æœæ˜¯å…©å€‹ä¸åŒ Index è€Œè³‡æ–™å¯«å…¥æ™‚è®“é †åºæ°å¥½ç›¸åå‘¢ï¼Ÿ
åœ¨å»ºç«‹è³‡æ–™æ™‚ï¼Œid è·Ÿ name çš„é †åºå‰›å¥½ç›¸åï¼Œä¹Ÿå°±æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">id1 &amp;gt; id2 &lt;span class="err">&amp;amp;&amp;amp;&lt;/span> name1 &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nt">name2&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="na">ä¾‹å¦‚&lt;/span> &lt;span class="err">(&lt;/span>&lt;span class="na">1&lt;/span>&lt;span class="err">,&lt;/span> &lt;span class="err">&amp;#34;&lt;/span>&lt;span class="na">zz&lt;/span>&lt;span class="err">&amp;#34;)&lt;/span> &lt;span class="err">(&lt;/span>&lt;span class="na">2&lt;/span>&lt;span class="err">,&lt;/span> &lt;span class="err">&amp;#34;&lt;/span>&lt;span class="na">zx&lt;/span>&lt;span class="err">&amp;#34;)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£ä¹Ÿæœƒç™¼ç”Ÿ Deadlock!&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0425/02_02.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="3-æŸ¥è©¢æ²’æœ‰å‘½ä¸­--gap-lock">3. æŸ¥è©¢æ²’æœ‰å‘½ä¸­ : Gap Lock&lt;/h3>
&lt;p>å¦‚æœæŸ¥è©¢æ²’æœ‰å‘½ä¸­ï¼Œæ­¤æ™‚ MySQL åœ¨ RR æƒ…æ³ä¸‹æœƒå–å¾— Gap Lockï¼Œæ‰€è¬‚çš„ Gap æ˜¯åœ¨å·²å­˜åœ¨æ¬„ä½ä¹‹é–“çš„ç¸«éš™ï¼Œç‚ºäº†é¿å…å¹»è®€ MySQL æœƒé–ä½ Gap ä¸è®“å…¶ä»– Transaction æ’å…¥è³‡æ–™&lt;/p>
&lt;p>é€™é‚Šç‰¹åˆ¥ä»‹ç´¹å…©å€‹é–å®šå€é–“çš„ Lockï¼Œåˆ†åˆ¥æ˜¯ Gap Lock / Insert Intention Lock&lt;/p>
&lt;ol>
&lt;li>Insert Intention Lock æ•…åæ€ç¾©æ˜¯æ˜¯æ’å…¥å‰æœƒé–å®šè©²å€é–“&lt;/li>
&lt;li>é€™å…©ç¨® Lock ç‰¹åˆ¥åœ¨æ–¼ä¸æœƒæ’æ“ è‡ªå·±äººï¼Œä¾‹å¦‚ &lt;code>Gap Lock ä¸æœƒé˜»æ“‹ Gap Lock&lt;/code> / &lt;code>Insert Intention Lock ä¸æœƒé˜»æ“‹ Insert intention Lock&lt;/code>ï¼Œä½†æ˜¯ &lt;code>Insert Intention Lock è·Ÿ Gap Lock äº’æ–¥&lt;/code>ï¼ŒåŸå› æ˜¯å€é–“å¯èƒ½å¾ˆå¤§ï¼Œç‚ºäº†æå‡æ€§èƒ½ï¼Œåœ¨åŒä¸€å€‹å€é–“å¯ä»¥åŒæ™‚æ’å…¥æ–°è³‡æ–™ï¼Œå¦‚æœçœŸçš„æœ‰é•å Unique Key å‰‡æœƒæœ‰åŸæœ¬çš„é‡è¤‡æ€§æª¢æŸ¥é˜»æ“‹ï¼ŒUpdate ä¹Ÿæ˜¯&lt;/li>
&lt;/ol>
&lt;p>æœ‰ä¸€å€‹å ´æ™¯æ˜¯ã€Œæˆ‘å€‘å¸Œæœ›æ›´æ–°æŸä¸€ç­†è³‡æ–™ï¼Œç™¼ç¾è³‡æ–™ä¸åœ¨å‰‡å¯«å…¥ã€ï¼Œå¦‚ä»¥ä¸‹ç¯„ä¾‹å‰‡æœƒé€ æˆ Deadlock
&lt;img src="https://yuanchieh.page/post/2022/img/0425/03.png"
loading="lazy"
>&lt;/p>
&lt;p>å› ç‚º id 6 / 10 åœ¨ update æ™‚éƒ½å–å¾—äº† Gap Lockï¼Œæ¥è‘—è¦ Insert å–å¾— Insert Intention Lock å»å› ç‚ºé›™æ–¹éƒ½é‚„æ¡æœ‰ Gap Lock è€Œç„¡æ³•å¯«å…¥ï¼Œè®“æˆ‘å€‘çœ‹å…·é«”çš„ Deadlock ç´°ç¯€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9700 &lt;span class="sb">`lock_mode X insert intention waiting`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex 73757072656d756d; asc &lt;span class="sb">`supremum`&lt;/span>;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) HOLDS THE LOCK(S):
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9699 &lt;span class="sb">`lock_mode X`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex 73757072656d756d; asc &lt;span class="sb">`supremum`&lt;/span>;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9699 lock_mode X insert intention waiting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 8; hex 73757072656d756d; asc supremum;;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°é›™æ–¹éƒ½åœ¨ç­‰ &lt;code>lock_mode X insert intention waiting&lt;/code>ï¼ŒæŒ‡å®šçš„ row æ˜¯ &lt;code>supermum&lt;/code> é€™æ˜¯ä»£è¡¨æœ€å¾Œä¸€å€‹å€é–“ï¼Œå€é–“å¤§è‡´é•·ä»¥ä¸‹é€™èˆ¬&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">(negative infinity, ç¬¬ä¸€ç­†]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">(ç¬¬ä¸€ç­†, ç¬¬äºŒç­†]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">(æœ€å¾Œä¸€ç­†, positive infinity)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥åŒæ¨£çš„ query åªæ˜¯åŸå§‹è³‡æ–™æ”¹è®Šè½åœ¨ä¸åŒå€é–“ï¼Œå°±ä¸æœƒæœ‰ Deadlock å¦‚ä»¥ä¸‹
&lt;img src="https://yuanchieh.page/post/2022/img/0425/03_01.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="4-ç¯„åœæŸ¥è©¢é–å®šæ‰¾éçš„æ¯ç­†è³‡æ–™å³ä½¿æ¢ä»¶ä¸åˆ">4. ç¯„åœæŸ¥è©¢ï¼šé–å®šæ‰¾éçš„æ¯ç­†è³‡æ–™å³ä½¿æ¢ä»¶ä¸åˆ&lt;/h3>
&lt;p>æ¥ä¸‹ä¾†çœ‹ä¸€å€‹ RR è »åš‡äººçš„ä¸€å€‹ç‰¹æ€§ï¼Œåƒè€ƒæ–‡ä»¶ &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener"
>15.7.2.1 Transaction Isolation Levels&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;When using the default REPEATABLE READ isolation level, the first UPDATE acquires an x-lock on each row that it reads and &lt;code>does not release any of them&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯èªª where condition å‡ä½¿æ˜¯ç¯„åœæœå°‹ï¼ŒRR æœƒæŠŠæœå°‹åˆ°çš„ç¯„åœå…¨éƒ¨é–æ­»ï¼Œç›´åˆ° transaction çµæŸ!&lt;/p>
&lt;p>è®“æˆ‘å€‘çœ‹ä»¥ä¸‹æ¡ˆä¾‹
&lt;img src="https://yuanchieh.page/post/2022/img/0425/04.png"
loading="lazy"
>&lt;/p>
&lt;p>Update çš„æ¢ä»¶æ²’æœ‰å‘½ä¸­ä½†æ˜¯&lt;code>å…¨éƒ¨éƒ½è¢« Lock&lt;/code>ï¼Œè¦ update / insert éƒ½ä¸è¡Œï¼Œç›¸å°çš„&lt;/p>
&lt;blockquote>
&lt;p>RC åœ¨æª¢æŸ¥ä¸ç¬¦åˆæ¢ä»¶å°±æœƒ releaseï¼Œåœ¨åšå¤§è¦æ¨¡çš„ Update / Delete è¨˜å¾—è¦ç”¨ RC æœƒæ¯”è¼ƒå¥½&lt;/p>
&lt;/blockquote>
&lt;h2 id="non-unique-index">Non Unique Index&lt;/h2>
&lt;p>ä¸Šé¢çš„ç¯„ä¾‹éƒ½æ˜¯ Clustered Indexï¼ŒMySQL æ”¯æ´ Secondary Indexï¼Œå…¶ä¸­ Unique Secondary Index èˆ‡ Clustered Index è¡Œç‚ºé¡ä¼¼ï¼Œå°±ä¸å¦å¤–è´…è¿°ï¼Œä½†æ˜¯ Non Unique Index è¦ç¨å¾®ç•™æ„&lt;/p>
&lt;h3 id="1-æŸ¥è©¢å‘½ä¸­ä¾ç„¶æœƒ-gap-lock">1. æŸ¥è©¢å‘½ä¸­ï¼šä¾ç„¶æœƒ Gap Lock&lt;/h3>
&lt;p>åœ¨ä¸€é–‹å§‹çš„ç¯„ä¾‹ï¼Œå¦‚æœ Clustered Index æŸ¥è©¢æœ‰å‘½ä¸­åªæœƒé–é‚£ä¸€è¡Œ (ex. update id = 1)ï¼Œä½†å¦‚æœ Non Unique Index å³ä½¿å®Œå…¨å‘½ä¸­ï¼Œä¹Ÿæœƒé€£åŒ Gap ä¸€èµ·é–èµ·ä¾† (Next Key Lock)&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0425/05.png"
loading="lazy"
>
é€™é‚Š Lock æ¯”è¼ƒå¤šï¼Œéœ€æ³¨æ„ Secondary Index æœƒè¢«é–ä¹‹å¤–ï¼Œå°æ‡‰çš„ Clustered Index ä¹Ÿæœƒè¢«é–ï¼Œé€™é‚Š age é–å®š 10 ä»¥åŠå‰é¢çš„å€é–“ï¼Œæ‰€ä»¥è¦æ’å…¥ age: 9 å°±æœƒå¤±æ•—ï¼›é‹ç”¨ä¸Šé¢çš„æŠ€å·§ï¼Œage åˆ‡æ›åˆ°ä¸åŒå€é–“å°±å¯ä»¥æˆåŠŸæ’å…¥&lt;/p>
&lt;h2 id="foreign-keyæœƒæœ‰-share-lock">Foreign Keyï¼šæœƒæœ‰ Share Lock&lt;/h2>
&lt;blockquote>
&lt;p>If a FOREIGN KEY constraint is defined on a table, any insert, update, or delete that requires the constraint condition to be checked sets shared record-level locks&lt;/p>
&lt;/blockquote>
&lt;p>æ›´æ–°æ¬„ä½æ™‚ Foreign Key ä¹Ÿæœƒè¢«é–ä½ï¼Œä¹‹å‰æœ‰ç´€éŒ„å°±ä¸è´…è¿° &lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-12-26-mysql-deadlock-%E5%95%8F%E9%A1%8C%E6%8E%92%E6%9F%A5%E8%88%87%E8%99%95%E7%90%86/" target="_blank" rel="noopener"
>MySQL Deadlock å•é¡Œæ’æŸ¥èˆ‡è™•ç†&lt;/a>&lt;/p>
&lt;h2 id="ç¸½çµèˆ‡å»ºè­°">ç¸½çµèˆ‡å»ºè­°&lt;/h2>
&lt;p>å¹¾é»å»ºè­°&lt;/p>
&lt;ol>
&lt;li>å¢åŠ  Index è¦ä»”ç´°è©•ä¼°ï¼ŒSecondary Index æœƒé€ æˆå¯«å…¥æ•ˆèƒ½ä¸‹é™ï¼Œé«”ç¾æ–¼ lock çš„ä½¿ç”¨&lt;/li>
&lt;li>å¦‚æœæ˜¯ç”¨ ORMï¼Œè¨˜å¾—æª¢æŸ¥ Query&lt;/li>
&lt;li>å¦‚æœéœ€è¦ç”¨ Secondary Index æ”¹è®Šæ¬„ä½ï¼Œå»ºè­°å¯ä»¥ç”¨æ‰¹æ¬¡ (RoR å°±æ˜¯ find_in_batch)&lt;/li>
&lt;li>æˆ–æ˜¯å…ˆç¯©é¸å‡º Primary Key (é è¨­ select ä¸æœƒæœ‰ lock)ï¼Œå†ä½¿ç”¨ Primary Key ç•¶ä½œä¿®æ”¹æ¢ä»¶é¿å… Gap Lock&lt;/li>
&lt;li>&lt;code>æ²’äº‹å°±ç”¨ Read Committed&lt;/code>&lt;/li>
&lt;/ol>
&lt;h2 id="é€²éšç‚ºä»€éº¼ä¸è¦é è¨­-read-committed-">é€²éšï¼šç‚ºä»€éº¼ä¸è¦é è¨­ Read Committed ?&lt;/h2>
&lt;p>æ—¢ç„¶ Repeatable Read æœƒæœ‰é€™éº¼å¤šæ•ˆèƒ½ç–‘æ…®ï¼Œæ›´æ–°æ™‚é€£ where æ¢ä»¶ä¸ç¬¦åˆçš„è¡Œéƒ½æœƒé–ã€é‚„æœƒæœ‰ä¸é æœŸçš„ Gap Lockï¼Œé‚£ç‚ºä»€éº¼é è¨­ä¸è¦æ”¹æˆ Read Committed ?&lt;/p>
&lt;p>åœ¨ PostgreSQL ç¢ºå¯¦å¦‚æ­¤ï¼Œ&lt;a class="link" href="https://www.postgresql.org/docs/7.2/xact-read-committed.html" target="_blank" rel="noopener"
>PQ 9.3. Read Committed Isolation Level&lt;/a>æåˆ°&lt;/p>
&lt;blockquote>
&lt;p>The partial transaction isolation provided by Read Committed level is adequate for many applications, and this level is fast and simple to use&lt;/p>
&lt;/blockquote>
&lt;p>æˆ‘åœ¨æŸ¥é–± MySQL ç›¸é—œè³‡æ–™ï¼Œä¹Ÿæœ‰æŸ¥åˆ° Percona ä¸€ç¯‡æ–‡ç« æåŠ MySQL é è¨­æ‡‰è©²è¦æ”¹æˆ Read Committed æ¯”è¼ƒå¥½ &lt;a class="link" href="https://www.percona.com/blog/2015/01/14/mysql-performance-implications-of-innodb-isolation-modes/" target="_blank" rel="noopener"
>MySQL performance implications of InnoDB isolation modes&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>In general I think good practice is to use READ COMITTED isolation mode as default and change to REPEATABLE READ for those applications or transactions which require it.&lt;/p>
&lt;/blockquote>
&lt;p>é‚£ MySQL å®˜æ–¹æ€éº¼èªªï¼Œæˆ‘æ‰¾åˆ°ä¸€ç¯‡å®˜æ–¹çš„ blog &lt;a class="link" href="https://dev.mysql.com/blog-archive/performance-impact-of-innodb-transaction-isolation-modes-in-mysql-5-7/" target="_blank" rel="noopener"
>Performance Impact of InnoDB Transaction Isolation Modes in MySQL 5.7&lt;/a> å»ºè­°åˆ°&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>For short running queries and transactions, use the default level of REPEATABLE-READ.&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>For long running queries and transactions, use the level of READ-COMMITTED&lt;/li>
&lt;/ul>
&lt;p>è£¡é¢æœ‰å¦ä¸€ç¯‡æ–‡åšäº† Benchmark éå¸¸æœ‰è¶£ &lt;a class="link" href="http://dimitrik.free.fr/blog/archives/2015/02/mysql-performance-impact-of-innodb-transaction-isolation-modes-in-mysql-57.html" target="_blank" rel="noopener"
>MySQL Performance : Impact of InnoDB Transaction Isolation Modes in MySQL 5.7&lt;/a>ï¼Œå¾ MySQL å…§éƒ¨çš„ Lock æ•¸é‡èˆ‡æ“åš QPS è¡¡é‡ä¸åŒ isolation levelï¼Œæˆ‘æœ¬ä¾†ä»¥ç‚º Read Committed åœ¨å¢åˆªæŸ¥æ”¹æœƒç¢¾å£“ Repeatable Readï¼Œä½†ç™¼ç¾ç›¡ç„¶æ²’æœ‰ï¼Œåè€Œå› ç‚º Read Committed åœ¨æ¯æ¬¡ Read éƒ½æœƒç”¢ç”Ÿæ–°çš„ MVCC ç‰ˆæœ¬è€Œæœ‰æ›´å¤šçš„å…§éƒ¨ Lockï¼Œéå¸¸æœ‰è¶£&lt;/p>
&lt;p>æ‰€ä»¥ç¸½çµå®˜æ–¹éƒ¨è½æ ¼å»ºè­°ï¼Œé è¨­é‚„æ˜¯ä¿ç•™ RR æ™®éæ•ˆèƒ½åè€Œæ›´å¥½ï¼Œåªæœ‰åœ¨é•·æ™‚é–“çš„ Job å†æ”¹æˆ RC å³å¯&lt;/p></description></item><item><title>ã€DDIAã€‘03 - è³‡æ–™åº«å„²å­˜åŸç†ç ”ç©¶</title><link>https://yuanchieh.page/posts/2022/2022-04-02-ddia03-%E8%B3%87%E6%96%99%E5%BA%AB%E5%84%B2%E5%AD%98%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6/</link><pubDate>Sat, 02 Apr 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-04-02-ddia03-%E8%B3%87%E6%96%99%E5%BA%AB%E5%84%B2%E5%AD%98%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6/</guid><description>&lt;p>DDIA - ã€ŠDesigning Data-Intensive Applicationsã€‹ï¼Œé€™æœ¬æ›¸å€¼å¾—æœ‰ä¸€å€‹å°ˆé–€çš„ç¸®å¯« XD åœ¨å¹¾å¹´å‰å‰›å‡ºç¤¾æœƒæ™‚æœ‰å…ˆç¡¬å•ƒäº†å¤§åŠéƒ¨åˆ†ï¼Œåœ¨å¾€å¾Œçš„å·¥ä½œä¸Šé€™äº›è§€å¿µä¸æ–·çš„è¢«ä½¿ç”¨ä¸Šï¼Œä¸€ç›´å¾ˆæƒ³å†é‡æ–°æ›´æ·±å…¥ç†è§£é€™æœ¬æ›¸ï¼›&lt;br>
å‰›å¥½æœ€è¿‘è¦é–‹å§‹æº–å‚™å…¬å¸å…§éƒ¨åˆ†äº«ï¼Œåˆ†äº«ä¸€äº›é—œæ–¼è³‡æ–™åº«çš„äº‹æƒ…ï¼Œé‡æ–°ç¿»é–±é€™æœ¬æ›¸ï¼Œä¸¦å¯«ä¸‹è®€æ›¸å¿ƒå¾—ï¼Œä»¥ä¸‹å…§å®¹åŒ…å«åœ–ç‰‡éƒ½æ˜¯æ•´ç†è‡ªç›¸é—œè³‡æ–™&lt;/p>
&lt;p>ä»¥ä¸‹å°‡æè¿°&lt;/p>
&lt;ul>
&lt;li>æœ€ç°¡å–®å¯¦ä½œè³‡æ–™åº«çš„æ–¹å¼&lt;/li>
&lt;li>SSLTable / B Tree å„²å­˜æ–¹å¼èˆ‡æ¯”è¼ƒ&lt;/li>
&lt;li>Column Storage&lt;/li>
&lt;/ul>
&lt;h2 id="storage-and-retrieval">Storage and Retrieval&lt;/h2>
&lt;p>è³‡æ–™åº«æœ€åŸºæœ¬çš„æ ¸å¿ƒåŠŸèƒ½&lt;/p>
&lt;ol>
&lt;li>çµ¦ä½ ä¸€äº›è³‡æ–™ï¼Œå¹«æˆ‘ä¿å­˜ - storage&lt;/li>
&lt;li>æˆ‘æ™šé»è·Ÿä½ æ‹¿é€™äº›è³‡æ–™ï¼Œè¨˜å¾—çµ¦æˆ‘ - retrieval&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœåƒ…è€ƒæ…®é€™å…©å€‹åŠŸèƒ½ï¼Œå¦‚ä½•ç”¨æœ€ç°¡å–®çš„æ–¹å¼å¯¦ä½œå‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="ä¸€-æœ€ç°¡å–®çš„è³‡æ–™åº«---log-structured-storage">ä¸€. æœ€ç°¡å–®çš„è³‡æ–™åº« - Log Structured Storage&lt;/h3>
&lt;p>ä»Šå¤©å¯¦ä½œä¸€å€‹ key-value DBï¼Œæˆ‘å€‘ç”¨å…©å€‹ bash command å°±å¯ä»¥å®Œæˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>db_set&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">,&lt;/span>&lt;span class="nv">$2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;&amp;gt; database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">db_get&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> grep &lt;span class="s2">&amp;#34;^&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">,&amp;#34;&lt;/span> database &lt;span class="p">|&lt;/span> sed -e &lt;span class="s2">&amp;#34;s/^&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">,//&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> tail -n &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘¼å« db_set æ™‚ï¼Œå¾ˆå–®ç´”ä¸€ç›´æŠŠå€¼ append åˆ°æª”æ¡ˆçš„æœ€å¾Œï¼›å¦‚æœè¦å–å‡ºï¼Œå‰‡å¾æª”æ¡ˆçš„æœ€å¾Œé–‹å§‹æ¯”å° keyï¼Œå›å‚³ç¬¬ä¸€ç­†åŒ¹é…çš„å€¼ï¼Œé€™æ¨£å°±èƒ½è§£æ±ºåŒå€‹ key è¢«æ›´æ–°å¤šæ¬¡çš„ç‹€æ³&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ db_set &lt;span class="m">42&lt;/span> &lt;span class="s1">&amp;#39;hello word&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ db_get &lt;span class="m">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hello world
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæˆ‘å€‘è€ƒé‡å¯«å…¥èˆ‡è®€å–çš„æ•ˆèƒ½&lt;/p>
&lt;ul>
&lt;li>å¯«å…¥ï¼šéå¸¸å¥½ï¼Œå› ç‚ºæ˜¯é †åºæ€§å¯«å…¥ï¼ŒåŸºæœ¬ä¸Šæ²’æœ‰æ¯” append æ›´å¿«çš„å¯«æ³•ï¼Œåœ¨éå¸¸å¤šçš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œä¹Ÿéƒ½ç”¨ä¸Š &lt;code>append only log&lt;/code>ï¼Œå¦‚ MySQL binlog&lt;/li>
&lt;li>è®€å–ï¼šå› ç‚ºè¦å¾æª”æ¡ˆæœ€æœ«ç«¯é–‹å§‹è®€å–ï¼Œæ™‚é–“è¤‡é›œåº¦ç‚º &lt;code>O(n)&lt;/code>ï¼Œéå¸¸æ…¢&lt;/li>
&lt;/ul>
&lt;h4 id="1-æ”¹å–„è®€å–æ•ˆç‡---åŠ ä¸Š-index">1. æ”¹å–„è®€å–æ•ˆç‡ - åŠ ä¸Š Index&lt;/h4>
&lt;p>æˆ‘å€‘å¯ä»¥é€éåœ¨ memory ä¸­ç¶­è­·ä¸€ä»½ Hash Tableï¼Œåœ¨å¯«å…¥æ™‚é †ä¾¿å„²å­˜ &lt;code>{ key:æª”æ¡ˆä½ç½® }&lt;/code>ï¼Œé€™æ¨£å°±èƒ½åœ¨æŸ¥è©¢æ™‚ç”¨ O(1) çš„æ™‚é–“æ‰¾åˆ° key&lt;/p>
&lt;blockquote>
&lt;p>ä½†é€™å¸¶ä¾†å¦ä¸€å€‹é™åˆ¶ï¼Œ&lt;code>Hash Table å¿…é ˆèƒ½å®Œæ•´æ”¾å…¥ Memory&lt;/code>ï¼Œå¦‚æœä»Šå¤© key size è¶…éï¼Œå‰‡ Index ç„¡æ³•è¢«å»ºç«‹å°±æœƒå›åˆ° O(n) çš„æŸ¥è©¢è¤‡é›œåº¦&lt;/p>
&lt;/blockquote>
&lt;h4 id="2-æ”¹å–„å„²å­˜æ•ˆç‡---compact">2. æ”¹å–„å„²å­˜æ•ˆç‡ - Compact&lt;/h4>
&lt;p>æ€è€ƒå¦ä¸€å€‹å„²å­˜å•é¡Œï¼Œä»Šå¤©å¦‚æœæ˜¯åŒä¸€å€‹ key è¢«åè¦†å„²å­˜å¤šæ¬¡ï¼Œä»¥ç›®å‰ append-only çš„è¨­è¨ˆï¼Œä»–æœƒè¢«å„²å­˜å¾ˆå¤šç­†ï¼Œæ¯æ¬¡è®€å–åªæ‹¿æœ€å¾Œä¸€ç­†ï¼Œå‰é¢å¹¾ç­†çš„è³‡æ–™ç©ºé–“å°±æµªè²»äº†&lt;/p>
&lt;p>æ‰€ä»¥é€šå¸¸æœƒæ­é… Compact è¨­è¨ˆï¼Œé‡æ–°æ•´ç† log æŠŠèˆŠè³‡æ–™åˆªé™¤ï¼Œé‡‹æ”¾å„²å­˜ç©ºé–“ï¼Œå¯¦ä½œä¸Š &lt;code>æœƒé–‹æ–°çš„æª”æ¡ˆåˆä½µèˆŠçš„æª”æ¡ˆå…§å®¹ï¼Œä¸¦ä¸æœƒç›´æ¥ä¿®æ”¹èˆŠæª”æ¡ˆ&lt;/code>ï¼Œé€™æ¨£åšçš„å¥½è™•æ˜¯å¯«å…¥ã€è®€å–ä¸æœƒä¸­æ–·ï¼Œç­‰åˆ°æ–°çš„æª”æ¡ˆå®Œæˆå¾Œï¼Œå†ç§»é™¤èˆŠæª”æ¡ˆ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0402/compact.png"
loading="lazy"
>&lt;/p>
&lt;h4 id="3-ç‚ºä»€éº¼è¦ç”¨-append-è€Œä¸æ˜¯ç›´æ¥-update-">3. ç‚ºä»€éº¼è¦ç”¨ append è€Œä¸æ˜¯ç›´æ¥ update ?&lt;/h4>
&lt;p>å¦‚æœæˆ‘ç›´æ¥æ”¹åŸæœ¬çš„è³‡æ–™ï¼Œæ˜¯ä¸æ˜¯å°±ç¯€çœäº† compact çš„éç¨‹ï¼ŸåŸå› åœ¨æ–¼ç¡¬ç¢Ÿé †åºå¯«å…¥æ•ˆèƒ½æœƒæ¯”è¼ƒå¥½ï¼Œå³ä½¿ SSD ä¹Ÿæ˜¯ï¼Œé€™é»å¾ŒçºŒè£œå……&lt;/p>
&lt;h4 id="4-ç„¡å¯é¿å…çš„ç¼ºé»---range-search">4. ç„¡å¯é¿å…çš„ç¼ºé» - range search&lt;/h4>
&lt;p>å¦‚æœè¦ç¯„åœæœå°‹ï¼ŒHash Table ç„¡æ³•åšåˆ°é€™ä»¶äº‹ï¼ŒåŒæ¨£çš„ disk å„²å­˜æ–¹å¼ä¹Ÿæ²’æœ‰æ’åºï¼Œæ‰€ä»¥åªèƒ½å…¨éƒ¨ Scan&lt;/p>
&lt;h4 id="5-real-world-sample-bitcask">5. Real World Sample: Bitcask&lt;/h4>
&lt;p>ä»¥ä¸Šçš„æ–¹å¼è½èµ·ä¾†ç°¡å–®çš„éåˆ†ï¼Œä½†é€™ä¹Ÿæ˜¯çœŸå¯¦æœ‰åœ¨æ¡ç”¨çš„ä½œæ³•ï¼Œå¦‚ Riak å…§çš„å„²å­˜å¼•æ“ Bitcaskï¼ŒRiak æ˜¯åˆ†æ•£å¼ Key-Value DB&lt;br>
Bitcask æ˜¯ç”¨ Erlang å¯¦ä½œï¼Œ&lt;a class="link" href="https://github.com/basho/bitcask" target="_blank" rel="noopener"
>åŸå§‹ç¢¼&lt;/a> æœ‰é»çœ‹ä¸æ‡‚ï¼Œä½†æœ‰å¦ä¸€ç¯‡æ–‡ç« å¯ä»¥å¾ high level è§’åº¦å»æŸ¥è­‰ &lt;a class="link" href="https://riak.com/assets/bitcask-intro.pdf" target="_blank" rel="noopener"
>Bitcask: A Log-Structured Hash Table for Fast Key/Value Data&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0402/disk.png"
loading="lazy"
>
å„²å­˜æ–¹é¢ï¼Œbitcask ç¶­è­·ä¸€å€‹ active file æŒçºŒå¯«å…¥ï¼Œå…¶é¤˜æœƒæœ‰å¤šå€‹ older file åªè®€ä¸å¯«ï¼ŒèƒŒæ™¯é‹è¡Œä¸€å€‹ merge process æŒçºŒåˆä½µå¤šå€‹ older file&lt;/p>
&lt;p>æ¯ç­†è³‡æ–™æœ‰å‰ç¶´ metadataï¼Œé€™äº›è³‡æ–™æ¬„ä½çš„å°ºå¯¸éƒ½æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯ key value çš„é•·åº¦å¯ä»¥æ˜¯è®Šå‹•ï¼Œé€é keysz / valuesz çŸ¥é“å°æ‡‰é•·åº¦ï¼›&lt;br>
å…¶ä¸­ CRC æ˜¯ checksumï¼Œå¯ä»¥æª¢æŸ¥è³‡æ–™å¯«å…¥æ˜¯å¦æœ‰èª¤&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0402/keydir.png"
loading="lazy"
>
bitcask ä¸­çš„è³‡æ–™çµæ§‹ &lt;code>keydir&lt;/code> å°±æ˜¯ hash tableï¼Œä¿å­˜ key å°æ‡‰åˆ° value çš„å„²å­˜ä½ç½®ï¼Œé€™æ¨£å°±èƒ½å¤ ä¸€æ¬¡ Disk æŸ¥è©¢å–å‡º value&lt;/p>
&lt;h4 id="6-ä¸åŒé¢å‘è€ƒé‡">6. ä¸åŒé¢å‘è€ƒé‡&lt;/h4>
&lt;p>è³‡æ–™åº«ä¸å–®æ˜¯è®€å¯«ï¼Œé‚„éœ€è¦è€ƒé‡å…¶ä»–é¢å‘çš„å•é¡Œï¼Œè®“æˆ‘å€‘ä¸€ä¸€æª¢è¦–é€™æ¨£çš„ç°¡å–®è¨­è¨ˆ&lt;/p>
&lt;ul>
&lt;li>Crash Recovery: åŸºæœ¬ä¸Šä¸æœƒæœ‰å•é¡Œï¼Œå› ç‚ºæª”æ¡ˆéƒ½æ˜¯ append onlyï¼Œå¦‚æœæœ‰å•é¡Œå¯ä»¥é€é CRC æª¢æŸ¥ï¼Œåªæ˜¯ keydir è¦é‡å»º&lt;/li>
&lt;li>Restore: ç›´æ¥è¤‡è£½æª”æ¡ˆéå»å°±å¥½&lt;/li>
&lt;li>Heavy Load &amp;amp; High Volume: ç•¶è³‡æ–™é‡è®Šå¤§æˆ–æ˜¯ loading è®Šå¤§æ™‚ï¼Œé æœŸ bitcask çš„æ•ˆèƒ½ä¸æœƒæœ‰å¤ªå¤§å·®ç•°ï¼Œå› ç‚ºéƒ½æ˜¯å¾ˆç°¡å–®çš„ disk èˆ‡ memory æ“ä½œ&lt;/li>
&lt;/ul>
&lt;h3 id="äºŒ-sstable-èˆ‡-lsm-tree">äºŒ. SSTable èˆ‡ LSM Tree&lt;/h3>
&lt;p>ä¸Šé¢æåˆ° Log Structure é‡åˆ° range search æ•ˆèƒ½æœƒå¾ˆå·®ï¼Œé‚£å¦‚æœæˆ‘å€‘æŠŠè³‡æ–™æ’åºå¾Œå†å¯«å…¥å‘¢ï¼Ÿ&lt;br>
åœ¨è¨ˆç®—æ©Ÿç§‘å­¸ä¸­ï¼Œè² è²¬å¿«é€Ÿæ’å…¥ã€æŸ¥æ‰¾ã€ç¯„åœæœå°‹çš„è³‡æ–™çµæ§‹å¯ä»¥ç”¨ &lt;code>å¹³è¡¡æ¨¹&lt;/code>ï¼Œæ’å…¥èˆ‡æœå°‹éƒ½æ˜¯ O(logn)ï¼Œå¦‚æœæ˜¯ç¯„åœæœå°‹å‰‡ç‚º O(logn, k)&lt;/p>
&lt;p>å¯¦ä½œä¸Šï¼Œç•¶è³‡æ–™å¯«å…¥æ™‚&lt;/p>
&lt;ol>
&lt;li>æœƒå…ˆæš«å­˜åˆ° memory ä¸­ï¼Œè³‡æ–™çµæ§‹ç‚ºå¹³è¡¡æ¨¹ï¼Œæ­¤ç¨±ç‚º &lt;code>memtable&lt;/code>&lt;/li>
&lt;li>ç•¶ memtable è¶…éé–€æª»ï¼Œå¯«å…¥ç¡¬ç¢Ÿï¼Œç¨±ç‚º &lt;code>SSTable (Sorted String Table)&lt;/code>ï¼Œå¾ŒçºŒè³‡æ–™å¯«å…¥æ–°çš„ memtable&lt;/li>
&lt;li>SSTable åŒæ¨£æœƒåœ¨èƒŒæ™¯ compactï¼Œå¦‚ Log Structure&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0402/sstable.png"
loading="lazy"
>&lt;/p>
&lt;blockquote>
&lt;p>åˆ°åº•å„²å­˜ç”¨ sorted å¾Œçš„çµæœæœ‰ä»€éº¼å·¨å¤§çš„å¥½è™•ï¼Ÿåˆæœƒæœ‰å¸¶ä¾†ä»€éº¼å½±éŸ¿å‘¢ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>è®“æˆ‘å€‘æ€è€ƒä»¥ä¸‹å¹¾å€‹ç´°ç¯€&lt;/p>
&lt;h4 id="1-å¯«å…¥æœ€ä¸€é–‹å§‹æ˜¯å„²å­˜åœ¨-memory-ä¸­å¦‚æœ-crash-æœƒä¸æœƒæ‰è³‡æ–™">1. å¯«å…¥æœ€ä¸€é–‹å§‹æ˜¯å„²å­˜åœ¨ memory ä¸­ï¼Œå¦‚æœ crash æœƒä¸æœƒæ‰è³‡æ–™ï¼Ÿ&lt;/h4>
&lt;p>æœƒï¼Œæ‰€ä»¥å¯«å…¥ memory æ™‚åŒæ™‚æœƒç”¨ append log æ–¹å¼å¯«å…¥è³‡æ–™åº«ï¼Œå€Ÿç”¨ log structure çš„æ™ºæ…§ï¼Œç•¶ crash recovery å¾ log å¾©åŸå³å¯&lt;/p>
&lt;h4 id="2sorted-å¾Œå„²å­˜çµæœçš„å¹¾å€‹å¥½è™•">2.sorted å¾Œå„²å­˜çµæœçš„å¹¾å€‹å¥½è™•&lt;/h4>
&lt;p>é™¤äº†å‰›å‰›èªªçš„æ”¯æ´æ›´å¿«çš„ç¯„åœæŸ¥è©¢å¤–ï¼Œ&lt;code>ä¿å­˜åœ¨ memory ä¸­çš„ index æ•¸é‡å¯ä»¥æ›´å°‘ï¼Œè®“ dataset æ”¯æ´å®¹é‡æ›´å¤§&lt;/code>ï¼Œå¦‚ä¸Šé¢åœ–ç¤ºï¼ŒSSTable æœƒä»¥&lt;code>å¤šç­†è³‡æ–™ç‚ºä¸€å€‹ block&lt;/code>ä¿å­˜ï¼Œä»Šå¤©æˆ‘è¦æ‰¾ 2ï¼Œindex tree å…§æ²’æœ‰ 2 æ²’é—œä¿‚ï¼Œæˆ‘å¯ä»¥æ‰¾åˆ° 1 çš„æª”æ¡ˆä½ç½®ï¼Œæ¥è‘—æŠŠ block è®€å–å‡ºä¾†ï¼Œé€™æ¨£æˆ‘å°±èƒ½é€é 1 æ‰¾åˆ° 2ï¼Œèƒ½å¤ é€™æ¨£æ‰¾æ˜¯å› ç‚º &lt;code>å„²å­˜æœ‰æŒ‰ç…§ index æ’åº&lt;/code>&lt;/p>
&lt;h4 id="3-compact-éç¨‹æœƒä¸æœƒå¾ˆéº»ç…©">3. compact éç¨‹æœƒä¸æœƒå¾ˆéº»ç…©?&lt;/h4>
&lt;p>ä¸æœƒï¼Œå¦‚æœæœ‰å­¸é merge sortï¼Œé€™å€‹éç¨‹å°±æ˜¯æŠŠå…©å€‹å°çš„ block å¾é ­åˆ°å°¾ iterate éå°±è§£æ±ºäº†ï¼Œæ™‚é–“è¤‡é›œåº¦ç‚º O(n+m)&lt;/p>
&lt;h4 id="4-æŸ¥æ‰¾ä¸å­˜åœ¨çš„-key-æ•ˆç‡ä¸å¥½">4. æŸ¥æ‰¾ä¸å­˜åœ¨çš„ key æ•ˆç‡ä¸å¥½&lt;/h4>
&lt;p>å› ç‚ºè¦æ‰¾éæ¯ä¸€å€‹ SSTable æ‰èƒ½ç¢ºå®šè³‡æ–™ä¸å­˜åœ¨ï¼Œé€™é‚Šå¯ä»¥åˆ©ç”¨ Bloom Filter å¿«é€Ÿåˆ¤æ–·ï¼Œå¯ä»¥åƒè€ƒæˆ‘ä¹‹å‰çš„ç­†è¨˜ &lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-11-17-sketch-data-structure-bloom-filter-%E4%BB%8B%E7%B4%B9%E8%88%87%E5%AF%A6%E4%BD%9C/" target="_blank" rel="noopener"
>Sketch Data Structure - Bloom Filter ä»‹ç´¹èˆ‡å¯¦ä½œ&lt;/a>&lt;/p>
&lt;h4 id="5-real-world-sample-leveldb--rocksdb--bigtable">5. Real World Sample: LevelDB / RocksDB / BigTable&lt;/h4>
&lt;p>Google LevelDB æ˜¯ç”¨ SSTable æ¦‚å¿µå¯¦ä½œçš„ Key-Value DBï¼Œå¯ä»¥åƒè€ƒä»–çš„èªªæ˜ &lt;a class="link" href="https://github.com/google/leveldb/blob/main/doc/impl.md" target="_blank" rel="noopener"
>LevelDB impl.md&lt;/a>ï¼Œå…¶ä¸­å¯ä»¥æ³¨æ„ compact éç¨‹æ˜¯æœ‰åˆ†ç­‰ç´šçš„ (æ‰€ä»¥æ‰å« level DB)ï¼Œé¿å…ä¸€æ¬¡æ€§å¤§é‡çš„ compact ç™¼ç”Ÿå°è‡´ç¡¬ç¢Ÿæ•ˆèƒ½åƒä¸æ¶ˆï¼Œå…¶ä¸­ç¿»äº†ä¸€ä¸‹ memtable æ²’æœ‰çœ‹åˆ°æ˜¯ç”¨ä»€éº¼æ–¹å¼å¯¦ä½œ&lt;/p>
&lt;p>RocksDB å‰‡æ˜¯ Facebook åŸºæ–¼ LevelDB æ‰€é–‹ç™¼çš„ï¼Œèªªæ˜è »å®Œæ•´çš„ &lt;a class="link" href="https://github.com/facebook/rocksdb/wiki/RocksDB-Overview" target="_blank" rel="noopener"
>RocksDB Overview&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>The memtable is an in-memory data structure - new writes are inserted into the &lt;code>memtable&lt;/code> and are optionally written to the logfile (aka. &lt;code>Write Ahead Log(WAL)&lt;/code>). The logfile is a sequentially-written file on storage. When the memtable fills up, it is flushed to a &lt;code>sstfile&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>ä¸‹æ–¹æœ‰æåˆ°ä¸€äº› &lt;a class="link" href="https://github.com/facebook/rocksdb/wiki/MemTable" target="_blank" rel="noopener"
>memtable å¯¦ä½œèˆ‡æ¯”è¼ƒ&lt;/a>ï¼Œé è¨­æ˜¯ skiplistï¼Œæ„Ÿè¦ºè »æœ‰è¶£çš„ï¼Œæœªä¾†å¯ä»¥å†æ·±å…¥ç ”ç©¶&lt;/p>
&lt;p>å¦å¤–é‚„æœ‰ Google çš„&lt;a class="link" href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/68a74a85e1662fe02ff3967497f31fda7f32225c.pdf" target="_blank" rel="noopener"
>Bigtable: A Distributed Storage System for Structured Data&lt;/a>ï¼Œè£¡é¢ä¹Ÿæœ‰æåˆ°å¾ˆå¤šç›¸é—œçš„å…§å®¹ï¼Œæœªä¾†å¾…è®€é …ç›®ä¹‹ä¸€ (æŒ–å‘)&lt;/p>
&lt;p>ä»¥ä¸Š Log Structure èˆ‡ SSTable éƒ½å¯ç¨±ç‚º &lt;code>LSMTree&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ Log Structure and Merging Treeï¼Œé€é log æ–¹å¼å„²å­˜ä¸¦æœ‰æŒçºŒ merge çš„è¡Œç‚º&lt;/p>
&lt;hr>
&lt;h3 id="ä¸‰-b-tree">ä¸‰. B Tree&lt;/h3>
&lt;p>B Tree åœ¨è³‡æ–™åº«å„²å­˜ä¸Šæ˜¯éå¸¸å—æ­¡è¿çš„é¸é …ï¼Œå¦‚ MySQL / PostgreSQL ç­‰ï¼ŒB Tree ä¹Ÿæ˜¯å¹³è¡¡æ¨¹çš„ä¸€ç¨®ï¼Œæ¯ä¸€å±¤ä¿å­˜æŒ‡å®šæ•¸é‡çš„ç¯€é» (branching factor) ä»£è¡¨ä¸åŒçš„ç¯„åœï¼Œä¸¦ä¿å­˜æŒ‡å‘ä¸‹ä¸€å±¤çš„æŒ‡é‡ï¼Œæœ€å¾Œåœ¨è‘‰å­ç¯€é» (leef node) ä¿å­˜è³‡æ–™&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0402/b_tree.png"
loading="lazy"
>&lt;/p>
&lt;p>åœ¨ B Tree çš„ä¿å­˜ä¸­ï¼Œæ˜¯ä»¥å›ºå®šå°ºå¯¸çš„ &lt;code>Page&lt;/code> ç‚ºå–®ä½ï¼Œå‰›å¥½å°æ‡‰åˆ°ç¡¬ç¢Ÿå„²å­˜æ–¹å¼ä¹Ÿæ˜¯ä»¥å›ºå®šå°ºå¯¸çš„å€å¡Šå„²å­˜ï¼Œå¦‚æœè³‡æ–™æ²’æœ‰å¡æ»¿ Page å‰‡æœƒé€ æˆä¸€äº›ç ´ç¢&lt;/p>
&lt;p>é«˜åº¦ç‚º 4 + brancing factor ç‚º 5 + Page size 4 KB çš„ B Tree å°±èƒ½å„²å­˜ 256 TB&lt;/p>
&lt;p>B Tree èˆ‡ SSTable ç›¸ä¼¼ä¹‹è™•åœ¨æ–¼è³‡æ–™ä¿å­˜æ–¼ç¡¬ç¢Ÿéƒ½æ˜¯æ’åºéï¼Œä½†æ˜¯ B Tree æœƒ&lt;code>ä¸æ–·ä¿®æ”¹å·²ç¶“æŒä¹…åŒ–çš„æª”æ¡ˆ&lt;/code>ï¼Œå°¤å…¶æ˜¯ç•¶ Page å…§è³‡æ–™è¶…ééœ€è¦æ‹†åˆ† Page ä¸¦é‡æ–°å¹³è¡¡æ™‚ï¼Œæœƒæœ‰æ¯”è¼ƒå¤šçš„ç¡¬ç¢Ÿæ“ä½œï¼Œè€Œ SSTable åªæœƒä¸€ç›´å¯«å…¥ç­‰åˆ° compact éšæ®µæ‰åˆä½µç”¢ç”Ÿæ–°çš„æª”æ¡ˆ&lt;/p>
&lt;h3 id="b-tree-vs-sstable">B Tree vs SSTable&lt;/h3>
&lt;p>å¸¸ç†ä¾†èªª SSTable å¯«å…¥æœƒæ¯”è¼ƒå¿«ï¼Œå› ç‚ºå°±æ˜¯ append ä¸Šå»è€Œ B Tree éœ€è¦å…ˆå¯« WAL ä¸¦ç­‰åˆ° Page åˆ·æ–°åˆ°ç¡¬ç¢Ÿä¸Šï¼Œé€™é»åœ¨é«˜å¯«å…¥çš„ç³»çµ±ä¸‹å°¤ç‚ºé‡è¦ï¼›
å¦å¤– SSTable æœƒæœ‰ compact éç¨‹ï¼Œç›¸æ¯” B Tree Page è¨­è¨ˆå¯ä»¥æ›´æœ‰æ•ˆä½¿ç”¨ç£ç¢Ÿç©ºé–“&lt;/p>
&lt;p>è€Œ B Tree çš„å¥½æ˜¯è®€å–è¼ƒå¿«ï¼Œå› ç‚º SSTable çš„åŒä¸€å€‹ key å¯èƒ½æ•£è½åœ¨å¤šå€‹ file ä¸­éœ€è¦æ¯å€‹éƒ½æª¢æŸ¥ï¼›åŒæ™‚ç•¶é‡ä¸Š compact æ™‚æ•ˆèƒ½æœƒæœ‰æ¯”è¼ƒå¤§çš„è¡æ“Šï¼Œè€Œ B Tree ç›¸å°æœƒæ¯”è¼ƒç©©å®š&lt;/p>
&lt;h3 id="column-storage">Column Storage&lt;/h3>
&lt;p>ä¸Šè¿°å OLTP çš„è³‡æ–™åº«è¨­è¨ˆï¼Œè³‡æ–™æ˜¯ä»¥ row çš„æ–¹å¼å„²å­˜ï¼Œä½†æ˜¯åœ¨ OLAP å°ˆé–€åšåˆ†æä¸Šï¼Œå¾€å¾€æˆ‘å€‘éœ€è¦çš„æ˜¯ query éå¸¸å¤šçš„è³‡æ–™ç­†æ•¸ä½†åªåˆ†æå…¶ä¸­ä¸€å…©å€‹æ¬„ä½ï¼Œä¾‹å¦‚æ’ˆå‡ºéå»ä¸€å¹´çš„éŠ·å”®ç¸½é¡ï¼Œå¦‚æœè³‡æ–™æ˜¯ä»¥ row æ–¹å¼å„²å­˜ï¼Œè¦æŠŠä¸€æ•´å¹´çš„è³‡æ–™éƒ½æ‹¿å‡ºä¾†éæ¿¾ã€ç¯©é¸å†ç¸½å’Œï¼Œååˆ†è€—è²»è³‡æº&lt;/p>
&lt;p>åœ¨ OLAP ä¸­ï¼Œæ—¢ç„¶æˆ‘å€‘å¸¸å¸¸ä»¥ &lt;code>column&lt;/code> ç‚ºä¸»ï¼Œé‚£æ”¹ç”¨ column ä¾†ç•¶ä½œå„²å­˜çš„ä¾æ“šæ˜¯ä¸æ˜¯æœƒæ¯”è¼ƒå¥½ï¼Ÿ column storage çš„æ¦‚å¿µå°±é€™æ¨£å»¶ä¼¸å‡ºä¾†&lt;/p>
&lt;p>é€™æ¨£åšçš„æœ€å¤§å¥½è™•&lt;code>éå¸¸å¥½å£“ç¸®&lt;/code>ï¼Œå¾æ¬„ä½è³‡æ–™çš„ cardinality ä¾†çœ‹ï¼Œå¾€å¾€æ•¸é‡ä¸å¤šï¼Œä¾‹å¦‚æ•¸ç™¾è¬ç­†è³‡æ–™ä¸­åœ‹å®¶ç¨®é¡å°±é‚£å…©ç™¾å€‹ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸€äº›å£“ç¸®çš„æŠ€å·§å¦‚ bitmap encodingï¼Œç”¨ bitmap ä»£è¡¨æŸå€‹ç‰¹å®šå€¼å„²å­˜ï¼Œåœ¨è®€å–æ™‚å¯ä»¥ç”¨ bitwise æ“ä½œï¼Œå°æ–¼ CPU æ•ˆç‡æœƒå¥½ä¸Šè¨±å¤šï¼›&lt;br>
æ‰€ä»¥å„²å­˜ç©ºé–“å°ã€é‹ç®—ä¹Ÿå¾ˆå¿«&lt;/p>
&lt;h4 id="é™åˆ¶èˆ‡æ‡‰è®Š">é™åˆ¶èˆ‡æ‡‰è®Š&lt;/h4>
&lt;p>å› ç‚ºç¾åœ¨æ˜¯æ¯ä¸€å€‹ column éƒ½ç¨ç«‹å„²å­˜ï¼Œé‚£å¦‚æœæˆ‘æƒ³è¦è®€å–æŸä¸€å€‹ row çš„æ‰€æœ‰ column æ€éº¼è¾¦ï¼Ÿ&lt;br>
æ‰€ä»¥åœ¨å„²å­˜æ™‚æ¯ä¸€å€‹ column file çš„ &lt;code>row order éƒ½å¿…é ˆä¸€æ¨£&lt;/code>ï¼Œé€™æ¨£æ‰èƒ½é‚„åŸåŒä¸€ç­† row çš„å…¨éƒ¨ column&lt;/p>
&lt;p>å¦‚æœåœ¨å„²å­˜æ™‚å¸Œæœ›æœ‰æ’åºï¼Œä¾‹å¦‚åˆ†æè³‡æ–™é€šå¸¸æœƒæŒ‰ç…§æ—¥æœŸæ’åºï¼Œå¯ä»¥å¥—ç”¨ä¹‹å‰ SSTable æ¦‚å¿µï¼Œå…ˆç”¨ memtable æ’å¥½åºï¼Œå¯«å…¥æ™‚å†åˆ†æˆå¤šå€‹ column file å„²å­˜&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0402/column.png"
loading="lazy"
>&lt;/p>
&lt;blockquote>
&lt;p>è¦æ³¨æ„ column-family database èˆ‡ column storage database æ˜¯ä¸ä¸€æ¨£çš„è©å½™ï¼Œå¦‚ Cassandra åœ¨æ–‡ä»¶è¡¨æ˜æ˜¯ä»¥ &lt;code>row-based&lt;/code> å„²å­˜ï¼Œåƒè€ƒ &lt;a class="link" href="https://github.com/apache/cassandra" target="_blank" rel="noopener"
>Apache Cassandra is a highly-scalable partitioned row store&lt;/a>ï¼Œä½†ä»–è¢«æ­¸é¡åœ¨ column-family ä¸­ï¼Œè‡³æ–¼ç‚ºä»€éº¼é€™æ¨£æ­¸é¡å¯èƒ½æ˜¯è·Ÿä»–çš„ç”¨é€”è·Ÿå°è±¡æ¯”è¼ƒæœ‰é—œï¼Œç¶²è·¯ä¸Šéš¨ä¾¿ä¸€æŸ¥éƒ½æœ‰ä¸€äº›éŒ¯èª¤çš„è³‡è¨Šï¼Œè¦åœ¨å°å¿ƒç•™æ„ (æœƒä¸æœƒæˆ‘æ‰æ˜¯éŒ¯çš„ ?! å¦‚æœæ˜¯æ­¡è¿ç•™è¨€è®“æˆ‘çŸ¥é“)&lt;/p>
&lt;/blockquote>
&lt;h3 id="çµè«–">çµè«–&lt;/h3>
&lt;p>çŸ¥é“è³‡æ–™åº«æ€éº¼å„²å­˜å¥½åƒä¸æœƒè®Šæˆè³‡æ–™åº«å¤§å¸« XD ä½†å°æ–¼æœªä¾†åœ¨è©•ä¼°ä¸åŒçš„è³‡æ–™åº«æ™‚ï¼Œåˆå¤šä¸€å€‹å¯ä»¥é©—è­‰çœŸå½çš„å·¥å…·ï¼Œå°¤å…¶æ˜¯åœ¨å¤§ç‡ŸéŠ·æ™‚ä»£å„ç¨®æ–°çš„æŠ€è¡“åè©æŒçºŒè¢«ç™¼æ˜ï¼Œä½†è³‡æ–™åº«çš„æœ¬è³ªå°±é‚„æ˜¯ storage and retrieval&lt;/p></description></item><item><title>Archives</title><link>https://yuanchieh.page/archives/</link><pubDate>Sun, 06 Mar 2022 00:00:00 +0000</pubDate><guid>https://yuanchieh.page/archives/</guid><description/></item><item><title>I/O åŒæ­¥èˆ‡éåŒæ­¥ï¼šå¾ç¡¬é«”ã€ä½œæ¥­ç³»çµ±åˆ°æ‡‰ç”¨ç¨‹å¼</title><link>https://yuanchieh.page/posts/2022/2022-02-06-i/o-%E5%90%8C%E6%AD%A5%E8%88%87%E9%9D%9E%E5%90%8C%E6%AD%A5%E5%BE%9E%E7%A1%AC%E9%AB%94%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%E5%88%B0%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/</link><pubDate>Sun, 06 Feb 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-02-06-i/o-%E5%90%8C%E6%AD%A5%E8%88%87%E9%9D%9E%E5%90%8C%E6%AD%A5%E5%BE%9E%E7%A1%AC%E9%AB%94%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%E5%88%B0%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/</guid><description>&lt;p>å¾æ‡‰ç”¨ç¨‹å¼çš„è§’åº¦ï¼ŒåŸ·è¡Œä»»å‹™å¯ä»¥åˆ†æˆ I/O bound èˆ‡ CPU boundï¼Œè€Œ I/O è™•ç†ç›¸æ¯”æ–¼ CPU é‹ç®—é€Ÿåº¦æ…¢å¥½å¹¾å€‹å±¤ç´šï¼Œæ‰€ä»¥ç•¶ I/O é‚„æ²’æº–å‚™å¥½æ™‚æœƒã€Œä¸»å‹•è®“ã€çµ¦å…¶ä»–ä»»å‹™ï¼Œç›¡å¯èƒ½åœ°è®“ CPU ä¿æŒå¿™ç¢Œï¼Œç­‰åˆ° ã€ŒI/O æº–å‚™å¥½å†é‡æ–°å›åˆ° CPU åŸ·è¡Œã€&lt;/p>
&lt;p>åœ¨ä¹‹å‰ç†è§£ Nodejs non-blocking I/O æ™‚ï¼Œå®˜æ–¹æ–‡ä»¶ &lt;a class="link" href="https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/" target="_blank" rel="noopener"
>Overview of Blocking vs Non-Blocking&lt;/a> å¯«åˆ°&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Any code that is expected to run in a concurrent manner must allow the event loop to &lt;span class="k">continue&lt;/span> running as non-JavaScript operations, like I/O, are occurring.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Nodejs sdk æœ‰æä¾› non-blocking I/O æ©Ÿåˆ¶ï¼Œåº•å±¤ libuv æœƒè™•ç† event loop èˆ‡å…¶é¤˜ I/O çš„åŸ·è¡Œï¼Œã€Œç•¶ I/O åŸ·è¡Œæ™‚å¯ä»¥è®“å…¶ä»–çš„ JavaScript code ç¹¼çºŒé‹è¡Œä¸è¢« blockã€&lt;/p>
&lt;p>æ‰€æœ‰ç”¨ã€Œã€æ‹¬èµ·ä¾†çš„åœ°æ–¹éƒ½æ˜¯æˆ‘æ‰€æƒ³ä¸é€çš„ï¼Œç‚ºä»€éº¼ I/O é‹è¡Œæ™‚å…¶ä»– JavaScript Code å¯ä»¥ç¹¼çºŒé‹è¡Œï¼Ÿæ˜¯å› ç‚º Nodejs æœ‰æŸç¨®ç‰¹æ®Šçš„æ–¹æ³•çŸ¥é“ç›®å‰çš„ç¨‹å¼åœ¨ç­‰å¾… I/O æ‰€ä»¥ä¸»å‹•åˆ‡æ›ä¸åŒçš„ä»»å‹™åŸ·è¡Œï¼Ÿå¦‚æœä¸æ˜¯ Nodejs runtime åˆ‡æ›ï¼Œé‚£æœƒæ˜¯ä½œæ¥­ç³»çµ±åˆ‡æ›çš„å—ï¼Ÿè©²æ€éº¼åˆ‡æ›ï¼Ÿ&lt;br>
åˆç‚ºä»€éº¼ I/O çš„è™•ç†ä¸éœ€è¦ CPU çš„ä»‹å…¥å—ï¼Ÿ CPU æ€éº¼çŸ¥é“ IO è™•ç†å®Œäº†è©²ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼Ÿæ˜¯ä¸æ˜¯æˆ‘çš„ IO å…¨éƒ¨æ”¹æˆ asynchronous æ•ˆèƒ½å°±çªé£›çŒ›é€²ï¼Ÿé‚£ç‚ºä»€éº¼ async io ä¸¦ä¸æ˜¯æ¯å€‹ç¨‹å¼èªè¨€åŸ·è¡Œæ™‚çš„é è¨­æ”¯æ´ï¼Ÿ&lt;/p>
&lt;p>åŒæ¨£æœ€è¿‘åœ¨çœ‹ Golang goroutine &lt;a class="link" href="https://medium.com/a-journey-with-go/go-goroutine-os-thread-and-cpu-management-2f5a5eaf518a" target="_blank" rel="noopener"
>Go: Goroutine, OS Thread and CPU Management&lt;/a>æ™‚åˆé‡åˆ°ç›¸åŒçš„å•é¡Œï¼Œç•¶è®€åˆ° goroutine ç­‰å¾… I/O å›æ‡‰æ™‚ M æœƒè§£é™¤ P ä¸¦é€²å…¥ç­‰å¾…ï¼Œè®“å…¶ä»–çš„ M åŸ·è¡Œï¼›å¦‚æœæ˜¯é‡åˆ° network ç›¸é—œçš„ I/O å‰‡æ¨è‡³ network poll ç­‰å¾… network å®Œæˆ&lt;/p>
&lt;p>å¾æ‡‰ç”¨ç¨‹å¼é–‹ç™¼è€…çš„è§’åº¦ï¼Œæˆ‘å€‘åªè¦çŸ¥é“æœ‰&lt;code>ç¥ç§˜çš„å°ç²¾éˆ&lt;/code>æœƒå¹«æˆ‘å€‘å®Œæˆ I/Oï¼ŒJavaScript callback / goroutine system call å¯ä»¥åœ¨éåŒæ­¥çš„ç‹€æ³ä¸‹æ‹¿åˆ° I/O å›å‚³çš„çµæœå°±å¥½&lt;/p>
&lt;blockquote>
&lt;p>ä½†å¾€ä¸‹æ€ç´¢ï¼Œé€™ä¸€åˆ‡çš„é»‘å¹•èƒŒå¾Œæœ‰æ»¿å±±æ»¿è°·çš„ç–‘æƒ‘&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä½œæ¥­ç³»çµ±èˆ‡-io-è£ç½®">ä½œæ¥­ç³»çµ±èˆ‡ I/O è£ç½®&lt;/h2>
&lt;p>ç‚ºäº†è®“é–‹ç™¼è€…å¯ä»¥å°ˆæ³¨æ–¼è»Ÿé«”é–‹ç™¼ï¼Œæ‡‰ç”¨ç¨‹å¼å¤šåŠé‹è¡Œåœ¨ä½œæ¥­ç³»çµ±ä¹‹ä¸Šï¼Œé€éä½œæ¥­ç³»çµ±æä¾›çš„çµ±ä¸€ä»‹é¢æŠ½è±¡åŒ–ç¡¬é«”ï¼Œä¸¦ç¢ºä¿å–®ä¸€æ‡‰ç”¨ç¨‹å¼ä¸æœƒéœ¸ä½”ç¡¬é«”è³‡æºï¼Œæ‰€æœ‰èˆ‡ I/O è£ç½®è¨­å‚™é€šè¨Šéƒ½å¿…é ˆç¶“éä½œæ¥­ç³»çµ±çš„æ“æ§ system callï¼Œè€Œé€™ç¥ç§˜çš„å°ç²¾éˆå°±èº²åœ¨é€™å€‹ç’°ç¯€ä¸­&lt;/p>
&lt;p>å¾ high level çš„è§’åº¦ä¾†çœ‹ï¼Œå¤§è‡´å¦‚ä¸‹
&lt;img src="https://yuanchieh.page/post/2022/img/0206/io.png"
loading="lazy"
>
åˆ†æˆå…©æ¢è·¯ç·šï¼šæ‡‰ç”¨ç¨‹å¼ä¸»å‹•å‘¼å«èˆ‡ I/O è£ç½®ä¸»å‹•è§¸ç™¼&lt;/p>
&lt;ol>
&lt;li>æ‡‰ç”¨ç¨‹å¼å‘¼å« system callï¼Œæ­¤æ™‚é€å‡º interrupt åˆ‡æ›åˆ° kernel space åŸ·è¡Œ&lt;/li>
&lt;li>system call æ“ä½œ(å¦‚è®€å¯«) I/O è£ç½®å°æ‡‰çš„ Fileï¼Œè§¸ç™¼ kernel module é‹ä½œï¼Œé€™é‚Šå°ˆæŒ‡ device driver çš„éƒ¨åˆ†&lt;/li>
&lt;li>ç•¶ I/O è£ç½®å®Œæˆç‰¹å®šå‹•ä½œï¼Œå¦‚ç¶²å¡æ¥æ”¶åˆ°å°åŒ… / ç¡¬ç¢Ÿè®€å–å®Œè³‡æ–™ï¼Œæœƒç›´æ¥é€é&lt;code>ç¡¬é«”æ‰“å‡º interrupt è¨Šè™Ÿçµ¦ CPU&lt;/code>&lt;/li>
&lt;li>CPU æœƒæ‰¾åˆ° OS è¨»å†Šå°æ‡‰çš„ &lt;code>interrupt handler è™•ç†&lt;/code>ï¼Œé¡ä¼¼æ–¼ API server è¨»å†Š api route ç­‰ request è¿‘ä¾†å°±åˆ°å°æ‡‰çš„ handlerï¼Œmapping éç¨‹ç¨±ç‚º &lt;code>ISR&lt;/code>&lt;/li>
&lt;li>ISR æœƒæ‰¾åˆ°å°æ‡‰çš„ device driver è™•ç†&lt;/li>
&lt;li>è£œå……ï¼šé€™é‚Šæˆ‘å€‘åªæ¢è¨è·Ÿ I/O ç›¸é—œçš„è­°é¡Œï¼Œæ‰€ä»¥ interrupt handler æŒ‡çš„æ˜¯å°±æ˜¯ä»¥ kernel module å­˜åœ¨çš„ I/O device driverï¼Œå…¶ä»–é‚„æœ‰å¦‚ timer interrupt handler ç­‰&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥çœŸæ­£æœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼&lt;/p>
&lt;blockquote>
&lt;p>I/O device driver å¦‚ä½•åœ¨æº–å‚™è³‡æ–™çš„æ™‚å€™é‡‹æ”¾ CPU è³‡æºï¼Œä¸¦åœ¨è³‡æ–™æº–å‚™å®Œæˆå¾Œé€é interrupt é‡æ–°å‘ OS æ’ç¨‹ä¸¦å›å‚³è³‡æ–™&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥ä¸‹å°‡ä»¥ Linux ç‚ºä¸»ï¼Œæ¢ç´¢ä½œæ¥­ç³»çµ±èˆ‡ I/O è£ç½®çš„äº’å‹•&lt;/p>
&lt;h2 id="linux-kernel-module-å¯¦ä½œ">Linux Kernel module å¯¦ä½œ&lt;/h2>
&lt;p>åƒè€ƒå…§å®¹ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#introduction" target="_blank" rel="noopener"
>The Linux Kernel Module Programming Guide&lt;/a>ï¼Œç¾åœ¨å­¸ç¿’ Linux çœŸçš„å¾ˆå¹¸é‹æœ‰ Jserv å¤§å¤§çš„è²¢ç»ï¼Œç”¨å½±ç‰‡èˆ‡å…±ç­†åˆ†äº«åœ¨æˆå¤§æ•™æˆçš„èª²ç¨‹ï¼Œä¸¦ç¶­è­·é€™ä»½æ˜“è®€å¥½æ‡‚çš„ Linux Kernel é–‹ç™¼æ•™å­¸ï¼Œä»¥ä¸‹å°‡å…ˆä»¥å¯¦ä½œåˆ‡å…¥&lt;/p>
&lt;h3 id="kernel-spaceuser-space-èˆ‡-kernel-module">kernel spaceã€user space èˆ‡ kernel module&lt;/h3>
&lt;p>å…ˆå‰æåˆ°ä½œæ¥­ç³»çµ±æ˜¯ç‚ºäº†çµ±ä¸€ç®¡ç†ç¡¬é«”è€Œå­˜åœ¨ï¼Œé¿å…æ‡‰ç”¨ç¨‹å¼éœ¸ä½”è³‡æºè€Œä½¿å…¶ä»–æ‡‰ç”¨ç¨‹å¼ç„¡æ³•ä½¿ç”¨ï¼Œåœ¨åŸ·è¡Œå±¤é¢ Linux æ‹†æˆ kernel space èˆ‡ user spaceï¼Œkernel space å¯ä»¥æ“ä½œæ‰€ä»¥çš„è³‡æºï¼Œè€Œä¸€èˆ¬æ‡‰ç”¨ç¨‹å¼åŸ·è¡Œæ–¼ user space ç•¶ä¸­ï¼Œé€™æ¨£çš„ä¿è­·æ˜¯åŸºæ–¼ &lt;code>CPU æ‰€æä¾›&lt;/code>ï¼ŒCPU æœ‰ä¸åŒçš„æ¨¡å¼å¯ä»¥ç”¨å‹ï¼Œkernel space æœ‰æœ€é«˜æ¬Šé™ (supervisor mode) è€Œ user space å‰‡æ˜¯æœ€ä½æ¬Šé™ (protect mode)&lt;/p>
&lt;p>kernel module æ˜¯åœ¨ &lt;code>Linux runtime å¯ä»¥å‹•æ…‹é–‹é—œè€Œä¸éœ€è¦é‡æ–°ç·¨è­¯ kernel image çš„ä¸€æ®µç¨‹å¼&lt;/code>ï¼Œå¯ç›´æ¥åœ¨ kernel space åŸ·è¡Œï¼Œå¸¸è¦‹ç‚º I/O device driver&lt;/p>
&lt;p>åˆå› ç‚º kernel module æ˜¯å±¬æ–¼ kernel çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä»–å€‘çš„è³‡æºæ˜¯å…±äº«çš„å¦‚è¨˜æ†¶é«”ï¼ŒåŒæ¨£çš„å¦‚æœ &lt;code>kernel module æœ‰å•é¡Œé€£å¸¶æ•´å€‹ kernel éƒ½æœƒ crash&lt;/code>ï¼Œä»¥ä¸‹å¯¦é©—å»ºè­°å¦å¤–é–‹ VM å˜—è©¦ï¼Œæˆ‘è‡ªå·±æ˜¯ç”¨ Macbook M1 + Ubuntu 20.20 VM åŸ·è¡Œ&lt;/p>
&lt;h3 id="hello-world---kernel-module">hello world - kernel module&lt;/h3>
&lt;p>åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#hello-and-goodbye" target="_blank" rel="noopener"
>lkmpg - 4.2 Hello and Goodbye&lt;/a>&lt;br>
è®“æˆ‘å€‘å…ˆå¾æœ€ç°¡å–®çš„ hello world é–‹å§‹ï¼Œå…ˆäº†è§£æœ€åŸºæœ¬çš„ kernel module å®‰è£ã€å¸è¼‰èˆ‡åŸ·è¡Œéç¨‹&lt;/p>
&lt;h4 id="1-hello-world">1. hello world&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * hello-1.c - The simplest kernel module.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;linux/kernel.h&amp;gt; /* Needed for pr_info() */ &lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;linux/module.h&amp;gt; /* Needed by all modules */ &lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">init_module&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">pr_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello world 1.&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* A non 0 return means init_module failed; module can&amp;#39;t be loaded. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">cleanup_module&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">pr_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Goodbye world 1.&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">MODULE_LICENSE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;GPL&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç·¨å¯« kernel module æ™‚ï¼Œæœ‰ä»¥ä¸‹ä¸‰é»å¿…å‚™&lt;/p>
&lt;ol>
&lt;li>ç•¶ module å®‰è£æ™‚è¦åšä»€éº¼ï¼šinit_module&lt;/li>
&lt;li>ç•¶ module ç§»é™¤æ™‚è¦åšä»€éº¼ï¼šcleanup_module&lt;/li>
&lt;li>æŒ‡å®š module çš„ licenseï¼šMODULE_LICENSE&lt;/li>
&lt;/ol>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€™å€‹ program åœ¨è¼¸å‡ºæ™‚æ˜¯ç”¨ pr_info è€Œé printfï¼ŒåŸå› æ˜¯åƒè€ƒ &lt;a class="link" href="https://www.calleluks.com/the-four-stages-of-compiling-a-c-program/" target="_blank" rel="noopener"
>C ç·¨è­¯éç¨‹&lt;/a> åœ¨ç¬¬ä¸‰éšæ®µ Assembly ç”¢å‡º object codeï¼Œå¦‚æœæœ‰å¤–éƒ¨å‡½å¼åº«å‘¼å«æœƒåœ¨ç¬¬å›› Linking éšæ®µè£œä¸Šç¼ºå°‘çš„ object codeï¼›&lt;br>
ä½†æ˜¯ kernel module çš„ç¬¬å››éšæ®µä¸åŒï¼Œä»–åªèƒ½è§£æ kernel æ‰€è¨»å†Šçš„ symbolï¼Œä¹Ÿå°±æ˜¯ kernel æœ¬èº«æä¾›çš„ system callï¼Œå¯ä»¥åœ¨ &lt;code>/proc/kallsyms&lt;/code> æŸ¥çœ‹&lt;/p>
&lt;h4 id="2-æ¢åˆ—--å®‰è£--ç§»é™¤-kernel-module">2. æ¢åˆ— / å®‰è£ / ç§»é™¤ kernel module&lt;/h4>
&lt;p>ç·¨è­¯ç”¨çš„ MakeFile åƒè€ƒä¸Šé™„é€£çµï¼Œç”¢å‡º module object code å¾Œï¼Œå¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤æ“ä½œ kernel module&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">// æ¢åˆ—
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo lsmod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// å®‰è£
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo insmod &lt;span class="o">{&lt;/span>module.ko&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// ç§»é™¤
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo rmmode &lt;span class="o">{&lt;/span>module&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥é€é &lt;code>$ sudo journalctl --since &amp;quot;1 hour ago&amp;quot; | grep kernel&lt;/code> æŸ¥çœ‹è¿‘ä¸€å°æ™‚ kernel module æ‰“å°çµæœ&lt;/p>
&lt;h3 id="device-driver">device driver&lt;/h3>
&lt;p>&lt;code>æ‰€æœ‰çš„è£ç½®åœ¨ linux ä¸­éƒ½æ˜¯ file&lt;/code>ï¼Œè³‡æ–™çµæ§‹å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fs.h" target="_blank" rel="noopener"
>include/linux/fs.h&lt;/a>ï¼Œé¦–å…ˆè¦å…ˆé‡æ¸…é€™é‚Šçš„ File &lt;code>åªå­˜åœ¨æ–¼ kernel&lt;/code>ï¼Œé›–ç„¶ä¸­æ–‡å¯èƒ½éƒ½è¢«ç¿»æˆæ–‡ä»¶æˆ–æª”æ¡ˆï¼Œä½†å¯¦éš›ä¸Šèˆ‡æª”æ¡ˆç³»çµ±ä¸­çš„æª”æ¡ˆæ¦‚å¿µæ˜¯ä¸åŒçš„! å¾Œè€…é€šå¸¸æ˜¯å«åš &lt;strong>inode&lt;/strong>&lt;/p>
&lt;p>æ‰€ä»¥æ¯ä¸€å€‹è£ç½®åœ¨ linux ä¸­éƒ½æ˜¯ä»¥ä¸€å€‹ file å­˜åœ¨ï¼Œé€šå¸¸å„²å­˜æ–¼ &lt;code>/dev/&lt;/code> åº•ä¸‹ï¼Œè€Œ device driver å‰‡æ˜¯ user space æ‡‰ç”¨ç¨‹å¼èˆ‡ device æºé€šçš„ç®¡é“ï¼Œæµç¨‹å¤§è‡´æ˜¯&lt;/p>
&lt;ol>
&lt;li>driver å‘ kernel è¨»å†Šå–å¾—å±¬æ–¼è‡ªå·±çš„è£ç½®ç·¨è™Ÿèˆ‡æŒ‡å®šæª”æ¡ˆ&lt;/li>
&lt;li>driver å®šç¾©æª”æ¡ˆæ“ä½œ&lt;/li>
&lt;/ol>
&lt;h4 id="1-è¨»å†Šè£ç½®">1. è¨»å†Šè£ç½®&lt;/h4>
&lt;p>åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#device-drivers" target="_blank" rel="noopener"
>lkmpg - 5.6 Device Drivers&lt;/a>
å…ˆè§€å¯Ÿç³»çµ±ä¸­æ—¢æœ‰çš„è£ç½®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ls -l /dev/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°é¡ä¼¼çš„è¼¸å‡º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">brw-rw---- &lt;span class="m">1&lt;/span> root disk 3, &lt;span class="m">1&lt;/span> Jul &lt;span class="m">5&lt;/span> &lt;span class="m">2000&lt;/span> /dev/hda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">brw-rw---- &lt;span class="m">1&lt;/span> root disk 3, &lt;span class="m">2&lt;/span> Jul &lt;span class="m">5&lt;/span> &lt;span class="m">2000&lt;/span> /dev/hda2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">brw-rw---- &lt;span class="m">1&lt;/span> root disk 3, &lt;span class="m">3&lt;/span> Jul &lt;span class="m">5&lt;/span> &lt;span class="m">2000&lt;/span> /dev/hda3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„åˆ° &amp;ldquo;3, 1&amp;rdquo; é€™é¡å‹çš„å­—ä¸²ï¼Œå‰é¢æ˜¯ major number å¾Œé¢æ˜¯ minor numberï¼Œåˆ†åˆ¥ä»£è¡¨ &lt;code>æŒ‡å®š driver, è£ç½® id&lt;/code>ï¼Œæ¯å€‹ device driver éƒ½æœƒè¢«åˆ†é…ä¸€å€‹ idï¼Œè€Œå¯èƒ½æœ‰å¤šå€‹è£ç½®éƒ½æ˜¯ç”±åŒä¸€å€‹ driver æ‰€é©…å‹•ï¼Œæ‰€ä»¥æœ‰ç¬¬äºŒå€‹ minor id è®“ driver å€åˆ†ä¸åŒçš„ç¡¬é«”&lt;/p>
&lt;p>æ¥è‘—æ³¨æ„åˆ°æœ€å‰çš„å­—å…ƒï¼Œå¯èƒ½æœƒçœ‹åˆ° &lt;code>d / b / c&lt;/code> ä¸‰ç¨®ï¼Œd ä»£è¡¨ directory ç›®éŒ„ï¼Œb ä»£è¡¨ blockã€c ä»£è¡¨ charï¼›&lt;br>
block device æ˜¯æŒ‡èªªæ“ä½œæœƒä»¥ block ç‚ºå–®ä½ï¼Œæ‰€ä»¥æœ‰æ™‚æ“ä½œæœƒè¢« buffer å¾Œæ‰åŸ·è¡Œï¼Œä¾‹å¦‚ç¡¬ç¢Ÿå„²å­˜è£ç½®ï¼Œå¯ä»¥æœ€ä½³åŒ–è®€å¯«çš„æ•ˆç‡ï¼›&lt;br>
char device å‰‡æ²’æœ‰ bufferï¼Œå¯ä»¥ä»»æ„è®€å¯«ä¸åŒçš„å¤§å°ï¼Œå¹¾ä¹å¤§å¤šæ•¸çš„è£ç½®éƒ½æ˜¯ char device&lt;/p>
&lt;h4 id="2-è¨»å†Šæª”æ¡ˆæ“ä½œ">2. è¨»å†Šæª”æ¡ˆæ“ä½œ&lt;/h4>
&lt;p>ç•¶æˆ‘å€‘æƒ³æŒ‡å®š device driver å¦‚ä½•æ“ä½œæª”æ¡ˆæ™‚ï¼Œæœƒå®šç¾© file_operationsï¼ŒæŒ‡å®šç•¶æª”æ¡ˆè¢«è®€å– / å¯«å…¥æ™‚è¦å°æ‡‰è§¸ç™¼çš„ handler functionï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹ struct ä¸­å¹¾ä¹éƒ½æ˜¯å®šç¾© &lt;a class="link" href="https://chenhh.gitbooks.io/parallel_processing/content/cython/function_pointer.html" target="_blank" rel="noopener"
>function pointer&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">struct&lt;/span> &lt;span class="n">file_operations&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">module&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">owner&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">loff_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">llseek&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">loff_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">ssize_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">__user&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">size_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">loff_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">ssize_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">__user&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">size_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">loff_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">ssize_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">read_iter&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">kiocb&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">iov_iter&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">ssize_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">write_iter&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">kiocb&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">iov_iter&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.....&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è£œå…… file ç›¸é—œè³‡æ–™ &lt;a class="link" href="https://blog.jaycetyle.com/2018/12/linux-fd-open-close/" target="_blank" rel="noopener"
>Linux ç³»çµ±ç¨‹å¼è¨­è¨ˆ - fd åŠ open()ã€close() ç³»çµ±å‘¼å«&lt;/a>ï¼Œfile åœ¨ Linux ä¸­å¿…é ˆå…ˆè¢« open() æ‰èƒ½åŸ·è¡Œå¾ŒçºŒçš„è®€å¯«æ“ä½œï¼Œopen() æ™‚æœƒæŠŠæª”æ¡ˆç¨±ä½œ &lt;code>open file&lt;/code>ï¼Œæ­¤æ™‚æœƒå›å‚³ &lt;code>file descriptor&lt;/code>ï¼Œè³‡æ–™çµæ§‹å°±æ˜¯ä¸Šé¢çš„ file_operations ç´€éŒ„æ¯ç¨®å‹•ä½œå°æ‡‰çš„è™•ç†æ–¹æ³•&lt;/p>
&lt;h4 id="3-ç¯„ä¾‹ç¨‹å¼ç¢¼">3. ç¯„ä¾‹ç¨‹å¼ç¢¼&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">file_operations&lt;/span> &lt;span class="n">chardev_fops&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">read&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">device_read&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">write&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">device_write&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">open&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">device_open&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">release&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">device_release&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">__init&lt;/span> &lt;span class="nf">chardev_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">major&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">register_chrdev&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DEVICE_NAME&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">chardev_fops&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">major&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">pr_alert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Registering char device failed with %d&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">major&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">major&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">pr_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;I was assigned major number %d.&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">major&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cls&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">class_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">THIS_MODULE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DEVICE_NAME&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">device_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">MKDEV&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">major&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DEVICE_NAME&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">pr_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Device created on /dev/%s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DEVICE_NAME&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">SUCCESS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* Methods */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* Called when a process tries to open the device file, like
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * &amp;#34;sudo cat /dev/chardev&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">device_open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">inode&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">inode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">counter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">atomic_cmpxchg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">already_open&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CDEV_NOT_USED&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CDEV_EXCLUSIVE_OPEN&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">EBUSY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;I already told you %d times Hello world!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">counter&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">try_module_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">THIS_MODULE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">SUCCESS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* This function is called whenever a process which has already opened the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * device file attempts to read from it.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">ssize_t&lt;/span> &lt;span class="nf">device_read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* see include/linux/fs.h */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">char&lt;/span> &lt;span class="n">__user&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* buffer to be filled */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">size_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* length of the buffer */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">loff_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">offset&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Number of bytes actually written to the buffer */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">bytes_read&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* How far did the process reading the message get? Useful if the message
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * is larger than the size of the buffer we get to fill in device_read.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">message_ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">message&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">message_ptr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">offset&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="cm">/* we are at the end of message */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* reset the offset */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* signify end of file */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message_ptr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">offset&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Actually put the data into the buffer */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">length&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">message_ptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Because the buffer is in the user data segment, not the kernel
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * data segment, assignment would not work. Instead, we have to
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * use put_user which copies data from the kernel data segment to
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * the user data segment.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">put_user&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">message_ptr&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bytes_read&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">pr_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Read %d bytes, %ld left&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bytes_read&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">offset&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">bytes_read&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Read functions are supposed to return the number of bytes actually
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * inserted into the buffer.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">bytes_read&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çµè«–é—œéµçš„ç¨‹å¼ç¢¼&lt;/p>
&lt;ol>
&lt;li>é€é register_chrdev è¨»å†Šè£ç½®èˆ‡æŒ‡å®šçš„ fileï¼Œç³»çµ±æœƒè¿”å› major number&lt;/li>
&lt;li>è¨»å†Š file_operatorsï¼Œå¯ä»¥æŒ‘é¸éœ€è¦çš„ handler è¨»å†Š&lt;/li>
&lt;li>å¯ä»¥æ³¨æ„ä¸€ä¸‹ device_read è¨»è§£ï¼Œè£¡é¢æœ‰å€‹ system call &lt;code>put_user&lt;/code>ï¼Œå› ç‚º driver æ˜¯åœ¨ kernel modeï¼Œè€Œ read æ˜¯å¾ user space è§¸ç™¼ï¼Œç•¶ä»Šå¤© driver æƒ³è¦å›å‚³è³‡æ–™çµ¦ user spaceï¼Œä¸èƒ½ç›´æ¥å¯«å…¥è¨˜æ†¶é«”ï¼Œè€Œæ˜¯éœ€è¦é€é put_user å°‡è¨˜æ†¶é«”å¾ kernel space è¤‡è£½åˆ° user space&lt;/li>
&lt;/ol>
&lt;p>åŸ·è¡Œä¸Šçš„ç´°ç¯€å°±ä¸è´…è¿°ï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹åƒè€ƒè³‡æ–™&lt;/p>
&lt;h4 id="io-blocking--non-blocking">IO blocking / non-blocking&lt;/h4>
&lt;p>åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#blocking-processes-and-threads" target="_blank" rel="noopener"
>lkmpg - 11 Blocking Processes and threads&lt;/a>&lt;/p>
&lt;p>ç•¶æ‡‰ç”¨ç¨‹å¼æ±ºå®šæ“ä½œ I/O æ™‚ï¼Œdevice driver å¯èƒ½é¢è‡¨è³‡æ–™å°šæœªæº–å‚™å¥½çš„æƒ…æ³ï¼Œæ­¤æ™‚æœƒé€é &lt;code>O_NONBLOCK&lt;/code> flag æ±ºå®šæ˜¯å¦ç‚º block æ‡‰ç”¨ç¨‹å¼ï¼Œå¦‚æœ non-blocking å‰‡ç›´æ¥å›å‚³éŒ¯èª¤ &lt;code>-O_NONBLOCK&lt;/code> è®“æ‡‰ç”¨ç¨‹å¼æ™šé»é‡è©¦ (polling)ï¼Œé€™ä¹Ÿå°±æ˜¯ Nodejs æ‰€é€éçš„æ–¹å¼ï¼Œnon-blocking I/O (é€™å¥è©±ä¸å…¨ç„¶å°ï¼Œé‚„æ˜¯è¦çœ‹ libuv é‡å°ä¸åŒ I/O çš„å¯¦ä½œï¼Œä½† non-blocking å°±æ˜¯æŒ‡é€™ç¨®æƒ…æ³æ²’éŒ¯)&lt;/p>
&lt;p>æˆ–æ˜¯æ‡‰ç”¨ç¨‹å¼é¸æ“‡ block modeï¼Œæ­¤æ™‚ device driver é‚„åœ¨ç­‰å¾…è³‡æ–™çš„åŒæ™‚ï¼Œå¯ä»¥é¸æ“‡é€é &lt;code>wait_event_interruptible&lt;/code> ä¸»å‹•äº¤å‡º CPU æ§åˆ¶æ¬Šï¼Œé¿å…ç„¡è¬‚çš„ä½”ç”¨ CPU è³‡æºï¼›
åŒæ™‚åœ¨ wait ä¹‹å‰æœƒå…ˆè¨»å†Šå°æ‡‰çš„ &lt;code>wake_up&lt;/code> äº‹ä»¶ï¼Œæˆ–æ˜¯æ”¶åˆ° signal æœƒå†å«é†’åŸæœ¬æ²ˆç¡çš„ process&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0206/blocking.png"
loading="lazy"
>&lt;br>
*åœ–ç‰‡åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://medium.com/@clu1022/%E6%B7%BA%E8%AB%87i-o-model-32da09c619e6" target="_blank" rel="noopener"
>https://medium.com/@clu1022/%E6%B7%BA%E8%AB%87i-o-model-32da09c619e6&lt;/a>&lt;/p>
&lt;p>é‡æ–°å›ä¾†çœ‹ blocking èˆ‡ non-blocking çš„åœ–ï¼Œé€™é‚Šæ˜¯å¾æ‡‰ç”¨ç¨‹å¼è§’åº¦å‡ºç™¼ï¼Œblocking I/O æœƒåœ¨ kernel device driver æ²’æœ‰è³‡æ–™æ™‚ç­‰å¾…ï¼Œä½†å¾ kernel è§’åº¦ï¼Œå¦‚æœæœ‰æŒ‡å®š interruptable å‰‡ä½œæ¥­ç³»çµ±æœƒåˆ‡æ›åˆ°ä¸åŒçš„ process å»ï¼Œæ‰€ä»¥ä¹Ÿä¸æœƒæœ‰è³‡æºæµªè²»çš„å•é¡Œ (æ’‡é™¤ context switching é–‹éŠ·)&lt;/p>
&lt;h3 id="system-call">system call&lt;/h3>
&lt;p>åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#system-calls" target="_blank" rel="noopener"
>lkmpg - 10. system call&lt;/a>&lt;/p>
&lt;p>å‰é¢å¯¦ä½œäº†ç°¡å–®çš„ kernel moduleï¼Œä¸¦çœ‹åˆ° device driver å¯ä»¥åœ¨ file ç™¼ç”Ÿè®ŠåŒ–æ™‚ç”¢ç”Ÿå°æ‡‰çš„è¡Œç‚ºï¼Œä½†ä¸€èˆ¬ä¾†èªªæ‡‰ç”¨ç¨‹å¼èˆ‡ kernel çš„äº’å‹•æ˜¯é€éå°è£éå¾Œçš„ system call&lt;/p>
&lt;p>Linux kernel æœƒæœ‰ä¸€å¼µ table &lt;code>sys_call_table&lt;/code> å„²å­˜æ”¯æ´çš„ system call èˆ‡å°æ‡‰çš„ addressï¼Œ ç•¶æ‡‰ç”¨ç¨‹å¼éœ€è¦æ“ä½œç¡¬é«”éœ€è¦æŒ‡å®š system callï¼Œä¾‹å¦‚ open() é–‹å•Ÿæª”æ¡ˆ / read() è®€å–æª”æ¡ˆç­‰ï¼Œåœ¨æš«å­˜å™¨å¯«å…¥æŒ‡å®šè³‡æ–™å¾Œé€éç‰¹æ®ŠæŒ‡ä»¤ interrupt é€šçŸ¥ CPU è¦åˆ‡æ› kernel space åŸ·è¡Œ (åœ¨ intel ä¸­æ˜¯ 0x80)ï¼Œé€²éšè³‡æ–™å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://en.wikipedia.org/wiki/Protection_ring" target="_blank" rel="noopener"
>CPU protection ring&lt;/a>&lt;/p>
&lt;h4 id="1-å¾-printf-è§€å¯Ÿ-system-call">1. å¾ printf è§€å¯Ÿ system call&lt;/h4>
&lt;p>åƒè€ƒ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#functions-available-to-modules" target="_blank" rel="noopener"
>lkmpg 5.2 Functions available to modules&lt;/a>
é€éæœ€ç°¡å–®çš„ c program printf ä¾†çœ‹ system call çš„åŸ·è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt; &lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰“åŒ…å¾Œé€é &lt;a class="link" href="https://strace.io/" target="_blank" rel="noopener"
>strace&lt;/a> æŸ¥çœ‹ system call ç‹€æ³&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ gcc -Wall -o hello hello.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ strace ./hello.o
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰“å°å‡ºè »å¤šæ±è¥¿ï¼ŒåŒ…å«ä¸€äº› memory allocate çš„æŒ‡ä»¤ç­‰ï¼Œæœ€çµ‚å¯ä»¥çœ‹åˆ° &lt;code>write&lt;/code> çš„ system call å‘¼å«&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">write&lt;span class="o">(&lt;/span>1, &lt;span class="s2">&amp;#34;hello world&amp;#34;&lt;/span>, 11hello world&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">exit_group&lt;span class="o">(&lt;/span>0&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2-ä¿®æ”¹-system-call">2. ä¿®æ”¹ system call&lt;/h4>
&lt;p>å¦‚æœæˆ‘å€‘å¸Œæœ›ä¿®æ”¹ system callï¼Œç†è«–ä¸Šå¯ä»¥ç›´æ¥æ”¹ sys_call_table çš„ mappingï¼Œä½†åŸºæ–¼å®‰å…¨æ€§è€ƒé‡é€™æ˜¯ç„¡æ³•ç›´æ¥åœ¨ runtime æ“ä½œçš„ï¼ŒåŸå› æ˜¯é¿å… hacker ç›´æ¥ä¿®æ”¹ system call&lt;/p>
&lt;p>ç¬¬äºŒå€‹å˜—è©¦å¯ä»¥é€é &lt;code>$sudo grep sys_call_table /proc/kallsyms&lt;/code> æ‰¾å‡º sys_call_table æ‰€å„²å­˜çš„å¯¦éš›è¨˜æ†¶é«”ä½ç½®ä¸¦æ›¿æ›ï¼Œä½†é€™ç›®å‰ä¹Ÿä¸è¡Œï¼ŒåŒæ¨£æ˜¯å› ç‚ºå®‰å…¨æ€§è€ƒé‡ï¼Œ Linux kernel åœ¨æ¯æ¬¡ boot æ™‚æœƒå‹•æ…‹æ“¾äº‚ kernel code è·Ÿ data (ç¨±ç‚º KASLR)ï¼Œå¢åŠ  hacker å˜—è©¦æ”»æ“Šçš„é›£åº¦&lt;/p>
&lt;p>ä¸€å€‹å¯è¡Œçš„åšæ³•æ˜¯é€é &lt;a class="link" href="https://ztex.medium.com/kprobe-%E7%AD%86%E8%A8%98-59d4bdb1e1fe" target="_blank" rel="noopener"
>kprobe&lt;/a>ï¼Œé€™æ˜¯ä¸€å€‹ kernel debug çš„å·¥å…·ï¼Œç•¶ CPU åŸ·è¡Œåˆ°ä¸­æ–·é»æ™‚æœƒä¿å­˜æš«å­˜å™¨ç‹€æ…‹ï¼Œä¸¦åŸ·è¡Œ kprobe æŒ‡å®šçš„æŒ‡ä»¤ï¼Œå¯ä»¥é€éé€™ç¨®æ–¹å¼å»å‹•æ…‹èª¿æ•´ system call åŸ·è¡Œ&lt;/p>
&lt;p>ä½†ä¸Šé¢çš„æ–¹æ³•åœ¨ production å¾ˆå±éšªï¼Œè©¦æƒ³å¦‚æœæœ‰å¤šå€‹ kernel module å»èª¿æ•´ system callï¼Œåœ¨ restore æ™‚å¯èƒ½æœƒç™¼ç”Ÿæ„å¤–ï¼Œä¸è«–æ˜¯å¾©åŸéŒ¯èª¤æˆ–æ˜¯åŸ·è¡Œåˆ°å·²ç¶“ç§»é™¤çš„ kernel moduleï¼Œæ‰€ä»¥å»ºè­°æ˜¯ç›´æ¥é‡æ–°ç·¨è­¯ kernel&lt;/p>
&lt;h2 id="cpu-èˆ‡-hardware-interrupt">CPU èˆ‡ Hardware interrupt&lt;/h2>
&lt;p>ä¸Šé¢å¤§è‡´æè¿°ç¶ ç·šçš„èµ°å‘ï¼Œå¾ user space å‘¼å« system callï¼Œè§¸ç™¼å°æ‡‰ device driver æ‰€æŒ‡å®šçš„ file operation&lt;/p>
&lt;p>æ¥ä¸‹ä¾†çœ‹è—ç·šçš„éƒ¨åˆ†ï¼Œç•¶ I/O device æ”¶åˆ°å¤–éƒ¨è¨Šè™Ÿå¦‚ç¶²å¡æ”¶åˆ°å°åŒ…ã€éµç›¤è¢«æŒ‰ä¸‹æŒ‰éˆ•ï¼Œå¦‚ä½•é€å‡ºä¸­æ–·çµ¦ CPU ä¸¦é€²å…¥å¾ŒçºŒçš„è™•ç†&lt;/p>
&lt;p>å…·é«”å…§å®¹è«‹åƒè€ƒå®…è‰²å¤«çš„ &lt;a class="link" href="https://hackmd.io/@sysprog/linux-interrupt" target="_blank" rel="noopener"
>Linux æ ¸å¿ƒè¨­è¨ˆ: ä¸­æ–·è™•ç†å’Œç¾ä»£æ¶æ§‹è€ƒé‡&lt;/a>ï¼Œé€™é‚Šåƒ…å¤§è‡´æä¸€ä¸‹æµç¨‹&lt;/p>
&lt;ol>
&lt;li>I/O è£ç½®é€å‡º Interrupt Request (IRQ)&lt;/li>
&lt;li>Hardware controller æ•´ç†å¾Œé€å‡º interrupt vector åˆ° CPU&lt;/li>
&lt;li>CPU åˆ‡æ›æ¨¡å¼ç«‹å³è™•ç† interruptï¼Œé€é ISR æ‰¾åˆ°å°æ‡‰çš„ Interrupt Handler&lt;/li>
&lt;li>Interrupt handler ä¸­æœ‰åˆ†æˆ top half / bottom halfï¼Œtop half æ˜¯ä¸æœƒè¢«å…¶ä»– Interrupt ä¸­æ–·ï¼Œæ‰€ä»¥ä¸€å®šæœƒç•¶ä¸‹å®Œæˆï¼›è€Œ bottom half å‰‡æœƒè¢«æ’å…¥ softiqr é‡æ–°æ’æˆï¼Œ&lt;code>soft&lt;/code> åœ¨ OS ä¸­æœ‰æ™‚æ˜¯ä»£è¡¨ä¸ç¢ºå®šä½•æ™‚æœƒè¢«å®Œæˆ&lt;/li>
&lt;/ol>
&lt;p>å¯¦ä½œé¢çš„éƒ¨åˆ†åƒè€ƒ &lt;a class="link" href="https://sysprog21.github.io/lkmpg/#detecting-button-presses" target="_blank" rel="noopener"
>lkmpg 15.2 Detecting button presses&lt;/a>ï¼Œé€é &lt;code>request_irq&lt;/code> è¨»å†Š interrupt requestï¼Œç•¶æŒ‡å®šçš„ I/O ç™¼ç”Ÿ interrupt æ™‚å°±æœƒå‘¼å«è¨»å†Šçš„ funtion&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">request_irq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">button_irqs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">button_isr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">IRQF_TRIGGER_RISING&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">IRQF_TRIGGER_FALLING&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;gpiomod#button1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ›´å¤šçš„è¨è«–å¯ä»¥åƒè€ƒæ–‡ä»¶ï¼Œä¸åŒçš„ CPU èˆ‡ä½œæ¥­ç³»çµ±æœ‰ä¸åŒçš„è€ƒé‡ï¼Œè€ƒæ…®åˆ°æ’ç¨‹ realtime OS çš„è¨­è¨ˆåˆæœƒæœ‰ä¸åŒ&lt;/p>
&lt;h2 id="å»¶ä¼¸linux-çš„-asynchronous-io">å»¶ä¼¸ï¼šLinux çš„ Asynchronous I/O&lt;/h2>
&lt;p>ç¾åœ¨æµè¡Œçš„ network I/O è™•ç†æ–¹å¼æ˜¯é€é I/O multiplexingï¼Œå¦‚ Linux çš„ epollï¼Œè€Œ asynchrous I/O çœ‹èµ·ä¾†ååˆ†çš„è¿·äººï¼Œæ‡‰ç”¨ç¨‹å¼ç™¼å‡ºè«‹æ±‚å¾Œå°±ç›´æ¥ç­‰åˆ°ä½œæ¥­ç³»çµ±é€šçŸ¥ï¼Œä¸­é–“å®Œå…¨ä¸ç”¨ç­‰å¾…ï¼Œä½†ç‚ºä»€éº¼ç›®å‰æ²’æœ‰è¢«å¤§è¦æ¨¡æ¡ç´å‘¢ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0206/io2.png"
loading="lazy"
>&lt;br>
*åœ–ç‰‡åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://medium.com/@clu1022/%E6%B7%BA%E8%AB%87i-o-model-32da09c619e6" target="_blank" rel="noopener"
>https://medium.com/@clu1022/%E6%B7%BA%E8%AB%87i-o-model-32da09c619e6&lt;/a>&lt;/p>
&lt;p>åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://kernel.dk/io_uring.pdf" target="_blank" rel="noopener"
>Efficient IO with io_uring&lt;/a>ï¼ŒAIO åœ¨ Linux 2.5 å°±å·²ç¶“åŠ å…¥äº†ï¼Œä½†æŒçºŒè¢«è©¬ç—…ä¾‹å¦‚é‡å° buffer i/o é‚„æ˜¯æœƒè®Šæˆ synchronous ä¸” API é›£ä»¥ä½¿ç”¨ï¼Œåœ¨ Linux 5.1 å¾ŒåŠ å…¥äº† &lt;code>io_urning&lt;/code>æ–°çš„ AIO API ä¸¦æŒçºŒå„ªåŒ–&lt;/p>
&lt;p>libuv æœ‰é–‹å§‹è¨è«–å°å…¥ io_uring çš„éƒ¨åˆ†ï¼Œæœ‰äººæä¾› &lt;a class="link" href="https://github.com/libuv/libuv/issues/1947#issuecomment-485230126" target="_blank" rel="noopener"
>benchmark&lt;/a> åœ¨è®€å–æª”æ¡ˆéƒ¨åˆ†å¯ä»¥æ¯”åŸæœ¬çš„ thread pool è¨­è¨ˆæ›´å¿«&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/13407542/is-there-really-no-asynchronous-block-i-o-on-linux" target="_blank" rel="noopener"
>SO: Is there really no asynchronous block I/O on Linux?&lt;/a> è£¡é¢æœ‰æä¾›å¾ˆå¤šçš„ç›¸é—œé€£çµï¼Œè³‡æ–™åº«å¦‚ PostgreSQL / RocksDB å˜—è©¦ç”¨ io_uring æå‡ç¡¬ç¢Ÿè®€å¯«æ•ˆèƒ½ï¼Œåœ¨ networking æ–¹é¢ä¹Ÿæœ‰ä¸€äº›å˜—è©¦ï¼Œåœ¨å¦ä¸€ç¯‡æ–‡ç«  &lt;a class="link" href="https://hackmd.io/@shanvia/B1Ds1vlAD" target="_blank" rel="noopener"
>Epoll vs. io_uring æ•ˆèƒ½æ¸¬è©¦èˆ‡æ¯”è¼ƒ&lt;/a>çœ‹èµ·ä¾†æ•ˆèƒ½æå‡ä¸å°‘ï¼ŒCPU ä½¿ç”¨ç‡ä½ä¸”èƒ½è™•ç†æ›´å¤šçš„ requestï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†æ·±å…¥ç ”ç©¶&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>çªç„¶é–“ä¸çŸ¥å¦‚ä½•ç¸½çµï¼Œç ”ç©¶çš„éç¨‹æ¯”æƒ³åƒä¸­ç™¼æ•£ï¼Œçœ‹äº†å¾ˆå¤šæ–‡ä»¶ XD&lt;/p>
&lt;p>å¤§æŠµä¸Šå¾ high level è§’åº¦ç†è§£äº†æ•´å€‹ I/O ç™¼ç”Ÿçš„éç¨‹ï¼Œèªè­˜åˆ°äº†ã€Œæ‡‰ç”¨ç¨‹å¼è®€å¯« IO çš„éç¨‹ã€ï¼Œä¸­é–“æ¶‰åŠåˆ° system call / kernel module çš„åŸ·è¡Œï¼Œä»¥åŠ OS context switch çš„éç¨‹ï¼Œæˆ–è¨±æˆ‘çœŸæ­£æƒ³é‡æ¸…çš„æ˜¯ &lt;code>ä¸¦éæŠŠ I/O è®Šæˆ non-blocking / asynchronous ç³»çµ±æ•ˆèƒ½å°±æœƒç„¡è…¦æå‡&lt;/code>ï¼Œmemory çš„ copy / interrupt handler è™•ç†ç­‰é‚„æ˜¯æœƒä½”ç”¨ CPU æ™‚é–“ï¼Œå¯ä»¥åƒè€ƒå¦ä¸€ç¯‡ &lt;a class="link" href="" >cloudflare&lt;/a> çš„æ•´ç†ï¼ŒçœŸæ­£æƒ³åšåˆ°æ•ˆèƒ½æå‡æœ‰æ™‚é‚„æ˜¯éœ€è¦ I/O è£ç½®çš„å‡ç´š&lt;/p>
&lt;p>ç ”ç©¶çš„éç¨‹é‚„æœ‰å¾ˆå¤šæ²’è§£é‡‹æ¸…æ¥šçš„åœ°æ–¹ï¼Œä¾‹å¦‚ File çš„è³‡æ–™å¦‚ä½•è¢« I/O è£ç½®è®€å¯«ï¼Œéœ€è¦åœ¨æ¶‰çµæ›´å¤šç¡¬é«”ç›¸é—œçš„çŸ¥è­˜ï¼Œæˆ–è¨±è©²ä¾†ç ”ç©¶æ¨¹è“æ´¾äº† XD&lt;/p>
&lt;p>ç¸½ä¹‹ï¼Œä¹Ÿç®—æ˜¯ç¨ç¨é‡æ¸…å›°æ“¾è‡ªå·±å¤šå¹´çš„ç–‘æƒ‘ï¼Œå¸Œæœ›ä¹Ÿå¯ä»¥åˆ†äº«çµ¦å°æ–¼æ‡‰ç”¨ç¨‹å¼èˆ‡ I/O è£ç½®äº’å‹•æœ‰ç–‘å•çš„äººï¼Œæˆ‘åœ¨æ¯ä¸€æ®µéƒ½ç›¡å¯èƒ½ç•™ä¸‹åƒç…§çš„ lkmpg ç« ç¯€ï¼Œå¼·çƒˆæ¨è–¦æœ‰èˆˆè¶£å¯ä»¥è®€å®Œæ•´ç¯‡ï¼Œå°æ–¼ Linux ä½œæ¥­ç³»çµ±æœ‰åŸºæœ¬çš„èªçŸ¥&lt;/p>
&lt;p>å¦‚æœæœ‰ä»»ä½•ä¸æ¸…æ¥šæˆ–å¯«éŒ¯çš„åœ°æ–¹ï¼Œå†éº»ç…©ç•™è¨€æŒ‡æ•™&lt;/p></description></item><item><title>ç­†è¨˜ï¼šCloudFlare å„ªåŒ–å°åŒ…æ¥æ”¶çš„éç¨‹</title><link>https://yuanchieh.page/posts/2022/2022-02-02-%E7%AD%86%E8%A8%98cloudflare-%E5%84%AA%E5%8C%96%E5%B0%81%E5%8C%85%E6%8E%A5%E6%94%B6%E7%9A%84%E9%81%8E%E7%A8%8B/</link><pubDate>Wed, 02 Feb 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-02-02-%E7%AD%86%E8%A8%98cloudflare-%E5%84%AA%E5%8C%96%E5%B0%81%E5%8C%85%E6%8E%A5%E6%94%B6%E7%9A%84%E9%81%8E%E7%A8%8B/</guid><description>&lt;p>æœ€è¿‘æƒ³äº†è§£ä¸€ä¸‹ä½œæ¥­ç³»çµ±è™•ç† I/O çš„éç¨‹ï¼Œç¿»é–±åˆ° CloudFlare ä¸€ç³»åˆ—é—œæ–¼ä½œæ¥­ç³»çµ±èˆ‡ Network Packet è™•ç†çš„å¯¦é©—èˆ‡æ–‡ç« ï¼Œè »æœ‰è¶£çš„ç¨å¾®æ•´ç†äº†ä¸€ä¸‹&lt;/p>
&lt;h2 id="é—œæ–¼-linux-å°åŒ…è™•ç†">é—œæ–¼ Linux å°åŒ…è™•ç†&lt;/h2>
&lt;p>ä¸»è¦åœ¨é‡æ¸¬ Linux æ¥µé™å¯ä»¥è™•ç†å¤šå°‘ packet per second / ä»¥åŠå¦‚ä½•æŒçºŒå„ªåŒ–&lt;/p>
&lt;h3 id="linux-å–®æ©Ÿè™•ç†-1m-udp-packet-per-second">Linux å–®æ©Ÿè™•ç† 1M udp packet per second&lt;/h3>
&lt;p>æ–‡ç« å‡ºè‡ªï¼š&lt;a class="link" href="https://blog.cloudflare.com/how-to-receive-a-million-packets/" target="_blank" rel="noopener"
>How to receive a million packets per second&lt;/a>ï¼Œåœ¨ç¡¬é«”è¦æ ¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">1. six core 2GHz Xeon processors.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. With hyperthreading &lt;span class="o">(&lt;/span>HT&lt;span class="o">)&lt;/span> enabled that counts to &lt;span class="m">24&lt;/span> processors on each box
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. multi-queue 10G network card by Solarflare
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. with &lt;span class="m">11&lt;/span> receive queues configured.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥æ’åˆ°æ¯ç§’æ¥æ”¶ä¸€ç™¾è¬å€‹ udp å°å°åŒ…(32 bytes)ï¼Œç™¼é€è·Ÿæ¥æ”¶ç«¯åœ¨åŒå€‹å€ç¶²çš„ä¸åŒæ©Ÿå™¨ä¸Š&lt;/p>
&lt;p>ä¸­é–“çš„å˜—è©¦è¿­ä»£éç¨‹å¾ˆæœ‰è¶£&lt;/p>
&lt;h4 id="1-è£¸æ¸¬">1. è£¸æ¸¬&lt;/h4>
&lt;p>åƒ…èƒ½åˆ° 0.19~0.35 Mï¼Œç™¼ç¾ kernel å¯èƒ½éš¨æ©Ÿåˆ†é… process åˆ°ä¸åŒ CPU ä¸Šï¼Œé€é &lt;code>taskset&lt;/code> æŒ‡å®š CPU é‹è¡Œï¼Œç©©å®šåœ¨ 0.35 M ä¸Šä¸å»ï¼Œç™¼ç¾åªæœ‰å–®ä¸€ CPU å¿™ç¢Œåˆ° 100%&lt;/p>
&lt;h4 id="2-numa-æ¶æ§‹å„ªåŒ–">2. NUMA æ¶æ§‹å„ªåŒ–&lt;/h4>
&lt;p>å¤šæ ¸å¿ƒè™•ç†å™¨ç‚ºäº†é¿å…å¤šæ ¸å¿ƒåœ¨å­˜å– Memory çš„è²§é ¸ï¼Œæœƒæ¡ç”¨ NUMA æ¶æ§‹ï¼Œè®“ä¸€è‡³å¤šå€‹ CPU core å…±ç”¨ä¸€å¡Š memory çµ„æˆä¸€å€‹ NUMA nodeï¼›
&lt;img src="https://www.motioncontroltips.com/wp-content/uploads/2018/04/NUMA-Architecture.png"
loading="lazy"
>&lt;/p>
&lt;ul>
&lt;li>åœ–ç‰‡å‡ºè™• &lt;a class="link" href="https://hackmd.io/@lkmem/SkWYoA-TU" target="_blank" rel="noopener"
>@lkmem/SkWYoA-TU&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>NUMA å¥½è™•æ˜¯å¦‚æœ CPU éƒ½åªå­˜å– local memory æ•ˆç‡æœƒéå¸¸å¥½ï¼Œå¦‚æœè¦å­˜å–åˆ°ä¸åŒå€åŸŸçš„ memory æˆ–æ˜¯ä»»å‹™åœ¨ä¸åŒ NUMA node CPU ä¸­ context switch å‰‡æ•ˆç‡æœƒå¾ˆå·®ï¼Œä½œè€…é€²è¡Œä»¥ä¸‹æ¯”è¼ƒï¼š&lt;/p>
&lt;ol>
&lt;li>å¦‚æœ RX queue å’Œæ‡‰ç”¨ç¨‹å¼æ˜¯åœ¨åŒä¸€å€‹ NUMA node çš„ä¸åŒ core ä¸Šï¼Œæ•ˆèƒ½æ˜¯æœ€å¥½çš„&lt;/li>
&lt;li>å¦‚æœæ˜¯åœ¨ä¸åŒçš„ NUMA node ä¸Šï¼Œå‰‡æ•ˆèƒ½å·®ä¸”ä¸ç©©å®š&lt;/li>
&lt;li>å¦‚æœæ˜¯åœ¨åŒå€‹è¶…åŸ·è¡Œç·’(HT)ä¸Šï¼Œå‰‡æ•ˆèƒ½åªå‰©ä¸€åŠ&lt;/li>
&lt;/ol>
&lt;h4 id="3-å¢åŠ -nic-çš„-rx-queue-æ•¸é‡">3. å¢åŠ  NIC çš„ RX queue æ•¸é‡&lt;/h4>
&lt;p>éå¾€ NIC åªæœ‰ä¸€å€‹ RX queue ç”¨ä¾†å­˜æ”¾æ¥æ”¶åˆ°çš„å°åŒ…ï¼Œè€Œ&lt;code>ä¸€å€‹ RX queue åªèƒ½ç”±ä¸€å€‹ CPU è®€å–&lt;/code>é™åˆ¶äº†å¤šæ ¸å¿ƒæ©Ÿå™¨çš„æ•ˆèƒ½ï¼Œæ‰€ä»¥ NIC ç›®å‰éƒ½æœƒæœ‰å¤šæ¢ RX queue&lt;/p>
&lt;p>ä½†æ˜¯æœ‰äº†å¤šæ¢ queueï¼ŒNIC éœ€è¦æŠŠåŒä¸€å€‹ connection çš„å¤šå€‹ packet é€åˆ°åŒä¸€å€‹ queue ä¸­è®“åŒä¸€å€‹ CPU è™•ç†ï¼Œå¦å‰‡æœƒé‡åˆ° packet order äº‚æ‰çš„å•é¡Œï¼Œæ­¤æ™‚å¯ä»¥é€é hashing è§£æ±ºï¼Œhash function ç‚º {ip, port}&lt;/p>
&lt;p>å¾Œä¾†å› ç‚ºå¯¦é©—çš„ NIC ç„¡æ³•èª¿æ•´ hash æ©Ÿåˆ¶ï¼Œæ‰€ä»¥æ”¹ç”¨å¢åŠ  IP çš„æ–¹å¼ï¼Œä½†ç›®çš„ä¹Ÿæ˜¯è¦æŠŠ &lt;code>packet åˆ†æ•£åˆ°å¤šå€‹ RX queue ä¸Š&lt;/code>ï¼Œæ­¤èˆ‰å¢åŠ åˆ° 0.47M&lt;/p>
&lt;h4 id="4-åŠ é–‹-recv-thread">4. åŠ é–‹ recv thread&lt;/h4>
&lt;p>åŸæœ¬æ˜¯ç”¨ single thread æ¥æ”¶ï¼Œå˜—è©¦é–‹å•Ÿ multi thread ä½†åè€Œæ€§èƒ½ä¸‹é™ï¼ŒåŸå› æ˜¯å¤šå€‹ thread å…±ç”¨åŒä¸€å€‹ file descriptor éœ€è¦é¡å¤– lock&lt;/p>
&lt;p>ä½†å¥½åœ¨ Linux åœ¨ 3.9 å¾ŒåŠ å…¥äº† &lt;code>SO_REUSEPORT&lt;/code> å¯ä»¥è®“å¤šå€‹socket descriptor ç¶å®šåˆ°åŒä¸€å€‹ port ä¸Šï¼Œæ‰€ä»¥è®“å¤šå€‹ thread å¯ä»¥åˆ†æ“”è®€å–çš„å·¥ä½œï¼Œä½†ä½œè€…åŒæ¨£è§€å¯Ÿåˆ° SO_REUSEPORT é€™ä¸€å±¤åŒæ¨£æœ‰åˆ†æ•£ä¸å¹³å‡çš„å•é¡Œï¼Œåªæœ‰å¹¾å€‹ CPU ç‰¹åˆ¥å¿™ç¢Œ&lt;/p>
&lt;blockquote>
&lt;p>One of the features merged in the 3.9 development cycle was TCP and UDP support for the SO_REUSEPORT socket option; that support was implemented in a series of patches by Tom Herbert. The new socket option allows &lt;code>multiple sockets on the same host to bind to the same port&lt;/code>, and is intended to improve the performance of &lt;code>multithreaded network server&lt;/code> &amp;hellip;..&lt;/p>
&lt;p>&amp;hellip;. Incoming connections and datagrams are distributed to the server sockets using a &lt;code>hash based on the 4-tuple of the connection&lt;/code>â€”that is, the peer IP address and port plus the local IP address and port.&lt;/p>
&lt;/blockquote>
&lt;h4 id="å°çµ">å°çµ&lt;/h4>
&lt;p>å–®æ©Ÿ Linux å„ªåŒ–å¾Œå¯ä»¥åšåˆ°æ¯ç§’æ¥æ”¶ 1M UDP packet&lt;/p>
&lt;ol>
&lt;li>è¨˜å¾—å°‡ packet åˆ†æ•£åˆ° RX queue&lt;/li>
&lt;li>æ¥æ”¶ç«¯æ‡‰ç”¨ç¨‹å¼è¦æ‰“é–‹ SO_REUSEPORT ä¸¦é€é multi thread è®€å–&lt;/li>
&lt;li>è¦æœ‰å¤šçš„ CPU è² è²¬å¾ RX queue è®€å–&lt;/li>
&lt;li>å¦‚æœæ˜¯ NUMA æ¶æ§‹ï¼ŒRX queue / æ‡‰ç”¨ç¨‹å¼çš„ CPU è¦åœ¨åŒä¸€å€‹ Node æ€§èƒ½æ¯”è¼ƒå¥½&lt;/li>
&lt;/ol>
&lt;h3 id="ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦-linux-kernel-è™•ç†-tcp-stack">ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ Linux kernel è™•ç† TCP stack?&lt;/h3>
&lt;p>æ–‡ç« å‡ºè‡ªï¼š&lt;a class="link" href="https://blog.cloudflare.com/why-we-use-the-linux-kernels-tcp-stack/" target="_blank" rel="noopener"
>Why we use the Linux kernel&amp;rsquo;s TCP stack&lt;/a>&lt;/p>
&lt;h4 id="ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦-os">ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ OS&lt;/h4>
&lt;p>è©¦æƒ³ä¸€å€‹å•é¡Œï¼Œå¦‚æœæˆ‘å€‘ä¸€å° server ä¸Šåªè·‘ä¸€å€‹å°ˆç”¨çš„æ‡‰ç”¨ç¨‹å¼ï¼Œé‚£ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦å…ˆé¡å¤–å®‰è£ä¸€å€‹ä¸Šåƒè¬è¡Œçš„ OS å»ä»£ç†åŸ·è¡Œæˆ‘å€‘çš„æ‡‰ç”¨ç¨‹å¼ï¼Ÿ&lt;/p>
&lt;p>OS ä¸»è¦æä¾›å¹¾å€‹å¥½è™•ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>æŠ½è±¡åŒ–ç¡¬é«”ã€æä¾›çµ±ä¸€ä»‹é¢ï¼š&lt;/strong>&lt;br>
OS æœƒæŠ½è±¡åŒ–åº•å±¤çš„ç¡¬é«”ï¼Œè®“æ‡‰ç”¨ç¨‹å¼å°ˆæ³¨æ–¼é–‹ç™¼è€Œä¸ç”¨ç®¡å¯¦éš›åŸ·è¡Œçš„ç¡¬é«”ç‚ºä½•ï¼Œå¸¶ä¾†æ›´å¥½çš„ç§»æ¤æ€§&lt;/li>
&lt;li>&lt;strong>è³‡æºç®¡ç†ï¼š&lt;/strong>&lt;br>
OS å¯ä»¥é€éæ’ç¨‹è®“ä¸€å€‹ç¡¬é«”æ–¼å¤šå€‹æ‡‰ç”¨ç¨‹å¼é–“åˆ‡æ›ä½¿ç”¨ï¼Œè€Œä¸æœƒæœ‰ä¸€å€‹æ‡‰ç”¨ç¨‹å¼éœ¸ä½”æ•´å€‹ç¡¬é«”è³‡æºï¼Œä¾‹å¦‚ç¶²å¡å¯åŒæ™‚è™•ç† server request ä¹Ÿå¯ç”¨æ–¼ ssl sesson&lt;/li>
&lt;/ol>
&lt;h4 id="ç‚ºä»€éº¼éœ€è¦-userspace-tcp-stack">ç‚ºä»€éº¼éœ€è¦ userspace TCP stack&lt;/h4>
&lt;p>å¦‚æœé€é OS å‰‡è®€å¯«ç¡¬é«”è³‡æºæ™‚éœ€è¦æ¶‰åŠ user space / kernel space è³‡æ–™çš„è¤‡è£½èˆ‡ context switchï¼Œé€™æœƒå¸¶ä¾†é¡å¤–çš„ latency / CPU performance å½±éŸ¿&lt;/p>
&lt;p>ä¾‹å¦‚ Googleã€Cloudflare é€™ç¨®ç¶²è·¯æµé‡éå¸¸å¤§çš„å…¬å¸ï¼Œå°±æœƒæœ‰å‹•æ©Ÿå»å®¢è£½åŒ– TCP stackï¼Œæ‰€è¬‚çš„ userspace TCP stack å°±æ˜¯ &lt;code>ç¹é(bypass) OS Kernel&lt;/code>ç›´æ¥å­˜å–ç¶²å¡ï¼Œé€™å¼µç¶²å¡å°±å°ˆé–€è¢«å–®ä¸€çš„æ‡‰ç”¨ç¨‹å¼æ‰€ä½¿ç”¨ï¼ŒOS çš„ç›£æ§å·¥å…· (iptable/netstat) ç­‰éƒ½ç„¡æ³•ä½¿ç”¨ï¼Œå…¶ä»–æ‡‰ç”¨ç¨‹å¼ä¹Ÿéƒ½ä¸èƒ½&lt;/p>
&lt;p>Cloudflare æœ‰æåˆ°é€é Linux iptable å¤§æ¦‚å¯ä»¥è™•ç†&lt;code>æ¯ç§’ä¸€ç™¾è¬çš„ packets&lt;/code>ï¼Œè€Œ Cloudflare åœ¨é­é‡æ”»æ“Šæ™‚æµé‡æœƒåœ¨ &lt;code>å–®å° server æ¯ç§’ä¸‰ç™¾è¬çš„ packets&lt;/code>ï¼Œé€™ä¹Ÿæ˜¯ä»–å€‘éœ€è¦ç¹é kernel è‡ªè¡Œè™•ç†çš„å‹•æ©Ÿ&lt;/p>
&lt;p>ä½†ç›®å‰æ²’æœ‰ç©©å®šçš„ open-source userspace TCP stack å¯ä»¥ä½¿ç”¨ï¼Œè¦è‡ªå·±ç¶­è­·é–‹ç™¼ï¼Œé™¤äº†åŸ·è¡Œå¤–å‘¨é‚Šçš„ debugã€monitor å·¥å…·éƒ½è¦è‡ªå·±æƒ³è¾¦æ³•&lt;code>æˆæœ¬å¾ˆé«˜&lt;/code>ï¼Œæ‰€ä»¥ Cloudflare æ¡å–&lt;code>åŠç¹é&lt;/code>çš„æ–¹å¼ï¼Œåªæœ‰ &amp;ldquo;RX queue&amp;rdquo; æœƒç¹é kernelï¼Œé€™å¸¶ä¾†çš„å¥½è™•æ˜¯äº«æœ‰ä¸€å®šçš„æ•ˆèƒ½æå‡ä¸”å…¶é¤˜ packets è™•ç†èƒ½ä»°è³´æ—¢æœ‰çš„å·¥å…·å¦‚ iptables/netstat&lt;/p>
&lt;h3 id="å„ªåŒ–-latency">å„ªåŒ– latency&lt;/h3>
&lt;p>æ–‡ç« å‡ºè‡ªï¼š&lt;a class="link" href="https://blog.cloudflare.com/how-to-achieve-low-latency/" target="_blank" rel="noopener"
>How to achieve low latency with 10Gbps Ethernet&lt;/a>&lt;br>
å‰é¢å„ªåŒ–äº† throughputï¼Œç¾åœ¨è¦ä¾†çœ‹ latency å¦‚ä½•è¢«å„ªåŒ–ï¼Œé‡æ¸¬çš„åŸºæº–ç·šå¾å¹³å‡ 47.5 us é–‹å§‹&lt;/p>
&lt;h4 id="1-æé«˜-read-çš„é »æ¬¡">1. æé«˜ read çš„é »æ¬¡&lt;/h4>
&lt;p>Linux 3.11 é–‹å§‹å¢åŠ äº† &lt;code>SO_BUSY_POLL&lt;/code> çš„ socket é¸é …ï¼Œåœ¨æŒ‡å®šçš„æ™‚é–“å…§ kernel å°±æœƒå»è®€å– packet æå‡è®€å–çš„é »æ¬¡ï¼Œé€éå¢åŠ  CPU ä½¿ç”¨ç‡é™ä½ latency 7 us&lt;/p>
&lt;p>åŒæ¨£çš„é“ç†å¯ä»¥å¥—ç”¨åœ¨ user space ï¼Œé€é non-blocking read &lt;code>fd.recvmsg(MSG_DONTWAIT)&lt;/code> å†å¾€ä¸‹é™ä½ 4 us&lt;/p>
&lt;h4 id="2-pin-process">2. pin process&lt;/h4>
&lt;p>é€éæŒ‡å®š process åœ¨ç‰¹å®šçš„ CPU ä¸ŠåŸ·è¡Œæ¸›å°‘ context switchï¼Œé™ä½ 1 usï¼›&lt;br>
ä½†å¦‚åŒå…ˆå‰æåˆ°ï¼Œé è¨­ä¸€å€‹ RX queue åªèƒ½æœ‰å–®ä¸€ CPU è®€å–ï¼Œå¦‚æœå‰›å¥½æ‡‰ç”¨ç¨‹å¼ä¹Ÿåœ¨æœ€å¿™ç¢Œçš„ CPU ä¸Šï¼Œå‰‡å»¶é²åè€Œæœƒå¢åŠ  2 us&lt;/p>
&lt;h4 id="3-å°‡-rx-queue-ç¶å®šåˆ°æŒ‡å®š-cpu">3. å°‡ RX queue ç¶å®šåˆ°æŒ‡å®š CPU&lt;/h4>
&lt;p>ç‚ºäº†é¿å…ä¸Šé¢å•é¡Œï¼Œå¯ä»¥é€é Indirection Table èª¿æ•´ RX queue å¦‚ä½•åˆ†é…åˆ° CPU è®€å–ï¼Œä½œè€…é™å®šåªæœ‰åœ¨åŒä¸€å€‹ NUMA node çš„ CPU æ‰èƒ½è®€å– RX queue&lt;/p>
&lt;p>åŒæ¨£çš„åšæ³•ä¹Ÿå¯ä»¥ç”¨ Flow steering å¯¦ä½œï¼ŒæŒ‡å®šç‰¹å®šçš„ flow åˆ°ç‰¹å®šçš„ RX queue ä¸Šé¢ï¼Œé¡å¤–ç”¨é€”æ˜¯ç¢ºä¿åœ¨é«˜æµé‡æƒ…æ³ä¸‹æŒ‡å®šçš„å°åŒ…é‚„èƒ½è¢«ç‰¹å®šçš„ CPU è™•ç†ï¼Œå¦‚ SSH/BGPï¼Œä¹Ÿå¯ä»¥ç”¨ä¾†é˜²å µ DDoS æ”»æ“Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">client$ sudo ethtool -N eth2 flow-type udp4 dst-ip 192.168.254.1 dst-port &lt;span class="m">65500&lt;/span> action &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨å‚³é€ç«¯ä¹Ÿå¯ä»¥æŒ‡å®šé¡ä¼¼çš„äº‹æƒ…ï¼Œèª¿æ•´ TX queue é€éå“ªå€‹ CPU ç™¼é€çš„æ©Ÿåˆ¶&lt;/p>
&lt;h4 id="å°çµ-1">å°çµ&lt;/h4>
&lt;p>å†é€šéä¸€äº›å„ªåŒ–ï¼Œå¾åŸæœ¬ 47 us é™åˆ° 26 usï¼›å¦‚æœæ˜¯é€é bypass kernel å‰‡è¿‘ä¸€æ­¥ä¸‹é™åˆ° &lt;code>17 us&lt;/code>&lt;/p></description></item><item><title>ã€Œé ˜åŸŸé©…å‹•è¨­è¨ˆèˆ‡ç°¡æ½”æ¶æ§‹å…¥é–€å¯¦ä½œç­ã€ä¸Šèª²ç­†è¨˜èˆ‡å¿ƒå¾—ï¼šé—œæ–¼æ•æ·ã€ DDD èˆ‡ Event Storming - ä¸Š</title><link>https://yuanchieh.page/posts/2022/2022-01-14-%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87%E7%B0%A1%E6%BD%94%E6%9E%B6%E6%A7%8B%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C%E7%8F%AD%E4%B8%8A%E8%AA%B2%E7%AD%86%E8%A8%98%E8%88%87%E5%BF%83%E5%BE%97%E9%97%9C%E6%96%BC%E6%95%8F%E6%8D%B7-ddd-%E8%88%87-event-storming-%E4%B8%8A/</link><pubDate>Fri, 14 Jan 2022 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2022/2022-01-14-%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87%E7%B0%A1%E6%BD%94%E6%9E%B6%E6%A7%8B%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C%E7%8F%AD%E4%B8%8A%E8%AA%B2%E7%AD%86%E8%A8%98%E8%88%87%E5%BF%83%E5%BE%97%E9%97%9C%E6%96%BC%E6%95%8F%E6%8D%B7-ddd-%E8%88%87-event-storming-%E4%B8%8A/</guid><description>&lt;p>åœ¨ 2022 å¹´ä¸€é–‹å§‹å°±ä¸Šåˆ°å¦‚æ­¤æ‰å¯¦ã€æœ‰æ”¶ç©«çš„èª²ç¨‹çœŸçš„æ˜¯å¤ªè®šäº†ï¼Œä¹‹å‰åœ¨åŒäº‹çš„ä»‹ç´¹ä¸‹èªè­˜äº† Event Storming ä¸¦æ¥è§¸åˆ°ä¸€äº› DDD çš„åè©ï¼Œé–‹å§‹åœ¨ç¶²è·¯ä¸Šé€éå½±éŸ³èª²ç¨‹ &lt;a class="link" href="https://www.pluralsight.com/courses/fundamentals-domain-driven-design" target="_blank" rel="noopener"
>Domain-Driven Design Fundamentals&lt;/a>ã€éµäººè³½ç³»åˆ—æ–‡ç« å­¸ç¿’ï¼Œåœ¨ä¸Šèª²å‰ä¹Ÿå¤§æ¦‚ç¿»äº†ä¸€ä¸‹ DDD è—çš®æ›¸ï¼Œä»¥ä¸Šçš„æ•™æéƒ½å¾ˆä¸éŒ¯ï¼Œä¹ŸæŠŠåè©è§£é‡‹è·Ÿ DDD æµç¨‹å¤§è‡´æ¢³ç†ä¸€éï¼Œä½†æ˜¯è“‹ä¸Šæ›¸æœ¬ã€é—œæ‰ç¶²é ï¼Œ&lt;code>æˆ‘è¦æ€éº¼å°å…¥ï¼Ÿ&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚èªª DDD æåˆ°é–‹ç™¼äººå“¡è¦æ‰¾é ˜åŸŸå°ˆå®¶ä¸€èµ·æ‰¾å‡º Domain Modelï¼Œä¸¦å°‡ Domain åŠƒåˆ†å‡ºé©åˆçš„ Bounded Contextï¼Œä½†ä»€éº¼æ˜¯é©åˆï¼Ÿæˆ‘è©²æ€æ¨£çŸ¥é“ä¸é©åˆï¼Ÿç•¶æˆ‘æ‰¾åˆ°é©åˆçš„&amp;quot;æ„Ÿè¦º&amp;quot; A-ha Moment æ˜¯æ€æ¨£æœƒç™¼ç”Ÿï¼Ÿ&lt;/p>
&lt;p>åœ¨ç¿»é–±ã€ŠClean Architectureã€‹ä¸€æ›¸ä¹Ÿæœ‰åŒæ„Ÿï¼Œæ–‡ç« å¯«å¾—éå¸¸æ¸…æ¥šï¼Œä¹Ÿé€é Uncle Bob çš„æ–‡ç­†é‡æ–°èªè­˜äº†è»Ÿé«”æ¶æ§‹ï¼Œä½†&lt;code>ç„¶å¾Œå‘¢ï¼Ÿæˆ‘è©²æ€éº¼å¯¦ä½œï¼Ÿ&lt;/code>&lt;/p>
&lt;p>åœ¨ DDD ä¸€æ›¸é—¡è¿°äº†è»Ÿé«”çš„å»ºç«‹éœ€è¦æ”œæ‰‹ Domain Expert å®šç¾© Domain Modelï¼Œä¸¦ç¢ºä¿ç¨‹å¼å¯¦ä½œè¦è·Ÿ Model ä¿æŒä¸€è‡´ï¼Œåœ¨åœ–è¡¨ä¸­æ‹†åˆ†äº† Entity / Value Object ç­‰ï¼Œä»¥åŠæä¾›å¾ˆå¤šå…ƒä»¶é–“æºé€šçš„ Pattenï¼Œä½†æ²’æœ‰èªªå¯¦ä½œèµ·ä¾†æœƒæ€æ¨£ (è¬›ç™½äº†æ›¸æœ¬ä¸­æ²’æœ‰å¤ªå¤šçš„ç¨‹å¼ç¢¼) &lt;br>
åœ¨ ã€ŠClean Architectureã€‹ ä¸­æè¿°çš„ SOLID / åˆ†å±¤åŸå‰‡ / ä¾è³´æ€§åŸå‰‡ï¼Œä½†æ²’æœ‰èªªå…ƒä»¶æ‰€è¬‚çš„&lt;code>è·è²¬æ€éº¼åŠƒåˆ†&lt;/code>ï¼Œæœ‰å¾ˆå¤šå¯¦ä½œçš„ç´°ç¯€è·Ÿå–æ¨ä¸¦æ²’æœ‰å¤ªå¤šæ¡ˆä¾‹&lt;/p>
&lt;p>Teddy å°‡å…©è€…çµåˆï¼Œç”¨è‡ªå·±è¨­è¨ˆçš„ Kanban ç³»çµ±ï¼Œå¸¶è‘—å­¸å“¡è·‘éä¸€æ¬¡ DDD å»ºæ¨¡çš„éç¨‹ï¼Œä¸¦é€éã€ŠClean Architectureã€‹å¯¦ä½œï¼Œä»–èªªä»–å¾ˆæ¥è¿‘ç†æƒ³çš„è»Ÿé«”&lt;/p>
&lt;blockquote>
&lt;p>æ”¹å‹•çš„æˆæœ¬åªè·Ÿéœ€æ±‚ç¯„åœæœ‰é—œï¼Œè·Ÿç³»çµ±å­˜åœ¨çš„æ™‚é–“ç„¡é—œ&lt;/p>
&lt;/blockquote>
&lt;p>é€éä¸€å€‹éšæ®µä¸€å€‹éšæ®µçš„è¨è«–èˆ‡æª¢è¨ï¼Œå…ˆè©¦éŒ¯å†å›é ­è§£é‡‹åè©ï¼Œé€™æ¨£çš„å­¸ç¿’æ–¹å¼æˆ‘è¦ºå¾—æ¯”çœ‹æ›¸ã€çœ‹å½±ç‰‡é‚„è¦å¥½å¾ˆå¤šï¼Œä»¥ä¸‹æˆ‘å°‡ç”¨æ™‚é–“è»¸åˆ†äº« Teddy ä¸Šèª²çš„å…§å®¹ä»¥åŠæˆ‘å€‘å°çµ„è¨è«–çš„æ¼”é€²ï¼Œæœƒæœ‰å¤§é‡éŒ¯èª¤ç„¶å¾Œè¢«ç³¾æ­£ ~æ‰“è‡‰~ çš„æ¡ˆä¾‹ XD&lt;br>
å…§å®¹æœ‰é»ç´°ï¼Œä¸æœƒå®Œæ•´ä»‹ç´¹ DDD è·Ÿ Event Stormingï¼Œåªæœƒåˆ†äº«åœ¨å¯¦ä½œä¸ŠéŒ¯èª¤èˆ‡è€å¸«çš„ç³¾æ­£&lt;/p>
&lt;p>æ¨å€‹èª²ç¨‹é é¢ &lt;a class="link" href="https://teddysoft.tw/courses/clean-architecture/" target="_blank" rel="noopener"
>é ˜åŸŸé©…å‹•è¨­è¨ˆèˆ‡ç°¡æ½”æ¶æ§‹å…¥é–€å¯¦ä½œç­&lt;/a>ï¼Œå¯¦éš›åƒèˆ‡å°çµ„è¨è«–æœƒæ¸…æ™°å¾ˆå¤š&lt;/p>
&lt;h2 id="domain-driven-design">Domain Driven Design&lt;/h2>
&lt;h3 id="ddd-åŸºæœ¬ä»‹ç´¹">DDD åŸºæœ¬ä»‹ç´¹&lt;/h3>
&lt;h4 id="1-ä»€éº¼æ˜¯-domain">1. ä»€éº¼æ˜¯ Domain&lt;/h4>
&lt;p>Domain å¯ä»¥è¢«æ‹†åˆ†ç‚º &lt;code>Problem Domain&lt;/code> ä»¥åŠ &lt;code>Solution Domain&lt;/code>ï¼ŒProblem Domain æ˜¯æŒ‡å¯¦éš›ç™¼ç”Ÿåœ¨ä¸–ç•Œä¸Šçš„å•é¡Œï¼Œä¹Ÿå°±æ˜¯å…¬å¸æ‰€é¢è‡¨çš„å•†æ¥­å•é¡Œï¼Œä¾‹å¦‚å¤–å‡ºæƒ³è¦å«è»Šã€è‚šå­é¤“æƒ³è¦é»å¤–è³£ç­‰ï¼Œä½†æ˜¯ä¸–ç•Œä¸Šçš„å•é¡Œå¤ªå¤šäº†ï¼Œä¸æœƒæ¯ä¸€å€‹éƒ½é—œæ³¨ï¼Œæ‰€ä»¥ç¸½åˆä¾†èªª&lt;/p>
&lt;blockquote>
&lt;p>åˆ©å®³é—œä¿‚äººæ‰€åœ¨ä¹çš„å¯¦éš›å•é¡Œå°±æ˜¯ä½ çš„ Domain&lt;/p>
&lt;/blockquote>
&lt;p>Uber åœ¨ä¹ç”¨æˆ¶å¤–å‡ºçš„é€šå‹¤å•é¡Œ / Food Panda åœ¨ä¹ç”¨æˆ¶è‚šå­é¤“æƒ³é»å¤–è³£æœè…¹çš„å•é¡Œï¼Œå„è‡ªæœ‰å„è‡ªçš„ Problem Domainï¼Œä¸¦å°æ­¤æå‡ºå„è‡ªçš„è§£æ³• Solution Domainï¼Œä¹‹å¾Œè¨è«–å°‡ Solution Domain é™ç¸®åœ¨è»Ÿé«”è¨­è¨ˆä¸Š&lt;/p>
&lt;p>å›æ­¸é–‹ç™¼çš„æ ¹æœ¬ï¼Œç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ä¸€ç›´è·Ÿ PM / åˆ©å®³é—œä¿‚äºº (å¾ŒçºŒä»¥&lt;code>é ˜åŸŸå°ˆå®¶&lt;/code>ä»£ç¨±) ä¸æ–·é‡æ¸…å•é¡Œï¼Œå› ç‚ºå•é¡Œæ‰æ˜¯é©…å‹•ä¸€åˆ‡çš„æœ¬è³ªï¼Œå¦‚æœä»Šå¤©ä¸ç”¨å¯«ä¸€è¡Œç¨‹å¼ç¢¼å°±èƒ½è§£æ±ºå•é¡Œï¼Œé‚£ä½•å¿…å‹•æ‰‹ï¼Œ&lt;code>é‡æ¸…å•é¡Œæ˜¯é–‹ç™¼çš„ç¬¬ä¸€æ­¥&lt;/code>&lt;/p>
&lt;h4 id="2-ä»€éº¼æ˜¯-domain-model">2. ä»€éº¼æ˜¯ Domain Model&lt;/h4>
&lt;p>æœ‰äº† Problem Domainï¼Œéå¾€çš„ç¿’æ…£æ˜¯ç›´æ¥é€²å…¥é–‹ç™¼è¨­è¨ˆï¼Œä¹Ÿå°±æ˜¯å°æ‡‰åˆ° Solution Domainï¼Œä½†é€™å…©å€‹ Domain é–“æœ‰ä¸€å€‹å¾ˆå¤§çš„é´»æº (é™„åœ–è·¯å¾‘ A)ï¼Œé–‹ç™¼äººå“¡ä»¥ç‚ºè‡ªå·±è½æ‡‚äº†éœ€æ±‚å°±é–‹å§‹å¯¦ä½œï¼Œè€Œé ˜åŸŸå°ˆå®¶ä¹Ÿä»¥ç‚ºé–‹ç™¼äººå“¡çœŸçš„æ‡‚äº†ï¼Œæœ€å¾Œç­‰ç³»çµ±é©—æ”¶æ™‚æ‰ç™¼ç¾æ ¹æœ¬åšéŒ¯äº†&lt;/p>
&lt;p>DDD æå€¡é ˜åŸŸå°ˆå®¶èˆ‡é–‹ç™¼äººå“¡æ‡‰è©²è¦å…ˆé”æˆå…±è­˜ï¼Œå°‡ Domain å»ºç«‹å‡ºå°æ‡‰çš„æ¨¡å‹ Modelï¼Œè®“é›™æ–¹å°‡å…±è­˜è½‰æ›ç‚ºåœ–å½¢ï¼Œä¸¦åœ¨éç¨‹ä¸­å»ºç«‹ &lt;code>Ubiquitous Language&lt;/code> å…±åŒèªè¨€ï¼Œç­‰ç¢ºèªå¾Œé–‹ç™¼äººå“¡æ‰å»å¯¦ä½œ (é™„åœ–è·¯å¾‘ B)&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0114/domain-model.png"
loading="lazy"
>&lt;/p>
&lt;p>æ¯”å°è·¯å¾‘ A ã€Bï¼Œçœ‹ä¼¼ B ç¹äº†é»é è·¯ï¼Œä½†å…ˆé€é Domain Model é—¡è¿° Solution çš„é•·ç›¸ä¸¦æŠ½é›¢å¯¦ä½œï¼Œæ‰èƒ½ç”¨æœ€å°çš„æˆæœ¬ï¼Œè®“é ˜åŸŸå°ˆå®¶åŠæ—©ç¢ºèªè§£æ³•çš„æ–¹å‘æ­£ä¸æ­£ç¢º&lt;/p>
&lt;blockquote>
&lt;p>Q: æ˜¯ä¸æ˜¯æ‰€æœ‰å•é¡Œéƒ½è¦å»º Domain Model?&lt;br>
A: ä¸æ˜¯ï¼Œåªæœ‰ç•¶å•†æ¥­é‚è¼¯è¶³å¤ è¤‡é›œæ‰éœ€è¦ï¼Œå–®ç´”çš„ CRUDã€å ±è¡¨ç³»çµ±æ˜¯ä¸éœ€è¦çš„&lt;/p>
&lt;/blockquote>
&lt;p>Event Storming æ˜¯ä¸€å€‹å»ºç«‹ Domain Model çš„æ–¹æ³•ï¼Œå¾ High Level åˆ° Low Level æŒçºŒæ¼”åŒ–çš„éç¨‹&lt;/p>
&lt;h4 id="3-domain-model-è¦è¶ŠçœŸè¶Šå¥½å—">3. Domain Model è¦è¶ŠçœŸè¶Šå¥½å—&lt;/h4>
&lt;p>æ‰€è¬‚çš„ã€ŒçœŸã€æ˜¯æŒ‡å¯¦éš›ä¸–ç•Œçš„çœŸå¯¦æ€§ï¼ŒTeddy ä¸Šèª²èˆ‰ä¾‹ï¼šã€Œæ¨£å“å±‹æ˜¯ä¸æ˜¯è¶ŠåƒçœŸçš„å¯¦é«”å±‹è¶Šå¥½ï¼Ÿã€&lt;br>
ç­”æ¡ˆæ˜¯ã€Œä¸ä¸€å®š!ã€ï¼Œé‡æ–°æ€è€ƒ Domain Model æ˜¯ Solution Domain çš„ä¸€ç’°ï¼Œæ‰€ä»¥çœŸæ­£çš„é‡é»æ˜¯æºé ­çš„ Problem Domainï¼Œä»Šå¤©å»ºå•†è“‹æ¨£å“å±‹æ˜¯å¸Œæœ›ç”¨æˆ¶è³¼è²·å¯¦é«”å±‹ï¼Œä½†å¦‚æœä»Šå¤©å»ºå•†è“‹å®Œå°±éŠ·å”®ä¸€ç©ºï¼Œé‚£æ ¹æœ¬é€£æ¨£å“å±‹éƒ½ä¸ç”¨è“‹&lt;/p>
&lt;p>åªè¦ Model èƒ½å¤ å‰›å¥½è§£æ±ºå•é¡Œå°±å¥½ï¼Œover design æˆ– under design éƒ½æ˜¯ä¸å¥½çš„ï¼Œé€™é»åœ¨å¾ŒçºŒçš„å¯¦éš›æ“ä½œæœƒå†è£œå……&lt;/p>
&lt;h2 id="event-storming">Event Storming&lt;/h2>
&lt;p>ä»¥ Kanban ç³»çµ± &lt;a class="link" href="https://ssl-ezscrum.csie.ntut.edu.tw/ezKanban-stable" target="_blank" rel="noopener"
>ezKanban&lt;/a>ï¼ŒTeddy æ“”ä»»é ˜åŸŸå°ˆå®¶ (å…¼ä»»é–‹ç™¼äººå“¡XD) å¸¶å¤§å®¶è·‘é Event Stormingï¼Œä»¥ä¸‹ä»‹ç´¹ Kanban çš„æ ¸å¿ƒå•†æ¥­é‚è¼¯&lt;/p>
&lt;ul>
&lt;li>Visualizeï¼šè¦–è¦ºåŒ–è¡¨é”&lt;/li>
&lt;li>Limit WIPï¼šæ¯ä¸€å€‹å·¥ä½œéšæ®µçš„é€²è¡Œä¸­å·¥ä½œ (WIP) æœ‰æ•¸é‡é™åˆ¶&lt;/li>
&lt;li>Manage Flowï¼šç®¡ç†å·¥ä½œæµç¨‹
å»ºæ¨¡å·¥å…·ä½¿ç”¨ &lt;a class="link" href="https://miro.com/app/dashboard/" target="_blank" rel="noopener"
>Miro&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>é€²è¡Œé †åºæŒ‰ç…§éšå±¤å¾ Big Picture é–‹å§‹èˆ‡é ˜åŸŸå°ˆå®¶è¨è«–æ ¸å¿ƒçš„ç”¨æˆ¶è¡Œç‚ºï¼Œæ¥è‘—åˆ° Process Modeling è£œå……æ›´å¤šçš„è¦å‰‡ã€è¡Œå‹•ï¼Œæœ€å¾Œæ‰æ˜¯ Software Design
&lt;img src="https://yuanchieh.page/post/2022/img/0114/event-storming-level.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="1-big-picture-æ‰¾å‡º-domain-event">1. Big Picture: æ‰¾å‡º Domain Event&lt;/h3>
&lt;p>å…ˆæ‹‰å‡ºä¸€æ¢ç®­é ­è¡¨é”æ™‚é–“è»¸ï¼Œå…ˆå¾Œé †åºï¼Œå°‡ User Story ä¸­çš„é—œéµäº‹ä»¶ (Domain Event) å…ˆæ¢åˆ—å‡ºä¾†ï¼Œæ‰€è¬‚çš„&lt;code>äº‹ä»¶æ˜¯æœƒæ”¹è®Šç³»çµ±ç‹€æ…‹&lt;/code>ï¼Œä¾‹å¦‚é›»å•†ç³»çµ±ç”¨æˆ¶åŠ è³¼ç‰©è»Šã€çµå¸³ç­‰ï¼Œåä¹‹&lt;code>è®€å–ä¸æ˜¯äº‹ä»¶ï¼Œå› ç‚ºä¸æœƒæ”¹è®Šç³»çµ±ç‹€æ…‹&lt;/code>ï¼Œä¸ç®¡ Data è®€å–å¹¾æ¬¡éƒ½ä¸æœƒæœ‰è®ŠåŒ–&lt;/p>
&lt;p>äº‹ä»¶æ˜¯ä»£è¡¨ç™¼ç”Ÿéçš„äº‹æƒ…ï¼Œæ‰€ä»¥éƒ½æœƒç”¨éå»å¼è¡¨é”ï¼Œä¾‹å¦‚çœ‹æ¿ç³»çµ±ä¸­çš„&lt;/p>
&lt;ul>
&lt;li>Workflow Created&lt;/li>
&lt;li>Workflow Deleted&lt;/li>
&lt;li>Stage WIP set
ç­‰ç­‰&lt;/li>
&lt;/ul>
&lt;p>åœ¨è¨è«–éç¨‹ä¸­ï¼Œå‹™å¿…è¨˜å¾—&lt;/p>
&lt;ul>
&lt;li>ä¸è¦å‡ºç¾æŠ€è¡“ç”¨èªï¼Œä¾‹å¦‚è³‡æ–™åº«æ€éº¼å„²å­˜ã€å¯¦ä½œè¦å¥—ä»€éº¼ Design Patten&lt;/li>
&lt;li>ä¸è¦è¢« UI ç¶æ¶äº†!
&lt;img src="https://yuanchieh.page/post/2022/img/0114/domain-model-impl.png"
loading="lazy"
>
å› ç‚ºæˆ‘å€‘æ˜¯çœ‹è‘— Teddy å·²ç¶“å¯¦ä½œå¥½çš„ ezKanbanï¼Œæ‰€ä»¥ Domain Event å¾ˆå¤šï¼Œå¯¦å‹™ä¸Šçœ‹å„è‡ªç³»çµ±è¦æ¨¡ï¼Œè€Œä¸” &lt;code>Event Storming æ˜¯æŒçºŒæ¼”é€²ï¼Œä¸ç”¨æ±‚ä¸€æ­¥åˆ°ä½&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä¸Šåœ–æ˜¯æˆ‘å€‘å°çµ„å»ºç«‹ Domain Eventï¼Œå…¶ä¸­æœ‰ä¸‰é»éŒ¯èª¤&lt;/p>
&lt;h4 id="a-æ™‚é–“è»¸é †åºæ€§">a. æ™‚é–“è»¸é †åºæ€§&lt;/h4>
&lt;p>æˆ‘å€‘ä¸€é–‹å§‹æŠŠ User Created / User Logined æ”¾åœ¨åŒä¸€åˆ—ä¸Šï¼ŒåŒä¸€åˆ—åœ¨ Event Storming ä»£è¡¨é€™å…©å€‹äº‹ä»¶æ˜¯åœ¨å·®ä¸å¤šæ™‚é–“é»ç™¼ç”Ÿï¼Œä½†ç†è«–ä¸Š User Create å¿…ç„¶åœ¨ User Logined ä¹‹å‰ï¼Œæ‰€ä»¥ä¸è©²æ”¾åœ¨åŒä¸€åˆ—ä¸Š&lt;/p>
&lt;h4 id="b-ä¸è¦è¢«-ui-ç¶æ¶">b. ä¸è¦è¢« UI ç¶æ¶&lt;/h4>
&lt;p>é€™æ˜¯ä¸€å€‹éå¸¸æœ‰è¶£çš„æ¡ˆä¾‹ï¼Œåœ¨ ezKanban ä¸­ä½ å¿…é ˆåœ¨ç•«é¢ä¸Šé»æ“Šã€ŒLayout Editã€æ‰èƒ½ç·¨è¼¯å·¥ä½œæµç¨‹çš„æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘å€‘çµ„å…§è¨è«–å¾ˆç›´è¦ºçš„æƒ³é€™å€‹äº‹ä»¶å¾ˆé‡è¦ï¼Œæ‰€ä»¥å°±è£œäº†ä¸€å€‹ ã€ŒLayout Mode Enteredã€ï¼Œä½†è€å¸«èªªä¸å°!! &lt;code>è¢« UI ç¶æ¶äº†&lt;/code>ï¼Œé€™åªæ˜¯ä¸€å€‹å¯¦ä½œç´°ç¯€ï¼Œæˆ‘ä»Šå¤©å¯ä»¥æ›ä¸€å€‹æŒ‰éˆ•æˆ– UI æµç¨‹åšåˆ°åŒä¸€ä»¶äº‹ï¼Œé€™å±¬æ–¼æ‡‰ç”¨å±¤é¢çš„é‚è¼¯&lt;/p>
&lt;p>Domain Event åˆå¯ç´°åˆ†æˆå…©ç¨® Core Domain Event / Application Domain Eventï¼Œå‰è€…æ˜¯æ»¿è¶³æ ¸å¿ƒå•†æ¥­é‚è¼¯çš„äº‹ä»¶ã€å¾Œè€…æ˜¯æ‡‰ç”¨ç¨‹å¼åŸ·è¡Œæ™‚éœ€è¦çš„äº‹ä»¶ï¼Œä»Šå¤©ä»¥çœ‹æ¿ç³»çµ±ï¼Œç”¨æˆ¶å“ªæœƒé—œå¿ƒä»€éº¼ Layout Modeï¼Œé‚£æ˜¯ä½ &lt;code>å¯¦ä½œçš„äº‹æƒ…&lt;/code>ï¼Œæ‰€ä»¥ä¸è©²æŠŠé€™å€‹ Event æ”¾åœ¨ä¸Šé¢&lt;/p>
&lt;p>æˆ‘è‡ªå·±å¾Œä¾†åœ¨åæ€é€™ä»¶äº‹æƒ…ï¼Œæˆ‘å˜—è©¦ç”¨é€™æ¨£çš„é‚è¼¯å»é‡æ¸…&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>æˆ‘èƒ½ä¸èƒ½ç”¨ä¸åŒçš„ UI Flow å–ä»£ç•¶å‰çš„äº‹ä»¶ï¼Ÿ ä¾‹å¦‚åœ¨ Board é é¢å°±å€åˆ†å‡ºã€Œç‰ˆä½èª¿æ•´ã€/ã€Œå·¥ä½œèª¿æ•´ã€ï¼Œå¦‚æœå¯ä»¥çš„è©±ï¼Œé‚£å°±æ˜¯æ‡‰ç”¨äº‹ä»¶&lt;/li>
&lt;li>ä»Šå¤©æˆ‘å¯¦ä½œåœ¨å¤šå¹³å° Web / App / Server éƒ½éœ€è¦é€™å€‹äº‹ä»¶å—ï¼Ÿå¦‚æœè¦é‚£æœ‰å¯èƒ½æ˜¯æ ¸å¿ƒï¼Œå¦‚æœåªæœ‰ Web è¦å¯¦ä½œå…¶ä»–å¹³å°ä¸ç”¨ï¼Œé‚£è‚¯å®šæ˜¯æ‡‰ç”¨äº‹ä»¶&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>é€™éº¼åœ¨æ„æ˜¯ä¸æ˜¯ Core Domain Event çš„ç”¨æ„æ˜¯è®“ Domain Model ä¿æŒç°¡æ½”ï¼Œå¤ªå¤šç´°ç¯€åƒé›œæœƒæ··æ·†è¨è«–&lt;/p>
&lt;h4 id="c-ä¸è¦è¢«-db-ç¶æ¶---ä»»å‹™é©…å‹•è€ŒéæŒ‡ä»¤é©…å‹•">c. ä¸è¦è¢« DB ç¶æ¶ - ä»»å‹™é©…å‹•è€ŒéæŒ‡ä»¤é©…å‹•&lt;/h4>
&lt;p>åœ¨æ¢åˆ— Domain Model æ™‚ï¼Œæˆ‘èˆ‡çµ„å“¡éƒ½æœ‰ä¸€å€‹ç–‘å• &lt;code>ã€Œä¸€å€‹ Stage æœ‰ 10 å€‹å±¬æ€§éƒ½èƒ½å¤  CRUDï¼Œé‚£æˆ‘è¦å…¨éƒ¨åˆ—å‡ºä¾†å—ï¼Ÿä¾‹å¦‚ Stage çš„æ¨™é¡Œã€èªªæ˜æ¬„ç­‰ï¼Œé‚£æˆ‘æ˜¯è¦å¯«ä¸€å€‹ Stage Updated å°±å¥½é‚„æ˜¯è¦å¯« Stage Name Updatedï¼Ÿã€&lt;/code>&lt;/p>
&lt;p>é™¤äº†ä¸è¦è¢« UI ç¶æ¶å¤–ï¼Œä¹Ÿä¸è¦è¢«è³‡æ–™åº«ç¶æ¶äº†! ä»Šå¤©ç”¨æˆ¶æ‰ä¸ç®¡ä½ æ€éº¼ CRUDï¼Œä»–çœŸæ­£åœ¨æ„æ˜¯&lt;code>èƒ½ä¸èƒ½å®Œæˆä»–æ‰‹ä¸­çš„ä»»å‹™&lt;/code>ï¼Œä¾‹å¦‚èªªä»Šå¤©æˆ‘å» ATM é ˜éŒ¢ï¼Œç³»çµ±é¡¯ç¤º&lt;/p>
&lt;ol>
&lt;li>èªªæ³• A: æ‚¨å·²æé ˜ 1000 å…ƒ&lt;/li>
&lt;li>èªªæ³• B: å·²æ›´æ–°æ‚¨çš„å¸³æˆ¶é¤˜é¡ç‚ºåŸé¤˜é¡æ¸›å»1000 å…ƒ&lt;/li>
&lt;/ol>
&lt;p>ç›¸ä¿¡ä½ ææ¬¾å¾Œçœ‹åˆ°èªªæ³• B æ‡‰è©²æœƒå‚»çœ¼ï¼Œè«‹ä»¥ã€Œç”¨æˆ¶æƒ³è¦å®Œæˆä»€éº¼ä»»å‹™ã€çš„è§’åº¦æè¿° Domain Event&lt;/p>
&lt;h4 id="d-ç”¨èªªæ•…äº‹çš„æ–¹å¼å»é‡æ¸…-model-è¡¨é”åŠ›">d. ç”¨èªªæ•…äº‹çš„æ–¹å¼å»é‡æ¸… Model è¡¨é”åŠ›&lt;/h4>
&lt;p>æˆ‘åœ¨æ“ä½œ ezKanban å…ˆè·‘äº†å»ºç«‹å·¥ä½œæµç¨‹ï¼Œæœ€å¾Œæ‰ç™¼ç¾ ezKanban æœ‰ Team çš„æ¦‚å¿µï¼ŒTeam å¯ä»¥é‚€è«‹å…¶ä»– User ç•¶ä½œ Member å…±äº« Projectï¼Œå› ç‚ºæˆ‘æ¯”è¼ƒæ™šçœ‹åˆ°æ‰€ä»¥ Team ç›¸é—œçš„äº‹ä»¶æ”¾åœ¨æ™‚é–“è»¸å¾Œé¢&lt;/p>
&lt;p>æœ€å¾Œ Teddy å•èªªï¼šã€Œé€™æ¨£çš„ Model è¡¨é”äº†ä»€éº¼å«æ„ï¼Ÿã€Model çš„æ„ç¾©åœ¨æ–¼&lt;code>åœ–å½¢åŒ–æˆ‘å€‘æƒ³è¦è§£æ±ºçš„å•é¡Œèˆ‡ç™¼ç”Ÿé †åº&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ¶çš„ä½¿ç”¨æ­·ç¨‹èˆ‡æ¯ä¸€å€‹ä½¿ç”¨æ¡ˆä¾‹ï¼Œä»Šå¤©ç”¨èªªæ•…äº‹çš„æ–¹å¼æœƒåƒ&lt;/p>
&lt;ol>
&lt;li>æ•…äº‹ A:ã€Œç”¨æˆ¶ä»Šå¤©æƒ³è¦ä½¿ç”¨çœ‹æ¿ç³»çµ±ï¼Œä»–å…ˆè¨»å†Šäº†å¸³è™Ÿä¸¦ç™»å…¥ï¼Œæ¥è‘—å»ºç«‹å°ˆæ¡ˆï¼Œä¸¦é–‹å§‹è¨­å®šè‡ªå·±çš„å·¥ä½œæµç¨‹&amp;hellip;&amp;hellip; æœ€å¾Œä»–é‚€è«‹ä»–çš„æˆå“¡åŠ å…¥ï¼Œå¤§å®¶ä¸€èµ·æ“ä½œçœ‹æ¿ã€&lt;/li>
&lt;li>æ•…äº‹ B: ã€Œç”¨æˆ¶ä»Šå¤©æƒ³è¦ä½¿ç”¨çœ‹æ¿ç³»çµ±ï¼Œä»–å…ˆè¨»å†Šäº†å¸³è™Ÿä¸¦ç™»å…¥ï¼Œæ¥è‘—å»ºç«‹åœ˜éšŠï¼Œé‚€è«‹ä»–çš„æˆå“¡åŠ å…¥ï¼Œå¤§å®¶ä¸€èµ·æ“ä½œçœ‹æ¿ï¼Œæ¥è‘—å»ºç«‹å°ˆæ¡ˆï¼Œä¸¦é–‹å§‹è¨­å®šåœ˜éšŠçš„å·¥ä½œæµç¨‹&amp;hellip;&amp;hellip;ã€&lt;/li>
&lt;/ol>
&lt;p>å…©å€‹æ•…äº‹éƒ½èªªå¾—é€šï¼Œä½† Teddy è¦ºå¾—æ•…äº‹ B æ›´ç¬¦åˆä»–çš„ä½¿ç”¨å ´æ™¯ï¼Œåœ˜éšŠçš„å»ºç«‹æœƒåœ¨å·¥ä½œæµç¨‹ä¹‹å‰ï¼Œæ‰€ä»¥èª¿æ•´å¾Œçš„ Domain Event å¤§è‡´é•·é€™æ¨£
&lt;img src="https://yuanchieh.page/post/2022/img/0114/domain-model-impl-r.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="2-big-picture---åŠƒåˆ†-bounded-context">2. Big Picture - åŠƒåˆ† Bounded Context&lt;/h3>
&lt;p>æ´‹æ´‹ç‘ç‘åˆ—å‡º Domain Event å¾Œï¼Œæ¥ä¸‹ä¾†è¦ä¾†åˆ†ç¾¤ï¼Œæƒ³åƒæˆæ˜¯è²·æˆ¿ç•«éš”é–“ï¼Œè¨­è¨ˆåœ–æ‡‰è©²è¦èƒ½æ¸…æ¥šè¾¨è­˜å‡ºé€™æ˜¯ä¸€å€‹å•†å‹™è¾¦å…¬å®¤é‚„æ˜¯ä¸€å€‹å°å®¶åº­è‡ªä½ç”¨ï¼Œé€ééš”é–“å»è¡¨é”ç³»çµ±çš„æ„åœ–
&lt;img src="https://yuanchieh.page/post/2022/img/0114/room.png"
loading="lazy"
>
*é™„åœ–å¾ Google æœå°‹ï¼Œä¸ç”¨æ‡‚å®¤å…§è¨­è¨ˆä½†ä¹Ÿå¤§è‡´èƒ½çœ‹å‡ºå·¦å³å…©å¼µåœ–çš„ä¸åŒ&lt;/p>
&lt;p>æˆ‘å€‘å°çµ„ä¸€é–‹å§‹æ€è€ƒæ–¹å¼æ˜¯ã€Œä¸ç„¶å°±æ¯å€‹ç‰©ä»¶ä¸€é–“ï¼ŒWorkflow ä¸€é–“ / Board ä¸€é–“ç­‰ã€ï¼Œå¦‚åœ–ç¤º
&lt;img src="https://yuanchieh.page/post/2022/img/0114/bound-wrong.png"
loading="lazy"
>&lt;/p>
&lt;p>Teddy çœ‹åˆ°æˆ‘å€‘å¦‚æ­¤è¨­è¨ˆï¼Œä»–åå•èªªã€Œä½ å€‘çš„éš”é–“æœ‰åæ‡‰å‡º &amp;ldquo;çœ‹æ¿ç³»çµ±&amp;rdquo; é€™å€‹æ„åœ–å—ï¼Ÿå¦‚æœå¾å¤–éƒ¨ä½¿ç”¨è€…çš„è§’åº¦ï¼Œä»–çœ‹åˆ° Workflow / Board / Stage é€™éº¼å¤šç´°ç¯€å°å—ï¼Ÿã€&lt;/p>
&lt;p>æ­£ç¢ºçš„éš”é–“æ‡‰è©²æ˜¯
&lt;img src="https://yuanchieh.page/post/2022/img/0114/bound-right.png"
loading="lazy"
>
å€åˆ†æˆä¸‰å¡Šï¼š&lt;/p>
&lt;ul>
&lt;li>Core Domainï¼šKanban æ˜¯æˆ‘å€‘çš„æ ¸å¿ƒé ˜åŸŸï¼Œ&lt;code>åƒè¬ä¸è¦å¤–åŒ…&lt;/code>&lt;/li>
&lt;li>Generic Domainï¼šUser / Team å±¬æ–¼é€šç”¨æ€§åŠŸèƒ½&lt;/li>
&lt;li>Support Domainï¼šåœ–ä¸Šæ²’æœ‰ï¼Œå¦‚é‡‘æµã€å¤–éƒ¨é€šçŸ¥ç³»çµ±ï¼Œé€™ç¨®çš„æ‰¾å¤–åŒ…å³å¯ï¼Œä¸ä¸€å®šè¦è‡ªå·±é–‹ç™¼&lt;/li>
&lt;/ul>
&lt;p>å¦‚ä½•çŸ¥é“è‡ªå·±çš„éš”é–“æ˜¯å¦æ­£ç¢ºï¼Ÿå›åˆ°å•†æ¥­é‚è¼¯èˆ‡èªªæ•…äº‹çš„æ–¹å¼ï¼ŒåŠƒåˆ† Bounded Context å¾Œæ˜¯å¦èƒ½æ­£ç¢ºæ‹†è§£å‡ºå…¬å¸çš„æ ¸å¿ƒèˆ‡éæ ¸å¿ƒå•†æ¥­é‚è¼¯&lt;/p>
&lt;blockquote>
&lt;p>å¤§å®¶æœ€é—œå¿ƒçš„å¾®æœå‹™ï¼Œé€šå¸¸æ˜¯ä¸€å€‹ Bounded Context ä¸€å€‹éƒ¨ç½²çš„å…ƒä»¶&lt;/p>
&lt;/blockquote>
&lt;h3 id="3-big-picture---åŠ å…¥-role--externel-system">3. Big Picture - åŠ å…¥ Role / Externel System&lt;/h3>
&lt;p>åŠ å…¥è§¸ç™¼çš„è§’è‰² / å¤–éƒ¨ç³»çµ±ï¼Œé€™ä¸€æ­¥é©Ÿç›¸å°å–®ç´”ï¼Œè§’è‰²æ˜¯ç³»çµ±ä¸­å‹•ä½œçš„åŸ·è¡Œè€…
&lt;img src="https://yuanchieh.page/post/2022/img/0114/role.png"
loading="lazy"
>
HotSpot æ˜¯ç•¶è¨è«–éç¨‹å¡ä½ã€ç™¼ç”Ÿæ„è¦‹ä¸åŒã€å‘½åä¸åŒæ™‚å¯ä»¥è²¼è‘—è¨»è¨˜ï¼Œé¿å…è¨è«–è¢«å¡ä½ï¼Œæœ€å¾Œå¯ä»¥çœ‹å“ªä¸€å€‹å€å¡Šæ˜¯å¤§å®¶æœ€æ²’æœ‰å…±è­˜çš„&lt;/p>
&lt;h3 id="4-process-modeling---åŠ å…¥-command--read-model">4. Process Modeling - åŠ å…¥ Command / Read Model&lt;/h3>
&lt;p>é€™ä¸€æ­¥ç›¸å°å–®ç´”&lt;/p>
&lt;ul>
&lt;li>Command æ˜¯è§¸ç™¼ Domain Event çš„å‹•ä½œï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æŠŠå®Œæˆå¼æ”¹æˆç¾åœ¨å¼è¡¨é”&lt;/li>
&lt;li>Read Model å‰‡æ˜¯å®Œæˆ Command æ‰€éœ€çš„åƒæ•¸
&lt;img src="https://yuanchieh.page/post/2022/img/0114/command.png"
loading="lazy"
>&lt;/li>
&lt;/ul>
&lt;h4 id="a-å»ºç«‹äº‹ä»¶æ˜¯å¦è¦å‚³å…¥-id">a. å»ºç«‹äº‹ä»¶æ˜¯å¦è¦å‚³å…¥ id&lt;/h4>
&lt;p>æœ‰è¶£çš„å°ç´°ç¯€æ˜¯ Create Board æ™‚æˆ‘å€‘æŠŠ board_id ä¹Ÿå¯«å‡ºä¾†ï¼Œå°çµ„è¨è«–æ™‚æœƒè¦ºå¾— DB æœƒè‡ªå‹•ç”¢ç”Ÿ id æ‰€ä»¥ä¸ç”¨å¯«åˆ° read modelï¼Œä½† Teddy èªª &lt;code>ã€ŒéŒ¯ï¼Œæˆ‘å“ªç®¡ä½  id æ˜¯ DB ç”¢ç”Ÿé‚„æ˜¯å‰ç«¯ç”¨ UUID ç”¢ç”Ÿï¼Œé€™æ˜¯å¯¦ä½œç´°ç¯€ï¼ŒBoard å°±æ˜¯éœ€è¦ id è­˜åˆ¥ã€&lt;/code>ï¼Œå†æ¬¡å¼·èª¿ï¼Œä¸è¦é™·å…¥ UI/DB çš„ç´°ç¯€&lt;/p>
&lt;h3 id="5-process-modeling---åŠ å…¥policy">5. Process Modeling - åŠ å…¥Policy&lt;/h3>
&lt;p>Policy/Rule/Process æ˜¯æŒ‡ &lt;code>äº‹ä»¶å®Œæˆå¾Œè§¸ç™¼çš„æµç¨‹&lt;/code>ï¼Œåƒè¬ä¸è¦è·Ÿå‹•ä½œéœ€è¦å®Œæˆçš„é©—è­‰ææ··ï¼Œä¾‹å¦‚èªª&lt;/p>
&lt;ul>
&lt;li>è¼¸å…¥ Email è¨»å†Šæ™‚ï¼ŒEmail å¿…é ˆç¬¦åˆæ ¼å¼ =&amp;gt; é€™æ˜¯é©—è­‰&lt;/li>
&lt;li>å¯†ç¢¼è¼¸éŒ¯ä¸‰æ¬¡å¾Œï¼Œéœ€è¦å°é–å¸³è™Ÿ =&amp;gt; é€™æ˜¯ Policy&lt;/li>
&lt;/ul>
&lt;p>é©—è­‰æ˜¯å¯¦ä½œç´°ç¯€åœ¨ Event Storming ä¸­ä¸è¡¨é”ï¼ŒPolicy æ‰æ˜¯æˆ‘å€‘ç¾éšæ®µè¦é—œæ³¨çš„ï¼Œä»¥ä¸‹æ˜¯èˆ‰ä¾‹ã€Œå…¨å®¶æ¨å‡ºé ˜å–åŒ…è£¹å¾Œï¼Œå¯ä»¥å…«æŠ˜è²·æ‹¿éµã€
&lt;img src="https://yuanchieh.page/post/2022/img/0114/policy.png"
loading="lazy"
>&lt;/p>
&lt;p>é€™é‚Šå·å¤¾å¸¶ä¸€å¼µç™½è‰²çš„ä¾¿åˆ©è²¼ï¼ŒTeddy èªªä»–ç¢ºå¯¦ä¹Ÿé‡åˆ°æœ‰äº›é©—è­‰æ˜¯é‡è¦çš„å•†æ¥­é‚è¼¯ï¼Œä»–è‡ªå·±è®Šå½¢å¢åŠ äº†ç™½è‰²ä¾¿åˆ©è²¼ï¼Œè¡¨ç¤º Command çš„é©—è­‰è¦å‰‡&lt;/p>
&lt;blockquote>
&lt;p>åˆ°é€™ä¸€æ­¥æˆ‘å€‘å¯ä»¥ç™¼ç¾ Event Storming å¾ˆå¥½çš„æè¿°äº†ä¸€å€‹æ•…äº‹
ã€ŒUser want receive package, we have to check his id card, after user have received package, he can purchase latte 20% offã€&lt;br>
é€™å°±æ˜¯ Event Storming çš„é­…åŠ›&lt;/p>
&lt;/blockquote>
&lt;h3 id="6-software-design---åŠ å…¥-model">6. Software Design - åŠ å…¥ Model&lt;/h3>
&lt;p>æ¥ä¸‹ä¾†é€²å…¥å¯¦ä½œç´°ç¯€ï¼ŒModel å¯ä»¥æƒ³åšæ˜¯ç‰©ä»¶ï¼Œæ¯”å° Command æ‡‰è©²æ˜¯å“ªä¸€å€‹ç‰©ä»¶è² è²¬ï¼Œæ¢åˆ—å¾Œæœ€çµ‚æŠŠ Model çš„å¤§è‡´é—œä¿‚ä¹Ÿæç¹ªï¼Œå¤§è‡´å¦‚ä¸‹
&lt;img src="https://yuanchieh.page/post/2022/img/0114/model-wrong.png"
loading="lazy"
>
å› ç‚º Stage / Swimlane ä¸€è€…æ˜¯æ©«å‘ä¸€è€…æ˜¯ç›´å‘ï¼Œå…©è€…å¯ä»¥äº’ç›¸åŒ…å«ï¼Œæ‰€ä»¥åœ–è¡¨æœ‰é»è¤‡é›œï¼Œåœ–è¡¨è¤‡é›œä»£è¡¨ç¨‹å¼ç¢¼å¯¦ä½œä¸€å®šä¹Ÿä¸å¥½å¯«ï¼Œè©²æ€éº¼å„ªåŒ–å‘¢ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2022/img/0114/model-right.png"
loading="lazy"
>&lt;/p>
&lt;ul>
&lt;li>æŠ½ä¸€å€‹ Lane ä»£è¡¨ Stage / Swimlaneï¼Œé€™æ¨£é—œä¿‚å°±å–®ç´”å¾ˆå¤š&lt;/li>
&lt;li>æ›´ç²¾æº–è¡¨é”å•†æ¥­é‚è¼¯ï¼Œå¦å¤–ä¸€å€‹é‡é»æ˜¯ &lt;code>Workflow èˆ‡ Stage é—œè¯è€Œä¸æ˜¯ Lane&lt;/code>ï¼Œå› ç‚º Workflow é è¨­ç¬¬ä¸€å±¤å¿…é ˆæ˜¯ Stageï¼Œé€éåœ–è¡¨è¡¨ç¤ºå‡ºæ ¸å¿ƒçš„è¨­è¨ˆé‚è¼¯&lt;/li>
&lt;/ul>
&lt;h4 id="a-model-æ‹†åˆ†å¾ˆçœ‹å•†æ¥­é‚è¼¯">a. Model æ‹†åˆ†å¾ˆçœ‹å•†æ¥­é‚è¼¯&lt;/h4>
&lt;p>åŒå­¸åœ¨èª²å ‚ä¸Šè©¢å•ï¼šã€Œå¦‚æœæˆ‘æœ‰å¤šå€‹æ”¯ä»˜ï¼Œæˆ‘æ˜¯ä¸æ˜¯è¦æŠŠæ¯å€‹ CreditCardPay / ApplePay éƒ½å¯«æˆä¸€å€‹ Modelï¼Ÿã€ &lt;br>
Teddy åå•ï¼šã€Œç‚ºä»€éº¼éœ€è¦ï¼Ÿå¦‚æœ Pay åªæ˜¯ä¸€å€‹ä»˜æ¬¾æ‰‹æ®µï¼Œå¦‚æœæ²’æœ‰å¾ˆå¤§çš„å·®ç•°ï¼Œä¸€å€‹ Pay è¡¨é”å¯¦ä½œæ™‚å†æ‹†åˆ†å°±å¥½ã€&lt;br>
æˆ‘æ¥è‘—æå•ï¼šã€Œé‚£ç‚ºä»€éº¼ Stage / Swimlane è¦æ‹†åˆ†ï¼Ÿä»–å€‘ä¹Ÿåªæ˜¯ä¸€å€‹æ©«çš„ä¸€å€‹ç›´çš„ã€&lt;/p>
&lt;p>Teddy è¡¨ç¤º &lt;code>å› ç‚ºåœ¨çœ‹æ¿çš„ Domain ä¸­ï¼Œç›´çš„ä»£è¡¨å·¥ä½œéšæ®µ / æ©«çš„ä»£è¡¨å·¥ä½œæµç¨‹æ˜¯æˆªç„¶ä¸åŒçš„ï¼Œé€™æ˜¯éå¸¸æ ¸å¿ƒçš„å•†æ¥­é‚è¼¯&lt;/code>ï¼Œæ‰€ä»¥ Model è¦æ‹†åˆ°å¤šç´°ï¼Œè¦ä¸è¦çœŸçš„æŠŠæ¯å€‹å¯¦ä½œçš„ç‰©ä»¶éƒ½è¡¨é”ï¼Œå®Œå…¨çœ‹é ˜åŸŸå°ˆå®¶èˆ‡é–‹ç™¼äººå“¡æ˜¯å¦å¾ˆé‡è¦–æ¯å€‹å…ƒä»¶çš„ç¨ç«‹æ€§èˆ‡è¡¨é”æ€§&lt;/p>
&lt;h3 id="7-software-design---æ‰¾å‡º-aggregate">7. Software Design - æ‰¾å‡º Aggregate&lt;/h3>
&lt;p>æœ€å¾Œä¸€æ­¥! ä¹Ÿæ˜¯å¾ˆæŠ½è±¡çš„ä¸€æ­¥ï¼Œå°‡ Model åˆ†ç¾¤ï¼Œæœ‰äº› Model æ˜é¡¯æ˜¯å…¶ä»– Model çš„é™„åº¸ ï¼Œä¾‹å¦‚èªªè¨‚å–®ç´°é … Order Item æ˜¯è¨‚å–® Order çš„é™„åº¸ï¼Œæ¯æ¬¡ Order Item çš„æ”¹å‹•æœƒå½±éŸ¿ Order çš„è¨ˆç®—ï¼Œæœƒé€²éšå½±éŸ¿ä¾‹å¦‚æŠ˜åƒ¹åˆ¸ç­‰è¨ˆç®—ï¼Œæ‰€ä»¥ Order Item æœ€å¥½ä¸è¦ç›´æ¥èª¿æ•´ï¼Œç”± Order çµ±ä¸€èª¿æ•´æ‰èƒ½ç¢ºä¿è³‡æ–™çš„&lt;code>ä¸€è‡´æ€§&lt;/code>&lt;/p>
&lt;p>è¦ä¸è¦æŠŠ Model Aggregate æˆä¸€å¡Šæœ‰å…©å€‹ä½œç”¨åŠ›&lt;/p>
&lt;ul>
&lt;li>è³‡æ–™ä¸€è‡´æ€§&lt;/li>
&lt;li>ä½µç™¼æ“ä½œ&lt;/li>
&lt;/ul>
&lt;p>Teddy å¸¶æˆ‘å€‘æ€è€ƒçš„æ–¹å¼æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>ä»Šå¤©æˆ‘æ”¹å‹• Model Aï¼Œé‚£æˆ‘å¯ä¸å¯ä»¥åŒæ™‚æ”¹å‹• Model B ? æˆ‘åœ¨ Workflow name çš„æ™‚å€™ï¼Œå¯ä»¥åŒæ™‚æ“ä½œ Board å—ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>åˆ‡è¨˜ä¸è¦ç”¨ Database Relation æ€è€ƒï¼Œä¾‹å¦‚ User åˆªé™¤ Order ä¹Ÿè¦è·Ÿè‘—è¢«åˆªé™¤ï¼Œé€™æ¨£ Aggregate æ°¸é åˆ‡ä¸é–‹ï¼Œæ›´ç›´è§€åœ°èªª &lt;code>è¦åŒ… Transaction æ“ä½œçš„éƒ½å°±æ”¾åœ¨åŒä¸€å€‹ Aggregate&lt;/code>&lt;br>
&lt;img src="https://yuanchieh.page/post/2022/img/0114/aggregate-right.png"
loading="lazy"
>&lt;/p>
&lt;p>æ‰¾å‡º Aggregate å¾Œï¼Œéœ€è¦æ‰¾ä¸€å€‹ Model ç•¶ä½œ Rootï¼Œå¾€å¾Œ Aggregate å…§çš„ Model éƒ½ç”±ä»–ä¾†æ§åˆ¶ï¼Œ&lt;code>å¤–äººä¸å¯ç›´æ¥æ“ä½œå…§éƒ¨ Model&lt;/code>ï¼Œä»»ä½•è·¨ Aggregate æ“ä½œåªèƒ½ä¿è­‰æœ€çµ‚ä¸€è‡´æ€§&lt;/p>
&lt;h3 id="å»¶ä¼¸è®Šé«”é‚„æ˜¯å¾ˆæƒ³æŠŠè®€å–ä¹Ÿæ”¾å…¥-event-storming-å¯ä»¥å—">å»¶ä¼¸è®Šé«”ï¼šé‚„æ˜¯å¾ˆæƒ³æŠŠè®€å–ä¹Ÿæ”¾å…¥ Event Storming å¯ä»¥å—ï¼Ÿ&lt;/h3>
&lt;p>Teddy ä¸Šèª²ä¸€ç›´å¼·èª¿è®€å–éš¨ä¾¿å¯«å°±å¥½ï¼Œæ€éº¼é«’éƒ½æ²’é—œä¿‚å› ç‚º Command æ‰æœƒå½±éŸ¿ç³»çµ±ç‹€æ…‹ XD Query æ•ˆèƒ½å•é¡Œç­‰åˆæ˜¯ DB ç´°ç¯€ï¼Œæœ¬èº«ä¹Ÿä¸æ˜¯ Event Storming è©²é—œæ³¨çš„å±¤ç´š&lt;/p>
&lt;p>ä½†å”ä½œä¸Šå¤§å®¶é‚„æ˜¯æƒ³æŠŠ UI æ”¾åˆ°è¨è«–ä¸­ / Read Model å¦‚æœæœ‰å‰ç«¯å¯èƒ½ä¹Ÿå¸Œæœ›åœ¨å¯«å¾—ç´°ä¸€é»ï¼Œé€™äº›éƒ½å¯ä»¥è‡ªå·±å»¶ä¼¸ï¼ŒTeddy ä¹Ÿåˆ†äº«æœ‰äº›æµç¨‹ UI å¯ä»¥å¹«åŠ©èªªæ˜çš„è©±ä»–ä¹Ÿæœƒæ”¾é€²å»ï¼Œä¾‹å¦‚ Command å¾Œå›å‚³å¦ä¸€å¼µ Read Model / UI åœ–ç¤ºæ”¾åœ¨ Read Model æ—é‚Šç­‰
&lt;img src="https://yuanchieh.page/post/2022/img/0114/ui.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="å»¶ä¼¸å•é¡Œé–‹ç™¼åªè¦é€™ä¸€ä»½æ–‡ä»¶å°±å¥½äº†å—">å»¶ä¼¸å•é¡Œï¼šé–‹ç™¼åªè¦é€™ä¸€ä»½æ–‡ä»¶å°±å¥½äº†å—ï¼Ÿ&lt;/h3>
&lt;p>æ–‡ä»¶çš„ç¶­è­·ä¹Ÿæ˜¯æˆ‘èª²å‰å¾ˆæƒ³äº†è§£çš„éƒ¨åˆ†ï¼Œåœ¨ DDD è—çš®æ›¸ä¸­ä¸æ–·å¼·èª¿ &lt;code>Domain Model è·Ÿç¨‹å¼ç¢¼å¯¦ä½œè¦é«˜åº¦ä¸€è‡´&lt;/code>ä¸¦æŒçºŒæ¼”é€²ï¼Œä½†å·¥ä½œå¤šå¹´æœ‰è‰¯å¥½ç¶­è­·æ–‡ä»¶ç¿’æ…£çš„äººé‚„çœŸçš„æ˜¯å°‘æ•¸ï¼Œå°¤å…¶æ˜¯æ–‡ä»¶è¶Šå¤šä»½ç¶­è­·çš„æˆæœ¬å°±æ›´é«˜ï¼Œæ‰€ä»¥æˆ‘èª²å¾Œå°±å• Teddy ä»–å€‘åœ˜éšŠé–‹ç™¼æ˜¯ä¸æ˜¯åªæœ‰é€™ä¸€ä»½æ–‡ä»¶ï¼Œä»–èªªåŸºæœ¬ä¸Šæ˜¯ï¼Œè³‡æ–™åº«éƒ¨åˆ†å› ç‚ºä»–æ˜¯èµ° Event Sourcing æ‰€ä»¥ä¸ç”¨å¦å¤–çš„ Schema è¨­è¨ˆæ–‡ä»¶ï¼Œå¦‚æœä¸æ˜¯é ‚å¤šå†ä¸€ä»½ DB Schema æ–‡ä»¶å°±è¶³å¤ äº†&lt;/p>
&lt;h2 id="ddd---tacticle-design--strategic-design">DDD - Tacticle Design &amp;amp; Strategic Design&lt;/h2>
&lt;p>è·‘éä¸€æ¬¡ Event Storming å†å›ä¾†çœ‹ DDD å»£ç‚ºäººçŸ¥çš„å…©å¼µåœ–å°±æ¯”è¼ƒèƒ½ç†è§£äº†ï¼Œé€™é‚Šåªé¡å¤–è£œå……å…©ä»¶äº‹&lt;/p>
&lt;h4 id="1-entity-èˆ‡-value-object-å€åˆ†">1. Entity èˆ‡ Value Object å€åˆ†&lt;/h4>
&lt;p>å‰è€…æ˜¯å…·æœ‰ id åœ¨ Conext ä¸‹æœ‰å”¯ä¸€è­˜åˆ¥æ€§çš„ç‰©ä»¶ï¼Œå¾Œè€…æ˜¯å…§å®¹é‡è¦ä½†æ˜¯ä¸æ˜¯åŒä¸€å€‹ç‰©ä»¶ä¸å¤ªé—œå¿ƒï¼Œä¾‹å¦‚èªªç´™éˆ”ï¼Œå¤§å¤šç³»çµ±ä¸‹æˆ‘å€‘åªé—œå¿ƒç´™éˆ”çš„é¢é¡ï¼Œç”­ç®¡ä½ æ˜¯å·¦é‚Šçš„ 100 å…ƒé‚„æ˜¯å³é‚Šçš„ 100 å…ƒï¼Œæ‰€ä»¥æ˜¯ Value Object / ä½†å¦‚æœæ˜¯å°éˆ”ç³»çµ±ï¼ŒåŒæ¨£æ˜¯ 100 å…ƒé‚„æ˜¯è¦ç”¨ id å€åˆ†ä¸åŒçš„ç´™éˆ”ï¼Œé€™æ™‚å°±æ˜¯ Entity äº†&lt;/p>
&lt;h4 id="2-å¦‚æœæœ‰é©—è­‰éœ€æ±‚å¯ä»¥è€ƒæ…®ç”¨-value-object">2. å¦‚æœæœ‰é©—è­‰éœ€æ±‚ï¼Œå¯ä»¥è€ƒæ…®ç”¨ Value Object&lt;/h4>
&lt;p>ä¸€å€‹å¯¦ä½œçš„å°ç´°ç¯€ï¼Œå¦‚æœä»¥å¾€éƒ½æ˜¯ç”¨æ¬„ä½å„²å­˜ä¸€å€‹åŸºç¤å‹åˆ¥ï¼Œä¾‹å¦‚ string emailï¼Œè¦å¢åŠ é©—è­‰å°±æœƒå¾ˆç‘£ç¢ï¼Œå°è£ä¸€å€‹ Email ç‰©ä»¶ä¸¦åœ¨ constructor çµ±ä¸€é©—è­‰æœƒæ¯”è¼ƒç°¡æ½”&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>é‡é»å°æ•´ç†ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»¥å•†æ¥­æ ¸å¿ƒç‚ºå‡ºç™¼&lt;/li>
&lt;li>ç”¨èªªæ•…äº‹çš„æ–¹å¼è·‘ Event Storming&lt;/li>
&lt;li>ä¸è¦è½å…¥å¯¦ä½œç´°ç¯€&lt;/li>
&lt;li>å¦‚æœæœ‰éœ€è¦ï¼Œå¯ä»¥è‡ªå·±è®Šé«”é©æ‡‰çµ„ç¹”&lt;/li>
&lt;/ul>
&lt;p>ä¸Šå®Œèª²è‡ªå·±é‡æ–°è¦†ç›¤ï¼Œæ²’æƒ³åˆ°èŠ±é€™éº¼å¤šæ™‚é–“æ‰æ•´ç†å®Œï¼ŒDDD ç”¨éœæ…‹çš„å­¸ç¿’æ–¹å¼çœŸçš„å¾ˆæŠ½è±¡ï¼Œå¤§è…¦ä¸€ç›´è½‰ä¸éå»ï¼Œä¸Šå®Œ Teddy çš„èª²æ‰è¦ºå¾—é‚£æ‰‡é–€è¢«æ‰“é–‹äº†ä¸€å€‹ç¸«ï¼Œçœ‹åˆ°ç†æƒ³è»Ÿé«”é–‹ç™¼çš„å…‰æ˜ XD&lt;/p>
&lt;p>é€™ä¸€ç¯‡ä¸»è¦æ•´ç† DDDï¼Œä¸‹ä¸€ç¯‡é è¨ˆæ•´ç† Clean Architecture èˆ‡å¦‚ä½•è·Ÿ DDD çµåˆï¼Œå¸Œæœ›é€™äº›ç´€éŒ„å°å¤§å®¶æœ‰å¹«åŠ©ï¼Œæœ€å¾Œåœ¨å¹« Teddy è€å¸«æ¨å»£ä¸€ä¸‹ä»–çš„&lt;a class="link" href="https://teddysoft.tw/courses/clean-architecture/" target="_blank" rel="noopener"
>èª²ç¨‹&lt;/a>ï¼Œåªæœ‰å¯¦éš›è·‘éä¸€æ¬¡Event Storming æ‰èƒ½çœŸæ­£å­¸æœƒï¼Œå¦‚æœæœ‰ä»€éº¼å»ºè­°æˆ–ç³¾éŒ¯å†éº»ç…©ç•™è¨€&lt;/p></description></item><item><title>ã€Šå–®é«”å¼ç³»çµ±åˆ°å¾®æœå‹™ã€‹è®€å¾Œåˆ†äº« - ä¸‹</title><link>https://yuanchieh.page/posts/2021/2021-12-05-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8B/</link><pubDate>Sun, 05 Dec 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-12-05-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8B/</guid><description>&lt;h2 id="ç¬¬å››ç« åˆ†è§£è³‡æ–™åº«">ç¬¬å››ç« ï¼šåˆ†è§£è³‡æ–™åº«&lt;/h2>
&lt;p>ä¸Šä¸€ç« æ˜¯ç”¨ç³»çµ±çš„å±¤ç´šè¨è«–å¦‚ä½•æ‹†åˆ†ï¼Œä½†ç³»çµ±æœ€é›£æ‹†åˆ†çš„éƒ¨åˆ†ç„¡ç–‘æ˜¯ &lt;code>è³‡æ–™åº«&lt;/code>ï¼Œæ‰€ä»¥ä½œè€…èŠ±äº†å¾ˆå¤§çš„ç¯‡å¹…æè¿°å¤šç¨®è³‡æ–™åº«æ‹†åˆ†çš„æ–¹å¼&lt;/p>
&lt;h3 id="åˆ†è§£æ¨¡å¼">åˆ†è§£æ¨¡å¼&lt;/h3>
&lt;h4 id="æ¨¡å¼ä¸€å…±äº«è³‡æ–™åº«">æ¨¡å¼ä¸€ï¼šå…±äº«è³‡æ–™åº«&lt;/h4>
&lt;p>æ‰€æœ‰çš„æœå‹™å…±äº«ä¸€å€‹è³‡æ–™åº«ï¼Œé€™æ˜¯ä¸€å€‹ä¸å¤ªå¥½çš„é¸æ“‡ï¼Œå› ç‚º&lt;code>ç„¡æ³•ä¿è­‰èª°æ§åˆ¶äº†è³‡æ–™&lt;/code>ï¼Œæ¯å€‹æœå‹™éƒ½æœ‰è®€å¯«ã€ä¿®æ”¹ Schema çš„èƒ½åŠ›ï¼Œé€™æš—ç¤ºäº†ç¼ºä¹å•†æ¥­é‚è¼¯çš„å‡èšåŠ›
&lt;img src="https://yuanchieh.page/post/2021/img/1203/share.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="æ¨¡å¼äºŒè³‡æ–™åº«è¦–åœ–">æ¨¡å¼äºŒï¼šè³‡æ–™åº«è¦–åœ–&lt;/h4>
&lt;p>å¦‚æœä»å¸Œæœ›å¤šå€‹æœå‹™é–“å…±äº«ä¸€å€‹è³‡æ–™åº«ï¼Œå¯ä»¥é€éè¦–åœ– (View Table) æ¸›è¼•è€¦åˆä¸Šçš„å›°æ“¾ï¼Œå› ç‚ºè¦–åœ–å¯ä»¥æœ‰ç¨ç«‹çš„æ¬Šé™ç®¡ç†ä¸¦éš±è—åº•å±¤å¯¦éš›å„²å­˜çš„é‚è¼¯ï¼›
è¦–åœ–çš„åŠŸèƒ½å–æ±ºæ–¼è³‡æ–™åº«æœ¬èº«çš„é™åˆ¶ï¼Œè¦å°å¿ƒè³‡æ–™æ˜¯å¦éæ™‚ç­‰å•é¡Œ
&lt;img src="https://yuanchieh.page/post/2021/img/1203/view.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="æ¨¡å¼ä¸‰è³‡æ–™åº«åŒ…è£æœå‹™">æ¨¡å¼ä¸‰ï¼šè³‡æ–™åº«åŒ…è£æœå‹™&lt;/h4>
&lt;p>å°‡è³‡æ–™åº«éš±è—åœ¨æœå‹™å¾Œé¢ï¼Œå¾&lt;code>è³‡æ–™åº«ä¾è³´è½‰è®Šæˆæœå‹™ä¾è³´&lt;/code>ï¼Œé€™å¯ä»¥ç•¶ä½œè½‰ç§»çš„ç¬¬ä¸€æ­¥ï¼Œå…ˆé¿å…è³‡æ–™åº«è€¦åˆæŒçºŒæƒ¡åŒ–ï¼Œé€éä¸€å±¤æœå‹™å°è£èˆ‡éš±è—å¯¦éš›çš„è³‡æ–™åº«é‚è¼¯&lt;/p>
&lt;p>æ›¸ä¸­æ¡ˆä¾‹æ˜¯éŠ€è¡Œçš„æ¬Šé™ç®¡ç†ï¼Œå¤šå€‹æœå‹™å› æ‡‰ä¸åŒçš„å ´æ™¯æŒçºŒå †ç–Šæ–°çš„æ¬Šé™ç®¡ç†åœ¨è³‡æ–™åº«ä¸­ï¼Œé€éæ‹†åˆ†å‡ºæ¬Šé™æœå‹™ï¼Œå°‡æ¬Šé™èª¿æ•´é™ç¸®å–®ä¸€æœå‹™ï¼Œå¾ŒçºŒå†è€ƒæ…®æ‹†åˆ†ç¨ç«‹è³‡æ–™åº«ï¼Œæœ‰é»åƒä¸Šä¸€ç« æåˆ°çš„&lt;a class="link" href="https://yuanchieh.page/post/2021/2021-12-03-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-copy/#%E6%A8%A1%E5%BC%8F%E4%BA%8C%E6%8A%BD%E8%B1%A1%E5%88%86%E6%94%AF" target="_blank" rel="noopener"
>æŠ½è±¡åˆ†æ&lt;/a>&lt;/p>
&lt;p>è·Ÿè¦–åœ–ç›¸æ¯”çš„å¥½è™•æ˜¯ä¸éœ€è¦æ˜ å°„ç¾æœ‰çš„è³‡æ–™è¡¨ï¼Œä¸”å¯ä»¥é€éç¨‹å¼é‚è¼¯æ§åˆ¶æ›´è¤‡é›œçš„æ“ä½œï¼Œåªæ˜¯ä¸Šæ¸¸ä»‹æ¥çš„æœå‹™éœ€è¦èª¿æ•´
&lt;img src="https://yuanchieh.page/post/2021/img/1203/service.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="æ¨¡å¼å››è³‡æ–™åº«æœå‹™ä»‹é¢">æ¨¡å¼å››ï¼šè³‡æ–™åº«æœå‹™ä»‹é¢&lt;/h4>
&lt;p>å¦‚æœå®¢æˆ¶ç«¯æ˜¯ BI å·¥å…·éœ€è¦ç›´æ¥é€é SQL ç«¯é»è®€å–ï¼Œæœ€å¥½æ˜¯å»ºç«‹å°ˆé–€çš„è³‡æ–™åº«ä½œç‚ºå…¬é–‹çš„è®€å–ç«¯é»ï¼Œå°æ˜ å¼•æ“è² è²¬åŒæ­¥è³‡æ–™ï¼Œå¯ä»¥é€éæ‰¹æ¬¡è™•ç†ã€ä¸²æµåŒæ­¥å·¥å…· (ä½œè€…æ¨è–¦ &lt;a class="link" href="https://debezium.io/" target="_blank" rel="noopener"
>Debezium&lt;/a>)ï¼Œè™•ç†çš„è¤‡é›œåº¦ä»°è³´æ–¼å…§éƒ¨è³‡æ–™åº«èˆ‡å°å¤–è³‡æ–™åº«çš„å·®ç•°ï¼Œå¦‚å¾ Cassandra æ˜ å°„åˆ° SQL DB
&lt;img src="https://yuanchieh.page/post/2021/img/1203/endpoint.jpg"
loading="lazy"
>&lt;/p>
&lt;h3 id="å…ˆåˆ†å‰²è³‡æ–™åº«é‚„æ˜¯ç¨‹å¼ç¢¼">å…ˆåˆ†å‰²è³‡æ–™åº«é‚„æ˜¯ç¨‹å¼ç¢¼&lt;/h3>
&lt;h4 id="å…ˆåˆ†å‰²è³‡æ–™åº«">å…ˆåˆ†å‰²è³‡æ–™åº«&lt;/h4>
&lt;p>è¦å°å¿ƒè·¨è³‡æ–™åº« Joinã€ä¸€è‡´æ€§èˆ‡å®Œæ•´æ€§å•é¡Œï¼Œå¦‚æœè¦ç‰¹åˆ¥æ³¨æ„è³‡æ–™ä¸€è‡´æ€§å•é¡Œå¯ä»¥æ¡å–æ­¤æ–¹æ³•ï¼Œç¼ºé»æ˜¯çŸ­æœŸæ•ˆç›Šä¸å¤§ï¼Œä¾ç„¶è¦é¢è‡¨å–®é«”å¼æ¶æ§‹&lt;/p>
&lt;p>å¯ä»¥é€éç¨‹å¼ä¸­çš„ Storage Layer å°‡ Domain å°æ‡‰åˆ°ç¨ç«‹çš„ Table / Database&lt;/p>
&lt;h4 id="å…ˆåˆ†å‰²ç¨‹å¼ç¢¼">å…ˆåˆ†å‰²ç¨‹å¼ç¢¼&lt;/h4>
&lt;p>å…ˆåˆ†å‰²ç¨‹å¼ç¢¼æ›´å®¹æ˜“äº†è§£æ–°æœå‹™éœ€è¦çš„è³‡æ–™ï¼Œä¹Ÿèƒ½å¤ ææ—©ç¨ç«‹éƒ¨ç½²æ–°æœå‹™ï¼Œä½†æœ‰å¯èƒ½æ‹†åˆ†å®Œç¨‹å¼ç¢¼å°±æ²’æœ‰ç¹¼çºŒæ‹†åˆ†è³‡æ–™åº«&lt;/p>
&lt;h3 id="è³‡æ–™ä¸€è‡´æ€§">è³‡æ–™ä¸€è‡´æ€§&lt;/h3>
&lt;p>å¦‚æœéœ€è¦é‡å°ä¸åŒçš„ Domain æ“ä½œå¯ä»¥åœ¨ SQL è³‡æ–™åº«ä¸­ç”¨ Transaction åŒ…èµ·ä¾†ç¢ºä¿åŸå­æ€§ï¼Œä½†æ˜¯åˆ†æ•£å¼æ¶æ§‹å°±éœ€è¦ç”¨åˆ¥çš„æ–¹å¼ç¢ºä¿åŸå­æ€§&lt;/p>
&lt;h4 id="æ–¹æ³•ä¸€äºŒéšæ®µæäº¤">æ–¹æ³•ä¸€ï¼šäºŒéšæ®µæäº¤&lt;/h4>
&lt;p>é€éä¸€å€‹å”èª¿è€…ï¼Œèˆ‡å¤šå€‹æœå‹™æºé€šä¸¦ç¢ºä¿å¤§å®¶ä¸€èµ· commit æˆ–ä¸€èµ· rollbackï¼Œæ¼”ç®—æ³•è¤‡é›œä¸”æ•ˆç‡å·®ï¼Œå¦‚æœå±…ä¸­çš„å”èª¿è€…å¤±æ•—å‰‡æœƒå‡ºç¾éä¸€è‡´æ€§å•é¡Œ
&lt;img src="https://yuanchieh.page/post/2021/img/1203/2pc.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="æ–¹æ³•äºŒsaga">æ–¹æ³•äºŒï¼šSaga&lt;/h4>
&lt;p>é¿å…é•·æ™‚é–“é–å®šè³‡æ–™ï¼Œå°‡æ¯å€‹åŸ·è¡Œæ­¥é©Ÿæ¨¡çµ„åŒ–ç¨ç«‹é‹ä½œï¼Œå€‹åˆ¥æœå‹™éƒ½è¦è™•ç†ç•°å¸¸äº‹ä»¶æ™‚çš„è£œå„Ÿè¡Œç‚ºï¼Œåƒè€ƒ &lt;a class="link" href="https://docs.microsoft.com/zh-tw/azure/architecture/reference-architectures/saga/saga" target="_blank" rel="noopener"
>Saga åˆ†æ•£å¼äº¤æ˜“æ¨¡å¼&lt;/a>ï¼Œä½†è¦å°å¿ƒ Saga æ¨¡å¼çš„è¤‡é›œåº¦å¾ˆé«˜
&lt;img src="https://yuanchieh.page/post/2021/img/1203/saga.jpg"
loading="lazy"
>&lt;/p>
&lt;h2 id="ç¬¬äº”ç« æˆé•·éç¨‹ä¸­çš„ç—›è‹¦">ç¬¬äº”ç« ï¼šæˆé•·éç¨‹ä¸­çš„ç—›è‹¦&lt;/h2>
&lt;p>å°å…¥å¾®æœå‹™æœƒé‡åˆ°å¾ˆå¤šçš„æŒ‘æˆ°ï¼Œå°¤å…¶æ˜¯ç•¶åœ˜éšŠäººæ•¸èˆ‡å¾®æœå‹™æ•¸é‡æŒçºŒå¢åŠ æ™‚ï¼Œå¯èƒ½æœƒé–‹å§‹å‡ºç¾ä»¥ä¸‹å•é¡Œ&lt;/p>
&lt;h3 id="1-å¤§è¦æ¨¡æ‰€æœ‰æ¬Š">1. å¤§è¦æ¨¡æ‰€æœ‰æ¬Š&lt;/h3>
&lt;p>ç•¶è¦æ”¹å‹•ç¨‹å¼ç¢¼æ™‚ï¼Œæœƒä¾ç…§ç¨‹å¼ç¢¼æ‰€æœ‰æ¬Šæ¦‚å¿µè€Œæœ‰æ‰€ä¸åŒï¼Œå¦‚æœæ˜¯å¼·å¤§çš„ç¨‹å¼ç¢¼æ‰€æœ‰æ¬Šå‰‡éœ€è¦å†ä¿®æ”¹å‰å‘ŠçŸ¥æŒæœ‰è€…ï¼›å¼±æ‰€æœ‰æ¬Šæˆ–æ˜¯é›†é«”æ‰€æœ‰æ¬Šå‰‡æ˜¯ç›´æ¥ä¿®æ”¹ä¸éœ€è¦é¡å¤–é€šçŸ¥&lt;/p>
&lt;p>é€šå¸¸ä¸€é–‹å§‹éƒ½æ˜¯é›†é«”æ‰€æœ‰æ¬Šï¼Œå¤§å®¶åˆ†å·¥é–‹ç™¼è€Œæ²’æœ‰ç‰¹å®šçš„ä»»å‹™ï¼Œä½†æ˜¯ç•¶äººæ•¸è¶…é 100 äººï¼Œé€šå¸¸å¥½çš„åœ˜éšŠéƒ½æ˜¯&lt;code>å¼·æ‰€æœ‰æ¬Š&lt;/code>ï¼Œè®“æ¯å€‹åœ˜éšŠå°ˆæ³¨æ–¼ç‰¹å®šé ˜åŸŸ&lt;/p>
&lt;h3 id="2-é‡å¤§è®Šé©">2. é‡å¤§è®Šé©&lt;/h3>
&lt;p>ç•¶å¾®æœå‹™æ”¹å‹•æ™‚ï¼Œå¦‚æœæ²’æœ‰è¬¹æ…æ€è€ƒç ´å£åŸæœ¬çš„ä»‹é¢ï¼Œå‰‡ç›¸ä¾çš„æœå‹™ä¹Ÿæœƒè·Ÿè‘—è¢«ç ´å£ï¼Œä¾‹å¦‚æå‡ API ç‰ˆè™Ÿæ™‚ï¼Œè¨˜å¾—è¦å…¬å‘Šä¸¦ä¿ç•™ä¸€å®šçš„æ”¯æ´æ™‚é–“&lt;/p>
&lt;h3 id="3-å ±å‘Š">3. å ±å‘Š&lt;/h3>
&lt;p>éå¾€å–®é«”å¼è³‡æ–™åº«è¦æ‹‰å ±è¡¨ç›¸å°ç°¡å–®ï¼Œä½†å¦‚æœæ‹†åˆ†å¾®æœå‹™ï¼Œä¸åŒåœ˜éšŠæ¡ç”¨ä¸åŒçš„è³‡æ–™åº«ï¼Œè¦ç¢ºä¿æœ€çµ‚å†ç”¢ç”Ÿå ±å‘Šæ™‚æœ‰åŒæ­¥ç›¸åŒçš„è³‡æ–™&lt;/p>
&lt;h3 id="4-ç›£æ§å’Œç–‘é›£æ’æŸ¥">4. ç›£æ§å’Œç–‘é›£æ’æŸ¥&lt;/h3>
&lt;p>åˆ†æ•£å¼ç³»çµ±çš„ç›£æ§èˆ‡æ’æŸ¥é›£åº¦æœƒæ¯”å–®é«”å¼é«˜éå¸¸å¤šï¼Œå¯ä»¥ä½¿ç”¨ ELK / Fluentd ç­‰æŠ€è¡“å½™æ•´ï¼Œä¸¦å¢åŠ ç³»çµ±çš„&lt;code>å¯è§€æ¸¬æ€§&lt;/code>ï¼ŒObservability çš„æ¦‚å¿µç®—æ˜¯æŠŠ Monitoring å†å¾€å‰æ¨é€²ä¸€æ­¥ï¼Œå¯ä»¥åƒè€ƒ &lt;a class="link" href="https://ithelp.ithome.com.tw/articles/10265190" target="_blank" rel="noopener"
>å–¬å”å¸¶ä½ ä¸Šæ‰‹ Elastic Stack - æ¢ç´¢èˆ‡å¯¦è¸ Observabilityï¼š01 - å‰è¨€ &amp;amp; æ·ºè«‡ Observability&lt;/a>ï¼›åœ¨è¿½è¹¤éƒ¨åˆ†ï¼Œå¯ä»¥æŠŠæ¯ä¸€å€‹å‘¼å«éƒ½ç”¢ç”Ÿå°æ‡‰çš„é—œè¯ IDï¼Œè¿½è¹¤åœ¨ä¸åŒå¾®æœå‹™é–“çš„é€šä¿¡ï¼Œå¯ä»¥åƒè€ƒé–‹æºå·¥å…· &lt;a class="link" href="https://www.jaegertracing.io/" target="_blank" rel="noopener"
>Jaeger&lt;/a>&lt;/p>
&lt;h3 id="5-ç•¶åœ°é–‹ç™¼è€…ç¶“é©—">5. ç•¶åœ°é–‹ç™¼è€…ç¶“é©—&lt;/h3>
&lt;p>ç•¶æœ‰æ›´å¤šæœå‹™æ™‚ï¼Œè¦åœ¨æœ¬åœ°ç«¯é–‹ç™¼è®Šæˆä¸€å ´å¤¢é­˜ï¼Œé›–ç„¶èªªæœ‰ Docker ç­‰å®¹å™¨åŒ–æŠ€è¡“ï¼Œä½†å¦‚æœåƒ JVM éœ€è¦åƒå¤§é‡è³‡æºï¼Œå¯èƒ½æœƒè€—ç›¡é–‹ç™¼è€…çš„æœ¬åœ°ç«¯è³‡æºï¼Œå¦‚æœæ˜¯ä½¿ç”¨ k8s å¯ä»¥è€ƒæ…®ç”¨ &lt;a class="link" href="https://www.telepresence.io/" target="_blank" rel="noopener"
>Telepresence&lt;/a>ï¼Œéƒ¨ç½²å®Œæ•´æœå‹™åœ¨é›²ç«¯ï¼Œé–‹ç™¼è€…å¯ä»¥é‹è¡Œç‰¹å®šæœå‹™åœ¨æœ¬åœ°ç«¯å…¶é¤˜ä¾è³´é›²ç«¯çš„æœå‹™&lt;/p>
&lt;h3 id="6-å…¨åŸŸèˆ‡æœ¬åœ°å„ªåŒ–æ¯”è¼ƒ">6. å…¨åŸŸèˆ‡æœ¬åœ°å„ªåŒ–æ¯”è¼ƒ&lt;/h3>
&lt;p>é›–ç„¶èªªå¾®æœå‹™å¯ä»¥è®“å„å€‹åœ˜éšŠå½ˆæ€§çš„æ¡ç”¨æŠ€è¡“ï¼Œä½†å¾æ•´é«”çš„è§’åº¦å¤ªéåˆ†æ•£çš„æŠ€è¡“æ£§å¯èƒ½æœƒå°è‡´è²»ç”¨ä¸Šæˆ–æ˜¯ç¶­è­·ä¸Šçš„å›°é›£ï¼›ä½†å¦‚æœå¤ªé›†ä¸­åŒ–ç®¡ç†ï¼Œå¼·è¿«å„å€‹åœ˜éšŠæ¡ç”¨ç›¸åŒçš„æŠ€è¡“åˆå¤±å»äº†å¾®æœå‹™çš„éƒ¨åˆ†å¥½è™•&lt;/p>
&lt;p>é€™å¯ä»¥ç”¨å‰å¹¾ç« æè¿°çš„å¯é€†èˆ‡ä¸å¯é€†æ±ºç­–ï¼Œå¦‚æœæ˜¯ä¸å¯é€†å¦‚é›²ç«¯ä¾›æ‡‰å•†ç­‰ï¼Œå‰‡éœ€è¦è·¨åœ˜éšŠçš„è¨è«–ï¼Œä½†å¯é€†çš„æ±ºç­–å¦‚æ¡ç”¨å‡½å¼åº«ã€å˜—è©¦æ–°çš„ç¨‹å¼èªè¨€å‰‡å¯ä»¥æ”¾æ‰‹çµ¦åœ˜éšŠæ±ºå®šï¼Œæœ€å¥½æ˜¯å¯ä»¥è®“&lt;code>æ¯å€‹åœ˜éšŠå‡ºä¸€åæŠ€è¡“è² è²¬äººçµ„æˆè·¨éƒ¨é–€å°çµ„&lt;/code>ï¼ŒåŒæ™‚å…¼å®¹å…¨åŸŸèˆ‡æœ¬åœ°å„ªåŒ–çš„å¯èƒ½&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>ä»¥ä¸Šæ˜¯å¾æ›¸ä¸­æ‘˜éŒ„çš„å…§å®¹ï¼Œå› ç‚ºé‚„æ²’æœ‰å¤ªå¤šçš„å¯¦éš›ç¶“é©—ï¼Œåªèƒ½ç…§æœ¬å®£ç§‘ï¼Œç„¡æ³•åƒå®‰å¾·é­¯å¤§å”å¯«å‡ºæŠ½è±¡åŒ–ç¨‹åº¦å¤ ä¹ŸåŒ…å«è¶³å¤ æ‰å¯¦çš„ç¶“é©—åˆ†äº«ï¼ŒæœŸè¨±è‡ªå·±æœªä¾†æœ‰æ›´å¤šç¶“é©—èƒ½å¤ é‡æ–°è£œå……æ–‡ç« å…§å®¹&lt;/p>
&lt;p>å¥½çš„æ¶æ§‹è¨­è¨ˆæ˜¯æŒçºŒæ¼”é€²çš„ï¼Œå»ºè­°æ˜¯å¾ Monolithic -&amp;gt; Modulized Monolithic -&amp;gt; Microservicesï¼Œå¦‚æœç„¡æ³•æ¨¡çµ„åŒ–å–®é«”å¼ï¼Œé‚£åªæœƒå¾—åˆ°æ›´ç³Ÿç³•çš„å¾®æœå‹™ï¼Œå¾®æœå‹™æœ¬èº«é€éç¨ç«‹çš„æœå‹™å½¢æˆé«˜å¼·åº¦ã€é›£ä»¥é•èƒŒçš„æ¨¡çµ„åŒ–ï¼Œå•é¡Œå°±å›åˆ°ç¨‹å¼è¨­è¨ˆçš„æœ€æºé ­å¦‚ä½•è¨­è¨ˆå‡º&lt;code>é«˜å…§èš+ä½è€¦åˆçš„æ¨¡çµ„&lt;/code>ï¼Œå¾€ä¸‹é è¨ˆé‚„æœ‰å¹¾å€‹çŸ¥è­˜é»çš„å»¶ä¼¸ DDD / Event Storming / Clean Architecture / Observability (é æœ›&lt;/p></description></item><item><title>ã€Šå–®é«”å¼ç³»çµ±åˆ°å¾®æœå‹™ã€‹è®€å¾Œåˆ†äº« - ä¸Š</title><link>https://yuanchieh.page/posts/2021/2021-12-03-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8A/</link><pubDate>Fri, 03 Dec 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-12-03-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8A/</guid><description>&lt;p>å¾®æœå‹™å› æ‡‰å®¹å™¨åŒ–æŠ€è¡“ã€æŒçºŒæ•´åˆèˆ‡äº¤ä»˜å·¥å…·æˆç†Ÿï¼Œæˆç‚ºé¡¯å­¸å¥½ä¸€æ®µæ™‚é–“äº†ï¼Œä½†é€™ä¸ä»£è¡¨æˆ‘å€‘å°±æ‡‰è©²å°å…¥å¾®æœå‹™ï¼Œçµ‚ç©¶å¾®æœå‹™åªæ˜¯ä¸€é …æŠ€è¡“(æˆ–èªªæ˜¯æ¶æ§‹)ï¼Œå¦‚æœæ²’æœ‰è¨­å®šä¸€å€‹æ­£ç¢ºçš„ç›®æ¨™ï¼Œä¸¦ç”¨é©ç•¶çš„æŒ‡æ¨™æ™‚æ™‚é—œæ³¨ï¼Œé‚£å°å…¥ä»»ä½•æ–°æŠ€è¡“æœ€å¾Œéƒ½æœƒæ˜¯ä¸€å ´ç½é›£ï¼Œå¾®æœå‹™æ›´æ˜¯ï¼›
æˆ‘å¾ˆå–œæ­¡é€™ç¯‡åˆ†äº«ï¼Œå…ˆæª¢è¦–åœ˜éšŠçš„ CI/CDã€monitoring æ©Ÿåˆ¶æ˜¯å¦å¥å…¨å†ä¾†æ€è€ƒå¾®æœå‹™ &lt;a class="link" href="https://www.facebook.com/hatelove/post/10223238347681539" target="_blank" rel="noopener"
>https://www.facebook.com/hatelove/post/10223238347681539&lt;/a>&lt;/p>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/GBTdnfD6s5Q"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>é€™éƒ¨å½±ç‰‡æ˜¯ Sam Newman (æœ¬æ›¸ä½œè€…)èˆ‡ Martin Fowler å°è«‡ï¼Œï¼Œä¸»è¦å¾å¯«æ›¸çš„å‹•æ©Ÿé–‹å§‹ï¼Œå¾Œé¢è«‡åˆ°äº†ç‚ºä»€éº¼è¦å°å…¥å¾®æœå‹™ã€å°å…¥ç†ç”±ä»¥åŠè³‡æ–™åº«ã€åœ˜éšŠå¦‚ä½•æ‡‰å°ç­‰ï¼ŒåŸºæœ¬ä¸Šè·Ÿæ›¸çš„çµæ§‹äº’ç›¸å‘¼æ‡‰ï¼ŒGOTO è »ç”¨å¿ƒçš„å½±ç‰‡ä¸€å€‹æ®µè½å°±æœƒæ‰“ Tag ä»¥åŠçµ±æ•´ï¼Œå¾ŒçºŒè¦å›é¡§å¾ˆæ–¹ä¾¿ï¼›å¾Œä¾†ç¶“æ­·æ‰çŸ¥é“ Sam Newman ä¹‹å‰ &lt;a class="link" href="https://samnewman.io/about/" target="_blank" rel="noopener"
>åœ¨ ThoughtWorks å·¥ä½œ 12 å¹´&lt;/a>&lt;/p>
&lt;p>ä»¥ä¸‹é‡å°æ¯ç« ç¯€åšä¸€äº›åˆ†äº«èˆ‡ç¸½çµï¼Œä¸¦èåˆä¸€äº›çœ‹éçš„è³‡æ–™&lt;/p>
&lt;h2 id="ç¬¬ä¸€ç« è¶³å¤ çš„å¾®æœå‹™">ç¬¬ä¸€ç« ï¼šè¶³å¤ çš„å¾®æœå‹™&lt;/h2>
&lt;p>å¾®æœå‹™æ˜¯æ³›æŒ‡&lt;code>åœç¹æ¥­å‹™é ˜åŸŸå»ºæ¨¡çš„å¯ç¨ç«‹éƒ¨ç½²ä¹‹æœå‹™&lt;/code>ï¼Œé€™é‚Šçš„é‡é»æœ‰å…©å€‹&lt;/p>
&lt;ol>
&lt;li>åœç¹æ¥­å‹™é ˜åŸŸ&lt;/li>
&lt;li>å¯ç¨ç«‹éƒ¨ç½²&lt;/li>
&lt;/ol>
&lt;h3 id="1-åœç¹æ¥­å‹™é ˜åŸŸ">1. åœç¹æ¥­å‹™é ˜åŸŸ&lt;/h3>
&lt;blockquote>
&lt;p>Conway&amp;rsquo;s Law: ä»»ä½•è¨­è¨ˆç³»çµ±çš„çµ„ç¹”ï¼Œéƒ½å°‡ä¸å¯ä»¥é¿å…çš„ç”¢ç”Ÿä»¥çµ„ç¹”é€šè¨Šæ¶æ§‹ç‚ºå‰¯æœ¬ä¹‹è¨­è¨ˆ&lt;/p>
&lt;/blockquote>
&lt;p>çµ„ç¹”çš„æ¶æ§‹æŸç¨®ç¨‹åº¦è·Ÿç¨‹å¼æ¶æ§‹é›·åŒï¼Œéƒ½æ‡‰è©²è¿½æ±‚é«˜å…§èšä½è€¦åˆï¼Œå¦å‰‡æœƒå› è·¨çµ„åˆ¥çš„é«˜æºé€šæˆæœ¬ï¼Œè€Œè®“çµ„ç¹”çš„ç”Ÿç”¢åŠ›ä¸‹é™ï¼Œé€²è€Œè®“å¤§å®¶é¸æ“‡å°è‡ªå·±æœ€æ–¹ä¾¿çš„è§£æ³•è€Œéå…¨å±€æœ€ä½³è§£&lt;/p>
&lt;p>æŠŠåº·å¨å®šå¾‹è½‰æˆå·¥ç¨‹å¸«çš„æ¯”å–»æœƒæ˜¯&lt;/p>
&lt;blockquote>
&lt;p>If you have four groups working on a compiler, you&amp;rsquo;ll get a 4-pass compiler&lt;/p>
&lt;/blockquote>
&lt;p>éå¾€çµ„ç¹”çš„åˆ†çµ„æ˜¯é€éè·èƒ½ï¼Œå¦‚ RD çµ„æˆä¸€å€‹ RD éƒ¨é–€è² è²¬ã€IT éƒ¨é–€è² è²¬éƒ¨ç½²èˆ‡ç¶­é‹ã€æ¥­å‹™éƒ¨é–€è² è²¬ç”¢å“ç«¯çš„å…¶é¤˜äº‹é …ï¼Œæ‰€ä»¥æ¥­å‹™ç«¯ç™¼èµ·éœ€æ±‚å¾Œï¼Œéœ€è¦å…ˆèˆ‡ RD éƒ¨é–€æºé€šã€RD éƒ¨é–€é–‹ç™¼å¾Œè«‹ IT éƒ¨é–€éƒ¨ç½²ï¼Œå±¤å±¤çš„è·¨éƒ¨é–€æºé€šè®“æ–°åŠŸèƒ½ä¸Šç·šå¾ˆæ…¢ï¼Œæ­¤æ™‚çµ„ç¹”çš„é‡é»æ˜¯ä»¥è·èƒ½å…§èšè€Œåˆ†æ¥­å‹™å…§èšï¼Œå»¶ä¼¸åˆ†äº«ä¹‹å‰æ•´ç†çš„ç­†è¨˜ &lt;a class="link" href="https://yuanchieh.page/posts/2021/2021-06-15-youtube-%E7%9B%B4%E6%92%ADfred%E8%81%8A%E8%81%8Asolid%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E6%95%B4%E7%90%86/" target="_blank" rel="noopener"
>FredèŠèŠSOLIDè¨­è¨ˆåŸå‰‡&lt;/a>ï¼ŒSOLID åŸå‰‡ä¸­çš„ Single Responsibility å¯ä»¥å¾æ¥­å‹™è§’åº¦å»æ€è€ƒ&lt;/p>
&lt;p>å› æ‡‰è»Ÿé«”éœ€è¦æ›´é«˜é »æ¬¡çš„åŠŸèƒ½éƒ¨ç½²ï¼Œé–‹å§‹ä»¥æ¥­å‹™é ˜åŸŸä¾†åšçµ„ç¹”çš„æ¶æ§‹ï¼Œä¾‹å¦‚ Amazon çš„ two pizza team è¿½æ±‚&lt;code>you build it, you run it&lt;/code>çš„ç²¾ç¥ï¼Œè®“æ¯å€‹åœ˜éšŠå¾éœ€æ±‚è¨­è¨ˆåˆ°ä¸Šç·šåæ‡‰é€Ÿåº¦æ›´å¿«&lt;/p>
&lt;h3 id="2-ç¨ç«‹éƒ¨ç½²">2. ç¨ç«‹éƒ¨ç½²&lt;/h3>
&lt;p>çµ„ç¹”ä¾ç…§æ¥­å‹™é ˜åŸŸåˆ‡é–‹å¾Œï¼Œæœƒéœ€è¦å¯ä»¥éš¨æ™‚æŒ‰ç…§åœ˜éšŠçš„ç¯€å¥éƒ¨ç½²æœå‹™ï¼Œä¸¦ç¢ºä¿å…¶é¤˜æœå‹™ä¸å—å½±éŸ¿ï¼Œé€™ä¹Ÿå°±æ˜¯&lt;code>ç¨ç«‹éƒ¨ç½²&lt;/code>çš„é‡è¦æ€§&lt;/p>
&lt;p>åœ¨è¨­è¨ˆæœå‹™ï¼Œè¦ç¢ºä¿æœå‹™çš„ä½è€¦åˆï¼Œå¦å‰‡æœƒé™·å…¥æ›´æ–°ä¸€å€‹æœå‹™è¦é€£å¸¶æ›´æ–°å…¶é¤˜å¤šå€‹æœå‹™ï¼Œè®Šæˆ&lt;code>å¯æ€•çš„åˆ†æ•£å¼å–®é«”å¼æ¶æ§‹&lt;/code>ï¼Œé€™å°±å»¶ä¼¸åˆ°é–‹é ­åˆ†äº«çš„ FB æ–‡ç«  - åœ˜éšŠæ˜¯å¦æœ‰è‰¯å¥½çš„ CICDã€æ˜¯å¦æœ‰è‰¯å¥½çš„ Log æ¶æ§‹èˆ‡ Tracing ç³»çµ±&lt;/p>
&lt;h3 id="3-è‡ªèº«æ“æœ‰çš„è³‡æ–™">3. è‡ªèº«æ“æœ‰çš„è³‡æ–™&lt;/h3>
&lt;p>&lt;code>å¾®æœå‹™ä¸æ‡‰è©²å…±äº«è³‡æ–™åº«&lt;/code>ï¼Œå¦‚æœå…¶é¤˜æœå‹™éœ€è¦è³‡æ–™ï¼Œæ‡‰è©²è¦é€éæœå‹™ä»‹é¢è€Œéç›´æ¥å­˜å–è³‡æ–™ï¼Œé¿å…ç¨‹å¼ç¢¼æ‹†åˆ†æœ€å¾Œå»åœ¨è³‡æ–™åº«è€¦åˆï¼Œæ¶ˆæŠ¹äº†ç¨ç«‹éƒ¨ç½²çš„åŠŸç”¨&lt;/p>
&lt;h3 id="å¾®æœå‹™å¥½è™•">å¾®æœå‹™å¥½è™•&lt;/h3>
&lt;p>ä¸»è¦é«”ç¾åœ¨éˆæ´»æ€§&lt;/p>
&lt;ol>
&lt;li>éƒ¨ç½²ç¨ç«‹æ€§ï¼šæ”¹å–„ç³»çµ±è¦æ¨¡èˆ‡å¼·å¥æ€§ (Robust)ã€å¯æ··ç”¨ä¸åŒæŠ€è¡“&lt;/li>
&lt;li>æ›´å¥½åˆ†å·¥ï¼šä¸åŒåœ˜éšŠå°ˆæ³¨ä¸åŒçš„ code base&lt;/li>
&lt;/ol>
&lt;h3 id="å–®é«”å¼æ¶æ§‹">å–®é«”å¼æ¶æ§‹&lt;/h3>
&lt;h4 id="1-å–®ä¸€ç¨‹åº">1. å–®ä¸€ç¨‹åº&lt;/h4>
&lt;p>å°‡æ‰€æœ‰ç¨‹å¼ç¢¼æ”¾å…¥å–®ä¸€ç¨‹åºéƒ¨ç½²çš„ç³»çµ±ä¸­&lt;/p>
&lt;h4 id="2-æ¨¡çµ„åŒ–å–®é«”å¼">2. æ¨¡çµ„åŒ–å–®é«”å¼&lt;/h4>
&lt;p>å°‡å–®ä¸€ç¨‹åºæ¨¡çµ„åŒ–ï¼Œè®“æ¯å€‹æ¨¡çµ„éƒ½èƒ½ç¨ç«‹é‹ä½œï¼Œåªæ˜¯éƒ¨ç½²æœƒçµ±ä¸€éƒ¨ç½²ï¼Œç”šè‡³å¯ä»¥è®“ä¸åŒæ¨¡çµ„ä½¿ç”¨ä¸åŒçš„è³‡æ–™åº«ï¼›éå¸¸æ¨è–¦ Shopify çš„åˆ†äº« &lt;a class="link" href="https://shopify.engineering/shopify-monolith" target="_blank" rel="noopener"
>Under Deconstruction: The State of Shopifyâ€™s Monolith&lt;/a>ï¼Œé è¨ˆä¹‹å¾Œå†å±•é–‹è¨è«–&lt;/p>
&lt;h3 id="è€¦åˆèˆ‡å…§èš">è€¦åˆèˆ‡å…§èš&lt;/h3>
&lt;p>å…§èšæ˜¯æŒ‡ã€Œç¨‹å¼ç¢¼åŒè®Šå‹•ã€å…±ç•™å­˜ã€ï¼Œç•¶ä»Šå¤©æ”¹ A åŠŸèƒ½æ™‚ï¼Œåƒ…éœ€è¦ç¢ºä¿ A åŠŸèƒ½ç›¸é—œçš„æœå‹™æ”¹å‹•ï¼Œé™ä½è®Šå‹•æˆæœ¬&lt;/p>
&lt;p>è€¦åˆæ˜¯æŒ‡ã€Œè³‡è¨Šéš±è—ã€ï¼ŒæŠŠç›¸å°ç¶“å¸¸æ€§è®Šå‹•çš„éƒ¨åˆ†èˆ‡éœæ…‹çš„éƒ¨åˆ†åˆ†é–‹ï¼Œæœ‰å€‹ç©©å®šçš„æ¨¡çµ„é‚Šç•Œï¼Œåˆå¯ç´°åˆ†æˆå¯¦ä½œè€¦åˆã€æ™‚é–“è€¦åˆã€éƒ¨ç½²è€¦åˆã€é ˜åŸŸè€¦åˆ&lt;/p>
&lt;h3 id="å°çµ">å°çµ&lt;/h3>
&lt;p>ç¬¬ä¸€ç« å®šç¾©äº†å¾®æœå‹™ã€å–®é«”å¼æ¶æ§‹ï¼Œä¸¦åˆ†æèƒŒå¾Œè¨­è¨ˆåŸç†èˆ‡æœ€çµ‚åæ‡‰çš„æ¶æ§‹å„ªåŠ£ï¼Œä½†éœ€è¦å°å¿ƒ &lt;code>å–®é«”å¼ä¸ç­‰åŒæ–¼å‚³çµ±&lt;/code>ï¼Œä¸è¦æ±¡ååŒ–å–®é«”å¼ï¼Œæ‡‰è©²è¦ç”¨æ›´å®¢è§€çš„è§’åº¦æ¬Šè¡¡æ¶æ§‹é¸æ“‡&lt;/p>
&lt;p>æœ€å¾Œä½œè€…æ¨è–¦ DDD å”åŠ©æ¥­å‹™é ˜åŸŸçš„å®šç¾©èˆ‡æ‹†åˆ†&lt;/p>
&lt;h2 id="ç¬¬äºŒç« é·ç§»è¨ˆç•«">ç¬¬äºŒç« ï¼šé·ç§»è¨ˆç•«&lt;/h2>
&lt;p>å¾®æœå‹™æ˜¯å€‹æŠ€è¡“é¸æ“‡è€Œéç›®çš„ï¼Œå†å°å…¥å‰æ‡‰è©²å…ˆè¬¹æ…æ€è€ƒ&lt;/p>
&lt;ol>
&lt;li>æƒ³è¦è§£æ±ºçš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿæƒ³è¦è§£æ±ºçš„å•é¡Œè·Ÿå…¬å¸åˆ©ç›Šæ˜¯å¦ä¸€è‡´ï¼Ÿç”¨æˆ¶æ˜¯å¦æœƒå› æ­¤å—ç›Šï¼Ÿ&lt;/li>
&lt;li>æ˜¯å¦æ¯”è¼ƒéæ›¿ä»£æ–¹æ¡ˆï¼Ÿæ˜¯ä¸æ˜¯å…¶ä»–ã€Œç„¡èŠçš„æŠ€è¡“ã€å°±èƒ½è§£æ±ºå•é¡Œï¼Ÿ&lt;/li>
&lt;li>å¦‚ä½•è¡¡é‡å°å…¥å¾®æœå‹™çš„æˆæ•ˆï¼Ÿæ€éº¼å†å°å…¥éç¨‹çŸ¥é“æ–¹å‘æ˜¯å¦æ­£ç¢ºï¼Ÿ&lt;/li>
&lt;/ol>
&lt;h3 id="ç‚ºä»€éº¼é¸æ“‡å¾®æœå‹™">ç‚ºä»€éº¼é¸æ“‡å¾®æœå‹™&lt;/h3>
&lt;p>å¦‚æœæ˜¯å› ç‚ºä¸‹åˆ—åŸå› è€Œæƒ³è¦å°å…¥å¾®æœå‹™ï¼Œå¯ä»¥å…ˆæ€è€ƒçœ‹çœ‹æ›¿ä»£æ–¹æ¡ˆæ˜¯å¦å¯è¡Œ&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å°å…¥ç›®çš„&lt;/th>
&lt;th>å¾®æœå‹™çš„æ½›åœ¨å„ªé»&lt;/th>
&lt;th>æ›¿ä»£æ–¹æ¡ˆ&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>å¢åŠ åœ˜éšŠè‡ªä¸»æ€§&lt;/td>
&lt;td>æ‹†åˆ†å¾®æœå‹™è®“åœ˜éšŠçš„è¦æ¨¡å°ã€æ“æœ‰ç›¸å°æ¬ŠåŠ›ï¼Œå¯ä»¥æ›´æœ‰æ•ˆçš„å·¥ä½œ&lt;/td>
&lt;td>åˆ†é…è²¬ä»»æœ‰å¾ˆå¤šæ–¹å¼ï¼Œä¸¦ä¸ä¸€å®šè¦æ”¹æ¶æ§‹ï¼Œå¯ä»¥å°‡ç¨‹å¼ç¢¼æ‰€æœ‰æ¬Šåˆ†å±¬ä¸åŒçš„åœ˜éšŠï¼Œåƒæ˜¯æ¡å–æ¨¡çµ„åŒ–å–®é«”å¼çµæ§‹ï¼Œä¾‹å¦‚ shopify&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç¸®çŸ­ä¸Šå¸‚æ™‚é–“&lt;/td>
&lt;td>å–®ç¨é‡å°å¾®æœå‹™é€²è¡Œè®Šæ›´èˆ‡éƒ¨ç½²&lt;/td>
&lt;td>åœ¨æ€è€ƒç”Ÿç”¢åŠ›å•é¡Œæ™‚ï¼Œæ‡‰è©²è¦å…ˆæª¢è¦–é–‹ç™¼æµç¨‹çš„è²§é ¸åœ¨ä½•è™•ï¼Œä½œè€…æåˆ°ä»–çš„é¡§å•ç”Ÿæ¶¯ä¸­ç™¼ç¾æ˜¯éœ€æ±‚å‚³ééç¨‹è€—è²»æœ€å¤šæ™‚é–“è€Œéé–‹ç™¼ï¼Œæ‰€ä»¥æ‡‰è©²å…ˆå¯©è¦–èˆ‡é‡æ¸¬è»Ÿé«”é–‹ç™¼çš„æ¯å€‹æ­¥é©Ÿ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æœ‰æ•ˆæ“´å±•è² è¼‰&lt;/td>
&lt;td>å–®å€‹å¾®æœå‹™å¯ä»¥ç¨ç«‹æ“´å±•ï¼Œæ›´å‹•æ…‹çš„èª¿æ•´å€‹åˆ¥æœå‹™çš„è¦æ¨¡&lt;/td>
&lt;td>å–®é«”å¼çš„æ°´å¹³æ“´å±•ä¾ç„¶æ˜¯å¾ˆæœ‰æ•ˆçš„æ“´å±•æ–¹å¼ï¼Œå¦‚æœç•¶ä¸‹é‡åˆ°æ•ˆèƒ½è²§é ¸ï¼Œç›´æ¥æ“´å±•è€Œéå°å…¥å¾®æœå‹™å¯èƒ½æ˜¯ç›¸å°å¿«é€Ÿåˆæœ‰æ•ˆçš„é¸æ“‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¢é€²å¼·å¥æ€§&lt;/td>
&lt;td>æ‹†åˆ†å¾®æœå‹™å¾Œï¼Œå¯å€‹åˆ¥ä¾æ“šæ¥­å‹™éœ€æ±‚è€Œå€åˆ†å‡ºæ ¸å¿ƒèˆ‡éæ ¸å¿ƒçš„å¾®æœå‹™ï¼Œé€²è€Œæä¾›ä¸åŒçš„å¼·å¥æ€§èª¿æ•´&lt;/td>
&lt;td>é€é Load Balancerã€Event Queue æ­é…å–®é«”å¼ç³»çµ±çš„æ°´å¹³æ“´å±•ï¼Œä¸€æ¨£å¯ä»¥å¢é€²å¼·å¥æ€§ï¼ŒæŠŠè³‡æºæŠ•æ³¨åœ¨è¨ºæ–·ç³»çµ±åŸå› å¯èƒ½æœƒæ›´æœ‰å¹«åŠ©&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ“´å±•é–‹ç™¼äººå“¡&lt;/td>
&lt;td>åœ¨ã€Šäººæœˆç¥è©±ã€‹ä¸­åªæœ‰æŠŠé …ç›®æ‹†åˆ†æˆå¯ç¨ç«‹ä½œæ¥­çš„é …ç›®ï¼Œå¢åŠ äººåŠ›æ‰æœ‰è¾¦æ³•åŠ é€Ÿé–‹ç™¼å¦å‰‡å¤šé¤˜çš„äººåŠ›æ˜¯æ²’æœ‰æ¬è‘—çš„ï¼Œå¾®æœå‹™é€éè‰¯å¥½çš„ä»‹é¢éš”é›¢å¯¦ä½œï¼Œè®“åœ˜éšŠè¦åŠ äººç›¸å°å®¹æ˜“&lt;/td>
&lt;td>é‡é»æ“ºåœ¨&lt;code>åœ˜éšŠèˆ‡æœå‹™çš„æ‰€æœ‰æ¬Šè¦ä¿æŒä¸€è‡´&lt;/code>ï¼Œå¯ä»¥é€éæ¨¡çµ„åŒ–å–®é«”å¼åˆ†å·¥åˆä½œ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ“æŠ±æ–°æŠ€è¡“&lt;/td>
&lt;td>å¾®æœå‹™å› ç‚ºæ˜¯ç¨ç«‹éƒ¨ç½²ï¼Œä¸åŒæœå‹™é–“å¯ä»¥æ¡å–å®Œå…¨ä¸åŒçš„æŠ€è¡“æ¶æ§‹&lt;/td>
&lt;td>é€™æ˜¯å¾®æœå‹™å¾ˆæ˜é¡¯çš„å„ªå‹¢ï¼Œæ›¿ä»£æ–¹æ¡ˆå¯ä»¥è€ƒæ…®å‘ JVM æ”¯æ´ Java, Scala, Kotlin ç­‰åŒå®¶æ—èªè¨€ï¼Œæˆ–æ˜¯åƒ Graal VM åŒä¸€å€‹ Runtime æ”¯æ´å¤šç¨®èªè¨€&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="å¾®æœå‹™ä½•æ™‚æ˜¯ä¸å¥½çš„ä¸»æ„">å¾®æœå‹™ä½•æ™‚æ˜¯ä¸å¥½çš„ä¸»æ„&lt;/h3>
&lt;ol>
&lt;li>æ¨¡ç³Šé ˜åŸŸï¼šéŒ¯èª¤å®šç¾©æœå‹™é‚Šç•Œæœƒå¾ˆå¯æ€•ï¼Œå› ç‚ºæœƒé€ æˆè·¨æœå‹™çš„é€£é–æ”¹å‹•&lt;/li>
&lt;li>æ–°å‰µå…¬å¸ï¼šå¯èƒ½æœ‰é»çˆ­è­°ï¼Œä½†é€™å‘¼æ‡‰åˆ°ä¸Šä¸€é»ï¼Œå¦‚æœå…¬å¸çš„å•†æ¥­æ¨¡å¼é‚„æ²’æœ‰ç©©å®šï¼Œé‚£è‡ªç„¶å°±ç„¡æ³•åˆ‡å‡ºæ­£ç¢ºçš„æœå‹™é‚Šç•Œ&lt;/li>
&lt;li>å®¢æˆ¶å®‰è£èˆ‡è»Ÿé«”ç®¡ç†ï¼šå¦‚æœæ˜¯è¦æŠŠè»Ÿé«”æ‰“åŒ…çµ¦åº«æˆ¶ï¼Œä½¿ç”¨å¾®æœå‹™å¯èƒ½æœƒä¸å¤ªå¥½ï¼Œè¦è€ƒé‡åˆ°å®¢æˆ¶çš„ç®¡ç†èƒ½åŠ›&lt;/li>
&lt;li>&lt;code>æ²’æœ‰å……åˆ†ç†ç”±æ™‚&lt;/code>&lt;/li>
&lt;/ol>
&lt;h3 id="çµ„ç¹”è®Šé©">çµ„ç¹”è®Šé©&lt;/h3>
&lt;p>ä½œè€…è¼ƒå“¨å¦‚ä½•åœ¨çµ„ç¹”å…§å°å…¥æ–°çš„æŠ€è¡“ï¼Œåˆ†äº« John Kother åšå£«çš„çµ„ç¹”è®Šé©æ­¥é©Ÿï¼Œå¤§è‡´ä¸Šæºé€šã€å°å¹…å˜—è©¦ã€çœ‹åˆ°åˆæ­¥æ•ˆç›Šã€èå…¥çµ„ç¹”
&lt;img src="https://yuanchieh.page/post/2021/img/1203/revolution.jpg"
loading="lazy"
>&lt;/p>
&lt;p>å†ç”¢ç”Ÿè®Šé©æ™‚ï¼Œè¦æ³¨æ„åˆ°è®Šé©æˆæœ¬ï¼ŒJeff Bezos å°‡è®Šé©åˆ†æˆå…©é¡ï¼šç¬¬ä¸€é¡æ˜¯å¿…ç„¶ã€ä¸å¯é€†çš„ï¼Œç¬¬äºŒé¡æ˜¯å¯é€†ã€å¯è®ŠåŒ–çš„ï¼Œç¬¬ä¸€é¡éœ€è¦é•·æœŸè¨è«–ã€è¬¹æ…çš„æ€è€ƒï¼Œç¬¬äºŒé¡å¯ä»¥è®“é«˜åˆ¤æ–·åŠ›çš„å€‹äººæˆ–çµ„ç¹”è¿…é€Ÿåšå‡ºï¼›
&lt;code>æ²’æœ‰ç¶“å¸¸ä¸‹æ±ºç­–çš„äººé€šå¸¸æœƒèª¤æŠŠç¬¬äºŒé¡ç•¶ä½œç¬¬ä¸€é¡ï¼Œè®“æ‰€æœ‰æ±ºç­–éƒ½åœæ»¯ä¸å‰&lt;/code>
&lt;img src="https://yuanchieh.page/post/2021/img/1203/decision.jpg"
loading="lazy"
>&lt;/p>
&lt;p>é€™ä¹Ÿå‘¼æ‡‰åˆ°ä¹‹å‰å·¥ä½œæ™‚å…¬å¸å°å…¥æ•æ·é–‹ç™¼ï¼Œå›ºç„¶çœ‹åˆ°å¿«é€Ÿè¿­ä»£ã€æŒçºŒé©—è­‰èˆ‡å¾®èª¿çš„å„ªå‹¢ï¼Œä½†å…§éƒ¨ä¹Ÿæ™‚å¸¸åœ¨çˆ­è«–å¦‚å°è¦æ¨¡å¯¦é©—æ˜¯å¦çœŸçš„æœ‰æ•ˆã€ç”¨æˆ¶æœƒä¸æœƒå› ç‚ºå¯¦é©—è€Œå¤§é‡æµå¤±ç­‰ç­‰ï¼Œç¾åœ¨åæ€èµ·ä¾†å°±æ˜¯æ²’æœ‰æŠŠç¬¬ä¸€é¡èˆ‡ç¬¬äºŒé¡æ±ºç­–æºé€šæ¸…æ¥šçš„ç·£æ•…&lt;/p>
&lt;h3 id="å¦‚ä½•é–‹å§‹">å¦‚ä½•é–‹å§‹&lt;/h3>
&lt;p>ä½œè€…æ¨å´‡é€é DDD å¹«åŠ©å®šç¾©æœå‹™é‚Šç•Œï¼Œä¸¦æ¡ç”¨ Event Storming è®“å¤§å®¶å°æ–¼æ¨¡å‹æœ‰å…±åŒçš„ç†è§£&lt;/p>
&lt;p>æ¥è‘—å¾€å…§æª¢è¦–åœ˜éšŠçš„çµ„æˆï¼Œåœ˜éšŠæˆå“¡æ˜¯å¦æœ‰è¶³å¤ çš„æŠ€èƒ½ï¼Ÿä¾‹å¦‚èªªå¾®æœå‹™è¦é€éäº‹ä»¶æºé€šå°å…¥ Kafkaï¼Œé‚£åœ˜éšŠæ˜¯å¦æœ‰ Kafka ç†Ÿæ‚‰çš„äººæ‰ï¼Ÿå¦‚æœæ²’æœ‰è¦èŠ±å¤šå°‘æ™‚é–“è·Ÿè³‡æºèª¿æ•´ï¼Ÿ&lt;/p>
&lt;h3 id="å¦‚ä½•ç¢ºå®šè½‰ç§»æ˜¯å¦æœ‰æ•ˆ">å¦‚ä½•ç¢ºå®šè½‰ç§»æ˜¯å¦æœ‰æ•ˆ&lt;/h3>
&lt;p>å¯ä»¥è¨­ç«‹å®šæœŸæª¢æŸ¥é»ï¼Œå†ä¸€å®šæ™‚é–“æª¢æŸ¥å®šæ€§èˆ‡å®šé‡æªæ–½ï¼Œå®šé‡æªæ–½åŒ…å«ç™¼å¸ƒé€±æœŸã€æ•…éšœç‡ã€éƒ¨ç½²æ¬¡æ•¸ã€æ€§èƒ½ç›£æ§ç­‰ï¼Œä½†è¦å°å¿ƒå®šé‡çš„æŒ‡æ¨™æœƒè®Šæˆé™·é˜±ï¼Œä¾‹å¦‚åœ˜éšŠè¿½æ±‚éƒ¨ç½²æ¬¡æ•¸è€Œç›²ç›®æ›´æ–° (å°±è·Ÿ RD è²¢ç»åº¦çœ‹ç¨‹å¼ç¢¼è¡Œæ•¸å£¹æ¨£çš„å¯ç¬‘)ï¼Œæ‰€ä»¥éœ€è¦æ­é…å®šæ€§æªæ–½ï¼Œè¨ªè«‡æˆå“¡å°æ–¼è½‰ç§»éç¨‹çš„æ„Ÿå—&lt;/p>
&lt;h2 id="ç¬¬ä¸‰ç« åˆ†å‰²å–®é«”å¼æ¶æ§‹">ç¬¬ä¸‰ç« ï¼šåˆ†å‰²å–®é«”å¼æ¶æ§‹&lt;/h2>
&lt;p>ç•¶é€šéä¸Šé¢å…©ç« çš„è¨è«–ï¼Œç¢ºå®šè¦å°å…¥å¾®æœå‹™æ™‚ï¼Œå›é¦–ç¾å¯¦è¦é¢å°çš„æ™‚é¾å¤§ã€æ¶æ§‹æ··äº‚çš„å–®é«”å¼æ¶æ§‹&lt;/p>
&lt;h4 id="1-é‡çµ„å–®é«”å¼ç³»çµ±">1. é‡çµ„å–®é«”å¼ç³»çµ±&lt;/h4>
&lt;p>å‚³çµ±ç¨‹å¼ç¢¼é€šå¸¸ä»¥æŠ€è¡“åˆ†é¡è€Œéæ¥­å‹™é ˜åŸŸåˆ†é¡ï¼Œä¾‹å¦‚ Model / Controller / View ç­‰è³‡æ–™å¤¾æ‹†åˆ†ï¼Œè¦é‡æ–°ä»¥æ¥­å‹™é ˜åŸŸæ‹†åˆ†ä¸¦æ‰¾å‡ºå°æ‡‰çš„ç¨‹å¼ç¢¼æœƒæ˜¯ä¸€é …å¤§å·¥ç¨‹ï¼Œæ­¤æ™‚å¯ä»¥åƒè€ƒå¸‚é¢ä¸Šé‡æ§‹èˆ‡ç®¡ç† legacy code çš„æ–¹æ³•&lt;/p>
&lt;h4 id="2-æ¨¡çµ„åŒ–å–®é«”å¼-1">2. æ¨¡çµ„åŒ–å–®é«”å¼&lt;/h4>
&lt;p>å¯ä»¥è€ƒæ…®å°‡åŠŸèƒ½å»ºç«‹ç¨ç«‹çš„æ¨¡çµ„ï¼Œä¾‹å¦‚ Java çš„ Jar æª”ã€Ruby çš„ Gem ç­‰ï¼Œæ‹†å‡ºç¨ç«‹çš„æ¨¡çµ„æœªä¾†è¦ç¨ç«‹éƒ¨ç½²æˆå¾®æœå‹™ä¹Ÿæœƒæ¯”è¼ƒå®¹æ˜“&lt;/p>
&lt;h4 id="3-æ¼¸é€²é‡å¯«">3. æ¼¸é€²é‡å¯«&lt;/h4>
&lt;p>è©¦è‘—å…ˆé‡æ§‹ç¾æœ‰çš„ç¨‹å¼ç¢¼ï¼Œæ¥è‘—åœ¨é‡æ–°å¯¦ç¾åŠŸèƒ½ï¼Œå¦‚æœåŸæœ¬ç¨‹å¼ç¢¼ä¸­çš„é‚è¼¯æ²’æœ‰å…ˆæ¢³ç†æ¸…æ¥šå°±è²¿ç„¶é‡å¯«ï¼ŒåªæœƒæŠŠéæ™‚ä¸”è¤‡é›œçš„é‚è¼¯é‡æ–°å¾©åˆ»ï¼Œä¸¦æ‹–ç´¯è½‰ç§»çš„é€Ÿåº¦&lt;/p>
&lt;h3 id="é·ç§»æ¨¡å¼">é·ç§»æ¨¡å¼&lt;/h3>
&lt;h4 id="æ¨¡å¼ä¸€çµæ®ºæ¦•-strangler-fig">æ¨¡å¼ä¸€ï¼šçµæ®ºæ¦• (Strangler Fig)&lt;/h4>
&lt;p>ç”± Martin Fowler åœ¨çœ‹åˆ°çµæ®ºæ¦•ç”Ÿé•·è¯æƒ³çš„ç³»çµ±é·ç§»æ¨¡å¼ &lt;a class="link" href="https://martinfowler.com/bliki/StranglerFigApplication.html" target="_blank" rel="noopener"
>StranglerFigApplication&lt;/a>ï¼Œä¸€é–‹å§‹ç¨®å­åœ¨æ¨¹ä¸Šç”Ÿé•·ï¼Œæ¥è‘—è½åœ°å¾ŒæŒçºŒæˆé•·ï¼Œæœ€å¾Œæ¯æ¨¹æœƒæ­»äº¡&lt;/p>
&lt;p>å¥—ç”¨é¡ä¼¼çš„é‚è¼¯åœ¨è»Ÿé«”ç³»çµ±ä¸Šï¼Œæœ€ç›´è¦ºçš„åšæ³•æ˜¯é‡å¯«ä¸€å€‹æ–°ç³»çµ±ç›´æ¥é·ç§»å°±å¥½ï¼Œä½†å¾€å¾€äº‹æƒ…æ›´è¤‡é›œï¼Œä¸€æ¬¡æ€§é‡å¯«æ–°ç³»çµ±éœ€è¦æ›´å¤šçš„æ™‚é–“ä¸¦å†’è‘—æ›´å¤§çš„é¢¨éšªï¼›&lt;br>
å­¸ç¿’çµæ®ºæ¦•ï¼Œè®“æ–°ç³»çµ±å¯ä»¥ç›¸å®¹æ–¼èˆŠç³»çµ±ï¼Œæ¥è‘—å†é€æ­¥æŠ½é›¢æ–°ç³»çµ±ï¼Œæœ€å¾Œå®Œæˆè½‰ç§»æ±°æ›èˆŠç³»çµ±ï¼Œè®“æ¯ä¸€å€‹æ­¥é©Ÿæ›´å°ä¸¦é™ä½é¢¨éšªï¼Œå¦‚æœä¸­é–“çŠ¯éŒ¯å¯ä»¥å¾ˆå¿«é€€è¿”ï¼Œæˆ–æ˜¯çµ‚æ­¢è½‰ç§»ä¹Ÿä¸æœƒæœ‰ä»»ä½•å•é¡Œ
&lt;img src="https://yuanchieh.page/post/2021/img/1203/%e7%b5%9e%e6%ae%ba%e6%a6%95.jpg"
loading="lazy"
>&lt;/p>
&lt;p>æ–¹æ³•é©ç”¨æ–¼ä¸Šå±¤çš„æœå‹™ï¼Œå¦‚æœæ˜¯ç³»çµ±å…§æ¯”è¼ƒåº•å±¤çš„æœå‹™æœƒæ¯”è¼ƒé›£å¥—ç”¨ (å¾ŒçºŒä»‹ç´¹)ï¼Œå¯¦ä½œä¸Šå¯ä»¥åœ¨å–®é«”å¼æ¶æ§‹å‰å¤šä¸€å€‹ä»£ç†å™¨å¦‚ HTTP Proxy æˆ–æ˜¯ Message Queueï¼Œé·ç§»æ­¥é©Ÿå¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>ç•¶æ–°ç³»çµ±å¯¦ä½œå°šæœªå®Œæˆæ™‚ï¼ŒåŸæœ¬çš„ Request æŒçºŒæµå‘èˆŠç³»çµ±&lt;/li>
&lt;li>æ–°ç³»çµ±å®Œæˆå¾Œå¯å…ˆéƒ¨ç½²ï¼Œä½†æ­¤æ™‚é‚„æœªå°å¤–é–‹æ”¾&lt;/li>
&lt;li>é€éé‡‘çµ²é›€éƒ¨ç½²ï¼Œå…ˆæ”¾æ‰‹éƒ¨åˆ†æµé‡åˆ°æ–°ç³»çµ±&lt;/li>
&lt;li>ç¢ºä¿æ²’å•é¡Œï¼Œæµé‡å®Œæ•´åˆ‡æ›è‡³æ–°ç³»çµ±ï¼Œæ±°æ›èˆŠç³»çµ±
&lt;img src="https://yuanchieh.page/post/2021/img/1203/pipe.png"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;p>åœ¨å°å…¥ä»£ç†å™¨æ™‚ï¼Œè¦æ³¨æ„ &lt;code>Smart Endpoints and Dumb Pipes&lt;/code>ï¼Œä¸è¦è®“ä»£ç†å™¨æ‰¿æ“”éå¤šçš„è·è²¬ï¼Œä¾‹å¦‚èªªå› ç‚ºèˆŠç³»çµ±æ”¯æ´ soap ä½†æ–°ç³»çµ±è¦æ”¯æ´ grpcï¼Œèˆ‡å…¶è®“ä»£ç†å™¨åˆ¤æ–· soap -&amp;gt; èˆŠç³»çµ± / grpc èµ°æ–°ç³»çµ±ï¼Œé‚„ä¸å¦‚ç›´æ¥å°å¤–å…¬é–‹å…©å€‹å”å®šï¼Œè€ŒèˆŠç³»çµ±å†æŠŠ soap æ ¼å¼è½‰æ›åˆ°æ–°ç³»çµ±çš„ grpc
&lt;img src="https://yuanchieh.page/post/2021/img/1203/proxy.png"
loading="lazy"
>
å»¶ä¼¸é–±è®€ &lt;a class="link" href="https://medium.com/@nathankpeck/microservice-principles-smart-endpoints-and-dumb-pipes-5691d410700f" target="_blank" rel="noopener"
>Microservice Principles: Smart Endpoints and Dumb Pipes&lt;/a>&lt;/p>
&lt;h4 id="æ¨¡å¼äºŒæŠ½è±¡åˆ†æ”¯">æ¨¡å¼äºŒï¼šæŠ½è±¡åˆ†æ”¯&lt;/h4>
&lt;p>ç•¶è¦æŠ½é›¢çš„çµ„ä»¶æ˜¯ç³»çµ±çš„åº•å±¤ï¼Œä¾‹å¦‚ä½¿ç”¨è€…é€šçŸ¥åŠŸèƒ½ï¼Œå¦‚æœè¦ç›´æ¥æ”¹å¯«æœƒå¿…é ˆæŠŠå¯¦ä½œç«¯èˆ‡å‘¼å«ç«¯ä¸€æ¬¡æ”¹å‹•ï¼Œæ­¤æ™‚æœ€å¥½æ˜¯&lt;/p>
&lt;ol>
&lt;li>ç‚ºè¦æ›¿æ›çš„åŠŸèƒ½å»ºç«‹æŠ½è±¡&lt;/li>
&lt;li>è®“èˆŠç³»çµ±çš„å…¶ä»–åŠŸèƒ½ä¾è³´ä»‹é¢è€Œéå¯¦ä½œ&lt;/li>
&lt;li>æä¾›å¾®æœå‹™çš„å¯¦ä½œ&lt;/li>
&lt;li>åˆ‡æ›æŠ½è±¡ä¸¦ä½¿ç”¨å¯¦ä½œ&lt;/li>
&lt;li>åˆªé™¤èˆŠå¯¦ä½œ
&lt;img src="https://yuanchieh.page/post/2021/img/1203/abs.png"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;p>åœ¨å®‰å¾·é­¯å¤§å”çš„éƒ¨è½æ ¼ä¸­æœ‰æåˆ°ç›¸åŒçš„æ¦‚å¿µ &lt;a class="link" href="https://columns.chicken-house.net/2016/10/03/microservice2/" target="_blank" rel="noopener"
>å¾®æœå‹™æ¶æ§‹ #2, æŒ‰ç…§æ¶æ§‹ï¼Œé‡æ§‹ç³»çµ±&lt;/a>ï¼Œèº«ä»½é©—è­‰çµ„ä»¶å¹¾ä¹æ˜¯æ‰€æœ‰åŠŸèƒ½éƒ½æœƒç›¸ä¾çš„çµ„ä»¶ï¼Œè¦å¾å–®é«”å¼æ¶æ§‹æŠ½å‡ºä¾†å‰ï¼Œè¨˜å¾—å…ˆæŠ½è±¡åŒ–ï¼Œç¢ºä¿åŠŸèƒ½å¼•ç”¨éƒ½ä¾è³´æŠ½è±¡åŒ–ï¼Œæœ€å¾Œæ‰æ›¿æ›å¾®æœå‹™å¯¦ä½œï¼Œé€™æ¨£æœ€å¾Œå¤±æ•—è¦åˆ‡æ›å›å»ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œé€™åˆå‘¼æ‡‰å› Martin Fowler åœ¨çµæ®ºæ¦•æ–‡ç« èªªçš„&lt;/p>
&lt;blockquote>
&lt;p>when designing a new application you should design it in such a way as to make it easier for it to be strangled in the future.&lt;/p>
&lt;/blockquote>
&lt;p>æœç„¶å¤§å¸«å€‘èªªçš„é“ç†éƒ½æ˜¯ç›¸é€šçš„&lt;/p>
&lt;h4 id="æ¨¡å¼ä¸‰å¹³è¡Œæ¨¡å¼">æ¨¡å¼ä¸‰ï¼šå¹³è¡Œæ¨¡å¼&lt;/h4>
&lt;p>å¦‚æœæ˜¯éå¸¸æ ¸å¿ƒã€é‡è¦çš„åŠŸèƒ½å¦‚é‡‘æµï¼Œåœ¨é‡å¯«æˆæ–°å¾®æœå‹™æ™‚ï¼Œå¯ä»¥æ¡ç”¨å¹³è¡Œæ¨¡å¼é›™é‚Šå¯«å…¥ï¼Œæ¯æ—¥é€²è¡Œæ¯”å°ç›´åˆ°æ²’æœ‰å‡ºéŒ¯æ™‚åœ¨åˆ‡æ›ï¼Œé™ä½å¾®æœå‹™ä¸Šç·šçš„é¢¨éšª&lt;br>
github æœ‰é–‹æºä¸€å€‹ Ruby gem &lt;a class="link" href="https://github.com/github/scientist" target="_blank" rel="noopener"
>scientist&lt;/a>ï¼Œå°ˆé–€åšå¹³è¡ŒåŒ–å¯¦é©—çš„æ¯”è¼ƒ
&lt;img src="https://yuanchieh.page/post/2021/img/1203/parallel.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="è£é£¾è€…æ¨¡å¼">è£é£¾è€…æ¨¡å¼&lt;/h4>
&lt;p>å¦‚æœç•¶å‰ç³»çµ±ç„¡æ³•è¢«ä¿®æ”¹ï¼Œå»éœ€è¦æ””æˆªå‘¼å«ä¸¦é¡å¤–å¢åŠ è¡Œç‚ºï¼Œå¯ä»¥è€ƒæ…®ç”¨è£é£¾è€…æ¨¡å¼ï¼Œé€éä»£ç†æœå‹™å™¨åœ¨å‘¼å«å®ŒåŸç³»çµ±å¾Œï¼Œé¡å¤–å‘¼å«å¾®æœå‹™ï¼›ä½†è¦å°å¿ƒé•å dump pipe çš„é¢¨éšª&lt;br>
&lt;img src="https://yuanchieh.page/post/2021/img/1203/decoration.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="æ¨¡å¼å››è®Šæ›´è³‡æ–™æ“·å–">æ¨¡å¼å››ï¼šè®Šæ›´è³‡æ–™æ“·å–&lt;/h4>
&lt;p>åŒæ¨£æ˜¯ä¸ä¿®æ”¹ç•¶å‰ç³»çµ±ï¼Œä¹Ÿä¸æƒ³ç”¨è£é£¾è€…æ¨¡å¼ï¼Œä½†åŒæ¨£å¸Œæœ›åœ¨è¡Œç‚ºè®Šå‹•æ™‚è§¸ç™¼å¾®æœå‹™ï¼Œå¦‚æœƒå“¡è¨»å†Šå¾Œï¼Œè¦æ‰“å°æœƒå“¡å¡ï¼Œå¯ä»¥é€éè³‡æ–™å„²å­˜çš„æ–¹å¼ï¼Œä¾‹å¦‚è³‡æ–™åº«çš„ triggerã€å®šæœŸ polling è³‡æ–™åº«ï¼›ä½†è¦å°å¿ƒè€¦åˆåœ¨è³‡æ–™åº«
&lt;img src="https://yuanchieh.page/post/2021/img/1203/data.jpg"
loading="lazy"
>&lt;/p>
&lt;h4 id="æ¨¡å¼äº”ä½¿ç”¨è€…ä»‹é¢çµ„æˆ">æ¨¡å¼äº”ï¼šä½¿ç”¨è€…ä»‹é¢çµ„æˆ&lt;/h4>
&lt;p>UI ç«¯ä¹Ÿå¯ä»¥æŠŠé é¢æ‹†è§£æˆä¸åŒçš„çµ„ä»¶ï¼Œä¾‹å¦‚ &lt;a class="link" href="https://micro-frontends.org/" target="_blank" rel="noopener"
>Micro Frontend&lt;/a>ï¼Œå› æ‡‰ Web æ¨™æº–çš„ç™¼å±•æ”¯æ´ custom elementï¼Œè®“ä¸åŒçš„åœ˜éšŠå¯ä»¥æ¡ç”¨ä¸åŒçš„æŠ€è¡“å¯¦åšä¸åŒçš„çµ„ä»¶ï¼Œé€é DOM event è·¨çµ„ä»¶é€šä¿¡&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å‰ä¸‰å¼µè«‡äº†çµ„ç¹”èˆ‡ç¨‹å¼ç¢¼æ¶æ§‹ï¼Œè©•ä¼°å°å…¥å¾®æœå‹™çš„å„ªåŠ£ã€å¤§æ–¹å‘ä¸Šå°å…¥çš„æ–¹å¼ï¼Œå¾Œé¢å…©å¼µæœƒç¹¼çºŒè«‡æœ€é›£æ‹†åˆ†çš„è³‡æ–™åº«æ¬ç§»ä»¥åŠå°å…¥å¾Œéš¨è‘—çµ„ç¹”æˆé•·æœƒé‡åˆ°çš„å›°å¢ƒ&lt;/p></description></item><item><title>Python - ç›´æ¥åŸ·è¡Œ package ä¸‹çš„ module çš„éŒ¯èª¤</title><link>https://yuanchieh.page/posts/2021/2021-11-22-python-%E7%9B%B4%E6%8E%A5%E5%9F%B7%E8%A1%8C-package-%E4%B8%8B%E7%9A%84-module-%E7%9A%84%E9%8C%AF%E8%AA%A4/</link><pubDate>Mon, 22 Nov 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-11-22-python-%E7%9B%B4%E6%8E%A5%E5%9F%B7%E8%A1%8C-package-%E4%B8%8B%E7%9A%84-module-%E7%9A%84%E9%8C%AF%E8%AA%A4/</guid><description>&lt;p>æœ€è¿‘å› ç‚ºè³‡æ–™åˆ†æé–‹å§‹å¤§é‡ä½¿ç”¨ Pythonï¼Œèˆ‡åŒäº‹å”ä½œåœ¨åŒä¸€å€‹ Package ä¸‹æ‹†åˆ†ä¸åŒ Module å¯¦ä½œï¼Œç•¶æˆ‘æƒ³ç›´æ¥åŸ·è¡Œ Module é‡ä¸Šäº† ã€ŒModuleNotFoundError: No module namedã€çš„éŒ¯èª¤ï¼Œè®“æˆ‘é–‹å§‹æƒ³ç­è§£ Python çš„ Package ç³»çµ±é‹ä½œçš„åŸç†&lt;/p>
&lt;h2 id="python-package-è¼‰å…¥æ–¹å¼">Python Package è¼‰å…¥æ–¹å¼&lt;/h2>
&lt;p>&lt;a class="link" href="https://docs.python.org/zh-tw/3/tutorial/modules.html" target="_blank" rel="noopener"
>å®˜æ–¹æ–‡ä»¶ï¼š6. æ¨¡çµ„ (Module)&lt;/a> å¯«å¾—å¾ˆè©³ç›¡ï¼Œæ¨¡çµ„çš„è¼‰å…¥é †åºæ˜¯æ ¹æ“š &lt;code>sys.path&lt;/code>ï¼Œè€Œ sys.path ä¾åºç”±ä»¥ä¸‹çµ„æˆ&lt;/p>
&lt;ol>
&lt;li>ç•¶å‰è·¯å¾‘&lt;/li>
&lt;li>ç’°å¢ƒè®Šæ•¸ PYTHONPATH&lt;/li>
&lt;li>site-package&lt;/li>
&lt;/ol>
&lt;p>å…¶ä¸­ site-package æ˜¯ä½¿ç”¨æ‰‹å‹•å»ºç½® package æ‰€åœ¨ä½ç½® (&lt;code>pip install, python setup.py install&lt;/code>)ï¼Œå¯èƒ½æœƒæœ‰éå¸¸å¤šçµ„ï¼Œæ¯ä¸€ä½ user / venv ä¸‹åˆæœ‰å°æ‡‰çš„ site-packageï¼Œåƒè€ƒ &lt;a class="link" href="https://stackoverflow.com/questions/122327/how-do-i-find-the-location-of-my-python-site-packages-directory?rq=1" target="_blank" rel="noopener"
>How do I find the location of my Python site-packages directory?&lt;/a>å¯ä»¥æ‰¾å‡ºå°æ‡‰çš„è·¯å¾‘&lt;/p>
&lt;ol>
&lt;li>Global: &lt;code>$ python -m site&lt;/code>&lt;/li>
&lt;li>User: &lt;code>$ python -m site --user-site&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥ sys.path æ±ºå®šäº† package è¼‰å…¥çš„é †åºï¼Œä¾‹å¦‚ç•¶å‰è·¯å¾‘ä¸‹ package åç¨±èˆ‡æ ¸å¿ƒæ¨¡çµ„é‡è¤‡ï¼Œé‚£æœƒä»¥ç•¶å‰è·¯å¾‘å„ªå…ˆè¼‰å…¥ï¼›&lt;br>
æ‰€ä»¥èƒ½é€éå‹•æ…‹æ”¹è®Š sys.path æ±ºå®šè¼‰å…¥é †åº&lt;/p>
&lt;h2 id="ç‚ºä»€éº¼ç›´æ¥åŸ·è¡Œ-package-ä¸‹çš„-module-æœƒå¤±æ•—">ç‚ºä»€éº¼ç›´æ¥åŸ·è¡Œ Package ä¸‹çš„ Module æœƒå¤±æ•—&lt;/h2>
&lt;p>åœ¨ Python ä¸­ï¼Œimport å¯ä»¥é¸æ“‡å®Œæ•´çš„ Module è·¯å¾‘æˆ–æ˜¯ç›¸å°è·¯å¾‘ï¼Œè€Œè·¯å¾‘æœƒå—åˆ°åŸ·è¡Œæª”æ¡ˆçš„ sys.path èˆ‡ __package__ çš„å½±éŸ¿ï¼Œç›¸é—œçš„ magic method ç‚º&lt;/p>
&lt;ol>
&lt;li>&lt;code>__name__&lt;/code>ï¼šModule çš„å®Œæ•´åç¨±&lt;/li>
&lt;li>&lt;code>__package__&lt;/code>ï¼šæ±ºå®šç›¸å°è·¯å¾‘ import çš„è§£æè·¯å¾‘ï¼Œå¦‚æœæª”æ¡ˆæ˜¯ Packageï¼Œå‰‡ __package__ æœƒç­‰æ–¼ __name__ï¼›&lt;br>
å¦‚æœæ˜¯ Module å‰‡ __package__ æ˜¯æ‰€å±¬çš„ Package åç¨±ï¼›&lt;br>
å¦‚æœ Module æ˜¯ &lt;code>top-level modules&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ &lt;code>__name__ == __main__&lt;/code>ï¼Œå‰‡ __package__ ç‚º None&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹åƒè€ƒè‡ª &lt;a class="link" href="https://stackoverflow.com/questions/16981921/relative-imports-in-python-3" target="_blank" rel="noopener"
>Relative imports in Python 3&lt;/a>ï¼Œå‡è¨­ç›®å‰çš„å°ˆæ¡ˆç›®éŒ„æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">main.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mypackage/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __init__.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mymodule.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> myothermodule.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ myothermodule.py ä¸­ï¼Œè¼‰å…¥ mymoduleï¼Œå¯ä»¥é€éå®Œæ•´è·¯å¾‘ &lt;code>import mypackage.mymodule&lt;/code> æˆ–æ˜¯ç›¸å°è·¯å¾‘ &lt;code>import .mymodule&lt;/code> çš„æ–¹å¼ï¼Œä½†å¦‚æœç›´æ¥åŸ·è¡Œ $python myothermodule æœƒåˆ†åˆ¥é‡åˆ°ä»¥ä¸‹éŒ¯èª¤&lt;/p>
&lt;ol>
&lt;li>å®Œæ•´è·¯å¾‘&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ModuleNotFoundError: No module named &lt;span class="s1">&amp;#39;mypackage&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>ç›¸å°è·¯å¾‘&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ImportError: attempted relative import with no known parent package
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®Œæ•´è·¯å¾‘çš„éŒ¯èª¤åŸå› æ˜¯å› ç‚º sys.path ä¸­æ²’æœ‰ mypackageï¼Œsys.path æ˜¯åŠ å…¥&lt;code>script ç•¶å‰çš„è³‡æ–™å¤¾ (./mypackage)&lt;/code>è€Œä¸æ˜¯ ./ï¼Œæ‰€ä»¥ mypackage æ˜¯ç„¡æ³•è¢«è¼‰å…¥çš„ï¼›&lt;br>
ç›¸å°è·¯å¾‘çš„éŒ¯èª¤å‰‡æ˜¯å› ç‚ºç•¶å‰ myothermodule.py æ˜¯ top-level moduleï¼Œ __package__ è¢«è¨­å®šç‚º Noneï¼Œæ‰€ä»¥ç›¸å°è·¯å¾‘è§£ææœƒå¤±æ•—&lt;/p>
&lt;h2 id="å¦‚ä½•è§£æ±º">å¦‚ä½•è§£æ±º&lt;/h2>
&lt;p>åˆ†åˆ¥é‡å°å®Œæ•´è·¯å¾‘èˆ‡ç›¸å°è·¯å¾‘æå‡ºè§£æ±ºæ–¹æ¡ˆ&lt;/p>
&lt;h3 id="1-å®Œæ•´è·¯å¾‘">1. å®Œæ•´è·¯å¾‘&lt;/h3>
&lt;p>æ—¢ç„¶å®Œæ•´è·¯å¾‘æ˜¯å› ç‚º sys.path æ²’æœ‰åŒ…å«åˆ° package çš„ä¸Šå±¤è·¯å¾‘è€Œæ²’æœ‰è¢«è¼‰å…¥ï¼Œé‚£å°±åŠ ä¸Šå»å³å¯&lt;/p>
&lt;p>Python é¼“å‹µä½†ä¸å¼·åˆ¶ import éƒ½è¦æ”¾åœ¨æª”æ¡ˆé–‹é ­&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pathlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Path&lt;/span> &lt;span class="c1"># if you haven&amp;#39;t already done so&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="vm">__file__&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">resolve&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parents&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Additionally remove the current file&amp;#39;s directory from sys.path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">except&lt;/span> &lt;span class="ne">ValueError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># Already removed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">mypackage.mymodule&lt;/span> &lt;span class="c1"># æˆåŠŸ Import&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="ç›´æ¥å®‰è£-package">ç›´æ¥å®‰è£ package&lt;/h4>
&lt;p>å¦ä¸€å€‹ä½œæ³•æ˜¯é€é setuptools ç›´æ¥å®‰è£ç›¸ä¾çš„å¥—ä»¶ï¼Œé€™æ¨£å°±èƒ½å¾ site-package importï¼Œä½†é€™æ”¹å‹•ç›¸å°éº»ç…©äº›ï¼Œä¸”è®Šæˆå¥—ä»¶è¦é¡å¤–ç®¡ç†åè€Œéº»ç…©&lt;/p>
&lt;h3 id="2-ç›¸å°è·¯å¾‘">2. ç›¸å°è·¯å¾‘&lt;/h3>
&lt;h4 id="ä½¿ç”¨--m-åŸ·è¡Œ">ä½¿ç”¨ -m åŸ·è¡Œ&lt;/h4>
&lt;p>ç›´æ¥æŒ‡å®šå®Œæ•´çš„ package.module è·¯å¾‘ &lt;code>$ python -m mypackage.myothermodule&lt;/code>ï¼Œæ­¤æ™‚ __package__ æœƒè¢«æ­£ç¢ºè§£ææˆ mypackageï¼Œåƒè€ƒ &lt;a class="link" href="https://www.python.org/dev/peps/pep-0366/" target="_blank" rel="noopener"
>PEP366&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>By adding a new module level attribute, this PEP allows relative imports to work automatically if the module is executed using the -m switch&lt;/p>
&lt;/blockquote>
&lt;h4 id="æ‰‹å‹•æŒ‡å®š">æ‰‹å‹•æŒ‡å®š&lt;/h4>
&lt;p>æ‰‹å‹•å¯¦ä½œ PEP366 çš„ææ¡ˆï¼Œåƒè€ƒ&lt;a class="link" href="https://gist.github.com/vaultah/d63cb4c86be2774377aa674b009f759a" target="_blank" rel="noopener"
>PEP366_boilerplate.py&lt;/a>ï¼ŒåŠ å…¥å°æ‡‰çš„ sys.path ä¸¦æŒ‡å®š __package__ï¼Œé”åˆ°è·Ÿ -m ç›¸åŒçš„æ•ˆæœ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-py" data-lang="py">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nn">importlib&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pathlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">import_parents&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">level&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">global&lt;/span> &lt;span class="n">__package__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="vm">__file__&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">resolve&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">top&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parents&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">level&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">top&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">ValueError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># already removed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__package__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">top&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parts&lt;/span>&lt;span class="p">):])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">importlib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">__package__&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># won&amp;#39;t be needed after that&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">__package__&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">import_parents&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">level&lt;/span>&lt;span class="o">=...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>ç¬¬ä¸€æ¬¡æ¥è§¸ Python è¦ºå¾—é —ç¥å¥‡ï¼Œæœ‰è¨±å¤š magic number ä»¥åŠç¨æ¨¹ä¸€æ ¼çš„ package ç®¡ç†æ–¹å¼ï¼ŒåŒ…å« virtual env çš„ä½¿ç”¨ç­‰&lt;/p></description></item><item><title>ã€ŠEffective SQLã€‹è®€å¾Œåˆ†äº«</title><link>https://yuanchieh.page/posts/2021/2021-11-14-effective-sql%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/</link><pubDate>Sun, 14 Nov 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-11-14-effective-sql%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/</guid><description>&lt;p>&lt;img src="https://cf-assets2.tenlong.com.tw/products/images/000/107/662/webp/ACL049900.webp?1525539256"
loading="lazy"
>
&lt;a class="link" href="https://www.tenlong.com.tw/products/9789864764358?list_name=lv" target="_blank" rel="noopener"
>å¤©ç“è³¼è²·é€£çµ&lt;/a>&lt;/p>
&lt;p>æœ€è¿‘åœ¨å¹«å…¬å¸è™•ç† Data Pipelineï¼Œå°‡è³‡æ–™é€å¾€ BigQuery å„²å­˜ï¼Œä¸¦é–‹å§‹äº† SQL ç…‰ç„ï¼Œå¿…é ˆèªªå¹³å¸¸é–‹ç™¼å¯«çš„ Query è¤‡é›œåº¦éƒ½ä¸å¤ªé«˜ï¼Œæ¯”è¼ƒæ³¨é‡è³‡æ–™è¡¨çš„è¨­è¨ˆèˆ‡æ•ˆèƒ½ï¼Œè€Œå ±è¡¨ç›¸é—œå‰‡éœ€è¦æ›´å¤§é‡çš„é—œè¯ã€å»é‡ã€æŸ¥è©¢æ•ˆèƒ½ç­‰ï¼Œæ‰€ä»¥ç‰¹åˆ¥è²·äº†ã€ŠEffective SQLã€‹æ‹œè®€ä¸€ç•ªï¼Œè£¡é ­æä¾›å¾ˆå¤šå¯« SQL çš„å„ªåŒ–ï¼Œä»¥åŠé—œè¯å¾Œå„ç¨®çš„ Edge Caseï¼Œå¦‚æœä½ å°æ–¼å¯«çš„ SQL æ²’æœ‰è¶³å¤ è‡ªä¿¡ï¼Œé‚£å¾ˆæ¨è–¦å…¥æ‰‹&lt;/p>
&lt;p>ä»¥ä¸‹å°‡æ•´ç†å¹¾é»æˆ‘è¦ºå¾—ç‰¹åˆ¥æœ‰å•Ÿç™¼æ€§çš„&lt;/p>
&lt;h2 id="é—œè¯é‹ç®—">é—œè¯é‹ç®—&lt;/h2>
&lt;p>åœ¨é—œè¯é‹ç®—ä¸­ï¼ŒåŒ…å«äº†å…«ç¨®é‹ç®—&lt;/p>
&lt;ol>
&lt;li>é¸æ“‡ï¼šé€é where / having éæ¿¾&lt;/li>
&lt;li>æŠ•å½±ï¼šé€é select / group by é¸æ“‡å›å‚³æ¬„ä½&lt;/li>
&lt;li>é€£æ¥ï¼šé€é join é€£æ¥å¤šå¼µè³‡æ–™è¡¨&lt;/li>
&lt;li>äº¤é›†ï¼šé€é interset æ‰¾å‡ºå…©å€‹é›†åˆçš„é‡ç–Š (MySQL ä¸æ”¯æ´)ï¼Œä¹Ÿå¯ä»¥ç”¨ INNER JOINï¼Œä¾‹å¦‚ã€Œæ‰¾åˆ°åŒæ™‚è²·é bike èˆ‡ sakteboard çš„å®¢æˆ¶ã€&lt;/li>
&lt;li>ç¬›å¡çˆ¾ç©ï¼šå…©å€‹é›†åˆçš„æ‰€æœ‰çµ„åˆåˆ—èˆ‰ï¼Œä½¿ç”¨ CROSS JOIN&lt;/li>
&lt;li>è¯é›†ï¼šåˆä½µå…©å€‹æ¬„ä½ç›¸åŒçš„é›†åˆï¼Œé€é UNION&lt;/li>
&lt;li>é™¤æ³•ï¼šè¢«é™¤æ•¸é›†åˆä¸­å¸¶æœ‰å…¨éƒ¨é™¤æ•¸é›†åˆçš„åˆ—ï¼Œä¾‹å¦‚ã€ŒæŸæ‡‰å¾µè€…ç¬¦åˆæ‰€ä»¥çš„å·¥ä½œæ¢ä»¶ã€&lt;/li>
&lt;li>å·®é›†ï¼šä¸€å€‹é›†åˆæ¸›å»å¦ä¸€å€‹é›†åˆï¼Œå¯ä»¥é€é EXCEPT (MySQL ä¸æ”¯æ´)ï¼Œä½†å¯ä»¥ç”¨ OUTER JOIN å†å»æª¢æŸ¥ null å€¼æ¨¡æ“¬&lt;/li>
&lt;/ol>
&lt;h3 id="ä½œæ³•-23-æ‰¾å‡ºä¸ç›¸ç¬¦æˆ–ä¸å­˜åœ¨çš„ç´€éŒ„">ä½œæ³• 23: æ‰¾å‡ºä¸ç›¸ç¬¦æˆ–ä¸å­˜åœ¨çš„ç´€éŒ„&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/4WX7yN4GWRrA1wX7zb8AXv/2" target="_blank" rel="noopener"
>https://www.db-fiddle.com/f/4WX7yN4GWRrA1wX7zb8AXv/2&lt;/a>&lt;br>
ä¸»è¦å¯ä»¥ä½¿ç”¨ 3 ç¨®æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>ä½¿ç”¨ In&lt;/li>
&lt;li>ä½¿ç”¨ Exists&lt;/li>
&lt;li>ä½¿ç”¨ Left Join ä¸¦ç”¨ Where&lt;/li>
&lt;/ol>
&lt;p>å‰å…©ç¨®æ­é… subqueryï¼Œexists é€šå¸¸æ€§èƒ½æ¯” in å¥½å› ç‚ºåªè¦ subquery è‡³å°‘å­˜åœ¨ä¸€åˆ—å°±èƒ½ return&lt;/p>
&lt;h3 id="ä½œæ³•-24-ä½¿ç”¨-case-è§£æ±ºå•é¡Œçš„æ™‚æ©Ÿ">ä½œæ³• 24: ä½¿ç”¨ Case è§£æ±ºå•é¡Œçš„æ™‚æ©Ÿ&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/knMFW8pMRiVa6yg22i59DB/0" target="_blank" rel="noopener"
>https://www.db-fiddle.com/f/knMFW8pMRiVa6yg22i59DB/0&lt;/a>&lt;br>
ç´€éŒ„ä¸€ä¸‹ Case ä¸­ when å¯ä»¥ä½¿ç”¨ subqueryï¼Œé€™è®“å¯èƒ½æ€§å¢å¤§å¾ˆå¤šï¼Œä¾‹å¦‚æ¨™è¨˜å•†å“çš„ç†±éŠ·ç¨‹åº¦ï¼Œå¯ä»¥åœ¨ when ä¸­åŠ å…¥ subquery æŸ¥è©¢è²©è³£ç¸½æ•¸è€Œä¸ç”¨å…ˆ outer join å† select ä¸€æ¬¡&lt;/p>
&lt;h3 id="ä½œæ³•-25-è§£æ±ºå¤šæ¢ä»¶å•é¡Œçš„æŠ€å·§">ä½œæ³• 25: è§£æ±ºå¤šæ¢ä»¶å•é¡Œçš„æŠ€å·§&lt;/h3>
&lt;p>ç•¶è³‡æ–™è¡¨éœ€è¦é—œè¯å¾Œå†ç”¨å¤šç¨®æ¢ä»¶ç¯©é¸ï¼Œè¦å°å¿ƒä¸‹æ¢ä»¶çš„ä½ç½®é¿å…ç¯©é¸éŒ¯èª¤ï¼Œä¾‹å¦‚ã€Œè¦æ‰¾å‡ºè²·é skateboard åˆåŒæ™‚è²·é helmet / knee pad çš„ç”¨æˆ¶ã€ï¼Œéœ€è¦ä½¿ç”¨å¤šæ¬¡ INNER JOIN æ‰èƒ½å¤ ç¯©é¸å‡ºåŒæ™‚æ»¿è¶³å¤šæ¢ä»¶çš„æŸ¥è©¢ï¼Œè¦å°å¿ƒä¸èƒ½ç›´æ¥ç”¨ IN æœƒè®Šæˆ &amp;ldquo;OR&amp;rdquo; çš„æ¢ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- é€™åªæœƒæ‰¾åˆ°æœ‰è²·éä»»ä¸€å•†å“çš„ç”¨æˆ¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">inner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">join&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">products&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">products&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">product_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">products&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;skateboard&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;helmet&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;knee pad&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥é©æ™‚ç”¨ function ç°¡åŒ–é‡è¤‡çš„ SQL
&lt;a class="link" href="https://www.db-fiddle.com/f/vpB9hZgNGhnFPZo2FQrLhn/0" target="_blank" rel="noopener"
>https://www.db-fiddle.com/f/vpB9hZgNGhnFPZo2FQrLhn/0&lt;/a>&lt;/p>
&lt;h3 id="ä½œæ³•-26-éœ€è¦å®Œå…¨ç¬¦åˆæ™‚ä½¿ç”¨é™¤æ³•">ä½œæ³• 26: éœ€è¦å®Œå…¨ç¬¦åˆæ™‚ä½¿ç”¨é™¤æ³•&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/sA2VfuFSxW9Lr4krdcUg29/1" target="_blank" rel="noopener"
>https://www.db-fiddle.com/f/sA2VfuFSxW9Lr4krdcUg29/1&lt;/a>
å‡è¨­æ˜¯ä¸€å€‹æ±‚è·ç¶²ç«™ï¼Œç”¨æˆ¶éœ€è¦æ‰¾ã€Œæ»¿è¶³ç‰¹å®šæŠ€èƒ½çµ„åˆçš„è·ç¼ºã€ï¼Œå°±éœ€è¦ç”¨åˆ°é™¤æ³•çš„æ¦‚å¿µï¼Œå¯ä»¥ç”¨å…©ç¨®æ–¹å¼&lt;/p>
&lt;h4 id="1-é›™é‡å¦å®š">1. é›™é‡å¦å®šï¼š&lt;/h4>
&lt;p>å…ˆçœ‹æœ€å…§å±¤ - æ‰¾å‡ºç”¨æˆ¶æ‰€æœ‰çš„èˆ‡æ‰€éœ€æŠ€èƒ½æ¨¹ç›¸ç¬¦åˆçš„æŠ€èƒ½ï¼Œç¬¬ä¸€å€‹å¦å®šå¼æ˜¯æ‰¾å‡ºæ‰€éœ€æŠ€èƒ½æ¨¹ä¸­ç”¨æˆ¶æœ‰å“ªäº›ä¸è¶³çš„ (not exists)ï¼Œç¬¬äºŒå±¤å¦å®šå¼ &lt;code>ç”¨æˆ¶æ²’æœ‰ (æ‰€éœ€æŠ€èƒ½æ¨¹ä¸­ä¸å†(ç”¨æˆ¶æ‰€éœ€çš„æŠ€èƒ½æ¨¹))&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skills&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">u2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">inner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">join&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user_skills&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">u2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">u2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">skill_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">skill_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‚è¼¯ä¸Šæœ‰é»ç¹ï¼Œå‡è¨­æ‰€éœ€æŠ€èƒ½æ¨¹éœ€è¦ js / awsï¼Œè€Œ user åªæœƒ rails / awsï¼Œç¬¬ä¸€å±¤æœƒå…ˆç¯©é¸å‡º aws (rails ä¸å†æ‰€éœ€æŠ€èƒ½æ¨¹å…§)ï¼›ç¬¬äºŒæ­¥æœƒç¯©é¸å‡º js (å› ç‚ºç”¨æˆ¶æ²’æœ‰è©²æŠ€èƒ½)ï¼Œç¬¬ä¸‰æ­¥è¨ˆç®—å‡º (ç”¨æˆ¶æœ‰ç¼ºå°‘æ‰€éœ€æŠ€èƒ½æ¨¹) æ‰€ä»¥è¢«éæ¿¾æ‰ï¼›&lt;br>
ä¸éä»¥ä¸Šé™¤äº†é‚è¼¯æ¯”è¼ƒç¹ï¼Œé‚„æœ‰ä¸€å€‹ç¼ºé»æ˜¯ &lt;code>å¦‚æœæ‰€éœ€æŠ€èƒ½æ¨¹ç‚ºç©ºï¼Œå‰‡æœƒå›å‚³æ‰€æœ‰çš„è¡Œï¼Œå› ç‚ºç¬¬ä¸€å±¤å¦å®šæœƒæ˜¯ all true&lt;/code>&lt;/p>
&lt;h4 id="2-ä½¿ç”¨-group-by-èˆ‡-having">2. ä½¿ç”¨ group by èˆ‡ havingï¼š&lt;/h4>
&lt;p>é€™å€‹æ–¹æ³•æ¯”æƒ³åƒä¸­ç°¡å–®ï¼Œé€é LEFT JOIN æ‰¾å‡º user ç›®å‰èˆ‡ prefered_skills æœ‰å¹¾å€‹é‡è¤‡æŠ€èƒ½ï¼Œæœ€å¾Œç›´æ¥æ¯” count æ˜¯å¦ç›¸åŒå°±çŸ¥é“&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prefered_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">skill_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skill_count&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">inner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">join&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user_skills&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">left&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">join&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skills&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">skill_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user_skills&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">skill_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">group&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">having&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skills&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefered_skill_count&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ä½œæ³•-33-ä¸ç”¨-group-by-æ‰¾å‡ºæœ€å¤§æˆ–æœ€å°å€¼">ä½œæ³• 33: ä¸ç”¨ GROUP BY æ‰¾å‡ºæœ€å¤§æˆ–æœ€å°å€¼&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/8TMwJykwSRc4Li4J9hbdyb/0" target="_blank" rel="noopener"
>https://www.db-fiddle.com/f/8TMwJykwSRc4Li4J9hbdyb/0&lt;/a>
é€™å€‹æè­°å¾ˆæœ‰è¶£ä¹Ÿå¾ˆå¯¦ç”¨ï¼Œé€šå¸¸çœ‹åˆ° MIN/MAX å¾ˆç›´è¦ºå°±æ˜¯ç”¨ GROUP BY æ‰¾å‡ºï¼Œä½†æ˜¯ GROUP BY å¾Œåªæœƒä¿ç•™èšé›†çš„æ¬„ä½è€Œå…¶ä»–æ¬„ä½è³‡è¨Šéƒ½æœƒæ¶ˆå¤± (é™¤éç”¨ primary ç•¶ä½œ GROUP BY æ¢ä»¶ä½†é€šå¸¸ä¸æœƒé€™éº¼ç”¨)ï¼Œé€™é‚Šä½œè€…çµ¦å‡ºå¦ä¸€å€‹å¾ˆæ£’çš„æ›¿ä»£æ–¹æ¡ˆï¼Œ&lt;code>ä½¿ç”¨ LEFT JOIN æ‰¾å‡ºæ¥µå€¼&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚èªªä»Šå¤©æœ‰ä¸€å€‹é…’å–® [é¡åˆ¥, ç”¢åœ°åœ‹å®¶, é…’ç²¾æ¿ƒåº¦]ï¼Œæˆ‘å€‘å¸Œæœ›ã€Œæ‰¾å‡ºåŒä¸€é¡åˆ¥ä¸­æœ€çƒˆçš„é…’åŒæ™‚é¡¯ç¤ºç”¢åœ°åœ‹å®¶ã€
ç¬¬ä¸€ç¨®æ˜¯éŒ¯èª¤ç¤ºç¯„ï¼Œæœƒå‡ºç¾&lt;code>ER_WRONG_FIELD_WITH_GROUP&lt;/code> çš„éŒ¯èª¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">alcohol&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">category&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">country&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">group&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">category&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥ç”¨ LEFT JOIN æ–¹å¼ï¼Œæ‰¾åˆ°åŒä¸€å€‹ç¨®é¡ä¸­æ¯”ç•¶å‰æ¬„ä½æ›´é«˜çš„é…’ç²¾æ¿ƒåº¦ï¼Œå¦‚æœæ‰¾ä¸åˆ° (where .. is null) ä»£è¡¨ç•¶å‰æ¬„ä½å°±æ˜¯æœ€çƒˆçš„å•¤é…’&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">left&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">join&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">category&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">category&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">alcohol&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">alcohol&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beers2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">category&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>Subquery vs JOINï¼š
å¯ä»¥çœ‹åˆ° Subquery åœ¨å¾ˆå¤šæ™‚å€™å¯ä»¥èˆ‡ JOIN äº’ç›¸æ›¿æ›ï¼Œä¸è«–æ˜¯åœ¨ç¯©é¸æ‰€é—œè¯çš„è³‡æ–™è¡¨ã€è¨ˆç®—åŠ ç¸½ç­‰ï¼Œé‚£ç©¶ç«Ÿå…©è€…èª°æ¯”è¼ƒå¥½ï¼Ÿ
ç¶²è·¯ä¸Šæ™®éèªª JOIN æ¯”è¼ƒå¥½ï¼Œå› ç‚º DBMS åŸ·è¡Œæ™‚æ¯”è¼ƒå®¹æ˜“å„ªåŒ–ï¼Œä¸” Subquery æ¯æ¬¡éƒ½æœƒåŸ·è¡Œï¼›
ä½†åœ¨é€™æœ¬æ›¸ä¸­å»æ²’æœ‰æ˜è¬›ï¼Œæœ‰æ™‚å€™ Subquery æ¶‰åŠçš„æ¬„ä½å°‘ã€å¯ä»¥é€éç´¢å¼•åŠ é€Ÿæ™‚ (ex. åŸºæ–¼ç´¢å¼•çš„ COUNT) åè€Œæœ‰å¯èƒ½æœƒæ›´å¿«ï¼Œæœ€å¾Œçœ‹ä¾†é‚„æ˜¯è¦å¯¦éš›è·‘è·‘çœ‹ç”¨ EXPLAIN æ‰çŸ¥é“&lt;/p>
&lt;/blockquote>
&lt;h3 id="çª—å£å‡½å¼">çª—å£å‡½å¼&lt;/h3>
&lt;p>æ—©æœŸ SQL æ²’æœ‰ç›¸é„°åˆ—çš„æ¦‚å¿µï¼Œåªèƒ½ç”¨ GROUP BY åšå½™æ•´ï¼Œè€Œçª—å£å‡½å¼æä¾›äº†ä»¥ç•¶å‰è¡Œè¨ˆç®—çš„é¡ä¼¼åŠ ç¸½æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨æŸæ¢ä»¶ä¸‹è©²è¡Œçš„åŠ ç¸½(SUM)ã€æ’è¡Œ (RANK)ã€å‰ä¸€ç­† (LEAD) ç­‰ï¼Œå¯ä»¥åšåˆ°ä»¥å¾€å¾ˆé›£å¯¦è¸çš„åŠŸèƒ½ä¾‹å¦‚åŒæœˆè·¨å¹´çš„ç‡Ÿæ”¶æˆé•·æ¯”ä¾‹&lt;/p>
&lt;p>é€é partition by month è®“çª—å£ä¾ç…§ month åˆ†é¡ï¼ŒåŒæ™‚ç”¨ year ç•¶ä½œæ’åºï¼Œå– lag ä¹Ÿå°±æ˜¯å‰ä¸€ç­†çš„ revenue å°±å¯ä»¥å¾—åˆ°ã€Œå»å¹´åŒæœˆã€çš„è³‡æ–™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">year&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">month&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">revenue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lag&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">revenue&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">over&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">partition&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">month&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">order&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">year&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">asc&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">increase&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">revenues&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¸¸ç”¨çš„é‚„æœ‰ ROW_NUMBER / ROW_NUMBER æ˜¯å–®ç´”çš„è¡Œæ•¸ï¼Œ RANK å‰‡æ˜¯æŒ‰ç…§é †åºæ’åï¼Œå…©è€…çš„æ¦‚å¿µå¾ˆæ¥è¿‘ï¼Œåªæœ‰åœ¨æœ‰é‡è¤‡æ•¸å€¼æ™‚ RANK æœƒå‡ºç¾ç›¸åŒçš„æ’åï¼›ä½†æ˜¯ç•¶ RANK ç›¸åŒæ’åå‡ºç¾å¾Œæœƒæ–·å±¤ï¼Œå¦‚æœå¸Œæœ›æ˜¯é€£çºŒæ’åå¯ä»¥ç”¨ DENSE_RANK&lt;/p>
&lt;p>å¦å¤–é‚„æœ‰ RANGEï¼Œå¯ä»¥å–å‰å¾Œä¸€å€‹ç¯„åœå€é–“åšå‹•æ…‹å½™æ•´&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>SQL å¯«èµ·ä¾†ä¹Ÿé —æœ‰æŒ‘æˆ°æ€§ï¼Œè¦æƒ³è¾¦æ³•å…¼é¡§ç°¡æ½”èˆ‡æ€§èƒ½éœ€è¦ä¸€å®šçš„æ™‚é–“å­¸ç¿’ï¼Œé‚„æœ‰ä¸€äº›é€²éšçš„è­°é¡Œå¦‚éšå±¤åŒ–é¡¯ç¤ºç­‰å°±å…ˆç•¥é&lt;/p></description></item><item><title>ã€Šè¨­è¨ˆé‡æ§‹ã€‹è®€å¾Œåˆ†äº«</title><link>https://yuanchieh.page/posts/2021/2021-11-06-%E8%A8%AD%E8%A8%88%E9%87%8D%E6%A7%8B%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/</link><pubDate>Sat, 06 Nov 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-11-06-%E8%A8%AD%E8%A8%88%E9%87%8D%E6%A7%8B%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/</guid><description>&lt;p>&lt;img src="https://cf-assets2.tenlong.com.tw/product_images/images/000/031/183/pjpeg/9789864345229_bc.jpg?1631873566"
loading="lazy"
>
&lt;a class="link" href="https://www.tenlong.com.tw/products/9789864345229?list_name=srh" target="_blank" rel="noopener"
>å¤©ç“è³¼è²·é€£çµ&lt;/a>&lt;/p>
&lt;p>ä¸è«–æ˜¯å› ç‚ºéš¨è‘—ç”¢å“è®ŠåŒ–è€Œå°è‡´éå¾€çš„ç¨‹å¼è¨­è¨ˆä¸é©åˆï¼Œæˆ–æ˜¯å–®ç´”è¨­è¨ˆäººå“¡æ²’æœ‰éµå®ˆåŸºæœ¬è¨­è¨ˆåŸå‰‡è€Œå°è‡´çš„è¨­è¨ˆéŒ¯èª¤ï¼Œå¦‚æœæ²’æœ‰æŒçºŒçš„å›é¡§ä¸¦é‡æ§‹ï¼Œæœƒè®“æŠ€è¡“å‚µè¶Šç–Šè¶Šé«˜ï¼Œè€ŒæŠ€è¡“å‚µæœ€çµ‚é«”ç¾åœ¨è®Šæ›´æˆæœ¬ (cost of change)ï¼Œè¦åŠ æ–°åŠŸèƒ½è¶Šä¾†è¶Šé›£åŠ ã€æˆ–æ˜¯åŠ äº†è«åå…¶ä»–çš„åœ°æ–¹é–‹å§‹å£æ‰ï¼Œè®“ç”¢å“é–‹ç™¼è¶Šä¾†è¶Šè‰±é›£&lt;/p>
&lt;p>ä½†æ˜¯è­˜åˆ¥ç¨‹å¼å£å‘³é“æœ‰æ™‚æ²’é€™éº¼ç›´è¦ºï¼Œè€Œã€Šè¨­è¨ˆé‡æ§‹ã€‹ç”¨å¾ˆæ¸…æ¥šçš„æ–¹å¼æ•´ç†ï¼Œå¾ç™¼ç”Ÿå£å‘³é“çš„æ½›åœ¨åŸå› ã€é€é Java SDK çš„éŒ¯èª¤è¨­è¨ˆã€æœ€å¾Œçµ¦å‡ºå¯¦éš›ç¯„ä¾‹ï¼Œä¸¦æŒ‡å‡ºé©åˆçš„é‡æ§‹æ–¹å¼ï¼›è€Œè¨­è¨ˆæ˜¯éœ€è¦å› åœ°åˆ¶å®œï¼Œæ‰€ä»¥æœ‰äº›å£å‘³é“æœ¬èº«æ˜¯åˆ»æ„çš„ï¼Œé€™æœ¬æ›¸ä¹Ÿé©ç•¶çš„èˆ‰å‡ºä¸€äº›åä¾‹ï¼Œè®“æ•´å€‹è«–è¿°æ›´åŠ çš„å®Œæ•´&lt;/p>
&lt;p>æ•´æœ¬æ›¸åƒ… 248 é å¾ˆæ¨è–¦å…¥æ‰‹ï¼Œç¸½å…±æ•´ç† 25 å€‹å£å‘³é“ï¼Œæ­é… Design Pattern / Refactoring ç³»åˆ—çš„æ›¸å¯ä»¥ç›¸äº’ä½è­‰
&lt;img src="https://yuanchieh.page/%27/post/2021/img/1106/code_smell_total.jpg%27"
loading="lazy"
>&lt;/p>
&lt;p>ä»¥ä¸‹ç´€éŒ„ä¸€ä¸‹æˆ‘ç‰¹åˆ¥æœ‰æ„Ÿï¼Œä»¥åŠå¯¦éš›é‡åˆ°çš„ç¨‹å¼å£å‘³é“&lt;/p>
&lt;h2 id="æŠ½è±¡">æŠ½è±¡&lt;/h2>
&lt;p>æŠ½è±¡æ˜¯ç‚ºäº†&lt;code>ç²¾ç°¡å’Œæ³›åŒ–ä¾†ç°¡åŒ–å¯¦é«”&lt;/code>ï¼Œå…·é«”çš„å¯¦ç¾æ‰‹æ³•æœ‰&lt;/p>
&lt;ol>
&lt;li>æä¾›æ¸…æ™°çš„æ¦‚å¿µé‚Šç•Œèˆ‡å”¯ä¸€èº«ä»½&lt;/li>
&lt;li>æ˜ å°„é ˜åŸŸå¯¦é«”&lt;/li>
&lt;li>ç¢ºä¿å…§èšæ€§èˆ‡å®Œæ•´æ€§&lt;/li>
&lt;li>è³¦äºˆå–®ä¸€è€Œé‡è¦çš„è·è²¬&lt;/li>
&lt;li>é¿å…é‡è¤‡&lt;/li>
&lt;/ol>
&lt;h3 id="31-ç¼ºå¤±æŠ½è±¡">3.1 ç¼ºå¤±æŠ½è±¡&lt;/h3>
&lt;p>å¾ˆå¤šæ™‚å€™æˆ‘å€‘æœƒç”¨åŸºæœ¬å‹åˆ¥ä¾†è¡¨é”ä¸€å€‹æ‡‰è©²è¢«æŠ½è±¡åŒ–çš„æ¦‚å¿µï¼Œä¾‹å¦‚æ›¸ç±ä¸­çš„ ISBNï¼ŒISBN åˆæœ‰ 10 ç¢¼ / 13 ç¢¼çš„å€åˆ¥ï¼Œæœ¬èº«æ•¸å­—çš„çµ„åˆåˆæœ‰å€‹åˆ¥çš„æ„ç¾©ï¼Œå¦‚æœæˆ‘å€‘åªç”¨åŸºæœ¬å‹åˆ¥ String å„²å­˜ï¼Œç•¶é‡åˆ°å•†æ¥­é‚è¼¯éœ€è¦æª¢æŸ¥ ISBN ç¢¼ã€é€é ISBN ç¢¼è§£è®€è³‡è¨Šæ™‚ï¼Œå°±æœƒè®“è™•ç†é‚è¼¯å››è™•é‡è¤‡&lt;/p>
&lt;p>è§£æ±ºæ–¹å¼æ˜¯å¢åŠ ä¸€å€‹ ISBN classï¼Œè®“åŸæœ¬çš„ Book å»å¼•ç”¨ ISBNï¼Œè®“æª¢æŸ¥èˆ‡è§£è®€çš„ method éš±è—åœ¨ ISBN class ä¸­&lt;/p>
&lt;h3 id="32-å‘½ä»¤å¼æŠ½è±¡åŒ–">3.2 å‘½ä»¤å¼æŠ½è±¡åŒ–&lt;/h3>
&lt;p>&lt;code>ç‰©ä»¶å°å‘çš„è¨­è¨ˆåŸå‰‡æ˜¯è­˜åˆ¥çœŸå¯¦ä¸–ç•Œçš„äº‹å‹™ï¼Œä¸¦ç”¨æŠ½è±¡åŒ–è¡¨ç¤ºä»– (æ˜ å°„é ˜åŸŸå¯¦é«”)&lt;/code>ï¼Œå…·é«”ä¾†èªªå°±æ˜¯æŠ½è±¡çš„ç‰©ä»¶æ‡‰è©²è¦è¡¨é”äº‹ç‰©çš„è¡Œç‚ºèˆ‡å…¶ç‹€æ…‹ï¼Œå¦‚æœæ˜¯ç¿’æ…£ç¨‹åºå‹æ€ç¶­è€Œéç‰©ä»¶å‹æ€ç¶­ï¼Œå®¹æ˜“ç”¢ç”Ÿè³‡æ–™èˆ‡è¡Œç‚ºè™•ç†åˆ†é–‹çš„å ´é¢ï¼Œå¦‚ Data class å„²å­˜æ‰€æœ‰çš„åƒæ•¸ï¼ŒDataHandler class è² è²¬æ¥æ”¶ Data class çš„åšåƒæ•¸ä¸¦å®šç¾©å¾ˆå¤š method&lt;/p>
&lt;p>ä¿®æ”¹çš„æ–¹å¼æ˜¯æ‰¾åˆ°é©åˆçš„ç‰©ä»¶ï¼Œè®“è³‡æ–™èˆ‡è¡Œç‚ºéƒ½åˆ†é¡åˆ°æ‰€å±¬çš„ç‰©ä»¶ï¼Œç”¨ä¾†è¡¨é”ä¸€å€‹æ¸…æ™°ä¸”å®Œæ•´çš„æ¦‚å¿µï¼Œå¦‚æœæ˜¯åƒ Data / DataHandler æˆ–è¨±å¯ä»¥è€ƒæ…®åˆä½µä¸€èµ·&lt;/p>
&lt;p>éå¾€åœ¨å¯« js æ™‚ Object Listeral çœŸçš„å¤ªæ–¹ä¾¿äº†ï¼Œå¾€å¾€ class éƒ½è®Šæˆå–®ç´”çš„ method è€Œæ²’æœ‰ç‹€æ…‹ï¼Œç›´æ¥åƒ object ç•¶ä½œåƒæ•¸åšé‹ç®—ï¼Œé€™è®“ç¨‹å¼ç¢¼çš„æŠ½è±¡åŒ–ä¸å®Œå…¨ï¼Œå°è‡´å¯ç†è§£æ€§ã€å¯é‡ç”¨æ€§ä½å¾ˆå¤š&lt;/p>
&lt;p>åä¾‹ï¼šè¨­è¨ˆæ¨¡å¼ä¸­æœ‰å¹¾ç¨®éƒ½æœ‰å‘½ä»¤å¼æŠ½è±¡åŒ–çš„å£å‘³é“ï¼Œä¾‹å¦‚&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://refactoringguru.cn/design-patterns/strategy" target="_blank" rel="noopener"
>ç­–ç•¥æ¨¡å¼&lt;/a>ï¼šæ¯å€‹ç­–ç•¥éƒ½æ˜¯ç¨ç«‹ç‰©ä»¶ï¼Œåœ¨å‹•æ…‹åŸ·è¡Œæ™‚ç•¶ä½œåƒæ•¸å‚³å…¥æ”¹è®Šè¡Œç‚º&lt;/li>
&lt;li>&lt;a class="link" href="https://refactoringguru.cn/design-patterns/state" target="_blank" rel="noopener"
>ç‹€æ…‹æ¨¡å¼&lt;/a>ï¼šå°‡ç‰©ä»¶çš„ä¸åŒç‹€æ…‹å®£å‘Šæˆç‰©ä»¶ï¼Œåœ¨åŸ·è¡Œæ™‚åˆ‡æ›ä¸åŒç‹€æ…‹ï¼Œæ–¹ä¾¿è®“æ¯å€‹è¡Œç‚ºå¯ä»¥æœ‰å°æ‡‰çš„æ“ä½œ&lt;/li>
&lt;li>&lt;a class="link" href="https://refactoringguru.cn/design-patterns/command" target="_blank" rel="noopener"
>å‘½ä»¤æ¨¡å¼&lt;/a>ï¼šå°‡æ¯å€‹å‘½ä»¤éƒ½å®£å‘Šæˆç‰©ä»¶&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šçš„ç‰©ä»¶å®£å‘Šéƒ½æœ‰é»é•ååŸå…ˆçš„ç‰©ä»¶æŠ½è±¡åŒ–åŸå‰‡ï¼Œä½†ç‚ºäº†æé«˜å¯é‡ç”¨æ€§ã€å¯æ“´å±•æ€§ï¼Œé€™æ¨£æ˜¯å¯ä»¥æ¥å—çš„å–æ¨&lt;/p>
&lt;h2 id="å°è£">å°è£&lt;/h2>
&lt;p>éš±è—å¯¦ä½œç´°ç¯€ï¼Œå¯¦ä½œé—œæ³¨é»åˆ†é›¢èˆ‡è³‡è¨Šéš±è—&lt;/p>
&lt;h3 id="44-æœªåˆ©ç”¨å°è£">4.4 æœªåˆ©ç”¨å°è£&lt;/h3>
&lt;p>ç•¶æˆ‘å€‘åœ¨ä¸€æ®µé‚è¼¯ä¸­é–‹å§‹ç”¨å¤§é‡çš„ if/else ã€switch æª¢æŸ¥å‹åˆ¥ä¸¦çµ¦äºˆä¸åŒæ“ä½œæ™‚ï¼Œå°±å¯èƒ½è½å…¥äº†æœªåˆ©ç”¨å°è£çš„å£å‘³é“ä¸­ï¼Œé€™æœƒæœ‰å¹¾å€‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>é¡¯å¼å‹åˆ¥æª¢æŸ¥è®“ç¨‹å¼ç¢¼èˆ‡å…·é«”å‹åˆ¥è€¦åˆï¼Œé™ä½å¯ç¶­è­·æ€§ï¼Œå¦‚æœæ–°å¢å‹åˆ¥å°±éœ€è¦æ”¹ç¨‹å¼ç¢¼&lt;/li>
&lt;li>å¦‚æœå‘¼å«æ–¹æ¼æª¢æŸ¥å‹åˆ¥ï¼Œå¯èƒ½æœƒæœ‰ä¸é æœŸçš„è¡Œç‚ºå‡ºç¾&lt;/li>
&lt;/ol>
&lt;p>é€é&lt;code>å¤šå‹&lt;/code>å¯ä»¥å¾ˆå¥½çš„è§£æ±ºå•é¡Œï¼Œå¤šå¼•å…¥ä¸€å€‹è¶…å‹åˆ¥ï¼Œæ¥è‘—å„å€‹é¡åˆ¥å¯¦ä½œç›¸åŒçš„ä»‹é¢å³å¯&lt;/p>
&lt;h2 id="æ¨¡çµ„åŒ–">æ¨¡çµ„åŒ–&lt;/h2>
&lt;p>é€éé›†ä¸­å’Œåˆ†è§£å»ºç«‹é«˜å…§èšã€ä½è€¦åˆçš„æŠ½è±¡&lt;/p>
&lt;h3 id="53-å¾ªç’°ä¾è³´å¼æ¨¡çµ„åŒ–">5.3 å¾ªç’°ä¾è³´å¼æ¨¡çµ„åŒ–&lt;/h3>
&lt;p>å¦‚æœä¾è³´é—œä¿‚åœ–æœ‰ç’°å‡ºç¾ï¼Œä¹Ÿå°±æ˜¯è¶…å‹åˆ¥ä¾è³´æ–¼å­å‹åˆ¥ï¼Œé€™æœƒå°è‡´ä¿®æ”¹é¡åˆ¥æ™‚ä¸å°å¿ƒå½±éŸ¿åˆ°å…¶ä»–çš„é¡åˆ¥&lt;/p>
&lt;p>å‡ºç¾çš„åŸå› å¯èƒ½æ˜¯&lt;/p>
&lt;ol>
&lt;li>è·è²¬æ‹†åˆ†éŒ¯èª¤&lt;/li>
&lt;li>æŠŠè‡ªå·±ç•¶ä½œåƒæ•¸å‚³é&lt;/li>
&lt;li>å¯¦ä½œ callback æ™‚&lt;/li>
&lt;li>ä¾è³´å±¤ç´šå¤ªå¤šæ²’æœ‰æ³¨æ„åˆ°&lt;/li>
&lt;/ol>
&lt;p>ä¾‹å¦‚èªªæœ‰ä¸€å€‹é›²ç«¯æ–‡ä»¶ç³»çµ±éœ€è¦æŠŠæ–‡ä»¶åŠ å¯†ï¼Œè€ŒåŠ å¯†éœ€è¦æ–‡ä»¶çš„å…§å®¹ï¼Œè®Šæˆ SourceDocument class è·Ÿ DESEncryption class ç›¸äº’ä¾è³´
&lt;img src="https://yuanchieh.page/%27/post/2021/img/1106/module1.jpg%27"
loading="lazy"
>&lt;/p>
&lt;p>è§£æ±ºè¾¦æ³•å¯ä»¥è®“ SourceDocument ä¾è³´æ–¼ IEncrytionï¼Œè€Œ DESEncryption å¯¦ä½œ IEncrytionï¼Œé€™æ¨£å°±æ²’æœ‰å¾ªç’°ä¾è³´ä»¥åŠ SourceDocument class è€¦åˆæ–¼ DESEncryption å¯¦ä½œçš„å•é¡Œ
&lt;img src="https://yuanchieh.page/%27/post/2021/img/1106/module2.jpg%27"
loading="lazy"
>&lt;/p>
&lt;h2 id="å±¤æ¬¡çµæ§‹-heirarchy">å±¤æ¬¡çµæ§‹ (heirarchy)&lt;/h2>
&lt;p>é€éåˆ†é¡ã€åˆä½µã€æ›¿æ›å’Œæ’åºç­‰æ‰‹æ³•å±¤æ¬¡åŒ–æŠ½è±¡ï¼Œä¾‹å¦‚å‹•ç‰©å­¸åˆ†é¡&lt;/p>
&lt;h3 id="67-å›é€†å‹-heirachy">6.7 å›é€†å‹ heirachy&lt;/h3>
&lt;p>å­å‹åˆ¥å¯ä»¥å¾è¶…å‹åˆ¥ç¹¼æ‰¿è¡Œç‚ºï¼Œæˆ–æ˜¯è‡ªè¡Œè¤‡å¯«è¡Œç‚ºï¼Œä½†å¦‚æœå­å‹åˆ¥æœªç…§è¶…å‹åˆ¥ä»‹é¢å¯¦ä½œï¼Œæœƒç ´å£ &lt;code>is-a&lt;/code> çš„ç¹¼æ‰¿é—œä¿‚ï¼Œé€²è€Œé•åé‡Œæ°æ›¿æ›åŸå‰‡ (LPS)ï¼Œé€™ç¨®é•èƒŒè¶…å‹åˆ¥çš„æ‰¿è«¾å°±æ˜¯å›é€†å‹å±¤æ¬¡çµæ§‹&lt;/p>
&lt;p>å¯èƒ½æ˜¯å› ç‚ºè¶…å‹åˆ¥æ¶µè“‹å¤ªå»£ï¼Œæˆ–æ˜¯å­å‹åˆ¥å–®ç´”æƒ³é‡ç”¨æŸäº›è¡Œç‚ºè€Œå¿…é ˆé•èƒŒå…¶é¤˜è¡Œç‚ºçš„è¨­è¨ˆ&lt;/p>
&lt;p>ä¾‹å¦‚æœ‰ä¸€å€‹è¶…å‹åˆ¥æ˜¯ CallSiteï¼Œå…¶ä¸­ä¸€å€‹å­å‹åˆ¥ ConstantCallSite ç‚ºäº†æä¾›ä¸å¯è®Šçš„ç‰¹æ€§ï¼Œæ‰€ä»¥ç•¶å‘¼å« setTarget æ™‚æœƒæ‹‹å‡ºéŒ¯èª¤
&lt;img src="https://yuanchieh.page/%27/post/2021/img/1106/heirarchy_1.jpg%27"
loading="lazy"
>&lt;/p>
&lt;p>è§£æ±ºæ–¹æ³•å¯ä»¥æŠŠå­å‹åˆ¥å…±ç”¨çš„è¡Œç‚ºå†å¤šæŠ½ä¸€å±¤è¶…å‹åˆ¥å‡ºä¾†ï¼Œå…±ç”¨ç›¸åŒçš„è¡Œç‚ºï¼Œå…¶é¤˜çš„å„è‡ªå‹åˆ¥è™•ç†
&lt;img src="https://yuanchieh.page/%27/post/2021/img/1106/heirarchy_2.jpg%27"
loading="lazy"
>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å¾ä¹‹å‰å­¸ç¿’ SOLID åŸå‰‡ï¼Œåˆ°å¾åå‘ç”¨ç¨‹å¼ç¢¼è‡­å‘³ä¾†çœ‹ç‚ºä»€éº¼éœ€è¦ SOLID ç®—æ˜¯ä¸€å€‹è »æœ‰è¶£çš„å°ç…§ï¼Œå†æ­é… Refactoring è®“è‡ªå·±å°æ–¼æŠ½è±¡çš„ç‰©ä»¶å°å‘ã€ŒæŠ½è±¡ã€ã€ã€Œå°è£ã€ã€ã€Œç¹¼æ‰¿ã€æœ‰æ›´å¤šçš„äº†è§£èˆ‡åæ€&lt;/p></description></item><item><title>MySQL Replication èˆ‡ RDS</title><link>https://yuanchieh.page/posts/2021/2021-10-10-mysql-replication-%E8%88%87-rds/</link><pubDate>Sun, 10 Oct 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-10-10-mysql-replication-%E8%88%87-rds/</guid><description>&lt;p>å…¬å¸ç›®å‰ä¸»è¦è³‡æ–™åº«æ˜¯ MySQLï¼Œç‚ºäº†è³‡æ–™åˆ†ææœ‰é–‹å•Ÿæ–°çš„ Read Replica é¿å…å½±éŸ¿åˆ°æ­£å¼ç’°å¢ƒï¼Œå› ç‚ºä¸€äº›åˆ†æå·¥å…· (Metabase) çš„é™åˆ¶ï¼Œæ‰€ä»¥èˆ‡åŒäº‹åœ¨æ€è€ƒ &lt;code>Read Replica å¦‚æœåªåŒæ­¥æŒ‡å®šçš„è³‡æ–™è¡¨ï¼ŒåŒæ™‚ä¿ç•™å¯«å…¥å…¶ä»–è³‡æ–™è¡¨çš„å½ˆæ€§è©²æœ‰å¤šå¥½ ?!&lt;/code>ï¼ŒæŸ¥äº†ä¸€ä¸‹ RDS ç™¼ç¾é€™æ˜¯å¯ä»¥çš„ &lt;a class="link" href="https://aws.amazon.com/premiumsupport/knowledge-center/rds-read-replica/" target="_blank" rel="noopener"
>How can I perform write operations to my Amazon RDS for MariaDB or MySQL DB instance read replica?&lt;/a>ï¼Œç•¶æ™‚è¦ºå¾—ååˆ†çš„è¡çªï¼Œç‚ºä»€éº¼ &amp;ldquo;Read&amp;rdquo; Replica å¯ä»¥ Writeï¼Œä¹Ÿå€Ÿæ­¤å›åˆ°æºé ­ç†è§£ MySQL Replication è¨­å®šèˆ‡æ©Ÿåˆ¶ï¼Œæ‰ç™¼ç¾é€™ä¸€åˆ‡éƒ½æ˜¯å¾ˆåˆä¹æƒ…ç†çš„&lt;/p>
&lt;p>ä»¥ä¸‹éƒ½æ˜¯ä»¥ MySQL v5.7 ç‚ºä¸»&lt;/p>
&lt;h2 id="mysql-replication">MySQL Replication&lt;/h2>
&lt;p>é–±è®€é &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/replication.html" target="_blank" rel="noopener"
>Chapter 16 Replication&lt;/a>ï¼Œç°¡å–®æ•´ç†å¹¾å€‹é‡é»&lt;/p>
&lt;ol>
&lt;li>Source DB / Replica DB éƒ½è¦æŒ‡å®š server_id&lt;/li>
&lt;li>Source DB å¿…é ˆé–‹å•Ÿ binlogï¼Œæœ‰ä¸‰ç¨®æ ¼å¼å¯ä»¥é¸ï¼Œå¾ŒçºŒè£œå……&lt;/li>
&lt;li>Replica DB å¯ä»¥é€é &lt;code>replication_do_table&lt;/code> æŒ‡å®šè³‡æ–™è¡¨åŒæ­¥&lt;/li>
&lt;li>Replica DB å¯ä»¥æŒ‡å®šå¤šå€‹ Source DB&lt;/li>
&lt;li>GTIDs å»ºè­°é–‹å•Ÿï¼Œä¸»è¦æ˜¯å¹«åŠ© binlog çš„æ¯ä¸€å€‹æ“ä½œéƒ½æ‰“ä¸Š idï¼Œæ–¹ä¾¿ç¢ºèªåŒæ­¥é€²åº¦ï¼›ä¸é–‹å•Ÿå‰‡æ˜¯ç”¨ file åŒæ­¥ï¼Œéœ€è¦ç´€éŒ„åŒæ­¥çš„æª”æ¡ˆåç¨±èˆ‡ä½ç½®ï¼Œç›¸å°è¤‡é›œäº›&lt;/li>
&lt;/ol>
&lt;p>binlog æœƒç´€éŒ„åœ¨ master ä¸Šçš„æ‰€æœ‰æ“ä½œï¼Œè€Œ replica å¾ˆå–®ç´”å°±æ˜¯æ‹¿åˆ° binlog æŠŠåŒæ¨£çš„æ“ä½œå¥—ç”¨åœ¨è‡ªå·±èº«ä¸Šï¼Œç”¨é€™å€‹è§’åº¦æ€è€ƒï¼Œå°±å¯ä»¥ç†è§£ç‚ºä»€éº¼ replica åŒæ™‚ä¿ç•™å¯«å…¥çš„åŠŸèƒ½å¾ˆæ­£å¸¸ï¼Œåªè¦ä¸å½±éŸ¿ master binlog ä¸Šçš„æ“ä½œå³å¯&lt;/p>
&lt;h3 id="binlog-format">binlog format&lt;/h3>
&lt;h4 id="1-statement">1. statement&lt;/h4>
&lt;p>binlog ç›´æ¥ç´€éŒ„ master ä¸Š SQL èªå¥ï¼Œæ‰€ä»¥ binlog æœ¬èº«éå¸¸å®¹æ˜“é–±è®€ï¼Œåœ¨åšç³»çµ±æ“ä½œæª¢æŸ¥æ™‚ï¼Œä¹Ÿå¯ä»¥å¾ˆæ¸…æ¥šçœ‹åˆ°æ¯ä¸€å€‹ SQL æ“ä½œ (audit)ï¼Œå¥½è™•æ˜¯ç›¸å°è³‡æ–™é‡å°ã€å¥½é–±è®€ï¼›ç¼ºé»æ˜¯æœ‰äº› statement æ˜¯ undeterminsiticï¼Œä¹Ÿå°±æ˜¯åœ¨ replica ä¸Šé‡æ–°åŸ·è¡Œæœƒæœ‰ä¸åŒçš„çµæœï¼Œä¾‹å¦‚ UUID() / USER() ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œæœ‰è¶£çš„æ˜¯ RAND() / NOW() é€™äº›çœ‹èµ·ä¾†å°±æ˜¯æœƒæœ‰å•é¡Œçš„åè€Œä¸æœƒæœ‰å•é¡Œ&lt;/p>
&lt;h4 id="2-row">2. row&lt;/h4>
&lt;p>ä¸ç´€éŒ„æ¯ä¸€å€‹ SQLï¼Œè€Œæ˜¯æŠŠ SQL æœƒå½±éŸ¿åˆ°çš„æ¬„ä½ä»¥ Row çš„æ ¼å¼ç´€éŒ„ï¼Œä¾‹å¦‚ UPDATE æ›´æ–°äº† 10 ç­†æ¬„ä½å°±ç´€éŒ„ 10 ç­†ï¼Œå¥½è™•æ˜¯é‡æ–°åŸ·è¡Œä¿è­‰çµæœä¸€è‡´ / å£è™•æ˜¯è³‡æ–™é‡å¾ˆå¤§ã€æ ¼å¼ä¸æ˜“é–±è®€éœ€è¦å·¥å…· decodeã€æ²’è¾¦æ³•çœ‹åˆ°åŸå§‹çš„ SQL&lt;/p>
&lt;h4 id="3-mixed">3. mixed&lt;/h4>
&lt;p>çµåˆ statement / row çš„å„ªé»ï¼Œåªæœ‰é‡ä¸Š undeterministic çš„ statement æ‰æœƒç”¨ row ç´€éŒ„ï¼Œé€™ä¹Ÿæ˜¯ RDS é è¨­çš„æ ¼å¼&lt;/p>
&lt;h2 id="å¯¦é©—">å¯¦é©—&lt;/h2>
&lt;p>å®Œæ•´å¯¦é©—å¯ä»¥åƒè€ƒæˆ‘çš„ Repo &lt;a class="link" href="https://github.com/sj82516/play-with-mysql-replication" target="_blank" rel="noopener"
>play-with-mysql-replication&lt;/a>ï¼Œä¸»è¦é©—è­‰äº†&lt;/p>
&lt;ol>
&lt;li>ä¸è¦åœ¨åŒæ­¥çš„è³‡æ–™åº«æ–°å¢è³‡æ–™ï¼Œå¦å‰‡æœƒçµ‚æ­¢åŒæ­¥&lt;/li>
&lt;li>åœ¨éåŒæ­¥çš„è³‡æ–™åº«åšä»»åˆæ“ä½œéƒ½æ²’å•é¡Œ&lt;/li>
&lt;li>åœ¨åŒæ­¥çš„è³‡æ–™åº«ï¼Œå¢åŠ  Indexã€å¢åŠ æ–°çš„æ¬„ä½ã€&lt;code>UPDATE å·²ç¶“åŒæ­¥çš„è³‡æ–™&lt;/code>éƒ½æ²’å•é¡Œ&lt;/li>
&lt;li>å¦‚æœæ˜¯ä¿®æ”¹åŒæ­¥çš„è³‡æ–™åº«æ¬„ä½æ ¼å¼ï¼Œä¾‹å¦‚ varchar(255) =&amp;gt; varchar(200)ï¼Œåœ¨ä¸è¶…éæ¬„ä½å°ºå¯¸ä¸‹ï¼Œstatement åŒæ­¥æ­£å¸¸ã€row ä¸èƒ½åŒæ­¥&lt;/li>
&lt;/ol>
&lt;p>RDS ä¸Šè¡Œç‚ºé¡ä¼¼ï¼Œå·®åˆ¥åœ¨é è¨­å°±ä¸èƒ½æœ‰ Multi Source çš„åŠŸèƒ½&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>ä½¿ç”¨è¨—ç®¡æœå‹™å¦‚ RDS ä»£ç‚ºç®¡ç† MySQL è »æœ‰è¶£çš„ï¼Œå¤§å¹…é™ä½äº†ç®¡ç†çš„éº»ç…©ï¼Œä½†å¦‚æœæœ‰ä»€éº¼åŠŸèƒ½é¢çš„å•é¡Œï¼Œå›æ­¸å·¥å…·æœ¬èº«å»æ¢ç´¢åè€Œå¯ä»¥çœ‹å¾—æ›´å…¨é¢ï¼›&lt;br>
ä¸é RDS é‚„æœ‰è€Œå¤–è·Ÿ Aurora åšçµåˆï¼Œå¯ä»¥è£½ä½œ Aurora Read Replicaï¼Œä¸ç¢ºå®šæœ‰æ²’æœ‰åˆ¥çš„è¡Œç‚ºå·®ç•°ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†ä¾†ç ”ç©¶&lt;/p></description></item><item><title>ä½¿ç”¨ InversifyJS é”åˆ° Iversion of Control æ§åˆ¶åè½‰</title><link>https://yuanchieh.page/posts/2021/2021-09-05-%E4%BD%BF%E7%94%A8-inversifyjs-%E9%81%94%E5%88%B0-iversion-of-control-%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%89/</link><pubDate>Sun, 05 Sep 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-09-05-%E4%BD%BF%E7%94%A8-inversifyjs-%E9%81%94%E5%88%B0-iversion-of-control-%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%89/</guid><description>&lt;p>ä¸€é–‹å§‹å­¸å¯«ç¨‹å¼ï¼Œå¾ˆç¿’æ…£ä¾ç…§åŸ·è¡Œé †åºï¼ŒæŠŠä½å±¤æ¬¡çš„ç‰©ä»¶å¯«æ­»åœ¨é«˜å±¤æ¬¡çš„ç‰©ä»¶ä¸­ï¼Œæ›´ç”šè€…ç›´æ¥è®€å–è³‡æ–™åº«æ²’æœ‰ä»»ä½•çš„æŠ½è±¡åŒ–ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">class&lt;/span> &lt;span class="nx">PaymentService&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orderCollection&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mongoClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">collection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;order&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">s3Service&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">S3Service&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">pay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">orderId&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">order&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orderCollection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">find&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">orderId&lt;/span> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">s3Service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">uploadResult&lt;/span>&lt;span class="p">(....);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯èƒ½æœƒè¦ºå¾—è³‡æ–™åº«ã€é›²ç«¯æœå‹™æœ¬èº«ä¸å¤ªæœƒæœ‰è®Šå‹•ï¼Œæ‰€ä»¥å¯«æ­»æ²’å·®ï¼Œä½†é™¤äº†æœå‹™è¢«ç¶æ­»å¤–ï¼Œå¦ä¸€å€‹é›£é¡Œæ˜¯&lt;code>å¯«æ¸¬è©¦&lt;/code>ï¼Œæ²’è¾¦æ³•å°‡ç¬¬ä¸‰æ–¹æœå‹™ mock å¯«å‡ºä¹¾æ·¨çš„ unit testï¼Œæˆ–æ˜¯å¿…é ˆ mock æ•´å€‹ç¬¬ä¸‰æ–¹ module åœ¨å¯«æ¸¬è©¦å‰å°±å…ˆèŠ±äº†ä¸€å°æ™‚åœ¨ mocking éå¸¸æµªè²»æ™‚é–“&lt;/p>
&lt;p>ç•¶æˆ‘å€‘æŠŠå¤–éƒ¨ç›¸ä¾æŠ½å‡ºä¾†ï¼Œé€éå»ºæ§‹å¼æ³¨å…¥ï¼Œå°±è§£æ±ºäº†ä»¥ä¸Šçš„å•é¡Œï¼Œä½†å¸¶ä¾†çš„æ–°å•é¡Œæ˜¯å‘¼å«æ–¹éœ€è¦èŠ±å¾ˆå¤šæ™‚é–“å…ˆå»ºæ§‹å‡ºéœ€è¦çš„æœå‹™ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">orderStorageService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">OrderStorageService&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">s3Service&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">S3Service&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">paymentService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">PaymentService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">orderStorageService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s3Service&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æ¯ä¸€å€‹ä½¿ç”¨ paymentService çš„åœ°æ–¹ï¼Œéƒ½éœ€è¦æ‰‹å‹•å»ºç«‹ç›¸ä¾çš„æœå‹™ï¼Œå³ä½¿æœ‰ç”¨ Factory Pattern å†å¤šä¸€å±¤æŠ½è±¡åŒ–ï¼Œç®¡ç†èµ·ä¾†ä¹Ÿæ˜¯ååˆ†çš„éº»ç…©&lt;/p>
&lt;p>æ­¤æ™‚å¯ä»¥ç”¨ &lt;a class="link" href="https://github.com/inversify/InversifyJS" target="_blank" rel="noopener"
>InvertifyJS&lt;/a> è§£æ±ºä¾è³´æ³¨å…¥çš„éº»ç…©&lt;/p>
&lt;p>åŸå§‹ç¢¼ &lt;a class="link" href="https://github.com/sj82516/inversify-js-example" target="_blank" rel="noopener"
>sj82516/inversify-js-example&lt;/a>&lt;/p>
&lt;h2 id="éœæ…‹ç›¸ä¾">éœæ…‹ç›¸ä¾&lt;/h2>
&lt;p>InversifyJS æ¦‚å¿µå¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>åˆå§‹åŒ– Containerï¼Œå°‡å¯ä»¥è¢«æ³¨å…¥çš„ Class éƒ½æ‰“ä¸Šæ¨™è¨˜ï¼Œå¯ä»¥æŠŠ Container ç•¶ä½œæ˜¯ Namespace&lt;/li>
&lt;li>åœ¨è¦æ³¨å…¥çš„åœ°æ–¹ï¼Œé€éæ¨™è¨˜æ±ºå®šåˆå§‹åŒ–ä¸¦æ³¨å…¥ç›¸ä¾çš„ Class&lt;/li>
&lt;li>å¦‚æœè¦å‹•æ…‹å–å¾—ç‰©ä»¶ï¼Œå¯ä»¥å¾ Container æ‹¿å–&lt;/li>
&lt;/ol>
&lt;p>è®“æˆ‘å€‘å…ˆçœ‹ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œå‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹ Payment Serviceï¼Œæœƒä¾è³´æ–¼ç¬¬ä¸‰æ–¹ä»˜æ¬¾å¹³å° PaymentGatewayService ä»¥åŠåŸºæœ¬çš„ LogService è’é›† log&lt;/p>
&lt;p>éœæ…‹ç›¸ä¾æ˜¯åªèªª Payment Service åœ¨åˆå§‹åŒ–å°±æ±ºå®šç›¸ä¾çš„ç‰©ä»¶ï¼Œè€Œä¸æœƒå‹•æ…‹çš„æ±ºå®šï¼Œç¬¬ä¸€æ­¥å°‡ LogService æ¨™è¨˜ &lt;code>@injectable&lt;/code>ï¼Œéœ€æ³¨æ„è¦å…ˆå®šç¾© interfaceï¼Œæ¥è‘—æŠŠå¯¦ä½œè¨­å®šç‚º injectableï¼Œè®“æœå‹™ç›¸ä¾æ–¼æŠ½è±¡ä»‹é¢è€Œä¸æ˜¯å¯¦ä½œï¼Œç¬¦åˆ &lt;code>ISP - ä»‹é¢éš”é›¢åŸå‰‡&lt;/code>ï¼Œä¾‹å¦‚èªª LogService å¯¦ä½œä¸Šå¯ä»¥æ˜¯å„²å­˜æ–¼æœ¬åœ°ç«¯æª”æ¡ˆã€ä¸Šå‚³åˆ° Slack ç­‰ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">interface&lt;/span> &lt;span class="nx">LogService&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">void&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">void&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">LogServiceTypes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">slack&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;slack&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">local&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;local&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="nx">type&lt;/span> &lt;span class="nx">LogServiceTypeValueTypes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">LogServiceTypes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">keyof&lt;/span> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">LogServiceTypes&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">@&lt;/span>&lt;span class="nx">injectable&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">LocalLogService&lt;/span> &lt;span class="kr">implements&lt;/span> &lt;span class="nx">LogService&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">static&lt;/span> &lt;span class="nx">NORMAL_FILE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;./normal.log&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">static&lt;/span> &lt;span class="nx">ERROR_FILE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;./error.log&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">fs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">appendFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">LocalLogService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NORMAL_FILE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">fs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">appendFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">LocalLogService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ERROR_FILE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">@&lt;/span>&lt;span class="nx">injectable&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">SlackLogService&lt;/span> &lt;span class="kr">implements&lt;/span> &lt;span class="nx">LogService&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;send log to slack&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;send error log to slack&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>&lt;code>LogServiceTypes&lt;/code> æ˜¯ç‚ºäº†è®“ä½¿ç”¨è€…åœ¨æŒ‡å®š logService æ™‚æœ‰å‹åˆ¥çš„æç¤º&lt;/li>
&lt;li>&lt;code>LogServiceTypeValueTypes&lt;/code> ä¸»è¦æ˜¯ç‚ºäº†æŒ‡å‘ LogServiceTypes çš„ values type&lt;/li>
&lt;/ol>
&lt;p>åœ¨ PaymentGatewayService åšé¡ä¼¼çš„äº‹æƒ…ï¼Œæ¥è‘—å®šç¾©æˆ‘å€‘ PaymentService&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="err">@&lt;/span>&lt;span class="nx">injectable&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">StaticPaymentService&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">@&lt;/span>&lt;span class="nx">inject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;slackLog&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">private&lt;/span> &lt;span class="nx">logService&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">LogService&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">@&lt;/span>&lt;span class="nx">inject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;stripePaymentGateway&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">private&lt;/span> &lt;span class="nx">paymentGatewayService&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">PaymentGatewayService&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">order&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Order&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="k">void&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">totalFee&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">paymentGatewayService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">totalFee&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">order&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">totalFee&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">balance&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> doesn&amp;#39;t have enough money`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> paid &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">totalFee&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">paymentGatewayService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">generateLink&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">totalFee&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡é»åœ¨ constructor ä¸­ä¸»å‹•å®£å‘Šäº†ç›¸ä¾çš„ç‰©ä»¶ï¼Œé€™é‚Šæˆ‘å€‘æŒ‡å®šè¦æ³¨å…¥ &lt;code>slackLog&lt;/code>ã€&lt;code>stripePaymentGateway&lt;/code>&lt;/p>
&lt;p>æœ€å¾Œæ˜¯å®šç¾©é€™äº›è³‡æºçš„åœ°æ–¹ &lt;code>invertify.config.ts&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">paymentServiceContainer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Container&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">LogService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;localLog&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">LocalLogService&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">LogService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;slackLog&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">SlackLogService&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">StaticPaymentService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;staticPaymentService&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">StaticPaymentService&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">StripePaymentGatewayService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;stripePaymentGateway&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">StripePaymentGatewayService&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">PaypalPaymentGatewayService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;paypalPaymentGateway&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">PaypalPaymentGatewayService&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘å€‘å®šç¾©ä¸€å€‹ paymentServiceContainerï¼Œæ¥è‘—å°‡ç‰©ä»¶éƒ½è¨»å†Šåˆ° Container ä¹‹ä¸­ï¼Œæ–¹ä¾¿å¾ŒçºŒçš„èª¿ç”¨ï¼Œä¸Šä¸€æ­¥ inject() çš„åç¨± &lt;code>slackLog&lt;/code> å°±æ˜¯åœ¨é€™é‚Šå®šç¾©ï¼Œå¯ä»¥è‡ªç”±æ›¿æ›ï¼Œåªè¦å–®å€‹ Container ä¸­ä¸é‡è¤‡å°±å¥½&lt;/p>
&lt;p>æœ€å¾Œæ˜¯ PaymentService çš„åˆå§‹åŒ–èˆ‡èª¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">staticPaymentService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">StaticPaymentService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;staticPaymentService&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">staticPaymentService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">order&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="é€™æ¨£å°±å®Œæˆäº†">é€™æ¨£å°±å®Œæˆäº†&lt;/h2>
&lt;h3 id="å°çµ">å°çµ&lt;/h3>
&lt;p>é€éä»¥ä¸Šçš„æ¡ˆä¾‹ï¼Œå¯ä»¥ç™¼ç¾ InvertifyJS åšçš„äº‹æƒ…ä¹Ÿä¸è¤‡é›œï¼Œè®“é–‹ç™¼è€…é¡¯å¼çš„è¨»å†Šå°æ‡‰çš„ç‰©ä»¶èˆ‡å…¶ä»‹é¢ï¼Œæ¥è‘—åœ¨éœ€è¦æ³¨å…¥çš„åœ°æ–¹ç›´æ¥ç”¨è¨»å†Šåç¨±å‘¼å«ï¼Œå¦‚æœéœ€è¦å‹•æ…‹åˆå§‹åŒ–ç‰©ä»¶èˆ‡å…¶ç›¸ä¾çš„æœå‹™ä½¿ç”¨ &lt;code>container.get(&amp;quot;name&amp;quot;)&lt;/code> å³å¯&lt;/p>
&lt;p>è®“å‘¼å«ç«¯è¦åšçš„å·¥ä½œå°‘äº†éå¸¸å¤š&lt;/p>
&lt;h2 id="å‹•æ…‹ç›¸ä¾">å‹•æ…‹ç›¸ä¾&lt;/h2>
&lt;p>å¦‚æœæˆ‘å€‘å¸Œæœ›å‹•æ…‹ä¸€äº›ï¼Œåœ¨åˆå§‹åŒ–æ™‚æ‰æ±ºå®šè¦é¸æ“‡ï¼Œå¯ä»¥æ¡ç”¨å·¥å» æ¨¡å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">DynamicPaymentService&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">private&lt;/span> &lt;span class="nx">logService&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">LogService&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">private&lt;/span> &lt;span class="nx">paymentGatewayService&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">PaymentGatewayService&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">order&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Order&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="k">void&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘å€‘ä¸ç”¨åœ¨å®£å‘Šçš„åœ°æ–¹åŠ ä¸Š Injectableï¼Œè€Œæ˜¯é€é Container å»ºç«‹ Factor&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">PaymentGatewayService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;PaymentGatewayService&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">StripePaymentGatewayService&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">whenTargetNamed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;stripe&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">PaymentGatewayService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;PaymentGatewayService&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">PaypalPaymentGatewayService&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">whenTargetNamed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;paypal&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">type&lt;/span> &lt;span class="nx">PaymentServiceFatory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">logType&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">LogServiceTypeValueTypes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">paymentPlatform&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">DynamicPaymentService&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">PaymentServiceFatory&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;DynamicPaymentService&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">toFactory&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">DynamicPaymentService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">interfaces&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">logType&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">paymentPlatform&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">paymentGatewayService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getNamed&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">PaymentGatewayService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;PaymentGatewayService&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">paymentPlatform&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">logService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">LogService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logType&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">DynamicPaymentService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">paymentGatewayService&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çœ‹èµ·ä¾†æœ‰é»åš‡äººï¼Œåˆ†æˆå¹¾æ®µ&lt;/p>
&lt;ol>
&lt;li>&lt;code>&amp;lt;(logType: symbol, paymentPlatform: string) =&amp;gt; DynamicPaymentService&amp;gt;&lt;/code> bind è£é¢æ”¾çš„æ˜¯å›å‚³çš„å‹åˆ¥ï¼Œæˆ‘å€‘çš„ Factor æ˜¯æœ‰å…©å€‹åƒæ•¸ logType / paymentPlatform ä¸¦ä¸”å›å‚³ DynamicPaymentService çš„å‡½å¼&lt;/li>
&lt;li>&lt;code>(&amp;quot;DynamicPaymentService&amp;quot;)&lt;/code> åœ¨ Container ä»–å°æ‡‰çš„åç¨±æ˜¯ &amp;ldquo;DynamicPaymentService&amp;rdquo;ï¼Œå¯ä»¥ç”¨ Stringï¼Œæ›´è¬¹æ…å¯ä»¥ç”¨ Symbol&lt;/li>
&lt;li>&lt;code>.toFactory&amp;lt;DynamicPaymentService&amp;gt;&lt;/code> å®šç¾© Factory å›å‚³ DynamicPaymentService å‹åˆ¥çš„ç‰©ä»¶&lt;/li>
&lt;li>&lt;code>(context: interfaces.Context) =&amp;gt; {}&lt;/code> é€éç•¶å‰ä¸Šä¸‹æ–‡å–å¾—ç›¸é—œè³‡è¨Šï¼Œä¸¦è¿”å›å¯¦éš› Factory å‡½å¼çš„å¯¦ä½œ&lt;/li>
&lt;li>ç‚ºäº†æ›´æ–¹ä¾¿å–å¾—å°æ‡‰çš„æœå‹™ï¼Œå¯ä»¥åŠ ä¸Š &lt;code>whenTargetNamed&lt;/code> ç›´æ¥æŒ‡å®šåç¨±&lt;/li>
&lt;/ol>
&lt;p>æœ€å¾Œä½¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">factory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">paymentServiceContainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">PaymentServiceFatory&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;DynamicPaymentService&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">paymentService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">factory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">LogServiceTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">slack&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;paypal&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">paymentService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">order&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>Inversify é‚„æœ‰å…¶ä»–æœ‰è¶£çš„åŠŸèƒ½ï¼ŒåŒ…å«ä½¿ç”¨ tag / å®šç¾© middleware ç­‰ç­‰ï¼Œæ•´é«”çœ‹èµ·ä¾†æ˜¯å€‹æ“´å……æ€§éå¸¸è‰¯å¥½çš„è¨­è¨ˆï¼Œæœ‰æ©Ÿæœƒå†ä¾†ç ”ç©¶å…§éƒ¨çš„å¯¦ä½œ&lt;/p></description></item><item><title>Nodejs / Ruby / Golang å¥—ä»¶ç‰ˆæœ¬ç®¡ç†å·®ç•°ï¼šæ¯”å° NPM èˆ‡ Bundler</title><link>https://yuanchieh.page/posts/2021/2021-07-10-nodejs-/-ruby-/-golang-%E5%A5%97%E4%BB%B6%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%AE%E7%95%B0%E6%AF%94%E5%B0%8D-npm-%E8%88%87-bundler/</link><pubDate>Sat, 10 Jul 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-07-10-nodejs-/-ruby-/-golang-%E5%A5%97%E4%BB%B6%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%AE%E7%95%B0%E6%AF%94%E5%B0%8D-npm-%E8%88%87-bundler/</guid><description>&lt;p>é–‹ç™¼ä¸Šç‚ºäº†æ–¹ä¾¿ï¼Œå¸¸å¸¸ä½¿ç”¨åˆ¥äººé–‹ç™¼å¥½çš„å¥—ä»¶ï¼Œä½†æ˜¯æœ€è¿‘é‡åˆ°å¹¾æ¬¡è¡çªï¼Œç™¼ç¾å¥—ä»¶çš„ç‰ˆæœ¬ç®¡ç†æ²’æœ‰æƒ³åƒä¸­ç°¡å–®ï¼Œä»¥ä¸‹å°‡é‡æ¸… npm / gem+bundler åœ¨å¥—ä»¶çš„&lt;/p>
&lt;ol>
&lt;li>å®‰è£&lt;/li>
&lt;li>è¼‰å…¥æ–¹å¼&lt;/li>
&lt;li>å­å¥—ä»¶çš„ç‰ˆæœ¬è¡çª
åšæ›´æ·±å…¥çš„äº†è§£èˆ‡æ¯”å°&lt;/li>
&lt;/ol>
&lt;p>å¯¦é©—æ–¹å¼æœƒæº–å‚™ test_module_1 / test_module_2ï¼Œåˆ†åˆ¥ä½¿ç”¨ depend_module version 1 / version 2ï¼Œæœ€å¾ŒåŒæ™‚ä½¿ç”¨ test_module_1 &amp;amp; 2&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="k">-&lt;/span> test_module_1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- depend_module@1.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">-&lt;/span> test_module_2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- depend_module@2.0.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>TLDRï¼›NPM å¯ä»¥åœ¨ä¸åŒæ¨¡çµ„å¼•ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼›è€Œ Gem ä¸è¡Œï¼›Golang å¯ä»¥é€é replace æŒ‡å®šå¤šå€‹ç‰ˆæœ¬&lt;/p>
&lt;/blockquote>
&lt;h2 id="npm">NPM&lt;/h2>
&lt;h3 id="npm-install">NPM install&lt;/h3>
&lt;p>ç¯€éŒ„ NPM 7.x &lt;a class="link" href="https://docs.npmjs.com/cli/v7/commands/npm-install" target="_blank" rel="noopener"
>npm-install å®˜æ–¹æ–‡ä»¶&lt;/a>éƒ¨åˆ†å…§å®¹&lt;/p>
&lt;p>&lt;code>$npm install&lt;/code> ä¸»è¦æ˜¯å”åŠ©å®‰è£ package æ‰€ç›¸ä¾çš„ packagesï¼Œæ‰€è¬‚çš„ package æ˜¯&lt;/p>
&lt;ol>
&lt;li>è³‡æ–™å¤¾ä¸­æœ‰ package.json&lt;/li>
&lt;li>gzip å£“ç¸®çš„ tar æª” (1)ï¼Œä¹Ÿå°±æ˜¯æŠŠæœ‰ package.json çš„è³‡æ–™å¤¾å£“ç¸®&lt;/li>
&lt;li>æŒ‡å‘ (2) çš„ urlï¼Œä¾‹å¦‚ &lt;code>$npm install https://github.com/indexzero/forever/tarball/v0.5.6&lt;/code>&lt;/li>
&lt;li>æŒ‡å‘ (1) çš„ git remote url&lt;/li>
&lt;li>è¢«ç™¼ä½ˆåˆ° registry çš„ (3)ï¼Œä¾‹å¦‚ &lt;code>npm install git+ssh://git@github.com:npm/cli#semver:^5.0&lt;/code>
ç­‰&lt;/li>
&lt;/ol>
&lt;p>åœ¨ package è·¯å¾‘ä¸‹åŸ·è¡Œ $npm installï¼Œå‰‡æœƒå®‰è£ packages åœ¨ node_modules ä¸­ï¼›&lt;code>-g&lt;/code> æœƒå®‰è£åˆ° global ç’°å¢ƒä¸‹ï¼›&lt;code>--production&lt;/code> å‰‡ä¸æœƒå®‰è£ devDependencies ä¸‹çš„ package&lt;/p>
&lt;p>å¦‚æœè¦å®‰è£åŒä¸€å€‹ package ä¸åŒç‰ˆæœ¬ä¸¦åŒæ™‚ä½¿ç”¨ï¼Œåœ¨ npm 6.9.0 ä»¥å¾Œå¯ä»¥ç”¨ alias&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">npm install jquery2@npm:jquery@2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm install jquery3@npm:jquery@3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¼‰å…¥-nodejs-require">è¼‰å…¥ Nodejs require&lt;/h3>
&lt;p>ç¯€éŒ„è‡ª Nodejs v16.4.2 &lt;a class="link" href="https://nodejs.org/api/modules.html#modules_loading_from_node_modules_folders" target="_blank" rel="noopener"
>Modules: CommonJS modules&lt;/a>ï¼Œé€™é‚Šå…ˆæ¢è¨ Commonjs Module è€Œä¸æ˜¯ ESM&lt;/p>
&lt;p>åœ¨ Nodejs ä¸­ï¼Œ&lt;code>æ¯ä¸€å€‹ file å°±æ˜¯ä¸€å€‹ç¨ç«‹çš„ module&lt;/code>ï¼Œå¯ä»¥é€é require ä¾†å¼•å…¥ï¼Œç•¶ require(X) åœ¨ Path Y ä¸‹ç™¼ç”Ÿæ™‚ï¼Œæœƒå˜—è©¦ä»¥ä¸‹æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>å¦‚æœ X æ˜¯ core moduleï¼Œå‰‡è¿”å› core module ä¸¦çµæŸ&lt;/li>
&lt;li>å¦‚æœ X æ˜¯ / é–‹é ­ï¼Œå‰‡å°‡ Y è¨­å®šç‚º filesystem root (æ²’ç”¨é)&lt;/li>
&lt;li>å¦‚æœ X æ˜¯ ./ã€ ../ ã€ / é–‹é ­ï¼Œå‰‡å˜—è©¦è¼‰å…¥å°æ‡‰è·¯å¾‘çš„æª”æ¡ˆæˆ–è³‡æ–™å¤¾&lt;/li>
&lt;li>å¦‚æœ X æ˜¯ # é–‹é ­ï¼Œå‰‡å¾€ä¸Šå±¤æ‰¾åˆ°æœ€è¿‘æœ‰ package.json çš„åœ°æ–¹ (ç¨±ç‚º scope)ï¼Œä¸¦èµ° ESM è¼‰å…¥æ–¹å¼&lt;/li>
&lt;li>æ‰¾åˆ° scopeï¼Œæ¯”å° package.json ä¸­å®šç¾©ï¼Œçœ‹æ˜¯ä¸æ˜¯è¦è¼‰å…¥è‡ªå·±&lt;/li>
&lt;li>ä¸æ–·åœ°å¾€ä¸Šä¸€å±¤è·¯å¾‘æ‰¾åˆ° node_modulesï¼Œä¸¦æŸ¥è©¢æœ‰æ²’æœ‰å°æ‡‰çš„ package&lt;/li>
&lt;/ol>
&lt;p>å¯¦éš›è¼‰å…¥çš„éç¨‹æŒºè¤‡é›œçš„ï¼Œåªè¦è¼‰å…¥ä¸€æ¬¡å¾Œ package å°±æœƒè¢« cache èµ·ä¾†ï¼Œå¯ä»¥å¾ &lt;code>require.cache&lt;/code> ä¸­çœ‹åˆ°è¢« cache çš„ç‹€æ³ï¼Œæ‰€ä»¥å¦‚æœä¸€å€‹å¥—ä»¶è¢«å¤šå€‹å¥—ä»¶å¼•ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½å› ç‚º cache è€Œå°è‡´æŸäº›å¥—ä»¶ä½¿ç”¨éŒ¯èª¤çš„ç‰ˆæœ¬å—ï¼Ÿ
çœ‹èµ·ä¾†æ˜¯ä¸æœƒçš„ï¼Œå› ç‚ºæ–‡ä»¶æåˆ° module cache æ˜¯åŸºæ–¼ä»–å€‘è¢«è§£æçš„ filenameï¼Œå› æ­¤ä¸åŒç‰ˆæœ¬çš„ package æœƒå®‰è£åœ¨ä¸åŒçš„ node_modules ä¸‹ï¼Œæ‰€ä»¥è§£æçš„ filename è‡ªç„¶ä¹Ÿä¸åŒ&lt;/p>
&lt;blockquote>
&lt;p>Modules are cached based on their resolved filename. Since modules may resolve to a different filename based on the location of the calling module (loading from node_modules folders), it is not a guarantee that require(&amp;lsquo;foo&amp;rsquo;) will always return the exact same object, if it would resolve to different files.&lt;/p>
&lt;/blockquote>
&lt;h3 id="ç‰ˆæœ¬å¯¦é©—">ç‰ˆæœ¬å¯¦é©—&lt;/h3>
&lt;p>æœ¬åœ°ç«¯ä½¿ç”¨ &lt;a class="link" href="mailto:Nodejs@14.15.4" >Nodejs@14.15.4&lt;/a> / &lt;a class="link" href="mailto:NPM@6.14.0" >NPM@6.14.0&lt;/a>ï¼Œæˆ‘ç™¼ä½ˆäº†&lt;/p>
&lt;ol>
&lt;li>depend_module 1.0.0 / 2.0.0&lt;/li>
&lt;li>yuan_test_module_1 require depend_module@1&lt;/li>
&lt;li>yuan_test_module_2 require depend_module@2&lt;br>
æœ€å¾Œ&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;yuan_test_module_1&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;yuan_test_module_2&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;require tow modules&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">require&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-----&lt;/span> &lt;span class="nx">è¼¸å‡º&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">depend_module&lt;/span> &lt;span class="nx">version&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">test_module_1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">depend_module&lt;/span> &lt;span class="nx">version&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">test_module_2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">require&lt;/span> &lt;span class="nx">tow&lt;/span> &lt;span class="nx">modules&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;/Users/zhengyuanjie/Desktop/package/test/index.js&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/yuan_test_module_1/index.js&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/depend_module/index.js&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/yuan_test_module_2/index.js&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;/Users/zhengyuanjie/Desktop/package/test/node_modules/yuan_test_module_2/node_modules/depend_module/index.js&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‡ºä¹æˆ‘æ„æ–™ä¹‹å¤–ï¼Œnode_modules çš„çµæ§‹æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">|- node_modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- depend_module (version 1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- yuan_test_module_1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- yuan_test_module_2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- node_modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |- depend_module (version 2)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘æ²’æœ‰é æœŸç¬¬ä¸€å±¤çµæ§‹ä¸­æœƒæœ‰ depend_moduleï¼Œä»¥ç‚ºéƒ½æœƒæ˜¯åœ¨å€‹åˆ¥çš„ test_module ä¸‹ï¼Œå†å›ä¾†çœ‹ npm æ–‡ä»¶èªªæ˜&lt;/p>
&lt;ol>
&lt;li>package{dep} structure: A{B,C}, B{C}, C{D}ï¼Œæ²’æœ‰ç‰ˆæœ¬è¡çªï¼Œå‰‡é è¨­éƒ½å®‰è£åœ¨æœ€ä¸Šå±¤&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-- B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-- C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-- D
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>A{B,C}, B{C,D@1}, C{D@2}ï¼ŒD@1 å®‰è£åœ¨æœ€ä¸Šå±¤ï¼ŒD@2 å‰‡å®‰è£åœ¨ C ä¸‹é¢&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-- B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-- C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> `-- D@2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-- D@1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£å¯ä»¥åšåˆ°é è¨­å…±äº«ç›¸åŒç‰ˆæœ¬çš„ module é¿å…é‡è¤‡ä¸‹è¼‰ï¼Œå»ä¹Ÿä¸ç”¨æ“”å¿ƒå¤šå€‹ç‰ˆæœ¬è¡çªçš„å•é¡Œ&lt;/p>
&lt;h3 id="ç’°ç‹€ç›¸ä¾">ç’°ç‹€ç›¸ä¾&lt;/h3>
&lt;p>å¦‚æœ package A require package B è€Œ package B åˆ require package Aï¼Œè®Šæˆç’°ç‹€ç›¸ä¾çš„æƒ…æ³ï¼Œåœ¨ Nodejs ä¸­é€™æ¨£ä¸æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œåªæ˜¯è¡Œç‚ºå¯èƒ½ä¸å¦‚é æœŸ&lt;/p>
&lt;p>å®˜ç¶²çš„æ¡ˆä¾‹ä¸­&lt;/p>
&lt;ol>
&lt;li>main.js require a.js / b.jsï¼Œå› ç‚º a.js å…ˆè¢« require å‰‡å…ˆè¢«è¼‰å…¥&lt;/li>
&lt;li>åœ¨ a.js ä¸­ï¼ŒåŸ·è¡Œåˆ° require b.jsï¼Œå‰‡é–‹å§‹è¼‰å…¥ b.js&lt;/li>
&lt;li>åœ¨ b.js ä¸­ï¼ŒåŸ·è¡Œåˆ° require a.jsï¼Œå‰‡ç‚ºäº†é¿å…ç„¡é™è¿´åœˆï¼Œæ­¤æ™‚æœƒå›å‚³&lt;code>æ­¥é©Ÿ(2)è¼‰å…¥åˆ°ä¸€åŠçš„ a.js&lt;/code>ï¼Œæ¥è‘—ç¹¼çºŒå®Œæˆ b.js è¼‰å…¥&lt;/li>
&lt;li>å›åˆ° a.jsï¼Œæ­¤æ™‚çš„ b.js å¼•ç”¨æ˜¯å®Œæ•´çš„ï¼Œç¹¼çºŒè¼‰å…¥ a.js&lt;/li>
&lt;li>å›åˆ° main.js ä¸­ï¼Œæ­¤æ™‚åœ¨ main.js ä¸­ a.js / b.js éƒ½æ˜¯å®Œæ•´çš„å¼•ç”¨&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">$&lt;/span> &lt;span class="nx">node&lt;/span> &lt;span class="nx">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">js&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">main&lt;/span> &lt;span class="nx">starting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">a&lt;/span> &lt;span class="nx">starting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span> &lt;span class="nx">starting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">in&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span> &lt;span class="nx">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">in&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">a&lt;/span> &lt;span class="nx">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">in&lt;/span> &lt;span class="nx">main&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="gem--bundler">Gem / Bundler&lt;/h2>
&lt;p>æ¥è‘—ä¾†çœ‹ Ruby ç”Ÿæ…‹å¦‚ä½•ç”¨ Gem Bundler ç®¡ç†å¥—ä»¶ï¼Œä»¥ä¸‹å…§å®¹ä¸»è¦åƒè€ƒ &lt;a class="link" href="https://www.honeybadger.io/blog/rbenv-rubygems-bundler-path/" target="_blank" rel="noopener"
>Understanding How Rbenv, RubyGems And Bundler Work Together&lt;/a>ï¼Œé¦–å…ˆå…ˆå®‰è£ rbenvï¼Œç”¨æ–¼ç®¡ç†ä¸»æ©Ÿä¸Šå¤šå€‹ Ruby ç‰ˆæœ¬&lt;/p>
&lt;p>RubyGem åœ¨ Ruby 1.9 å¾Œå°±æ•´åˆäº†ï¼Œgem å®‰è£è·¯å¾‘å¯ä»¥é€é &lt;code>$gem env&lt;/code> ä¸­çš„ &amp;ldquo;INSTALLATION DIRECTORY&amp;rdquo; è·¯å¾‘ï¼Œä¸åŒç‰ˆæœ¬æœ‰è¢«åˆ†é–‹ä¸åŒçš„è·¯å¾‘å®‰è£ï¼Œä½†ä¸åƒ npm æœƒåœ¨æ¯å€‹å°ˆæ¡ˆä¸‹éƒ½æœ‰ç¨ç«‹çš„ node_modules&lt;/p>
&lt;h3 id="è¼‰å…¥">è¼‰å…¥&lt;/h3>
&lt;p>æœ‰ä¸‰ç¨®æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>load:&lt;br>
é¡ä¼¼æ–¼ requireï¼Œä½†æœƒé‡è¤‡è¼‰å…¥&lt;/li>
&lt;li>require:&lt;br>
åˆ° $LOAD_PATH ä¸‹æª¢æŸ¥æ˜¯å¦æœ‰è¼‰å…¥å°æ‡‰çš„ gemï¼Œæ²’æœ‰å‰‡å»ç³»çµ±å®‰è£è·¯å¾‘è¼‰å…¥ gem ä¸‹çš„ libï¼Œä¸¦åŠ åˆ° $LOAD_PATH ä¸­ï¼Œè©³è¦‹é¾å“¥çš„ &lt;a class="link" href="https://kaochenlong.com/2016/05/01/require/" target="_blank" rel="noopener"
>Ruby èªæ³•æ”¾å¤§é¡ä¹‹ã€Œä½ çŸ¥é“ require å¹«ä½ åšäº†ä»€éº¼äº‹å—?ã€&lt;/a>&lt;/li>
&lt;li>require_relative:&lt;br>
æ¥å—ç›¸å°è·¯å¾‘è¼‰å…¥&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥ RubyGem ç®¡ç†ç›¸ç•¶å–®ç´”ï¼ŒæŠŠ Gem éƒ½å®‰è£åœ¨çµ±ä¸€çš„å®‰è£è·¯å¾‘ä¸‹&lt;/p>
&lt;h3 id="bundler">Bundler&lt;/h3>
&lt;p>Bundler è² è²¬å¹¾é …å·¥ä½œ&lt;/p>
&lt;ol>
&lt;li>è®€å– Gemfile ä¸¦å®‰è£å°æ‡‰é©åˆçš„ç‰ˆæœ¬&lt;/li>
&lt;li>ç”¢ç”Ÿ Gemfile.lock ç¢ºä¿åœ¨ä¸åŒç’°å¢ƒä¸‹é‚„åŸæ™‚ç‰ˆæœ¬ä¸€è‡´&lt;/li>
&lt;li>å› ç‚ºä¸èƒ½è¼‰å…¥å¤šç‰ˆæœ¬ï¼Œæ‰€ä»¥ Bundler æœƒåœ¨æ‰€æœ‰ç‰ˆè™Ÿä¸­æ‰¾åˆ°é©åˆçš„ï¼Œä¾‹å¦‚ module_a éœ€è¦ module_c &amp;gt; 1.0.0ï¼Œè€Œ module_b éœ€è¦ module_c &amp;lt;=1.1.0ï¼Œå‰‡æœ€å¾Œæœƒå®‰è£ &lt;a class="link" href="mailto:module_c@1.1.0" >module_c@1.1.0&lt;/a> ç¬¦åˆå…©è€…éœ€æ±‚&lt;/li>
&lt;/ol>
&lt;h3 id="å¯¦é©—">å¯¦é©—&lt;/h3>
&lt;p>å¯¦é©—æ–¹å¼ç›¸åŒï¼Œä½†æ˜¯ç™¼ç¾ Ruby ä¸èƒ½è¼‰å…¥å¤šå€‹ç‰ˆæœ¬ï¼Œæœƒå‡ºç¾&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">`raise_if_conflicts&amp;#39;: Unable to activate yuan_test_gem_2-2.0.0, because depend_gem-1.0.0 conflicts with depend_gem (= 2.0.0) (Gem::ConflictError)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ Bundler æœƒå› ç‚ºæ‰¾ä¸åˆ°é©åˆç‰ˆæœ¬è€Œæ‹‹éŒ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">There was an error parsing &lt;span class="sb">`Gemfile`&lt;/span>: You cannot specify the same gem twice with different version requirements.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">You specified: depend_gem (~&amp;gt; 1.0) and depend_gem (~&amp;gt; 2.0). Bundler cannot continue.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="golang-mod">Golang mod&lt;/h2>
&lt;p>åƒè€ƒ&lt;a class="link" href="https://www.percona.com/blog/2020/03/09/using-different-versions-of-a-package-in-an-application-via-go-modules/" target="_blank" rel="noopener"
>Using Different Versions of a Package in an Application via Go Modules&lt;/a>ï¼ŒGolang å¯ä»¥åœ¨ mod file ä¸­æŒ‡å®š &lt;code>replace&lt;/code>ï¼Œå°±å¯ä»¥åœ¨ç¨‹å¼ä¸­ä½¿ç”¨å¤šå€‹ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘è‡ªå·±çš„ forkï¼Œç›¸ç•¶çš„æ–¹ä¾¿ï¼Œ&lt;a class="link" href="https://golang.org/doc/modules/managing-dependencies#external_fork" target="_blank" rel="noopener"
>å®˜æ–¹æ–‡ä»¶ï¼šRequiring external module code from your own repository fork&lt;/a>&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>æ¯”å°ä¸åŒçš„å¯¦ä½œè »æœ‰è¶£ï¼Œç›®å‰çœ‹ä¾† npm æœƒ install åœ¨ç•¶ä¸‹è·¯å¾‘ï¼Œæ›ä¾†å¥½è™•æ˜¯å¯ä»¥è¼‰å…¥å¤šå€‹ç‰ˆæœ¬çš„ç›¸åŒæ¨¡çµ„ï¼›è€Œ gem æ²’æœ‰é€™æ¨£çš„å½ˆæ€§
è‡³æ–¼&lt;code>è¼‰å…¥å¤šç‰ˆæœ¬çš„ç›¸åŒæ¨¡çµ„&lt;/code>æˆ‘è¦ºå¾—æ˜¯è »ç¾ä»£çš„éœ€æ±‚ï¼Œä¸ç¢ºå®šç‚ºä»€éº¼ Ruby / Gem æ²’æœ‰æä¾›é€™æ¨£çš„ç‰¹æ€§ï¼ŒèƒŒå¾Œçš„è„ˆçµ¡ä¸çŸ¥æ˜¯å¦‚ä½•è€ƒé‡&lt;/p></description></item><item><title>AWS Aurora æ¶æ§‹ç ”ç©¶ä»¥åŠèˆ‡è‡ªé§• MySQL çš„å·®ç•°</title><link>https://yuanchieh.page/posts/2021/2021-07-02-aws-aurora-%E6%9E%B6%E6%A7%8B%E7%A0%94%E7%A9%B6%E4%BB%A5%E5%8F%8A%E8%88%87%E8%87%AA%E9%A7%95-mysql-%E7%9A%84%E5%B7%AE%E7%95%B0/</link><pubDate>Fri, 02 Jul 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-07-02-aws-aurora-%E6%9E%B6%E6%A7%8B%E7%A0%94%E7%A9%B6%E4%BB%A5%E5%8F%8A%E8%88%87%E8%87%AA%E9%A7%95-mysql-%E7%9A%84%E5%B7%AE%E7%95%B0/</guid><description>&lt;p>å…¬å¸ä½¿ç”¨ MySQLï¼Œè¿‘æ—¥é‡åˆ°ä¸€äº›è®€å–çš„ç“¶é ¸ï¼Œæœ‰äº†ä½¿ç”¨ AWS Aurora çš„è¨è«–ï¼Œå‰›å¥½ä¸Šä¸€é€±çœ‹åˆ° &lt;a class="link" href="https://plaid.com/blog/exploring-performance-differences-between-amazon-aurora-and-vanilla-mysql" target="_blank" rel="noopener"
>Exploring performance differences between Amazon Aurora and vanilla MySQL&lt;/a> æ‰èµ«ç„¶ç™¼ç¾ AWS Aurora åº•å±¤å„²å­˜æ¶æ§‹æœƒå½±éŸ¿ä½¿ç”¨å ´æ™¯ï¼Œè·Ÿé æœŸçš„è‡ªé§• MySQL æ­é… Replica æœ‰ä¸åŒçš„æ•ˆæœ&lt;/p>
&lt;p>ä»¥ä¸‹é€™ç¯‡å°‡æ¢è¨&lt;/p>
&lt;ol>
&lt;li>MySQL å„²å­˜çš„åŸºæœ¬åŸç†&lt;/li>
&lt;li>Aurora çš„å„²å­˜æ¶æ§‹&lt;/li>
&lt;/ol>
&lt;p>è³‡æ–™æºè‡ªæ–¼&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://plaid.com/blog/exploring-performance-differences-between-amazon-aurora-and-vanilla-mysql" target="_blank" rel="noopener"
>Exploring performance differences between Amazon Aurora and vanilla MySQL&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.amazon.science/publications/amazon-aurora-design-considerations-for-high-throughput-cloud-native-relational-databases" target="_blank" rel="noopener"
>Amazon Aurora: Design Considerations for High Throughput Cloud-native Relational Databases&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="mysql-å„²å­˜çš„åŸºæœ¬åŸç†">MySQL å„²å­˜çš„åŸºæœ¬åŸç†&lt;/h2>
&lt;p>é—œè¯å¼è³‡æ–™åº«æœ€åŸºæœ¬è¦ä¿éšœ ACIDï¼Œå…¶ä¸­ Durability æ˜¯æœ€åŸºæœ¬çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¿è­‰å¯«å…¥æˆåŠŸçš„è³‡æ–™ä¸æœƒå› ç‚ºç³»çµ± crash ç­‰å•é¡Œè€Œéºå¤±ï¼Œåœ¨ MySQL å¯«å…¥çš„æµç¨‹å¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>å°‡æ›´æ–°å¯«å…¥ Redo Log buffer (WAL)ï¼Œç­‰å¾… commit ç¢ºå®šå°±åˆ·æ–°åˆ°ç¡¬ç¢Ÿä¿å­˜ç´€éŒ„é¿å…éºå¤±è³‡æ–™&lt;/li>
&lt;li>å¦‚æœè³‡æ–™æœ‰è¢«è®€å–åˆ° memory ä¸­ï¼Œå‰‡æ›´æ–° Page å…§å®¹ä¸¦æ¨™è¨˜ç‚º dirty&lt;/li>
&lt;li>èƒŒæ™¯é‹è¡Œçš„ç¨‹åºåœ¨ checkpoint æ™‚æ©Ÿè§¸ç™¼æ™‚å°‡ dirty page èˆ‡ redo log çš„å…§å®¹æ›´æ–°æ–¼ç¡¬ç¢Ÿä¸Šçš„ data file&lt;/li>
&lt;/ol>
&lt;p>å…¶ä¸­æœ‰å¹¾å€‹ç›®çš„&lt;/p>
&lt;ol>
&lt;li>æ¸›å°‘ disk I/O ä¸¦ä¿éšœé€£çºŒæ€§å¯«å…¥ï¼š&lt;br>
å¦‚æœæ¯ä¸€ç­†è³‡æ–™é€²ä¾†å°±é¦¬ä¸Šæ›´æ–°ç¡¬ç¢Ÿä¸Šçš„å„²å­˜ï¼Œé€™æœƒæ‹–å® DB æ•ˆèƒ½ï¼Œæ‰€ä»¥ MySQL è®€å¯«æ™‚æ˜¯ä»¥ &lt;code>page&lt;/code> ç‚ºå–®ä½ï¼Œå¦‚æœç™¼ç¾æ›´æ–°çš„ page åœ¨è¨˜æ†¶é«”ä¸­æœƒæ¨™è¨˜ç‚º dirty pageï¼Œå¾ŒçºŒå† checkpoint çµ±ä¸€æ›´æ–°åˆ°ç¡¬ç¢Ÿä¸­&lt;/li>
&lt;li>Redo Log é¿å…ç³»çµ± Crash è€Œè³‡æ–™éºå¤±ï¼š&lt;br>
ç‚ºäº†é¿å…è³‡æ–™éºå¤±ï¼Œæ‰€ä»¥æœƒå…ˆå¯«å…¥ Redo Logï¼Œæ‰€ä»¥åˆç¨±ä½œ Write Ahead Log å…ˆå¯«å…¥ log å†æ“ä½œï¼ŒRedo Log æ˜¯ä¸€å€‹é †åºæ€§æŒçºŒå¯«å…¥çš„ Logï¼Œæ‰€ä»¥å¯«å…¥æ•ˆèƒ½æ¯”éš¨æ©Ÿæ€§æ›´æ–°é‚„è¦å¥½ï¼Œç•¶ç³»çµ± crash å¾Œï¼Œæœƒä¾†æª¢æŸ¥ Redo Log ä¸­æ˜¯å¦å­˜åœ¨æ²’æœ‰æ›´æ–°åˆ°è³‡æ–™åº«ç¡¬ç¢Ÿçš„è³‡æ–™ï¼›&lt;br>
å…·é«”å¯«å…¥ç¡¬ç¢Ÿæ™‚æ©Ÿçœ‹ &lt;code>innodb_flush_log_at_trx_commit&lt;/code>ï¼Œé è¨­ 1 ç‚ºæ¯ä¸€ç­†éƒ½åŠæ™‚å¯«å…¥ç¡¬ç¢Ÿä¸­&lt;/li>
&lt;li>å®šæœŸåŒæ­¥åˆ°ç¡¬ç¢Ÿä¸­ï¼š&lt;br>
æ¯å€‹æ“ä½œéƒ½æœ‰å…ˆå¯«å…¥ Redo Logï¼Œä½†é€™æ˜¯ç‚ºäº†ç½é›£å¾©åŸè€Œç”¨ï¼Œè³‡æ–™åº«çš„è³‡æ–™æœƒä»¥ Page å½¢å¼å„²å­˜æ–¼ç¡¬ç¢Ÿä¸­ï¼Œæ‰€ä»¥å®šæœŸåˆ° checkpoint æœƒæŠŠ dirty page å¾è¨˜æ†¶é«”æ›´æ–°åˆ°ç¡¬ç¢Ÿä¸­&lt;/li>
&lt;/ol>
&lt;h3 id="binlog">Binlog&lt;/h3>
&lt;p>Binlog é©ç”¨æ–¼ç³»çµ±ç•°åœ°æ¢å¾©/å»ºç«‹ Replicaï¼ŒBinlog ä¸åƒ Redo Log æœƒä¿å­˜æ‰€æœ‰çš„æ“ä½œï¼Œåªæœƒä¿å­˜å°æ–¼è³‡æ–™æœ‰ç•°å‹•çš„è¡Œç‚ºï¼Œä¾‹å¦‚ update / delete ç­‰&lt;/p>
&lt;p>å¯«å…¥æ™‚æ©Ÿåœ¨ commit å®Œæˆæ™‚ï¼Œæœƒåœ¨ commit çµæŸå‰ / lock é‡‹æ”¾å‰å¯«å…¥ç¡¬ç¢Ÿï¼Œé¿å…è³‡æ–™ç•°å¸¸ï¼Œå…·é«”çš„å¯«å…¥é »ç‡è¦çœ‹ &lt;code>sync_binlog&lt;/code>ï¼Œé è¨­ç‚º 1 ä»£è¡¨æ¯ä¸€ç­† commit å°±å¯«ä¸€æ¬¡ï¼Œå¯ä»¥è¨­å®šç‚º n ä»£è¡¨ n ç­† commit æ‰å¯«å…¥ä½†å°±æœƒæœ‰éºå¤±è³‡æ–™çš„é¢¨éšª&lt;/p>
&lt;h3 id="undo-log">Undo log&lt;/h3>
&lt;p>å¦‚æœ isolation level é–‹åˆ° repeatable readï¼Œå‰‡ MySQL æ¡ç”¨ MVCCï¼Œè®“æ¯å€‹ transaction åªæœƒè®€å–åˆ°è‡ªå·± transaction é–‹å§‹å‰çš„æœ€æ–°è³‡æ–™ï¼Œè€Œä¸è¢«ä¸¦è¡Œçš„ transaction æ‰€å½±éŸ¿&lt;/p>
&lt;p>ä¹‹æ‰€ä»¥éœ€è¦ undo log æ˜¯ç•¶ transaction rollback æ™‚ï¼Œéœ€è¦çŸ¥é“è‡ªå·±è¦å›æ»¾çš„ç‹€æ…‹ï¼Œæ‰€ä»¥ undo log å¿…é ˆä¿å­˜åˆ° transaction åŸ·è¡Œå®Œç•¢æ‰å¯ä»¥åˆªé™¤ï¼Œé•·åº¦æœƒæ˜¯ &lt;code>åŸ·è¡Œæœ€ä¹…çš„ transaction&lt;/code>&lt;/p>
&lt;h2 id="aurora-æ¶æ§‹">Aurora æ¶æ§‹&lt;/h2>
&lt;p>Aurora æ˜¯ AWS åŸºæ–¼é›²ç«¯å»ºæ§‹çš„é—œè¯å¼è³‡æ–™åº«æœå‹™ï¼Œå…¼å®¹æ–¼ MySQL / PostgreSQLï¼Œä¸»è¦æƒ³è§£æ±ºå¹¾å€‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>å®¹éŒ¯èƒ½åŠ›ï¼š&lt;br>
ç¡¬ç¢Ÿå¯èƒ½æœƒå£ / ä¸»æ©Ÿå¯èƒ½æœƒæœ‰å•é¡Œ / ç”šè‡³ Data Center éƒ½æœƒå‡ºæ„å¤–ï¼Œå°¤å…¶æ˜¯åœ¨é›²ç«¯åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œæ©Ÿå™¨æ•¸å¢åŠ å¸¶ä¾†æ›´é«˜çš„å‡ºéŒ¯æ©Ÿæœƒï¼ŒAurora æ¯ä¸€å€‹ replica éƒ½æœƒå°æ‡‰ 3 å€‹ AZ å„ 2 å€‹ node ç¸½å…± 6 å€‹ node å„²å­˜è³‡æ–™ï¼Œå¤§å¹…å¢åŠ å®¹éŒ¯èƒ½åŠ›&lt;/li>
&lt;li>æ“´å±•æ€§ï¼š&lt;br>
å‚³çµ±çš„è³‡æ–™åº«æ¶è¨­æ–¼å–®ä¸€ä¸»æ©Ÿä¸Šï¼Œè®€å–æœƒå—é™æ–¼ Disk I/O çš„è²§é ¸ï¼ŒAurora å°‡ Compute / Storage åˆ†é›¢ï¼Œå¯ä»¥é‡å°éœ€æ±‚ç¨ç«‹å‡ç´šï¼Œä¸¦å¢åŠ è·¨å€åŸŸã€è·¨ AZ çš„ Read Replica&lt;/li>
&lt;/ol>
&lt;p>ä½†æœ‰é€™éº¼å¤šå¥½è™•å»ä¸ç”¨å—åˆ°å¤ªå¤šçš„æ€§èƒ½å½±éŸ¿ï¼Œè½èµ·ä¾†æœ‰é»ç¾å¥½çš„ä¸åˆ‡å¯¦éš›ï¼Œä¾‹å¦‚å‚™ä»½åˆ°å¤šå€‹å„²å­˜ node å°±éœ€è¦æ“”å¿ƒè³‡æ–™ä¸€è‡´æ€§/æ•ˆèƒ½çš„å•é¡Œï¼Œé™¤äº†åŸæœ¬çš„ Disk I/O åˆå¤šäº†ä¸€æ®µ Network I/Oï¼ŒAurora åœ¨ä¸åŒçš„åœ°æ–¹ä½œå‡ºäº†å°æ‡‰çš„èª¿æ•´&lt;/p>
&lt;h2 id="2-durability-at-scale">2. DURABILITY AT SCALE&lt;/h2>
&lt;h3 id="21-replication-and-correlated-failures">2.1 Replication and Correlated Failures&lt;/h3>
&lt;p>Aurora è·Ÿå¾ˆå¤šåˆ†æ•£å¼å„²å­˜çš„æœå‹™å¾ˆåƒï¼Œæ¡ç”¨å¤šæ•¸è®€å¯«çš„æ©Ÿåˆ¶ï¼Œåªè¦ç¢ºä¿&lt;/p>
&lt;ol>
&lt;li>Vw + Vr &amp;gt; V&lt;/li>
&lt;li>Vw &amp;gt; V / 2&lt;/li>
&lt;/ol>
&lt;p>V ä»£è¡¨ç¯€é»æ•¸é‡ï¼Œå¦‚æœ Vw å¯«å…¥ç¯€é»æ•¸é‡è¶…é 1/2 ç¯€é»éƒ½æˆåŠŸæ‰æˆåŠŸï¼Œä¸” Vr è®€å–æ•¸é‡æ˜¯è®€å–å¤šæ•¸å‰‡&lt;/p>
&lt;p>æœ€åŸºæœ¬çš„æ•¸é‡æœƒå– 3ï¼Œå‰‡ Vw / Vr åªè¦æœ‰ 2 å€‹ node å­˜æ´»å‰‡å¯ä»¥ç¹¼çºŒé‹ä½œï¼Œå®¹éŒ¯ç‡æ˜¯ 33%ï¼Œä½†æ–‡ä»¶ä¸­èªªåˆ° Aurora é¸æ“‡ 6 å€‹ nodeåˆ†æ•£åœ¨ 3 å€‹ AZï¼Œé€™æ¨£å¯ä»¥é é˜²ä¸€å€‹ AZ ä»¥åŠä¸€å€‹é¡å¤–éŒ¯èª¤ä¸‹è®€å–é‚„ä¸æœƒä¸­æ–·&lt;/p>
&lt;h3 id="22-segmented-storage">2.2 Segmented Storage&lt;/h3>
&lt;p>ç‚ºäº†é™ä½åŒæ™‚æ©Ÿå™¨æ•…éšœè€Œå°è‡´ç ´å£å¤šæ•¸çš„å¯èƒ½ï¼Œè¦ç›¡å¯èƒ½é™ä½ MTTF(å¹³å‡éŒ¯èª¤æ™‚é–“)èˆ‡ MTTR(å¹³å‡å¾©åŸæ™‚é–“)ï¼ŒAurora ä»¥ 10GB ç•¶ä½œä¸€å€‹å€æ®µï¼Œç”¢ç”Ÿ 6 å€‹å‚™ä»½ä¸¦åˆ†æ•£åˆ° 3 å€‹ AZ ç¨±ä¹‹ç‚º PG(Protection Group)ï¼Œä¸€å€‹ Storage Volume å°±æ˜¯ç”±å¤šå€‹ PG æ‰€çµ„æˆï¼Œå¯¦é«”ä¸Šå°±æ˜¯ç”± EC2 åŠ ä¸Šä¸€ç¾¤åˆ†å‰²çš„ SSD çµ„æˆï¼Œæœ€å¤§å¯æ”¯æ´åˆ° 64TB&lt;/p>
&lt;p>Segment æ˜¯æœ€å°ç¨ç«‹å–®ä½ (ä¹Ÿå°±æ˜¯æœƒå£æ‰æ˜¯ç¨ç«‹ä¸€å€‹ Segment å£)ï¼ŒAWS æœƒè² è²¬æŒçºŒç›£æ§èˆ‡å¾©åŸï¼Œç›®å‰å¾©åŸä¸€å€‹ Segment ç´„ 10ç§’é˜ (ç¶²è·¯å¸¶å¯¬ç‚º 10Gbps ä¸‹)ï¼Œæ‰€ä»¥å‡ºç¾ç ´å£å¤šæ•¸çš„å ´æ™¯ï¼šå…©å€‹ node åœ¨ 10ç§’é˜å…§åŒæ™‚å£æ‰ä¸”ä¸€å€‹ AZ æ›æ‰åˆä¸åŒ…å«åŒæ™‚å£æ‰çš„ node æ©Ÿç‡å°±å¾®ä¹å…¶å¾®&lt;/p>
&lt;blockquote>
&lt;p>å°çµï¼šé€™é‚Šè«‡çš„æ˜¯ AWS åœ¨æŒä¹…æ€§ä¸Šçš„å„ªåŒ–ï¼Œå°‡æœ€å°çš„å„²å­˜å–®ä½å®šåœ¨ 10GBï¼Œè®“å¾©åŸé€Ÿåº¦è®Šå¿« / ç”¢ç”Ÿ 6 çµ„å‚™ä»½å¢åŠ å®¹éŒ¯&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-log-is-the-database">THE LOG IS THE DATABASE&lt;/h2>
&lt;h3 id="31-the-burden-of-amplified-writes">3.1 The Burden of Amplified Writes&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0702/mysql-old.png"
loading="lazy"
>
å…ˆçœ‹ç¬¬ä¸€ç‰ˆ Aurora å˜—è©¦çš„æ¶æ§‹ - å‚³çµ±çš„é¡åƒåŒæ­¥æ¶æ§‹ï¼Œä¸€å° Primary Instance è² è²¬å¯«å…¥å„²å­˜æ–¼ EBS ä¸¦åŒæ™‚å‚™ä»½åˆ°å¦ä¸€ä»½ EBS ä¸­ï¼Œæœ‰ä¸€å° Replica Instance åŒæ­¥ Primary çš„å¯«å…¥ä¸¦å„²å­˜æ–¼å…©ä»½ EBS ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸€å€‹ MySQL å¯«å…¥æœ€å¤šæœƒè§¸ç™¼äº”å€‹ I/O binlog / redo log / frm(metadata) / double-writeï¼Œè¦ç­‰åˆ°å…¨éƒ¨å¯«å…¥çµæŸæ‰ç®—æ˜¯æ“ä½œæˆåŠŸï¼Œé€™æœƒæ‹‰é•·å›æ‡‰æ™‚é–“ï¼Œæ›´ç³Ÿç³•çš„æ˜¯åœ–ç‰‡ä¸­æ­¥é©Ÿ 1,3,5 (ç‚ºä»€éº¼æœ‰5?) æ˜¯åŒæ­¥ä¸”é †åºå¯«å…¥&lt;/p>
&lt;h3 id="32-offloading-redo-processing-to-storage">3.2 Offloading Redo Processing to Storage&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0702/aurora.png"
loading="lazy"
>
ç›¸åçš„ Aurora é€é Redo Log åŒæ­¥ï¼Œè®“ Storage level è² è²¬ Redo Log å¯«å…¥èˆ‡æ›´æ–° Data fileï¼ŒåŒæ™‚åˆ†é€çµ¦ Replica æ›´æ–°è¨˜æ†¶é«”ä¸­ page çš„è³‡æ–™ï¼›&lt;br>
ä¸åƒéå¾€ MySQL éœ€è¦åœ¨ Checkpoint / background / cache ç©ºé–“ä¸è¶³æ™‚åˆ·æ–°è³‡æ–™åˆ°ç¡¬ç¢Ÿä¸­ï¼Œå…¨éƒ¨ç”± Storage Service è² è²¬ï¼Œå¤§å¹…é™ä½äº† Network I/O&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0702/perf.png"
loading="lazy"
>
å¾ Benchmark å¯ä»¥çœ‹åˆ°ï¼Œæ¯ç­† Transaction æ‰€éœ€çš„ I/O å¾ 7.4 è®Šæˆ 0.9ï¼Œå®Œæˆçš„ Transaction æ•¸ä¹Ÿæå‡äº† 35 å€&lt;/p>
&lt;p>é€™åŒæ™‚ä¹Ÿé™ä½äº†å¾©åŸçš„æ™‚é–“ï¼Œå‚³çµ± DB éœ€è¦å¾ Redo Log ä¸Šä¸€æ¬¡çš„ checkpoint é–‹å§‹é€æ¢åŸ·è¡Œï¼Œä½† Aurora çš„å¾©åŸæ˜¯å¾ Storage level å‘å…¶ä»–å‚™ä»½æ‹‰ Segmentï¼Œå¾©åŸé€Ÿåº¦å¯ä»¥åœ¨ä¸€åˆ†é˜ä»¥å…§&lt;/p>
&lt;h3 id="33-storage-service-design-points">3.3 Storage Service Design Points&lt;/h3>
&lt;p>Storage Service æ ¸å¿ƒè¨­è¨ˆè¦é™ä½å¯«å…¥è«‹æ±‚çš„å»¶é²ï¼Œæ‰€ä»¥æŠŠå¤§éƒ¨åˆ†çš„å„²å­˜å·¥ä½œéƒ½ç§»è‡³èƒŒæ™¯åŸ·è¡Œï¼Œå°¤å…¶æ˜¯æ›´å¥½åœ°åˆ©ç”¨ CPU å»æ›å– Disk å¯«å…¥æ™‚é–“ï¼Œä¾‹å¦‚èˆŠçš„ Page è¦åƒåœ¾å›æ”¶å¯ä»¥åœ¨èƒŒæ™¯ç”¨ CPU åŸ·è¡Œè€Œä¸è¦å»¶é²å‰æ™¯åœ¨è™•ç†å¯«å…¥è«‹æ±‚ï¼Œæ‰€ä»¥ Aurora çš„èƒŒæ™¯é‹ä½œä¸æœƒå½±éŸ¿å‰æ™¯ï¼Œä¸åŒæ–¼å‚³çµ± DB å¦‚æœèƒŒæ™¯åœ¨ Checkpoint åˆ·æ–°ç¡¬ç¢Ÿå‰‡æœƒé€ æˆå‰æ™¯å¯«å…¥çš„å»¶é²&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0702/storage.png"
loading="lazy"
>
Storage Service æ”¶åˆ°è«‹æ±‚æœƒåŸ·è¡Œ&lt;/p>
&lt;ol>
&lt;li>æ”¾å…¥ Memory ä¸­&lt;/li>
&lt;li>å¯«å…¥ç¡¬ç¢Ÿï¼Œå¯«å…¥è«‹æ±‚æˆåŠŸ&lt;/li>
&lt;li>æ’åºï¼Œä¸¦ç¢ºèªå¯«å…¥ç´€éŒ„æ˜¯å¦æœ‰éºæ¼&lt;/li>
&lt;li>é€é gossip è·Ÿå…¶ä»–ç¯€é»è¦éºæ¼çš„ç´€éŒ„&lt;/li>
&lt;li>æ›´æ–°åˆ° page ä¸­&lt;/li>
&lt;li>å®šæœŸåŒæ­¥åˆ° s3&lt;/li>
&lt;li>å®šæœŸæ¸…é™¤èˆŠçš„ page&lt;/li>
&lt;li>å®šæœŸæª¢æŸ¥ page çš„é©—è­‰ç¢¼&lt;/li>
&lt;/ol>
&lt;p>é™¤äº†æ­¥é©Ÿ 1, 2 æœƒå½±éŸ¿å‰æ™¯å¯«å…¥ï¼Œå…¶é¤˜æ­¥é©Ÿéƒ½å¯ä»¥éåŒæ­¥ä¸”æ–¼èƒŒæ™¯åŸ·è¡Œ&lt;/p>
&lt;h2 id="4-the-log-marches-forward">4. THE LOG MARCHES FORWARD&lt;/h2>
&lt;p>æ¥è‘—è¦ç¢ºä¿ rumtimeã€replica éƒ½ä¿æŒä¸€è‡´æ€§ï¼Œç©¶ç«Ÿæ˜¯å¦‚ä½•ä¸ä½¿ç”¨æ˜‚è²´çš„ 2pc å»åˆèƒ½ä¿æŒä¸€è‡´æ€§&lt;/p>
&lt;h3 id="41-solution-sketch-asynchronous-processing">4.1 Solution sketch: Asynchronous Processing&lt;/h3>
&lt;p>å‰é¢æé Aurora æ˜¯é€é redo log åŒæ­¥ï¼Œæ¯ä¸€ç­† log éƒ½æœ‰ æŒçºŒéå¢çš„ LCN (Log Sequence Number)ï¼Œå› ç‚ºå¯«å…¥æˆåŠŸåªè¦å¤šæ•¸çš„ node åŒæ„å³å¯ï¼Œæ‰€ä»¥æœ‰äº› node å¯èƒ½æœƒç¼ºå°‘å¹¾å€‹ logï¼Œå¯ä»¥é€é LCN å»è·Ÿå…¶ä»– node ç´¢å–éºå¤±çš„ log&lt;/p>
&lt;p>è€ƒé‡åˆ°å¤š transaction çš„æƒ…æ³ï¼Œæ¯å€‹ transaction åŸ·è¡Œé †åºæœ‰æ‰€ä¸åŒï¼Œåœ¨éç¨‹æœƒé™¸çºŒæŠŠ commit é€åˆ° storage service å„²å­˜ (åˆ° complete) éšæ®µï¼Œä½†å¦‚æœç™¼ç”Ÿäº†ç³»çµ±æ•…éšœæ™‚ï¼Œé‡æ–°æ¢å¾©å¾Œéœ€è¦æŠŠæ²’æœ‰ commit çš„ transaction éƒ½ rollbackï¼Œå‡è¨­ DB ç›®å‰æœ€é«˜å®Œæˆå¯«å…¥çš„ LCN ç¨±ç‚º VCL (Volume Complete LSN))ï¼Œåœ¨å¾©åŸä¸­ä»»ä½• LCN é«˜æ–¼ VCL éƒ½æœƒè¢«éºæ£„ï¼Œå› ç‚ºä»£è¡¨æ²’æœ‰è¢« complete&lt;/p>
&lt;p>æ›´é€²éšé€™äº›é«˜æ–¼ VCL çš„ LCN æœƒè¢«æ¨™è¨˜æˆ CPL (Consistency Point LSNs)ï¼Œæ¥è‘—å®šç¾©å‡º VDL ç‚ºé‚£äº›åœ¨ä½æ–¼ VCL ä¸­æœ€é«˜çš„ CPLï¼Œä¾‹å¦‚ CPL æœ‰ 900,1000, 1100 ä½†æ˜¯ VCL ç‚º 1007ï¼Œå‰‡ VDL ç‚º 1000ï¼Œé€™ä»£è¡¨ storage service complete åˆ° 1007 ä½†æ˜¯æŒä¹…åŒ–å„²å­˜åˆ° 1000&lt;/p>
&lt;blockquote>
&lt;p>é€™ä¸€æ•´æ®µæ²’æœ‰åˆ°éå¸¸ç†è§£ï¼Œå¾…ä¹‹å¾Œæ…¢æ…¢æ€è€ƒ&lt;/p>
&lt;/blockquote>
&lt;h3 id="42-normal-operation">4.2 Normal Operation&lt;/h3>
&lt;p>Aurora æœƒåŒæ™‚è™•ç†å¤§é‡çš„å¯«å…¥è«‹æ±‚ï¼Œæ¯ä¸€ç­† redo log éƒ½æœƒç”¢ç”Ÿä¸€å€‹å¤§æ–¼ VDL(è¢«æŒä¹…åŒ–ä¿å­˜çš„ LCN)çš„ LCNï¼Œä½†ç‚ºäº†ä¸è¦è®“ LCN çš„éå¢é å¤§æ–¼ Storage Service æ‰€èƒ½ä¿å­˜çš„é€Ÿåº¦ï¼ŒLSN Allocation Limit (LAL) é è¨­ç‚º 10è¬ç­†ï¼Œæ„å³ Aurora æœ€å¤šä¸¦è¡Œ 10 è¬ç­†é€²è¡Œä¸­çš„ transaction é¿å…å¯«å…¥é€Ÿåº¦è·Ÿä¸ä¸Š&lt;/p>
&lt;p>æ¯ä¸€å€‹ PG ä¸­çš„æ¯ä¸€å€‹ Segment åªæœƒä¿å­˜éƒ¨åˆ†çš„ redo logï¼Œä½†æœƒæœ‰ä¸€å€‹ link æŒ‡å‘ä¸Šä¸€ä»½ log æ‰€åœ¨çš„ PGï¼Œé€™ç”¨ä¾†è¿½è¹¤ç›®å‰æ‰€å®Œæˆæœ€å¤§çš„ LCNï¼Œä¸¦ä¸”åœ¨èˆ‡å…¶ä»– node gossip æ™‚å¯ä»¥çŸ¥é“ç¼ºæ¼çš„ log&lt;/p>
&lt;h4 id="read">Read&lt;/h4>
&lt;p>å¦‚åŒå¤§å¤šæ•¸çš„ DBï¼ŒAurora æœƒåœ¨ buffer ä¸­ cache page ï¼Œå¦‚æœ cache miss å‰‡å¾ disk è®€å–ï¼Œæ­¤æ™‚å‚³çµ± DB æœƒå„ªå…ˆç§»é™¤ dirty page ä¸¦å¯«å›ç¡¬ç¢Ÿä¸­ï¼›ä½† Aurora ä¸¦ä¸éœ€è¦åˆ·æ–° dirty page (å› ç‚º storage service å·²ç¶“ç¨ç«‹æ›´æ–°)ï¼Œç›¸åçš„æ˜¯æŠŠ page LCN å¤§æ–¼ç­‰æ–¼ VDL çš„ page ç§»é™¤ä¸¦è®€å–æœ€æ–°è¢«æŒä¹…åŒ–çš„page&lt;/p>
&lt;p>å‰é¢æåˆ° Aurora é€éå¤šæ•¸è®€å–ç¢ºä¿ä¸€è‡´æ€§ï¼Œä½†å¤§å¤šæ•¸æ™‚æ©Ÿä¸¦ä¸éœ€è¦ï¼ŒAurora æœƒåœ¨ Page è®€å–æ™‚ç´€éŒ„ Page LCN ç•¶ä½œ read pointï¼Œæ¥è‘—åªè¦è®€å–çš„ storage node VDL ç¢ºå®šåœ¨ read point ä¹‹å¾Œï¼Œå°±ä»£è¡¨è©² node æœ‰è©² page å®Œæ•´æœ€æ–°çš„è³‡æ–™ï¼Œè€Œä¸”å› ç‚ºæ¯å€‹ segment éƒ½æœ‰ç´€éŒ„ LCN èˆ‡ linkï¼Œæ‰€ä»¥èƒ½å¾ˆå¿«çŸ¥é“è³‡æ–™è¦åˆ°å“ªä¸€å€‹ segment è®€å–&lt;/p>
&lt;p>åŒæ™‚æ¯å€‹ PG æœƒç¶­è­·ä¸€ä»½ç›®å‰æœ€ä½çš„ Protection Group Min Read Point LSN (PGMRPL)ï¼Œé€™ä»£è¡¨ä½æ–¼æ­¤æ•¸å­—çš„ LCN çš„ page éƒ½ä¸æœƒå†è¢«è®€å–ï¼Œé€™æ¨£åƒåœ¾å›æ”¶å°±èƒ½ç§»é™¤éèˆŠçš„ log&lt;/p>
&lt;h3 id="replica">Replica&lt;/h3>
&lt;p>ä¸€å€‹ write node å¯ä»¥æ­é… 16 å€‹ read replica ä¸¦å…±ç”¨ç›¸åŒçš„ storage serviceï¼Œwriter æœƒæŠŠ redo log ä¹ŸåŒæ­¥çµ¦ readerï¼Œå¦‚æœ log æœ‰åœ¨ cache ä¸­å‰‡æ›´æ–°ï¼Œå¦å‰‡å°±ç›´æ¥ä¸Ÿæ£„&lt;/p>
&lt;p>å› ç‚º reader è·Ÿ storage service çš„ redo log æ›´æ–°æ˜¯éŒ¯é–‹ï¼Œæ‰€ä»¥ reader åœ¨æ›´æ–° log æ™‚è¦ç¢ºä¿ LCN æ˜¯å°æ–¼ç­‰æ–¼ VDL / å¦‚æœ log æ˜¯ mini-transaction çš„ä¸€éƒ¨åˆ†å‰‡æ›´æ–°ï¼Œç¢ºä¿è·Ÿæ‰€æœ‰çš„ database çœ‹åˆ°ç›¸åŒå…§å®¹&lt;/p>
&lt;p>é æœŸ reader çš„å»¶é²æœƒåœ¨ 20ms ä»¥å…§&lt;/p>
&lt;h3 id="43-recovery">4.3 Recovery&lt;/h3>
&lt;p>å‚³çµ± DB åœ¨ç½é›£å¾©åŸæ™‚ï¼Œæœƒå»è®€å– redo log ä¸­é‚„æ²’è¢« checkpoint åŸ·è¡Œçš„ logï¼Œæ­é… undo log å°‡å¤±æ•—çš„ transaction rollbackï¼Œä½†é€™åŸ·è¡Œéç¨‹è »èŠ±æ™‚é–“ï¼Œè€Œ Aurora æ²’æœ‰é€™æ–¹é¢å›°æ“¾&lt;/p>
&lt;p>é¦–å…ˆæœƒæª¢æŸ¥æ¯ä¸€å€‹ PGï¼Œæ‰¾å‡ºè®€å–å¤šæ•¸ä¸­å¯ä»¥ç¢ºä¿å·²ç¶“å®Œæˆçš„å¯«å…¥å¤šæ•¸ç´€éŒ„ VDLï¼Œé«˜æ–¼ VDL çš„ LCN å…¨éƒ¨æ¨æ£„ï¼Œæ¥è‘—ä¸€æ¨£éœ€è¦é€é undo log å» rollbackï¼Œæ•´å€‹éç¨‹ç´„ 10ç§’ä»¥å…§&lt;/p>
&lt;h2 id="5-putting-it-all-together">5. PUTTING IT ALL TOGETHER&lt;/h2>
&lt;p>æ¥è‘—çœ‹å®Œæ•´çš„æ¶æ§‹åœ–
&lt;img src="https://yuanchieh.page/post/2021/img/0702/architech.png"
loading="lazy"
>
ç¤¾ç¾¤ç‰ˆçš„ MySQL InnoDB å¼•æ“åœ¨å¯«å…¥æ“ä½œæ™‚æœƒä¿®æ”¹ buffer ä¸­çš„ page èˆ‡å¯«å…¥ WAL redo log bufferï¼Œç­‰åˆ° commit æ™‚å†æŠŠ redo log buffer å¯«å…¥ç¡¬ç¢Ÿä¸­ï¼›è€Œè¢«ä¿®æ”¹çš„ page è¦å‰‡é€é double-write buffer é¿å…åªæ›´æ–°éƒ¨åˆ† pageï¼Œpage å¯«å…¥æœƒç™¼ç”Ÿåœ¨èƒŒæ™¯ / checkpoint / cache ç§»é™¤æ™‚ï¼›
æ­¤å¤–é‚„æœ‰ä¸€äº› B+Tree æ“ä½œèˆ‡ç›¸é—œçš„ mini trasaction (MTR) å¦‚æ‹†åˆ†ã€åˆä½µ B+Tree page éœ€è¦æ˜¯åŸå­æ€§æ“ä½œ&lt;/p>
&lt;p>åœ¨ Aurora ç‰ˆæœ¬ä¸­ï¼Œredo log record å°±ä»£è¡¨æ¯ä¸€å€‹ MTR æ“ä½œï¼Œæœ€æ–°çš„ä¸€ç­† log è¢«æ¨™è¨˜æˆ consistency pointï¼›Aurora æä¾›ç›¸åŒçš„ isolation level&lt;/p>
&lt;p>å…¶é¤˜å°±æ˜¯æ¶æ§‹çš„èªªæ˜ï¼Œä»¥åŠå„æ–¹é¢çš„æ€§èƒ½è¡¨ç¾ï¼Œå°±ä¸è´…è¿°äº†&lt;/p>
&lt;hr>
&lt;h2 id="aurora-å°æ¯”-mysql-æœ‰ä»€éº¼éš±æ†‚">Aurora å°æ¯” MySQL æœ‰ä»€éº¼éš±æ†‚&lt;/h2>
&lt;p>å› ç‚º Aurora å¦‚æœ primary è·Ÿ read replica åœ¨åŒä¸€å€‹ region ä¸‹ï¼Œå‰‡æœƒå…±ç”¨ storage serviceï¼Œé€™ä¹Ÿå°±ä»£è¡¨ undo log æœƒæ˜¯åŒä¸€ä»½ï¼Œå¦‚æœä»Šå¤© read replica æœ‰ä¸€ç­†åŸ·è¡Œéå¸¸ä¹…çš„ transactionï¼Œå‰‡ undo log ä¹Ÿæœƒè·Ÿè®Šå¤§å°è‡´ primary æ•ˆèƒ½ä¸‹é™&lt;/p>
&lt;p>é€™å€‹åœ¨å‚³çµ± MySQL ä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºå¦‚ 3.1 æåˆ° MySQL æ˜¯é€é binlog åŒæ­¥å„è‡ªçš„ MySQL ç¶­è­·å„è‡ªçš„ redo log / undo log æ‰€ä»¥ read replica ä¸æœƒæœ‰ä»»ä½•å½±éŸ¿ primary çš„æ™‚å€™&lt;/p>
&lt;p>æœ€å¾Œä½œè€…æŒ‡å‡ºæœ‰å¹¾å€‹è§£æ³•&lt;/p>
&lt;ol>
&lt;li>èª¿æ•´ read replica é è¨­ isolation level ç‚º read commitedï¼Œå°±ä¸æœƒç”¨åˆ° undo log(éœ€æ³¨æ„é è¨­ç‚º repeatable read)&lt;/li>
&lt;li>Aurora é¸æ“‡ binlog relicaï¼Œå°±è·Ÿå‚³çµ±çš„ mysql ä¸€æ¨£&lt;/li>
&lt;li>æ‹¿åœ¨ S3 çš„å‚™ä»½è³‡æ–™ï¼Œç”¨å…¶ä»–å¤§æ•¸æ“šå·¥å…·åˆ†æ&lt;/li>
&lt;li>Aurora æ”¯æ´ cloneï¼Œå‚™ä»½ä¸€çµ„æ–°çš„è¨­å®š&lt;/li>
&lt;/ol>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>ç¿»æ•´å€‹ Aurora æ¶æ§‹æœ‰å¾ˆå¤šç”Ÿç¡¬çš„åœ°æ–¹æ²’æœ‰å®Œå…¨ææ‡‚ï¼Œä½†æ˜¯çœ‹åˆ°é€™ç¨®è§£ bug è¿½æ ¹ç©¶åº•åˆ°åº•å±¤æ¶æ§‹é‚„æ˜¯è¦ºå¾—å¾ˆéç™®ï¼Œä¹‹å¾ŒæœƒæŒçºŒçš„å„ªåŒ–æ–‡ç« å…§å®¹ï¼Œå¦‚æœæœ‰å“ªè£¡æœ‰å»ºè­°è·ŸæŒ‡æ•™å†éº»ç…©ç•™è¨€ï½&lt;/p></description></item><item><title>å£“æ¸¬å·¥å…·ï¼šJMeter ä½¿ç”¨æ•™å­¸ + è‡ªå®šç¾©è®Šæ•¸ä½¿ç”¨</title><link>https://yuanchieh.page/posts/2021/2021-06-26-jmeter-%E4%BD%BF%E7%94%A8%E6%95%99%E5%AD%B8-+-%E8%87%AA%E5%AE%9A%E7%BE%A9%E8%AE%8A%E6%95%B8%E4%BD%BF%E7%94%A8/</link><pubDate>Sat, 26 Jun 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-06-26-jmeter-%E4%BD%BF%E7%94%A8%E6%95%99%E5%AD%B8-+-%E8%87%AA%E5%AE%9A%E7%BE%A9%E8%AE%8A%E6%95%B8%E4%BD%BF%E7%94%A8/</guid><description>&lt;p>æœ€è¿‘åŠŸèƒ½ä¸Šç·šé‡åˆ°ä¸€äº› OOM å•é¡Œï¼Œåœ¨ Staging æ‰‹å‹•é©—è­‰æµé‡ä¸å¤ æ¸¬ä¸å‡ºä¾†æœ‰é»é ­ç–¼ï¼Œæ‰€ä»¥å›é ­ç”¨ JMeter é€²è¡Œå£“åŠ›æ¸¬è©¦ï¼Œå› ç‚ºæœ‰ Cache æ‰€ä»¥åªæ‰“å–®ä¸€ç¨® request æ˜¯æ²’æœ‰ç”¨çš„ï¼Œå¿…é ˆçµ„åˆå‡ºå¤šç¨®åƒæ•¸ä¸€èµ·åŸ·è¡Œï¼Œå¥½åœ¨ JMeter æ”¯æ´ csv è¼¸å…¥åƒæ•¸ï¼Œä»¥ä¸‹å°‡ä»‹ç´¹å¦‚ä½•ä½¿ç”¨&lt;/p>
&lt;p>Sample å¯ä»¥åƒè€ƒæˆ‘çš„ github repo &lt;a class="link" href="https://github.com/sj82516/jmeter-pre-post-processor" target="_blank" rel="noopener"
>jmeter-pre-post-processor&lt;/a>&lt;/p>
&lt;h3 id="å®‰è£">å®‰è£&lt;/h3>
&lt;p>åˆ°&lt;a class="link" href="https://jmeter.apache.org/download_jmeter.cgi" target="_blank" rel="noopener"
>å®˜ç¶²&lt;/a>ä¸‹è¼‰æœ€æ–°ç‰ˆï¼Œè§£å£“ç¸®å®Œ &lt;code>$ bin/jmeter&lt;/code> å³å¯åŸ·è¡Œï¼Œè¨˜å¾—é›»è…¦è¦å®‰è£ java&lt;/p>
&lt;h3 id="sample1-æ“ä½œ">Sample1: æ“ä½œ&lt;/h3>
&lt;p>é€²è¡ŒåŸºæœ¬çš„å£“åŠ›æ¸¬è©¦ï¼Œå¤§æ¦‚æœƒæœ‰ä»¥ä¸‹çš„æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>æ±ºå®šé€²è¡Œå¹¾è¼ªæ¸¬è©¦&lt;/li>
&lt;li>è¦ç™¼é€å¤šå°‘ requestã€åŒæ™‚é–“ä½µç™¼æ•¸&lt;/li>
&lt;li>request é‡å°çš„ host / åƒæ•¸è¨­å®š&lt;/li>
&lt;li>çµæœçš„é¡¯ç¤ºï¼Œå¯ä»¥å°‡ response å­˜æˆæª”æ¡ˆ / åœ–è¡¨é¡¯ç¤º response é€Ÿåº¦ã€æˆåŠŸç‡ç­‰&lt;/li>
&lt;/ol>
&lt;p>å°æ‡‰ JMeter è¨­å®šæ˜¯&lt;/p>
&lt;ol>
&lt;li>&lt;code>Thread Group&lt;/code>
&lt;ol>
&lt;li>Number of Threads: å¤šå°‘ request&lt;/li>
&lt;li>Loop Count: ç¸½å…±å¹¾è¼ª&lt;/li>
&lt;li>Ramp-Up Second: æœ‰é» ticky çš„åƒæ•¸ï¼ŒæŒ‡å®šå¤šå°‘æ™‚é–“å…§ Thread æœƒå•Ÿå‹•ï¼Œå‡è¨­è¨­å®š 90 sec ç¸½å…±æœ‰ 10 å€‹ threadï¼Œå‰‡ä¸‹ä¸€å€‹ thread æœƒä¸Šä¸€å€‹ thread æˆåŠŸå¾Œ + 9 (90/10) sec å¾Œå•Ÿå‹•ï¼Œå®˜æ–¹å»ºè­° &lt;code>é è¨­ = threads æ•¸é‡å†è¦–æƒ…æ³å¢æ¸›&lt;/code>ï¼Œå¦‚æœè¦ç¢ºä¿åŒæ™‚ä½µç™¼ï¼Œrequest åŸ·è¡Œæ™‚é–“è¦å¤§æ–¼ thread å•Ÿå‹•æ™‚é–“&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>åœ¨ Thread Group ä¸Šï¼ŒæŒ‰ä¸‹å³éµå¢åŠ 
&lt;ol>
&lt;li>&lt;code>Config Element&lt;/code> ç³»åˆ—ï¼šå¯ä»¥æ”¾å…±ç”¨åƒæ•¸
&lt;ol>
&lt;li>Http Request Default: Http request çš„é è¨­åƒæ•¸ï¼Œå¯ä»¥æ”¾ host / port ç­‰å…±ç”¨è¨­å®š&lt;/li>
&lt;li>Http Header Manager: æ”¾å…±åŒ Header&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>Sampler&lt;/code>: æ¡æ¨£ï¼Œä¹Ÿå°±æ˜¯è¦æ¸¬è©¦çš„é …ç›®
&lt;ol>
&lt;li>Http Request: æŒ‡å®šè¦æ‰“çš„åƒæ•¸&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>Listener&lt;/code>: æ”¶é›†çµæœ
&lt;ol>
&lt;li>Summary Reportï¼šçµ±è¨ˆæ‰€æœ‰ request çš„é€Ÿåº¦èˆ‡æˆåŠŸç‡ç­‰
&lt;img src="https://yuanchieh.page/post/2021/img/0626/jmeter.png"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;h3 id="sample2-å¾-csv-è®€å–åƒæ•¸">Sample2: å¾ csv è®€å–åƒæ•¸&lt;/h3>
&lt;p>é¸æ“‡ Config Element &amp;gt; CSV Data Set Configï¼Œé¸æ“‡ csv æª”æ¡ˆå¾Œï¼Œåœ¨ Http Request å¯ä»¥ç”¨ &lt;code>${è®Šæ•¸å}&lt;/code> çš„æ–¹å¼ï¼Œå°±å¯ä»¥è®€å–åˆ°å°æ‡‰çš„ csv æ¬„ä½å–”
ä¾‹å¦‚æˆ‘çš„ csv é•·é€™æ¨£&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">account,password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user1,test1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user2,test2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user3,test3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘å¸Œæœ›æ‰“å‡º POST /login ä¸­çš„ body å¸¶åƒæ•¸ï¼Œè®Šæˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">{&amp;#34;user&amp;#34;: &amp;#34;${account}&amp;#34;, &amp;#34;password&amp;#34;: &amp;#34;${password}&amp;#34;}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>JMeter æœƒä¾åºå¾ä¸Šè‡³ä¸‹ä¸æ–·è¼ªè¿´ç™¼é€å–”&lt;/p>
&lt;h3 id="sample3-pre-processor">Sample3: Pre Processor&lt;/h3>
&lt;p>å¦‚æœæˆ‘å€‘å¸Œæœ›åœ¨æ¯æ¬¡ Request å‰åšä¸€äº›é è™•ç†ï¼Œä¾‹å¦‚ç”¢ç”Ÿäº‚æ•¸ã€å­—ä¸²çµ„åˆç­‰ï¼Œå°±å¯ä»¥ç”¨ Pre Processorï¼Œæœ‰åˆ†æˆå¾ˆå¤šç¨®ï¼Œå¯ä»¥ç”¨ BeanShell (java-like script language) æˆ–æ˜¯ JSR223 (javascript / groovy ç­‰æ›´å¤šçš„ script language)ï¼Œé€™é‚Šå°±ç”¨ javascript&lt;/p>
&lt;p>å»¶ä¼¸è‡ª Sample2ï¼Œå…ˆå°‡ csv è®€é€²ä¾†çš„ account / password ç•¶ä½œåƒæ•¸ï¼Œåœ¨ account å‰é¢åŠ ä¸€å€‹ &amp;ldquo;prefix_&amp;rdquo; å­—ä¸²ï¼Œåšæ³•ä¸Šæ–°å¢ä¸€å€‹ JSR223 Preprocessorï¼Œé¸æ“‡ javascriptï¼Œä¸¦è¼¸å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">account&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">vars&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;account&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">account&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;prefix_&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">account&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">vars&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;account&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">account&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vars&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ‰ä¸€äº›ç’°å¢ƒè®Šæ•¸å¯ä»¥ä½¿ç”¨ï¼Œä¾‹å¦‚ &lt;code>vars&lt;/code> å¯ä»¥å–å¾—/è¨­å®šç•¶å‰çš„è®Šæ•¸ï¼Œå…¶é¤˜é‚„æœ‰ &lt;code>sample&lt;/code> å¯ä»¥æ”¹è®Š sample çµæœ / &lt;code>log&lt;/code> æ‰“å‡º logï¼Œ console.log æ˜¯ä¸èƒ½ç”¨çš„ / &lt;code>props&lt;/code> å–å¾—ç•¶å‰ JMeter è¨­å®šç­‰ï¼Œé€™äº›æ¯”è¼ƒé€²éšï¼Œå¯ä»¥åƒè€ƒ &lt;a class="link" href="https://www.blazemeter.com/blog/how-use-beanshell-jmeters-favorite-built-component" target="_blank" rel="noopener"
>How to Use BeanShell: JMeter&amp;rsquo;s Favorite Built-in Component&lt;/a>&lt;/p>
&lt;h3 id="post-processor">Post Processor&lt;/h3>
&lt;p>æœ‰äº›æ™‚å€™ï¼Œæˆ‘å€‘æœƒå¸Œæœ›åšä¸€äº›å¾Œè™•ç†ï¼Œä¾‹å¦‚ parse response åš assertion ç­‰ï¼Œå¯ä»¥å¢åŠ  post-processorï¼Œä¾‹å¦‚æˆ‘å€‘å¯ä»¥æ¥ç™»å…¥å–å¾—çš„ tokenï¼Œç•¶ä½œä¸‹ä¸€å€‹ request çš„åƒæ•¸ï¼Œæ–°å¢ä¸€å€‹ JSR223 PostProcessor&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">responseBody&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">sampler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sample&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">getResponseDataAsString&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">responseBody&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">responseBody&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">vars&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;user_id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">responseBody&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£ä¸‹ä¸€å€‹ request å°±å¯ä»¥æ‹¿ ${user_id} äº†&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>JMeter æœ‰éå¸¸å¤šæ–¹ä¾¿ä¸”å¼·å¤§çš„çµ„ä»¶ï¼Œå¯ä»¥çµ„åˆå‡ºå„ç¨®å®¢è£½åŒ–çš„å£“æ¸¬ç’°å¢ƒ&lt;/p></description></item><item><title>Youtube ç›´æ’­ã€ŒFredèŠèŠSOLIDè¨­è¨ˆåŸå‰‡ã€æ•´ç†</title><link>https://yuanchieh.page/posts/2021/2021-06-15-youtube-%E7%9B%B4%E6%92%ADfred%E8%81%8A%E8%81%8Asolid%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E6%95%B4%E7%90%86/</link><pubDate>Tue, 15 Jun 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-06-15-youtube-%E7%9B%B4%E6%92%ADfred%E8%81%8A%E8%81%8Asolid%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E6%95%B4%E7%90%86/</guid><description>&lt;p>ç•¶æ™‚åœ¨ç¤¾ç¾¤çœ‹åˆ°åˆ†äº«ï¼Œæƒ³èªªè½çœ‹çœ‹ä¹Ÿæ²’ä»€éº¼æå¤±ï¼Œè½å®Œæ‰ç™¼ç¾æ ¹æœ¬è³ºåˆ°ï¼Œæ²’æœ‰æƒ³é SOLID å¯ä»¥ç”¨é€™ç¨®æ–¹å¼ç†è§£ï¼Œä¹Ÿæ‰çœŸæ­£æ˜ç™½è‡ªå·±ä»¥å¾€åœ¨çœ‹ Uncle Bob çš„æ›¸æ€è€ƒéƒ½å¤ªæ·ºå±¤ï¼ŒçœŸå¿ƒæ„Ÿè¬ Fred å¤§å¤§æ’¥ç©ºè·Ÿå¤§å®¶åˆ†äº«å¯¶è²´çš„çŸ¥è­˜ï¼Œåœ¨ç›´æ’­ä¸­é‡åˆ°è¨­å‚™ã€ç¶²è·¯å•é¡Œé‚„æ˜¯å¾ˆæœ‰æ¢ç†çš„å®Œæˆåˆ†äº«&lt;/p>
&lt;p>ä»¥ä¸‹å°‡æ•´ç† Fred å¤§å¤§ç›´æ’­çš„åˆ†äº«ï¼Œå»ºè­°æœ‰ç©ºå¯ä»¥èŠ±å…©å°æ™‚çœ‹å®Œç›´æ’­&lt;/p>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/e0UOuQ_lCUY"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;h2 id="solid">SOLID&lt;/h2>
&lt;p>Uncle Bob åœ¨ 1995 å¹´(ç´„ 37æ­²)æ ¹æ“šè‡ªå·±é–‹ç™¼ç¨‹å¼çš„ç—›é»ï¼Œä¹Ÿå°±æ˜¯å¤§å‹è»Ÿé«”ç¨‹å¼å¯ç¶­è­·æ€§ï¼Œéœ€æ±‚è®Šæ›´å¸¶ä¾†ç¨‹å¼ç¢¼ç¶­è­·å•é¡Œï¼Œè€Œç¶­è­·å•é¡Œçš„æ ¹æœ¬åŸå› æ˜¯ç¨‹å¼ç¢¼çš„è€¦åˆï¼Œåœ¨ç¤¾ç¾¤æå‡ºè¨è«–ï¼Œç„¶å¾Œè¢«æˆ°ç¿»äº† XD&lt;/p>
&lt;h3 id="è¨­è¨ˆå£å‘³é“">è¨­è¨ˆå£å‘³é“&lt;/h3>
&lt;ul>
&lt;li>Rigidity åƒµåŒ–ï¼šä»»ä½•è®Šæ›´æœƒå°è‡´ç³»çµ±ä¸­ç›¸ä¾çš„çµ„ä»¶éœ€è¦è®Šæ›´ï¼Œè¶…å‡ºæƒ³åƒ&lt;/li>
&lt;li>Fragility è„†å¼±ï¼šç™¼ç”Ÿè®Šæ›´æ™‚ï¼Œå…¶ä»–åœ°æ–¹å®¹æ˜“ç™¼ç”Ÿå•é¡Œ&lt;/li>
&lt;li>Immobility é›£ä»¥æœç”¨ï¼šçµ„ä»¶æœ‰å¤ªå¤šç´°ç¯€çš„ä¾è³´&lt;/li>
&lt;li>Viscosity é»æ»¯ï¼šè®Šæ›´æ™‚ç”¨å¤ªå¤š hackï¼Œè€Œéä»¥åŸè¨­è¨ˆçš„æ–¹å¼é€²è¡Œ&lt;/li>
&lt;/ul>
&lt;h3 id="çµ„ä»¶ç›¸äº’ä¾è³´æ€§">çµ„ä»¶ç›¸äº’ä¾è³´æ€§&lt;/h3>
&lt;p>SOLID æœ¬è³ªåœ¨è§£æ±ºçµ„ä»¶ä¹‹é–“ä¸åˆç†çš„ç›¸äº’ä¾è³´æ€§&lt;/p>
&lt;h2 id="single-responsibility">Single Responsibility&lt;/h2>
&lt;p>æè¿°èˆ‡å®šç¾©æœ€æ¨¡ç³Šçš„ä¸€æ¢ï¼Œæœ‰å¹¾ç¨®å¸¸è¦‹èªªæ³•&lt;/p>
&lt;ul>
&lt;li>ä¸€å€‹é¡åˆ¥æ‡‰è©²åªæœ‰ä¸€å€‹æ”¹è®Šçš„åŸå› &lt;/li>
&lt;li>ä¸€å€‹é¡åˆ¥åªæ‡‰åšä¸€ä»¶äº‹ï¼Œå°±æ˜¯ä»–çš„è·è²¬ =&amp;gt; é‚£è·è²¬æ‡‰è©²æ˜¯ä»€éº¼ï¼Œå°±æ˜¯é€™å€‹é¡åˆ¥è©²åšçš„äº‹ (ç„¡é™ loop)
ä¾‹å¦‚ä¸€å€‹å­¸ç”Ÿç®¡ç†ç³»çµ±ï¼ŒStudent çš„é¡åˆ¥å¢åˆªæ”¹æŸ¥ï¼Œè¦ç”¢ç”Ÿå¹¾å€‹é¡åˆ¥ï¼Ÿ
è³‡æ–™è™•ç†ä¸­çš„ ETL æ˜¯ä¸€å€‹è·è²¬é‚„æ˜¯ä¸‰å€‹åŸå‰‡ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;p>é•å SRP çš„è¨­è¨ˆå¯èƒ½æœƒé•·é€™æ¨£
&lt;img src="https://yuanchieh.page/post/2021/img/0615/srp.png"
loading="lazy"
>&lt;/p>
&lt;p>å¯ç¶­è­·æ€§å•é¡Œæ–¹é¢ï¼Œé™¤äº†ç¨‹å¼ç¢¼è€¦åˆï¼Œä¹Ÿè¦æ³¨æ„ &lt;code>æ¥­å‹™è€¦åˆ&lt;/code>
ä¸€å€‹çµ„ä»¶æœ‰äº†ç”¨æˆ¶ç›¸é—œï¼Œåˆæœ‰ä¿¡ç”¨å¡ç›¸é—œï¼Œçµæœå…©ç¨®æ¥­å‹™å°±è€¦åˆäº†&lt;/p>
&lt;blockquote>
&lt;p>è»Ÿé«”çµ„ä»¶ç™¼ç”Ÿçš„åŸå› (è·è²¬)ï¼Œæ‡‰è©²ä¾†è‡ªåŒä¸€å€‹æ¥­å‹™æ–¹ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ç¾¤æœƒå°çµ„ä»¶æå‡ºæ¥­å‹™éœ€æ±‚çš„äºº&lt;/p>
&lt;/blockquote>
&lt;p>ç•¶çµ„ä»¶è¦æ¨¡å¢åŠ ï¼Œæ¥­å‹™é‡å¢åŠ ï¼Œè€ƒæ…®ä½¿ç”¨ SRP æ‹†åˆ†çµ„ä»¶ï¼Œè®“æ¥­å‹™å–®ç´”åŒ–ï¼ŒæŒçºŒè¿­ä»£ï¼Œå¾å¦ä¸€å€‹è§’åº¦ç†è§£ SRP æ˜¯&lt;code>çµ„ä»¶ä¸è©²ç¢°çš„äº‹æƒ…åˆ¥ç¢°&lt;/code>&lt;/p>
&lt;p>è­˜åˆ¥æ˜¯å¦éµå¾ SRP çš„æå•ã€Œé€™å€‹ xxx æ˜¯åšä»€éº¼çš„ï¼Ÿã€/ å¦‚æœç­”æ¡ˆåŒ…å«äº†ã€Œooo &lt;code>å’Œ&lt;/code> xxxã€ï¼Œå‰‡é€šå¸¸é•èƒŒäº† SRP&lt;/p>
&lt;p>å¸¸è¦‹éŒ¯èª¤&lt;/p>
&lt;ol>
&lt;li>ä¸è¦ç”¨è¨‚å–® ID æ ¼å¼ç•¶ä½œåˆ†é¡çš„æ–¹æ³•ï¼Œè€Œæ‡‰è©²ç”¨ç¨ç«‹çš„æ¬„ä½ (ex. çªç„¶è¦æ”¹ id é•·åº¦å°±çˆ†ç‚¸äº†)&lt;/li>
&lt;/ol>
&lt;p>é€éä»¥ä¸‹å•é¡Œæ€è€ƒ SRP æ–¹é‡
&lt;img src="https://yuanchieh.page/post/2021/img/0615/srp_test.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>ä¸ä¸€å®šè¦æ‹†ï¼Œå¦‚æœ 20 å€‹æ–¹æ³•æ˜¯ç·Šè€¦åˆä¹Ÿå±¬æ–¼åŒæ¥­å‹™&lt;/li>
&lt;li>å¯ä»¥ï¼Œä½†è¨ˆç®—æ–¹å¼æ‡‰è©²æ‹†é™¤&lt;/li>
&lt;li>åˆ†é–‹&lt;/li>
&lt;li>æœ€å¥½ä¸è¦ï¼Œç”¨æˆ¶ç­‰ç´šå°±æ˜¯ç­‰ç´šï¼Œç‹€æ…‹å°±æ˜¯ç‹€æ…‹&lt;/li>
&lt;/ol>
&lt;h3 id="å°çµ">å°çµ&lt;/h3>
&lt;ul>
&lt;li>SRP å»ºè­°ï¼šä»»ä½•ä¸€å€‹çµ„ä»¶æ‡‰è©²åªå°åŒä¸€å€‹å®¢æˆ¶/æ¥­å‹™é—œè¯æ–¹çš„éœ€æ±‚è€Œç™¼ç”Ÿè®Šå‹•&lt;/li>
&lt;li>ä¸è©²åšåˆ°çš„äº‹å°±ä¸è¦ç¢°&lt;/li>
&lt;li>è­˜åˆ¥æ˜¯å¦é•å SRP : é€™å€‹çµ„ä»¶/æœå‹™/é¡åˆ¥/æ¬„ä½/å€¼æ˜¯åšä»€éº¼çš„&lt;/li>
&lt;li>å¾è¢«æ›´å‹•çš„çµ„ä»¶è§’åº¦è§£æ±ºæ¥­å‹™çš„è€¦åˆ&lt;/li>
&lt;/ul>
&lt;h2 id="open-close">Open Close&lt;/h2>
&lt;p>å¦‚æœæ¯æ¬¡åŠŸèƒ½ä¿®æ”¹éƒ½æœƒé€ æˆç³»çµ±ä¸€é€£ä¸²çš„çµ„ä»¶ä¿®æ”¹ï¼Œé€™æ¨£å°±ä¸ç¬¦åˆé–‹é–‰åŸå‰‡ï¼Œä¸€èˆ¬æœƒç†è§£æˆ&lt;code>ä¸ä¿®æ”¹åŸå§‹ç¢¼å°±å¯ä»¥æ“´å±•ç³»çµ±è¡Œç‚º&lt;/code> ï¼Ÿï¼é€™æ˜¯é€šéˆå— XD æ€éº¼å¯èƒ½æ²’æœ‰å¯« code è¡Œç‚ºå°±å‡ºç¾&lt;/p>
&lt;p>çœŸæ­£çš„è§£è®€æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>ç³»çµ±è¦å¯ä»¥å¦¥å–„é æ¸¬è¤‡é›œåº¦çš„ç™¼ç”Ÿé»ï¼Œä¸¦å»ºç«‹é©åˆçš„ &lt;code>æ“´å±•é»&lt;/code> ï¼Œè€Œç™¼ç”Ÿè¡Œç‚ºè®Šæ›´æ™‚ï¼Œé€éæ“´å±•é»è®Šæ›´ï¼ŒåŸæœ¬çš„ä¸»æµæˆèˆ‡ä½¿ç”¨è©²æ“´å±•é»æœ¬èº«çš„ client æœ¬èº«ä¸éœ€è¦ä¿®æ”¹&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚æœ‰ä¸€å€‹å¤–è³£å¹³å°ï¼Œæœ‰å¤šç¨®æœƒå“¡èº«ä»½ï¼Œå°æ‡‰ä¸åŒçš„æŠ˜æ•¸ï¼Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-jsx" data-lang="jsx">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">calPrice&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ç”¨æˆ¶æ˜¯å°ˆå±¬æœƒå“¡&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">é‡‘é¡&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">æ‰“ä¸ƒæŠ˜&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ç”¨æˆ¶æ˜¯&lt;/span> &lt;span class="nx">vip&lt;/span> &lt;span class="nx">æœƒå“¡&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">æ‰“å…«æŠ˜&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">æ™®é€šæœƒå“¡&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ä¸Šå€‹æœˆé‚„æ˜¯&lt;/span> &lt;span class="nx">vip&lt;/span> &lt;span class="nx">æœƒå“¡&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">æ‰“å…«æŠ˜&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">åŸåƒ¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœ PM èª¬&lt;/p>
&lt;ol>
&lt;li>æœƒå“¡åˆ¶åº¦å¢åŠ &lt;/li>
&lt;li>èª¿æ•´æŠ˜æ•¸
å‰‡æ•´å€‹è¨ˆåƒ¹éƒ½æœƒå—åˆ°å½±éŸ¿&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥è¤‡é›œåº¦ç™¼ç”Ÿé»åœ¨æ–¼ &lt;code>è¨ˆç®—æ‡‰ä»˜åƒ¹æ ¼&lt;/code> ï¼Œæ‡‰è©²åœ¨æ­¤è™•è¨­è¨ˆæ“´å±•é»ï¼Œé€é Strategy Patternï¼Œå»ºç«‹ UserPayService interfaceï¼Œå°‡è¨ˆç®—é‚è¼¯æ”¾åœ¨ä¸åŒçš„å¯¦ç¾ä¸Š&lt;/p>
&lt;p>å¦‚æœç™¼ç”Ÿ&lt;/p>
&lt;ol>
&lt;li>å¢åŠ æœƒå“¡ç­‰ç´š â‡’ å¢åŠ å¯¦ä½œå³å¯
åŸæœ¬è¨ˆç®—çš„æµç¨‹ä¸éœ€è¦ä¿®æ”¹&lt;/li>
&lt;/ol>
&lt;p>å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://tdd.best/code-4-fun/polymorphism-replace-conditions/" target="_blank" rel="noopener"
>ç”¨å¤šå‹å–ä»£é‡è¤‡çš„åˆ¤æ–·å¼&lt;/a>&lt;/p>
&lt;h3 id="å°çµ-1">å°çµ&lt;/h3>
&lt;p>çµ„ä»¶çš„è€¦åˆï¼Œæœƒè®“å¾®å°çš„è®Šå‹•ä¹Ÿè®“ç³»çµ±æœ‰å¤§å¹…åº¦ä¿®æ”¹ï¼ŒOCP å»ºè­°ï¼šçµ„ä»¶çš„è¨­è¨ˆå¿…é ˆè®“ç³»çµ±æ˜“æ–¼æ“´å±•ï¼Œ&lt;code>åŒæ™‚é™åˆ¶æ¯æ¬¡è¢«ä¿®æ”¹çš„ç¯„åœ&lt;/code>ï¼Œå¯¦ä½œç‚ºå°‡ç³»çµ±åŠƒåˆ†ä¸€ç³»åˆ—çš„çµ„ä»¶ï¼Œå°‡ä¾è³´æ€§é—œä¿‚ä¾ç…§å±¤æ¬¡çµæ§‹çµ„ç¹” (&lt;code>ç©©å®šçš„çµ„ä»¶ä¸è¦ç›¸ä¾æ–¼ä¸ç©©å®šçš„çµ„ä»¶&lt;/code>)ï¼Œå¥—ç”¨åˆ°æ¶æ§‹è¨­è¨ˆä¹Ÿæ˜¯å¦‚æ­¤ (Clean Architecture)&lt;/p>
&lt;p>OCP ä¹Ÿæ˜¯ä¸€å€‹å¾ˆå¥½çµåˆ Design Pattern çš„åŸå‰‡&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0615/open_close.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="ä¾è³´åè½‰åŸå‰‡">ä¾è³´åè½‰åŸå‰‡&lt;/h2>
&lt;p>æ–°æå‡ºçš„è¨­è¨ˆæ¶æ§‹ï¼Œæœƒåˆ†å±¤ä¸åŒçš„æ¥­å‹™
&lt;img src="https://yuanchieh.page/post/2021/img/0615/dip_system_layer.png"
loading="lazy"
>&lt;/p>
&lt;p>ä¾‹å¦‚ç¶²é æ“ä½œæœƒå¾ web ui å±¤ =&amp;gt; controller æ¥­å‹™é‚è¼¯ =&amp;gt; å„²å­˜åˆ° db å±¤å†åŸè·¯è¿”å›çµ¦ clientï¼Œå¯«ç¨‹å¼æ™‚å¦‚æœæŒ‰ç…§é€™æ¨£çš„é †åºï¼Œæœ‰å¯èƒ½ç™¼ç”Ÿé«˜éšçµ„ä»¶ä¾è³´ä½éšçµ„ä»¶ï¼Œä¾‹å¦‚å®¢æˆ¶åŒ¯å‡ºé›²ç«¯ç™¼ç¥¨æœƒå„²å­˜æ–¼ S3ï¼Œé‚£æˆ‘å€‘å¾ˆå®¹æ˜“æŠŠ s3 ä¸Šå‚³é‚è¼¯å¯«æ­»é›²ç«¯ç™¼ç¥¨çš„æ¥­å‹™é‚è¼¯ä¸­ï¼Œä½†å¦‚æœ s3 sdk å‡ç´šæ€éº¼è¾¦ï¼Ÿ&lt;/p>
&lt;p>ä»”ç´°æƒ³æƒ³ã€Œç™¼ç¥¨åŒ¯å‡ºã€çš„æ¥­å‹™éœ€æ±‚è·Ÿã€Œå¯¦éš›ä½¿ç”¨å“ªä¸€é–“é›²æœå‹™ã€æœ‰é—œä¿‚å—ï¼Ÿ
æ‰€ä»¥éœ€è¦ä¸€å€‹ &lt;code>å½ˆæ€§çµ„ç¹”çµ„ä»¶çš„ä¾è³´&lt;/code> ï¼Œå°‡èƒ½åŠ›æŠ½è±¡åŒ–å‡ºæ¥­å‹™è¦å‰‡ï¼Œæ˜ç¢ºå®šç¾©å‡ºä»‹é¢æ–¹æ³•&lt;/p>
&lt;h3 id="å°çµ-2">å°çµ&lt;/h3>
&lt;ol>
&lt;li>ç‚ºäº†é”æˆ OCP æ•ˆæœï¼Œéœ€è¦åšçµ„ä»¶çš„åˆ‡ç‰‡çš„æ–¹å¼ èˆ‡ å½ˆæ€§èª¿æ•´çµ„ä»¶ä¾è³´é—œä¿‚çš„æ–¹æ³•&lt;/li>
&lt;li>ç¨‹å¼ç¢¼ä¾è³´é—œä¿‚æ‡‰å¤šä½¿ç”¨ä»‹é¢ï¼Œè€Œéå…·é«”å¯¦ç¾&lt;/li>
&lt;/ol>
&lt;h2 id="é‡Œæ°æ›¿æ›åŸå‰‡">é‡Œæ°æ›¿æ›åŸå‰‡&lt;/h2>
&lt;p>70 å¹´ä»£è»Ÿé«”è¶Šä¾†è¶Šå¤§ï¼Œé–‹ç™¼çš„æˆæœ¬è¶Šä¾†è¶Šé«˜&lt;br>
â‡’ åŠ å…¥æµç¨‹æ§åˆ¶ / blocks / subroutines åˆ†è§£å¤šå€‹çµ„ä»¶ (modules)ï¼Œçµ„åˆå‡ºçµæ§‹åŒ–çš„ç³»çµ±&lt;br>
â‡’ ç¶“å¸¸æœ‰å¤šå€‹åŠŸèƒ½é¡ä¼¼çš„çµ„ä»¶çµ„ä»¶ï¼Œè®“é€™äº›çµ„ä»¶çµ„ä»¶ä¹‹é–“æœ‰é—œè¯çš„ç‹€æ…‹ï¼Œsmalltalk åŠ å…¥äº† &lt;code>ç¹¼æ‰¿&lt;/code>&lt;br>
â‡’ Liskov æ–¼ 1987 å¹´ç™¼ç¾ç¹¼æ‰¿æœƒå¸¶ä¾†å¯ç¶­è­·æ€§çš„å•é¡Œ&lt;br>
â‡’ B ç¹¼æ‰¿ A -&amp;gt; B is Aï¼Œé€™æ˜¯éå¸¸å¼·çš„è€¦åˆ
æ‰€ä»¥ Liskov æ‰æœƒå»ºè­° æ‰€æœ‰ç”¨ A çš„åœ°æ–¹ä¸€å®šè¦å¯ä»¥ç”¨ B&lt;/p>
&lt;p>åœ¨è€ƒæ…®ä»£ç¢¼è¤‡ç”¨ä¸Šï¼Œå„ªå…ˆè€ƒæ…®çµ„åˆï¼Œå¦‚æœçœŸçš„è¦å¤šæ…‹ï¼Œä½¿ç”¨ interface è·Ÿ abstract class æœƒæ˜¯æ›´å¥½çš„çµ„åˆ&lt;/p>
&lt;h3 id="æ“´å±•é—¡è¿°">æ“´å±•é—¡è¿°&lt;/h3>
&lt;p>æ‰€æœ‰å°æŸå€‹ä»‹é¢ (interface / api)çš„å¯¦ç¾ï¼Œéƒ½å¯ä»¥æ˜¯ä½œç‚ºå°è©²ä»‹é¢çš„ subtypingï¼Œç„¡è«–ä»‹é¢èƒŒå¾Œçš„å¯¦ç¾æ›´å‹•ï¼Œè¡Œç‚ºæ‡‰è©²ä¿æŒè·Ÿç•¶åˆæ‰¿è«¾ä¸€è‡´&lt;/p>
&lt;ul>
&lt;li>api æœƒä¾ç…§ client ç‰ˆè™Ÿç”¢ç”Ÿä¸åŒçš„è¡Œç‚ºï¼Œé€™æœƒç ´å£ç•¶åˆçš„æ‰¿è«¾&lt;/li>
&lt;/ul>
&lt;h2 id="interface-segregation">Interface Segregation&lt;/h2>
&lt;p>Robert Martin åƒèˆ‡å°è¡¨æ©Ÿé–‹ç™¼ï¼Œè™•ç†/å°å‡º/è£è¨‚éƒ½æœƒç”¢ç”Ÿä¸€å€‹å°æ‡‰çš„ job é¡åˆ¥ï¼Œéš¨è‘—é–‹ç™¼è¦æ¨¡ï¼ŒJob å…§æœ‰ä¸Šç™¾å€‹ function èˆ‡éœ€æ±‚ï¼Œæ‰€æœ‰çš„æ¥­å‹™é‚è¼¯éƒ½å¼•ç”¨äº† Jobï¼Œåˆ°å¾Œé¢ Job é¡åˆ¥çš„ typo ä¿®æ­£ï¼Œéƒ½æœƒå°è‡´å°ˆæ¡ˆæ•¸å€‹å°æ™‚çš„ç·¨è­¯æ™‚é–“&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0615/isp.png"
loading="lazy"
>&lt;/p>
&lt;p>é–‹ç™¼åªæ”¹åˆ—å°ç›¸é—œçš„åŠŸèƒ½ï¼Œä½†ä»–ä¸çŸ¥é“å…¶ä»–äººæœ‰æ²’æœ‰ä¾è³´é€™å€‹æ–¹æ³•ï¼Œæ‡‰è©²è¦å…·é«”åŠŸèƒ½é¡èˆ‡ Job é¡é€éä»‹é¢åˆ†é›¢ï¼ŒåŠŸèƒ½é¡åªä¾è³´ä»‹é¢ APIï¼Œè®“å¯¦éš›çš„ Job é¡å·¥ä½œé¿å…äº’ç›¸å¹²æ“¾&lt;/p>
&lt;p>ç•¶ä¸€å€‹åŠŸèƒ½è±å¯Œçš„ concrete class è¦çµ¦å¤šå€‹èª¿ç”¨æ–¹æä¾›åŠŸèƒ½ï¼Œæ‡‰è©²é€éä»‹é¢æˆ–æŠ½è±¡é¡ä¾†æä¾›çµ¦ &lt;code>ä¸åŒèª¿ç”¨æ–¹ä¸åŒçš„åŠŸèƒ½å¤ éä¸åŒçš„ä»‹é¢éš”é›¢&lt;/code>
â‡’ SRP æŒ‡å°çµ„ä»¶çš„è¨­è¨ˆï¼ŒISP ç”¨æ–¼æŒ‡å°ä»‹é¢çš„è¨­è¨ˆ&lt;br>
&lt;img src="https://yuanchieh.page/post/2021/img/0615/isp_result.png"
loading="lazy"
>&lt;/p>
&lt;p>ä¸æ‡‰è®“å®¢æˆ¶ç«¯çŸ¥é“é¡å¤–çš„åŠŸèƒ½&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0615/conclusion.png"
loading="lazy"
>&lt;/p>
&lt;ul>
&lt;li>SRP æ˜¯è»Ÿé«”æ¶æ§‹çš„ç†å¿µå‰æï¼Œä¸€å€‹çµ„ä»¶ä¸æ‡‰è©²è¢«å¤šå€‹ä¸ç›¸é—œçš„æ¥­å‹™è€Œé€ æˆè€¦åˆå¸¶ä¾†ç¶­è­·æ€§ä¸Šçš„å•é¡Œ&lt;/li>
&lt;li>OCP å‰‡æ˜¯è¨­è¨ˆåŸå‰‡çš„æŒ‡å°æ€æƒ³ï¼Œå¯ä»¥é€éè¨­è¨ˆæ¨¡å¼ã€DIP ä¾†é”æˆ&lt;/li>
&lt;li>DIP æè¿°çµ„ä»¶ä¹‹é–“å¦‚ä½•æŠ½è±¡åŒ–èˆ‡çµ„ç¹”çš„æŒ‡å°æ–¹é‡&lt;/li>
&lt;li>LSP ç¢ºä¿ä»‹é¢å¯¦ç¾èˆ‡ä½¿ç”¨æ–¹çš„è€¦åˆï¼Œä¿è­‰ä»‹é¢è¡Œç‚ºçš„ç©©å®š&lt;/li>
&lt;li>ISP ç¶­è­·èˆ‡ä½¿ç”¨ä¸€å€‹çµ„ä»¶è©²æš´éœ²çš„çŸ¥è­˜ï¼Œåœ¨å¯¦ä½œä¸ŠæŒ‡å°ä»‹é¢è¨­è¨ˆ
&lt;ul>
&lt;li>ç•¶ä¸€å€‹ä»‹é¢å› ç‚ºæ¥­å‹™ A è€Œä¿®æ”¹ï¼Œé‚£æ‡‰è©²ä¹Ÿåªæœ‰æ¥­å‹™ A è¢«å½±éŸ¿åˆ°&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0615/extend.png"
loading="lazy"
>&lt;/p></description></item><item><title>Golang ä½µç™¼è™•ç† Mutex / RWMutex / SingleFlight</title><link>https://yuanchieh.page/posts/2021/2021-06-06-golang-%E4%BD%B5%E7%99%BC%E8%99%95%E7%90%86-mutex-/-rwmutex-/-singleflight/</link><pubDate>Sun, 06 Jun 2021 01:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-06-06-golang-%E4%BD%B5%E7%99%BC%E8%99%95%E7%90%86-mutex-/-rwmutex-/-singleflight/</guid><description>&lt;p>åœ¨èˆ‡å…¬å¸å‰è¼©è«‹æ•™æ™‚ï¼Œæœ‰èŠåˆ° Mutex , RWMutex æ€§èƒ½å°æ¯”ï¼Œä»¥åŠä½µç™¼ä¸‹ç”¨ SingleFlight é¿å…æ“Šç©¿å•é¡Œï¼Œæ‰€ä»¥å°±èŠ±é»æ™‚é–“çœ‹å¯¦ä½œèˆ‡ç·´ç¿’ï¼Œç™¼ç¾é€™ç³»åˆ—å¯«å¾—å¤ªå¥½äº† &lt;a class="link" href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/" target="_blank" rel="noopener"
>6.2 åŒæ­¥åŸè¯­ä¸é”&lt;/a>ï¼Œæ‹œè®€éå¾Œæ•´ç†ä»¥ä¸‹çš„æå•&lt;/p>
&lt;h3 id="mutex-å¯¦ä½œ">Mutex å¯¦ä½œ&lt;/h3>
&lt;p>åˆ†æˆå…©ç¨®æ¨¡å¼ï¼šä¸€èˆ¬æ¨¡å¼èˆ‡é£¢é¤“æ¨¡å¼
å–å¾— Lock æ™‚&lt;/p>
&lt;ol>
&lt;li>æ²’æœ‰äººä½”ç”¨å‰‡ç›´æ¥å–å¾—&lt;/li>
&lt;li>æœ‰äººå ç”¨æ™‚ï¼Œå¦‚æœåˆ¤æ–·æ˜¯å¦èƒ½é€²å…¥è‡ªæ—‹æ¨¡å¼ï¼Œæ‰€è¬‚çš„è‡ªæ—‹æ˜¯é€éæ¶ˆè€— CPU cylcles çš„ buzy waitingï¼Œé™ä½ context switch çš„èŠ±è²»&lt;/li>
&lt;li>é‡æ–°å˜—è©¦å–å¾—é–ï¼Œå¦‚æœæ²’æœ‰å–å¾—é–ï¼Œç­‰åˆ°æ™‚é–“è¶…é 1ms å‰‡é€²å…¥é£¢é¤“æ¨¡å¼ï¼Œä¸¦ç­‰å¾…ä¿¡è™Ÿ (runtime_SemacquireMutex)&lt;/li>
&lt;/ol>
&lt;h3 id="rwmutex-æœƒç”¢ç”Ÿ-write-starvation-å—">RWMutex æœƒç”¢ç”Ÿ Write Starvation å—ï¼Ÿ&lt;/h3>
&lt;p>RWMutex æ¡ç”¨å¯«å…¥å„ªå…ˆï¼Œå¦‚æœåœ¨å–å¾— RWMutex å¯«é–æ™‚ï¼Œç™¼ç¾ç›®å‰æœ‰å¤šå€‹è®€é–&lt;/p>
&lt;ol>
&lt;li>å…ˆå°‡ readerCount è®Šæˆè² æ•¸ï¼Œè®“å¾ŒçºŒè®€é–éƒ½ç„¡æ³•å–å¾—&lt;/li>
&lt;li>ç­‰åˆ°ä¿¡è™Ÿ writerSem å–šé†’&lt;/li>
&lt;/ol>
&lt;p>è®€é–åœ¨å–å¾—æ™‚&lt;/p>
&lt;ol>
&lt;li>æª¢æŸ¥ readerCount æ˜¯å¦ç‚ºè² æ•¸ï¼Œå¦‚æœæ˜¯ä»£è¡¨æœ‰å¯«é–&lt;/li>
&lt;li>å¦‚æœæœ‰å¯«é–ï¼Œå‰‡åµè½ readerSem ä¿¡è™Ÿå–šé†’åŸ·è¡Œ&lt;/li>
&lt;/ol>
&lt;p>åœ¨è§£é™¤å¯«é– / è®€é–ï¼Œæœƒåˆ†åˆ¥å»å‡ºç™¼ä¿¡è™Ÿï¼Œè®“ç­‰å¾…çš„è®€é– / å¯«é–é–‹å§‹åŸ·è¡Œ&lt;/p>
&lt;h3 id="rwmutex-è·Ÿ-mutex-æ•ˆèƒ½æ¯”è¼ƒ">RWMutex è·Ÿ Mutex æ•ˆèƒ½æ¯”è¼ƒ&lt;/h3>
&lt;p>å¯¦éš›æ¸¬è©¦çš„çµæœï¼Œè¨­å®šä¸€å€‹å¯«å…¥æ¯”ç‡ï¼Œå–®ç´”æ¯”è¼ƒå–é–/é‡‹æ”¾é–ï¼Œè·‘ä¸€ç™¾è¬æ¬¡å…©è€…å·®ç•°ä¸å¤§&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">BenchmarkMutexTest-8 10000000 0.04064 ns/op
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BenchmarkRWMutexTest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BenchmarkRWMutexTest-8 10000000 0.04699 ns/op
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BenchmarkFakeWrite
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŠ å…¥äº†è®€å–è·Ÿå¯«å…¥ï¼Œæœ‰äº›æ¸¬è©¦æœƒç”¨ time.Sleep ï¼Œä½†æˆ‘å¯¦é©—å› ç‚ºåŒæ™‚è·‘ goroutine é—œä¿‚ï¼Œå¦‚æœå…¨éƒ¨ goroutine éƒ½åœ¨ sleep æœƒå‡ºéŒ¯ï¼Œæ‰€ä»¥æ”¹ç”¨ç°¡å–®çš„è¨ˆæ•¸å¾é›¶æ•¸åˆ°ä¸€ç™¾è¬ç•¶ä½œè®€å–ï¼Œè€Œå¯«å…¥å‰‡æ˜¯äº”å€çš„è®€å–æ™‚é–“&lt;/p>
&lt;p>å¯«å…¥æ¯”ä¾‹æŠ“ 0.2 çš„è©±ï¼ŒRWMutex ç”¨èµ·ä¾†æœ‰å„ªå‹¢å¾ˆå¤š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">BenchmarkMutexTest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BenchmarkMutexTest-8 10000 58176 ns/op
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BenchmarkRWMutexTest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BenchmarkRWMutexTest-8 10000 37176 ns/op
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¸¬è©¦çš„ç¨‹å¼ç¢¼åœ¨æ­¤ &lt;a class="link" href="https://github.com/sj82516/go-rwmutex-benchmark" target="_blank" rel="noopener"
>go-rwmutex-benchmark&lt;/a>&lt;/p>
&lt;p>ç¸½çµ&lt;/p>
&lt;blockquote>
&lt;p>RWMutex æ¸¬è©¦èµ·ä¾†æ•ˆèƒ½è »å¥½çš„ï¼Œåœ¨è€ƒé‡åˆ°è®€å–æ¯”è¼ƒå¤šçš„æƒ…æ³è¡¨ç¾æœƒæ¯” Mutex é‚„è¦å¥½&lt;/p>
&lt;/blockquote>
&lt;h2 id="singleflight">Singleflight&lt;/h2>
&lt;p>ç•¶ Server åœ¨è™•ç†ä½µç™¼æ™‚ï¼Œæœƒé¿å…å¤§é‡é‡è¤‡çš„æŸ¥è©¢æ“ä½œé€²å…¥ DB ä¸­ï¼Œé€™å°¤å…¶æœƒç™¼ç”Ÿåœ¨ Cache å¤±æ•ˆçš„ç•¶ä¸‹ï¼Œæœ€ç†æƒ³ç‹€æ³æ˜¯&lt;code>æ‰€æœ‰åŒæ¨£çš„æŸ¥è©¢åªè¦é€² DB æŸ¥ä¸€æ¬¡ï¼Œå…¶ä»–æŸ¥è©¢ç­‰å¾…è¿”å›ç›¸åŒçš„çµæœ&lt;/code>&lt;br>
é€™æ¨£çš„æƒ…å¢ƒå¯ä»¥ä½¿ç”¨ &lt;a class="link" href="https://medium.com/@vCabbage/go-avoid-duplicate-requests-with-sync-singleflight-311601b3068b" target="_blank" rel="noopener"
>Singleflight&lt;/a>ï¼Œæä¾›é˜»å¡å…¶é¤˜æŸ¥è©¢ï¼Œåªè®“ä¸€å€‹æŸ¥è©¢ç™¼ç”Ÿçš„æ©Ÿåˆ¶ï¼Œä¸¦å°å¤–é–‹æ”¾ä¸‰å€‹æ–¹æ³•&lt;/p>
&lt;ul>
&lt;li>Do: ä½¿ç”¨è€…æŒ‡å®š Key èˆ‡å—ä¿è­·çš„æ–¹æ³•ï¼ŒåŒä¸€æ™‚é–“åªæœ‰ä¸€å€‹ä¿è­·æ–¹æ³•æœƒè¢«åŸ·è¡Œï¼Œå…¶é¤˜é€²ä¾†çš„å‘¼å«æœƒç­‰å¾…&lt;/li>
&lt;li>DoChan: åŒæ–¼ Doï¼Œä½†è¿”å› channelï¼Œå¯ä»¥æ­é… timeout ä½¿ç”¨&lt;/li>
&lt;li>Forget: æœ‰æ™‚å€™æœƒå¸Œæœ›ä¸»å‹•è®“ Key ä¸å†ä¿è­·ï¼Œä¾‹å¦‚éäº†æ•¸ç§’ç‚ºäº†é¿å…è®€å–å¤ªèˆŠçš„å€¼ï¼Œå¯ä»¥ä¸»å‹•åˆªé™¤ Key è®“ä¸‹ä¸€å€‹ä¿è­·æ–¹æ³•å¯ä»¥åŸ·è¡Œ (å³ä½¿å‰è€…å°šæœªè¿”å›)&lt;/li>
&lt;/ul>
&lt;p>æ›´è©³ç´°å…§å®¹å¯åƒè€ƒæ­¤ç¯‡ &lt;a class="link" href="https://medium.com/@vCabbage/go-avoid-duplicate-requests-with-sync-singleflight-311601b3068b" target="_blank" rel="noopener"
>Go: Avoid duplicate requests with sync/singleflight&lt;/a>ï¼Œè‡ªå·±å¯«äº†ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ &lt;a class="link" href="https://play.golang.org/p/_uGNGjyMJ5f" target="_blank" rel="noopener"
>go playground&lt;/a>&lt;/p>
&lt;p>Singleflight çš„å¯¦ä½œä¹Ÿååˆ†ç²¾ç·´ï¼Œç”¨ä¸€å€‹ map ä¿å­˜ key å°æ‡‰ structï¼Œstruct è£¡é¢æ”¾ mutext é¿å…åŒæ­¥æ“ä½œ / wg è®“å…¶ä»–å‘¼å«ç™¼ç¾æœ‰äººåœ¨åŸ·è¡Œå°±ä¹–ä¹–ç­‰å¾… ï¼Œå¯åƒè€ƒ &lt;a class="link" href="https://segmentfault.com/a/1190000018464029" target="_blank" rel="noopener"
>golangé˜²ç¼“å­˜å‡»ç©¿åˆ©å™¨&amp;ndash;singleflight&lt;/a>&lt;/p>
&lt;h3 id="typescript-å¯¦ä½œ">typescript å¯¦ä½œ&lt;/h3>
&lt;p>å¾Œä¾†è¦ºå¾—é —æœ‰è¶£å°±è‡ªå·±å¯¦ä½œä¸€å€‹ typescript ç‰ˆæœ¬ï¼š&lt;a class="link" href="https://github.com/sj82516/go-singleflight" target="_blank" rel="noopener"
>sj82516/go-singleflight&lt;/a>ï¼ŒåŸæœ¬æƒ³è¦å¤šä¸€å€‹å„²å­˜çš„ adpter æ”¯æ´ redisï¼Œä½†å¡åœ¨ Object / Error è¦å¦‚ä½• serialize / deserialize å°±å…ˆä¸­æ­¢äº†&lt;/p>
&lt;h2 id="go-assembler">Go Assembler&lt;/h2>
&lt;p>å¾€ä¸‹è¿½ &lt;code>&amp;quot;sync/atomic&amp;quot;&lt;/code> ç™¼ç¾æ²’æœ‰ç›¸é—œçš„ CompareAndSwapInt32 çš„ç¨‹å¼ç¢¼ï¼Œé€™æ˜¯å› ç‚ºé€™äº›éƒ¨åˆ†æ˜¯åœ¨ runtime ç”¢ç”Ÿï¼Œatomic æŒ‡ä»¤å¿…é ˆç”± CPU æä¾›æ‰èƒ½ä¿è­‰åŸ·è¡Œæ™‚çš„åŸå­æ€§ï¼Œè€ŒæŒ‡ä»¤å‰‡æ˜¯å„å¹³å°é™å®šï¼Œå¦‚ x86 / x64 / arm 32 / arm 64 / powerpc ç­‰ç­‰ï¼Œé€™åœ¨ç·¨è­¯çš„æ™‚å€™å¯ä»¥é€é &lt;code>GOARCH / GOOS&lt;/code> æŒ‡å®šç·¨è­¯çš„å¹³å°&lt;/p>
&lt;p>è£œå……è³‡æ–™å¯ä»¥åƒè€ƒ&lt;/p>
&lt;ol>
&lt;li>é«˜éšèªè¨€å¦‚ä½•è®Šæˆæ©Ÿå™¨å¯åŸ·è¡Œçš„ä½å…ƒæª”ï¼š&lt;a class="link" href="https://www.youtube.com/watch?v=N2y6csonII4" target="_blank" rel="noopener"
>Compiling, assembling, and linking&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=KINIAgRpkDA" target="_blank" rel="noopener"
>GopherCon 2016: Rob Pike - The Design of the Go Assembler&lt;/a> / æ–‡å­—èªªæ˜ &lt;a class="link" href="https://medium.com/martinomburajr/go-tools-the-compiler-part-1-assembly-language-and-go-ffc42cbf579d" target="_blank" rel="noopener"
>Go Tools: The Compiler â€” Part 1 Assembly Language and Go&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>Rob Pike èªªæ˜ä¸€é–‹å§‹ Go çš„åŸå§‹ç¢¼æœ‰ä½¿ç”¨ C/Yaac å®Œæˆç·¨è­¯çš„æ–¹å¼ï¼Œä½†å› ç‚ºé›£ç®¡ç†å¾Œä¾†åœ¨ Go 1.3 é–‹å§‹æ±°æ›æˆ Go å¯¦ä½œ&lt;/p>
&lt;p>é€™é‚Šå¯¦ä½œæœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼ Rob Pike è¡¨ç¤ºé›–ç„¶æ¯å€‹å¹³å°çš„æŒ‡ä»¤/æš«å­˜å™¨åç¨±éƒ½ä¸åŒï¼Œä½†æ˜¯åŸºæœ¬çš„ä½¿ç”¨å¯ä»¥è¢«æŠ½è±¡åŒ–ï¼Œæ‰€ä»¥ Go Compiler æœƒç·¨è­¯å‡º semi pseudo codeï¼Œæ¥è‘—ä¾ç…§æŒ‡å®šçš„å¹³å°è½‰æ›æˆå°æ‡‰çš„ assembly codeï¼Œé€™éƒ¨åˆ†å¯¦ä½œäº† &lt;code>obj&lt;/code> library&lt;/p>
&lt;p>é€™æ¨£çš„å¥½è™•æ˜¯å°æ–¼ Compiler ä¾†èªªç”¢ç”Ÿ semi pseudo code å°±æ˜¯å–®ç´”çš„æ–‡å­—è½‰æ›&lt;/p>
&lt;p>åœ¨å½±ç‰‡ä¸­çš„ç¯„ä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ADDW&lt;/span> &lt;span class="nx">AX&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">BX&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-----&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Prod&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">As&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">arch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;ADDW&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">From&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Addr&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Reg&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">arch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Register&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;AX&amp;#34;&lt;/span>&lt;span class="p">]},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">To&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Addr&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Reg&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">arch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Register&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;BX&amp;#34;&lt;/span>&lt;span class="p">]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€å¾Œæåˆ°ä»–å€‘åœ¨é–‹ç™¼å·¥å…·ï¼Œç›´æ¥è®€ PDF ç”¢ç”Ÿå„å¹³å°å°æ‡‰çš„ instruction set
&lt;img src="https://yuanchieh.page/"
loading="lazy"
>&lt;/p>
&lt;p>åœ¨æ€è€ƒçš„éç¨‹ä¸­ï¼Œé–‹å§‹æƒ³ assembly å¤¾åœ¨ source code / machine code çš„åœ°ä½ï¼Œé€™ä¸€ç¯‡ SO çµ¦å‡ºäº†å›ç­” &lt;a class="link" href="https://stackoverflow.com/questions/51780158/why-do-we-even-need-assembler-when-we-have-compiler" target="_blank" rel="noopener"
>Why do we even need assembler when we have compiler?&lt;/a>&lt;br>
æ­£å¦‚åŒå¤¾åœ¨ä¸­é–“çš„åœ°ä½ï¼Œmachine code äººé¡ç„¡æ³•è®€ï¼Œsource code åˆå¤ª high levelï¼Œå¦‚æœè¦ç¢ºèª compiler æ˜¯å¦ç·¨è­¯å‡ºæœ‰æ•ˆçš„ machine codeï¼Œé‚£æŸ¥çœ‹ assembly çœ‹å¯¦éš›äººé¡å¯è®€çš„æŒ‡ä»¤æ˜¯æœ€å¥½çš„&lt;/p>
&lt;p>Go ç·¨è­¯éç¨‹å¯åƒè€ƒ &lt;a class="link" href="https://draveness.me/golang/docs/part1-prerequisite/ch02-compile/golang-compile-intro/" target="_blank" rel="noopener"
>Go è¯­è¨€è®¾è®¡ä¸å®ç° &lt;/a>&lt;/p>
&lt;p>å­˜åƒå€‹åœ¨ SO ä¸Šè¢«æ‰£åˆ†çš„ç™¼å• &lt;a class="link" href="https://stackoverflow.com/questions/67855719/why-assembly-is-unportable?noredirect=1#comment119941280_67855719" target="_blank" rel="noopener"
>Why assembly is unportable&lt;/a>ï¼Œcomment æœ‰å¾ˆå¤šè§£é‡‹ä¹‹å¾Œæ…¢æ…¢ç´°è®€å†è£œå……&lt;/p></description></item><item><title>æ·±å…¥ç†è§£ WebRTC</title><link>https://yuanchieh.page/posts/2021/2021-05-30-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-webrtc/</link><pubDate>Sun, 30 May 2021 07:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-05-30-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-webrtc/</guid><description>&lt;p>å››å¹´å‰æ›¾ç¶“å°æ–¼ WebRTC æä¾› P2P å½±éŸ³ä¸²æµæ„Ÿåˆ°æ–°å¥‡ï¼Œå¯«ä¸‹äº† &lt;a class="link" href="http://sj82516-blog.logdown.com/post/1207821" target="_blank" rel="noopener"
>WebRTC-ä»‹ç´¹èˆ‡å¯¦æˆ°&lt;/a>ï¼›&lt;br>
å¾Œä¾†åœ¨å·¥ä½œä¸­ï¼Œé–‹å§‹æ›´æ·±å…¥ä½¿ç”¨ WebRTCï¼Œä¹Ÿé–‹å§‹è‡ªæ¶ TURN Serverï¼Œå¾ Spec è§’åº¦èªè­˜äº†&lt;br>
&lt;a class="link" href="https://yuanchieh.page/posts/2019/2019-10-02-sdp-spec-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/" target="_blank" rel="noopener"
>SDP Spec é–±è®€ç­†è¨˜&lt;/a> &lt;br>
&lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-09-22-rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/" target="_blank" rel="noopener"
>RFC 5389 - STUN å”å®šä»‹ç´¹&lt;/a>&lt;br>
&lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/" target="_blank" rel="noopener"
>Coturn Server æ¶è¨­æ•™å­¸ - on AWS&lt;/a>&lt;/p>
&lt;p>åªæ˜¯ä½¿ç”¨ä¸Šæˆ–ç†è§£ä¸Šï¼Œå§‹çµ‚åœç•™æ–¼æ¯”è¼ƒè¡¨å±¤çš„ SDK API å‘¼å«æˆ–æ˜¯æ–‡ä»¶é–±è®€ï¼Œè€Œæ²’æœ‰çœŸæ­£å¾å¤§æ–¹å‘ç†è§£ï¼Œæ±ºå®šå¾ &lt;a class="link" href="https://webrtcforthecurious.com/" target="_blank" rel="noopener"
>WebRTC For The Curious&lt;/a> æ·±å…¥ç†è§£ WebRTC çš„åŸç†èˆ‡ç´°ç¯€&lt;/p>
&lt;p>æœ¬ç¯‡æ–‡ç« å…§å®¹æœƒæ¶µè“‹&lt;/p>
&lt;ol>
&lt;li>WebRTC åˆ°åº•æ˜¯ä»€éº¼&lt;/li>
&lt;li>WebRTC çš„é€£ç·šç”±å§‹è€Œçµ‚çš„æµç¨‹&lt;/li>
&lt;/ol>
&lt;h2 id="ä»€éº¼æ˜¯-webrtc">ä»€éº¼æ˜¯ WebRTC&lt;/h2>
&lt;p>ä»¥ä¸‹å…§å®¹ç†è§£è‡ª &lt;a class="link" href="https://webrtcforthecurious.com/" target="_blank" rel="noopener"
>WebRTC For The Curious&lt;/a>&lt;/p>
&lt;p>WebRTC æ˜¯ Web Real-Time Communication ç¸®å¯«ï¼Œæœ¬èº«æ˜¯ API ä¹Ÿæ˜¯ Protocolï¼Œä¸»è¦æ˜¯å¯ä»¥è®“å…©å€‹ WebRTC Agent å»ºç«‹ &lt;code>å³æ™‚ã€é›™å‘ã€å®‰å…¨&lt;/code>çš„ä¸²æµï¼ŒWebRTC API å‰‡æ˜¯éµå®ˆ Protocol å®šç¾©æ‰€æä¾›çš„å¯¦ä½œï¼Œç›®å‰å¤šå®¶ç€è¦½å™¨éƒ½æœ‰å¯¦ä½œ WebRTC APIï¼Œä¹Ÿæœ‰é Javascript çš„ WebRTC API å¯¦ä½œ&lt;/p>
&lt;p>WebRTC protocol æœ¬èº«åªæ˜¯é›†åˆäº†å¤šå€‹å·²çŸ¥ã€ç©©å®šçš„å”å®šè€Œæä¾›çš„å®Œæ•´è§£æ±ºæ–¹æ¡ˆï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ­¥é©Ÿ&lt;/p>
&lt;h3 id="ä¸€-signaling">ä¸€. Signaling&lt;/h3>
&lt;p>ç•¶å…©å€‹ Agent è¦äº’ç›¸æºé€šæ™‚ï¼Œä»–å€‘ä¸çŸ¥é“å½¼æ­¤çš„ä½ç½®ã€å½¼æ­¤æ”¯æ´çš„å½±éŸ³ç‰ˆæœ¬ç­‰ç­‰ï¼Œæ­¤æ™‚æœƒéœ€è¦ &lt;code>SDP&lt;/code> æè¿°é›™æ–¹ç‹€æ…‹ï¼Œä¸¦é€éç®¡é“æºé€šï¼ŒSDP æ˜¯ä¸€å€‹ç”± Key-Pair çµ„æˆçš„æ–‡æœ¬å”å®šï¼Œåªè¦åŒ…å«ä»¥ä¸‹å¹¾å€‹é …ç›®ï¼š&lt;/p>
&lt;ol>
&lt;li>IP/Port (Candidate)&lt;/li>
&lt;li>Agent é æœŸæœ‰å¹¾å€‹ Audio/Video Track&lt;/li>
&lt;li>Audio/Video codec æ”¯æ´&lt;/li>
&lt;li>é€£ç·šè³‡è¨Š (å¦‚ Frag ç­‰)&lt;/li>
&lt;li>å®‰å…¨æ€§è³‡è¨Š (å¦‚ Fingerprint ç­‰)&lt;/li>
&lt;/ol>
&lt;p>éœ€æ³¨æ„&lt;code>å¦‚ä½•äº¤æ› SDP&lt;/code> ä¸å† WebRTC å®šç¾©ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„å”å®šå¦‚ HTTP / Websocket / XMPP ç­‰ï¼Œåªè¦ Agent ä¹‹é–“èƒ½å¤ äº¤æ›å³å¯&lt;/p>
&lt;h3 id="äºŒ-connecting">äºŒ. Connecting&lt;/h3>
&lt;p>WebRTC Agent è¦æº–å‚™å»ºç«‹é€£ç·šæ™‚ï¼Œæœƒé€é &lt;code>ICE (Interactive Connectivity Establishment)&lt;/code>ï¼ŒAgent æœ¬èº«å¯èƒ½åœ¨åŒå€‹ Local å€ç¶²ä¸‹ï¼Œä¹Ÿå¯èƒ½åœ¨ä¸–ç•Œçš„å…©ç«¯ï¼Œé€é ICE æ‰¾å‡ºå…©å€‹ Agent èƒ½å¤ ç›´æ¥é€£ç·šçš„æ–¹å¼ï¼Œé€™èƒŒå¾Œéš±è—äº† NAT Traversal èˆ‡ STUN/TURN ç´°ç¯€ï¼Œæœƒåœ¨å¾ŒçºŒä»‹ç´¹&lt;/p>
&lt;h3 id="ä¸‰-security">ä¸‰. Security&lt;/h3>
&lt;p>å»ºç«‹é›™å‘é€£ç·šå¾Œï¼ŒWebRTC æœƒåœ¨å¢åŠ é€£ç·šçš„å®‰å…¨æ€§ï¼Œé€é DTLS (Datagram Transport Layer Security) UDP over TLS èˆ‡ SRTP (Secure Real-time Transport Protocol)&lt;/p>
&lt;p>DTLS ä¸»è¦ç”¨æ–¼ Data Channelï¼ŒWebRTC é€é DTLS äº¤æ¡å»ºç«‹å®‰å…¨é€£ç·šï¼Œå…¶ä¸­ TLS é©—è­‰éƒ¨åˆ†ç•¥èˆ‡ HTTPS éç¨‹ä¸åŒï¼Œåœ¨ WebRTC ä¸­æ²’æœ‰å»å‘ CA é©—è­‰æ†‘è­‰ï¼Œè€Œæ˜¯é€éå…ˆå‰ Signaling äº¤æ›çš„ fingerprint æª¢æŸ¥&lt;/p>
&lt;p>è€Œ Audio/Video ä¸²æµå‰‡æ˜¯é€é RTPï¼Œç‚ºäº†å¤šç–ŠåŠ ä¸€å±¤å®‰å…¨æ€§æ¡ç”¨ SRTP å‚³è¼¸ RTP å…§å®¹ï¼Œæ‰€æ¡ç”¨çš„åŠ å¯†é‡‘é‘°å‰‡æ˜¯é€é Data Channel æ‰€äº¤æ›&lt;/p>
&lt;p>ç›®å‰å°±æˆåŠŸå»ºç«‹é›™å‘ã€å®‰å…¨çš„é€£ç·šå¾Œï¼Œä½†æ˜¯å½±éŸ³ä¸²æµé‚„å¿…é ˆè€ƒé‡åˆ°ç¶²è·¯ç‹€æ³ï¼Œå¦‚å°åŒ…éºå¤±ã€é »å¯¬é™åˆ¶ç­‰å•é¡Œ&lt;/p>
&lt;h3 id="å››-communicating">å››. Communicating&lt;/h3>
&lt;p>æ¡ç”¨ SCTP (Stream Control Transmission Protocol) åšå‚³è¼¸ç‹€æ³çš„ç›£æ§ã€æµé‡ç®¡åˆ¶ï¼Œå¯¦éš›ä¸Š SCTP çš„å°åŒ…æ˜¯é€é Data Channel èµ° DTLS&lt;/p>
&lt;p>å…¨éƒ¨ç¸½çµï¼ŒWebRTC å°±æ˜¯ç”±é€™äº›å”å®šæ‰€é›†çµè€Œæˆçš„
&lt;img src="https://yuanchieh.page/post/img/20210108/webrtc-protocol.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="webrtc-api">WebRTC API&lt;/h3>
&lt;p>å¿«é€Ÿéä¸€ä¸‹ API è¨­è¨ˆ&lt;/p>
&lt;h4 id="1-new-peerconnection">1. new PeerConnection&lt;/h4>
&lt;p>å»ºç«‹ WebRTC Sessionï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°çš„æ‰€æœ‰ Protocol é›†åˆ&lt;/p>
&lt;h4 id="2-addtrack">2. addTrack&lt;/h4>
&lt;p>å»ºç«‹ RTP Streamï¼Œä¸¦ç¶å®šä¸€å€‹éš¨æ©Ÿç”¢ç”Ÿçš„ SSRCï¼Œä¹‹å¾Œåœ¨ createOffer æ™‚æœƒå¸¶åœ¨ SDP ç•¶ä¸­ä¸¦å»ºç«‹å°æ‡‰çš„ media sessionï¼Œæ¯ç•¶ addTrack ä¸€æ¬¡éƒ½æœƒå»ºç«‹æ–°çš„ RTP Stream&lt;/p>
&lt;p>åªè¦ ICE å¾ŒæˆåŠŸå»ºç«‹ SRTP é€£ç·šï¼Œmedia packets å°±æœƒé¦¬ä¸Šå‚³é€å‡ºå»&lt;/p>
&lt;h4 id="3-createdatachannel">3. createDataChannel&lt;/h4>
&lt;p>å¦‚æœ SCTP é€£ç·šé‚„æ²’å»ºç«‹å‰‡æ–°å»ºç«‹ä¸€å€‹ï¼Œé è¨­åªæœ‰åœ¨æŸä¸€æ–¹è¦æ±‚ data channel æ‰æœƒå»ºç«‹&lt;/p>
&lt;p>ç•¶ DTLS æˆåŠŸå»ºç«‹é€£ç·šå¾Œï¼ŒSCTP packets å°±æœƒé–‹å§‹å‚³é€&lt;/p>
&lt;h4 id="4-createoffer">4. createOffer&lt;/h4>
&lt;p>å»ºç«‹ local SDP&lt;/p>
&lt;h4 id="5-setlocaldescription">5. setLocalDescription&lt;/h4>
&lt;p>å…ˆå‰çš„ addTrack / createDataChannel åªæ˜¯æš«æ™‚æ€§çš„ï¼Œåªæœ‰ç•¶å‘¼å« setLocalDescription æ‰ç¢ºå®šå¥—ç”¨ä¿®æ”¹&lt;/p>
&lt;p>é€šå¸¸å‘¼å« setLocalDescription å°±æœƒå‚³é€ offer è®“å°æ–¹ setRemoteDescription&lt;/p>
&lt;h4 id="6-setremotedescription">6. setRemoteDescription&lt;/h4>
&lt;p>setRemoteDescription é€šçŸ¥ local agent å°æ–¹çš„ candidate ç‹€æ…‹ï¼Œå¦‚æœé›™æ–¹éƒ½ setRemoteDescriptionå°±å¯ä»¥é–‹å§‹ connecting&lt;/p>
&lt;h4 id="7-addicecandidate">7. addIceCandidate&lt;/h4>
&lt;p>é€šçŸ¥ WebRTC Agent å¢åŠ  remote ICE candidate&lt;/p>
&lt;h4 id="8-ontrack">8. ontrack&lt;/h4>
&lt;p>ç•¶ RTP stream æ¥æ”¶åˆ°å°åŒ…æ™‚è§¸ç™¼äº‹ä»¶ï¼Œå°åŒ…æ‡‰è©²æœƒå»åˆ setRemoteDescription æ™‚æŒ‡å®šçš„æ ¼å¼&lt;/p>
&lt;p>WebRTC æœƒé€é SSRC ç¢ºèªå°æ‡‰çš„ Media Stream&lt;/p>
&lt;h4 id="9-oniceconnectionstatechange">9. oniceconnectionstatechange&lt;/h4>
&lt;p>å¦‚æœ ICE Agent æœ‰ç•°å‹•æœƒè§¸ç™¼äº‹ä»¶ï¼Œåƒæ˜¯é‡åˆ°ç¶²è·¯ç‹€æ³ç­‰&lt;/p>
&lt;h4 id="10-onstatechange">10. onstatechange&lt;/h4>
&lt;p>ICE Agent / DTLS Agent ç‹€æ…‹ç•°å‹•æ™‚æœƒè§¸ç™¼äº‹ä»¶&lt;/p>
&lt;h2 id="ä¸€-signaling-1">ä¸€. Signaling&lt;/h2>
&lt;p>WebRTC Agent ä¸€é–‹å§‹å»ºç«‹æ™‚ä¸¦ä¸çŸ¥é“è©²èˆ‡èª°é€šè¨Šã€ä¹Ÿä¸çŸ¥é“è©²ç”¨ä»€éº¼æ ¼å¼ï¼Œæ‰€ä»¥æœƒéœ€è¦åœ¨åˆå§‹åŒ–æ™‚åš Signalingï¼Œè®“å¾ŒçºŒçš„é€£ç·šæœ‰æ©Ÿæœƒç™¼ç”Ÿ&lt;br>
WebRTC ä¸¦æ²’æœ‰ç¡¬æ€§è¦å®š Signaling å‚³è¼¸çš„æ©Ÿåˆ¶ï¼Œå¸¸è¦‹åšæ³•æ˜¯é€é Websocket&lt;/p>
&lt;h3 id="ä»€éº¼æ˜¯-sdp">ä»€éº¼æ˜¯ SDP&lt;/h3>
&lt;p>WebRTC ä»°è³´ SDP äº¤æ›å»ºç«‹é€£ç·šæ‰€éœ€çš„è³‡è¨Šï¼ŒSDP æœ¬èº«ç›¸ç•¶å¥½ç†è§£ï¼Œåªæ˜¯è¦å»ç†è§£ WebRTC è‡ªå®šç¾©çš„åƒæ•¸èˆ‡ä»£è¡¨å€¼&lt;/p>
&lt;p>SDP å®šç¾©åœ¨ &lt;a class="link" href="https://tools.ietf.org/html/rfc4566" target="_blank" rel="noopener"
>RFC4566&lt;/a>ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€å€‹ key / value çµ„åˆï¼Œä¸€ä»½ SDP ä¸­å¯ä»¥åŒ…å«å¤šå€‹ Media Descriptionï¼Œè€Œä¸€å€‹ Media Description é€šå¸¸ä»£è¡¨ä¸€å€‹ Media Stream&lt;br>
ä¾‹å¦‚èªªä¸€å€‹å½±ç‰‡æœ‰å…©å€‹ Video Stream å¤–åŠ ä¸‰å€‹ Audio Streamï¼Œé‚£å°±éœ€è¦äº”å€‹ Media Description æè¿°&lt;/p>
&lt;h4 id="å¦‚ä½•è§£è®€-sdp">å¦‚ä½•è§£è®€ SDP&lt;/h4>
&lt;p>SDP æ ¼å¼ç‚º &lt;code>k=value&lt;/code>ï¼Œéµé€šå¸¸æ˜¯ä¸€å€‹è‹±æ–‡å­—æ¯ä»£è¡¨ï¼Œç­‰è™Ÿå¾Œé€£æ¥å€¼ï¼Œä»¥ä¸‹æ˜¯å®šç¾©çš„å¹¾å€‹éµ&lt;/p>
&lt;ol>
&lt;li>&lt;code>v&lt;/code>: Versionï¼Œä»£è¡¨ç‰ˆæœ¬&lt;/li>
&lt;li>&lt;code>o&lt;/code>: Originï¼Œé€šå¸¸ä»£è¡¨ id ç”¨ä»¥è­˜åˆ¥&lt;/li>
&lt;li>&lt;code>s&lt;/code>: Session åç¨±&lt;/li>
&lt;li>&lt;code>t&lt;/code>: Timingï¼Œé€šå¸¸æ˜¯ &lt;code>0 0&lt;/code>&lt;/li>
&lt;li>&lt;code>m&lt;/code>: Media Description&lt;/li>
&lt;li>&lt;code>a&lt;/code>: Attribute æœ€å¸¸è¦‹çš„éµ&lt;/li>
&lt;li>&lt;code>c&lt;/code>: Connectionï¼Œé€šå¸¸æ˜¯ &lt;code>IN IP4 0.0.0.0&lt;/code>&lt;/li>
&lt;/ol>
&lt;h4 id="media-description">Media Description&lt;/h4>
&lt;p>ä¸€å€‹ Session Description é€šå¸¸åŒ…å«å¤šå€‹ Media Descriptionï¼Œè€Œ Media Description å‰‡ç”±ä¸€é€£ä¸²çš„ RTP Payload çš„æ ¼å¼å®šç¾©ï¼Œå¯¦éš›çš„ codec æœƒä»¥ &lt;code>rtpmap&lt;/code> è¡¨ç¤º
å¦‚ä»¥ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">v=0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">m=audio 4000 RTP/AVP 111
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=rtpmap:111 OPUS/48000/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">m=video 4000 RTP/AVP 96
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=rtpmap:96 VP8/90000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=my-sdp-value
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™è£¡å®šç¾©å…©å€‹ Media Description&lt;br>
ä¸€å€‹æ˜¯ audio å¸¶è‘— fmt 111ï¼Œä¸¦æŒ‡å®š codec ç‚º OPUS
å¦ä¸€å€‹æ˜¯ video å¸¶è‘— fmt 96ï¼Œcodec ç‚º VP8ï¼Œä¸¦å¸¶è‘—ç¬¬äºŒå€‹å±¬æ€§å€¼ç‚º my-sdp-value&lt;/p>
&lt;h3 id="webrtc-å¦‚ä½•åˆ©ç”¨-sdp">WebRTC å¦‚ä½•åˆ©ç”¨ SDP&lt;/h3>
&lt;p>æ¥è‘—è«‡åˆ° WebRTC å¦‚ä½•ä½¿ç”¨ SDP çš„æ ¼å¼ï¼ŒWebRTC æ¡ç”¨ Offer / Answer æ¶æ§‹ï¼Œä¸€æ–¹ Agent å…ˆä¸»å‹•æä¾› Offerï¼Œå¦ä¸€æ–¹å†æ±ºå®šæ˜¯å¦æ¥å—ï¼Œä¸¦å›æ‡‰ Answer ç¢ºå®š codec ç­‰&lt;/p>
&lt;h4 id="transceivers">Transceivers&lt;/h4>
&lt;p>Transceiver æŒ‡å®š Media å‚³è¼¸çš„æ–¹å‘ï¼Œä¾‹å¦‚èªªå¯ä»¥æŒ‡å®šã€Œæˆ‘è¦ç”¨é€™å€‹æ ¼å¼ç™¼é€ã€ã€Œæˆ‘è¦ç”¨é€™å€‹æ ¼å¼æ¥æ”¶è€Œä¸”æˆ‘ä¸æƒ³è¦æ”¶åˆ°ä»»ä½•è³‡æ–™ã€ç­‰ï¼Œä¸»è¦æœ‰å››å€‹å€¼&lt;/p>
&lt;ol>
&lt;li>send&lt;/li>
&lt;li>recv&lt;/li>
&lt;li>sendrecv&lt;/li>
&lt;li>inactive&lt;br>
æ¯ç”¢ç”Ÿä¸€å€‹ Transceiver å°±æœƒå°æ‡‰æœ‰ä¸€å€‹ Media Descriptionï¼Œä¸¦å¸¶æœ‰ä¸€å€‹ attribute æè¿°å¦‚ &lt;code>a=sendrecv&lt;/code>&lt;/li>
&lt;/ol>
&lt;h4 id="å…¶é¤˜å¸¸è¦‹å±¬æ€§">å…¶é¤˜å¸¸è¦‹å±¬æ€§&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>&lt;code>group:BUNDLE:&lt;/code>&lt;br>
æœ‰äº› WebRTC Agent æœƒåœ¨ä¸€å€‹ connection ä¸Šå‚³è¼¸å¤šç¨®é¡å‹çš„ media stream&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>fingerprint:sha-256&lt;/code>:&lt;br>
DTLS è¦ç”¨åˆ°çš„æ†‘è­‰ sha 256 å€¼ï¼Œç”¨ä¾†æ¯”å°æ†‘è­‰çš„æ­£ç¢ºæ€§&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>setup&lt;/code>:&lt;br>
æ±ºå®š DTLS Agent åœ¨ ICE é€£ç·šå»ºç«‹å¾Œçš„è¡Œç‚º&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ice-ufrag&lt;/code>:
ICE Agent çš„ user fragmentï¼Œç”¨ä¾†é©—è­‰èº«ä»½&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ice-pwd&lt;/code>:
åŒé©—è­‰èº«ä»½ä½¿ç”¨&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>rtpmap&lt;/code>:
æŒ‡å RTP Payload çš„ codec&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>fmtp&lt;/code>:
Payload é¡å¤–å±¬æ€§è³ªï¼Œä¾‹å¦‚ video encoding æ–¹å¼ç­‰ç´°ç¯€&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>candidate&lt;/code>:
ICE candidateï¼Œä¾›å¾ŒçºŒ ICE Agent å»ºç«‹é€£ç·šä½¿ç”¨&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ssrc&lt;/code>:
Media Stream çš„ ID&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>ç¯„ä¾‹ SDP å¯ä»¥åœ¨é€™é‚Šç”¢ç”Ÿ &lt;a class="link" href="https://webrtc.github.io/samples/src/content/peerconnection/munge-sdp/" target="_blank" rel="noopener"
>WebRTC samples Munge SDP&lt;/a>&lt;/p>
&lt;h2 id="äºŒ-connecting-1">äºŒ. Connecting&lt;/h2>
&lt;p>ä¸Šä¸€æ­¥ Signaling äº¤æ›å®Œé€£ç·šè³‡è¨Šï¼Œæ¥è‘—å°±è¦å»ºç«‹é›™æ–¹ P2P é€£ç·šï¼Œä½†ç¾å¯¦çš„ç¶²è·¯ä¸–ç•Œåœ¨æœ‰ä¸åŒç¨®çš„ NAT å­˜åœ¨ï¼Œä½¿å¾—å»ºç«‹é€£ç·šæ™‚æœƒæœ‰ä¸€äº›é˜»ç¤™ï¼Œç‚ºäº†å…‹æœè¡ç”Ÿå‡ºäº† NAT ç©¿è¶Šæ©Ÿåˆ¶ &lt;a class="link" href="https://datatracker.ietf.org/doc/html/rfc8445" target="_blank" rel="noopener"
>Interactive Connectivity Establishment (ICE)&lt;/a>&lt;/p>
&lt;h3 id="nat-ç¨®é¡">NAT ç¨®é¡&lt;/h3>
&lt;p>NAT æ˜¯åœ¨ä¸€å€‹å€åŸŸç¶²è·¯ä¸‹ï¼Œç”±çµ±ä¸€çš„å°å¤–è·¯ç”±å™¨å…±ç”¨ public ipï¼Œè€Œå…§éƒ¨çš„æ©Ÿå™¨å‰‡ä½¿ç”¨ private ipï¼Œå¦‚æœå…§éƒ¨æ©Ÿå™¨éœ€è¦èˆ‡å¤–éƒ¨ç¶²è·¯æºé€šï¼Œå‰‡é€éè·¯ç”±å™¨æ”¶ç™¼ï¼Œè·¯ç”±å™¨æœƒè¨˜ä½å“ªäº›å°åŒ…è¦è½‰é€åˆ°å°æ‡‰çš„å…§éƒ¨æ©Ÿå™¨ï¼›&lt;br>
ä¸è«–æ˜¯å› æ‡‰ IPv4 ä½ç½®ä¸å¤ ç”¨ï¼Œåˆæˆ–æ˜¯å®‰å…¨æ€§è€ƒé‡ï¼ŒNAT æ™®éå­˜åœ¨æ–¼ç¾ä»Šçš„ç¶²è·¯ç’°å¢ƒä¸‹&lt;br>
&lt;img src="https://webrtcforthecurious.com/docs/images/03-nat-mapping.png"
loading="lazy"
>&lt;br>
*åœ–ç‰‡ä¾†è‡ª webrtcforthecurious&lt;/p>
&lt;p>è€Œè·¯ç”±å™¨é‡å°å°åŒ…çš„ç™¼é€æœƒæœ‰ä¸åŒçš„å°æ‡‰ç”¢ç”Ÿï¼Œå‡è¨­ Machine A å‘ public Host 1 ç™¼é€è«‹æ±‚ï¼Œå‰‡æœƒåœ¨è·¯ç”±å™¨è¨»å†Šä¸€å€‹ Mapping&lt;/p>
&lt;h4 id="1-endpoint-independent-mapping">1. Endpoint-Independent Mapping&lt;/h4>
&lt;p>å¦‚æœ Machine A è¦å‘ public Host 2 ç™¼é€è«‹æ±‚ï¼Œå‰‡å¯ä»¥å¾©ç”¨åŒä¸€å€‹ Mapping&lt;/p>
&lt;h4 id="2-address-dependent-mapping">2. Address Dependent Mapping&lt;/h4>
&lt;p>å¦‚æœ Machine A è¦å‘ public Host 2 ç™¼é€è«‹æ±‚ï¼Œå‰‡æœƒç”¢ç”Ÿæ–°çš„ Mapping&lt;/p>
&lt;h4 id="3-address-and-port-dependent-mapping">3. Address and Port Dependent Mapping&lt;/h4>
&lt;p>å¦‚æœ Machine A è¦å‘ public Host 1 ä½†æ˜¯ä¸åŒçš„ port ç™¼é€è«‹æ±‚ï¼Œå‰‡æœƒç”¢ç”Ÿæ–°çš„ Mapping&lt;/p>
&lt;p>é‡å°å¤–éƒ¨å°åŒ…çš„æ¥æ”¶æœƒæœ‰ä¸åŒçš„é™åˆ¶&lt;/p>
&lt;h4 id="4-endpoint-independent-filtering">4. Endpoint-Independent Filtering&lt;/h4>
&lt;p>ä»»ä½• public Host éƒ½å¯ä»¥å°åŒä¸€å€‹ Mapping é€å°åŒ…çµ¦ Machine A&lt;/p>
&lt;h4 id="5-address-dependent-filtering">5. Address Dependent Filtering&lt;/h4>
&lt;p>åªæœ‰ Machine A å…ˆé€é public Host 1ï¼Œå‰‡ public Host 1 æ‰å¯ä»¥é€éæ­¤ Mapping é€å°åŒ…çµ¦ Machine A&lt;/p>
&lt;h4 id="6-address-and-port-dependent-filtering">6. Address and Port Dependent Filtering&lt;/h4>
&lt;p>åªæœ‰ Machine A å…ˆé€é public Host 1 + port 1ï¼Œå‰‡ public Host 1 + port 1 æ‰å¯ä»¥é€éæ­¤ Mapping é€å°åŒ…çµ¦ Machine A&lt;/p>
&lt;blockquote>
&lt;p>å°çµï¼Œå¯ä»¥çœ‹åˆ° NAT é™åˆ¶ç”±ä¸Šå¾€ä¸‹è¶Šä¾†è¶Šåš´è¬¹ï¼Œä¸€é–‹å§‹ä»»ä½• public ip éƒ½å¯ä»¥é€ï¼Œæ¥è‘—é™åˆ¶ ip addressï¼Œæœ€åš´æ ¼æ˜¯è¦ ip address + port éƒ½å»åˆæ‰å¯ä»¥é€&lt;/p>
&lt;/blockquote>
&lt;p>èªªå®Œäº† NAT ç¨®é¡ï¼Œä½†é€™äº›ç¨®é¡æœƒæ€éº¼å½±éŸ¿ P2P é€£ç·šå‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="stun">STUN&lt;/h3>
&lt;p>å¦‚æœä»Šå¤©å…©å€‹ webrtc client éƒ½åœ¨ NAT ä¹‹å¾Œï¼Œé‚£è¦å»ºç«‹é€£ç·šå°±å¿…é ˆå…ˆçŸ¥é“ &lt;code>è‡ªå·±çš„ public IP&lt;/code>ï¼Œé€™ä¹Ÿæ˜¯ &lt;a class="link" href="https://datatracker.ietf.org/doc/html/rfc8489" target="_blank" rel="noopener"
>STUN å”å®š&lt;/a> æ‰€åšçš„äº‹æƒ…ï¼Œè®“ client å¯ä»¥çŸ¥é“ NAT Mapping å°å¤–çš„ public IP&lt;/p>
&lt;p>è©¦æƒ³ä»¥ä¸‹æƒ…å¢ƒ&lt;/p>
&lt;ol>
&lt;li>client A / client B éƒ½åœ¨å„è‡ªçš„ NAT ä¹‹å¾Œï¼Œä»–å€‘æƒ³è¦å»ºç«‹ P2P é€£ç·š&lt;/li>
&lt;li>client A / client B æ­¤æ™‚ä¸çŸ¥é“è‡ªå·±çš„ public IP&lt;/li>
&lt;li>client A / client B åˆ†åˆ¥å‘ STUN Server(æœ‰å›ºå®š public IP) ç™¼å‡ºè«‹æ±‚ï¼Œæ­¤æ™‚ NAT ä¸Šæœƒå»ºç«‹ Mapping + client A / client B å–å¾— public IP äº¤æ›&lt;/li>
&lt;li>å¦‚æœ NAT æ˜¯å±¬æ–¼ &lt;code>Endpoint-Independent Mapping + Endpoint-Independent Filtering&lt;/code>ï¼Œå‰‡ client A / client B é€é SDP äº¤æ›è³‡è¨Šå¾Œï¼Œå°±å¯ä»¥å»ºç«‹é›™å‘é€£ç·šäº†&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>åæ€å¦‚æœ NAT æ˜¯ Address Dependent Mapping + Address Dependent Filteringï¼Œé€é STUN ä¹‹å¾Œ client A / B å¯ä»¥ç›´æ¥é€£ç·šå—ï¼Ÿ&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯ä¸è¡Œçš„å–”ï¼Œå› ç‚º client A å»ºç«‹äº†èˆ‡ STUN server çš„ NAT Mapping åªèƒ½å…©è€…ç”¨ï¼Œclient B æƒ³è¦é€å°åŒ…çµ¦ client A å°±æœƒè¢«æ“‹ä¸‹ä¾†&lt;/p>
&lt;/blockquote>
&lt;h3 id="turn">TURN&lt;/h3>
&lt;p>é‡åˆ° STUN server ç„¡æ³•ç”¨ï¼Œæ¥è‘—å°±è¦ç”¨ &lt;a class="link" href="https://datatracker.ietf.org/doc/html/rfc8656" target="_blank" rel="noopener"
>TURN&lt;/a>ï¼ŒTURN server æœƒå±…ä¸­ï¼Œæ‰€æœ‰çš„å°åŒ…éƒ½é€é TURN server è½‰ç™¼ï¼Œä½†é€™æ¨£ä¹Ÿå°±ä¸æ˜¯ P2P é€£ç·šäº†&lt;/p>
&lt;p>TURN çš„é‹ä½œæ©Ÿåˆ¶å»ºç«‹æ–¼ STUN ä¹‹ä¸Šï¼Œæ“´å…… STUN å°åŒ…çš„æ ¼å¼ï¼Œæµç¨‹å¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>client A å»ºç«‹ &lt;code>Allocation&lt;/code>ï¼ŒTURN server æœƒä¿ç•™ä¸€å€‹ port çµ¦ client Aï¼Œä¸¦å›å‚³ &lt;code>Relayed Transport Address&lt;/code>ï¼Œå¯ä»¥æƒ³åƒæˆæ¬é€²æ–°å¤§æ¨“æ™‚ä¸€æ¨“ä¿¡ç®±æœ‰ä¸€å€‹æ ¼å­å°ˆå±¬æ–¼ä½ çš„ï¼Œæ‰€ä»¥å¯„ä¿¡åˆ°é€™å€‹æ ¼å­çš„è³‡æ–™éƒ½æ˜¯è¦çµ¦ä½ çš„&lt;/li>
&lt;li>ç•¶ WebRTC åœ¨äº¤æ› SDP æ™‚å°‡ Relayed Transport Address çµ¦å°æ–¹&lt;/li>
&lt;li>ç‚ºäº†é¿å…å…¶ä»–äººäº‚å¯„è³‡æ–™ï¼Œclient å¿…é ˆåœ¨ Relay Server å¹«å°æ–¹å¢åŠ  &lt;code>Permission&lt;/code>&lt;/li>
&lt;li>Allocation / Permission éƒ½æœ‰æ™‚é–“é™åˆ¶(LIFETIMEåƒæ•¸æ§åˆ¶)ï¼Œå¯ä»¥å¾ŒçºŒ Refresh&lt;/li>
&lt;/ol>
&lt;p>å¦å¤–ä¸€ç¨®å°æ–¼ NAT çš„åˆ†é¡ (éŒå½¢ã€å°ç¨±å‹) é“ç†ä¹Ÿæ˜¯é¡ä¼¼ï¼ŒPeer A è¨»å†Šçš„ Mapping è¦åœ¨ä»€éº¼æƒ…æ³ä¸‹ Peer B å¯ä»¥ç›´æ¥æ‹¿ä¾†ç”¨ï¼Œå¦‚æœä¸è¡Œ (å°ç¨±å‹) å°±è¦èµ° TURN Serverï¼Œå¯åƒè€ƒ &lt;a class="link" href="https://ithelp.ithome.com.tw/articles/10209590" target="_blank" rel="noopener"
> 30-28ä¹‹ WebRTC é€£ç·šå‰å‚³ - ç‚ºä»€éº¼ P2P é€£ç·šå¾ˆéº»ç…© ? ( NAT ) &lt;/a>&lt;/p>
&lt;h3 id="ice">ICE&lt;/h3>
&lt;p>çµåˆä»¥ä¸Šçš„é€£ç·šæ–¹æ³•ï¼Œå°±çµ„åˆæˆ ICE protocolï¼Œæ¯å€‹ ICE Agent æœƒåˆ†æˆ Controlling / Controlledï¼Œæœ‰ä¸€æ–¹ä¸»å°é€£ç·šéç¨‹ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿï¼Œå˜—è©¦æ‰¾å‡ºé›™æ–¹å¯ä»¥äº’é€šçš„é€£ç·š&lt;/p>
&lt;h4 id="1candidate-gathering">1.Candidate Gathering&lt;/h4>
&lt;p>Candidate æ˜¯æŒ‡å¯èƒ½è¢«ä½¿ç”¨çš„é€£ç·šæ–¹å¼ï¼Œå…±æœ‰å¹¾ç¨®&lt;/p>
&lt;ol>
&lt;li>host: local interface&lt;/li>
&lt;li>srflx: Server Reflexiveï¼Œä¹Ÿå°±æ˜¯å¾ STUN é‚£æ‹¿åˆ°çš„ public ip&lt;/li>
&lt;li>relay: é€é TURN server æ‹¿åˆ°çš„ ip&lt;/li>
&lt;li>prflx: Peer Reflexiveï¼Œå¾ peer é‚£é‚Šæ‹¿åˆ°è‡ªå·±çš„ ipï¼Œæ™šé»è£œå……&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šè³‡è¨Šæ”¶é›†å®Œå¾Œï¼Œé€é signaling æ–¹å¼ç™¼é€çµ¦å°æ–¹&lt;/p>
&lt;h4 id="2candidate-selection">2.Candidate Selection&lt;/h4>
&lt;p>å› ç‚ºé›™æ–¹éƒ½è’é›†äº†å„è‡ªçš„ candidateï¼Œæ¥è‘—å°±æ˜¯ full mesh çµ„åˆå‡º &lt;code>Candidate Pair&lt;/code>ï¼Œä¸¦æŒ‰ç…§å„ªå…ˆé †åºé–‹å§‹æ¸¬è©¦é€£ç·šï¼Œå¯ä»¥æˆåŠŸæ”¶ç™¼è¨Šæ¯å‰‡æ¨™è¨˜ç‚º &lt;code>Valid Candidate&lt;/code>ï¼Œä¸»å°æ–¹æœƒæŒ‘ä¸€å€‹ valid candidate æ¨™è¨˜æˆ &lt;code>Nominated Pair&lt;/code>ï¼Œæ¥è‘—é›™æ–¹åœ¨æ¸¬è©¦ä¸€æ¬¡æ˜¯å¦èƒ½æˆåŠŸæ”¶ç™¼è¨Šæ¯ï¼Œå®Œæˆå‰‡æ¨™è¨˜ç‚º &lt;code>Selected Candidate Pair&lt;/code>ï¼Œé€™ä¸€å€‹ session å°±ç”¨ä¸€çµ„é€£ç·šæ–¹å¼&lt;/p>
&lt;h4 id="3-restart">3. Restart&lt;/h4>
&lt;p>å¦‚æœ Selected Candidate Pair æœ‰ä»»ä½•å•é¡Œï¼Œå‰‡ä»¥ä¸Šæ­¥é©Ÿé‡æ–°ä¾†é&lt;/p>
&lt;blockquote>
&lt;p>æœ€å¾Œè£œå……ä¸€ä¸‹ Peer Reflexiveï¼Œç‚ºä»€éº¼æœƒæœ‰å¾å°æ–¹æ‹¿åˆ°è‡ªå·±æ‰€ä¸çŸ¥é“çš„ ip é€™ç¨®ç‹€æ³ï¼Œä¸»è¦æœƒç™¼ç”Ÿåœ¨ Host Candidate èˆ‡ Server Reflexive Candidate æºé€š&lt;/p>
&lt;p>è©¦æƒ³ client A é€é host candidate å¤šåŠæ‹¿åˆ°æ˜¯è‡ªå·±çš„ private ipï¼Œæ­¤æ™‚é€é NAT å‘ client B ç™¼é€è«‹æ±‚ï¼Œclient B æœƒæ‹¿åˆ° NAT çš„ public address (ä¹Ÿå°±æ˜¯ client A çš„ Mapping)ï¼Œæ­¤æ™‚è¿”å› public address çµ¦ client Aï¼Œæ­¤æ™‚å°±æ˜¯ prflx
å…¶å¯¦ä¸Šè¿°çš„éç¨‹é¡ä¼¼æ–¼ &lt;code>STUN&lt;/code> server çš„åŠŸç”¨
å› ç‚º ICE protocol æ˜¯æœ‰ç¶“éé©—è­‰çš„ï¼Œæ‰€ä»¥ client A å¯ä»¥æ”¾å¿ƒçš„æ‹¿é€™çµ„ public ip ç•¶ä½œè‡ªå·±çš„ ip&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä¸‰-securing">ä¸‰. Securing&lt;/h2>
&lt;p>è©²æ€éº¼ç¢ºä¿æ”¶åˆ°çš„ sdp ä¾†è‡ªé æœŸçš„ client / è¦å¦‚ä½•ç¢ºä¿æ”¶åˆ°çš„ media æ˜¯ä¾†æ­£ç¢ºçš„ clientï¼ŒWebRTC çµåˆè¨ˆæœ‰çš„åŠ å¯†æ–¹å¼ DTLS / SRTPï¼Œç¢ºä¿æ©Ÿå¯†æ€§/å®Œæ•´æ€§/èº«ä»½é©—è­‰&lt;/p>
&lt;h3 id="dtls">DTLS&lt;/h3>
&lt;p>DTLS æ˜¯ TLS çš„è¿‘è¦ªï¼Œåªæ˜¯ DTLS çš„å‚³è¼¸å±¤æ˜¯ UDP è€Œ TLS æ˜¯ TCPï¼›
DTLS æ˜¯ Client/Server æ¶æ§‹ï¼ŒæŸä¸€æ–¹æœƒå…ˆç™¼èµ·é€šä¿¡ï¼Œæ¥è‘—é›™æ–¹æœƒäº¤æ›æ†‘è­‰ï¼Œè€Œç¢ºä¿æ†‘è­‰çš„æ­£ç¢ºæ€§æ˜¯æ¯”å° SDP ä¸­çš„æ†‘è­‰ hash å€¼ï¼›&lt;br>
å®Œæˆäº¤æ¡å¾Œæœƒå–å¾—å…±åŒå°ç¨±å¯†é‘°ï¼Œå¾ŒçºŒå°±ç”¨æ­¤åŠ å¯†
&lt;img src="https://webrtcforthecurious.com/docs/images/04-handshake.png"
loading="lazy"
>
*åœ–ç‰‡ä¾†è‡ª webrtcforthecurious&lt;/p>
&lt;p>æµç¨‹åŸºæœ¬èˆ‡ HTTPS å¾ˆåƒï¼Œåªæ˜¯ client ä¹Ÿè¦æä¾›æ†‘è­‰çµ¦ serverï¼Œåœ¨ https é€™ä¸€æ­¥æ˜¯å¯é¸çš„ä½†é€šå¸¸å¿½ç•¥&lt;/p>
&lt;p>ServerHello/ClientHello å„è‡ªå†ç”¢ç”Ÿ random secretï¼Œæ‹¿åˆ°æ†‘è­‰å¾Œ client ç”¢ç”Ÿ pre-master ä¸¦åŠ å¯†å‚³é€çµ¦ serverï¼Œé›™æ–¹å¯ä»¥å¾—åˆ°ç›¸åŒä½†å…¶ä»–äººä¸çŸ¥é“çš„ master key&lt;/p>
&lt;blockquote>
&lt;p>éç¨‹ä¸­çªç„¶æƒ³åˆ°ï¼Œæ—¢ç„¶æ˜¯ client æœ€å¾ŒæŠŠ pre-master åŠ å¯†ï¼Œé‚£ç‚ºä»€éº¼é‚„è¦ client/secret random number ?
åŸå› æ˜¯ç‚ºäº†&lt;code>é¿å…å›æ”¾æ”»æ“Š&lt;/code>ï¼Œåƒè€ƒ &lt;a class="link" href="https://security.stackexchange.com/questions/89383/why-does-the-ssl-tls-handshake-have-a-client-and-server-random" target="_blank" rel="noopener"
>Why does the SSL/TLS handshake have a client and server random?&lt;/a>
å¦‚æœå°‘äº† Server random numberï¼Œé‚£é§­å®¢å³ä½¿ä¸çŸ¥é“å…§æ–‡ä¹Ÿæ²’é—œä¿‚ï¼Œé‡è¤‡å›æ”¾è«‹æ±‚ï¼ŒServer æ²’è¾¦æ³•çŸ¥é“é€™äº›è«‹æ±‚æ˜¯éæ™‚çš„
åä¹‹å¦‚æœæœ‰ random numberï¼ŒServer å°±æœƒç™¼ç¾ master key ä¸åŒè€Œä¸­æ–·è«‹æ±‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="srtp">SRTP&lt;/h3>
&lt;p>SRTP æ˜¯é‡å° RTP è¨­è¨ˆçš„åŠ å¯†ç‰ˆæœ¬ï¼Œæœ¬èº«æ²’æœ‰å®šç¾©ç”¢ç”Ÿ keyï¼Œæ‰€ä»¥ WebRTC å°±æ‹¿ DTLS äº¤æ¡å¾Œç”¢ç”Ÿçš„å…±åŒé‡‘é‘°ç•¶ä½œ SRTP çš„åŠ å¯†é‡‘é‘°&lt;/p>
&lt;p>å…·é«”å…§å®¹å°±å…ˆç•¥é&lt;/p>
&lt;h2 id="real-time-networking">Real-time Networking&lt;/h2>
&lt;p>ç¶²è·¯ç‹€æ³æœƒå¾ˆå¤§å¹…åº¦å½±éŸ¿å³æ™‚å½±éŸ³æœå‹™çš„å“è³ªï¼Œå“è³ªå‰‡æ˜¯åœ¨ Quality &amp;amp; Latency ä¸­åšæŠ‰æ“‡ï¼Œè©•ä¼°ç¶²è·¯ç‹€æ³æ™‚æœƒçœ‹&lt;/p>
&lt;ol>
&lt;li>&lt;code>Bandwidth&lt;/code>: é€šé“ä¸Šæœ€å¤§å¯å‚³è¼¸çš„é‡&lt;/li>
&lt;li>&lt;code>Transmission Time and Round Trip Time&lt;/code>ï¼šå¾ç™¼é€åˆ°æ”¶åˆ°å›æ‡‰çš„æ™‚é–“&lt;/li>
&lt;/ol>
&lt;p>åœ¨ç¶²è·¯ç‹€æ³ä¸å¥½çš„æƒ…æ³ä¸‹ï¼Œæœƒé‡åˆ°å¹¾ç¨®è² é¢æƒ…æ³&lt;/p>
&lt;ol>
&lt;li>&lt;code>Jitter&lt;/code>: RTT æ™‚é•·æ™‚çŸ­ï¼Œå°è‡´ç•«é¢å¡é “&lt;br>
å¯ä»¥é€é Jitter Buffer æ”¹å–„å•é¡Œï¼Œæ”¶åˆ°å°åŒ…å¾Œå…ˆ queue ä¸€å°æ®µæ™‚é–“ï¼Œç­‰åˆ°å¯ä»¥å®Œæ•´è§£æ frame åœ¨ render&lt;/li>
&lt;li>&lt;code>Packet Loss&lt;/code>: æŸäº›å°åŒ…æ‰äº†ï¼Œå°è‡´ç•«é¢è·³æ ¼&lt;br>
è§£æ±º Packet Loss å•é¡Œå¯ä»¥é€é&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>æ”¶åˆ°å°åŒ…å¾Œå›å‚³ ACK&lt;/li>
&lt;li>æ”¶åˆ°å°åŒ…å¾Œå›å‚³æ”¶åˆ°çš„å°åŒ… SACK&lt;/li>
&lt;li>å›å‚³æ²’æœ‰æ”¶åˆ°çš„å°åŒ… NACK (é‡åˆ°è·³è™Ÿæ™‚)&lt;/li>
&lt;/ul>
&lt;p>ä»Šå¤©å¦‚æœç¶²è·¯ç‹€æ³ä¸å¥½ï¼Œå‰‡ç™¼é€æ–¹æ‡‰è©²è¦é™ä½å½±éŸ³å“è³ª / æ¸›ç·©ç™¼é€é€Ÿåº¦ï¼Œé¿å…ç¶²è·¯ç‹€æ³æƒ¡åŒ–ï¼›&lt;br>
å¦ä¸€æ–¹é¢ç•¶ç¶²è·¯ç‹€æ³æ”¹å–„ï¼Œå‰‡ç™¼é€æ–¹ä¹Ÿæ‡‰è©²è¦çŸ¥é“ï¼Œé€²è€Œæå‡å‚³è¼¸çš„å“è³ªèˆ‡é€Ÿåº¦&lt;/p>
&lt;p>é‚£æ¥æ”¶æ–¹å¦‚ä½•å›å ±ç¶²è·¯ç‹€æ³çµ¦ç™¼é€æ–¹å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="media">Media&lt;/h3>
&lt;p>WebRTC æœ¬èº«ä¸ç®¡åº•å±¤çš„å½±éŸ³ codecï¼Œåªè¦é›™æ–¹éƒ½å¯ä»¥è™•ç†å°±å¥½ï¼Œé€é RTP å‚³è¼¸å½±éŸ³è³‡æ–™ / RTCP è™•ç†ç¶²è·¯ç‹€æ³+æ§åˆ¶æµé‡&lt;/p>
&lt;h4 id="rtcp-å¦‚ä½•æ•´ç†ç¶²è·¯ç‹€æ³">RTCP å¦‚ä½•æ•´ç†ç¶²è·¯ç‹€æ³&lt;/h4>
&lt;p>RTCP é€éå¹¾ç¨®æ–¹å¼ï¼Œè®“ç™¼é€æ–¹å¯ä»¥å¾—çŸ¥ç¶²è·¯ç‹€æ³&lt;/p>
&lt;ol>
&lt;li>Receiver Reports&lt;br>
Sender å†ç™¼é€æ™‚æ‰“ä¸Šç•¶æ™‚çš„æ™‚é–“æˆ³è¨˜ t1ï¼ŒReceiver æ”¶åˆ°å¾ŒåŠ ä¸Šè‡ªå·±è™•ç†çš„æ™‚é–“ t2ï¼Œå›å‚³ Report çµ¦ Senderï¼Œæœ€å¾Œ Sender æ”¶åˆ°çš„æ™‚é–“ç‚º t3&lt;br>
å‰‡ Sender å¯ä»¥ç®—å‡º &lt;code>rtt = t3 - t1 - t2&lt;/code>&lt;/li>
&lt;li>REMB&lt;br>
Reciver æ ¹æ“šçµ±è¨ˆ packet lossï¼Œè·Ÿ Sender å›å ±é æœŸçš„ bitrate&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">if (packetLoss &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nt">2&lt;/span>&lt;span class="err">%)&lt;/span> &lt;span class="na">video_bitrate&lt;/span> &lt;span class="err">*=&lt;/span> &lt;span class="na">1&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">08&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">if&lt;/span> &lt;span class="err">(&lt;/span>&lt;span class="na">packetLoss&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> 10%) video_bitrate *= (1 - 0.5*lossRate)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†é€™å€‹æ–¹æ³•ç†è«–ä¸Šçœ‹èµ·ä¾†ä¸éŒ¯ï¼Œå¯¦éš›æ‡‰ç”¨ä¸Šå»å¾ˆç³Ÿç³•ï¼Œå› ç‚º encoder åœ¨å‹•æ…‹æ”¹è®Š bitrate ä¸‹æ²’æœ‰é€™éº¼æœ‰æ•ˆç‡
3. TWCC&lt;br>
è¿½è¹¤æ¯ä¸€å€‹å°åŒ…çš„ç‹€æ³ï¼Œå¯ä»¥è®“ Sender æœ‰æ›´å³æ™‚ã€æ¸…æ¥šçš„ç¶²è·¯ç‹€æ³&lt;/p>
&lt;p>é€™ä¸€æ®µç†è§£ä¸é€™éº¼å…¨é¢ï¼Œæœªä¾†æœ‰æ©Ÿæœƒè£œä¸Š&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å»ºç«‹ WebRTC é€£ç·šéç¨‹ï¼Œç¸½å…±åˆ†æˆ&lt;/p>
&lt;ol>
&lt;li>Signalingï¼š äº¤æ›å½¼æ­¤è³‡è¨Šçš„ç®¡é“ï¼Œé€é SDP æè¿°é€™äº›è³‡è¨Š&lt;/li>
&lt;li>Connectingï¼šç‚ºäº†æ‡‰ä»˜è¤‡é›œçš„ç¶²è·¯ç’°å¢ƒ(NAT)ï¼Œé€é ICE è§£æ±ºé€£ç·šå•é¡Œ&lt;/li>
&lt;li>Securingï¼šç¢ºä¿äº¤æ›çš„è³‡æ–™æ˜¯å®‰å…¨çš„&lt;/li>
&lt;li>Real-time communicationï¼šå³æ™‚å‚³é€è³‡æ–™&lt;/li>
&lt;/ol></description></item><item><title>ã€Refactoring Ruby Editionã€‘(ä¸€) é«”é©—é‡æ§‹</title><link>https://yuanchieh.page/posts/2021/2021-05-01-refactoring-ruby-edition%E4%B8%80-%E9%AB%94%E9%A9%97%E9%87%8D%E6%A7%8B/</link><pubDate>Sat, 01 May 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-05-01-refactoring-ruby-edition%E4%B8%80-%E9%AB%94%E9%A9%97%E9%87%8D%E6%A7%8B/</guid><description>&lt;p>å·¥ä½œäº†æ•¸å¹´ï¼Œå¯èƒ½æ˜¯ä¸€é–‹å§‹å¯«å‹•æ…‹èªè¨€çš„é—œä¿‚ï¼Œé®®å°‘æ³¨æ„åˆ°æŠ½è±¡åŒ– / å°è£ / ç‰©ä»¶å°å‘çš„è¨­è¨ˆï¼Œå°è‡´ç¨‹å¼ç¢¼è¶Šä¾†è¶Šé›£ä»¥ç¶­è­·ï¼Œæ·±çŸ¥é€™æ˜¯è‡ªå·±æŠ€èƒ½ä¸Šçš„å¼±é»ï¼Œé–‹å§‹å»å­¸ç¿’ TDD / é‡æ§‹ï¼Œå¸Œæœ›å¯ä»¥å¯«å‡ºå¥½æ‡‚ / å¥½ç¶­è­· / æœ‰æ¸¬è©¦ä¿è­·çš„ä¹¾æ·¨ç¨‹å¼ç¢¼&lt;/p>
&lt;p>å‰›å¥½æœ€è¿‘æ›å·¥ä½œé–‹å§‹å¯« Rubyï¼Œå°±é †ä¾¿è²·äº†é€™æœ¬ &lt;code>ã€Refactoring Ruby Editionã€‘&lt;/code>ï¼ŒåŸæœ¬æ˜¯ Martin Fowler å¤§å¤§ç”¨ Java ç•¶ä½œç¯„ä¾‹æ‰€ç·¨å¯«ï¼Œé€™ä¸€æœ¬æ˜¯ç”±å¦å¤–å…©åä½œè€…èˆ‡ Martin Fowler æ›åï¼Œæ¡ç”¨ Ruby ç•¶ä½œç¯„ä¾‹ä¸¦åŠ å…¥ Ruby çš„èªè¨€ç‰¹æ€§ï¼Œä¸å½±éŸ¿å°æ–¼é‡æ§‹çš„ç†è§£èˆ‡å¯¦è¸&lt;/p>
&lt;p>ç›®å‰çœ‹äº†ä¸€åŠè¦ºå¾—å¾ˆå—ç”¨ï¼Œæ•´ç†å¾ˆå¤š code smellï¼Œä»¥åŠé‡åˆ°æ™‚è©²å¦‚ä½•æœ‰ç³»çµ±çš„é‡æ§‹æˆä¹¾æ·¨çš„ç¨‹å¼ç¢¼ï¼Œæœ‰ä¸€äº›åŸå‰‡å¯èƒ½æœƒäº’æ–¥ (æŠ½é¡åˆ¥æˆ–æ˜¯æŠŠé¡åˆ¥å¡å›å»)ï¼Œæ›¸ä¸­ä¹Ÿæœ‰æåŠè©²å¦‚ä½•åˆ¤æ–·ä½•è€…ç‚ºä½³&lt;/p>
&lt;p>ä»¥ä¸‹å…§å®¹å°æ‡‰çš„æ˜¯ç¬¬ä¸€ç«  ã€ŒRefactoring, a First Exampleã€ï¼Œç¨‹å¼ç¢¼æ–¼æ­¤ &lt;a class="link" href="https://github.com/sj82516/refactoring-ruby" target="_blank" rel="noopener"
>sj82516/refactoring-ruby&lt;/a>ï¼Œä»¥ä¸‹æ¯å€‹æ­¥é©Ÿéƒ½æœƒå°æ‡‰åˆ°ä¸€å€‹ commit&lt;/p>
&lt;h3 id="ç¯„ä¾‹">ç¯„ä¾‹&lt;/h3>
&lt;p>é€™æ˜¯ä¸€å€‹ç§Ÿç‰‡æœå‹™ï¼Œè¨ˆç®—ç›®å‰ç”¨æˆ¶ç§Ÿç‰‡çš„è²»ç”¨èˆ‡å›é¥‹é»æ•¸ï¼Œå½±ç‰‡æœ‰åˆ†ä¸‰ç¨®é¡å‹&lt;/p>
&lt;h2 id="é‡æ§‹ä¹‹å‰">é‡æ§‹ä¹‹å‰&lt;/h2>
&lt;p>ä¸€é–‹å§‹å…ˆè§€å¯Ÿé€™æ®µé€™æ®µç¨‹å¼ç¢¼ï¼Œ Customer ä¸­çš„ statement method æ˜é¡¯å¾ˆé•·ä¸€æ®µï¼Œè² è²¬è¨±å¤šäº‹æƒ…ï¼ŒåŒ…å«è¨ˆç®—èˆ‡æ•´ç†è¼¸å‡ºè¦æ ¼&lt;/p>
&lt;p>å¾åŠŸèƒ½é¢ä¸Šä¾†çœ‹ï¼Œé€™æ®µç¨‹å¼ç¢¼é‹ä½œç¬¦åˆé æœŸï¼Œå°æ–¼ç›´è­¯å™¨ä¾†èªªä¹Ÿä¸å­˜åœ¨é†œä¸é†œçš„ç¨‹å¼ç¢¼ï¼Œä½†ä»Šå¤©å¦‚æœéœ€æ±‚è®Šæ›´ï¼Œéœ€è¦äººé¡çš„ä»‹å…¥å»ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œé‚£å¯è®€æ€§å°±å¾ˆé‡è¦äº†&lt;/p>
&lt;p>ä¾‹å¦‚èªªä»Šå¤©è¦å¢åŠ ä¸€å€‹è¼¸å‡ºæˆ html æ ¼å¼ï¼Œç›®å‰çš„å¯«æ³•åªèƒ½ copy statement ä¸¦ä¿®æ”¹è¼¸å‡ºæ ¼å¼ï¼Œåˆå¦‚æœä¹‹å¾Œè¦èª¿æ•´å½±ç‰‡çš„è¨ˆåƒ¹æ–¹å¼ï¼Œé‚£å¾ˆä¸å¹¸å…©å€‹æ–¹æ³•éƒ½è¦åŒæ­¥æ”¹å‹•&lt;/p>
&lt;blockquote>
&lt;p>ç•¶ä½ ç™¼ç¾è¦å¢åŠ æ–°åŠŸèƒ½å¾ˆé›£æ”¹å‹•æ™‚ï¼Œ&lt;code>å…ˆé‡æ§‹&lt;/code>åˆ°ä½ è¦ºå¾—å¾ˆå¥½åŠ æ–°åŠŸèƒ½å¾Œï¼Œå†åŠ ä¸Šæ–°åŠŸèƒ½&lt;/p>
&lt;/blockquote>
&lt;h2 id="é–‹å§‹é‡æ§‹">é–‹å§‹é‡æ§‹&lt;/h2>
&lt;p>ä»¥ä¸‹æŒ‰ç…§æ›¸ä¸­å»ºè­°ï¼Œé–‹å§‹é€²è¡Œé‡æ§‹&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/37ab1f1d4f998f0c49b7512489cf06b6606740c9" target="_blank" rel="noopener"
>init&lt;/a>&lt;/p>
&lt;h3 id="1-å¯«æ¸¬è©¦">1. å¯«æ¸¬è©¦&lt;/h3>
&lt;p>å¦‚ä½•ç¢ºä¿åœ¨é‡æ§‹éç¨‹ä¸æŠŠåŠŸèƒ½æ”¹å£ï¼Ÿ &lt;code>å¯«æ¸¬è©¦ï¼&lt;/code> é€éå¯«æ¸¬è©¦å¯ä»¥æ˜ç¢ºè¡¨é”æˆ‘å€‘é æœŸçš„ç¨‹å¼ç¢¼è¡Œç‚ºï¼Œåœ¨èˆ‡ PM æºé€šæ™‚é€éå…·é«”çš„æ¸¬è©¦æ¡ˆä¾‹ä¹Ÿå¯ä»¥é¿å…æœ‰èªçŸ¥ä¸Šçš„æ­§ç•°&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/4a2efdcff4d2dc6654dd74590bbb59da85a257b6" target="_blank" rel="noopener"
>test: add unit test&lt;/a>&lt;/p>
&lt;h3 id="2-æ‹†è§£èˆ‡é‡çµ„---extact-method">2. æ‹†è§£èˆ‡é‡çµ„ - Extact Method&lt;/h3>
&lt;p>é¦–å…ˆæ‹†è§£éæ–¼è¤‡é›œçš„ statement æ–¹æ³•ï¼Œè¦æ‹†è§£é¦–å…ˆæ‰¾åˆ°é‚è¼¯ä¸Šæ¯”è¼ƒç·Šå¯†çš„å€å¡Šï¼Œä¸¦æ‹†åˆ†å‡ºç¨ç«‹çš„æ–¹æ³•ï¼Œä¾‹å¦‚ case å°±å¾ˆé©åˆ&lt;/p>
&lt;p>åœ¨æ‹†åˆ†æ™‚è¦æ³¨æ„ä½¿ç”¨åˆ°çš„è®Šæ•¸æœ‰æ²’æœ‰è¢«ä¿®æ­£ï¼Œä¾‹å¦‚ rental æ²’æœ‰è¢«æ”¹å‹•æ‰€ä»¥ç•¶ä½œåƒæ•¸å‚³é€²å»å°±æ²’äº‹ï¼Œä½†æ˜¯ this_amount æœ‰è¢«æ”¹å‹•ï¼Œå¦‚æœè¢«æ”¹å‹•åªæœ‰ä¸€å€‹è®Šæ•¸ï¼Œé‚£å°±ç•¶åš function return å³å¯&lt;/p>
&lt;blockquote>
&lt;p>åˆ¥å¿˜è¨˜æ¯æ”¹ä¸€å°æ­¥éƒ½è¦è·‘æ¸¬è©¦ï¼Œå°¤å…¶æ˜¯å‹•æ…‹èªè¨€å®¹æ˜“å¡åœ¨è®Šæ•¸åç¨±å¯«éŒ¯ç­‰å°å•é¡Œä¸Š&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/c734e357cd146243da6bb1b29aa994be40c84589" target="_blank" rel="noopener"
>refactor extract amount_for method&lt;/a>&lt;/p>
&lt;h4 id="2-2-é‡æ–°å‘½åå¹«åŠ©èªçŸ¥">2-2 é‡æ–°å‘½åå¹«åŠ©èªçŸ¥&lt;/h4>
&lt;p>åœ¨æ–°çš„ amount_for methodï¼Œæ”¹å‹•ä¸€ä¸‹è®Šæ•¸åç¨±æœ‰åŠ©æ–¼å«ç¾©çš„è¡¨é”ï¼Œå°‘ç”¨å¤ªå»£æ³›çš„å«ç¾©ä¾‹å¦‚ element / i é€™é¡&lt;/p>
&lt;blockquote>
&lt;p>Any fool can write code that a computer can understand. Good programmers write code that humans can understand.&lt;/p>
&lt;/blockquote>
&lt;p>ä¸å¾—ä¸æ¨è–¦ä¸€ä¸‹ RubyMineï¼Œä¸€å¹´è¨‚é–±è¦ $89 é‚ä½†æ˜¯æœ‰ Refactor ç³»åˆ—çš„è¼”åŠ©å·¥å…·è¶…æ–¹ä¾¿ï¼Œé€é &lt;code>shift éµ * 2 å«å‡º action dialog å¾Œè¼¸å…¥ã€Œrefactor thisã€&lt;/code>ï¼Œå°±æœƒæœ‰ä¸€ç³»åˆ—çš„é‡æ§‹æ–¹æ³•è®“ä½ æŒ‘é¸&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/35abc2dd64937c7c77ee6e398b9c1f77376912e7" target="_blank" rel="noopener"
>refactor: rename&lt;/a>&lt;/p>
&lt;h3 id="3-æŠŠé‚è¼¯æ”¾åœ¨æ­£ç¢ºçš„ç‰©ä»¶ä¸Š---move-method">3. æŠŠé‚è¼¯æ”¾åœ¨æ­£ç¢ºçš„ç‰©ä»¶ä¸Š - Move Method&lt;/h3>
&lt;p>ä»”ç´°çœ‹ä¸€ä¸‹ amount_for æ–¹æ³•ä¸­ï¼Œé‹ç®—é‚è¼¯çš„è³‡æ–™ä¾†æºéƒ½å¾ Rental é€™å€‹ç‰©ä»¶è€Œä¾†ï¼Œéƒ½æ²’æœ‰ç”¨ä¸Š Customer ç‰©ä»¶ä¸Šçš„è³‡æ–™ï¼Œé€™æ™‚å€™å¯ä»¥åˆç†çš„æ‡·ç–‘æ˜¯ä¸æ˜¯æŠŠæ–¹æ³•ç§»åˆ° Rental æœƒæ›´åŠ åˆé©&lt;/p>
&lt;p>æ¥è‘—ä¿®æ­£ Customer çš„å¼•ç”¨&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/06622927d241160705a9947c7aadf24c040ea4b2" target="_blank" rel="noopener"
>refactor: move method to rental&lt;/a>&lt;/p>
&lt;h4 id="3-2-ç§»é™¤ä¸å¿…è¦çš„å€åŸŸè®Šæ•¸---inline">3-2. ç§»é™¤ä¸å¿…è¦çš„å€åŸŸè®Šæ•¸ - Inline&lt;/h4>
&lt;p>é€™æ™‚å€™ this_amount å°±æœ‰é»å¤šé¤˜äº†ï¼Œé€é inline è®Šæ•¸ç›´æ¥å¾ rental.charge è®€å–&lt;/p>
&lt;p>æˆ–è¨±æœƒæœ‰äººçˆ­è«–ï¼šå¤šæ¬¡å‘¼å«æ–¹æ³•æœƒé™ä½æ•ˆèƒ½ï¼Œä½†æ˜¯åŸå‰‡ä¸Š&lt;code>é‡æ§‹æ˜¯ç‚ºäº†ç°¡æ½”ï¼Œæ•ˆèƒ½å•é¡Œç­‰åˆ°ç™¼ç”Ÿæ™‚åœ¨å„ªåŒ–å³å¯&lt;/code>ï¼Œå°¤å…¶æ˜¯ç¾åœ¨çš„é‹ç®—è³‡æºå¾€å¾€å¾ˆè¶³å¤ ï¼Œå¥½ç¶­è­·ä¸Šå¸¶ä¾†çš„é–‹ç™¼è³‡æºç¯€çœæœƒæ¯”é‹ç®—è³‡æºä¾†å¾—é‡è¦&lt;/p>
&lt;blockquote>
&lt;p>å›éé ­ä¾†çœ‹å€åŸŸè®Šæ•¸å“ªè£¡ä¸å¥½ï¼Ÿ&lt;br>
è©¦æƒ³æˆ‘å€‘å‰›å‰›åœ¨æŠ½æ–¹æ³•ï¼Œéœ€è¦æ“”å¿ƒå€åŸŸè®Šæ•¸æœ‰æ²’æœ‰è¢«å…¶ä»–äººè®€å–æˆ–ä¿®æ”¹ï¼Œè€Œæ›´ç³Ÿç³•çš„äº‹æœƒæœ‰äººæŠŠå€åŸŸè®Šæ•¸é‡è¤‡ assign æ–¼ä¸åŒçš„ç”¨é€”ï¼Œç‚ºäº†é¿å…å¤šé¤˜çš„æ“”å¿ƒèˆ‡é–±è®€éšœç¤™ï¼Œç§»é™¤å€åŸŸè®Šæ•¸æ˜¯æœƒæœ‰å¹«åŠ©çš„&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/8e8668ac07c1aa7d32e369844a1f82673d35e427" target="_blank" rel="noopener"
>refactor: remove total_amount&lt;/a>&lt;/p>
&lt;h4 id="3-3-ä¿®æ”¹-frequent_renter_points">3-3. ä¿®æ”¹ frequent_renter_points&lt;/h4>
&lt;p>åŒæ¨£çš„ä¿®æ”¹å¯ä»¥å¥—ç”¨åˆ° frequent_renter_pointsï¼Œä¸é frequent_renter_points æœ¬èº«æ˜¯å€åŸŸè®Šæ•¸ï¼Œè€Œä¸”æ˜¯ä¸æ–·åœ°éš¨è‘— loop è€Œæ”¹è®Šï¼Œé€™æ™‚å€™ç•¶ä½œåƒæ•¸å‚³é€²å»åœ¨ç”¨ return reassign æœ‰é»æ²’å¿…è¦ &lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/90c71babfeec7e5e05170e1b9aca81dd9f4d81c7" target="_blank" rel="noopener"
>refactor: extract and move frequent_renter_points method&lt;/a>&lt;/p>
&lt;h3 id="4-ç§»é™¤å€åŸŸè®Šæ•¸-remove-temp">4. ç§»é™¤å€åŸŸè®Šæ•¸ Remove Temp&lt;/h3>
&lt;p>å…ˆå‰æåˆ°å€åŸŸè®Šæ•¸çš„ç¼ºé»ï¼Œæ¥è‘—ç§»é™¤ total_amount èˆ‡ frequent_renter_pointsï¼Œç›´æ¥åœ¨ä½¿ç”¨çš„åœ°æ–¹å‘¼å«æ–¹æ³•ï¼ŒåŒæ¨£çš„ï¼Œ&lt;code>å‘¼å«æ–¹æ³•çš„æ•ˆèƒ½ç–‘æ…®åªæœ‰åœ¨çœŸçš„æœ‰å•é¡Œæ™‚å†è€ƒæ…®&lt;/code>&lt;/p>
&lt;p>Ruby æ¯”è¼ƒå¦™çš„æ˜¯æ–¹æ³•å‘¼å«å¯ä»¥çœç•¥()ï¼Œæ‰€ä»¥çœ‹èµ·ä¾†è·Ÿå‘¼å«è®Šæ•¸æ²’ä»€éº¼å…©æ¨£&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/e8a02536a1258ed08e74ee0543e6094a4c113688" target="_blank" rel="noopener"
>refactor: remove frequent_renter_points&lt;/a>&lt;/p>
&lt;h3 id="5-é€éå¤šå‹å–ä»£-case">5. é€éå¤šå‹å–ä»£ case&lt;/h3>
&lt;p>å¦‚æœè¦ä½¿ç”¨ caseï¼Œé‚£è¨˜å¾— case ä¸­çš„åˆ¤æ–·ä¾æ“šæ‡‰è©²æ˜¯ç‰©ä»¶æœ¬èº«çš„è³‡æ–™&lt;br>
ç›®å‰åœ¨ Rental çš„ charge ä¸­ï¼Œæœƒä¾ç…§ Movie çš„ type åˆ†ä¸åŒçš„æ”¶è²»æ–¹å¼ï¼Œé€™è£¡å¦‚æœæœªä¾† Movie è¦å¢åŠ  type / èª¿æ•´æ¯ç¨® type çš„æ”¶è²»æ–¹å¼ï¼Œä¸€ç›´ä¾†æ”¹ Rental çš„ charge å‘¼å«ç«¯ä¸å¤ªåˆé©ï¼Œæ‰€ä»¥å°‡ charge çš„é‚è¼¯æ­¸é¡åˆ° Movie ä¸­ &lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/3249902cc08268667286ba7ff0c2f43a7dec9eac" target="_blank" rel="noopener"
>refactor: move charge logic to Movie&lt;/a>&lt;/p>
&lt;p>ç›¸åŒçš„é“ç†ä¹Ÿå¥—ç”¨æ–¼ frequent_renter_points ä¸Š&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/dcf968a9e279c59321a7771ba3c5eab5626976db" target="_blank" rel="noopener"
>refactor: move frequent_renter_points logic to Movie&lt;/a>&lt;/p>
&lt;h4 id="5-2-å°‡-case-è½‰æ›æˆå¤šå‹">5-2. å°‡ case è½‰æ›æˆå¤šå‹&lt;/h4>
&lt;p>Movie ä¸­çš„ charge ä¾ç…§ä¸åŒçš„ type æ”¶è²»ï¼Œé€™è½èµ·ä¾†å°±å¾ˆåƒ&lt;code>ç¹¼æ‰¿&lt;/code>å¯ä»¥è™•ç†çš„äº‹æƒ…ï¼Œå¯å»ºç«‹å¤šå€‹ä¸åŒçš„ Sub Movie Class&lt;br>
ä½†é€™é»ä¸¦ä¸é©ç”¨æ–¼ç›®å‰çš„å ´æ™¯ï¼Œå› ç‚º Movie çš„ type æœƒéš¨è‘—æ™‚é–“è€Œæ”¹è®Šï¼Œä¸¦ä¸æ˜¯åˆå§‹åŒ–å¾Œå°±ä¸è®Šçš„ï¼Œæ‰€ä»¥æ›´é©åˆç”¨ &lt;code>State/Strategy Pattern&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>State/Strategy Pattern æœ€å¤§å·®ç•°åœ¨æ–¼ State è¡¨é”çš„æ˜¯ç‹€æ…‹çš„æ”¹è®Šï¼Œè€Œ Strategy ä»£è¡¨çš„æ˜¯è¨ˆç®—æ™‚çš„æ¼”ç®—æ³•æ”¹è®Šï¼Œå…©è€…çœ‹èµ·ä¾†è »åƒçš„ï¼Œä¸»è¦åœ¨æ–¼å‘½åå¦‚ä½•è¡¨é”è¨­è¨ˆè€…çš„æ„åœ–&lt;/p>
&lt;/blockquote>
&lt;p>é€™é‚Šæ¯”è¼ƒé©åˆç”¨ State Patternï¼Œå› ç‚º Movie çš„ type æ¯”è¼ƒæ˜¯ä¸€ç¨® stateï¼ŒæœƒæŒçºŒä¸€æ®µæ™‚é–“è€Œéç•¶ä¸‹è¨ˆç®—å®Œå°±çµæŸ&lt;/p>
&lt;p>é€™é‚Šç¬¬ä¸€æ­¥å…ˆåœ¨ price_code= æ–¹æ³•ä¸­åˆå§‹åŒ–ç‹€æ…‹ï¼Œå…ˆæš«æ™‚ç”¨ case é ‚æ›¿ç­‰ç­‰æœƒæ›æ‰
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/4e99642cc80c190f48f5f29c9bf7ccf05c208c66" target="_blank" rel="noopener"
>refactor: add state pattern to extract charge logic&lt;/a>&lt;/p>
&lt;h4 id="5-3-æŠ½æ›-frequent_render_points">5-3. æŠ½æ› frequent_render_points&lt;/h4>
&lt;p>frequent_render_points ä¹Ÿå¯ä»¥ç”¨é¡ä¼¼çš„æ–¹å¼ï¼Œä½†æ³¨æ„åˆ°åªæœ‰ New Release çš„è¨ˆç®—æ–¹å¼ä¸åŒï¼Œé€™é‚Šå¯ä»¥ç”¨ Module çš„æ–¹å¼è¨­å®šé è¨­æ–¹æ³•ï¼Œåœ¨ New Release Sub Class ä¸­åœ¨è¤‡å¯«&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/a227f668b68059cc27e6f1acc80ab63e5d7d34aa" target="_blank" rel="noopener"
>refactor: update frequent_renter_points&lt;/a>&lt;/p>
&lt;h4 id="5-4-ç§»é™¤-price_code">5-4. ç§»é™¤ price_code=&lt;/h4>
&lt;p>æœ€å¾Œè®“å‘¼å«è€…å°‡åˆå§‹åŒ–çš„ price class å‚³å…¥ï¼Œå°±å¯ä»¥çœå» price_code= ä¸­çš„ case ä½¿ç”¨&lt;/p>
&lt;p>å°å…¥ State Pattern èŠ±äº†å¹¾å€‹æ­¥é©Ÿï¼Œä¸»è¦æ˜¯åœ¨æœªä¾†å¢åŠ æ–°çš„è¨ˆåƒ¹æ¨¡å¼ï¼ŒèˆŠçš„ Code éƒ½ä¸æœƒå—åˆ°å½±éŸ¿ï¼Œåªè¦æ–°å¢å°±å¥½ï¼Œç¬¦åˆ &lt;code>Open Close åŸå‰‡&lt;/code>&lt;br>
&lt;a class="link" href="https://github.com/sj82516/refactoring-ruby/commit/d100a3353e16f45017f507190e68c192b93110ad" target="_blank" rel="noopener"
>refactor: change Movie initialize&lt;/a>&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>é‡æ§‹æœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼ä¸€æ­¥ä¸€æ­¥èª¿æ•´ç¨‹å¼ç¢¼åˆ°æœ‰å½ˆæ€§çš„æ–¹å¼ï¼Œæ‰€ä»¥ä¸ç”¨ä¸€é–‹å§‹å°±è¿½æ±‚å®Œç¾çš„è¨­è¨ˆï¼Œé¿å…äº† over design çš„å•é¡Œï¼Œå› ç‚ºåªè¦æœ‰é‡æ§‹çš„ç¿’æ…£å°±ä¸æœƒè®“ç¨‹å¼ç¢¼åƒµç¡¬åˆ°ç„¡æ³•ç¶­è­·&lt;/p>
&lt;p>ä¹‹å‰å·¥ä½œå¸¸å¸¸é‡åˆ°å¤§å®¶æœƒèªª Legacy Code å¤šåˆ°ç„¡æ³•ç¶­è­·è€Œéœ€è¦ã€Œé‡å¯«ã€ï¼Œä½†å›éé ­ä¾†çœ‹å¦‚æœç”¨ä¸€æ¨£çš„é‚è¼¯è·Ÿé–‹ç™¼æ–¹å¼ï¼Œé‡å¯«å¹¾ç™¾æ¬¡æœ€å¾Œéƒ½é¢è‡¨åŒæ¨£çš„å›°å¢ƒï¼Œå­¸ç¿’é‡æ§‹é€æ­¥å„ªåŒ–ï¼Œä¸¦èª¿æ•´å°æ–¼ç‰©ä»¶å°å‘ã€è¨­è¨ˆæ¨¡å¼çš„èªçŸ¥ï¼Œé€™æ‰æ˜¯é•·ä¹…ä¹‹è¨ˆ&lt;/p></description></item><item><title>ä¸€æ—¥åƒè§€ ARRC å¯¦é©—å®¤</title><link>https://yuanchieh.page/posts/2021/2021-04-23-%E4%B8%80%E6%97%A5%E5%8F%83%E8%A7%80-arrc-%E5%AF%A6%E9%A9%97%E5%AE%A4/</link><pubDate>Fri, 23 Apr 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-04-23-%E4%B8%80%E6%97%A5%E5%8F%83%E8%A7%80-arrc-%E5%AF%A6%E9%A9%97%E5%AE%A4/</guid><description>&lt;p>é‚„è¨˜å¾—ç´„åœ¨ 2016 å¹´ç¬¬ä¸€æ¬¡åœ¨å‹Ÿè³‡å¹³å°ä¸Šçœ‹åˆ° ARRC çš„å‹Ÿè³‡æ´»å‹•ï¼Œæ‰çŸ¥é“äº¤å¤§æœ‰é€™éº¼ä¸€ä½ç†±è¡€çš„æ•™æˆ å³å®—ä¿¡æ•™æˆï¼Œæƒ³è¦æ‰“é€ ä¸€éš»&lt;code>ç´” MIT çš„ç«ç®­&lt;/code>ï¼Œæ‰¾äº†ç•¶æ™‚ä¸€èµ·èµ´ç¾å”¸æ›¸çš„æœ‹å‹ï¼Œä¸²é€£å¤šæ‰€å¤§å­¸çš„å°ˆæ¥­ä¸€èµ·ç‚ºäº†å¤ªç©ºå¤¢è€ŒåŠªåŠ›&lt;/p>
&lt;p>&lt;a class="link" href="https://www.youtube.com/watch?v=7B9Up161sAI" target="_blank" rel="noopener"
>å°ç£æœ¬åœŸç«ç®­ è¦è®“å¤ªç©ºæ—…è¡Œå¤¢æƒ³æˆçœŸ | å³å®—ä¿¡ Jong-Shinn Wu | TEDxTaipei&lt;/a>&lt;/p>
&lt;p>ç•¶æ™‚æˆ‘é‚„åœ¨é¦¬ç¥–ç•¶æ›¿ä»£å½¹ï¼Œé ˜è‘—æ™‚è–ª 8å…ƒçš„è–ªæ°´ XD é‚„æ˜¯è´ŠåŠ©äº†åŸºæœ¬æ–¹æ¡ˆï¼Œæœ€å¾Œæ”¶åˆ°è´ŠåŠ©å“æ˜¯ä¸€æœ¬è¬›å¤ªç©ºèˆ‡ ARRC çš„ç™¼å±•å²çš„æ›¸(ç¹ªæœ¬?!)&lt;/p>
&lt;p>å…¶å¯¦æˆ‘å°å¤ªç©ºä¸€ç«…ä¸é€šï¼ŒèªªçœŸçš„ä¹Ÿæ²’æœ‰ç‰¹åˆ¥çš„åš®å¾€ï¼Œä½†æˆ‘å¾ˆèªå¯æ•™æˆæ‰€æç¹ªçš„å¤ªç©ºæ™‚ä»£ï¼Œåœ¨ 2021 å¹´å›ä¾†çœ‹ï¼Œåƒ Starlink / Facebook éƒ½åœ¨ç©æ¥µç™¼å°„è¡›æ˜Ÿï¼Œé€£æ•™æˆæ‰€æç¹ªçš„é€éè¡›æ˜ŸæŸ¥çœ‹å•†æ¥­æ¨¡å¼ä¹Ÿåœ¨æˆ‘å–œæ­¡çš„å½±é›†ã€ŠBillionaresã€‹çœŸå¯¦ä¸Šæ¼”ï¼›&lt;br>
å¦å¤–é‚„æœ‰&lt;code>å¤ªç©ºç§‘æŠ€æ˜¯æŠ€è¡“çš„ç«è»Šé ­&lt;/code>ï¼Œå¯ä»¥å¸¶å‹•åŸºç¤ç”¢æ¥­ä¸€èµ·å‘ä¸Šå‡ç´šï¼Œé€™ä¹Ÿæ˜¯æˆ‘è¦ºå¾—å¾ˆç†±è¡€ã€å¾ˆå€¼å¾—æŠ•è³‡çš„äº‹æƒ…&lt;/p>
&lt;p>æ‰€ä»¥åœ¨ 2020å¹´æ¨å‡ºç¬¬äºŒæ³¢çš„è´ŠåŠ©æ™‚å°±ç«‹é¦¬è´ŠåŠ©ï¼Œæ‹¿åˆ°å°ç£å¤ªç©ºéšŠçš„è¡£æœè·ŸéšŠå“¡è­‰ï¼ æœ€å¾Œä¹Ÿæ†‘è­‰æœ‰é€™æ¬¡åƒè§€çš„æ©Ÿæœƒï¼Œä»¥ä¸‹å°‡æ•´ç†èˆ‡åˆ†äº«åƒè§€çš„éç¨‹èˆ‡å¿ƒå¾—&lt;/p>
&lt;p>*è£œå€‹ç•¶åˆæ•™æˆè·Ÿå‘±å‰çš„å°è«‡ï¼Œè¶…ç†±è¡€çš„
&lt;a class="link" href="https://www.youtube.com/watch?v=C5kEJdyer00" target="_blank" rel="noopener"
>ã€å‘±å‰ç›´æ’­ã€‘æ”¿æ²»é›»å°EP12ï¼šè½Ÿéš†éš†éš†è¡è¡è¡æ‹‰é¢¨å¼•æ“ç«ç®­ç™¼å‹•&lt;/a>&lt;/p>
&lt;p>é€™æ¬¡å»çš„æ˜¯äº¤å¤§ ARRCå‰ç»ç«ç®­ç ”ç©¶ä¸­å¿ƒ
&lt;img src="https://yuanchieh.page/post/2021/img/0423/pic4.jpg"
loading="lazy"
>&lt;/p>
&lt;h2 id="ç«ç®­çš„ç¨®é¡">ç«ç®­çš„ç¨®é¡&lt;/h2>
&lt;p>ç«ç®­åœ¨é«˜ç©ºå› ç‚ºå¤–ç•Œç©ºæ°£ç¨€è–„ï¼Œæ‰€ä»¥éœ€è¦è‡ªå‚™ç‡ƒæ–™èˆ‡åŠ©ç‡ƒåŠ‘ï¼ŒåŸºæœ¬ç¨®é¡å¯åˆ†æˆ&lt;/p>
&lt;ol>
&lt;li>å›ºæ…‹ç«ç®­ï¼š&lt;br>
ç‡ƒæ–™èˆ‡åŠ©ç‡ƒåŠ‘å…ˆæ··åˆå¥½ï¼Œä¸¦ä»¥å›ºæ…‹å„²å­˜ï¼Œä¸€é»ç«å°±æœƒé–‹å§‹åŠ‡çƒˆç‡ƒç‡’ï¼Œæœ€å…¥é–€çš„æ˜¯è”—ç³–ç«ç®­ sugar rocketï¼Œå¯ä»¥çœ‹ &lt;a class="link" href="https://www.youtube.com/watch?v=LLjmd6RTNYs" target="_blank" rel="noopener"
>è‡ªè£½ç¡ç³–ç«ç®­ï¼å¤§é›…ä¸€è™Ÿèƒ½å¤ é †åˆ©é£›å‘å®‡å®™å—ï¼Ÿã€èƒ¡æ€äº‚æã€‘(Feat.@é»ƒå°æ½”Jerryâ€‹ , ARRCå‰ç»ç«ç®­ç ”ç©¶ä¸­å¿ƒ)&lt;/a>&lt;/li>
&lt;li>æ¶²æ…‹ç«ç®­ï¼š&lt;br>
ç‡ƒæ–™èˆ‡åŠ©ç‡ƒåŠ‘éƒ½æ˜¯æ¶²æ…‹ï¼Œä½†å› ç‚ºæ˜¯æ¶²é«”æ‰€ä»¥æ··åˆå¾Œå®¹æ˜“çˆ†ç‚¸ï¼Œå±éšªåº¦è¼ƒé«˜&lt;/li>
&lt;li>æ··åˆå¼ç«ç®­ï¼š&lt;br>
ç‡ƒæ–™æ˜¯å›ºæ…‹ï¼ŒåŠ©ç‡ƒåŠ‘æ˜¯æ¶²æ…‹ï¼Œå¯ä»¥ç”¨&lt;a class="link" href="https://www.facebook.com/ARRCRocket/post/1774406962704502:0" target="_blank" rel="noopener"
>é–¥é–€&lt;/a>æ§åˆ¶åŠ©ç‡ƒåŠ‘ä¾†æ§åˆ¶ç«åŠ›ï¼Œç”šè‡³åšåˆ°æ‡¸æµ®çš„åŠŸèƒ½ï¼Œé€™æ˜¯å¦å¤–å…©è€…æ‰€ä¸è¡Œçš„&lt;/li>
&lt;/ol>
&lt;p>æ··åˆå¼ç«ç®­æ˜¯å¤ªç©ºç§‘æŠ€çš„æœªä¾†ï¼Œå…·æœ‰å¯æ§åˆ¶ / å®‰å…¨çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ ARRC æ¥ä¸‹ä¾† HTTP ç³»åˆ—ç«ç®­çš„ç™¼å±•æ–¹å‘&lt;br>
&lt;a class="link" href="https://www.nctu.edu.tw/article/8127" target="_blank" rel="noopener"
>äº¤å¤§ã€ŒARRCå‰ç»ç«ç®­ç ”ç©¶ä¸­å¿ƒã€ å®Œæˆå…¨çƒé¦–æ¬¡æ··åˆå¼ç«ç®­ç©ºä¸­æ‡¸æµ®é£›è©¦&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>éç¨‹ä¸­æœ‰å•ç‚ºä»€éº¼æ··åˆå¼å¾ˆå¥½å…¶ä»–åœ‹å®¶æ²’æœ‰ç‡å…ˆç™¼å±•ï¼Ÿ &lt;br>
å¾—åˆ°çš„ç­”è¦†æ˜¯ç¾åœ‹ç•¶åˆäºŒæˆ°å¾Œç¶æ¶å¾·åœ‹çš„é£›å½ˆå°ˆå®¶ï¼Œæœ‰å„ªè‰¯çš„æ¶²æ…‹ç«ç®­æŠ€è¡“ / æ—¥æœ¬åœ¨ç³¸å·è‹±å¤«çš„ç ”ç©¶ä¸‹ç™¼å±•å›ºæ…‹ç«ç®­ï¼Œå› ç‚ºç«ç®­çš„ç ”ç™¼æˆæœ¬éå¸¸é«˜ï¼Œæ‰€ä»¥æ—¢æœ‰çš„æŠ€è¡“å¾ˆå¥½å°±æœƒæ¡ç”¨ï¼Œåˆå› ç‚ºç«ç®­æ˜¯é«˜æ©Ÿå¯†ç§‘æŠ€ï¼Œä¸æœƒå°å¤–è¼¸å‡ºï¼Œæ‰€ä»¥å°ç£è‡ªå·±åªèƒ½å¾é ­æ‘¸ç´¢ï¼Œæ²’æœ‰éå¾€çš„æŸç¸›æ˜¯åŠ£å‹¢ä¹Ÿæ˜¯å„ªå‹¢&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰å€‹æ•…äº‹æ˜¯æ—¥æœ¬çš„å›ºæ…‹ç«ç®­ç™¼å±•å¤ªå¥½ç¾åœ‹æœƒæ€•ï¼Œåè€Œè¼¸å‡ºæ¶²æ…‹ç«ç®­çµ¦æ—¥æœ¬ï¼Œé€éå¦ä¸€ç¨®æ–¹å¼é™åˆ¶æ—¥æœ¬çš„ç™¼å±• &lt;a class="link" href="https://www.thenewslens.com/article/138128" target="_blank" rel="noopener"
>æ—¥æœ¬çš„å®‡å®™æ”¿ç­–ï¼ˆä¸‹ï¼‰ï¼šçµ‚çµè‡ªä¸»é–‹ç™¼ï¼Œç¾åœ‹å‘æ—¥æœ¬æä¾›æ¶²é«”ç‡ƒæ–™ç«ç®­æŠ€è¡“çš„å…©é»ç†ç”±&lt;/a>&lt;/p>
&lt;h2 id="ç«ç®­çš„å™´å˜´èˆ‡ç‡ƒæ–™">ç«ç®­çš„å™´å˜´èˆ‡ç‡ƒæ–™&lt;/h2>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0423/pic1.jpg"
loading="lazy"
>
å·¦åœ–ç‚ºç«ç®­çš„ç‡ƒæ–™ï¼Œæ“šèªªå°±åƒæ˜¯å¡‘è† è·Ÿæ¨¹è„‚çš„æè³ªï¼Œç‡ƒç‡’æœƒç”¢ç”Ÿå¤§é‡æ°£é«”ï¼Œä¸­é–“æœ‰ä¸€å€‹æ´æœƒè®“æ°£é«”å¾€å¤–æ’æ”¾&lt;/p>
&lt;p>å³åœ–çš„ä¸Šæ–¹æ˜¯å™´å˜´ï¼Œä¸‹æ–¹æ˜¯æ©Ÿé›»çµ„ï¼Œå™´å˜´ä¹Ÿæ˜¯å¤§æœ‰å­¸å•ï¼Œ&lt;code>åœ¨ä½å¤ªç©ºæœƒç”¨å°å™´å˜´ï¼Œé«˜å¤ªç©ºå‰‡ç”¨å¤§å™´å˜´&lt;/code>ï¼Œä¸»è¦æ˜¯ç‚ºäº†è®“ç‡ƒæ–™å™´å‡ºçš„æ°£é«”å¾—åˆ°æœ€å¤§çš„æ¨é€²å‹•åŠ›ï¼Œæ°£é«”æµå‹•é€Ÿåº¦åœ¨å°æ–¼éŸ³é€Ÿæ™‚æ´å£è¶Šå°å‰‡é€Ÿåº¦è¶Šå¿«ï¼Œä½†æ˜¯åˆ°è¶…éŸ³é€Ÿä¹‹å¾Œåè€Œæ˜¯æ´å£è¶Šå¤§é€Ÿåº¦è¶Šå¿«ï¼Œé€™ä¹Ÿå°±æ˜¯å™´å˜´è¨­è¨ˆæ˜¯å¤§åˆ°å°åœ¨å°åˆ°å¤§ï¼›&lt;br>
å¦å¤–å™´å˜´å¤§å°ä¹Ÿæ˜¯ç‚ºäº†é…åˆå¤–ç•Œå¤§æ°£å£“åŠ›ï¼ŒåŒæ¨£æ˜¯æµé«”çš„ç‰¹æ€§ï¼Œ&lt;code>ç•¶æ’å‡ºæ°£é«”çš„å£“åŠ›èˆ‡å¤–ç•Œæ°£å£“ç›¸åŒæ™‚å¯ä»¥ç²å¾—æ›´å¤§çš„å‹•èƒ½&lt;/code>ï¼Œæ‰€ä»¥é«˜å¤ªç©ºå› ç‚ºæ°£å£“ä½æ‰€ä»¥å™´å˜´è¦æ›´å¤§&lt;br>
ä»¥ä¸Šæ“šèªªæ˜¯æµé«”åŠ›å­¸æœ‰æ•™éçš„åŸç†ï¼Œæˆ‘è‡ªå·±æ²’æœ‰ä¿®éå¦‚æœæœ‰å¯«éŒ¯å†éº»ç…©ç³¾æ­£&lt;/p>
&lt;p>é€™ä¹Ÿæ˜¯å¤šç¯€å¼ç«ç®­çš„è¨­è¨ˆåŸå› ä¹‹ä¸€ï¼Œä¸‹æ¬¡å†çœ‹ç«ç®­ç™¼å°„çš„éç¨‹ä¸å¦¨æ³¨æ„çœ‹çœ‹å™´å˜´çš„éƒ¨åˆ†&lt;/p>
&lt;h2 id="ç¢³çº–ç¶­">ç¢³çº–ç¶­&lt;/h2>
&lt;p>ç«ç®­è¦é«˜é€Ÿæ¨é€²åˆ°éå¸¸é™é çš„å½¼å²¸ï¼Œéœ€è¦å¾ˆå¤§çš„å‹•åŠ› / å …å›ºåŒæ™‚è¼•é‡åŒ–çš„é‡é‡ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œé€šå¸¸æ˜¯ç”¨å¾ˆè–„çš„é‡‘å±¬æ‰“é€ ä¸€å±¤å¤–æ®¼ (åœ–ç‰‡å³ä¸Š)ï¼Œåœ¨ç”¨ç¢³çº–ç¶­çºç¹åœ¨å¤–é¢å¢åŠ å¼·åº¦ (å·¦ä¸‹)ï¼Œä¸€çµ„å››æ ¹ (å³ä¸‹)&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0423/pic2.jpg"
loading="lazy"
>&lt;/p>
&lt;p>åœ–ç‰‡ä¸­çš„æ˜¯æ”¾ç‡ƒæ–™çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ç«ç®­çš„å¼•æ“ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ç™½è‰²ä¸­ç©ºçš„æ£’æ£’åŠ å¤§ç‰ˆï¼Œåœ–ç‰‡å³ä¸Šæ˜¯é‡‘å±¬æ®¼ï¼Œå¯¦éš›é•·ç´„ 1.2 å…¬å°ºï¼Œä½†ä»–éå¸¸å¾—è¼•ï¼Œæ‰€ä»¥æ‰è¦ç”¨å¤–é¢çš„é‡‘å±¬æ”¯æ¶ä¿è­·ï¼Œé¿å…è®Šå½¢&lt;/p>
&lt;p>æœ€å¾Œç”¨ç¢³çº–çºç¹æŠ€è¡“ï¼Œå°‡é‡‘å±¬æ®¼çºç¹ï¼Œé€™é»åœ¨å½±ç‰‡ä¸­æœ‰æåˆ°æ˜¯ä¸€é–“ç†±å¿ƒçš„å» å•†å¹«å¿™åšçš„ï¼Œåœ¨å°è¦½éç¨‹ä¸­ä¹Ÿæåˆ°ä»–å€‘é€™å€‹çºç¹æŠ€è¡“å¾ˆä¸éŒ¯ï¼Œæœ€è¿‘é€šéäº†é©—è­‰å¯ä»¥å¹«å¿™åœ¨å¤ªç©ºç›¸é—œçš„ç”¢å“ &lt;a class="link" href="https://www.facebook.com/ARRCRocket/post/2292227254255801/" target="_blank" rel="noopener"
>ã€HTTP-3A ç ”ç™¼é€²åº¦ï½œç«ç®­ç¢³çº–ç¶­çºç¹å¤–æ®¼ã€‘&lt;/a>ï¼Œå†æ¬¡æ‡‰è­‰äº†&lt;code>å°ç£çš„ç”¢æ¥­å¯¦åŠ›çœŸçš„å¾ˆæ£’ï¼Œåªæ˜¯æ²’æœ‰ä¸€å€‹å“ç‰Œè·Ÿæ•´åˆçš„é¾é ­&lt;/code>&lt;/p>
&lt;p>ä½†å¤§å¤šæ•¸çš„ç¢³çº–ç¶­éƒ½åªèƒ½ç”¨äººå·¥å»æ‹¼è²¼ï¼Œåƒæ˜¯ç¢³çº–ç¶­è…³è¸è»Šéƒ½æ˜¯ç´”æ‰‹å·¥ï¼Œè¤‡é›œçš„éƒ¨åˆ†é‚„æ²’è¾¦æ³•ç”¨æ©Ÿå™¨å–ä»£ï¼Œåœ¨ ARRC ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦è‡ªå·±è²·ç¢³çº–ç¶­çš„å¸ƒè‡ªå·±å‹•æ‰‹ï¼Œé€™ä½å¹«å¿™å°è¦½çš„åŒå­¸å°±è‡ªå·±å‹•æ‰‹åšäº†ä¸€å°å››ç¶­çš„ç¢³çº–ç¶­åˆ‡å‰²æ©Ÿ(ä¸‹åœ–)ï¼Œä»–èªªå¤–é¢ä¸€å°å¯èƒ½è¦ä¸Šç™¾è¬ï¼Œè‡ªå·± DIY åªèŠ±äº†äº”ã€å…­è¬è€Œå·²ï¼Œè€Œä¸”çœä¸‹å…©ã€ä¸‰å€‹äººåŠ›éå¸¸æ£’ï¼Œé€™ä½åŒå­¸æœ€å¾Œèªªä»–ç¾åœ¨æ‰å¤§å››ï¼Œå¾å¤§ä¸€å°±é–‹å§‹å¹«å¿™äº†ï¼Œæ»¿æ»¿çš„ respect! å¯æƒœå¿˜äº†å•åŒå­¸çš„å¤§å&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/%e7%a2%b3%e7%ba%96%e7%b6%ad%e5%88%87%e5%89%b2%e6%a9%9f.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>åœ–ç‰‡å·¦ä¸Šæ˜¯ç«ç®­å°–ç«¯çš„éƒ¨åˆ†ï¼Œå› ç‚ºè¦è€é«˜æº«æ‰€ä»¥ç”¨é‡‘å±¬çš„é¼»é ­ï¼Œæœ‰æåˆ°ç«ç®­é‹ç”¨çš„æ˜¯ç¢³çº–ç¶­èˆ‡é‡‘å±¬çš„æ··åˆä½¿ç”¨ï¼Œåœ¨é›¶ä»¶ä¹‹é–“æ˜¯é€éç‰¹æ®Šçš„è† æ°´å›ºå®šï¼Œèºçµ²åŸºæœ¬ä¸Šæ˜¯ä¸å—åŠ›çš„&lt;/p>
&lt;h2 id="éš¨æ‰‹æ‹æ‹">éš¨æ‰‹æ‹æ‹&lt;/h2>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0423/pic3.jpg"
loading="lazy"
>
ä¸‰å¼µå°åœ–æ˜¯é‚„åœ¨ç ”ç™¼çš„ HTTP-3A å–”ï¼
å³ä¸‹è§’æ˜¯åˆ°æ™‚å€™æ¬é‹ç«ç®­çš„è¼‰å…·ï¼Œå› ç‚ºç«ç®­éå¸¸éå¸¸è¼•ï¼Œæ‰€ä»¥è·¯ä¸Šæ¬é‹æœƒæœ‰è®Šå½¢ï¼Œéœ€è¦æœ‰å¤–å±¤æ”¯æ¶ä¿è­·ï¼Œè¨˜å¾—åœ¨æŸéš»å½±ç‰‡æœ‰æåˆ°å°ç£åœ¨æ±éƒ¨ç™¼å°„é‚„ä¸éŒ¯ï¼Œç©©åº¦ä½æœ‰è¶³å¤ çš„åœ°çƒè‡ªè½‰é€Ÿåº¦ï¼ŒåŒæ™‚æ…£æ€§æœƒå¾€å¤ªå¹³æ´‹å°„æ¯”è¼ƒå®‰å…¨&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/2021/img/0423/pic5.jpg"
loading="lazy"
>
ç¥ç™¼å°„é †åˆ©ä»¥åŠç„¡é è­¦å‡ºç¾çš„å³å®—ä¿¡æ•™æˆ&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>å”±è¡°å°ç£çš„äººå¾ˆå¤šï¼Œä½†è‚¯å‡ºä¾†æ”¹è®Šçš„äººå¾ˆå°‘ï¼Œé€™æ¬¡åƒè§€çš„éç¨‹çœ‹åˆ°æœ‰ä¸€ç¾¤è¸å¯¦çš„äººåœ¨åŠªåŠ›åšä¸€ä»¶ä¸å¯æ€è­°ä½†é€æ­¥å¯¦ç¾çš„éç¨‹ï¼Œè¦ºå¾—æ»¿æ»¿çš„è¸å¯¦èˆ‡ç†±è¡€ï¼Œè‡ªå·±æœ‰é€™å€‹æ©Ÿæœƒå¯ä»¥ç”¨å¾®è–„çš„è´ŠåŠ©æ”¯æŒè¦ºå¾—å¾ˆé–‹å¿ƒï¼Œä¹ŸæœŸè¨±è‡ªå·±çš„æœªä¾†ä¹Ÿå¯ä»¥è¸å¯¦çš„èµ°ä¸‹å»&lt;/p></description></item><item><title>ã€è·¨ç¨‹å¼èªè¨€ä¸Šæ‰‹ã€‘Ruby åŸºç¤æ•™å­¸</title><link>https://yuanchieh.page/posts/2021/2021-04-02-%E8%B7%A8%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80%E4%B8%8A%E6%89%8Bruby-%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/</link><pubDate>Fri, 02 Apr 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-04-02-%E8%B7%A8%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80%E4%B8%8A%E6%89%8Bruby-%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/</guid><description>&lt;p>ã€è·¨ç¨‹å¼èªè¨€ä¸Šæ‰‹ã€‘ç³»åˆ—ç¬¬ä¸€ç¯‡ï¼Œæœ€è¿‘æ›å·¥ä½œå­¸ç¿’äº† Golang / Rubyï¼Œå¯ä»¥èªªæ˜¯è¨­è¨ˆç†å¿µè™•æ–¼å°ç«‹é¢çš„ç¨‹å¼èªè¨€ï¼Œåœ¨å­¸ç¿’ä¸­ä¸æ–·æ‹¿å…©è€…æ¯”è¼ƒï¼Œæ‰¾åˆ°å¾ˆå¤šæœ‰è¶£çš„åœ°æ–¹&lt;br>
åœ¨é€™æ¨£çš„éç¨‹ä¸­ï¼Œæ…¢æ…¢æ‰¾å‡ºè‡ªå·±ä¸Šæ‰‹æ–°ç¨‹å¼èªè¨€çš„ patternï¼Œä¹Ÿå°±æ˜¯é€æ­¥å¡«è£œè‡ªæˆ‘ç–‘å•çš„éç¨‹ï¼Œåƒæ˜¯ã€Œæ€éº¼å®£å‘Šè®Šæ•¸ï¼Ÿã€ã€Œæ€éº¼å¯«æ¸¬è©¦ï¼Ÿã€ã€Œapi server / http request æ€éº¼ç™¼ï¼Ÿã€ã€Œä½µç™¼æˆ–æ•ˆèƒ½æ€éº¼è™•ç†ï¼Ÿã€ç­‰ç­‰å…±é€šçš„ç–‘æƒ‘é»&lt;/p>
&lt;p>åŠé–“æœ‰å¾ˆå¤šå–„å¿ƒäººå£«çš„æ•™å­¸ï¼Œä½†å¾€å¾€éƒ½ç¼ºä¸€é»æˆ‘æƒ³äº†è§£çš„è³‡è¨Šï¼Œä¾‹å¦‚ Google æœå°‹ã€ŒRuby æ•™å­¸ã€çš„ä¸­æ–‡ç´ æï¼Œè·‘å‡ºé€™å¹¾å€‹å¾ˆæ£’çš„æ•™å­¸&lt;/p>
&lt;ol>
&lt;li>é«˜è¦‹é¾å¤§å¤§çš„ &lt;a class="link" href="https://railsbook.tw/" target="_blank" rel="noopener"
>ç‚ºä½ è‡ªå·±å­¸ Ruby on Rails&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://ihower.tw/rails/ruby.html" target="_blank" rel="noopener"
>Ruby on Rails å¯¦æˆ°è–ç¶“&lt;/a>&lt;/li>
&lt;li>Ruby å®˜ç¶²çš„ &lt;a class="link" href="https://www.ruby-lang.org/zh_tw/documentation/quickstart/3/" target="_blank" rel="noopener"
>äºŒååˆ†é˜ Ruby é«”é©—&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>Ruby æ•™å­¸æœƒè¢«ç¶åœ¨ Rails æ•™å­¸ä¸­æˆ–è¨±æ˜¯ Ruby ç”Ÿæ…‹ç‰¹æœ‰çš„ç¾è±¡ï¼Œä½†æ™®éç¨‹å¼èªè¨€æ•™å­¸ä¹Ÿéƒ½ç¼ºå°‘&lt;/p>
&lt;ol>
&lt;li>Testingï¼šåŒ…å« Testing Framework / Unit Test / Mockã€Stub&lt;/li>
&lt;li>Moduleï¼šCore Module / Local Module æ€éº¼è¼‰å…¥&lt;/li>
&lt;li>Concurrencyï¼šåº•å±¤å¦‚ä½•è™•ç†ä½µç™¼/å¹³è¡Œé‹ç®—&lt;/li>
&lt;li>ç¨‹å¼èªè¨€å¤šç”¨æ–¼å¾Œç«¯ï¼Œæ‰€ä»¥æˆ‘æœƒåœ¨æ„å¯« api server / http request çš„æ„Ÿè¦ºæ˜¯æ€æ¨£&lt;/li>
&lt;/ol>
&lt;p>å¯ä»¥èªªé€™å¹¾é»éƒ½æ˜¯æ¯”è¼ƒé€²éš/åç§‘çš„è­°é¡Œï¼Œä½†å°æˆ‘çš„å·¥ä½œå¾ˆé‡è¦ï¼Œä¹Ÿæ˜¯é€™ç³»åˆ—çš„èµ·æºï¼Œ&lt;code>æˆ‘æƒ³è¦é‡æ–°å¯«ä¸€ä»½å°æˆ‘è‡ªå·±ä¾†èªªå®Œæ•´çš„ç¨‹å¼èªè¨€æ•™å­¸&lt;/code>ï¼Œéç¨‹ä¸­æœƒæ‹¿æˆ‘å·²ç¶“ç†Ÿæ‚‰çš„ç¨‹å¼èªè¨€å¦‚ Javascript è·Ÿä¸€é»é»çš„ Golang åšå°æ¯”&lt;/p>
&lt;blockquote>
&lt;p>ç›®æ¨™æœƒè‘—é‡æ–¼æœ‰ç¶“é©—çš„ç¨‹å¼è¨­è¨ˆå¸«ï¼Œå·²ç¶“ç†Ÿç·´ä»»ä¸€ç¨‹å¼èªè¨€ï¼Œæƒ³è¦å¿«é€Ÿä¸Šæ‰‹æˆ–æ˜¯å“å‘³å¦ä¸€é–€èªè¨€çš„äºº&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥ä¸‹å…§å®¹æœƒåŒ…å«&lt;/p>
&lt;ol>
&lt;li>Ruby è¨­è¨ˆç†å¿µèˆ‡èµ·æº&lt;/li>
&lt;li>åŸºç¤èªæ³•&lt;/li>
&lt;li>æ¨¡çµ„&lt;/li>
&lt;li>æ¸¬è©¦&lt;/li>
&lt;li>Http / API ç›¸é—œ&lt;/li>
&lt;li>å…¶ä»–è£œå……&lt;/li>
&lt;/ol>
&lt;p>å…§å®¹å¤§é‡åƒè€ƒä¸Šé™„çš„åƒè€ƒè³‡æ–™ï¼Œä¸¦èå…¥è‡ªå·±çš„æ·ºè¦‹ï¼Œæœƒéš¨è‘—ä½¿ç”¨æ™‚é–“çš„æ‹‰é•·æŒçºŒä¿®æ”¹ï¼Œæœ‰ä»€éº¼ä¸åŒçš„æ„è¦‹æ­¡è¿ç•™è¨€åˆ†äº«&lt;/p>
&lt;h2 id="1-ruby-è¨­è¨ˆç†å¿µèˆ‡èµ·æº">1. Ruby è¨­è¨ˆç†å¿µèˆ‡èµ·æº&lt;/h2>
&lt;p>Ruby æ˜¯ä¸€é–€ Dynamic Languageï¼Œé‹è¡Œåœ¨ Ruby Virtual Machine ä¸Šï¼Œæœ¬èº«æ˜¯å¼±å‹åˆ¥ä½†æ²’æœ‰ JS ä¸­éš±å¼çš„è½‰å‹ (ex. 1 + &amp;ldquo;23&amp;rdquo;)ï¼Œåœ¨ 3.0 åŠ å…¥ Type safety å·¥å…· &lt;code>TypeProf&lt;/code> å¹«åŠ©æª¢æŸ¥å‹åˆ¥å•é¡Œ&lt;/p>
&lt;p>é€éç¯„ä¾‹ç°¡å–®çœ‹ä¸€ä¸‹ Ruby å¹¾å€‹ç‰¹åˆ¥çš„è¨­è¨ˆç†å¿µ&lt;/p>
&lt;h3 id="ruby-is-designed-to-make-programmers-happy">Ruby is designed to make programmers happy&lt;/h3>
&lt;p>å‡ºè‡ªæ–¼ &lt;a class="link" href="https://www.artima.com/articles/the-philosophy-of-ruby" target="_blank" rel="noopener"
>The Philosophy of Ruby A Conversation with Yukihiro Matsumoto, Part I&lt;/a>ï¼ŒRuby çµ¦äºˆé–‹ç™¼è€…å¾ˆé«˜çš„è‡ªç”±åº¦&lt;/p>
&lt;ol>
&lt;li>å®šç¾© symbol åœ¨ Ruby çš„æ¡†æ¶ä¸‹ç”¢ç”Ÿè‡ªå·±çš„ DSLï¼Œä¾‹å¦‚ &lt;a class="link" href="http://sinatrarb.com/" target="_blank" rel="noopener"
>sinatra&lt;/a> é€™å€‹ web frameworkï¼Œçœ‹ç¯„ä¾‹æœƒä»¥ç‚ºæ ¹æœ¬ä¸æ˜¯ ruby å¯«çš„&lt;/li>
&lt;li>æ”¯æ´ Meta programming å¯ä»¥åœ¨ Runtime æ”¹è®Šé¡åˆ¥è¡Œç‚º&lt;/li>
&lt;li>å¯ä»¥è¤‡å¯«ä»»æ„çš„æ–¹æ³•ï¼ŒåŒ…å«åŸç”Ÿé¡åˆ¥&lt;/li>
&lt;li>åŒä¸€ç¨®åŠŸèƒ½å¯ä»¥æœ‰éå¸¸å¤šç¨®å¯«æ³•ï¼Œå…‰æ˜¯è¿´åœˆå¯ä»¥ç”¨ while / for in / each / until / begin while ç­‰&lt;/li>
&lt;/ol>
&lt;h3 id="seeing-everything-as-an-object">Seeing Everything as an Object&lt;/h3>
&lt;p>åœ¨ Ruby çš„ä¸–ç•Œä¸­ï¼Œå¹¾ä¹æ¯ä¸€å€‹è®Šæ•¸éƒ½æ˜¯ç‰©ä»¶ï¼ŒåŒ…å« &lt;code>1+2&lt;/code> ä¹Ÿå¯ä»¥å¯«æˆ &lt;code>1.+(2)&lt;/code>ï¼Œ1 æœ¬èº«æ˜¯ &lt;code>Integer é¡åˆ¥&lt;/code>è£¡é ­æœ‰ + é€™å€‹æ–¹æ³•&lt;br>
é€™è®“ Ruby å¾ˆé©åˆ OOPï¼Œä¹Ÿå¸¶ä¾†å¾ˆå¤šçš„å½ˆæ€§ï¼Œåƒæ˜¯åœ¨ operator overwrite&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Integer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">alias&lt;/span> &lt;span class="ss">:plus&lt;/span> &lt;span class="ss">:+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">other&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_s&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34; is adding &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">other&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plus&lt;/span> &lt;span class="n">other&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¼¸å‡ºçµæœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1 is adding 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Integer æ˜¯é è¨­é¡åˆ¥ï¼ŒRuby é‡åˆ°é¡åˆ¥é‡è¤‡å®£å‘Šæ™‚æœƒ&lt;code>åˆä½µ&lt;/code>ï¼Œæ¥è‘—æˆ‘å€‘åœ¨ Integer å®£å‘Š plus æ˜¯åŸæœ¬ + çš„åˆ¥åï¼Œæ¥è‘—è¦†å¯« &lt;code>+&lt;/code> å…ˆæ‰“å°å‡º is adding å­—ä¸²åœ¨å›å‚³ï¼Œåœ¨ Ruby ä¸­é è¨­ function æœ€å¾Œä¸€è¡Œå³ä½¿ä¸é¡¯å¼å®£å‘Šä¹Ÿæœƒ return&lt;/p>
&lt;h3 id="é€éåŒ¿åå‡½å¼æ”¯æ´-functional-programming-style">é€éåŒ¿åå‡½å¼æ”¯æ´ Functional Programming Style&lt;/h3>
&lt;p>åœ¨ Ruby ä¸–ç•Œä¸­ï¼Œä¸åƒ Javascript / Golang æŠŠ function è¦–ç‚ºä¸€ç­‰å…¬æ°‘&lt;/p>
&lt;blockquote>
&lt;p>åœ¨ç¨‹å¼èªè¨€ä¸­ï¼Œæ‰€è¬‚çš„ä¸€ç­‰å…¬æ°‘æ¢ä»¶æ˜¯&lt;/p>
&lt;ol>
&lt;li>å¯ä»¥å‚³å…¥ function ç•¶ä½œåƒæ•¸&lt;/li>
&lt;li>å¯ä»¥è¢« function ç•¶ä½œ return å€¼&lt;/li>
&lt;li>å¯ä»¥è¢«å„²å­˜æ–¼è³‡æ–™çµæ§‹ä¸­ä½¿ç”¨&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>ä½†æ˜¯ Ruby ä¹Ÿé‚„æ˜¯åŒ¿åå‡½å¼çš„èªæ³•ï¼Œå¤§è‡´å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">proc&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sum_five&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">sum_five&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">sum_five&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">sum_five&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¾ŒçºŒæœƒæœ‰æ›´è©³ç´°è£œå……ï¼Œä½†è‡³å°‘ Ruby ä¸–ç•Œä¸­ä¹Ÿæ˜¯å¯ä»¥åšåˆ° functional programming çš„&lt;/p>
&lt;p>ç¶œåˆä»¥ä¸Šï¼ŒRuby æ˜¯ä¸€é–€å½ˆæ€§å¾ˆå¤§ã€å¾ˆè‡ªç”±çš„èªè¨€ï¼Œé€™æ˜¯ä¸€æŠŠé›™é¢åˆƒï¼Œå°æ–¼æ–°æ‰‹å¯èƒ½ä¹Ÿä¸æ˜¯é€™éº¼å‹å–„ï¼Œç•¢ç«Ÿæœ‰å¤ªå¤šèªæ³•è·Ÿé—œéµå­—è¦å»ç†Ÿæ‚‰&lt;/p>
&lt;h3 id="å¦‚ä½•å®‰è£">å¦‚ä½•å®‰è£&lt;/h3>
&lt;p>å¯ä»¥å¾å®˜ç¶²ä¸‹è¼‰å®‰è£ &lt;a class="link" href="https://www.ruby-lang.org/en/documentation/installation/" target="_blank" rel="noopener"
>Installing Ruby&lt;/a>ï¼Œæˆ–æ˜¯å…ˆå®‰è£ Ruby ç‰ˆæœ¬ç®¡ç†å·¥å…·å¦‚ &lt;a class="link" href="http://rvm.io/" target="_blank" rel="noopener"
>RVM&lt;/a>&lt;/p>
&lt;h4 id="å¥—ä»¶ç®¡ç†">å¥—ä»¶ç®¡ç†&lt;/h4>
&lt;p>å®‰è£å®Œ ruby å¾Œï¼Œä¹ŸåŒæ™‚å®‰è£äº† &lt;code>gem&lt;/code>ï¼Œgem æ˜¯ ruby å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¯ä»¥å®‰è£æˆ–ç™¼ä½ˆè‡ªå·±çš„å¥—ä»¶&lt;/p>
&lt;blockquote>
&lt;p>gem æˆ‘ä¸€é–‹å§‹ç†è§£æˆ npmï¼Œä½† npm å±¤ç´šé«˜äº†ä¸€äº›ï¼Œä¾‹å¦‚ gem ä¸¦æ²’æœ‰åšåˆ°ç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼Œgem + bundle æ¯”è¼ƒæ˜¯ npm çš„çµ„åˆ&lt;/p>
&lt;/blockquote>
&lt;p>è©³ç´°å¯åƒè€ƒ &lt;a class="link" href="https://medium.com/@bag571ivy3470/ruby-%E7%9A%84-rvm-vs-gem-vs-bundle-%E7%9A%84%E5%B7%AE%E5%88%A5-fc9ab20a920" target="_blank" rel="noopener"
>Ruby çš„ Rvm VS Gem VS Bundler çš„å·®åˆ¥&lt;/a>&lt;/p>
&lt;h2 id="åŸºç¤èªæ³•">åŸºç¤èªæ³•&lt;/h2>
&lt;h3 id="è®Šæ•¸å®£å‘Š">è®Šæ•¸å®£å‘Š&lt;/h3>
&lt;ol>
&lt;li>ä¸ç”¨å®£å‘Šå‹åˆ¥&lt;/li>
&lt;li>è®Šæ•¸å¯ä»¥æ”¹è®Šå‹åˆ¥&lt;/li>
&lt;li>ä½†æ˜¯æ²’æœ‰éš±å¼çš„å‹åˆ¥è½‰æ›&lt;/li>
&lt;li>è®Šæ•¸çš„ &lt;code>scope åªæœ‰ç•¶å‰çš„ context&lt;/code>ï¼Œä½†è¦æ³¨æ„åŒ¿åå‡½å¼æœƒè®€å–ç•¶å‰çš„ contextï¼Œä¸¦ä¸æœƒä¸€ç›´å¾€ä¸ŠæŸ¥æ‰¾ï¼Œé™¤éç”¨å…¨åŸŸè®Šæ•¸ &lt;code>$&lt;/code> é–‹é ­&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">123&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span> &lt;span class="c1"># æ‹‹éŒ¯ TypeError (String can&amp;#39;t be coerced into Integer)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">func&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="c1"># æ‹‹éŒ¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upto&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="c1"># é€™æ¨£æ˜¯å¯ä»¥çš„ï¼Œå› ç‚º block æ˜¯ç”¨å®£å‘Šç•¶å‰çš„ context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">$sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="c1"># å…¨åŸŸè®Šæ•¸å¯ä»¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">func&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="vg">$sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å‘½åè¦å‰‡">å‘½åè¦å‰‡&lt;/h4>
&lt;ol>
&lt;li>è®Šæ•¸åç¨±å¸¸ç”¨è›‡å½¢å‘½åæ³•&lt;/li>
&lt;li>è®Šæ•¸å…¨å¤§å¯«ä»£è¡¨&lt;code>å¸¸æ•¸&lt;/code>ï¼Œä½†æ˜¯å¸¸æ•¸è¢«æ”¹æœƒæœ‰ warning ä¸æœƒæœ‰éŒ¯èª¤&lt;/li>
&lt;li>Class/Module åç¨±é–‹é ­å¤§å¯«&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">naming_convetion&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">FIVE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">FIVE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="c1"># warning: already initialized constant X&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="symbols">Symbols&lt;/h4>
&lt;p>å»ºç«‹å”¯ä¸€ä¸”ä¸å¯è®Šçš„ç‰©ä»¶ï¼Œç”¨ &lt;code>:&lt;/code> é–‹é ­ï¼Œé‡è¤‡å®£å‘Šéƒ½æœƒæŒ‡å‘åŒä¸€ä»½è¨˜æ†¶é«”ä½ç½® (&lt;code>é€é object_id è­˜åˆ¥&lt;/code>)ï¼Œè€Œå­—ä¸²æ¯ä¸€æ¬¡å®£å‘Šéƒ½æœƒåœ¨è¨˜æ†¶é«”ç”¢ç”Ÿæ–°çš„ä¸€ä»½ String Objectï¼Œå¦‚æœæ˜¯è¦å–®ç´”ç”¨ä¾†è­˜åˆ¥ Symbol æ•ˆèƒ½æœƒæ¯” String å¥½ä¸Šå¾ˆå¤šå–”&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">hello&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ss">:hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">world&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ss">:hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">hello&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">world&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">hello&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">object_id&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">world&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">object_id&lt;/span> &lt;span class="c1">#true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">hello&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;hello&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">world&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;hello&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">hello&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">world&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">hello&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">object_id&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">world&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">object_id&lt;/span> &lt;span class="c1">#false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="hash">Hash&lt;/h4>
&lt;p>Ruby æœ‰ Hashï¼Œå¯ä»¥ç”¨ &lt;code>=&amp;gt; æˆ– :&lt;/code> åˆ†éš” key valueï¼Œä½†æ˜¯å…©è€…æœ‰å¾ˆå¤§çš„å·®ç•°&lt;/p>
&lt;ol>
&lt;li>=&amp;gt; éå¸¸çš„è‡ªç”±ï¼Œkey å€¼å¯ä»¥æ˜¯ä»»æ„çš„å€¼&lt;/li>
&lt;li>: çš„ key åªèƒ½æ˜¯ symbolï¼Œå¦‚æœæ”¾å­—ä¸²æœƒç›´æ¥è½‰æˆ symbol&lt;br>
è¦éå¸¸å°å¿ƒ &lt;code>string è·Ÿ symbol&lt;/code> æ˜¯ä¸åŒçš„ï¼Œå¯¦ä½œä¸Šå¾ˆå®¹æ˜“è¸©åˆ°é€™å€‹å‘&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="c1"># nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="ss">:&amp;#34;123&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="c1"># &amp;#34;123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="c1"># &amp;#34;123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="ss">:&amp;#34;123&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="c1"># nil&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ruby-ä¸­å¹¾ä¹éƒ½æ˜¯ç‰©ä»¶æœ‰å…§å»ºå¾ˆå¤šä¾¿åˆ©çš„æ–¹æ³•">Ruby ä¸­å¹¾ä¹éƒ½æ˜¯ç‰©ä»¶ï¼Œæœ‰å…§å»ºå¾ˆå¤šä¾¿åˆ©çš„æ–¹æ³•&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">methods&lt;/span> &lt;span class="c1"># åˆ—å‡ºæ‰€æœ‰ Integer åŒ…å«çš„ method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">odd?&lt;/span> &lt;span class="c1"># æ˜¯ä¸æ˜¯å¶æ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">class&lt;/span> &lt;span class="c1"># é¡åˆ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_s&lt;/span> &lt;span class="c1"># è½‰æˆå­—ä¸²&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="é™£åˆ—">é™£åˆ—&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">include?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">push&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pop&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="loop--control-flow">loop / control flow&lt;/h3>
&lt;h4 id="æ¢ä»¶å¼">æ¢ä»¶å¼&lt;/h4>
&lt;p>åŸºæœ¬çš„ if / elseif / else èˆ‡ä¸‰å…ƒåˆ¤æ–·å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">odd?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;x is odd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">elsif&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">even?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;x is even&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;never happen&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">odd?&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="s2">&amp;#34;x is odd&amp;#34;&lt;/span>&lt;span class="ss">:&amp;#34;x is even&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="switch-case">switch case&lt;/h4>
&lt;ol>
&lt;li>æ¡ç”¨ case / when / else èªæ³•ï¼Œä¸ç”¨åŠ  break&lt;/li>
&lt;li>case å¦‚æœæ²’æœ‰æ¥åƒæ•¸ï¼Œå‰‡ when æ¢ä»¶å¯ä»¥æ”¾ statement / å¦‚æœæœ‰æ¥åƒæ•¸ï¼Œå‰‡ when æ¢ä»¶æ”¾å¸¸æ•¸&lt;/li>
&lt;li>å¦‚æœå¸Œæœ› case when çµæœè³¦å€¼çµ¦è®Šæ•¸ï¼Œå¯ä»¥ç”¨ when &amp;hellip; then&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">when&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">odd?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;x is odd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">when&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">even?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;x is even&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;never happen&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">when&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;x is in 1 to 10&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;x is not in 1 to 10&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">when&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span> &lt;span class="s2">&amp;#34;x is in 1 to 10&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;x is not in 1 to 10&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># val = &amp;#34;x is in 1 to 10&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="è¿´åœˆ">è¿´åœˆ&lt;/h4>
&lt;p>æ–¹å¼å¾ˆå¤šç¨®&lt;/p>
&lt;ol>
&lt;li>å…ˆæª¢æŸ¥æ¢ä»¶çš„ for in / while / until&lt;/li>
&lt;li>å¾Œæª¢æŸ¥æ¢ä»¶çš„ begin &amp;hellip; (when/until)&lt;/li>
&lt;li>Enumerable ç‰©ä»¶å¯ä»¥ç”¨ each&lt;/li>
&lt;/ol>
&lt;p>ä½†&lt;code>æ²’æœ‰å¸¸è¦‹ for(initialExpression; conditionExpression; incrementExpression)&lt;/code> å®£å‘Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">until&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="n">arr&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">each&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="nb">puts&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="error-handling">Error handling&lt;/h4>
&lt;ol>
&lt;li>é€é raise æ‹‹å‡ºéŒ¯èª¤&lt;/li>
&lt;li>é€é rescue æ¥éŒ¯èª¤ï¼Œå¯ä»¥æ›´é€²éšæŒ‡å®šéŒ¯èª¤é¡å‹&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#... process, may raise an exception&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="no">ArgumentError&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">rescue&lt;/span> &lt;span class="no">ArgumentError&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;ArgumentError&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">rescue&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="n">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="n">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#... error handler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#... executes when no error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">ensure&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#... always executed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€²éšè³‡æ–™è«‹åƒè€ƒ &lt;a class="link" href="https://stackify.com/rescue-exceptions-ruby/" target="_blank" rel="noopener"
>How to Rescue Exceptions in Ruby&lt;/a>&lt;/p>
&lt;h3 id="function">Function&lt;/h3>
&lt;ol>
&lt;li>function ä¸ç”¨å®šç¾©å›å‚³å€¼&lt;/li>
&lt;li>å‘¼å«å¯ä»¥çœç•¥æ‹¬è™Ÿ&lt;/li>
&lt;li>é è¨­æœ€å¾Œä¸€è¡Œæœƒå›å‚³ï¼Œä¸ç”¨åœ¨é¡¯ç¤ºå®£å‘Š return&lt;/li>
&lt;li>å¦‚æœå‘¼å«çš„åƒæ•¸æ•¸é‡è·Ÿå®£å‘Šä¸åŒæœƒæ‹‹å‡ºéŒ¯èª¤&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">add&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="c1"># ç­‰åŒæ–¼ return a + b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="class">Class&lt;/h3>
&lt;ol>
&lt;li>é è¨­ Class åç¨±é–‹é ­å¤§å¯«&lt;/li>
&lt;li>æ”¯æ´ç¹¼æ‰¿ &lt;code>Successor &amp;lt; Predecessor&lt;/code>&lt;/li>
&lt;li>è¦å»ºç«‹ instance é€é &lt;code>Class.new&lt;/code>ï¼Œæœƒå‘¼å« class ä¸­çš„ private method &lt;code>initialize&lt;/code>&lt;/li>
&lt;li>å®£å‘Š instance è®Šæ•¸ä»¥ &lt;code>@&lt;/code> é–‹é ­ / å®£å‘Š class static è®Šæ•¸ç”¨ &lt;code>@@&lt;/code>&lt;/li>
&lt;li>éœ€è¦é¡¯å¼æŒ‡å®šé‡å° instance è®Šæ•¸çš„ getter/setterï¼Œæˆ–æ˜¯ç”¨ &lt;code>attr_accessor/attr_writer/attr_reader&lt;/code> å¢åŠ &lt;/li>
&lt;li>æ”¯æ´ public/protected/privateï¼Œä½†è·Ÿå…¶ä»–èªè¨€çš„ private ä¸å¤ªåŒï¼Œä»¥ä¸‹ç¯€éŒ„è‡ªé«˜è¦‹é¾å¤§å¤§çš„æ–‡ç« &lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>å› ç‚ºåœ¨ Ruby è£¡æ‰€è¬‚çš„ private æ–¹æ³•çš„ä½¿ç”¨è¦å®šå¾ˆç°¡å–®ï¼Œå°±åªæœ‰ä¸€æ¢ï¼šã€Œä¸èƒ½æ˜ç¢ºçš„æŒ‡å‡º receiverã€ã€‚ç”¨ç™½è©±æ–‡è¬›ï¼Œå°±æ˜¯ã€Œåœ¨å‘¼å« private æ–¹æ³•çš„æ™‚å€™ï¼Œå‰é¢ä¸å¯ä»¥æœ‰å°æ•¸é»ã€ã€‚ä¹Ÿå°±æ˜¯å› ç‚ºé€™æ¨£ï¼Œåœ¨ Ruby çš„ private æ–¹æ³•å…¶å¯¦ä¸åªé¡åˆ¥è‡ªå·±å…§éƒ¨å¯ä»¥å­˜å–ï¼Œå®ƒçš„å­é¡åˆ¥ä¹Ÿå¯ä»¥ï¼Œä¸¦æ²’æœ‰åƒå…¶å®ƒç¨‹å¼èªè¨€ä¸€æ¨£çš„ç¹¼æ‰¿é™åˆ¶&lt;/p>
&lt;/blockquote>
&lt;ol start="7">
&lt;li>å®šç¾© static method å¯ä»¥ç”¨ &lt;code>def self.method&lt;/code>ï¼Œæˆ–æ˜¯ç”¨ &lt;code>class &amp;lt;&amp;lt; self&lt;/code>&lt;/li>
&lt;li>&lt;code>æ²’æœ‰ interface / method overloading / polymorphism&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Person&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">attr_accessor&lt;/span> &lt;span class="ss">:name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">age&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">age&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;Hello, my name is &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="vi">@name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nc">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nf">show_specy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;we are Mammals&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">=begin ç­‰åŒæ–¼ä¸Šè€…ï¼Œæ­¤æ–¹æ³•é©å’Œæ–¼å¤§é‡å®šç¾©
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> class &amp;lt;&amp;lt; self
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> def show_specy
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> puts &amp;#34;we are Mammals&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> end
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> end
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">=end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">protected&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">my_protected_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;my protected method&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">private&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">my_little_secret&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;private methods&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">show_specy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">p1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;yoyo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">p1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">p1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;hello&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># puts p1.age å°æ‡‰ç¬¬5é»ï¼Œä¸èƒ½ç›´æ¥å‘¼å« .age å–å¾— age è®Šæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Teacher&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">Person&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">age&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">major&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">super&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">age&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@major&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">major&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">can_access_parent_private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">my_protected_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_little_secret&lt;/span> &lt;span class="c1"># é€™æ¨£å¯ä»¥è®€å– parent private method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#self.my_little_secret &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">t1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Teacher&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Mark&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;English&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">t1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">t1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">can_access_parent_private_method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">t1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span> &lt;span class="ss">:my_little_secret&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">t1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span> &lt;span class="ss">:my_protected_method&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Ruby ç‰©ä»¶æ¯”æƒ³åƒä¸­è¤‡é›œï¼Œå°¤å…¶æ˜¯æ”¯æ´ Meta programmingï¼Œé€²éšè³‡æ–™å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://spreered.medium.com/ruby-%E7%9A%84%E7%B9%BC%E6%89%BF%E9%8D%8A-1-%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91%E5%A6%82%E4%BD%95%E5%AF%A6%E8%B8%90-10324ec7546d" target="_blank" rel="noopener"
>Ruby çš„ç¹¼æ‰¿éŠ (1) ç‰©ä»¶å°å‘å¦‚ä½•å¯¦è¸&lt;/a>&lt;/p>
&lt;h3 id="åŒ¿åå‡½å¼-block--proc--lambda">åŒ¿åå‡½å¼ block / Proc / lambda&lt;/h3>
&lt;ol>
&lt;li>block ä»£è¡¨ç¨‹å¼ç¢¼å€å¡Šï¼Œå°‘æ•¸ Ruby ä¸­&lt;code>ä¸æ˜¯ç‰©ä»¶&lt;/code>çš„å­˜åœ¨ï¼Œå¿…é ˆä¾é™„åœ¨ function ä¸Šï¼Œé€é yeild å‘¼å« block åŸ·è¡Œï¼Œå–®è¡Œå®£å‘Šç”¨ &lt;code>{...}&lt;/code>ï¼Œå¤šè¡Œç”¨ &lt;code>do ... end&lt;/code>&lt;/li>
&lt;li>Proc æ˜¯ç‰©ä»¶ï¼Œä¸é™åˆ¶åƒæ•¸ï¼Œreturn æ™‚æ˜¯ä»£è¡¨ç•¶æ™‚çš„ context returnï¼Œé€é proc.call åŸ·è¡Œ&lt;/li>
&lt;li>lambda æ˜¯ç‰¹æ®Šçš„ Procï¼Œæœƒåš´æ ¼æª¢æŸ¥åƒæ•¸ï¼Œreturn å°±å¦‚åŒä¸€èˆ¬çš„ function return&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="mi">1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upto&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="n">ele&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="nb">puts&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¯ä»¥åˆ¤æ–·æ˜¯ä¸æ˜¯æœ‰ block è¢«å‚³å…¥ï¼Œå¦‚æœæœ‰å‰‡ç”¨ yeild å‘¼å«åŸ·è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">block_given?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;world&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">hello&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;message from hello: &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Proc / lambda å¯ä»¥å„²å­˜æ–¼è®Šæ•¸å‚™ç”¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">my_proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;from proc &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">my_lambda&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">lambda&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;from lambda &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">block&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;before call&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">block&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;func&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;after call&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_lambda&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># before call/n from lambda func/n after call&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># proc å®£å‘Šæ–¼æœ€ä¸Šå±¤ contextï¼Œæ‰€ä»¥ return æ™‚æœƒé€£å¸¶çµæŸæ•´å€‹ç¨‹å¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_proc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># before call/n from proc func&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="æœ‰è¶£çš„èªæ³•-symbol">æœ‰è¶£çš„èªæ³• &lt;code>&amp;amp;:symbol&lt;/code>&lt;/h4>
&lt;p>ç¶²è·¯ä¸Šæœ‰äº›èªªæ³•æ˜¯ &lt;code>{|x| x[:symbol]}&lt;/code> çš„ç¸®å¯«ï¼Œè®“æˆ‘å€‘çœ‹ä¸‹å»&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Person&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">attr_reader&lt;/span> &lt;span class="ss">:name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2222&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">name_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="c1"># å…©è€…ç›¸åŒ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">name_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="ss">:name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">p&lt;/span> &lt;span class="n">name_list&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>åƒæ•¸ç”¨ &amp;amp; é–‹é ­ä»£è¡¨åƒæ•¸æ˜¯ä»¥ Proc å‚³å…¥ï¼Œä»–è·Ÿä¸€èˆ¬çš„åƒæ•¸ argsæ˜¯åˆ‡é–‹çš„&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">some_method&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">block&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;args: &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">inspect&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;block: &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">block&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">inspect&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">some_method&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:whatever&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># args: [1,2,3, :whatever]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># block: nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">some_method&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="ss">:whatever&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># args: [1,2,3]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># block: #&amp;lt;Proc:0x007fd23d010da8&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>åœ¨ Ruby å‘¼å« object method å¯ä»¥ç”¨ send çš„æ–¹å¼&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Person&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">attr_reader&lt;/span> &lt;span class="ss">:name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">p&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>&amp;amp;:symbol å¯¦éš›ä¸Šæœƒå»å‘¼å« :symbol#to_proc ï¼Œè€Œåœ¨ Symbol ä¸­æœ‰å®šç¾© to_proc è¡Œç‚ºï¼Œä¹Ÿæœƒæœ‰äººå»è‡ªå®šç¾© class ä¸­çš„ to_proc æ–¹æ³•&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Symbol&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">to_proc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">receiver&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">receiver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span> &lt;span class="nb">self&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¶œåˆä¸Šè¿°ï¼Œå¯ä»¥æ‹†è§£æˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2222&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="ss">:name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¯ä»¥æ‹†è§£æˆä¸‹è€…&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">puts&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯ receiver æœƒæ”¶åˆ° symbol çš„æ–¹æ³•å‘¼å«ï¼Œåƒè€ƒè‡ª &lt;a class="link" href="https://stackoverflow.com/questions/1217088/what-does-mapname-mean-in-ruby" target="_blank" rel="noopener"
>What does map(&amp;amp;:name) mean in Ruby?&lt;/a>&lt;/p>
&lt;p>å…¶ä»–å„ªç§€çš„è³‡è¨Š&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://5xruby.tw/post/discover-ruby-block" target="_blank" rel="noopener"
>Ruby æ¢ç´¢ï¼šBlocks æ·±å…¥æ·ºå‡º&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://medium.com/@jinghua.shih/ruby-%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-ruby-block-2387b74f188b" target="_blank" rel="noopener"
>[Ruby] å¦‚ä½•ç†è§£ Ruby Block&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="concurrency--parallelism">Concurrency &amp;amp; Parallelism&lt;/h3>
&lt;ol>
&lt;li>Ruby æ”¯æ´ Process ï¼Œå¯ç”¨æ–¼è™•ç† CPU-Heavy issue&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Ruby åœ¨ 2.0 å°å…¥ Cope on Writeï¼Œç•¶ process fork æ™‚å¦‚æœ value æ²’æœ‰æ”¹å‹•å‰‡ä½¿ç”¨åŒä¸€ä»½è¨˜æ†¶é«”ç©ºé–“ï¼Œé™ä½ fork å°æ–¼è¨˜æ†¶é«”è³‡æºç„¡è¬‚çš„ä½”ç”¨&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>Ruby æ”¯æ´ Threadï¼Œé©ç”¨æ–¼è™•ç† IO Eventï¼Œä½†å¦‚æœæ˜¯ CPU-Heavy issue å‰‡æ²’æœ‰å¹«åŠ©ï¼Œå› ç‚º Ruby æœ‰ GIL (Global Interpreter Lokc) æ‰€ä»¥&lt;code>ç„¡æ³•ä½µç™¼ï¼Œä¸€æ¬¡åªèƒ½åŸ·è¡Œä¸€å€‹ thread&lt;/code>ï¼Œé€™è·Ÿ Ruby VM å¯¦ä½œæœ‰é—œï¼Œå¦‚æœæ˜¯ &lt;code>JRuby å‰‡æ²’æœ‰æ­¤å•é¡Œ&lt;/code>&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Thread releases GIL when it hits blocking I/O operations such as HTTP requests, DB queries, writing / reading from disk and even sleep&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s1">&amp;#39;benchmark&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">ELE_AMOUNT&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">PROCESS_NUM&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Array&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">ELE_AMOUNT&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nb">Array&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">ELE_AMOUNT&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="nb">rand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">)}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="no">Benchmark&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">bm&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">report&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;seq&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reduce&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sum&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">report&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;parallel&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">write&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">IO&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pipe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upto&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">PROCESS_NUM&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Process&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fork&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">p&lt;/span> &lt;span class="n">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">step&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="no">ELE_AMOUNT&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="no">PROCESS_NUM&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ceil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start_ele&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">step&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">start_ele&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">step&lt;/span>&lt;span class="o">].&lt;/span>&lt;span class="n">reduce&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sum&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">write&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">puts&lt;/span> &lt;span class="n">total&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Process&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wait&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">report&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;thread&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">threads&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upto&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">PROCESS_NUM&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">step&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="no">ELE_AMOUNT&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="no">PROCESS_NUM&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ceil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start_ele&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">step&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">arr&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">start_ele&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">step&lt;/span>&lt;span class="o">].&lt;/span>&lt;span class="n">reduce&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sum&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">ele&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">threads&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">t&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">threads&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">each&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="ss">:join&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>Fiber æ˜¯é¡ä¼¼æ–¼ goroutine çš„æ¦‚å¿µï¼Œæ›´è¼•é‡çš„ user space threadï¼Œä¸»è¦ç”¨ä¾†éåŒæ­¥çš„æ’ç¨‹ï¼Œé©ç”¨æ–¼çµåˆ Non-blocking IOï¼Œå› ç‚º Fiber åœ¨ Context Switch æ¯” Thread æ›´ç‚ºè¼•é‡&lt;br>
ç¯„ä¾‹ä¾†æºï¼š&lt;a class="link" href="https://engineering.universe.com/introduction-to-concurrency-models-with-ruby-part-i-550d0dbb970" target="_blank" rel="noopener"
>Introduction to Concurrency Models with Ruby. Part I&lt;/a>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="no">EventMachine&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">run&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Fiber&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">page&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">http_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://www.google.com/&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">page&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">response_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">about&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">http_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;https://google.ca/search?q=universe.com&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ... &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;Google is down&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">resume&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">http_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">current_fiber&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Fiber&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">current&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">EM&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">HttpRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">callback&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">current_fiber&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">resume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">errback&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">current_fiber&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">resume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Fiber&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">yield&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>Ruby 3.0 å°å…¥äº†åŸºæ–¼ Actor æ¨¡å¼çš„ &lt;code>Ractor&lt;/code> ï¼ŒçœŸæ­£èƒ½åšåˆ°åˆ©ç”¨ Thread é”æˆ Parallelismï¼Œä»¥å‰æœƒéœ€è¦ GIL æ˜¯ç‚ºäº†é¿å… multi thread ä¹‹ä¸‹çš„ deadlock / race condition ç‹€æ³ï¼Œä½†æ˜¯åœ¨ Ractor ä¸­åŸºæœ¬ä¸Š Object éƒ½ä¸æœƒè¢«å…±äº«ï¼Œåƒè€ƒ &lt;a class="link" href="https://blog.golang.org/codelab-share" target="_blank" rel="noopener"
>Share Memory By Communicating&lt;/a>
æœ‰äº›æ–‡ç« æœƒå¯« Guildï¼Œä½†æˆ‘æŸ¥ Ruby å®˜æ–¹æ–‡ä»¶åªæœ‰çœ‹åˆ° Ractor&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>&lt;code>Do not communicate by sharing memory; instead, share memory by communicating.&lt;/code>&lt;br>
æ„å³å¦‚æœå¸Œæœ›åœ¨å¤šå€‹ Thread ä¸­å…±äº«è³‡è¨Šï¼Œä¸è¦é€éå…±äº«è¨˜æ†¶é«”ä¾†æºé€šï¼Œè€Œæ˜¯é€éé€šä¿¡äº¤æ›è³‡æ–™é”åˆ°å…±äº«è³‡æ–™çš„ç›®çš„ &lt;br>
å› ç‚ºå…±äº«è¨˜æ†¶é«”å°±å¿…é ˆè™•ç† lockï¼Œæ¥è‘—å°±è¦æ“”å¿ƒ dead lock ç­‰å•é¡Œ&lt;br>
å¦‚æœä¸å…±äº«è¨˜æ†¶é«”ï¼Œç›´æ¥å°‡è³‡æ–™é€éé€šé“ç­‰æ–¹å¼å‚³éï¼Œå°±ä¸ç”¨æ“”å¿ƒä»¥ä¸Šçš„å•é¡Œï¼Œä¹Ÿå¯ä»¥æ›´å¥½çš„ä¸¦è¡Œé‹ç®—&lt;/p>
&lt;/blockquote>
&lt;p>å„ªè‰¯çš„è³‡æºåƒè€ƒ&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://www.toptal.com/ruby/ruby-concurrency-and-parallelism-a-practical-primer" target="_blank" rel="noopener"
>Ruby Concurrency and Parallelism: A Practical Tutorial&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://engineering.universe.com/introduction-to-concurrency-models-with-ruby-part-i-550d0dbb970" target="_blank" rel="noopener"
>Introduction to Concurrency Models with Ruby. Part I / II&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=Dtn9Uudw4Mo" target="_blank" rel="noopener"
>RubyConf Taiwan 2019 - The Journey to One Million by Samuel Williams&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="module">Module&lt;/h2>
&lt;ol>
&lt;li>Module æä¾›é¡ä¼¼æ–¼ Namespace è§’è‰²ï¼Œå¯ä»¥è‡ªå®šç¾©æ–¹æ³•èˆ‡å¸¸æ•¸ä¸ç”¨æ“”å¿ƒèˆ‡å…¶ä»–äººè¡çª&lt;/li>
&lt;li>Module ä¸èƒ½è¢«å¯¦é«”åŒ– (ä¹Ÿå°±æ˜¯ä¸èƒ½è¢« new)ï¼Œä¸»è¦é€é mixin æ“´å…… Class
åœ¨å…±äº«å¯¦ä½œæ–¹é¢ï¼ŒRuby ä¸€å€‹ Class åªèƒ½ç¹¼æ‰¿ä¸€å€‹ Parentï¼Œä½†æ˜¯ Module å¯ä»¥ mixin å¤šå€‹ï¼Œåœ¨æ²’æœ‰ç›´æ¥é—œä¿‚çš„æƒ…æ³ä¸‹æƒ³è¦è·¨å¤šå€‹ Class å…±äº«æŸäº›ç‰¹å®šçš„æ–¹æ³•ï¼ŒModule æ˜¯ä¸éŒ¯çš„é¸æ“‡&lt;/li>
&lt;li>ä½¿ç”¨ Mixin è¦å°å¿ƒå¤šå€‹ Module å¯èƒ½æœƒæœ‰ä¸é æœŸçš„äº’ç›¸å¹²æ“¾ï¼Œä¾‹å¦‚ä¿®æ”¹åŒä¸€å€‹ instance è®Šæ•¸ï¼Œæœ‰ç‹€æ…‹è¦ç´€éŒ„è¨˜å¾—å–ä¸€å€‹æ¯”è¼ƒç‰¹æ®Šçš„åç¨±&lt;/li>
&lt;li>å¦‚æœ Module ä¸­æœ‰ Class å®£å‘Šï¼Œè¦æŒ‡å®šè©² Class å¯ä»¥ç”¨é›™å†’è™Ÿ &lt;code>::&lt;/code> é€£æ¥ä¾‹å¦‚ &lt;code>Module Name::Class Name&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##### calculator.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="nn">Greeting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">sayhi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">puts&lt;/span> &lt;span class="s2">&amp;#34;hello, &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="vi">@name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">Hi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">###### main.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">require_relative&lt;/span> &lt;span class="s1">&amp;#39;./calculator&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Person&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">Greeting&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Hi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># é€é include é”åˆ° mixin æ•ˆæœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kp">include&lt;/span> &lt;span class="no">Greeting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Person&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;yoyo&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sayhi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Module é™¤äº†å¯ä»¥è¢« include å¤–ï¼Œé‚„æœ‰ extend è·Ÿ prependï¼Œè«‹åƒè€ƒ &lt;a class="link" href="https://spreered.medium.com/ruby-%E7%9A%84%E7%B9%BC%E6%89%BF%E9%8D%8A-2-module-%E7%9A%84-include-prepend-%E5%92%8C-extend-ae4e1c940097" target="_blank" rel="noopener"
>Ruby çš„ç¹¼æ‰¿éŠ (2) â€” Module çš„ includeã€prepend å’Œ extend&lt;/a>&lt;/p>
&lt;h3 id="ç¨‹å¼ç¢¼æ‹†åˆ†æª”æ¡ˆ">ç¨‹å¼ç¢¼æ‹†åˆ†æª”æ¡ˆ&lt;/h3>
&lt;p>æŠŠå…¨éƒ¨ç¨‹å¼ç¢¼å¡åœ¨åŒä¸€å€‹æª”æ¡ˆååˆ†çš„å¯æ€•ï¼Œé€éé©æ™‚çš„æ‹†åˆ†å¯ä»¥è®“ç¨‹å¼ç¢¼æ›´å¥½ç¶­è­·ï¼Œåœ¨ Ruby ä¸­å¦‚æœè¦ include å…¶ä»–æª”æ¡ˆçš„å®£å‘Šï¼Œå¯ä»¥ç”¨ &lt;code>require_relative 'æª”æ¡ˆæœ¬èº«çš„ç›¸å°è·¯å¾‘'&lt;/code>çš„æ–¹å¼&lt;br>
ç›®å‰çœ‹èµ·ä¾†åªæœ‰å¸¸æ•¸ã€Moduleã€Class æœƒè¢«è‡ªå‹• exportï¼Œé‚„å†æ‰¾åˆ°ç›¸é—œçš„æ–‡ä»¶èªªæ˜&lt;/p>
&lt;p>require ç¸½å…±æœ‰å¹¾ç¨®&lt;/p>
&lt;ol>
&lt;li>&lt;code>require&lt;/code>ï¼š&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>å¦‚æœæ˜¯ç›¸å°è·¯å¾‘ï¼Œå‰‡æ ¹æ“š &lt;code>$LOCAL_PAHT&lt;/code> è¨­å®šå»æ‰¾å°æ‡‰çš„ libraryï¼Œé€šå¸¸æ˜¯ç”¨ä¾†æ‰¾å¤–éƒ¨ç›¸ä¾æˆ–æ˜¯ gem&lt;/li>
&lt;li>å¦‚æœæ˜¯çµ•å°è·¯å¾‘ï¼Œå‰‡ç›´æ¥è¼‰å…¥å°æ‡‰æª”æ¡ˆ&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>&lt;code>require_local&lt;/code>:&lt;br>
é€éæª”æ¡ˆçš„ç›¸å°è·¯å¾‘æ‰¾åˆ°æª”æ¡ˆï¼Œä¸»è¦æ˜¯ç”¨æ–¼åœ¨è‡ªå·±å°ˆæ¡ˆä¸­çš„å…¶ä»–æª”æ¡ˆ&lt;/li>
&lt;/ol>
&lt;h2 id="testing">Testing&lt;/h2>
&lt;p>Ruby ä¸¦æ²’æœ‰å…§å»ºçš„ Test Frameworkï¼Œè©•ä¼°å¾Œé¸ç”¨ RSpecï¼Œæä¾› TDD/BDD Style èªæ³•ï¼Œé€é describe / it çµ„åˆæ¸¬è©¦æ¡ˆä¾‹&lt;/p>
&lt;ol>
&lt;li>æ…£ä¾‹æ˜¯å°ˆæ¡ˆæ ¹ç›®éŒ„å»ºç«‹ spec ç›®éŒ„ï¼Œå¾…æ¸¬é …ç›®å°æ‡‰æª”æ¡ˆååŠ ä¸Š _spec çµå°¾&lt;/li>
&lt;/ol>
&lt;h3 id="unit-test">Unit Test&lt;/h3>
&lt;ol>
&lt;li>æ”¯æ´ before / after / around(before + each)ï¼ŒåŸ·è¡Œé »ç‡åˆ†æˆ each / all / suite&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>suite æ˜¯åœ¨æ•´å€‹ test file åªæœƒè·‘ä¸€æ¬¡ï¼Œall å‰‡æ˜¯æ¯å€‹ describe éƒ½æœƒåŸ·è¡Œä¸€æ¬¡&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>å¦‚æœæ˜¯æœ‰è®Šæ•¸è¦åœ¨æ¯ä¸€æ¬¡ test case å‰åŸ·è¡Œï¼Œå¯ä»¥ç”¨ before(:each)ï¼Œæˆ–æ˜¯ç”¨ &lt;code>let(è®Šæ•¸åç¨±){å›å‚³å€¼}&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„é‹è²»è¨ˆç®—&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;rspec&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">require_relative&lt;/span> &lt;span class="s1">&amp;#39;../calculator&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">describe&lt;/span> &lt;span class="no">Calculator&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:calculator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="no">Calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s1">&amp;#39;small package should get $100 fee&amp;#39;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fee&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s1">&amp;#39;medium size should get $500 fee&amp;#39;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fee&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">before&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@calculator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">around&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">p&lt;/span> &lt;span class="s2">&amp;#34;before each test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">p&lt;/span> &lt;span class="s2">&amp;#34;after each test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s1">&amp;#39;large size should get $700 fee&amp;#39;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="vi">@calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fee&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">750&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="stub--mock--spy">Stub / Mock / Spy&lt;/h3>
&lt;p>RSpec æä¾› mock æ–¹æ³•å«åš double (å‡ºè‡ªæ–¼ stunt double æ¼”å“¡æ›¿èº«)&lt;/p>
&lt;ol>
&lt;li>double å¯ä»¥æ†‘ç©ºç”¢ç”Ÿç‰©ä»¶ï¼Œå¯ä»¥è‡ªå®šç¾© function èˆ‡å›å‚³å€¼&lt;/li>
&lt;li>double å¯ä»¥åªè¦†å¯«ç‰¹å®šæ–¹æ³•çš„å›å‚³å€¼ &lt;code>allow(instance).to receive(method).and_return(value)&lt;/code>&lt;/li>
&lt;li>spy ä¸æ”¹æ–¹æ³•çš„å¯¦ä½œï¼Œåªç¢ºèªæœ‰æ²’æœ‰è¢«å‘¼å«ï¼Œä»¥åŠç¢ºèªå‚³å…¥çš„åƒæ•¸ä»¥åŠå‘¼å«é †åºæ˜¯å¦å¦‚é æœŸ&lt;/li>
&lt;li>æ¯ä¸€å€‹ test case å¾Œéƒ½æœƒè¢«è‡ªå‹• restore&lt;/li>
&lt;li>å› ç‚ºæ˜¯å‹•æ…‹èªè¨€ï¼Œæ‰€ä»¥è¦ &amp;ldquo;double(string)&amp;rdquo; ç­‰æ–¹æ³•éƒ½æ˜¯å¯ä»¥çš„&lt;/li>
&lt;/ol>
&lt;p>é‹è²»è¨ˆç®—åŠ ä¸Šä¸€å€‹ VIP æª¢æŸ¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">VIP_Service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">is_vip?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="s2">&amp;#34;do some query&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">describe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:calculator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vip_service&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">VIP_Service&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># é€™è£¡é€é mock å‹•æ…‹æ”¹è®Š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">allow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vip_service&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">receive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:is_vip?&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">and_return&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kp">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vip_service&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>spy çš„æ¡ˆä¾‹è«‹çœ‹å®˜æ–¹æ–‡ä»¶ç¯„ä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s1">&amp;#39;rspec&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Invitation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">deliver&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">email&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">p&lt;/span> &lt;span class="n">email&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">describe&lt;/span> &lt;span class="s2">&amp;#34;Invitation&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:invitation&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">spy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;invitation&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">before&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">invitation&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">deliver&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;foo@example.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">invitation&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">deliver&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;bar@example.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s2">&amp;#34;passes when a count constraint is satisfied&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># é€é have_recieved çœ‹æ–¹æ³•æœ‰æ²’æœ‰è¢«å‘¼å«&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">invitation&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">have_received&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:deliver&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">twice&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">it&lt;/span> &lt;span class="s2">&amp;#34;passes when an order constraint is satisifed&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># åŠ ä¸Š with æª¢æŸ¥æ–¹æ³•å‘¼å«æ™‚å‚³å…¥çš„åƒæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># åŠ ä¸Š ordered ä»£è¡¨è¦æŒ‰ç…§æ­¤é †åºå‘¼å«&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">invitation&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">have_received&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:deliver&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;foo@example.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ordered&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">invitation&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">have_received&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:deliver&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;bar@example.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ordered&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="http-request--api-server">HTTP Request &amp;amp; API Server&lt;/h2>
&lt;p>Ruby ä¸¦æ²’æœ‰æä¾› http server çš„å°è£ï¼Œåªæœ‰ tcp serverï¼Œæ‰€ä»¥æˆ‘å€‘é¸ç”¨ &lt;a class="link" href="https://github.com/rack/rack" target="_blank" rel="noopener"
>Rack&lt;/a> é€™ä¸€å¥— libraryï¼Œä»–è¢« Ruby ç”Ÿæ…‹åœˆå»£æ³›æ¡ç”¨çš„åº•å±¤æ¡†æ¶ï¼Œå¦‚ RoR ä¹Ÿæ˜¯&lt;/p>
&lt;blockquote>
&lt;p>Rack provides a minimal, modular, and adaptable interface for developing web applications in Ruby.&lt;/p>
&lt;/blockquote>
&lt;h3 id="api-server">API Server&lt;/h3>
&lt;p>æ–°å¢ server.ruï¼Œé€é &lt;code>$rackup server.ru&lt;/code> å•Ÿå‹•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s1">&amp;#39;rack&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s1">&amp;#39;json&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rack_proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">lambda&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">req&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Rack&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request_method&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path_info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">when&lt;/span> &lt;span class="s2">&amp;#34;GET:/hello&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;content-type&amp;#34;&lt;/span>&lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;application/json&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;hello&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_json&lt;/span> &lt;span class="o">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">when&lt;/span> &lt;span class="s2">&amp;#34;POST:/world&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">body&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">JSON&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;content-type&amp;#34;&lt;/span>&lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;application/json&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;hello&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="n">body&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_json&lt;/span> &lt;span class="o">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="mi">406&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;content-type&amp;#34;&lt;/span>&lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;html/txt&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;not_implemented_yet&amp;#39;&lt;/span>&lt;span class="o">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">run&lt;/span> &lt;span class="n">rack_proc&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="http-request">HTTP Request&lt;/h3>
&lt;p>åƒè€ƒ &lt;a class="link" href="https://www.twilio.com/blog/5-ways-make-http-requests-ruby" target="_blank" rel="noopener"
>5 ways to make HTTP requests in Ruby&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">require&lt;/span> &lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">HTTP&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://localhost:9292/hello&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:params&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="ss">:name&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;world&amp;#34;&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">p&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">HTTP&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://localhost:9292/world&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:body&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="ss">:name&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;jojo&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_json&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">p&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>å¯«éæœ€é•·çš„æ–‡ç« ï¼Œæ•´ç†äº†é€™ä¸€å€‹ç¦®æ‹œä¸Šæ‰‹ Ruby çš„éç¨‹ï¼ŒRuby å¯¦éš›ä¸Šé‚„æœ‰éå¸¸å¤šçš„ &lt;code>é»‘é­”æ³•&lt;/code>ï¼Œè·Ÿæ–°åŒäº‹å€‘ä¸€èµ·ä¸Šæ‰‹çš„éç¨‹ä¸æ–·ç™¼ç¾é©šå–œ(æ?!)&lt;br>
å¿…é ˆå¦ç™½èªªä¸Šæ‰‹åˆ°ç¾åœ¨æ²’æœ‰å¾ˆæ„› Rubyï¼Œå› ç‚ºå¤ªè‡ªç”±äº†ï¼Œåˆæœ‰å¤ªå¤šé—œéµå­—è·Ÿå¯«æ³•ï¼Œå¯èƒ½è¦åœ¨ä¸€æ®µæ™‚é–“ç†Ÿæ‚‰ï¼Œä¹‹å¾Œå†ä¾†æ…¢æ…¢è£œå……&lt;/p></description></item><item><title>Golang Test - å–®å…ƒæ¸¬è©¦ã€Mockèˆ‡http handler æ¸¬è©¦</title><link>https://yuanchieh.page/posts/2021/2021-03-18-golang-test/</link><pubDate>Thu, 18 Mar 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-03-18-golang-test/</guid><description>&lt;p>ä¸Šé 91 è€å¸«çš„ TDD å¾Œï¼Œé–‹å§‹æ³¨é‡ç¨‹å¼èªè¨€æ”¯æ´çš„æ¸¬è©¦æ¡†æ¶ï¼Œ&lt;code>ç·¨å¯«æ¸¬è©¦ä»£ç¢¼èˆ‡å¯«å‡ºå®¹æ˜“å¯«æ¸¬è©¦çš„ä»£ç¢¼&lt;/code>æ˜¯å¾ˆé‡è¦çš„ä¸€ä»¶äº‹ï¼Œå¥½æ¸¬è©¦çš„ä»£ç¢¼é€šå¸¸å¥½ç¶­è­·ï¼Œå› ç‚ºé€šå¸¸ä»£è¡¨æœ‰æ›´ä½çš„è€¦åˆæ€§ã€ç‰©ä»¶ä¾è³´é—œä¿‚æ˜ç¢ºç­‰ï¼Œèªªæ˜¯ã€Œé€šå¸¸ã€ä¹Ÿä»£è¡¨ä¸æ˜¯é€™éº¼çµ•å°ï¼›ä½†åä¹‹ &lt;code>ä¸å®¹æ˜“å¯«æ¸¬è©¦çš„ä»£ç¢¼&lt;/code>å¾€å¾€éƒ½æ˜¯æœ‰å¥‡æ€ª smell çš„&lt;/p>
&lt;p>é—œæ–¼æ¸¬è©¦æ¡ˆä¾‹çš„ç¨®é¡è«‹åƒè€ƒ 91 è€å¸«çš„ &lt;a class="link" href="https://dotblogs.com.tw/hatelove/2012/11/29/learning-tdd-in-30-days-day7-unit-testing-stub-mock-and-fake-object-introduction" target="_blank" rel="noopener"
>Unit Test - Stub, Mock, Fake ç°¡ä»‹&lt;/a>&lt;/p>
&lt;p>ä»¥ä¸‹å°‡åˆ†äº«å¦‚ä½•åœ¨ Golang ä¸­ç·¨å¯«&lt;/p>
&lt;ul>
&lt;li>å–®å…ƒæ¸¬è©¦&lt;/li>
&lt;li>å¦‚ä½• Stub/Mock å¤–éƒ¨ç›¸ä¾&lt;/li>
&lt;li>å¦‚ä½•é‡å° http handler åš http request å‡è«‹æ±‚æª¢æŸ¥&lt;/li>
&lt;/ul>
&lt;p>è‡ªå·±é–‹å§‹çœŸæ­£å¯« Golang ä¹Ÿæ˜¯é€™å¹¾å€‹ç¦®æ‹œï¼Œæœ‰ä¸€äº›å‘½åã€å¯«æ³•ä¸æ­£ç¢ºï¼Œç…©è«‹æŒ‡æ•™ï¼Œä½†é‡å°æ¸¬è©¦çš„æœ¬èº«æ‡‰è©²æ˜¯æ²’ä»€éº¼å•é¡Œçš„&lt;br>
ç›®å‰æ¡ç”¨ &lt;code>Ginkgo&lt;/code> + &lt;code>gomock&lt;/code> + &lt;code>httptest&lt;/code> çµ„åˆçš„æ¸¬è©¦å·¥å…·&lt;/p>
&lt;p>ä»¥ä¸‹æˆ‘å€‘å°‡å¯«ä¸€å€‹ç°¡å–®çš„åŒ¯ç‡å…Œæ›è¡¨ï¼Œç”¨æˆ¶è¼¸å…¥æ—¢æœ‰çš„å¹£åˆ¥ / æ¬²å…Œæ›çš„å¹£åˆ¥ / æ•¸é‡ï¼ŒServer å›å‚³å…Œæ›å¾Œçš„æ•¸é‡ï¼Œç¨‹å¼ç¢¼æ–¼æ­¤ &lt;a class="link" href="https://github.com/sj82516/golang-exchange-currency" target="_blank" rel="noopener"
>golang-exchange-currency&lt;/a>&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç¨‹å¼ç¢¼çµæ§‹&lt;/p>
&lt;ul>
&lt;li>main.go: å•Ÿå‹• http server&lt;/li>
&lt;li>src/exchange_currency_model.go: æ¨¡æ“¬å»è³‡æ–™åº«è®€å–åŒ¯ç‡å…Œæ›è¡¨&lt;/li>
&lt;li>src/currency_exchange_handler.go: http handlerï¼Œè™•ç† request èˆ‡ response&lt;/li>
&lt;/ul>
&lt;h2 id="å–®å…ƒæ¸¬è©¦">å–®å…ƒæ¸¬è©¦&lt;/h2>
&lt;p>é¦–å…ˆè¦æ±ºå®šæ¸¬è©¦æ¡†æ¶ï¼Œé€™éƒ¨åˆ†è©•ä¼°é &lt;code>åŸç”Ÿçš„testing&lt;/code>ã€&lt;code>Testify&lt;/code>ï¼Œæœ€å¾Œé¸æ“‡äº† &lt;a class="link" href="https://onsi.github.io/ginkgo/#getting-ginkgo" target="_blank" rel="noopener"
>&lt;code>Ginkgo&lt;/code>&lt;/a>ï¼Œæœ€å¤§åŸå› æ˜¯ç†Ÿæ‚‰åŸæœ¬ Nodejsçš„ &lt;code>Decribe / It&lt;/code> çµ„ç¹” test case çš„æ–¹å¼ï¼Œä»¥åŠæœ‰æ–¹ä¾¿çš„ BeforeEach å¯ä»¥æŠ½å‡ºé‡è¤‡æ¸¬è©¦è¡Œç‚ºçš„éƒ¨åˆ†ï¼Œä¾‹å¦‚åœ¨æ¯å€‹æ¸¬è©¦æ¡ˆä¾‹ä¹‹å‰éƒ½å…ˆ new å¥½ object&lt;br>
é€™äº›åœ¨ testing / Testify éƒ½è¦é¡å¤–çš„åŠŸå¤«è™•ç†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="s">&amp;#34;github.com/onsi/ginkgo&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span> &lt;span class="s">&amp;#34;github.com/onsi/gomega&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">Describe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;currency exchange&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">CurrencyExchangeHandler&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">BeforeEach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">NewCurrencyExchangeHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">It&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;should get 0 if amount is 0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="nx">Done&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;US&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;TW&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)).&lt;/span>&lt;span class="nf">To&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="stubmock">Stub/Mock&lt;/h2>
&lt;p>&lt;code>Stub&lt;/code> å°ˆæ³¨æ–¼æ¸¬è©¦ç‰©ä»¶æœ¬èº«ï¼Œåªæ˜¯æŠŠå¤–éƒ¨ç›¸ä¾çš„æ–¹æ³•å¡ä¸€å€‹è¨­å®šå€¼å›å‚³ï¼›&lt;br>
&lt;code>Mock&lt;/code> å‰‡å»¶ä¼¸ Stubï¼Œé™¤äº†å¡å›å‚³å€¼å¤–ï¼Œè€Œå¤–æª¢æŸ¥è¢«å‘¼å«ç‰©ä»¶çš„å‚³å…¥å€¼ / å‘¼å«æ¬¡æ•¸ / ç‹€æ…‹æ”¹è®Šç­‰éæ¸¬è©¦ç‰©ä»¶æœ¬èº«çš„ç‹€æ…‹&lt;/p>
&lt;p>åœ¨ Golang ä¸­ï¼Œä½¿ç”¨ &lt;a class="link" href="https://github.com/golang/mock" target="_blank" rel="noopener"
>&lt;code>gomock&lt;/code>&lt;/a> çœŸçš„æ˜¯è¶…ç´šæ–¹ä¾¿ï¼Œå¯ä»¥ç›´æ¥é‡å°æª”æ¡ˆç”¢å‡ºå°æ‡‰çš„ mock æª” exchange_price_model_mock.goï¼Œé€™é‚Šè¦æ³¨æ„ mock æ˜¯é‡å° interface ç”¢ç”Ÿï¼Œæ‰€ä»¥å¦‚æœä½ çš„æª”æ¡ˆä¸­æ²’æœ‰ interfaceï¼Œmock æª”å‡ºä¾†å°±æœƒæ˜¯ç©ºçš„&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘åœ¨ exchange_price_model.go ä¸­æœ‰å®šç¾©&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">IExchangePriceModel&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetExchangeRate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ExchangeRateResult&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—åŸ·è¡Œ &lt;code>mockgen -source={è¦ mock çš„æª”æ¡ˆ} -destination={è¼¸å‡ºä½ç½®} -package={package åç¨±}&lt;/code>ï¼Œä¾‹å¦‚ &lt;code>$ mockgen -source=exchange_price_model.go -destination=exchange_price_model_mock.go -package=src&lt;/code>ï¼Œmockgen æ˜¯ gomock ç”¨ä¾†ç”¢ç”Ÿ mock æª”æ¡ˆçš„ binary åŸ·è¡Œå·¥å…·&lt;/p>
&lt;p>ä¹‹å¾Œæ¸¬è©¦æ¡ˆä¾‹æ¡ç”¨ &lt;code>NewMockIExchangePriceModel&lt;/code> é€™å€‹ç”± mockgen ç”¢ç”Ÿçš„ struct å³å¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">Describe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;currency exchange&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">CurrencyExchangeHandler&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mockCtrl&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gomock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MockIExchangePriceModel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">BeforeEach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mockCtrl&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">gomock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewController&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">GinkgoT&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">NewMockIExchangePriceModel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mockCtrl&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">NewCurrencyExchangeHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">It&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;should get 0 if amount is 0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="nx">Done&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EXPECT&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetExchangeRate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;US&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;TW&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gomock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Any&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">from&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">to&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ExchangeRateResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ch&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ExchangeRateResult&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">IsExists&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ExchangeRate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">40&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;US&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;TW&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)).&lt;/span>&lt;span class="nf">To&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç·¨å¯« mock çš„æ–¹å¼å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EXPECT&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Method&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;é æœŸ method è¦æ”¶åˆ°çš„åƒæ•¸&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;å¯¦éš›åŸ·è¡Œæ™‚æ”¶åˆ°çš„åƒæ•¸&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">åšä»»ä½•é€ å‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç­‰æ–¼æ˜¯å¯«ä¸€æ¬¡é€£&lt;code>é æœŸè¼¸å…¥&lt;/code>ã€&lt;code>é€ å‡è¼¸å‡º&lt;/code>éƒ½ä¸€ä¸¦åšå®Œï¼Œå¦‚æœè¦æ–¹ä¾¿å¯ä»¥ &lt;code>.Return()&lt;/code> ç›´æ¥å¯«å›å‚³å…§å®¹ï¼Œä½†å› ç‚ºæ¶‰åŠ channel è¦å‚³éè³‡æ–™ï¼Œæ‰€ä»¥æˆ‘é¸æ“‡ .Do() ä¸¦å¡å…¥é€ å‡çš„è³‡æ–™å›å‚³ channel&lt;/p>
&lt;p>å¦‚æœä¸åœ¨æ„é æœŸè¼¸å…¥ï¼Œå¯ä»¥éƒ½ç”¨ &lt;code>gomock.Any()&lt;/code> è·³éæª¢æŸ¥&lt;/p>
&lt;h3 id="å¦‚ä½•é€ å‡-timenow-ç­‰ç³»çµ±ç›¸ä¾çš„å‡½å¼">å¦‚ä½•é€ å‡ Time.Now ç­‰ç³»çµ±ç›¸ä¾çš„å‡½å¼&lt;/h3>
&lt;p>æœå°‹äº†ä¸€ä¸‹é€™é¡å•é¡Œï¼Œå»ºè­°æ˜¯æŠŠæœ‰å¤–éƒ¨ç›¸ä¾éƒ½æŠ½åˆ°å¦ä¸€å€‹ Object å»ï¼Œç„¶å¾Œé€éä¾è³´æ³¨å…¥çš„æ–¹å¼å‚³é€²å»ï¼Œæ‰èƒ½å¤ é€ å‡&lt;/p>
&lt;p>ä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ObjectA&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ObjectA&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">MethodA&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MethodB&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ObjectA&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">MethodB&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£æ˜¯ç„¡æ³•æ¸¬è©¦çš„ï¼Œè¦æ‹†è§£æˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">interface&lt;/span> &lt;span class="nx">IObjectB&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MethodB&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ObjectA&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ObjB&lt;/span> &lt;span class="nx">IObjectB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ObjectA&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">MethodA&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MethodB&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä½¿ç”¨ Interface æ›¿æ›éç¨‹ï¼Œè¦æ³¨æ„ *Type è·Ÿ Type çš„å·®ç•°ï¼Œå¦‚æœç™¼ç¾ä»¥ä¸‹éŒ¯èª¤è¨Šæ¯è«‹åƒè€ƒ &lt;a class="link" href="https://stackoverflow.com/questions/40823315/x-does-not-implement-y-method-has-a-pointer-receiver" target="_blank" rel="noopener"
>X does not implement Y (â€¦ method has a pointer receiver)&lt;/a>&lt;br>
å¾å•ç­”ä¸­å›å»æ–‡ä»¶çœ‹ï¼Œå¯ä»¥æ³¨æ„åˆ°ä»¥ä¸‹å…§å®¹
&lt;a class="link" href="https://golang.org/ref/spec#Method_sets" target="_blank" rel="noopener"
>Method sets Â¶&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">The method &lt;span class="nb">set&lt;/span> of any other &lt;span class="nb">type&lt;/span> T consists of all methods declared with receiver &lt;span class="nb">type&lt;/span> T. The method &lt;span class="nb">set&lt;/span> of the corresponding pointer &lt;span class="nb">type&lt;/span> *T is the &lt;span class="nb">set&lt;/span> of all methods declared with receiver *T or T &lt;span class="o">(&lt;/span>that is, it also contains the method &lt;span class="nb">set&lt;/span> of T&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™ä¸€æ®µä¹Ÿå°±æ˜¯èªª&lt;/p>
&lt;ul>
&lt;li>å¦‚æœ method å®£å‘Šçš„ reciever æ˜¯ non pointer type &lt;code>func (t T) method&lt;/code>ï¼Œå‰‡ T / *T éƒ½æœ‰åŒ…å«æ­¤ method&lt;/li>
&lt;li>ä½†å¦‚æœ method å®£å‘Šçš„ reciever æ˜¯ pointer typeï¼Œå‰‡åªæœ‰ *T åŒ…å«æ­¤ method&lt;/li>
&lt;/ul>
&lt;p>å»¶ä¼¸è‡³ embedded struct&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">- If S contains an embedded field T, the method sets of S and *S both include promoted methods with receiver T. The method &lt;span class="nb">set&lt;/span> of *S also includes promoted methods with receiver *T.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- If S contains an embedded field *T, the method sets of S and *S both include promoted methods with receiver T or *T.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ˜¯&lt;/p>
&lt;ul>
&lt;li>S æ˜¯ non pointerï¼Œä¸” T ä¹Ÿæ˜¯ non pointerï¼Œå‰‡åŒ…å«äº† T non pointer type methods&lt;/li>
&lt;li>S æ˜¯ non pointer + T æ˜¯ pointer / åªè¦ S æ˜¯ pointer typeï¼Œå‰‡åŒ…å«äº† T non pointer / pointer type methods&lt;/li>
&lt;/ul>
&lt;p>è©³è¦‹ç¨‹å¼ç¢¼ï¼Œæˆ‘æŠŠ struct æœ‰çš„ method éƒ½åˆ—å‡ºä¾†ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°ä»¥ä¸Šçš„è¦å‰‡ &lt;a class="link" href="https://play.golang.org/p/jkYrqF4KyIf" target="_blank" rel="noopener"
>Go playground&lt;/a>&lt;/p>
&lt;p>å¦å¤–æŠ½å‡ºä¾è³´å†æ³¨å…¥ï¼Œå¦‚æœå¿˜è¨˜åˆå§‹åŒ–æœƒæœ‰è¨˜æ†¶é«”å­˜å–å¤±æ•—çš„éŒ¯èª¤ &lt;code>http: panic serving runtime error: invalid memory address or nil pointer dereference&lt;/code>ï¼Œçœ‹åˆ°éŒ¯èª¤è¨˜å¾—å»æª¢æŸ¥&lt;/p>
&lt;h2 id="é‡å°-http-handler-åšæª¢æŸ¥">é‡å° HTTP Handler åšæª¢æŸ¥&lt;/h2>
&lt;p>é€éå–®å…ƒæ¸¬è©¦èˆ‡ Stub/Mockï¼Œå¯ä»¥æª¢æŸ¥å®Œå•†æ¥­é‚è¼¯çš„éƒ¨ä»½ï¼Œä½†å¦‚æœæƒ³æ›´ç¢ºå®š server æ˜¯å¦æœ‰æ­£ç¢ºè™•ç† http requestï¼ŒåŒ…å«æ˜¯å¦å›å‚³é æœŸçš„éŒ¯èª¤çµæœï¼Œå¯ä»¥å†é€²ä¸€æ­¥é‡å° http handler åšæ¸¬è©¦&lt;/p>
&lt;p>é€™é‚Šæ¡ç”¨ core library åŒ…å« &lt;code>net/http/httptest&lt;/code> æ¸¬è©¦ï¼Œå®Œæ•´æ•™å­¸å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://blog.questionable.services/article/testing-http-handlers-go/" target="_blank" rel="noopener"
>Testing Your (HTTP) Handlers in Go&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">It&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test ServeHttp integration&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="nx">Done&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EXPECT&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetExchangeRate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gomock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Any&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">gomock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Any&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">gomock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Any&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">from&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">to&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ExchangeRateResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ch&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ExchangeRateResult&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">IsExists&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ExchangeRate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ch&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/exchange-currency&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">query&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Query&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;US&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;to&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;TW&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;amount&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;10&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RawQuery&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Encode&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewRecorder&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ExchangePriceModel&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">CurrencyExchangeHandler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">E&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">handler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandlerFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServeHTTP&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">handler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">To&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">body&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Amount&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bytes&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">body&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Amount&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">To&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">300&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸ŠåŸºæœ¬å°±æ˜¯é€ å‡ / åˆå§‹åŒ– handler / åˆå§‹åŒ– http request / é€é &lt;code>handler.ServeHTTP(rr, req)&lt;/code> æ¨¡æ“¬ http handler è™•ç†éç¨‹ / æª¢æŸ¥ response&lt;/p>
&lt;p>åŸºæœ¬ä¸Š Context / Cookie ç­‰éƒ½å¯ä»¥è™•ç†ï¼Œè™•ç†èµ·ä¾†ç›¸ç•¶æ–¹ä¾¿&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>å¾å‹•æ…‹èªè¨€éä¾†ï¼Œæœ€ä¸ç¿’æ…£çš„å°±æ˜¯è¦ä¸€ç›´å»æƒ³ç‰©ä»¶ä¹‹é–“çš„ç›¸ä¾ï¼ŒåŒ…å«è¦è™•ç† mock æ™‚è¦æ‹†å‡º interface èˆ‡å¤–éƒ¨ç‰©ä»¶ï¼Œè€Œä¸èƒ½é‡å°æŸä¸€å€‹ object çš„æŸä¸€å€‹ method é€ å‡&lt;/p>
&lt;p>ä½†æ•´é«”ä¸Šï¼ŒGolang çš„æ¸¬è©¦ç®—æ–¹ä¾¿ä¸”å¥½ä¸Šæ‰‹ï¼Œ~æ‰¾ä¸åˆ°å·æ‡¶ä¸å¯«æ¸¬è©¦çš„ç†ç”±äº†~&lt;/p></description></item><item><title>ã€Šå‰µæ„ç«¶æ“‡ã€‹å¿ƒå¾—åˆ†äº«</title><link>https://yuanchieh.page/posts/2021/2021-03-07-%E5%89%B5%E6%84%8F%E7%AB%B6%E6%93%87%E5%BF%83%E5%BE%97%E5%88%86%E4%BA%AB/</link><pubDate>Sun, 07 Mar 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-03-07-%E5%89%B5%E6%84%8F%E7%AB%B6%E6%93%87%E5%BF%83%E5%BE%97%E5%88%86%E4%BA%AB/</guid><description>&lt;blockquote>
&lt;p>æˆ‘è¦ºå¾—é€™æ˜¯ä¸€æœ¬å¯«çµ¦ç†±æ„›ç”¢å“è€ŒéæŠ€è¡“æœ¬ä½çš„å·¥ç¨‹å¸«&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20210316/%e5%89%b5%e6%84%8f%e7%ab%b6%e6%93%87_cover.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å·¥ä½œäº†ä¸€æ®µæ™‚é–“ï¼Œæ­·ç¶“å…¬å¸ç®¡ç†åˆ¶åº¦èˆ‡æ–‡åŒ–çš„è½‰è®Šï¼Œé–‹å§‹åœ¨æ€è€ƒæ€éº¼æ¨£çš„ç’°å¢ƒè·Ÿåœ˜éšŠæ‰æ˜¯é©åˆè‡ªå·±ï¼Œé‚£å®Œç¾çš„åœ˜éšŠåˆæ‡‰è©²æ˜¯æ€æ¨£çš„å‹æ…‹ï¼Ÿ
æœŸé–“çœ‹éäº† Netflix é«”ç³»çš„ã€Šçµ¦åŠ›ã€‹/ã€Šä¸€åƒé›¶ä¸€å€‹é»å­ä¹‹å¾Œã€‹/ã€Šé›¶è¦å‰‡ã€‹ï¼Œå¼·èª¿äººæ‰å¯†åº¦ / é–‹æ”¾ / ä¸‹æ”¾æ¬ŠåŠ›ç­‰æ–¹å¼ï¼Œä½†é€™äº›éƒ½æ¯”è¼ƒæ˜¯ä»¥äººè³‡ / ç®¡ç†å±¤è§’åº¦å‡ºç™¼ &lt;br>
è€Œã€ŠClean Coderã€‹æ˜¯ç”±å°ˆæ¥­å·¥ç¨‹å¸«æ‰€æ’°å¯«ï¼Œå¦‚ä½•ç•¶ä¸€ä½å ‚å ‚æ­£æ­£çš„ç¨‹å¼è¨­è¨ˆå¸«ï¼Œè£¡é¢ç³¾æ­£äº†è‡ªå·±å¾ˆå¤šå£ç¿’æ…£ï¼Œä½†æ¯”è¼ƒåƒæ•™æ¢/å®ˆå‰‡ä¸€èˆ¬ï¼Œå°‘äº†é»è¶£å‘³èˆ‡åœ˜éšŠçš„æè¿°&lt;/p>
&lt;p>è€Œé€™æœ¬ã€Šå‰µæ„ç«¶æ“‡ã€‹ï¼Œç”±æ›¾ç¶“æ˜¯ Apple é¦–å¸­è»Ÿé«”å·¥ç¨‹å¸«ï¼Œåƒèˆ‡é Safari / iPhone ç¬¬ä¸€ä»£éµç›¤è¨­è¨ˆ / iPad éµç›¤è¨­è¨ˆï¼Œæè¿°æ¯ä¸€å€‹å°ˆæ¡ˆç¶“æ­·çš„éç¨‹èˆ‡æŒ«æŠ˜ï¼Œä¸¦æ”¶æ–‚å‡ºä½œè€…èªç‚º&lt;code>ç‚ºä»€éº¼ Apple å¯ä»¥è¨­è¨ˆå‡ºé ‚å°–ç”¢å“çš„å¿ƒæ³•&lt;/code>ï¼Œä¸¦æç¹ªå‡ºå°ˆæ¥­çš„ç”¢å“åœ˜éšŠåœ¨æ±ºç­–/åŸ·è¡Œçš„éç¨‹ï¼Œæ¯ä¸€æ­¥çš„åæ€éƒ½ç™¼äººæ·±çœï¼Œä»¥ä¸‹æ˜¯æ•´ç†éå¾Œçš„è‡ªæˆ‘åæ€&lt;/p>
&lt;h2 id="æ¼”ç¤ºdemo---è’é›†åé¥‹---ä¸‹ä¸€æ¬¡æ¼”ç¤º">æ¼”ç¤º(Demo) -&amp;gt; è’é›†åé¥‹ -&amp;gt; ä¸‹ä¸€æ¬¡æ¼”ç¤º&lt;/h2>
&lt;p>2005 å¹´ Apple å•Ÿå‹•äº† Purple è¨ˆç•«ï¼Œä¹Ÿå°±æ˜¯ iPhone çš„è¨­è¨ˆï¼Œåœ¨ 2005 å¹´ 9æœˆï¼Œæ•´å€‹å·¥ç¨‹åœ˜éšŠä¸¦å¬é›†è¦è§£æ±ºæœ€æ£˜æ‰‹çš„å•é¡Œ éµç›¤ï¼Œä¸åŒæ–¼é»‘è“æ©Ÿçš„å¯¦é«”éµç›¤ï¼ŒiPhone æ‰“ç®—ç”¨å¤šé»è§¸æ§é »å¹•ç•¶åšè»Ÿé«”éµç›¤ï¼Œä½†æ˜¯å› ç‚ºç¬¬ä¸€ä»£ iPhone è¢å¹•å¤ªå°ï¼Œæ‰€ä»¥éµç›¤è¨­è¨ˆå°±è‡³é—œé‡è¦ï¼Œé€™æ˜¯ iPhone è¨ˆç•«é‡åˆ°çš„ä¸€å¤§é›£é¡Œ&lt;/p>
&lt;p>ä¸»ç®¡åœ¨æ¸¬è©¦ç¬¬ä¸€ä»£éµç›¤æ™‚ï¼Œç™¼ç¾é€£è‡ªå·±çš„å§“åéƒ½æ‰“ä¸å‡ºä¾†ï¼Œæ–¼æ˜¯å¬é›†æ‰€æœ‰äººï¼Œè¦å¤§å®¶åœä¸‹æ‰‹é‚Šä»»å‹™ï¼Œå…¨åŠ›æ”»å…‹éµç›¤å•é¡Œï¼Œå¤§å®¶å°±å„è‡ªç™¼æƒ³ï¼Œæå‡ºè‡ªå·±çš„è§£æ±ºæ–¹æ¡ˆ&lt;/p>
&lt;p>ä½œè€…æƒ³åˆ°ï¼Œå¦‚æœæŠŠå¤šå€‹è‹±æ–‡å­—æ¯ä½µå…¥ä¸€å€‹è¼¸å…¥æ ¼ï¼Œé€éå­—å…¸è‡ªå‹•æ ¡æ­£çŒœå‡ºç”¨æˆ¶è¦è¼¸å…¥çš„å–®å­—ï¼Œå°±å¯ä»¥è§£æ±ºé¢ç©å° + æå‡é€Ÿåº¦çš„å•é¡Œï¼Œå¾Œä¾†åœ¨å±•ç¤ºéç¨‹ä¸­ä¹ŸæˆåŠŸæ“Šæ•—å…¶ä»–ææ¡ˆï¼Œä»–ä¹Ÿå°±æˆç‚º iPhone ä¸»è¦è² è²¬éµç›¤çš„ç¨‹å¼è¨­è¨ˆå¸«&lt;/p>
&lt;p>ä½†æ˜¯é€™æ¨£çš„éµç›¤å•é¡Œå¾ˆå¤šï¼Œä¾‹å¦‚åªé€éå­—å…¸æ ¡æ­£ï¼Œé‚£å¦‚æœç”¨æˆ¶è¼¸å…¥ã€ŒArrrr!ã€å°±æ‰“ä¸å‡ºä¾†äº†ï¼Œæ‰€ä»¥å°±ä¸æ–·çš„èª¿æ•´ -&amp;gt; æ¼”ç¤º -&amp;gt; å›é¥‹ï¼Œæ¯å€‹æˆå“¡æ‰‹ä¸Šéƒ½å¸¶è‘—åŸå‹æ©Ÿï¼Œå½¢å½±ä¸é›¢ä¸æ–·çš„æ¸¬è©¦ä¸¦çµ¦äºˆåé¥‹&lt;/p>
&lt;p>é€™è½èµ·ä¾†æ˜¯ common senseï¼Œä½†æ˜¯æ¼”ç¤ºçš„ç´°ç¯€æ‰æ˜¯é—œéµ&lt;/p>
&lt;h3 id="çµ¦äºˆç›´æ¥çš„å›é¥‹">çµ¦äºˆç›´æ¥çš„å›é¥‹&lt;/h3>
&lt;p>æ¼”ç¤ºçš„æ™‚å€™æ˜¯ä¸æ˜¯èƒ½æŠ“åˆ°é‡é»ï¼ŒæŠŠåŠ›æ°£èŠ±åœ¨æ­£ç¢ºçš„ä½ç½®ä¸Šï¼Œæ›´é‡è¦çš„æ˜¯&lt;code>ã€Œæœ‰æ²’æœ‰äººå¯ä»¥çµ¦å‡ºæœæ–·çš„åé¥‹ã€&lt;/code>&lt;/p>
&lt;p>ä½œè€…æåˆ°è³ˆä¼¯æ–¯å¯ä»¥çš„è©±æœƒç›¡å¯èƒ½åƒèˆ‡æ¼”ç¤ºï¼Œä¸¦çµ¦äºˆéå¸¸ç›´æ¥çš„å›é¥‹ï¼Œä¾‹å¦‚èªªç¬¬ä¸€ä»£ iPad éµç›¤å…¶å¯¦æœ‰å…©å€‹éµç›¤æ¨¡å¼å¯ä»¥åˆ‡æ›ï¼Œä½†è³ˆä¼¯æ–¯ç©ä¸€ç©å°±å•ä½œè€…ã€Œä½ è¦ºå¾—æ˜¯ä¸æ˜¯åªè¦ä¸€å€‹å°±å¥½ï¼Ÿä½ å–œæ­¡å“ªä¸€å€‹ï¼Ÿã€&lt;br>
ä¹‹å¾Œå°±æ‹æ¿æ±ºå®šï¼Œåªç•™ä¸€å€‹ç°¡åŒ–æ¨¡å¼çš„éµç›¤&lt;/p>
&lt;p>å·¥ä½œä¹…äº†è¦ºå¾—æœ‰ä¸€å€‹æœæ–·çš„æ±ºç­–è‡³é—œé‡è¦ï¼Œå¾ˆå¤šæ™‚å€™å¤§å®¶åœ¨æœƒè­°ä¸Šéƒ½ä¸æ•¢çµ¦äºˆç›´æ¥çš„åé¥‹æˆ–æ±ºå®šï¼Œå¯ä»¥è½å‡ºå¤§å®¶å°æ–¼èƒŒè² è²¬ä»»çš„ææ‡¼èˆ‡æ’æ–¥ï¼Œæˆ–æ˜¯çŒœä¸é€æŒæ¬Šè€…çš„å¿ƒæ€ï¼Œé€™ä¾†å›ä¹‹é–“ç•™ä¸‹å¾ˆå¤šæœ¦æœ§çš„ç©ºé–“ï¼Œååˆ†çš„å¯æƒœ&lt;/p>
&lt;h3 id="æ¼”ç¤ºå¾ˆé‡è¦">æ¼”ç¤ºå¾ˆé‡è¦&lt;/h3>
&lt;p>å¦ä¸€é»æ˜¯å·¥ç¨‹å¸«å°æ–¼æ¼”ç¤ºçš„å¿ƒæ…‹èˆ‡æŠ€å·§ï¼Œå¹´å‰å‰›å¥½èˆ‡ CEO One on Oneï¼Œä»–æåŠå·¥ç¨‹å¸«æ™®éä¸é‡è¦–æ¼”ç¤ºï¼Œä¸æ‡‚å¾—å¦‚ä½•ç”¨æ­£ç¢ºçš„æ–¹å¼è®“å¤§å®¶ (åŒ…å« CEO æœ¬äºº)äº†è§£æŠ€è¡“çš„é‡è¦æ€§ï¼Œä¾‹å¦‚æ•å¸æœ‰æŒçºŒåœ¨ç ”ç©¶ä½å…‰æºéŒ„å½±çš„å„ªåŒ–æ¼”ç®—æ³•ï¼Œä½†æ˜¯ Demo æ™‚é¸æ“‡åœ¨æ˜äº®çš„æœƒè­°å®¤ï¼ŒCEO è¡¨ç¤ºä»–å¾ˆç´æ‚¶ç‚ºä»€éº¼ä¸æ‰¾ä¸€å€‹åˆé©çš„å ´æ™¯æ›´å‡¸é¡¯æŠ€è¡“ä¸Šçš„çªç ´å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="ç«™åœ¨ç§‘æŠ€èˆ‡äººæ–‡çš„äº¤ç•Œé»">ç«™åœ¨ç§‘æŠ€èˆ‡äººæ–‡çš„äº¤ç•Œé»&lt;/h2>
&lt;p>åœ¨æ›¸ä¸­æœ‰æåŠå“å‘³ï¼Œä¾‹å¦‚éµç›¤å°±æ‡‰è©²è¦è®“ç”¨æˆ¶é †æš¢çš„æ‰“å‡ºä»–æ‰€æƒ³è¦çš„å­—ï¼Œæ‰€ä»¥ä½œè€…ä¸æ–·çš„å„ªåŒ–è‡ªå‹•æ ¡æ­£åŠŸèƒ½ï¼ŒåŒæ™‚ä¿ç•™ç”¨æˆ¶è¼¸å…¥å†·åƒ»å­—çš„å¯èƒ½&lt;/p>
&lt;p>å“å‘³è½èµ·ä¾†è™›ç„¡ç¸¹ç·²ï¼Œä½œè€…çš„å®šç¾©æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>åŸ¹é¤Šéˆå·§çš„åˆ¤æ–·åŠ›ï¼Œæ‰¾åˆ°ä»¤äººæ„‰æ‚…åˆå®Œå–„çš„å¹³è¡¡é»&lt;/p>
&lt;/blockquote>
&lt;p>é€™ä»°è³´åœ˜éšŠä¸­è¨­è¨ˆå¸«èˆ‡å·¥ç¨‹å¸«ä¸æ–·çš„æºé€šï¼Œä»¥åŠç®¡ç†è€…å¾ˆæ˜ç¢ºçš„è¡¨é”ç›®æ¨™ï¼Œä¾‹å¦‚é–‹ç™¼ Safari çš„æ™‚ç©ºèƒŒæ™¯æ˜¯è¦å–ä»£åŸæœ¬ Mac OS å…§å»ºçš„ IEï¼Œé‚£æ™‚å€™è³ˆä¼¯æ–¯çµ¦äºˆéå¸¸æ˜ç¢ºçš„æŒ‡ç¤º&lt;code>ã€Œé€Ÿåº¦ã€&lt;/code>ï¼Œè¦ç”¨æˆ¶æ”¾æ£„ IE è·³æ§½åˆ° Safari é€Ÿåº¦å°±æ˜¯æœ€é‡è¦çš„ç”¨æˆ¶é«”é©—æŒ‡æ¨™&lt;/p>
&lt;p>å¦å¤–ä½œè€…å°æ–¼ A/B Test æå‡ºè³ªç–‘ï¼Œæœ€æœ‰åçš„å°±æ˜¯ Google æ¸¬è©¦ 41 ç¨®è—è‰²ï¼Œå¾ç”¨æˆ¶çµ¦äºˆçš„æ•¸æ“šå›é¥‹ä½œç‚ºä¾ç¡…æ˜¯ã€Œæœ€é¡§å®¢å°å‘çš„åšæ³•ã€ï¼Œä½†æ˜¯ä½œè€…è¡¨ç¤ºé€™ä¸æœƒæ˜¯ Apple åšäº‹çš„æ…‹åº¦ï¼Œæˆ–è¨±ä»–å€‘æœƒæ¡ç”¨æ•¸æŠ€åˆ†æï¼Œä½†ä»–å€‘æœ‰å°ˆæ¥­çš„è¨­è¨ˆå¸«åœ¨ç‚ºæ‰€æœ‰çš„è¨­è¨ˆæŠŠé—œï¼ŒåŒ…å«åƒè¨­è¨ˆå¸«æå‡ºè§¸æ§è¢å¹•æ‡‰è©²è¦æœ‰é•·æŒ‰æ‹–å‹•çš„è¨­è¨ˆï¼Œå°±åƒæ˜¯åœ¨æ‰‹æŒ‰è‘—ç´™åœ¨æ¡Œé¢æ‹–å‹•çš„æ„Ÿè¦ºï¼Œé€™æ¨£æ‰æœ‰æ›´æ²ˆæµ¸çš„é«”é©—ï¼›&lt;br>
æ»‘å‹•æ²è»¸æ™‚æŒçºŒæ»‘å‹•æœƒåŠ é€Ÿï¼Œè§¸åº•æœƒæœ‰å°å°çš„åå½ˆå›é¥‹ï¼Œéƒ½æ˜¯ Apple è¨­è¨ˆå¸«æ‰€è¨­è¨ˆçš„&lt;/p>
&lt;p>æ•å¸è¿‘å¹´ä¹Ÿåœ¨å°å…¥æ•¸æ“šé©…å‹•è¨­è¨ˆï¼Œä½†è‡ªå·±ä¹Ÿåœ¨åæ€éœ€æ±‚è¨­è¨ˆæ˜¯ä¸æ˜¯çœŸçš„å®Œç¾ï¼Ÿå¾ç”¨æˆ¶çš„æ•¸æ“šä¸æ–·å»æ‰“ç£¨å°±èƒ½å¾—åˆ°æœ€æ£’çš„ç”¢å“ï¼Ÿ&lt;br>
æˆ–è¨±é‚„æ˜¯è¦å›æ­¸éœ€æ±‚è¨­è¨ˆçš„æœ¬èº«ï¼Œé€™æ¨£çš„ææ¡ˆæ˜¯ä¸æ˜¯æœ‰ã€Œå“å‘³ã€ï¼Œæ‰æœ‰å¾ŒçºŒçš„ AB Test çš„åƒ¹å€¼&lt;/p>
&lt;p>çœ‹åˆ°é€™ä¸€æ®µä¹Ÿé —æœ‰æ„Ÿè§¸ï¼Œåœ¨éµç›¤å°ˆæ¡ˆä¸­æœ‰å°ˆè·çš„è¨­è¨ˆå¸«ï¼Œè€Œä½œè€…èº«ç‚ºè»Ÿé«”å·¥ç¨‹å¸«å»ä¸å–®å–®æŠŠè‡ªå·±æ“ºåœ¨å¯¦ä½œè€…çš„è§’è‰²ï¼Œè€Œæ˜¯&lt;code>æŠŠè‡ªå·±ç•¶ä½œç”¨æˆ¶ä¸æ–·å»å„ªåŒ–éµç›¤è¨­è¨ˆ&lt;/code>ï¼Œåœ¨æ›¸ä¸­æè¿°äº†äº”å…­ä»£éµç›¤çš„å„ªåŒ–éç¨‹ï¼Œåƒæ˜¯å¾åŸæœ¬çš„å¤šå­—ä¸€éµæ”¹æˆä¸€å­—ä¸€éµï¼Œç„¶å¾Œå†æ”¹æˆ QWERTY éµç›¤ï¼Œè‡ªå‹•æ ¡æ­£ä¹Ÿå¾å–®ç´”çš„å­—å…¸æ¯”å°è®Šæˆè¼¸å…¥çš„ä½ç§»å‘é‡å·®ï¼Œå¯ä»¥çœ‹å‡ºä½œè€…æƒ³è¦æŠŠæœ€æ£’çš„ç”¨æˆ¶é«”é©—å¸¶çµ¦æ‰€æœ‰çš„äººï¼ŒåŒ…å«ä»–è‡ªå·±&lt;/p>
&lt;h2 id="æœ€å›°é›£çš„å•é¡Œ">æœ€å›°é›£çš„å•é¡Œ&lt;/h2>
&lt;p>å› ç‚º Safari å°ˆæ¡ˆçš„æˆåŠŸï¼Œä½œè€…çš„ä¸»ç®¡å¸Œæœ›ä½œè€…æŠŠç€è¦½å™¨åŒ…æˆå¥—ä»¶ Webkit åµŒå…¥ Email ç•¶ä¸­åšæ–‡å­—ç·¨è¼¯å™¨ï¼Œä½œè€…èŠ±äº†å¾ˆå¤šæ™‚é–“åœ¨è§£æ±ºæ»‘é¼ æ¸¸æ¨™ä½ç½®çš„å•é¡Œï¼Œå› ç‚ºé€™æ¶‰åŠåˆ°æ–‡å­—æ’ç‰ˆ / æ›è¡Œè·³å­—ç­‰é‚è¼¯ï¼Œé æ¯”æƒ³åƒä¸­è¤‡é›œå¾—å¤š &lt;br>
ä½œè€…åœ¨æ›¸ä¸­æœ‰æè¿°ä»–é‡åˆ°çš„é›£é¡Œï¼Œä»¥åŠä»–æ›¾ç¶“å˜—è©¦éçš„è§£æ³•ï¼ŒèŠ±äº†å¥½å¹¾é€±çš„æ™‚é–“éƒ½ç„¡æ³•çªç ´ï¼Œæœ€å¾Œå‘ä¸»ç®¡å°‹æ±‚å¹«åŠ©ï¼Œå¾å…¶ä»–éƒ¨é–€æ‰¾ä¾†æœ‰ç¶“é©—çš„å·¥ç¨‹å¸«ï¼Œæœ€å¾Œå°±ä¸€èµ·è§£æ±ºäº†å•é¡Œ&lt;/p>
&lt;p>ä½œè€…çµ±æ•´äº†å¹¾å€‹é»&lt;/p>
&lt;ol>
&lt;li>å•å•é¡Œä¹‹å‰å¿…é ˆè‡ªå·±å…ˆåŠªåŠ›é&lt;/li>
&lt;li>èº«ç‚ºç¨‹å¼è¨­è¨ˆå¸«å¿…é ˆæ‹‹é–‹è‡ªå·±çš„å°Šåš´ï¼Œæœ‰å•é¡Œå°±è¦æœ‰èª æ„åœ°å»å°‹æ±‚å”åŠ©&lt;/li>
&lt;/ol>
&lt;p>è½èµ·ä¾†å¾ˆä¸€èˆ¬ï¼Œä½†ä»”ç´°å›æƒ³å·¥ä½œçš„ç¶“æ­·ï¼Œå¯è¬‚æ–‡äººç›¸è¼•ï¼Œå¾ˆå¤šæ™‚å€™å…¶å¯¦åŒäº‹ä¹‹é–“å¾ˆå°‘æœ‰åˆ‡ç£‹ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯å¤§å®¶åœ¨è—æ‹›é‚„æ˜¯å®³ç¾ï¼Œè¦ºå¾—å¯¦åœ¨å¾ˆå¯æƒœï¼Œå°¤å…¶æ˜¯äº‹å¾Œå›æƒ³å½¼æ­¤éƒ½è¸©éä¸€æ¨£çš„å‘ï¼Œå¦‚æœæ—©é»åˆ†äº«æˆ–æ˜¯äº’ç›¸è«‹æ•™ï¼Œå°±èƒ½é¿å…é€™ç„¡è¬‚çš„æµªè²»&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>è‡ªå·±åœ¨è·æ¶¯ç™¼å±•çš„éç¨‹ï¼Œä¹Ÿä¸æ–·æ€ç´¢è‡ªå·±çš„å®šä½ï¼Œä¸€æ–¹é¢å¸Œæœ›è‡ªå·±æœ‰è¶³å¤ çš„æŠ€è¡“å¯¦åŠ›ï¼Œèƒ½å¤ æŒ‘å…¬å¸è€Œä¸æ˜¯è®“å…¬å¸æŒ‘æˆ‘ï¼›å¦ä¸€æ–¹é¢ä¹Ÿå¸Œæœ›è‡ªå·±èƒ½å¤ æ‰¾åˆ°ç†±æ„›çš„ç”¢å“ï¼ŒæŠŠè‡ªå·±çš„æŠ€è¡“èƒ½åŠ›è®Šæˆå½±éŸ¿åŠ›&lt;/p>
&lt;p>ä»¥å‰æœƒè¦ºå¾—å…©è€…æœ‰é»è¡çªï¼Œç•¢ç«Ÿç”¢å“é–‹ç™¼æœ‰æ™‚å€™éœ€è¦çš„ä¸è¦‹å¾—æ˜¯æŠ€è¡“èƒ½åŠ›ï¼Œè€Œæ˜¯åè¦†çš„æºé€šä»¥åŠæ›´æ·±å…¥çš„ç†è§£ç”¨æˆ¶éœ€æ±‚ï¼ŒæŠ•å…¥ç”¢å“è¶Šå¤šæœƒä¸æœƒè®“æŠ€è¡“ç™¼å±•ä¸Šçš„æ™‚é–“ç¸®çŸ­ ?!&lt;/p>
&lt;blockquote>
&lt;p>ç¾…èƒ–èªªéè¦åšåˆ° Uç›¤åŒ–ç”Ÿå­˜ã€Œè‡ªå¸¦ä¿¡æ¯ï¼Œä¸è£…ç³»ç»Ÿï¼Œéšæ—¶æ’æ‹”ï¼Œè‡ªç”±åä½œã€‚ã€&lt;/p>
&lt;/blockquote>
&lt;p>ä½†æ…¢æ…¢åœ°é–‹å§‹é«”æœƒåˆ°ï¼Œå…©è€…æœ‰æ™‚å€™æ˜¯ç›¸è¼”ç›¸æˆçš„ï¼Œç†±æƒ…é€™ç¨®æ±è¥¿æ˜¯ç„¡å½¢ä¸”å®¹æ˜“è¢«å¿½è¦–çš„åƒ¹å€¼ï¼Œå¦‚æœä¸Šç­å°æ–¼ç”¢å“æœ‰ç†±æƒ…ï¼Œé€™å¯ä»¥å»¶ç‡’åˆ°å°æ–¼æŠ€è¡“å°ˆç²¾çš„åŸ·è‘—ï¼Œè®“è§£æ±ºå•é¡Œå¯ä»¥å¾æ›´æ ¹æœ¬çš„è§’åº¦è€Œä¸æ˜¯å«Œéº»ç…©çš„è² é¢å¿ƒæ…‹å»é¢å°&lt;/p>
&lt;p>è¬›å¾—æœ‰é»ç± çµ±ï¼Œè‡ªå·±å¯èƒ½ä¹Ÿé‚„æ²’æƒ³å¾—å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å¾é€™æœ¬æ›¸ä¸­çœ‹åˆ°å¦ä¸€æ¢æˆ‘è¦ºå¾—å€¼å¾—æ•ˆæ³•çš„è·æ¶¯&lt;/p></description></item><item><title>å¾ Nodejs åˆ° Golang: Concurrency å¯¦ä½œæ¯”è¼ƒ</title><link>https://yuanchieh.page/posts/2021/2021-03-07-%E5%BE%9E-nodejs-%E5%88%B0-golang-concurrency-%E5%AF%A6%E4%BD%9C%E6%AF%94%E8%BC%83/</link><pubDate>Sun, 07 Mar 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-03-07-%E5%BE%9E-nodejs-%E5%88%B0-golang-concurrency-%E5%AF%A6%E4%BD%9C%E6%AF%94%E8%BC%83/</guid><description>&lt;p>åœ¨ä¸€å…©å¹´å‰ Golang å¾ˆç«ç´…æ™‚æœ‰å­¸äº†ä¸€ä¸‹ï¼Œä½†ç•¶æ™‚æ²’æœ‰æ·±å…¥çš„ç†è§£ Golang ç›¸å°æ–¼å…¶ä»–èªè¨€çš„ç‰¹è‰²èˆ‡é­…åŠ›ï¼Œåªåœç•™åœ¨è¡¨å±¤çš„èªæ³•å­¸ç¿’ï¼Œæ™‚éš”å¤šå¹´å› ç‚ºæ›å·¥ä½œçš„éœ€æ±‚ï¼Œé‡å­¸ Golang ç™¼ç¾æœ‰è »å¤šæœ‰è¶£çš„åœ°æ–¹ï¼Œæ‹¿ä¾†èˆ‡ Nodejs ç›¸æ¯”æœ‰è¨±å¤šé¡ä¼¼ä½†ä¸åŒçš„å¯¦ä½œå·®ç•°ï¼Œå°¤å…¶åœ¨éåŒæ­¥é€™ä¸€å¡Šï¼Œç‰¹æ­¤ç­†è¨˜ä¸¦åˆ†äº«å¦‚ä½•å¾ Nodejs è·³æ§½åˆ° Golang&lt;/p>
&lt;p>æœ¬ç¯‡å°‡è‘—é‡æ–¼ä»‹ç´¹ Golang ä¸Šæ‰‹çš„æ•™å­¸è³‡æºï¼Œä»¥åŠå°æ¯” Nodejs (Javascript)ï¼ŒGolang çš„ç‰¹è‰²åœ¨ä»€éº¼åœ°æ–¹&lt;/p>
&lt;h2 id="golang-èˆ‡-nodejs-ç•°åŒä¹‹è™•---ä»¥éåŒæ­¥ç‚ºä¾‹">Golang èˆ‡ Nodejs ç•°åŒä¹‹è™• - ä»¥éåŒæ­¥ç‚ºä¾‹&lt;/h2>
&lt;p>Golang èˆ‡ Nodejs åœ¨éåŒæ­¥è¨­è¨ˆä¸Šæœ‰äº›é›·åŒä¹‹è™•ï¼Œç›¸è¼ƒæ–¼å‚³çµ±çš„æ¯ä¸€å€‹ IO äº‹ä»¶å°±é–‹ä¸€å€‹ thread è®“ OS å»æ’ç¨‹ï¼Œ&lt;code>Nodejs èˆ‡ Golang éƒ½ç›¡å¯èƒ½æ¸›å°‘ kernel thread çš„ç”¢ç”Ÿï¼Œè€Œæ˜¯é€é Non blocking system call æˆ–æ˜¯ user thread èˆ‡ scheduler æ–¹å¼ï¼Œé™ä½ OS Context Switch å°±èƒ½æ›´æœ‰æ•ˆç‡ä½¿ç”¨ kernel thread&lt;/code>&lt;/p>
&lt;h3 id="nodejs-å…§éƒ¨éåŒæ­¥è™•ç†">Nodejs å…§éƒ¨éåŒæ­¥è™•ç†&lt;/h3>
&lt;p>é€é runtime åº•å±¤ &lt;code>libuv&lt;/code> å‘¼å« non-blocking system callï¼Œå‘ system è¨»å†Šæœ‰èˆˆè¶£çš„äº‹ä»¶ä¸¦åŠ å…¥ event loop ï¼Œevent loop ä¸­åˆç´°åˆ†æˆå¤šå€‹ phase æª¢æŸ¥ä¸åŒçš„ä»»å‹™å¦‚ timer / io / check ç­‰ï¼Œç­‰åˆ° main thread åŸ·è¡Œå®Œå¾Œæª¢æŸ¥ event loop ä¸Š IO äº‹ä»¶æ˜¯å¦å®Œæˆï¼Œå¦‚æœå®Œæˆå‰‡è§¸ç™¼ callback åˆ° main thread åŸ·è¡Œ&lt;/p>
&lt;p>ä½†éœ€è¦æ³¨æ„ Nodejs core library æœ‰äº›æ˜¯æ²’æœ‰ non blocking system callï¼Œä¾‹å¦‚ fs / crypto / dns.lookup æŸ¥è©¢ï¼Œé€™äº›æ˜¯å¾ Worker Pool å¦å¤–é–‹ thread åŸ·è¡Œï¼Œæœƒå—é™æ–¼ç’°å¢ƒè®Šæ•¸ UV_THREADPOOL_SIZE æ§åˆ¶æ•´é«” kernel thread æ•¸é‡ï¼Œæ‰€ä»¥å†æ¬¡æé†’ &lt;code>Nodejs runtime æ˜¯ multi threadï¼Œåªæ˜¯ js è·Ÿ event loop callback éƒ½è·‘åœ¨åŒä¸€å€‹ main thread ä¸Š&lt;/code>ï¼Œå…·é«”å¯ä»¥åƒè€ƒ&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=zphcsoSJMvM" target="_blank" rel="noopener"
>The Node.js Event Loop: Not So Single Threaded&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=P9csgxBgaZ8" target="_blank" rel="noopener"
>Node&amp;rsquo;s Event Loop From the Inside Out by Sam Roberts, IBM&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://docs.libuv.org/en/v1.x/guide/basics.html" target="_blank" rel="noopener"
>Basics of libuv&lt;/a>&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Instead, the application can request the operating system to watch the socket and put an event notification in the queue. The application can inspect the events at its convenience&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœæ˜¯ core library æ²’æœ‰æ”¯æ´çš„ non blocking ä»»å‹™ï¼Œå°±å¿…é ˆè‡ªå·±é€é worker_threads / child_process / cluster ç­‰æ–¹å¼æ‰ä¸æœƒ block main threadï¼Œé€™ä¹Ÿæ˜¯æ–°æ‰‹ææ··çš„å•é¡Œ &lt;code>æ˜¯ä¸æ˜¯ç”¨ Promise åŒ…æˆéåŒæ­¥å°±ä¸æœƒ blocking (X)&lt;/code>&lt;/p>
&lt;h3 id="golang-çš„-goroutine-èˆ‡-scheduler">Golang çš„ goroutine èˆ‡ scheduler&lt;/h3>
&lt;p>å…§å®¹æ‘˜éŒ„è‡ªé€™å¹¾ç¯‡å„ªè‰¯çš„å…§å®¹ï¼š&lt;br>
&lt;a class="link" href="https://www.youtube.com/watch?v=YHRO5WQGh0k" target="_blank" rel="noopener"
>GopherCon 2018: Kavya Joshi - The Scheduler Saga&lt;/a> / &lt;a class="link" href="https://medium.com/a-journey-with-go/go-goroutine-os-thread-and-cpu-management-2f5a5eaf518a" target="_blank" rel="noopener"
>Go: Goroutine, OS Thread and CPU Management&lt;/a> / &lt;a class="link" href="https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html" target="_blank" rel="noopener"
>Scheduling In Go : Part II - Go Scheduler&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>å‰æƒ…æè¦ï¼Œprocessor åªèƒ½åŸ·è¡Œ kernel thread ä»»å‹™ï¼Œæ¯å€‹ kernel thread åœ¨è¨˜æ†¶é«”ä½”ç”¨èˆ‡ context switcth èŠ±è²»éƒ½ä¸å° (8KB / 1 ms)&lt;br>
è€Œ Golang æœ¬èº«å»ºç«‹ user thread (goroutine)ï¼Œé–‹éŠ·ç›¸å°åªè¦ (2KB/10 ns)
é€é Schedule å®‰æ’ user thread -&amp;gt; kernel thread -&amp;gt; processor å¯¦éš›é‹è¡Œç¨‹å¼ï¼Œç›¡å¯èƒ½è®“ kernel thread æŒçºŒä¿æŒ running æ¸›å°‘ context switch&lt;/p>
&lt;/blockquote>
&lt;p>Golang æœ¬èº«æœ‰ Scheduler è² è²¬æ’ç¨‹ï¼Œé€é &lt;code>go func()&lt;/code>å•Ÿå‹• goroutine (user thread)ï¼Œæ­¤ user thread å°‡ç”± Scheduler æ’ç¨‹&lt;br>
&lt;img src="https://www.ardanlabs.com/images/goinggo/94_figure11.png"
loading="lazy"
alt="ä¾†è‡ªåƒè€ƒæ–‡ä»¶"
>&lt;br>
(ä¾†è‡ªåƒè€ƒæ–‡ä»¶)&lt;/p>
&lt;ol>
&lt;li>Scheduler é è¨­ç‚ºå•Ÿå‹•ä¸€å€‹ Processor P1ï¼Œé€™è£¡æœƒå°æ‡‰åˆ°ç¡¬é«”ä¸Šå¯ç¨ç«‹åŸ·è¡Œ thread çš„é‹ç®—å–®å…ƒ&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ä¸ä¸€å®šç­‰æ–¼ CPU core æ•¸é‡ï¼Œå› ç‚ºåƒ intel Hyper-Threading åŠŸèƒ½ï¼Œä¸€å€‹ physical core å¯é‹è¡Œå…©å€‹ thread&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>Processor P1 ä¸Šé‹è¡Œä¸€å€‹ Kernel Thread M1ï¼Œä¸¦å°‡ goroutine G1 æ’ç¨‹åˆ° M1 ä¸­åŸ·è¡Œ&lt;/li>
&lt;li>å¦‚æœæœ‰æ–°çš„ goroutine G2 èª•ç”Ÿï¼Œä¸”ç›®å‰çš„ Processor P1é‚„åœ¨è·‘ï¼Œå‰‡å»ºç«‹æ–°çš„ kernel thread M2èˆ‡ Processor P2ï¼Œä¸¦åŸ·è¡Œ goroutine G2&lt;/li>
&lt;li>å¦‚æœ kernel thread å•Ÿå‹•æ•¸é‡é”åˆ°ä¸Šé™ &lt;code>GOMAXPROCS&lt;/code>ï¼Œå‰‡æœƒæ”¾åˆ° FIFO queue ç•¶ä¸­ï¼Œç°¡ç¨± &lt;code>runq&lt;/code>ï¼Œæ¯å€‹ Processor éƒ½æœ‰å°æ‡‰è‡ªå·±çš„ local runq&lt;/li>
&lt;li>Processor å¦‚æœæŠŠ local run queue éƒ½è™•ç†å®Œï¼Œå¯ä»¥å»å·å…¶ä»– processor çš„ runq (&lt;code>work stealing&lt;/code>)ï¼Œé”åˆ°å·¥ä½œ balance&lt;/li>
&lt;li>é™¤äº† local runqï¼Œé‚„æœ‰ä¸€å€‹ global runq æ”¾è¢«ä¸­æ–·çš„é•·æ™‚é–“ä½”ç”¨ goroutineï¼Œkernel thread æœƒç”¨æ¯”è¼ƒä½çš„é »ç‡å»åŸ·è¡Œï¼Œé‚„æœ‰åƒåƒåœ¾å›æ”¶ç­‰ä»»å‹™&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">schedule&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// only 1/61 of the time, check the global runnable queue for a G.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// if not found, check the local queue.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// if not found,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// try to steal from other Ps.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// if not, check the global runnable queue.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// if not found, poll network.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/blockquote>
&lt;ol start="7">
&lt;li>é‡åˆ° system callï¼Œæœƒæœ‰å…©ç¨®åæ‡‰
&lt;ul>
&lt;li>å¦‚æœæ˜¯ &lt;code>blocking system call&lt;/code>ï¼Œå‰‡è©² kernel thread æœƒæš«åœ (parking) ä¸¦ç§»å‡º processorï¼ŒæŠŠ process è®“çµ¦å…¶ä»–äºº (handoff)ï¼Œæ­¤æ™‚ thread ä¸æœƒä½”ç”¨ç¸½é«”ä¸Šé™&lt;/li>
&lt;li>å¦‚æœæ˜¯ &lt;code>non blocking system call&lt;/code> ä¾‹å¦‚ network ç›¸é—œï¼Œå‰‡ä¸éœ€è¦ç§»å‡º threadï¼Œè€Œæ˜¯æŠŠ goroutine æ”¾åˆ° &lt;code>network poll&lt;/code>ï¼Œprocessor æœƒåœ¨æœ‰ç©ºçš„æ™‚å€™å» network poll æ‰¾å‡ºå®Œæˆ system callä¸” runnable çš„ goroutine&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>é€™æ¨£æ¯å€‹ process éƒ½ç›¡å¯èƒ½ç¶å®šä¸€å€‹ kernel threadï¼Œä¸”æ­¤ kernel thread å°±æŒçºŒåœ¨ running ç‹€æ…‹è€Œæ²’æœ‰åˆ‡æ›ï¼Œé€é Go Scheduler æ›¿æ› user thread æ’ç¨‹å·¥ä½œ&lt;/p>
&lt;p>Scheduler æœ¬èº«æœƒåœ¨ä»¥ä¸‹æƒ…æ³è™•ç†æ’ç¨‹&lt;/p>
&lt;ul>
&lt;li>&lt;code>go&lt;/code> keyword&lt;/li>
&lt;li>åƒåœ¾å›æ”¶ï¼šåƒåœ¾å›æ”¶æœ‰ç¨ç«‹çš„ goroutine&lt;/li>
&lt;li>system call&lt;/li>
&lt;li>sync ç›¸é—œå‘¼å«: atomic / mutex / channel ç›¸é—œæ“ä½œï¼Œæœƒå°è‡´ goroutine å µå¡&lt;/li>
&lt;/ul>
&lt;p>goroutine å¯ä»¥é‡å° function level å•Ÿå‹•ä½µç™¼ï¼Œä¹Ÿæœ‰è±å¯Œçš„åŒæ­¥èªæ³•ï¼Œä¾‹å¦‚ sync.Mutex ä¿è­· critical section / sync.WaitGroup ç­‰å¾… goroutine å®Œæˆ / channel åœ¨ goroutine ç•¶ä¸­å‚³éè³‡æ–™èˆ‡æ§åˆ¶åŸ·è¡Œ&lt;/p>
&lt;h3 id="ç¯„ä¾‹ä¸€é€é-http-request-è®€å–-users-list-ä¸¦å†æ¬¡é€é-http-request-å–å¾—-10-ä½-user-çš„è©³ç´°è³‡æ–™ç®—æœ€å¾Œçš„æ€§åˆ¥åŠ ç¸½">ç¯„ä¾‹ä¸€ï¼šé€é http request è®€å– users list ä¸¦å†æ¬¡é€é http request å–å¾— 10 ä½ user çš„è©³ç´°è³‡æ–™ï¼Œç®—æœ€å¾Œçš„æ€§åˆ¥åŠ ç¸½&lt;/h3>
&lt;p>ç¯„ä¾‹åªæ˜¯è¦ç¨å¾®å“åšä¸€ä¸‹å…©å€‹èªæ³•çš„å·®ç•°ï¼ŒéŒ¯èª¤è™•ç†ç­‰å°±å…ˆä¸è¦å¤ªåœ¨æ„&lt;/p>
&lt;script src="https://gist.github.com/sj82516/6e10f70a62a1d717c78485077ff5a15d.js">&lt;/script>
&lt;p>é€™éƒ¨åˆ†å¯«èµ·ä¾†ç”¨ Nodejs å°±è »æ–¹ä¾¿çš„&lt;/p>
&lt;h3 id="ç¯„ä¾‹äºŒè¨ˆç®—-1000--1000-æ•¸å­—çŸ©é™£åŠ ç¸½ä½µç™¼å››å€‹-thread-åŸ·è¡Œæœ€å¾ŒåŠ ç¸½">ç¯„ä¾‹äºŒï¼šè¨ˆç®— 1000 * 1000 æ•¸å­—çŸ©é™£åŠ ç¸½ï¼Œä½µç™¼å››å€‹ thread åŸ·è¡Œæœ€å¾ŒåŠ ç¸½&lt;/h3>
&lt;script src="https://gist.github.com/sj82516/df8e34f1ba7952817d3da2607c3eda35.js">&lt;/script>
&lt;p>Nodejs åœ¨ child_process æˆ–æ˜¯ worker thread æˆ‘è‡ªå·±éƒ½è¦ºå¾—æœ‰é»ä¸å¤ªæ–¹ä¾¿ï¼Œä¸èƒ½é‡å°æŸä¸€å€‹ function èµ·æ–°çš„ threadï¼Œå‚³éè³‡æ–™ä¸Šä¹Ÿä¸æ˜¯å¤ªæ–¹ä¾¿ï¼Œä¸å¦‚ Golang ç›´æ¥ &lt;code>go func()&lt;/code> æ­é… channel ä¾†çš„ç°¡ä¾¿&lt;/p>
&lt;p>æ¥è‘—å›éé ­ä¾†çœ‹ï¼Œåˆ†äº«å¾ Nodejs è·³æ§½åˆ° Golang çš„å­¸ç¿’æ–¹å¼&lt;/p>
&lt;h2 id="golang-æ•™å­¸è³‡æºæ¨è–¦">Golang æ•™å­¸è³‡æºæ¨è–¦&lt;/h2>
&lt;p>å½±ç‰‡ä»˜è²»è³‡æºï¼š&lt;a class="link" href="https://app.pluralsight.com/paths/skills/go-core-language" target="_blank" rel="noopener"
>Go Core Language&lt;/a> ï¼Œè‡ªå·±æœ¬èº«è »å–œæ­¡å½±ç‰‡å¼æ•™å­¸ï¼Œå¯ä»¥å¿«é€Ÿéä¸€éï¼ŒPluralsight çš„èª²ç¨‹å“è³ªé‚„ä¸éŒ¯ï¼Œè€Œä¸”é‚„æœ‰ Skill å¯ä»¥æ¸¬è©¦è‡ªå·±çš„èƒ½åŠ›ï¼ŒæŠŠä¸Šé¢ Go æ ¸å¿ƒèª²ç¨‹çœ‹å®Œå¤§æ¦‚å°±èŠ±å€‹ 5å€‹å°æ™‚å·¦å³ï¼Œè¦ºå¾—å…¥é–€ä¾†èªªé —åˆ’ç®—&lt;/p>
&lt;h2 id="ç‚ºä»€éº¼è¦ç”¨-golang">ç‚ºä»€éº¼è¦ç”¨ Golang&lt;/h2>
&lt;p>é™¤äº†æœ¬èº«æ˜¯éœæ…‹å¼·å‹åˆ¥çš„ç·¨è­¯å¼èªè¨€ï¼ŒGolang ç›¸æ¯”æ–¼ Nodejs èªè¨€æœ¬èº«æœ‰å¹¾å¤§ç‰¹è‰²è®“æˆ‘ååˆ†å–œæ­¡&lt;/p>
&lt;h3 id="1-éå¸¸å·¥ç¨‹å°å‘ç°¡æ½”">1. &lt;code>éå¸¸å·¥ç¨‹å°å‘/ç°¡æ½”&lt;/code>ï¼š&lt;/h3>
&lt;p>Golang å¾ä¸€é–‹å§‹æ¨å‡ºå°±æ˜¯ç‚ºäº†è§£æ±º Google æ‰€é‡åˆ°çš„å¤§å‹è»Ÿé«”ç³»çµ±è¨­è¨ˆé›£é¡Œï¼Œæ‰€ä»¥å¾ä¸€é–‹å§‹è¨­è¨ˆå°±éå¸¸å·¥ç¨‹ã€åœ˜éšŠåˆä½œå°å‘ï¼Œä¾‹å¦‚&lt;/p>
&lt;ol>
&lt;li>åªæœ‰ for loop æ²’æœ‰ while / do while ç­‰ï¼Œè®“å¯«æ³•æœ‰çµ±ä¸€çš„æ–¹å¼ï¼Œä¸æœƒæ¯å€‹äººéƒ½æœ‰å„è‡ªçš„å¯¦ä½œ&lt;/li>
&lt;li>package ä¸­å¤§å¯«ä»£è¡¨ public / å°å¯«ä»£è¡¨ private&lt;/li>
&lt;li>test function å¿…é ˆæ˜¯ä»¥ Test é–‹é ­&lt;br>
Golang åªæœ‰ 25 å€‹ keywordsï¼Œä¸”åœ¨è¨±å¤šåœ°æ–¹éƒ½æœ‰æ˜ç¢ºçš„é™åˆ¶ï¼Œè€Œä¸æ˜¯çµ¦äºˆç©ºæ³›çš„è‡ªç”±ï¼Œé€™è®“åœ˜éšŠæœ‰æ˜ç¢ºçš„ coding style å¯ä»¥éµå®ˆ&lt;/li>
&lt;/ol>
&lt;h3 id="2-èªè¨€æ ¸å¿ƒåŒ…å«å¸¸ç”¨çš„åŠŸèƒ½ä¾‹å¦‚-cli--testing">2. &lt;code>èªè¨€æ ¸å¿ƒåŒ…å«å¸¸ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ CLI / Testing&lt;/code>&lt;/h3>
&lt;p>åœ¨ Nodejs ä¸­ï¼Œæˆ‘å€‘å¸¸éœ€è¦å„ç¨® npm package å®Œæˆä»»å‹™ï¼Œå°è‡³ http request éƒ½è¦å®‰è£ node-fetch / axios / request ç­‰ï¼Œå› ç‚ºæ ¸å¿ƒ library æä¾›çš„ api ä¸å¥½ç”¨ï¼›
ä½†æ˜¯ Golang ä¸­æ²’æœ‰é€™æ¨£çš„å•é¡Œï¼Œå¦‚æœæ˜¯è¦å¯« CLI å·¥å…·ï¼Œè™•ç†åƒæ•¸ / ç”¢ç”Ÿ -help æ–‡ä»¶ç­‰æ ¸å¿ƒ library éƒ½è™•ç†å¦¥ç•¶ï¼›http request ç”¨åŸç”Ÿçš„ net/http å°±å¾ˆæ–¹ä¾¿ï¼Œç”šè‡³ api server ä¹Ÿéƒ½å¯ä»¥ä¸ç”¨ç¤¾ç¾¤çš„ framework å°±èƒ½å¤ å¿«é€Ÿå¯¦ä½œ&lt;/p>
&lt;h3 id="3-è·¨å¹³å°ç·¨è­¯å‡ºå–®ä¸€å¯åŸ·è¡Œçš„-binary-æª”">3. &lt;code>è·¨å¹³å°ç·¨è­¯å‡ºå–®ä¸€å¯åŸ·è¡Œçš„ Binary æª”&lt;/code>&lt;/h3>
&lt;p>é›–ç„¶æœ‰ Docker æä¾›è·¨å¹³å°éƒ¨ç½²çš„ä¸€è‡´æ€§ä¿è­‰ï¼Œä½†æ˜¯ Golang å¯ä»¥ç›´æ¥ç·¨è­¯å‡ºå°æ‡‰å¹³å°å¯åŸ·è¡Œçš„ Binary æª”é‚„æ˜¯å¾ˆæ–¹ä¾¿ï¼Œåœ¨å¯« Dockerfile ä¹Ÿä¸ç”¨æ“”å¿ƒå¤ªå¤šç’°å¢ƒè¨­å®šæ˜¯å¦æ­£ç¢º / å®‰è£éå¤šå¥—ä»¶æ˜¯å¦æœ‰å®‰å…¨æ¼æ´ç­‰ç­‰&lt;/p>
&lt;h3 id="4-å®˜æ–¹æ–‡ä»¶é½Šå…¨ä¸”è©³ç›¡">4. &lt;code>å®˜æ–¹æ–‡ä»¶é½Šå…¨ä¸”è©³ç›¡&lt;/code>&lt;/h3>
&lt;p>Golang å®˜ç¶²ä¸­çš„ &lt;a class="link" href="https://golang.org/doc/faq" target="_blank" rel="noopener"
>Frequently Asked Questions (FAQ)&lt;/a> èˆ‡ &lt;a class="link" href="https://blog.golang.org/" target="_blank" rel="noopener"
>The Go Blog&lt;/a>å°±æœ‰è§£ç­”æˆ‘è¨±å¤šç–‘æƒ‘ï¼ŒåŒ…å«&lt;/p>
&lt;blockquote>
&lt;p>ç‚ºä»€éº¼ Golang è¦æŠŠå‹åˆ¥å®£å‘Šæ”¾åœ¨å¾Œé¢ &lt;a class="link" href="https://golang.org/doc/faq#different_syntax" target="_blank" rel="noopener"
>Why are declarations backwards?&lt;/a>
å› ç‚ºç”¨å£èªå¿µç¨‹å¼ç¢¼æ›´ç›´è¦ºè¡¨é”å‡ºæ„åœ–&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç‚ºä»€éº¼è¦ç”¨ Go &lt;a class="link" href="https://blog.golang.org/two-recent-go-articles" target="_blank" rel="noopener"
>Two recent Go articles&lt;/a>&lt;br>
å› ç‚ºç›®å‰ç†±é–€çš„èªè¨€éƒ½æ˜¯åœ¨ç¶²è·¯/å¤šæ ¸å¿ƒæ™‚ä»£å‰çš„ç”¢ç‰©ï¼Œå¦‚C/C++/Javaï¼Œåƒæ˜¯thread åŠŸèƒ½éƒ½æ˜¯åœ¨èªè¨€èª•ç”Ÿå¾ˆä¹…ä¹‹å¾Œæ‰è¨­è¨ˆçš„ï¼›å¦å¤–ç¾ä»Šç³»çµ±çš„è¦æ¨¡ / å”ä½œäººå“¡ç­‰æ•¸é‡éƒ½å®Œå…¨ä¸åŒï¼Œæ‰€ä»¥éœ€è¦æœ‰æ–°å‹æ…‹çš„èªè¨€ä¾†æ”¯æ´ï¼›&lt;br>
Go å…·å‚™&lt;code>å¿«é€Ÿç·¨è­¯/è·¨å¹³å°æ”¯æ´/åƒåœ¾å›æ”¶æ©Ÿåˆ¶/goroutine ä½µç™¼è¨­è¨ˆ&lt;/code>ï¼Œè®“è¨­è¨ˆç¾ä»£è»Ÿé«”æ›´åŠ ç°¡ä¾¿&lt;/p>
&lt;/blockquote>
&lt;p>å®˜æ–¹å°±æœ‰è±å¯Œçš„è³‡æºå¯ä»¥è®“é–‹ç™¼è€…æ›´æ·±åº¦çš„ç†è§£ Golang è¨­è¨ˆç²¾é«“èˆ‡å¥§å¦™&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>é—œæ–¼åº•å±¤çš„ runtime ç¨®ç¨®é‚„æœ‰è¨±å¤šæœªè§£ä¹‹è¬ï¼Œå°±ç­‰æœªä¾†æ…¢æ…¢å¡«å‘ï¼Œçœ‹è‘—ä¸åŒèªè¨€çš„ç™¼å±•èˆ‡è¨­è¨ˆç†å¿µï¼Œè¦ºå¾—å¯¦åœ¨æ˜¯æœ‰è¶£&lt;/p>
&lt;p>å›æ­¸å·¥ä½œï¼Œå¦‚æœæ˜¯ä¸€äº›ç°¡å–®çš„ä»»å‹™ï¼Œå¯« Nodejs é‚„æ˜¯è »é †æ‰‹çš„ï¼›åªæ˜¯åœ¨å¤§å‹è»Ÿé«”é–‹ç™¼ä¸Šï¼ŒGolang çš„è¨­è¨ˆç†å¿µ / èªè¨€ç‰¹æ€§éƒ½è®“ä»–æˆç‚ºç†±é–€çš„é¸æ“‡ï¼Œä¸æ„§æ˜¯ Docker / K8s ç­‰å·¥å…·é¸æ“‡çš„é–‹ç™¼èªè¨€&lt;/p></description></item><item><title>ã€æ¥µé€Ÿé–‹ç™¼+ã€‘ä¸Šèª²èˆ‡ç·´ç¿’å¿ƒå¾—</title><link>https://yuanchieh.page/posts/2021/2021-02-16-%E6%A5%B5%E9%80%9F%E9%96%8B%E7%99%BC-%E4%B8%8A%E8%AA%B2%E8%88%87%E7%B7%B4%E7%BF%92%E5%BF%83%E5%BE%97/</link><pubDate>Tue, 16 Feb 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-02-16-%E6%A5%B5%E9%80%9F%E9%96%8B%E7%99%BC-%E4%B8%8A%E8%AA%B2%E8%88%87%E7%B7%B4%E7%BF%92%E5%BF%83%E5%BE%97/</guid><description>&lt;p>æœ‹å‹æ–¼ 2018 å¹´å°±å»ä¸Šäº† 91 è€å¸«çš„èª²ï¼Œä¸æ–·çš„å¤§æ¨æ¥µé€Ÿé–‹ç™¼èˆ‡ TDDï¼Œç•¶æ™‚æƒ³èªªä¸€å ‚èª²ä¸€å…©è¬ä¹Ÿå¤ªé©šäººï¼Œå¾Œä¾†æœ‹å‹ç›´æ¥ç¾å ´ Demoï¼Œå°±æ­¤æ‰“ç ´æˆ‘çš„ä¸–ç•Œè§€ï¼Œæ²’æœ‰æƒ³åˆ°å¯«ç¨‹å¼å¯ä»¥æµæš¢æˆé€™ç¨®åœ°æ­¥ï¼Œå ±åå¹¾æ¬¡éƒ½æ²’æœ‰æ¶åˆ°ç¥¨ï¼Œæœ€å¾Œå ±åˆ° 2021/01 çš„èª²ç¨‹ï¼Œå¦‚æœæƒ³è¦å ±åï¼Œè¨˜å¾—è¦å†é–‹æ”¾ç¬¬ä¸€å¤©å°±æ¶ç¥¨å–”ï¼&lt;/p>
&lt;blockquote>
&lt;p>çµ•å°ç‰©è¶…æ‰€å€¼&lt;/p>
&lt;/blockquote>
&lt;p>ç¶“éå››é€±çš„ç·´ç¿’ï¼Œç›®å‰ Tennis Kata ä½¿ç”¨ WebStorm + ES6 é–‹ç™¼ï¼Œå¯ä»¥åœ¨ 15 åˆ†é˜å®Œæˆï¼Œè·Ÿé‚£äº›å£“åœ¨10åˆ†é˜ä»¥å…§çš„ç¥äººåŒå­¸ç›¸æ¯”é‚„å·®å¾ˆé ï¼Œä½†æƒ³èªªé‚„æ˜¯å¯ä»¥ç”¨è‡ªå·±çš„è§’åº¦åˆ†äº«ç·´ç¿’çš„éç¨‹&lt;/p>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/dEIQ1gHEu8g"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;h2 id="å‰æƒ…æè¦">å‰æƒ…æè¦&lt;/h2>
&lt;p>&lt;a class="link" href="https://dotblogs.com.tw/hatelove/2019/06/17/extreme-developing-training-202002" target="_blank" rel="noopener"
>91 éƒ¨è½æ ¼ã€æ¥µé€Ÿé–‹ç™¼+ã€‘&lt;/a> ä¸­æ˜ç¢ºæåˆ°&lt;/p>
&lt;blockquote>
&lt;p>æˆ‘èªåŒã€Œæ™‚é–“ä¸å¤ ã€æ˜¯å€‹å•é¡Œï¼Œç„¶è€Œå»å¾ˆå°‘äººå»æ”¹å–„æˆ–è§£æ±ºé€™å€‹å•é¡Œã€‚é€™é–€èª²ï¼Œå°‡è®“å„ä½å­¸åˆ°ï¼Œå¦‚ä½•å»ºç«‹è‡ªæˆ‘åˆ»æ„ç·´ç¿’çš„æ¨¡å‹ï¼Œå°‡æ‰€æœ‰å·¥å…·çš„æ•´åˆèµ·ä¾†ç™¼æ®æœ€å¤§ç¶œæ•ˆï¼Œé€éæ­£ç¢ºçš„é–‹ç™¼æ–¹å¼èˆ‡é †åºï¼Œè®“ä½ å¯«ä»£ç¢¼æ™‚èƒ½è¡Œé›²æµæ°´ï¼Œä¸¦ä¸”å…¼é¡§è¨­è¨ˆã€å“è³ªèˆ‡ç”Ÿç”¢åŠ›ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¸€é–‹å§‹è½æœ‹å‹åˆ†äº«ï¼Œæœƒè¦ºå¾—&lt;code>ç†Ÿæ‚‰å·¥å…·ä½¿ç”¨å¥½åƒå¾ˆ lowï¼Œèº«ç‚ºå·¥ç¨‹å¸«æ‡‰è©²æ›´å°ˆæ³¨æ–¼æ¼”ç®—æ³•ã€æ¶æ§‹å±¤é¢&lt;/code>ï¼Œä½†æ®Šä¸çŸ¥è‡ªå·±ä¸€å¤©çš„å·¥ä½œæ™‚é–“éƒ½æµªè²»åœ¨ç„¡è¬‚çš„éµç›¤æŒ‰éµèˆ‡æ»‘é¼ ç§»å‹•&lt;/p>
&lt;p>ä¸Šèª²çš„ç¬¬ä¸€å€‹èª²ç¨‹æ˜¯ï¼Œå…©å…©ä¸€çµ„ï¼Œä¸€äººå¯« Tennis Kataï¼Œå¦ä¸€å€‹äººç´€éŒ„å¯«ç¨‹å¼çš„äººæµªè²»å¤šå°‘ç„¡è¬‚çš„æ–¹å‘éµï¼Œæˆ–æ˜¯åœ¨æ€æ¨£çš„å ´æ™¯ä½¿ç”¨æ»‘é¼ ï¼Œé€™ç„¡é—œä¹ç†Ÿä¸ç†Ÿæ‚‰ Tennis Kataï¼Œè€Œæ˜¯å°æ–¼&lt;code>å¯«ç¨‹å¼é€™é …æŠ€è—æ˜¯å¦ç°¡æ½”åˆ°æ²’æœ‰å¤šé¤˜çš„å‹•ä½œ&lt;/code>&lt;/p>
&lt;p>åœ¨å¯«æ¸¬è©¦æ¡ˆä¾‹ï¼Œæˆ‘å€‘æ˜¯å¦æ¯æ¬¡éƒ½è¦é‡æ–°æ‰“&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;....&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">()=&amp;gt;{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">expect&lt;/span>&lt;span class="p">(...).&lt;/span>&lt;span class="nx">toBe&lt;/span>&lt;span class="p">(...)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘å€‘çœ¼ç›ç›¯è‘—ç¨‹å¼ç¢¼ç¬¬ 100 è¡Œçš„ name é€™å€‹è©ï¼Œæ˜¯å¦èƒ½å¤ å¾ˆç²¾æº–åˆå¿«é€Ÿè·³åˆ°å–®å­—ä¸Šï¼Œä¸¦é‡æ–°å‘½åç‚º firstName ç„¶å¾Œå¥—ç”¨åˆ°æ‰€æœ‰çš„å¼•ç”¨ä¸Šï¼Ÿ&lt;/p>
&lt;p>ä¸Šå®Œèª²æœ€éœ‡æ’¼çš„æ˜¯ï¼Œè‡ªå·±å¾æ²’æœ‰æŠ½çµ²å‰ç¹­ã€Œå¯«ç¨‹å¼ã€é€™ä»¶äº‹ï¼Œè€Œæ˜æ˜æœ‰å¥½çš„å·¥å…· / å¥½çš„æ–¹æ³•ï¼Œç‚ºä»€éº¼ä¸ç”¨å‘¢ï¼Ÿï¼&lt;/p>
&lt;h2 id="å¦‚ä½•ç·´ç¿’">å¦‚ä½•ç·´ç¿’&lt;/h2>
&lt;p>ä¸Šå®Œèª² 91 ç¬‘è‘—èªªï¼Œæ¯å¤©åªç·´ 30 åˆ†é˜å°±å¥½ï¼Œå› ç‚ºå¤šç·´ä¹Ÿå¯èƒ½æ˜¯é‡è¤‡éŒ¯èª¤çš„å‹•ä½œï¼Œéµå®ˆè€å¸«çš„å©å’ï¼Œæˆ‘å›ºå®šæ¯å¤©æ—©ä¸Šç·´ç¿’ 30 åˆ†é˜ï¼Œé›–ç„¶æœ‰æ™‚å€™æœƒè¶…éï¼Œä½†ç›¡é‡ä¸è¦è®“è‡ªå·±ç·´ç¿’åˆ°å¿ƒç…©ï¼Œé¿å…å®¹æ˜“ä¸­æ–·ç¿’æ…£&lt;/p>
&lt;h3 id="ç¬¬ä¸€é€±ç·´ç¿’">ç¬¬ä¸€é€±ç·´ç¿’&lt;/h3>
&lt;p>ç¬¬ä¸€é€±ç®—æ˜¯æœ€ç—›è‹¦ï¼Œä½†å¥½åœ¨ä¹Ÿæ˜¯å‰›ä¸Šå®Œèª²èƒ½é‡æœ€å¼·çš„æ™‚å€™ï¼Œfocus åœ¨ tune IDE ä¸Šï¼Œå¾åŸæœ¬çš„ VSCode è½‰ç§»è‡³ Webstorm çš„é™£ç—›æœŸï¼Œä¸»è¦èª¿æ•´&lt;/p>
&lt;ol>
&lt;li>Nodejs ç’°å¢ƒè¨­å®šï¼šå› ç‚ºæƒ³è¦ ESM æ‰€ä»¥è¦æ‰“é–‹è¨­å®šåƒæ•¸ (Nodejs v14 ä»¥å‰)&lt;/li>
&lt;li>æ’ç‰ˆï¼šå¹«å¿™è£œä¸Šï¼›ç­‰ / å»é™¤å¤šé¤˜çš„æ–·è¡Œ / æ›å­—é«”ç­‰ç­‰&lt;/li>
&lt;li>èª¿æ•´ .ideavimrm&lt;br>
é€™éƒ¨åˆ†å¾ˆèŠ±æ™‚é–“ï¼Œä½†å¾ˆå»ºè­°è‡ªå·±æƒéæ•´å€‹æª”æ¡ˆï¼ŒæŠŠå¤šé¤˜çš„æŒ‡ä»¤ç§»é™¤ï¼Œä¸¦ç¢ºä¿è‡ªå·±å¤§æ¦‚çŸ¥é“æ¯å€‹æŒ‡ä»¤çš„å«ç¾©ï¼Œå°¤å…¶æ˜¯ zr ç³»åˆ—&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">zri: inline
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zrp: æŠ½åƒæ•¸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zrm: æŠ½æ–¹æ³•
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zrf: æŠ½æˆ field
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zrn: æˆ‘è‡ªå·±åŠ çš„ï¼Œrefactor element
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åƒæ˜¯ç”¨ Mac é–‹ç™¼ï¼Œè¦ä½¿ç”¨ F1~F12 éƒ½å¾ˆç—›è‹¦ï¼Œæˆ‘å°±å»æŸ¥ &lt;code>:actionlist&lt;/code> æ‰¾å‡º idealvim æ”¯æ´çš„ actionï¼Œæˆ–æ˜¯æŸ¥é€™ä¸€åˆ† &lt;a class="link" href="https://gist.github.com/zchee/9c78f91cc5ad771c1f5d" target="_blank" rel="noopener"
>IdeaVim actionlist&lt;/a>&lt;br>
é›–ç„¶è¨­å®š keymap ä¹Ÿå¯ä»¥ï¼Œä½†æƒ³èªªèƒ½å¤ ç”¨ä¸€å¥—å°±å…¨éƒ¨ç”¨ä¸€å¥—ï¼Œæ‰€ä»¥åˆ‡æ›æª”æ¡ˆæˆ‘ä¹Ÿé‡æ–°ç¶é&lt;/p>
&lt;p>ç¬¬ä¸€é€±åªåšåˆ° tune ideï¼Œä¸¦ç·´ç¿’åˆ° &amp;rsquo;thirty love&amp;rsquo;ï¼Œä¸¦ç†Ÿæ‚‰ zr ç³»åˆ—çš„å¿«æ·éµ&lt;/p>
&lt;h3 id="ç¬¬äºŒé€±">ç¬¬äºŒé€±&lt;/h3>
&lt;p>æ¥ä¸‹ä¾†æŒ‘æˆ°å¯«å®Œæ•´å€‹ tennisï¼Œé€Ÿåº¦å¤§æ¦‚åœ¨ 22~25 åˆ†é˜ï¼Œæ¯å¤©å›ºå®šå…ˆçœ‹ä¸€æ¬¡è€å¸«çš„å½±ç‰‡ï¼Œæ³¨æ„è‡ªå·±å¾ˆå¡çš„åœ°æ–¹è€å¸«æ€éº¼å¯«ï¼Œä¾‹å¦‚è£œ &amp;rsquo;this.&amp;rsquo; / è£œ ; è£œ , ç­‰ç­‰ï¼Œæ…¢æ…¢ä¿®æ‰ä¸€äº›å£ç¿’æ…£ï¼Œç›¡å¯èƒ½æ¯æ¬¡ç·´ç¿’åªå°ˆæ³¨åœ¨ä¸‰å€‹é»ä¸Šé¢ï¼Œä¹Ÿæ…¢æ…¢æ›´ç†Ÿæ‚‰ä½¿ç”¨ j / k / w / b ç§»å‹•ï¼Œ&lt;code>æ™‚æ™‚æé†’è‡ªå·±æƒ³ä¸å‡ºä¾†ä¹Ÿä¸å¯ä»¥è‡ªæš´è‡ªæ£„ç”¨æ–¹å‘éµè·Ÿæ»‘é¼ ï¼Œåœä¸‹ä¾†çœ‹è€å¸«çš„å½±ç‰‡&lt;/code>&lt;/p>
&lt;h3 id="ç¬¬ä¸‰é€±">ç¬¬ä¸‰é€±&lt;/h3>
&lt;p>è‡ªå·±ç·´ç¿’é€Ÿåº¦å¡åœ¨ 22 åˆ†é˜ä¸Šä¸‹ï¼Œç™¼ç¾æ˜¯å¾ŒåŠæ®µå¤ªä¸ç†Ÿç·´ï¼Œæ±ºå®šå°ˆæ”»å¾ŒåŠæ®µï¼Œç”¨ git ä¿å­˜é€²åº¦ï¼Œæ¯å¤© reset åè¦†ç·´ç¿’ï¼Œä¸€æ¨£æ˜¯å…ˆçœ‹è€å¸«çš„å½±ç‰‡é…æ—©é¤ï¼Œæ¥è‘—ç”¨ä¾¿æ¢ç´™å¯«ä¸‹è¦æ”¹é€²çš„ä¸‰å€‹é»ï¼Œå¦‚æœé‡åˆ°è‡ªå·±å¾ˆå¡çš„åœ°æ–¹ï¼Œ&lt;code>ç›´æ¥ä¿®æ”¹ .ideavimrc&lt;/code>&lt;/p>
&lt;p>é€™ä¸€é€±é€Ÿåº¦çš„é€²æ­¥ä¾†è‡ª&lt;/p>
&lt;ol>
&lt;li>&lt;code>æ›´å¤šæ¡ç”¨ Acejump&lt;/code>&lt;br>
ä¸€é–‹å§‹ä¸‹æ„è­˜éƒ½æ˜¯ç”¨ j/k/w/b å»ç§»å‹•ï¼Œé–‹å§‹æœ‰æ„è­˜ç·´ç¿’ç”¨ Acejumpï¼Œé€™é‚Šä¹Ÿå¾ˆæ„Ÿè¬åŒæ¢¯åŒå­¸åœ¨ç¾¤çµ„ä¸­ä¸æ–·è¨è«–æœ€ä½³å¯«æ³•&lt;/li>
&lt;li>ç·´ç¿’ &lt;code>vim surround&lt;/code> å„ªåŒ– Math.abs ç·¨å¯«&lt;br>
å¯ä»¥åƒè€ƒé€™ä»½ gist &lt;a class="link" href="https://gist.github.com/wilon/ac1fc66f4a79e7b0c161c80877c75c94" target="_blank" rel="noopener"
>vim-surroundä½¿ç”¨æŒ‡å—.MD&lt;/a>ï¼Œå¦‚æœè¦é‡å°å·²é¸å–çš„éƒ¨åˆ†è¦ç”¨ &lt;code>S&lt;/code> åŠ ä¸Šå°ç¨±ç¬¦è™Ÿ&lt;/li>
&lt;li>å–æ¶ˆ Webstorm æŠ½åƒæ•¸æ™‚è£œä¸Šé è¨­&lt;br>
å‡è¨­ä»¥ä¸‹è¦æŠŠ &amp;ldquo;joey&amp;rdquo; æŠ½æˆåƒæ•¸ï¼Œæˆ‘çš„é è¨­æœƒæ˜¯å¸¶å…¥é è¨­å€¼ï¼Œé€™æ¨£æœƒè®“åŸæœ¬åœ¨åˆå§‹åŒ– Tennis æ™‚ä¸æœƒè‡ªå‹•è£œä¸Š new Tennis(&amp;ldquo;joey&amp;rdquo;)&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">constructor&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">firstPlayerName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;joey&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">firstPlayerName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;joey&amp;#34;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">firstPlayerName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">firstPlayerName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æŠ½åƒæ•¸æ™‚æœƒæœ‰å°æç¤ºï¼Œè¨˜å¾—è¦é»æ‰&lt;br>
&lt;img src="https://yuanchieh.page/post/2021/img/0126/default-param.png"
loading="lazy"
>&lt;/p>
&lt;p>å¦ä¸€å€‹ç·´ç¿’æ˜¯æª”æ¡ˆç›®éŒ„æ“ä½œï¼Œä¾‹å¦‚èªªå¤šå»ºä¸€å€‹ folder / æŠŠæª”æ¡ˆç§»å‹•éå» / åˆªé™¤æª”æ¡ˆé€™äº›ï¼ŒåŸæœ¬ Tennis æ²’æœ‰ç·´åˆ°é€™éƒ¨åˆ†ï¼Œä½†å¯¦å‹™ä¸Šé€™äº›å‹•ä½œå¾ˆéœ€è¦ï¼Œå°±æœ‰èŠ±é¡å¤–çš„æ™‚é–“ç·´ç¿’&lt;/p>
&lt;h3 id="ç¬¬å››é€±ç·´ç¿’">ç¬¬å››é€±ç·´ç¿’&lt;/h3>
&lt;p>å¾åŸæœ¬ 22 åˆ†é˜é€²æ­¥åˆ° 19 åˆ†ï¼Œé–‹å§‹ç”¨æ®µè½åˆ‡å‰²ï¼Œä¸€é‚Šæ”¾è€å¸«çš„å½±ç‰‡ä¸€é‚Šæ”¾è‡ªå·±çš„å½±ç‰‡ï¼Œæ‰¾å‡ºç‚ºä»€éº¼è‡ªå·±æœƒè½å¾Œçš„åœ°æ–¹&lt;/p>
&lt;p>è€å¸«çš„æ™‚é–“å¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>(1:54) fifteen love&lt;/li>
&lt;li>(4:16) thirty love&lt;/li>
&lt;li>(8:00) love thirty&lt;/li>
&lt;li>(9:24) deuce&lt;/li>
&lt;li>(13:24) done&lt;/li>
&lt;/ol>
&lt;p>è§€å¯Ÿå¾Œæœ‰å¹¾å€‹è‡ªå·±å®¹æ˜“å¿˜è¨˜çš„å¿«æ·éµ&lt;/p>
&lt;ol>
&lt;li>é¸å–æŠ½æ–¹æ³•ï¼Œå¯ä»¥ç”¨ z( / z{ å¿«é€ŸæŠ½å–ï¼Œå°æ¯” vi( å¿«ä¸Šä¸€é»&lt;/li>
&lt;li>åˆªé™¤å«å–®å¼•è™Ÿçš„è®Šæ•¸&lt;/li>
&lt;/ol>
&lt;h2 id="å·¥ä½œä¸Šç”¨å¾—åˆ°å—">å·¥ä½œä¸Šç”¨å¾—åˆ°å—ï¼Ÿ&lt;/h2>
&lt;p>ç·´ç¿’çœ‹èµ·ä¾†å¾ˆç†æƒ³ï¼Œä½†å¯¦å‹™ä¸Šæœ‰ç”¨å—ï¼Ÿ&lt;br>
é€™ä¹Ÿæ˜¯åœ¨ç·´ç¿’éç¨‹ä¸æ–·æ€è€ƒçš„ï¼Œé›–ç„¶æœæ–·ä¹ŸæŠŠå·¥ä½œæ©Ÿè½‰æˆ Webstrom + idealvimï¼Œæ–°å°ˆæ¡ˆç·¨å¯«è‡ªç„¶æ²’å¤ªå¤§å•é¡Œï¼Œä½†æ˜¯èˆŠå°ˆæ¡ˆä½¿ç”¨ä¸Šå°±å¡å¡çš„ï¼Œä¸»è¦æ˜¯ä»¥å‰çš„ js å¯«æ³•æ¯”è¼ƒäº‚ï¼Œide å¾ˆé›£è‡ªå‹•è¾¨åˆ¥ï¼ŒåŠ ä¸Šä¸€å€‹æª”æ¡ˆç¨‹å¼ç¢¼ä¸Šåƒè¡Œï¼ŒèŠ±æœ€å¤šçš„æ™‚é–“ä¸æ˜¯åœ¨æ–¼ä¿®æ”¹è€Œæ˜¯&lt;code>æŸ¥è©¢&lt;/code>ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ &lt;code>,m&lt;/code> å»çœ‹ file structureï¼Œæ¥ä¸‹ä¾†å°±æ˜¯ç”¨æ»‘é¼ æ»¾æ»¾æ»¾çœ‹ Code&lt;/p>
&lt;p>è€å¸«ä¹Ÿæœ‰åœ¨ä¸Šèª²æåˆ°ï¼Œæ»‘é¼ ä¹Ÿä¸æ˜¯ä¸å¥½ï¼Œåœ¨æŸ¥è©¢æ™‚æ»‘é¼ æ»¾å‹•é‚„æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¸ç”¨å¤ªæ‹˜æ³¥&lt;/p>
&lt;p>ç¸½ä¹‹ç›®å‰å·¥ä½œä½¿ç”¨ä¸Šé‚„æ²’æœ‰åˆ°å¾ˆé †ï¼Œæœƒå°‘é‡ç”¨ä¸€äº›å¿«æ·éµå¦‚æŠ½æ–¹æ³• / æŠ½åƒæ•¸ï¼Œä½†æ˜¯é‚„æ²’æœ‰è¾¦æ³•æµæš¢çš„ä½¿ç”¨çµ„åˆæŠ€&lt;/p></description></item><item><title>ã€å·¥ç¨‹å¸«çœ‹å•†æ¥­ã€‘æŠ€è¡“å·¥ä½œè€…çš„å•†æ¥­æ€ç¶­è¬›åº§åˆ†äº«</title><link>https://yuanchieh.page/posts/2021/2021-02-06-%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9C%8B%E5%95%86%E6%A5%AD%E6%8A%80%E8%A1%93%E5%B7%A5%E4%BD%9C%E8%80%85%E7%9A%84%E5%95%86%E6%A5%AD%E6%80%9D%E7%B6%AD%E8%AC%9B%E5%BA%A7%E5%88%86%E4%BA%AB/</link><pubDate>Sat, 06 Feb 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-02-06-%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9C%8B%E5%95%86%E6%A5%AD%E6%8A%80%E8%A1%93%E5%B7%A5%E4%BD%9C%E8%80%85%E7%9A%84%E5%95%86%E6%A5%AD%E6%80%9D%E7%B6%AD%E8%AC%9B%E5%BA%A7%E5%88%86%E4%BA%AB/</guid><description>&lt;p>å·¥ä½œä¹Ÿå››å¹´äº†ï¼Œä¾†åˆ°è·æ¶¯æœ€ç‚ºè¿·æƒ˜çš„ä¸€å¹´ï¼Œéå»ä¹Ÿä¸ç®—æ··æ±å­¸è¥¿å­¸å¥½åƒæ‹¼æ¹Šå‡ºä¸€äº›æ±è¥¿ï¼Œä½†ä¹Ÿé–‹å§‹æ‡·ç–‘è‡ªå·±è©²é¸ä»€éº¼æŠ€è¡“ç™¼å±•ï¼Ÿåˆæ‡‰è©²é¸æ“‡æ€æ¨£çš„å·¥ä½œèˆ‡è·æ¶¯ï¼Ÿæœªä¾†åˆä½•å»ä½•å¾ï¼Ÿ&lt;/p>
&lt;p>åœ¨é€™ä½æ½®æœŸï¼Œå‰›å¥½ä¸Šå®Œ 91 è€å¸«çš„æ¥µé€Ÿé–‹ç™¼èª²ç¨‹ï¼Œåœ¨æŠ€è¡“åŸ¹è¨“ä¸Šå¸¶çµ¦æˆ‘å¾ˆæ£’çš„è¦–é‡èˆ‡å¼·å¤§çš„å­¸ç¿’å‹•èƒ½ï¼Œç™¼ç¾è‡ªå·±çš„åŸºæœ¬åŠŸæ‡‰è©²å†å¥½å¥½é›•ç¢ï¼›&lt;br>
åˆå‰›å¥½åœ¨å•†æ¥­æ€ç¶­å­¸é™¢çœ‹åˆ° 91 è€å¸«åˆ†äº«è·æ¶¯çš„ç¨®ç¨®é¸æ“‡èˆ‡è¦åŠƒï¼Œè¦ºå¾—ååˆ†çš„æ•¬ä½©ï¼Œè‡ªå·±ä»¥ä¸€å€‹å·¥ç¨‹å¸«è·æ¶¯ç™¼å±•çš„è§’åº¦ï¼Œæ‘˜éŒ„ 91 å¤§å¤§åœ¨å•†æ¥­æ€ç¶­å­¸é™¢çš„åˆ†äº«&lt;/p>
&lt;p>å…ˆåˆ†äº«æœ€å¾Œ Qï¼†Aï¼Œä¹Ÿæ˜¯å¤§å®¶å¸¸è¦‹çš„å•é¡Œï¼Œæ¥è‘—åœ¨æ‘˜éŒ„å¾ŒçºŒ 91 çš„åˆ†äº«&lt;/p>
&lt;h3 id="é«˜è–ªå·¥ç¨‹å¸«èˆ‡ä½è–ªå·¥ç¨‹å¸«çš„å·®ç•°">é«˜è–ªå·¥ç¨‹å¸«èˆ‡ä½è–ªå·¥ç¨‹å¸«çš„å·®ç•°&lt;/h3>
&lt;p>å›æ­¸å¸‚å ´éœ€æ±‚ï¼Œçœ‹é€™å€‹å¸‚å ´éœ€è¦æ€éº¼æ¨£çš„èƒ½åŠ›ï¼Ÿæ˜¯ä¸æ˜¯æœ‰å¾ˆå¤šäººå¯ä»¥æä¾›é€™æ¨£çš„èƒ½åŠ›ï¼Ÿæˆ‘å¯ä¸å¯ä»¥åˆå¿«åˆå¥½åˆä¾¿å®œçš„è§£æ±ºå•é¡Œï¼ŸåŸ¹é¤Šå‡ºè‡ªæˆ‘çš„ç¨€ç¼ºèƒ½åŠ›ï¼Œæ‰æœ‰è­°åƒ¹çš„è‡ªç”±&lt;br>
å·¥ç¨‹å¸«è¦å°å¿ƒæŠ€è¡“æœ¬ä½ï¼Œéœ€è¦è‘—çœ¼æ–¼å•†æ¥­åƒ¹å€¼çš„è²¢ç»ï¼Œ91 è€å¸«èˆ‰ä¾‹è‡ªå·±çš„èª²ç¨‹æ²’æœ‰ä¸²é‡‘æµï¼Œå› ç‚ºé€™ä¸æ˜¯å•†æ¥­ä¸Šç™¼å±•çš„ç“¶é ¸ï¼Œä½†å¾ˆå¤šå·¥ç¨‹å¸«æœƒè¦ºå¾—å¾ˆé…·å¾ˆæ–¹ä¾¿å°±å»åšï¼Œä½†é€™ä¸æœƒå¸¶ä¾†å¤ªå¤§çš„æ•ˆç›Š&lt;/p>
&lt;h3 id="å¦‚ä½•é¿å…è‡ªå·±æˆç‚ºä¸€å¹´ç¶“é©—ç”¨åå¹´çš„å·¥ç¨‹å¸«">å¦‚ä½•é¿å…è‡ªå·±æˆç‚ºä¸€å¹´ç¶“é©—ç”¨åå¹´çš„å·¥ç¨‹å¸«&lt;/h3>
&lt;ol>
&lt;li>å¦‚æœè‡ªå·±æ˜¯ç’°å¢ƒä¸­æœ€å¼·çš„äººï¼Œå»ºè­°æ›å€‹ç’°å¢ƒï¼Œæ‰¾æ–°çš„å­¸ç¿’å‹•èƒ½&lt;/li>
&lt;li>è§€å¯Ÿåˆ¥äººå¦‚ä½•è§£æ±ºå•é¡Œï¼Œæ‰€ä»¥ 91 æ¨å´‡ Pair / Mod Programmingï¼Œå¾åˆ¥äººçš„ä½œæ³•å¯ä»¥æ‰¾åˆ°ä¸åŒçš„å­¸ç¿’æ–¹å¼&lt;/li>
&lt;li>æŒçºŒå­¸ç¿’ / æŒçºŒå˜—è©¦&lt;/li>
&lt;li>è§€å¯Ÿè‡ªå·±æœ‰æ²’æœ‰å¾ˆå¸¸åŠ ç­ï¼Œæˆ–æ˜¯ä¸€ç›´åšé‡è¤‡æ€§å¾ˆé«˜çš„å·¥ä½œï¼Œè«‹ç”¨æ™‚é–“å»è³ºæ™‚é–“ï¼Œæ‰¾åˆ°æ­£å‘å¢å¼·è¿´è·¯&lt;/li>
&lt;/ol>
&lt;h3 id="è©²é¸æ“‡ä»€éº¼æŠ€è¡“ç™¼å±•">è©²é¸æ“‡ä»€éº¼æŠ€è¡“ç™¼å±•&lt;/h3>
&lt;p>åŒæ¨£æ˜¯å¸‚å ´éœ€æ±‚ï¼Œç•¶åˆ 91 ä¸å–œæ­¡å‹•æ…‹èªè¨€ï¼Œä½†å‰é™£å­ python å¾ˆç«ç†±ï¼Œä»–é€éé¡§å•å‘å®¢æˆ¶å­¸ç¿’ï¼Œæœ€å¾Œç™¼ç¾ä»–ä¹Ÿå–œæ­¡ä¸Š python äº†&lt;br>
91 å¾ˆæ…¶å¹¸è‡ªå·±æ˜¯é¡§å•èˆ‡æ•™å­¸å…¼ä½µï¼Œé¡§å•å¯ä»¥å¾å®¢æˆ¶ä¸­å¾—åˆ°å¯¦å‹™ä¸Šçš„ç¶“é©—ï¼Œè½‰è®ŠæˆåŸ¹è¨“æ™‚çš„æ•™å­¸æ–¹å‘ï¼Œå¦‚æœåªåšæ•™å­¸å°±ä¸€ç›´åƒè€æœ¬ç„¡æ³•æˆé•·&lt;/p>
&lt;h3 id="junior-å·¥ç¨‹å¸«æ”¹å¾€å»£é‚„æ˜¯å¾€æ·±">Junior å·¥ç¨‹å¸«æ”¹å¾€å»£é‚„æ˜¯å¾€æ·±&lt;/h3>
&lt;p>å…ˆæ‰¾åˆ°ç«‹è¶³ä¹‹åœ°ï¼Œç†Ÿæ‚‰ä¸€å€‹æŠ€è¡“åˆ°å¯ä»¥è§£æ±ºå¤§å¤šæ•¸çš„å•†æ¥­å•é¡Œï¼Œä¾‹å¦‚èªª GraphQL ç”¨å‹•æ…‹èªè¨€ python / js æ¯”è¼ƒå¥½å¯¦ä½œï¼Œä½† c# ä¸€æ¨£å¯ä»¥è§£æ±ºä½†å¯èƒ½æ¯”è¼ƒä¸é©åˆ(é€™å¥½åƒæ€ªæ€ªçš„ï¼Ÿ)ï¼Œæ…¢æ…¢ç™¼ç¾æŸäº›åœ°æ–¹å¯èƒ½è§£æ³•ä¸å¤ æ¼‚äº®ï¼Œå†é–‹å§‹è·³å»å­¸æ–°çš„æŠ€è¡“ï¼Œå°±æœ‰è¶³å¤ çš„å‹•æ©Ÿå»å­¸ç¿’&lt;/p>
&lt;h3 id="junior-å·¥ç¨‹å¸«è©²å»æ–°å‰µé‚„æ˜¯å¤§å…¬å¸">Junior å·¥ç¨‹å¸«è©²å»æ–°å‰µé‚„æ˜¯å¤§å…¬å¸&lt;/h3>
&lt;p>éƒ½æ˜¯é¸æ“‡è€Œå·²ï¼Œæ–°å‰µå…¬å¸éœ€è¦å¿«é€Ÿã€ä½æˆæœ¬çš„è¿­ä»£ï¼Œå¯ä»¥å­¸ç¿’å¦‚ä½•æ¶ç˜ã€å¿«é€Ÿå¾—åˆ°å¸‚å ´çš„å›é¥‹ï¼›å¤§å…¬å¸å‰‡æ˜¯åˆ†å·¥å¾ˆç´°ï¼Œé–‹ç™¼åªåšé–‹ç™¼ï¼Œä¸æ‡‚æ•´å€‹ç”¢å“é¢å‘ï¼Œ91 ä¸å¤ªèªåŒé€™æ¨£çš„åˆ†å·¥æ–¹å¼ï¼Œä½†æ˜¯ç•¶åˆé¸æ“‡ Yahoo æ˜¯å› ç‚ºå¯ä»¥æ¥è§¸åˆ°æ›´å¤šçš„è¦–é‡ / å¯¦åŠ›å¾—åˆ°æ›´å¤šçš„åŸ¹é¤Šï¼Œè€Œä¸”èƒ½åšå…¨ä¸–ç•Œçš„ç”Ÿæ„&lt;br>
æœ€å¾Œå›æ­¸é‡é»ï¼Œ&lt;code>æ™‚é–“æ˜¯æœ€è²´çš„ï¼Œç”¨æ™‚é–“å»è³ºæ™‚é–“&lt;/code>&lt;/p>
&lt;hr>
&lt;p>91 å¤§å¤§ä¸»è¦åˆ†äº«å·¥ä½œä¸Šçš„é¸æ“‡ / å·¥ä½œä»¥å¤–å¦‚ä½•å‰µé€ é€£çµ / å¦‚ä½•é€éæŠ€è¡“è®Šç¾ / æœ€å¾Œå›é¡§è·æ¶¯çš„æˆé•·&lt;/p>
&lt;h2 id="å¤§äº‹è¨˜å·¥ä½œç¶“æ­·">å¤§äº‹è¨˜(å·¥ä½œç¶“æ­·)&lt;/h2>
&lt;h3 id="ç¬¬ä¸€ä»½å·¥ä½œå¡æšåœ‹é˜²å½¹-4-å¹´">ç¬¬ä¸€ä»½å·¥ä½œï¼šå¡æš(åœ‹é˜²å½¹) 4 å¹´&lt;/h3>
&lt;p>åœ‹é˜²å½¹å°±æ˜¯å››å¹´è·‘ä¸æ‰çš„å¥½ç”¨å‹å·¥ï¼Œæ‰€ä»¥ 91 ä¹Ÿå¸¸è¢«æ´¾å»è™•ç†æ£˜æ‰‹çš„ä»»å‹™ï¼Œåœ¨é€™ç¬¬ä¸€ä»½å·¥ä½œä¸­ï¼Œ91 ç£¨ç·´äº†æ‰å¯¦åŸºæœ¬åŠŸ / å¦‚ä½•å¸¶ team / æ•æ·é–‹ç™¼ï¼Œå› ç‚ºæ˜¯ä½¿ç”¨å¾®è»Ÿçš„ solutionï¼Œ91 ä¹Ÿæ‹¿åˆ°äº†å¾®è»Ÿ MVP çš„é ­éŠœ&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>ç·´å¥½åŸºæœ¬åŠŸï¼Œæ‰¾åˆ°è‡ªæˆ‘çš„ç«‹è¶³ä¹‹åœ°&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;h3 id="ç¬¬äºŒä»½å·¥ä½œyahoo-5-å¹´">ç¬¬äºŒä»½å·¥ä½œï¼šYahoo 5 å¹´&lt;/h3>
&lt;p>é›¢é–‹åœ‹é˜²å½¹æ™‚æœ‰æ‹¿åˆ° 7 å€‹ offerï¼Œæœ€å¾Œé¸æ“‡è–ªè³‡æœ€ä½çš„ Yahoo åŸå› æ˜¯&lt;/p>
&lt;ol>
&lt;li>æœ¬èº«å°æ–¼äº¤æ˜“å‹ç³»çµ±æœ‰èˆˆè¶£&lt;/li>
&lt;li>è·æ¶¯æ‰å‰›é–‹å§‹ï¼Œé¸æ“‡è·æ¶¯å‡ºè·¯æœ€å»£çš„å…¨çƒæ€§ / ç´”è»Ÿå…¬å¸&lt;/li>
&lt;/ol>
&lt;p>å¾ˆæ·±çš„é«”æ‚Ÿæ˜¯ &lt;code>å¦‚æœå·²ç¶“æ˜¯åœ˜éšŠæœ€å¼·çš„äººï¼Œé‚£ä½ çš„é€²æ­¥æœƒå¾ˆæ…¢&lt;/code>ï¼Œé¸æ“‡ Yahoo æœ‰å¾ˆå¤šå¾ˆå¼·çš„æŠ€è¡“äººå¯ä»¥ç•¶ä½œ role modelï¼ŒåŒæ™‚é–‹æ”¾çš„æ–‡åŒ–ä¹Ÿè®“ 91 æœ‰æ›´å¤šå˜—è©¦çš„æ©Ÿæœƒï¼Œç´¯ç©æ›´å¤šçš„æŠ€è¡“è²é‡&lt;/p>
&lt;h3 id="ç¬¬ä¸‰ä»½å·¥ä½œæ±æ£®ä¿¡æ¯---1-å¹´">ç¬¬ä¸‰ä»½å·¥ä½œï¼šæ±æ£®ä¿¡æ¯ - 1 å¹´&lt;/h3>
&lt;p>åœ¨ Yahoo äº”å¹´ä¹Ÿåšå¾—å·®ä¸å¤šäº†ï¼Œç¬¬ä¸‰ä»½å·¥ä½œæœ‰é»è·Œç ´å¤§å®¶çœ¼é¡ï¼Œå»äº†ä¸€å€‹ç™¾å»¢å¾…èˆˆçš„æ±æ£®ä¿¡æ¯ï¼Œæ“”ä»»æ¶æ§‹å¸« / è² è²¬èˆ‡å…¶ä»–åœ˜éšŠæºé€šï¼ŒæŠŠä¹‹å‰æ‰€æœ‰ç´¯ç©çš„ç¶“é©—éƒ½è®Šæˆè–ªè³‡ç±Œç¢¼ (350+)ï¼Œä½†é€™ä¹Ÿæ˜¯äººç”Ÿæœ€æ…˜æ•—çš„ä¸€å¹´ï¼Œç™¼ç¾ &lt;code>ä¸Šç­æ™‚çš„ä¸å¿«æ¨‚ä¸èƒ½å¾ä¸‹ç­ä¸­è£œè¶³&lt;/code>ï¼ŒåŒæ™‚ç§‘æ™®ä¸€ä¸‹å¹´è–ªé 300 å¾Œç¨…æ”¶ä¹Ÿå¢åŠ ï¼Œå¤šä¸€äº›éŒ¢ä½†å…¶å¯¦ä¸æœƒæ¯”è¼ƒå¿«æ¨‚&lt;/p>
&lt;h3 id="ç¬¬å››ä»½å·¥ä½œodd-e">ç¬¬å››ä»½å·¥ä½œï¼šOdd-e&lt;/h3>
&lt;p>ä»¥å‰å°±æ‰¾åˆ°è‡ªå·±ç†±æ„›çš„å¤©è·ï¼šé¡§å•+æ•™å­¸ï¼ŒåŸºæ–¼ä¸Šä¸€ä»½æ•™è¨“ï¼Œæ±ºå®šå¾è‡ªå·±ç†±æ„›çš„äº‹ç‰©è®Šç¾(å•†æ¥­æ€ç¶­)ï¼Œé›–ç„¶è¦é¢è‡¨æ›´é«˜çš„ä¸ç¢ºå®šæ€§ï¼Œä½†æ±ºå®šçµ¦è‡ªå·±ä¸€å¹´çš„æ™‚é–“å˜—è©¦ï¼Œæœ€å¾Œå°±ä¸€è·¯åšåˆ°ç¾åœ¨ (è–ªè³‡é‚„ç¿»å¥½å¹¾å€!)&lt;/p>
&lt;h2 id="å‰µé€ é€£çµ">å‰µé€ é€£çµ&lt;/h2>
&lt;p>è¦åœ¨ç¤¾ç¾¤ä¸­æ‰¾åˆ°è‡ªå·±çš„ç«‹è¶³ä¹‹åœ°ï¼Œ&lt;code>91 = æ•æ· + é–‹ç™¼&lt;/code>ï¼Œæ‰€æœ‰çš„å˜—è©¦éƒ½åœç¹è‘—é€™å…©å¡Šèµ°&lt;/p>
&lt;h3 id="ç¤¾ç¾¤è²¢ç»">ç¤¾ç¾¤è²¢ç»&lt;/h3>
&lt;p>åœ¨ç¤¾ç¾¤ä¸­æ‰¾åˆ°å¾ˆå¤šè²´äººï¼Œä¹Ÿé€éç¤¾ç¾¤å¥ å®šè‡ªå·±çš„æ±Ÿæ¹–åœ°ä½&lt;/p>
&lt;h3 id="æŒçºŒæ›å…‰">æŒçºŒæ›å…‰&lt;/h3>
&lt;p>å¯«éƒ¨è½æ ¼ / åƒåŠ  IT éµäººè³½ / è¬›å¸«äº¤æµ / FB ç²‰çµ²å°ˆé  / Youtuber&lt;/p>
&lt;h3 id="ç•°æ¥­çµç›Ÿ">ç•°æ¥­çµç›Ÿ&lt;/h3>
&lt;p>å¤©ç“æ›¸å±€ / å‡ºç‰ˆæ¥­ / ä¼æ¥­æ‹›å‹Ÿ / å•†æ¥­æ€ç¶­å­¸é™¢&lt;/p>
&lt;h3 id="å°ˆæ¥­å½¢è±¡">å°ˆæ¥­å½¢è±¡&lt;/h3>
&lt;p>å‡ºç‰ˆæ›¸ç± / å¾®è»Ÿ MVP / ç ”è¨æœƒè¬›å¸«&lt;/p>
&lt;h2 id="æŠ€è¡“è®Šç¾">æŠ€è¡“è®Šç¾&lt;/h2>
&lt;h3 id="å¾å¯©æ ¡é–‹å§‹">å¾å¯©æ ¡é–‹å§‹&lt;/h3>
&lt;p>ç¬¬ä¸€æ¬¡å‡ºç‰ˆæ˜¯å¯©æ ¡ç°¡é«”ç‰ˆçš„ .net æ›¸ç±ï¼Œæ­¤æ™‚ä»¥é–‹ç™¼è€…çš„è§’åº¦å‡ºç™¼ï¼Œè¸å‡ºç¬¬ä¸€æ­¥å°‡æŠ€è¡“è®Šç¾&lt;br>
æ¥è‘—ç¬¬äºŒæ¬¡å‡ºç‰ˆè®Šæˆå…±åŒç¿»è­¯æ•æ·åŸæ–‡æ›¸ï¼Œä¹Ÿå…±åŒå‡ºç‰ˆäº†è·Ÿ .net ç›¸é—œçš„æ›¸ç±&lt;/p>
&lt;h3 id="æ¥åˆ°ç¬¬ä¸€å ´ä¼æ¥­å…§è¨“">æ¥åˆ°ç¬¬ä¸€å ´ä¼æ¥­å…§è¨“&lt;/h3>
&lt;p>æŒçºŒå‡ºç‰ˆè·Ÿ .net ç›¸é—œçš„æ›¸ç±ç´¯ç©è²é‡ï¼ŒåŒæ™‚æ¥åˆ°ç¬¬ä¸€å ´ä¼æ¥­å…§è¨“ï¼Œç•¶æ™‚æœ‰åº•æ°£æ¥ä¼æ¥­å…§è¨“ä¹Ÿæ˜¯å› ç‚ºåœ¨ Yahoo ç´¯ç©å¾ˆå¤šå ´å…§éƒ¨å“¡å·¥åŸ¹è¨“çš„ç¶“é©—ï¼Œä¹Ÿé–‹å§‹é–‹è¾¦å…¬é–‹èª²ç¨‹&lt;br>
åœ¨ç¤¾ç¾¤çš„è€•è€˜ä»¥åŠéƒ¨è½æ ¼çš„ç´¯ç©ï¼Œé–‹å§‹æ”¶åˆ°å°ˆæ¬„é‚€ç´„ï¼Œæœ‰äº†å¦ä¸€ä»½æ”¶å…¥&lt;/p>
&lt;h3 id="æŒçºŒå˜—è©¦">æŒçºŒå˜—è©¦&lt;/h3>
&lt;p>91 åœ¨æ¼”è¬›ä¸æ–·é‡è¤‡ã€Œåœ¨ä¸é¤“æ­»çš„æƒ…æ³ï¼Œæˆ‘é‚„æœ‰XXX æƒ³è¦å˜—è©¦ã€ï¼Œåƒ 2021 å¹´åˆç¿»è­¯äº† Kent Beck çš„æ›¸ç±ï¼Œç®—æ˜¯äººç”Ÿä¸€å¤§çªç ´ï¼Œä¹Ÿå¾ˆç¬¦åˆã€Œæ•æ·+é–‹ç™¼ã€çš„äººç‰©è¨­å®šï¼› &lt;br>
åœ¨ä»Šå¹´ 91 å› æ‡‰ç–«æƒ…ï¼Œæ±ºå®šå˜—è©¦ Youtube / ç·šä¸Šèª²ç¨‹ï¼Œä¸¦å˜—è©¦èˆ‡ä¸åŒè¬›å¸«å»ºç«‹é€£çµã€å½¼æ­¤å°æµ&lt;/p>
&lt;blockquote>
&lt;h1 id="å°ç¯€">å°ç¯€&lt;/h1>
&lt;ol>
&lt;li>å¾ªåºæ¼¸é€²çš„çªç ´ï¼š
å¾å¯©æ ¡ &amp;gt; å…±åŒç¿»è­¯ &amp;gt; å…±åŒå‡ºç‰ˆ / å…¬å¸å…§è¨“ &amp;gt; å¤–éƒ¨ä¼æ¥­åŸ¹è¨“ &amp;gt; å…¬é–‹èª²ç¨‹ &amp;gt; é¡§å•&lt;/li>
&lt;li>è®“æ‰€æœ‰çš„å˜—è©¦æœ‰é€£çµï¼š
ç¿»è­¯ã€Šå–®å…ƒæ¸¬è©¦çš„è—è¡“ã€‹ï¼Œæ”¯æ’ä¼æ¥­å…§è¨“èˆ‡åŸ¹è¨“èª²çš„å…§å®¹ / å…¬é–‹èª²å°æ–¼äº‹æ¥­çš„å¹«åŠ©ï¼Œå­¸å“¡æœƒå»å…¬å¸æ¨å‹•ï¼Œå¸¶ä¾†ä¼æ¥­å…§è¨“ + é¡§å•æ¡ˆçš„æ©Ÿæœƒ&lt;/li>
&lt;li>æ‰¾åˆ°é˜²ç·šï¼š
ç¢ºä¿è‡ªå·±æœ‰åº•ç·šï¼Œæœ‰ç¬¬ä¸€é–“é¡§å•æ¡ˆéˆ¦å¦ï¼Œä¹‹å¾Œæ‰å¥½è«‡åº•åƒ¹ï¼Œè‡ªå·±ä¹Ÿä¸æœƒæ…Œ&lt;/li>
&lt;li>æ°¸é ç•™æ™‚é–“ä¿æŒå˜—è©¦ï¼š
æ‰¾åˆ°ç¬¬äºŒé–“é¡§å•æ°¸è±é‡‘ / å­¸ç¿’æ–°èªè¨€ Pythonï¼Œè—‰ç”±å®¢æˆ¶æ‹“å±•è¦–é‡ï¼Œå›é¥‹åˆ°å…¬é–‹èª²ç¨‹ / ç¤¾ç¾¤çš„å…§å®¹ä¸­&lt;/li>
&lt;li>ç‚ºå¸‚å ´å¸¶ä¾†åƒ¹å€¼ï¼š&lt;br>
è§€å¯Ÿå¸‚å ´çš„å‹•å‘ï¼Œä»¥è§£æ±ºä¼æ¥­å•é¡Œç‚ºç›®æ¨™&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h2 id="è·æ¶¯æˆé•·">è·æ¶¯æˆé•·&lt;/h2>
&lt;h3 id="1-job">1. Job&lt;/h3>
&lt;ol>
&lt;li>&lt;code>æ™‚é–“æ˜¯æœ€è²´çš„&lt;/code>ï¼šå¦‚ä½•è¡¡é‡è‡ªå·±çš„åƒ¹å€¼ï¼Ÿ 91 è¡¨ç¤ºç¯€çœè€é—†çš„æ™‚é–“ / ç¯€çœåœ˜éšŠçš„æ™‚é–“å°±æ˜¯ä½ çš„åƒ¹å€¼&lt;/li>
&lt;li>&lt;code>ç”¨æ™‚é–“è³ºæ™‚é–“&lt;/code>ï¼šé€éå·¥å…· / æå‡æŠ€èƒ½ç­‰è³ºæ›´å¤šçš„æ™‚é–“ï¼Œæ‰èƒ½æŒçºŒæå‡è‡ªå·±çš„åƒ¹å€¼&lt;/li>
&lt;li>&lt;code>è·¨å‡ºå»æŒçºŒå­¸ç¿’&lt;/code>ï¼šæŒ‘å…¬å¸æ™‚é¸æ“‡é–‹æ”¾é€æ˜ï¼ŒæŠŠæ–°çš„æ–¹æ³•å¸¶å›å…¬å¸ï¼Œç”¨æ™‚é–“è³ºæ™‚é–“ (å‘¼æ‡‰ä¸Šä¸€é»)&lt;/li>
&lt;li>å‘ä¸Šæºé€šï¼šæŒçºŒèˆ‡ä¸Šå¸å³æ™‚åŒæ­¥ï¼Œå–å¾—å…±è­˜&lt;/li>
&lt;/ol>
&lt;h3 id="2-work">2. Work&lt;/h3>
&lt;ol>
&lt;li>&lt;code>æ‰¾æ„›&lt;/code>ï¼šé€™æ˜¯é•·æœŸæŠ•è³‡ï¼ŒåŸæœ¬ 91 å¾ˆè¨å­å‹•æ…‹èªè¨€ï¼Œä½†ä»–è¦ºå¾—æ‡‰è©²è¦å˜—è©¦éæ‰èƒ½æ‰¹è©•ï¼Œæœ€å¾Œä¹Ÿå–œæ­¡ä¸Š Pythonã€Ruby ç­‰ï¼Œè¦è©¦éæ‰çŸ¥é“&lt;/li>
&lt;li>&lt;code>ç¶œæ•ˆ&lt;/code>ï¼šæ‰¾æ„›å¾Œé–‹å§‹æƒ³è¾¦æ³•é—œè¯ï¼Œä¾‹å¦‚å¸‚å ´ä¸Šé–‹ç™¼èˆ‡æ•æ·åŸ¹è¨“çš„éœ€æ±‚ï¼Œæœ‰æ•æ·æ•™ç·´ï¼Œä½†ä»–å€‘å¯èƒ½ä¸æ‡‚é–‹ç™¼ / åä¹‹äº¦ç„¶ï¼Œ91 å°±æŠŠå…©å€‹ä»–æ‰€æ„›çš„èˆˆè¶£çµåˆèµ·ä¾†ï¼Œåœ¨å¸‚å ´ä¸Šå°±åªèƒ½æ‰¾ä»–&lt;/li>
&lt;/ol>
&lt;h3 id="3-career">3. Career&lt;/h3>
&lt;ol>
&lt;li>å¤©èŠ±æ¿ &amp;gt; è–ªè³‡ï¼šé¸æ“‡ Yahoo è–ªè³‡å¾ˆä½ï¼Œä½†æ˜¯å¸¶ä¾†å¾ˆå¤§çš„æˆé•·ï¼ŒæŠŠé€™äº›æˆé•·çŒåœ¨ä¸‹ä¸€ä»½å·¥ä½œä¸Š&lt;/li>
&lt;li>ç”¨æˆæœæè¿°è‡ªæˆ‘ï¼Œè€Œä¸æ˜¯é¡¯æ“ºçš„ Titleï¼šæŒçºŒåœ¨ Job / Work è¼¸å‡ºï¼Œç”¨æˆæœèªªæœäººï¼Œå¾ŒçºŒ 91 å·¥ä½œéƒ½æ˜¯é‚€ç´„ï¼Œè€Œä¸ç”¨è‡ªå·±æŠ•&lt;/li>
&lt;/ol>
&lt;h3 id="4-values">4. Values&lt;/h3>
&lt;ol>
&lt;li>åˆå¿ƒï¼šæ“‡å…¶æ‰€æ„›&lt;/li>
&lt;li>äººè„ˆï¼šä½ å¯ä»¥å¹«åŠ©åˆ°å¤šå°‘äººï¼Ÿ&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>æ˜¯å¦æœ‰èƒ½åŠ›å¹«åŠ©å…¶ä»–äººï¼Ÿ&lt;/li>
&lt;li>æ˜¯å¦æœ‰è¾¦æ³•çŸ¥é“å…¶ä»–äººç¾åœ¨æœ‰éœ€è¦å¹«å¿™ï¼Ÿ&lt;/li>
&lt;li>ç‚ºä»€éº¼ä»–äººè¦é¸æ“‡ä½ å¹«å¿™ï¼Ÿ&lt;br>
æ‰¾åˆ°è‡ªå·±åƒ¹å€¼çš„åŸºåº•&lt;/li>
&lt;/ul>
&lt;ol start="3">
&lt;li>è‡ªç”±ï¼šé¸æ“‡çš„è‡ªç”± / ä¸éœ€è¦æ“”å¿ƒåˆ¥äººç«¶çˆ­èˆ‡å£“è¿« / å¥åº·&lt;/li>
&lt;/ol>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>æˆ‘è‡ªå·±æŠŠè¬›åº§æ‹†æˆå…©éƒ¨åˆ†ï¼Œä¸€å€‹æ˜¯æŠ€è¡“è€…çš„è·æ¶¯ç™¼å±• / ä¸€å€‹æ˜¯æŠ€è¡“è€…çš„æŠ€èƒ½è®Šç¾ï¼Œè‡ªå·±ç›®å‰å°ˆæ³¨æ–¼å‰è€…ï¼Œç¸½çµè‡ªå·±çš„å¿ƒå¾—&lt;/p>
&lt;ol>
&lt;li>æ™‚é–“æœ€è²´ï¼Œä¸æ–·çš„æƒ³å¦‚ä½•ç¯€çœè‡ªå·±çš„æ™‚é–“ / åœ˜éšŠçš„æ™‚é–“ / è€é—†çš„æ™‚é–“&lt;/li>
&lt;li>å¾å¸‚å ´éœ€æ±‚èˆ‡å•†æ¥­åƒ¹å€¼çš„è§’åº¦å»æ€è€ƒè‡ªæˆ‘è·æ¶¯ç™¼å±•&lt;/li>
&lt;li>å˜—è©¦æŠŠè‡ªå·±æ‰€ç†±æ„›çš„äº‹ç‰©è®Šç¾ï¼Œæƒ³æƒ³çœ‹å¦‚ä½•ç™¼æ®ç¶œæ•ˆ&lt;/li>
&lt;/ol></description></item><item><title>ã€ŠClean Coder ç„¡ç‘•çš„ç¨‹å¼ç¢¼ã€‹å¿ƒå¾—</title><link>https://yuanchieh.page/posts/2021/2021-01-26-clean-coder-%E7%84%A1%E7%91%95%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC%E5%BF%83%E5%BE%97/</link><pubDate>Tue, 26 Jan 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-01-26-clean-coder-%E7%84%A1%E7%91%95%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC%E5%BF%83%E5%BE%97/</guid><description>&lt;p>&lt;img src="https://yuanchieh.page/%27/post/2021/img/0126/cover.jpeg%27"
loading="lazy"
>&lt;/p>
&lt;p>Clean Code ç›¸ä¿¡å¾ˆå¤šäººéƒ½çœ‹éï¼Œæä¾›è»Ÿé«”ç•Œä¸€å€‹è‡ªæˆ‘å¯©æ€ç¨‹å¼ç¢¼å“è³ªçš„æ¨™ç«¿ï¼Œä¹Ÿè¢«è¨±å¤šå·¥ç¨‹å¸«å¥‰ç‚ºåœ­è‡¬ï¼Œé€™ä¸€æœ¬ Clean Coder æ›´å¤šè‘—é‡æ–¼&lt;code>èº«ç‚ºä¸€åå°ˆæ¥­äººå£«æ‰€éœ€å…·å‚™çš„å…§æ¶µ&lt;/code>ï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ç¨‹å¼ç¢¼&lt;/p>
&lt;p>Highlight å…©é»æˆ‘è¦ºå¾—è¢«é‡é‡æé†’çš„åœ°æ–¹ï¼Œä¸¦æå‡ºä¸€äº›è‡ªå·±çš„æƒ³æ³•&lt;/p>
&lt;h2 id="èªªä¸èˆ‡èªªæ˜¯">èªªã€Œä¸ã€èˆ‡èªªã€Œæ˜¯ã€&lt;/h2>
&lt;p>èº«ç‚ºå·¥ç¨‹å¸«ï¼Œéƒ½é‡é PM è‡¨æ™‚ä¾†çš„éœ€æ±‚ï¼Œä¸¦å¼·ç¡¬çš„è¦å£“ä¸€å€‹ä¸å¤ªåˆç†çš„æ—¥æœŸï¼Œåœ¨é€™ç¨®å£“åŠ›ä¸‹ï¼Œä¸è«–æ˜¯å‡ºæ–¼å–„æ„æˆ–æ˜¯æ‡¶å¾—çˆ­è¾¯ï¼Œæ˜¯å¦éƒ½æ›¾èªªéã€Œå¥½çš„æˆ‘è©¦è©¦ã€&lt;br>
å°æ–¼ç­”æ‡‰æ¥ä¸‹å·¥ä½œçš„å·¥ç¨‹å¸«è€Œè¨€ï¼Œã€Œè©¦è©¦ã€å°±æ˜¯ä»£è¡¨æœ‰å¯èƒ½åšåˆ°ï¼Œä½†æ˜¯ PM æœƒè§£è®€æˆã€Œå¥½çš„æ²’å•é¡Œã€&lt;br>
ç­‰åˆ°ä¸Šç·šæ—¥ä¾†è‡¨é–‹å¤©çª—ï¼Œèº«ç‚º PM è¦ºå¾—è¢«å·¥ç¨‹å¸«è€äº†ï¼Œè€Œå·¥ç¨‹å¸«ä¹Ÿå¾ˆç„¡è¾œçš„è¡¨ç¤ºã€Œå°±èªªè©¦è©¦è€Œå·²ã€ï¼Œé–‹å§‹è¸¢èµ·çš®çƒï¼Œé€™å°é›™æ–¹éƒ½æ˜¯å¾ˆä¸å°ˆæ¥­çš„è¡¨ç¾&lt;/p>
&lt;p>ç•¶æˆ‘å€‘è¦&lt;code>çµ¦äºˆæ‰¿è«¾æ™‚ï¼Œè«‹éå¸¸å°å¿ƒæˆ‘å€‘çš„æªè¾­&lt;/code>ï¼Œå¦‚æœå› ç‚ºå£“åŠ›å°±æ”¹å£èªªã€Œæˆ‘è©¦è©¦çœ‹ã€ï¼Œé‚£æ˜¯å¦ä»£è¡¨è‘—éå»çš„ä½ éƒ½åœ¨å·æ‡¶ï¼Œåœ¨å£“åŠ›ç›¸é€¼çš„æƒ…æ³ä¸‹åè€Œå¢åŠ å·¥ä½œç”¢èƒ½ï¼Ÿ&lt;br>
å¦‚æœé‚„æ˜¯ç…§æ—¢å®šçš„æ–¹å¼åšï¼Œé‚£æ‰€è¬‚çš„ã€Œå˜—è©¦ã€åˆæ˜¯åœ¨å˜—è©¦ä»€éº¼å‘¢ï¼Ÿ&lt;/p>
&lt;p>é€™è½èµ·ä¾†å¾ˆç†æƒ³åŒ–ï¼Œæˆ–è¨±æœƒå—¤ä¹‹ä»¥é¼»ï¼Œä½†åŠæ—©èªªä¸ï¼Œä¸¦å …å®ˆåº•ç·šï¼Œä¸è¦å› ç‚ºå£“åŠ›å°±æ”¾æ£„æ¸¬è©¦ï¼Œä¸è¦å› ç‚ºå£“åŠ›å°±æƒ³å¯«å‡ºæœ‰è‡­å‘³çš„ç¨‹å¼ç¢¼ï¼Œèº«ç‚ºå°ˆæ¥­äººå£«æ‡‰è©²æœ‰å°è‡ªå·±å·¥ä½œå“è³ªçš„ä¿è­‰ï¼Œè€Œä¸æ˜¯ä¸€æ˜§çš„é™ä½æ¨™æº–&lt;/p>
&lt;blockquote>
&lt;p>æˆ–è¨±æ›´å¥½çš„æ–¹å¼æ˜¯å°‡ä»»å‹™ç´°åˆ†ï¼Œåœ¨æ™‚é™å…§çµ¦å‡ºåˆç†çš„æˆæœï¼Œä¸¦è¦åŠƒæœªä¾†é€æ­¥å®Œæˆçš„æ™‚è¾°ï¼Œé‡åˆ°æ™‚è¾°å›°é›£æ‡‰å„˜æ—©åæ‡‰ï¼Œè€Œä¸æ˜¯æŠ±è‘—åƒ¥å€–çš„å¿ƒæ…‹ç¥ˆç¦±æˆ–æ˜¯å†·çœ¼çœ‹è‘—ä»»å‹™å¤±æ•—&lt;/p>
&lt;/blockquote>
&lt;p>ç•¶ç¢ºå®šè¦æ¥ä¸‹ä»»å‹™æ™‚ï¼Œè«‹ç¢ºä¿å†çµ¦äºˆã€Œæ˜¯ã€çš„æ‰¿è«¾æ™‚åŒ…å«ä¸‰å€‹æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>å£é ­ä¸Šèªªè‡ªå·±æœƒå»åš&lt;/li>
&lt;li>å¿ƒè£¡èªçœŸå°å¾…è‡ªå·±æ‰€åšå‡ºçš„æ‰¿è«¾&lt;/li>
&lt;li>çœŸçš„ä»˜è«¸è¡Œå‹•&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœç™¼ç¾æœ‰é€™äº›å¾µå…†ï¼Œé‚£å¤šåŠæ‰¿è«¾éƒ½æœƒè½ç©º&lt;/p>
&lt;ol>
&lt;li>éœ€è¦ / æ‡‰ç•¶ - æˆ‘å€‘éœ€è¦æœ‰äººå®Œæˆé€™é …äº‹æƒ…&lt;/li>
&lt;li>å¸Œæœ› / ä½†é¡˜ - ä½†é¡˜æˆ‘æœ‰æ™‚é–“å¹«ä½ è™•ç†&lt;/li>
&lt;li>è®“æˆ‘å€‘ (è€Œä¸æ˜¯ã€Œè®“æˆ‘ã€) - è®“æˆ‘å€‘ä¸€èµ·åšé€™é …ä»»å‹™&lt;/li>
&lt;/ol>
&lt;p>çœŸæ­£çš„æ‰¿è«¾ï¼Œæ‡‰ç•¶æ˜¯&lt;code>æ˜ç¢ºæŒ‡å‡ºè‡ªå·±å°‡è² è²¬é€™ä»¶äº‹æƒ…ï¼Œä¸¦çµ¦äºˆæ˜ç¢ºçš„æ™‚è¾°èˆ‡äº¤ä»˜å…§å®¹&lt;/code>&lt;/p>
&lt;p>é€™é»çœŸçš„å¾ˆæœ‰æ„Ÿï¼Œå°¤å…¶æ˜¯åšå¾Œç«¯ï¼Œæ™‚å¸¸è¦å”åŠ©å…¶ä»–åœ˜éšŠèª¿æŸ¥ API å‘¼å«ç´€éŒ„ / ä¼ºæœå™¨é‹ä½œç‹€æ³ / DB è³‡æ–™æŸ¥è©¢ç­‰ç‘£äº‹ï¼Œå¸¸å¸¸æœƒèªªã€Œå¥½çš„ï¼Œæˆ‘ç­‰ç­‰å¹«ä½ æŸ¥ã€ï¼Œä¸€æ–¹é¢æ­£äº‹ä¸€ç›´è¢«æ‰“æ–·æ•ˆç‡å·®ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå®¹æ˜“å¿˜è¨˜ç­”æ‡‰éçš„äº‹æƒ…ï¼Œå°è‡´æ•´å¤©å·¥ä½œå¾ˆå¿™å»ä¹Ÿæ²’æœ‰ä»€éº¼ç”¢å‡º&lt;/p>
&lt;p>å¾Œä¾†æˆ‘åšäº†ä¸€äº›èª¿æ•´&lt;/p>
&lt;ol>
&lt;li>ä¸Šç­ä¸€é–‹å§‹å°±ç”¨ç­†è¨˜æœ¬å¯«ä¸‹ä»Šå¤©è¦å®Œæˆçš„ä»»å‹™&lt;/li>
&lt;li>é–‹ç™¼é€”ä¸­æœ‰äººæ•² slack éœ€è¦å”åŠ©ï¼Œé™¤éäº‹æ…‹ç·Šæ€¥ï¼Œå¦å‰‡ç­‰ä»»å‹™åšåˆ°ä¸€å€‹éšæ®µå†å›è¦†&lt;/li>
&lt;li>æ¯å¤©åªæ¥å›ºå®šçš„ç‘£äº‹æ•¸é‡ï¼Œå…¶é¤˜çš„çµ¦äºˆæ˜ç¢ºæ™‚é–“å›è¦†(å¦‚éš”å¤©)&lt;/li>
&lt;/ol>
&lt;p>ç›¡å¯èƒ½ç¢ºä¿è‡ªå·±çš„ä»»å‹™æº–æ™‚ä¸”æœ‰å“è³ªäº¤ä»˜ï¼Œä¹‹é¤˜ä¹Ÿå”åŠ©å…¶ä»–åœ˜éšŠæˆå“¡çš„èª¿æŸ¥ï¼Œè®“è‡ªå·±çµ¦äºˆçš„æ‰¿è«¾æ˜¯æ­£é¢çš„&lt;/p>
&lt;h2 id="é ä¼°">é ä¼°&lt;/h2>
&lt;p>é ä¼°å·¥æ™‚æ˜¯ä¸€å€‹è »å¾®å¦™çš„è—è¡“ï¼ŒPM æœƒæ‹¿ä¸€å€‹ä¸æ˜¯å®Œå…¨æ˜ç¢ºçš„éœ€æ±‚ä¾†è©¢å•ä¸€å€‹é ä¼°çš„å·¥æ™‚ï¼Œé ä¼°ä¸æ˜¯æ‰¿è«¾ï¼Œå¸¶æœ‰è‘—ä¸€é»æ¨¡ç³Šçš„ç©ºé–“ï¼Œã€Œå¯èƒ½ä¸‰å¤©ï¼Ÿå¦‚æœæœ‰ç·Šæ€¥äº‹ä»¶å¯èƒ½è¦äº”å¤©ï¼Ÿã€æœªä¾†æœ‰è‘—å¤ªå¤šçš„ä¸ç¢ºå®šæ€§ï¼Œä½†æ˜¯é ä¼°èˆ‡è³‡æºå®‰æ’æ¯æ¯ç›¸é—œï¼Œä¸èƒ½å› ç‚ºé ä¼°ä¸æº–è€Œè®“ PM é›£ä»¥å®‰æ’é€²åº¦ï¼Œ&lt;code>è€Œå¾€å¾€å·¥ç¨‹å¸«æœ‰éåº¦æ¨‚è§€çš„ç‹€æ³ (ç¬‘&lt;/code>&lt;/p>
&lt;h3 id="pert-program-evaluation-and-review-technique">PERT (Program Evaluation and Review Technique)&lt;/h3>
&lt;p>ç¾è»åœ¨ 1957 å¹´ç™¼å±•æ½›è‰‡æ¥µåœ°èˆªè¡Œè¨ˆç•«æ™‚æ‰€è¨­è¨ˆçš„é ä¼°å·¥æ™‚æ–¹æ³•ï¼Œæ¡ç”¨ä¸‰å€‹æ•¸å€¼&lt;/p>
&lt;ol>
&lt;li>O ç•°å¸¸æ¨‚è§€ï¼šæ‰€æœ‰äº‹æƒ…éƒ½å¾ˆé †åˆ©çš„æƒ…æ³ä¸‹çš„å·¥æ™‚ï¼Œæ©Ÿç‡æ‡‰å°æ–¼ 1%&lt;/li>
&lt;li>N å¸¸è¦é ä¼°ï¼šæ©Ÿç‡ç™¼ç”Ÿæœ€é«˜çš„é ä¼°å·¥æ™‚&lt;/li>
&lt;li>P ç•°å¸¸æ‚²è§€ï¼šè€ƒé‡å„ç¨®ç½å®³å¦‚åœ°éœ‡ç­‰ï¼Œçµ¦äºˆæœ€æ‚²è§€çš„å·¥æ™‚é ä¼°ï¼Œæ©Ÿç‡æ‡‰å°æ–¼ 1%&lt;/li>
&lt;/ol>
&lt;p>å¾—å‡ºä¸Šé¢ä¸‰å€‹æ•¸å€¼å¾Œï¼Œå¯ä»¥ç”¨æ©Ÿç‡åˆ†æè¡¨ç¤º&lt;/p>
&lt;ol>
&lt;li>é ä¼°å®Œæˆå·¥æ™‚: u = (O+4N+P) / 6&lt;/li>
&lt;li>æ¨™æº–å·®ï¼Œç”¨ä¾†è¡¡é‡ä¸ç¢ºå®šæ€§ï¼š(P-O) / 6&lt;/li>
&lt;/ol>
&lt;h3 id="å¾·çˆ¾è²æ³•">å¾·çˆ¾è²æ³•&lt;/h3>
&lt;p>å‰›æ‰çš„ PERT æ˜¯ä¸€å€‹äººé ä¼°çš„å·¥æ™‚ï¼Œä½†æ˜¯æ›ä¸€å€‹äººå¯èƒ½æœƒçµ¦å‡ºä¸åŒçš„é ä¼°çµæœï¼Œä»°è³´åœ˜éšŠæˆå“¡çµ¦å‡ºä¸åŒçš„é ä¼°ï¼Œæœ€å¾Œé”æˆå…±è­˜ä¹Ÿæ˜¯ä¸€ç¨®æ–¹æ³•&lt;/p>
&lt;p>ä¸»æŒäººè«‹æ¯å€‹æˆå“¡åœ¨ä»–äººä¸çŸ¥é“çš„ç‹€æ³ä¸‹æ±ºå®šé ä¼°å·¥æ™‚ï¼Œæ™‚é–“åˆ°ä¸€èµ·äº®ç‰Œ(æ•¸æ‰‹æŒ‡ä¹‹é¡çš„)ï¼Œçœ‹å¤§å®¶æ˜¯å¦æœ‰å…±è­˜ï¼Œå¦‚æœæœ‰äººæœ‰å¾ˆå¤§çš„æ­§ç•°ï¼Œå‰‡é–‹å§‹è¨è«–åˆ†æ­§çš„ä¾æ“šï¼Œæ¥è‘—ä¸‹ä¸€è¼ªï¼Œç›´åˆ°å¤§å®¶çµ¦äºˆçš„è©•ä¼°éƒ½å·®ä¸å¤šæ‰çµæŸ&lt;/p>
&lt;p>å‡èšå…±è­˜ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€ç’°ï¼Œå°¤å…¶æ˜¯åœ˜éšŠåˆä½œä¸Šï¼Œå¾æ¯ä¸€å€‹äººè©•ä¼°å·¥æ™‚çš„ä¸åŒï¼Œå°±èƒ½å»çœ‹å‡ºå°æ–¼ç´°ç¯€èˆ‡å¯¦ä½œæƒ³æ³•ä¸Šçš„å·®ç•°ï¼Œå½Œå¹³é€™é¡çš„å·®ç•°å¯ä»¥è®“åœ˜éšŠåˆä½œæ›´é †æš¢&lt;/p>
&lt;h3 id="å¤§æ•¸å®šå¾‹">å¤§æ•¸å®šå¾‹&lt;/h3>
&lt;p>å°‡å¤§ä»»å‹™æ‹†è§£æˆå°ä»»å‹™å¾Œåœ¨ä¼°æ™‚æœƒæ¯”è¼ƒç²¾æº–ï¼Œä¸”ç¶“éæ‹†è§£å¯ä»¥æ›´ç†è§£ä»»å‹™çš„å„ç¨®é¢å‘&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>æ›¸ä¸­é‚„æœ‰è«‡å…¶ä»–é¢å‘å¦‚æ¸¬è©¦ / ç·´ç¿’ / å”ä½œç­‰ï¼Œç®—è »æœ‰è¶£çš„ä¸€æœ¬æ›¸ï¼Œæ˜ç¢ºæŒ‡å‡ºå°ˆæ¥­äººå£«çš„å€åˆ¥ï¼Œå…¶ä¸­èˆ‰çš„æ¡ˆä¾‹ä¹Ÿæ˜¯æ­·æ­·åœ¨ç›®ï¼Œå€¼å¾—åœ¨è·æ¶¯ä¸­æ™‚æ™‚å“å‘³&lt;/p></description></item><item><title>å¦‚ä½•æ‰“é€ å®‰å…¨çš„ production ready Node.js Docker Image</title><link>https://yuanchieh.page/posts/2021/2021-01-21-%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E5%AE%89%E5%85%A8%E7%9A%84-production-ready-node.js-docker-image/</link><pubDate>Thu, 21 Jan 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-01-21-%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E5%AE%89%E5%85%A8%E7%9A%84-production-ready-node.js-docker-image/</guid><description>&lt;p>è¦æ‰“é€ ä¸€å€‹ã€Œå¯ä»¥å‹•çš„ Docker Imageã€å¾ˆç°¡å–®ï¼Œåƒè€ƒ Node.js å®˜æ–¹æ–‡ä»¶ &lt;a class="link" href="https://node.js.org/en/docs/guides/node.js-docker-webapp/" target="_blank" rel="noopener"
>Dockerizing a Node.js web app&lt;/a> å°±å¯ä»¥ç”¢å‡ºä¸€å€‹å°‡è¿‘ &lt;code>1GB&lt;/code> çš„ Docker Image&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">FROM node:14
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Create app directory&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WORKDIR /usr/src/app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Install app dependencies&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># A wildcard is used to ensure both package.json AND package-lock.json are copied&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># where available (npm@5+)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY package*.json ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RUN npm install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If you are building your code for production&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># RUN npm ci --only=production&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Bundle app source&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY . .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EXPOSE &lt;span class="m">8080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CMD &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;node&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;server.js&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°±é–‹å§‹æƒ³&lt;/p>
&lt;ol>
&lt;li>é€™æ¨£å®‰å…¨å—ï¼Ÿ&lt;/li>
&lt;li>å¯ä»¥æ‰“é€ æ›´è¼•é‡ã€æ›´å¥½ ship çš„ Image å—ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>å¾Œä¾†æ‰¾åˆ°é€™ä¸€ç¯‡æ–‡ç« &lt;a class="link" href="https://snyk.io/blog/10-best-practices-to-containerize-node.js-web-applications-with-docker/" target="_blank" rel="noopener"
>10 best practices to containerize Node.js web applications with Docker&lt;/a>è¦ºå¾—ååˆ†å¯¦ç”¨ï¼Œä¹Ÿè§£æ±ºå®‰å…¨æ€§ä¸Šçš„ç–‘æ…®ï¼Œä»¥ä¸‹æ‘˜è¦é‡é»&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20210121/synk_docker.png"
loading="lazy"
alt="daily"
>&lt;/p>
&lt;h2 id="1-é¸æ“‡æ­£ç¢ºçš„-base-image-ä¸¦é€é-build-stage-ç²¾ç°¡ç”¢å‡º">1. é¸æ“‡æ­£ç¢ºçš„ Base Image ä¸¦é€é Build Stage ç²¾ç°¡ç”¢å‡º&lt;/h2>
&lt;blockquote>
&lt;p>tldr;&lt;/p>
&lt;ol>
&lt;li>æ¡ç”¨ alpine æˆ– -slim ç‰ˆæœ¬çš„ base image&lt;/li>
&lt;li>ç”¨ sha256 æŒ‡å®š base image ç‰ˆæœ¬é¿å…ç•°å‹•&lt;/li>
&lt;li>æ”¯æ´å¤šéšæ®µï¼Œå¯ä»¥å‰æœŸ build ç”¨æ¯”è¼ƒå¤§çš„ base imageï¼Œæœ€å¾Œç”¢å‡ºåœ¨ä½¿ç”¨ç²¾ç°¡çš„ base image&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">FROM node:latest AS build
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># --------------&amp;gt; The production image&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY --from&lt;span class="o">=&lt;/span>build /usr/src/app/node_modules /usr/src/app/node_modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/blockquote>
&lt;p>é€²å…¥ docker hub node.js å®˜æ–¹ imageï¼Œå¯ä»¥çœ‹åˆ°ç²ç…æ»¿ç›®çš„ç‰ˆæœ¬ï¼Œé™¤äº†å°æ‡‰ä¸åŒçš„ node.js ç‰ˆæœ¬ï¼Œåº•å±¤çš„ os å¯ä»¥åˆ†æˆå¹¾ç¨®&lt;/p>
&lt;ol>
&lt;li>stretch: åŸºæ–¼ debian 9&lt;/li>
&lt;li>bulter: åŸºæ–¼ debian 10&lt;/li>
&lt;li>alpine: åŸºæ–¼ alpine linux&lt;/li>
&lt;/ol>
&lt;p>å¦ç™½èªªç›®å‰é‚„ä¸å¤ªç†è§£ debian 9 / 10 çœŸæ­£çš„å·®ç•°ï¼Œè€Œ alpine linux ç›®æ¨™æ˜¯æ‰“é€ æœ€è¼•é‡çš„ container osï¼Œæœ€å¤§å·®ç•°åœ¨æ¡ç”¨ musl libc å–ä»£ glibcï¼Œå¦‚æœä½¿ç”¨çš„ js å¥—ä»¶æœ‰åˆ©ç”¨åˆ° libc å¯èƒ½æœƒæœ‰å•é¡Œ&lt;/p>
&lt;p>è€Œå¸¶æœ‰ &lt;code>-slim&lt;/code> çµå°¾å‰‡æ˜¯ä»£è¡¨è©² image æ˜¯æœ€è¼•é‡å¯é‹è¡Œ Node.js çš„ container osï¼Œä¹Ÿæ˜¯å®˜æ–¹å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒæ¡ç”¨&lt;br>
ä¾‹å¦‚èªª &lt;code>node:14.15.4-stretch å°ºå¯¸ 942MB&lt;/code> vs &lt;code>node:14.15.4-stretch-slim å°ºå¯¸ 167MB&lt;/code>ï¼Œå‰è€…é€£ build å·¥å…·éƒ½æœ‰åŒ…å«å¦‚ python / node-gyp ç­‰ï¼Œé€™å°è‡´å°ºå¯¸å·®ç•°éå¸¸å·¨å¤§&lt;br>
å®‰è£è¶Šå¤šå·¥å…·çš„ Imageï¼Œå°è‡´çš„æ½›è—æ€§å®‰å…¨æ¼æ´å°±è¶Šå¤šï¼Œæ‰€ä»¥æ­£å¼ç’°å¢ƒé‹è¡Œç›¡é‡æ¡ç”¨ slim ç‰ˆæœ¬&lt;/p>
&lt;p>æ‰€ä»¥æœ€æ£’çš„æ˜¯åœ¨ç¬¬ä¸€éšæ®µæ¡ç”¨å®Œæ•´ Image æ–¹ä¾¿ build node_modulesï¼Œæœ€å¾Œéšæ®µç”¢å‡ºç”¨ç²¾ç°¡ Image ç¢ºä¿é‹è¡Œæ™‚æ²’æœ‰å¤šé¤˜çš„å·¥å…·&lt;/p>
&lt;h2 id="2-ç¢ºä¿åªå®‰è£-production-éœ€è¦çš„-node-modules-ä¸¦æŒ‡å®š-node_env-ç‚º-production">2. ç¢ºä¿åªå®‰è£ production éœ€è¦çš„ node modules ä¸¦æŒ‡å®š NODE_ENV ç‚º production&lt;/h2>
&lt;blockquote>
&lt;p>é€é &lt;code>RUN npm ci --only=production&lt;/code> åªå®‰è£ dependencies è€Œæ²’æœ‰ dev_dependencies é–‹ç™¼ç”¨çš„å¥—ä»¶&lt;/p>
&lt;/blockquote>
&lt;p>npm ci èˆ‡ npm install çœ‹ä¼¼éƒ½åœ¨å®‰è£å¥—ä»¶ä½†æœ‰å¾ˆå¤§çš„å·®ç•°ï¼›&lt;br>
&lt;strong>npm ci&lt;/strong> åªè®€å– lock fileï¼Œä¸¦ç”¨ package.json åšæ¯”å°ï¼Œå¦‚æœ lock file èˆ‡ package.json ç‰ˆæœ¬ä¸åˆæœƒå™´å‡ºéŒ¯èª¤ï¼Œ&lt;code>æœ€é©åˆç”¨åœ¨è¦ç©©å®šä¸”å¼·ä¸€è‡´çš„å¥—ä»¶ç‰ˆæœ¬è¦æ±‚&lt;/code>&lt;br>
&lt;strong>npm install&lt;/strong> å‰‡æ˜¯è®€å– package.jsonï¼Œä¸¦é€é lock file åšå®‰è£çš„ç‰ˆæœ¬æŒ‡å®šï¼Œå¦‚æœæœ‰å¥—ä»¶æ²’æœ‰å‡ºç¾åœ¨ lock file ä¸­ï¼Œå‰‡ npm ç›´æ¥å®‰è£&lt;/p>
&lt;p>é‹è¡Œç’°å¢ƒï¼Œæ ¹æ“š Node.js çš„ä¸æˆæ–‡è¦å®šï¼Œè«‹æŒ‡å®š&lt;code>NODE_ENV=production&lt;/code>ï¼Œå„å€‹å¥—ä»¶éƒ½æœƒé‡å° production é€²è¡Œå„ªåŒ–ï¼Œå¦å¦‚æ–‡ä¸­èˆ‰ä¾‹ express.js æœƒåœ¨ç”Ÿç”¢ç’°å¢ƒåŠ å…¥é é¢ cache æ©Ÿåˆ¶&lt;/p>
&lt;h2 id="3-ä¸è¦ç”¨-root-é‹è¡Œ-container">3. ä¸è¦ç”¨ root é‹è¡Œ container!!&lt;/h2>
&lt;blockquote>
&lt;p>è¨˜å¾—åŠ å…¥ &lt;code>USER node&lt;/code> åˆ‡æ›ä½¿ç”¨è€…ï¼Œä¸¦è¨˜å¾— COPY æ™‚è¦çµ¦äºˆä½¿ç”¨è€…ç›¸å°æ¬Šé™ &lt;code>COPY --chown=node:node . /usr/src/app&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>é€™å¾ˆé‡è¦ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¿˜è¨˜ï¼Œçµ¦äºˆç”¨æˆ¶ä¸å¤šä¸å°‘çš„æ¬Šé™ä¸€ç›´æ˜¯å®‰å…¨æ€§çš„åŸºæœ¬æº–å‰‡ï¼Œé è¨­ docker container å…§æ˜¯ä»¥ root é‹è¡Œ processï¼Œä½†å¦‚æœä¸å°å¿ƒæ‡‰ç”¨ç¨‹å¼æœ‰æ¼æ´ï¼Œç”šè‡³æœ‰å¯èƒ½è®“é§­å®¢è·³è„« container context ç²å¾— host root æ¬Šé™&lt;/p>
&lt;h2 id="4-æ­£ç¢ºæ¥æ”¶ç¨‹åºä¸­æ–·äº‹ä»¶èˆ‡å„ªé›…åœ°é€€å‡º">4. æ­£ç¢ºæ¥æ”¶ç¨‹åºä¸­æ–·äº‹ä»¶èˆ‡å„ªé›…åœ°é€€å‡º&lt;/h2>
&lt;blockquote>
&lt;p>æ¡ç”¨ dump-init ç›´æ¥å•Ÿå‹• Node.js process&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">RUN apk add dumb-init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CMD &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;dumb-init&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;node&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;server.js&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸¦è¨˜å¾—åœ¨ Node.js ä¸­åµæ¸¬äº‹ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">process.on&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;SIGINT&amp;#39;&lt;/span>, closeGracefully&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">process.on&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;SIGTERM&amp;#39;&lt;/span>, closeGracefully&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/blockquote>
&lt;p>ä¼ºæœå™¨é•·æ™‚é–“é‹è¡Œæ™‚ï¼Œç¸½æœƒé‡åˆ°ç‰ˆæœ¬æ›´æ–°çš„æ™‚å€™ï¼Œæœ€ç†æƒ³çš„åšæ³•æ˜¯è®“ä¸­æ–·æµé‡ä¸¦è®“ç¨‹åºå®Œæˆå‰©é¤˜å·¥ä½œå¾Œå„ªé›…é€€å‡ºï¼Œä½†å¦‚æœæ¡ç”¨çš„æ–¹å¼éŒ¯èª¤ Docker Container æœƒç„¡æ³•æ”¶åˆ°ç³»çµ±ä¸­æ–·çš„äº‹ä»¶ &lt;code>SIGKILL&lt;/code> ã€&lt;code>SIGTERM&lt;/code> ç­‰&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯å¹¾ç¨®å¸¸è¦‹çš„ Container åŸ·è¡ŒæŒ‡ä»¤ï¼Œä½†åˆ†åˆ¥æœ‰ä¸€äº›å•é¡Œ&lt;/p>
&lt;h4 id="1-cmd-npm-start">1. CMD &amp;ldquo;npm&amp;rdquo; &amp;ldquo;start&amp;rdquo;&lt;/h4>
&lt;p>é€™æœƒé‡åˆ°å…©å€‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>é€é npm å•Ÿå‹• Node.js processï¼Œä½†æ˜¯ &lt;code>npm ä¸æœƒæ­£ç¢º pass æ‰€æœ‰çš„ç³»çµ±ä¸­æ–·åˆ° Node.js process ä¸Š&lt;/code>&lt;/li>
&lt;li>&lt;code>CMD &amp;quot;cmd&amp;quot; &amp;quot;params&amp;quot; ..&lt;/code> èˆ‡ &lt;code>CMD [&amp;quot;cmd&amp;quot;, &amp;quot;params&amp;quot;]&lt;/code> æ˜¯ä¸åŒçš„ï¼Œå‰è€…æ˜¯å…ˆå•Ÿå‹• shell å†å»åŸ·è¡Œå¾Œé¢çš„ cmdï¼›è€Œå¾Œè€…å‰‡æ˜¯ç›´æ¥åŸ·è¡Œ cmdï¼Œæœ€ç›´æ¥çš„å·®ç•°å°±æ˜¯ &lt;code>PID 1 æ˜¯ shell é‚„æ˜¯ cmd&lt;/code>ï¼Œé€é shell åŒæ¨£æœ‰å¯èƒ½ä¸æœƒæ”¶åˆ°å…¨éƒ¨çš„ç³»çµ±ä¸­æ–·&lt;/li>
&lt;/ol>
&lt;h4 id="2-cmd-node-indexjs">2. CMD [&amp;ldquo;node&amp;rdquo;, &amp;ldquo;index.js&amp;rdquo;]&lt;/h4>
&lt;p>å„ªåŒ–ä¸Šé¢çš„æŒ‡ä»¤ï¼Œæ”¹ç”±ç›´æ¥å•Ÿå‹• node.js å°‘äº† npm èˆ‡ shellï¼Œé€™æœƒé‡åˆ°å¦ä¸€å€‹å•é¡Œ &lt;code>linux å°æ–¼ PID 1 çš„ç¨‹åºæœ‰ç‰¹åˆ¥çš„è™•ç†&lt;/code>ï¼Œå› ç‚º PID 1 ä»£è¡¨æ­¤ç¨‹åºè¦è² è²¬ç³»çµ±çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥ Kernel æœƒæœ‰é¡å¤–çš„è™•ç†æ©Ÿåˆ¶ï¼Œå¯¦éš›çš„å½±éŸ¿æœ‰&lt;/p>
&lt;ol>
&lt;li>ä¸€èˆ¬çš„ç¨‹åºæ”¶åˆ° &lt;code>SIGTERM&lt;/code> å¾Œ Kernel æœƒæœ‰é è¨­çš„çµæŸè™•ç†ï¼Œä½†æ˜¯ &lt;code>PID 1 æ²’æœ‰é è¨­çµ‚æ­¢è™•ç†ï¼Œä¹Ÿå°±æ˜¯æ”¶åˆ°å¾Œæ²’æœ‰ä¸»å‹•é€€å‡ºå°±ä¸æœƒé€€å‡º&lt;/code>&lt;/li>
&lt;li>å¦‚æœæœ‰ orphan process æœƒè¢«ä¸»å‹•æ›è¼‰åˆ° PID 1 ä¹‹ä¸‹ï¼Œä½†ä¸€èˆ¬çš„ process ä¸æœƒå»è™•ç† orphan processï¼Œæœƒç•™ä¸‹å¾ˆå¤š zombie process&lt;/li>
&lt;/ol>
&lt;p>æ ¹æ“š Node.js Docker å°çµ„å»ºè­°ï¼Œä¸è¦è®“ Node.js é‹è¡Œåœ¨ PID 1 ä¸Š&lt;/p>
&lt;blockquote>
&lt;p>Node.js was not designed to run as PID 1 which leads to unexpected behaviour when running inside of Docker. For example, a Node.js process running as PID 1 will not respond to SIGINT (CTRL-C) and similar signals&lt;/p>
&lt;/blockquote>
&lt;h4 id="æœ€çµ‚è§£æ³•é€é-init-process-å†å»å•Ÿå‹•-nodejs">æœ€çµ‚è§£æ³•ï¼šé€é init process å†å»å•Ÿå‹• Node.js&lt;/h4>
&lt;p>æœ€å¾Œç”¨ dumb-initï¼Œé€™å¥—ç”± yelp é‡‹å‡ºçš„å•Ÿå‹• processï¼Œæœƒæ­£ç¢ºå°‡æ‰€æœ‰çš„ç³»çµ±ä¸­æ–·éƒ½ pass çµ¦æ‰€æœ‰çš„ child processï¼Œä¸¦ä¸”åœ¨é€€å‡ºæ™‚æ¸…é™¤æ‰€æœ‰çš„ orphan process&lt;/p>
&lt;p>&lt;a class="link" href="https://engineeringblog.yelp.com/2016/01/dumb-init-an-init-for-docker.html" target="_blank" rel="noopener"
>Introducing dumb-init, an init system for Docker containers&lt;/a>&lt;/p>
&lt;p>å¸‚é¢ä¸Šé‚„æœ‰ä¸åŒçš„é¸æ“‡ï¼Œå¯ä»¥åƒè€ƒæ­¤ç¯‡ &lt;a class="link" href="https://ahmet.im/blog/minimal-init-process-for-containers/" target="_blank" rel="noopener"
>Choosing an init process for multi-process containers&lt;/a>&lt;/p>
&lt;h2 id="5-æ­£ç¢ºè™•ç†-build-éšæ®µä½¿ç”¨çš„æ©Ÿæ•è³‡æ–™">5. æ­£ç¢ºè™•ç† Build éšæ®µä½¿ç”¨çš„æ©Ÿæ•è³‡æ–™&lt;/h2>
&lt;blockquote>
&lt;p>å–„ç”¨ multi stageï¼Œè®“æ©Ÿæ•è³‡æ–™ä¸è¦å¤–æ´©åœ¨ Image ç•¶ä¸­ï¼Œä¸¦ä½¿ç”¨ mount secret åŒæ­¥æ©Ÿæ•è³‡æ–™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">RUN --mount&lt;span class="o">=&lt;/span>&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>secret,id&lt;span class="o">=&lt;/span>npmrc,target&lt;span class="o">=&lt;/span>/usr/src/app/.npmrc npm ci --only&lt;span class="o">=&lt;/span>production
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/blockquote>
&lt;p>å¦‚æœæœ‰ä¸€äº›æ©Ÿæ•è³‡æ–™æ˜¯åœ¨ Building éšæ®µæ‰€éœ€è¦ï¼Œä¾‹å¦‚è¦å» private github æ‹‰ repo çš„ .npmrc ç­‰è³‡æ–™ï¼Œéœ€è¦è¢«å¦¥å–„è™•ç†ï¼Œå¸¸è¦‹çš„éŒ¯èª¤ç¤ºç¯„æœ‰&lt;/p>
&lt;ol>
&lt;li>hard code å¯«æ­»&lt;/li>
&lt;li>æ¡ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œåœ¨ docker build æ™‚æŒ‡å®šï¼Œä½†å¦‚æœç”¨ docker history é‚„æ˜¯æœƒè¢«ç™¼ç¾&lt;/li>
&lt;/ol>
&lt;p>å¥‡æ€ªçš„æ˜¯æˆ‘ä¸¦æ²’æœ‰åœ¨ Docker æ–‡ä»¶ &lt;a class="link" href="https://docs.docker.com/storage/bind-mounts/" target="_blank" rel="noopener"
>Use bind mounts&lt;/a> çœ‹åˆ° &amp;ndash;mount type=secret çš„èªªæ˜ï¼Œä½†ç¢ºå¯¦æœ‰åœ¨å®˜æ–¹æ•™å­¸çœ‹åˆ° &lt;a class="link" href="https://docs.docker.com/develop/develop-images/build_enhancements/" target="_blank" rel="noopener"
>Build images with BuildKit&lt;/a>&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>æœ€çµ‚çš„ç”¢å‡ºæœƒé•·é€™æ¨£&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># --------------&amp;gt; The build image&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FROM node:latest AS build
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WORKDIR /usr/src/app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY package-*.json /usr/src/app/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RUN --mount&lt;span class="o">=&lt;/span>&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>secret,id&lt;span class="o">=&lt;/span>npmrc,target&lt;span class="o">=&lt;/span>/usr/src/app/.npmrc npm ci --only&lt;span class="o">=&lt;/span>production
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># --------------&amp;gt; The production image&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FROM node:lts-alpine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RUN apk add dumb-init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ENV NODE_ENV production
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">USER node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WORKDIR /usr/src/app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY --chown&lt;span class="o">=&lt;/span>node:node --from&lt;span class="o">=&lt;/span>build /usr/src/app/node_modules /usr/src/app/node_modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY --chown&lt;span class="o">=&lt;/span>node:node . /usr/src/app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CMD &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;dumb-init&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;node&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;server.js&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>ã€å·¥ç¨‹å¸«çœ‹å•†æ¥­ã€‘é‡åŒ–è¡ŒéŠ·çš„æµé‡æ€ç¶­è¬›åº§å¿ƒå¾—</title><link>https://yuanchieh.page/posts/2021/2021-01-19-%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9C%8B%E5%95%86%E6%A5%AD%E9%87%8F%E5%8C%96%E8%A1%8C%E9%8A%B7%E7%9A%84%E6%B5%81%E9%87%8F%E6%80%9D%E7%B6%AD%E8%AC%9B%E5%BA%A7%E5%BF%83%E5%BE%97/</link><pubDate>Tue, 19 Jan 2021 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2021/2021-01-19-%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9C%8B%E5%95%86%E6%A5%AD%E9%87%8F%E5%8C%96%E8%A1%8C%E9%8A%B7%E7%9A%84%E6%B5%81%E9%87%8F%E6%80%9D%E7%B6%AD%E8%AC%9B%E5%BA%A7%E5%BF%83%E5%BE%97/</guid><description>&lt;blockquote>
&lt;p>æ­¤ç¯‡ç‚ºåƒåŠ å•†æ¥­æ€ç¶­å­¸é™¢ 2021 è¬›åº§ã€Šé‡åŒ–è¡ŒéŠ·ã€‹æ„Ÿæƒ³èˆ‡åæ€ï¼Œè¬›è€…æ˜¯ä¾†è‡ª KKday ç‡ŸéŠ·é•· Yukiï¼Œåˆ†äº«åœ¨å…¬å¸ç¶“ç‡Ÿæµé‡èˆ‡å•†æ¥­é–‹ç™¼çš„å¿ƒå¾—&lt;/p>
&lt;/blockquote>
&lt;h2 id="é‡åŒ–è¡ŒéŠ·çš„è¿·æ€">é‡åŒ–è¡ŒéŠ·çš„è¿·æ€&lt;/h2>
&lt;p>åœ¨å‚³çµ±è§€å¿µä¸­ï¼Œæœƒç›´è¦ºèªç‚ºæµé‡æœƒå¸¶ä¾†ç‡Ÿæ”¶ï¼Œç”šè‡³æŠŠæµé‡åˆ¶å®šç‚ºå…ˆè¡ŒæŒ‡æ¨™ï¼Œå»å¿½ç•¥äº†æµé‡çš„å“è³ªã€å¾ŒçºŒè³¼è²·è½‰æ›ã€ä¸åŒçš„å®¢æˆ¶çµ‚ç”Ÿåƒ¹å€¼ç­‰åˆ†æï¼Œå°è‡´çœ‹ä¼¼æ“æœ‰å¤§æµé‡ï¼Œç‡Ÿæ”¶å»ä¹Ÿä¸è¦‹èµ·è‰²ï¼Œä»¥ä¸‹ Yuki è€å¸«æ•´ç†äº†å¹¾ç¨®è¿·æ€&lt;/p>
&lt;h3 id="å‰µé€ æµé‡å°±æœ‰æ›´å¤šçš„ç”Ÿæ„">å‰µé€ æµé‡å°±æœ‰æ›´å¤šçš„ç”Ÿæ„ï¼Ÿ&lt;/h3>
&lt;h4 id="ä¸åˆ†è¡ŒéŠ·é€šè·¯ä¾†æº">ä¸åˆ†è¡ŒéŠ·é€šè·¯ä¾†æº&lt;/h4>
&lt;p>å¸¸è¦‹çš„é›»å•†ç¶²ç«™æœƒèˆ‡æŠ˜æ‰£ç¶²åˆä½œï¼Œå¸¶ä¾†æ›´å¤šçš„æ›å…‰ï¼Œ&lt;code>ä½†æ˜¯é€™æ¨£çš„æ›å…‰è·Ÿæµé‡å€¼å¾—å—ï¼Ÿ&lt;/code>è©¦æƒ³ä¸€èˆ¬æ¶ˆè²»è€…è¡Œç‚ºï¼Œåˆ°ç¶²ç«™æ‰¾åˆ°å•†å“å¾Œï¼Œæœƒå†å»æŠ˜æ‰£ç¶²æœå°‹æŠ˜æ‰£ç¢¼ï¼Œé€™æ¨£ç­‰åŒæ–¼å¤šäº†ä¸€æ¬¡æµé‡ï¼Œä½†ä¸€æ¨£åªæˆäº¤ä¸€ç­†ï¼Œé‚„è³ ä¸Šäº†æ¯›åˆ©&lt;br>
æ‰€ä»¥åœ¨ç²å–æµé‡çš„åŒæ™‚ï¼Œæ‡‰è©²å»é—œæ³¨æµé‡æœ¬èº«çš„å“è³ª&lt;/p>
&lt;h4 id="ä¸åˆ†ç”¢å“èˆ‡æ´»å‹•">ä¸åˆ†ç”¢å“èˆ‡æ´»å‹•&lt;/h4>
&lt;p>Yuki è€å¸«èˆ‰è‡ªå®¶ç¶²ç«™çš„ç¯„ä¾‹ï¼Œä¹‹å‰äº”æœˆå¤©æ¼”å”±æœƒé–€ç¥¨ç§’æ®ºï¼Œè©±é¡Œæ­£åœ¨é¢¨å£ä¸Šï¼Œä»–å€‘ä¹Ÿè¦åŠƒäº†ã€Œäº”æœˆå¤©æ¼”å”±æœƒæ¥é§æœå‹™ã€çš„å•†å“ï¼ŒæˆåŠŸç²å¾—å·¨å¤§çš„æµé‡ï¼Œä½†æ˜¯æ²’æœ‰ä»€éº¼æˆäº¤é‡ï¼Œå› ç‚ºç”¨æˆ¶å¤šåŠæ˜¯æƒ³è¦è²·æ¼”å”±æœƒé–€ç¥¨ï¼Œå³ä½¿è¢«é¨™é€²ä¾†ä¹Ÿå¾ˆå¿«å°±èµ°äº†&lt;br>
æ‰€ä»¥è«‹å°ç·¨å¯«æ¡ˆè¹­æµé‡å¾ˆç°¡å–®ï¼Œä½†å…¶å¯¦éƒ½æ²’æœ‰å¯¦éš›å¹«åŠ©ï¼Œé‚„ä¸å¦‚é–‹ç™¼æœ‰ç”¨çš„å•†å“&lt;/p>
&lt;h3 id="èˆ‰è¾¦è¡ŒéŠ·æ´»å‹•è®“èˆŠå®¢å›è³¼å°±èƒ½æ“æœ‰å…è²»æµé‡">èˆ‰è¾¦è¡ŒéŠ·æ´»å‹•è®“èˆŠå®¢å›è³¼ï¼Œå°±èƒ½æ“æœ‰å…è²»æµé‡&lt;/h3>
&lt;p>é›»å•†ç¶²ç«™ç¶“ç‡Ÿå¸¸æœƒé€éæŠ˜æ‰£ç­‰èˆ‰è¾¦è¡ŒéŠ·æ´»å‹•ï¼Œå¸Œæœ›å–šé†’æ²ˆç¡çš„èˆŠå®¢å›è³¼ï¼Œä½†å¦‚æœæ²’æœ‰ä»”ç´°å»è€ƒé‡æˆæœ¬ï¼Œå…¶å¯¦å–šé†’èˆŠå®¢çš„æˆæœ¬å¾€å¾€æ¯”ç²å–æ–°å®¢æˆæœ¬ä¾†å¾—é«˜&lt;/p>
&lt;h3 id="ç²å®¢æˆæœ¬èˆ‡ç²æµé‡æˆæœ¬æ²’æœ‰æœƒå“¡åƒ¹å€¼åˆ†æ">ç²å®¢æˆæœ¬èˆ‡ç²æµé‡æˆæœ¬æ²’æœ‰æœƒå“¡åƒ¹å€¼åˆ†æ&lt;/h3>
&lt;p>Yuki è€å¸«åœ¨åˆ†ææ•¸æ“šæ™‚ç™¼ç¾åˆ°ï¼Œç”¨æˆ¶çš„ç¬¬ä¸€ç­†è¨‚å–®å¦‚æœæ˜¯é«˜å–®åƒ¹ï¼Œé‚£ä»–å¾ŒçºŒçš„è¨‚å–®å¾€å¾€ä¹Ÿæ˜¯é«˜å–®åƒ¹ï¼Œçµ‚ç”Ÿæœƒå“¡åƒ¹å€¼æœƒæ˜¯ä¸€èˆ¬ç”¨æˆ¶çš„ 2 ~ 4 å€ä»¥ä¸Šï¼ é€™æ¨£çš„ç”¨æˆ¶å¾ˆæ˜é¡¯å°±å€¼å¾—æ›´é«˜çš„æˆæœ¬å»æ‹‰æ”&lt;br>
å¦‚æœæ²’æœ‰ä»”ç´°åˆ†ææœƒå“¡åƒ¹å€¼ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰ç”¨æˆ¶éƒ½æ··ç‚ºä¸€è«‡ï¼Œç”šè‡³&lt;code>è¨‚è£½éŒ¯èª¤çš„ KPI&lt;/code>ï¼Œæœƒå°è‡´æµé‡åšå¾—å¾ˆè¾›è‹¦ä¹Ÿä¸è¦‹èµ·è‰²&lt;/p>
&lt;h3 id="takeaway">Takeaway&lt;/h3>
&lt;h4 id="ä»¥ç”¢å“ç·šå»¶ä¼¸å‰µé€ èˆŠå®¢æµé‡èˆ‡åˆ†ç¾¤å›è³¼è€Œä¸æ˜¯é æŠ˜æ‰£">ä»¥ç”¢å“ç·šå»¶ä¼¸å‰µé€ èˆŠå®¢æµé‡èˆ‡åˆ†ç¾¤å›è³¼ï¼Œè€Œä¸æ˜¯é æŠ˜æ‰£ï¼&lt;/h4>
&lt;p>KKday ä¹‹å‰æ›¾åšéæ­è™èˆªæ³¡æº«æ³‰çš„æ´»å‹•ï¼Œç´¯ç©äº†ä¸€æ‰¹èˆªç©ºè¿·ç”¨æˆ¶ï¼Œå¾Œä¾†æ¨å‡ºæ˜Ÿå®‡å¾®æ—…è¡Œï¼Œé€™äº›è€ç”¨æˆ¶å°±å¾ˆè²·å–® /
å¦å¤–æœ‰ä¸€æ‰¹è¦ªå­ç”¨æˆ¶ï¼Œéå¾€å›ºå®šæœƒåœ¨å¯’æš‘å‡å‡ºåœ‹åº¦å‡ï¼Œä½†å› ç‚ºç–«æƒ…çš„é—œä¿‚æ ¹æœ¬ç„¡æ³•å‡ºåœ‹ï¼Œçµ¦äºˆå†å¤šçš„æŠ˜æ‰£æ²’ç”¨ï¼ŒKKday æ”¹ç‚ºèˆ‰è¾¦å¤ä»¤ç‡Ÿ/å†¬ä»¤ç‡Ÿï¼Œå°±å—åˆ°é€™ç¾¤è¦ªå­ç”¨æˆ¶çš„å–œæ„›
è¦åšå‡ºç”¨æˆ¶å–œæ„›çš„ç”¢å“æ‰èƒ½å¤ é›™è´&lt;/p>
&lt;h4 id="è¦è¿½æ±‚çš„ä¸æ˜¯æµé‡è€Œæ˜¯èƒ½å‰µé€ åƒ¹å€¼çš„æµé‡">è¦è¿½æ±‚çš„ä¸æ˜¯æµé‡ï¼Œè€Œæ˜¯èƒ½å‰µé€ åƒ¹å€¼çš„æµé‡ï¼&lt;/h4>
&lt;p>å¦‚åŒå…ˆå‰çš„åˆ†äº«ï¼Œé«˜åƒ¹å€¼çš„ç”¨æˆ¶ç²å–æˆæœ¬é€šå¸¸æœƒæ¯”è¼ƒé«˜ï¼Œè€Œä¸”è½‰æ›ç‡ä¹Ÿæœƒæ¯”è¼ƒä½ï¼Œä½†æ›ç®—çµ‚ç”Ÿåƒ¹å€¼å¾Œé‚„æ˜¯é é«˜æ–¼ä¸€èˆ¬ç”¨æˆ¶ï¼Œåƒè¬ä¸è¦ç”¨éŒ¯èª¤çš„ KPI å°è‡´éŒ¯èª¤çš„çµæœ&lt;/p>
&lt;h2 id="çœŸæ­£çš„æ©Ÿæœƒåœ¨è¡ŒéŠ·æ¼æ–—ä¹‹å¤–">çœŸæ­£çš„æ©Ÿæœƒåœ¨è¡ŒéŠ·æ¼æ–—ä¹‹å¤–&lt;/h2>
&lt;p>å‚³çµ±çš„è¡ŒéŠ·æ¼æ–—ï¼Œå­œå­œçŸ»çŸ»åœ¨å„ªåŒ–æ¯ä¸€å±¤çš„è½‰æ›ç•¶ä¸­ï¼Œä½† Yuki è€å¸«åˆ†äº«åˆ°å¾€å¾€æœ€å¤§çš„æ©Ÿæœƒéƒ½åœ¨é€™æ¼æ–—ä»¥å¤–ï¼Œä»¥ä¸‹æ˜¯å¹¾å€‹ KKday å˜—è©¦çš„æ–¹å‘&lt;/p>
&lt;h3 id="ip-åˆä½œ">IP åˆä½œ&lt;/h3>
&lt;p>KKday æ›¾çˆ­å–åˆ°é˜¿å¦¹å°æ±è·¨å¹´æ¼”å”±æœƒçš„åˆä½œæ–¹æ¡ˆï¼Œæ­é…åŒ…æ©Ÿ / æ©Ÿå ´æ¥é§ç­‰æœå‹™ï¼Œçµ„åˆæˆæ›™å…‰è·¨å¹´è¡Œç¨‹ï¼Œæ—¢æ­ä¸Šç†±é–€è©±é¡Œä¹Ÿè¿åˆå®¢æˆ¶éœ€æ±‚ï¼Œæ‰€ä»¥ä¸€æ¨å‡ºå°±ç§’æ®ºï¼Œå¾ŒçºŒå®¢æˆ¶ä¹Ÿçµ¦äºˆå¥½è©•ï¼Œå¾ŒçºŒä¹Ÿæ•²é–‹èˆ‡å…¶ä»–æ˜æ˜Ÿçš„æ¼”å”±æœƒåˆä½œæ©Ÿæœƒ&lt;/p>
&lt;blockquote>
&lt;p>ç›¸æ¯”æ–¼äº”æœˆå¤©æ¥é§è»Šçš„æ“¦é‚Šçƒï¼Œæå‡ºæœ‰è©±é¡Œåˆæœ‰çœŸæ­£éœ€æ±‚çš„å•†å“æ‰èƒ½é•·é•·ä¹…ä¹…&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨èˆ‡ IP åˆä½œéç¨‹ä¸­ï¼ŒYuki è€å¸«å¼·èª¿ &lt;code>ä¸è¦å¦„è‡ªè²è–„æƒ³èªªã€Œç‚ºä»€éº¼XXX é€™éº¼æœ‰åæ€éº¼æœƒæƒ³è·Ÿæˆ‘å€‘åˆä½œã€&lt;/code>ï¼Œå¥¹åœ¨éå»é€£çºŒèˆ‡å¤šå®¶ IP å¦‚ç¦æ–¯æ±½è»Š/ tomicaå°å¡è»Šåˆä½œç­‰ç­‰ï¼Œéƒ½æ¨å‡ºå¤šè´çš„å•†æ¥­åˆä½œæ¡ˆï¼Œæœ€æ£’çš„æ˜¯å°æ–¹æä¾›é™å®šå•†å“ï¼ŒåŒæ™‚ä¹Ÿæœƒå¹«å¿™å®£å‚³ï¼Œç”¨æˆ¶è²·å–®ä¹Ÿæœƒå¾ˆé–‹å¿ƒ&lt;/p>
&lt;h3 id="ç§‘æŠ€å·¥å…·çš„æ‡‰ç”¨">ç§‘æŠ€å·¥å…·çš„æ‡‰ç”¨&lt;/h3>
&lt;p>KKday è¦çµåˆè‡ªå®¶å•†å“ç”¢å‡ºå¤§é‡çš„æ–‡ç« æ¨å»£ï¼Œä½†è³‡æ–™çš„æ•´ç†/åœ–æ–‡æ’ç‰ˆç­‰ååˆ†è€—è²»äººåŠ›ï¼Œå¾Œä¾†å°±ç ”ç™¼ KKday æ™ºèƒ½å°å¹«æ‰‹ï¼Œé€é AI çˆ¬æ–‡ / è‡ªå‹•ç”¢ç”Ÿæ–‡æ¡ˆæœ€å¾Œå†ç”±è³‡æ·±ç·¨è¼¯å¯©æ ¸ç™¼å¸ƒï¼ŒåŠ é€Ÿæ—…éŠæ–‡ç« çš„ç™¼å¸ƒé€Ÿåº¦&lt;/p>
&lt;p>éç¨‹ä¹Ÿæåˆ°é€™æŠ€è¡“é–€æª»ä¸é«˜ï¼Œä½†å°±æ˜¯æä¾›å¾ˆæ£’çš„å•†æ¥­åƒ¹å€¼ï¼Œè§£æ±ºäº†çœŸå¯¦çš„å•é¡Œ&lt;/p>
&lt;h3 id="è½‰æ›ç‡è¿·æ€">è½‰æ›ç‡è¿·æ€&lt;/h3>
&lt;p>åªè¦ç™¼ç”Ÿæµé‡å¤§ã€è½‰æ›ç‡ä½ï¼Œé€šå¸¸ç›´è¦ºå°±æ˜¯è¦å» tune ä»‹é¢æå‡è½‰æ›ç‡ï¼Œä½†é€™å¾€å¾€é™·å…¥äº†æ€ç¶­çš„èª¤å€ï¼ŒYuki è€å¸«åˆ†äº«åˆ° KKday ä¸€å€‹æ¡ˆä¾‹ï¼Œç™¼ç¾éå¹´æœŸé–“çš„æ—¥æœ¬æŸä¸€å€‹æ´»å‹•çš„æµé‡å¾ˆå¥½ä½†è½‰å–®ç‡è¶…ä½ï¼Œä»”ç´°ç ”ç©¶æ‰ç™¼ç¾æ˜¯å°ç£å»æ—¥æœ¬ç©çš„éŠå®¢é»æ“Šï¼Œä½†æ˜¯åœ¨é¸æ“‡æ—¥æœŸæ™‚å°±é›¢é–‹äº†ï¼Œè¿½æŸ¥å¾Œçœ‹åˆ°æ˜¯å› ç‚ºæ´»å‹•çš„å‰ç½®æ—¥æœŸæ˜¯äº”å¤©ï¼Œå¦‚æœæ˜¯éŠå®¢ä¸å¤ªå¯èƒ½åœ¨æ—…éŠä¸­è²·äº”å¤©å¾Œçš„è¡Œç¨‹ï¼Œæœ€å¾Œçš„èª¿æ•´æ˜¯èˆ‡ä¾›æ‡‰å•†æ´½è«‡ï¼ŒæŠŠå‰ç½®æ—¥æœŸå£“ç¸®åˆ°ä¸€å¤©ï¼Œè½‰æ›ç‡ä¹Ÿå°±è·Ÿè‘—æå‡&lt;/p>
&lt;p>é€™å›æ‡‰åˆ°è€å¸«å¦ä¸€å€‹é‡é»&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>æœ€ç›´è¦ºçš„æ”¹å–„æ–¹æ¡ˆï¼Œå¾€å¾€åªåœ¨åˆæœŸæœ‰æ•ˆï¼Œéç›´è¦ºçš„æ©Ÿæœƒæ›´é¡¯å¾—çè²´&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>é€™é»éå¸¸æœ‰æ„Ÿï¼Œå› ç‚ºæˆ‘å€‘å…¬å¸ä¹Ÿæ˜¯åœ¨ä¸€å€‹æ™‚æœŸç˜‹ç‹‚çš„åœ¨å„ªåŒ– onboarding æµç¨‹ / è³¼è²·è½‰æ›ï¼Œä¸æ–·åœ¨çœ‹æ¯ä¸€å€‹ step é–“çš„æ•¸æ“šï¼Œç¢ºå¯¦ä¹Ÿåœ¨éç¨‹ä¸­å¾—åˆ°ä¸€å®šçš„æå‡ï¼Œä½†æ˜¯å¾ŒçºŒå°±é‡ä¸Šè²§é ¸ï¼Œæœ€çµ‚é‚„æ˜¯è¦æŒçºŒçš„å„ªåŒ–ç”¢å“/èª¿æ•´è³¼è²·æ–¹æ¡ˆï¼Œæ‰èƒ½è®“ç”¨æˆ¶é¡˜æ„è²·å–®&lt;/p>
&lt;p>å¥½åšçš„é€šå¸¸éƒ½åšéäº†(æ²’åšéç•¶ç„¶é‚„æ˜¯è¦åš)ï¼Œä½†è¦è¨˜å¾—ç”¢å“æœ¬èº«çš„å…§æ¶µæ‰æ˜¯çœŸæ­£çš„é•·é ä¹‹é“&lt;/p>
&lt;h2 id="å¦‚ä½•å¸¶é ˜åœ˜éšŠ">å¦‚ä½•å¸¶é ˜åœ˜éšŠ&lt;/h2>
&lt;p>ğŸ‘ &lt;strong>åˆ¥åªå•æ•¸å­—&lt;/strong> &lt;br>
å¦‚æœä¸»ç®¡åªéå•æ•¸å­—ï¼Œä¸åœ¨ä¹éç¨‹ï¼Œé‚£æœ€å¾Œç”¢å‡ºä¸è¦‹å¾—æ˜¯æœ€ç†æƒ³çš„ï¼Œåƒæ˜¯æ´—å‡ºä½å“è³ªçš„æµé‡ &lt;br>
ğŸ‘ &lt;strong>åˆ¥é¼“å‹µåšå ±å‘Š&lt;/strong> &lt;br>
æ•¸å­—æ‡‰è©²å¯ä»¥è‡ªå·±å¾å ±è¡¨æª¢è¦–ï¼Œæ‡‰è©²è®“ä¸‹é¢çš„äººæœ‰æ›´å¤šæ€è€ƒèˆ‡è©¦éŒ¯çš„æ©Ÿæœƒ&lt;br>
ğŸ‘ &lt;strong>åšç­–ç•¥è¦æ¸…ç©ºè…¦è¢‹&lt;/strong> &lt;br>
ä¸è¦ç”¨é–‹æœƒå¡æ»¿å¤§å®¶çš„è¡Œç¨‹&lt;br>
ğŸ‘ &lt;strong>ç”¨è©¢å•ä»£æ›¿å»ºè­°&lt;/strong> &lt;br>
å› ç‚ºç®¡ç†éšå±¤çš„æ¬Šå¨æ„Ÿï¼Œå¯èƒ½çªç™¼å¥‡æƒ³çš„å»ºè­°å°±æœƒè¢«ä¸‹å±¬ç†è§£æˆåŸ·è¡Œæ–¹å‘(è¶…æœ‰æ„Ÿ)ï¼Œæ‡‰è©²ä»¥è©¢å•ä»£æ›¿å»ºè­°ï¼Œå¾ˆå¤šäº‹æƒ…ç¬¬ä¸€ç·šçš„å“¡å·¥åè€Œæ›´æ¸…æ¥š&lt;/p>
&lt;h2 id="ç¸½å›é¡§">ç¸½å›é¡§&lt;/h2>
&lt;ol>
&lt;li>æ–°å®¢æµé‡ï¼š&lt;br>
èƒ½è¢«å„ªåŒ–çš„å¤§å¤šéƒ½åšäº†ï¼Œè¦åšä¸€äº›æ„æƒ³ä¸åˆ°çš„çªç ´&lt;/li>
&lt;li>èˆŠå®¢å›è³¼ï¼š&lt;br>
é€éç”¢å“ç·šçš„å»¶ä¼¸ï¼Œè¿åˆç”¨æˆ¶çš„éœ€æ±‚è€Œéé€éæŠ˜æ‰£&lt;/li>
&lt;li>å¢åŠ åŠ©æ”»ï¼š &lt;br>
KKday æ•¸æ“šç ”ç©¶ç™¼ç¾ï¼Œç”¨æˆ¶åœ¨æ—…éŠå‰ 14 å¤©æœƒé–‹å§‹é€›ç¶²ç«™è²·è¡Œç¨‹ï¼Œè³¼è²·é€”ä¸­æœƒæœ‰ 7 å€‹é—œéµé»ï¼Œå¦‚ä½•åœ¨è³¼è²·æ—…ç¨‹ä¸­æ‰“å‹•ç”¨æˆ¶ï¼Œå°±è¦ä¸æ–·åœ°å»æ€è€ƒè·Ÿå˜—è©¦ï¼Œä¾‹å¦‚å¢åŠ åœ–ç‰‡/å½±ç‰‡çš„å“è³ªå¯ä»¥æå‡è½‰æ›ç­‰&lt;/li>
&lt;li>å¥åº·çš„æµé‡æ¨¡å‹ï¼š&lt;br>
åˆ†ç”¢å“/åˆ†æµé‡/åˆ†ç”¨æˆ¶åƒ¹å€¼ï¼Œæ‰èƒ½åˆ¶å®šæ­£ç¢ºçš„æµé‡ç­–ç•¥&lt;/li>
&lt;li>Martech:&lt;br>
åˆ©ç”¨ç¾æœ‰çš„å·¥å…·å„ªåŒ–è¡ŒéŠ·çš„æ–¹å¼&lt;/li>
&lt;/ol>
&lt;h2 id="è·å ´å¿ƒæ…‹">è·å ´å¿ƒæ…‹&lt;/h2>
&lt;p>åœ¨éç¨‹ä¸­ï¼ŒYuki è€å¸«æŒçºŒå¼·èª¿ &lt;code>è€é—†æ€ç¶­&lt;/code>ï¼Œä¸è¦åªè‘—çœ¼æ–¼è‡ªèº«çš„ KPI é”æˆï¼Œè€Œæ˜¯è¦æ›´è¿‘ä¸€æ­¥ç™¼æ®è‡ªèº«å½±éŸ¿åŠ›ï¼Œè©¦è‘—ç«™åœ¨è€é—†çš„è§’åº¦æ€è€ƒï¼Œçœ‹çœ‹å…¬å¸ç”¢å“é‚„æœ‰ä»€éº¼åœ°æ–¹å¯ä»¥æ”¹å–„ï¼Œè€Œä¸æ˜¯å—é™æ–¼è‡ªèº«çš„è·ä½&lt;/p>
&lt;p>ä½†åŒæ™‚è€å¸«ä¹Ÿæé†’ï¼Œç•¶è€é—†é‚„æ˜¯ç”¨èˆŠæœ‰çš„è§€å¿µæ™‚ï¼Œç›¡å¯èƒ½å…ˆè¿åˆè€é—†çš„éœ€æ±‚ï¼Œä¾‹å¦‚æµé‡ç¿»å€ï¼Œåœ¨éç¨‹ä¸­æœ‰å¯ä»¥æ–½åŠ›çš„åœ°æ–¹åœ¨ä½¿åŠ›ï¼Œæ…¢æ…¢çš„å°æ­£è§€å¿µï¼Œè€Œä¸æ˜¯ç›´æ¥åé§è€é—†ï¼Œé€™æ¨£æ‰æœ‰è½‰è®Šçš„æ©Ÿæœƒ&lt;/p>
&lt;h2 id="åæ€">åæ€&lt;/h2>
&lt;p>è½å®Œæ¼”è¬›ï¼Œåéä¾†æ€è€ƒå¹¾ä»¶äº‹æƒ…&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æˆ‘å€‘å…¬å¸æœ‰å®Œæ•´çš„ç”¨æˆ¶åƒ¹å€¼åˆ†æå—ï¼Ÿ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœè¦æœ‰å¹¾å€‹è©æè¿°æˆ‘å€‘å…¬å¸æœ€æœ‰åƒ¹å€¼çš„ç”¨æˆ¶ç¾¤æœƒæ€éº¼æè¿°å‘¢ï¼Ÿ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æˆ‘å€‘æœ‰å®Œæ•´çš„æµé‡æ¨¡å‹åˆ†æå—ï¼Ÿ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æˆ‘å€‘æœ‰åšä»€éº¼æµé‡æ¨å»£å—ï¼Ÿ&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>å›é¡§è‡ªå®¶å…¬å¸æ˜¯åš SaaSï¼Œå°ˆæ³¨æ–¼å–®ä¸€çš„ç”¢å“é–‹ç™¼ï¼Œæ‰€ä»¥ä¸åƒ KKday æ˜¯ä»¥å¹³å°çš„å½¢å¼ï¼Œæœ‰å¤§é‡çš„å•†å“èˆ‡åˆä½œæ¡ˆå¯ä»¥æ“ä½œï¼Œä½†æ˜¯å°æ–¼ç”¨æˆ¶è¼ªå»“èˆ‡åˆ†ç¾¤é€™éƒ¨åˆ†ä¹Ÿæ˜¯æœ‰åœ¨è‘—æ‰‹ï¼Œä¾‹å¦‚èªªæˆ‘å€‘æœƒåœ¨ onboarding æµç¨‹åŸ‹å…¥ç”¨æˆ¶çš„ç”¨é€”é¸å¡«ï¼Œè—‰æ­¤åˆ†ç¾¤ç”¨æˆ¶&lt;/p>
&lt;p>ä½†æœ‰è¶£çš„æ˜¯æˆ‘å€‘å…¬å¸ç”¨æˆ¶éä½ˆä¸–ç•Œå„åœ°ï¼Œç”¨æˆ¶çš„è³¼è²·è¡Œç‚º/è½‰æ›ç‡ç­‰å—åˆ°åœ‹æƒ…å½±éŸ¿æ¯”ç”¨æˆ¶ç”¨é€”å½±éŸ¿é‚„è¦å¤§ï¼Œæ‰€ä»¥åœ¨åšå¤§éƒ¨åˆ†è³¼è²·å¯¦é©—æ™‚éƒ½æ˜¯ä»¥åœ‹å®¶ç‚ºå€åˆ†&lt;/p>
&lt;p>è‡³æ–¼æµé‡è¿½è¹¤å¾ŒçºŒç”¨æˆ¶è½‰æ›çš„éƒ¨åˆ†ï¼Œå‰‡é‚„åœ¨è‘—æ‰‹é–‹ç™¼ä¸­ï¼Œä½†å…¥å£ç›¸å°ä¹Ÿå–®ç´”ï¼Œå¾ç¶²ç«™å°æµæˆ–æ˜¯ app store / play store æœå°‹ã€ä¸‹å»£å‘Šé€²ä¾†çš„ï¼ŒæŒçºŒè§€å¯Ÿæœƒä¸æœƒæœ‰ä»€éº¼è®ŠåŒ–å‡ºç¾&lt;/p></description></item><item><title>MySQL Deadlock å•é¡Œæ’æŸ¥èˆ‡è™•ç†</title><link>https://yuanchieh.page/posts/2020/2020-12-26_mysql-deadlock-%E5%95%8F%E9%A1%8C%E6%8E%92%E6%9F%A5%E8%88%87%E8%99%95%E7%90%86/</link><pubDate>Sat, 26 Dec 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-12-26_mysql-deadlock-%E5%95%8F%E9%A1%8C%E6%8E%92%E6%9F%A5%E8%88%87%E8%99%95%E7%90%86/</guid><description>&lt;p>å¯«äº†ä¸€å€‹ç°¡å–®çš„è³¼ç‰©æµç¨‹ SQLï¼Œåœ¨ä¸€å€‹ transaction ä¸­åŸ·è¡Œ&lt;/p>
&lt;ol>
&lt;li>è®€å– product è³‡è¨Šï¼š&lt;code>select * from product where id = 1&lt;/code>&lt;/li>
&lt;li>å¯«å…¥æ–°è¨‚å–® order ç‹€æ…‹: &lt;code>insert into orders (product_id) values (1)&lt;/code>&lt;/li>
&lt;li>æ›´æ–° product è²©å”®ç‹€æ…‹ï¼š&lt;code>update product set sold=1 where id = 1&lt;/code>&lt;br>
å…¶ä¸­ order table çš„ product_id æ˜¯å¼•ç”¨ product table çš„ id ç•¶åš foriegn keyï¼Œä¸¦åœ¨ä½µç™¼çš„æƒ…æ³ä¸‹åŸ·è¡Œï¼Œé–‹å§‹å¶ç„¶é‡åˆ° Deadlock&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Error&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">update&lt;/span> &lt;span class="err">`&lt;/span>&lt;span class="n">products&lt;/span>&lt;span class="err">`&lt;/span> &lt;span class="nb">set&lt;/span> &lt;span class="err">`&lt;/span>&lt;span class="n">sold&lt;/span>&lt;span class="err">`&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">34&lt;/span> &lt;span class="n">where&lt;/span> &lt;span class="err">`&lt;/span>&lt;span class="nb">id&lt;/span>&lt;span class="err">`&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;919&amp;#39;&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">Deadlock&lt;/span> &lt;span class="n">found&lt;/span> &lt;span class="n">when&lt;/span> &lt;span class="n">trying&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">get&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">try&lt;/span> &lt;span class="n">restarting&lt;/span> &lt;span class="n">transaction&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶ä¸‹è¦ºå¾—å¥‡æ€ªï¼Œç¬¬ä¸€å°è±¡ä¸­ Deadlock åªç™¼ç”Ÿåœ¨å…©å€‹ Transaction äº’ç›¸æ‰€éœ€çš„æ¬„ä½è€Œç„¡æ³•é‡‹æ”¾ï¼Œå¦‚&lt;/p>
&lt;ol>
&lt;li>T1: lock(r1) , wait(r2)&lt;/li>
&lt;li>T2: lock(r2), wait(r1)&lt;br>
ä½†æ˜æ˜æˆ‘å°±ä¸€ç¨® SQL ä½µç™¼åŸ·è¡Œï¼Œæ€éº¼ä¹Ÿæœƒæœ‰ Deadlock&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹é–‹å§‹æ’æŸ¥åŸå› &lt;/p>
&lt;h2 id="mysql-deadlock-èªªæ˜">MySQL Deadlock èªªæ˜&lt;/h2>
&lt;p>è®“æˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡ä»¶ &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-deadlocks.html" target="_blank" rel="noopener"
>15.7.5 Deadlocks in InnoDB&lt;/a>&lt;/p>
&lt;p>Deadlock ä¸»è¦æ˜¯å¤šå€‹ Transaction æ‰‹ä¸Šæ¡æœ‰å°æ–¹éœ€è¦çš„è³‡æºï¼Œåœ¨ç­‰å¾…è³‡æºé‡‹æ”¾çš„åŒæ™‚å»ä¹Ÿä¸æœƒé‡‹æ”¾æ‰‹ä¸Šçš„è³‡æºï¼Œå¸¸ç™¼ç”Ÿåœ¨ä½¿ç”¨ update å»é †åºå‰›å¥½ç›¸å&lt;br>
å¦‚æœ Deadlock æ•¸é‡å¾ˆå°‘ä¸å¤ªéœ€è¦æ“”å¿ƒï¼Œæ‡‰ç”¨ç¨‹å¼è¨˜å¾— retry å°±å¥½ï¼Œä½†å¦‚æœç™¼ç”Ÿå¾ˆé »ç¹å°±è¦æª¢æŸ¥ SQL çš„ç‹€æ³&lt;/p>
&lt;p>ç‚ºäº†ç›¡é‡æ¸›å°‘ Deadlock ç™¼ç”Ÿï¼Œå¯ä»¥æª¢æŸ¥ä»¥ä¸‹æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>ç›¡å¯èƒ½æ¸›å°‘ Update / Delete åœ¨å–®ä¸€ Transaction ä¸­çš„æ•¸é‡&lt;/li>
&lt;li>Lock æ™‚è«‹ä¾ç…§åŒæ¨£çš„é †åº (ä¾‹å¦‚ select &amp;hellip; for update)&lt;/li>
&lt;li>é™ä½ Lock çš„å±¤ç´šï¼Œé¿å… lock tables çš„æ“ä½œ&lt;/li>
&lt;li>è­¦æ…é¸æ“‡ indexï¼Œå› ç‚ºéå¤šçš„ index å¯èƒ½æœƒé€ æˆ deadlockï¼Œå¾ŒçºŒæœƒå†å±•é–‹æè¿°
&lt;blockquote>
&lt;p>InnoDB uses automatic row-level locking. You can get &lt;code>deadlocks even in the case of transactions that just insert or delete a single row&lt;/code>. That is because these operations are not really â€œatomicâ€; they automatically set &lt;code>locks on the (possibly several) index records&lt;/code> of the row inserted or deleted.&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>è€ƒæ…®é™ä½ isolation levelï¼Œé«˜å±¤ç´šçš„ &lt;code>isolation level æœƒå»æ”¹è®Š read çš„æ“ä½œ&lt;/code>ï¼Œä¾‹å¦‚ MySQL ä¸­ &lt;code>serializable å…¶å¯¦å°±æ˜¯éš±å¼æŠŠæ‰€æœ‰ select éƒ½åŠ ä¸Š lock for share&lt;/code>ï¼Œå¼•è‡ªæ–¼å®˜æ–¹æ–‡ä»¶ &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener"
>15.7.2.1 Transaction Isolation Levels&lt;/a>
&lt;blockquote>
&lt;p>This level is like REPEATABLE READ, but InnoDB implicitly converts all plain SELECT statements to SELECT &amp;hellip; FOR SHARE if autocommit is disabled.&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ol>
&lt;p>Deadlock detection é è¨­æ˜¯é–‹å•Ÿï¼Œä½†å¦‚æœåœ¨é«˜æµé‡ä¸‹æœƒæœ‰æ•ˆèƒ½çš„å½±éŸ¿ï¼Œå¦‚æœé æœŸ Deadlock ç‹€æ³ä¸å¤šå¯ä»¥æ”¹é€é &lt;code>innodb_deadlock_detect&lt;/code> é¸é …é—œé–‰ï¼Œç”¨ &lt;code>innodb_lock_wait_timeout&lt;/code> ä¸€ç›´ç­‰ä¸åˆ° lock ç™¼ç”Ÿ timeout è€Œè§¸ç™¼ rollback å–ä»£&lt;/p>
&lt;p>MySQL å¯ä»¥é€é SQL æŒ‡ä»¤ &lt;code>&amp;gt; SHOW ENGINE INNODB STATUS&lt;/code> çœ‹æœ€å¾Œä¸€ç­†ç™¼ç”Ÿ Deadlock çš„åŸå› ï¼Œæˆ–æ˜¯é–‹å•Ÿ &lt;code>innodb_print_all_deadlocks&lt;/code> æŠŠæ¯ä¸€æ¬¡ Deadlock åŸå› éƒ½è¼¸å‡ºåˆ° error log ä¸­&lt;br>
é–‹å•Ÿè¨­å®šçš„ SQL ç‚º &lt;code>&amp;gt; SET GLOBAL innodb_print_all_deadlocks=ON;&lt;/code>&lt;/p>
&lt;h2 id="å…·é«”çš„-deadlock-log">å…·é«”çš„ Deadlock log&lt;/h2>
&lt;p>ç•¶åœ¨æ‡‰ç”¨ç¨‹å¼ç™¼ç¾ deadlock éŒ¯èª¤å¾Œï¼Œå›åˆ° MySQL ä½¿ç”¨æŒ‡ä»¤æŸ¥çœ‹ï¼Œå¾—åˆ°ä»¥ä¸‹åŸå§‹ log&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">=====================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-12-26 00:10:16 0x7f9668490700 INNODB MONITOR OUTPUT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">=====================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Per second averages calculated from the last 29 seconds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BACKGROUND THREAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SEMAPHORES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LATEST DETECTED DEADLOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-12-26 00:05:14 0x7f9657cf9700
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (1) TRANSACTION:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TRANSACTION 14048, ACTIVE 1 sec starting index read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql tables in use 1, locked 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LOCK WAIT 11 lock struct(s), heap size 1136, 6 row lock(s), undo log entries 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MySQL thread id 54, OS thread handle 140283242518272, query id 45840 172.22.0.1 api-server updating
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update &lt;span class="sb">`products`&lt;/span> set &lt;span class="sb">`sold`&lt;/span> = 32 where &lt;span class="sb">`id`&lt;/span> = &amp;#39;919&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (1) HOLDS THE LOCK(S):
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table &lt;span class="sb">`online-transaction`&lt;/span>.`products` trx id 14048 lock mode S locks rec but not gap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 4; hex 00000397; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 0000000036d7; asc 6 ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 010000013f1e26; asc ? &lt;span class="ni">&amp;amp;;&lt;/span>;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 800000b1; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: len 4; hex 800000fe; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6: len 4; hex 80000020; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (1) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table &lt;span class="sb">`online-transaction`&lt;/span>.`products` trx id 14048 lock_mode X locks rec but not gap waiting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 4; hex 00000397; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 0000000036d7; asc 6 ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 010000013f1e26; asc ? &lt;span class="ni">&amp;amp;;&lt;/span>;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 800000b1; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: len 4; hex 800000fe; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6: len 4; hex 80000020; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) TRANSACTION:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TRANSACTION 14052, ACTIVE 1 sec starting index read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql tables in use 1, locked 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LOCK WAIT 11 lock struct(s), heap size 1136, 6 row lock(s), undo log entries 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MySQL thread id 57, OS thread handle 140283970258688, query id 45841 172.22.0.1 api-server updating
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update &lt;span class="sb">`products`&lt;/span> set &lt;span class="sb">`sold`&lt;/span> = 34 where &lt;span class="sb">`id`&lt;/span> = &amp;#39;919&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) HOLDS THE LOCK(S):
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table &lt;span class="sb">`online-transaction`&lt;/span>.`products` trx id 14052 lock mode S locks rec but not gap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 4; hex 00000397; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 0000000036d7; asc 6 ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 010000013f1e26; asc ? &lt;span class="ni">&amp;amp;;&lt;/span>;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 800000b1; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: len 4; hex 800000fe; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6: len 4; hex 80000020; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table &lt;span class="sb">`online-transaction`&lt;/span>.`products` trx id 14052 lock_mode X locks rec but not gap waiting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Record lock, heap no 259 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: len 4; hex 00000397; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1: len 6; hex 0000000036d7; asc 6 ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: len 7; hex 010000013f1e26; asc ? &lt;span class="ni">&amp;amp;;&lt;/span>;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3: len 21; hex 50726163746963616c204672657368204d6f757365; asc Practical Fresh Mouse;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: len 4; hex 800000b1; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5: len 4; hex 800000fe; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6: len 4; hex 80000020; asc ;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ge">**&lt;/span>* WE ROLL BACK TRANSACTION (2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TRANSACTIONS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FILE I/O
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INSERT BUFFER AND ADAPTIVE HASH INDEX
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LOG
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BUFFER POOL AND MEMORY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ROW OPERATIONS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">END OF INNODB MONITOR OUTPUT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">============================
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŒ‘å‡ºé‡é»ä¾†çœ‹&lt;/p>
&lt;ol>
&lt;li>&lt;code>LATEST DETECTED DEADLOCK&lt;/code> ä»¥ä¸‹é¡¯ç¤ºæœ€å¾Œä¸€æ¬¡ç™¼ç”Ÿçš„ Deadlockï¼Œæœ‰è¡¨è¿°äº’ç›¸æ­»é–çš„å…©ç­† Transaction &lt;code>*** (1) TRANSACTION:&lt;/code> èˆ‡ &lt;code>*** (2) TRANSACTION:&lt;/code>&lt;/li>
&lt;li>æ¥è‘—çœ‹åˆ°å…©ç­† Transaction æ‰‹ä¸Šæ¡æœ‰çš„ Lockï¼Œçœ‹å¾—å‡ºä¾†ä»–å€‘éƒ½æœ‰åŒä¸€è¡Œ product row çš„ lock mode S locks&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">RECORD LOCKS space id 3 page no 8 n bits 336 index PRIMARY of table &lt;span class="sb">`online-transaction`&lt;/span>.`products` trx id 14052 lock mode S locks rec but not gap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>æ¥è‘—ä»–å€‘åœ¨ç­‰å¾…çš„é–ç‚º&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="sb">`online-transaction`&lt;/span>.`products` trx id 14052 lock_mode X locks rec but not gap waiting
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç­”æ¡ˆå°±æ­¤æ­æ›‰ï¼Œå› ç‚ºå…©å€‹ Transaction æ‰‹ä¸Šéƒ½æ¡æœ‰ share lockï¼Œå¦‚æœè¦å–å¾— exclusive lock å‰‡å°æ–¹å¿…é ˆå…ˆé‡‹æ”¾ share lockï¼Œå› æ­¤é€ æˆ Deadlockï¼Œæœ€çµ‚çœ‹åˆ° Transaction 2 è¢« rollback äº†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">*** WE ROLL BACK TRANSACTION &lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Debug è³‡è¨Šä¹çœ‹å¾ˆå¤šï¼Œä½†ä»”ç´°çœ‹é‚„è »å¥½ç†è§£çš„&lt;/p>
&lt;h3 id="æ‰¾å‡ºå•é¡Œæ ¹æº">æ‰¾å‡ºå•é¡Œæ ¹æº&lt;/h3>
&lt;p>çŸ¥é“æ˜¯å› ç‚º shared lock å°è‡´å¾Œé¢çš„ exclusive lock æ­»é–çš„åŸå› ï¼Œå›é ­çˆ¬æŒ‡ä»¤çœ‹å“ªè£¡æœ‰å•é¡Œ&lt;/p>
&lt;p>é¦–å…ˆå®šä½åˆ° select fromï¼Œæ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼Œé™¤é isolation æ˜¯ serializableï¼Œå¦å‰‡ä¸€èˆ¬çš„ select from æ˜¯æ²’æœ‰ lock çš„ï¼Œå‡ºè™• &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-consistent-read.html" target="_blank" rel="noopener"
>15.7.2.3 Consistent Nonlocking Reads&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Consistent read is the default mode in which InnoDB processes SELECT statements in READ COMMITTED and REPEATABLE READ isolation levels. &lt;code>A consistent read does not set any locks&lt;/code> on the tables it accesses, and therefore other sessions are free to modify those tables at the same time a consistent read is being performed on the table.&lt;/p>
&lt;/blockquote>
&lt;p>æ—¢ç„¶ä¸æ˜¯ select é€ æˆï¼Œå«Œç–‘çŠ¯å°±è®Šæˆ insert order äº†ï¼Œorders table ä¸­çš„ product_id æ˜¯å¼•ç”¨ product table ä¸­çš„ id ç•¶ä½œ foreign keyï¼Œæœç„¶æ‰¾åˆ°ç›¸é—œçš„æè¿° &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html" target="_blank" rel="noopener"
>14.7.3 Locks Set by Different SQL Statements in InnoDB&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>If a FOREIGN KEY constraint is defined on a table, any insert, update, or delete that requires the constraint condition to be checked sets shared record-level locks&lt;/code> on the records that it looks at to check the constraint. InnoDB also sets these locks in the case where the constraint fails.&lt;/p>
&lt;/blockquote>
&lt;p>çœŸç›¸å¤§ç™½&lt;/p>
&lt;h3 id="å¦‚ä½•è§£æ±º">å¦‚ä½•è§£æ±º&lt;/h3>
&lt;p>åœ¨ SQL æœ€ä¸€é–‹å§‹ï¼Œå› ç‚ºç¯¤å®šæœƒæ”¹è®Š product æ¬„ä½ï¼Œç›´æ¥ä½¿ç”¨ &lt;code>select for update&lt;/code> ç”¨ exclusive lock é–ä½ï¼Œå°±è§£æ±ºå•é¡Œäº†&lt;br>
éœ€æ³¨æ„è¨­å®šæˆ &lt;code>serializable&lt;/code> é‚„æ˜¯æœ‰æ©Ÿæœƒç™¼ç”Ÿ Deadlock å–”ï¼Œå› ç‚ºåœ¨ MySQL ä¸­åªæ˜¯è¿½åŠ  select from çš„é–ï¼Œè€Œä¸æ˜¯çœŸçš„åƒ redis ä¸€æ¬¡åªé †åºåŸ·è¡Œä¸€é“æŒ‡ä»¤å–”&lt;/p>
&lt;h2 id="è£œå……è³‡æ–™---é—œæ–¼-mysql-lock">è£œå……è³‡æ–™ - é—œæ–¼ MySQL Lock&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.aneasystone.com/archives/2018/04/solving-dead-locks-four.html" target="_blank" rel="noopener"
>è§£å†³æ­»é”ä¹‹è·¯ï¼ˆç»ˆç»“ç¯‡ï¼‰ - å†è§æ­»é”&lt;/a> å¼·åŠ›æ¨è–¦é€™ç¯‡æ–‡ç« ï¼Œå¾Œä¾†èˆ‡åŒäº‹åœ¨å·¥ä½œä¸Šæ’æŸ¥æ­»é–ï¼Œç™¼ç¾ update å–®ç­†è³‡æ–™ç«Ÿç„¶ä¹Ÿæœ‰æ­»é–çš„ç‹€æ³ï¼Œæ‰çŸ¥é“ lock éœ€è¦é–å®šå°æ‡‰çš„ Index ä¸¦ä¸”åœ¨æ²’æœ‰å‘½ä¸­æ™‚æœƒä½¿ç”¨å€é–“é– (å¦‚æœ isolation level åœ¨ Repeatable Read ä»¥ä¸Š)ï¼Œé‚„æ˜¯æœ‰æ©Ÿæœƒé€ æˆæ­»é–&lt;/p>
&lt;p>é€éä¸Šè¿°çš„åƒè€ƒè³‡æ–™ï¼Œä¸¦é‡æ–°ç¿»é–± MySQL æ–‡ä»¶ï¼Œæ•´ç†äº†å¦ä¸€ç¯‡ &lt;a class="link" href="https://yuanchieh.page/post/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"
>ã€MySQLã€‘Lock èˆ‡ Index é—œä¿‚å’Œ Deadlock åˆ†æ&lt;/a>&lt;/p></description></item><item><title>UUID åŸç†èˆ‡å¯¦ä½œåˆ†æ - è©²å¦‚ä½•æŒ‘é¸é©åˆçš„ UUID ç‰ˆæœ¬</title><link>https://yuanchieh.page/posts/2020/2020-12-01-uuid-%E5%8E%9F%E7%90%86%E8%88%87%E5%AF%A6%E4%BD%9C%E5%88%86%E6%9E%90-%E8%A9%B2%E5%A6%82%E4%BD%95%E6%8C%91%E9%81%B8%E9%81%A9%E5%90%88%E7%9A%84-uuid-%E7%89%88%E6%9C%AC/</link><pubDate>Tue, 01 Dec 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-12-01-uuid-%E5%8E%9F%E7%90%86%E8%88%87%E5%AF%A6%E4%BD%9C%E5%88%86%E6%9E%90-%E8%A9%B2%E5%A6%82%E4%BD%95%E6%8C%91%E9%81%B8%E9%81%A9%E5%90%88%E7%9A%84-uuid-%E7%89%88%E6%9C%AC/</guid><description>&lt;p>UUID æ˜¯ä¸€å€‹è¢«å¤§é‡ä½¿ç”¨çš„æ¼”ç®—æ³•ï¼Œåˆ†æ•£å¼åœ°ç”¢ç”Ÿå¤§é‡&lt;code>ä¸é‡è¤‡ä¸”å›ºå®šç‚º 128 bit&lt;/code>çš„ IDï¼Œåˆ†æ•£å¼æ˜¯æŒ‡èªªå¤šå°æ©Ÿå™¨æ¯ç§’åŒæ™‚ç”¢ç”Ÿå¤šç­† UUIDï¼Œæœ‰æ¥µå¤§æ¦‚ç‡é€™äº› UUID éƒ½ä¸æœƒç™¼ç”Ÿé‡è¤‡ï¼Œä¸éœ€è¦æœ‰ä¸€å°æ©Ÿå™¨å±…ä¸­è² è²¬ ID çš„ç®¡æ§èˆ‡ç™¼æ”¾ï¼Œåä¾‹åƒæ˜¯ MySQL è³‡æ–™åº«ä¸­çš„ auto increment id&lt;/p>
&lt;p>å…ˆæé‡é»ï¼Œå¦‚ä½•é¸æ“‡ UUID v1 ~ v5ï¼Œåƒè€ƒ &lt;a class="link" href="https://stackoverflow.com/questions/20342058/which-uuid-version-to-use" target="_blank" rel="noopener"
>Which UUID version to use?&lt;/a>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>v4&lt;/strong>: å®Œå…¨éš¨æ©Ÿï¼Œæ²’æœ‰ç‰¹æ®Šéœ€æ±‚é¸é€™å€‹ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ &lt;code>77%&lt;/code> ç”¨æˆ¶é¸æ“‡é€™å€‹&lt;/li>
&lt;li>&lt;strong>v1&lt;/strong>: çµ„æˆåŒ…å« timestamp èˆ‡æ©Ÿå™¨è­˜åˆ¥ç¢¼(MAC Address)ï¼Œå¦‚æœéœ€è¦è­˜åˆ¥ç”±å“ªä¸€å°æ©Ÿå™¨åœ¨ä»€éº¼æ™‚é–“é»ç”¢ç”Ÿå¯ä»¥é¸é€™å€‹ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ &lt;code>21%&lt;/code> ç”¨æˆ¶é¸æ“‡é€™å€‹&lt;/li>
&lt;li>&lt;strong>v5 &amp;amp; v3&lt;/strong>: å¯ä»¥æŒ‡å®š Namespace èˆ‡ Nameï¼Œç›¸åŒçš„ Namespace èˆ‡ Name æœƒç”¢ç”Ÿç›¸åŒçš„ UUIDï¼Œv3 é›·åŒ v5ï¼Œå·®åˆ¥åœ¨æ–¼ v5 æœƒæ¡ç”¨ SHA1 ç•¶ä½œ Hash function è€Œ v3 æ¡ç”¨ MD5ï¼Œé™¤äº†ç›¸å®¹æ€§ç­‰è€ƒé‡ï¼Œå¦å‰‡è«‹å„ªå…ˆæ¡ç”¨ v5ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ &lt;code>1%&lt;/code> ç”¨æˆ¶é¸æ“‡é€™å€‹&lt;/li>
&lt;li>&lt;strong>v2&lt;/strong>: ä¸æ¡ç”¨ï¼Œé€£ RFC æ–‡ä»¶ä¹Ÿåªæœ‰å¸¶åˆ°å®šç¾©ï¼Œæ²’æœ‰å¯¦ä½œè¦ç¯„&lt;/li>
&lt;/ol>
&lt;p>éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ &lt;a class="link" href="https://github.com/uuidjs/uuid" target="_blank" rel="noopener"
>uuid.js&lt;/a> çš„ v1ï¼Œuuid å¯¦ä½œæ˜¯æ²’æœ‰æ¡ç”¨ MAC Addressï¼Œæ‰€ä»¥å¦‚æœæœ‰è­˜åˆ¥åŒä¸€å°æ©Ÿå™¨ç”¢ç”Ÿçš„ uuid çš„éœ€æ±‚ï¼Œéœ€è¦è‡ªå·±å¦å¤–å¯¦ä½œï¼Œå¾Œé¢æœ‰æ›´è©³ç›¡çš„è£œå……&lt;/p>
&lt;p>ä»¥ä¸‹å°‡æ‘˜è¦ &lt;a class="link" href="https://tools.ietf.org/html/rfc4122" target="_blank" rel="noopener"
>RFC 4122 - A Universally Unique IDentifier (UUID) URN Namespace &lt;/a>ï¼Œä¸¦æ¯”å°æ¯é€±æœ‰å°‡è¿‘å››ç™¾è¬ä¸‹è¼‰çš„ uuid.js å¯¦ä½œï¼Œæœ‰è©¢å•ä½œè€…ä¸€äº›ç´°ç¯€ï¼Œä»–ä¹Ÿéå¸¸ç†±å¿ƒè£œå……å¾ˆå¤šæœ‰æ£’çš„è³‡æ–™ï¼Œæœƒä¸€ä¸¦æ•´ç†åˆ†äº«&lt;/p>
&lt;h2 id="rfc-4122">RFC 4122&lt;/h2>
&lt;p>UUID å…±æœ‰ 128 bitsï¼Œä»¥ä¸‹æ˜¯ v1 å¯¦ä½œè¦ç¯„&lt;/p>
&lt;h3 id="412--layout-and-byte-order">4.1.2. Layout and Byte Order&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201201/uuid.png"
loading="lazy"
>&lt;br>
ä»¥ä¸‹å°‡ä»‹ç´¹æ¯å€‹æ¬„ä½çš„çµ„æˆ&lt;/p>
&lt;h3 id="413--version">4.1.3. Version&lt;/h3>
&lt;p>UUID ç‰ˆæœ¬å¤¾åœ¨ time_hi_and_version æœ€é«˜æ•ˆä½å…ƒ(most significant)ä¸­ 4~7 bitï¼Œæ‰€ä»¥å¾ UUID string å°±èƒ½çœ‹å‡ºç‰ˆè™Ÿ&lt;/p>
&lt;h3 id="414--timestamp">4.1.4. Timestamp&lt;/h3>
&lt;p>Timestamp ç¸½å…±æ˜¯ 60 bitsï¼Œå°æ–¼ UUID v1 ä¾†èªªæ˜¯ UTC æ™‚é–“ä¸”è‡ª 1582/10/15 00:00:00 (the date of Gregorian reform to the Christian calendar) é–‹å§‹è¨ˆç®—ï¼Œå¦‚æœæ©Ÿå™¨æ²’æœ‰ UTC æ™‚é–“ï¼Œå¯ä»¥æ¡ç”¨ local timeï¼Œä½†æ˜¯è¦ç¢ºä¿ local time æ˜¯ç©©å®šçš„&lt;/p>
&lt;h3 id="415--clock-sequence">4.1.5. Clock Sequence&lt;/h3>
&lt;p>å¦‚æœç³»çµ±æ™‚é–“ç™¼ç”Ÿå€’è½‰ï¼Œæˆ–æ˜¯ Node ID ç™¼ç”Ÿæ”¹è®Šï¼Œå‰‡æœƒå¢åŠ ç¢°æ’çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥é€é Clock Sequence ä¾†ç´€éŒ„ï¼Œå¦‚æœç™¼ç¾ç”¢ç”Ÿéçš„ UUID æ¡ç”¨çš„ Timestamp æ¯”ç•¶ä¸‹çš„æ™‚é–“é‚„è¦æ™šæ™‚ (æ„å³ Clock æ™‚é–“è¢«å€’è½‰)ï¼Œå‰‡ clock sequence éå¢ï¼Œåˆå§‹åŒ–å‰‡éš¨æ©Ÿç”¢ç”Ÿ&lt;/p>
&lt;p>å¦å¤–å¦‚æœ Node ID ç™¼ç”Ÿæ”¹è®Šï¼Œé‚£æœ€å¥½ä¹Ÿå°‡ clock sequence éš¨æ©Ÿé‡ç½®ï¼Œé™ä½ç¢°æ’çš„é¢¨éšª&lt;/p>
&lt;p>éœ€æ³¨æ„ clock sequence çš„è¨­å®šæœ€å¥½æ˜¯åœ¨ç³»çµ±å•Ÿå‹•å¾Œè¨­å®šä¸€æ¬¡å°±ä¸è¦å†æ”¹è®Šï¼Œé™ä½è·¨ç³»çµ±ç”¢ç”Ÿç¢°æ’çš„é¢¨éšª&lt;/p>
&lt;h3 id="416--node">4.1.6. Node&lt;/h3>
&lt;p>Node ID æ¡ç”¨ &lt;code>IEEE 802 MAC address&lt;/code>ï¼Œå¦‚æœæœ‰å¤šå€‹ MAC Address ä»»ä¸€æŒ‘ä¸€å€‹æœ‰ç”¨çš„å³å¯ï¼Œå¦‚æœæ²’æœ‰å‰‡éš¨æ©Ÿç”¢ç”Ÿ&lt;/p>
&lt;p>ä»¥ä¸Šæ˜¯ v1 çš„æ¬„ä½æ„ç¾©ï¼Œv3ã€v5 å‰‡æ˜¯æŠŠ Name åŠ ä¸Š Namespace å–é›œæ¹Šï¼Œæ¥è‘—åˆ†é…è‡³ä¸Šè¿°çš„æ¬„ä½ä¸­ï¼Œv4 å‰‡å…¨éƒ¨éš¨æ©Ÿç”¢ç”Ÿ&lt;/p>
&lt;h3 id="421--basic-algorithm">4.2.1. Basic Algorithm&lt;/h3>
&lt;p>æ¥è‘—çœ‹æœ€åŸºæœ¬çš„æ¼”ç®—æ³•å¯¦ä½œæµç¨‹&lt;/p>
&lt;ol>
&lt;li>å–å¾—ç³»çµ±ç´šåˆ¥çš„å…¨åŸŸé–&lt;/li>
&lt;li>è®€å–ç³»çµ±è¨­å®šæª”ï¼ŒåŒ…å« clock_seq / node id / timestamp&lt;/li>
&lt;li>è¨ˆç®—å‡º timestamp&lt;/li>
&lt;li>å–å¾— node id&lt;/li>
&lt;li>å¦‚æœä¿å­˜ node id èˆ‡è®€å–çš„ node id ä¸åŒï¼Œé‡æ–°è¨­å®š clock_seq&lt;/li>
&lt;li>ç•¶å‰ timestamp å°æ–¼ä¿å­˜çš„ timestampï¼Œclock_seq + 1&lt;/li>
&lt;li>å°‡ç›®å‰è¨ˆç®—çš„å€¼ä¿å­˜å›å»&lt;/li>
&lt;li>é‡‹æ”¾é–&lt;/li>
&lt;li>å°‡ç›®å‰çš„ timestamp / clock_seq / node id çµ„åˆå‡º uuid&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœè¦é«˜é »ç‡è£½é€  uuidï¼Œæœƒé‡åˆ°ä»¥ä¸‹å¹¾å€‹æ•ˆèƒ½è²§é ¸èˆ‡å°æ‡‰è§£æ³•&lt;/p>
&lt;ol>
&lt;li>&lt;code>æ¯æ¬¡å­˜ç³»çµ±è®€å–è³‡æ–™å¾ˆæ²’æ•ˆç‡&lt;/code>:&lt;br>
åƒ…éœ€è¦å†ç³»çµ±å•Ÿå‹•æ™‚è®€å–ä¸€æ¬¡é€² memory å³å¯ï¼Œå‡è¨­ç³»çµ±æ²’æœ‰ç©©å®šå„²å­˜ç©ºé–“ï¼Œå‰‡æ¯æ¬¡éƒ½è¦éš¨æ©Ÿç”¢ç”Ÿ clock_seqï¼Œé€™æœƒå°è‡´ç¢°æ’æ©Ÿç‡å¢åŠ ï¼Œæ‡‰è©²è¦ç›¡é‡é¿å…ï¼›å¦‚æœç¢ºå®š node id éƒ½ä¸æœƒè®Šï¼Œä¹Ÿå¯ä»¥ä¸ç”¨ä¿å­˜ç›´æ¥è¿”å›å³å¯&lt;/li>
&lt;li>&lt;code>system clock ç²’åº¦ä¸è¦‹å¾—æœ‰åˆ° 100-nanoseconds&lt;/code>:&lt;br>
System Clock Resolutionï¼šå¦‚æœç”¢ç”Ÿé »æ¬¡ä¸é«˜ï¼Œå‰‡ç›´æ¥å°‡ç³»çµ±æ™‚é–“æ”¾å¤§åˆ° 100-nano çš„ç²’åº¦å³å¯ï¼Œä½†å¦‚æœç³»çµ±å–®ä¸€æ™‚é–“ç”¢ç”Ÿéå¤š uuidï¼Œå¯¦ä½œå¿…é ˆè¿”å›éŒ¯èª¤ï¼Œæˆ–æ˜¯æš«åœç”¢ç”Ÿï¼Œç›´åˆ°ç³»çµ±æ™‚é–“æ­£å¸¸ï¼Œå¦‚æœè¦æé«˜ç²’åº¦ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨åŒä¸€å€‹ç³»çµ±æ™‚é–“å…§ç´¯è¨ˆç”¢ç”Ÿçš„ uuid å€‹æ•¸ï¼Œ&lt;/li>
&lt;li>&lt;code>æ¯æ¬¡è¦å›å¯«ç³»çµ±è³‡æ–™å¾ˆæ²’æ•ˆç‡&lt;/code>&lt;br>
åªéœ€è¦å®šæ™‚æ›´æ–°å„²å­˜è³‡æ–™å³å¯ï¼Œå°‡ timestamp è¨­å®šåœ¨æ¯”è‡³ä»Šç”¢ç”Ÿçš„ UUID ä½¿ç”¨çš„ timestamp å¤§ä¸€é»ï¼Œä½†åˆä¸è¦å¤§åˆ°è¶…é reboot æ™‚çš„æ‰€éœ€è¦çš„å•Ÿå‹•æ™‚é–“ï¼Œç›®çš„åœ¨æ–¼é™ä½ clock sequence é‡ç½®çš„æ©Ÿæœƒï¼Œåœ¨ä¸‹æ–¹çš„å»ºè­°å¯¦ä½œä¸­æ˜¯æ¯ 10 ç§’å¯«å…¥ä¸€æ¬¡&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">next_save&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">fopen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;state&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;wb&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">fwrite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">st&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span> &lt;span class="n">st&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">fclose&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* schedule next save for 10 seconds from now */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">next_save&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timestamp&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>&lt;code>è·¨é€²ç¨‹åˆ†äº«ç‹€æ…‹å¾ˆæ²’æ•ˆç‡&lt;/code>&lt;br>
å¦‚æœè·¨é€²ç¨‹å…±äº«ç‹€æ…‹å¾ˆè€—è³‡æºï¼Œå¯ä»¥æ¯å€‹é€²ç¨‹åˆ‡å‰²ä¸€å¡Šæ™‚é–“å€æ®µå€‹åˆ¥ç”¢ç”Ÿ uuid ï¼Œç›´åˆ°æ™‚é–“å€æ®µç”¨å®Œæ‰å»è¦æ–°çš„&lt;/li>
&lt;/ol>
&lt;h3 id="43--algorithm-for-creating-a-name-based-uuid">4.3. Algorithm for Creating a Name-Based UUID&lt;/h3>
&lt;p>v3 è·Ÿ v5 ä¸»è¦æ˜¯åœ¨æŸä¸€ç‰¹å®šçš„ Namespace ä¸‹é‡å° Name ç”¢ç”Ÿå°æ‡‰çš„ UUIDï¼Œæœ‰ä»¥ä¸‹ç‰¹æ€§&lt;/p>
&lt;ol>
&lt;li>ç›¸åŒçš„ namespace ç›¸åŒçš„ nameï¼Œä¸åŒç³»çµ±æ™‚é–“ä¸€æ¨£æœ‰ç›¸åŒçš„ uuid&lt;/li>
&lt;li>ç›¸åŒ namespace ä¸‹ä¸åŒ nameï¼Œuuid ä¸åŒ&lt;/li>
&lt;li>ç›¸åŒ name ä¸åŒ namespaceï¼Œuuid ä¸åŒ&lt;/li>
&lt;li>å¦‚æœå…©å€‹ uuid ç›¸åŒï¼Œå‰‡ä»£è¡¨ namespace / name ç›¸åŒ&lt;/li>
&lt;/ol>
&lt;p>UUID æ¬„ä½å‰‡æ˜¯é€é Name + Namespace é›œæ¹Šå¾Œçš„å€¼å»æ´¾ç™¼&lt;/p>
&lt;h3 id="45--node-ids-that-do-not-identify-the-host">4.5. Node IDs that Do Not Identify the Host&lt;/h3>
&lt;p>å¦‚æœ MAC Address ä¸èƒ½ä½¿ç”¨ï¼Œæœ‰å¹¾ç¨®åšæ³•èƒ½ä¿è­‰ Node ID çš„ç¨ä¸€æ€§&lt;/p>
&lt;ol>
&lt;li>å»è·Ÿ IEEE è²è«‹ç¨ç«‹å€æ®µçš„ä½å€ï¼Œåœ¨æ–‡ä»¶ç·¨å¯«æ™‚æœŸåƒ¹æ ¼æ˜¯ US$550&lt;/li>
&lt;li>ä½¿ç”¨å¯†ç¢¼å­¸å¼·åº¦çš„éš¨æ©Ÿç¢¼å–æœ€ä½ä½ 47 bitï¼Œæœ€é«˜ bit è¨­å®šç‚º 1ï¼Œä¸»è¦æ˜¯é¿é–‹ IEEE ä¸­ MAC Address çš„å€æ®µ
&lt;blockquote>
&lt;p>å¸¸è¦‹åšæ³•æ˜¯åœ¨ buffer ä¸­éš¨æ©Ÿç´¯ç©ä¸€æ®µè³‡æ–™ï¼Œæ¥è‘—ç”¨ SHA1 æˆ– MD5 å– 48 bitsï¼Œç„¶å¾ŒæŠŠæœ€é«˜ bit è¨­å®šç‚º 1&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ol>
&lt;h3 id="6--security-considerations">6. Security Considerations&lt;/h3>
&lt;p>UUID ä¸¦ä¸ä¿è­‰éš¨æ©Ÿæ€§ï¼Œæ‰€ä»¥ä¸æœƒå¾ˆé›£çŒœï¼Œæ‰€ä»¥ä¸èƒ½æ‹¿ä¾†åšè·Ÿå®‰å…¨æ€§æœ‰é—œçš„æ¥­å‹™&lt;/p>
&lt;blockquote>
&lt;p>Do not assume that UUIDs are hard to guess&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥ä¸Šå¤§æ¦‚æŒ‘å€‹é‡é»å¸¶é&lt;/p>
&lt;h2 id="uuidjs-å¯¦ä½œæ‹†è§£">uuid.js å¯¦ä½œæ‹†è§£&lt;/h2>
&lt;p>ä»¥ä¸‹å°‡é–±è®€&lt;a class="link" href="https://github.com/uuidjs/uuid" target="_blank" rel="noopener"
>uuid.js github repo&lt;/a>çš„åŸå§‹ç¢¼ï¼Œåœ¨é–‹å§‹çœ‹ v1~v5 çš„å¯¦ä½œå‰ï¼Œå…ˆçœ‹ä¸€å€‹ç”¨æ–¼ç”¢ç”Ÿéš¨æ©Ÿæ•¸çš„é‡è¦å‡½å¼ &lt;a class="link" href="https://github.com/uuidjs/uuid/blob/master/src/rng.js" target="_blank" rel="noopener"
>rng.js&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">crypto&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s1">&amp;#39;crypto&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">rnds8Pool&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Uint8Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">256&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// # of random values to pre-allocate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">poolPtr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">rnds8Pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="k">default&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">rng&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">poolPtr&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nx">rnds8Pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">crypto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">randomFillSync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rnds8Pool&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">poolPtr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">rnds8Pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">slice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">poolPtr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">poolPtr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¨‹å¼ç¢¼å¾ˆçŸ­ï¼Œä¸»è¦å°±æ˜¯ç”¢ç”Ÿä¸€å€‹ rnds8Pool é™£åˆ—ï¼Œéš¨æ©Ÿå¡å…¥æ•¸å€¼ï¼Œæœ€å¾Œæ¯æ¬¡å›å‚³ 16 bitï¼Œå¦‚æœé€™ä¸€æ®µ rnds8Pool éƒ½å›å‚³äº†ï¼Œå°±åœ¨ä¸€æ¬¡ç”¢ç”Ÿæ–°çš„éš¨æ©Ÿäº‚æ•¸&lt;/p>
&lt;p>é€™å¯ä»¥ä¿è­‰ç”¢ç”Ÿ &lt;code>Generates cryptographically strong pseudo-random data.&lt;/code>ï¼Œä¾†è‡ª Nodejs å®˜æ–¹æ–‡ä»¶çš„ä¿è­‰ï¼Œä¹Ÿæ˜¯ uuid ä¸æœƒæœ‰é«˜ç¢°æ’æ©Ÿç‡çš„ä¿è­‰ï¼Œåˆ‡è¨˜ Math.random ä¸è¶³å¤ éš¨æ©Ÿï¼Œæ‹¿ä¾†ä½¿ç”¨å•é¡Œæœƒå¾ˆå¤š&lt;/p>
&lt;h3 id="uuid-v1-å¯¦ä½œ">UUID v1 å¯¦ä½œ&lt;/h3>
&lt;p>ä»¥ä¸‹æŒ‘é‡é»èªªï¼Œä¸å¾—ä¸èªªä½œè€…çš„ç¨‹å¼ç¢¼ä»¥åŠè¨»è§£å¯«å¾—å¾ˆä¹¾æ·¨ï¼Œç›´æ¥æ¨™æ˜å¯¦ä½œå°æ‡‰çš„ RFC æ®µè½&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">seedBytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rng&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">rng&lt;/span>&lt;span class="p">)();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…ˆç”¢ç”Ÿéš¨æ©Ÿæ•¸å‚™ç”¨ï¼Œåœ¨å‰é¢æ–‡ä»¶ä»‹ç´¹ä¸­ï¼Œæœ‰ç”¨åˆ°éš¨æ©Ÿç”¢ç”Ÿçš„éƒ½æœƒå¾ seedBytes ä¸­æå–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">_nodeId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mh">0x01&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™è£¡å¯ä»¥çœ‹åˆ°ï¼Œå¯¦ä½œä¸­çš„ &lt;code>node_idæ˜¯æ¯æ¬¡å•Ÿå‹•æ™‚éš¨æ©Ÿç”¢ç”Ÿ&lt;/code>ï¼Œé€™ç¬¦åˆæ–‡ä»¶ 4.1.6ï¼Œæ²’æœ‰æ¡ç”¨ MAC Address è‡ªå·±äº‚æ•¸ç”¢ç”Ÿä¹Ÿå¯ä»¥ï¼›&lt;br>
åŒæ™‚é€™ä¸€æ®µæˆ‘æœ‰ç‰¹åˆ¥ç•™ä¸€å€‹ Issue è©¢å•ä½œè€…ï¼Œç‚ºä»€éº¼ä¸ç…§æ–‡ä»¶è¦ç¯„å»æ‹¿æ©Ÿå™¨çš„ MAC Addressï¼Œä»–å›ç­”åˆ°&lt;code>åŸºæ–¼éš±ç§å•é¡Œ&lt;/code>ï¼Œè€Œä¸”å¦‚æœ Node ID è·Ÿ Clock Seq æ¯æ¬¡éƒ½éš¨æ©Ÿç”¢ç”Ÿä¹Ÿæ˜¯ç¬¦åˆæ–‡ä»¶è¦ç¯„çš„&lt;/p>
&lt;blockquote>
&lt;p>I believe that this comes close to the idea of the spec while avoiding the privacy problems that come with trying to derive a stable node ID from hardware.&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">clockseq&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Per 4.2.2, randomize (14 bit) clockseq
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">clockseq&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">_clockseq&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="nx">seedBytes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x3fff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ²’æœ‰ clockseq å°±äº‚æ•¸ç”¢ç”Ÿ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Per 4.2.1.2 Throw error if too many uuids are requested
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">nsecs&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;uuid.v1(): Can&amp;#39;t create more than 10M uuids/sec&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœå¯¦ä½œè€…ç™¼ç¾çŸ­æ™‚é–“å…§æœ‰å¤ªå¤§é‡çš„ uuid ç”¢ç”Ÿï¼Œéœ€è¦æ‹‹å‡ºéŒ¯èª¤æˆ–æ˜¯æš«åœ uuid ç”Ÿæˆé¿å…ç¢°æ’&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// `time_low`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">tl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nx">msecs&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xfffffff&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10000&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">nsecs&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mh">0x100000000&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tl&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">24&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tl&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tl&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">tl&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// `time_mid`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">tmh&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nx">msecs&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mh">0x100000000&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xfffffff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tmh&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">tmh&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// `time_high_and_version`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nx">tmh&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">24&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xf&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mh">0x10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// include version
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tmh&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¢ç”Ÿ time ç›¸é—œæ¬„ä½&lt;/p>
&lt;p>v4 å¯¦ä½œç›¸ç•¶ç°¡å–®ï¼Œå°±æ˜¯ä¿ç•™ versionï¼Œå…¶é¤˜å¡éš¨æ©Ÿæ•¸ï¼›
v3,v5 å¤§åŒå°ç•°ï¼Œæ‰€ä»¥ä½œè€…å¯«äº†ä¸€å€‹ v35.js ï¼Œé‡é»å¤§æ¦‚å°±é€™éº¼å¹¾è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Compute hash of namespace and value, Per 4.3
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Future: Use spread syntax when supported on all platforms, e.g. `bytes =
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// hashfunc([...namespace, ... value])`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">bytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Uint8Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">namespace&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">bytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">hashfunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bytes&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŠŠ namespace è·Ÿ value åˆèµ·ä¾†ç„¶å¾Œ hash éï¼Œæ¥è‘—å°±æŒ‰ç…§æ–‡ä»¶å¡åˆ°å°æ‡‰çš„ä½ç½®&lt;/p>
&lt;h2 id="å¾Œè¨˜ä½œè€…æäº¤-proposal-çµ¦-tc39">å¾Œè¨˜ï¼šä½œè€…æäº¤ proposal çµ¦ tc39&lt;/h2>
&lt;p>ä½œè€…åœ¨ PR ä¸­æœ‰èªªåˆ°ä»–æäº†ä¸€å€‹ proposal çµ¦ tc39 &lt;a class="link" href="https://github.com/tc39/proposal-uuid#arent-v1-uuids-better-because-they-are-guaranteed-to-be-unique" target="_blank" rel="noopener"
>proposal-uuid&lt;/a>ï¼Œç›®å‰é‚„åœ¨ stage 0ï¼Œå¸Œæœ›æŠŠ uuid ç”¢ç”Ÿè®Šæˆ js çš„è¦ç¯„ï¼Œä¸»è¦æ˜¯æœ‰å¤ªå¤šéŒ¯èª¤ä¸”ç²—å¿ƒçš„å¯¦ä½œï¼Œä¾‹å¦‚ä½¿ç”¨ Math.random ç­‰ï¼Œé€™é‚Šå¼•ç”¨ä¸€ç¯‡éå¸¸æ£’çš„æ–‡ç« æŒ‡å‡ºç‚ºä»€éº¼ Math.random ä¸å¥½ &lt;a class="link" href="https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d" target="_blank" rel="noopener"
>TIFU by using Math.random()&lt;/a>ï¼Œä»¥ä¸‹å°‡æ‘˜éŒ„é‡é»&lt;/p>
&lt;h3 id="tifu-by-using-mathrandom-æ–‡ç« é‡é»æ‘˜è¦">TIFU by using Math.random() æ–‡ç« é‡é»æ‘˜è¦&lt;/h3>
&lt;blockquote>
&lt;p>TIFU =&amp;gt; Today I Fucked Up&lt;/p>
&lt;/blockquote>
&lt;p>ä½œè€…å…¬å¸æ¡ç”¨ microserviceï¼Œä½†ä»–å€‘å¸Œæœ›å¯ä»¥è¿½è¹¤æ¯å€‹ request åœ¨ service ä¸­äº¤äº’çµæœï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€å€‹å…¨åŸŸçš„ request idï¼Œéœ€è¦ä¸€å€‹éš¨æ©Ÿç”Ÿæˆæ¼”ç®—æ³•ç”¢ç”Ÿè¶³å¤ éš¨æ©Ÿçš„ id&lt;/p>
&lt;p>æ‰€è¬‚çš„è¶³å¤ éš¨æ©ŸåŒ…å«å…©é»&lt;/p>
&lt;ol>
&lt;li>è¶³å¤ å¤§çš„ identifier spaceï¼šæœ‰è¶³å¤ å¤šçš„çµ„åˆèˆ‡å¯èƒ½æ€§&lt;/li>
&lt;li>è¶³å¤ éš¨æ©Ÿçš„ identifier generationï¼šæœ‰äº†è¶³å¤ å¤šçš„ identifier spaceï¼Œé‚„éœ€è¦è¶³å¤ éš¨æ©Ÿçš„ç”Ÿæˆæ©Ÿåˆ¶&lt;/li>
&lt;/ol>
&lt;p>ä½œè€…æ±ºå®šç”¨é•·åº¦ 22 çš„ base 64ï¼Œä¹Ÿå°±æ˜¯ space æœ‰ 64^22 é€™éº¼å¤§ï¼Œgeneration å‰‡æ˜¯ç”¨ decent pseudo-random number generator (PRNG) å¸¸è¦‹çš„æ¼”ç®—æ³•ï¼ŒV8 å³æ˜¯æ¡ç”¨é€™ä¸€å¥—ï¼Œå¦‚æœè¶³å¤ éš¨æ©Ÿï¼Œé‚£é€™æ¨£çš„ç©ºé–“è¶³ä»¥&lt;code>é è¨ˆæ¯ç§’ç”¢ç”Ÿä¸€ç™¾è¬æ¬¡ä¹Ÿè¦ä¸‰ç™¾å¹´æ‰æœƒç¢°æ’&lt;/code>ï¼Œå¤šéº¼çš„ç¾å¥½&lt;/p>
&lt;p>æœ€å¾Œä½œè€…å…œå‡ºä¾†çš„ç¨‹å¼ç¢¼å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">ALPHABET&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">random_base64&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">random_base64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">rand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">floor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">ALPHABET&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">str&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">ALPHABET&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">substring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rand&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">str&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çœ‹èµ·ä¾†ä¸€é»å•é¡Œéƒ½æ²’æœ‰ï¼Œä¹Ÿæ˜¯å¤§å®¶å¸¸è¦‹çš„éš¨æ©Ÿç”Ÿæˆåšæ³•&lt;/p>
&lt;p>ä½†æ˜¯åœ¨ä¸ä¹…å¾ŒåŒäº‹ç™¼ç¾ ID ç¢°æ’äº† ğŸ’¥&lt;/p>
&lt;blockquote>
&lt;p>â€œAnyone who considers arithmetical methods of producing random digits is, of course, in a state of sin.â€ From John von Neumann
æ„å³è¦é€éæ•¸å­¸æ–¹å¼ç”¢ç”ŸçœŸæ­£éš¨æ©Ÿæ ¹æœ¬æ˜¯ä¸å¯èƒ½&lt;/p>
&lt;/blockquote>
&lt;h4 id="prng-å¯¦ä½œ">PRNG å¯¦ä½œ&lt;/h4>
&lt;p>ç°¡å–®çœ‹ä¸€ä¸‹å½éš¨æ©Ÿæ•¸çš„ç”Ÿæˆæ–¹å¼ä¹‹ä¸€ PRNG (pseudo random number generator)
&lt;img src="https://miro.medium.com/max/700/1*_rpSUn6ekuZvXJnT5bWUbw.png"
loading="lazy"
>
ä¾†è‡ªåŸæ–‡çš„åœ–ç‰‡&lt;/p>
&lt;p>ç°¡å–®ä¾†èªªå°±æ˜¯æœƒæœ‰ä¸€å€‹åˆå§‹çš„ Seedï¼Œæ¥è‘—æŒ‰ç…§æ•¸å­¸å…¬å¼ç®—å‡ºä¸€å€‹å°æ‡‰çš„ä½ç½®ï¼Œæ‰€ä»¥åªæœ‰ç¶“éå¹¾æ¬¡è¼ªè½‰ï¼Œæ‰€ä»¥è¦ç”¨ finite state ç”¢ç”Ÿéš¨æ©Ÿæ•¸æ˜¯ä¸å¯èƒ½çš„ï¼Œåªè¦ PRNG æŒçºŒç”¢ç”Ÿï¼Œé‚£æœ€çµ‚è¼¸å‡ºæœƒé‡è¤‡å‡ºç¾ &lt;code>Periodic&lt;/code>ï¼Œä½œè€…æ¯”é‡åˆ°ï¼Œ PRNG å°±åƒä¸€æœ¬å£“ç¸®çš„å¯†ç¢¼æœ¬æœ¬åŒ…å«è‘—ä¸€ä¸²æ•¸å­—ï¼ŒSeed åƒæ˜¯ä½ æŒ‘æŸä¸€é é–‹å§‹çœ‹ï¼Œæ¥è‘—ä¸€è·¯å¾€ä¸‹ç¿»ï¼Œåˆ°æ›¸å°¾å†å¾æ›¸é¦–é–‹å§‹çœ‹èµ·ï¼Œçµ‚å°‡è¼ªè¿´&lt;/p>
&lt;p>ä¸éåªè¦ Cycle çš„é•·åº¦é•·åˆ°åœ¨æœ‰é™æ™‚é–“å…§ä¸æœƒç™¼ç”Ÿå³å¯ï¼Œé€™ä¹Ÿæ±ºå®š PRNG æ¼”ç®—æ³•å“è³ªï¼Œç¨±ä¹‹ç‚º &lt;code>full-cycle generator&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>If a PRNGâ€™s state has a k-bit representation, the cycle length is less than or equal to 2áµ. A PRNG that actually achieves this maximum cycle length is called a full-cycle generator.&lt;/p>
&lt;/blockquote>
&lt;p>è‰¯å¥½çš„ PRNG æœƒç›¡å¯èƒ½é”åˆ° 2áµ ä¸Šé™&lt;/p>
&lt;p>å¾Œé¢æœ‰ä¸€æ®µå†èªªæ˜ Chrome ç•¶æ™‚çš„ Math.random æ¼”ç®—æ³•éŒ¯èª¤ï¼Œæ‰€ä»¥å¯¦éš›ä¸Š 590 million å°±æœƒç™¼ç”Ÿå¾ªç’°ï¼Œæ›´ç³Ÿç³•çš„æ˜¯åŸºæ–¼ç”Ÿæ—¥æ‚–è«–ï¼Œç”¢ç”Ÿåƒ…åƒ… 3 è¬æ¬¡å°±æœƒæœ‰ 50% çš„ç¢°æ’æ©Ÿæœƒ (50% chance of collision after generating just 30,000 identifiers.)&lt;/p>
&lt;p>æœ€å¾Œçš„çµè«–æ˜¯å¦‚æœè¦&lt;code>æ¡ç”¨å½éš¨æ©Ÿç”Ÿæˆæ•¸è«‹ç”¨ CSPRNG(cryptographically secure PRNG)&lt;/code>ï¼Œæˆ–æ˜¯æ¡ç”¨ç³»çµ±æ ¸å¿ƒåŸºæ–¼å¤–éƒ¨å™ªéŸ³ã€ç¶²è·¯å°åŒ…ç­‰ç”¢ç”Ÿçš„çœŸéš¨æ©Ÿæ•¸ &lt;code>urandom&lt;/code>&lt;/p>
&lt;h2 id="å…¶ä»–">å…¶ä»–&lt;/h2>
&lt;p>ä»Šå¤©è·¯éçœ‹åˆ°ä¸€ç¯‡é—œæ–¼ UUID çš„å¥½æ–‡ &lt;a class="link" href="https://medium.com/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B-uuid-2748df80aa7e" target="_blank" rel="noopener"
>é–’è«‡è»Ÿé«”æ¶æ§‹ï¼šUUID&lt;/a>ï¼Œä¸»è¦æ›´æ·±å…¥æ¢è¨å¦‚æœæŠŠ UUID ç•¶ä½œè³‡æ–™åº«çš„ Key å°æ–¼æ•ˆèƒ½çš„å½±éŸ¿ï¼Œä¸»ç›®çš„æ˜¯å¸Œæœ›èƒ½é”åˆ° &lt;code>åˆ†æ•£å¼ç”¢ç”Ÿéå¢çš„ Key&lt;/code>ï¼ŒUUID v1 ç®—æ˜¯æœ‰ç¬¦åˆé€™å€‹è¦æ±‚ï¼Œä½†å› ç‚ºæœ‰åšé timestamp çš„æ‹†åˆ†ï¼Œå°è‡´ Java å¯¦ä½œåœ¨æ¯”å°æ™‚æœƒæœ‰é»å•é¡Œ&lt;br>
å¯ä»¥è‡ªå·±å®¢è£½åŒ– UUID çš„æ ¼å¼ï¼Œæˆ–ä¹¾è„†è‡ªå‰µï¼Œåƒè€ƒå…¶ä»–å¯¦ä½œå¦‚ Twitter Snowflake(å·² deprecated) æˆ–æ˜¯ &lt;a class="link" href="https://firebase.googleblog.com/2015/02/the-2120-ways-to-ensure-unique_68.html" target="_blank" rel="noopener"
>Firebase Push ID&lt;/a>ï¼Œå¤§æŠµä¸Šéƒ½è„«é›¢ä¸äº† &lt;code>timestamp åŠ ä¸Šäº‚æ•¸æˆ–æ˜¯åŠ ä¸Šæ©Ÿå™¨è­˜åˆ¥ç¢¼&lt;/code>çš„åšæ³•&lt;/p>
&lt;h2 id="çµè«–">çµè«–&lt;/h2>
&lt;p>ID æ˜¯å¸¸ç”¨çš„å±¬æ€§ï¼Œç”¨ä¾†æŠ½è±¡åŒ–æŒ‡å‘æŸå€‹ç‰©ä»¶/äº‹ä»¶ï¼Œé¸æ“‡æ­£ç¢ºçš„æ–¹å¼ç”¢ç”Ÿ IDï¼Œæ‰ä¸æœƒå°æ–¼ç³»çµ±ç”¢ç”Ÿæ•ˆèƒ½è²§é ¸ï¼Œé€éå­¸ç¿’ UUID çš„å¯¦ä½œéç¨‹ï¼Œçœ‹åˆ°åˆ†æ•£å¼ç”¢ç”Ÿ ID çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯åœ¨å¤§æ•¸æ“šæ™‚ä»£ï¼Œå¿«é€Ÿç”¢ç”Ÿç¨ä¸€(ä¸”éå¢)çš„ ID å°¤ç‚ºåŸºç¤ä¸”é‡è¦ï¼Œè€Œåœ¨ä¹‹ä¸­&lt;code>éš¨æ©Ÿæ€§&lt;/code>åœ¨æ•´å€‹éç¨‹æ‰®æ¼”è‘—å¾ˆé—œéµçš„è§’è‰²&lt;/p></description></item><item><title>ç’°èŠ±æ±365æŒ‘æˆ°è³½åˆ†äº«-å¦‚ä½•ä¸€äººå‚™è³½èˆ‡æ¯”è³½éç¨‹</title><link>https://yuanchieh.page/posts/2020/2020-11-30-%E7%92%B0%E8%8A%B1%E6%9D%B1365%E6%8C%91%E6%88%B0%E8%B3%BD%E5%88%86%E4%BA%AB-%E5%A6%82%E4%BD%95%E4%B8%80%E4%BA%BA%E5%82%99%E8%B3%BD%E8%88%87%E6%AF%94%E8%B3%BD%E9%81%8E%E7%A8%8B/</link><pubDate>Mon, 30 Nov 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-11-30-%E7%92%B0%E8%8A%B1%E6%9D%B1365%E6%8C%91%E6%88%B0%E8%B3%BD%E5%88%86%E4%BA%AB-%E5%A6%82%E4%BD%95%E4%B8%80%E4%BA%BA%E5%82%99%E8%B3%BD%E8%88%87%E6%AF%94%E8%B3%BD%E9%81%8E%E7%A8%8B/</guid><description>&lt;p>è‡ªå·±æ˜¯ä¸€å€‹å–œæ­¡é€éé‹å‹•è³½äº‹å¢æ·»ç”Ÿæ´»è¶£å‘³çš„äººï¼Œä¹Ÿäº«å—è‘—èªè­˜ä¸åŒé‹å‹•çš„é­…åŠ›ï¼Œå¾å…«æœˆåº•è³¼å…¥è‡ªè¡Œè»Šå¾Œï¼Œå°±é–‹å§‹æ‰¾ç›¸é—œçš„è‡ªè¡Œè»Šè³½äº‹ï¼Œæœ€å¾ŒæŒ‘é¸äº†æ™‚é–“é‚„è »å‰›å¥½çš„ç’°èŠ±æ± 365 æŒ‘æˆ°è³½ï¼Œæœ‰å¤§æ¦‚ä¸‰å€‹æœˆèƒ½æº–å‚™ï¼Œæœ‰é»è¶•ä½†å€¼å¾—æ‹¼æ‹¼çœ‹ï¼Œç¶²è·¯ä¸Šçš„åˆ†äº«å¤§å¤šæ˜¯è»Šå‹çš„æ¯”è³½é¨ä¹˜å¿ƒå¾—ï¼Œæ¯”è¼ƒå°‘è¦‹åˆ°å‚™è³½ç›¸é—œçš„ç¶“é©—ï¼Œä»¥åŠ&lt;code>èƒ½ä¸èƒ½åœ¨æ²’æœ‰è»ŠéšŠæˆ–è£œçµ¦è»Šçš„æƒ…æ³ä¸‹å®Œæˆæ¯”è³½&lt;/code>&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä»¥ä¸‹å°‡åˆ†äº«æˆ‘å¾å…«æœˆåº•åˆ°åä¸€æœˆåº•å¦‚ä½•æº–å‚™ï¼Œä»¥åŠæ¯”è³½é€™å…©å¤©çš„å¿ƒè·¯æ­·ç¨‹ï¼Œæœ€å¾Œçµ¦ä¸€äº›æ•´é«”çš„æº–å‚™æ¸…å–®ï¼Œä¹Ÿå¿…é ˆèªªæˆ‘è‡ªå·±é–‹å§‹é¨è‡ªè¡Œè»Šä¹Ÿä¸åˆ°åŠå¹´ï¼Œåˆ†äº«æ¯”è¼ƒé©ç”¨æ–¼è·Ÿæˆ‘ä¸€æ¨£çš„å°ç™½ï¼Œå¦‚æœå°ˆæ¥­çš„è»Šå‹æœ‰ä¸åŒçš„å»ºè­°æˆ–æŒ‡æ•™ï¼Œä¹Ÿéå¸¸æ­¡è¿ç•™è¨€&lt;/p>
&lt;h2 id="äº‹å‰æº–å‚™">äº‹å‰æº–å‚™&lt;/h2>
&lt;p>é™¤äº†è‡ªè¡Œè»Šä¹‹å¤–ï¼Œæœ‰å¹¾é …æ±è¥¿è¦ºå¾—è¦ç·´è»Šæ‡‰è©²è¦æº–å‚™çš„&lt;/p>
&lt;h4 id="1-è»ŠéŒ¶è¸é »å¿ƒç‡æ„Ÿæ¸¬">1. è»ŠéŒ¶ï¼‹è¸é »ï¼‹å¿ƒç‡æ„Ÿæ¸¬ï¼š&lt;/h4>
&lt;p>ä¸€é–‹å§‹æˆ‘æ˜¯ç”¨æ‰‹æ©Ÿé–‹ Strava ç´€éŒ„ï¼Œä½†çœŸå¿ƒå»ºè­°è¦èªçœŸç·´é‚„æ˜¯æº–å‚™è»ŠéŒ¶ï¼Œåƒæˆ‘è‡ªå·±ç”¨ Bryton 320 è¦ºå¾—çºŒèˆªé” 30 å€‹å°æ™‚çœŸå¾ˆæ–¹ä¾¿ï¼Œä¹Ÿä¸ç”¨å¿ƒç–¼æ‰‹æ©Ÿä¸€è·¯éœ‡å‹•æ€•å£æ‰ï¼›&lt;br>
&lt;code>è¸é »&lt;/code>çš„æ¨è–¦æ˜¯å› ç‚ºä¸€é–‹å§‹é¨è»ŠæŠ“ä¸åˆ°æ„Ÿè¦ºï¼Œçœ‹ç¶²è·¯æ•™å­¸å»ºè­°ç¶­æŒåœ¨ 100 ä»¥ä¸Šçš„è¸é »ï¼Œé¿å…å‚·è†è“‹ï¼›&lt;br>
&lt;code>å¿ƒç‡å¸¶&lt;/code>æ˜¯å› ç‚ºè€åŠ›é‹å‹•æœ€å¥½æ˜¯ç¶­æŒåœ¨æœ€å¤§å¿ƒç‡çš„ 70% ä¸Šä¸‹ï¼Œæœ€å¤§å¿ƒç‡çš„å…¬å¼ç´„ç‚º &lt;code>206.9 - (0.67 x å¹´é½¡)&lt;/code>ï¼Œåƒæˆ‘è‡ªå·±æ˜¯æŠ“ 150ï¼Œå¹³å¸¸ç·´ç¿’å°±ç›¡é‡ç¶­æŒï¼Œæœ€å¤§ä¸è¦è¶…é 165 é¿å…å¤ªæ—©çˆ†æ‰åè€Œæ’ä¸ä¹…ï¼Œæˆ‘è¦ºå¾—ç·´ç¿’äº†ä¸€é™£å­å¿ƒç‡å¸¶æ¯”è¸é »æ›´é‡è¦ &lt;br>
è²·ä¸€å¥— Bryon 3000å…ƒä¸Šä¸‹å°±å¾ˆå¤ ç”¨äº†&lt;/p>
&lt;h4 id="2è»Šè¡£è»Šè¤²">2.è»Šè¡£ã€è»Šè¤²&lt;/h4>
&lt;p>ä¸€é–‹å§‹æœ‰ç©¿éä¾¿å®œçš„è»Šè¤²ï¼Œé¨æ²’å¤šä¹…å±è‚¡å°±æœƒéº»éº»çš„ï¼Œè²·äº† Monton è»Šè¤²è¦ºå¾—èˆ’é©å¾ˆå¤šï¼Œå¦‚æœé¨äº†ä¸èˆ’é©æœƒå½±éŸ¿é¨ä¹˜çš„æ„é¡˜ï¼Œå°±æ›´åˆ¥èªªè¦æ¯”è³½äº†ï¼Œä¸€ä»¶ç´„ 2000 å…ƒé‚„ç®—è »å€¼å¾—çš„ &lt;br>
è»Šè¡£çš„éƒ¨åˆ†ï¼Œæˆ‘å¹³å¸¸ä¹Ÿæœƒç©¿ä¸€èˆ¬çš„æ’æ±—è¡«ï¼Œä½†å°ˆé–€çš„è»Šè¡£æœ€å¤§ç‰¹é»åœ¨å¾Œæ–¹æœ‰å£è¢‹ï¼Œè¦è£œçµ¦å°±éå¸¸æ–¹ä¾¿ï¼Œæ¯”è³½çš„æ™‚å€™å¾ˆå¥½ç”¨ï¼Œä¹Ÿè »æ¨è–¦&lt;/p>
&lt;h4 id="3é˜²é›¨å¤–å¥—">3.é˜²é›¨å¤–å¥—&lt;/h4>
&lt;p>é€™æˆ‘å€‹äººæ²’æœ‰è²·ï¼Œä½†çœŸå¿ƒè¦ºå¾—æ‡‰è©²è¦è²·ï¼Œå› ç‚ºæ¯”è³½å…©å¤©éƒ½ä¸‹é›¨ï¼Œæœ‰é˜²é¢¨é˜²é›¨çš„å¤–å¥—æœƒè®“é¨ä¹˜æ›´åŠ èˆ’é©å®‰å…¨ï¼Œè€Œä¸”æ—©ä¸Šå…­é»å‡ºç™¼é‚„å¾ˆå†·ï¼Œæ²¿é€”çš„è»Šå‹äº”æˆä»¥ä¸Šéƒ½æœ‰è²·&lt;/p>
&lt;h4 id="4-èƒ½é‡è† ">4. èƒ½é‡è† &lt;/h4>
&lt;p>ä¸€é–‹å§‹æ˜¯å› ç‚ºå¹³æ—¥ç·´ç¿’åˆ°ä¸€åŠæœƒè‚šå­é¤“æ‰å˜—è©¦è³¼è²·ï¼Œä½†ç™¼ç¾çœŸçš„å¾ˆå¥½ç”¨ï¼Œç”šè‡³å¯ä»¥èªªæ˜¯å¿…å‚™çš„ç”¨å“ï¼Œæˆ‘æ˜¯è²· SIS èƒ½é‡è† ï¼Œå£å‘³æ²’é€™éº¼ç”œä¸»æ‰“å¯ä»¥ç›´æ¥åƒä¸ç”¨é…æ°´ / GU çš„æˆ‘ä¹Ÿæœ‰è²·ï¼Œé™¤äº†å•¤é…’å£å‘³è¶…é›·å…¶ä»–çš„éƒ½ä¸éŒ¯ï¼Œä»–æ¯” SIS æ›´æ¿ƒï¼Œé‡é‡åªæœ‰ä¸€åŠä½†æä¾›ç›¸åŒçš„ç†±é‡ï¼Œéœ€è¦é…ä¸€å£æ°´ &lt;br>
åŸºæœ¬ä¸Šæˆ‘å¹³å¸¸ç·´ç¿’å¸¶ä¸€åŒ…ï¼Œé¨ä¹˜ç´„ 40 ~ 50 åˆ†é˜åƒä¸€åŒ…ï¼Œæ¯”è³½æ™‚èº«ä¸Šå¸¶ 5~6 åŒ…å‚™ç”¨&lt;/p>
&lt;h2 id="å‚™è³½">å‚™è³½&lt;/h2>
&lt;p>å…«æœˆåº•é–‹å§‹ï¼Œæ¯é€±è‡³å°‘é¨ä¸‰æ¬¡ï¼Œå…©æ¬¡æŒ‘å¹³æ—¥æ—©ä¸Šï¼Œå¾ä¸‰é‡æ²¿æ²³æ¿±ä¾†å›å—æ¸¯ç´„ 60 å…¬é‡Œï¼Œç´„ 2å°æ™‚å‡ºé ­å®Œæˆ
&lt;img src="https://yuanchieh.page/post/img/20201130/daily.png"
loading="lazy"
alt="daily"
>&lt;/p>
&lt;p>å‡æ—¥æŒ‘ä¸€å¤©é¨é•·è·é›¢ï¼Œæœ‰é¨éä¸‰é‡ç¿»éé¢¨æ«ƒå˜´ä¾†å›é‡‘å±±(ç´„85å…¬é‡Œä½†è »å¤šå±±è·¯)ã€ä¸‰é‡å»¶æ²³æ¿±å¾€æ·¡æ°´åˆ°çŸ³é–€å†æŠ˜è¿”(å¹³è·¯ç¸½è¨ˆç´„100å…¬é‡Œ)ï¼Œé€£çºŒé¨ä¹˜æ™‚é–“éƒ½åœ¨äº”å€‹å°æ™‚å·¦å³&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201130/100k.png"
loading="lazy"
alt="100k"
>&lt;/p>
&lt;p>è‡ªå·±é¨ä¹˜çš„å¯¦åŠ›å¤§æ¦‚æ˜¯å¾æ¥“æ—æ©‹ä¸Šé¢¨æ«ƒå˜´33åˆ†ï¼Œçœ‹ Strava ç®—è »ä¸€èˆ¬çš„æˆç¸¾ï¼Œå°±æä¾›çµ¦å¤§å®¶åƒè€ƒï¼Œä¸éä»¥ä¸Šçš„ç·´ç¿’ä¸å¤ªå¤ ï¼Œæ¨ä¼°å¯èƒ½ä¸€é€±ç·´ 250 å…¬é‡Œï¼ŒæŒçºŒå››å€‹æœˆå‚™è³½æœƒè®“æ¯”è³½å¥½éä¸€äº›&lt;/p>
&lt;h2 id="äº¤é€šèˆ‡ä½å®¿">äº¤é€šèˆ‡ä½å®¿&lt;/h2>
&lt;p>å› ç‚ºæ²’æœ‰éšŠè»Šï¼Œæ‰€ä»¥è¦è‡ªå·±æƒ³è¾¦æ³•åˆ°èŠ±è“®ï¼Œæˆ‘å¾Œä¾†é¸æ“‡&lt;code>æ­ç«è»Šåˆ°èŠ±è“®&lt;/code>ï¼Œåˆ°äº†ç•¶åœ°åœ¨ç§Ÿæ±½æ©Ÿè»Šä»£æ­¥ï¼Œåœ¨ç¶²è·¯ä¸Šè²·ä¸€å€‹ 500 å…ƒçš„æ”œè»Šè¢‹ï¼Œæ‹†é™¤å‰å¾Œè¼ªå°±å¯ä»¥ä¸Šè·¯ï¼Œéç¨‹æ¯”æƒ³åƒä¸­ç°¡å–®ï¼Œ&lt;code>åŒ…å¥½çš„è…³è¸è»Šå°±ç®—æ˜¯ä¸€èˆ¬çš„è¡Œæï¼Œæ²’æœ‰å…¶ä»–çš„ç­æ¬¡é™åˆ¶ï¼Œé™¤éæ˜¯æ²’æœ‰æ‹†çš„æ‰è¦ç‰¹åˆ¥æ‰¾å°ˆé–€åˆ—è»Šå–”&lt;/code>&lt;/p>
&lt;p>ä½å®¿éƒ¨åˆ†èŠ±è“®ç«™çš„èµ·é»åœ¨äºå£«éƒ½é£¯åº—ï¼Œé›¢èŠ±è“®ç«è»Šç«™ä¸é ï¼Œå»ºè­°ä½å¸‚å€å°±å¥½ï¼Œé¤é£²è§£æ±ºä¹Ÿæ¯”è¼ƒæ–¹ä¾¿ï¼›&lt;br>
å°æ±çš„èµ·é»åœ¨å¨œè·¯å½é£¯åº—ï¼Œä¸å¾—ä¸èªªæˆ‘ä¸€é–‹å§‹ä»¥ç‚ºä¹Ÿåœ¨å°æ±ç«è»Šç«™é™„è¿‘ï¼Œçµæœç›¸å·®è¶…é  XD è€Œä¸”å°æ±ç«è»Šç«™é™„è¿‘æ²’ä»€éº¼æ±è¥¿ï¼Œé›¢å¸‚å€é‚„æœ‰ä¸€å°æ®µè·é›¢ï¼Œå°±&lt;code>ä¸å¤ªå»ºè­°ä½åœ¨å°æ±ç«è»Šç«™é™„è¿‘&lt;/code>ï¼Œå› ç‚ºç¬¬ä¸€å¤©æ¯”è³½æ¯”å®Œè¦å›æ°‘å®¿ï¼Œé¨å¤ªé è…³è¶…ç´šé…¸ï¼Œé‚„è¦å†å‡ºä¾†è¦“é£ŸçœŸçš„ç´¯ OTZ&lt;/p>
&lt;p>å¦å¤–å°æ±ä½å®¿å»ºè­°å•ä¸€ä¸‹èƒ½ä¸èƒ½æ²–æ´—è‡ªè¡Œè»Šï¼Œç¬¬ä¸€å¤©æ¯”å®Œè»Šå­æ‡‰è©²éƒ½è »é«’ï¼Œæˆ‘æœ‰æº–å‚™æ¸…æ½”ç”¨å“ï¼Œæ´—ä¹¾æ·¨é‡æ–°ä¸Šæ²¹è¿æ¥ç¬¬äºŒå¤©çš„æŒ‘æˆ°&lt;/p>
&lt;h2 id="æ¯”è³½å…©æ—¥">æ¯”è³½å…©æ—¥&lt;/h2>
&lt;p>æŠ±è‘—å¿å¿‘çš„å¿ƒï¼Œå› ç‚ºè‡ªå·±ä¹Ÿæ²’æœ‰çœŸçš„é¨ä¹˜è¶…é 150 å…¬é‡Œçš„ç¶“é©—ï¼Œåœ¨æ²’æœ‰è»ŠéšŠã€è£œçµ¦è»Šï¼Œç”šè‡³é‚„ä¸æœƒè£œèƒ(åªæœ‰å¸¶å·¥å…·ä¸¦éš¨æ™‚æº–å‚™çœ‹ Youtube æ•™å­¸XD)çš„ç‹€æ³ä¸‹ï¼Œè‡ªå·±çœŸçš„èƒ½å®Œè³½å—ï¼Ÿ&lt;/p>
&lt;p>ç’°èŠ±æ± 365 æœ‰åˆ†è‡ªè¡Œè»Šè³½è·ŸæŒ‘æˆ°è³½ï¼Œè¦è¨˜å¾—å ±å&lt;code>æŒ‘æˆ°è³½&lt;/code>å–”ï¼Œç•¶åˆä¸€ç›´çœ‹æƒ³èªªæ€éº¼è·¯ç·šä¸ä¸€æ¨£ï¼Œæ‰ç™¼ç¾è‡ªè¡Œè»Šè³½æ˜¯å°ˆæ¥­åœ¨æ¯”çš„ï¼Œä¸è¦ææ··å›‰&lt;/p>
&lt;p>æ¯”è³½å‰ä¸€å¤©æœƒå»äºå£«éƒ½é£¯åº—å ±åˆ°ï¼Œä¸‹åˆäº”é»æœƒæœ‰èªªæ˜æœƒï¼Œç°¡å–®è‡´è©èˆ‡èªªæ˜äº¤é€šè·¯æ³&lt;/p>
&lt;h3 id="1128-ç¬¬ä¸€å¤©-èŠ±è“®åˆ°å°æ±">11/28 ç¬¬ä¸€å¤©: èŠ±è“®åˆ°å°æ±&lt;/h3>
&lt;p>å…­é»å¾èŠ±è“®äºå£«éƒ½é£¯åº—ï¼Œæ²¿è‘—æµ·å²¸èµ°å° 11 ç·šä¸€è·¯æ®ºåˆ°å°æ±ï¼Œé€”ä¸­æœƒç¿»éæµ·æ‹”å…©ç™¾çš„ç‰›å±±ï¼Œæ¥è‘—å°±ä¸Šä¸Šä¸‹ä¸‹çš„ä¸˜é™µåœ°ï¼Œæ“šèªªä»¥å¾€çš„ç’°èŠ±æ±éƒ½åœ¨å››æœˆèˆ‰è¾¦ï¼Œä»Šå¹´å› ç‚ºç–«æƒ…å»¶åˆ°åä¸€æœˆï¼Œé †è‘—æ±åŒ—å­£é¢¨ä¸€è·¯å¾€å—æ®ºï¼Œä¸€é–‹è³½çœ‹è‘—å¤§å®¶å¹³è·¯æ™‚é€Ÿéƒ½é£† 40 å…¬é‡Œï¼Œå®³æˆ‘ä¹Ÿè·Ÿè‘—è¡ï¼Œçœ‹åˆ°å¿ƒç‡é‚„ç¶­æŒåœ¨ 150 å·¦å³ï¼Œæ‰ç™¼ç¾å¼·å‹çš„å­£é¢¨çœŸçš„å¾ˆçµ¦åŠ›&lt;/p>
&lt;p>ä¸€è·¯ä¸Šè·¯æ³éƒ½ä¸éŒ¯ï¼Œæ±½è»Šä¹Ÿä¸ç®—å¤šï¼Œè »å¤šè·¯æ®µéƒ½æœ‰æ©Ÿæ…¢è»Šé“æ‰€ä»¥é¨ä¹˜è »é †æš¢ï¼Œåœ¨ 60 å…¬é‡Œè™•é–‹å§‹ä¸‹é›¨ï¼Œç„¡å¥ˆè‡ªå·±æ²’æœ‰é›¨è¡£ï¼Œå°±é ‚è‘—é›¨ç¹¼çºŒè¡ï¼Œåˆ°äº† 80 å…¬é‡Œè™•åƒåˆé¤ï¼Œæ­¤æ™‚æ‰æ—©ä¸Šä¹é»ï¼Œé æ¯”é æœŸçš„å¿«&lt;/p>
&lt;p>åƒé£½å¾Œç¹¼çºŒæ·‹é›¨ï¼Œåœ¨é †é¢¨çš„æƒ…æ³ä¸‹ï¼Œå¤§å®¶éƒ½ä¸‰å…©æˆç¾¤çš„é¨ï¼Œå› ç‚ºç¬¬ä¸€å¤©é«”èƒ½å……æ²›ï¼Œåˆæœ‰æ·‹é›¨æ€•èº«é«”å†·æ‰æ‰€ä»¥æ¯ä¸€ç«™éƒ½æœ‰é€²è£œçµ¦ï¼Œä½†åƒä¸€åƒä¸Šå€‹å»æ‰€å°±è¶•å¿«ç¹¼çºŒé¨ï¼Œå»ºè­°å¯ä»¥åœ¨è£œçµ¦ç«™å¸¶ä¸€å¡Šé¦™è•‰åœ¨èº«ä¸Šåƒï¼Œæˆ‘è‡ªå·±çš„è£œçµ¦ç­–ç•¥æ˜¯ &lt;code>æ¯å€‹è£œçµ¦ç«™éƒ½é€²ï¼Œè·¯ä¸Šé¨ä¹˜ç´„ 50åˆ†é˜åƒä¸€åŒ…èƒ½é‡è† &lt;/code>ï¼Œè·¯ä¸Šæœ‰è»Šå°±è·Ÿï¼Œä¹Ÿä¸ç”¨ä¸å¥½æ„æ€å°±è¹­åœ¨å¾Œé¢ï¼Œä¿æŒå®‰å…¨è»Šè·ï¼›&lt;/p>
&lt;blockquote>
&lt;p>è·Ÿè»Šæ™‚é€Ÿåº¦å¿«å¯ä»¥æ›å¤§ç›¤ï¼Œè¸©å€‹å¹¾ä¸‹å¾Œä¼‘æ¯ï¼Œä¸è¦ç”¨è¼•é½’æ¯”ç‹‚è¸©ï¼Œä¿æŒè»Šè·ä¸æ‹‰è¶…éä¸‰å€‹è»Šèº«å³å¯ï¼Œè¦æŠ“ç·Šä¼‘æ¯çš„ç¯€å¥ï¼Œé€™æ˜¯å¥½å¿ƒçš„å¤§å“¥è·¯éæ•™æˆ‘çš„ï¼Œé€™æ¨£è¼•é¬†äº†è¨±å¤š&lt;/p>
&lt;/blockquote>
&lt;p>å‰é¢è…³éƒ½æ²’ä»€éº¼å•é¡Œï¼Œå¤§æ¦‚ä¸€è·¯åˆ° 130 å…¬é‡Œè™•å¤©æ°£æ”¾æ™´ï¼Œä½†å¤§è…¿ä¹Ÿé–‹å§‹æœ‰ç–²å‹æ€§ç— ç—›ï¼Œä¸€è·¯ä¸Šç¨æ¨æ™‚å°±æ”¾æ…¢é€Ÿåº¦ï¼Œç­‰åˆ°æœ‰å·®ä¸å¤šæ™‚é€Ÿçš„é›†åœ˜å‡ºç¾å°±è·Ÿä¸Šï¼Œè·Ÿåˆ°ä¸è¡Œåœ¨æ”¾æ‰ä¼‘æ¯ï¼Œä¸€è·¯é€™æ¨£åˆ°çµ‚é»ï¼Œå®Œæˆç¬¬ä¸€å¤©çš„ 170 å…¬é‡Œï¼Œ&lt;code>ç¸½å®Œè³½æ™‚é–“ç´„å…­å€‹åŠå°æ™‚&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201130/1128.png"
loading="lazy"
alt="1128"
>&lt;/p>
&lt;p>ä¸å¾—ä¸èªªä¸€è·¯ä¸Šå¤§å®¶éƒ½å¾ˆæ‹¼ï¼Œä¸‹å¤§é›¨ä¸‹å¡ç…§æ¨£é£† 4,50 æ²’åœ¨æ€•çš„ XD&lt;br>
æœ€å¾Œæˆç¸¾æ˜¯ 209 / 1395ï¼Œæ¯”é æœŸçš„å¥½ :P&lt;/p>
&lt;h3 id="1129-ç¬¬äºŒå¤©-å°æ±åˆ°èŠ±è“®">11/29 ç¬¬äºŒå¤©: å°æ±åˆ°èŠ±è“®&lt;/h3>
&lt;p>ç¬¬ä¸€å¤©çš„æ¯”è³½éç¨±å ªç¨±çˆ½å¿«ï¼Œæœ‰é †é¢¨å¯ä»¥é£†ï¼Œå¾Œæ®µä¹Ÿæœ‰å…‹æœç— ç—›çš„æ„å¿—éç¨‹ï¼Œä½†ç¬¬äºŒå¤©çš„æ¯”è³½å°±çœŸçš„æ˜¯é€²å…¥åœ°ç„äº†ï¼Œåœ¨ä¸€é–‹å§‹ç†±èº«æ®µèº«é«”é‚„å¸¶è‘—æ˜¨å¤©çš„ç–²å‹ï¼Œè†è“‹èˆ‡å°è…¿é‚„æœ‰é»ç·Šç¹ƒçš„ç— ç–¼æ„Ÿï¼Œé€™æ‰ä¸åˆ° 1/10 çš„è·¯æ®µå•Šï¼Œå’¬è‘—ç‰™å‘Šè¨´è‡ªå·±å¤šæ’ä¸€æ®µåœ¨æ”¾æ£„ä¹Ÿä¸é²&lt;/p>
&lt;p>é¢¨ç¥åªçœ·é¡§äº†æ˜¨å¤©ï¼Œä»Šå¤©å›ç¨‹è½‰è®Šæˆå¤§é€†é¢¨ï¼Œä¸åŒæ–¼æ˜¨å¤©ä¸‰å…©æˆç¾¤ï¼Œé€™ä¸€å¤©å¤§å®¶ä¹–ä¹–æ’æˆä¸€ç›´ç·šï¼Œç”±å‹‡è€…ç ´é¢¨å¸¶é ˜å¤§å®¶å‰è¡Œï¼Œè™•æ–¼éšŠä¼ä¸­å¤®çœŸçš„çœåŠ›éå¸¸å¤šï¼Œè·¯ä¸Šè»Šå‹ä¹Ÿéƒ½å¾ˆå®¢æ°£ï¼Œè¦æ’å…¥éšŠä¼æ¯”å€‹æ‰‹å‹¢å¤§å®¶éƒ½å¾ˆæ¨‚æ„äº’åŠ©&lt;/p>
&lt;p>è·Ÿåˆ°ä¸è¡Œå°±æ…¢æ…¢ç¨æ¨ï¼Œç­‰ä¸‹ä¸€æ³¢é›†åœ˜å†ç¹¼çºŒè·Ÿï¼Œä½†é€™ä¸€å¤©çš„ç‹€æ³æ¯”ç¬¬ä¸€å¤©ç³Ÿï¼Œæº«åº¦ä¸‹é™äº†å…©åº¦ï¼ŒåŒæ¨£é£„é›¨ï¼Œåªæ˜¯åŠ ä¸Šç¬¬ä¸€å¤©çš„ç–²æ†Šï¼Œå¾Œä¾†æ±ºå®šé™¤äº†è£œçµ¦ç«™ï¼Œé‡åˆ° 7-11 ä¹Ÿé€²å»åä¸€ä¸‹åƒå€‹å·§å…‹åŠ›è£œä¸€è£œï¼Œå¤§æ¦‚æ¯ 10 å…¬é‡Œå°±æœƒè‚šå­é¤“äº†ï¼Œä¸åƒç¬¬ä¸€å¤©æ€¥è‘—æƒ³è¦å®Œè³½ï¼Œ&lt;code>ç¬¬äºŒå¤©å°±åªæœ‰èƒ½å¤ å®Œè³½å°±æ˜¯è‹±é›„çš„å¿µé ­XD&lt;/code>&lt;/p>
&lt;p>å›å»çš„è·¯ç·šå¤§å¤šèµ°å°9ç·šï¼Œé¨åœ¨èŠ±æ±ç¸±è°·ä¸Šçœ‹è‘—å…©å²¸çš„å±±è„ˆä¹Ÿæ˜¯é —æœ‰è¶£ï¼Œå‰æœŸè¦å…ˆä¸Šé¹¿é‡é«˜å°å†å¾€ä¸‹æºœï¼Œæ¥è‘—åˆ°ç‘ç©—çˆ¬ä¸€å€‹é™¡å¡åˆ°åŒ—å›æ­¸ç·šæ™¯é»åƒè£œçµ¦ï¼Œæ¥è‘—å°±ç¹¼çºŒä¸Šä¸Šä¸‹ä¸‹çš„ä¸˜é™µè·¯æ®µå›èŠ±è“®å¸‚å€&lt;/p>
&lt;p>å°å°æŠ±æ€¨ä¸€ä¸‹é€™ä¸€å¤©åˆé¤å®‰æ’åœ¨ 125 å…¬é‡Œè™•ï¼Œåœ¨åŠ æ²¹ç«™æ—é‚Šè‡¨æ™‚æ­æ£šå­ï¼Œä½†å› ç‚ºä¸‹é›¨ï¼Œæ’éšŠç­‰è‘—é ˜ç‚’éºµæ™‚é‚„è¦æ·‹é›¨ï¼Œæ„Ÿè¦ºæœ‰é»ä¸å¥½&lt;/p>
&lt;p>å …æŒäº†å…«å€‹å°æ™‚å¤šæ‰å®Œæˆæ¯”è³½ï¼Œå¯æƒœè»ŠéŒ¶åˆ°å¾Œé¢ç•¶æ©Ÿæ²’æœ‰å®Œæ•´è¨˜éŒ„åˆ° QQ
&lt;img src="https://yuanchieh.page/post/img/20201130/1129.png"
loading="lazy"
alt="1129"
>&lt;br>
æœ€çµ‚æˆç¸¾æ˜¯ 439 / 1206ï¼Œç¬¬äºŒå¤©æ²’åŠ›æœç„¶æ‰å¾ˆå¤š XD&lt;/p>
&lt;p>å¾Œä¾†å¥³å‹æ­ä¸Šç«è»Šï¼Œçœ‹åˆ°æœ‰ä¸€äº›è»Šå‹ä¸Šç«è»Šåå€‹å¹¾ç«™å†ç¹¼çºŒé¨ï¼Œæœƒè¦ºå¾—å¥½åƒæ€ªæ€ªçš„ï¼Œä½†æˆ‘è¦ºå¾—å¦‚æœèº«é«”æ’ä¸ä½ï¼Œé€™æ¨£å€’ä¹Ÿæ˜¯å€‹åšæ³•ï¼Œç„¡é—œä¹æ¯…åŠ›æˆ–æ˜¯é¬¥å¿—ç­‰ç­‰ï¼Œé¡§åŠåˆ°è‡ªå·±çš„ç”Ÿå‘½ï¼Œç›¡å¯èƒ½åœ°åšåˆ°æœ€å¥½å°±å¥½ï¼ŒæŒ‘æˆ°è³½æœ¬ä¾†å°±æ„åœ¨è¶…è¶Šè‡ªå·±ï¼Œè‡´æ•¬æ‰€æœ‰å®Œè³½çš„è»Šå‹å€‘ï¼Œä¹Ÿæ…¶å¹¸è‡ªå·±ä¸€è·¯å¹³å®‰çš„å®Œè³½&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>å¦‚æœèƒ½æœ‰è»ŠéšŠçœŸçš„å¾ˆä¸éŒ¯ï¼Œçœ‹åˆ°æ²¿è·¯å¤§è»ŠéšŠéƒ½æœ‰æ»¿æ»¿çš„è£œçµ¦è»Šï¼ŒçœŸçš„å¥½æ£’å•Šï¼Œå› ç‚ºå¤§æœƒå®‰æ’çš„è£œçµ¦é»æœ‰æ™‚å€™è·é›¢ä¸ç­‰æœ‰é»é ­ç–¼ï¼›&lt;br>
æ²¿è·¯é‚„æœ‰èªè­˜çš„è»Šå‹äº’ç›¸åŠ æ²¹æ‰“æ°£æ˜¯ä¸€ä»¶å¾ˆæ£’çš„äº‹ï¼Œä½†é€™ä¹Ÿä¸ä»£è¡¨ä¸€å€‹äººå°±ç„¡æ³•åƒåŠ ï¼Œå¤§æœƒåå†Šä¸Šç´„æœ‰ 1600 äººå ±åï¼Œå…¶ä¸­ç´„æœ‰å…©ä¸‰ç™¾äººä¹Ÿéƒ½æ˜¯å€‹äººèº«ä»½ï¼Œè‡ªå·±ä¹Ÿåœ¨é€™æ¨£çš„ç‹€æ³ä¸‹å®Œè³½ï¼Œå¸Œæœ›åˆ†äº«èƒ½å¤ çµ¦å…¶ä»–æƒ³åƒåŠ æ¯”è³½çš„è»Šå‹ä¸€äº›åƒè€ƒ&lt;/p></description></item><item><title>Sketch Data Structure - Bloom Filter ä»‹ç´¹èˆ‡å¯¦ä½œ</title><link>https://yuanchieh.page/posts/2020/2020-11-17-sketch-data-structure-bloom-filter-%E4%BB%8B%E7%B4%B9%E8%88%87%E5%AF%A6%E4%BD%9C/</link><pubDate>Tue, 17 Nov 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-11-17-sketch-data-structure-bloom-filter-%E4%BB%8B%E7%B4%B9%E8%88%87%E5%AF%A6%E4%BD%9C/</guid><description>&lt;p>åœ¨ç³»çµ±è¨­è¨ˆä¸­ï¼Œæˆ‘å€‘å¸¸å¸¸éœ€è¦æª¢è¦–æŸä¸€å€‹å€¼æ˜¯å¦å‡ºç¾éï¼Œä¾‹å¦‚éŠæˆ²ä¸­ç”¨æˆ¶ ID æ˜¯å¦å·²ç¶“è¨»å†Šéç­‰ç­‰ï¼Œå¦‚æœæŠŠæ¯å€‹ ID éƒ½å­˜æˆä¸€å¼µè¡¨æ¯æ¬¡å»æª¢è¦–ï¼Œæœƒéœ€è¦å¾ˆå¤§é‡çš„è¨˜æ†¶é«” ( ID å¤§å° * ID æ•¸é‡)ï¼Œå¦‚æœæ˜¯åƒ Google é€™é¡æœ‰ä¸Šå„„çš„ç”¨æˆ¶ï¼Œå…‰æ˜¯å¸³è™Ÿé‡è¤‡æª¢æŸ¥å¯èƒ½å°±éœ€è¦ 1,20 GB çš„è¨˜æ†¶é«”ç©ºé–“ï¼›&lt;/p>
&lt;p>ä»¥ä¸‹å°‡ä»‹ç´¹ï¼ŒBloom Filter ç‚ºä»€éº¼å¯ä»¥çŠ§ç‰²ä¸€é»æº–ç¢ºæ€§å°±èƒ½ç¯€çœå¤§é‡çš„ç©ºé–“&lt;/p>
&lt;h2 id="åŸç†">åŸç†&lt;/h2>
&lt;p>Bloom Filter åŸç†å…¶å¯¦å¾ˆç°¡å–®ï¼Œç”¢ç”Ÿä¸€å€‹é™£åˆ—ï¼Œç”¨ bit ä»£è¡¨è©²å…ƒç´ æ˜¯å¦å‡ºç¾éï¼Œé€é Hash function å°‡è¼¸å…¥å°ˆæ›æˆé™£åˆ—ä½ç½®ï¼Œè—‰æ­¤æ¨™è¨˜èˆ‡æŸ¥è©¢æ˜¯å¦å…ƒç´ å‡ºç¾é&lt;/p>
&lt;p>å› ç‚º Hash æœƒæœ‰ç¢°æ’å•é¡Œï¼Œæ‰€ä»¥æœƒæœ‰ &lt;code>False Positive ä½†ä¸æœƒæœ‰ False Negative &lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>æ„å³ Bloom Filter å›ç­”å…ƒç´ å·²å­˜åœ¨ä½†å¯¦éš›ä¸Šæ²’æœ‰å­˜åœ¨ï¼Œ Bloom Filter å›ç­”ä¸å­˜åœ¨å‰‡ä¸€å®šä¸å­˜åœ¨&lt;/p>
&lt;/blockquote>
&lt;p>åŸç†å¾ˆå¥½æ‡‚ï¼Œä½†è¤‡é›œçš„æ˜¯&lt;code>é™£åˆ—è¦å¤šå¤§? è¦é¸å¹¾ç¨® Hash&lt;/code> æ‰èƒ½å¹³è¡¡è¨˜æ†¶é«”ç”¨é‡ä»¥åŠé¿å… False Positive çš„éŒ¯ï¼Œé€™ä¸€å€‹éƒ¨è½æ ¼ç”¨æ•¸å­¸è­‰æ˜ &lt;a class="link" href="http://pages.cs.wisc.edu/~cao/papers/summary-cache/node8.html" target="_blank" rel="noopener"
>Bloom Filters - the math&lt;/a>&lt;/p>
&lt;ol>
&lt;li>å‡è¨­æˆ‘å€‘æ±ºå®šç”¨ä¸€å€‹é•·åº¦ç‚º m çš„é™£åˆ—ï¼Œé™£åˆ—çš„å…ƒç´ æ˜¯ä¸€å€‹ bit è¡¨ç¤ºè©²éµå€¼å·²å‡ºç¾é&lt;/li>
&lt;li>ç•¶ä»Šå¤©å¢åŠ éµå€¼æ™‚ï¼Œç¶“é Hash æœƒéš¨æ©Ÿåˆ†é…é™£åˆ—ä¸­çš„ä¸€å€‹ä½ç½®çµ¦è©²éµå€¼ï¼Œæ›å¥è©±èªªé™£åˆ—çš„æŸå€‹ä½ç½®è¢«æ’å…¥çš„å¯èƒ½æ€§æ˜¯ &lt;code>1/m&lt;/code>&lt;/li>
&lt;li>ä»Šå¤©å‡è¨­æ’å…¥äº†ä¸€å€‹éµå€¼ï¼Œé‚£ç¬¬äºŒå€‹éµå€¼èˆ‡ç¬¬ä¸€å€‹éµå€¼ç¢°æ’çš„æ©Ÿç‡æ˜¯ &lt;code>1/m&lt;/code> (å¥½æ­»ä¸æ­»åˆ†é…åˆ°åŒä¸€å€‹é™£åˆ—)ï¼Œä¹Ÿå°±ä»£è¡¨ä¸æœƒç¢°æ’çš„æ©Ÿç‡æ˜¯ &lt;code>1 - 1/m&lt;/code>&lt;/li>
&lt;li>ä»Šå¤©å‡è¨­æ’å…¥äº†å…©å€‹éµå€¼ï¼Œé‚£ç¬¬ä¸‰å€‹éµå€¼ä¸æœƒç¢°æ’çš„æ©Ÿç‡æ˜¯ &lt;code>(1 - 1/m)^2&lt;/code>ï¼Œå¦‚æœæ’å…¥äº† n å€‹éµå€¼ï¼Œé‚£ç¬¬ n + 1 å€‹ä¸æœƒç¢°æ’çš„æ©Ÿç‡æ˜¯ &lt;code>(1 - 1/m)^n&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šæ˜¯ Hash æ•¸é‡ç‚º 1 çš„æƒ…æ³ï¼Œæ¥ä¸‹ä¾†è€ƒé‡ç¨ç«‹ Hash ç‚º k çš„æƒ…æ³&lt;/p>
&lt;ol>
&lt;li>å› ç‚º Hash æ•¸é‡ç‚º k ï¼Œæ‰€ä»¥æ¯ä¸€è¼ªé™£åˆ—æœƒæœ‰è‡³å¤š k å€‹ä½ç½®è¢«æ¨™è¨˜æˆ 1ï¼Œéœ€æ³¨æ„ Hash ä¹‹é–“ä¹Ÿå¯èƒ½æ¨™è¨˜åˆ°åŒä¸€å€‹ä½ç½®ï¼Œæ‰€ä»¥åœ¨æ©Ÿç‡ä¸Šæ˜¯ç¨ç«‹äº‹ä»¶ï¼Œæ‰€ä»¥æ˜¯æŸä½ç½®åœ¨æ’å…¥å¾Œä¸æœƒè¢«é¸ä¸­çš„æ©Ÿç‡æ˜¯ &lt;code>(1-1/m)^k&lt;/code>ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡ Hash å¾Œçš„å€¼éƒ½æ²’æœ‰é¸åˆ°ä»–&lt;/li>
&lt;li>æ‰€ä»¥æ’å…¥ n å€‹éµå€¼å¾Œï¼Œç¬¬ n + 1 å€‹ä¸æœƒç”¢ç”Ÿç¢°æ’çš„æ©Ÿç‡æ˜¯ &lt;code>(1-1/m)^(k*n)&lt;/code>&lt;/li>
&lt;li>æ›ç®—ä¸€ä¸‹ï¼Œæœƒç”¢ç”Ÿ False Positive çš„æ©Ÿç‡æ˜¯ &lt;code>(1 - (1-1/m)^(k*n))^k&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ç¬¬ n + 1 å€‹éµå€¼èˆ‡ä»»ä¸€ä¸€æ¬¡ Hash å¾Œç”¢ç”Ÿç¢°æ’çš„æ©Ÿç‡ï¼Œç°¡åŒ–å¾Œå¯ä»¥è®Šæˆ &lt;code>(1 - e ^ (-k*n/m))^k&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>å¾é€™å€‹å…¬å¼å¯ä»¥çœ‹å‡º&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>m è¶Šå¤§ï¼ŒFalse Positive çš„æ©Ÿç‡å°±è¶Šå°&lt;/code>ï¼Œé€™ä¹Ÿè »ç›´è§€çš„ï¼Œå› ç‚º Hash å¾Œç”¢ç”Ÿçš„ç¢°æ’æ©Ÿç‡è‡ªç„¶å°±è®Šå°ï¼›&lt;br>
ä½†æ˜¯ k çš„å€¼å°±æ¯”è¼ƒæ²’é€™éº¼ç›´è§€ï¼Œä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œä¹Ÿä¸æ˜¯è¶Šå°è¶Šå¥½ï¼Œè€Œæ˜¯åœ¨ m,n åœ¨å°æ‡‰çš„æ¯”ä¾‹ä¸‹ï¼Œæœƒæœ‰ä¸€å€‹æœ€å‰›å¥½çš„å€¼&lt;/p>
&lt;/blockquote>
&lt;p>æˆ‘å€‘å¯ä»¥ç”¨ &lt;a class="link" href="https://hur.st/bloomfilter/" target="_blank" rel="noopener"
>Bloom Filter Calculator&lt;/a> æ‰‹å‹•èª¿æ•´åƒæ•¸ï¼Œå»è©•ä¼°é æœŸçš„ False Positive æ©Ÿç‡èˆ‡æ‰€éœ€è¦è€—è²»çš„è¨˜æ†¶é«”ç©ºé–“ (m çš„å¤§å°)&lt;/p>
&lt;p>åŸºæœ¬ä¸Šï¼Œå¦‚æœ m æ˜¯ n çš„ 10 å€ï¼Œåœ¨é¸æ“‡ 4 å€‹ Hash function ä¸‹ False Positive æ©Ÿç‡ç´„ç‚º 1.2 %ï¼Œå¦‚æœé¸æ“‡ 5 å€‹ Hash function å‰‡æ©Ÿç‡é™ç‚º 0.9 %&lt;/p>
&lt;p>ä¸€é–‹å§‹åœ¨æ€è€ƒæ™‚ï¼Œæœƒæƒ³èªªæ˜æ˜å¢åŠ  Hash function çš„æ•¸é‡æ‡‰è©²æœƒå¢åŠ ç¢°æ’æ©Ÿç‡æ‰å°ï¼Œå¾Œä¾†æ‰æƒ³åˆ°å‰ææ˜¯ &lt;code>m &amp;gt;&amp;gt; n&lt;/code> çš„æ™‚å€™ï¼Œæœ‰è¶³å¤ çš„å¤šé¤˜ç©ºé–“è®“å¤šå€‹ Hash function çš„æ•´é«”ç¢°æ’æ©Ÿç‡æ›´å°&lt;/p>
&lt;h3 id="è®Šå½¢---å¢åˆªéµå€¼">è®Šå½¢ - å¢åˆªéµå€¼&lt;/h3>
&lt;p>å¦‚æœä»Šå¤©è¦åˆªé™¤éµå€¼æ™‚é †ä¾¿æ›´æ–° Bloom Filterï¼Œå°±ä¸èƒ½ç”¨ boolean å„²å­˜ï¼Œè€Œæ˜¯è¦ç”¨ unsigned integerï¼Œå¢åŠ æ™‚ + 1 ç§»é™¤æ™‚ - 1ï¼Œé‚£ integer éœ€è¦ 4 bit / 8 bit é‚„æ˜¯å¤šå°‘å€‹ bit æ‰è¶³å¤ å‘¢ ?!&lt;/p>
&lt;p>åŒä¸€ç¯‡éƒ¨è½æ ¼æ–‡ä¸­ï¼ŒåŒæ¨£æœ‰æ•¸å­¸æ¨å°ï¼Œä½†å› ç‚ºä¸å¤ªäº†è§£å°±å…ˆç•¥éï¼Œæœ€å¾Œçš„çµè«–å¦‚æœ Hash function è¶³å¤ éš¨æ©Ÿçš„è©± 4 bit æ‡‰è©²å·²ç¶“è¶³å¤ ï¼Œä½†éœ€è¦å°å¿ƒå¦‚æœéå¸¸éå¸¸ä¸å¹¸ 4 å€‹ bit ä¸å¤ å„²å­˜ï¼Œæœƒç”¢ç”Ÿ &lt;code>False Negative&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ Bloom Filter å›ç­”ä¸å†ä½†å¯¦éš›ä¸Šé‚„æ˜¯å­˜åœ¨çš„ç‹€æ³&lt;/p>
&lt;h2 id="å¯¦ä½œ">å¯¦ä½œ&lt;/h2>
&lt;p>å¯¦ä½œéƒ¨åˆ†ï¼Œå¯ä»¥æ‹†æˆå…©å€‹æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>å¦‚ä½•ç”¢ç”Ÿ k å€‹ç¨ç«‹çš„ Hash Function&lt;/li>
&lt;li>å¯¦ä½œæ’å…¥èˆ‡æŸ¥è©¢çš„ bitwise æ“ä½œ&lt;/li>
&lt;/ol>
&lt;h3 id="å¦‚ä½•ç”¢ç”Ÿ-k-å€‹ç¨ç«‹çš„-hash-function">å¦‚ä½•ç”¢ç”Ÿ k å€‹ç¨ç«‹çš„ Hash Function&lt;/h3>
&lt;p>å¦‚ä½•ç”¢ç”Ÿä¸€å€‹é‹ç®—å¿«é€Ÿã€è¶³å¤ éš¨æ©Ÿä¸” Universal çš„ Hash function æ˜¯éå¸¸é—œéµçš„ä¸€æ­¥ï¼Œå½±éŸ¿å¾ŒçºŒçš„éŒ¯èª¤ç‡ï¼Œé¸æ“‡ç”¨ non-cryptographic hash function å³å¯ï¼Œå¼·åº¦ä¸é«˜ä½†æ˜¯æ€§èƒ½å¤ å¥½ï¼Œå·®åˆ¥åœ¨æ–¼ hash å¾Œè¢«é€†æ¨çš„å¯èƒ½æ€§(æ²’æœ‰å¼·æŠ—ç¢°æ’èˆ‡å¼±æŠ—ç¢°æ’çš„ä¿è­‰)ï¼Œå¯èƒ½æœƒé­é‡ HashDosï¼Œè¢«ç™¼ç¾ç¢°æ’å¾Œå°±ä¸æ–·å˜—è©¦å°è‡´æ€§èƒ½è®Šå·®&lt;/p>
&lt;p>å›æ­¸æ­£é¡Œï¼Œçˆ¬äº†ä¸€äº› Bloom Filter çš„å¯¦ä½œï¼Œæœ‰ç™¼ç¾ä½¿ç”¨ xxHashã€MurMurHash ç­‰å·²çŸ¥çš„ hash function libraryï¼Œé€™ä¸€å€‹å¯¦ä½œè »æœ‰è¶£ &lt;a class="link" href="https://github.com/jasondavies/bloomfilter.js" target="_blank" rel="noopener"
>bloomfilter.js&lt;/a>ï¼ŒHash function æ˜¯å¯¦ä½œ &lt;a class="link" href="http://isthe.com/chongo/tech/comp/fnv/" target="_blank" rel="noopener"
>Fowlerâ€“Nollâ€“Vo(FNV) hash function&lt;/a>ï¼Œç¨‹å¼ç¢¼å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">function&lt;/span> &lt;span class="nx">fnv_1a&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">seed&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2166136261&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">seed&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">charCodeAt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff00&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">fnv_multiply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">fnv_multiply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xff&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">fnv_mix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// a * 16777619 mod 2**32
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">fnv_multiply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">24&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// See https://web.archive.org/web/20131019013225/http://home.comcast.net/~bretm/hash/6.html
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">fnv_mix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">17&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0xffffffff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ Stack Exchange çœ‹åˆ°æœ‰è¶£çš„å•ç­” &lt;a class="link" href="https://softwareengineering.stackexchange.com/questions/49550/which-hashing-algorithm-is-best-for-uniqueness-and-speed" target="_blank" rel="noopener"
>Which hashing algorithm is best for uniqueness and speed?&lt;/a>ï¼Œæœ‰å¼·è€…æ¯”è¼ƒå¤šç¨® Hash Function çš„æ•ˆèƒ½ä»¥åŠç¢°æ’æ©Ÿç‡ï¼ŒFNV-1a è¡¨ç¾é‚„ä¸éŒ¯ï¼Œä½†ä½œè€…æ¯”è¼ƒæ¨è–¦ Murmur2&lt;/p>
&lt;p>æ¥è‘—ï¼Œæœ‰å¦ä¸€ç¯‡è«–æ–‡ &lt;a class="link" href="https://www.eecs.harvard.edu/~michaelm/postscripts/tr-02-05.pdf" target="_blank" rel="noopener"
>Building a Better Bloom Filter&lt;/a> è­‰æ˜å¦‚æœè¦ç”¢ç”Ÿå¤šå€‹ Hash function æ‡‰ç”¨åœ¨ Bloom filter ä¸Šï¼Œåªéœ€è¦ç”¢ç”Ÿå…©å€‹ Hash function å†åŠ ä¸Šä¿‚æ•¸çš„çµ„åˆå‡ºå…¶ä»–çš„ Hash function å³å¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">h1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span> &lt;span class="nx">ih2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">mod&lt;/span> &lt;span class="nx">p&lt;/span> &lt;span class="c1">// p æ˜¯è³ªæ•¸
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å¦‚æœåŸæœ¬çš„éµå€¼å¾ˆé•·ï¼Œå†å®¹å¿ä¸€å®šçš„ False Positive ä¸‹ä½¿ç”¨ Bloom Filter å¯ä»¥ç¯€çœéå¸¸å¤§é‡çš„å„²å­˜ç©ºé–“ï¼Œä½†éœ€æ³¨æ„ Hash é‹ç®—æœƒå¤šä¸€äº› CPU è³‡æº&lt;/p></description></item><item><title>Raft æ¼”ç®—æ³•ä»‹ç´¹èˆ‡ã€ŠIn Search of an Understandable Consensus Algorithmã€‹æ‘˜è¦</title><link>https://yuanchieh.page/posts/2020/2020-11-03-raft-%E6%BC%94%E7%AE%97%E6%B3%95%E4%BB%8B%E7%B4%B9%E8%88%87in-search-of-an-understandable-consensus-algorithm%E6%91%98%E8%A6%81/</link><pubDate>Tue, 03 Nov 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-11-03-raft-%E6%BC%94%E7%AE%97%E6%B3%95%E4%BB%8B%E7%B4%B9%E8%88%87in-search-of-an-understandable-consensus-algorithm%E6%91%98%E8%A6%81/</guid><description>&lt;p>å…±è­˜æ¼”ç®—æ³•ä¸»è¦æ‡‰ç”¨æ–¼åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œä¸€å€‹é›†ç¾¤ä¸­æœ‰å¤šå€‹ç¯€é»çµ„æˆï¼Œè®“æ¯å€‹ç¯€é»éƒ½ç¶­è­·ç›¸åŒçš„ç‹€æ…‹ï¼Œä¾‹å¦‚èªªåœ¨å¤šç¨®ç³»çµ±ä¸­éƒ½éœ€è¦é›†ç¾¤æœ‰å–®ä¸€å€‹ Leader å­˜åœ¨ï¼Œæ‰€æœ‰ç¯€é»éƒ½å¿…é ˆæ‰¿èªé€™ä¸€å€‹ Leaderï¼Œå¦å‰‡å¤šå€‹ Leader å¯èƒ½æœƒå°è‡´ Split brain ç­‰è³‡æ–™ä¸ä¸€è‡´ç­‰å•é¡Œï¼›&lt;br>
ä½†å¦‚ä½•è®“ç¯€é»ç‹€æ…‹ä¸€è‡´æ˜¯ä¸€ä»¶ä¸ç°¡å–®çš„äº‹æƒ…ï¼Œè¦è€ƒæ…®åˆ°ç¯€é»å¯èƒ½å¤±æ•— / ç¶²è·¯å°åŒ…å»¶é²ç­‰ç­‰&lt;/p>
&lt;p>Raft æ¼”ç®—æ³•æ˜¯ç”±å²ä¸¹ä½›å¤§å­¸çš„æ•™æˆæ‰€æå‡ºï¼Œä»–åœ¨å½±ç‰‡ä¸­æåˆ°éå¾€çš„å…±è­˜æ¼”ç®—æ³• Paxos éæ–¼è¤‡é›œï¼Œä¸–ç•Œä¸ŠçœŸæ­£äº†è§£çš„äººæ²’æœ‰å¹¾å€‹ï¼Œå¸‚é¢ä¸Šçš„å¯¦ä½œä¹Ÿåˆ†æ­§å‡ºéå¸¸å¤šçš„å¯¦ä½œç‰ˆæœ¬ï¼Œç†è«–å¤ªéè‰±æ·±å°è‡´å¯¦å‹™ä¸Šæœ‰å¾ˆå¤§çš„è½å·®&lt;/p>
&lt;p>æ‰€ä»¥ä»–åœ¨è¨­è¨ˆ Raft çš„ä¸€å€‹æ ¸å¿ƒç†å¿µæ˜¯&lt;code>å¥½æ‡‚&lt;/code>ï¼Œä»–åœ¨ Conference ä¸Šä¹Ÿåƒ…ç”¨ç´„ 10 åˆ†é˜å°±å¤§è‡´ä»‹ç´¹å®Œ Raft çš„åŸç†ï¼Œæ•´ä»½è«–æ–‡ä¹Ÿæ‰ 16 é &lt;/p>
&lt;p>ä»¥ä¸‹å°‡æ•´ç†å½±ç‰‡ä»‹ç´¹èˆ‡è«–æ–‡æ‘˜è¦ï¼Œæ¢è¨ Raft å¦‚ä½•åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­è®“&lt;code>å¤šç¯€é»åœ¨å®¹å¿éŒ¯èª¤ä¸‹é”åˆ°å¼·ä¸€è‡´æ€§&lt;/code>&lt;/p>
&lt;h2 id="å½±ç‰‡ä»‹ç´¹">å½±ç‰‡ä»‹ç´¹&lt;/h2>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/no5Im1daS-o"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>å…ˆå¾åœ¨ Conf ä¸Šçš„ä»‹ç´¹å½±ç‰‡å¿«é€Ÿç†è§£ï¼ŒRaft ç”±ä¸‰å€‹éƒ¨åˆ†çµ„æˆ&lt;/p>
&lt;ol>
&lt;li>&lt;code>Leader Election&lt;/code>:&lt;br>
æ•´å€‹é›†ç¾¤ä¸­ç¥¨é¸å‡ºä¸€ä½ Leader&lt;/li>
&lt;li>&lt;code>Log Replication&lt;/code>:&lt;br>
Leader è² è²¬æ¥æ”¶ Client çš„æŒ‡ä»¤ï¼Œä¸¦æŠŠç‹€æ…‹åŒæ­¥åˆ°å¤šæ•¸ç¯€é»ä¸Š&lt;/li>
&lt;li>&lt;code>Safety&lt;/code>:&lt;br>
ç•¶ Leader è¦é‡æ–°ç¥¨é¸æ™‚ï¼Œç¢ºä¿æ“æœ‰æœ€æ–°è³‡æ–™çš„ç¯€é»æ‰èƒ½ç•¶ä¸Š Leaderï¼Œé¿å…ç¢ºèªé(commited)çš„è³‡æ–™è¢«å–æ¶ˆ&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹å°‡æ‘˜è¦è«–æ–‡ &lt;a class="link" href="https://raft.github.io/raft.pdf" target="_blank" rel="noopener"
>ã€ŠIn Search of an Understandable Consensus Algorithm (Extended Version)ã€‹&lt;/a>éƒ¨åˆ†å…§å®¹&lt;/p>
&lt;h1 id="è«–æ–‡æ‘˜è¦">è«–æ–‡æ‘˜è¦&lt;/h1>
&lt;p>Raft æ˜¯ä¸€ç¨®ç”¨æ–¼ç®¡ç†å‰¯æœ¬ç´€éŒ„çš„å…±è­˜æ¼”ç®—æ³•ï¼Œæ•ˆæœé¡ä¼¼æ–¼ Paxosï¼Œä½†çµæ§‹ä¸Šå®Œå…¨ä¸åŒï¼Œé€™ä¹Ÿä½¿å¾— Raft ç›¸è¼ƒæ–¼ Paxos æ›´å®¹æ˜“äº†è§£&lt;br>
ç‚ºäº†å¢åŠ å¯è®€æ€§ï¼ŒRaft è§£æ§‹å‡ºå¹¾å€‹å…±è­˜æ¼”ç®—æ³•ä¸­é—œéµçš„å…ƒç´ ï¼Œåƒæ˜¯ Leader Election / Log replication / Safetyï¼Œä¸¦é€éæ¸›å°‘ç‹€æ…‹é”åˆ°æ›´å¼·çš„å‡èšæ€§ (æ„æŒ‡ç¯€é»å¯ä»¥è®ŠåŒ–çš„ç‹€æ…‹å°‘ï¼Œå°±æ›´å®¹æ˜“é”åˆ°ä¸€è‡´)&lt;/p>
&lt;h2 id="1-introduction">1. Introduction&lt;/h2>
&lt;p>å…±è­˜æ¼”ç®—æ³• (Consensus) æä¾›ç”±æ©Ÿå™¨çµ„æˆçš„é›†åˆå¯ä»¥é‹ä½œé¡ä¼¼åŒä¸€é«”ä¸¦èƒ½å¤ å®¹å¿éƒ¨åˆ†æˆå“¡å‡ºéŒ¯ï¼Œä¹Ÿé€™æ˜¯é€™äº›ç‰¹æ€§ï¼Œå…±è­˜æ¼”ç®—æ³•åœ¨å»ºæ§‹å¤§å‹è»Ÿé«”ç³»çµ±æ˜¯å¾ˆé—œéµçš„è§’è‰²&lt;/p>
&lt;p>Paxos ä¸»å®°é€™ä¸€å¡Šè¿‘åå¹´ï¼Œä½†ä¸å¹¸çš„æ˜¯ Paxos å¾ˆé›£æ‡‚ï¼ŒåŒæ™‚åœ¨å¯¦å‹™ä¸Šéœ€è¦æœ‰å¾ˆè² è²¬çš„è¨­è¨ˆæ‰èƒ½å¤ ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸è«–æ˜¯å­¸ç”Ÿé‚„æ˜¯ç³»çµ±å·¥ç¨‹å¸«éƒ½ååˆ†å›°æ“¾&lt;/p>
&lt;p>æ‰€ä»¥ä½œè€…é–‹å§‹æƒ³è¦è¨­è¨ˆä¸€é–€è¶³å¤ å¥½ç†è§£ã€åŒæ™‚å°æ–¼ç³»çµ±å·¥ç¨‹å¸«ä¹Ÿå®¹æ˜“å¯¦è¸çš„å…±è­˜æ¼”ç®—æ³•&lt;/p>
&lt;blockquote>
&lt;p>our primary goal was &lt;code>understandability&lt;/code>: could we define a consensus algorithm for
practical systems and describe it in a way that is significantly easier to learn than Paxos&lt;/p>
&lt;/blockquote>
&lt;p>é€éè§£æ§‹å‡ºç¨ä»¶ä»¥åŠæ¸›å°‘æ©Ÿå™¨åœ¨ä¸ä¸€è‡´ç‹€æ…‹çš„å¯èƒ½æ€§ï¼Œè®“æ•´å€‹æ¼”ç®—æ³•æ›´å®¹æ˜“ç†è§£&lt;/p>
&lt;p>Raft æœ‰ä»¥ä¸‹å¹¾å€‹ç‰¹é»&lt;/p>
&lt;ol>
&lt;li>Strong Leader:&lt;br>
Log çš„å¯«å…¥å¿…é ˆç¶“ç”± Leader å†åˆ°å…¶ä»–ç¯€é»ä¸Šï¼Œé€™æ¨£å¯ä»¥ç°¡åŒ–å¾ˆå¤šä¸å¿…è¦çš„è¤‡é›œæ€§&lt;/li>
&lt;li>Leader Election:&lt;br>
åœ¨é¸èˆ‰æ™‚ï¼ŒRaft åˆ©ç”¨éš¨æ©Ÿå»¶é²(randomized timers)æ–¹å¼å¿«é€Ÿä¸”æœ‰æ•ˆè§£æ±ºå¯èƒ½çš„è¡çª (é¿å…å¤§å®¶åœ¨åŒä¸€å€‹æ™‚åˆ»æƒ³è¦è®Šæˆ Leader)&lt;/li>
&lt;li>èº«ä»½æ”¹è®Š&lt;br>
åœ¨æ”¹è®Šç¯€é»çš„è¨­å®šæª”æ™‚ï¼Œå¯ä»¥å°‡å‰å¾Œå…©ç¨®è¨­å®šæª”ä»¥è¯é›†æ–¹å¼åˆä½µ(joint consensus)ï¼Œåœ¨æ›´æ”¹è¨­å®šåŒæ™‚é‚„èƒ½ç¶­æŒæœå‹™&lt;/li>
&lt;/ol>
&lt;p>ä½œè€…èªç‚º Raft æ˜¯å€‹å„ªç•°çš„å…±è­˜æ¼”ç®—æ³•ï¼Œå°±è®“æˆ‘å€‘ç¹¼çºŒå¾€ä¸‹çœ‹&lt;/p>
&lt;h2 id="2-replicated-state-machines">2. Replicated state machines&lt;/h2>
&lt;p>Replicated state machines æ˜¯æŒ‡ä¸€ç¾¤æ©Ÿå™¨çš„é›†åˆï¼Œå¯ä»¥é‹ç®—å‡ºç›¸åŒçš„ç‹€æ…‹ï¼Œä¸¦åœ¨å°‘æ•¸ç¯€é»å¤±æ•—æ™‚é‚„èƒ½æ­£å¸¸é‹è¡Œï¼Œä¸»è¦ç”¨ä¾†è§£æ±ºåˆ†æ•£å¼ç³»çµ±ä¸­å„ç¨®éŒ¯èª¤å®¹å¿æ€§çš„å•é¡Œï¼Œä¾‹å¦‚ GFS / HDFS / RAMCloudï¼Œåœ¨é€™äº›ç³»çµ±ä¸­æœ‰ç¨ç«‹çš„ Replicated state machine æŒç®¡ Leader Election / ä¿å­˜ Configï¼Œåœ¨ Leader crash æƒ…æ³ä¸‹é‚„èƒ½ç¹¼çºŒé‹ä½œï¼›
Replicated state machine çš„å¯¦éš›æ¡ˆä¾‹æœ‰ Chubby / ZooKeeper&lt;/p>
&lt;p>Replicated state machine é€šå¸¸æ˜¯ç”±è¤‡è£½ Log æ‰€å¯¦è¸ï¼Œå¦‚ä¸‹åœ–ï¼Œæ¯å€‹ Server éƒ½æœ‰ä¸€ä»½ logï¼Œä¾ç…§ç›¸åŒé †åºç´€éŒ„è‘—ç›¸åŒçš„æŒ‡ä»¤ï¼Œé‹ç®—æ•´ä»½ log å°±èƒ½å¾—åˆ°ç›¸åŒçš„ç‹€æ…‹æ©Ÿ (state machine)&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201103/stateMachine.png"
loading="lazy"
alt="stateMachine"
>&lt;/p>
&lt;p>å¾ client æ”¶åˆ°æŒ‡ä»¤å¾Œï¼Œ&lt;code>å¦‚ä½•ä¿æŒé †åºè¤‡è£½ç›¸åŒçš„æŒ‡ä»¤åˆ°æ¯å°æ©Ÿå™¨ä¸Šï¼Œå°±æ˜¯å…±è­˜æ¼”ç®—æ³•çš„ä»»å‹™&lt;/code>ï¼Œå…±è­˜æ¼”ç®—æ³•å…·é«”æä¾›ä¸‹åˆ—ä¿è­‰&lt;/p>
&lt;ol>
&lt;li>Safety:&lt;br>
åœ¨éæ‹œå åº­æƒ…æ³ä¸‹ï¼Œç³»çµ±å³ä½¿é­é‡ç¶²è·¯å»¶é²ã€ç¶²è·¯åˆ†éš” (partition)ã€å°åŒ…éºå¤±ã€æŒ‡ä»¤é‡è¤‡ç™¼é€ã€ç™¼é€é †åºæ”¹è®Šç­‰å•é¡Œï¼Œéƒ½ä¸å½±éŸ¿çµæœ&lt;/li>
&lt;li>åªè¦å¤šæ•¸ç¯€é»å­˜æ´»å°±èƒ½å¤ æ­£å¸¸é‹è¡Œï¼Œä¾‹å¦‚ 5 å€‹ç¯€é» 3 å€‹é‚„æ´»è‘—å°±å¯ä»¥ï¼Œä¸¦ä¸”å¤±æ•—çš„ç¯€é»å¯ä»¥åœ¨å¾Œé¢é‡æ–°åŠ å›é›†ç¾¤ä¸­&lt;/li>
&lt;li>ä¸ä¾è³´æ™‚é–“ç•¶ä½œåˆ¤æ–·ï¼Œåœ¨åˆ†æ•£å¼ç³»çµ±ä¸­æ™‚é–“æ˜¯ä¸å¯ä¿¡çš„(é™¤éå­¸ Google ç”¨åŸå­é˜è‡ªå¹¹å‡º &lt;a class="link" href="https://cloud.google.com/spanner/docs/true-time-external-consistency" target="_blank" rel="noopener"
>TrueTime&lt;/a> )ï¼Œæ¯å€‹ç³»çµ±éƒ½å­˜åœ¨è‘—æ™‚é˜æ²’å°é½Šçš„å¯èƒ½&lt;/li>
&lt;li>å¤šæ•¸ç¯€é»æœ‰å›æ‡‰æ”¶åˆ°å‰¯æœ¬å°±ç®—æˆåŠŸï¼Œå°‘æ•¸ç¯€é»æ™šå›è¦†ä¸æœƒé€ æˆæ€§èƒ½å½±éŸ¿&lt;/li>
&lt;/ol>
&lt;h2 id="3-whats-wrong-with-paxos">3. Whatâ€™s wrong with Paxos?&lt;/h2>
&lt;p>é€™ä¸€ç« ç¯€ä¸»è¦åœ¨æç¹ª Paxos çš„èƒŒæ™¯èˆ‡æœ‰å¤šé›£ç†è§£çš„åŸå› ï¼Œä½†å› ç‚ºä¹‹å‰æ²’æœ‰å­¸é Paxosï¼Œå°±å…ˆç•¥éé€™ç« &lt;/p>
&lt;h2 id="4-designing-for-understandability">4. Designing for understandability&lt;/h2>
&lt;p>é€™ä¸€ç« ç¯€ä¸»è¦æ˜¯ä½œè€…ä¸æ–·å¼·èª¿ &lt;code>understandability&lt;/code> æ˜¯ä»–å€‘çš„æ ¸å¿ƒç†å¿µï¼Œç•¶é‡åˆ°è¨­è¨ˆæœ‰å¤šç¨®æ–¹æ¡ˆé¸æ“‡æ™‚ï¼Œä»–å€‘æœƒé¸æ“‡æœ€å¥½è§£é‡‹çµ¦åˆ¥äººè½çš„é‚£ä¸€å€‹ï¼Œå°æ–¼ä»–å€‘ä¾†èªªå¯è®€æ€§æ˜¯æ ¸å¿ƒç†å¿µ&lt;/p>
&lt;p>å…·é«”ä¸Šï¼Œé€é &lt;code>decomposition æ‹†åˆ†ç¨ç«‹æ¨¡çµ„&lt;/code>ä»¥åŠ&lt;code>æ¸›å°‘ä¸ç¢ºå®šæ€§èˆ‡ç‹€æ…‹å¯èƒ½æ€§&lt;/code> é”æˆç›®çš„ï¼Œä½†åœ¨æŸä¸€äº›éƒ¨åˆ†é‚„æ˜¯æœ‰ç”¨ä¸Šéš¨æ©Ÿæ€§ï¼Œå› ç‚ºé€™è®“æ¼”ç®—æ³•æ›´å¥½ç†è§£&lt;/p>
&lt;h2 id="5-the-raft-consensus-algorithm">5. The Raft consensus algorithm&lt;/h2>
&lt;p>Raft åœ¨å¯¦ä½œä¸Šæœƒå…ˆé¸å‡ºä¸€å Leader ï¼Œç”± Leader ç®¡ç† log çš„è¤‡è£½åˆ°å…¶ä»–ç¯€é»çš„ç‹€æ…‹æ©Ÿä¸Šï¼Œé€é Leader çš„å¥½è™•æ˜¯ä¸éœ€è¦å…¶ä»–ç¯€é»åŒæ„ Leader èƒ½ç¨è‡ªæ±ºå®šæ–°çš„ log è¦å„²æ”¾çš„ä½ç½®ï¼›&lt;br>
å¦‚æœ Leader å¤±æ•—äº†å¯ä»¥å†é¸æ–°çš„ Leader å‡ºä¾†&lt;/p>
&lt;h3 id="51-raft-basics">5.1 Raft basics&lt;/h3>
&lt;p>é€šå¸¸ Raft é›†ç¾¤æœƒç”±äº”å€‹ç¯€é»çµ„æˆï¼Œå¯ä»¥å®¹å¿å…©å€‹ç¯€é»å¤±æ•—ï¼Œè€Œæ¯å€‹ç¯€é»æœ‰ä¸‰ç¨®ç‹€æ…‹ &lt;code>leader / follower / candidate&lt;/code>ï¼Œé€šå¸¸æƒ…æ³ä¸‹æ˜¯ä¸€å€‹ leader å…¶ä»–äººéƒ½æ˜¯ follower&lt;/p>
&lt;ol>
&lt;li>follower: è¢«å‹•çš„è™•ç†ä¾†è‡ª leader æˆ– candidate çš„è«‹æ±‚&lt;/li>
&lt;li>leader: è² è²¬æ‰€æœ‰ client çš„ requestï¼Œä¸¦è¤‡è£½æŒ‡ä»¤åˆ° follower ä¸­&lt;/li>
&lt;li>candidate: follower ç™¼ç¾æ²’æœ‰ leaderï¼Œè¨­ä¸€å€‹éš¨æ©Ÿ timeout åˆ‡æ›æˆ candidate æ¨¡å¼ï¼Œæº–å‚™è¦é¸æ–° leader&lt;/li>
&lt;/ol>
&lt;p>ä¸‹åœ–ç‚ºç‹€æ…‹æ©Ÿç¤ºæ„åœ–
&lt;img src="https://yuanchieh.page/post/img/20201103/state.png"
loading="lazy"
alt="state-machine"
>&lt;/p>
&lt;p>Raft å°‡æ™‚é–“åˆ‡å‰²æˆ &lt;code>å›åˆ (term)&lt;/code>ï¼Œæ¯ä¸€å€‹å›åˆä»£è¡¨è‘—ä¸€æ¬¡çš„é¸èˆ‰ï¼Œä¹Ÿå°±æ˜¯ candidate å»ç«¶é¸ leader çš„éç¨‹ï¼Œå¦‚æœæˆåŠŸæ¨é¸å‡º leader å¾Œï¼Œå‰‡æ¯å€‹ç¯€é»ç´€éŒ„é€™ä¸€å€‹å›åˆæ•¸ï¼›å¦‚æœé¸èˆ‰å¤±æ•—ï¼Œå‰‡é–‹å•Ÿæ–°çš„å›åˆç›´åˆ°æœ‰äººæˆç‚º leader&lt;/p>
&lt;p>ä»¥ä¸‹ç‚ºæ¦‚å¿µåœ–
&lt;img src="https://yuanchieh.page/post/img/20201103/term.png"
loading="lazy"
alt="term"
>&lt;/p>
&lt;p>å›åˆæœ¬èº«æ˜¯ä¸€å€‹éå¢æ•¸å€¼ï¼Œç”¨ä¾†è¡¨ç¤ºé‚è¼¯ä¸Šçš„æ™‚é–“æ¦‚å¿µï¼Œæœ‰å¯èƒ½ç¯€é»è§€å¯Ÿåˆ°çš„å›åˆè·Ÿå…¶ä»–ç¯€é»ä¸åŒï¼Œå¦‚æœå›åˆæ•¸å°å‰‡ä»£è¡¨è‡ªèº«çš„è³‡æ–™éæ™‚ï¼Œä»–å¿…é ˆæ›´æ–°è‡ªå·±çš„å›åˆæ•¸ï¼›&lt;br>
ä¾‹å¦‚èªªåŸæœ¬çš„ leader å¯èƒ½æ–·ç·šï¼Œå…¶ä»–ç¯€é»æ¨é¸å‡ºæ–°çš„ leader å‰‡æœƒé€²åˆ°ä¸‹ä¸€å€‹å›åˆæ•¸ï¼Œ&lt;code>åŸæœ¬çš„ leader å›æ­¸å¾Œç™¼ç¾è‡ªå·±çš„å›åˆæ•¸æ¯”è¼ƒå°ï¼Œå‰‡æœƒä¸»å‹•è®Šæˆ follower&lt;/code>ï¼›&lt;br>
å¦‚æœç¯€é»æ”¶åˆ°è«‹æ±‚æ™‚ï¼Œç™¼ç¾å›åˆæ•¸æ¯”è‡ªå·±å°ï¼Œå‰‡ä»£è¡¨è«‹æ±‚éæœŸï¼Œç›´æ¥æ‹‹æ£„è©²è«‹æ±‚&lt;/p>
&lt;h3 id="52-leader-election">5.2 Leader election&lt;/h3>
&lt;p>Raft é€é &lt;code>heartbeat&lt;/code> è§¸ç™¼ leader é¸èˆ‰ï¼Œç•¶ leader é¸ä¸Šæ™‚ï¼Œæœƒåœ¨å›ºå®šæ™‚é–“å…§ç™¼&lt;code>å…§å®¹ç‚ºç©ºçš„ AppendEntries RPC ç•¶ä½œå¿ƒè·³åŒ…&lt;/code>ï¼Œå¦‚æœ follower è¶…é election timeout æ²’æœ‰æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œå‰‡é€²å…¥é¸èˆ‰éšæ®µ&lt;/p>
&lt;p>folower æœƒå°‡ç¾ä»Šçš„å›åˆæ•¸åŠ ä¸€ä¾¿è½‰ç‚º candidateï¼Œä¸¦è«‹æ±‚å…¶ä»– follower æŠ•ç¥¨çµ¦ä»– &lt;code>RequestVote RPC&lt;/code>ï¼Œé‡åˆ°ä»¥ä¸‹æƒ…æ³ candidate æ‰æœƒæ”¹è®Šç‹€æ…‹&lt;/p>
&lt;ol>
&lt;li>è´å¾—é¸èˆ‰&lt;/li>
&lt;li>å…¶ä»–ç¯€é»æˆç‚º leader&lt;/li>
&lt;li>è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º leader&lt;/li>
&lt;/ol>
&lt;h4 id="è´å¾—é¸èˆ‰">è´å¾—é¸èˆ‰&lt;/h4>
&lt;p>å¦‚æœ candidate æ‹¿ä¸‹éåŠçš„ç¥¨æ•¸ï¼Œå‰‡æˆç‚ºæ–°çš„ leaderï¼Œæ¯ä¸€å€‹ follower &lt;code>åœ¨åŒä¸€å€‹å›åˆæ•¸ä¸‹åªæœƒæŠ•ç¥¨çµ¦è«‹æ±‚å…ˆåˆ°çš„ candidate&lt;/code>ï¼Œé€™é¿å…ç„¡æ•ˆé¸èˆ‰çš„ç™¼ç”Ÿ&lt;br>
å¦‚æœ candidate æˆç‚º leaderï¼Œå‰‡é–‹å§‹ç™¼é€å¿ƒè·³åŒ…&lt;/p>
&lt;h4 id="ç™¼ç¾æœ‰å…¶ä»–-leader">ç™¼ç¾æœ‰å…¶ä»– leader&lt;/h4>
&lt;p>å¦‚æœåœ¨ candidate éšæ®µæ”¶åˆ°å¿ƒè·³åŒ…(AppendEntries)ï¼Œå‰‡ä»£è¡¨æœ‰å…¶ä»– leader ç”¢ç”Ÿï¼Œcandidate æœƒå»æ¯”å°å›åˆæ•¸è‡³å°‘è¦å¤§æ–¼ç­‰æ–¼ä»–è‡ªèº«çš„å›åˆæ•¸ï¼Œå¦‚æœæ˜¯å‰‡è½‰æˆ followerï¼›&lt;br>
åä¹‹å‰‡ç¹¼çºŒç¶­æŒ candidate&lt;/p>
&lt;h4 id="è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º-leader">è¶…éä¸€å®šæ™‚é–“éƒ½æ²’é¸å‡º leader&lt;/h4>
&lt;p>è¶…éä¸€å®šæ™‚é–“é‚„æ˜¯æ²’æœ‰é¸å‡ºä¾†çš„è©±ï¼Œtimeout å¾Œé–‹å§‹ä¸‹ä¸€è¼ªæ–°çš„é¸èˆ‰&lt;/p>
&lt;p>Raft é€éåœ¨ä¸€å®šæ™‚é–“å…§éš¨æ©Ÿ timeout (150-300ms)ï¼Œé¿å…æ‰€æœ‰çš„ follower åŒæ™‚é€²å…¥é¸èˆ‰éšæ®µï¼Œé€™æ¨£èƒ½åŠ é€Ÿ leader çš„æ¨é¸ï¼Œå¾ŒçºŒæœƒæœ‰æ›´è¿‘ä¸€æ­¥çš„èªªæ˜&lt;/p>
&lt;p>åœ¨è¨­è¨ˆéç¨‹ï¼Œä½œè€…æ›¾è€ƒæ…®åŠ å…¥ rank ï¼Œrank è¼ƒé«˜è€…æ›´æœ‰æ©Ÿæœƒæˆç‚º leaderï¼Œä½†ç™¼ç¾é€™æœƒå°è‡´æ¼”ç®—æ³•è¨­è¨ˆæ›´åŠ è¤‡é›œï¼Œä¸”æœ‰å¯ç”¨æ€§çš„å•é¡Œï¼Œä¾‹å¦‚é«˜é †ä½ candidate ç™¼ç”Ÿç‹€æ³ï¼Œå‰‡ä½é †ä½ candidate è¦å¤šä¸€æ¬¡ timeout æ‰èƒ½ç•¶ä¸Š leader ç­‰å•é¡Œ&lt;/p>
&lt;h3 id="53-log-replication">5.3 Log replication&lt;/h3>
&lt;p>Leader æœƒé€é AppendEntries RPC å°‡æŒ‡ä»¤åŒæ­¥åˆ° follower ä¸¦å›å‚³åŸ·è¡Œçµæœçµ¦ clientï¼Œå¦‚æœ follower æ­¤æ™‚ crash ç­‰ï¼Œleader æœƒæŒçºŒé€ç›´åˆ° follower ç‹€æ…‹åŒæ­¥&lt;/p>
&lt;p>Log æ˜¯ä»¥ &lt;code>å›åˆæ•¸ + æŒ‡ä»¤&lt;/code> çš„æ–¹å¼ä¾åºå„²å­˜ï¼Œä¸»è¦æ˜¯æª¢è¦–æ˜¯å¦æœ‰ä¸ä¸€è‡´çš„ç‹€æ³ç”¢ç”Ÿ&lt;/p>
&lt;p>æ¯å€‹ç¯€é»éƒ½æœƒä¿å­˜ç¾ä»Šæœ€å¾Œä¸€å€‹ commited log çš„ç´¢å¼• (&lt;code>commitIndex&lt;/code>)ï¼ŒLeader åœ¨åŒæ­¥ log æ™‚ï¼Œæœƒç´€éŒ„ log è¦å¯«å…¥çš„ä½ç½® (commitIndex + 1)ï¼Œä¸¦åŒæ™‚ç™¼é€çµ¦ follower (leaderCommit)ï¼Œç­‰åˆ°å¤šæ•¸çš„ follower éƒ½å¯«å…¥ log å¾Œæ‰æ¨™è¨˜æˆ &lt;code>commited&lt;/code>ï¼ŒRaft ä¿è­‰ commited log æ˜¯å·²ç¶“æŒä¹…åŒ–ä¸”æœ€çµ‚æ¯å€‹ follower éƒ½æœƒé”åˆ°ä¸€è‡´æ€§&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/log.png"
loading="lazy"
alt="log"
>&lt;/p>
&lt;p>å› æ­¤ Raft ä¿è­‰ Logs æœ‰ä»¥ä¸‹ç‰¹æ€§&lt;/p>
&lt;ol>
&lt;li>å¦‚æœä»»æ„å…©å€‹ç¯€é»çš„ log æœ‰è‘—ç›¸åŒçš„ index èˆ‡å›åˆæ•¸ï¼Œå‰‡ä»–å€‘å¿…å®šå„²å­˜ç›¸åŒçš„æŒ‡ä»¤&lt;/li>
&lt;li>å¦‚æœä»»æ„å…©å€‹ç¯€é»çš„ log æœ‰è‘—ç›¸åŒçš„ index èˆ‡å›åˆæ•¸ï¼Œå‰‡è©²æŒ‡ä»¤å…ˆå‰çš„ log ç´€éŒ„éƒ½å¿…å®šç›¸åŒ&lt;/li>
&lt;/ol>
&lt;p>ç¬¬ä¸€é»ä¿è­‰ç¯€é»å„²å­˜ log å¾Œå°±ä¸æœƒå†è¢«æ”¹è®Šï¼Œç¬¬äºŒé»å‰‡ç¢ºä¿ç•¶ follower ç™¼ç¾è‡ªå·±çš„ log è·Ÿ leader ä¸åŒæ™‚ï¼Œå¯ä»¥ä¾æ­¤é‡æ–°è·Ÿ leader åŒæ­¥ç´€éŒ„&lt;/p>
&lt;p>Leader æœƒé‡å°æ¯ä¸€å€‹ follower ç¶­è­·æŒ‡é‡ &lt;code>nextIndex&lt;/code>ï¼Œç”¨ä¾†è¨˜éŒ„ follower ç›®å‰éœ€è¦åŒæ­¥çš„ log ç´¢å¼•ï¼Œleader åœ¨ç™¼é€ AppendEntries æŒ‡ä»¤æ™‚ï¼Œæœƒå¤¾å¸¶æœ€æ–° committed log çš„å›åˆæ•¸èˆ‡ indexï¼Œè®“ follower å¯ä»¥æ¯”å° log æ˜¯å¦åŒæ­¥ï¼Œå¦‚æœ follower åœ¨è‡ªå·±çš„ logs ä¸­æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„ç´€éŒ„ï¼Œå‰‡ä»£è¡¨å…©è€…éåŒæ­¥ï¼Œå›å‚³å¤±æ•—ï¼Œæ¥è‘— &lt;code>Leader ä¸æ–·éæ¸› nextIndex ç›´åˆ° follower æ‰¾åˆ°å…©è€…æœ€è¿‘ä¸€æ¬¡åŒæ­¥çš„ç´€éŒ„&lt;/code>ï¼Œæ¥è‘—é–‹å§‹ä¸€æ­¥æ­¥åŒæ­¥ç´€éŒ„&lt;/p>
&lt;blockquote>
&lt;p>leader èˆ‡ follower æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡åŒæ­¥ç´€éŒ„çš„æ–¹å¼ï¼Œå¯ä»¥å„ªåŒ–æˆ follower å›å‚³é€™ä¸€å€‹å›åˆæ•¸ä¸‹ä»–æ‰€ä»¥ç´€éŒ„çš„ç´¢å¼•ï¼Œleader ç›´æ¥å€’å›é€™å€‹å›åˆé–‹å§‹åŒæ­¥ï¼›&lt;br>
ä½†ä½œè€…èªç‚ºä¸ä¸€è‡´ç‹€æ…‹æ‡‰è©²å¾ˆå°‘ç™¼ç”Ÿï¼Œå„ªåŒ–çš„æ•ˆç›Šä¸å¤§&lt;/p>
&lt;/blockquote>
&lt;p>é€éé€™æ¨£çš„ log åŒæ­¥è¨­è¨ˆï¼ŒLeader åœ¨å‰›å•Ÿå‹•æ™‚ä¸ç”¨æ“”å¿ƒå¤ªå¤šåŒæ­¥çš„å•é¡Œï¼Œåˆ©ç”¨ AppendEntries çš„æˆåŠŸèˆ‡å¤±æ•—å»èª¿é… follower å„²å­˜çš„ç´€éŒ„ï¼Œleader ä¹Ÿä¸ç”¨å»åˆªé™¤æˆ–æ›´æ–°è‡ªèº«çš„ logï¼Œè®“æ•´å€‹åŒæ­¥çš„éç¨‹æ›´åŠ çš„ç°¡å–®&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/AppendEntries.png"
loading="lazy"
alt="AppendEntries"
>&lt;/p>
&lt;h3 id="54-safety">5.4 Safety&lt;/h3>
&lt;p>å…ˆå‰ä»‹ç´¹äº† leader election å’Œ relicate logï¼Œä½†åƒ…æœ‰é€™æ¨£çš„æ©Ÿåˆ¶æ˜¯ä¸å¤ çš„ï¼Œè©¦æƒ³å¦‚æœ leader ç™¼ç”ŸéŒ¯èª¤ï¼Œä»Šå¤©æœ‰ä¸€å€‹ follower åƒ…åŒ…å«éƒ¨åˆ†çš„ commited logï¼Œé¸ä¸Š leader å¾Œä¾¿æœƒè¤‡å¯«åŸæœ¬å…¶ä»–å·²ç¶“ commited çš„ logï¼Œé€™æ¨£å°±ä¸èƒ½ä¿è­‰ä¸€è‡´æ€§èˆ‡æŒä¹…åŒ–&lt;/p>
&lt;p>é€™ä¸€ç« ä»‹ç´¹ Raft åœ¨ leader election åŠ ä¸Šé™åˆ¶å¾Œï¼Œå¦‚ä½•é”åˆ°&lt;code>ç¢ºä¿æ¯ä¸€å°ç‹€æ…‹æ©Ÿéƒ½ä»¥ç›¸åŒé †åºä¿å­˜ç›¸åŒçš„æŒ‡ä»¤&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/safety.png"
loading="lazy"
alt="safety"
>&lt;/p>
&lt;p>Raft æœƒç¢ºä¿ä»»ä½•æ™‚å€™é›†ç¾¤éƒ½ç¬¦åˆä¸Šè¿°æ¢ä»¶&lt;/p>
&lt;ol>
&lt;li>Election Safety: æ¯ä¸€è¼ªé¸èˆ‰è‡³å¤šåªé¸å‡ºä¸€ä½ leader&lt;/li>
&lt;li>Leader Append-Only: leader å¾ä¸åˆªé™¤æˆ–æ”¹å¯«è‡ªå·±çš„ logï¼Œåªæœƒä¸€ç›´å¢åŠ &lt;/li>
&lt;li>Log Matching: ä»»å…©ä»½ logs åœ¨åŒä¸€å€‹ term åŒä¸€å€‹ index ä¸Šï¼Œå‰‡ log å…§å®¹å¿…å®šç›¸åŒï¼Œä¸”å…ˆå‰çš„ log ä¹Ÿéƒ½ç›¸åŒ&lt;/li>
&lt;li>Leader Completeness: æŸå€‹ log åœ¨ä»»ä¸€ä¸€å€‹ term ä¸­èªå®š commitedï¼Œå‰‡å¾ŒçºŒ term ä¸­çš„ leader éƒ½å¿…é ˆæœ‰è©²ä»½ log&lt;/li>
&lt;li>State Machine Safety: å¦‚æœæŸå€‹ server åœ¨æŸ index ä¸Šçš„ log å¥—ç”¨è‡³ç‹€æ…‹æ©Ÿï¼Œå‰‡ä¸æœƒæœ‰å…¶ä»–çš„ server åœ¨åŒä¸€å€‹ index ä¸Šå¥—ç”¨ä¸åŒçš„ log&lt;/li>
&lt;/ol>
&lt;h4 id="541-election-restriction">5.4.1 Election restriction&lt;/h4>
&lt;p>åœ¨ leader-based çš„å…±è­˜æ¼”ç®—æ³•ä¸­ï¼Œleader æœ€çµ‚æœƒå„²å­˜æ‰€æœ‰çš„ commited logï¼Œåœ¨æŸäº›æ¼”ç®—æ³•ä¸­ï¼Œleader åœ¨æ²’æœ‰ä¿å­˜æ‰€æœ‰ commited log æƒ…æ³ä¸‹ä¹Ÿèƒ½å¤ æª”é¸ï¼Œä¸¦é€éé¡å¤–çš„æ©Ÿåˆ¶å»å›è£œé€™äº›æœªåŒæ­¥çš„ logï¼Œé€™å¢åŠ äº†è »å¤šçš„è¤‡é›œæ€§&lt;/p>
&lt;p>Raft ç¢ºä¿ leader å¿…é ˆæ˜¯ç”± &lt;code>æ“æœ‰å¤§å¤šæ•¸ç¯€é»åŒæ„çš„æœ€æ–° committed log çš„ candidate&lt;/code> æ‰èƒ½ç•¶é¸ï¼Œç¢ºä¿ leader ä¸€å®šæ˜¯æ“æœ‰æœ€æ–° log çš„ç¯€é»ï¼Œåªè² è²¬å¢åŠ æ–°çš„ logï¼Œè®“è³‡æ–™æµåªæœ‰ä¸€å€‹æ–¹å‘ï¼Œçœå»å…¶ä»–çš„éº»ç…©&lt;/p>
&lt;p>åœ¨ RequestVote RPC ä¸­å¢åŠ äº†é™åˆ¶ï¼ŒRPC ä¸­å¤¾å¸¶ candidate æœ€å¾Œä¸€å€‹ log ä¸­çš„å›åˆæ•¸èˆ‡ç´¢å¼•æ•¸ï¼Œå¦‚æœ follower ç™¼ç¾ candidate çš„ç´€éŒ„æ¯”è‡ªå·±èˆŠï¼Œå‰‡å›å‚³å¤±æ•—&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/RequestVote.png"
loading="lazy"
alt="RequestVote"
>&lt;/p>
&lt;h4 id="542-committing-entries-from-previous-terms">5.4.2 Committing entries from previous terms&lt;/h4>
&lt;p>å…ˆå‰æåˆ°ï¼ŒLeader æœƒç­‰å¤šæ•¸çš„ç¯€é»å„²å­˜ log æ‰æ¨™è¨˜æˆ commitedï¼Œ ä½†å¦‚æœ leader å°‡ log å¯«åˆ°å¤šå€‹ follower å¾Œï¼Œé‚„ä¾†ä¸åŠæ”¶åˆ° commited å°± crash äº†&lt;br>
æ­¤æ™‚&lt;code>æ–°çš„ leader æœƒæŒçºŒåŒæ­¥ logï¼Œä½†ç„¡æ³•ç¢ºèªå…ˆå‰çš„ log æ˜¯ä¸æ˜¯è¢« commit&lt;/code> äº†ï¼Œå› ç‚ºåªæœ‰å…ˆå‰çš„ leader æ‰èƒ½ç¢ºèª log å·²ç¶“è¢«å¤šæ•¸çš„ç¯€é»æ‰€ä¿å­˜&lt;/p>
&lt;p>å¦‚ä»¥ä¸‹åœ–ç¤º
&lt;img src="https://yuanchieh.page/post/img/20201103/commit.png"
loading="lazy"
alt="commit"
>&lt;/p>
&lt;ol>
&lt;li>S1 ä¸€é–‹å§‹æ˜¯ leaderï¼ŒåŒæ­¥ term2 åˆ° S2 å°± crash&lt;/li>
&lt;li>S5 æ¥è‘—ç•¶ leader (S3,S4 å¯ä»¥æŠ•çµ¦ä»–) é–‹å§‹äº† term 3ï¼Œæ­¤æ™‚ç™¼ç”Ÿ crash&lt;/li>
&lt;li>S1 åˆå›ä¾†ç•¶ leaderï¼Œå°‡ term2 çš„ log åŒæ­¥åˆ° S3 å¾Œï¼Œæ­¤æ™‚åˆ crash&lt;/li>
&lt;/ol>
&lt;p>æ¥è‘—æ‹†å…©ç¨®æƒ…æ³&lt;br>
d. S1 ä¾†ä¸åŠåŒæ­¥ term4 è³‡æ–™ï¼Œå‰‡ S5 æœ‰æ©Ÿæœƒç•¶å…¥ leaderï¼Œä¸¦ç”¨ term3 è¤‡å¯«æ‰å…¶ä»–è³‡æ–™&lt;br>
e. S1 åŒæ­¥ term4 è³‡æ–™åˆ°å¤§å¤šæ•¸ç¯€é»ä¸Šï¼Œå‰‡ S5 ç„¡æ³•ç•¶ä¸Š leader&lt;/p>
&lt;p>&lt;code>åœ¨ leader é‚„æ²’æ”¶åˆ° commited æƒ…æ³ä¸‹ï¼Œå³ä½¿å¤šæ•¸çš„ç¯€é»å·²ç¶“åŒæ­¥ logï¼Œä½†æ–°çš„ leader æœ‰æ©Ÿæœƒè¤‡å¯«&lt;/code>&lt;/p>
&lt;p>ç‚ºäº†æ¸›å°‘é€™æ¨£çš„æƒ…æ³ï¼ŒRaft ä¸å»è¨ˆç®—å…ˆå‰ log æ‰€åŒæ­¥çš„å‰¯æœ¬æ•¸å»åˆ¤å®šæ˜¯å¦ commitedï¼Œ&lt;code>åªæœ‰ leader ç•¶ä¸‹çš„å›åˆæ•¸æ˜¯é€éå‰¯æœ¬çš„è¨ˆç®—ä¾†æ±ºå®š log æ˜¯å¦è¢« commitedï¼Œå¦‚æœ commit å¾Œï¼Œå‰‡å…ˆå‰çš„æ‰€æœ‰ log éƒ½è¢«è¦–ç‚º commited&lt;/code>ï¼Œé™ä½è¨ˆç®—ä¸Šçš„è¤‡é›œæ€§ï¼Œä¸¦å› ç‚ºä¹‹å‰çš„ log ç‰¹æ€§ä¿è­‰ï¼Œå…ˆå‰çš„ log ä¸€å®šä¹Ÿéƒ½è¢«è¤‡è£½åˆ°å…¶ä»–å‰¯æœ¬ä¸Š&lt;/p>
&lt;h4 id="543-safety-argument">5.4.3 Safety argument&lt;/h4>
&lt;p>æ›´é€²ä¸€æ­¥è§£é‡‹ &lt;code>Leader Completeness&lt;/code>ï¼Œé€éåè­‰æ³•ï¼Œæ‰¾å‡ºé›†ç¾¤ç„¡æ³•ä¸éµå®ˆ Leader Completeness&lt;/p>
&lt;p>å‡è¨­ leaderT ä»£è¡¨åœ¨ term T çš„ leaderï¼Œleader U å‰‡æ˜¯ term Uï¼Œä¸” U ä»£è¡¨æ˜¯ T çš„ä¸‹ä¸€ä½ï¼Œä¸” leaderT æ‰€èªå®šçš„ commited log (logT) åœ¨ leader U ä¸å­˜åœ¨ (é•å Leader Completeness)&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201103/leader-completeness.png"
loading="lazy"
alt="leader-completeness"
>&lt;/p>
&lt;ol>
&lt;li>leaderU åœ¨ç•¶ follower æ™‚ä¸¦ä¿å­˜æ²’æœ‰ logT&lt;/li>
&lt;li>leaderT å°‡ logT åŒæ­¥åˆ°å¤šæ•¸ç¯€é»ä¸Šï¼Œè€Œ leaderU åœ¨é¸èˆ‰æ™‚ç²å¾—å¤šæ•¸åŒæ„ï¼Œä¹Ÿå°±æ˜¯è‡³å°‘æœ‰ä¸€ä½æŠ•ç¥¨ç¯€é» (voter) æ”¶åˆ° logT åŒæ™‚åˆæŠ•ç¥¨çµ¦ leaderU&lt;/li>
&lt;li>voter å¿…é ˆå…ˆä¿å­˜ logTï¼Œæ‰åˆæŠ•ç¥¨çµ¦ leaderUï¼Œåéä¾†å°±ä¸æœƒæœ‰è¡çª (term U &amp;gt; term T æ‰€ä»¥ logT å¾Œåˆ°æœƒè¢«ä¸Ÿæ£„)&lt;/li>
&lt;li>voter ä¾ç„¶ä¿å­˜ logTï¼Œå› ç‚º leader å¾ä¸æ”¹è®Šæ—¢å®š logï¼Œè€Œ follower ä¹Ÿåªæœ‰èˆ‡ leader è¡çªæ™‚æ‰æœƒè¤‡å¯«&lt;/li>
&lt;/ol>
&lt;p>è£½é€ å‡ºå ´æ™¯å¾Œï¼Œè®“æˆ‘å€‘ä¾†çœ‹ç‚ºä»€éº¼ Raft ä¸å¯èƒ½é”åˆ°é€™æ¨£çš„ç‹€æ³&lt;br>
5. ä¾æ“šå…ˆå‰è¦å®šï¼Œ follower åªæœƒæŠ•çµ¦ log ä¿ç•™æ¯”è‡ªå·±æ›´å¤šçš„ candidate&lt;br>
6. å¦‚æœ voter èˆ‡ leaderU æœ€æ–°ä¸€å€‹ term éƒ½æ˜¯ T çš„è©±ï¼Œå‰‡ leaderU çš„ log æ•¸æ‡‰è©²èˆ‡ voter ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ leaderU è‡³å°‘æ“æœ‰ voter æ‰€æ“æœ‰çš„ log&lt;br>
7. åä¹‹ï¼Œå¦‚æœ leaderU çš„æœ€æ–° log term å¤§æ–¼ voter çš„è©±ï¼Œç‚ºäº†è¦ç¬¦åˆæ—©æ–¼ leaderU çš„ leader æ‰€æœ‰ commited log éƒ½æ‡‰è©²è¢«ä¿ç•™åˆ° leaderU ä¸­ï¼Œå› æ­¤æ ¹æ“š &lt;code>Log Matching&lt;/code> å‰‡ leaderU æ‡‰è©²è¦å„²å­˜é€™äº› log&lt;/p>
&lt;p>åœ¨ç„¡æ³•é”æˆçš„æƒ…æ³ï¼Œè­‰æ˜äº† Raft æ»¿è¶³ Leader Completeness æ¢ä»¶ï¼Œç¢ºä¿ leader å¦‚æœæœ€æ–°çš„ log term &amp;gt; Tï¼Œå‰‡ leader å¿…å®šæ“æœ‰ term T æ‰€ commited çš„ä¸€åˆ‡ log&lt;/p>
&lt;blockquote>
&lt;p>Thus, the leaders of all terms greater than T must contain all entries from term T that are committed in term T&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰äº† Leader Completeness å±¬æ€§ï¼Œå°±èƒ½é€²ä¸€æ­¥è­‰æ˜ &lt;code>State Machine Safety&lt;/code>ï¼Œå¦‚æœæŸä¸€æ©Ÿå™¨åœ¨æŸä¸€ index å¥—ç”¨æŒ‡ä»¤åˆ°ç‹€æ…‹æ©Ÿä¸­ï¼Œå‰‡å…¶ä»–æ©Ÿå™¨åœ¨ç›¸åŒ index ä¸‹ä¸¦ç„¶å¥—ç”¨ç›¸åŒçš„æŒ‡ä»¤ï¼Œå› ç‚ºèƒ½å¤ è¢«å¥—ç”¨çš„ log ä¸€å®šæ˜¯ leader commited å¾Œçš„ logï¼Œä¸”å› ç‚º Log
Completenessï¼Œæ‰€æœ‰æ›´æ–°çš„ leader ä¹Ÿéƒ½ä¿ç•™è¢« commited å¾Œçš„ logï¼Œå› æ­¤èƒ½&lt;code>ç¢ºä¿æ‰€æœ‰çš„ç¯€é»çµ‚å°‡ä»¥ç›¸åŒçš„é †åºå¥—ç”¨ç›¸åŒçš„æŒ‡ä»¤åˆ°ç‹€æ…‹æ©Ÿä¸Š&lt;/code>&lt;/p>
&lt;h3 id="55-follower-and-candidate-crashes">5.5 Follower and candidate crashes&lt;/h3>
&lt;p>å…ˆå‰éƒ½æ˜¯è¨è«– leader crashed å¾Œçš„è™•ç½®ï¼Œè‡³æ–¼ follower èˆ‡ candidate å‰‡å–®ç´”å¾ˆå¤šï¼Œå› ç‚º Raft çš„ RPC æŒ‡ä»¤éƒ½æ˜¯ &lt;code>idempotent&lt;/code>ï¼Œleader å¯ä»¥æŒçºŒçš„é€æŒ‡ä»¤ç›´åˆ°æˆåŠŸï¼Œfollower è·Ÿ candidate å¤±æ•—å¾Œé‡å•Ÿå°±é‡æ–°æ¥æ”¶æŒ‡ä»¤å°±å¥½&lt;/p>
&lt;h3 id="56-timing-and-availability">5.6 Timing and availability&lt;/h3>
&lt;p>Raft Safety å»ºç«‹åœ¨ä¸ä¾è³´ timingï¼Œç³»çµ±ä¸æœƒå› ç‚ºè¨Šæ¯ç™¼é€çš„å¿«æ…¢è€Œå¾—åˆ°ä¸é æœŸçš„çµæœï¼›&lt;br>
ä½†æ•´é«”ç³»çµ±çš„å¯ç”¨æ€§å»é‚„æ˜¯è·Ÿæ™‚é–“æœ‰ä¸€äº›é—œè¯ï¼Œä¾‹å¦‚èªª server ä¸èƒ½å† election timeout æœŸé–“å…§ç¥¨é¸å‡º leaderï¼Œè€Œ Raft åœ¨æ²’æœ‰ leader çš„æƒ…æ³ä¸‹å°±ä¸å¯ç”¨&lt;/p>
&lt;p>æ‰€ä»¥æ•´é«”ä¸Šè¦ç¬¦åˆä»¥ä¸‹ä¸ç­‰å¼ Raft æ‰èƒ½é‹ä½œæ­£å¸¸&lt;/p>
&lt;blockquote>
&lt;p>broadcastTime â‰ª electionTimeout â‰ª MTBF&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>&lt;code>broadcastTime&lt;/code> ä»£è¡¨ RPC å®Œæ•´ request / response æ‰€è€—è²»çš„æ™‚é–“ï¼Œé ˆå°æ–¼ electionTimeout ä¸€å€‹é‡ç´šï¼Œé€šå¸¸åœ¨ 0.5ms ~ 20msï¼›&lt;/li>
&lt;li>&lt;code>electionTimeout&lt;/code> å‰‡æ˜¯ follower ç­‰å¾…å¤šä¹…å¾Œæœƒè§¸ç™¼é¸èˆ‰ï¼Œé€™æ˜¯å¯ä»¥ä¸»å‹•å»è¨­å®šçš„ï¼Œé€šå¸¸åœ¨ 100ms ~ 500msï¼›&lt;/li>
&lt;li>&lt;code>MTBF&lt;/code> å‰‡ä»£è¡¨ server é€²å…¥éŒ¯èª¤ç‹€æ…‹çš„å€é–“ï¼Œé€šå¸¸æ˜¯æ•¸å¤©è‡³æ•¸å€‹æœˆ&lt;/li>
&lt;/ol>
&lt;p>è©¦æƒ³å¦‚æœ broadcastTime &amp;gt; electionTimeoutï¼Œå‰‡æ¯ä¸€æ¬¡é¸èˆ‰åœ¨é‚„æ²’æ”¶åˆ°æŠ•ç¥¨çµæœåˆé–‹å§‹ä¸‹ä¸€è¼ªé¸èˆ‰ï¼Œå‰‡æ°¸é é¸ä¸å®Œï¼›&lt;br>
å¦‚æœ electionTimeout &amp;gt; MTBFï¼Œå‰‡é¸èˆ‰é‚„æ²’çµæŸ server åˆ crashï¼Œé‚£ä¹Ÿä¸€æ¨£æœƒæœ‰ leader ç„¡æ³•ç”¢ç”Ÿçš„å•é¡Œ&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>å¾ŒçºŒé‚„æœ‰ Cluster membership changes / Log compaction / Client interaction é€²éšæ¢è¨ï¼Œå°±å…ˆæš«æ™‚ç•¥éï¼Œåƒ…ç†è§£å‰åŠéƒ¨æ¼”ç®—æ³•çš„æ ¸å¿ƒè¨­è¨ˆ&lt;/p>
&lt;p>åˆ†æ•£å¼ç³»çµ±çš„è¿·äººä¹‹è™•åœ¨æ–¼&lt;code>è¤‡é›œ&lt;/code>ï¼Œéœ€è¦é¢å°ç¶²è·¯å»¶é² / æ™‚é–“ä¸ä¸€è‡´(time skewed) / æ©Ÿå™¨å¤±æ•—ç­‰ä¸ç©©å®šçš„å› å­ï¼Œã€Œå†ä¸ç©©å®šçš„æ¢ä»¶ä¸‹æ¶æ§‹å‡ºå¯å®¹éŒ¯/é«˜å¯ç”¨/ä¸€è‡´æ€§çš„ç©©å®šç³»çµ±ã€ï¼Œçœ‹ä¼¼è’è¬¬å»å¯ä»¥é€éæ¼”ç®—æ³•çš„è¨­è¨ˆé”æˆç›®çš„(æˆ–æ˜¯èªªæ›´è²¼è¿‘)ï¼Œå¯¦åœ¨ä»¤äººè®šå˜†é€™äº›è¨­è¨ˆæ¼”ç®—æ³•çš„å°ˆå®¶å€‘&lt;/p>
&lt;p>Raft é€éç”± Leader ä¸»å° Log çš„åŒæ­¥ï¼Œä¸¦åŠ å…¥é¸èˆ‰æ™‚çš„æ¢ä»¶é™åˆ¶ï¼Œç¢ºä¿ commited log ä¸æœƒè¢«æ”¹å¯«é”åˆ° &lt;code>å¼·ä¸€è‡´æ€§&lt;/code>ï¼›å¦‚æœ Leade å¤±æ•—ï¼Œä¹Ÿä¸ç”¨æ“”å¿ƒ log ç™¼ç”Ÿå•é¡Œï¼Œç­‰ä¸‹ä¸€ä½ Leader è¢«æ¨é¸å‡ºä¾†åˆèƒ½å¤ ç¹¼çºŒç¶­æŒç³»çµ±é‹ä½œ&lt;/p>
&lt;p>æ•´ä»½è«–æ–‡è®€èµ·ä¾†é‚„ç®—è »å¥½ç†è§£çš„ï¼Œç¢ºå¯¦ç¬¦åˆä½œè€…ä¸æ–·å¼·èª¿å¯è®€æ€§çš„é‡è¦&lt;/p></description></item><item><title>Gossip Protocol ä»‹ç´¹ (ä¸‹) - ã€ŠEfficient Reconciliation and Flow Control for Anti-Entropy Protocolsã€‹è«–æ–‡æ‘˜è¦</title><link>https://yuanchieh.page/posts/2020/2020-10-28-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8B-efficient-reconciliation-and-flow-control-for-anti-entropy-protocols%E8%AB%96%E6%96%87%E6%91%98%E8%A6%81/</link><pubDate>Wed, 28 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-28-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8B-efficient-reconciliation-and-flow-control-for-anti-entropy-protocols%E8%AB%96%E6%96%87%E6%91%98%E8%A6%81/</guid><description>&lt;h1 id="gossip-protocol">Gossip Protocol&lt;/h1>
&lt;p>Gossip Protocol æ˜¯ä¸€ç¨®é€šè¨Šæ©Ÿåˆ¶ï¼Œæ‡‰ç”¨æ–¼åŒä¸€ç¶²è·¯å…§æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“äº¤æ›è¨Šæ¯ä½¿ç”¨ï¼ŒåŸç†é¡ä¼¼æ–¼è¾¦å…¬å®¤å‚³è¬ è¨€ä¸€æ¨£ï¼Œä¸€å€‹å‚³ä¸€å€‹ï¼Œæœ€çµ‚æ¯ä¸€å€‹æ©Ÿå™¨éƒ½æ“æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œåˆç¨± Epidemic Protocol&lt;/p>
&lt;p>ä¸Šä¸€ç¯‡åˆ†äº«åˆ° &lt;a class="link" href="https://yuanchieh.page/post/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9%E4%B8%8A/" target="_blank" rel="noopener"
>Cassandra å…§éƒ¨å¦‚ä½•ä½¿ç”¨ Gossip Protocol&lt;/a>ï¼Œå½±ç‰‡ä¸­æœ‰æ¨è–¦ &lt;a class="link" href="https://www.cs.cornell.edu/home/rvr/papers/flowgossip.pdf" target="_blank" rel="noopener"
>Efficient Reconciliation and Flow Control for Anti-Entropy Protocols&lt;/a>ï¼Œä»¥ä¸‹æ‘˜è¦æ­¤ç¯‡è«–æ–‡æ‰€æ¢è¨çš„å…§å®¹&lt;/p>
&lt;p>å»ºè­°å¯ä»¥å…ˆè®€ä¸Šç¯‡ï¼Œæœ‰å€‹æ¦‚ç•¥èªè­˜å¾Œåœ¨çœ‹ç†è«–æœƒæ¯”è¼ƒå¥½æ‡‚äº›&lt;/p>
&lt;h2 id="efficient-reconciliation-and-flow-control-for-anti-entropy-protocols-æ‘˜è¦">ã€ŠEfficient Reconciliation and Flow Control for Anti-Entropy Protocolsã€‹ æ‘˜è¦&lt;/h2>
&lt;p>anti-entropyï¼Œåˆæˆ–ç¨±ä½œ gossipï¼Œç”¨æ–¼ä¸éœ€è¦å¼·ä¸€è‡´æ€§çš„ç‹€æ…‹åŒæ­¥ï¼Œåœ¨ä¸€äº›é™åˆ¶ä¸‹ï¼Œæ™‚é–“è¤‡é›œåº¦æ˜¯ log(N) (N ç‚ºç¾¤é«”æ•¸é‡) ä¸”åœ¨ host é­é‡éŒ¯èª¤æˆ–æ˜¯è¨Šæ¯ä¸Ÿå¤±éƒ½ä¸å½±éŸ¿&lt;/p>
&lt;p>gossip å¸Œæœ›ç›¡é‡åœ¨å¯æ§åˆ¶çš„å›åˆå…§å®ŒæˆåŒæ­¥ï¼Œä½†å¦‚åŒå…¶ä»–åŒæ­¥æ“ä½œï¼Œé€™æœƒä»°è³´ CPU è³‡æºèˆ‡ Network æµé‡ï¼Œåœ¨é«˜è² è¼‰ä¸‹ CPU å¯èƒ½ä¾†ä¸åŠé‹ç®—è¦æ›´æ–°çš„ç‹€æ…‹æˆ–æ˜¯ç¶²è·¯æµé‡ä¸å¤ å¿«å°è‡´å»¶é²å°åŒ…&lt;/p>
&lt;p>é€™ä»½è«–æ–‡ä¸»è¦æä¾›å…©å€‹åƒ¹å€¼ï¼Œ&lt;/p>
&lt;ol>
&lt;li>åœ¨é™å®š CPU / Network ä¸‹å„ªåŒ– gossip protocol å‚³è¼¸æ•ˆç‡&lt;/li>
&lt;li>åˆ†æ gossip protocol çš„æµé‡ç®¡åˆ¶&lt;/li>
&lt;/ol>
&lt;p>gossip protocol ä¸»è¦æœ‰å…©ç¨®é¡å‹&lt;/p>
&lt;ol>
&lt;li>anti-entropy: æŒçºŒå‚³é€ gossip information ç›´åˆ°å…¨éƒ¨è³‡æ–™éƒ½æ›´æ–°å®Œæˆ&lt;/li>
&lt;li>rumormongering: é¸å®šä¸€å€‹è¶³å¤ æœ‰æ•ˆçš„æ™‚é–“æŒçºŒé€ gossip informationï¼Œå¤§æ¦‚ç‡ç¯€é»éƒ½æœƒæ‹¿åˆ°æœ€æ–°è³‡è¨Š&lt;/li>
&lt;/ol>
&lt;p>å‡è¨­ç›®å‰çš„é›†ç¾¤ {p,q &amp;hellip;}ï¼Œæ¯å€‹åƒèˆ‡è€…éƒ½éœ€è¦ç¶­è­·ä¸€ä»½åˆ—è¡¨ï¼Œé€™å€‹åˆ—è¡¨æ˜¯ç”± key -&amp;gt; (value + version) çµ„æˆï¼Œä¹Ÿå°±æ˜¯ Cassandra å…§çš„ ApplicationState&lt;/p>
&lt;blockquote>
&lt;p>Ïƒ âˆˆ S = K â†’ (V Ã— N ) // Ïƒ ä»£è¡¨å–ç‹€æ…‹
Ïƒ(k) = (v, n) ï¼Œè¡¨ç¤º key æ­¤æ™‚å°æ‡‰çš„ value v è·Ÿ version n&lt;/p>
&lt;/blockquote>
&lt;p>åˆ—è¡¨åŒ…å« key -&amp;gt; value -&amp;gt; versionï¼Œå¦‚æœæ˜¯é€™å€‹ key çš„æœ€æ–°è³‡æ–™ï¼Œå‰‡ä»–çš„ version æœƒå¤§æ–¼èˆŠçš„ version&lt;/p>
&lt;blockquote>
&lt;p>Ïƒ1(k) = (v1, n1), Ïƒ2(k) = (v2, n2) // Ïƒ1(k) ä»£è¡¨é€™ä¸€å€‹ç¯€é»å–ä»–çš„ keyï¼Œè¿”å› (v1, n1) ä»£è¡¨ value ç‚º v1 ä¸” version n1ï¼›
Ïƒ(k) è¡¨ç¤ºå– Ïƒ1 èˆ‡ Ïƒ2 å– XORï¼Œä¸¦é‡åˆ°ç›¸åŒ key æ™‚å– verson è¼ƒå¤§è€…ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ n1 &amp;gt; n2 å‰‡ Ïƒ(k) = (v1, n1)&lt;/p>
&lt;/blockquote>
&lt;p>æ“ä½œæµç¨‹å¤§è‡´æ˜¯&lt;/p>
&lt;ol>
&lt;li>å¾é›†ç¾¤ä¸­éš¨æ©ŸæŒ‘ä¸€å€‹ host å‚³é€è¨Šæ¯ï¼Œè¨Šæ¯å…§å®¹æ˜¯è‡ªå·±æ‰€ç¶­è­·çš„åˆ—è¡¨&lt;/li>
&lt;li>æ”¶åˆ°è¨Šæ¯å¾Œé‹ç®—ï¼Œæ­¤å‹•ä½œç¨±ç‚º merge æˆ–ç¨±ç‚º reconciliation ï¼Œä¹Ÿå°±æ˜¯æ”¶åˆ°è¨Šæ¯æ™‚æœƒå»é‹ç®—åˆ—è¡¨çš„å·®ç•°ï¼Œä¸¦ä¿ç•™å·®ç•°ä¸­ version è¼ƒé«˜çš„ key -&amp;gt; value&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>âˆ€r : Âµq (r) = Âµq (r) âŠ• Âµp(r) // q çœŸæ­£è¦æ›´æ–°çš„æ˜¯ p å‚³ä¾†çš„è¨Šæ¯èˆ‡ q è‡ªèº«ç¾åœ¨çš„è¨Šæ¯å– XOR æ‰¾å‡ºå·®ç•°è™•&lt;/p>
&lt;/blockquote>
&lt;p>å‚³é€è¨Šæ¯æœ‰ä¸‰ç¨®æ ¼å¼&lt;/p>
&lt;ol>
&lt;li>push: ç¯€é» p å‚³é€æ•´ä»½åˆ—è¡¨ï¼Œç¯€é» q æ”¶åˆ°å‰‡è¨ˆç®— merge å¾Œåˆä½µå…¥è‡ªå·±çš„åˆ—è¡¨&lt;/li>
&lt;li>pull: ç¯€é» p å‚³é€ key -&amp;gt; version è€Œæ²’æœ‰ valueï¼Œç¯€é» q å›å‚³ç¯€é» p é ˆè¦æ›´æ–°çš„éµå€¼ï¼Œè®Šå…å¤šé¤˜çš„å€¼å‚³é€&lt;/li>
&lt;li>push-pull: å°±åƒ pushï¼Œç¯€é» p å‚³é€å®Œæ•´åˆ—è¡¨ï¼Œç¯€é» q æœƒå›å‚³ p éæœŸé ˆè¦æ›´æ–°çš„éµå€¼ ( pull å¾ŒåŠæ®µï¼Œ&lt;code>push-pull æ˜¯æœ€æœ‰æ•ˆç‡çš„åšæ³•&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæŸå€‹ key ä¸å†æ›´æ–°ï¼Œé‚£åœ¨ä¸€å®šçš„æ™‚é–“å…§å¾ˆé«˜çš„æ©Ÿç‡å¤§å®¶éƒ½æœƒåŒæ­¥ç›¸åŒçš„ valueï¼Œå¦‚æœé›†ç¾¤éš¨æ©ŸæŒ‘é¸ç¯€é»çš„æ¼”ç®—æ³• &lt;code>(Fp âŠ† P âˆ’ {p})&lt;/code> å¤ éš¨æ©Ÿçš„è©±ï¼Œå³ä½¿é‡åˆ° message loss æˆ–æ˜¯ host çŸ­æš« failedï¼Œä¹Ÿåƒ…åƒ…æ˜¯ç¨å¾®å»¶é²åŒæ­¥çš„æ™‚é–“&lt;/p>
&lt;p>å‡è¨­ update key çš„æ™‚é–“æ˜¯å›ºå®šçš„ï¼Œé‚£éš¨è‘—é›†ç¾¤æ•¸é‡ç·šæ€§å¢é•· Nï¼Œå‰‡é”æˆåŒæ­¥æ‰€éœ€è¦çš„æ™‚é–“æœƒæˆ log(N) å¢é•·ã€‚&lt;/p>
&lt;p>ä½†å¯¦å‹™ä¸Šå¿…é ˆè€ƒé‡åˆ° CPU / Network ä»¥åŠæ›´æ–°çš„é »ç‡ï¼Œå¦‚æœæ›´æ–°çš„é »ç‡å¤ªé«˜ï¼Œå› ç‚ºè³‡æºå—é™å‰‡åŒæ­¥çš„å»¶é²å¯èƒ½æœƒç„¡é™çš„å¢é•·ï¼Œå¯¦éš›ä¸Šæ‡‰ç”¨ç¨‹å¼åœ¨æ„çš„ä¸æ˜¯å¤šå¸¸æ›´æ–°ï¼Œè€Œæ˜¯è³‡æ–™æ˜¯ä¸æ˜¯æŠµé”åŒæ­¥&lt;/p>
&lt;p>æ¥è‘—è¦æ¢è¨å¦‚æœæˆ‘å€‘é™å®š gossip message ä¸èƒ½è¶…é MTU(Maximum Transmission Unit)ï¼Œé‚£æˆ‘å€‘è©²æ€éº¼æ±ºå®šè¦æ›´æ–°å“ªäº› key æ‰èƒ½æœ€æœ‰æ•ˆè®“æ‰€æœ‰ç¯€é»ç‹€æ…‹ä¸€è‡´&lt;/p>
&lt;h2 id="reconciliation">RECONCILIATION&lt;/h2>
&lt;p>å…ˆå‰æåˆ° p è·Ÿ q ä¾†å›é€šä¿¡éƒ½åªé€å…©è€…ç‹€æ…‹çš„ deltaï¼Œå¦‚æœè¶…é MTU å‰‡å¿…é ˆæœ‰ä¸€å€‹å„ªå…ˆåºæ±ºå®šå“ªäº›éµå€¼è¦å…ˆæ›´æ–°( &lt;code>&amp;lt;Ï€&lt;/code> ä»£è¡¨æ­¤æ’åºæ¼”ç®—æ³•)ï¼Œä½œè€…ä»‹ç´¹äº†å…©ç¨®ï¼Œä¸€ç¨®æ˜¯ &lt;code>precise reconciliation&lt;/code> æœ€ç‚ºåŸºæº–ç·šï¼Œå°æ¯”å¦ä¸€å€‹ä½œè€…æå‡ºçš„ &lt;code>Scuttlebutt&lt;/code> æ›´æ–°æ©Ÿåˆ¶&lt;/p>
&lt;h3 id="precise-reconciliation">precise reconciliation&lt;/h3>
&lt;p>æ ¹æ“šæ›´æ–°æ™‚é–“åºæ±ºå®šå“ªäº› key è¦å…ˆé€å‡ºå»ï¼Œåœ¨å¯¦å‹™ä¸Š precise reconciliation æ¯”è¼ƒéº»ç…©äº›ï¼Œå¦‚å…ˆå‰èªªå¿…é ˆè¦å…ˆé€ state çµ¦å°æ–¹åšæ¯”è¼ƒæ‰èƒ½ç®—å‡º deltaï¼Œé€™æœƒæ¶ˆè€—é »å¯¬ä»¥åŠ CPU cycle&lt;/p>
&lt;p>ä¾æ“šæ™‚é–“åºåˆå¯ä»¥ç´°åˆ†æˆ &lt;code>precise-oldest&lt;/code>: åœ¨ MTU é™åˆ¶ä¸‹å…ˆé€é‚£äº›å¾ˆä¹…æ²’æœ‰æ›´æ–°çš„ key / &lt;code>precise-newest&lt;/code>: å…ˆé€æœ€è¿‘æ‰è¢«æ›´æ–°çš„ keyï¼Œå¾Œè€…è¦ç•™æ„æœƒæœ‰ starvation å•é¡Œï¼Œåœ¨å¯¦ä½œä¸Šç¯€é»å¿…é ˆåŒæ­¥æ™‚é–“ï¼Œæ‰èƒ½ä½œç‚ºåˆ¤æ–·çš„ä¾æ“š&lt;/p>
&lt;blockquote>
&lt;p>Note that, if implemented, both these orderings would require a synchronized clock among the members and that all
updates be timestamped with this clock.&lt;/p>
&lt;/blockquote>
&lt;h3 id="scuttlebutt-reconciliation">Scuttlebutt Reconciliation&lt;/h3>
&lt;p>ä½œè€…æåŠå¦ä¸€ç¨®è§£æ³•ï¼Œä¹Ÿæ˜¯ Cassandra æ¡ç´çš„åšæ³•ï¼Œåˆå§‹åŒ–æ™‚ version å›ºå®šæ˜¯æœ€å°çš„æ•¸å­—ï¼Œæ¯æ¬¡æ›´æ–°éµå€¼æ™‚ï¼Œè¦æŠŠ version è¨­å®šå¤§æ–¼æˆç›®å‰ä»»æ„éµå€¼å°æ‡‰çš„æœ€é«˜ç‰ˆè™Ÿ&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>{(r, max(Âµp(r))) | r âˆˆ P}&lt;/code> // æ­¤å…¬å¼è¡¨ç¤º r æ˜¯å±¬æ–¼ç¯€é» P çš„å±¬æ€§ï¼Œæ‰¾å‡º r ä»¥åŠç•¶ä¸‹ P ä¸­ r æœ€å¤§çš„ç‰ˆè™Ÿï¼›&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚èªªç›®å‰ Participant p çš„åˆ—è¡¨æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">key &lt;span class="p">|&lt;/span> value &lt;span class="p">|&lt;/span> version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a &lt;span class="p">|&lt;/span> a1 &lt;span class="p">|&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">b &lt;span class="p">|&lt;/span> b1 &lt;span class="p">|&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c &lt;span class="p">|&lt;/span> c1 &lt;span class="p">|&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ­¤æ™‚ a è¦æ›´æ–°ï¼Œå‰‡ç‰ˆè™Ÿè‡³å°‘è¦æ‹‰åˆ° 4ï¼Œè€Œä¸”ä¸åƒ precise-conciliation æœƒä¸€æ¬¡é€å¤šçµ„é–“å€¼æ›´æ–°ï¼ŒScuttlebutt å…è¨±ä¸€æ¬¡å¯ä»¥é€ä¸€å€‹éµå€¼ï¼Œä½†å¿…é ˆæŒ‰ç…§ version å¤§å°é€ä¸€é€
æ•´å€‹æ¶æ§‹å¿…é ˆç¬¦åˆä»¥ä¸‹ç‹€æ…‹
&lt;img src="https://yuanchieh.page/post/img/20201028/gossip_equation.png"
loading="lazy"
>&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯èªªåœ¨æ•´å€‹é›†ç¾¤ä¸‹ï¼Œä»»ä¸€éµå€¼ k åœ¨ç¯€é» p / ç¯€é» q å¿…é ˆæ»¿è¶³ä»¥ä¸‹ä»»ä¸€æ¢ä»¶&lt;/p>
&lt;ol>
&lt;li>åœ¨ç¯€é» p è·Ÿç¯€é» q ä¸­åŒä¸€å€‹ key version æ˜¯ä¸€æ¨£ï¼Œä»£è¡¨&lt;code>è³‡æ–™å·²ç¶“åŒæ­¥&lt;/code>&lt;/li>
&lt;li>å¦‚æœç¯€é» p çš„ key version è·Ÿç¯€é» q ä¸åŒï¼Œå‰‡æ­¤ version å¿…é ˆæ¯”æ˜¯ç¯€é»q ä¸­ä»»æ„æœ€å¤§çš„ç‰ˆè™Ÿé‚„è¦å¤§&lt;/li>
&lt;/ol>
&lt;p>ç¬¬äºŒé»éå¸¸é‡è¦ï¼Œé€™æ˜¯ä¿æŒæ¯æ¬¡æ›´æ–°ä¸éœ€è¦æ•´åŒ…é€ï¼Œå…ˆå¾ç‰ˆæœ¬åˆ¤æ–·å°±èƒ½åˆ¤æ–·å“ªäº›æ¬„ä½çœŸçš„éœ€è¦æ›´æ–°çš„ä¾æ“š&lt;/p>
&lt;p>ä¾†çœ‹ä¸€å€‹å¯¦éš›æ¡ˆä¾‹ï¼Œç›®å‰æœ‰ä¸‰å€‹ç¯€é» r,p,qï¼Œå…±æœ‰ 3 å€‹ key a,b,cï¼Œå¯ä»¥çœ‹åˆ° t1 æ™‚ r çš„ä¸‰å€‹ key éƒ½è¢«æ›´æ–°éï¼Œç‰ˆè™Ÿåˆ†åˆ¥æ˜¯ 21/22/23ï¼›&lt;br>
æ­¤æ™‚ r è¦å‘ p,q ç™¼é€ gossip messageï¼Œä»–å¿…é ˆå…ˆå¾ a é–‹å§‹ï¼Œå› ç‚ºé€™æ˜¯ a,b,c ä¸‰è€…ä¸­ç‰ˆè™Ÿæœ€å°ï¼Œä¸”å¤§æ–¼&lt;code> Âµq(p) / Âµp(p)&lt;/code> ï¼Œé€™æ„å‘³è‘—ç¯€é» p å’Œ ç¯€é»q éƒ½è¦æ›´æ–°ï¼Œæ‰€ä»¥ r æœƒåŒæ™‚é€è¨Šæ¯çµ¦ p , qï¼Œåœ¨ t2 æ™‚åªæœ‰ key a å…ˆè¢«æ›´æ–°&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201028/example.png"
loading="lazy"
>&lt;/p>
&lt;blockquote>
&lt;p>å¯ä»¥å›å»çœ‹ Gossip ä»‹ç´¹(ä¸Š)çš„ GossipDigestSynMessage éƒ¨åˆ†&lt;/p>
&lt;/blockquote>
&lt;p>é›–ç„¶èªªä¸€æ¬¡åªæ›´æ–°ä¸€å€‹éµå€¼æ•ˆç‡å¥½åƒå¾ˆä½ï¼Œä½†å„ªé»æ˜¯ r ä¸éœ€è¦é€å·²ç¶“æ›´æ–°éçš„å€¼ï¼Œæ¸›å°‘é‡è¤‡ï¼Œåœ¨é »å¯¬æœ‰é™æƒ…æ³ä¸‹ï¼ŒScuttlebutt ä¹Ÿå¿…é ˆæ±ºå®š gossip message å‚³é€çš„å„ªå…ˆåºï¼Œé€™è£¡æœ‰å…©ç¨®åšæ³•&lt;/p>
&lt;ol>
&lt;li>&lt;code>scuttle-breadth&lt;/code>: åœ¨åŒä¸€å€‹ participant ä¸­ï¼Œå°‡ delta ç”¨ version å¾å°åˆ°å¤§æ’åºï¼Œå¦‚æœå…©å€‹ä¸åŒ delta çš„ version ç›¸åŒï¼Œå‰‡éš¨æ©ŸæŠ½ participant ç™¼é€&lt;/li>
&lt;li>&lt;code>scuttle-depth&lt;/code>: åœ¨ participant ä¸­ï¼Œåªæœ‰éµå€¼æœ‰è½å·®å°±ç®—ä¸€å€‹ deltaï¼Œå¾ delta æœ€å¤šçš„ participant é–‹å§‹é€ï¼Œæ‰€ä»¥æœ‰å¯èƒ½éƒ½é€çµ¦åŒä¸€å€‹ participant&lt;/li>
&lt;/ol>
&lt;h4 id="å¯¦é©—çµæœ">å¯¦é©—çµæœ&lt;/h4>
&lt;p>ç¸½å…± 128 participants èˆ‡ 64 çµ„ key/ valueï¼Œæ¯ç§’æ¯å€‹ participant gossip ä¸€æ¬¡ï¼›
å‰ 15 sec æš–æ©Ÿï¼Œä¸¦é–‹å§‹é™ç¸®é »å¯¬ / 25 ç§’é–‹å§‹åŠ å€æ›´æ–°é »ç‡ / 75 ç§’æ›´æ–°é »ç‡å›æ­¸æ­£å¸¸ / 120 sec åœæ­¢æ›´æ–°ï¼Œä¸­é–“ 25~75 åŠ å¤§æµé‡ä¸»è¦æ˜¯æƒ³è¦çœ‹æ¼”ç®—æ³•åœ¨é«˜è² è¼‰ä¸‹çš„è¡¨ç¾ï¼Œä»¥åŠé«˜å³°éå»å¾Œçš„æ¢å¾©é€Ÿåº¦&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201028/gossip.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>ç¬¬ä¸€å¼µåœ–è¡¨ä»£è¡¨é€™ä¸€å€‹æ™‚é–“ä¸Šï¼Œè©²éµå€¼è‡ªå¾ä¸Šæ¬¡è¢«æ›´æ–°å¾Œéš”äº†å¤šä¹…æ‰æ”¶åˆ°æœ€æ–°è³‡è¨Šï¼Œè¶Šä½è€…è¶Šå¥½&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>staleness of such a mapping Âµq (p)(k) is the amount of time that has lapsed since Âµq(p)(k) was last updated&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>ç¬¬äºŒå¼µåœ–è¡¨ä»£è¡¨é€™ä¸€å€‹æ™‚é–“æœ‰å¤šå°‘å€‹éµå€¼æ˜¯éæœŸçš„ ï¼Œè¶Šä½è€…è¶Šå¥½&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>reports the number of stale mappings as a function of time&lt;/p>
&lt;/blockquote>
&lt;p>äº¤å‰æ¯”å°æœ‰ä»¥ä¸‹çµè«–&lt;/p>
&lt;ol>
&lt;li>&lt;code>Scuttle-depth è¡¨ç¾å„ªç•°&lt;/code>&lt;/li>
&lt;li>Precise-newest å¯ä»¥çœ‹å‡ºæœ‰ starvation ç‹€æ³ï¼Œä¹Ÿå°±æ˜¯æœ‰éµå€¼å¾ˆä¹…æ²’æœ‰è¢«æ›´æ–° (åœ–ä¸€ä»–æœ€é«˜)ï¼Œä½†æ˜¯çœŸæ­£å½±éŸ¿åˆ°çš„éµå€¼å…¶å¯¦æ˜¯å°‘æ•¸ (åŒä¸€æ™‚é–“é»å…¶å¯¦éæœŸçš„éµå€¼æ•¸ä¸å¤š)ï¼Œä½†æ˜¯é«˜å³°éå»æ”¶æ–‚å¾ˆå¿«&lt;/li>
&lt;li>å…¶é¤˜å…©è€…è¡¨ç¾æ™®æ™®&lt;/li>
&lt;/ol>
&lt;h2 id="flow-control">Flow Control&lt;/h2>
&lt;p>åœ¨ä¸€äº›æƒ…æ³ä¸‹ï¼Œparticipant äº¤æ›è¨Šæ¯æ™‚æ›´æ–°é »ç‡å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æœƒéœ€è¦ä¸€å€‹æµé‡æ§åˆ¶çš„æ¼”ç®—æ³•ï¼Œå»å¹³è¡¡ä¸€å€‹ participant æƒ³è¦å¢åŠ æ›´æ–°é »ç‡è€Œå¦ä¸€å€‹æƒ³è¦é™ä½é »ç‡çš„å¯èƒ½ï¼Œè¦è£½é€ å‡ºé€™æ¨£çš„ä¸åŒæ›´æ–°é »ç‡ï¼Œä½†åŒæ™‚ç³»çµ±å¿…é ˆç¶­æŒç›¸åŒçš„æœ€å¤§äº¤æ›é »ç‡ä¸Šé™&lt;br>
åœ¨ participant äº¤æ› gossip æ™‚ï¼Œæœƒé€£å¸¶äº¤æ›å½¼æ­¤é è¨­æ›´æ–°çš„é »ç‡ (Ïp , Ïq)ä»¥åŠæœ€å¤§å€¼ (Ï„p,Ï„q )ï¼Œç•¶å…©å€‹ participant åœ¨äº¤æ›æ™‚æœƒé †ä¾¿äº¤æ›&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201028/flow1.png"
loading="lazy"
>&lt;/p>
&lt;p>æ©Ÿåˆ¶æœ‰é»é¡ä¼¼æ–¼ TCP çš„ Additive Increase Multiplicative Decrease (AIMD)ï¼Œé€æ¼¸å¢åŠ ç™¼é€çš„é »ç‡ä½†é‡åˆ°éŒ¯èª¤æ™‚å¿«é€Ÿæ¸›å°‘ï¼›&lt;br>
å¦‚æœè¦ç™¼é€çš„ delta æ•¸é‡é«˜æ–¼ MTUï¼Œå‰‡ç·šæ€§å¢åŠ ï¼Œåä¹‹ï¼Œå‰‡å€æ•¸æ¸›å°‘&lt;/p>
&lt;p>å¯¦é©—éç¨‹æ˜¯åœ¨ t = 90 æ™‚é™ç¸® mtu å¾ 100 é™åˆ° 50ï¼Œå¯ä»¥çœ‹åˆ° 90 ä¹‹å¾Œ max out of date å¤§å¹…å¢åŠ ï¼Œä¹‹å¾Œæ‰æ…¢æ…¢æ”¶æ–‚ï¼Œå…¶ä¸­ scuttle-depth åœ¨è¡¨ç¾ä¸Šæ¯”è¼ƒç©©å®š &lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201028/exp2.png"
loading="lazy"
>&lt;/p>
&lt;p>é€™ä¸€ç« ç¯€æ¯”è¼ƒä¸ç¢ºå®šï¼Œå¦‚æœæœ‰ä»€éº¼éŒ¯èª¤éº»ç…©æŒ‡æ•™ ğŸ™&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>æœ¬ç¯‡æå‡ºå…©å€‹é‡é»&lt;/p>
&lt;ol>
&lt;li>æ–°çš„ reconciliation æ©Ÿåˆ¶ï¼ŒåŠ é€ŸåŒæ­¥çš„æ•ˆç‡ï¼ŒåŒæ™‚é¿å… starvation&lt;/li>
&lt;li>å¼•å…¥ flow control æ©Ÿåˆ¶ï¼Œè®“ participant å¯ä»¥ç”¨åˆç†çš„é€Ÿåº¦æ›´æ–°&lt;/li>
&lt;/ol>
&lt;h2 id="å¯¦ä½œé¢">å¯¦ä½œé¢&lt;/h2>
&lt;p>ç¶²è·¯ä¸Šæ‰¾äº†ä¸€å€‹ nodejs ç‰ˆæœ¬çš„ gossip protocol å¯¦ä½œ &lt;a class="link" href="https://github.com/bpot/node-gossip" target="_blank" rel="noopener"
>node-gossip&lt;/a>ï¼Œçœ‹èµ·ä¾†æ˜¯ä½¿ç”¨ scuttle-depth å”è­°æ©Ÿåˆ¶
è¨ˆç®—èˆ‡ peer ä¸­çš„ delta æœ€å¤šçš„ï¼Œæ¥è‘—å…ˆæŒ‰ç…§ peer ä¸­æœ€èˆŠçš„ version é–‹å§‹æ’åº&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Sort by peers with most deltas
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">deltas_with_peer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">deltas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nx">deltas_with_peer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">peer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">deltas_with_peer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">peer_deltas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">peer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deltas&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Sort deltas by version number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// console.log(peer_deltas);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">j&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">delta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">peer_deltas&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">delta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">unshift&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">peer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">peer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">deltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delta&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Gossip Protocol ä»‹ç´¹ (ä¸Š) - å¾ Cassandra å…§éƒ¨å¯¦ä½œèªè­˜ Gossip Protocol çš„ä½¿ç”¨</title><link>https://yuanchieh.page/posts/2020/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8A-%E5%BE%9E-cassandra-%E5%85%A7%E9%83%A8%E5%AF%A6%E4%BD%9C%E8%AA%8D%E8%AD%98-gossip-protocol-%E7%9A%84%E4%BD%BF%E7%94%A8/</link><pubDate>Mon, 26 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-26-gossip-protocol-%E4%BB%8B%E7%B4%B9-%E4%B8%8A-%E5%BE%9E-cassandra-%E5%85%A7%E9%83%A8%E5%AF%A6%E4%BD%9C%E8%AA%8D%E8%AD%98-gossip-protocol-%E7%9A%84%E4%BD%BF%E7%94%A8/</guid><description>&lt;p>Gossip Protocol æ˜¯ä¸€ç¨®é€šè¨Šæ©Ÿåˆ¶ï¼Œæ‡‰ç”¨æ–¼åŒä¸€ç¶²è·¯å…§æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“äº¤æ›è¨Šæ¯ï¼ŒåŸç†é¡ä¼¼æ–¼è¾¦å…¬å®¤å‚³è¬ è¨€ä¸€æ¨£ï¼Œä¸€å€‹å‚³ä¸€å€‹ï¼Œæœ€çµ‚æ¯ä¸€å€‹æ©Ÿå™¨éƒ½æ“æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œåˆç¨± &lt;code>Epidemic Protocol&lt;/code>&lt;/p>
&lt;p>å¯¦å‹™ä¸Šæœ‰å¹¾å€‹å¥½è™•&lt;/p>
&lt;ol>
&lt;li>å»ä¸­å¿ƒåŒ–:&lt;br>
æ©Ÿå™¨èˆ‡æ©Ÿå™¨é–“ç›´æ¥æºé€š (peer to peer)&lt;/li>
&lt;li>å®¹éŒ¯ç‡é«˜:&lt;br>
å³ä¾¿ç¯€é»èˆ‡ç¯€é»ä¹‹é–“ç„¡æ³•ç›´æ¥ç›¸é€£ï¼Œåªæœ‰æœ‰å…¶ä»– ç¯€é» å¯ä»¥å‚³éç‹€æ…‹ï¼Œä¹Ÿå¯ä»¥ç¶­æŒä¸€è‡´çš„ç‹€æ…‹&lt;/li>
&lt;li>æ•ˆç‡é«˜ä¸”å¯é &lt;/li>
&lt;/ol>
&lt;p>Gossip Protocol è¢«å»£æ³›æ¡ç´ï¼Œå¦‚Cassandra / Redis Cluster / Consul ç­‰é›†ç¾¤æ¶æ§‹ï¼Œä»¥ä¸‹å°‡å¾ Cassandra çš„å¯¦ä½œä¾†ç†è§£ Gossip Protocol&lt;/p>
&lt;h2 id="apple-inc-cassandra-internals--understanding-gossip">Apple Inc.: Cassandra Internals â€” Understanding Gossip&lt;/h2>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/FuP1Fvrv6ZQ"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>å…ˆå¾å¯¦å‹™é¢ä¾†çœ‹ï¼ŒGossip Protocol åœ¨ Cassandra ä¸­ä¸»è¦ç”¨æ–¼åŒæ­¥ ç¯€é» çš„ Metadataï¼ŒåŒ…å«&lt;/p>
&lt;ol>
&lt;li>cluster membership&lt;/li>
&lt;li>heartbeat&lt;/li>
&lt;li>node status&lt;br>
åŒæ™‚æ¯å€‹ç¯€é»éƒ½æœƒä¿å­˜ä¸€ä»½å…¶ä»–ç¯€é»ç‹€æ…‹çš„ Mapping Table&lt;/li>
&lt;/ol>
&lt;p>æ›´å…·é«”ä¾†çœ‹ç¯€é»ç‹€æ…‹æ‰€ä¿å­˜çš„è³‡æ–™æ ¼å¼&lt;/p>
&lt;ol>
&lt;li>HeartbeatState:&lt;br>
æ¯ä¸€å€‹ç¯€é»æœƒæœ‰ä¸€å€‹ HeartbeatStateï¼Œç´€éŒ„ generation / versionï¼Œ&lt;code>generation&lt;/code> æ˜¯ç¯€é»å•Ÿå‹•æ™‚çš„ timestampï¼Œç”¨ä¾†å€åˆ†æ©Ÿå™¨æ˜¯å¦é‡æ–°å•Ÿå‹•éï¼›&lt;code>version&lt;/code> å‰‡æ˜¯éå¢æ•¸å€¼ï¼Œæ¯æ¬¡ ApplicationState æœ‰å€¼æ›´æ–°æ™‚å°±æœƒéå¢&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>æ‰€ä»¥åŒä¸€å€‹ç¯€é»å…§çš„ ApplicationState version ä¸æœƒé‡è¤‡ï¼Œä¸” version æ¯”è¼ƒå¤§ä¸€å®šä»£è¡¨é€™å€‹éµå€¼æ¯”è¼ƒæ–°&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>ApplicationState: ä¸€å€‹ç”±&lt;code>{enum_name, value, version}&lt;/code>å»ºç«‹çš„ tupleï¼Œenum_name ä»£è¡¨å›ºå®šçš„ key åç¨±ï¼Œversion å‰‡è¡¨ç¤º value çš„ç‰ˆæœ¬è™Ÿç¢¼ï¼Œè™Ÿç¢¼å¤§è€…å‰‡ä»£è¡¨è³‡æ–™è¼ƒæ–°&lt;/li>
&lt;li>EndpointState: ç´€éŒ„æŸä¸€å€‹ç¯€é»ä¸‹æ‰€æœ‰çš„ ApplicationState&lt;/li>
&lt;li>EndpointStateMapping: ä¸€å€‹ç¯€é»æœƒæœ‰ä¸€å¼µé‡å°å·²çŸ¥çš„ç¯€é»æ‰€ç´€éŒ„çš„ EndpointStateï¼ŒåŒæ™‚æœƒåŒ…å«è‡ªå·±çš„ç‹€æ…‹&lt;/li>
&lt;/ol>
&lt;p>å¦‚ä¸‹åœ–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259909635, version &lt;span class="m">325&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version &lt;span class="m">45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">87&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259911052, version &lt;span class="m">61&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 2.7, generation 1259911052, version &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">31&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šå¯ä»¥çœ‹åˆ°ç¯€é» 10.0.0.1 æ‰€ä¿å­˜çš„ &lt;code>EndPointStateMap&lt;/code> æœ‰å…©ç­† EndPointStateï¼Œå…¶ä¸­ 10.0.0.1 çš„ HeartBeatState æ˜¯ &lt;code>generation 1259909635, version 325&lt;/code>ï¼Œé€™ä»£è¡¨ 10.0.0.1 æ˜¯åœ¨ 1259909635 æ™‚å•Ÿå‹•çš„ï¼Œä¸¦ä¸”ä»–ç›®å‰ä¿å­˜æ¬„ä½ä¸­æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ 325ï¼›&lt;br>
æ¥è‘—çœ‹ &lt;code>ApplicationState &amp;quot;load-information&amp;quot;: 5.2, generation 1259909635, version 45&lt;/code>ï¼Œé€™ä»£è¡¨ç¯€é»å…§ &amp;ldquo;load-information&amp;rdquo; é€™å€‹ Key å°æ‡‰çš„å€¼æ˜¯ 5.2 ä»¥åŠç•¶æ™‚æ”¶åˆ°çš„ generation èˆ‡ versionï¼Œå¾Œå…©è€…ç”¨ä¾†æ±ºå®š &lt;code>é€™å€‹ key æ”¶åˆ°è¨Šæ¯å¾Œè¦ä¸è¦æ›´æ–°çš„ä¾æ“š&lt;/code>&lt;/p>
&lt;h3 id="gossip-messaging">Gossip Messaging&lt;/h3>
&lt;p>æ¥è‘—ä¾†çœ‹æ¯æ¬¡ Gossip çš„å¯¦ä½œæµç¨‹ï¼Œæ¯å€‹ç¯€é»æœƒåœ¨æ¯ä¸€ç§’å•Ÿå‹•ä¸€å€‹æ–°çš„ gossip å›åˆ&lt;/p>
&lt;ol>
&lt;li>æŒ‘å‡º &lt;code>1~3&lt;/code> çš„ç¯€é»ï¼Œå„ªå…ˆé¸æ“‡ live ç‹€æ…‹çš„ç¯€é»ï¼Œæ¥è‘—æœƒæ©Ÿç‡æ€§é¸æ“‡ Seed ç¯€é» / å…ˆå‰åˆ¤å®šå·²ç¶“é›¢ç¶«çš„ç¯€é»&lt;/li>
&lt;li>å‚³éè¨Šæ¯çš„æµç¨‹æ˜¯ SYN / ACK / ACK2 (é¡ä¼¼æ–¼ TCP çš„3æ¬¡äº¤æ¡)&lt;/li>
&lt;/ol>
&lt;p>å‡è¨­ç¾åœ¨æ˜¯ç¯€é» A è¦å‚³è¨Šæ¯çµ¦ ç¯€é» B é—œæ–¼ç¯€é» C çš„ Gossip&lt;/p>
&lt;ol>
&lt;li>&lt;strong>GossipDigestSynMessage&lt;/strong> :&lt;br>
ç¯€é» A è¦ç™¼é€çš„ SYN è¨Šæ¯åŒ…å« &lt;code>{ipAddr, generation, heartbeat}&lt;/code>ï¼Œéœ€æ³¨æ„æ­¤æ™‚åªè¦é€ HeartbeatStateï¼Œè€Œæ²’æœ‰é€è©³ç´°çš„ ApplicationStateï¼Œé¿å…å¤šé¤˜çš„è³‡æ–™å‚³è¼¸&lt;/li>
&lt;li>&lt;strong>GossipDigestAckMessage&lt;/strong> :&lt;br>
ç¯€é» B æ”¶åˆ°å¾Œï¼Œæœƒå»æ¯”å°ä»–è‡ªå·±æš«å­˜ç¯€é» C çš„ç‹€æ…‹ï¼Œé‹ç®—å…©è€…å·®ç•° &lt;br>
a. ç¯€é» A çš„è³‡æ–™æ¯”è¼ƒæ–°ï¼Œå‰‡ç¯€é» B æœƒæº–å‚™è·Ÿç¯€é» A è¦æ–°çš„è³‡æ–™&lt;br>
b. ç¯€é» B çš„è³‡æ–™æ¯”è¼ƒæ–°ï¼Œæ‰“åŒ…è¦æ›´æ–°çš„ ApplicationState å›å‚³ &lt;code>ACK&lt;/code> é€šçŸ¥ç¯€é» A&lt;/li>
&lt;li>&lt;strong>GossipDigestAck2Message&lt;/strong> :&lt;br>
ç¯€é» A æ”¶åˆ° ACK å¾Œï¼Œæ›´æ–°è‡ªå·±æš«å­˜çš„è³‡æ–™ï¼Œä¸¦ä¸”æ ¹æ“š (2.a) ä¸­ç¯€é» B æ‰€éœ€è¦çš„ ApplicationStateï¼Œå›å‚³ &lt;code>ACK2&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æœƒå¤šä¸€å€‹ &lt;code>ACK2&lt;/code> æ˜¯ç‚ºäº†è®“é€šè¨Šæ›´ç©©å®šï¼Œé”åˆ°æ›´å¿«æ”¶æ–‚çš„ä½œç”¨ï¼Œä½†é€™é‚Šå¦‚æœ ç¯€é» B æ²’æ”¶åˆ° ACK2 æ˜¯å¦æœƒé‡è©¦ç­‰å¦‚åŒ TCP ä½œæ³•å°±æ²’æœ‰æåŠ&lt;/p>
&lt;blockquote>
&lt;p>ç¸½çµä¾†çœ‹å‚³é€è¨Šæ¯çš„éç¨‹ï¼Œåœ¨ Cluster æ²’æœ‰ç¯€é»ç‹€æ…‹ç•°å‹•ä¸‹ï¼Œå‚³é€çš„è¨Šæ¯é‡æ˜¯å›ºå®šçš„ï¼Œä¸æœƒæœ‰ &lt;code>Gossip Storm&lt;/code> ç¶²è·¯å°åŒ…çªç„¶çˆ†é‡çš„æƒ…æ³ï¼› &lt;br>
é™¤éæ˜¯æœ‰ç¯€é» æ–°åŠ å…¥ï¼Œå¤šå€‹ç¯€é» å¸Œæœ›åŒæ­¥è³‡è¨Šæ‰æœ‰å¯èƒ½&lt;/p>
&lt;/blockquote>
&lt;p>ä¾†çœ‹å¯¦éš›æ¡ˆä¾‹ï¼Œå‡è¨­
ç›®å‰æœ‰ç¯€é»A (10.0.0.1)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259909635, version &lt;span class="m">325&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version &lt;span class="m">45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">87&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259911052, version &lt;span class="m">61&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 2.7, generation 1259911052, version &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">31&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259912238, version &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 12.0, generation 1259912238, version &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259912942, version &lt;span class="m">18&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 6.7, generation 1259912942, version &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bj05IVc0lvRXw2xH, generation 1259912942, version &lt;span class="m">7&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥åŠç¯€é»B (10.0.0.2)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259909635, version &lt;span class="m">324&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version &lt;span class="m">45&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version &lt;span class="m">87&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259911052, version &lt;span class="m">63&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 2.7, generation 1259911052, version &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">31&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version &lt;span class="m">62&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EndPointState 10.0.0.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HeartBeatState: generation 1259812143, version &lt;span class="m">2142&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 16.0, generation 1259812143, version &lt;span class="m">1803&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: W2U1XYUC3wMppcY7, generation 1259812143, version &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="ç¯€é»a-æ±ºå®šå‘ç¯€é»b-ç™¼èµ·-gossip">ç¯€é»A æ±ºå®šå‘ç¯€é»B ç™¼èµ· Gossip&lt;/h4>
&lt;p>ç”¢ç”Ÿçš„ GossipDigestSynMessage æœƒæ˜¯é¡ä¼¼æ–¼ &lt;code>10.0.0.1:1259909635:325 10.0.0.2:1259911052:61 10.0.0.3:1259912238:5 10.0.0.4:1259912942:18&lt;/code>ï¼Œä¸»è¦æ˜¯å‚³é€ &lt;code>Node IP:generation:version&lt;/code>&lt;/p>
&lt;h4 id="ç¯€é»b-æ”¶åˆ°-gossipdigestsynmessage">ç¯€é»B æ”¶åˆ° GossipDigestSynMessage&lt;/h4>
&lt;p>æœƒæœ‰ä»¥ä¸‹æµç¨‹&lt;/p>
&lt;ol>
&lt;li>è·Ÿè‡ªå·±çš„ç‹€æ…‹æ¯”è¼ƒï¼Œå¾å·®ç•°æœ€å¤šçš„éæ¸›æ’åºï¼Œé€™æ„å‘³è‘—å„ªå…ˆè™•ç†å·®ç•°æœ€å¤šçš„ç¯€é»è³‡è¨Š&lt;/li>
&lt;li>æ¥è‘—æª¢é©—æ¯ä¸€å€‹ç¯€é»çš„è³‡æ–™
-ç¯€é»A æ‰€ä¿å­˜çš„ &lt;code>10.0.0.1:1259909635:325&lt;/code> æœƒå¤§æ–¼ç¯€é»B æ‰€ä¿å­˜çš„&lt;code>10.0.0.1:1259909635:324&lt;/code>ï¼Œgeneration ä¸€æ¨£æ‰€ä»¥ç•¥éï¼Œä½†æ˜¯ version 325 &amp;gt; 324ï¼Œå‰‡ä»£è¡¨ç¯€é»B éœ€è¦å‘ç¯€é» A ç´¢å– 10.0.0.1 åœ¨ ApplicationState åœ¨ç‰ˆæœ¬ 324 ä¹‹å¾Œçš„è³‡æ–™
&lt;ul>
&lt;li>&lt;code>10.0.0.2:1259911052:61&lt;/code> æ¯”ç¯€é»B ä¿å­˜çš„ç‰ˆæœ¬é‚„è¦å°ï¼Œæ‰€ä»¥åˆ°æ™‚å€™æœƒæ‰“åŒ…è³‡æ–™çµ¦ç¯€é»A&lt;/li>
&lt;li>&lt;code>10.0.0.3:1259912238:5&lt;/code> éƒ¨åˆ†ç¯€é»B generation æ¯”è¼ƒå°ï¼Œé€™æ„å‘³è‘— 10.0.0.3 æœ‰ reboot éï¼Œæ‰€ä»¥ç¯€é»B éœ€è¦æ›´æ–°å…¨éƒ¨çš„è³‡æ–™&lt;/li>
&lt;li>&lt;code>10.0.0.4:1259912942:18&lt;/code>ç¯€é»B æ ¹æœ¬æ²’æœ‰ 10.0.0.4 çš„è³‡æ–™ï¼Œæ‰€ä»¥éœ€è¦å…¨éƒ¨çš„è³‡æ–™&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>çµ„åˆä»¥ä¸Šçµæœ GossipDigestAckMessageçš„å…§å®¹æœƒæ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">10.0.0.1:1259909635:324
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.3:1259912238:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.4:1259912942:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.2:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: AujDMftpyUvebtnn, generation 1259911052, version 62&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState, generation 1259911052, version 63&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™ä»£è¡¨è‘—&lt;/p>
&lt;ul>
&lt;li>è«‹çµ¦æˆ‘ 10.0.0.1 åœ¨ generation 1259909635 ä¸­ version 324 ä»¥å¾Œçš„æ›´æ–°è³‡æ–™&lt;/li>
&lt;li>è«‹çµ¦æˆ‘ 10.0.0.3 åœ¨ generation 1259912238 å…¨éƒ¨è³‡æ–™ (version:0)&lt;/li>
&lt;li>10.0.0.4 åŒä¸Š&lt;/li>
&lt;li>é€™æ˜¯ä½ éœ€è¦æ›´æ–°é—œæ–¼ 10.0.0.2 çš„ ApplicationState è³‡æ–™&lt;/li>
&lt;/ul>
&lt;h4 id="ç¯€é»a-å›è¦†-gossipdigestack2message">ç¯€é»A å›è¦† GossipDigestAck2Message&lt;/h4>
&lt;p>ç¯€é»A æ”¶åˆ°å¾Œï¼Œæ›´æ–°å®Œ 10.0.0.2 çš„è³‡è¨Šå¾Œï¼Œæ¥è‘—å›è¦†ç¯€é»B æ‰€è¦çš„è³‡æ–™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">10.0.0.1:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 5.2, generation 1259909635, version 45&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;bootstrapping&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version 56&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bxLpassF3XD8Kyks, generation 1259909635, version 87&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState, generation 1259909635, version 325&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.3:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 12.0, generation 1259912238, version 3&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState, generation 1259912238, version 3&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.4:&lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;load-information&amp;#34;&lt;/span>: 6.7, generation 1259912942, version 3&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>ApplicationState &lt;span class="s2">&amp;#34;normal&amp;#34;&lt;/span>: bj05IVc0lvRXw2xH, generation 1259912942, version 7&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>HeartBeatState: generation 1259912942, version 18&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£å°±å®Œæˆä¸€è¼ªçš„ Gossip äº†&lt;/p>
&lt;blockquote>
&lt;p>å¯ä»¥çœ‹å‡ºç‚ºä»€éº¼ HeartbeatState çš„ version æœƒèˆ‡ ApplicationState å…±äº«ï¼Œé€™é‚Šçš„å…±äº«æŒ‡çš„æ˜¯åœ¨&lt;code>åŒä¸€å€‹ç¯€é»ä¸‹ ApplicationState çš„ version å¿…é ˆæ˜¯ç¨ä¸€ç„¡äºŒä¸”éå¢&lt;/code>ï¼Œé€™æ¨£æ‰èƒ½åœ¨ SYN æ™‚åªå‚³é€ HeartbeatState ç›´æ¥åˆ¤æ–·æœ‰å“ªäº›æ¬„ä½éœ€è¦æ›´æ–°&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥ä¸Šç¯„ä¾‹æ•´ç†è‡ª &lt;a class="link" href="https://cwiki.apache.org/confluence/display/CASSANDRA2/ArchitectureGossip" target="_blank" rel="noopener"
>ArchitectureGossip&lt;/a>&lt;/p>
&lt;h2 id="å…¶ä»–é›†ç¾¤ä¸Šçš„ç®¡ç†">å…¶ä»–é›†ç¾¤ä¸Šçš„ç®¡ç†&lt;/h2>
&lt;p>é›†ç¾¤ç®¡ç†ä¸Šï¼Œé™¤äº†é€é Gossip Protocol åŒæ­¥è³‡è¨Šå¤–ï¼Œé‚„æœ‰å¹¾å€‹å•é¡Œè¦è§£æ±º&lt;/p>
&lt;ol>
&lt;li>èª°åœ¨ Cluster ç•¶ä¸­&lt;/li>
&lt;li>å¦‚ä½•æ±ºå®šç¯€é»çš„ç‹€æ…‹æ˜¯ Up / Downï¼Œé€™åˆæœƒå¸¶ä¾†ä»€éº¼å½±éŸ¿&lt;/li>
&lt;li>ä½•æ™‚è¦çµ‚æ­¢è·ŸæŸç¯€é»çš„é€šè¨Š&lt;/li>
&lt;li>æ‡‰è©²è¦åå¥½èˆ‡å“ªå€‹ç¯€é»é€šè¨“&lt;/li>
&lt;li>å¢åŠ /ç§»é™¤/åˆªé™¤/å–ä»£ç¯€é»æ™‚å¦‚ä½•å¯¦ä½œ&lt;/li>
&lt;/ol>
&lt;h3 id="èª°åœ¨-cluster-ç•¶ä¸­">èª°åœ¨ Cluster ç•¶ä¸­&lt;/h3>
&lt;p>ç•¶ä¸€å€‹æ–°çš„ç¯€é»è¦å•Ÿå‹•æ™‚ï¼Œä»–å¿…é ˆè¦çŸ¥é“é›†ç¾¤ä¸­æœ‰å“ªäº›ç¯€é»å» Gossipï¼Œåœ¨ Cassandra çš„è¨­å®šæª”ä¸­å¯ä»¥æŒ‡å®š &lt;code>Seed&lt;/code>ï¼Œæœ‰ä¸åŒçš„ä½œæ³•å¯ä»¥æŒ‡å®šï¼Œå¸¸è¦‹æ˜¯å¯«æ­»æŸä¸€äº›ç¯€é»çš„ ip addrï¼Œç¯€é»å•Ÿå‹•å¾Œå°±è·Ÿ Seed ç¯€é»æºé€šï¼Œå¾ŒçºŒå°±é€é Gossip Protocol å–å¾—æ‰€æœ‰ç¯€é»çš„ç‹€æ…‹èˆ‡ IP&lt;/p>
&lt;blockquote>
&lt;p>åœ¨ Consul ä¸­ï¼Œæœƒè‡ªå·±é€éå»£æ’­åœ¨ LAN è£¡é¢è‡ªå‹•ç™¼ç¾æœ‰æ²’æœ‰å…¶ä»–ç¯€é»ï¼Œåœ¨ EC2 ä¸Šé‚„å¯ä»¥æŒ‡å®š EC2 Tag å»æ‰¾å‡ºå…¶ä»–ç¯€é»&lt;/p>
&lt;/blockquote>
&lt;h3 id="failure-detection-æ±ºå®šç¯€é»æ˜¯-up-æˆ–-down">Failure Detection: æ±ºå®šç¯€é»æ˜¯ Up æˆ– Down&lt;/h3>
&lt;p>åœ¨ Cassandra ä¸­ï¼ŒéŒ¯èª¤åµæ¸¬æ˜¯è©²ç¯€é»åœ¨æœ¬åœ°ç«¯æ±ºå®šæŸç¯€é»çš„ç‹€æ…‹ï¼Œè€Œé€™å€‹ç‹€æ…‹ä¸æœƒéš¨è‘— Gossip æ‰€å‚³é€&lt;/p>
&lt;blockquote>
&lt;p>ex.ç¯€é»A è¦ºå¾—ç¯€é»B æ˜¯ Downï¼Œç•¶ç¯€é»A è·Ÿç¯€é»C Gossip æ™‚ï¼Œç¯€é»C ä¸æœƒå› ç‚ºç¯€é»A è€ŒæŠŠç¯€é»B åˆ¤æ–·æˆ Downï¼Œç¯€é» C æœƒè‡ªè¡Œåˆ¤æ–·&lt;/p>
&lt;/blockquote>
&lt;p>åµæ¸¬çš„æ–¹å¼é€é Heartbeatï¼ŒHeartbeat å¯ä»¥æ˜¯ç¯€é»è·Ÿç¯€é»ç›´æ¥ç”¨ Gossip é€šè¨Šï¼Œä¹Ÿå¯ä»¥æ˜¯å¾å…¶ä»–ç¯€é»é–“æ¥å–å¾— Gossipï¼›&lt;br>
ç¯€é»æœƒè¨ˆç®—æ¯æ¬¡ Heartbeat çš„é–“éš”ï¼Œç•¶è¶…é &lt;code>phi_convict_threshold&lt;/code> å‰‡åˆ¤å®šç‚º Downï¼Œç³»çµ±éœ€è¦å› æ‡‰ç¡¬é«”ç‹€æ…‹/ç¶²è·¯ç’°å¢ƒå»èª¿æ•´é–¥å€¼ï¼Œé¿å…å¤ªæ•æ„Ÿèª¤åˆ¤æˆ–æ˜¯å¤ªé²éˆè€Œåæ‡‰ä¸åŠç­‰ç‹€æ³&lt;/p>
&lt;p>åœ¨ç¯€é»æ–·ç·šçš„æ™‚å€™ï¼Œå…¶ä»–ç¯€é»éƒ¨åˆ†çš„å¯«å…¥å¯èƒ½å› æ­¤æ²’æœ‰æ”¶åˆ° ACK å›è¦†ï¼Œæ­¤æ™‚æœƒæš«å­˜åœ¨æœ¬åœ°ç•¶ä½œ Hintï¼Œå¦‚æœç¯€é»åœ¨ä¸€å®šæ™‚é–“å…§æ¢å¾©ï¼Œå‰‡æœƒé€é Hint é‡æ–°å‚³é€å¯«å…¥ï¼Œä¿®å¾©æ‰è³‡æ–™çš„å¯èƒ½&lt;/p>
&lt;p>å¦‚æœç¯€é»é‡æ–°æ¢å¾©æ™‚ï¼Œå…¶ä»–ç¯€é»æœƒå®šæœŸé‡é€ Gossip çµ¦ Offline ç¯€é»ï¼Œå±†æ™‚å°±èƒ½æŠŠ Down èª¿æ•´å› Up&lt;/p>
&lt;h3 id="ç¯€é»åå¥½">ç¯€é»åå¥½&lt;/h3>
&lt;p>é™¤äº†éŒ¯èª¤åµæ¸¬å¤–ï¼ŒCassandra å…§éƒ¨æœ‰æ¨¡çµ„ Dynamic Snitch å°ˆé–€åšç¯€é»é–“çš„é€šè¨Šå“è³ªåµæ¸¬ï¼Œæ¯ 100 msè¨ˆç®—èˆ‡å…¶ä»–ç¯€é»çš„å»¶é²ï¼Œè—‰æ­¤æ‰¾å‡ºè¡¨ç¾è¼ƒå¥½çš„ç¯€é»ï¼›&lt;br>
ç‚ºäº†é¿å…ä¸€æ™‚ç¶²è·¯æ³¢å‹•ï¼Œæ¯ 10 åˆ†é˜å°±æœƒé‡æ–°è¨ˆç®—&lt;/p>
&lt;p>å…¶é¤˜çš„ç¯€é»ç®¡ç†å°±æš«æ™‚ç•¥éï¼Œå°æ–¼ç†è§£ Gossip Protocol ä¸å¤§&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œç¯€é»çš„ç‹€æ…‹åŒæ­¥ååˆ†åŸºç¤ä¸”é‡è¦ï¼Œè€Œ Gossip Protocol ç›®å‰æ˜¯è¢«å»£æ³›æ‡‰ç”¨çš„è§£æ³•ï¼Œæ¨¡æ“¬äººé¡å‚³é€å…«å¦çš„æ–¹å¼ï¼Œæƒ³ä¸åˆ°åœ¨æ©Ÿå™¨ä¹Ÿä¸€æ¨£é©ç”¨&lt;br>
æ•´é«”æœ€æœ‰è¶£çš„è¨­è¨ˆæ‡‰è©²åœ¨æ–¼ &lt;code>generation / version&lt;/code> çš„å¯¦ä½œï¼Œé€é generation å¯ä»¥çŸ¥é“æ©Ÿå™¨é‡å•Ÿéå¾Œè¦ä¸è¦é‡æ–°è¦è³‡æ–™ï¼›é€é version å¯ä»¥å¿«é€Ÿ diff åƒ…æœ‰å“ªäº›è³‡æ–™è¦æ›´æ–°ï¼Œé¿å…é¡å¤–çš„å‚³è¼¸æµªè²»ï¼Œä¸‹ä¸€ç¯‡å°‡å¾ç†è«–ä¸Šå»åˆ†æ Gossip Protocol&lt;/p></description></item><item><title>Redis Cluster ä»‹ç´¹</title><link>https://yuanchieh.page/posts/2020/2020-10-19-redis-cluster-%E4%BB%8B%E7%B4%B9/</link><pubDate>Mon, 19 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-19-redis-cluster-%E4%BB%8B%E7%B4%B9/</guid><description>&lt;p>é›–ç„¶ Redis Cluster æ¨å‡ºå·²ä¹…ï¼Œä½†å…¬å¸æœ€è¿‘æ‰æº–å‚™å¾ Sentinel è½‰æˆ Clusterï¼Œæ¶æ§‹ä¸Šæœ‰ä¸å°‘çš„èª¿æ•´ï¼Œä»¥ä¸‹é–±è®€æ–‡ä»¶ &lt;a class="link" href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener"
>Redis Cluster Specification&lt;/a>ä¸¦æ‘˜è¦&lt;/p>
&lt;h2 id="overview">Overview&lt;/h2>
&lt;p>å¯ä»¥ç”±ä¸€è‡³å¤šå€‹ replica çµ„æˆï¼Œæ¯ä¸€å€‹ replica åˆ†é…å›ºå®šçš„ slotï¼Œé€é CRC å°‡ key åš hash å¾Œåˆ†é…è‡³å›ºå®šçš„ replicaï¼Œslot ç¸½æ•¸å›ºå®šåœ¨ &lt;code>16358&lt;/code> å€‹&lt;/p>
&lt;ol>
&lt;li>å‹•æ…‹å¢åŠ ã€åˆªé™¤ replicaï¼Œå¯ä»¥é€é Migrate æŒ‡ä»¤é‡æ–°åˆ†é… slot&lt;/li>
&lt;li>ä»»ä½•ä¸€å€‹ Node éƒ½èƒ½å¤ æ¥æ”¶ requestï¼Œä½†æ²’æœ‰ proxy åŠŸèƒ½ï¼Œæœƒé€é MOVED å›å‚³ client æ­£ç¢ºçš„ Node&lt;/li>
&lt;li>&lt;code>å¯ç”¨æ€§&lt;/code>ï¼Œé­é‡ç¶²è·¯åˆ†å‰²æ™‚å¤šæ•¸ç¾¤é«”å¯ä»¥æ´»ä¸‹ä¾†ï¼Œæ¢ä»¶æ˜¯ replica è‡³å°‘æœ‰ä»»ä¸€ Master å­˜åœ¨ (å¾ Slave Promote æˆ Master ä¹Ÿå¯ä»¥)&lt;/li>
&lt;/ol>
&lt;p>æ‰€æœ‰çš„å–®ä¸€key æŒ‡ä»¤æ”¯æ´ Clusterï¼Œå¦‚æœæ˜¯ multi-key æŒ‡ä»¤ä¾‹å¦‚ set union ç­‰ï¼ŒRedis æœƒç”¢ç”Ÿ hash tag å¼·è¿«æ‰€æœ‰çš„ multi-key åˆ†é…åˆ°åŒä¸€å€‹ Node ä¸Š&lt;/p>
&lt;h3 id="node">Node&lt;/h3>
&lt;p>æ¯å€‹ Node å½¼æ­¤äº’ç›¸é€é tcp é€£æ¥ï¼Œç¨±ç‚º Redis Cluster Busï¼Œé€é gossip protocol ç™¼ç¾æ–°çš„ node /ping å½¼æ­¤ / ç™¼é€ cluster message ç­‰&lt;/p>
&lt;p>æ¯å€‹ Node éƒ½æœƒæœ‰ &lt;code>160 bitäº‚æ•¸ ID&lt;/code>ï¼Œå³ä½¿ Cluster ip ä½ç½®æ”¹è®Šï¼ŒID ä¹Ÿä¸æœƒæ”¹è®Šï¼Œé™¤éæ˜¯ config æª”è¢«åˆªé™¤æˆ–æ˜¯ admin å¼·åˆ¶æ›¿æ›
Node ä¹‹é–“æ˜¯èµ° TCP ä¸¦é€é 16739 portï¼ŒNode æœƒèˆ‡å…¶ä»– Cluster å…§çš„æ‰€æœ‰ Node ç›¸é€£è¡Œç¨‹ &lt;code>full mesh (N-1 connection)&lt;/code>&lt;/p>
&lt;p>Clusert Node æœƒæ¥å—ä»»æ„çš„é€£ç·šï¼Œä¸¦å›æ‡‰ä»»æ„çš„pingï¼Œä½†å…¶ä»–è¨Šæ¯åªæœ‰&lt;code>è¢«è¦–ç‚º cluster ä¸€éƒ¨åˆ†çš„ Node&lt;/code> æ‰æœƒè™•ç†ï¼Œå¦å‰‡ç›´æ¥ä¸Ÿæ£„
è¦åŠ å…¥ cluster çš„é©—è­‰æœ‰å…©ç¨®æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>admin ä½¿ç”¨ &lt;code>CLUSTER MEET ip port&lt;/code> åŠ å…¥&lt;/li>
&lt;li>å·²ç¶“äº’ç›¸é©—è­‰éçš„ Node å£è€³ç›¸å‚³ï¼Œä¾‹å¦‚ A -&amp;gt; B é©—è­‰éï¼ŒB&amp;lt;-&amp;gt;Cé©—è­‰éï¼Œå‰‡ B æœƒæ¨è–¦ C çµ¦ Aï¼Œå‰‡ A&amp;lt;-&amp;gt;C ä¹Ÿèƒ½æˆåŠŸå»ºç«‹é€£ç·šï¼›
æ‰€ä»¥ Node èˆ‡ä»»ä¸€è¢«é©—è­‰çš„ Node è¨±å¯å¾Œï¼Œå¾ŒçºŒå…¶ä»– Node å°±èƒ½è‡ªå‹•ç™¼ç¾&lt;/li>
&lt;/ol>
&lt;p>æ•´é«”çš„ Cluster Node æ•¸é‡ä¸Šé™å»ºè­°åœ¨ &lt;code>1000&lt;/code> ä»¥å…§&lt;/p>
&lt;h3 id="å¯«å…¥éºå¤±">å¯«å…¥éºå¤±&lt;/h3>
&lt;p>å› ç‚ºæ˜¯éåŒæ­¥å‰¯æœ¬ï¼Œæ‰€ä»¥æœ‰å°æ¦‚ç‡å·²ç¶“å›å‚³æˆåŠŸçµ¦ client çš„ write æœƒè¢«è¦†è“‹ï¼ŒRedis æ¡å– last failover winsï¼Œä¹Ÿå°±æ˜¯æœ€æ–°çš„ä¸€å€‹ Master æœƒè¦†å¯«å…¶ä»–å‰¯æœ¬çš„çµæœï¼Œæ‰€ä»¥æœƒæœ‰ä¸€æ®µç©ºçª—æœŸéºå¤±è³‡æ–™ï¼Œç©ºçª—æœŸé•·çŸ­è¦çœ‹ç™¼ç”Ÿç¶²è·¯åˆ†éš”æ™‚ client æ˜¯é€£åˆ°å¤šæ•¸é‚„æ˜¯å°‘æ•¸ç¾¤&lt;/p>
&lt;p>Master å¯«å…¥å¾Œï¼Œé‚„ä¾†ä¸åŠè¤‡è£½åˆ° Slave å°±æ­»æ‰äº†ï¼Œå¦‚æœæ²’æœ‰åœ¨ä¸€å®šæ™‚é–“ ( NODE_TIMEOUT )å…§æ¢å¾©ï¼ŒSlave è¢« promote æˆ Master é‚£å¯«å…¥çš„çµæœå°±æ‰äº†ï¼›
è€Œ Master è¢« partition éš”é–‹ï¼Œåœ¨ä¸€æ®µæ™‚é–“å¾Œ Master ç™¼ç¾è‡ªå·±é€£ä¸åˆ°å¤šæ•¸Master å°±æœƒåœæ­¢æ¥å—å¯«å…¥è«‹æ±‚&lt;/p>
&lt;h3 id="å¯ç”¨æ€§">å¯ç”¨æ€§&lt;/h3>
&lt;p>ä¾‹å¦‚èªªç›®å‰æœ‰ N å€‹ Master ï¼Œä¸”å°æ‡‰æ­é… N å€‹ Slave (1å°1)ï¼Œå‡è¨­æœ‰ä»»ä¸€å€‹ Node æ›æ‰ï¼Œç›®å‰ç‚º &lt;code>2N - 1&lt;/code>&lt;/p>
&lt;p>æ­¤æ™‚å¦‚æœå‰›å¥½æ®˜å­˜çš„ replica é‚£ä¸€å€‹ Node æ­»å»ï¼Œæ•´å€‹ Cluster æ‰ç®—æ›æ‰ï¼Œåä¹‹å°±èƒ½ç¹¼çºŒé‹ä½œï¼Œå› ç‚ºæœƒæœ‰ä¸€éƒ¨åˆ†çš„ slot æ²’æœ‰ Node è² è²¬&lt;br>
æ‰€ä»¥ &lt;code>avalaibility æ˜¯ 1 / (2N-1)&lt;/code>&lt;/p>
&lt;h3 id="æ•ˆèƒ½">æ•ˆèƒ½&lt;/h3>
&lt;p>å› ç‚º Node æ²’æœ‰ Proxy åŠŸèƒ½ï¼Œæ‰€ä»¥åªæœƒè·Ÿ client èªªæ­£ç¢ºçš„ Node åœ¨å“ªï¼Œæ¥è‘— client è¦å†ç™¼èµ·ä¸€æ¬¡ request æ‰èƒ½å®Œæˆæ“ä½œï¼Œæœ€çµ‚ client æœƒçŸ¥é“æ‰€æœ‰çš„æ“ä½œè©²å»å“ªå€‹ Nodeï¼›&lt;br>
åŸºæœ¬ä¸Šä¸å¤ªéœ€è¦æ“”å¿ƒæ•ˆèƒ½å•é¡Œï¼Œå‡è¨­ Cluster æœ‰ N å€‹ Masterï¼Œè² è¼‰èƒ½åŠ›åŸºæœ¬ä¸Šå¯ä»¥è¦–ç‚ºå–®æ©Ÿ * Nï¼Œé›–ç„¶æœ‰ä¸Šè¿°åœ¨ç¬¬ä¸€æ¬¡è¦å¤šæŸ¥ä¸€æ¬¡çš„å•é¡Œï¼Œä½†å› ç‚º Client å°æ–¼æ¯å€‹ Cluster Master éƒ½ä¿æŒ TCP é•·é€£çµï¼Œæ‰€ä»¥ä¸è‡³æ–¼å¤ªæ“”å¿ƒ&lt;/p>
&lt;h3 id="åˆ†æ•£å¼æ¨¡å‹">åˆ†æ•£å¼æ¨¡å‹&lt;/h3>
&lt;p>redis å°‡ key space åˆ‡å‰²æˆ 16384 ç­‰åˆ† &lt;code>HASH_SLOT = CRC16(key) mod 16384&lt;/code>ï¼Œåˆ†é…å¾Œæœƒå›ºå®šï¼Œè©² slot å°±æœƒç”±åŒä¸€å€‹ Node è² è²¬ï¼Œç›´åˆ°æœ‰ reconfig çš„æŒ‡ä»¤ï¼›&lt;/p>
&lt;p>hash tag æ˜¯ä¸€å€‹åˆ†æ•£çš„ä¾‹å¤–ï¼Œä¸»è¦æ˜¯ç‚ºäº†æ”¯æ´ &lt;code>multi-key&lt;/code> å¯ä»¥åˆ†é…åˆ°åŒä¸€å€‹ hash slot ä¸Šï¼Œå¦‚æœ key åŒ…å« {} ï¼Œå‰‡ hash key ç”¢ç”Ÿæ˜¯key è£¡é¢ç¬¬ä¸€çµ„ {â€¦} ä¸­é–“çš„å€¼ (æ²’æœ‰åŒ…å« {})&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">HASH_SLOT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">keylen&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">keylen&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* æ²’æœ‰æ‰¾åˆ° {ï¼Œå‰‡ hash æ•´å€‹å­—ä¸² */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">keylen&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">crc16&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">keylen&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">16383&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* æ‰¾åˆ° { */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">keylen&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* æ²’æœ‰æ‰¾åˆ° }ï¼Œhash æ•´å€‹å­—ä¸² */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">keylen&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">crc16&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">keylen&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">16383&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* å¦‚æœæœ‰ {} é…å°ï¼Œå‰‡ key å– {...} ä¹‹é–“çš„å­—ä¸² */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">crc16&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">16383&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="resharding">Resharding&lt;/h2>
&lt;p>Redis Cluster åœ¨ç®¡ç†ä¸Šä»¥åŠä½¿ç”¨ä¸Šéƒ½æœ‰ç›¸ç•¶å¤§çš„å½ˆæ€§ï¼ŒCluster å¯ä»¥ä»»æ„å¢æ¸› Node æ•¸é‡ä»¥åŠèª¿æ•´ Slot å°æ‡‰çš„ Nodeï¼›è€Œ Redis Client å¯ä»¥èˆ‡ä»»æ„çš„ Node é€£ç·š&lt;/p>
&lt;p>å¦‚æœ Node æ”¶åˆ° Client request å¾Œ&lt;/p>
&lt;ol>
&lt;li>å¦‚æœè©²è³‡æ–™å±¬æ–¼ä»–çš„ slotï¼Œå‰‡ç›´æ¥è™•ç†&lt;/li>
&lt;li>åä¹‹å‰‡æ‰¾å‡ºå“ªå€‹ Node æ‡‰è©²è² è²¬ï¼Œå›å‚³ Moved éŒ¯èª¤çµ¦ Client &lt;code>-MOVED 3999 127.0.0.1:6381&lt;/code>ï¼Œé€™ä»£è¡¨ key åœ¨ slot 3999ï¼Œæ­£ç¢ºçš„ Node æ˜¯ 127.0.0.1:6381&lt;/li>
&lt;/ol>
&lt;p>Client åœ¨æ¯æ¬¡æ”¶åˆ° MOVED å¾Œéƒ½æ‡‰è©²å»è¨˜ä½å“ªä¸€å€‹ slot å°æ‡‰å“ªä¸€å€‹ Nodeï¼Œé€™æ¨£å¯ä»¥å¢åŠ æ•ˆç‡ï¼›&lt;br>
åˆç›´æ¥æ‹‰ä¸‹æ•´å¼µ mappingï¼Œç”¨ &lt;code>$cluster nodes&lt;/code> æ‰¾å‡ºæ‰€ä»¥çš„ nodeï¼Œä¸¦çµåˆ &lt;code>$cluster slots&lt;/code> ç›´æ¥æŸ¥çœ‹ cluster å®Œæ•´å°ç…§è¡¨ï¼Œå°±å¯ä»¥å®Œæ•´çŸ¥é“ node å°æ‡‰çš„ slot ä»¥åŠ node ip ä½ç½®èˆ‡ id&lt;/p>
&lt;h3 id="rebalance">Rebalance&lt;/h3>
&lt;p>Cluster å¯ä»¥åœ¨é‹è¡Œä¸­å¢æ¸› Nodeï¼Œä¸¦ä¸”æœƒè‡ªå‹•æ¬ç§»è³‡æ–™ä¸¦æ›´æ–° slot mappingï¼Œæœ‰å¹¾å€‹ command å¯ä»¥å‹•æ…‹å½±éŸ¿ Node èˆ‡ Slot&lt;/p>
&lt;ol>
&lt;li>&lt;code>addslot&lt;/code> : æŒ‡å®š Node å¢åŠ  slot&lt;/li>
&lt;li>&lt;code>delslot&lt;/code> : ç§»é™¤ slotï¼ŒåŸæœ¬è² è²¬çš„ Node æœƒéºå¿˜é€™å€‹ slot&lt;/li>
&lt;li>&lt;code>setslot&lt;/code> : è½‰ç§» slot&lt;/li>
&lt;/ol>
&lt;p>è½‰ç§»çš„éƒ¨åˆ†æ¯”è¼ƒè¤‡é›œï¼Œæœƒéœ€è¦å…ˆå»èª¿æ•´ Node ç‹€æ…‹ï¼Œä¾‹å¦‚èªªå¸Œæœ›å°‡ slot 8å¾ Node A è½‰åˆ° Node B&lt;/p>
&lt;ol>
&lt;li>åœ¨ Node B ä¸ŠæŒ‡å®šè³‡æ–™æœƒå¾ Node A éä¾†: &lt;code>$CLUSTER SETSLOT 8 IMPORTING A&lt;/code>&lt;/li>
&lt;li>åœ¨ Node A ä¸ŠæŒ‡å®šè¦æŠŠ slot 8 è½‰ç§»åˆ° Node B ä¸Š: &lt;code>$CLUSTER SETSLOT 8 MIGRATING B&lt;/code>&lt;/li>
&lt;li>ä¹‹å¾Œæœ‰ä¸€å€‹èƒŒæ™¯ç¨‹å¼ &lt;code>redis-trib&lt;/code> æœƒä¸»å‹•å°‡ slot é€æ­¥æ¬ç§»&lt;/li>
&lt;/ol>
&lt;p>ä¹Ÿå¯ä»¥æ‰‹å‹•è½‰ç§»&lt;/p>
&lt;ol>
&lt;li>åˆ—å‡ºè©² slot ä¸€å®šæ•¸é‡çš„ hash key: &lt;code>$CLUSTER GETKEYSINSLOT slot count&lt;/code>&lt;/li>
&lt;li>å°‡é€™äº› key è½‰ç§»: &lt;code>$MIGRATE target_host target_port key target_database id timeout&lt;/code>ï¼ŒMigrate æœƒåœ¨è½‰ç§»æˆåŠŸå¾Œæ‰ç§»é™¤ Node B çš„ç´€éŒ„&lt;/li>
&lt;/ol>
&lt;p>éç¨‹å¯åƒè€ƒæ­¤å•ç­” &lt;a class="link" href="https://stackoverflow.com/questions/53080371/redis-cluster-live-reshard-failure" target="_blank" rel="noopener"
>Redis cluster live reshard failure&lt;/a>&lt;/p>
&lt;h3 id="è½‰ç§»éç¨‹">è½‰ç§»éç¨‹&lt;/h3>
&lt;p>åœ¨è½‰ç§»éç¨‹ä¸­ï¼Œclient é‡å°æ¬ç§»ä¸­èˆ‡æ¬å…¥ä¸­çš„ Node ç™¼å‡º Request åæ‡‰æœƒæœ‰æ‰€ä¸åŒ&lt;/p>
&lt;ol>
&lt;li>æ¬å‡ºä¸­çš„ Node : &lt;br>
a. å¦‚æœ key é‚„åœ¨ Nodeä¸­ å‰‡ç›´æ¥è™•ç† &lt;br>
b. ä¸å†å‰‡å›å‚³ &lt;code>ASK&lt;/code> éŒ¯èª¤ï¼ŒClient æ¥è‘—å¿…å…ˆå‘æ–°çš„ Node ç™¼å‡º &lt;code>ASKING&lt;/code>ï¼Œæ¥è‘—æ‰å‚³é€ Request&lt;/li>
&lt;li>æ¬å…¥ä¸­çš„ Node : åªè™•ç†æœ‰å…ˆå‚³é€ ASKING çš„è«‹æ±‚ï¼Œå…¶é¤˜å›å‚³ MOVED éŒ¯èª¤&lt;/li>
&lt;/ol>
&lt;p>é€™æ¨£çš„ç›®çš„æ˜¯ç‚ºäº†æ–¹ä¾¿è½‰ç§»éç¨‹ï¼Œ&lt;code>New Key ä¸€å®šæ˜¯åœ¨æ¬å…¥ä¸­ Nodeç”¢ç”Ÿ&lt;/code>ï¼ŒMigrate å‰‡åªéœ€è¦è™•ç† Old Key&lt;/p>
&lt;blockquote>
&lt;p>å·²ç¶“æœ‰ MOVED éŒ¯èª¤ç¢¼ä»ç„¶éœ€è¦ ASK çš„åŸå› æ˜¯ ASK æ˜¯ä¸€æ¬¡æ€§è«‹æ±‚ï¼Œæˆ‘å€‘æœƒå¸Œæœ›åœ¨æ¬ç§»éç¨‹ï¼Œå‡è¨­ Client å¦‚æœæœ‰ slot 8 çš„è«‹æ±‚ï¼Œæ‡‰è©²å…ˆå»å• A å†å»å• Bï¼Œå¦‚æœ A æ²’æœ‰æœƒç”¨ ASK è½‰å» Bï¼›&lt;br>
MOVED ä»£è¡¨çš„æ˜¯å¾€å¾Œçš„æ°¸ä¹…æ€§æ‰€æœ‰é‡å° slot 8 çš„è«‹æ±‚éƒ½å» Node Bï¼Œä½†é¡¯ç„¶é‚„åœ¨ migrate çš„è©±æœƒæœ‰å¤§é‡çš„ key é‚„æ²’æ¬ç§»ï¼Œæ‰€ä»¥ç”¨ ASK ä¸€æ¬¡æ€§çš„æŸ¥è©¢ç•¶ä½œéåº¦&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœæ˜¯ multi-key æ“ä½œï¼Œå‡è¨­ key åˆ†æ•£åœ¨å…©å€‹ node ä¹‹é–“ï¼Œå‰‡æœƒæ”¶åˆ° &lt;code>TRYAGAIN&lt;/code> éŒ¯èª¤&lt;/p>
&lt;h2 id="fault-tolerance">Fault Tolerance&lt;/h2>
&lt;p>Node æœƒç™¼é€ &lt;code>ping / pong&lt;/code> å»ç¢ºèªå…¶ä»– Node æ˜¯å¦é‚„å­˜æ´»ï¼Œå…©è€…åˆä½µåˆç¨± &lt;code>heartbeat&lt;/code>ï¼Œé™¤äº† ping æœƒè§¸ç™¼ pong å›å¾©å¤–ï¼Œå¦‚æœ Node æœ‰ config æª”æ›´æ–°ï¼Œä¹Ÿæœƒä¸»å‹•ç™¼é€ pong çµ¦å…¶ä»– Node&lt;/p>
&lt;p>åœ¨åŠå€‹ &lt;code>NODE_TIMEOUT&lt;/code> æ™‚é–“å…§ï¼ŒNode æœƒé€ ping çµ¦å…¶ä»–æ‰€æœ‰çš„ Node ç¢ºä¿å­˜æ´»ï¼Œåœ¨ NODE_TIMEOUT æ™‚é–“é»åˆ°å‰ï¼ŒNode é‚„æœƒé‡æ–°èˆ‡å…¶ä»– Node å»ºç«‹ TCP é€£ç·šï¼Œç¢ºä¿ping æ²’æ”¶åˆ°ä¸æ˜¯å‰›å¥½é€™ä¸€æ¬¡çš„ TCP é€£ç·šæœ‰å•é¡Œ&lt;/p>
&lt;blockquote>
&lt;p>æ‰€ä»¥ packet äº¤æ›æ•¸é‡èˆ‡ Node æ•¸é‡å’Œ NODE_TIMEOUT æ™‚é–“æœ‰é—œï¼Œä¾‹å¦‚ 100 Node + 60 sec çš„ timeoutï¼Œå‰‡æ¯ä¸€å€‹ Node 30 sec å…§æœƒé€ 99 å€‹ping çµ¦å…¶ä»– Nodeï¼Œæ›ç®—å¾Œæ•´å€‹ cluster æ˜¯æ¯ç§’ 330ping&lt;/p>
&lt;/blockquote>
&lt;p>heartbeat å°åŒ…å…±ç”¨ Header å¤§è‡´å¦‚ä¸‹&lt;/p>
&lt;ol>
&lt;li>NodeID: 160 bit è­˜åˆ¥ç¢¼&lt;/li>
&lt;li>currentEpoch: éå¢æ•¸å­—ï¼Œç”¨ä¾†è¡¨ç¤ºè¨Šæ¯çš„å…ˆå¾Œé †åº&lt;/li>
&lt;li>flag: æ˜¯ Master é‚„æ˜¯ Slave&lt;/li>
&lt;li>bitmap: ç”¨ä¾†è¡¨ç¤ºè² è²¬çš„ slot&lt;/li>
&lt;li>sender çš„ tcp port&lt;/li>
&lt;li>sender èªç‚º Cluter æ˜¯å¦é‚„åœ¨é‹è¡Œ&lt;/li>
&lt;li>å¦‚æœæ˜¯ Slave å‰‡éœ€è¦åŒ…å« Master NodeID&lt;/li>
&lt;/ol>
&lt;h3 id="fault-detection">Fault Detection&lt;/h3>
&lt;p>åœ¨ Cluster ä¸­ï¼Œä¸€å€‹ Node è¢«åˆ¤å®šéŒ¯èª¤æ˜¯ç¶“ç”±å¤šæ•¸çš„ Node æ‰€æ±ºå®šï¼›&lt;br>
è€Œå¦‚æœç™¼ç”ŸéŒ¯èª¤çš„æ˜¯ Masterï¼Œä¸”æ²’æœ‰ Slave è¢«æˆåŠŸå‡ç´šæˆ Masterï¼Œå‰‡æ­¤æ™‚ Cluster é€²å…¥éŒ¯èª¤ç‹€æ…‹ï¼Œåœæ­¢ Client çš„è«‹æ±‚&lt;/p>
&lt;p>Node åœ¨æ™‚é–“å…§æœƒéš¨æ©Ÿå°æ•¸å€‹ Node ç™¼é€ping è«‹æ±‚ï¼Œæ­¤æ™‚å¦‚æœè¶…é &lt;code>NODE_TIMEOUT&lt;/code> éƒ½æ²’æ”¶åˆ° pongï¼Œå‰‡æœƒæ¨™è¨˜è©² Node ç‚º &lt;code>PFAIL&lt;/code>ï¼Œæ­¤æ™‚çš„ PFAIL ä¸¦ä¸æœƒè§¸ç™¼ä»»ä½•æ©Ÿåˆ¶ï¼›&lt;br>
ç•¶ Node åœ¨å›è¦† pong æ™‚ï¼ŒæœƒæŠŠè‡ªå·±æ‰€ç¶­è­·çš„&lt;code>hash slot map&lt;/code>ä¹Ÿä¸€ä¸¦ç™¼é€ï¼Œæ‰€ä»¥æ¯å€‹ Node åœ¨ä¸€å®šçš„æ™‚é–“å…§éƒ½æœƒçŸ¥é“å…¶ä»– Node æ‰€ç¶­è­·çš„æ¨™è¨˜ç‹€æ…‹æ¸…å–®&lt;/p>
&lt;p>å‡è¨­ Node A æ¨™è¨˜ Node B ç‚º PFAILï¼Œæ¥è‘— Node A æ”¶åˆ°ä¾†è‡ªå…¶ä»– Master Node å°æ–¼ Node B çš„æ¨™è¨˜ï¼Œå¦‚æœåœ¨ &lt;code> NODE_TIMEOUT * FAIL_REPORT_VALIDITY_MULT&lt;/code> ç­‰å¾…æ™‚é–“å…§ï¼Œå¤§å¤šæ•¸çš„ Master ä¹Ÿéƒ½æ¨™è¨˜ Node B ç‚º PFAIL æˆ–æ˜¯ FAILï¼Œå‰‡ Node A è½‰æ¨™è¨˜ Node B ç‚º &lt;code>FAIL&lt;/code>&lt;/p>
&lt;p>è¢«æ¨™è¨˜æˆ FAIL å¹¾ä¹æ˜¯ä¸å¯é€†ï¼Œé™¤äº†ä¸‹è¿°æƒ…æ³&lt;/p>
&lt;ol>
&lt;li>Node æ˜¯ Slave ä¸”å¯ä»¥è¢«é€£ä¸Š&lt;/li>
&lt;li>Node æ˜¯ Master ä¸”å¯ä»¥è¢«é€£ä¸Šï¼ŒåŒæ™‚æ²’æœ‰åˆ†é…åˆ°ä»»ä½• slotï¼Œæ­¤æ™‚æœƒç­‰å¾…è¢«åŠ å…¥ Cluster&lt;/li>
&lt;li>Node æ˜¯ Master ä¸”å¯ä»¥è¢«é€£ä¸Šï¼ŒåŒæ™‚ Cluster éå¾ˆé•·ä¸€æ®µæ™‚é–“éƒ½æ²’æœ‰ Slave è¢« Promote æˆåŠŸï¼Œå‰‡å¯ä»¥è€ƒæ…®é‡æ–°åŠ å…¥ Cluster&lt;/li>
&lt;/ol>
&lt;p>é€éé€™æ¨£çš„è¨­è¨ˆï¼Œæœ€çµ‚ Cluster ä¸­æ¯ä¸€å€‹ç¯€é»çš„ç‹€æ…‹éƒ½æœƒæ˜¯è¢«åŒæ­¥çš„&lt;/p>
&lt;h2 id="configuration-handling-propagation-and-failovers">Configuration handling, propagation, and failovers&lt;/h2>
&lt;p>é€™ä¸€ç« ç¯€ä¸»è¦è«‡ Slave promotion çš„éç¨‹&lt;/p>
&lt;h3 id="cluster-current-epoch">Cluster current epoch&lt;/h3>
&lt;p>åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œå¿…é ˆæœ‰å€‹æ–¹å¼æ±ºå®šé‡è¤‡æˆ–æ˜¯è¡çªçš„äº‹ä»¶è©²é¸æ“‡å“ªä¸€å€‹ï¼ŒRedis Cluster ä¸­æ¡ç”¨ &lt;code>epoch&lt;/code> (å°æ¯” Raft ä¸­çš„ term) æ˜¯ä¸€å€‹ 64 bit unsigned intï¼Œåˆå§‹åŒ– Master / Slave éƒ½æ˜¯ 0ï¼Œåœ¨ç™¼é€è¨Šæ¯æ™‚åŠ  1ï¼Œåœ¨æ”¶åˆ°è¨Šæ¯æ™‚å¦‚æœå°æ–¹çš„ epoch é«˜æ–¼è‡ªå·±ï¼Œå‰‡æ›´æ–° epoch ä¸¦åŠ  1ï¼›&lt;br>
é‡åˆ°æœ‰è¡çªï¼Œå‰‡é¸æ“‡ epoch è¼ƒé«˜çš„é‚£ä¸€å‰‡è¨Šæ¯&lt;/p>
&lt;p>Master åœ¨ç™¼é€ ping æ™‚æœƒå¤¾å¸¶ configEpoch ä¸”åœ¨å› pong æ™‚æœƒå¤¾å¸¶æ‰€å±¬çš„ slot mapping&lt;/p>
&lt;h3 id="promotion-éç¨‹">Promotion éç¨‹&lt;/h3>
&lt;p>å¦‚æœç¬¦åˆä»¥ä¸‹æ¢ä»¶&lt;/p>
&lt;ol>
&lt;li>Master Node å¤±æ•—&lt;/li>
&lt;li>Master æœ‰è² è²¬ slot&lt;/li>
&lt;li>Slave ä¸¦æ²’æœ‰èˆ‡ Master å¤±è¯è¶…éä¸€å®šæ™‚é–“ï¼Œé€™å€‹åˆ¤å®šæ˜¯ç‚ºäº†é¿å… Slave çš„è³‡æ–™å¤ªèˆŠ&lt;/li>
&lt;/ol>
&lt;p>å‰‡ Slave æœƒæº–å‚™æèµ· Promotionï¼Œæ­¤æ™‚æœƒå¢åŠ  configEpoch å€¼ï¼Œä¸¦å¸Œæœ›å–å¾—å¤šæ•¸ Master çš„åŒæ„ï¼Œç™¼é€ &lt;code>FAILOVER_AUTH_REQUEST&lt;/code> çµ¦ Master Nodesï¼Œæ¥è‘— Slave æœƒç­‰å¾… 2 * NODE_TIMEOUT&lt;/p>
&lt;p>æ­¤æ™‚ Master å¦‚æœåŒæ„ï¼Œå‰‡å›è¦† &lt;code>FAILOVER_AUTH_ACK&lt;/code>ï¼Œæ­¤æ™‚ Master åœ¨æ¥ä¸‹ä¾†çš„ 2 * NODE_TIMEOUT ä¸å¯ä»¥å›è¦†å…¶ä»– Slave Node FAILOVER_AUTH_ACK è¨Šæ¯ï¼Œé¿å…å¤šå€‹ Slave åŒæ™‚æŠ•ç¥¨&lt;/p>
&lt;p>å¦‚æœ Slave åœ¨ 2 * NODE_TIMEOUT å…§æ”¶åˆ°å¤šæ•¸ Master åŒæ„ï¼Œå‰‡é¸èˆ‰é€šéï¼›&lt;br>
åä¹‹å¦‚æœå¤±æ•—ï¼Œå‰‡ 4 * NODE_TIMEOUT å¾Œé–‹å§‹ä¸‹ä¸€æ¬¡é¸èˆ‰&lt;/p>
&lt;h3 id="hash-slot-ç¶­è­·">Hash Slot ç¶­è­·&lt;/h3>
&lt;p>å…ˆå‰æåˆ° Master åœ¨é€ pong æ™‚æœƒæŠŠè‡ªå·±ç®¡ç†çš„ slot ä¹Ÿä¸€ä½µæ›´æ–°ï¼Œæ­¤æ™‚çš„ slot æœƒå¤¾å¸¶ç›®å‰ Master çš„ epoch è³‡è¨Šï¼Œä¾‹å¦‚ä»¥ä¸‹&lt;/p>
&lt;ol>
&lt;li>Cluster åˆå§‹åŒ–ï¼Œæ­¤æ™‚ Slot éƒ½æ²’æœ‰å°æ‡‰çš„ Masterï¼Œéœ€è¦ &lt;code>CLUSTER ADDSLOTS&lt;/code> åˆ†é…&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">16383&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>å‡è¨­åˆ†é…éƒ¨åˆ†çµ¦ Aï¼ŒA æœƒé †ä¾¿æ¨™è¨˜ epochï¼Œå‡è¨­æ­¤æ™‚å€¼ç‚º 3&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> -&amp;gt; A &lt;span class="o">[&lt;/span>3&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> -&amp;gt; A &lt;span class="o">[&lt;/span>3&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">16383&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>ç”¢ç”Ÿ Failoverï¼ŒB ä¸Šä¾†é ‚æ›¿ Aï¼Œæ­¤æ™‚æœƒæŠŠ &lt;code>epoch + 1&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> -&amp;gt; B &lt;span class="o">[&lt;/span>4&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> -&amp;gt; B &lt;span class="o">[&lt;/span>4&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">16383&lt;/span> -&amp;gt; NULL
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™ä¹Ÿå°±æ˜¯ &lt;code>last failover wins&lt;/code> ç­–ç•¥ï¼Œå‡ä½¿ A æ­¤æ™‚ç¶²è·¯é€£ç·šå›ä¾†è¦å®£ç¨±è‡ªå·±æ˜¯ Master ä¹Ÿæœƒè¢«æ“‹ä¸‹ä¾†ï¼Œå› ç‚º A çš„ epoch æ¯”è¼ƒå°&lt;/p>
&lt;h4 id="å¯¦éš›æ¡ˆä¾‹">å¯¦éš›æ¡ˆä¾‹&lt;/h4>
&lt;p>å‡è¨­ Master å·²ç¶“æ›äº†ï¼Œæ­¤æ™‚æœ‰ A,B,C ä¸‰å€‹ Slave&lt;/p>
&lt;ol>
&lt;li>A ç«¶é¸æˆåŠŸè®Šæˆäº† Master&lt;/li>
&lt;li>ç¶²è·¯å€éš”é—œä¿‚ï¼ŒA è¢«è¦–ç‚ºéŒ¯èª¤&lt;/li>
&lt;li>B å› æ­¤ç«¶é¸è€Œæˆ Master&lt;/li>
&lt;li>æ¥è‘—æ› B è¢«ç¶²è·¯å€éš”&lt;/li>
&lt;li>æ­¤æ™‚ A æˆåŠŸé€£ç·šå›ä¾†&lt;/li>
&lt;/ol>
&lt;p>æ­¤æ™‚ B å¤±è¯ï¼ŒA ä»¥ç‚ºè‡ªå·±é‚„æ˜¯ Masterï¼Œæ­¤æ™‚ C å› ç‚º B å¤±è¯æœƒæƒ³è¦å»ç«¶é¸ Master&lt;/p>
&lt;ol>
&lt;li>æ­¤æ™‚ C æœƒæˆåŠŸï¼Œå› ç‚ºå…¶ä»–çš„ Master çŸ¥é“ C çš„ Master(B) å·²ç¶“å¤±æ•—&lt;/li>
&lt;li>A ç„¡æ³•å®£ç¨±è‡ªå·±æ˜¯ Master ï¼Œå› ç‚º hash slot å·²ç¶“è¢«æ›´æ–°æˆ B çš„ epoch ï¼ˆç¬¬ä¸‰æ­¥)ï¼Œä¸” B çš„ epoch é«˜æ–¼ A çš„ epoch&lt;/li>
&lt;li>æ¥è‘— C æœƒæ›´æ–° hash slot çš„ epochï¼ŒCluster æŒçºŒé‹ä½œ&lt;/li>
&lt;/ol>
&lt;h2 id="çµè«–">çµè«–&lt;/h2>
&lt;p>æ•´å€‹çœ‹é Redis Cluster Spec æœƒå°æ–¼å¯¦éš›æ“ä½œæ¯”è¼ƒæœ‰ä¿¡å¿ƒï¼Œä¸‹ä¸€ç¯‡ä¾†è‡ªå·±å¯¦éš›æ¶è¨­çœ‹çœ‹&lt;/p>
&lt;p>æœ‰ä¸€äº›ç´°ç¯€æ¯”è¼ƒç‘£ç¢å°±è·³éï¼Œæœ‰äº›ç« ç¯€è®€èµ·ä¾†æ¯”è¼ƒä¸é€šé †ï¼Œè‡ªå·±é‡æ–°ç†è§£å¾Œç·¨æ’ä¸€ä¸‹ (OS. å¯èƒ½æœƒè®Šå¾—æ›´é›£ç†è§£ ?!&lt;/p></description></item><item><title>ä½¿ç”¨ Redis ç•¶ä½œ API Rate limit çš„ä¸‰ç¨®æ–¹æ³•</title><link>https://yuanchieh.page/posts/2020/2020-10-18-%E4%BD%BF%E7%94%A8-redis-%E7%95%B6%E4%BD%9C-api-rate-limit-%E7%9A%84%E4%B8%89%E7%A8%AE%E6%96%B9%E6%B3%95/</link><pubDate>Sun, 18 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-18-%E4%BD%BF%E7%94%A8-redis-%E7%95%B6%E4%BD%9C-api-rate-limit-%E7%9A%84%E4%B8%89%E7%A8%AE%E6%96%B9%E6%B3%95/</guid><description>&lt;p>æœ€è¿‘å…¬å¸ API æœå‹™è¢« Client ä¸é æœŸçš„é«˜é »å­˜å–ï¼Œé€ æˆå¾Œç«¯ DB å¾ˆå¤§çš„è² æ“”ï¼Œé–‹å§‹è©•ä¼°å„ç¨® API Rate Limit çš„æ–¹æ¡ˆï¼Œå…¶ä¸­ä¸€å€‹æœ€å¸¸è¦‹çš„ä½œæ³•å°±æ˜¯é  Redisï¼Œä½†å…·é«”çš„æ–¹æ¡ˆå…¶å¯¦æœ‰è »å¤šç¨®ï¼Œåƒè€ƒä»¥ä¸‹å½±ç‰‡æ•´ç†ä¸‰ç¨®ä½œæ³•&lt;/p>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/HnSb8DFU5UA"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>é †ä¾¿æ¨è–¦ä¸€ä¸‹ RedisLabs æ‰€æ¨å‡ºçš„ GUI ç®¡ç†å·¥å…· &lt;code>RedisInsights&lt;/code>ï¼Œå¯ä»¥å¿«é€Ÿåˆ†æ Redis ä¸­ Key Space çš„ä½¿ç”¨ / Profiling ä¸€æ®µæ™‚é–“å…§å“ªäº› Key è¢«å¤§é‡å­˜å–ç­‰ç­‰ï¼ŒåŸºæœ¬çš„ Redis CLI æ“ä½œå°±æ›´ä¸ç”¨æäº†ï¼Œå°æ¯”ä¹‹å‰ç”¨çš„ &lt;code>medis&lt;/code> åŠŸèƒ½å¼·åŒ–ä¸å°‘ï¼Œå°¤å…¶æ˜¯&lt;code>ç®¡ç†/ç›£æ§é€™ä¸€å¡Šçš„åŠŸèƒ½&lt;/code>&lt;br>
ç›®å‰æ˜¯å…è²»çš„ï¼Œæ”¯æ´ Cluster Modeï¼Œé€£æ¥ AWS ElasticCache ä¹Ÿæ²’å•é¡Œï¼Œååˆ†æ¨è–¦&lt;/p>
&lt;h2 id="rate-limit-å…¨è§€">Rate Limit å…¨è§€&lt;/h2>
&lt;p>è¦è¨­è¨ˆ Rate Limit æ©Ÿåˆ¶æ™‚éœ€è¦è€ƒé‡å¹¾å€‹é¢å‘&lt;/p>
&lt;h3 id="who">Who&lt;/h3>
&lt;p>è©²å¦‚ä½•è­˜åˆ¥è¦é™åˆ¶çš„å°è±¡ï¼Ÿ&lt;br>
æœ€ç›´è¦ºæ˜¯é€é IPï¼Œä½†æ˜¯ä½¿ç”¨ IP æœ€å¤§çš„é¢¨éšªæ˜¯ å¦‚æœæ˜¯å¤§å®¢æˆ¶ï¼Œä»–ä¸€å€‹äººçš„æµé‡é è¶…éå…¶ä»–å°å®¢æˆ¶ï¼Œå°å…¬å¸çš„åƒ¹å€¼é¡¯ç„¶ä¹Ÿæ˜¯é é é‡è¦ï¼Œå¦‚æœç”¨ IP å¾ˆå®¹æ˜“æœ‰èª¤æ®ºçš„æƒ…æ³ï¼ŒæŠŠæœ‰åƒ¹å€¼çš„ç”¨æˆ¶é˜»æ“‹åœ¨å¤–&lt;/p>
&lt;p>å…¶ä»–çš„ä½œæ³•å¯ä»¥ç”¨ JWT Token / API Key ç­‰å€‹åˆ¥ç”¨æˆ¶è­˜åˆ¥çš„æ–¹å¼ï¼Œéœ€è¦é‡å°è‡ªå®¶çš„æ¥­å‹™å ´æ™¯å»åˆ¤æ–·&lt;/p>
&lt;h3 id="how">How&lt;/h3>
&lt;p>è©²ä½¿ç”¨æ€æ¨£çš„æ–¹å¼è¨ˆç®—é™åˆ¶çš„æ–¹å¼ï¼Ÿ&lt;br>
é€šå¸¸æ˜¯åœ¨æŸå€‹æ™‚é–“å€æ®µå…§ï¼Œé™åˆ¶åªèƒ½å­˜å–å¤šå°‘æ¬¡çš„è¨ˆç®—æ¨¡å¼ï¼Œæœ‰ä¸‰ç¨®æ–¹å¼å¯ä»¥åƒè€ƒ&lt;/p>
&lt;h3 id="static-time-window---å›ºå®šæ™‚é–“å€æ®µ">static time window - å›ºå®šæ™‚é–“å€æ®µ&lt;/h3>
&lt;p>ä¾‹å¦‚èªªæ¯ä¸€åˆ†é˜ç‚ºä¸€å€‹å–®ä½ï¼Œé€™ä¸€åˆ†é˜å…§åªèƒ½å­˜å–äº”æ¬¡&lt;br>
é€™æ¨£çš„æ–¹å¼ååˆ†ç°¡å–®ï¼Œä½†å¯èƒ½æœƒæœ‰çŸ­æ™‚é–“å…§è¶…é‡çš„å•é¡Œï¼Œä¾‹å¦‚èªª 0:59 å­˜å– 4 æ¬¡ï¼Œæ¥è‘— 1:01 å­˜å–4 æ¬¡ï¼Œåˆ†é–‹åœ¨å…©å€‹æ™‚é–“å€æ®µéƒ½æ˜¯åˆæ³•ï¼Œä½†æ˜¯æ‰éš”å…©ç§’å°±å­˜å– 8 æ¬¡ï¼Œé€™å¯èƒ½ä¸æœƒæ˜¯å¸Œæœ›çš„çµæœ&lt;/p>
&lt;p>å¯¦ä½œæ–¹å¼ï¼Œä»¥ç›®å‰æ¯é€± 160 k ä¸‹è¼‰çš„ &lt;code>express-rate-limit&lt;/code> ä¸­ redis ç‰ˆæœ¬ &lt;a class="link" href="https://www.npmjs.com/package/rate-limit-redis" target="_blank" rel="noopener"
>rate-limit-redis&lt;/a> æ˜¯ä»¥ä¸‹åšæ³•&lt;/p>
&lt;ol>
&lt;li>å…ˆè¨ˆç®—å‡ºè©²æ™‚é–“æ®µçš„éµå€¼ï¼Œä¾‹å¦‚ 01:00 ~ 01:59 çš„éµå€¼éƒ½æ˜¯ &lt;code>01&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">expiryMs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">expiry&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>å¢åŠ  key ä¸¦æ›´æ–° ttl æ™‚é–“ï¼Œincr æœƒå›å‚³ç•¶ä¸‹å¢åŠ å¾Œçš„å€¼ï¼Œè—‰æ­¤åˆ¤æ–·æ˜¯å¦è¶…éé™åˆ¶&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">multi&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">incr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rdskey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">pttl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rdskey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">exec&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å› ç‚ºæœ‰ ttlï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒ key çš„åˆªé™¤ï¼Œé€™å€‹æ–¹æ³•ç°¡å–®ç›´è¦ºå„²å­˜æˆæœ¬ä¹Ÿå¾ˆä½&lt;/p>
&lt;p>ç‚ºäº†åš´æ ¼é™åˆ¶&lt;code>ä»»æ„æ™‚é–“å€æ®µå…§çš„æœ€å¤§å­˜å–æ•¸é‡&lt;/code>ï¼Œåƒè€ƒä»¥ä¸‹æ–‡ç« æåŠå…©ç¨®åšæ³• &lt;a class="link" href="https://engineering.classdojo.com/blog/2015/02/06/rolling-rate-limiter/" target="_blank" rel="noopener"
>Better Rate Limiting With Redis Sorted Sets
&lt;/a>&lt;/p>
&lt;h3 id="token-bucket">token bucket&lt;/h3>
&lt;p>æ¯ä¸€å€‹ç”¨æˆ¶éƒ½æœ‰ä¸€å€‹å°æ‡‰çš„ bucketï¼Œåªæœ‰ token è¶³å¤ æ™‚å¯ä»¥é€²è¡Œæ“ä½œï¼Œæ¯éš”ä¸€æ®µæ™‚é–“æœƒå›è£œ token æ•¸é‡ï¼Œå¥½è™•æ˜¯å¯ä»¥åˆ¶å®šå¤šç¨®æ“ä½œçš„ token éœ€è¦æ•¸é‡ï¼Œåƒæ˜¯æ›´ç¹é›œçš„æ“ä½œéœ€è¦æ¶ˆè€—æ›´å¤šçš„ token ï¼Œæ›´æœ‰å½ˆæ€§æ‡‰å°ä¸åŒçš„é™åˆ¶æ–¹æ¡ˆ&lt;/p>
&lt;p>è³‡æ–™çµæ§‹ä½¿ç”¨ Redis çš„ &lt;code>Hash&lt;/code>ï¼Œæ¼”ç®—æ³•å¤§è‡´å¦‚ä¸‹&lt;/p>
&lt;ol>
&lt;li>ç”¨æˆ¶è¦æ“ä½œçš„æ™‚å€™ï¼Œå¦‚æœæ­¤æ™‚æ²’æœ‰ç´€éŒ„ï¼Œå…ˆæ’å…¥ä¸€ç­† Hash &lt;code>user: ç•¶ä¸‹ çš„ timestamp =&amp;gt; token åˆå§‹åŒ–æ•¸é‡&lt;/code>&lt;/li>
&lt;li>å¾ŒçºŒæ“ä½œæ™‚ï¼Œå–å‡ºä¸Šä¸€æ¬¡æ“ä½œçš„ timestampï¼Œæ¥è‘—å›è£œé€™ä¸€æ®µæ™‚é–“éœ€è¦è£œå……çš„ Token æ•¸é‡&lt;/li>
&lt;li>æ¥è‘—æ‰£é™¤æ“ä½œæ‰€éœ€çš„ Token æ•¸ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç¬¦åˆé™åˆ¶&lt;/li>
&lt;/ol>
&lt;p>éœ€æ³¨æ„é€™ç¨®åšæ³•æœƒæœ‰ &lt;code>Race Condition&lt;/code> å•é¡Œï¼Œå¦‚æœä¸€å€‹ç”¨æˆ¶åŒæ™‚æœ‰å…©å€‹æ“ä½œï¼Œåœ¨ç¬¬ä¸‰æ­¥é©Ÿæª¢æŸ¥æ™‚ï¼Œæœƒèª¤ä»¥ç‚ºè‡ªå·±éƒ½æœ‰è¶³å¤ çš„ tokenï¼Œé™¤éä½¿ç”¨ &lt;code>Lua script&lt;/code>ï¼ŒRedis æ‰æœƒå°‡&lt;code>å¤šå€‹æ“ä½œè¦–ç‚º atomic é¿å… Race Condition&lt;/code>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/BitMEX/node-redis-token-bucket-ratelimiter" target="_blank" rel="noopener"
>node-redis-token-bucket-ratelimiter&lt;/a> ä¾¿æ˜¯æ¡ç”¨ Lua script ä½œæ³•ï¼Œè®“æˆ‘å€‘ä¾†æ¬£è³ä¸€ä¸‹&lt;/p>
&lt;ol>
&lt;li>å–å¾—åƒæ•¸ï¼Œä¸¦æŒ‡å®š &lt;code>redis.replicate_commands()&lt;/code>ï¼Œé€™æ˜¯åœ¨èª¿ç”¨ &lt;code>$ redis eval&lt;/code> æ™‚è¦ç”¢ç”Ÿéš¨æ©Ÿ IO æ™‚éœ€è¦æå‰åŸ·è¡Œçš„æŒ‡ä»¤ &lt;a class="link" href="https://redis.io/commands/eval" target="_blank" rel="noopener"
>Redis - EVAL script numkeys key&lt;/a>ï¼Œé€™ä¸€ç¯‡æœ‰æ˜“æ‡‚çš„è§£é‡‹ &lt;a class="link" href="http://mysql.taobao.org/monthly/2019/01/06/" target="_blank" rel="noopener"
>Redis Â· å¼•æ“ç‰¹æ€§ Â· Luaè„šæœ¬æ–°å§¿åŠ¿&lt;/a>ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ç‚ºäº†ç¬¦åˆ Redis åœ¨æŒä¹…åŒ–ä»¥åŠå‰¯æœ¬è³‡æ–™æ™‚çš„åŠŸèƒ½ï¼Œåœ¨ 5.0 ä»¥å¾Œæ˜¯é»˜èªé¸é …ï¼› &lt;br>
æ¥è‘—å°±æ˜¯åˆ†åˆ¥è¨ˆç®—ä¸Šä¸€æ¬¡æ›´æ–°æ™‚é–“ &lt;code>initialUpdateMS&lt;/code> / æ®˜ç•™çš„ token æ•¸ &lt;code>prevTokens&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- valueKey timestampKey | limit intervalMS nowMS [amount]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">valueKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">-- &amp;#34;limit:1:V&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">timestampKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">-- &amp;#34;limit:1:T&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">limit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tonumber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">intervalMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tonumber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">amount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tonumber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]),&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">force&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">lastUpdateMS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">prevTokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Use effects replication, not script replication;; this allows us to call &amp;#39;TIME&amp;#39; which is non-deterministic&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">redis.replicate_commands&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;TIME&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">nowMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.floor&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">initialTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;GET&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">valueKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">initialTokens&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- If we found no record, we temporarily rewind the clock to refill&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- via addTokens below&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">prevTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nowMS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">intervalMS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">prevTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">initialTokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;GET&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">timestampKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- this is a corruption&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- å¦‚æœè³‡æ–™æœ‰å•é¡Œï¼Œéœ€è¦å›æ¨ lastUpdateMS æ™‚é–“ï¼Œä¹Ÿå°±æ˜¯ç”¨ç¾åœ¨æ™‚é–“å›æ¨æ®˜å­˜ Token æ•¸é‡çš„å›è£œæ™‚é–“&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nowMS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">prevTokens&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastUpdateMS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">initialUpdateMS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>æ¥è‘—è¨ˆç®—ä¸Šä¸€æ¬¡åˆ°ç¾åœ¨éœ€è¦å›è£œçš„ Token &lt;code>addTokens&lt;/code> / é€™ä¸€æ¬¡é‹ç®—é…é¡å¤ ä¸å¤  &lt;code>netTokens&lt;/code> / å¦‚æœä¸‹ä¸€æ¬¡è¦å˜—è©¦éœ€è¦ç­‰å¤šä¹…çš„æ™‚é–“ &lt;code>retryDelta&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">addTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.max&lt;/span>&lt;span class="p">(((&lt;/span>&lt;span class="n">nowMS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">lastUpdateMS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- calculated token balance coming into this transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">grossTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prevTokens&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">addTokens&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- token balance after trying this transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">grossTokens&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- time to fill enough to retry this amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">retryDelta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">rejected&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">forced&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- we used more than we have&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">force&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">forced&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c1">-- drain the swamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rejected&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">grossTokens&lt;/span> &lt;span class="c1">-- rejection doesn&amp;#39;t eat tokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- == percentage of `intervalMS` required before you have `amount` tokens&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">retryDelta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.ceil&lt;/span>&lt;span class="p">(((&lt;/span>&lt;span class="n">amount&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">netTokens&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span> &lt;span class="c1">-- polite transaction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- nextNet == pretend we did this again...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">nextNet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">netTokens&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">nextNet&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- ...we would need to wait to repeat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- == percentage of `invervalMS` required before you would have `amount` tokens again&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">retryDelta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math.ceil&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">math.abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nextNet&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">limit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>å¦‚æœæˆåŠŸæ“ä½œ ( rejected == false )ï¼Œå‰‡å»¶é•· key çš„éæœŸæ™‚é–“&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">rejected&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PSETEX&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">valueKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">intervalMS&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">netTokens&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">addTokens&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">initialUpdateMS&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- we filled some tokens, so update our timestamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PSETEX&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">timestampKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">intervalMS&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">nowMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- we didn&amp;#39;t fill any tokens, so just renew the timestamp so it survives with the value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PEXPIRE&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">timestampKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">intervalMS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="sliding-time-window---æ»‘å‹•æ™‚é–“å€æ®µ">sliding time window - æ»‘å‹•æ™‚é–“å€æ®µ&lt;/h3>
&lt;p>æœ€å¾Œä¸€å€‹æ˜¯ä½¿ç”¨ sorted setï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>$ redis.multi&lt;/code> å°‡å¤šå€‹ sorted set çš„æŒ‡ä»¤ä¸²å†ä¸€èµ· Atomic åŸ·è¡Œæ‰€ä»¥èƒ½å¤ é¿å… Race Condition ç‹€æ³&lt;br>
å…·é«”æƒ³æ³•æ˜¯&lt;/p>
&lt;ol>
&lt;li>ç”¨ä¸€å€‹ sorted set å„²å­˜æ‰€æœ‰çš„ timestamp&lt;/li>
&lt;li>request é€²ä¾†å¾Œï¼Œå…ˆç”¨ &lt;code>ZREMRANGEBYSCORE&lt;/code> æ¨æ£„ time window ä»¥å¤–çš„ key&lt;/li>
&lt;li>å–å¾— sorted set å‰©é¤˜çš„æ‰€æœ‰å…ƒç´  &lt;code>ZRANGE(0, -1)&lt;/code>&lt;/li>
&lt;li>åŠ ä¸Šé€™ä¸€æ¬¡çš„æ“ä½œ &lt;code>ZADD&lt;/code>ï¼Œä¸¦å»¶é•· sorted set çš„ ttl&lt;/li>
&lt;li>æ¥è‘—ç®—æ•´å€‹ sorted set çš„å…ƒç´ é‡ï¼Œå°±çŸ¥é“å­˜å–å¹¾æ¬¡äº†&lt;/li>
&lt;/ol>
&lt;p>éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Œé€™é‚Šå¦‚æœç¬¬äº”æ­¥åˆ¤æ–·å¤±æ•—ä¹Ÿæœƒè¢«è¨ˆç®—åœ¨ limit ç•¶ä¸­ï¼Œå› ç‚ºç¬¬å››æ­¥å·²ç¶“å…ˆåŠ ä¸Šå»äº†ï¼Œå¦‚æœ&lt;code>åœ¨ç¬¬ä¸‰æ­¥å…ˆåˆ¤æ–·æ•¸é‡å¤ ä¸å¤ å†å»æ›´æ–° sorted setï¼Œä¸­é–“çš„æ™‚é–“å·®å°±æœ‰å¯èƒ½ç™¼ç”Ÿ Race Condition&lt;/code>ï¼Œæ‰€ä»¥è¦åš´æ ¼é™åˆ¶å¿…é ˆè¦é€™éº¼åšï¼Œé™¤éåˆè¦åŒ…æˆ lua script&lt;/p>
&lt;p>é€™æœƒå°è‡´ä¸€å€‹é¢¨éšªï¼Œå¦‚æœ Client çœŸçš„å¤±æ§ä¸€ç›´æ‰“ï¼Œé‚£ä»–æœƒç„¡æ­¢ç›¡çš„å¤±æ•—ï¼Œå› ç‚ºæ¯ä¸€æ¬¡çš„å¤±æ•—æ“ä½œéƒ½æœƒè¢«åŠ å…¥ sorted set ç•¶ä¸­ï¼Œä½†å…¶å¯¦éƒ½æ²’æœ‰çœŸçš„åŸ·è¡Œåˆ°&lt;/p>
&lt;p>æ¨¡çµ„è«‹åƒè€ƒ &lt;a class="link" href="https://github.com/peterkhayes/rolling-rate-limiter" target="_blank" rel="noopener"
>rolling-rate-limiter&lt;/a>ï¼Œç¨‹å¼ç¢¼åœ¨é€™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">batch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">multi&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">zremrangebyscore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">clearBefore&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">addNewTimestamp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">zadd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">uuid&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">zrange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;WITHSCORES&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">expire&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ttl&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reject&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exec&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">reject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åŠ å®Œå¾Œæ‰ä¾†è¨ˆç®—æ˜¯ä¸æ˜¯æ‰£æ‰“è¶³å¤ 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">zRangeOutput&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">addNewTimestamp&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="nx">as&lt;/span> &lt;span class="nb">Array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">unknown&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">zRangeResult&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getZRangeResult&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">zRangeOutput&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">timestamps&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">extractTimestampsFromZRangeResult&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">zRangeResult&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timestamps&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµè«–">çµè«–&lt;/h2>
&lt;p>Rate Limit çœ‹ä¼¼ç°¡å–®ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘çš„çœ‰è§’è¦å»è€ƒé‡ï¼Œä¹‹å‰ä¸€ç›´éƒ½æ²’æœ‰å®¢è£½ Redis ä¸­ lua script çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯è »æœ‰è¶£çš„&lt;/p></description></item><item><title>å…¬è·¯è»Šæ–°æ‰‹ä¸Šè·¯-å…¥å‘ä¸€å€‹æœˆçš„å¿ƒå¾—</title><link>https://yuanchieh.page/posts/2020-10-08_%E5%85%AC%E8%B7%AF%E8%BB%8A%E6%96%B0%E6%89%8B%E4%B8%8A%E8%B7%AF-%E5%85%A5%E5%9D%91%E4%B8%80%E5%80%8B%E6%9C%88%E7%9A%84%E5%BF%83%E5%BE%97/</link><pubDate>Thu, 08 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020-10-08_%E5%85%AC%E8%B7%AF%E8%BB%8A%E6%96%B0%E6%89%8B%E4%B8%8A%E8%B7%AF-%E5%85%A5%E5%9D%91%E4%B8%80%E5%80%8B%E6%9C%88%E7%9A%84%E5%BF%83%E5%BE%97/</guid><description>&lt;p>å¹³æ™‚å–œæ­¡é‹å‹•ï¼Œæ›¾åƒåŠ éé¾èˆŸã€è·‘éå…¨é¦¬/åŠé¦¬ï¼Œç¶­æŒä¸€é€±è‡³å°‘ä¸‰æ¬¡æ¯æ¬¡ä¸€å°æ™‚çš„é‹å‹•ç¿’æ…£ï¼Œåœ¨åŒäº‹çš„æ¨å‘ä¸‹ï¼Œè©¦é¨äº†å¹¾æ¬¡å¾Œè¦ºå¾—é¨è»Šå¾ˆèˆ’é©ï¼Œåœ¨å°åŒ—è¿‘éƒŠæœ‰å¾ˆå¤šä¸éŒ¯çš„å±±è·¯ï¼Œä¹Ÿæœ‰æ²³æ¿±å¯ä»¥èˆ’é©çš„é¨ä¹˜&lt;/p>
&lt;p>åˆ†äº«å¹¾å€‹ç•¶åˆé¸è»Šçš„æƒ³æ³•ï¼ŒåŒ…å«é ç®—ç­‰ç­‰è€ƒé‡ï¼Œä»¥åŠå…¥å‘ä¸€å€‹æœˆå¾Œçš„ä¸€äº›å¿ƒå¾—èˆ‡é¿é›·å»ºè­°&lt;br>
æ–°æ‰‹åˆ†äº«ï¼Œå¦‚æœ‰éŒ¯èª¤æ­¡è¿ç³¾æ­£ ğŸ™&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20201008/bike.jpg"
loading="lazy"
>&lt;br>
ç‰½è»Šå¾Œä¸€é€±ç¬¬ä¸€æ¬¡ä¸Šé¢¨æ«ƒå˜´&lt;/p>
&lt;p>*æ›´æ–°: åœ¨ 2020/11 å®Œè³½ç’°èŠ±æ±ï¼Œæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒçœ‹çœ‹ &lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-11-30-%E4%B8%80%E4%BA%BA%E5%82%99%E6%88%B0%E7%92%B0%E8%8A%B1%E6%9D%B1365%E6%8C%91%E6%88%B0%E8%B3%BD-%E5%82%99%E8%B3%BD%E6%AF%94%E8%B3%BD%E9%81%8E%E7%A8%8B%E5%88%86%E4%BA%AB/" target="_blank" rel="noopener"
>ä¸€äººå‚™æˆ°ç’°èŠ±æ±365æŒ‘æˆ°è³½ - å‚™è³½ã€æ¯”è³½éç¨‹åˆ†äº«&lt;/a>ï¼Œå¸Œæœ›è®“é€™ç¯‡çœ‹èµ·ä¾†æ›´æœ‰å¯ä¿¡åº¦ (å’¦ ?!&lt;/p>
&lt;h2 id="è³¼è»Šå‰çš„è€ƒé‡">è³¼è»Šå‰çš„è€ƒé‡&lt;/h2>
&lt;p>å› ç‚ºç•¢ç«Ÿæ˜¯å‰›å…¥å‘ï¼Œé ç®—ä¸€é–‹å§‹æ˜¯æŠ“å…©è¬ï¼Œé€™å…¶å¯¦é‚„è »ä½çš„ï¼Œåªèƒ½è²·å„å®¶å» ç‰Œçš„å…¥é–€è»Šæ¬¾ï¼Œå¦ç™½èªªé¸æ“‡ä¸å¤šï¼Œä½†æˆ‘è‡ªå·±è¦ºå¾—é€™å€‹åƒ¹æ ¼æ˜¯æˆ‘å¿ƒç†å¯ä»¥è² æ“”çš„ï¼Œå¦‚æœæ—¥å¾Œ~ä¸å¹¸~é¨å‡ºèˆˆè¶£ï¼Œè¦å†æ›ä¹Ÿé‚„æ˜¯å¯ä»¥çš„&lt;/p>
&lt;p>ä¸€èˆ¬è‡ªè¡Œè»Šé¡å‹æœ‰åˆ†æˆ &lt;code>å…¬è·¯è»Š&lt;/code>ã€&lt;code>ç™»å±±è»Š&lt;/code>ã€&lt;code>ä¸‰éµè»Š&lt;/code>ç­‰ç­‰ï¼Œå…¬è·¯è»ŠæŠŠæ‰‹éƒ¨åˆ†åˆæœ‰ &lt;code>å¹³æŠŠ&lt;/code> èˆ‡ &lt;code>å½æŠŠ&lt;/code>ï¼Œå¹³æŠŠç›¸å°åå§¿è¼ƒé«˜ï¼Œæ‰€ä»¥é•·é€”ç›¸å°æ¯”è¼ƒä¸æœƒç´¯ï¼Œä¸€é–‹å§‹è©¦é¨ä¹Ÿæ˜¯ç”¨å¹³æŠŠï¼›&lt;br>
&lt;code>å½æŠŠ&lt;/code> å°±æ˜¯ç›¸å°åå§¿è¼ƒè¶´ï¼ŒæŠŠæ‰‹æœ‰å¤šç¨®æ‰‹å‹¢å¯ä»¥è®Šæ›ï¼Œç›¸å°èº«é«”è² æ“”å°±æ¯”è¼ƒå¤§ä¸€äº›ï¼Œä½†å¹³å¸¸æœ‰é‹å‹•ã€é‡è¨“ç¿’æ…£æ‡‰è©²æ˜¯è »èƒ½é©æ‡‰&lt;/p>
&lt;p>è »å»ºè­°è³¼è»Šå‰å…ˆå»è·Ÿæœ‹å‹å€Ÿé¨çœ‹çœ‹ï¼Œç•¶åˆä¹Ÿæ˜¯æ„Ÿè¬åŒäº‹é ˜é¨äº†ä¸‰å››æ¬¡ï¼Œç¢ºèªå–œæ­¡é¨ä¹˜åœ¨å…¥æ‰‹æœƒæ¯”è¼ƒå¥½&lt;/p>
&lt;h2 id="è³¼è»Šè©•ä¼°">è³¼è»Šè©•ä¼°&lt;/h2>
&lt;p>å› ç‚ºé ç®—æŠ“åœ¨å…©è¬ï¼ŒåŸºæœ¬ä¸Šåªèƒ½é¸é‹åˆé‡‘çš„è»Šï¼Œè»Šæ¬¾ä¹Ÿæ²’å¤ªå¤šå¯ä»¥æŒ‘çš„ï¼Œå°æ–¼æ–°æ‰‹å…¥å‘ä¼¼ä¹ä¹Ÿæ˜¯å¥½äº‹ï¼Œä¸ç„¶æœ‰é¸æ“‡éšœç¤™ XD&lt;br>
ç©¶ç«Ÿè¦ä¸è¦ç›´ä¸Šç¢³çº–ä¹Ÿèªªä¸æº–ï¼Œé¨å±±è·¯è»Šé‡æ‡‰è©²å½±éŸ¿è »å¤šï¼Œä½†æˆ‘é¨é‹è»Šé‚„æ˜¯èƒ½ä¸Šé¢¨æ«ƒå˜´ã€å†·æ°´å‘ï¼Œé¨ç’°èŠ±æ±ä¹Ÿä¸è¼¸ç¢³çº–çš„è»Š (æ’åéƒ½åœ¨å‰ 50%)ï¼Œé™¤éæ˜¯å¿—åœ¨åƒåŠ  KOM&lt;/p>
&lt;blockquote>
&lt;p>å¾Œä¾†æœ‰å¹¸é¨åˆ°æœ‹å‹ç ´åè¬çš„ç¢³çº–è»Šï¼Œä¸€é¨ä¸Šå»å°±ç™¼ç¾ã€Œå“‡ï¼ä¹Ÿå¤ªå¥½é¨äº†å§ã€é¨èµ·ä¾†æ›´çµå¯¦ã€åŠ›é‡æ›´ç›´æ¥å‚³è¼¸å‡ºå»çš„æ„Ÿè¦ºï¼Œå³ä½¿é¨å¹³è·¯æ„Ÿå—ä¹Ÿå®Œå…¨ä¸åŒï¼Œæ‰€ä»¥é ç®—å¤ ç›´ä¸Šä¹Ÿç„¡ä»¿ XD&lt;br>
ä½†ç¢³çº–ä¸€ç´šè»Šæ¶è·ŸäºŒç´šè»Šæ¶çš„å·®è·æ²’æœ‰æ„Ÿå—éä¹Ÿé‚„ä¸çŸ¥é“&lt;/p>
&lt;/blockquote>
&lt;h3 id="è»Šå­æœ¬é«”">è»Šå­æœ¬é«”&lt;/h3>
&lt;p>å…¬è·¯è»ŠåŸºæœ¬ä¸Šè¶Šè¼•è¶Šè²´ï¼Œå…¥é–€åƒ¹å¤§ç´„éƒ½å¾ 1ã€2 è¬é–‹å§‹ï¼Œé€™æ™‚å€™é€šå¸¸éƒ½æ˜¯è²·&lt;code>æˆè»Š&lt;/code>ï¼Œå» ç‰Œçˆ¬äº†æ–‡å¤§æ¦‚å°±æ˜¯ Giant / Performer / KHS / Fuji / Merida ç­‰ï¼Œä¹‹å‰åªæœ‰è½éæ·å®‰ç‰¹çš„å¤§åï¼Œå¾Œä¾†è€ƒé‡äº†ä¸€ä¸‹æ±ºå®šè²· &lt;code>Performer çš„ Storm Dark&lt;/code>&lt;br>
ä¸»è¦æ˜¯è½åº—å“¡ä»‹ç´¹èªªï¼Œä¸€èˆ¬å…¥é–€è»Šæ¬¾å„å¤§å» å·®ç•°ä¸å¤§ï¼Œå°±æ˜¯çœ‹è»Šå‹ã€å“ç‰Œåå¥½ã€é¡è‰²ç­‰ç­‰çš„é¸æ“‡ï¼Œç•¶åˆæœ€å¸å¼•æˆ‘çš„æ˜¯ &lt;code>Performer&lt;/code> æœ‰æä¾›å·¥å» å®¢è£½åŒ–çƒ¤æ¼†ï¼Œè¦ºå¾—å¤šèŠ±ä¸€é»éŒ¢çƒ¤æˆè‡ªå·±å–œæ­¡çš„é…è‰²å¾ˆä¸éŒ¯&lt;br>
ä½†å¾Œä¾†æ²’æœ‰çƒ¤æ¼†ï¼Œå› ç‚ºç–«æƒ…é—œä¿‚è…³è¸è»Šè¨‚å–®æš´å¢ï¼Œè¦æ’çƒ¤æ¼†éœ€è¦å¾ˆä¹…ï¼Œå¾Œä¾†æƒ³èªªç­‰ä¹‹å¾Œæœ‰æ©Ÿæœƒå†èªª&lt;/p>
&lt;p>é€™é‚Šæ¨è–¦ä¸€ä¸‹è³¼è²·çš„è»Šåº—&lt;code>å°å“²å±…å–®è»Š&lt;/code>ï¼Œè³¼è²·å¾Œæœ‰å¹«å¿™èª¿æ•´åé«˜ã€æŠŠæ‰‹ç­‰ç­‰åŸºæœ¬çš„ Fittingï¼Œå»ºè­°ç¬¬ä¸€æ¬¡è²·é‚„æ˜¯å»å¯¦é«”åº—é¢ï¼Œè«‹åº—å®¶å¹«å¿™æŠ“è»Šæ¶å¤§å°ç­‰ç­‰ï¼Œé€™é–“æœå‹™é‚„ä¸éŒ¯æ¨è–¦çµ¦å¤§å®¶&lt;/p>
&lt;p>å¾Œä¾†åœ¨ç¶²è·¯ä¸Šçœ‹åˆ°å°ˆæ¥­ Fitting å¸«&lt;a class="link" href="https://www.youtube.com/channel/UCXwoA5XyVqQe5JDGea7cnMA" target="_blank" rel="noopener"
>èˆ’è¿·èªª&lt;/a>çš„åˆ†äº«ï¼Œä¹Ÿè »æ¨è–¦å¤§å®¶å¯ä»¥æ”¶çœ‹é€™å€‹é »é“ï¼Œå¯ä»¥å­¸ç¿’åˆ°å¾ˆå¤šé—œæ–¼è‡ªè¡Œè»Šä»¥åŠå¦‚ä½•é¨ä¹˜ç­‰çŸ¥è­˜&lt;/p>
&lt;h3 id="è®Šé€Ÿç³»çµ±">è®Šé€Ÿç³»çµ±&lt;/h3>
&lt;p>è®Šé€Ÿç³»çµ±è¦æ ¼å¯ä»¥é¸æ“‡ï¼Œé€šå¸¸æ­é…çš„å» å•†æ˜¯æ—¥å•† Shimanoï¼Œä»–å€‘å®¶çš„è®Šé€Ÿå™¨æœ‰åˆ†å¹¾å€‹ Levelï¼Œæˆ‘é¸æ“‡æ˜¯ &lt;code>SORA&lt;/code>ï¼Œåº—å“¡æ˜¯èªªå…¥é–€å»ºè­°å°±å¾é€™æ¬¾é–‹å§‹ï¼Œæ›´ä½éšå°±ä¸æ¨ï¼Œè‡³æ–¼æ›´é«˜éšçš„ 105 / Ultegra ç­‰é‚„æ²’æœ‰å˜—è©¦éï¼Œç¨å¾®è©¢å•ä¸€ä¸‹ç­‰ç´šå·®ç•°ï¼Œä¸»è¦åœ¨æ–¼&lt;code>è®Šé€Ÿæ‰‹æ„Ÿã€ç²¾æº–åº¦èˆ‡é€Ÿåº¦&lt;/code>çš„å·®ç•°ï¼›&lt;br>
ä½éšçš„åŸºæœ¬ä¸Šéƒ½æ˜¯æ©Ÿæ¢°è®Šé€Ÿï¼Œé‚„æœ‰æ›´è²´çš„é›»å­è®Šé€Ÿï¼Œåƒ¹æ ¼éƒ½è¦å¥½å¹¾è¬&lt;/p>
&lt;h3 id="å¤§é½’ç›¤èˆ‡é£›è¼ª">å¤§é½’ç›¤èˆ‡é£›è¼ª&lt;/h3>
&lt;p>è‡ªè¡Œè»Šçš„å‚³å‹•ç³»çµ±ï¼Œå‰æ–¹æ˜¯å¤§é½’ç›¤ï¼Œå¾Œæ–¹æ˜¯é£›è¼ªï¼Œå¤§é½’ç›¤é€šå¸¸æ˜¯å…©ç›¤: å¤§ç›¤åŠ å°ç›¤ï¼Œå¾Œæ–¹é£›è¼ªå‰‡æ˜¯ç®—æœ€å°é½’åˆ°æœ€å¤§é½’&lt;br>
&lt;code>é½’è¼ªæ¯”&lt;/code>æœƒå½±éŸ¿é¨ä¹˜æ™‚è¸©è¸çš„åŠ›é“ï¼Œé½’è¼ªæ¯”é«˜å°±è²»åŠ›ï¼Œé©åˆä¸‹å¡è·Ÿå¹³è·¯ï¼Œåä¹‹å‰‡ä¸Šå¡æ¯”è¼ƒè¼•é¬†ï¼Œçœ‹ä¸€äº›æ–‡ç« æœ‰æåˆ°é½’è¼ªæ¯”å°æ–¼é¨ä¹˜å½±éŸ¿å¾ˆå¤§ï¼Œç†æƒ³æ˜¯è…³è¸©è¸çš„è¼¸å‡ºåŠŸç‡ç©©å®šï¼Œä¹Ÿå°±æ˜¯åŠ›é“èˆ‡é »ç‡å›ºå®šï¼Œé€éè®Šé€Ÿä¾†é©æ‡‰åœ°å½¢çš„è®ŠåŒ–&lt;/p>
&lt;p>æˆ‘å¾Œä¾†é£›è¼ªé¸æ“‡ 11T~34Tï¼Œä¸»è¦æ˜¯é æœŸæœƒå¾ˆå¸¸çˆ¬å¡ï¼Œ34T çˆ¬å¡è¸©èµ·ä¾†å°±å¾ˆè¼•&lt;/p>
&lt;h3 id="å¡é‹">å¡é‹&lt;/h3>
&lt;p>å¦ä¸€å€‹åœ¨è€ƒæ…®çš„æ˜¯&lt;code>å¡é‹&lt;/code>ï¼Œä¸Šå¡åŸºæœ¬ä¸Šè¦ä¸‰åƒèµ·è·³ï¼Œè½æœ‹å‹èªªé€™æœƒå½±éŸ¿ç™¼åŠ›çš„æ–¹å¼ï¼Œå› ç‚ºè…³èˆ‡è¸æ¿åˆé«”ï¼Œæ‰€ä»¥å¾€å›æ‹‰å¤§è…¿è‚Œä¹Ÿæœƒå‡ºåŠ›ï¼Œè€Œä¸åƒä¸€èˆ¬é¨ä¹˜åªæœ‰ä¸‹è¸©çš„æ™‚å€™èƒ½å‡ºåŠ›&lt;br>
é™¤äº†åƒ¹æ ¼å¤–ï¼Œç©¿ä¸Šå¡é‹å±éšªæ€§æœƒé«˜ä¸€äº›ï¼Œå¯èƒ½è‡¨æ™‚è¦åœè»Šä½†è„±å¡ä¸é †å°±æœƒæ‘”è»Šï¼Œè€ƒé‡å¾Œæ±ºå®šå…ˆä¸€èˆ¬é¨ä¹˜å°±å¥½ï¼ŒæŠŠè‚ŒåŠ›ç·´èµ·ä¾†ä¹‹å¾Œå†èªª&lt;/p>
&lt;h3 id="é…ä»¶">é…ä»¶&lt;/h3>
&lt;p>å…¶ä»–é…ä»¶éƒ¨åˆ†ï¼Œæ¨è–¦å¹¾å€‹å¥½æ±è¥¿è¦æº–å‚™&lt;/p>
&lt;ol>
&lt;li>æ‰‹é›»ç­’ / å¾Œæ–¹è­¦ç¤ºç‡ˆ:&lt;br>
é€™æ˜¯&lt;code>ä¸Šè·¯å¿…å‚™è£å‚™&lt;/code>ï¼Œå¦å‰‡æœƒæœ‰è¡Œè»Šå®‰å…¨èˆ‡æ³•è¦å•é¡Œå–”! æ™šä¸Š/è¦–ç·šä¸å¥½ä¸€å®šè¦é–‹ç‡ˆ&lt;/li>
&lt;li>æ‰‹æ©Ÿæ¶:&lt;br>
æ¶åœ¨é¾é ­ä¸Šæ–¹ä¾¿å°èˆªï¼Œä½†å¦‚æœå¸Œæœ›é¨å±±è·¯æˆ–é•·æ™‚é–“(è¶…éå…©å°æ™‚)ï¼Œå»ºè­°è²·è»ŠéŒ¶&lt;/li>
&lt;li>æ°´å£ºæ¶:&lt;br>
é€šå¸¸èƒ½å¤ åœ¨è»Šæ¶ä¸Šè£å…©å€‹ï¼Œå»ºè­°å…©å€‹éƒ½è£ï¼Œä¸€å€‹æ”¾æ°´å£ºï¼Œä¸€å€‹æ”¾ç¶­ä¿®ç½&lt;br>
ç¶­ä¿®ç½ç›®å‰å€‹äººæº–å‚™äº† CO2 é‹¼ç“¶ / å…§èƒ / æŒ–èƒæ£’ï¼Œä½†ç›®å‰é‚„æ²’ç”¨é&lt;/li>
&lt;li>è…³è¸è»ŠåŒ…:&lt;br>
å¼·çƒˆæ¨è–¦ï¼Œç¸½æ˜¯è¦æœ‰å€‹åœ°æ–¹æ”¾é›¨è¡£ã€éŒ¢åŒ…ã€é‘°åŒ™ç­‰é›œç‰©ï¼Œè²·ä¸€å€‹åæ–¹æ–¹ä¾¿ï¼›&lt;br>
å¦å¤–ä¸æ¨è–¦æ”¾åœ¨å‰æ–¹çš„å‰ç®¡è…³è¸è»ŠåŒ…ï¼Œç«™ç«‹æŠ½è»Šç­‰æœƒå½±éŸ¿é¨ä¹˜ï¼Œé™¤éæ˜¯æœ‰ç‰¹åˆ¥è¨­è¨ˆçš„è·Ÿå‰ç®¡å·®ä¸å¤šå¯¬åº¦ä¸å½±éŸ¿é¨ä¹˜ï¼Œå¦å‰‡è²·ç¶åœ¨åå¢Šä¸‹æ–¹çš„å€‹äººè¦ºå¾—ä¸éŒ¯&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šæˆ‘éƒ½åœ¨äº¤è»Šæ™‚ä¸€æ¬¡è«‹è‡ªè¡Œè»Šåº—çµ„è£ï¼Œé…ä»¶å¤§æ¦‚ä¹ŸèŠ±äº† 3000 å¤šï¼Œç¸½å…±èŠ±äº† &lt;code>2 è¬å‡ºé ­&lt;/code>åœ¨è»Šå­ä¸Šï¼Œä½†å‘ä¹‹æ‰€ä»¥ç‚ºå‘å°±æ˜¯ä»–æœƒæ¯”ä½ æƒ³åƒä¸­çš„æ·±&amp;hellip;.&lt;/p>
&lt;p>é™¤äº†ä¸Šè¿°è»Šç”¨å“å¤–ï¼Œé‚„æœ‰å¹¾é …äººèº«é…ä»¶&lt;/p>
&lt;ol>
&lt;li>å®‰å…¨å¸½:&lt;br>
åŸºæœ¬ä¸Šè·¯å¤§å®¶éƒ½æœƒå¸¶ï¼Œç•¢ç«Ÿå…¬è·¯è»Šæ™‚é€Ÿä¹Ÿæ˜¯è »å¿«ï¼Œæœ‰äº›å…¬è·¯æœ‰å…¬è»Šã€æ±½æ©Ÿè»Šæ··é›œï¼Œæ‰€ä»¥å®‰å…¨æ˜¯è »åŸºæœ¬çš„ï¼Œæˆ‘æ˜¯åœ¨è¿ªå¡å„‚è²·å€‹ç°¡ä¾¿çš„ 999 å…ƒå®‰å…¨å¸½&lt;/li>
&lt;li>è»Šè¡£è»Šè¤²:&lt;br>
å› ç‚ºåå¢Šå…¶å¯¦è »ç¡¬çš„ï¼Œè¦èˆ’é©çš„é•·æ™‚é–“é¨ä¹˜ (ä¸€å°æ™‚ä»¥ä¸Š)ï¼Œå»ºè­°è²·å€‹è»Šè¤²ï¼Œ&lt;del>æˆ‘åœ¨è¦çš®è²·ä¸€ä»¶ç´„ 500ï¼Œé‚„ç®—å¯ä»¥&lt;/del>ï¼Œå¾Œä¾†ç™¼ç¾é‚„æ˜¯è¦è²·å¥½ä¸€é»çš„ï¼Œä¸ç„¶èƒ¯ä¸‹è·Ÿå¤§è…¿é¨å€‹ä¸€å°æ™‚å°±æœƒç™¼éº»ï¼Œå¾Œä¾†é¸è³¼ Monton å°ç£å“ç‰Œè¦ºå¾—ä¸éŒ¯ï¼Œç´„ $2000 ä¸Šä¸‹ï¼›&lt;br>
è»Šè¡£æˆ‘è¦ºå¾—çœ‹å€‹äººï¼Œç©¿ä¸€èˆ¬é‹å‹•è£ä¹Ÿæ˜¯å¯ä»¥ï¼Œåªæ˜¯è»Šè¡£éƒ½æœƒåœ¨èƒŒå¾Œè¨­è¨ˆå£è¢‹ï¼Œå¦‚æœè¦é¨æ¯”è³½é‚„æ˜¯è¦è²·è»Šè¡£æ¯”è¼ƒæ¨è–¦ï¼Œè£œçµ¦æ”¾å£è¢‹å¾ˆæ–¹ä¾¿&lt;/li>
&lt;li>è‡ªè¡Œè»Šæ¶:&lt;br>
ä¸€èˆ¬ä¸æœƒè£åœè»ŠæŸ±ï¼Œå› ç‚ºé‡é‡èˆ‡ç¾è§€è€ƒé‡ï¼Œå¹³å¸¸éƒ½æ˜¯æ–œé åœ¨ç‰†ä¸Šï¼Œä½†æ˜¯å¶çˆ¾è¦æ¸…ç†è»Šå­é‚„æ˜¯è¦è²·å€‹è»Šæ¶ï¼Œ&lt;code>æ¥µåº¦ä¸æ¨è–¦ä»¥ä¸‹é€™æ¬¾&lt;/code>ï¼Œé€™ç¨®é€šå¸¸ä¸€å…©ç™¾å…ƒå°±æœ‰ï¼Œä½†æ˜¯è¶…ç´šä¸ç©©å®š
&lt;img src="https://yuanchieh.page/post/img/20201008/bad.jpg"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;p>æˆ‘æ˜¯è‡ªå·±å¦å¤–æ›¿æ›èºçµ²æ‰å‹‰å¼·å‰›å¥½ï¼Œä¸ç„¶ç¬¬ä¸€æ¬¡æ´—è»Šä¸€ç›´æ»‘è½è¶…ç´šä¸çˆ½&lt;br>
4. æ¸…æ½”ç”¨å“&lt;br>
éˆæ¢ç‚ºäº†è¦ç¶­æŒæ»‘é †çš„é‹ä½œï¼Œéœ€è¦ä¸ŠéŠæ¢æ²¹ï¼Œä½†æ˜¯è·¯é¢çš„ç°å¡µã€å°çŸ³å­æœƒè¢«æ²¹æ²¾é»ï¼Œæ‰€ä»¥ä¹…äº†å°±æœƒé»‘é»‘çš„ï¼Œéœ€è¦å»æ²¹æ¸…æ½”å¾Œå¾Œé‡æ–°ä¸Šæ²¹ï¼Œæ‰€ä»¥éœ€è¦&lt;code>å»æ²¹æ±¡æ¸…æ½”åŠ‘&lt;/code>ä»¥åŠ&lt;code>éŠæ¢æ²¹&lt;/code>ï¼Œé€šå¸¸é¨ä¹˜å¾Œå°±è¦ç¨å¾®æ¸…æ½”è·Ÿä¿é¤Šï¼Œè‡³å°‘æ·‹åˆ°é›¨ä¸€å®šè¦ä¿é¤Š&lt;br>
æˆ‘è‡ªå·±æ˜¯ç”¨å»¢æ£„ç‰™åˆ·è·Ÿå»šæˆ¿çš„é›™è‰²æ´—ç¢—åˆ·æ¸…æ½”ï¼Œä¸ŠéŠæ¢æ²¹å¾Œç”¨å»šæˆ¿é¤å·¾ç´™è¼•è¼•çš„æŠŠå¤šé¤˜çš„æ²¹æ“¦æ‰é¿å…æ²¾æŸ“ç°å¡µ&lt;br>
5. æ‰“æ°£ç­’&lt;br>
æ¯æ¬¡å‡ºç™¼å‰éƒ½è¦æª¢æŸ¥èƒå£“ï¼Œæˆ‘åŸºæœ¬ä¸Šéƒ½æœƒæ‰“åˆ° 110 psiï¼Œè²·äº†ä¸€å€‹æ·å®‰ç‰¹çš„æ‰“æ°£ç­’ CONTROL TOWER 1+ 1000å…ƒé‚„è »å¥½ç”¨ï¼Œä½†æ„Ÿè¦ºå¯ä»¥ä¸ç”¨è²·åˆ°é€™éº¼è²´ï¼Œç•¶åˆä¸å°å¿ƒæ‰‹æ»‘&amp;hellip;&lt;/p>
&lt;p>ä»¥ä¸Šå¤§æ¦‚åˆèŠ±äº† 5000å…ƒ&lt;/p>
&lt;h3 id="ç›®å‰ç¸½åƒ¹">ç›®å‰ç¸½åƒ¹&lt;/h3>
&lt;p>é‚„æœ‰ä¸€äº›é›¶é›¶ç¸½ç¸½å…± &lt;del>27000&lt;/del> 30000 å…ƒï¼Œé‚„æœ‰ä¸€äº›å•†å“æ˜¯è§€æœ›ä¸­ï¼Œåˆ—å‡ºä¾†åƒ…ä¾›åƒè€ƒ&lt;/p>
&lt;h3 id="è»ŠéŒ¶èˆ‡ç›£æ§è¨­å‚™">è»ŠéŒ¶èˆ‡ç›£æ§è¨­å‚™&lt;/h3>
&lt;p>å¦‚æœå¸Œæœ›é¨çš„æ›´å°ˆæ¥­ï¼Œå°±éœ€è¦æ›´å°ˆæ¥­çš„è¨­å‚™å»ç›£æ§æ¯æ¬¡é¨ä¹˜çš„æ•ˆæœï¼Œæœƒæœ‰å¾ˆå¤šçš„æ„Ÿæ¸¬å™¨å»ç›£æ¸¬&lt;code>è¸é »&lt;/code>ã€&lt;code>é€Ÿç‡&lt;/code>ã€&lt;code>å¿ƒç‡&lt;/code>ã€&lt;code>åŠŸç‡&lt;/code>ï¼Œä»¥ä¸Šè·Ÿé¨ä¹˜è¡¨ç¾æœ‰å¾ˆç›´æ¥ç›¸é—œ&lt;/p>
&lt;p>å¦‚åŒè·‘æ­¥å¤§å®¶éƒ½æœƒå•å€™ä½ çš„åˆ†é€Ÿã€Œè·‘ä¸€å…¬é‡Œéœ€è¦å¹¾åˆ†é˜ã€ï¼Œè…³è¸è»Šè«‡çš„æ˜¯&lt;code>ã€ŒåŠŸç‡ã€&lt;/code>ï¼Œä¸€å°æ™‚èƒ½å¤ è¼¸å‡ºå¹¾ç„¦è€³çš„èƒ½é‡ï¼Œæ‰€ä»¥éœ€è¦&lt;code>åŠŸç‡è¨ˆ&lt;/code>å»è§€æ¸¬è…³è¼¸å‡ºçš„åŠ›é‡ï¼Œä½†åŠŸç‡è¨ˆéå¸¸è²´ï¼Œéƒ½è¦ä¸€å…©è¬èµ·è·³ï¼Œæ–°æ‰‹å…¥é–€æˆ‘å°±å…ˆä¸è€ƒæ…®äº†&amp;hellip;&lt;/p>
&lt;p>å¯ä»¥åƒè€ƒä»¥ä¸‹å½±ç‰‡å°æ–¼åŠŸç‡çš„åˆ†ç´šï¼Œå¾ˆæœ‰è¶£&lt;br>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/e_CyVRSfGic"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;/p>
&lt;p>ç¬¬äºŒå€‹æ˜¯&lt;code>å¿ƒç‡&lt;/code>ï¼Œå› ç‚ºè‡ªè¡Œè»Šé€šå¸¸ä¹Ÿæ˜¯èµ°é•·é€”è€åŠ›è³½ï¼Œæ‰€ä»¥è¦ç¶­æŒåœ¨ä¸€å®šçš„å¿ƒç‡å¼·åº¦è¨“ç·´ï¼Œå¯ä»¥è§€å¯Ÿè‡ªå·±æ˜¯å¦å¤ªå¿«æˆ–å¤ªæ…¢ï¼Œå°±è·Ÿè·‘æ­¥è§€æ¸¬çš„æŒ‡æ¨™ä¸€æ¨£&lt;br>
å¯ä»¥è²·å°ˆæ¥­çš„å¿ƒç‡å¸¶ï¼Œæˆ–æ˜¯æœ‰æ‰‹éŒ¶ï¼Œä½†å› ç‚ºåƒ¹æ ¼è€ƒé‡ä¸€æ¨£å…ˆç•¥é&lt;/p>
&lt;p>æœ€å¾Œå°±æ˜¯&lt;code>é€Ÿç‡èˆ‡è¸é »&lt;/code>ï¼Œæˆ‘é¸æ“‡å…ˆè²·ä¸€å€‹&lt;code>è¸é »æ„Ÿæ¸¬å™¨&lt;/code>ï¼Œæˆ‘é¸æ“‡ Bryton è¸é »æ„Ÿæ¸¬å™¨ç´„ 800 å…ƒï¼Œä¸»è¦è€ƒé‡æ˜¯è¸é »æ˜¯æœ€åŸºæœ¬çš„æŒ‡æ¨™ï¼Œçœ‹äº†ä¸€äº›æ•™å­¸å½±ç‰‡éƒ½æ¨è–¦æ–°æ‰‹å…ˆè¨“ç·´è¸é »ç©©å®šåº¦é–‹å§‹ï¼Œè€Œä¸”&lt;code>è¸é »å¤ªä½æœƒå‚·è†è“‹&lt;/code>ï¼Œç›®å‰æ˜¯æŠ“å¹³è·¯ 90~100ï¼Œä¸Šå¡è‡³å°‘ 65~70ï¼Œå¯ä»¥ç”¨æ‰‹æ©Ÿæ­é… Appï¼ŒiOS æˆ‘ç”¨ ã€ŒALA Cyclingã€ï¼Œå…è²» App é‚„ç®—å·®å¼·äººæ„&lt;/p>
&lt;p>å¾Œä¾†å¥³å‹è²¼å¿ƒçš„è²·äº† Bryton 320 ï¼Œæœ‰è»Šæ©ŸçœŸçš„æ–¹ä¾¿å¾ˆå¤šï¼ŒBryton å…¥é–€ä½¿ç”¨é‚„ç®—ä¸éŒ¯ï¼Œæ­é…è¸é » / å¿ƒç‡å¸¶æœ‰æ•¸æ“šå¯ä»¥ç›£æ§è‡ªå·±é‹å‹•çš„ç‹€æ³å¾ˆä¸éŒ¯ï¼Œçµ‚æ–¼å¯ä»¥è®“æ‰‹æ©Ÿé€€å½¹ï¼Œå¯ä»¥çš„è©±å»ºè­°æ­é…ï¼Œè¦è¨“ç·´åŸºæœ¬ä¸Šå°±æ˜¯å¿…å‚™ï¼›&lt;br>
é«˜éšè»ŠéŒ¶æœƒæ­é…å…¨å½©è¢å¹•èˆ‡ GPS å°èˆªåŠŸèƒ½ï¼Œæˆ‘å€‹äººä¸Šè·¯æ˜¯éƒ½ä¸å¤ªçœ‹å°èˆªï¼Œé ‚å¤šæ‰‹æ©Ÿç¨å¾®æŸ¥ä¸€ä¸‹ï¼Œè¦ºå¾—å°èˆªåŠŸèƒ½æ€§å¥½åƒæ™®æ™®ï¼Œå¦‚æœé¨å›ºå®šè·¯ç·šå±…å¤šå»ºè­°å¯ä»¥ä¸ç”¨å…ˆè€ƒæ…® GPS åŠŸèƒ½&lt;/p>
&lt;h3 id="å…¶é¤˜é›œä¸ƒé›œå…«çš„æ¨è–¦">å…¶é¤˜é›œä¸ƒé›œå…«çš„æ¨è–¦&lt;/h3>
&lt;h4 id="æ°´ç®¡">æ°´ç®¡&lt;/h4>
&lt;p>å…ˆæ¨è–¦ä¸€äº› Youtube é »é“&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://www.youtube.com/channel/UC5Vv4D8t9Tjwh1chA9QeJcA" target="_blank" rel="noopener"
>å¯åˆ©ä¹&lt;/a>ï¼Œæˆ‘æœ€å–œæ­¡çš„é »é“ï¼Œå¤§å”çš„è²éŸ³å¾ˆæœ‰ç£æ€§ XD æ˜¯è‡ªè¡Œè»Šåº—è€é—†èˆ‡æ„›å¥½è€…ï¼Œçœ‹èµ·ä¾†æœ‰åœ¨åœ‹å¤–ç”Ÿæ´»ï¼Œä»‹ç´¹çš„ç¯„åœå¾ˆå»£ï¼Œå¾æ´—è»Šã€è»Šæ¬¾ä»‹ç´¹ã€è‡ªä¸»ç¶­ä¿®ã€æ–°å“ä»‹ç´¹ç­‰ç­‰æˆ‘éƒ½å¾ˆå–œæ­¡&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/channel/UCNyWKC0XwJnLQ0bmt-KbNfw" target="_blank" rel="noopener"
>è„†ç“œåŸä¸»&lt;/a>ï¼Œæœ‰ä¸€äº›è·¯ç·šæ¨è–¦ã€é€²éšçŸ¥è­˜çš„åˆ†äº«&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/user/asdfgh16884" target="_blank" rel="noopener"
>k2&lt;/a>ï¼Œä¸»è¦çœ‹ä¸€äº›çµ„è£ç­‰ç­‰ä»‹ç´¹ï¼Œè¦ºå¾—å½±ç‰‡å…§å®¹ã€ç¯€å¥éƒ½è »å–œæ­¡çš„&lt;/li>
&lt;li>&lt;a class="link" href="https://www.youtube.com/channel/UCQ-R3BQI5_3SxtmnDn8cGCA" target="_blank" rel="noopener"
>ä¸€è¼ªçš„é‹å‹•æ—¥å¸¸eLun_fitnessTW&lt;/a>ã€&lt;a class="link" href="https://www.youtube.com/channel/UCVXSO8rgWWroELnYB9UUEmA" target="_blank" rel="noopener"
>Linda Loves Cycling&lt;/a>ã€&lt;a class="link" href="https://www.youtube.com/channel/UCZuS7jBYdWKB9bjMZZv-s5w" target="_blank" rel="noopener"
>ä¼Šå¨ƒ Eva&lt;/a>ï¼Œçœ‹æ­£å¦¹çš„é »é“å°±æ˜¯å¾ˆæ£’ XD æœ‰å¾ˆå¤šçš„é¨è»Šç´€éŒ„ã€è‡ªè¡Œè»Šç”Ÿæ´»ç›¸é—œçš„åˆ†äº«ï¼Œå……æ»¿æ­£èƒ½é‡&lt;/li>
&lt;/ol>
&lt;h4 id="app">App&lt;/h4>
&lt;ol>
&lt;li>Strava: &lt;br>
ç¤¾ç¾¤+é‹å‹•ç´€éŒ„ï¼Œæ¯æ¬¡éƒ½å¯ä»¥è¨˜éŒ„è‡ªå·±çš„é¨ä¹˜ï¼Œé‚„å¹«ä½ åˆ‡è·¯æ®µæ¯”è¼ƒé€Ÿåº¦è¶…æœ‰è¶£çš„ï¼Œå¯ä»¥çœ‹åˆ°è‡ªå·±ä¸€æ¬¡æ¯”ä¸€æ¬¡é€²æ­¥å°±å¾ˆèˆ’å£“ï¼Œé€šå¸¸å„å¤§è»ŠéŒ¶ä¹Ÿéƒ½æ”¯æ´å°‡ç´€éŒ„å½™æ•´åˆ° Stravaï¼Œåƒ Bryton ä¹Ÿæœ‰æ”¯æ´&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201008/map.jpg"
loading="lazy"
>
è·¯ç·šç´€éŒ„
&lt;img src="https://yuanchieh.page/post/img/20201008/route.jpg"
loading="lazy"
>
è·¯æ®µè¨ˆæ™‚ï¼Œå¯èƒ½æ˜¯ç¿»è­¯å•é¡Œæ‰€ä»¥æœ‰çš„è·¯æ®µåç¨±å¾ˆæ€ªï¼Œæœ‰çš„æœ‰åœ¨åœ°åŒ–&lt;/li>
&lt;li>Velodash:&lt;br>
æ“šèªªæ˜¯å°ç£äººç¶“ç‡Ÿçš„ï¼Œç›¸å° Strava æœ‰æ›´å¤šåœ¨åœ°çš„å…ƒç´ ï¼Œå°¤å…¶æ˜¯è·¯ç·šæ¢ç´¢å¾ˆå¥½ç”¨ï¼Œç´€éŒ„é é¢æˆ‘å€‹äººä¹Ÿè¦ºå¾—æ¯” Strava å¥½çœ‹ï¼Œå¯æƒœæ²’è¾¦æ³•é€£çµè£å‚™&lt;/li>
&lt;li>ALA Cycling: ç‚ºäº†æŠŠæ‰‹æ©Ÿç•¶è»ŠéŒ¶ç”¨çš„ App&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20201008/record.jpg"
loading="lazy"
>&lt;/li>
&lt;/ol>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>é•·è·¯æ¼«æ¼«ï¼Œæœ€è¿‘é¨çš„é‚„ç®—è »æœ‰èˆˆè¶£ï¼Œå¸Œæœ›èƒ½å¤ ç¨å¾®å¹«åŠ©åˆ°å‰›æº–å‚™å…¥å‘çš„äºº&lt;br>
å¹³å¸¸è »å–œæ­¡é¨ç’°å°å°åŒ—ã€æ²³æ¿±ã€é¢¨æ«ƒå˜´&lt;/p></description></item><item><title>é…çœ¼é¡æ¨è–¦ - éˆé­‚ä¹‹çª—èˆ‡å…‰æ˜åˆ†å­</title><link>https://yuanchieh.page/posts/2020/2020-10-04_-%E9%85%8D%E7%9C%BC%E9%8F%A1%E6%8E%A8%E8%96%A6-%E9%9D%88%E9%AD%82%E4%B9%8B%E7%AA%97%E8%88%87%E5%85%89%E6%98%8E%E5%88%86%E5%AD%90/</link><pubDate>Sun, 04 Oct 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-10-04_-%E9%85%8D%E7%9C%BC%E9%8F%A1%E6%8E%A8%E8%96%A6-%E9%9D%88%E9%AD%82%E4%B9%8B%E7%AA%97%E8%88%87%E5%85%89%E6%98%8E%E5%88%86%E5%AD%90/</guid><description>&lt;p>è¿‘æ—¥å› é…æˆ´å…©ä¸‰å¹´çš„çœ¼é¡ç£¨æéæ–¼åš´é‡ï¼ŒåŠ ä¸Šæˆ¶å¤–é‹å‹•éœ€æ±‚å¸Œæœ›æ­é…è‡ªå‹•è®Šè‰²é¡ç‰‡ï¼Œé™ä½ç´«å¤–ç·šå°æ–¼çœ¼ç›çš„å‚·å®³ï¼Œæ±ºå®šé ç®—æ‹‰é«˜ä¸€æ¬¡é…åˆ°å¥½ï¼›&lt;br>
åœ¨ç¶²è·¯ä¸ŠæŸ¥è©•åƒ¹ï¼Œçœ‹åˆ°æœ€å¾Œå°±æ˜¯é€™å…©é–“åœ¨çŒ¶è±« &lt;a class="link" href="https://wttsoul.com/" target="_blank" rel="noopener"
>&lt;strong>éˆé­‚ä¹‹çª—&lt;/strong>&lt;/a> vs &lt;a class="link" href="https://www.beoptic.com/" target="_blank" rel="noopener"
>&lt;strong>å…‰æ˜åˆ†å­&lt;/strong>&lt;/a>ï¼ŒPTT æ¿ä¸Šå¤§å¤šæ¨è–¦é©—å…‰å¾ˆå²å®³ï¼Œåƒ¹æ ¼ä¹Ÿå¾ˆå²å®³ï¼Œä½†æ²’æœ‰è¦ªèº«é«”é©—ä¹Ÿä¸å¤ªç¢ºå®šï¼Œå‰›å¥½å¥³å‹ä¹Ÿè¦æ›çœ¼é¡ï¼Œå°±æ±ºå®šä¸€äººä¸€é–“ä¾†æ¯”å°æœå‹™ï¼Œåˆ†åˆ¥æ˜¯é¸éˆé­‚ä¹‹çª—ä¸­å±±åº—å’Œå…‰æ˜åˆ†å­æ•¦å—åº—&lt;/p>
&lt;p>ä»¥ä¸‹ä¸å°ˆæ¥­å¿ƒå¾—ï¼Œåƒ…ä¾›åƒè€ƒ (æ‡‰è©²ä¸æœƒæœ‰äººæ‡·ç–‘æ˜¯æ¥­é…å§ XD&lt;/p>
&lt;p>TLDRï¼›&lt;br>
å…©é–“æœå‹™éƒ½å¾ˆè®šï¼Œéƒ½æœƒå¾ˆä»”ç´°é©—å…‰ï¼Œä¸¦ä»‹ç´¹æ¯ä¸€æ­¥é©Ÿçš„ç›®çš„è·Ÿæ„ç¾©ï¼Œä¹Ÿå°è‡ªå·±çš„çœ¼ç›æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼›&lt;br>
å€‹äººé«”é©—ä¸Šçš„å·®ç•°&lt;/p>
&lt;ol>
&lt;li>éˆé­‚ä¹‹çª—åƒ¹æ ¼å¸¶è¼ƒå¯¬ï¼Œé«˜è¦åˆ°ä½è¦éƒ½æœ‰ï¼›&lt;/li>
&lt;li>å…‰æ˜åˆ†å­æ•´é«”é«”é©—æ¯”è¼ƒé«˜ç´šï¼Œé©åˆå¾ˆè¬›ç©¶å“å‘³çš„äºº&lt;/li>
&lt;/ol>
&lt;p>å¯¦éš›æ­é…çš„çœ¼é¡åƒ¹æ ¼:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åº—å®¶&lt;/th>
&lt;th>é¡æ¶&lt;/th>
&lt;th>é¡ç‰‡&lt;/th>
&lt;th>ç¸½åƒ¹&lt;/th>
&lt;th>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>éˆé­‚ä¹‹çª—&lt;/td>
&lt;td>ä¸é½é‹¼å°ç£å“ç‰Œï¼ŒåŸåƒ¹ æ‰“6æŠ˜ 7000å¤š&lt;/td>
&lt;td>ä¾è¦–è·¯å…¨è¦–ç·š+æ›²ç‡1.6 ç´„ 7000å¤š&lt;/td>
&lt;td>ç¾é‡‘åƒ¹å¯å¤šæ‰“ 95æŠ˜ï¼Œç¸½å…±ç´„ &lt;code>14000&lt;/code> å…ƒ (æœŸé–“æ­é…æŒ¯èˆˆåˆ¸å¯ä»¥å¤šæŠ˜ 1000)&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å…‰æ˜åˆ†å­&lt;/td>
&lt;td>æ—¥æœ¬å“ç‰Œ Mr. gentlemanï¼Œæœ‰é»å¿˜è¨˜å·¥è—ã€æè³ªä¸Šæœ‰æ²’æœ‰ç‰¹æ®Šçœ‰è§’ï¼Œç´„ 14000&lt;/td>
&lt;td>ä»‹ç´¹åªæœ‰&lt;code>è”¡å¸&lt;/code>å‹éŒ„ï¼Œæ›²ç‡é¸ 1.67 çš„æ–°ä¸€ä»£éè†œ ï¼Œå› é–ƒå…‰éé‡æ‰€ä»¥éœ€è¦å®¢è£½åŒ–é¡ç‰‡ç´„ 9900&lt;/td>
&lt;td>&lt;code>23000&lt;/code> å·¦å³ï¼Œæ²’æœ‰ç‰¹æ®Šçš„æŠ˜æ‰£&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>é ç®—å¤ å°±åˆ°é€™å…©é–“é…é…çœ‹ï¼Œè·Ÿä¸€èˆ¬çš„çœ¼é¡è¡Œæœå‹™ã€å°ˆæ¥­åº¦çœŸçš„æ˜¯æœ‰å¾ˆå¤§çš„è½å·®&lt;/p>
&lt;h2 id="é©—å…‰">é©—å…‰&lt;/h2>
&lt;p>æœ¬äººé«”é©—çš„æ˜¯éˆé­‚ä¹‹çª—ï¼Œå…¨ç¨‹å¥³å‹é™ªåŒåœ¨æ—ï¼Œäº‹å¾Œæ¯”å°é©—å…‰æµç¨‹å…©é–“å¹¾ä¹ä¸€æ¨¡ä¸€æ¨£ï¼Œåªæœ‰é †åºä¸åŒ&lt;/p>
&lt;h3 id="è§’è†œç‹€æ³">è§’è†œç‹€æ³&lt;/h3>
&lt;p>ç”¨ä¸€å°æœ‰å¤šå€‹åœ“åœˆçµ„æˆçš„å„€å™¨å»æ‹æ”è§’è†œï¼Œæ“šé©—å…‰å¸«èªª&lt;code>äººçœ¼ 70% åº¦æ•¸ä¾†è‡ªè§’è†œï¼Œä¹Ÿå°±æ˜¯çœ¼ç›æœ€å¤–åœçš„ä¸€å±¤&lt;/code>ï¼Œå…ˆæ‹æ”è§’è†œæ˜¯ç‚ºäº†ç¢ºèªå¥åº·ç‹€æ…‹ï¼Œå¦‚æœæœ‰å—æé‡æ¸¬è¦–åŠ›ä¹Ÿä¸æº–ï¼Œä¹Ÿå°±æ²’æœ‰å¾ŒçºŒé©—å…‰çš„å¿…è¦&lt;/p>
&lt;p>é‡æ¸¬å‡ºä¾†æœƒæœ‰ç­‰é«˜ç·šåœ–ï¼Œé¡¯ç¤ºè§’è†œæ›²åº¦çš„ç‹€æ…‹ï¼Œå¦‚æœæ˜¯æœ‰é–ƒå…‰æœƒå‘ˆç¾å…«å­—å½¢&lt;/p>
&lt;p>é™¤äº†è§’è†œå¤–ï¼Œé‚„æœƒè§€å¯Ÿç³å­”å¤§å°ï¼Œå€‹äººç³å­”åå¤§ï¼Œæ‰€ä»¥é©—å…‰å¸«èªªæœƒæœ‰æ—¥å¤œè¦–å·®å¤§ä»¥åŠç•å…‰ç­‰ç¼ºé»&lt;/p>
&lt;h3 id="æ¸¬é‡åº¦æ•¸">æ¸¬é‡åº¦æ•¸&lt;/h3>
&lt;p>é€™éƒ¨åˆ†æœ‰é»é¡ä¼¼ä¸€èˆ¬çœ¼é¡è¡Œçš„é©—å…‰ï¼Œæœƒçœ‹ç¿»æ»¾ E çš„ç¼ºå£ / ç´…è‰²ç¶ è‰²å“ªé‚Šé¡¯çœ¼ï¼Œå¾Œä¾†æ‰çŸ¥é“å¦‚æœ&lt;code>ç´…è‰²æ˜é¡¯ä»£è¡¨èª¿æ•´è¦–åŠ›å¤ªæ·ºï¼Œç¶ è‰²æ˜é¡¯ä»£è¡¨èª¿æ•´è¦–åŠ›éæ·±&lt;/code>ï¼Œè¦å…©é‚Šä¸€æ¨£æ¸…æ¥šæ‰æ˜¯æ­£ç¢ºçš„&lt;/p>
&lt;p>å› ç‚ºæœ¬èº«æœ‰é–ƒå…‰ï¼Œé©—å…‰å¸«æœƒå»é‡æ¸¬é–ƒå…‰çš„è§’åº¦ï¼Œç›¸èšæ–¼æ­£å¸¸çš„çœ¼ç›å‘ˆç¾çƒé«”ï¼Œ&lt;code>é–ƒå…‰çš„çœ¼ç›æ˜¯å±¬æ–¼æ©¢åœ“å½¢&lt;/code>ï¼Œæœƒé€éé¡ç‰‡ç£¨è£½å»çŸ¯æ­£ï¼Œä½†æ©¢åœ“å‚¾æ–œçš„è§’åº¦å°±æœƒå½±éŸ¿é¡ç‰‡ç£¨è£½çš„æ–¹å‘ï¼Œæ‰€ä»¥éœ€è¦å»èª¿æ•´è§’åº¦&lt;/p>
&lt;p>æ¥è‘—é‚„æœ‰æ¸¬é‡ &lt;code>æ–œè¦–è·Ÿæ–œä½&lt;/code>ï¼Œæ–œè¦–æ˜¯å‘å‰çœ‹æ™‚ç³å­”ä¸æ˜¯æŒ‡å‘æ­£å‰æ–¹ï¼Œæ‰€ä»¥é¢å°é¢èªªè©±æœƒä»¥ç‚ºå°æ–¹è¦–ç·šä¸åœ¨è‡ªå·±èº«ä¸Šï¼›&lt;br>
è€Œæ–œä½æ˜¯çœ¼ç›é–‰èµ·æ™‚æœƒå¾€æ—é‚Šä½ç§»ï¼Œç­‰åˆ°è¦ç›´è¦–æ™‚æœƒé€éè‚Œè‚‰æ‹‰æ‰¯æŠŠç³å­”å°æ­£ï¼Œä½†å¦‚æœè‚Œè‚‰ç„¡åŠ›å°±æœƒæœ‰æ–œè¦–çš„å•é¡Œï¼Œå¯ä»¥ç†è§£æˆ&lt;code>çœ¼ç›æœƒæ‰¾æ™‚é–“å·æ‡¶çš„æ¦‚å¿µ XD&lt;/code>&lt;/p>
&lt;p>æ¸¬é‡æ–¹æ³•æ˜¯ç”¨çœ¼ç›ç›´è¦–å‰æ–¹ï¼Œç”¨ç‰¹æ®Šçš„é¡ç‰‡å»æª¢æ¸¬çœ¼ç›æ˜¯å¦æœ‰ä¸Šè¿°ç‹€æ³ï¼Œå¤ªåš´é‡è€…è¦çŸ¯æ­£ï¼Œæœ¬èº«æœ‰ç¨å¾®æ–œä½ï¼Œä½†æ˜¯ä¸åš´é‡ä¸éœ€è¦å¦å¤–çŸ¯æ­£&lt;/p>
&lt;p>æœ€å¾Œé©—å…‰å¸«æœƒæŠŠå‰›å‰›çš„æ•¸æ“šï¼Œå†åšèª¿æ•´ï¼Œéˆé­‚ä¹‹çª—çš„é©—å…‰å¸«ç›´æ¥æ‹¿å‡ºç™½æ¿ç•«åœ–è¬›è§£ï¼Œå€‹äººååˆ†å–œæ­¡é€™ç¨®æ•™è‚²é¡§å®¢çš„ä½œæ³•ï¼Œå¾Œé¢è£œå……èªªæ˜äº†&lt;/p>
&lt;ol>
&lt;li>èª¿æ•´è¦–åŠ›åªæ˜¯è¦è®“æˆåƒä½ç½®æº–ç¢ºè½åœ¨è¦–ç¶²è†œä¸Šï¼Œ&lt;code>è€Œè¦–åŠ›çŸ¯æ­£çš„æ¥µé™(1.0 é‚„æ˜¯ 2.0)æ˜¯çœ‹è¦–ç¶²è†œç´°èƒæ•¸é‡&lt;/code>ï¼Œç´°èƒè¶Šå¤šæˆåƒæ•ˆæœè¶Šå¥½ï¼Œå°±åƒæ‹ç…§åŒæ¨£çš„é¡é ­åº•ç‰‡ç´ è³ªä¸åŒæ‹æ”æ•ˆæœä¹Ÿä¸åŒçš„é“ç†&lt;/li>
&lt;li>é‡æ¸¬åº¦æ•¸å¯ä»¥å¾®èª¿ï¼Œä¸€èˆ¬é‡æ¸¬çš„è¦–åŠ›æ˜¯çœ‹é ç‰©ï¼Œä¹Ÿå°±æ˜¯å…­å…¬å°ºä»¥ä¸Šï¼Œä½†å¦‚æœå¹³å¸¸éƒ½æ˜¯çœ‹è¿‘ç‰©ç‚ºä¸»ï¼Œå¯ä»¥å¾®èª¿é™è¿‘è¦–åº¦æ•¸ï¼Œäººçœ¼é€é&lt;code>ç«ç‹€è‚Œè·Ÿæ°´æ™¶é«”å»èª¿æ•´èšç„¦çš„ä½ç½®ï¼Œåªèƒ½æŠŠæˆåƒä½ç½®å¾€å¾Œæ‹‰ä¸å¯èƒ½å¾€å‰æ‹‰&lt;/code>ï¼ŒåŸç†åƒæ˜¯è¿‘è¦–çš„äººæ±è¥¿æ‹¿è¿‘å°±çœ‹å¾—åˆ°ï¼Œå› ç‚ºæˆåƒä½ç½®æœƒå¾€å‰æ‹‰å‰›å¥½è½åˆ°è¦–ç¶²è†œä¸Š&lt;/li>
&lt;li>&lt;code>å…¨è¦–ç·š&lt;/code> æ˜¯ä¸€é–€å°ˆåˆ©æŠ€è¡“ï¼Œæˆæ¬Šçµ¦é¡ç‰‡è£½é€ å•†å»ç”Ÿç”¢ï¼Œæ‰€ä»¥å¥½åƒæœ‰è »å¤šé–“å» å•†éƒ½æœ‰æä¾›ï¼Œå¦å¤–å…¨è¦–ç·šæ˜¯éš”çµ•&lt;code>ç´«å¤–ç·šè€Œéå…‰é‡&lt;/code>ï¼Œä¹Ÿå°±æ˜¯é™°å¤©å¯èƒ½é¡ç‰‡ä¹Ÿæœƒè®Šè‰²ï¼Œä½†é–‹è»Šå¯ä»¥ä¸ç”¨æ“”å¿ƒï¼Œå› ç‚ºæ“‹é¢¨ç»ç’ƒé€šå¸¸æœƒéš”çµ•ç´«å¤–ç·šï¼Œä¸å¤ªéœ€è¦æ€•é€²å…¥éš§é“æœƒå¤ªæš—&lt;/li>
&lt;li>ç¾åœ¨æŠ—è—å…‰æŠ€è¡“æœ‰æå‡ï¼Œåƒ…å¸æ”¶éƒ¨åˆ†å°äººçœ¼æœ‰å®³çš„éƒ¨åˆ†è—å…‰æ³¢é•·ï¼Œé¡è‰²ä¸æœƒè®Šé»ƒå¾ˆå¤šï¼Œæœ‰å¯¦éš›æ‹¿é¡ç‰‡æ¸¬è©¦ç¢ºå¯¦å·¥ç¨‹å¸«çš„çœ¼ç›çœ‹ä¸å‡ºè‰²å·® XD&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ä»¥ä¸Šé©—å…‰æ™‚é–“ç´„ &lt;code>45 åˆ†é˜&lt;/code>ï¼Œé€™å…©é–“éƒ½å·®ä¸å¤šï¼Œé æ¯”å…¶ä»–é–“é©—å…‰é‚„è¦ä»”ç´°çš„å¤šï¼Œè¨˜å¾—ç¶²è·¯å…ˆé ç´„å–”&lt;/p>
&lt;/blockquote>
&lt;h3 id="æ¸¬é‡é¡æ¡†åœ¨è‡‰ä¸Šçš„ä½ç½®">æ¸¬é‡é¡æ¡†åœ¨è‡‰ä¸Šçš„ä½ç½®&lt;/h3>
&lt;p>ä»¥å‰é…çœ¼é¡ï¼Œéƒ½æ˜¯é©—å…‰å®ŒæŒ‘å®Œé¡æ¡†è¨­è¨ˆå°±çµæŸï¼Œä½†å…¶å¯¦å› ç‚ºæ¯å€‹äººè‡‰å‹ä¸æ˜¯å®Œç¾å°ç¨±ï¼Œå–œæ­¡å¸¶çš„çœ¼é¡é«˜åº¦ä¹Ÿä¸åŒï¼Œé€™äº›éƒ½æœƒå½±éŸ¿åˆ°é¡ç‰‡ï¼Œæ‰€ä»¥&lt;code>é¡æ¡†çš„å¾®èª¿ä¹Ÿæ˜¯å¾ˆé‡è¦çš„&lt;/code>&lt;/p>
&lt;p>é€™æ¬¡å»éˆé­‚ä¹‹çª—ï¼Œæœ‰å„€å™¨æ­é… app æ‹æ”æ­£é¢èˆ‡å´é¢ï¼Œæ­£é¢å»çœ‹ç³è·ï¼Œå´é¢çœ‹çœ¼ç›è·é›¢é¡ç‰‡çš„é•·åº¦ï¼Œé€™äº›æ•¸æ“šæœƒå½±éŸ¿é¡ç‰‡ç£¨è£½çš„è§’åº¦&lt;/p>
&lt;p>å…‰æ˜åˆ†å­é€™æ–¹é¢åšå¾—æ›´åŠ çš„å…ˆé€²ä¸€äº›ï¼Œé¦–å…ˆæ˜¯å„€å™¨ä½¿ç”¨è”¡å¸æä¾›çš„ï¼Œå…±æœ‰å¤šé¡†é¡é ­æ‰€ä»¥ç«™å®šé»æ‹ä¸€æ¬¡æå®šï¼Œå¦å¤–å´è‡‰æœ‰å»èª¿æ•´çœ¼é¡çš„å‚¾æ–œçš„è§’åº¦ï¼Œé¿å…è²¼è‡‰å¤ªè¿‘æˆ–å¤ªé ï¼Œé€™éƒ¨åˆ†æ˜é¡¯å¥½ä¸€äº›&lt;/p>
&lt;h2 id="å…¶é¤˜">å…¶é¤˜&lt;/h2>
&lt;p>è¬›ä¸€äº›å…¶ä»–é›œä¸ƒé›œå…«çš„æ„Ÿå—å¥½äº†&lt;/p>
&lt;h3 id="æœå‹™">æœå‹™&lt;/h3>
&lt;p>å…©é–“é©—å…‰å¸«éƒ½å¾ˆæ£’ï¼Œæœå‹™æ…‹åº¦éƒ½å¾ˆå¥½ï¼Œåƒæ˜¯æœ‰å•å…¨è¦–ç·šæ˜¯ä»€éº¼ã€çœ¼ç›èƒ½ä¸èƒ½çŸ¯æ­£åˆ° 2.0 ç­‰ç­‰é›œä¸ƒé›œå…«çš„å•é¡Œï¼Œéƒ½æœ‰å¾ˆå®Œæ•´çš„è§£ç­”ï¼Œä½†å…©äººæ¯”è¼ƒå¾Œç¨ç¨åå¥½éˆé­‚ä¹‹çª—çš„è§£èªªï¼Œå› ç‚ºç”¨ç™½æ¿å¤ªèªçœŸäº† XD è€Œä¸”æ•´é«”ä¸Šè¬›å¾—æ¯”è¼ƒå…¨é¢&lt;/p>
&lt;h3 id="åº—é¢">åº—é¢&lt;/h3>
&lt;p>åœ°é»éƒ½éå¸¸æ–¹ä¾¿ï¼Œè£æ½¢éƒ¨åˆ†å…‰æ˜åˆ†å­å°±æ˜¯ç°¡ç´„ä½†æ˜¯åˆé€éœ²è‘—å¥¢è¯ï¼Œè®“æœ¬å®…ç©¿è‘—å¤¾è…³æ‹–é€²å»æœ‰é»ä¸å¤ªè‡ªåœ¨ (çª®äººè²Œ)ï¼Œç‡Ÿé€ è‘—æ™‚å°šã€å¹´ä»£æ„Ÿçš„æ°£æ°›ï¼Œé¡æ¶ä¹Ÿéƒ½æ˜¯è¨­è¨ˆå“ç‰Œï¼Œæ‰€ä»¥å¾ˆåœ¨æ„è¨­è¨ˆæ„Ÿã€å¤–è§€çš„äººå¯ä»¥è€ƒæ…®ï¼› &lt;br>
éˆé­‚ä¹‹çª—ç›¸å°å°±å¾ˆæ˜äº®ï¼Œæ¯”è¼ƒæ˜¯å¹³æ—¥æœƒå»çš„çœ¼é¡è¡Œï¼Œåƒ¹æ ¼å¸¶å¾ˆå¯¬ï¼Œä¾¿å®œçš„å¹¾åƒå…ƒåˆ°ä¸Šè¬å…ƒéƒ½æœ‰ï¼Œå¸‚äº•å°æ°‘æƒ³è¦é…å€‹å¥½çœ¼é¡å»é€™é‚Šæ‡‰è©²æ¯”è¼ƒè‡ªåœ¨&lt;/p>
&lt;p>è‡³æ–¼é¡ç‰‡éƒ¨åˆ†è”¡å¸è·Ÿä¼Šè¦–è·¯åœ¨è€ç”¨æ€§ã€è¦–è¦ºæ¸…æ™°åº¦ã€é€äº®åº¦ç­‰ç­‰çš„æ¯”è¼ƒï¼Œå› ç‚ºä¹Ÿä¸æ˜¯å°ˆæ¥­çš„å°±ä¸å¤šèªªï¼Œåƒ…æ†‘ä¸€å€‹é–€å¤–çš„æ¶ˆè²»è€…åˆ†äº«è‡ªå·±é«”é©—çš„éç¨‹ï¼Œå¦‚æœæœ‰ä»»ä½•è¬›éŒ¯çš„åœ°æ–¹æ­¡è¿ç•™è¨€&lt;/p></description></item><item><title>RFC 5389 - STUN å”å®šä»‹ç´¹</title><link>https://yuanchieh.page/posts/2020/2020-09-22-rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/</link><pubDate>Tue, 22 Sep 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-09-22-rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/</guid><description>&lt;p>STUN æ‡‰ç”¨æ–¼è™•ç† NAT ç©¿è¶ŠæŠ€è¡“ (å¦‚ ICE ) ä¸‹çš„ä¸€ç¨®å·¥å…·ï¼Œæœ¬èº«ä¸¦é NAT ç©¿è¶Šçš„è§£æ±ºæ–¹æ¡ˆï¼Œä¸»è¦åŠŸèƒ½ç‚º&lt;code>ç¢ºèªå…©å€‹åœ¨ NAT èƒŒå¾Œç¯€é»çš„ IP / Port&lt;/code>ï¼Œæœ¬ç¯‡ç‚º &lt;a class="link" href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="noopener"
>RFC 5389&lt;/a> çš„é–±è®€å¿ƒå¾—ï¼Œåˆ†äº« STUN èƒŒå¾Œçš„è¨­è¨ˆåŸç†èˆ‡çµæ§‹&lt;/p>
&lt;p>STUN ä¹‹ä¸Šé‚„æœ‰æ“´å¢ä¸€å€‹ TURN å”å®šï¼Œæä¾› relay é€£ç·šçš„åŠŸèƒ½ï¼Œä¸€èˆ¬çš„ TURN Server æœƒåŒæ™‚æä¾› STUN çš„æœå‹™ï¼Œå¦‚æœæƒ³çŸ¥é“ TRUN Server æ¶è¨­ï¼Œå¯ä»¥åƒè€ƒå¦ä¸€ç¯‡æ–‡ç«  &lt;a class="link" href="https://yuanchieh.page/post/2020-09-21_aws-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8/" target="_blank" rel="noopener"
>AWS Coturn serveræ¶è¨­æ•™å­¸&lt;/a>&lt;/p>
&lt;p>å¦‚æœä½ æœ‰ä»¥ä¸‹ç–‘æƒ‘ï¼Œé‚£é€™ç¯‡æ–‡ç« æ‡‰è©²å¯ä»¥å¹«åŠ©åˆ°ä½ &lt;/p>
&lt;ol>
&lt;li>STUN Server ç©¶ç«Ÿæ˜¯å¦‚ä½•é‹ä½œ&lt;/li>
&lt;li>STUN Server æ˜¯å¦æœ‰é©—è­‰æ©Ÿåˆ¶&lt;/li>
&lt;li>æƒ³çŸ¥é“ Coturn config ä¸­çš„åƒæ•¸å«ç¾©ï¼Œå¦‚ Fingerprint / Realm / Nonce&lt;/li>
&lt;/ol>
&lt;h2 id="èˆ‡èˆŠç‰ˆ-stun-çš„å·®ç•°">èˆ‡èˆŠç‰ˆ STUN çš„å·®ç•°&lt;/h2>
&lt;p>å…ˆå‰æœ‰ä¸€ç‰ˆ STUN çš„å®šç¾© &lt;a class="link" href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener"
>RFC-3489&lt;/a>ï¼Œç•¶æ™‚çš„ STUN è¢«å®šç¾©æˆå®Œæ•´çš„ NAT ç©¿è¶Šè§£æ±ºæ–¹æ¡ˆï¼Œä½†æ˜¯é­é‡äº†ä»¥ä¸‹å•é¡Œæ‰æ”¹ç”¨é€™ä¸€ç‰ˆ 5389 å–ä»£äº†èˆŠç‰ˆ&lt;/p>
&lt;ol>
&lt;li>ç„¡æ³•æ­£ç¢ºå€åˆ† NAT é¡å‹ï¼Œå°è‡´å¯èƒ½é€£ç·šæœ‰å•é¡Œ&lt;br>
NAT å…±æœ‰å››ç¨®é¡å‹ï¼Œå…¶ä¸­ symmetric NATs æ˜¯æ¯æ¬¡é€šè¨Šæ²’æœ‰å›ºå®šçš„ Public IP / Portï¼Œæ‰€ä»¥åªèƒ½é€é TURN ä¾†è§£æ±ºé›™ç¯€é»çš„é€£ç·šå•é¡Œ&lt;br>
ä½†æ˜¯èˆŠç‰ˆ STUN æ¼”ç®—æ³•è¨­è¨ˆç„¡æ³•å€åˆ† NAT é¡å‹ï¼Œæ‰€ä»¥æœ‰å¯èƒ½é€ æˆéƒ¨åˆ†çš„é€£ç·šç•°å¸¸&lt;/li>
&lt;li>æ”¯æ´ TCP / DTLS:&lt;br>
èˆŠç‰ˆåªæ”¯æ´ UDP&lt;/li>
&lt;li>Security è€ƒé‡&lt;/li>
&lt;/ol>
&lt;p>æ–°ç‰ˆ STUN ä¸å†æ˜¯å®Œæ•´çš„ NAT traversal è§£æ±ºæ–¹æ¡ˆï¼Œåªå°ˆæ³¨æ–¼&lt;code>æ‰¾å‡ºç¯€é»å¤–å±¤ NAT å°å¤–çš„ Public IP/Port&lt;/code>ï¼Œå®Œæ•´çš„è§£æ±ºæ–¹æ¡ˆå¦‚ ICE / SIP Outbound ç­‰ç­‰&lt;/p>
&lt;blockquote>
&lt;p>ä¹Ÿå› æ­¤ STUN SERVER é è¨­ port æ˜¯ 3489 / TLS port æ˜¯ 5398&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ¶æ§‹ä»‹ç´¹">æ¶æ§‹ä»‹ç´¹&lt;/h2>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200922/stun.png"
loading="lazy"
>&lt;br>
å¯ä»¥çœ‹åˆ° STUN Client èº²åœ¨å…©å±¤ NAT ä¹‹å¾Œï¼Œè€Œ STUN Server å°±æ˜¯è¦é€šçŸ¥ STUN Client æœ€å¤–å±¤ NAT æ‰€å°æ‡‰çš„ Public IP / Port&lt;/p>
&lt;p>STUN æ¡ç”¨ client/server æ¶æ§‹ï¼Œæ”¯æ´å…©ç¨®æºé€šæ–¹å¼(transaction)&lt;/p>
&lt;ol>
&lt;li>request / response&lt;/li>
&lt;li>indicate (é€å‡ºå»ä¸ç­‰å›è¦†)&lt;/li>
&lt;/ol>
&lt;p>æ¯å€‹ transaction éƒ½æœ‰ 96bit random id&lt;/p>
&lt;h3 id="å‚³é€æ©Ÿåˆ¶">å‚³é€æ©Ÿåˆ¶&lt;/h3>
&lt;p>æ¯å€‹ Transaction æœƒå®šç¾©é¡å‹ (Action)ï¼Œç›®å‰ Spec åƒ…å®šç¾© Binding action&lt;/p>
&lt;p>é‹ä½œæ©Ÿåˆ¶å¦‚ä¸‹&lt;/p>
&lt;ol>
&lt;li>client é€å‡º request&lt;/li>
&lt;li>NAT æœƒä¿®æ”¹ client package å°åŒ…çš„ IPï¼Œä¸¦è‡ªä¸»ç®¡ç† client private ip port èˆ‡ NAT å°æ‡‰å‡ºå»çš„ ip / port&lt;/li>
&lt;li>ä¸€è·¯åˆ° server æ‰‹ä¸Šåªæœƒæ‹¿åˆ° NAT çš„ public ip / portï¼Œç¨±ä¹‹ç‚º &lt;code>server reflexive transport address (srflx)&lt;/code>ï¼Œå¦‚æœæœ‰ç”¨é WebRTC æ‡‰è©²æœ‰çœ‹é srflx ï¼Œé€™å°±æ˜¯ä»£è¡¨ç”¨æˆ¶èµ° STUN&lt;/li>
&lt;li>æ¥è‘— server æŠŠé€™å€‹ public ip / port ç•¶ä½œå…§å®¹ &lt;code>XOR-MAPPED-ADDRESS&lt;/code> å‚³å›å»çµ¦ client&lt;/li>
&lt;li>NAT æ¥è‘—æœƒä¸€è·¯æ”¹ ip portï¼Œä½†å› ç‚ºå…§æ–‡ä¸æ”¹æ‰€ä»¥ client æœƒçŸ¥é“æœ€å¤–å±¤ NAT çš„ public ip + port&lt;/li>
&lt;/ol>
&lt;h4 id="packet-format">Packet Format&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span>&lt;span class="m">0&lt;/span> 0&lt;span class="p">|&lt;/span> STUN Message Type &lt;span class="p">|&lt;/span> Message Length &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> Magic Cookie &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> Transaction ID &lt;span class="o">(&lt;/span>&lt;span class="m">96&lt;/span> bits&lt;span class="o">)&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°åŒ…æ ¼å¼ä»‹ç´¹&lt;/p>
&lt;ol>
&lt;li>æœ€å‰æ–¹å…©å€‹ bit å›ºå®šç‚º 0 ï¼Œä¸»è¦æ˜¯ç”¨ä¾†å€åˆ†æ˜¯ä¸æ˜¯ STUN çš„ packet&lt;/li>
&lt;li>Message Type åŒ…å« Transaction é¡å‹ / response æˆåŠŸæˆ–å¤±æ•—&lt;/li>
&lt;li>magic cookie å›ºå®šç‚º 0x2112A442&lt;/li>
&lt;li>Transaction ID ç”¨ä¾†å€åˆ† STUN transaction&lt;/li>
&lt;li>STUN message ä¸å¯ä»¥è¶…é MTO&lt;/li>
&lt;li>å¦‚æœå‚³è¼¸é€é UDP:&lt;br>
Client è¦è‡ªå·±è™•ç† retransmitï¼Œé è¨­ timeout 500ms ~ 3000 ms é–“ï¼Œä¹‹å¾Œæ¯æ¬¡ retry Timeout double&lt;/li>
&lt;li>å¦‚æœå‚³è¼¸é€é TCP:&lt;br>
ä¸è¦å¢åŠ è€Œå¤–çš„ framing / demultiplexing
å·²ç¶“ä¿éšœè³‡æ–™å¯é æ€§ï¼Œé è¨­ Timeout ç‚º 39.5s
Server æ‡‰è©²ç­‰ Client ä¸»å‹•æ–·ç·šï¼Œé™¤éé‡åˆ° timeout&lt;/li>
&lt;/ol>
&lt;h3 id="é©—è­‰è¨Šæ¯">é©—è­‰è¨Šæ¯&lt;/h3>
&lt;p>Server æ”¶åˆ°è¨Šæ¯å¾Œï¼Œæœƒå…ˆåšåŸºæœ¬çš„é©—è­‰ï¼Œå¦‚æœæœ‰é–‹å•Ÿ fingerprint extension å‰‡é©—è­‰ï¼Œå¦‚æœç™¼ç¾æœ‰ä¸æ”¯æ´çš„å±¬æ€§å‰‡å›å‚³éŒ¯èª¤ï¼›
Server å›å‚³éŒ¯èª¤æ™‚ï¼Œå¿…é ˆ&lt;code>æŒ‡å®š error codeï¼Œä¸¦æŒ¾å¸¶ error code attribute&lt;/code>ï¼Œä¾‹å¦‚èªªæœ‰ä¸æ”¯æ´çš„å±¬æ€§å‰‡å›å‚³ 420 + UNKNOWN-ATTRIBUTESï¼Œå¦‚æœæ˜¯ 401 é©—è­‰å¤±æ•—å‰‡å¿…é ˆå°æ‡‰å›å‚³é©—è­‰æ–¹å¼ï¼Œé€™é‚Šçš„ error code åƒè€ƒ HTTP æ‰€ä»¥æœƒæœ‰ç¨®ä¼¼æ›¾ç›¸ä¼¼çš„åˆ†é¡ï¼›&lt;br>
å¦‚æœè¨Šæ¯æˆåŠŸå‰‡å¤¾å¸¶ &lt;code>XOR-MAPPED-ADDRESS&lt;/code> å›å‚³&lt;/p>
&lt;h3 id="fingerprint">FINGERPRINT&lt;/h3>
&lt;p>å†Multiplexing ä¸‹ï¼Œæœƒæœ‰å¤šå€‹ä¸åŒ protocol çš„ packet å‚³é€åˆ°ç›¸åŒä½å€çš„ï¼Œä¾‹å¦‚èªª RTPï¼ŒåŠ ä¸Š &lt;code>fingerprint&lt;/code> å¯ä»¥æ–¹ä¾¿ STUN Server å€åˆ† STUN message&lt;/p>
&lt;h3 id="dns">DNS&lt;/h3>
&lt;p>é€é SRV ç´€éŒ„å›å‚³ STUN Server ç›¸é—œçš„æœå‹™ï¼ŒSRV æ ¼å¼å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">_service._proto.name. TTL class SRV priority weight port target.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ˜¯ä»¥ STUN Server é–‹æ”¾ TCP / UDP ï¼Œå‡è¨­ STUN Server domain name æ˜¯ &lt;code>stun.example.com&lt;/code>çš„è©±&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">_stun._udp.example.com &lt;span class="m">86400&lt;/span> IN SRV &lt;span class="m">0&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">3489&lt;/span> stun.example.com.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">_stun._tcp.example.com &lt;span class="m">86400&lt;/span> IN SRV &lt;span class="m">0&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">3489&lt;/span> stun.example.com.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ SRV å¥½è™•æ˜¯å¯ä»¥æ”¹è®Šé è¨­çš„ Portï¼›&lt;br>
å¦‚æœä¸ç”¨ SRVï¼Œä¹Ÿå¯ä»¥ç”¨ A / AAAA ç´€éŒ„è¿”å› IP Listï¼Œä½† Port å°±åªèƒ½ç”¨é è¨­çš„&lt;/p>
&lt;h3 id="èº«ä»½é©—è­‰èˆ‡è¨Šæ¯å®Œæ•´æ€§æª¢æŸ¥">èº«ä»½é©—è­‰èˆ‡è¨Šæ¯å®Œæ•´æ€§æª¢æŸ¥&lt;/h3>
&lt;p>å…±æœ‰å…©ç¨®èº«ä»½é©—è­‰çš„æ–¹å¼ï¼Œ&lt;/p>
&lt;h4 id="çŸ­æœŸ">çŸ­æœŸ&lt;/h4>
&lt;p>Client / Server æœƒé å…ˆå…±äº«åŒä¸€å€‹ secretï¼Œå¾ŒçºŒ Client ç”¢ç”Ÿä¸€å€‹æœ‰æ™‚é–“é™åˆ¶çš„ credential (password)ï¼ŒServer æ”¶åˆ°å¾Œæœƒç”¨ç›¸åŒçš„ secret åšé©—è­‰ï¼›&lt;br>
ç¢ºä¿è¨Šæ¯å®Œæ•´æ€§å‰‡é€é &lt;code>MESSAGE-INTEGRITY&lt;/code> æ¬„ä½ï¼Œæ­¤æ¬„ä½ç”¢ç”Ÿçš„æ–¹å¼æ˜¯æŠŠ STUN Message åš HMAC_SHA1ï¼›&lt;/p>
&lt;p>Server æ”¶åˆ°STUN Message å¾Œçš„é©—è­‰æµç¨‹å¦‚ä¸‹&lt;/p>
&lt;ol>
&lt;li>æ²’æœ‰ MESSAGE-INTEGRITY å’Œ USERNAME æ¬„ä½å‰‡å›å‚³ 401&lt;/li>
&lt;li>æª¢æŸ¥ USERNAME æ˜¯å¦åˆæ³•&lt;/li>
&lt;li>ç”¨ passwrod èˆ‡ username è¨ˆç®—å‡º message intergrity çš„å€¼ä¸¦æ¯”å°&lt;/li>
&lt;li>éƒ½é€šéå‰‡ç”¢ç”Ÿ responseï¼Œresponse åŒæ¨£è¦åŒ…å« MESSAGE-INTEGRITY&lt;/li>
&lt;/ol>
&lt;p>Client æ”¶åˆ° response ä¹Ÿéœ€è¦æª¢æŸ¥ MESSAGE-INTEGRITY&lt;/p>
&lt;p>å› ç‚º credential æœ‰æ™‚é–“é™åˆ¶ï¼Œæ‰€ä»¥ä¸æœƒé‡åˆ°å›æ”¾(replay)æ”»æ“Š&lt;/p>
&lt;h4 id="é•·æœŸ">é•·æœŸ&lt;/h4>
&lt;p>Server / Client å›ºå®šé•·æœŸä½¿ç”¨&lt;code>ç›¸åŒçš„ username / password&lt;/code>&lt;/p>
&lt;p>æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>Client ä¸å¸¶ä»»ä½• credential ç™¼èµ·&lt;/li>
&lt;li>Server rejectï¼Œä¸¦åˆ†é… realm (æŒ‡å¼• client é¸æ“‡ credential) èˆ‡ nonce (é¡ä¼¼æ–¼ cookieï¼ŒæŒ‡å®š duration / client identity ç­‰) å¤šä¸€å±¤ä¿è­·&lt;/li>
&lt;li>Client retry ï¼Œæˆ´ä¸Š credential èˆ‡ nonce + message-integrity (å°æ•´å€‹ request åš HMAC)&lt;/li>
&lt;li>Server æª¢æŸ¥ auth èˆ‡ integrity&lt;/li>
&lt;/ol>
&lt;p>Server æ”¶åˆ°è¨Šæ¯æ™‚æœƒä¾åºæª¢æŸ¥&lt;/p>
&lt;ol>
&lt;li>MESSAGE-INTEGRITY: æ²’æœ‰å›å‚³ 401&lt;/li>
&lt;li>å¦‚æœæ²’æœ‰ username / password / realm / nonce ï¼Œå›å‚³ 400&lt;/li>
&lt;li>Nonce éæœŸäº†ï¼Œ438&lt;/li>
&lt;li>Username ç„¡æ•ˆï¼Œ401&lt;/li>
&lt;li>Message-integrity éŒ¯èª¤ï¼Œå›å‚³ 401&lt;/li>
&lt;li>ALTERNATE-SERVER Mechanism
å¦‚æœ Server å¸Œæœ› Redirect Client å»åˆ¥çš„ Serverï¼Œå¯ä»¥å›å‚³ error code 300 ä¸¦æŒ‡å®š ALTERNATE-SERVER
Client æ”¶åˆ°å¾Œï¼Œç”¨ç›¸åŒçš„ transport protocol / credential å°æ–°çš„ Server é‡å•Ÿ transaction&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ä¹‹æ‰€ä»¥é–‹é ­è¦ç”¢ç”Ÿä¸€æ¬¡ auth failed çš„ requestæ˜¯è¦äº†å»è·Ÿ Server æ‹¿ Nonceï¼Œä¸»è¦æ˜¯ç‚ºäº†é¿å…&lt;code>å›æ”¾æ”»æ“Š&lt;/code>ï¼›&lt;br>
å›æ”¾æ”»æ“Šä¸»è¦æ˜¯ å¦‚æœæœ‰ä¸­é–“äººï¼Œä»–æ‹¿åˆ° Client request è¨˜éŒ„ä¸‹ä¾†ï¼ŒæŠŠåŒæ¨£çš„ request å¾€ Server é€ï¼Œå› ç‚º credential æ˜¯é•·æœŸæœ‰æ•ˆæ‰€ä»¥ä¸­é–“äººä¹Ÿèƒ½å¤ é€šéé©—è­‰ï¼Œå³ä½¿æ˜¯æœ‰ TLS ä¿è­· / ä¸­é–“äººä¸çŸ¥é“ username, password å›æ”¾æ”»æ“Šéƒ½æœ‰ç”¨ï¼›&lt;br>
æ‰€ä»¥æ‰éœ€è¦ Nonce ä¸€å€‹ç”± Server æ ¸ç™¼ä¸€æ¬¡æ€§çš„ Tokenï¼ŒåŒ…è£åœ¨ STUN Message ä¸­ï¼Œè¶…å‡ºæ™‚é–“å°±æœƒè¢«èªå®šç„¡æ•ˆï¼Œå¾è€Œé¿å…å›æ”¾æ”»æ“Š&lt;/p>
&lt;/blockquote>
&lt;h3 id="stun-attributes">STUN Attributes&lt;/h3>
&lt;p>å† STUN Header ä¹‹å¾Œï¼Œå¯ä»¥æ¥é›¶è‡³å¤šå€‹ attributeï¼Œattribute æ¡ç”¨ TLV encode&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> Type &lt;span class="p">|&lt;/span> Length &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> Value &lt;span class="o">(&lt;/span>variable&lt;span class="o">)&lt;/span> ....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœ response ä¸­æœ‰é‡è¤‡çš„ attributeï¼Œåªæœ‰ &lt;code>ç¬¬ä¸€å€‹&lt;/code> æœƒè¢«è€ƒæ…®ï¼Œå…¶é¤˜æœƒè¢«æ¨æ£„
Type å† 0x0000 and 0x7FFF æ˜¯å¿…é ˆè¦è¢«è™•ç†çš„ï¼Œå¦‚æœ STUN agent ç„¡æ³•è™•ç†å‰‡æœƒå¤±æ•—
0x8000~0xFFFF å‰‡æ˜¯ optional
ä»¥ä¸‹èˆ‰å¹¾å€‹å¸¸è¦‹çš„ attribute&lt;/p>
&lt;h4 id="mapped-address">MAPPED-ADDRESS&lt;/h4>
&lt;p>ä¸»è¦æ˜¯ç‚ºäº†å…¼å®¹èˆŠç‰ˆ STUNï¼Œé¡¯ç¤º Client æœ€å¾Œä¸€å€‹ Public NAT çš„ ip / port&lt;/p>
&lt;h4 id="xor-mapped-address">XOR-MAPPED-ADDRESS&lt;/h4>
&lt;p>é›·åŒæ–¼ä¸Šè€…ï¼Œä½†æ˜¯ ip / port éƒ½æ˜¯è·Ÿ magic-cookie å‰ 16 bits åš XOR å„²å­˜ (ipv4 / ipv6 xor æ–¹å¼ä¸åŒ)ï¼ŒåŸå› æ˜¯ç™¼ç¾æœ‰äº› NAT å¦‚æœçœ‹åˆ° payload æ˜¯è‡ªå·±çš„ public IP æœƒå»ä¿®æ”¹ï¼Œxor ä¹‹å¾Œå°±æ²’é€™å€‹å•é¡Œ&lt;/p>
&lt;blockquote>
&lt;p>åŸæ–‡è§£é‡‹
deployment experience found that some NATs rewrite the 32-bit binary payloads containing the NAT&amp;rsquo;s public IP address, such as STUN&amp;rsquo;s MAPPED-ADDRESS attribute, in the well-meaning but misguided attempt at providing a generic ALG function.&lt;/p>
&lt;/blockquote>
&lt;h4 id="username">USERNAME&lt;/h4>
&lt;p>ç”¨ä¾†é©—è­‰ç”¨çš„ï¼Œå¿…é ˆæ˜¯ç”¨ utf-8 encode ä¸¦å°æ–¼ 513 bets SASLprep&lt;/p>
&lt;h4 id="message-integrity">MESSAGE-INTEGRITY&lt;/h4>
&lt;p>å° STUN Message å– HMAC-SHA1ï¼Œå›ºå®šé•·åº¦ç‚º 20 bytes (å› ç‚º sha1 )
HMAC key æœƒå› ç‚º credential ä¸åŒè€Œæœ‰æ‰€ä¸åŒ&lt;/p>
&lt;ol>
&lt;li>Long term: &lt;code>key = MD5(username â€œ:â€ realm â€œ:â€ SASLprep(password))&lt;/code>&lt;/li>
&lt;li>Short term: &lt;code>key = SASLprep(password)&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>éœ€æ³¨æ„ hash åŒ…å«æ•´å€‹ STUN Messageï¼ŒåŒæ™‚ä¹ŸåŒ…å«äº† Message lengthï¼Œæ‰€ä»¥åœ¨ç”¢ç”Ÿ hash å‰ï¼ŒMESSAGE-INTEGRITY ä¹Ÿå¿…é ˆå…ˆå®‰æ’é€²å» STUM Message ä¸­ä¸¦å¸¶ dummy contentï¼Œå…¶ä»–åœ¨ä¹‹å¾Œçš„å±¬æ€§å‰‡è¢«æ’é™¤åœ¨å¤–
é©—è­‰æ™‚ä¹Ÿå¿…é ˆéµå®ˆç›¸åŒçš„æµç¨‹&lt;/p>
&lt;h4 id="fingerprint-1">Fingerprint&lt;/h4>
&lt;p>å°æ•´å€‹ STUN Message (æ’é™¤è‡ªå·±) å– CRC-32ï¼Œæ¥è‘—èˆ‡ 0x5354554e
åš XOR ( é¿å…å…¶ä»– packet ä¹Ÿç”¨ CRC-32
Fingerprint å¿…é ˆæ˜¯æœ€å¾Œä¸€å€‹å±¬æ€§&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">the FINGERPRINT attribute MUST be the last attribute in the message, and thus will appear after MESSAGE-INTEGRITY.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="error-code">Error Code&lt;/h4>
&lt;p>åŒ…å«æ•¸å€¼çš„ error code å¾ 300~699ï¼Œä¿æŒèˆ‡ SIP / HTTP ç›¸ä¼¼çš„ç¾½ç¿¼
å†åŠ ä¸Š rease: utf-8çš„æ–‡å­—æè¿° ï¼Œä¸»è¦æ˜¯è®“ç”¨æˆ¶å¯ä»¥ç†è§£&lt;/p>
&lt;h4 id="realm">REALM&lt;/h4>
&lt;p>å¦‚æœ STUN Server åŒæ™‚æ”¯æ´å¤šå€‹ domainï¼Œé€é REALM å¯ä»¥å€åˆ†ä¸åŒ domain ä½¿ç”¨çš„è¨­å®š&lt;/p>
&lt;h4 id="nonce">NONCE&lt;/h4>
&lt;p>ç”¨æ–¼æ¯æ¬¡é€£ç·šé¿å… replay å•é¡Œçš„æ–¹å¼ï¼Œé¡ä¼¼æ–¼ web çš„ cookie&lt;/p>
&lt;h4 id="unknown-attributes">UNKNOWN-ATTRIBUTES&lt;/h4>
&lt;p>å† error code 420 æ™‚å‡ºç¾&lt;/p>
&lt;h4 id="software">SOFTWARE&lt;/h4>
&lt;p>æè¿°è»Ÿé«”çš„ç‰ˆæœ¬ / è£½é€ å•†ç­‰è³‡è¨Š&lt;/p>
&lt;h4 id="alternate-server">ALTERNATE-SERVER&lt;/h4>
&lt;p>Server è¦æ±‚è½‰æ›æ™‚&lt;/p>
&lt;h3 id="security">Security&lt;/h3>
&lt;p>ä»¥ä¸‹æ¢åˆ—å¹¾ç¨®è¢«æ”»æ“Šçš„å¯èƒ½èˆ‡é˜²ç¯„æªæ–½&lt;/p>
&lt;ol>
&lt;li>Attacker å¯èƒ½ç«„æ”¹ STUN è¨Šæ¯:&lt;br>
ä½†å¯ä»¥ç”¨ message integrity é©—è­‰é˜²æ­¢&lt;/li>
&lt;li>Attacker å¯ä»¥å±…ä¸­å›å‚³ error response&lt;br>
åœ¨æŸäº›å¦‚é©—è­‰å¤±æ•—çš„è¨Šæ¯ï¼Œé€™å€‹å°±ä¸å¥½é˜²å µï¼Œé™¤éä½¿ç”¨ TLS æ‰èƒ½æœçµ•å•é¡Œ&lt;/li>
&lt;li>HMACå¯èƒ½é­å—å­—å…¸æ”»æ“Š:&lt;br>
å› ç‚º STUN åˆ©ç”¨ HMACï¼Œå¯èƒ½é­å—å­—å…¸æ”»æ“Šï¼Œè«‹ç¢ºä¿ password è¶³å¤ è¤‡é›œï¼Œæˆ–æ˜¯ç”¨ TLS é˜²æ­¢å•é¡Œï¼›ä¸æ’é™¤ SHA1 ä¹‹å¾Œè¢«æ”»ç ´ï¼Œæœªä¾†å¯èƒ½å¢åŠ æ–°çš„æ¬„ä½èˆ‡æ–°çš„ hash æ©Ÿåˆ¶&lt;/li>
&lt;li>DoS éƒ¨åˆ†: &lt;br>
STUN server æ˜¯ &lt;code>stateless&lt;/code>ï¼Œæ‰€ä»¥æ¯”è¼ƒä¸æœƒè¢« DoS æ‰“å®ï¼›&lt;br>
Attacker å¯èƒ½å‡å†’ source IPï¼Œè®“ STUN server å»æ”»æ“Šå—å®³è€…ï¼Œæ”»æ“Šä¸æœƒè¢«è·¨å¤§ï¼Œè¦å¾ ingress å»éæ¿¾ ipï¼›&lt;/li>
&lt;li>SOFTWARE æ­éœ²ç‰ˆæœ¬è³‡è¨Šï¼Œå¯èƒ½è®Šæˆæ½›è—çš„è½é»&lt;br>
STUN Server æ‡‰è©²è¦æœ‰å°æ‡‰çš„è¨­å®šå»é—œé–‰æ­¤é¸é …&lt;/li>
&lt;li>ä¿®æ”¹ source ip&lt;br>
Attack å±…ä¸­çš„è©±ï¼Œå¯ä»¥æ””æˆªclient çš„ source ip ä¸¦ä¿®æ”¹ï¼Œserver æ”¶åˆ°éŒ¯çš„ ip å°±æœƒç”¨ XOR-MAPPED-ADDRESS å›å‚³å›ï¼Œ&lt;code>é€™å¹¾ä¹ä¸å¯èƒ½é˜»æ“‹&lt;/code>ï¼Œå› ç‚ºæ­£å¸¸çš„ NAT ä¹Ÿæœƒå»ä¿®æ”¹ source ipï¼›&lt;br>
åªèƒ½åœ¨æ›´ä¸Šå±¤çš„å”è­°ï¼Œä¾‹å¦‚ ICE å»é©—è­‰ address çš„æ­£ç¢ºæ€§&lt;/li>
&lt;/ol></description></item><item><title>Coturn Server æ¶è¨­æ•™å­¸ - on AWS</title><link>https://yuanchieh.page/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/</link><pubDate>Mon, 21 Sep 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-09-21-coturn-server-%E6%9E%B6%E8%A8%AD%E6%95%99%E5%AD%B8-on-aws/</guid><description>&lt;p>å…¬å¸ P2P é€šä¿¡æ¡ç”¨ WebRTC tech stackï¼Œè¿‘æ—¥å¸Œæœ›è‡ªå»º STUN/TURN Serverï¼Œæ±ºå®šæ¡ç”¨ &lt;a class="link" href="https://github.com/coturn/coturn" target="_blank" rel="noopener"
>Coturn&lt;/a> é€™å¥—çŸ¥åçš„è§£æ±ºæ–¹æ¡ˆï¼Œåœ¨ AWS æ¶è¨­éç¨‹é‡åˆ°ä¸€äº›å‘ï¼Œæ±ºå®šåˆ†äº«å¦‚ä½•æ¶è¨­ï¼Œä¸¦åˆ†äº«è¨­å®šæª”å¦‚ä½•è¨­å®šèˆ‡æ“ä½œ&lt;br>
ä»¥ä¸‹åŒ…å«&lt;/p>
&lt;ol>
&lt;li>Coturn æ–¼ AWS ä¸Šçš„æ¶è¨­èˆ‡æ¸¬è©¦&lt;/li>
&lt;li>ä»‹ç´¹è¨­å®šæª”å…§å®¹&lt;/li>
&lt;li>ä¸Š Production çš„è€ƒé‡&lt;/li>
&lt;li>è£œå…… NAT èˆ‡ STUN/TURN é—œä¿‚&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæƒ³çŸ¥é“æ›´è©³ç´°çš„å”å®šä»‹ç´¹ï¼Œè«‹åƒè€ƒ&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="https://yuanchieh.page/post/2020-09-22_rfc-5389-stun-%E5%8D%94%E5%AE%9A%E4%BB%8B%E7%B4%B9/" target="_blank" rel="noopener"
>RFC 5398 - STUN&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæƒ³è¦ç”¨ Container æ¶è¨­ï¼Œå¯ä»¥åƒè€ƒæˆ‘ç”¨ docker-compose æ¶è¨­çš„æ–¹å¼ &lt;a class="link" href="https://github.com/sj82516/coturn-with-prometheus-grafana-on-docker" target="_blank" rel="noopener"
>Running Coturn + Promethes + Grafana in Docker&lt;/a>&lt;/p>
&lt;h2 id="coturn-æ–¼-aws-ä¸Šçš„æ¶è¨­">Coturn æ–¼ AWS ä¸Šçš„æ¶è¨­&lt;/h2>
&lt;p>ä½¿ç”¨ Ubuntu 18.04 éå¸¸ç°¡å–®ï¼Œåªè¦ä»¥ä¸‹æŒ‡ä»¤å°±èƒ½å•Ÿå‹• Coturn&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo apt-get -y update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo apt-get -y install coturn
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>å¼·çƒˆå»ºè­°ä½¿ç”¨ &lt;code>Ubuntu 18.04&lt;/code> è€Œä¸è¦ç”¨ &lt;code>Amazon Linux 2&lt;/code>ï¼ŒAmazon Linux 2 è¦è‡ªå·±è™•ç†å„ç¨®å¥—ä»¶çš„ç›¸ä¾æ€§ï¼Œæ¶è¨­éç¨‹èŠ±äº†åŠå¤©é‚„æ²’æ¶èµ·ä¾†&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç”¨ apt-get install çš„è©±ï¼Œæœƒè¢«é™åˆ¶ç‰ˆæœ¬ï¼Œå¦‚æœæœ‰å…¶ä»–éœ€æ±‚ï¼Œä¾‹å¦‚æ”¯æ´é™¤äº† SQLite ä»¥å¤–çš„ DBï¼Œæˆ–æ˜¯è¦å®‰è£ Prometheusï¼Œå»ºè­°å¾ source code build èµ·ï¼Œå¯ä»¥åƒè€ƒå¦ä¸€ç¯‡æ–‡ç« &lt;/p>
&lt;/blockquote>
&lt;p>å®‰è£å¾Œæœƒæœ‰å¹¾å€‹ command èƒ½å¤ ä½¿ç”¨&lt;/p>
&lt;ol>
&lt;li>turnserver&lt;br>
å•Ÿå‹• STUN/TURN server instance&lt;/li>
&lt;li>turnadmin&lt;br>
ä»‹é¢ç®¡ç†å¾Œå°&lt;br>
å…¶é¤˜éƒ½æ˜¯æ¸¬è©¦ç”¨å·¥å…·&lt;/li>
&lt;li>turnutils_peer&lt;br>
UDP-only echo serverï¼Œæª¢æ¸¬é€£ç·šä½¿ç”¨&lt;/li>
&lt;li>turnutils_stunclient&lt;br>
å‘¼å« STUN server ä¸¦å–å¾—å›æ‡‰&lt;/li>
&lt;li>turnutils_uclient&lt;br>
å¯ä»¥æ¨¡æ“¬å¤šäººé€£ç·š TURN server ä¸¦å–å¾—å›æ‡‰&lt;/li>
&lt;/ol>
&lt;p>ä¸Šä¸€æ­¥å®‰è£å¾Œé è¨­æœƒè‡ªè¡Œå•Ÿå‹• Coturnï¼Œä½†ç‚ºäº†å¾ŒçºŒçš„å¯¦é©—ï¼Œå…ˆæŠŠ turn service é—œé–‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo service coturn status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// å¦‚æœæœ‰åœ¨é‹è¡Œï¼Œå…ˆé—œé–‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo service coturn stop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—å•Ÿå‹• turnserver&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo turnserver
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¨å¾®çœ‹ä¸€ä¸‹ command line è·³å‡ºçš„è¨Šæ¯ï¼Œå¤§è‡´èªªæ˜&lt;/p>
&lt;ol>
&lt;li>file descriptor ä¸Šé™ï¼Œé€™æœƒå½±éŸ¿æœ€å¤§é€£ç·šæ•¸ï¼Œå¯ä»¥é€é &lt;code>$ sudo ulimit -n {number}&lt;/code>å»èª¿æ•´&lt;/li>
&lt;li>æ”¯æ´çš„é€šè¨Šå”å®šï¼Œé è¨­ STUN æ”¯æ´ UDP / TCP / DTLSï¼Œä½†å› ç‚ºç›®å‰æ²’æœ‰æŒ‡å®šæ†‘è­‰ï¼Œæ‰€ä»¥ DTLS ä¸æ”¯æ´&lt;/li>
&lt;li>æ¡ç”¨çš„ Databaseï¼Œé è¨­ä½¿ç”¨ SQLiteï¼Œä¸»è¦ç”¨ä¾†å„²å­˜ admin è³‡è¨Š / turn é€£ç·šè³‡è¨Šç­‰ï¼ŒåŒæ™‚æ”¯æ´ MySQL / Redis / PostgreSQL / MongoDBï¼Œå¯ä»¥è‡ªç”±æ›¿æ›ï¼›&lt;br>
æ ¹æ“š Spec &lt;code>STUN/TURN Server è™•ç†é€£ç·šæ˜¯ State-less&lt;/code>ï¼Œæ„å³ Database ä¸æ˜¯ç”¨ä¾†å„²å­˜é€£ç·šè³‡æ–™ï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒæœƒæ˜¯ bottleneck (å¦‚æœ Coturn éµå®ˆ Spec çš„è©±)&lt;/li>
&lt;/ol>
&lt;p>çœ‹ä¸€ä¸‹æœ‰æ²’æœ‰ä»€éº¼éŒ¯èª¤ï¼Œcli-password éŒ¯èª¤å¯ä»¥å…ˆå¿½ç•¥&lt;/p>
&lt;h3 id="å•Ÿå‹•-turnserver">å•Ÿå‹• turnserver&lt;/h3>
&lt;p>è¦æ¸¬è©¦ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆè¨­å®š AWS security groupï¼Œé–‹æ”¾ä»¥ä¸‹çš„ port&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">3478: UDP+TCP // TURN Server æ¥æ”¶ request çš„ port
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5394: UDP+TCP // TURN Server æ¥æ”¶ TLS request çš„ port
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">49152-65536: UDP+TCP // å¯¦éš›é€£ç·šçš„ Socket Port range
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šä¸‰å€‹éƒ½èƒ½å¤ èª¿æ•´ï¼Œä½†å°±å…ˆæ¡ç”¨é è¨­&lt;/p>
&lt;p>æ¥è‘—å•Ÿå‹• turnserver&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo turnserver -v --lt-cred-mech --user hello:world --realm &amp;lt;your domain name&amp;gt; --external-ip &amp;lt;your instance public-ip&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šçš„åƒæ•¸ä»£è¡¨&lt;/p>
&lt;ol>
&lt;li>&lt;code>-v&lt;/code>: é¡¯ç¤ºè©³ç´°çš„ log&lt;/li>
&lt;li>&lt;code>--lt-cred-mech&lt;/code>: æŒ‡å®šç‚º long term credentialï¼Œç¨å¾Œè§£é‡‹&lt;/li>
&lt;li>&lt;code>--user {username}:{password}&lt;/code>: æ­é… long term credentialï¼ŒæŒ‡å®š username / password&lt;/li>
&lt;li>&lt;code>--realm&lt;/code>: æŒ‡å®š TURN server å°æ‡‰çš„ domain nameï¼Œæç¤º client è¦æ¡ç”¨å°æ‡‰çš„é©—è­‰æ–¹å¼&lt;/li>
&lt;li>&lt;code>--external-ip&lt;/code>: æŒ‡å®š external ipï¼Œåœ¨ Coturn æ–‡ä»¶å¯«åˆ°ï¼Œå¦‚æœæ˜¯åœ¨ AWS EC2 ä¸Šæ¶è¨­ external-ip åªè¦æŒ‡å®š public ic&lt;/li>
&lt;/ol>
&lt;p>è¨˜å¾—è¦å»å°‡ç¶å®š domain name A record æŒ‡å‘ AWS instance&lt;/p>
&lt;p>æ¥è‘—ï¼Œæœ‰å¹¾ç¨®æ¸¬è©¦æ–¹æ³•&lt;/p>
&lt;h4 id="1-ä½¿ç”¨-coturn-è‡ªå¸¶çš„-test-tool">1. ä½¿ç”¨ Coturn è‡ªå¸¶çš„ test tool&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ turnutils_uclient -T &amp;lt;server ip&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ turnutils_stunclient &amp;lt;server ip&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¬¬ä¸€å€‹æœƒå˜—è©¦å‚³é€å°åŒ…ï¼Œå¯ä»¥çœ‹ packet çš„ loss rate æ˜¯å¦ç‚º 0 /&lt;br>
ç¬¬äºŒå€‹æœƒå›å‚³ä¸»æ©Ÿ public ip (å¦‚æœå‰é¢æ²’æœ‰ NAT çš„è©±)ï¼Œä¹Ÿå°±æ˜¯ STUN æœ€ä¸»è¦çš„åŠŸç”¨&lt;/p>
&lt;h4 id="2-ç”¨ç€è¦½å™¨é–‹å•Ÿ-webrtc-samples-trickle-ice">2. ç”¨ç€è¦½å™¨é–‹å•Ÿ WebRTC samples Trickle ICE&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200922/trickle-ice.png"
loading="lazy"
>&lt;br>
è¼¸å…¥ server domain æ™‚è¨˜å¾—è¦åŠ  &lt;code>turn:{domain name}&lt;/code>ï¼Œå°±å¯ä»¥æˆåŠŸæ‹¿åˆ° STUN (srflx) / TURN (relay) çš„ç´€éŒ„&lt;/p>
&lt;p>æ¸¬è©¦äº†ä¸€ä¸‹ï¼ŒChrome / Firefox ä¸æ”¯æ´ no auth è¨­å®šï¼ŒChrome ä¸æ”¯æ´ ip based çš„ server&lt;/p>
&lt;p>é€™æ¨£å°±å®Œæˆç¬¬ä¸€æ­¥çš„è¨­å®šèˆ‡æ¸¬è©¦ï¼Œæ¥è‘—çœ‹ Coturn çš„å®Œæ•´ä»‹ç´¹èˆ‡è¨­å®š&lt;/p>
&lt;h2 id="è¨­å®šæª”">è¨­å®šæª”&lt;/h2>
&lt;p>è¨­å®šæª”çš„é è¨­è·¯å¾‘ç‚º &lt;code>/etc/turnserver.conf&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ç­‰ç­‰æœƒä¿®æ”¹çš„æ–‡ä»¶ï¼Œå¯ä»¥æ”¾åœ¨å…¶ä»–åœ°æ–¹ç”¨ cmd æŒ‡å®š&lt;br>
ä¹Ÿå¯ä»¥å¾ç¶²è·¯ä¸Šçœ‹åˆ°å®˜æ–¹çš„é è¨­è¨­å®šæª” &lt;a class="link" href="https://raw.githubusercontent.com/coturn/coturn/master/examples/etc/turnserver.conf" target="_blank" rel="noopener"
># Coturn TURN SERVER configuration file&lt;/a>&lt;/p>
&lt;h3 id="é©—è­‰">é©—è­‰&lt;/h3>
&lt;p>STUN çš„è²»ç”¨å¾ˆä¾¿å®œï¼Œåªæœ‰ç°¡å–®çš„ request / responseï¼Œä½†æ˜¯ TURN å°±éå¸¸è²´ï¼Œå› ç‚ºè¦å›æ”¾(Relay) P2P çš„ media streamï¼Œæ‰€ä»¥ Bandwidth ç›¸ç•¶é©šäººï¼Œé€™æ™‚å€™å°±éœ€è¦åŠ ä¸Šå¸³è™Ÿå¯†ç¢¼çš„æª¢æŸ¥&lt;/p>
&lt;p>TURN æ”¯æ´å…©ç¨®æ¨¡å¼ï¼Œå»ºè­°æ˜¯å…©è€…é¸å…¶ä¸­ä¸€è€…&lt;/p>
&lt;h4 id="long-term-credential">long term credential&lt;/h4>
&lt;p>é•·æœŸæ†‘è­‰å±¬æ–¼éœæ…‹é¡å‹ï¼Œä¹Ÿå°±æ˜¯ Client / Server å…±ç”¨å›ºå®šçš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¾‹å¦‚ä¸Šè¿°çš„ hello:world&lt;br>
åœ¨è¨­å®šæª”ä¸­&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">lt-cred-mech
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">user&lt;/span>&lt;span class="o">=&lt;/span>hello:world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">user&lt;/span>&lt;span class="o">=&lt;/span>hello2:world2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="short-term-credential">short term credential&lt;/h4>
&lt;p>å¦‚æœå¸Œæœ›ç™¼çµ¦ Client çŸ­æœŸçš„æ†‘è­‰ï¼Œæˆ–æ˜¯å¸Œæœ›å¤šä¸€å±¤æˆæ¬Šçš„æµç¨‹ä¾‹å¦‚å¾ API Server çµ¦äºˆç­‰ç­‰ï¼Œå¯ä»¥ä½¿ç”¨çŸ­æœŸæ†‘è­‰&lt;/p>
&lt;p>TURN å¯¦ä½œçš„æ–¹å¼æ˜¯ Client / Server å…±äº«ä¸€å€‹å›ºå®šçš„ secret keyï¼Œæ¥è‘—ä½¿ç”¨ &lt;code>HMAC_SHA1 å°‡ username hashed&lt;/code>ï¼Œusername çš„å‰åŠæ®µæ˜¯ unix timestamp&lt;br>
æ‰€ä»¥ TURN server æ”¶åˆ°å¾Œï¼Œå¾ username å¯ä»¥çœ‹å‡ºéæœŸæ™‚é–“ï¼Œé€é HMAC_SHA1 å¯ä»¥ç¢ºä¿æ˜¯ç”±åˆæ³•çš„ Client æ‰€é€å‡º&lt;br>
è¨­å®šæª”å¯«æ³•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">use-auth-secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">static-auth-secret&lt;span class="o">={&lt;/span>secret&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Nodejs ç‰ˆæœ¬çš„ç”¢ç”Ÿè¦å‰‡å¦‚ä¸‹ï¼Œåƒè€ƒè‡ª &lt;a class="link" href="https://stackoverflow.com/questions/35766382/coturn-how-to-use-turn-rest-api/35767224#35767224" target="_blank" rel="noopener"
>CoTURN: How to use TURN REST API?&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">crypto&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;crypto&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// name éš¨ä¾¿å¡«æ²’æœ‰é—œä¿‚
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="nx">getTURNCredentials&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">secret&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">unixTimeStamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">parseInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Date&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">24&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">3600&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// this credential would be valid for the next 24 hours
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">unixTimeStamp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">password&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hmac&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">crypto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createHmac&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sha1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">secret&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hmac&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setEncoding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;base64&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hmac&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">username&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hmac&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">end&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">hmac&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">read&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">username&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">username&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">password&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">password&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ç¶²è·¯è¨­å®š">ç¶²è·¯è¨­å®š&lt;/h3>
&lt;p>ç¶²è·¯è¨­å®šå°±æ”¾åœ¨ä¸€å¡Šçœ‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">external-ip&lt;span class="o">=&lt;/span>&amp;lt;public ip&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fingerprint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">realm&lt;/span>&lt;span class="o">=&lt;/span>turn.yuanchieh.page
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šæ˜¯å¿…é ˆè¨­å®šçš„åƒæ•¸&lt;/p>
&lt;ol>
&lt;li>external-ip:&lt;br>
TURN server çš„ public ipï¼Œçœ‹æ–‡ä»¶å®Œæ•´çš„è¨­å®šæ˜¯ &lt;code>external-ip=&amp;lt;public ip&amp;gt;/&amp;lt;private ip&amp;gt;&lt;/code>ï¼Œä½†å› ç‚ºåœ¨ AWS ä¸Š EC2 è™•æ–¼ NAT ä¹‹å¾Œï¼Œæ‰€ä»¥åªèƒ½æ”¾ public ip&lt;/li>
&lt;li>fingerprint:&lt;br>
ä¸»è¦æ˜¯ TURN Server ç”¨ä¾†å€åˆ† packetï¼Œå¾ŒçºŒçš„ Spec æœƒæœ‰æ›´è©³ç´°ä»‹ç´¹&lt;/li>
&lt;li>realm:&lt;br>
è¨­å®šç‚ºè‡ªå·±æŒ‡å‘ TURN Server çš„ domain nameï¼Œæ–‡ä»¶è¡¨ç¤º TURN Server å¯ä»¥æŒ‡å®šå¤šå€‹ realmï¼Œæ¯å€‹ realm æœ‰å„è‡ªçš„ user æ¬Šé™ç®¡ç†ï¼ŒClient è¡¨æ˜æ‰€å±¬çš„ realm å°±èƒ½ç”¨å°æ‡‰çš„ user æª¢æŸ¥&lt;/li>
&lt;/ol>
&lt;p>å…¶é¤˜é‚„æœ‰éå¸¸å¤šçš„è¨­å®šï¼Œä¾‹å¦‚èªª&lt;/p>
&lt;ol>
&lt;li>æ˜¯å¦è¦é–‹æ”¾ UDP / TCP / DTLS / stun-only&lt;/li>
&lt;li>è¨­å®šä¸åŒçš„ port / port ranage&lt;/li>
&lt;li>æŒ‡å®šçš„ DB / Log ç­‰ç­‰&lt;/li>
&lt;li>æ¯æ¬¡é€£ç·š session çš„æ™‚é•· / æ¯å€‹ user çš„é€£ç·š quota ç­‰ç­‰ &lt;br>
é€™äº›ç´°éƒ¨çš„è¨­å®šå¯ä»¥åœ¨æ…¢æ…¢çœ‹æˆ–æ˜¯ä¿ç•™é è¨­å³å¯&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹æ˜¯æˆ‘æ¸¬è©¦éæˆåŠŸçš„è¨­å®šæª”&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">external-ip&lt;span class="o">=&lt;/span>52.72.33.185
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">verbose
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fingerprint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">use-auth-secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">static-auth-secret&lt;span class="o">=&lt;/span>north
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">realm&lt;/span>&lt;span class="o">=&lt;/span>turn.yuanchieh.page
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å•Ÿå‹• turnserver æ™‚é€é &lt;code>-c&lt;/code> æŒ‡å®š turnserver.conf çš„ä½ç½®ï¼Œå®Œæˆå¾Œå»ºè­°åœ¨ä½¿ç”¨æ¸¬è©¦å·¥å…·æ¸¬è©¦é&lt;/p>
&lt;h2 id="sample-code">Sample Code&lt;/h2>
&lt;p>ç‚ºäº†æ›´æ–¹ä¾¿æ¸¬è©¦ TURN Serverï¼Œè‡ªå·±å¯«äº†ä¸€å€‹ Sample Code &lt;a class="link" href="https://github.com/sj82516/webrtc-turn-server-test" target="_blank" rel="noopener"
>Connection through self-hosted TURN server&lt;/a>ï¼Œæˆ–æ˜¯ç›´æ¥çœ‹ Demo Page &lt;a class="link" href="https://webrtc-turn-server-test.vercel.app/" target="_blank" rel="noopener"
>https://webrtc-turn-server-test.vercel.app/&lt;/a>ï¼Œè¼¸å…¥å°æ‡‰çš„å¸³è™Ÿå¯†ç¢¼ï¼Œæœƒä¸»å‹•ç”Ÿæˆå°æ‡‰çš„ iceServers&lt;/p>
&lt;h2 id="go-to-production">Go To Production&lt;/h2>
&lt;p>æº–å‚™ä¸Šæ­£å¼ç’°å¢ƒæ™‚ï¼Œé‚„æœ‰ç›£æ§ä»¥åŠå¯ç”¨æ€§çš„èª¿æ•´&lt;/p>
&lt;h3 id="ç›£æ§">ç›£æ§&lt;/h3>
&lt;p>2020/12/04æ›´æ–°ï¼šç›®å‰ 4.5.2 å¯ä»¥æ”¯æ´ &lt;code>prometheus&lt;/code> å›‰ï¼Œå¯æ˜¯åªæœ‰æ”¯æ´ Debianï¼Œå…¶ä»–å¹³å°å°šæœªæ”¯æ´ï¼Œå¦å¤–è¦æ³¨æ„ç›´æ¥ç”¨ &lt;code>apt-get install coturn ç‰ˆæœ¬ç›®å‰æ˜¯ä¸æ”¯æ´ prometheusï¼Œéœ€è¦è‡ªå·±æ‰‹å‹•ç·¨è­¯å–”&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Version 4.5.2 &lt;span class="s1">&amp;#39;dan Eider&amp;#39;&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - fix null pointer dereference in &lt;span class="k">case&lt;/span> of out of memory. &lt;span class="o">(&lt;/span>thanks to Thomas Moeller &lt;span class="k">for&lt;/span> the report&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - merge PR &lt;span class="c1">#517 (by wolmi)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * add prometheus metrics
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>Warning: æ’°æ–‡æ™‚é–‹å•Ÿ prometheus æœƒæœ‰è¨˜æ†¶é«”å•é¡Œï¼Œå»ºè­°å…ˆä¸è¦ä½¿ç”¨å–”ï¼Œè©³è¦‹ github issue &lt;a class="link" href="https://github.com/coturn/coturn/issues/666" target="_blank" rel="noopener"
>https://github.com/coturn/coturn/issues/666&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;del>çœ‹åˆ°æ–‡ä»¶çš„ç¯„ä¾‹ä»¥åŠè¨­å®šæª”æ”¯æ´ &lt;code>prometheus&lt;/code> é€™å¥—é–‹æºçš„ç›£æ§å·¥å…·ï¼Œä½†å¯æƒœå¯¦æ¸¬ä¸‹ä¾†æš«æ™‚ç„¡æ³•ä½¿ç”¨(4.5.1.2)ï¼Œé›–ç„¶èªªæœ‰ç›¸é—œçš„ branch å·²ç¶“ merged ä½†æ˜¯ Issue é‚„æ˜¯é–‹è‘— &lt;a class="link" href="https://github.com/coturn/coturn/issues/474" target="_blank" rel="noopener"
>support export metrics to prometheus #474&lt;/a>&lt;/del>&lt;/p>
&lt;h3 id="å¯ç”¨æ€§">å¯ç”¨æ€§&lt;/h3>
&lt;p>å¦‚æœåªæœ‰å–®å° TURN server æ›æ‰å°è‡´æœå‹™ä¸­æ–·å°±å¾ˆæ…˜äº†ï¼Œå®˜æ–¹æœ‰å¹¾å€‹å¯ç”¨æ€§/Load Balance ä½œæ³•&lt;/p>
&lt;ol>
&lt;li>TCP Level LB Proxy:&lt;br>
éœ€æ³¨æ„å¦‚æœæœ‰ä½¿ç”¨ TURN åŠŸèƒ½ï¼Œå¿…é ˆç¢ºä¿åŒä¸€å€‹ Client æŒçºŒé€£åˆ°åŒä¸€å° TURN Serverï¼Œå¦å‰‡æ™®é€šçš„ TCP LB å³å¯&lt;/li>
&lt;li>DNS:&lt;br>
é€é DNS Round-Robin ç´€éŒ„ï¼Œè®“ Client é€£åˆ°å°æ‡‰çš„ TURN Server&lt;/li>
&lt;li>å…§å»ºçš„ ALTERNATE-SERVER:&lt;br>
éœ€è¦åœ¨æ‰€æœ‰çš„ TURN Server ä¹‹å‰å»ºä¸€å° LBï¼Œé€™å° LB æŒ‰ç…§æµé‡å›çµ¦ Client ALTERNATE-SERVER çš„éŒ¯èª¤ï¼ŒClient å°±æœƒæŒ‰ç…§æŒ‡å®šçš„ Server å»èµ°ï¼Œé”åˆ° LB çš„æ•ˆæœ&lt;/li>
&lt;/ol>
&lt;p>çœ‹ä¾†çœ‹å»ï¼Œæ¡ç”¨ DNS æ¯”è¼ƒæ–¹ä¾¿ï¼ŒAWS Route53 æ”¯æ´å®šæœŸæª¢æŸ¥ Server ç‹€æ…‹ï¼Œåªæœƒå›å‚³å¥åº·çš„ Serverï¼ŒåŒæ™‚èƒ½æ¡ç”¨ Latency based æˆ–æ˜¯ Region based çš„ DNS ç´€éŒ„ï¼Œè®“å…¨çƒéƒ¨ç½²æ›´åŠ æ–¹ä¾¿&lt;/p>
&lt;h2 id="nat-ä»‹ç´¹èˆ‡-stunturn-ä½¿ç”¨">NAT ä»‹ç´¹èˆ‡ STUN/TURN ä½¿ç”¨&lt;/h2>
&lt;p>å…ˆå‰æœ‰æåˆ°å› ç‚º NAT é—œä¿‚ï¼Œæ‰€ä»¥è¦å»ºç«‹ P2P é€£ç·šæœƒéœ€è¦ STUN Server çš„å¹«åŠ©ï¼Œä½†æœ‰ä¸€ç¨® NAT æ˜¯å¿…é ˆé€é TURN Serverï¼Œä»¥ä¸‹è§£é‡‹é€™éƒ¨åˆ†çš„ç‹€æ³&lt;/p>
&lt;p>&lt;a class="link" href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2" target="_blank" rel="noopener"
>Wiki NAT ç¶²è·¯ä½å€è½‰æ›&lt;/a>&lt;br>
&lt;a class="link" href="https://blog.csdn.net/eydwyz/article/details/87364157" target="_blank" rel="noopener"
>NATçš„å››ç§ç±»å‹&lt;/a>&lt;/p>
&lt;p>ç°¡å–®æ•´ç†ä¸Šé¢æ–‡ä¸­çš„é‡é»&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ClientA &lt;span class="o">(&lt;/span>192.168.9.1:3000&lt;span class="o">)&lt;/span> ---&amp;gt; NAT &lt;span class="o">(&lt;/span>8.8.8.8:800&lt;span class="o">)&lt;/span> ---&amp;gt; Server1 &lt;span class="o">(&lt;/span>1.1.1.1:1000&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ClientA é å…ˆèˆ‡ Server1 å–å¾—é€£ç·šï¼Œæ­¤æ™‚å‡è¨­ Server2 (2.2.2.2) æƒ³è¦å¾ (8.8.8.8:800) é€è³‡æ–™çµ¦ ClientB&lt;/p>
&lt;ol>
&lt;li>å®Œå…¨åœ“éŒå‹NAT &lt;br>
å…è¨±&lt;/li>
&lt;li>å—é™åœ“éŒå‹NAT &lt;br>
å¿…é ˆ ClientA ä¹Ÿé€éè«‹æ±‚çµ¦ Server2 (2.2.2.2)æ‰å¯ä»¥&lt;/li>
&lt;li>åŸ å—é™åœ“éŒå‹NAT &lt;br>
å¿…é ˆ ClientA ä¹Ÿé€éè«‹æ±‚çµ¦ Server2 (2.2.2.2:1000)æ‰å¯ä»¥ï¼Œç›¸è¼ƒæ–¼ä¸Šè€… Port å¿…é ˆå›ºå®š&lt;/li>
&lt;li>å°ç¨±NAT&lt;br>
ä¸å…è¨±&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥åœ¨ WebRTC ä¸‹ï¼Œå¦‚æœ Client åœ¨å®Œå…¨åœ“éŒå‹NATï¼Œä»»ä¸€æ–¹ç™¼è«‹é€£ç·šéƒ½å¯ä»¥ï¼›&lt;br>
å¦‚æœæ˜¯åœ¨äºŒã€ä¸‰ç¨®ï¼Œå‰‡ Client å¿…é ˆé›™æ–¹åŒæ™‚ç™¼é€è«‹æ±‚ï¼Œæ‰ç¬¦åˆ NAT è½‰ç™¼æ¢ä»¶ï¼›&lt;br>
ç¬¬å››ç¨®å‰‡ä¸å…è¨±ç›´æ¥çš„ P2P&lt;/p></description></item><item><title>ã€Šä¸€åƒé›¶ä¸€å€‹é»å­ä¹‹å¾Œï¼šNETFLIXå‰µå§‹çš„ç¥•å¯†ã€‹é–±è®€å¿ƒå¾—</title><link>https://yuanchieh.page/posts/2020/2020-09-17-%E4%B8%80%E5%8D%83%E9%9B%B6%E4%B8%80%E5%80%8B%E9%BB%9E%E5%AD%90%E4%B9%8B%E5%BE%8Cnetflix%E5%89%B5%E5%A7%8B%E7%9A%84%E7%A5%95%E5%AF%86%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/</link><pubDate>Thu, 17 Sep 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-09-17-%E4%B8%80%E5%8D%83%E9%9B%B6%E4%B8%80%E5%80%8B%E9%BB%9E%E5%AD%90%E4%B9%8B%E5%BE%8Cnetflix%E5%89%B5%E5%A7%8B%E7%9A%84%E7%A5%95%E5%AF%86%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/</guid><description>&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200917/netflix.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>æ¯å®¶çŸ¥åçš„å·¨é ­ï¼Œéƒ½æœ‰åŒ…è£å¾Œæ¼‚äº®çš„ã€Œå…¬é—œã€å‰µæ¥­æ•…äº‹ï¼Œåƒæ˜¯ Netflix å°±æ˜¯å‰µè¾¦äºº Reed Hastings å»ç™¾è¦–é”ç§Ÿç‰‡å› ç‚ºæ™šé‚„è¢«ç½°éŒ¢ï¼Œæ†¤è€Œå‰µè¾¦çš„æ•…äº‹&lt;br>
é€™å€‹æ•…äº‹çš„åŒ…è£æ˜¯å› ç‚ºç•¶æ™‚ Netflix è¢«ç™¾è¦–é”æ‹’çµ•æ”¶è³¼å¾Œï¼Œç‚ºäº†ç°¡æ½”ã€æœ‰å¸å¼•åŠ›é †ä¾¿æ¨éŠ·è‡ªå®¶ç”¢å“ç‰¹è‰² (æ²’æœ‰é²é‚„ç½°æ¬¾) æ‰€ç·¨é€ çš„ï¼Œé€™ç¢ºå¯¦æ˜¯å€‹å¾ˆæ£’çš„è…³æœ¬ï¼Œä½†çœŸå¯¦çš„å‰µæ¥­æ•…äº‹é æ¯”é€™ä¸€å°æ®µç²¾å½©çš„å¾ˆå¤š&lt;/p>
&lt;p>é€™æœ¬æ›¸æœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼ï¼Œä½œè€… Marc Randolph é‰…ç´°å½Œéºåœ°å¾é»å­ç™¼æƒ³åˆ°å‰µè¾¦å‰ç·Šé‘¼å¯†é¼“çš„ç±ŒåŠƒï¼Œå…¬å¸ç¶“æ­·å¤šæ¬¡ Pivot çµ‚æ–¼æ‘¸ç´¢å‡ºè‡ªå·±çš„ä¸€å¥—å•†æ¥­æ¨¡å¼ï¼Œæè¿°çš„æ–¹å¼é€£ç•¶å¤©åƒä»€éº¼ / è·Ÿå®¶äººçš„äº’å‹• / èˆ‡å…¬å¸æˆå“¡çš„å°è©±ç­‰éƒ½æ’°å¯«ä¸‹ä¾†ï¼Œè®“äººèº«æ­·å…¶ç¶“è·Ÿè‘— Neflix ä¸€èµ·èµ°éé‚£ä¸€æ®µæ­²æœˆçš„æ„Ÿè¦ºï¼Œä½†åˆä¸æœƒæ’ˆå¨åˆ°å¦‚æ—¥è¨˜èˆ¬çš„ç‘£ç¢&lt;/p>
&lt;p>ä»¥ä¸‹é‡é»æ•´ç†å¹¾é»å€‹äººè¦ºå¾—å¾ˆç²¾å½©çš„éƒ¨åˆ†&lt;/p>
&lt;h2 id="ä¸€åƒé›¶ä¸€å€‹é»å­">ä¸€åƒé›¶ä¸€å€‹é»å­&lt;/h2>
&lt;p>Marc å› ç‚ºå…¬å¸è¢«æ”¶è³¼è€Œèˆ‡ Reed æ‰€å…±äº‹ï¼Œå› ç‚ºå…¬å¸è¦è·‘è¡Œæ”¿æµç¨‹ï¼Œå…©äººæ¥ä¸‹ä¾†æ•¸å€‹æœˆéƒ½ç„¡æ‰€äº‹äº‹ï¼Œåœ¨æ¯å¤©é€šå‹¤è·¯ä¸Šï¼ŒMarc æœƒä¸æ–·åœ°ä¸Ÿå‡ºæ–°é»å­èˆ‡ Reed è¨è«–ï¼Œã€Œå®¢è£½åŒ–æ£’çƒæ£ã€/ ã€Œéƒµå¯„æ´—é«®ç²¾ã€ï¼ŒMarc æ“…é•· Marketing / æŒ–æ˜æ–°é»å­ï¼Œè€Œ Reed å‰‡æ˜¯æœ‰ç†æ€§ä¸”æœ‰é‚è¼¯çš„åˆ†ææ¯ä¸€å€‹é»å­ï¼Œä¸€è·¯ä¸Šå…©äººä¸æ–·çš„çˆ­åŸ·ã€æŒçºŒæ¿€ç›ªæ–°çš„æƒ³æ³•&lt;/p>
&lt;blockquote>
&lt;p>æ¯ä¸€å€‹å¥½é»å­çš„èƒŒå¾Œéƒ½æœ‰å †ç©å¦‚å±±çš„çˆ›é»å­ï¼Œç”šè‡³æœ‰æ™‚å€™å¥½é»å­å‡ºç¾æ™‚ä½ é‚„ç„¡æ³•å¯Ÿè¦º&lt;/p>
&lt;/blockquote>
&lt;p>å¾Œä¾† Marc åœ¨æ¯ä¸€å¤œè¦å“„å°å­©ç¡è¦ºæ™‚ï¼Œæ‹¿èµ·ä¾†éŒ„å½±å¸¶ã€Šé˜¿æ‹‰ä¸ã€‹ï¼Œè·Ÿ Reed è¨è«–æ™‚æ­£å¥½ä»–è¢«ç™¾è¦–é”å‘äº† 40 ç¾é‡‘ï¼Œåœ¨å¤šå€‹çˆ›é»å­è½Ÿç‚¸ä¸‹ï¼Œé€™ä¼¼ä¹æ˜¯ä¸€å€‹æœ‰å‰æ™¯çš„é»å­&lt;/p>
&lt;p>Marc æ¥è‘—çµ„ç¹”åœ˜éšŠï¼Œé–‹å§‹æƒ³å¦‚ä½•æ‰“é€ ã€Œéƒµå¯„å‡ºç§ŸéŒ„å½±å¸¶ã€äº‹æ¥­ï¼Œè·Ÿåœ˜éšŠè¨è«–å¾Œç™¼ç¾ï¼Œç‚ºäº†æ–¹ä¾¿ç”¨æˆ¶ï¼Œå…¬å¸è¦è² æ“”ä¾†å›çš„éƒµè²» / åŒ…æç­‰ï¼Œç®—ä¸€ç®—æˆæœ¬é«˜çš„é©šäººï¼Œç¶“éè©¦ç®—å¾Œå¿…é ˆè¦å‡ºç§Ÿä¸€ç™¾æ¬¡æ‰æœ‰è¾¦æ³•é‚„æœ¬ï¼Œé€™æ ¹æœ¬å°±è¡Œä¸é€š&lt;/p>
&lt;p>ä½†æ˜¯ç•¶æ™‚(1997å¹´)æ–°çš„å½±éŸ³æ ¼å¼ DVD å³å°‡å•ä¸–ï¼Œæ‰­è½‰äº†éŒ„å½±å¸¶æ‰€é€ æˆçš„å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>ä¸€å¼µè–„å¦‚ CD çš„é«”ç©èˆ‡é‡é‡&lt;/li>
&lt;li>åŠ ä¸Šä¹‹å‰å» å•†å› ç‚ºè¦æ ¼ä¹‹äº‚ &lt;a class="link" href="https://zh.wikipedia.org/zh-tw/%E5%BD%95%E5%83%8F%E5%B8%A6%E6%A0%BC%E5%BC%8F%E6%88%98" target="_blank" rel="noopener"
>wiki: éŒ„å½±æ©Ÿæ ¼å¼æˆ°&lt;/a>ï¼Œæ‰€ä»¥å¤§å®¶æ¯”è¼ƒé¡˜æ„çµ„ç¹”è¯ç›Ÿéµå¾ªåŒä¸€å¥—è¦ç¯„&lt;/li>
&lt;li>åª’é«”ç”¢æ¥­èƒŒæ™¯çš„æ­·å²å› ç´ ï¼Œå¥½èŠå¡¢ç­‰å¨›æ¨‚ç”¢æ¥­ä¸æ»¿ç™¾è¦–é”å£Ÿæ–·ç§Ÿç‰‡å¸‚å ´ï¼ŒDVD é è¨ˆç™¼è¡Œçš„åƒ¹æ ¼æ˜¯éŒ„å½±å¸¶çš„ 1/5&lt;br>
ç¬é–“è®“éƒµå¯„å‡ºç§Ÿ DVD é€™å€‹é»å­å¯è¡Œ&lt;/li>
&lt;/ol>
&lt;p>é›–èªª DVD å‰æ™¯çœ‹èµ·ä¾†å¾ˆèª˜äººï¼Œå›æº¯æ™‚ç©ºç•¶æ™‚é‚„æ˜¯æ¥µç‚ºå°çœ¾çš„å¸‚å ´ï¼Œç”šè‡³ Marc å’Œ Reed éƒ½æ²’çœ‹é DVDï¼Œä½† Marc æ¥µåŠ›èªªæœ Reedï¼Œæœ€å¾Œå…©äººè³­èªªã€Œå¦‚æœéƒµå¯„ CD å¯ä»¥æˆåŠŸã€ï¼Œä»–å€‘å°±èªçœŸè€ƒæ…®é–‹å…¬å¸åšéƒµå¯„ DVD çš„ç”Ÿæ„&lt;/p>
&lt;h2 id="èšé›†é ‚å°–äººæ‰ä¸¦æ”¾æ‰‹è®“ä»–å€‘ç™¼æ®">èšé›†é ‚å°–äººæ‰ä¸¦æ”¾æ‰‹è®“ä»–å€‘ç™¼æ®&lt;/h2>
&lt;p>&lt;code>ã€ŒçœŸæ­£çš„å‰µæ–°ï¼Œä¸æœƒä¾†è‡ªç”±ä¸Šè€Œä¸‹çš„ç™¼è™Ÿæ–½ä»¤ï¼Œä¹Ÿä¸æœƒä¾†è‡ªå®šç¾©ç‹¹éš˜çš„ä»»å‹™ã€‚ä½ è¦é›‡ç”¨ä¸€ç¾¤å°ˆæ³¨æ–¼å¤§ç›®æ¨™çš„å‰µæ–°è€…ï¼Œä»–å€‘æœ‰è¾¦æ³•æ‰¾å‡ºè‡ªå·±èº«è™•ä½•æ–¹ï¼Œè‘—æ‰‹è§£æ±ºå•é¡Œã€&lt;/code>
ç›´æ¥å¾æ›¸ä¸­æ‘˜éŒ„é€™ä¸€æ®µï¼Œæç¹ªäº† Marc æœ€ä¸€é–‹å§‹å»ºç«‹åœ˜éšŠèˆ‡é‹ç‡Ÿçš„æ–¹å‘ï¼Œæ”¾æ‰‹è®“å°ˆæ¥­çš„äººæ‰å»è‡ªç”±ç™¼æ®ï¼ŒMarc åªæŠ“ä½å¤§æ–¹å‘ï¼Œä¸¦æŒçºŒæ‰¾å°‹å¤–éƒ¨åˆä½œæ©Ÿæœƒï¼Œä¾‹å¦‚èˆ‡ç´¢å°¼ / æ±èŠè«‡åˆä½œï¼Œé€™å…©å®¶æ˜¯ç•¶æ™‚è²©å”® DVD æ’­æ”¾å™¨çš„å¤§å» ï¼Œæ¨å‡ºäº†è²·æ–°æ©Ÿå…è²»ç§Ÿç‰‡çš„è¡ŒéŠ·æ–¹æ¡ˆ&lt;/p>
&lt;p>å›é¡§ Marc æœ¬äººçš„ç”Ÿå‘½ç¶“æ­·èˆ‡ç”Ÿæ´»å“²å­¸ï¼Œä»–ååˆ†é‡è¦–ä»¥å‰åœ¨é‡å¤–æ±‚ç”Ÿçš„è¨“ç·´ï¼Œåœ¨é‡å¤–æ”€å²© / æº¯æºª / ç™»å±±æ™‚ï¼Œä½ å¿…é ˆç’°é¡§æ•´å€‹ç’°å¢ƒï¼Œæ‰¾å‡ºä»»ä½•å¯èƒ½ç™¼ç”Ÿæ„å¤–çš„åœ°æ–¹ä¸¦è¨­æƒ³å¦‚ä½•è™•ç†ï¼ŒåŒæ™‚è¦ä¸æ–·åœ¨æ²’æœ‰æ˜ç¢ºæ–¹å‘ã€æ··äº‚çš„ç¾å¯¦ä¸­æŒçºŒå¾€ç›®æ¨™é‚é€²&lt;/p>
&lt;p>å°±åƒæ˜¯ Netflix åœ¨ä¸Šç·šå‰çš„æº–å‚™ï¼Œä»–å€‘ä¸æ–·çš„æ”¹è‰¯åŒ…è£ / å›éƒµçš„æ–¹å¼ï¼›å€‰å„²äººå“¡æŒçºŒæ‰¾å‡ºå¦‚ä½•æœ‰æ•ˆç®¡ç†åº«å­˜ã€æ‰¾å‡ºæ¯ä¸€å®¶éƒµå±€çš„æœ€çŸ­è·¯å¾‘èˆ‡å¯„é€æ™‚é–“ï¼›å…§å®¹ç‡Ÿé‹äººå“¡å»å„å¤§ DVD è«–å£‡è‡¥åº•æŒçºŒæ¨æ’­è¨Šæ¯ï¼Œæ‰€æœ‰äººéƒ½ç·Šé‘¼å¯†é¼“æº–å‚™æœå‹™ä¸Šç·šçš„é‚£ä¸€åˆ»&lt;/p>
&lt;p>æ™‚é–“å¿«è½‰åˆ°æœå‹™å³å°‡ä¸Šç·šçš„å‰ä¸€åˆ» (1997/4/14)ï¼Œä¼ºæœå™¨éƒ½æ¶è¨­å®Œæˆï¼Œé€£æ¥äº†ä¸€å€‹å°éˆ´éºå¦‚æœæœ‰è¨‚å–®é€²ä¾†å°±æœƒè²éŸ¿ï¼Œç­‰åˆ°ä¹é»é˜ä¸€ä¸Šç·šï¼Œã€Œéˆ´éˆ´éˆ´ã€æœå‹™æ¯”æƒ³åƒä¸­ç«ç†±ï¼Œä¼ºæœå™¨éäº†ä¸€å€‹å°æ™‚å°±æ”¯æ’ä¸ä½ï¼ŒIT äººå“¡ä¸æ–·å¾€è¨ªå¤§è³£å ´çµ„å»ºæ–°çš„ä¼ºæœå™¨ï¼Œæ‰€æœ‰äººæ—¢ç·Šå¼µå»åˆæ„Ÿåˆ°æ¬£æ…°ï¼Œéƒµå¯„ DVD é€™é–€ç”Ÿæ„è¡Œå¾—é€š!&lt;br>
å› ç‚ºç”Ÿæ„æ¯”æƒ³åƒä¸­ç«çˆ†ï¼Œé€™æ™‚å€™å€‰å„²äººå“¡å…ˆå‰ç ”ç©¶çš„å„å¤§éƒµå±€é—œé–€æ™‚é–“èˆ‡æœ€çŸ­è·¯å¾‘å°±éå¸¸é‡è¦ï¼ŒæŠŠè¦åšçš„ç´°ç¯€éƒ½å¯¦éš›çš„æ¸¬è©¦/èª¿æ•´éæ‰èƒ½æ‡‰ä»˜å„ç¨®çªç™¼çš„ç‹€æ³&lt;/p>
&lt;h2 id="pivot-pivot-åœ¨-pivot">Pivot Pivot åœ¨ Pivot&lt;/h2>
&lt;p>é€™ä¸€æ®µ Pivot çš„è½‰æŠ˜ååˆ†ç²¾å½©ï¼Œæ•£è½åœ¨æ™‚é–“è»¸çš„ä¸åŒéƒ¨ä½ï¼ŒNetflix é›–èªªä¸€é–‹å§‹æ˜¯æ‰“ç®—éƒµå¯„å‡ºç§Ÿ DVDï¼Œä½†æ˜¯æœ€ä¸€é–‹å§‹çš„ç‡Ÿæ”¶é«˜é” 9 æˆéƒ½æ˜¯ä¾†è‡ªè²©å”®ï¼Œè€Œéå‡ºç§Ÿï¼Œä»–å€‘å°±æ˜¯æä¸æ‡‚ç‚ºä»€éº¼ç”¨æˆ¶ä¸æœƒæƒ³è¦æŒçºŒçš„ç§Ÿå€Ÿï¼›&lt;br>
é›ªä¸ŠåŠ éœœçš„æ˜¯ï¼ŒAmazon å‰äº›é™£å­æ‰ä¸Šå¸‚ï¼Œæ‰¾ä¸Š Netflix å¸Œæœ›è«‡ä½µè³¼ï¼Œäºé¦¬éœä¸æ»¿è¶³æ–¼ç·šä¸Šè³£æ›¸è€Œå·²ï¼Œè€Œæ˜¯å¸Œæœ›è·¨è¶³æˆç‚ºå…¨éƒ½è³£çš„é›»å•†å¹³å°ï¼Œä¸è«–ä½µè³¼æ˜¯å¦æˆåŠŸï¼ŒAmazon éƒ½æ±ºå¿ƒè¸å…¥ DVD ç·šä¸Šè²©å”®çš„å¸‚å ´ï¼Œå° Netflix æœƒæ˜¯ä¸€å€‹éå¸¸å¤§çš„æ‰“æ“Š&lt;/p>
&lt;p>å¾Œä¾† Marc è·Ÿ Reed å› ç‚ºæ”¶è³¼åƒ¹æ ¼å¤ªä½ï¼Œæ‰€ä»¥æ‹’çµ•äº† Amazon çš„é‚€è«‹ï¼Œä½†å…©äººæ„è­˜åˆ°å…¬å¸å±åœ¨æ—¦å¤•ï¼Œæ‰€ä»¥å¿ƒä¸€æ©«æŠŠè²©å”®çš„äº‹æ¥­åœæ­¢ï¼Œå°ˆå¿ƒåšå‡ºç§Ÿï¼Œæ­¤æ™‚å‡ºç§Ÿçš„äº‹æ¥­é›·åŒç·šä¸Šç‰ˆçš„ç™¾è¦–é”ï¼Œä¸€æ¨£æœƒæ”¶å–é²é‚„ç½°æ¬¾&lt;/p>
&lt;blockquote>
&lt;p>åŠ æ‹¿å¤§åŸå‰‡&lt;/p>
&lt;/blockquote>
&lt;p>é€™æ˜¯ Netflix æ—©æœŸåšå•†æ¥­æ±ºç­–æ™‚çš„é‡è¦ä¾æ“šï¼Œä»–å€‘æœ€ä¸€é–‹å§‹åªå°ˆæ³¨æ–¼ç¾åœ‹å¸‚å ´ï¼Œä½†å¾Œä¾†èª¿æŸ¥å¦‚æœå¢åŠ åŠ æ‹¿å¤§ï¼Œå¯ä»¥ç«‹åˆ»å¤šä¸€æˆçš„æ”¶å…¥ï¼Œä½†æ˜¯å¾Œä¾†æƒ³äº†æƒ³ï¼Œå› ç‚ºé‚„æœƒæœ‰æ³•è¦ / éƒµå¯„é™åˆ¶ / èªè¨€ (åŠ æ‹¿å¤§æœ‰æ³•èªå€)ï¼Œä»–å€‘æ±ºå®š&lt;code>åªå°ˆæ³¨æ–¼ä¸€ä»¶äº‹æƒ…ä¸Š&lt;/code>ï¼Œæ‰€ä»¥å°±ç¨±ç‚ºã€ŒåŠ æ‹¿å¤§åŸå‰‡ã€&lt;/p>
&lt;p>å‡ºç§Ÿèˆ‡è²©å”® DVD çš„äº‹æ¥­ä¹Ÿæ˜¯ï¼Œé›–èªªæœ‰ Amazon é€™å€‹å¤–æ•µå­˜åœ¨ï¼Œä½†ä»–å€‘å…§éƒ¨æ—©å·²å†è¨è«–å…©ç¨®å•†æ¥­æ¨¡å¼çš„å–æ¨ï¼Œç¾å…¶åèƒ½æ»¿è¶³æ›´å¤šå…ƒç”¨æˆ¶çš„éœ€æ±‚ï¼Œä½†ä¹Ÿç„¡å½¢ä¸­è®“ç”¨æˆ¶æ›´åŠ çš„å›°æƒ‘&lt;/p>
&lt;p>å‰²æ¨æ‰è²©å”® DVD å¾Œï¼ŒNetflix æŒçºŒçš„ç‡’éŒ¢ï¼Œç”¨æˆ¶ä¼¼ä¹å‡ºç§Ÿéä¸€æ¬¡å°±ä¸æƒ³ç§Ÿç¬¬äºŒæ¬¡ï¼ŒMarc èˆ‡ä»–çš„åœ˜éšŠæŒçºŒæƒ³å•é¡Œåœ¨ä»€éº¼åœ°æ–¹ï¼Œæœ€å¾Œä»–å€‘æƒ³å‡ºäº†ç¾ä»Š Netflix çš„å•†æ¥­æ¨¡å¼&lt;/p>
&lt;blockquote>
&lt;p>è¨‚é–±åˆ¶ + æ²’æœ‰é²é‚„ç½°æ¬¾ + ä¸æ–·é€åˆ°å®¶æœå‹™&lt;/p>
&lt;/blockquote>
&lt;p>æ¯ä¸€å€‹æœˆ 19.99 ç¾é‡‘ï¼Œä¸€æ¬¡å¯ä»¥ç§Ÿå››ç‰‡ï¼Œåœ¨ç¶²ç«™ä¸Šå¯ä»¥å»ºç«‹å¾…çœ‹æ¸…å–®ï¼Œæ¯é‚„ä¸€ç‰‡å°±ç«‹åˆ»é€ä¸‹ä¸€ç‰‡çµ¦ä½ ï¼Œæ²’æœ‰ä»»ä½•çš„é€€é‚„æœŸé™!&lt;/p>
&lt;p>é€™å€‹å•†æ¥­æ¨¡å¼å¾¹åº•å¼•çˆ†äº†ï¼Œç”¨æˆ¶æ„›æ­»é€™å€‹å•†æ¥­æ¨¡å¼ï¼Œåœ¨æ¨å‡ºç¬¬ä¸€å€‹æœˆå…è²»è©¦ç”¨å¾Œï¼Œè¿‘ä¹ä¹æˆçš„ç”¨æˆ¶æ¬¡æœˆçºŒè¨‚ï¼Œé€™å€‹æ¨¡å¼æ›´ç¬¦åˆä¸€èˆ¬äººçœ‹å½±ç‰‡çš„éœ€æ±‚&lt;/p>
&lt;p>é›–ç„¶æ‰¾åˆ°é©åˆçš„å•†æ¥­æ¨¡å¼ï¼Œä½†é‚„æ˜¯å¾ˆç‡’éŒ¢ï¼Œå› ç‚ºæä¾›ç¬¬ä¸€å€‹æœˆå…è²»è©¦ç”¨ï¼Œæ‰€ä»¥å…¬å¸å¿…é ˆè² æ“”ç”¨æˆ¶ç¬¬ä¸€å€‹æœˆçš„ DVD / éƒµå¯„æˆæœ¬ï¼Œç¾é‡‘æµå£“åŠ›å¾ˆå¤§ï¼ŒMarc èˆ‡ Reed æ‰¾ä¸Šç™¾è¦–é”è«‡ä½µè³¼ï¼Œæœ€å¾Œç„¡ç–¾è€Œçµ‚ï¼ŒMarc åœ¨æ›¸æœ«é…¸äº†ç™¾è¦–é”ä¸€ä¸‹ :P&lt;/p>
&lt;p>åœ¨ç•¶æ™‚ 2000 å¹´åˆé‡åˆ° .com æ³¡æ²«å¾Œï¼Œç¶²è·¯æœå‹™çš„å‹Ÿè³‡æ¥µåº¦å›°é›£ï¼ŒNetflix ä¸å¾—å·²é–‹å§‹äº†ç¬¬ä¸€æ³¢çš„å¤§è£å“¡ï¼ŒåŒ…å«å¾ˆå¤šçš„å‰µå§‹åœ˜éšŠæˆå“¡çš„é›¢å»ï¼Œç¶“éçµ„ç¹”ç˜¦èº«å¾Œæ‰€æœ‰äººæ›´åŠ å°ˆæ³¨æ–¼ç›®æ¨™ä¸Šï¼›&lt;br>
åœ¨æ›¸çš„éç¨‹ä¸­ï¼ŒMarc æœ¬äººçš„æ¬Šåˆ©ä¹Ÿæ…¢æ…¢çš„è¢«å‰å¥ªï¼Œå…¶å¯¦ Marc æ‰æ˜¯ Netflix æœ€ä¸€é–‹å§‹çš„å‰µè¾¦äººï¼ŒReed å‡ºè³‡ä¸¦æ“”ä»»è‘£äº‹çš„è§’è‰²ï¼Œä½†å¾Œä¾† Reed å¦ç™½åœ°æŒ‡å‡º Marc ç¼ºå¤±ï¼Œæ”¹ç”± Reed å‡ºä»»åŸ·è¡Œé•·è®Šæˆé›™é¦–é•·åˆ¶ï¼Œå¾ŒçºŒ Marc åœ¨ä¸Šå¸‚å¾Œä¸€æ®µæ™‚é–“ï¼Œé›¢é–‹äº†å¾…ä¸ƒå¹´å¤šçš„ Netflix&lt;/p>
&lt;p>Marc å¾ˆå‹‡æ•¢åœ°æ‰¿èªè‡ªå·±çš„ä¸è¶³ï¼ŒReed ä¹Ÿå¾ˆèª å¯¦åœ°ä»¥å¥½å‹/è‘£äº‹çš„èº«ä»½ç›´æ¥æŒ‡å‡ºï¼Œæœ€å¾Œä¹Ÿåœ¨ä»–é ˜å°ä¸‹è®“ Netflix è®Šæˆå¸‚å€¼ä¸€åƒäº”ç™¾å„„ç¾å…ƒçš„å¤§å…¬å¸ï¼›&lt;br>
ä½†æ˜¯çœ‹åˆ°æ•´å€‹éç¨‹é‚„æ˜¯ä¸å‹å”å™“&lt;/p>
&lt;h2 id="that-will-never-work---nobady-knows-anything">That will never work -&amp;gt; Nobady knows anything&lt;/h2>
&lt;p>&lt;code>That will never work&lt;/code> æ˜¯åŸæ–‡æ›¸åï¼Œä»£è¡¨è‘—ç•¶åˆMarc çš„é»å­ä¸è¢«çœ¾äººçœ‹å¥½ï¼Œ&lt;code>Nobady knows anything&lt;/code> å‰‡æ˜¯ Marc çµ¦å‡ºçš„å›æ‡‰ï¼Œæ²’æœ‰äººçŸ¥é“ä»»ä½•äº‹ï¼Œåªæœ‰è©¦äº†æ‰çŸ¥é“&lt;/p>
&lt;p>é€™æœ¬æ›¸ååˆ†çš„ç²¾å½©ï¼Œéç¨‹æœ‰å¾ˆå¤šå‰µæ¥­çš„å°æ•…äº‹ï¼Œä¾‹å¦‚æœ€ä¸€é–‹å§‹ Netflix å«åš kibble (ç‹—é£Ÿ)ï¼Œèµ·å› æ˜¯ Marc å¥½å‹æ¨è–¦å…ˆå¹«å…¬å¸å–çš„çˆ›åå­—ï¼Œé€™æ¨£åˆ°æœå‹™å¿«ä¸Šç·šï¼Œå³ä½¿ä½ å¿™åˆ°ç„¦é ­çˆ›é¡ï¼Œçœ‹åˆ°åå­—é€™éº¼çˆ›æ‰æœƒæœ‰å‹•åŠ›å»æƒ³çœŸæ­£çš„å¥½åå­— /&lt;br>
ä»–å€‘æ›¾ç¶“æœ‰ä¸€æ¬¡ç©ºå‰çµ•å¾Œçš„å¥½æ©Ÿæœƒå»è¡ŒéŠ·ï¼Œçµæœä¸å°å¿ƒæŠŠ A ç‰‡å¯„çµ¦ç”¨æˆ¶ï¼Œåè€Œé€ æˆå¾ˆå¤§çš„å…¬é—œå±æ©Ÿï¼&lt;/p>
&lt;p>ååˆ†æ¨è–¦å–œæ­¡å‰µæ¥­ / å–®ç´”å° Netflix ç™¼è·¡ æœ‰èˆˆè¶£çš„æœ‹å‹å»è§€çœ‹&lt;/p></description></item><item><title>Elasticsearch æ•™å­¸ - API æ“ä½œ</title><link>https://yuanchieh.page/posts/2020/2020-07-15-elasticsearch-%E6%95%99%E5%AD%B8-api-%E6%93%8D%E4%BD%9C/</link><pubDate>Wed, 15 Jul 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-07-15-elasticsearch-%E6%95%99%E5%AD%B8-api-%E6%93%8D%E4%BD%9C/</guid><description>&lt;p>ä»¥ä¸‹å…§å®¹åŒ…å«åŸºæœ¬çš„ CRUD æ“ä½œï¼ŒElasticsearch æä¾›è‰¯å¥½çš„ REST API å‘¼å«ä»‹é¢ï¼Œä»¥ä¸‹æ¨¡æ“¬æƒ…å¢ƒç‚ºæ›¸åº—ï¼Œæ——ä¸‹æœ‰ amazon / eslite å¤šå®¶æ›¸åº—ï¼Œæ¯ä¸€æ›¸åº—å„²å­˜æ›¸æœ¬ç›¸é—œçš„è³‡æ–™ï¼Œå¦‚æ›¸åã€é æ•¸ã€ç°¡ä»‹ç­‰&lt;/p>
&lt;p>å¦å¤–é‚„æœ‰ä¸€äº›ç³»çµ±é…ç½®èˆ‡é€²éšåŠŸèƒ½ï¼Œçœ‹åˆ° Alias åŠŸèƒ½è¦ºå¾—ååˆ†æœ‰è¶£ï¼Œè®“ç¶­é‹æœ‰æ›´å¤šçš„å½ˆæ€§è·Ÿæ–¹æ³•å»èª¿æ•´è³‡æ–™å„²å­˜èˆ‡ç¡¬é«”æ¶æ§‹&lt;/p>
&lt;p>å¦‚æœæƒ³ä¹‹å‰æ¶æ§‹å±¤é¢ï¼Œå¯ä»¥åƒè€ƒ &lt;a class="link" href="https://yuanchieh.page/post/2020/2020-07-08_elasticsearch-%E4%BB%8B%E7%B4%B9%E8%88%87%E8%A9%95%E4%BC%B0/" target="_blank" rel="noopener"
>Elasticsearch ç³»çµ±ä»‹ç´¹èˆ‡è©•ä¼°&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>åŸºæœ¬åè©è§£é‡‹ï¼ŒIndex = MongoDB çš„ Collection / MySQL çš„ Tableï¼›
Document = MongoDB Document / MySQL Row&lt;/p>
&lt;/blockquote>
&lt;h2 id="åŸºæœ¬æ“ä½œ-crud">åŸºæœ¬æ“ä½œ CRUD&lt;/h2>
&lt;h3 id="å¸¸è¦‹çš„å›å‚³å€¼">å¸¸è¦‹çš„å›å‚³å€¼&lt;/h3>
&lt;p>ä¸è«–è«‹æ±‚æ˜¯å¦æˆåŠŸï¼Œé€šå¸¸æœƒè¿”å› _index / _type / _id / _version / _shard ç­‰è³‡è¨Š&lt;br>
&lt;code>_version&lt;/code> æ˜¯ç”¨ä¾†è¿½è¹¤ document è¢«æ”¹å‹•çš„æ¬¡æ•¸ï¼›&lt;br>
&lt;code>_found&lt;/code> ä»£è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨&lt;/p>
&lt;h3 id="å»ºç«‹">å»ºç«‹&lt;/h3>
&lt;ol>
&lt;li>å¦‚æœç³»çµ±å·²ç¶“æœ‰è¦åŠƒ _id&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/amazon/book/1?op_type&lt;span class="o">=&lt;/span>create
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>å¦‚æœæ²’æœ‰ _id å‰‡ç”± Elasticsearch ç”Ÿæˆï¼Œé è¨­ç”Ÿæˆçš„ &lt;code>_id æ˜¯ 22å­—å…ƒé•· + Base64 ç·¨ç¢¼ + URL åˆæ³•çš„å­—ä¸²&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XPOST http://localhost:9200/amazon/book
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åˆªé™¤">åˆªé™¤&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XDELETE http://localhost:9200/amazon/book/1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°å›å‚³å€¼ _version ä¹Ÿæœƒè¢«å¢åŠ &lt;/p>
&lt;h3 id="æ›´æ–°--éƒ¨åˆ†æ›´æ–°">æ›´æ–° / éƒ¨åˆ†æ›´æ–°&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/amazon/book/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// éƒ¨åˆ†æ›´æ–°
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -XPOST http://localhost:9200/amazon/book/1/_update
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å° Elasticsearch ä¾†èªªï¼Œæ‰€æœ‰çš„è³‡æ–™éƒ½æ˜¯ä¸å¯è®Šçš„ï¼Œæ‰€ä»¥æ›´æ–°å…¶å¯¦æ˜¯å»ºç«‹æ–°çš„æ–‡æª”ä¸¦åˆªé™¤èˆŠçš„&lt;/p>
&lt;p>å¦å¤–æœ‰å€‹å‹•è©æ˜¯ &lt;code>Indexing&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å»ºç«‹èˆ‡æ›´æ–°åˆåœ¨ä¸€èµ·ï¼Œæ²’æœ‰æ–‡æª”æ™‚å»ºç«‹ã€å­˜åœ¨æ™‚å°±æ›´æ–°&lt;/p>
&lt;h4 id="scripting">scripting&lt;/h4>
&lt;p>æœ‰æ™‚å€™æˆ‘å€‘æœƒå¸Œæœ›åŸºæ–¼ç¾æœ‰çš„ document æ¬„ä½é€²è¡Œæ›´æ–°ï¼Œä¾‹å¦‚èªªç€è¦½æ¬¡æ•¸ +1 ç­‰ç­‰çš„åŠŸèƒ½ï¼Œå¯ä»¥é€é scripting èªæ³•&lt;br>
å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl -XPOST curl http://localhost:9200/amazon/book/iVKeNXMBpRlP8dKifEma/_update -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-d &lt;span class="s1">&amp;#39;{ &amp;#34;script&amp;#34;: &amp;#34;ctx._source.page_num += 1&amp;#34; }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ Body ä¸­å¤¾å¸¶ &lt;code>script&lt;/code>ï¼Œä¸¦æŒ‡å®šæ¬„ä½èˆ‡æ“ä½œå³å¯ï¼Œåƒé€™é‚Šæˆ‘æ˜¯å°‡æ›¸ç±çš„é é¢ +1&lt;/p>
&lt;h4 id="upsert">upsert&lt;/h4>
&lt;p>æœ‰æ™‚å€™æ¬„ä½è¦æ›´æ–°æ™‚å¯èƒ½ä¸å­˜åœ¨ï¼Œå¯ä»¥é€é upsert æŒ‡å®šæ¬„ä½ä¸å­˜åœ¨æ™‚çš„è¡Œç‚º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;{ &amp;#34;script&amp;#34;: &amp;#34;ctx._source.page_num += 1&amp;#34;, &amp;#34;upsert&amp;#34;: { &amp;#34;page_num&amp;#34;: 100 } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ¨‚è§€é–èˆ‡-_version">æ¨‚è§€é–èˆ‡ _version&lt;/h3>
&lt;p>ç•¶æ¯æ¬¡æœ‰å¯«çš„æ“ä½œï¼Œdocument çš„ _version éƒ½æœƒè¢« +1ï¼Œé€™æ˜¯ç‚ºäº†å¯¦è¸æ¨‚è§€é–æä¾›åœ¨ä½µç™¼ç‹€æ³ä¸‹çš„ä¿è­·ï¼Œåœ¨æ‰€æœ‰çš„æ“ä½œä¸­å¯ä»¥åŠ å…¥ querystring &lt;code>?version=&lt;/code> ç¢ºä¿ç‰ˆè™Ÿ
ä¾‹å¦‚æˆ‘è¦æŸ¥æ‰¾ id=&amp;ldquo;iVKeNXMBpRlP8dKifEma&amp;rdquo; çš„æ›¸ç±ä¸”ç¢ºä¿æ˜¯ version 1&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/amazon/book/iVKeNXMBpRlP8dKifEma?version&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæœ‰å…¶ä»–äººå·²ç¶“æ›´å‹•éæ›¸ç±å°è‡´ version ä¸å†æ˜¯ 1ï¼Œæ­¤æ“ä½œæœƒæ‹‹å‡º &lt;code>409&lt;/code> éŒ¯èª¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;reason&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;[iVKeNXMBpRlP8dKifEma]: version conflict, current version [4] is different than the one provided [1]&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;index_uuid&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;gSaILK3KSH6UCpOeYBGKcQ&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;shard&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;index&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;amazon&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>,&lt;span class="s2">&amp;#34;status&amp;#34;&lt;/span>:409
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>Warningï¼šæ¨‚è§€é–åƒ…é©ç”¨æ–¼å–®æ–‡æª”æ›´æ–°ï¼ŒElasticsearch æ²’æœ‰ Transaction æ¦‚å¿µï¼Œæ‰€ä»¥æ²’æœ‰å¤šæ–‡æª”æ›´æ–°çš„ä¸€è‡´æ€§ä¿è­‰&lt;/p>
&lt;/blockquote>
&lt;h3 id="æŸ¥è©¢">æŸ¥è©¢&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XGET http://localhost:9200/amazon/book/1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæƒ³è¦é‡å°å¤šç­† document æŸ¥è©¢
éœ€æŒ‡å®šå¤šç­†çš„ index/type/idï¼Œå¦‚æœæŸä¸€å€‹æª”æ¡ˆä¸å­˜åœ¨å›å‚³å€¼å¾— _found å°±æœƒæ˜¯ false&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">è·¨ index æŸ¥è©¢
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/_mget -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-d &lt;span class="s1">&amp;#39;{ &amp;#34;docs&amp;#34;: [ { &amp;#34;_index&amp;#34;: &amp;#34;amazon&amp;#34;, &amp;#34;_type&amp;#34;: &amp;#34;book&amp;#34;, &amp;#34;_id&amp;#34;: 5 }, { &amp;#34;_index&amp;#34;: &amp;#34;amazon&amp;#34;, &amp;#34;_type&amp;#34;: &amp;#34;book&amp;#34;, &amp;#34;_id&amp;#34;: &amp;#34;iVKeNXMBpRlP8dKifEma&amp;#34; } ] }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">ä¹Ÿå¯ä»¥åœ¨åŒä¸€å€‹ index/type åº•ä¸‹æŸ¥è©¢ï¼Œåªè¦æ¨™æ³¨ id å°±å¥½
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">$ curl http://localhost:9200/amazon/book/_mget -H &amp;#39;&lt;/span>Content-Type: application/json&lt;span class="s1">&amp;#39; \
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">-d &amp;#39;&lt;/span>&lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;ids&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span> 1, &lt;span class="s2">&amp;#34;iVKeNXMBpRlP8dKifEma&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ‰¹æ¬¡å¯«å…¥æ“ä½œ">æ‰¹æ¬¡å¯«å…¥æ“ä½œ&lt;/h3>
&lt;p>å¦‚æœæˆ‘å€‘æƒ³è¦ä¸€æ¬¡å»ºç«‹å¤šå€‹æª”æ¡ˆï¼Œæˆ–æ˜¯åˆªé™¤ç­‰ï¼Œç”šè‡³æ˜¯æ··é›œå„ç¨®æŸ¥è©¢ä¸€æ¬¡æ€§å‘¼å«ï¼Œå¯ä»¥ä½¿ç”¨ batch&lt;br>
Elasticsearch åŸ·è¡Œ Batch æ™‚æœƒåŒæ™‚&lt;code>ç¨ç«‹è™•ç†ï¼Œçµæœä¹Ÿéœ€è¦å»å°æ‡‰çš„ Response æŸ¥è©¢&lt;/code>ï¼Œå¦‚æœæœ‰ Shard å°±æœƒåˆ†æ•£åˆ°å°æ‡‰çš„ Shard æœ€å¾Œå†æŠŠçµæœåˆä½µ
å¦‚æœæ“ä½œæ˜¯ create/index/update çš„è©±ï¼Œä¸‹ä¸€è¡Œæ˜¯æ”¾ document å…§å®¹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/_bulk -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-d $&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;_index&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;amazon&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;_type&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;book&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>: &lt;span class="m">2&lt;/span> &lt;span class="o">}&lt;/span>&lt;span class="se">\n&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;....&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;page_num&amp;#34;&lt;/span>:991,&lt;span class="s2">&amp;#34;publish_date&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2017/05/16&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;intro&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;....&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;delete&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;_index&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;amazon&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;_type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;book&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>: &lt;span class="m">5&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="o">}&lt;/span>&lt;span class="se">\n&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€æ³¨æ„ Body ä¸­æ˜¯ä»¥ &lt;code>\n&lt;/code> ç•¶ä½œæ–°çš„æŒ‡ä»¤é–‹å§‹ï¼Œä¸”&lt;code>æœ€å¾Œä¸€ç­†ç´€éŒ„ä¹Ÿè¦ä»¥ \n çµå°¾&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>ç‚ºä»€éº¼ Elasticsearch ä¸ç”¨ JSON Array ç•¶ä½œ Body å‘¢ï¼Ÿ&lt;br>
é€™æ˜¯å› ç‚ºå¦‚æœæ˜¯ Array çš„è©±ï¼ŒNode æ¥æ”¶åˆ°ä¹‹å¾Œé‚„è¦å»æ‹†è§£ Arrayï¼Œæ¥è‘—æ±ºå®šå“ªäº› Query æ˜¯å±¬æ–¼å“ªå€‹ Shard åœ¨åŒ…ä¸€å±¤ Arrayï¼›
ç›´æ¥ä½¿ç”¨ JSON Object åŠ ä¸Š \n å¯ä»¥ä¸ç”¨é¡å¤–çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œç”¨æ›è¡Œå­—ç¬¦æ‹†è§£ Query å°±å¥½ï¼Œç¯€çœè¨±å¤šä¸å¿…è¦é–‹éŠ·&lt;/p>
&lt;/blockquote>
&lt;h2 id="æœå°‹">æœå°‹&lt;/h2>
&lt;p>Elasticsearch åœ¨æœå°‹ä¸Šå½ˆæ€§å¾ˆå¤§ï¼Œå¯ä»¥è·¨ index / è·¨ type æœå°‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/_search
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŒ‡å®šæ¢ä»¶éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨ querystring æˆ–æ˜¯ Body å¤¾å¸¶ï¼Œæ¨è–¦å¾Œè€…å› ç‚ºå½ˆæ€§èˆ‡å¯ç¶­è­·æ€§æ›´é«˜&lt;/p>
&lt;h4 id="æŒ‡å®šæŸæ¬„ä½çš„æ¢ä»¶æœå°‹">æŒ‡å®šæŸæ¬„ä½çš„æ¢ä»¶æœå°‹&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/amazon/book/_search?q&lt;span class="o">=&lt;/span>name:Elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¨ &lt;code>q=${æ¬„ä½åç¨±}:${æ¢ä»¶}&lt;/code>ï¼Œå¦‚æœæœ‰å¤šç­†å‰‡ç”¨&lt;code>+&lt;/code>é€£çµ&lt;/p>
&lt;h4 id="æŸæ–‡æª”ä»»ä¸€æ¬„ä½ç¬¦åˆæ¢ä»¶æœå°‹">æŸæ–‡æª”ä»»ä¸€æ¬„ä½ç¬¦åˆæ¢ä»¶æœå°‹&lt;/h4>
&lt;p>åœ¨ Elasticsearch ä¸­ï¼Œæ¯å€‹æ–‡ä»¶éƒ½æœ‰ä¸€å€‹ç‰¹å‡ºæ¬„ä½ &lt;code>_all&lt;/code>ï¼Œä¹Ÿå°±æ˜¯æŠŠæ–‡ä»¶ä¸­æ‰€æœ‰çš„å­—ä¸²æ ¼å¼æ¬„ä½éƒ½æ‹¼æ¥èµ·ä¾†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/amazon/book/_search?q&lt;span class="o">=&lt;/span>Elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="mapping">Mapping&lt;/h3>
&lt;p>ç‚ºäº†æ›´å¥½çš„æ”¯æ´æœå°‹ï¼ŒElasticsearch åœ¨å¯«å…¥æ–‡ä»¶æ™‚æœƒæœ‰å»ºç«‹ Schemaï¼Œå¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤æŸ¥è©¢&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/amazon/_mapping
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‹åˆ¥æœ‰åˆ†æˆ text / number ç³»åˆ—(int, long) / date / boolean / object / geo_point ç­‰ç­‰ &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" target="_blank" rel="noopener"
>éå¸¸å¤šç¨®&lt;/a>&lt;br>
å¦‚æœæ¬„ä½æ˜¯ Arrayï¼Œå‰‡ä»¥ç¬¬ä¸€å€‹å…ƒç´ çš„å‹åˆ¥ç‚ºä¸»ï¼Œä¸”åŒä¸€ Array ä¸­å…ƒç´ å¿…é ˆéƒ½æ˜¯åŒå‹åˆ¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;amazon&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;intro&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;fields&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ignore_above&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">256&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;page_num&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;long&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;publish_date&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;date&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;format&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ä¸»å‹•é‡å° Index è¨­å®š Schema èˆ‡èª¿æ•´å‹åˆ¥è¨­å®šï¼Œä¾‹å¦‚èªªç´¢å¼•çš„æ·±åº¦èˆ‡æ•¸é‡ç­‰ï¼Œé è¨­ Elasticsearch æœƒæŠŠæ¯å€‹æ¬„ä½éƒ½å»ºç«‹ç´¢å¼•ï¼Œæ‰€ä»¥è¨˜æ†¶é«”æ¶ˆè€—éå¸¸é©šäºº&lt;/p>
&lt;blockquote>
&lt;p>Warning: å‹åˆ¥è¨­å®šå¾Œåªèƒ½æ–°å¢æ¬„ä½ï¼Œä¸èƒ½æ›´å‹•æ—¢æœ‰çš„å‹åˆ¥æˆ– Indexingï¼Œæœ€å¥½æ˜¯ä¸€é–‹å§‹å°±è¨­å®šå¥½ï¼Œä¸ç„¶è¦ ReIndex ï¼Œè©³è¦‹å¾ŒçºŒ&lt;/p>
&lt;/blockquote>
&lt;h3 id="å»ºç«‹-mapping">å»ºç«‹ Mapping&lt;/h3>
&lt;p>å…ˆåˆªé™¤ amazon Indexï¼Œé‡æ–°å»ºç«‹ Index èˆ‡ Mapping&lt;br>
å‡è¨­æˆ‘å¸Œæœ› page_num æ¬„ä½æ˜¯ Integer ä¸”ä¸è¦å»ºç«‹ç´¢å¼•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/amazon/_mapping -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --data &lt;span class="s1">&amp;#39;{ &amp;#34;properties&amp;#34;: { &amp;#34;page_num&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;integer&amp;#34;, &amp;#34;index&amp;#34;: false } } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡æ–°å°‡è³‡æ–™å¯«å…¥å¾Œï¼Œå…¶é¤˜çš„æ¬„ä½ Elasticsearch æœƒå¹«å¿™è£œä¸Šå‹åˆ¥ï¼Œpage_num å› ç‚ºå·²ç¶“å­˜åœ¨å‰‡ä¸æœƒæ”¹è®Š &lt;br>
éœ€è¦æ³¨æ„å¦‚æœ &lt;code>indexæŒ‡å®šfalse&lt;/code> å‰‡ä½¿ç”¨ &lt;code>/_search?q&lt;/code> æœƒç„¡æ³•æœå°‹&lt;/p>
&lt;h3 id="analyzer">Analyzer&lt;/h3>
&lt;p>å¦‚æœåªèƒ½é‡å°æ¢ä»¶åšç¯©é¸ï¼Œé€™ä¸€èˆ¬çš„è³‡æ–™åº«ä¹Ÿåšå¾—åˆ°ï¼ŒçœŸæ­£è®“ Elasticsearch å€åˆ¥æ–¼ä¸€èˆ¬è³‡æ–™åº«çš„åœ°æ–¹åœ¨æ–¼ Analyzer&lt;br>
æ¯å€‹æ–‡æª”çš„æ¬„ä½é™¤äº†å‹åˆ¥å®šç¾©èˆ‡ç´¢å¼•å¤–ï¼Œé‚„å¯ä»¥æŒ‡å®šè©²æ¬„ä½å¦‚ä½•è¢«åˆ†æï¼Œä¾‹å¦‚èªªæœ€åŸºæœ¬çš„&lt;code>æ–·è©&lt;/code> &amp;ldquo;ä¸­è¯æ°‘åœ‹&amp;rdquo; è¦æ‹†æˆ &amp;ldquo;ä¸­&amp;rdquo;ã€&amp;ldquo;è¯&amp;rdquo;ã€&amp;ldquo;æ°‘&amp;rdquo;ã€&amp;ldquo;åœ‹&amp;rdquo; é‚„æ˜¯ &amp;ldquo;ä¸­è¯&amp;rdquo;ã€&amp;ldquo;æ°‘åœ‹&amp;quot;ç­‰æœ‰å¤šç¨®æ–¹å¼ï¼Œæ±ºå®šå¦‚ä½•æ–·è©æœƒå½±éŸ¿æŸ¥è©¢&lt;br>
å¦å¤–åƒ&lt;code>èªæ„åˆ†æ&lt;/code>ï¼Œå¦‚æœæˆ‘å€‘æƒ³æœå°‹ã€ŒQuick fox jumpsã€ï¼Œæˆ‘å€‘ä¸å–®å¸Œæœ›å­—é¢ä¸Šå®Œå…¨ç¬¦åˆï¼Œè€Œæ˜¯æ‰¾åˆ°é¡ä¼¼ä¸‹è€…çš„æ–‡æª” &lt;code>A quick brown fox jumps over the lazy dog&lt;/code>&lt;/p>
&lt;p>æ‰€ä»¥ Analyzer ä¸»è¦åˆ†æˆä¸‰å€‹éƒ¨åˆ†&lt;/p>
&lt;ol>
&lt;li>&lt;code>character filter&lt;/code>&lt;br>
æ±ºå®šå­—å…ƒå¦‚ä½•è™•ç†ï¼Œåƒæ˜¯è½‰æ›æ•¸å­—æ ¼å¼ / å»é™¤ HTML tag ç­‰&lt;/li>
&lt;li>&lt;code>tokenizer&lt;/code>&lt;br>
æ±ºå®šå­—å…ƒå¦‚ä½•çµ„åˆæˆå­—ä¸²ï¼Œè‹±æ–‡é è¨­æ˜¯ç”¨ç©ºç™½ï¼Œæ¯å€‹ Analyzer ä¸€å®šä¹Ÿåªèƒ½æœ‰ä¸€å€‹ tokenizer&lt;/li>
&lt;li>&lt;code>token filter&lt;/code>&lt;br>
å°‡å­—ä¸²åšè™•ç†ï¼Œä¾‹å¦‚å…¨éƒ¨è½‰å°å¯« / éæ¿¾åŒç¾©è©ç­‰&lt;/li>
&lt;/ol>
&lt;h4 id="æ¸¬è©¦-analyzer">æ¸¬è©¦ Analyzer&lt;/h4>
&lt;p>å¦‚æœä¸çŸ¥é“è¦æ€éº¼é¸æ“‡ Analyzerï¼Œå¯ä»¥çœ‹æ–‡ä»¶æ‰¾å‡º&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" target="_blank" rel="noopener"
>å…§å»ºçš„ Analyzer&lt;/a>ä¸¦é€é API å»æ¸¬è©¦ï¼ŒæŒ‡å®šä¸åŒçš„ Analyzer èˆ‡æ¸¬è©¦å­—ä¸²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/_analyze -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --data &lt;span class="s1">&amp;#39;{ &amp;#34;analyzer&amp;#34;: &amp;#34;standard&amp;#34;, &amp;#34;text&amp;#34;:&amp;#34;this is a test&amp;#34; }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/_analyze -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> &lt;span class="se">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --data &lt;span class="s1">&amp;#39;{ &amp;#34;filter&amp;#34;: [&amp;#34;lowercase&amp;#34;], &amp;#34;char_filter&amp;#34; : [&amp;#34;html_strip&amp;#34;], &amp;#34;tokenizer&amp;#34;: &amp;#34;whitespace&amp;#34;, &amp;#34;text&amp;#34;:&amp;#34;this &amp;lt;a&amp;gt;iS&amp;lt;/a&amp;gt; A Test&amp;#34; }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°å›å‚³å€¼æ˜¯ Analyzer æœƒå¦‚ä½• parse å­—ä¸²ä¸¦ç”¢ç”Ÿç´¢å¼•çš„ keywordï¼Œæ›´å¤šçš„åƒæ•¸å¯ä»¥åƒè€ƒæ–‡ä»¶ &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-analyze.html" target="_blank" rel="noopener"
>Analyze API&lt;/a> &lt;br>
å¦‚æœéœ€è¦æ”¯æ´ä¸­æ–‡ï¼Œå‰‡éœ€è¦å¦å¤–å®‰è£ plugin&lt;/p>
&lt;h4 id="èª¿æ•´æ¬„ä½çš„-analyzer">èª¿æ•´æ¬„ä½çš„ Analyzer&lt;/h4>
&lt;p>å¯ä»¥åœ¨ Index ä¸‹å»ºç«‹å®¢è£½åŒ–çš„ Analyzerï¼Œä¾‹å¦‚æˆ‘å»ºç«‹ä¸€å€‹ &lt;code>my_intro_analyzer&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/amazon/_settings -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="s1">&amp;#39;{ &amp;#34;analysis&amp;#34;: { &amp;#34;analyzer&amp;#34;: { &amp;#34;my_intro_analyzer&amp;#34;: { &amp;#34;filter&amp;#34;: [&amp;#34;lowercase&amp;#34;], &amp;#34;char_filter&amp;#34; : [&amp;#34;html_strip&amp;#34;], &amp;#34;tokenizer&amp;#34;: &amp;#34;whitespace&amp;#34; } } } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€é Mapping API å»æ›´æ”¹æ¬„ä½çš„ Analyzerï¼ŒåŒæ¨£æ˜¯ä¸èƒ½æ›´æ”¹æ—¢æœ‰çš„ Indexï¼Œä¸”åªèƒ½æŒ‡å®š Analyzer è€Œä¸èƒ½åœ¨æ¬„ä½ä¸­è‡ªè¨‚ tokenizer ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/amazon -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;{ &amp;#34;mappings&amp;#34;: { &amp;#34;properties&amp;#34;: { &amp;#34;intro&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;text&amp;#34;, &amp;#34;analyzer&amp;#34;: &amp;#34;my_intro_analyzer&amp;#34; } } }, &amp;#34;settings&amp;#34;: { &amp;#34;analysis&amp;#34;: { &amp;#34;analyzer&amp;#34;: { &amp;#34;my_intro_analyzer&amp;#34;: { &amp;#34;filter&amp;#34;: [&amp;#34;lowercase&amp;#34;], &amp;#34;char_filter&amp;#34; : [&amp;#34;html_strip&amp;#34;], &amp;#34;tokenizer&amp;#34;: &amp;#34;whitespace&amp;#34; } } } } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>çœ‹èµ·ä¾† Indexing æ·±åº¦èˆ‡ Analyzer åˆ†æçš„ Token æ•¸éƒ½éœ€è¦è¨­å®šä¸Šé™ï¼Œå¦å‰‡é è¨­å€¼æœƒè®Šæˆè¨˜æ†¶é«”æ€ªç¸!&lt;/p>
&lt;/blockquote>
&lt;h2 id="dsl">DSL&lt;/h2>
&lt;p>å‰é¢æåˆ°æœå°‹æ™‚å¯ä»¥ç”¨ querystring åŠ ä¸Šæ¢ä»¶ï¼Œä½†ç‚ºäº†è¨­å®šæ›´è¤‡é›œä¸”å½ˆæ€§çš„æŸ¥è©¢èªæ³•ï¼Œå¯ä»¥ä½¿ç”¨ Elasticsearch è‡ªè¨‚çš„æŸ¥è©¢èªè¨€&lt;/p>
&lt;h3 id="query">Query&lt;/h3>
&lt;p>å¦‚æœä»Šå¤©æƒ³è¦æ‰¾æ¬„ä½ä¸­æ˜¯å¦æœ‰ç›¸è¿‘çš„å€¼ï¼Œå¯ä»¥ç”¨ &lt;code>match&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/amazon/_search -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="s1">&amp;#39;{ &amp;#34;query&amp;#34;: { &amp;#34;match&amp;#34;: { &amp;#34;name&amp;#34;: &amp;#34;Distributed&amp;#34; } } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="filter">Filter&lt;/h3>
&lt;p>å¦‚æœä»Šå¤©æƒ³è¦æ‰¾æ¬„ä½ä¸­å®Œå…¨ä¸€æ¨¡ä¸€æ¨£å€¼ï¼Œå¯ä»¥ç”¨ &lt;code>term&lt;/code> æ¥ç¯©é¸æ¢ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/amazon/_search -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="s1">&amp;#39;{ &amp;#34;query&amp;#34;: { &amp;#34;term&amp;#34;: { &amp;#34;name&amp;#34;: &amp;#34;Elasticsearch: The Definitive Guide: A Distributed Real-Time Search and Analytics Engine 1st Edition, Kindle Edition&amp;#34; } } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="çµ„åˆå¤šç¨®æ¢ä»¶">çµ„åˆå¤šç¨®æ¢ä»¶&lt;/h3>
&lt;p>å¦‚æœä»Šå¤©è¦æœå°‹çš„æ¢ä»¶æ¯”è¼ƒè¤‡é›œï¼Œä¾‹å¦‚èªªæˆ‘å¸Œæœ›&lt;code>åç¨±ä¸€å®šè¦åŒ…å« Distributed&lt;/code>ï¼Œé æ•¸&lt;code>æœ€å¥½&lt;/code>åœ¨200è‡³500é æˆ–æ˜¯å‡ºç‰ˆå¹´ä»½åœ¨ä»Šå¹´(ä½†å…©è€…å¿…é ˆè‡³å°‘ç¬¦åˆä¸€é …)&lt;br>
å¯ä»¥ç”¨ &lt;code>bool&lt;/code> æ­é… &lt;code>must&lt;/code> å¿…é ˆç¬¦åˆ + &lt;code>should&lt;/code> æ‡‰è©²ç¬¦åˆï¼Œæ­é… &lt;code>minimum_should_match&lt;/code> å¯ä»¥æ±ºå®šæ¢ä»¶çš„ç¬¦åˆç¨‹åº¦&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl http://localhost:9200/amazon/_search -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&lt;span class="s1">&amp;#39;{ &amp;#34;query&amp;#34;: { &amp;#34;bool&amp;#34;: { &amp;#34;must&amp;#34;: { &amp;#34;match&amp;#34;: { &amp;#34;name&amp;#34;: &amp;#34;Distributed&amp;#34; } }, &amp;#34;minimum_should_match&amp;#34;: 1, &amp;#34;should&amp;#34;: [ { &amp;#34;range&amp;#34;: { &amp;#34;page_num&amp;#34;: { &amp;#34;gt&amp;#34;: 200, &amp;#34;lt&amp;#34;: 500 } } }, { &amp;#34;range&amp;#34;: {&amp;#34;publish_date&amp;#34;: { &amp;#34;gt&amp;#34;: &amp;#34;2020/01/01&amp;#34; } } } ] } } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç³»çµ±é…ç½®èˆ‡è¨­å®š">ç³»çµ±é…ç½®èˆ‡è¨­å®š&lt;/h2>
&lt;h3 id="sharding-ç›¸é—œ">Sharding ç›¸é—œ&lt;/h3>
&lt;h4 id="1-è¨­å®š-index-çš„-sharding-èˆ‡-replica-æ•¸é‡">1. è¨­å®š Index çš„ sharding èˆ‡ replica æ•¸é‡&lt;/h4>
&lt;p>æœ‰å…©ç¨®æ–¹å¼ï¼Œä¸€ç¨®æ˜¯å»ºç«‹ Index æ™‚å°±æŒ‡å®šï¼Œç¬¬äºŒç¨®æ˜¯å»ºç«‹ Index å¾ŒçºŒèª¿æ•´&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">1. å»ºç«‹ Index æŒ‡å®š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -XPUT http://localhost:9200/amazon -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&lt;span class="s1">&amp;#39;{ &amp;#34;index&amp;#34;: { &amp;#34;number_of_shards&amp;#34;: 2, &amp;#34;number_of_replicas&amp;#34;: 0 } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. å¾ŒçºŒå‹•æ…‹èª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -XPUT http://localhost:9200/amazon/_settings -H &lt;span class="s1">&amp;#39;Content-Type: application/json&amp;#39;&lt;/span> --data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&lt;span class="s1">&amp;#39;{ &amp;#34;index&amp;#34;: { &amp;#34;number_of_replicas&amp;#34;: 0 } }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€æ³¨æ„ sharding number æœ€å¥½ä¸€é–‹å§‹å°±è¨­å®šå¥½ï¼Œå¯ä»¥é…ç½®ç¨å¾®å¤šä¸€é» Primary shard æ–¹ä¾¿å¾ŒçºŒ scale out&lt;br>
å¾ŒçºŒå¦‚æœè¦å‹•æ…‹èª¿æ•´å¾ˆéº»ç…©ï¼Œè¦æŠŠ Index è¨­æˆ read-only ä¸¦é€é Split API ä¿®æ”¹ / æˆ–æ˜¯ç”¨ Reindex æ–¹å¼é‡å»ºæ–°çš„ Index&lt;/p>
&lt;h4 id="2-æŒ‡å®š-index-ä½¿ç”¨çš„æ©Ÿå‹">2. æŒ‡å®š Index ä½¿ç”¨çš„æ©Ÿå‹&lt;/h4>
&lt;p>æœ‰æ™‚å€™æˆ‘å€‘æœƒå¸Œæœ›æŸäº›ç†±é–€çš„ Index ä½¿ç”¨è¼ƒå¥½çš„ç¡¬é«”ï¼Œå…¶ä»–å†·é–€çš„ä½¿ç”¨å·®ä¸€é»çš„ç¡¬é«”ï¼ŒElasticsearch åœ¨æ©Ÿå™¨é‹ä½œæ™‚å¯ä»¥æ‰“ä¸Šæ¨™è¨˜ &lt;code>--node.box_type&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ./bin/elasticsearch --node.box_type strong
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŒ‡å®š Index è¦å­˜æ”¾çš„æ©Ÿå‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ POST /logs_2014-09-30/_settings
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;index.routing.allocation.include.box_type&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;strong&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çµåˆå¾ŒçºŒçš„ Alias å¯ä»¥é…ç½®å‡ºæ›´ç¬¦åˆå¯¦éš›æ‡‰ç”¨çš„è¨­å®š&lt;/p>
&lt;h4 id="index-template">Index template&lt;/h4>
&lt;p>ç•¶å»ºç«‹æ–°çš„ Index æ™‚ï¼Œå¯ä»¥æŒ‡å®š template å¥—ç”¨è¨­å®šï¼Œå°±ä¸ç”¨æ¯æ¬¡éƒ½è¦æ‰“è¨­å®šï¼ŒElasticsearch åœ¨ 7.8 ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥æŒ‡å®š component template èˆ‡ index templateï¼›&lt;br>
component template æ˜¯å°å–®ä½å¯ä»¥è¢«ç”¨ä¾†çµ„åˆçš„ï¼›è€Œ index template å‰‡æ˜¯ Index ç›´æ¥å¥—ç”¨çš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">// Component template
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PUT _component_template/other_component_template
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;template&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;mappings&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;properties&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ip_address&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;ip&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// Index templateï¼Œåªè¦ Index é–‹é ­æ˜¯ bar å°±æœƒå¥—ç”¨
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PUT _index_template/template_1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;index_patterns&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;bar*&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;template&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;settings&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;number_of_shards&amp;#34;&lt;/span>: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;mappings&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;_source&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;enabled&amp;#34;&lt;/span>: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;properties&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;host_name&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;created_at&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;date&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;format&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;EEE MMM dd HH:mm:ss Z yyyy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;aliases&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;mydata&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;priority&amp;#34;&lt;/span>: 10,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;composed_of&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;component_template1&amp;#34;&lt;/span>, ....&lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;version&amp;#34;&lt;/span>: 3,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;_meta&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;my custom&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="reindex-èˆ‡-alias">Reindex èˆ‡ Alias&lt;/h3>
&lt;p>å…ˆä»‹ç´¹ &lt;code>Alias&lt;/code>ï¼Œçœ‹åˆ°é€™å€‹åŠŸèƒ½è®“æˆ‘è¦ºå¾—ååˆ†é©šè±”ï¼Œå¯ä»¥å°‡ç¶­é‹èˆ‡é–‹ç™¼æ‹†åˆ†çš„æ›´åŠ ç¨ç«‹&lt;br>
ä»Šå¤©å‡è¨­å› ç‚ºè³‡æ–™çš„æ ¼å¼å•é¡Œ / Sharding é‡æ–°åˆ†é…ç­‰å•é¡Œéœ€è¦&lt;code>Index éœ€è¦é‡å»º&lt;/code>ï¼ŒAlias å°±èƒ½æ´¾ä¸Šç”¨å ´&lt;/p>
&lt;p>ä»–çš„æ¦‚å¿µå°±å¥½åƒæª”æ¡ˆé€£çµï¼Œå¯ä»¥å–ä¸€å€‹é€£çµåç¨±ï¼Œä½†åŒæ™‚å°æ‡‰åˆ°å¤šå€‹å¯¦éš›çš„æª”æ¡ˆè·¯å¾‘ï¼Œä¾‹å¦‚èªªæˆ‘æœ‰å…©å€‹ Index æƒ³è¦åˆ†é–‹å„²å­˜ /amazon + /eslite&lt;br>
ä½†æˆ‘å¸Œæœ›æŸ¥è©¢æ™‚å¯ä»¥æœ‰ä¸€å€‹å…±åŒçš„ endpoint å–åå« /bookstoreï¼Œå°±å¯ä»¥ç”¨ Alias é€£çµ /amazon èˆ‡ /eslite&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/eslite/_alias/bookstore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -XPUT http://localhost:9200/amazon/_alias/bookstore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/boostore/_search
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// åŒæ™‚è¿”å› amazon / eslite åº•ä¸‹çš„æ–‡æª”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl http://localhost:9200/*/_alias/bookstore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æŸ¥è©¢å“ªäº› Index æœ‰è¨­å®š &lt;span class="nb">alias&lt;/span> ç‚º bookstore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -X DELETE http://localhost:9200/amazon/_alias/bookstore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// åˆªé™¤ &lt;span class="nb">alias&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é›–ç„¶æœå°‹çš„æ™‚å€™ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šå¤šå€‹ Index å¦‚ &lt;code>curl http://localhost:9200/amazon,eslite/_search&lt;/code>ï¼Œä½†å¦‚æœè¦å¢æ¸› Index é …ç›®å°±éœ€è¦æ”¹ç¨‹å¼ç¢¼ï¼Œååˆ†ä¸ä¹¾æ·¨&lt;/p>
&lt;p>å¦å¤–æ›´å¤§çš„å¥½è™•åœ¨æ–¼åŒä¸€å€‹ Index è¦å‡ç´šæ™‚ï¼Œå¯¦éš›å„²å­˜å¯ä»¥ç”¨ç‰ˆè™Ÿå¦‚ index_name_v1ï¼Œç”¨ alias æŒ‡å®š index_nameï¼›&lt;br>
æ¥è‘—åœ¨å»ºç«‹æ–°çš„ index_name_v2 æ›æˆæ–°çš„ Indexï¼Œå®Œæˆå¾Œåœ¨åˆ‡æ› index_name çš„æŒ‡å‘å°±èƒ½ zero downtime åˆ‡æ› index äº†&lt;/p>
&lt;blockquote>
&lt;p>æŸ¥è©¢æ™‚æŒ‡å®š alias å°±å¯ / å¯«å…¥æ™‚å¦‚æœ alias ä¸‹åªæœ‰ä¸€å€‹ index å°±ä¸ç”¨æŒ‡å®šï¼›è¶…éä¸€å€‹å¿…é ˆæŒ‡å®šå¯«å…¥çš„ index&lt;/p>
&lt;/blockquote>
&lt;h3 id="æ‹†åˆ†-index-èˆ‡-alias-æ‡‰ç”¨">æ‹†åˆ† Index èˆ‡ Alias æ‡‰ç”¨&lt;/h3>
&lt;p>å‡è¨­ä»Šå¤©æˆ‘å€‘æ‹¿ Elasticsearch ç•¶ä½œ Logging Serviceï¼Œé€šå¸¸æ˜¯è¶Šè¿‘æœŸçš„è³‡æ–™è¶Šç†±é–€ï¼Œæ™‚é–“ä¹…ä¹‹å¾ŒèˆŠè³‡æ–™å¯èƒ½è¦ç§»é™¤æˆ–è½‰å‡ºä¿å­˜&lt;br>
åœ¨ç³»çµ±è¨­è¨ˆä¸Šï¼Œæˆ‘å€‘è¦è€ƒé‡å¹¾å€‹é»&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>å„²å­˜æ™‚å€åˆ†æ–°è³‡æ–™èˆ‡èˆŠè³‡æ–™&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>æœå°‹æ™‚å¸Œæœ›æ–°è³‡æ–™èˆ‡éƒ¨åˆ†èˆŠè³‡æ–™éƒ½å¯ä»¥è¢«æŸ¥è©¢&lt;/li>
&lt;li>èˆŠè³‡æ–™çš„å®šæœŸåˆªé™¤èˆ‡å†·ä¿å­˜&lt;/li>
&lt;/ol>
&lt;p>æ›¸ä¸­å»ºè­°ï¼ŒLog ä¾ç…§æ™‚é–“å€é–“å»ºç«‹æ–°çš„ Indexï¼Œä¾‹å¦‚æ¯å€‹ä¾ç…§æ¯å€‹æœˆä»½å„²å­˜ &lt;code>2020-05&lt;/code> å°±å–®æ”¾äº”æœˆä»½çš„ Log&lt;br>
å»ºç«‹æ–°çš„ Index æ™‚å¯ä»¥é€é template ç¶å®šé è¨­å€¼ï¼Œå°±ä¸ç”¨æ¯æ¬¡éƒ½è¦æ‰‹å‹•é å…ˆå»ºç«‹ Index äº†&lt;br>
å‡è¨­æŸ¥è©¢æ™‚æœƒå¸Œæœ›æœå°‹è¿‘æœŸ 3 å€‹æœˆçš„è³‡æ–™ï¼Œèˆ‡å…¶æ¯æ¬¡éƒ½æŒ‡å®š 3 å€‹ Indexï¼Œå¯ä»¥é€é &lt;code>Alias&lt;/code> ç°¡åŒ–æŸ¥è©¢èªæ³•&lt;/p>
&lt;p>æ‹†åˆ†å¤šå€‹ Index å¥½è™•æ˜¯èª¿æ•´éå¸¸å½ˆæ€§ï¼Œä¾‹å¦‚èªªèˆŠçš„ Index å¯ä»¥&lt;code>å–æ¶ˆ Replica / ç§»åˆ°è¼ƒå·®çš„ç¡¬é«” / å–®ç¨å‚™ä»½ / æ•´å€‹ç æ‰(æ•ˆç‡é æ¯”ç  document å¥½)&lt;/code>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>ç¤™æ–¼ç¯‡å¹…ï¼Œå…¶ä»–é‚„æœ‰è™•ç†è‡ªç„¶èªè¨€ / åœ°ç†ä½ç½®è³‡æ–™ / å¯¦éš›ä¸Šç·šçš„æ³¨æ„äº‹é …ç­‰ç­‰é€²éšè­°é¡Œï¼Œåªèƒ½ç­‰ä¹‹å¾ŒçœŸçš„æœ‰ç”¨ä¸Šå†ä¾†åˆ†äº«&lt;/p></description></item><item><title>Elasticsearch ç³»çµ±ä»‹ç´¹èˆ‡è©•ä¼°</title><link>https://yuanchieh.page/posts/2020/2020-07-08-elasticsearch-%E7%B3%BB%E7%B5%B1%E4%BB%8B%E7%B4%B9%E8%88%87%E8%A9%95%E4%BC%B0/</link><pubDate>Wed, 08 Jul 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-07-08-elasticsearch-%E7%B3%BB%E7%B5%B1%E4%BB%8B%E7%B4%B9%E8%88%87%E8%A9%95%E4%BC%B0/</guid><description>&lt;p>æœ€è¿‘æœ‰ä¸€äº›è‡ªå»ºæœå°‹å¼•æ“çš„éœ€è¦ï¼Œæ‰€ä»¥æ‰¾ä¸Šäº† Elasticsearch é€™ä¸€å¥—é–‹æºçš„åˆ†æ•£å¼çš„ NoSQL Databaseï¼Œé€™ä¸€ç¯‡æ–‡ç« ä¸»è¦åˆ†äº«è‡ªå·±å¦‚ä½•è©•ä¼° Elasticsearchï¼Œè‘—é‡åœ¨ç³»çµ±çš„æ¶æ§‹èˆ‡å…§éƒ¨å¯¦ä½œæ©Ÿåˆ¶ï¼Œæ•™å­¸é è¨ˆæœƒæ‹‰åˆ°å¦å¤–ä¸€ç¯‡æ–‡ç« &lt;/p>
&lt;p>ä»¥ä¸‹å…§å®¹å¤§å¤šåƒè€ƒæ­¤æœ¬æ›¸ï¼š&lt;code>ã€ŠElasticsearch: The Definitive Guide: A Distributed Real-Time Search and Analytics Engineã€‹&lt;/code>ï¼Œé›–ç„¶æ˜¯ 2015 çš„æ›¸ï¼Œä½†å…§å®¹ç›¸ç•¶çš„è±å¯Œï¼Œé‚„æœ‰è±å¯Œçš„å…§éƒ¨å¯¦ä½œæ©Ÿåˆ¶/Clusteræ¶æ§‹ç­‰ç­‰çš„è£œå……ï¼Œé™¤äº† api æœ‰äº›åƒæ•¸è¦æ›´æ–°å¤–ï¼Œä¸æœƒå› ç‚ºæ™‚é–“è€ŒæŠ¹æ»…ä»–çš„åƒ¹å€¼ï¼ŒåŒ…å«äº†æœ‰è¶£çš„æµªæ¼«æ•…äº‹&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch åŸä½œè€…å…¶å¯¦æ˜¯ç‚ºäº†å¹«è€å©†å¯«ä¸€å€‹é£Ÿè­œæœå°‹å¼•æ“è€Œé–‹å§‹çš„ï¼Œä½†éäº†å¥½å¹¾å¹´ Elasticsearch éƒ½è®Šæˆå…¬å¸äº†ä½†è€å©†ä¾ç„¶é‚„æ²’æ‹¿åˆ°èªªå¥½çš„é£Ÿè­œæœå°‹å¼•æ“&amp;hellip;. (æˆªè‡³ 2015å¹´)&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200708/bookcover.jpg"
loading="lazy"
>&lt;/p>
&lt;h2 id="terminology-èˆ‡åŸºç¤ä»‹ç´¹">Terminology èˆ‡åŸºç¤ä»‹ç´¹&lt;/h2>
&lt;p>Elasticsearch æ˜¯å»ºæ§‹åœ¨ Lucene é€™å€‹ Java é–‹ç™¼çš„æœå°‹å¼•æ“ä¸Šï¼Œå¢åŠ äº†åˆ†æ•£å¼èˆ‡ API å‘¼å«çš„ä»‹é¢ï¼›&lt;br>
è³‡æ–™å±¤ç´šåˆ†æˆ &lt;code>Index &amp;gt; Document&lt;/code>ï¼Œæ¯å€‹ Index ç•¶ç¬¬ä¸€ç­† Document å»ºç«‹å¾Œæœƒæœ‰éš±å¼çš„æ¬„ä½å‹åˆ¥ï¼Œå¾ŒçºŒçš„ Document éƒ½è¦éµå®ˆå‹åˆ¥ï¼Œå…¶ä¸­ &lt;code>Index&lt;/code> é€™å€‹è©è »å®¹æ˜“èª¤æœƒï¼Œå› ç‚ºä»–é™¤äº†ä»£è¡¨æœ€ä¸Šå±¤çš„è³‡æ–™é›†åˆå¤–ï¼Œä¹Ÿä»£è¡¨ç´¢å¼•çš„åŒç¾©è©&lt;br>
Elasticsearch å„²å­˜æ™‚æ˜¯ç”¨ JSON æ ¼å¼ï¼Œå¯ä»¥å°æ¯å€‹æ¬„ä½è¨­å®šå‹åˆ¥ï¼ŒåŒæ™‚å¯ä»¥æŒ‡å®šæ˜¯å¦æ”¯æ´å…¨æ–‡æœå°‹&lt;br>
ç‚ºäº†æ”¯æ´å…¨æ–‡æœå°‹ï¼ŒElasticsearch ä½¿ç”¨ Reverted indexï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€å¼µè¡¨ç´€éŒ„ä¸€å€‹è©åœ¨å“ªäº› Document ä¸­çš„æ¬„ä½å‡ºç¾é&lt;/p>
&lt;blockquote>
&lt;p>Warning: åœ¨ 6.x.x ç‰ˆæ™‚ Elasticsearch ç§»é™¤äº† Type å±¤ç´šï¼Œä¸»è¦æ˜¯å› ç‚ºç•¶ä¸€å€‹ Index ä¸‹æœ‰å¤šå€‹ Typeï¼Œå‡è¨­å¤šå€‹ Type æœ‰ç›¸åŒåç¨±çš„æ¬„ä½ï¼Œå°æ–¼ Lucence ä¾†èªªæœƒæŠŠå…©å€‹ç›¸åŒåç¨±æ¬„ä½éƒ½ç•¶ä½œåŒä¸€å€‹ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦å…©å€‹ä¸åŒ Type ä¸­ç›¸åŒåç¨±æ¬„ä½è¨­å®šä¸åŒå‹åˆ¥æ˜¯æœƒæ‹‹å‡ºéŒ¯èª¤çš„ (ex. Index ä¸‹æœ‰ User / Twitter å…©å€‹ Typeï¼Œä¸”å…©å€‹ Type éƒ½æœ‰ user_nameï¼Œå‰‡ user_name å¿…é ˆæ˜¯ç›¸åŒå‹åˆ¥)ï¼Œæ‰€ä»¥ç¶“éè€ƒé‡å¾Œå°±ç§»é™¤äº†&lt;br>
åƒè€ƒæ–‡ä»¶ &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html" target="_blank" rel="noopener"
>Removal of mapping types&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨å»ºç«‹ç´¢å¼•æ™‚ï¼ŒElasticsearch æœƒå°‡æ¬„ä½ç¶“é &lt;code>Analyzer&lt;/code> è™•ç†ï¼Œä¹Ÿå°±æ˜¯ charaterizer -&amp;gt; tokenizer -&amp;gt; token filter&lt;br>
æ‰€ä»¥èƒ½å¤ æ”¯æ´åƒéæ¿¾ä»‹ç³»è© / å°‡æ–‡å­—è½‰æˆå°å¯«æˆ–æ˜¯åŒç¾©è©è½‰æ› / æ”¯æ´ä¸åŒèªè¨€çš„æ–·è©ç­‰éˆæ´»çš„èªè¨€è™•ç†æµç¨‹ï¼Œæ‰€ä»¥æ‰èƒ½å¤ æä¾›åˆ¥æ–¼ä¸€èˆ¬è³‡æ–™åº«æ­»æ¿çš„å…¨æ–‡æœå°‹&lt;/p>
&lt;p>åœ¨è³‡æ–™æ›´æ–°èˆ‡æŸ¥è©¢æ™‚ï¼ŒElasticsearch æä¾›è¿‘ä¹å³æ™‚çš„æ“ä½œï¼ŒåŒæ™‚æŸ¥è©¢æ”¯æ´ä¾ç…§æ¢ä»¶ç¯©é¸ (Filter) æˆ–æ˜¯ä¾æ“šé—œè¯åº¦æ’åº (Query)&lt;br>
å‰è€…åƒæ˜¯ &lt;code>çµ¦æˆ‘ id æ˜¯ 123 çš„è³‡æ–™&lt;/code>é€™é¡ yes/no å•é¡Œï¼›å¾Œè€…æ˜¯å›ç­” &lt;code>å¹«æˆ‘æ‰¾å‡ºè·Ÿ Mary ç›¸é—œçš„æ–‡æª”&lt;/code> é€™é¡æ¨¡ç³Šæœå°‹çš„çµæœ&lt;/p>
&lt;h3 id="æ¶æ§‹ä»‹ç´¹">æ¶æ§‹ä»‹ç´¹&lt;/h3>
&lt;p>Elasticsearch æ”¯æ´åˆ†æ•£å¼ï¼Œå¯ä»¥åœ¨ Index å±¤ç´šæŒ‡å®šè¦ Sharding é…ç½®æ–¹å¼ï¼ŒShard æœ‰å…©ç¨®è§’è‰² &lt;code>Primary / Replica&lt;/code>ï¼Œå‰è€…è² è²¬è®€å¯«è€Œå¾Œè€…è² è²¬å¾ Primary å‚™ä»½è³‡æ–™ä¸¦åˆ†æ•£è®€çš„æŸ¥è©¢ï¼Œæ¯ä¸€å€‹ Shard åŸ·è¡Œç¨ç«‹çš„ Luceneï¼Œå¯è¦–ç‚ºç¨ç«‹çš„ Worker
å³ä½¿åœ¨å–®æ©Ÿä¸Šè·‘ï¼ŒElasticsearch ä¹ŸæœƒæŒ‰ç…§é…ç½®ï¼Œå°‡è³‡æ–™æ‹†åˆ†å„²å­˜&lt;/p>
&lt;p>å¦‚æœ Cluster æ­¤æ™‚å¢åŠ æ©Ÿå™¨ï¼ŒElasticsearch æœƒ&lt;code>è‡ªå‹•å°‡ Shard åˆ†æ•£åˆ°å„å€‹ç¯€é»ä¸Š&lt;/code>ï¼Œå¦‚æœæœ‰ Replica å‰‡&lt;code>ç›¡å¯èƒ½åˆ†æ•£é¢¨éšªè®“æ¯å°æ©Ÿå™¨éƒ½æœ‰å‚™æ´è³‡æ–™&lt;/code> &lt;br>
Cluster ä¹‹é–“æœƒæœ‰ä¸€å€‹ Masterï¼ŒMaster ä¸»è¦ç®¡ç†æ•´å€‹ Cluster / åŠ å…¥ã€ç§»é™¤ç¯€é» / å»ºç«‹ Index ç­‰ï¼Œä¾‹å¦‚æŸ¥è©¢/å¯«å…¥éƒ½æ˜¯å€‹ç¯€é»èƒ½å¤ ç¨ç«‹å®Œæˆï¼Œæ‰€ä»¥ä¸éœ€è¦æ“”å¿ƒ Master æœƒæˆç‚ºç³»çµ±çš„ Single Point of Failure&lt;br>
ç¯€é»ç™¼ç”Ÿå•é¡Œï¼ŒCluster æœƒè‡ªå‹•ç¥¨é¸ Master ä¸¦é‡æ–°åšè³‡æ–™æ¬ç§»çš„å‹•ä½œ &lt;br>
å¯¦éš›ä¸Š Node æœ‰åˆ†å¾ˆå¤šé¡å‹ï¼Œåƒæ˜¯ Master Node è² è²¬ç®¡ç† Cluster / Data Node å„²å­˜è³‡æ–™ / Ingest Node é è™•ç†æµç¨‹ç­‰ç­‰&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200708/cluster.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="æœå‹™è©•ä¼°">æœå‹™è©•ä¼°&lt;/h2>
&lt;p>ä¸»è¦æ˜¯é‡å°å„ç¨®ç¶­é‹ä¸Šçš„é»é€²è¡Œè€ƒé‡ï¼Œçœ‹åˆ° &lt;code>åˆ†æ•£å¼&lt;/code>è³‡æ–™åº«éƒ½æœƒæœ‰ä¸‰å€‹ç‰¹é»&lt;/p>
&lt;ol>
&lt;li>&lt;code>**Replica**&lt;/code>: è³‡æ–™å¦‚ä½•å‚™æ´&lt;/li>
&lt;li>&lt;code>**Sharding**&lt;/code>: å¦‚ä½•æ‹†åˆ†è³‡æ–™é›†&lt;/li>
&lt;li>&lt;code>**Cluster**&lt;/code>: å¦‚ä½•æ°´å¹³æ“´å±•æ©Ÿå™¨&lt;/li>
&lt;/ol>
&lt;p>ä¸€èˆ¬ä¾†èªªåˆ†æ•£å¼è³‡æ–™åº«çš„ Replica éƒ½æ˜¯ç”± active slave æ“”ä»»ï¼Œå³æ™‚å‚™ä»½æ‰€æœ‰çš„æ›´æ–°ï¼ŒåŒæ™‚èƒ½å¤ æ”¯æ´è®€å–çš„åˆ†æ“”ï¼Œå„å®¶æä¾›çš„åŠŸèƒ½éƒ½å·®ä¸å¤šï¼›&lt;br>
è‡³æ–¼ Cluster / Sharding å‰‡å„å®¶è³‡æ–™åº«çš„å¯¦ä½œèˆ‡è€ƒé‡å„æœ‰ä¸åŒï¼ŒåŒæ™‚è€ƒé‡åˆ° &lt;code>CAP&lt;/code> åœ¨å¯ç”¨æ€§èˆ‡è³‡æ–™ä¸€è‡´æ€§ä¹‹é–“åšå–æ¨é€™æ˜¯æˆ‘è¦ºå¾—æœ€æœ‰è¶£çš„åœ°æ–¹&lt;/p>
&lt;p>å¯¦éš›è©•ä¼°ä¸Šæœƒå»æ€è€ƒä»¥ä¸‹å¹¾å€‹æ¡ˆä¾‹ï¼ŒåŒæ™‚ä»¥æˆ‘æ¯”è¼ƒç†Ÿæ‚‰çš„ MongoDB / Redis ä½œç‚ºå°æ¯”&lt;/p>
&lt;ol>
&lt;li>åŸºç¤è³‡æ–™åº«&lt;br>
a. å¯«è³‡æ–™æ™‚å¦‚ä½•ä¿è­‰ Durability&lt;br>
b. Concurrency ä¸‹çš„ Consistency ä¿è­‰æ˜¯ä»€éº¼&lt;/li>
&lt;li>Sharding&lt;br>
a. Sharding çš„ä¾æ“šæ˜¯ä»€éº¼ / æ˜¯å¦èƒ½å¤ å‹•æ…‹å¢æ¸› shard&lt;br>
b. Query å¦‚ä½• routing åˆ°æ­£ç¢ºçš„ shard ä¸Šé¢&lt;/li>
&lt;li>Cluster&lt;br>
a. Cluster åŸºæœ¬æ¶æ§‹è¦å¦‚ä½•æ­å»º&lt;br>
b. Cluster èª¿æ•´æ™‚éœ€è¦åšä»€éº¼æ”¹å‹•&lt;br>
c. Cluster å¢æ¸› node æ™‚æœƒæœ‰ä»€éº¼è®ŠåŒ–&lt;br>
d. Cluster åœ¨ä»€éº¼æƒ…æ³ä¸‹æœƒä¸å¯ç”¨&lt;/li>
&lt;/ol>
&lt;h3 id="åŸºç¤è³‡æ–™åº«">åŸºç¤è³‡æ–™åº«&lt;/h3>
&lt;h4 id="å¯«è³‡æ–™æ™‚å¦‚ä½•ä¿è­‰-durability">å¯«è³‡æ–™æ™‚å¦‚ä½•ä¿è­‰ Durability&lt;/h4>
&lt;p>Elasticsearch ç‚ºäº†å¹³è¡¡ Durability èˆ‡æ•ˆèƒ½ï¼Œæ‰€ä»¥ç•¶ Reverted Index å»ºç«‹å¾Œå°±æ˜¯ &lt;code>ä¸å¯è®Š immutable&lt;/code>çš„ï¼Œé€™æ¨£çš„å¥½è™•æ˜¯æ€§èƒ½å¸¶ä¾†å¾ˆå¤§çš„æå‡ï¼Œè³‡æ–™è¼‰å…¥ memory å¾Œä¸ç”¨æ“”å¿ƒæœƒè®Šå‹• / mulit thread ä¹Ÿä¸ç”¨æ“”å¿ƒè³‡æ–™éæœŸçš„å•é¡Œç­‰ç­‰&lt;br>
ä½†è³‡æ–™ä¸å¯é¿å…æœƒé‡åˆ°æ›´æ–°æˆ–åˆªé™¤çš„éœ€æ±‚ï¼Œæ‰€ä»¥ Elasticsearch æ¡ç”¨ Segment æ–¹å¼ï¼Œ&lt;code>æ¯æ¬¡å»ºç«‹ Index å¾Œå°±æ˜¯ä¸€å€‹ç¨ç«‹çš„ Segment&lt;/code>ï¼Œç´¯ç©ä¸€æ‰¹ä¿®æ”¹å¾Œåœ¨å»ºç«‹ä¸€å€‹æ–°çš„ Segment&lt;br>
æŸ¥è©¢è³‡æ–™æ™‚å°±åŒæ™‚æŸ¥æ‰¾å¤šå€‹ Segmentï¼Œå¦‚æœåŒç­†è³‡æ–™åœ¨å¤šå€‹ Segment éƒ½æœ‰ç´€éŒ„ï¼Œå‰‡æ¡å–æœ€æ–°ä¸€ç­†çš„è³‡æ–™&lt;/p>
&lt;p>å¯¦éš›çš„Elasticsearch å…§éƒ¨å„²å­˜æ©Ÿåˆ¶çš„æ–¹å¼åƒè€ƒä¸‹åœ–&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200708/design.png"
loading="lazy"
>&lt;/p>
&lt;p>å„²å­˜æ©Ÿåˆ¶å¦‚ä¸‹&lt;/p>
&lt;ol>
&lt;li>æ–°çš„ä¿®æ”¹ç”¢ç”Ÿï¼Œå¯«é€² in-memory buffer ä¸­ï¼Œæ­¤æ™‚è³‡æ–™ä¸èƒ½è¢«æœå°‹&lt;/li>
&lt;li>&lt;code>[Refresh]&lt;/code> å›ºå®šæ™‚é–“ refresh åˆ° file cache (ç°è‰²çš„ Segmentï¼Œä»£è¡¨é‚„æ²’çœŸæ­£å„²å­˜åˆ°ç¡¬ç¢Ÿä¸Š)ï¼Œæ­¤æ™‚è³‡æ–™å¯ä»¥è¢«æœå°‹ (é è¨­æ¯ 10ç§’)&lt;/li>
&lt;li>&lt;code>[Flush]&lt;/code> å›ºå®šæ™‚é–“ file cache é€é &lt;code>fsync&lt;/code> å¯«å…¥ç¡¬ç¢Ÿï¼Œæ­¤æ™‚æ‰æ˜¯çœŸæ­£çš„æŒä¹…åŒ– (é è¨­æ¯ 30åˆ†é˜æˆ–æ˜¯ Translogéå¤§æ™‚)&lt;/li>
&lt;li>æ¯æ¬¡ Flush æœƒç”¢ç”Ÿæ–°çš„ Segmentï¼Œä½†å¦‚æœ Segment å¤ªå¤šæœƒé€ æˆæª”æ¡ˆéå¤šæ€§èƒ½åè€Œä¸‹é™ï¼Œæœƒå›ºå®šæ™‚é–“åˆä½µå¤šå€‹ Segment&lt;br>
ä½†è¦å°å¿ƒ Segment åˆä½µæœƒåƒæ‰å¤§é‡çš„è¨˜æ†¶é«”èˆ‡ CPUï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½å¤ å¤ªé »ç¹ï¼Œå¯ä»¥æŒ‡å®š &lt;code>max_num_segments&lt;/code> åƒæ•¸&lt;/li>
&lt;li>Translog æ˜¯ç‚ºäº†ç¢ºä¿ 2~3 æ­¥é©Ÿå¦‚æœæ©Ÿå™¨ç™¼ç”Ÿå•é¡Œï¼Œå¯ä»¥é€é Translog å›å¾©è³‡æ–™&lt;br>
Translog å°‡æ¯ç­†æ“ä½œé †åºå¯«å…¥ç¡¬ç¢Ÿï¼Œç•¶ç¬¬ä¸‰æ­¥ flush å¾Œä¸€ä½µæ¸…ç©º&lt;br>
ä½† Translog æœ¬èº«ä¹Ÿæœ‰ fsync çš„é »ç‡ï¼Œé è¨­æ˜¯ 5 ç§’é˜ï¼Œæ‰€ä»¥æœ‰æ©Ÿæœƒ&lt;code>ä¸Ÿå¤± 5ç§’é˜å…§çš„è³‡æ–™&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>Redis åœ¨æŒä¹…åŒ–ä¿å­˜æœ‰åˆ† RDB èˆ‡ AOFï¼ŒRDB æ˜¯é€éä¿å­˜æ•´ä»½ Snapshot / AOF å‰‡æ˜¯å¯«å…¥æ¯ç­†æ“ä½œ log é è¨­æ¯ç§’ fsync åˆ°ç¡¬ç¢Ÿä¸Š&lt;/p>
&lt;h4 id="concurrency-ä¸‹çš„-consistency-ä¿è­‰æ˜¯ä»€éº¼">Concurrency ä¸‹çš„ Consistency ä¿è­‰æ˜¯ä»€éº¼&lt;/h4>
&lt;p>å° Elasticsearch é€²è¡Œå¯«å…¥æ“ä½œæ™‚ï¼Œé‡å° Request Level å¯ä»¥åšä¸åŒçš„ä¿è­‰æ€§ï¼Œé è¨­æ˜¯ &lt;code>sync&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ Primary + Replica éƒ½å¯«å…¥æˆåŠŸæ‰è¿”å›ï¼Œè³‡æ–™ä¸ç”¨æ“”å¿ƒæœƒä¸è¦‹ï¼›&lt;br>
å¯ä»¥èª¿æ•´æˆ &lt;code>async&lt;/code>ï¼Œåªè¦ Primary å¯«å…¥æˆåŠŸå°±è¿”å›ï¼Œä½†å¯èƒ½è³‡æ–™æœƒä¸è¦‹ï¼› &lt;br>
ä½†æ›¸ä¸­æåˆ°å»ºè­°é‚„æ˜¯ç”¨ &lt;code>sync&lt;/code>ï¼Œå› ç‚ºå¦‚æœ Elasticsearch æ­¤æ™‚è² è¼‰è¼ƒé«˜ï¼Œå¯ä»¥è®“ Request è¼ƒæ™šå›è¦†ç”¢ç”Ÿ back preasureï¼Œå¦å‰‡å¯èƒ½æœƒè®“ç³»çµ±ä¹˜è¼‰éå¤šçš„ Query&lt;/p>
&lt;p>åœ¨ä½µç™¼çš„ç‹€æ³ä¸‹ï¼ŒElasticsearch æ¡ç”¨&lt;code>æ¨‚è§€é–&lt;/code>ï¼Œé€é_versionå»æ¯”å°æ›´å‹•æ˜¯å¦ç‚ºæ­£ç¢ºçš„ç‰ˆæœ¬ï¼Œé è¨­çš„_version æ˜¯éå¢çš„æ•¸å­—ï¼Œä¹Ÿå¯ä»¥ç”¨è‡ªå®šç¾©çš„ _version&lt;/p>
&lt;h3 id="sharding">Sharding&lt;/h3>
&lt;h4 id="sharding-çš„ä¾æ“šæ˜¯ä»€éº¼--æ˜¯å¦èƒ½å¤ å‹•æ…‹å¢æ¸›-shard">Sharding çš„ä¾æ“šæ˜¯ä»€éº¼ / æ˜¯å¦èƒ½å¤ å‹•æ…‹å¢æ¸› shard&lt;/h4>
&lt;p>Elasticsearch åœ¨å»ºç«‹ Index æ™‚ï¼Œå¯ä»¥æŒ‡å®š sharding çš„æ•¸é‡ï¼Œè¨­å®šå¾Œå¦‚æœè¦æ›´å‹•ï¼Œå°±å¿…é ˆè¦å…ˆé—œé–‰ Index å¯«å…¥ä¸¦èª¿æ•´è¨­å®š &lt;br>
è‡³æ–¼è³‡æ–™å¦‚ä½•åˆ†é…åˆ° shardï¼Œå‰‡æ˜¯ç”±å…§éƒ¨çš„ &lt;code>hash function å° id åšé‹ç®—&lt;/code>ï¼ŒElasticsearch æœƒè‡ªå‹• balance è³‡æ–™&lt;/p>
&lt;p>MongoDB å‰‡æ˜¯éœ€è¦å° collection æŒ‡å®š shard keyï¼Œå¯ä»¥åˆ†æˆ range shard / hash shardï¼Œå‰è€…å¯è‡ªå·±æŒ‡å®š shard è¦å„²å­˜çš„ key ç¯„åœï¼Œå¾Œè€…åŒæ¨£æœ‰å…§éƒ¨ hash function æ±ºå®šï¼ŒMongoDB æœƒè‡ªè¡Œè² è²¬ balanceï¼›&lt;br>
Redis cluster é è¨­æœ‰ 16384 å€‹å‘ï¼Œé€é hash é‹ç®—(CRC16 mod 16384)åˆ†æ•£ key åˆ°ç¾æœ‰çš„ Node ä¸Šé¢ï¼Œå¦‚æœå‹•æ…‹å¢æ¸› cluster Redis æœƒè‡ªè¡Œè™•ç†è³‡æ–™æ¬ç§»&lt;/p>
&lt;h4 id="query-å¦‚ä½•-routing-åˆ°æ­£ç¢ºçš„-shard-ä¸Šé¢">Query å¦‚ä½• routing åˆ°æ­£ç¢ºçš„ shard ä¸Šé¢&lt;/h4>
&lt;p>Elasticsearch æ¯ä¸€å€‹ Node éƒ½èƒ½å¤ è™•ç† Queryï¼Œæœƒåœ¨å…§éƒ¨è‡ªå·± routing åˆ°è³‡æ–™æ‰€åœ¨çš„ Node ä¸Šï¼Œå¦å¤–ç‚ºäº†æ•ˆèƒ½ï¼Œå¦‚æœæ˜¯è®€å–ä¸”æœ‰ replicaï¼ŒElasticsearch æœƒç”¨ &lt;code>Round-Robin&lt;/code> å»åˆ†æ•£è®€å–çš„å£“åŠ›&lt;/p>
&lt;p>MongoDB å‰‡éœ€è¦ Mongos å»è™•ç† queryï¼Œæ‰€ä»¥å¤šä¸€å€‹æœå‹™è¦æ¶è¨­ï¼Œä¹Ÿé€ æˆæœå‹™å¤šä¸€å€‹ä¸­æ–·çš„å¯èƒ½ï¼›&lt;br>
Redis Cluster ä¹Ÿæ˜¯æ¯ä¸€å€‹ Node éƒ½èƒ½è™•ç† Query&lt;/p>
&lt;h3 id="cluster">Cluster&lt;/h3>
&lt;h4 id="cluster-åŸºæœ¬æ¶æ§‹è¦å¦‚ä½•æ­å»º">Cluster åŸºæœ¬æ¶æ§‹è¦å¦‚ä½•æ­å»º&lt;/h4>
&lt;p>Elasticsearch åœ¨ Cluster æ¶æ§‹ä¸Šéå¸¸å½ˆæ€§ï¼Œè¦å¹¾å€‹ Node éƒ½å¯ä»¥ï¼ŒåŒæ™‚å¯ä»¥é‡å°ä¸åŒçš„ Indices å»èª¿æ•´ sharding / replica æ•¸é‡ï¼ŒElasticsearch æœƒä»¥&lt;code>å®¹éŒ¯åº¦æœ€é«˜çš„æ–¹å¼è‡ªå‹•åˆ†é…&lt;/code>&lt;br>
ä½†å»ºè­°é‚„æ˜¯ Cluster é‚„æ˜¯ 3 å°ä»¥ä¸Šï¼Œæ‰å¯ä»¥è®“å¯ç”¨æ€§æ›´é«˜&lt;/p>
&lt;blockquote>
&lt;p>å¦‚æœåªæœ‰å…©å°ï¼Œç™¼ç”Ÿ Network partitioningï¼Œå‡è¨­è¦ä¿è­‰ Consistency è¦éå¤šæ•¸çš„å° Cluster èƒ½å¤ é‹ä½œ(é¿å… split brain)ï¼Œå‰‡å…©é‚Šå„ä¸€å°å°±æœƒæœå‹™ä¸­æ–·ï¼Œåœ¨ Network partitioning ä¸‹æ²’æœ‰ä»»ä½•çš„å®¹éŒ¯æ€§&lt;br>
æ‰€ä»¥ Cluster åŸºæœ¬éƒ½ 3å°èµ·è·³ä¸”é¸æ“‡å¥‡æ•¸&lt;/p>
&lt;/blockquote>
&lt;p>MongoDB Cluster åªå°‘è¦ 3 å€‹ Node (è‡³å°‘å…©å€‹å¯å„²å­˜çš„ Node)ï¼Œå¦‚æœæ˜¯ Sharding Cluster å‰‡éœ€è¦ Config Server (3å°) + Replica set (3å°èµ·è·³) * nï¼Œå¤–åŠ  Mongos&lt;br>
Redis Cluster å‰‡ä¹Ÿæ²’æœ‰é™åˆ¶ï¼Œè¦åŠ å¹¾å€‹ Node éƒ½å¯ä»¥ï¼Œå¦‚æœè¦å‚™æ´å‰‡è¨­å®š slave node&lt;/p>
&lt;h4 id="cluster-èª¿æ•´æ™‚éœ€è¦åšä»€éº¼æ”¹å‹•">Cluster èª¿æ•´æ™‚éœ€è¦åšä»€éº¼æ”¹å‹•&lt;/h4>
&lt;p>Elasticsearch å†å¢åŠ æ–°çš„ Cluster Node æ™‚&lt;code>ä¸éœ€è¦é¡å¤–çš„è¨­å®š&lt;/code>ï¼Œåªè¦ç¢ºä¿ Network å¯ä»¥ multicast ä¸”è¨­å®šåŒä¸€å€‹ cluster nameï¼Œå°±æœƒè‡ªå·±åŠ é€²å»&lt;/p>
&lt;p>MongoDB éœ€è¦æ”¹ Config Server è¨­å®šæª” / Redis Cluster ä¹Ÿæ˜¯&lt;/p>
&lt;h4 id="cluster-å¢æ¸›-node-æ™‚æœƒæœ‰ä»€éº¼è®ŠåŒ–">Cluster å¢æ¸› node æ™‚æœƒæœ‰ä»€éº¼è®ŠåŒ–&lt;/h4>
&lt;p>Elasticsearch å†è¨­å®šæª”ï¼Œå¯ä»¥æŒ‡å®š Primary èˆ‡ Replica çš„æ•¸é‡ï¼Œä¸¦å¹³å‡åˆ†æ•£åˆ°æ¯ä¸€å€‹ Node ä¸Š&lt;br>
ä¾‹å¦‚èªª Primary 2 + replica 1ï¼Œå‰‡æœƒç”¢ç”Ÿ P1 / P2 + R1 / R2ï¼Œå‡è¨­ç›®å‰æœ‰å…©å€‹ Node ä»–æœƒè‡ªå‹•åˆ†é…æˆ P1 + R2 / P2 + R1 åˆ†æ•£é¢¨éšªï¼Œæ›äº†ä¸€å°è³‡æ–™ä¹Ÿä¸æœƒæ‰&lt;/p>
&lt;p>MongoDB çš„ Cluster Node ä¸»è¦æœ‰å…©ç¨® secondary / åƒ…æŠ•ç¥¨ç”¨çš„ Arbiter (æ’‡é™¤ Primary)&lt;br>
Redis Cluster æ²’æœ‰ç‰¹åˆ¥å€åˆ† Node æ€§è³ª&lt;/p>
&lt;h4 id="cluster-åœ¨ä»€éº¼æƒ…æ³ä¸‹æœƒä¸å¯ç”¨">Cluster åœ¨ä»€éº¼æƒ…æ³ä¸‹æœƒä¸å¯ç”¨&lt;/h4>
&lt;p>Elasticsearch / MongoDB / Redis Cluster é€™æ–¹é¢éƒ½æ˜¯é¡ä¼¼çš„ï¼Œç•¶ç™¼ç”Ÿ partitioning æ™‚ï¼Œåªæœ‰è¶…éåŠæ•¸çš„ cluster å¯ä»¥é‹ä½œ&lt;/p></description></item><item><title>gRPC ä»‹ç´¹èˆ‡ Nodejs å¯¦ä½œåˆ†äº«</title><link>https://yuanchieh.page/posts/2020/2020-06-07-grpc-%E4%BB%8B%E7%B4%B9%E8%88%87-nodejs-%E5%AF%A6%E4%BD%9C%E5%88%86%E4%BA%AB/</link><pubDate>Sun, 07 Jun 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-06-07-grpc-%E4%BB%8B%E7%B4%B9%E8%88%87-nodejs-%E5%AF%A6%E4%BD%9C%E5%88%86%E4%BA%AB/</guid><description>&lt;p>ä¸€èˆ¬çš„ API Endpoint è¨­è¨ˆæ¡ç”¨ RESTful APIè¦ç¯„ï¼Œä¸é RESTful æ¯”è¼ƒæŒ‡ç¨±çš„æ˜¯ Client/Server çš„æ¶æ§‹è¨­è¨ˆè€Œä¸æ˜¯ä¾·é™æ–¼ API Endpoint çš„è¨­è¨ˆè¦ç¯„ï¼Œæ›´æº–ç¢ºçš„èªªæ³•æ˜¯ HTTP + JSON æ ¼å¼ï¼Œä½”æ“šå¤šæ•¸çš„ API è¨­è¨ˆè¿‘ä¸€äºŒåå¹´ (SOAP/WSDL å› ç‚ºå·¥ä½œä¸­æ²’æœ‰ä½¿ç”¨éå°±ä¸æè¿°)&lt;/p>
&lt;p>ä½†å› æ‡‰æ–°çš„ç¶²è·¯æ‡‰ç”¨ç¨‹å¼ï¼Œä¸æ–·æœ‰æ–°çš„è¨­è¨ˆå˜—è©¦å»æ›´é€² API è¨­è¨ˆï¼Œè¿‘å¹´æœ‰ Facebook æå‡ºäº† &lt;code>GraphQL&lt;/code>ï¼Œå°‡è®€å–è³‡æ–™çš„å½ˆæ€§äº¤é‚„çµ¦ Clientï¼Œé©æ‡‰å¤šå±å¹•å¤šè£ç½® Client çš„æ‡‰ç”¨å ´æ™¯&lt;/p>
&lt;p>åˆæˆ–æ˜¯ä»Šå¤©è¦æ¢è¨çš„ &lt;code>gRPC&lt;/code>ï¼Œç”± Google åŸºæ–¼ http/2 æå‡ºä¸”å»£æ³›æ‡‰ç”¨åœ¨å¾®æœå‹™æ¶æ§‹ä¸­ï¼Œä¸»è¦å¸Œæœ›æ”¹å–„å¹¾å€‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>&lt;strong>&lt;code>API æ–‡ä»¶åŒ–èˆ‡ Client å¯¦ä½œç¹é›œ&lt;/code>&lt;/strong>&lt;br>
ä¸€èˆ¬çš„ API è¨­è¨ˆæ˜¯ Server é–‹å¥½ HTTP endpoint å¾Œï¼Œå®šç¾©å¥½åƒæ•¸ä¸¦æ’°å¯«æ–‡ä»¶ï¼Œæ¥è‘— Client å†é–±è®€æ–‡ä»¶å¯¦ä½œï¼›&lt;br>
å¥½è™•æ˜¯è§£è€¦çš„å¾ˆå¾¹åº•ï¼Œä¸ç®¡æœ‰å¹¾å€‹ Client æˆ–æ˜¯ä½¿ç”¨ä»€éº¼ç¨‹å¼èªè¨€ï¼ŒæŒ‰ç…§ API ä»‹é¢å¯¦ä½œå³å¯ï¼› &lt;br>
ä½†åŒæ¨£çš„è¦ç¶­è­·æ™‚ç›¸å°æˆæœ¬ä¹Ÿæ¯”è¼ƒé«˜ï¼Œåƒæ˜¯åƒæ•¸çš„åç¨±èˆ‡å‹åˆ¥ï¼Œéƒ½å¿…é ˆé›™æ–¹å»ç¶­è­·èˆ‡é–±è®€æ–‡ä»¶ï¼Œå†ç”¨ç¨‹å¼ç¢¼å¯¦ä½œï¼Œä¸­é–“å¤šäº†ä¸€å±¤çš„è½‰æ› &lt;br>
gRPC é è¨­æ¡ç”¨ &lt;code>protocol buffer&lt;/code> ç•¶ä½œ IDL (ä»‹é¢å®šç¾©èªè¨€)ï¼Œå°‡ Endpoint æä¾›çš„æœå‹™/åƒæ•¸/å›å‚³å€¼éƒ½å®šç¾©å¥½åç¨±èˆ‡å‹åˆ¥ï¼Œ&lt;code>ç•¶ä½œ Server / Client å¯¦ä½œçš„ Interface&lt;/code>ï¼Œå¤§å¹…é™ä½é›™æ–¹æºé€šçš„æˆæœ¬&lt;/li>
&lt;li>&lt;strong>&lt;code>å¢åŠ å‚³è¼¸æ•ˆç‡&lt;/code>&lt;/strong>&lt;br>
gRPC é è¨­ä½¿ç”¨ &lt;code>protocol buffer&lt;/code> ç•¶ä½œç·¨ç¢¼/è§£ç¢¼å‚³è¼¸å…§å®¹ï¼Œæ¯”ç”¨æ–‡å­—æè¿°çš„ JSON åœ¨æª”æ¡ˆå¤§å°èˆ‡ç¶²è·¯å‚³è¼¸æ•ˆç‡ä¸Šæ›´å…·å‚™å„ªå‹¢ï¼Œå°ˆæ¡ˆä¸­æœ‰æä¾› &lt;a class="link" href="https://github.com/david-cao/gRPCBenchmarks" target="_blank" rel="noopener"
>Android client benchmark&lt;/a>ï¼ŒgRPC çš„å»¶é²é æ¯” JSON è¦å¿«ä¸Šè¨±å¤š&lt;/li>
&lt;li>&lt;strong>&lt;code>æ‡‰ç”¨å½ˆæ€§&lt;/code>&lt;/strong> &lt;br>
å‚³çµ±çš„ HTTP å°±æ˜¯ Request/Response ä¸€ä¾†ä¸€å¾€ï¼Œåœ¨ grpc ä¸­ç¨±ç‚º Unary Callï¼Œä½†æ˜¯ gRPC é¡å¤–æä¾› &lt;code>streaming&lt;/code>ï¼Œå¯ä»¥åˆ†æ‰¹åœ¨åŒä¸€å€‹ request response ä¸­å‚³é€å¤šæ¬¡ payloadï¼Œè¨­è¨ˆæ›´æœ‰å½ˆæ€§çš„æºé€šæ–¹å¼&lt;/li>
&lt;li>&lt;strong>&lt;code>HTTP verb ä¸¦ç„¡æ³•å®Œæ•´æè¿°è³‡æºçš„æ“ä½œ&lt;/code>&lt;/strong> &lt;br>
ä¹‹å‰è¨­è¨ˆ API é ­ç—›çš„æ˜¯ HTTP çš„å‹•è© (GET/POST) ç­‰ç„¡æ³•å®Œæ•´æè¿°æ‰€æœ‰çš„æ“ä½œï¼Œä¾‹å¦‚èªªæ‰¹æ¬¡åˆªé™¤ï¼Œå¾Œä¾†&lt;a class="link" href="https://yuanchieh.page/post/2019-09-18_%E5%A6%82%E4%BD%95%E8%A8%AD%E8%A8%88-rest-api/" target="_blank" rel="noopener"
>åƒç…§ Google API è¨­è¨ˆæ–‡ä»¶æœ‰æ‰¾åˆ°è§£æ³•&lt;/a>ï¼Œä½†é‚„æ˜¯æœ‰é€™éº¼ä¸€é»å½†æ‰­&lt;br>
æ¡ç”¨ gRPC å°±æ²’æœ‰é€™æ–¹é¢çš„è¦ç¯„(èˆ‡å›°æ“¾ ?!&lt;/li>
&lt;/ol>
&lt;p>ç›®å‰ gRPC ç”± Google é–‹æºä¸¦ä¸»åŠ›ç¶­è­·ï¼Œæ¡ç”¨çš„å¤§å» ä¹Ÿæœ‰ä¸å°‘ï¼Œä¹Ÿæ”¯æ´è¨±å¤šç¨‹å¼èªè¨€ Java/JS(Nodejs &amp;amp; browser)/Python/PHP ç­‰ç­‰ï¼ŒAndroid/iOS App ä¹Ÿéƒ½æœ‰æ”¯æ´çš„ Libraryï¼›&lt;br>
è§€å¿µä¸Šè¦æ‰¾åˆ°æ˜ å°„æ–¼ HTTP é‚„è »å®¹æ˜“çš„ï¼Œåƒæ˜¯ Http header å°æ‡‰ gRPC metadata / Http Status Code å°æ‡‰ gRPC ä¹Ÿæœ‰åŒæ¨£çš„å›å‚³æ ¼å¼&lt;/p>
&lt;p>ä»¥ä¸‹å…§å®¹åŒ…å«&lt;/p>
&lt;ol>
&lt;li>protocol buffer ç°¡ä»‹èˆ‡ç·¨ç¢¼æ©Ÿåˆ¶&lt;/li>
&lt;li>gPRC å››ç¨®å‚³è¼¸æ–¹å¼ä»‹ç´¹èˆ‡ server ç«¯å¯¦ä½œ&lt;/li>
&lt;li>éŒ¯èª¤è™•ç†èˆ‡é©—è­‰æ©Ÿåˆ¶ (&lt;code>*Warning æœ‰å‘&lt;/code>)&lt;/li>
&lt;/ol>
&lt;p>ä½†ç›®å‰ä¸åŒ…å« Client side å¯¦ä½œ&lt;/p>
&lt;h2 id="nodejs-å¯¦ä½œ">Nodejs å¯¦ä½œ&lt;/h2>
&lt;p>ä»¥ä¸‹æœƒå¯¦ä½œä¸€å€‹ç°¡å–®çš„ To-Do Listï¼Œdemo code æ–¼æ­¤ &lt;a class="link" href="https://github.com/sj82516/grpc-demo" target="_blank" rel="noopener"
>grpc-demo&lt;/a>&lt;/p>
&lt;h3 id="å®šç¾©-proto-æª”æ¡ˆ">å®šç¾© .proto æª”æ¡ˆ&lt;/h3>
&lt;p>åœ¨å°ˆæ¡ˆè·¯å¾‘ä¸‹ï¼Œå»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ &lt;code>./protos&lt;/code> æ”¾&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span class="line">&lt;span class="cl">&lt;span class="k">import&lt;/span> &lt;span class="s">&amp;#34;google/protobuf/empty.proto&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="n">syntax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;proto3&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nn">ToDoService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">ToDoItem&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">title&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">author&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="n">isDone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">createDate&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">ToDoList&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">repeated&lt;/span> &lt;span class="n">ToDoItem&lt;/span> &lt;span class="n">ToDoList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">GetQueryOptions&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">author&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">ToDoService&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">CreateToDo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ToDoItem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ToDoList&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">createMultiToDo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span> &lt;span class="n">ToDoItem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">google.protobuf.Empty&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">GetToDoListByAuthor&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">GetQueryOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span> &lt;span class="n">ToDoItem&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">GetToDoListByAuthorOnFly&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span> &lt;span class="n">GetQueryOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span> &lt;span class="n">ToDoItem&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>&lt;code>import&lt;/code>
å¯ä»¥å¾å…¶ä»–åœ°æ–¹è¼‰å…¥ proto æª”æ¡ˆä½¿ç”¨è£¡é¢çš„å®£å‘Š&lt;/li>
&lt;li>&lt;code>syntax = &amp;quot;proto3&amp;quot;;&lt;/code>&lt;br>
æ¨™è¨»ä½¿ç”¨ protobuffer version&lt;/li>
&lt;li>&lt;code>message å®£å‘Šå‹åˆ¥åç¨± { å‹åˆ¥ åƒæ•¸å = é †åº}&lt;/code>&lt;br>
å‹åˆ¥éƒ¨åˆ†å¯ä»¥åƒè€ƒå®˜ç¶²ï¼Œæœ‰æä¾› int / uint / float / string ç­‰å¤šæ¨£åŸºç¤å‹åˆ¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šç¾©å‹åˆ¥ï¼›&lt;br>
é †åºçš„éƒ¨åˆ†ï¼Œå¾ 1 é–‹å§‹ä¸€è·¯éå¢ï¼Œå‹åˆ¥å…§éƒ¨çš„åƒæ•¸é †åºä¸èƒ½é‡è¤‡ï¼Œä¸”&lt;code>è¶Šå°çš„æ•¸å­—é€šå¸¸æ˜¯è¶Šå¸¸ä½¿ç”¨åˆ°çš„åƒæ•¸&lt;/code>ï¼Œè©³è¦‹å¾ŒçºŒè£œå……&lt;/li>
&lt;li>&lt;code>service æœå‹™åç¨± { rpc å‡½å¼åç¨± (åƒæ•¸) returns (å›å‚³å€¼) }&lt;/code>&lt;br>
å¦‚æœå¸Œæœ›å°‡ proto ç”¨æ–¼ rpcï¼Œå°±éœ€è¦å®£å‘Š service é¡åˆ¥ï¼Œ&lt;code>stream&lt;/code> è¡¨ç¤ºåƒæ•¸æˆ–å›å‚³å€¼å¯èƒ½æœƒæ˜¯æ‰¹æ¬¡å‚³é€ payload&lt;br>
é€™é‚Šå®šç¾©äº†å››å€‹å‡½å¼ï¼Œå»ºç«‹ ToDoItem / streaming æ‰¹æ¬¡å»ºç«‹ ToDoItem / ä¾ç…§ä½œè€…æ‰¹æ¬¡å–å¾— ToDoItem / å‹•æ…‹æ”¹è®Šæœå°‹ä½œè€…ä¸¦å‹•æ…‹ä¾ç…§æ¢ä»¶å›å‚³ ToDoItem&lt;/li>
&lt;/ol>
&lt;h2 id="server-side-å¯¦ä½œ">Server side å¯¦ä½œ&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;path&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">grpc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;grpc&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">protoLoader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;@grpc/proto-loader&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">toDoServiceImplementations&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;./implementations/todoService&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">PROTO_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">__dirname&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;./protos/todo.proto&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">packageDefinition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">protoLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">loadSync&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">PROTO_PATH&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">keepCase&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">longs&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">enums&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">defaults&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">oneofs&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">toDoProto&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">loadPackageDefinition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">packageDefinition&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">ToDoService&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">toDoProto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ToDoService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">toDoServiceImplementations&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;0.0.0.0:50051&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServerCredentials&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createInsecure&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">main&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šæ­¥é©Ÿå¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>å»ºç«‹ grpc server instance&lt;/li>
&lt;li>è¼‰å…¥ä¸Šä¸€æ­¥å®šç¾©çš„ proto&lt;/li>
&lt;li>å°‡ proto èˆ‡å¯¦ä½œçš„ function çµåˆ&lt;/li>
&lt;li>server bind port ä¸¦é–‹å§‹é‹è¡Œ&lt;/li>
&lt;/ol>
&lt;p>æ¥è‘—çœ‹ implementation éƒ¨åˆ†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;span class="lnt">95
&lt;/span>&lt;span class="lnt">96
&lt;/span>&lt;span class="lnt">97
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">grpc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;grpc&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">todoList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">title&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">author&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isDone&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">createDate&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mf">1.4&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">title&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">author&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isDone&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">createDate&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mf">1.4&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">title&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello3&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">author&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isDone&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">createDate&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mf">1.4&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">title&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;world&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">author&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;world&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isDone&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">createDate&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mf">1.4&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">title&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;world2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">author&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isDone&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">createDate&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mf">1.4&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">title&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;world3&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">author&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Hello2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isDone&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">createDate&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;1.4&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">CreateToDo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">clientToken&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">metadata&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;token&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">.[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">clientToken&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="s1">&amp;#39;Secret&amp;#39;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">error&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PERMISSION_DENIED&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;No token&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">todoList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">request&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">todoList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">error&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OUT_OF_RANGE&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;too many ToDoItem&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">callback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ToDoList&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">todoList&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">createMultiToDo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">on&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;data&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">todoList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">on&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;end&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">callback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">GetToDoListByAuthor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">author&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">author&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">isAny&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">todoItem&lt;/span> &lt;span class="k">of&lt;/span> &lt;span class="nx">todoList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">author&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">todoItem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">author&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">isAny&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">todoItem&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">isAny&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;error&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PERMISSION_DENIED&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">end&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">main&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">GetToDoListByAuthorOnFly&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">author&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">on&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;data&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">author&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">author&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">main&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">on&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;end&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">end&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">todoItem&lt;/span> &lt;span class="k">of&lt;/span> &lt;span class="nx">todoList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">author&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">todoItem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">author&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">todoItem&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sec&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">sec&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exports&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CreateToDo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">createMultiToDo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">GetToDoListByAuthor&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">GetToDoListByAuthorOnFly&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° handle function å…±æœ‰å››ç¨®&lt;/p>
&lt;ol>
&lt;li>handleUnaryCall(call, callback) // CreateToDo&lt;/li>
&lt;li>handleClientStreamingCall(call, callback) // createMultiToDo&lt;/li>
&lt;li>handleServerStreamingCall(call) // GetToDoListByAuthor&lt;/li>
&lt;li>handleBidiStreamingCall(call) // GetToDoListByAuthorOnFly&lt;/li>
&lt;/ol>
&lt;p>æ‹†æˆ client / server å…©éƒ¨åˆ†&lt;/p>
&lt;ol>
&lt;li>å¦‚æœ client æ˜¯é€ unary dataï¼Œå‰‡ç›´æ¥å¾ &lt;code>call.request&lt;/code> è®€å–å‚³é€å€¼&lt;/li>
&lt;li>å¦‚æœ client æ˜¯é€ streaming dataï¼Œå‰‡ä½¿ç”¨ &lt;code>call.on('data', (data)=&amp;gt;{})&lt;/code> / &lt;code>call.on('end', ()=&amp;gt;{})&lt;/code> è™•ç†è³‡æ–™èˆ‡å‚³é€çµæŸ&lt;/li>
&lt;li>å¦‚æœ server æ˜¯é€ unary dataï¼Œå‰‡handle function ç¬¬äºŒå€‹åƒæ•¸ç‚º callbackï¼Œcallback å¸¸ç”¨å‰å…©å€‹åƒæ•¸ï¼Œä»£è¡¨ &lt;code>error&lt;/code> è·Ÿ &lt;code>data&lt;/code>ï¼Œå¦‚æœæ²’æœ‰éŒ¯èª¤å‰‡å›å‚³ &lt;code>callback(null, myData)&lt;/code>&lt;/li>
&lt;li>å¦‚æœ server æ˜¯é€ streaming dataï¼Œå‰‡ç”¨ &lt;code>call.write(myData)&lt;/code>ï¼ŒçµæŸå‚³é€å‘¼å« &lt;code>call.end()&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ­é…çš„ GUI Client å·¥å…·å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://github.com/uw-labs/bloomrpc" target="_blank" rel="noopener"
>bloomrpc&lt;/a>ï¼Œè¼‰å…¥ proto æª”æ¡ˆå¾Œå°±æœƒè‡ªå‹•è·³å‡ºå®šç¾©çš„ service èˆ‡é æœŸçš„å›å‚³çµæœï¼Œç›¸ç•¶çš„æ–¹ä¾¿ï¼Œé€™ä¹Ÿæ˜¯ä½¿ç”¨ gRPC çš„ä¸€å¤§å¥½è™•&lt;/p>
&lt;h3 id="å‚³å…¥å¤šé¤˜çš„åƒæ•¸æˆ–å‹åˆ¥éŒ¯èª¤">å‚³å…¥å¤šé¤˜çš„åƒæ•¸æˆ–å‹åˆ¥éŒ¯èª¤&lt;/h3>
&lt;p>åœ¨ä½¿ç”¨é å…ˆå‹åˆ¥å®šç¾©çš„è¨­è¨ˆæ™‚ï¼Œä¸å…è…¦ä¸­æµ®ç¾å¦‚æœæˆ‘ä¸æŒ‰ç…§å®šç¾©çš„è©±æœƒæ€éº¼æ¨£ï¼Ÿ&lt;br>
å¦‚æœæ˜¯&lt;code>å‚³å…¥å¤šé¤˜çš„å‹åˆ¥ï¼Œprotobuffer åœ¨ version 2 &amp;amp;&amp;amp; version 3.5 ä»¥ä¸Šæœƒä¿ç•™&lt;/code>ï¼Œç›®å‰ç‰ˆæœ¬åˆ° 3.12 äº†&lt;br>
å¦‚æœæ˜¯ &lt;code>å‹åˆ¥ä¸å°&lt;/code>ï¼Œå…§éƒ¨æ¡ç”¨çš„ encode / decode æ˜¯åŸºæ–¼ &lt;a class="link" href="https://www.npmjs.com/package/protobufjs#valid-message" target="_blank" rel="noopener"
>protobufjs&lt;/a>ï¼Œæœƒä½¿ç”¨ Number / Boolean ç­‰ JS é¡åˆ¥ä¾†è½‰æ›å‹åˆ¥ï¼Œä¾‹å¦‚ number &amp;ldquo;123&amp;rdquo; å°±æœƒè®Šæˆ 123&lt;/p>
&lt;h2 id="éŒ¯èª¤è™•ç†">éŒ¯èª¤è™•ç†&lt;/h2>
&lt;p>æ ¹æ“šå‰é¢æ‰€æè¿°ï¼ŒServer å›æ‡‰æ™‚æœƒåˆ†æˆ Unary è·Ÿ Streamingï¼Œå…©ç¨®çš„éŒ¯èª¤å›å‚³æ©Ÿåˆ¶ä¸åŒï¼›&lt;br>
é€™éƒ¨åˆ†æœ‰é»å°å‘ï¼Œå®˜æ–¹ç¯„ä¾‹åªæœ‰ç¤ºç¯„ Unary Response æ™‚çš„éŒ¯èª¤è™•ç†ï¼Œä¹Ÿå°±æ˜¯å‘¼å« callback çš„ç¬¬ä¸€å€‹åƒæ•¸&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">callback&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">error&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OUT_OF_RANGE&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;too many ToDoItem&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…ˆå‰å®šç¾© service æ™‚ä¸¦æ²’æœ‰å®£å‘ŠéŒ¯èª¤å›å‚³ï¼Œé€™æ˜¯å› ç‚º gRPC å…§å»ºéŒ¯èª¤è¨Šæ¯ï¼Œæ ¼å¼å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> string error
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> string message
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>error å°æ‡‰æ–¼ HTTP status codeï¼Œå¯ä»¥å¾ grpc çš„éœæ…‹åƒæ•¸å–å¾—å¦‚ &lt;code>grpc.status.PERMISSION_DENIED&lt;/code> ç­‰åŒæ–¼ 403ï¼Œmessage å‰‡æ˜¯è‡ªå®šç¾©çš„å­—ä¸²ï¼Œéœ€æ³¨æ„ Nodejs ä¸æ”¯æ´ rich formatï¼Œä»¥ä¸‹æˆªè‡ªå®˜æ–¹æ–‡ä»¶&lt;/p>
&lt;blockquote>
&lt;p>This richer error model is already supported in the C++, Go, Java, Python, and Ruby libraries, and at least the grpc-web and Node.js libraries have open issues requesting it.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ gRPC client æ”¶åˆ°çš„éŒ¯èª¤è¨Šæ¯æœƒè¢«è½‰æˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;2 UNKNOWN: too many ToDoItem&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦å¤– Streaming response å‚³ééŒ¯èª¤çš„æ–¹å¼æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;error&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PERMISSION_DENIED&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>emit error å¾Œæœƒè‡ªå‹• closeï¼Œç›®å‰åªæ”¯æ´ statusï¼Œä¸èƒ½å‚³éç‰©ä»¶ï¼Œå¦å‰‡ connection ç„¡æ³•è¢« closeï¼Œå‘¼å« &lt;code>call.end()&lt;/code> ä¹Ÿæ²’æœ‰ç”¨&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœè¦æœ‰æ›´è±å¯Œçš„éŒ¯èª¤æ ¼å¼ï¼Œå°±éœ€è¦è‡ªå·±å®šç¾©äº†&lt;/p>
&lt;h2 id="é©—è­‰æ©Ÿåˆ¶">é©—è­‰æ©Ÿåˆ¶&lt;/h2>
&lt;p>gRPC å…§å»ºå…©ç¨®é©—è­‰ç›¸é—œçš„æ©Ÿåˆ¶ï¼Œä¸€ç¨®æ˜¯ &lt;code>SSL/TLS&lt;/code>ï¼Œæä¾›é€šè¨Šä¸Šçš„é»åˆ°é»åŠ å¯†ï¼Œå¦ä¸€ç¨®æ˜¯ Google æœå‹™çš„ OAuth Token é©—è­‰æ©Ÿåˆ¶ï¼Œå¾Œè€…åƒ…é™æ–¼èˆ‡ Google æœå‹™å°æ¥æ‰æœ‰ç”¨ï¼›&lt;br>
ç•¶ç„¶ä¹Ÿå¯ä»¥ç”¨ middleware æ–¹å¼è‡ªè¡Œå¯¦ä½œé©—è­‰æ©Ÿåˆ¶&lt;/p>
&lt;p>é©—è­‰æ©Ÿåˆ¶æœ‰å…©ç¨® scopeï¼Œä¸€ç¨®æ˜¯ &lt;code>Channel Level&lt;/code>ï¼Œä¹Ÿå°±æ˜¯é©ç”¨æ–¼ gRPC é€£ç·šï¼Œå¦ä¸€å€‹æ˜¯ &lt;code>Call Level&lt;/code>ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å‘¼å«ï¼Œé€™éƒ¨åˆ†æ˜¯ä½¿ç”¨æ–¼ Client side&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">ssl_creds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">credentials&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createSsl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">root_certs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">stub&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">helloworld&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Greeter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;myservice.example.com&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ssl_creds&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šç‚ºäº†å¯¦ä½œæ–¹ä¾¿æ€§ï¼Œå°‡ token æ”¾ç½®æ–¼ &lt;code>metadata&lt;/code> ä¹‹ä¸­ï¼Œè¦å¾ server side è®€å–ä½¿ç”¨ &lt;code>call.metadata.get('Key')&lt;/code> å³å¯&lt;/p>
&lt;h2 id="cache">Cacheï¼Ÿ&lt;/h2>
&lt;p>å¦ä¸€å€‹ HTTP (RESTful æ¶æ§‹ä¸‹) åŸæœ‰çš„è¨­è¨ˆæ˜¯ Cache æ©Ÿåˆ¶ï¼Œåˆåˆ†æˆ server / proxy / client ä¸‰è€…è™•ç†ï¼ŒgRPC çœ‹èµ·ä¾†æœ‰é¡ä¼¼çš„è¦åŠƒï¼Œä½†ç›®å‰é‚„åœ¨å¯¦é©—éšæ®µ &lt;a class="link" href="https://github.com/grpc/grpc/issues/7945" target="_blank" rel="noopener"
>Provide support for caching GRPC method response #7945&lt;/a>&lt;/p>
&lt;h2 id="protocol-buffer-encoding-æ©Ÿåˆ¶">Protocol buffer Encoding æ©Ÿåˆ¶&lt;/h2>
&lt;p>åƒè€ƒå®˜æ–¹æ–‡ä»¶ &lt;a class="link" href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="noopener"
>Protocol buffer Encoding&lt;/a>ï¼Œå…ˆå‰æåˆ° Protocol buffer æœƒå°‡è¨Šæ¯ç·¨ç¢¼æˆ binary æ ¼å¼ï¼Œè€Œ JSON å‰‡ç¶­æŒæ–‡å­—æ ¼å¼ï¼Œé€™é‚Šç°¡å–®ä»‹ç´¹ Protocol buffer ç·¨ç¢¼çš„éç¨‹&lt;/p>
&lt;h4 id="varints">Varints&lt;/h4>
&lt;p>varints æ˜¯ä¸€ç¨®ç”¨å¤šå€‹ bytes è¡¨é”æ•¸å­—çš„æ–¹å¼ï¼Œé™¤äº†æœ€å¾Œä¸€å€‹ byte å¤–ï¼Œå…¶é¤˜ byte çš„ç¬¬ä¸€ä½å…ƒè¡¨ç¤ºå¾ŒçºŒæ˜¯å¦é‚„æœ‰ byteï¼Œbyte çš„é †åºç‚ºæœ€ä½æœ‰æ•ˆä½(è¶Šå‰é¢çš„ byte æ˜¯ä½ä½) &lt;code>least significant group first.&lt;/code>ï¼Œæ‰€ä»¥å¯¦éš›ä¸Šæ¯å€‹ byte æ˜¯ç”¨ 7 bits è¡¨é”æ•¸å€¼&lt;/p>
&lt;p>ä¾‹å¦‚èªª &lt;code>1010 1100 0000 0010&lt;/code> ä»£è¡¨ 300ï¼Œå› ç‚º &lt;code>1 010 1100&lt;/code> 1 ä»£è¡¨å¾Œé¢é‚„æœ‰ byte ç›¸é€£ï¼Œ&lt;code>0 000 0010&lt;/code> 0 å‰‡è¡¨ç¤ºä»–æ˜¯æœ€å¾Œä¸€å€‹ byte äº†ï¼›&lt;br>
å› ç‚ºæœ€ä½æœ‰æ•ˆä½ï¼Œæ‰€ä»¥é‡çµ„æˆ &lt;code>000 0010 010 1100&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ 300&lt;/p>
&lt;h4 id="key-value">Key Value&lt;/h4>
&lt;p>å…¶å¯¦ Protocol buffer å°±æ˜¯ç·¨ç¢¼ä¸€é€£ä¸²çš„ Key-Valueï¼Œåœ¨ç·¨ç¢¼æ™‚æœƒä»¥ &lt;code>ç·¨ç¢¼è™Ÿ(5 bits) é¡åˆ¥(3 bits) æ•¸å€¼&lt;/code>è¡¨ç¤ºï¼Œä¾‹å¦‚èªª&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">message Test2 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> optional string &lt;span class="nv">b&lt;/span> &lt;span class="o">=&lt;/span> 2&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‡è¨­ b å„²å­˜äº† &amp;ldquo;testing&amp;rdquo;ï¼Œé‚£æ™‚è¨˜å¾—ç·¨ç¢¼çµæœæ˜¯ &lt;code>12 07 74 65 73 74 69 6e 67&lt;/code>ï¼Œæ‹†è§£ 12 æˆ &lt;code>0001 0010&lt;/code> =&amp;gt; &lt;code>00010 010&lt;/code> å°æ‡‰åˆ°æ¬„ä½ç·¨è™Ÿ 2 + æ•¸å€¼é¡åˆ¥ 2(ä»£è¡¨æ˜¯è‡ªè¨‚é•·åº¦çš„é¡åˆ¥ï¼Œå¦‚ string / object ç­‰)ï¼›&lt;br>
æ¥è‘— &lt;code>07&lt;/code> è¡¨ç¤ºæ¥ä¸‹ä¾† 7 å€‹ bytes æ˜¯æ•¸å€¼è¡¨ç¤ºï¼›&lt;br>
å¾ŒçºŒçš„æ•¸å€¼æ˜¯ utf-8 ç·¨ç¢¼çš„é¡¯ç¤º&lt;/p>
&lt;p>æ¥è‘—çœ‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">message Test1 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> optional int32 &lt;span class="nv">a&lt;/span> &lt;span class="o">=&lt;/span> 1&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">message Test3 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> optional Test1 &lt;span class="nv">c&lt;/span> &lt;span class="o">=&lt;/span> 3&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‡è¨­ Test1 a å„²å­˜ 150ï¼Œå‰‡ç·¨ç¢¼çµæœhex è¡¨ç¤ºç‚º &lt;code>08 96 01&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ &lt;code>00001 000&lt;/code> æ¬„ä½ç·¨è™Ÿ 1 + æ•¸å€¼ç·¨è™Ÿ 0 ä¹Ÿå°±æ˜¯ varintsï¼›&lt;br>
&lt;code>96 01&lt;/code> å‰‡æ˜¯ &lt;code>1001 0110 + 0000 0001&lt;/code> ä¸¦ä¾ç…§ varints è¡¨ç¤ºæ³•è½‰ä¹˜ &lt;code>000 0001 001 0110&lt;/code> ä¹Ÿå°±æ˜¯ 150&lt;/p>
&lt;p>æ¥è‘— Test3 å„²å­˜ Test1ï¼Œå‡è¨­ Test1 çš„ a ç­‰æ–¼ 150ï¼›&lt;br>
hex è¡¨ç¤ºæ³•ç‚º &lt;code> 1a 03 08 96 01&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ &lt;code>00011 010&lt;/code>ï¼Œæ¬„ä½ 3çš„é¡åˆ¥æ˜¯ 2ï¼Œæ¥ä¸‹ä¾† &lt;code>03&lt;/code> å…± 3 å€‹bytes ç‚ºæ•¸å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€æ­¥çš„ &lt;code>08 96 01&lt;/code>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>gRPC æœƒå…¨é¢å–ä»£ HTTP + JSON å—ï¼Ÿ &lt;br>
é€™å€‹å•é¡Œæˆ–è¨±æœ‰é»åƒ Deno æœƒä¸æœƒå…¨é¢å–ä»£ Nodejsï¼Œç¾åœ¨è«‡å¥½åƒæœ‰é»éæ—©ï¼Œç•¢ç«Ÿ HTTP + JSON è¡Œä¹‹æœ‰å¹´ï¼Œå¤šæ–¹å¹³å°çš„æ”¯æ´åº¦é‚„æ˜¯æ¯”è¼ƒå¥½ï¼ŒåŒ…å«åƒ Proxy ç­‰ä¸­ä»‹ç¶²è·¯æœå‹™&lt;/p>
&lt;p>ä½†æ˜¯ gRPC åœ¨æŸäº›ç”¨é€”ä¸Šï¼ŒåŸºæ–¼é–‹ç™¼æ•ˆç‡ / å‚³è¼¸é€Ÿç‡ç­‰ï¼Œç¢ºå¯¦å¾ˆå€¼å¾—æŠ•è³‡èˆ‡å˜—è©¦çš„æŠ€è¡“&lt;/p></description></item><item><title>JS Proxy / Reflect å¯¦æˆ° - å¯¦ä½œ API è‡ªå‹• retry æ©Ÿåˆ¶</title><link>https://yuanchieh.page/posts/2020/2020-05-27-js-proxy-/-reflect-%E5%AF%A6%E6%88%B0-%E5%AF%A6%E4%BD%9C-api-%E8%87%AA%E5%8B%95-retry-%E6%A9%9F%E5%88%B6/</link><pubDate>Wed, 27 May 2020 08:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-05-27-js-proxy-/-reflect-%E5%AF%A6%E6%88%B0-%E5%AF%A6%E4%BD%9C-api-%E8%87%AA%E5%8B%95-retry-%E6%A9%9F%E5%88%B6/</guid><description>&lt;p>ä¹‹å‰åœ¨é–±è®€ ES6 ç›¸é—œæ•™å­¸æ™‚ï¼Œæœ‰æåŠ &lt;code>Proxy&lt;/code> / &lt;code>Reflect&lt;/code> é€™å…©å€‹æ–°çš„å…§å»ºç‰©ä»¶å‹åˆ¥ï¼ŒProxy ä¸»è¦æ˜¯ä½œç‚ºæŒ‡å®šç‰©ä»¶çš„ä»£ç†ï¼Œå¯ä»¥æ”¹å¯«ã€åµè½ç‰©ä»¶çš„å­˜å–èˆ‡æ“ä½œ / Reflect å‰‡æ˜¯ç”¨éœæ…‹æ–¹æ³•æ“ä½œç‰©ä»¶ï¼Œå®Œå–„ Proxy handler çš„å¯¦ä½œï¼›&lt;br>
ç•¶åˆæœ‰çœ‹æ²’æœ‰æ‡‚ï¼Œä¹Ÿæƒ³ä¸åˆ°æ‡‰ç”¨çš„å ´æ™¯ï¼Œç›´åˆ°æœ€è¿‘åœ¨é–‹ç™¼æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œé‡åˆ°è¦åŒ…è£ API è‡ªå‹• retry æ©Ÿåˆ¶&lt;/p>
&lt;blockquote>
&lt;p>é‡å°ä¸åŒçš„ API éŒ¯èª¤é›†ä¸­åŒ–è™•ç†ï¼Œå¯èƒ½æ˜¯å–®ç´” retry æˆ–æ˜¯å‘¼å«å…¶ä»– API æ›æ–°çš„ token ä¹‹é¡çš„&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœè¦æ¯æ¬¡ api call æ™‚å» catch error ä¸¦è™•ç†æ˜¯ä¸€ä»¶éå¸¸é ­ç–¼ä¸”é›£ä»¥ç®¡ç†çš„äº‹æƒ…ï¼Œè‡¨æ©Ÿä¸€å‹•æƒ³åˆ° &lt;code>Proxy&lt;/code> é€™å€‹å¥½å¹«æ‰‹ï¼Œç›®å‰ç”¨èµ·ä¾†è »é †åˆ©çš„ï¼Œä»¥ä¸‹åˆ†äº« Proxy / Reflect åŸºæœ¬ä»‹ç´¹ï¼Œä»¥åŠå¦‚ä½•æ‡‰ç”¨åœ¨ API retry æ©Ÿåˆ¶çš„å¯¦ä½œ&lt;/p>
&lt;p>æ–‡ç« å…§å®¹å¤§å¤šåƒè€ƒè‡ª &lt;a class="link" href="https://javascript.info/proxy" target="_blank" rel="noopener"
>javascript.info: Proxy and Reflect&lt;/a>ï¼Œå€‹äººè¦ºå¾—å¯«å¾—æ¯” MDN è©³ç›¡ä¸”æ˜“æ‡‚&lt;/p>
&lt;h2 id="proxy">Proxy&lt;/h2>
&lt;p>ç•¶æˆ‘å€‘åœ¨èª¿ç”¨ Proxy æ™‚ï¼Œæœƒé€™æ¨£å®£å‘Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handler&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>&lt;code>target&lt;/code>&lt;br>
è¦è¢« Proxy ä»£ç†çš„ç‰©ä»¶å°è±¡ï¼Œåªè¦æ˜¯ Object å‹æ…‹éƒ½å¯ä»¥ï¼ŒåŒ…å« Array / Function ç­‰ï¼Œå¦‚æœä¸æ˜¯ Object å®£å‘Šæ™‚æœƒæ”¶åˆ°éŒ¯èª¤&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Uncaught&lt;/span> &lt;span class="nx">TypeError&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Cannot&lt;/span> &lt;span class="nx">create&lt;/span> &lt;span class="nx">proxy&lt;/span> &lt;span class="kd">with&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="nx">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">object&lt;/span> &lt;span class="nx">as&lt;/span> &lt;span class="nx">target&lt;/span> &lt;span class="nx">or&lt;/span> &lt;span class="nx">handler&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>&lt;code>handler&lt;/code>&lt;br>
é¸æ“‡è¦æŒ‡å®šè§¸ç™¼çš„æ™‚æ©Ÿï¼ŒProxy æœƒç”¢ç”Ÿæ‰€è¬‚çš„ &lt;code>trap&lt;/code>ï¼Œä¹Ÿå°±æ˜¯æ””æˆªç‰©ä»¶æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚æœæœªå®šç¾©å‰‡ç›´æ¥å‘¼å«åŸ Target&lt;/li>
&lt;/ol>
&lt;p>åœ¨ç‰©ä»¶çš„æ“ä½œä¸Šï¼Œéƒ½æœƒæœ‰å°æ‡‰çš„å…§éƒ¨å‘¼å«æ–¹æ³•(internal methods)ï¼Œä¾‹å¦‚èªª &lt;code>new A()&lt;/code> ä»£è¡¨å‘¼å«äº† &lt;code>A ç‰©ä»¶çš„ [[Contructor]]&lt;/code> æ–¹æ³•ï¼Œå¸¸ç”¨çš„ get / set å¦‚ &lt;code>a.prop / a.prop = 'hello world'&lt;/code> å‰‡åˆ†åˆ¥å‘¼å«äº† &lt;code>[[Get]] / [[Set]]&lt;/code> ç­‰æ–¹æ³•ï¼Œè€Œ handler å‰‡æ˜¯å°æ‡‰é€™äº›æ–¹æ³•ç”¢ç”Ÿæ””æˆªçš„å®šç¾©&lt;/p>
&lt;p>å¦å¤–æœ‰äº›ç‰©ä»¶æœƒæœ‰å…§éƒ¨çš„å„²å­˜è³‡æ–™æ ¼å¼ï¼Œç¨±ç‚º internal slotï¼Œä¾‹å¦‚ Map çš„å…§éƒ¨è³‡æ–™æ ¼å¼æ˜¯ &lt;code>[[Mapdata]]&lt;/code> è€Œä¸æ˜¯é€é &lt;code>[[Get]]/[[Set]]&lt;/code>ï¼Œé€™é¡å‹å°±ä¸èƒ½é€é Proxy ä»£ç†&lt;/p>
&lt;h4 id="åŸºæœ¬æ¡ˆä¾‹---æ”¹å¯«-get-è¨­å®šé è¨­å€¼">åŸºæœ¬æ¡ˆä¾‹ - æ”¹å¯« get è¨­å®šé è¨­å€¼&lt;/h4>
&lt;p>æˆ‘å€‘å¸Œæœ›åœ¨å–å¾—é™£åˆ—æ™‚ï¼Œé‡åˆ°è¶…å‡ºç¯„åœå‰‡å›å‚³é è¨­å€¼ 0&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">numbers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">numbers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">numbers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">prop&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nx">target&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">target&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// default value
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 0
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ handler ä¸­å®šç¾© get å¯ä»¥æ””æˆª &lt;code>[[Get]]&lt;/code> å‘¼å«ï¼Œæœƒæ”¶åˆ°ä¸‰å€‹åƒæ•¸ target / prop / receiver&lt;/p>
&lt;ol>
&lt;li>target &lt;br>
ç›®æ¨™ç‰©ä»¶ï¼Œä¹Ÿå°±æ˜¯ number æœ¬èº«&lt;/li>
&lt;li>prop&lt;br>
å‘¼å«çš„å±¬æ€§åç¨±&lt;/li>
&lt;li>receiver:&lt;br>
&lt;code>åŸ·è¡Œ target[prop]&lt;/code> æ™‚çš„ this ä»£è¡¨å€¼ï¼Œé€šå¸¸æ˜¯ Proxy æœ¬èº«ï¼Œä½†å¦‚æœæ˜¯æœ‰ç¹¼æ‰¿ç­‰å¯¦ä½œæœƒä¸å¤ªä¸€æ¨£ï¼Œå¾ŒçºŒæœƒè£œå……&lt;/li>
&lt;/ol>
&lt;p>å¦å¤–æ–¹æ³•å‘¼å«ä¹Ÿæœƒè§¸ç™¼ getå–”ï¼Œä¾‹å¦‚ a.method()&lt;/p>
&lt;h4 id="ç¬¬äºŒå€‹æ¡ˆä¾‹---æ”¹å¯«-set-çµ±ä¸€é©—è­‰æ–¹å¼">ç¬¬äºŒå€‹æ¡ˆä¾‹ - æ”¹å¯« set çµ±ä¸€é©—è­‰æ–¹å¼&lt;/h4>
&lt;p>åœ¨å¯«å…¥è¡¨å–®æ™‚ï¼Œå¯èƒ½æœƒç”¨ä¸€å€‹ç‰©ä»¶æš«å­˜ç”¨æˆ¶çš„è¼¸å…¥ï¼Œä½†æ­¤æ™‚éƒ½éœ€è¦æ¬„ä½çš„é©—è­‰ï¼Œä¾‹å¦‚æ‰‹æ©Ÿè™Ÿç¢¼ / åœ°å€æ ¼å¼ç­‰ç­‰&lt;br>
å¦‚æœè¦å°‡é‚è¼¯æ•£è½åœ¨æ¯ä¸€å€‹è¼¸å…¥å¾Œçš„ function æœ‰é»éº»ç…©&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">numbers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">numbers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">numbers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// (*)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// to intercept property writing
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">typeof&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;number&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">target&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">numbers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// added successfully
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">numbers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// added successfully
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">alert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Length is: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">numbers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">numbers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// TypeError (&amp;#39;set&amp;#39; on proxy returned false)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>set æœƒæ”¶åˆ°å››å€‹åƒæ•¸ï¼Œä¸¦æ³¨æ„éœ€è¦å›å‚³ &lt;code>boolean&lt;/code> è¡¨ç¤º set æ˜¯å¦æˆåŠŸ&lt;/p>
&lt;/blockquote>
&lt;p>å…¶é¤˜åƒæ˜¯ construct / getPrototypeOf / ownKeys ç­‰ç­‰çš„æ–¹æ³•&lt;/p>
&lt;h4 id="å¯¦éš›ä½¿ç”¨---æ­£å¼ç’°å¢ƒè¤‡å¯«-console-è¡Œç‚º">å¯¦éš›ä½¿ç”¨ - æ­£å¼ç’°å¢ƒè¤‡å¯« console è¡Œç‚º&lt;/h4>
&lt;p>åœ¨é–‹ç™¼æ™‚ï¼Œç‚ºäº† debug æ–¹ä¾¿å›ç•™ä¸‹å¾ˆå¤š console å‘¼å«çš„æ–¹æ³•ï¼Œä½†å¦‚æœä¸Šåˆ°æ­£å¼æ©Ÿå¿˜è¨˜é—œé–‰å°±æœƒå¾ˆå°·å°¬ï¼›&lt;br>
åŒæ™‚åƒ error / warning æœƒéœ€è¦ç”¨å…¶ä»–çš„æ–¹å¼é€å› server ç´€éŒ„éŒ¯èª¤ logï¼Œé¿å…æ­£å¼æ©Ÿé™¤éŒ¯ä¸æ˜“ï¼Œæ­¤æ™‚ç”¨ Proxy å»åŒ… console å°±æ˜¯ä¸€å€‹è »æ–¹ä¾¿çš„åšæ³•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">console&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">console&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receive&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">prop&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;log&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">prop&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;debug&amp;#39;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">alert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ä½ çœ‹ä¸è¦‹æˆ‘&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">()=&amp;gt;{};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">target&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// å½ˆå‡º alert
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// ç…§å¸¸é¡¯ç¤º
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶ç„¶ä¹Ÿå¯ä»¥è‡ªå®šç¾© Log Class é”åˆ°ä¸€æ¨£çš„æ•ˆæœï¼Œä½†æœƒè¦ºå¾—ç”¨ console.log æ˜¯å€‹å¾ˆç›´è¦ºçš„åšæ³•ï¼Œå¦‚æœèƒ½ç”¨ Proxy å»æ”¹å¯«é”åˆ°ä¸€æ¨£çš„æ•ˆæœæ¯”è¼ƒæ–¹ä¾¿ (æ‡¶&lt;/p>
&lt;h4 id="receiver-æ‡‰ç”¨">receiver æ‡‰ç”¨&lt;/h4>
&lt;p>å‰›æ‰æåˆ° get ç¬¬ä¸‰å€‹åƒæ•¸ receiver æŒ‡çš„æ˜¯å‡½å¼åŸ·è¡Œ this æ‰€ä»£è¡¨çš„ç‰©ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;Guest&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">userProxy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">prop&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">iterator&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">prop&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">toStringTag&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">prop&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nodejs.util.inspect.custom&amp;#39;&lt;/span>&lt;span class="p">)){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">target&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">// (*) target = user
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">admin&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">__proto__&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">userProxy&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;Admin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// outputs: Guest
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">admin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="c1">// Expected: Admin but outputs: Guest (?!?)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®£å‘Šä¸€å€‹ user ç‰©ä»¶ï¼Œä¸¦ç”¨ userProxy ä»£ç†ï¼Œæœ€å¾Œ admin ç”¨ &lt;code>__proto__&lt;/code> æ–¹å¼ç¹¼æ‰¿ userProxyï¼Œé€é userProxy get å¯ä»¥çœ‹å‡º &lt;code>target éƒ½æŒ‡å‘ user&lt;/code>ï¼Œä½†æ˜¯ receiver å°±ä¸ä¸€æ¨£ï¼Œå…©è€…éƒ½æŒ‡å‘å‘¼å«çš„è‡ªèº« (Proxy / Admin)&lt;br>
ä½†å› ç‚ºæœ€å¾ŒåŸ·è¡Œæ˜¯é€é &lt;code>target[prop]&lt;/code>ï¼Œæ‰€ä»¥ this æŒ‡å‘çš„éƒ½æ˜¯ user&lt;/p>
&lt;p>å¦‚æœå¸Œæœ› admin.name æœ€å¾Œå°å‡º &amp;ldquo;Admin&amp;rdquo;ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è®“åŸ·è¡Œæ™‚ this æŒ‡å‘ adminï¼Œå°±éœ€è¦ Reflect å”åŠ©&lt;/p>
&lt;blockquote>
&lt;p>è¨˜å¾—è¦é¿å…åœ¨ proxy handler get ä¸­ç›´æ¥å‘¼å« receiver[prop]ï¼Œå› ç‚ºæœƒä¸æ–·é€é [[GET]] -&amp;gt; Proxy get -&amp;gt; [[GET]] -&amp;gt; Proxy get è¼ªè¿´&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>é€™ä¸€æ®µæ˜¯ç”¨ node.js åŸ·è¡Œï¼Œéœ€åŠ å…¥ if condition é¿å…ä¸æ–·çš„éè¿´å‘¼å«ï¼Œå› ç‚ºåœ¨ console.log æ™‚æœƒä¸»å‹•å» iterate ç‰©ä»¶ä¸¦å‘¼å« toStringï¼Œé€™äº›ä¹Ÿæœƒè§¸ç™¼ [[GET]]&lt;/p>
&lt;/blockquote>
&lt;h2 id="reflect">Reflect&lt;/h2>
&lt;p>Reflect æ˜¯ ES6 æ–°å¢çš„é¡åˆ¥ï¼Œä¸èƒ½é€é new å»ºæ§‹æ–°çš„ instanceï¼Œåªèƒ½å‘¼å«éœæ…‹æ–¹æ³•ï¼Œä¸»è¦æ˜¯é‡å°ç‰©ä»¶æ“ä½œçš„æ–¹æ³•ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">123&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="c1">// 123
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 123
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">object1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">property1&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">delete&lt;/span> &lt;span class="nx">object1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">property1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deleteProperty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;property1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸºæœ¬ä¸Šéƒ½æœ‰ä¸€å°ä¸€çš„æ–¹æ³•å¯ä»¥èª¿ç”¨&lt;/p>
&lt;p>å‰›æ‰æåˆ°ï¼Œgetter æ™‚ç¬¬ä¸‰å€‹åƒæ•¸ receiver å¯ä»¥è®Šæˆ target å‘¼å«æ™‚çš„ this æŒ‡å‘ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">123&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">get&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">(){&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">456&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 123
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 456
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥ç•¶æˆ‘å€‘å¸Œæœ›æŒ‡å®š getter å¯¦éš›æ“ä½œçš„ç‰©ä»¶ï¼Œå¯ä»¥ç”¨ &lt;code>Reflect.get å»å–ä»£ target[propd]&lt;/code>ï¼Œé€™æ˜¯ä¸€ç¨®æœ€å®‰å…¨çš„åšæ³•ï¼Œçµåˆ function call ç”¨ä»¥ä¸‹æ–¹å¼æœ€ç‚ºä¿éšª&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(...&lt;/span>&lt;span class="nx">arguments&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;function&amp;#39;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æŸäº›æ™‚å€™ï¼Œç”¨ Reflect.get å¯ä»¥é¿å…ä¸é æœŸéŒ¯èª¤ï¼Œä¾‹å¦‚èªª &lt;code>Map&lt;/code>ï¼ŒMap åœ¨è®€å¯«åƒæ•¸æ™‚æ˜¯é€é &lt;code>this.[[MapData]]&lt;/code> è€Œä¸æ˜¯ &lt;code>this.[[Get]]/this.[[Set]]&lt;/code>ï¼Œæ‰€ä»¥å¦‚æœæ²’æœ‰æŒ‡å®š receiver å‰‡é è¨­ this æŒ‡å‘ Proxy å°±æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œè¦æ”¹ç”¨ Reflect.get å°‡ this æ›¿æ›æˆ Map æœ¬èº«æ‰ä¸æœƒæœ‰å•é¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Map&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">proxy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">proxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// éŒ¯èª¤: Uncaught TypeError: Method Map.prototype.get called on incompatible receiver
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">/// æ­£ç¢ºæ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Map&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">proxy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(...&lt;/span>&lt;span class="nx">arguments&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;function&amp;#39;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">proxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="api-retry-æ©Ÿåˆ¶">API retry æ©Ÿåˆ¶&lt;/h4>
&lt;p>å€‹äººé‚„æ˜¯è »å–œæ­¡ç”¨ axios çš„è€Œä¸æ˜¯ç”¨åŸç”Ÿçš„ fetchï¼Œå¯èƒ½æ˜¯å› ç‚º axios æ›´åƒä¸€å€‹ç‰©ä»¶ï¼Œå¯ä»¥é€é create å‰µå»º instance è »æ–¹ä¾¿çš„&lt;/p>
&lt;p>æ¥è‘—ç”¨ Proxy ä»£ç† function çš„å‘¼å«ï¼Œä¸¦å›å‚³ä¸€å€‹ async functionï¼Œåœ¨è£¡é ­å°±èƒ½è‡ªå®šç¾©éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼Œä¾‹å¦‚èªªæ”¶åˆ° 403 å°±å»æ›æ–°çš„ token ä¹‹é¡çš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">APIInstace&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">axios&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">baseURL&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;https://httpstat.us&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">APIProxy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">APIInstace&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">receiver&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(...&lt;/span>&lt;span class="nx">arguments&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">(...&lt;/span>&lt;span class="nx">arguments&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">response&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">403&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">APIInstace&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;https://www.mocky.io/v2/5ed11b963500005b00ffa29a&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="s2">&amp;#34;OhNo&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">await&lt;/span> &lt;span class="nx">APIProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/403&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="c1">// æ²’æœ‰éŒ¯èª¤
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">await&lt;/span> &lt;span class="nx">APIProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/404&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ‹‹å‡º OhNo éŒ¯èª¤
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Vault æ•™å­¸-é›†ä¸­åŒ–ç®¡ç†æ©Ÿæ•è³‡æ–™(ä¸Š)</title><link>https://yuanchieh.page/posts/2020/2020-04-23-vault-%E6%95%99%E5%AD%B8-%E9%9B%86%E4%B8%AD%E5%8C%96%E7%AE%A1%E7%90%86%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99%E4%B8%8A/</link><pubDate>Thu, 23 Apr 2020 20:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-04-23-vault-%E6%95%99%E5%AD%B8-%E9%9B%86%E4%B8%AD%E5%8C%96%E7%AE%A1%E7%90%86%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99%E4%B8%8A/</guid><description>&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/VYfl-DpZ5wM"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>å…§å®¹æ‘˜éŒ„è‡ªå½±ç‰‡ä»‹ç´¹ï¼Œè¦è¨è«– Vault çš„åŠŸèƒ½ä¹‹å‰ï¼Œå…ˆé€€ä¸€æ­¥å›ä¾†çœ‹æœ€ä¸€èˆ¬çš„æ©Ÿæ•è³‡æ–™çš„å®šç¾©èˆ‡ç®¡ç†æ–¹å¼&lt;/p>
&lt;p>æ©Ÿæ•è³‡æ–™ä¸»è¦åˆ†æˆ &lt;code>é©—è­‰(Authentication)&lt;/code> èˆ‡ &lt;code>æˆæ¬Š(Authorization)&lt;/code>ï¼Œä¸€è€…è¡¨æ˜èº«ä»½ä¸€è€…æ±ºå®šæ“ä½œçš„æ¬Šé™ï¼Œå¯èƒ½æ˜¯ DB çš„æ¬Šé™ / ç¬¬ä¸‰æ–¹æœå‹™çš„ API Token / ç”¨ä¾†åŠ è§£å¯†çš„å°ç¨±é‡‘é‘°ç­‰ç­‰ï¼Œé€™äº›è³‡æ–™å¯èƒ½è¢«æ”¾åœ¨åŸå§‹ç¢¼ç•¶ä¸­ / config æ–‡ä»¶ / ç’°å¢ƒè®Šæ•¸ / ç‰ˆæœ¬æ§åˆ¶ç­‰ç­‰å››æ•£å„åœ°ï¼Œä¹‹å‰ Github æœ‰æå‡ºè¨±å¤šé–‹ç™¼è€…éƒ½èª¤ä¸Šå‚³æ©Ÿæ•è³‡æ–™ï¼›&lt;br>
å¦ä¸€æ–¹é¢æ™‚é–“ä¸€ä¹…æ²’æœ‰äººçŸ¥é“åˆ°åº•ç™¼å‡ºå»å“ªäº› key åˆæˆ–æ˜¯èª°æœ‰åœ¨ç”¨ï¼Œç³Ÿç³•çš„æ˜¯å¯èƒ½ä¸€çµ„ key æœ‰å¤šå€‹äººä½¿ç”¨&lt;/p>
&lt;p>Vault æå‡ºä¸‰å€‹å±¤ç´šçš„è§£æ±ºæ–¹æ¡ˆ&lt;br>
&lt;strong>&lt;code>1. é›†ä¸­åŒ–ç®¡ç†&lt;/code>&lt;/strong> &lt;br>
æ­å»º Vault Server é›†ä¸­ç®¡ç†æ‰€æœ‰çš„æ©Ÿæ•è³‡æ–™ï¼Œåœ¨ Vault Server ä¸­ç¢ºä¿æ‰€æœ‰çš„æ©Ÿæ•è³‡æ–™éƒ½æ˜¯&lt;code>è¢«åŠ å¯†å„²å­˜&lt;/code>ï¼ŒåŒæ™‚ Client ä¾†è·Ÿ Server è¦æ©Ÿæ•è³‡æ–™æ™‚&lt;code>å‚³è¼¸éç¨‹ä¹Ÿæ˜¯åŠ å¯†çš„&lt;/code>ï¼Œå®‰å…¨æ€§å¤§å¹…æå‡ï¼›&lt;br>
ä¸”æœ‰ Vault ç®¡ç†ï¼Œå¯ä»¥å®šæœŸ Rotateï¼Œä¸¦éš¨æ™‚æŸ¥çœ‹ç›®å‰çš„æ©Ÿæ•è³‡æ–™ä½¿ç”¨ç‹€æ³&lt;br>
&lt;strong>&lt;code>2.å‹•æ…‹ç”Ÿæˆ&lt;/code>&lt;/strong> &lt;br>
é€éå‹•æ…‹ç”Ÿæˆæ–¹å¼ï¼Œæ¯ä¸€å€‹ Client ä¾†è¦å³ä½¿æ¬Šé™éœ€æ±‚ç›¸åŒï¼Œä¹Ÿå‹•æ…‹ç”Ÿæˆä¸åŒçš„ keyï¼Œå¦‚æœæœ‰ç•°å¸¸æ“ä½œï¼Œå°±èƒ½å¾ˆæ¸…æ¥šæ˜¯å“ªä¸€å€‹ Client æœ‰å•é¡Œï¼Œæ¥è‘—ç›´æ¥ revoke æ‰å°±è¡Œäº†ï¼›&lt;br>
å¦‚æœå¤§å®¶éƒ½å…±ç”¨ä¸€æŠŠ keyï¼Œå°±æŸ¥ä¸å‡ºæ˜¯èª°ä¹Ÿä¸èƒ½ç›´æ¥ revokeï¼Œé€ æˆå®‰å…¨ä¸Šçš„æ¼æ´&lt;br>
&lt;strong>&lt;code>3.Encrpyt as Service&lt;/code>&lt;/strong>&lt;br>
API Server è¨­è¨ˆæ™‚ï¼Œæˆ‘å€‘å¸¸éœ€è¦åŠ è§£å¯†è³‡æ–™ï¼Œæ‰€ä»¥æœƒéœ€è¦é‡‘é‘°èˆ‡å¯¦ä½œåŠ è§£å¯†æ¼”ç®—æ³•ï¼Œä½†æ˜¯ä¸€æ–¹é¢é‡‘é‘°å¤–æµåˆ° API Server ä¸Šå¤šä¸€å±¤é¢¨éšªï¼Œå†è€…å¦‚æœåŠ è§£å¯†æ¼”ç®—æ³•æœ‰æ¼æ´åˆæ˜¯å¦ä¸€å€‹é¢¨éšªï¼›&lt;br>
æ‰€ä»¥ Vault Server æœ¬èº«ä¹Ÿæä¾›åŠ è§£å¯† APIï¼Œè®“é‡‘é‘°èˆ‡æ¼”ç®—æ³•çš„ä¿éšœéƒ½ç•™åœ¨ Vault Server ä¸Šï¼Œå¤§å¹…é™ä½é¢¨éšªã€‚&lt;/p>
&lt;p>æ¶æ§‹ä¸Šï¼ŒVault æ‹†æˆå¹¾å€‹æ¨¡çµ„å¢åŠ ç›¸å®¹æ€§ &lt;br>
&lt;img src="https://yuanchieh.page/post/img/20200423/vault.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>Authentication&lt;br>
åŸºæ–¼äººå“¡çš„é©—è­‰ï¼Œå¯ä»¥é€éç¬¬ä¸‰æ–¹çš„æ¶æ§‹å¦‚ AWS/LDAPï¼Œæˆ–æ˜¯K8S&lt;/li>
&lt;li>Audit &lt;br>
å°‡æ‰€æœ‰çš„æ“ä½œéƒ½è¨˜éŒ„ä¸‹ä¾†ï¼Œå¯ä»¥å­˜æ”¾åœ¨ system logs æˆ–æ˜¯å…¶ä»–å„²å­˜æ–¹å¼&lt;/li>
&lt;li>Secret&lt;br>
æ©Ÿæ•è³‡æ–™çš„å‹æ…‹ï¼Œå¯èƒ½æ˜¯ Key-Valueï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹æœå‹™å¦‚ Database / AWS ç­‰&lt;/li>
&lt;li>Storage&lt;br>
æ©Ÿæ•è³‡æ–™çš„å„²æ”¾ä½ç½®&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹æ•™å­¸å°‡åˆæ­¥æ¢ç´¢ Vault åŠŸèƒ½ç‚ºä¸»ï¼Œåªé©ç”¨æ–¼å­¸ç¿’èˆ‡æ¸¬è©¦ç’°å¢ƒä½¿ç”¨!&lt;br>
ä¸‹ä¸€ç¯‡å¯¦ä½œç¯‡ï¼Œä»¥ AWS ç‚ºä¸»ï¼Œå‹•æ…‹ Launch API Server æ™‚ä¸»å‹•ç´¢å–æ©Ÿæ•è³‡æ–™ï¼Œè¢«é…èˆ‡å‹•æ…‹ MongoDB é‡‘é‘°èˆ‡ AWS Role&lt;/p>
&lt;h2 id="vault-åˆæ¢">Vault åˆæ¢&lt;/h2>
&lt;p>&lt;a class="link" href="https://learn.hashicorp.com/vault/getting-started/install" target="_blank" rel="noopener"
>Vault å®˜æ–¹æ•™å­¸&lt;/a> æ˜¯ä¸€å€‹äº’å‹•å¼çš„æ•™å­¸ï¼Œè »ç°¡å–®æ˜ç­çš„ï¼Œä»¥ä¸‹æ˜¯æ•´ç†çš„ç­†è¨˜ï¼Œåƒ…é©ç”¨æ–¼å­¸ç¿’ï¼Œå®Œå…¨ä¸å»ºè­°ç”¨åœ¨æ­£å¼ç’°å¢ƒ!&lt;/p>
&lt;p>å…ˆåˆ° &lt;a class="link" href="https://www.vaultproject.io/downloads" target="_blank" rel="noopener"
>å®˜æ–¹è¼‰é»&lt;/a>ä¸‹è¼‰ä¸¦å®‰è£ï¼Œè¨­å®šå¥½è·¯å¾‘ä¹‹å¾Œå¯ä»¥å®‰è£ auto complete &lt;code>$vault -autocomplete-install&lt;/code>ï¼Œvault æœƒåµæ¸¬ shell å®‰è£å°æ‡‰çš„æ’ä»¶&lt;/p>
&lt;h3 id="å•Ÿå‹•æ¸¬è©¦ç’°å¢ƒçš„-vault-server">å•Ÿå‹•æ¸¬è©¦ç’°å¢ƒçš„ Vault server&lt;/h3>
&lt;p>&lt;code>$ vault server -dev&lt;/code> æ¥è‘—æœƒåœ¨ terminal æ‰“å°å‡º Root Token: çš„å­—æ¨£ï¼Œæ­¤æ™‚ vault server æœƒè·‘åœ¨å‰æ™¯ï¼›&lt;br>
é–‹å•Ÿå¦ä¸€å€‹ terminal tabï¼Œå°‡å…¶è¼¸å‡ºè‡³ç’°å¢ƒè®Šæ•¸ç­‰ç­‰æœƒä½¿ç”¨ä¸Š &lt;code>export VAULT_DEV_ROOT_TOKEN_ID=&amp;quot;{æ›¿æ› Root Token}&amp;quot;&lt;/code>ï¼Œæ¥è‘—æŒ‡å®š vault server url &lt;code>$export VAULT_ADDR='http://127.0.0.1:8200'&lt;/code>ï¼›&lt;br>
é€é &lt;code>$ vault status&lt;/code> æª¢æŸ¥æ˜¯å¦æŒ‡å®šæ­£ç¢º&lt;/p>
&lt;h3 id="å–å¾—æ–°å¢æ›´æ–°åˆªé™¤-secret">å–å¾—/æ–°å¢/æ›´æ–°/åˆªé™¤ secret&lt;/h3>
&lt;p>å…ˆå‰æåˆ° Secret æœ‰å¾ˆå¤šç¨®ï¼Œå¾æœ€ç°¡å–®çš„ key value é–‹å§‹ï¼ŒVault é€šéä»¥ä¸‹æŒ‡ä»¤è¨­å®š&lt;/p>
&lt;ol>
&lt;li>&lt;code>vault kv put secret/{path} {key}={vaule} {key2}={value2}&lt;/code>&lt;/li>
&lt;li>&lt;code>vault kv get -format=json secret/{path}&lt;/code>&lt;br>
format æ˜¯é¸æ“‡æ€§å›æŒ‡å®šå›å‚³æ ¼å¼&lt;/li>
&lt;li>&lt;code>vault kv delete secret/{path}&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>å¯ä»¥æŠŠ Vault Server å„²å­˜å¯†ç¢¼çš„æ–¹å¼æƒ³æˆ RESTful API Serverï¼ŒæŒ‡å®šè³‡æºçš„è·¯å¾‘ï¼Œæ¡ç”¨æœ€é•·åŒ¹é…æ–¹å¼ï¼Œ&lt;code>secret&lt;/code> æ˜¯é è¨­çš„å‰ç¶´ï¼Œå¾Œé¢çš„path ç”¨ / åˆ†éš”ï¼Œæ¥è‘—çš„ kv å¯ä»¥è¨­å®šå¤šçµ„ï¼Œput åŒæ™‚ä»£è¡¨æ–°å¢èˆ‡æ›´æ–°ï¼›&lt;/p>
&lt;h3 id="å•Ÿç”¨-secret-ä¸¦è¨­å®š-path">å•Ÿç”¨ Secret ä¸¦è¨­å®š path&lt;/h3>
&lt;p>é è¨­ç”¨ dev å•Ÿå‹•å¾Œ &lt;code>secret/&lt;/code> è·¯å¾‘æœƒå°æ‡‰åˆ° KV å„²å­˜æ–¹å¼ï¼Œå¯ä»¥é€é &lt;code>$vault secrets list&lt;/code> æŸ¥çœ‹ï¼Œæ¥è‘—å¦‚æœæˆ‘å€‘æƒ³è¦è‡ªè¨‚å…¶ä»–çš„ Secretï¼Œæˆ–æ˜¯æŒ‡å®šæ–°çš„è·¯å¾‘å„²æ”¾ KVï¼Œå¯ä»¥é€é &lt;code>$vault secrets enable -path={path} {secret engine}&lt;/code> ä¾‹å¦‚ &lt;code>$vault secrets enable -path=kv kv&lt;/code> å°±èƒ½æŒ‡å®š kv/ ç‚ºæ–°çš„ key-value å„²å­˜è·¯å¾‘&lt;/p>
&lt;p>æ¥è‘—ä¸‹ &lt;code>$vault kv put kv/hello foo=bar&lt;/code> å¯ä»¥å¾—åˆ°ç›¸åŒçš„çµæœï¼Œé€é &lt;code>$vault secrets list&lt;/code> å¯ä»¥çœ‹å‡ºä¾†å¤šäº†ä¸€çµ„è¨­å®š&lt;/p>
&lt;p>å¦‚æœä¸è¦ç”¨äº†ï¼Œå¯ä»¥é€é &lt;code>$vault secrets disable {path}/&lt;/code> å¦‚ &lt;code>$vault secrets disable kv/&lt;/code> åˆªé™¤ï¼Œæ³¨æ„åº•ä¸‹å„²å­˜çš„å¯†ç¢¼ä¹Ÿéƒ½æœƒä¸€ä¸¦æ¶ˆå¤±&lt;/p>
&lt;h3 id="å•Ÿå‹•-aws-secret-engine-å–å¾—å‹•æ…‹-accesskey--accesssecret">å•Ÿå‹• AWS Secret Engine å–å¾—å‹•æ…‹ AccessKey / AccessSecret&lt;/h3>
&lt;p>å…ˆå‰æåˆ° Vault ä¸€å¤§ç‰¹è‰²æ˜¯æ”¯æ´å¤šç¨® Secretï¼Œè€Œä¸” Secret å¯ä»¥æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œæ¯ä¸€å€‹ Client ä¾†ç´¢å–éƒ½èƒ½è¦åˆ°ç¨ç«‹çš„ Secret&lt;/p>
&lt;p>é€é aws secret engineï¼Œå¯ä»¥æŒ‡å®š Role èˆ‡æ¬Šé™ä¸¦çµ¦äºˆå‹•æ…‹ secretï¼Œé¦–å…ˆè®“æˆ‘å€‘å•Ÿå‹• secret &lt;code>$vault secrets enable -path=aws aws&lt;/code>ï¼Œæ¥è‘—è¨­å®š aws å¸³è™Ÿ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault write aws/config/root &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="nv">access_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">AWS&lt;/span>&lt;span class="p"> Access Key&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="nv">secret_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">AWS&lt;/span>&lt;span class="p"> Secret key&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="nv">region&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">AWS&lt;/span>&lt;span class="p"> Region&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>çµ•å°ä¸å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒå¦‚æ­¤ä½¿ç”¨ï¼Œå› ç‚º shell command æœƒè¢«è¨˜éŒ„åœ¨ log ä¸­&lt;/p>
&lt;/blockquote>
&lt;p>å¾ŒçºŒçš„æ“ä½œï¼ŒVault å°±æœƒç”¨é€™çµ„å¸³å¯†å»ç®¡ç† IAM&lt;/p>
&lt;p>æ¥è‘—å‰µå»ºè§’è‰²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault write aws/roles/my-role &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="nv">credential_type&lt;/span>&lt;span class="o">=&lt;/span>iam_user &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="nv">policy_document&lt;/span>&lt;span class="o">=&lt;/span>-&lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">{
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;Statement&amp;#34;: [
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;Sid&amp;#34;: &amp;#34;Stmt1426528957000&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;Action&amp;#34;: [
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;ec2:*&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> ],
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;Resource&amp;#34;: [
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;*&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> ]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> ]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™è£¡çµ¦äºˆäº† ec2 å…¨éƒ¨çš„æ¬Šé™&lt;/p>
&lt;p>æ¥è‘—è¦ç”¢ç”Ÿ Secret é€šé &lt;code>$vault read aws/creds/my-role&lt;/code>ï¼Œæ­¤æ™‚å°±æœƒå›å‚³ä¸€çµ„æ–°çš„ roleï¼Œæ¯æ¬¡å‘¼å«éƒ½æœƒå›å‚³ç¨ç«‹çš„ Secret (ç‚ºä»€éº¼ç”¨ read ä»£è¡¨å‰µå»ºå‹•ä½œå°±ä¸ç¢ºå®šè¨­è¨ˆçš„åŸç†äº† :thinking_face)ï¼Œå¾ IAM Console å¯ä»¥çœ‹åˆ°è¢«å‰µå»ºçš„ç”¨æˆ¶
&lt;img src="https://yuanchieh.page/post/img/20200423/vault_aws_user.png"
loading="lazy"
>&lt;/p>
&lt;p>å¦‚æœè¦ revoke çš„è©±ï¼Œé€šé &lt;code>$vault lease revoke aws/creds/my-role/{lease id}&lt;/code> å³å¯&lt;/p>
&lt;p>å‰›å‰›æƒ³è¦æŸ¥æ‰¾æœ‰æ²’æœ‰æŒ‡ä»¤å¯ä»¥æ¢åˆ—å‡ºæ‰€æœ‰çš„ credentialsï¼Œä½†çœ‹ä¾†æ˜¯æ²’æœ‰é€™é …æŒ‡ä»¤ï¼Œå¦‚æœç•¶åˆæ²’æœ‰è¨˜å¾— lease id çš„è©±ï¼Œå°±è¦å» IAM Console æ‰‹å‹•åˆªé™¤äº†&lt;/p>
&lt;p>æ‰€æœ‰çš„æŒ‡ä»¤å¯ä»¥å¾é€™é‚Šçœ‹åˆ° &lt;a class="link" href="https://www.vaultproject.io/api-docs/secret/aws" target="_blank" rel="noopener"
>AWS Secret æ–‡ä»¶&lt;/a>ï¼Œæˆ–æ˜¯ç”¨ &lt;code>$vault path-help aws&lt;/code> æŸ¥çœ‹ï¼Œpath-help å¯ä»¥æŒ‡å®šä¸åŒçš„è·¯å¾‘å±¤æ¬¡ï¼Œä¾‹å¦‚ &lt;code>$vault path-help aws/config/lease&lt;/code>&lt;/p>
&lt;h3 id="authentication--authorization">Authentication &amp;amp; Authorization&lt;/h3>
&lt;p>ç¾åœ¨æˆ‘å€‘çŸ¥é“è¦å¦‚ä½•å»ºç«‹èˆ‡ç®¡ç†é‡‘é‘°ï¼Œä½†é‡é»å›åˆ°&lt;code>èª°èƒ½ä¾†è¦é‡‘é‘°ä»¥åŠæ¬Šé™åŠƒåˆ†&lt;/code>ï¼ŒAuthentication éƒ¨åˆ† Vault å¯ä»¥ç”¨ token / AppRule / Github / AWS IAM / LDAP ç­‰ç­‰ï¼ŒAuthorization éƒ¨åˆ†å¯ä»¥åˆ¶å®š Policyï¼Œé™ç¸®ç”¨æˆ¶èƒ½å¤ æ“ä½œçš„ Secret æ¬Šé™&lt;/p>
&lt;h4 id="token">Token&lt;/h4>
&lt;p>Token é©—è­‰æ©Ÿåˆ¶æ˜¯ Vault æ ¸å¿ƒã€ä¸èƒ½è¢«é—œé–‰çš„é©—è­‰åŠŸèƒ½ï¼Œåƒæˆ‘å€‘ä¸€é–‹å§‹å•Ÿå‹• Vault Server å¾Œæœƒç”¢ç”Ÿä¸€å€‹ root tokenï¼Œæ¥è‘—æœƒç”¨ root token å»åˆ¶å®š Policyï¼Œä¸¦ç”¢ç”Ÿå¤šçµ„ Tokenï¼Œæ–‡ä»¶æåˆ°å¦‚æœ&lt;code>è¨­å®šå®Œå°±æ‡‰è©² revoke root token&lt;/code>ï¼Œæœ€å¥½æ˜¯æœ‰ root token æ™‚å¤§å®¶ä¸€èµ·ç›¯è‘—è¢å¹•æ“ä½œå¾Œå°± revokeï¼Œå¾ŒçºŒæœ‰éœ€è¦å¯ä»¥åœ¨å‹•æ…‹ç”Ÿæˆ&lt;/p>
&lt;ol>
&lt;li>$vault operator init&lt;/li>
&lt;li>$vault operator generate-root&lt;/li>
&lt;li>ç”¨ root token ç”Ÿæˆå…¶ä»– root token&lt;/li>
&lt;/ol>
&lt;p>åœ¨ Vault ä¸­ï¼ŒToken ç®¡ç†æ˜¯éšå±¤åŒ–çš„ï¼Œç”¨æ¯ Token å»ç”Ÿæˆçš„ Token æœƒè‡ªå‹•è®Šæˆå­ Tokenï¼Œç‚ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œå¦‚æœæ¯ Token è¢« Revoke é‚£éº¼ä»¥ä¸‹&lt;code>æ‰€æœ‰çš„å­ Token æœƒå…¨æ•¸è¢« Revoke&lt;/code>ï¼Œå¦‚æœå¸Œæœ› Token ä¸å—æ¯ Token å½±éŸ¿ï¼Œå¯ä»¥ç”¨è¨­å®šç‚º Orphan Tokenï¼Œè·³è„«éšå±¤ç¨ç«‹ç®¡ç†&lt;/p>
&lt;p>é™¤äº† Root Tokenï¼Œå…¶é¤˜çš„ Token éƒ½æœ‰ TTLï¼ŒTTL è¨­å®šæœ‰å¹¾å€‹åœ°æ–¹&lt;/p>
&lt;ol>
&lt;li>Vault Server å•Ÿå‹•æ™‚çš„ Config&lt;/li>
&lt;li>é€é mount tuning å»æ›´æ”¹&lt;/li>
&lt;li>æ ¹æ“šæ¯ Token çš„Policy&lt;/li>
&lt;/ol>
&lt;p>åœ¨æœ‰äº›é•·é§çš„ç¨‹å¼ä¸­ï¼Œéœ€è¦é•·æ™‚é–“æŒæœ‰ Token å¯ä»¥è¨­å®šç‚º &lt;code>Periodic&lt;/code>ï¼ŒæŒ‡å®šæ›´æ–°é€±æœŸåªè¦åœ¨é€™æœŸé–“å…§å» renew å°±èƒ½ç¹¼çºŒä½¿ç”¨ Tokenï¼ŒåŒæ™‚å¯ä»¥æŒ‡å®š TTL æˆ–æ˜¯è¨­ç‚ºæ°¸ä¸å¤±æ•ˆï¼Œç­‰ TTL åˆ°äº†æœƒè‡ªå‹• revoke&lt;/p>
&lt;p>Token å»ºç«‹å¾Œæœƒå›å‚³ id / accessor / policy ç­‰è³‡è¨Šï¼Œ&lt;code>accessor&lt;/code> å¯ä»¥ç”¨ä¾†æ“ä½œ token ç›¸é—œçš„æŒ‡ä»¤ä¾‹å¦‚ renew / revoke / åæŸ¥ token id ç­‰ç­‰ï¼Œä¸å¤ªç¢ºå®šç‚ºä»€éº¼ä¸ç›´æ¥ç”¨ token id è€Œæ˜¯è¦å¤šç”¢ç”Ÿå¦ä¸€çµ„ accessor ä»£è™Ÿï¼Œä½†ç›®å‰çœ‹åˆ°è¦æ¢åˆ—å‡ºæ‰€æœ‰ token åªèƒ½é€éåˆ—å‡º accessors å†å»åæŸ¥ token&lt;/p>
&lt;p>ä»¥ä¸Šçš„ Token æ˜¯æŒ‡ &lt;code>Service Token&lt;/code>ï¼Œä¹Ÿå°±æ˜¯é è¨­æœ€å¸¸ä½¿ç”¨çš„ Token å½¢å¼ï¼›å¦å¤–é‚„æœ‰ Batch Token ç”¨åœ¨ Vault æ“ä½œä¸Šï¼Œæš«æ™‚æ²’æœ‰çœ‹åˆ°ç”¨è™•å°±å…ˆç•¥é&lt;/p>
&lt;p>æ¥è‘—å¯¦éš›æ“ä½œçœ‹çœ‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">// é€é root ç”Ÿæˆçš„ tokenï¼Œttl é è¨­ç‚ºç„¡éæœŸ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault token create
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----- é–‹å•Ÿå¦ä¸€å€‹ shellï¼Œè©¦è‘—ç”¨å‰›å‰›çš„ token ç™»å…¥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">VAULT_ADDR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;http://127.0.0.1:8200&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault login &lt;span class="o">{&lt;/span>token&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// åˆªé™¤å‰›æ‰çš„ token
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault token revoke &lt;span class="o">{&lt;/span>token&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æ–°å¢ä¸€å€‹ ttl ç‚º 1h çš„ token
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault token create -ttl&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;1h&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä»–çš„éƒ¨åˆ†ï¼Œè¦ºå¾—é€é api ä¸‹æŒ‡ä»¤æ¯”è¼ƒæ–¹ä¾¿ï¼Œæ±è¥¿ä¹Ÿæ¯”è¼ƒå…¨é¢ï¼Œå¯ä»¥åƒè€ƒ&lt;a class="link" href="https://www.vaultproject.io/api/auth/token" target="_blank" rel="noopener"
>æ–‡ä»¶&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">// æŸ¥çœ‹æ‰€æœ‰çš„ accessors
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --header &lt;span class="s2">&amp;#34;X-Vault-Token: {token}&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --request LIST &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> http://127.0.0.1:8200/v1/auth/token/accessors
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æŸ¥çœ‹å„åˆ¥ accessor
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --header &lt;span class="s2">&amp;#34;X-Vault-Token: {token}&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --request POST &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --data &lt;span class="s1">&amp;#39;{&amp;#34;accessor&amp;#34;: &amp;#34;{accessor id}&amp;#34;}&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> http://127.0.0.1:8200/v1/auth/token/lookup-self
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// é€é accessor revoke token
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --header &lt;span class="s2">&amp;#34;X-Vault-Token: {token}&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --request POST &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --data &lt;span class="s1">&amp;#39;{&amp;#34;accessor&amp;#34;: &amp;#34;{accessor token}&amp;#34;}&amp;#39;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> http://127.0.0.1:8200/v1/auth/token/revoke-accessor
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="è¨­å®š-policy">è¨­å®š Policy&lt;/h2>
&lt;p>æ¥è‘—å°±æ˜¯è¨­å®š Policy éƒ¨åˆ†ï¼Œé™åˆ¶ä¸åŒ Token èƒ½å¤ æ“ä½œ Secret çš„æ¬Šé™ï¼ŒVault æ’°å¯« policy çš„æ ¼å¼æ˜¯æ¡ç”¨ hclï¼Œä¹Ÿå°±æ˜¯ HashiCorp è‡ªå·±å…§éƒ¨çš„ Config æè¿°èªè¨€ï¼Œåœ¨è·¯å¾‘ä¸‹å»ºç«‹æª”æ¡ˆ &lt;code>my-policy.hcl&lt;/code> ä¸¦è²¼ä¸Šä»¥ä¸‹å…§å®¹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">path &lt;span class="s2">&amp;#34;kv/foo&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">capabilities&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;update&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">path &lt;span class="s2">&amp;#34;secret/data/foo&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">capabilities&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;update&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šè¿°æ–‡ä»¶çš„æ„æ€æ˜¯é€™å€‹ Policy åªèƒ½æ“ä½œ secret/foo çš„æ–°&amp;amp;æ›´æ–°ï¼Œå…¶ä»–çš„æ“ä½œéƒ½ä¸€ç‡è¢«ç¦æ­¢ï¼Œ&lt;code>/data/&lt;/code> æŒ‡çš„æ˜¯é è¨­ Key Value çš„ Secret è·¯å¾‘ï¼Œå¦‚æœæ˜¯å¦å¤–å•Ÿå‹•çš„å¦‚ &lt;code>$vault secrets enable -path=kv kv&lt;/code>ï¼Œå‰‡å¯ä»¥ä¸ç”¨åŠ  /data è®Šæˆ &lt;code>kv/foo&lt;/code> å³å¯&lt;/p>
&lt;p>æ¥è‘—å¯¦éš›æ“ä½œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault policy write my-policy my-policy.hcl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault token create -policy&lt;span class="o">=&lt;/span>my-policy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° token çš„ policy çª©äº†è‡ªå®šç¾©çš„ my-policy&lt;/p>
&lt;p>æ¥è‘—é–‹å¦ä¸€å€‹ shell ç™»å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault login &lt;span class="o">{&lt;/span>token&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault kv put secret/foo &lt;span class="nv">bar&lt;/span>&lt;span class="o">=&lt;/span>baz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// permission denied
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault kv &lt;span class="nb">read&lt;/span> secret/foo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault kv put secret/foo/bar &lt;span class="nv">bar&lt;/span>&lt;span class="o">=&lt;/span>baz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¾Œä¾†ç™¼ç¾ $vault login æœƒå½±éŸ¿æ‰€æœ‰çš„ shellï¼Œé€™é»åœ¨æ¸¬è©¦è¦ç¨åŠ ç•™æ„&lt;/p>
&lt;p>Vault Policy è¨­å®šå¯ä»¥å¾ˆå½ˆæ€§ï¼Œä¸»è¦æœ‰å¹¾é …é—œéµå­—&lt;/p>
&lt;h4 id="1-path">1. path&lt;/h4>
&lt;p>è·¯å¾‘é¸æ“‡ï¼Œå¯ä»¥ç”¨ &lt;code>*&lt;/code> ä»£è¡¨ä»¥ä¸‹æ‰€æœ‰è·¯å¾‘ / &lt;code>+&lt;/code> ä»£è¡¨æ­¤è·¯å¾‘åŒ¹é…ä»»ä½•å­—å…ƒç­‰æ–¹å¼ï¼Œå¦‚æœæœ‰å¤šçµ„ pathï¼ŒVault æ¡å–æœ€é•·åŒ¹é…çš„åŸå‰‡&lt;/p>
&lt;h4 id="2-capabilities">2. capabilities&lt;/h4>
&lt;p>æ¬Šé™é¸æ“‡ï¼Œæœ‰ &lt;code>[read, create, update, delete, list, sudo, deny]&lt;/code>ï¼Œæ–‡ä»¶æåˆ° Vault æ²’æœ‰å¾ˆä»”ç´°å€åˆ† create/update çš„ä½¿ç”¨å ´æ™¯ï¼Œæ‰€ä»¥è¦çµ¦å°±ä¸€èµ·çµ¦ï¼›&lt;br>
sudo æŒ‡çš„æ˜¯å— root ä¿è­·çš„æ¬Šé™ / deny æ˜¯ç¦æ­¢ä»»ä½•æ“ä½œåŒ…å« sudo ä¹Ÿä¸è¡Œ&lt;/p>
&lt;h4 id="3-allowed_parameters--denied_parameters--required_parameters">3. allowed_parameters &amp;amp; denied_parameters &amp;amp; required_parameters&lt;/h4>
&lt;p>é‡å°åƒæ•¸çš„è¨­å®šï¼Œå¯ä»¥æ¢åˆ—å…è¨±/ä¸å…è¨±/å¿…å‚™çš„åƒæ•¸ï¼Œå¦‚æœæ²’æœ‰ç‰¹åˆ¥è¨­å®šï¼Œå‰‡ä»£è¡¨ä¸å—ä»»ä½•é™åˆ¶&lt;/p>
&lt;h4 id="4-min_wrapping_ttl--max_wrapping_ttl">4. min_wrapping_ttl &amp;amp; max_wrapping_ttl&lt;/h4>
&lt;p>ç”¢ç”Ÿå­ Token çš„æœ€é•·èˆ‡æœ€çŸ­ TTL&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç¶œåˆç¯„ä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">path &lt;span class="s2">&amp;#34;secret/foo&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">capabilities&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">allowed_parameters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;zip&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;zap&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">min_wrapping_ttl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;1s&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">max_wrapping_ttl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;90s&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">path &lt;span class="s2">&amp;#34;secret/bar/*&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">capabilities&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">required_parameters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;baz&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">path &lt;span class="s2">&amp;#34;secret/baz/+/data-*&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">capabilities&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">denied_parameters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;deny-*&amp;#34;&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡å° secret/fooï¼Œåœ¨å‰µå»ºæ™‚åªå…è¨±åƒæ•¸ foo / barï¼Œå…¶ä¸­ foo çš„ value ä¸å—é™ï¼Œä½†æ˜¯ bar åªèƒ½æ˜¯ zip æˆ–æ˜¯ zap&lt;/p>
&lt;p>ç¬¬äºŒæ¢æ˜¯æŒ‡ secret/bar åº•ä¸‹çš„ä»»æ„è·¯å¾‘é©ç”¨ï¼ŒåŒ…å« secret/bar/baz å’Œ secret/bar/baz/foo&amp;hellip;. ç­‰ç­‰ï¼Œä¸¦ä¸”å¿…é ˆåŒ…å« bar, baz é€™å…©å€‹åƒæ•¸&lt;/p>
&lt;p>ç¬¬ä¸‰æ¢æ˜¯è·¯å¾‘æœƒåŒ¹é…å¦‚ secret/baz/foo/data-barï¼Œä¸”ä¸å…è¨± deny- é–‹é ­çš„ key&lt;/p>
&lt;h3 id="å¤šé‡-policy-èˆ‡è¡çª">å¤šé‡ Policy èˆ‡è¡çª&lt;/h3>
&lt;p>åœ¨ Token å‰µå»ºæ™‚å¯ä»¥åŒæ™‚ç¶å®šå¤šçµ„ Policyï¼Œä¸å…è®“äººå¥½å¥‡å¦‚æœå…©çµ„ Policy å°åŒä¸€è·¯å¾‘ç”¢ç”Ÿè¡çªæ™‚çš„ç‹€æ³ï¼Œå¯¦æ¸¬ç™¼ç¾æ˜¯ capacities ç›¸åŒè·¯å¾‘ä¸‹æœƒçµ¦äºˆæœ€ç¶œåˆçš„æ¬Šé™ï¼Œè€Œä¸æ˜¯æŒ‰ç…§é †åºè¦†è“‹ä¹‹é¡çš„&lt;/p>
&lt;p>å¯ä»¥ç”¨ &lt;code>$vault token capabilities {token} {path}&lt;/code> æŸ¥è©¢&lt;/p>
&lt;h3 id="æ”¹è®Š-policy">æ”¹è®Š Policy&lt;/h3>
&lt;p>ç•¶æ”¹è®Š Policy æ™‚ï¼ŒåŸæœ¬å·²ç¶“å»ºç«‹å¥½çš„ Token ä¸æœƒå‹•æ…‹å¥—ç”¨ï¼Œéœ€è¦åˆªé™¤é‡å»ºï¼Œè€Œæ–°å¢/æ›´æ–° Policy çš„æ–¹å¼ç”¨ &lt;code>$ vault policy write {policy_name} my-policy.hcl&lt;/code>å³å¯&lt;/p>
&lt;h2 id="çµ±æ•´">çµ±æ•´&lt;/h2>
&lt;p>åƒ…åƒ…ä»‹ç´¹åŸºæœ¬åŠŸèƒ½å°±èŠ±äº†ä¸å°‘ç¯‡å¹…ï¼Œæ¶µè“‹äº†åŸºæœ¬çš„ Secrets / Auth çš„åŠŸèƒ½ä»‹ç´¹èˆ‡æ“ä½œ&lt;/p>
&lt;ol>
&lt;li>å•Ÿå‹• dev serverï¼Œé—œæ‰è³‡æ–™å‰‡å…¨éƒ¨æ¶ˆå¤±&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault server --dev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>ç™»å…¥èˆ‡è¨­å®šè·¯å¾‘&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault login &lt;span class="o">{&lt;/span>token&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">VAULT_ADDR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;http://127.0.0.1:8200&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>Secret Engine æ˜¯èˆ‡è·¯å¾‘åŒ¹é…ï¼Œsecret/data æ˜¯é è¨­ Key Store Secret Engineï¼Œå¯ä»¥å¦å¤–é–‹å•Ÿæ–°çš„è·¯å¾‘&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault secrets &lt;span class="nb">enable&lt;/span> -path&lt;span class="o">=&lt;/span>kv kv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æ¢åˆ—
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault secrets list -detailed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault secrets disable &lt;span class="o">{&lt;/span>path&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>æ–°å¢&amp;amp;æ›´æ–°/å–å¾—ï¼åˆªé™¤ Token&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault kv put kv/foo &lt;span class="nv">foo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault kv get kv/foo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault kv delete kv/foo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="5">
&lt;li>Authentication&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault token create -ttl&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;1h&amp;#34;&lt;/span> -policy&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;my_policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault token revoke &lt;span class="o">{&lt;/span>token id&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="6">
&lt;li>Authorization&lt;br>
å¦å¤–ç”¨ hcl æª”å„²å­˜ Policyï¼Œä¸¦åŒ¯å…¥è¨­å®šä¸­&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ vault policy write my-policy my-policy.hcl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault token capabilities &lt;span class="o">{&lt;/span>token&lt;span class="o">}&lt;/span> &lt;span class="o">{&lt;/span>path&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault policy &lt;span class="nb">read&lt;/span> my-policy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault policy list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vault policy delete my-policy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æƒ³ä¸åˆ°åˆæ­¥ä»‹ç´¹å°±èŠ±é€™éº¼å¤§çš„ç¯‡å¹…ï¼Œä¸‹ä¸€ç¯‡è¦å¯¦ä½œçµåˆ AWS èˆ‡æ­é… API Server çš„æµç¨‹&lt;/p></description></item><item><title>Packeræ•™å­¸-æ‰“é€  Imageèˆ‡å¯¦éš›ä½¿ç”¨ç¶“é©—</title><link>https://yuanchieh.page/posts/2020/2020-04-15-packer%E6%95%99%E5%AD%B8-%E6%89%93%E9%80%A0-image%E8%88%87%E5%AF%A6%E9%9A%9B%E4%BD%BF%E7%94%A8%E7%B6%93%E9%A9%97/</link><pubDate>Wed, 15 Apr 2020 02:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-04-15-packer%E6%95%99%E5%AD%B8-%E6%89%93%E9%80%A0-image%E8%88%87%E5%AF%A6%E9%9A%9B%E4%BD%BF%E7%94%A8%E7%B6%93%E9%A9%97/</guid><description>&lt;p>ç•¶æˆ‘å€‘åœ¨åˆ©ç”¨ Vagrant å»ºç«‹é–‹ç™¼ç’°å¢ƒï¼Œæˆ–æ˜¯é›²ç«¯ä¸Šæº–å‚™éƒ¨ç½²æ™‚ï¼Œéƒ½éœ€è¦ç”¨ VM åŸ·è¡ŒæŒ‡å®šçš„ Imageï¼Œæº–å‚™å¥½ç’°å¢ƒå¾Œé–‹å§‹åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼ï¼Œä½†æ˜¯ç®¡ç† Image æ˜¯ä¸€ä»¶æœ‰é»éº»ç…©çš„äº‹ï¼Œå°¤å…¶æ˜¯è¦è¨˜éŒ„æ¯å€‹æ­¥é©Ÿåˆ°åº•åšéäº†ä»€éº¼ï¼Œåˆæˆ–æ˜¯è¦æ•´åˆå…¥æŒçºŒéƒ¨ç½² CD çš„ç’°ç¯€éƒ½ä¸é€™éº¼å‹å–„&lt;/p>
&lt;p>Packer ç”¨ json æª”æŒ‡å®šåŸºç¤ Image / Provision æ­¥é©Ÿ / æŒ‡å®šå¹³å°æ‰“é€ å°æ‡‰çš„ Imageï¼Œä¾‹å¦‚å¯ä»¥åŒæ™‚é‡å° AWS / DigitalOcean / vmware ç­‰ä¸åŒå¹³å°å»ºç«‹ï¼Œé€é command line å°±å¯ä»¥å»ºç«‹ Image&lt;/p>
&lt;p>ä»¥ä¸‹æ•™å­¸å°ˆæ³¨åœ¨ AWS çš„ Image å»ºç«‹ä¸Šï¼Œä¸¦åˆ†äº«å¯¦éš›ä½¿ç”¨ç¶“é©—&lt;/p>
&lt;p>Packer åœ¨å»ºç«‹ AWS Image æ™‚æœƒéœ€è¦é–‹æ©Ÿå™¨ï¼Œè‡ªå‹•ä¸Šå‚³çš„ AMI ä¸¦é—œé–‰æ©Ÿå™¨ï¼ŒPacker é–‹ç«‹çš„æ©Ÿå™¨å‹åˆ¥æ™‚ &lt;code>t2.micro&lt;/code> æœ‰å…è²»çš„é¡åº¦ï¼Œä½†å¦‚æœè¶…éå¯èƒ½æœƒæœ‰é¡å¤–çš„ä¸€é»é»è²»ç”¨ï¼Œå–æ±ºæ–¼ build image çš„æ¬¡æ•¸èˆ‡æ™‚é–“ï¼›&lt;br>
å¦å¤– AWS AMI å„²å­˜æ–¼ S3ï¼Œä¹Ÿæœƒæœ‰é¡å¤–çš„æˆæœ¬ï¼ŒPacker åªè² è²¬å»ºç«‹ Imageï¼Œå¾ŒçºŒçš„ç®¡ç†è¦è‡ªå·±è™•ç†&lt;/p>
&lt;p>ä¹‹å‰åœ¨å…¬å¸å»ºç«‹ Image ä¹Ÿæ˜¯è¦å…ˆé–‹æ–°æ©Ÿå™¨ï¼Œå‹•æ‰‹è™•ç†å®Œå£“æˆ Imageï¼Œç¼ºé»æ˜¯æ•´å€‹æ“ä½œæ­¥é©Ÿæ˜¯ä¸é€æ˜ï¼Œé›–ç„¶å¯ä»¥ç¿» bash_history ä½†é‚„æ˜¯ä¸é€™éº¼å®¹æ˜“ï¼Œå¦‚æœæ–‡ä»¶æ¼å¯«å¾Œäººç¶­è­·å°±æœƒå¾ˆç—›è‹¦ï¼›&lt;br>
ç”¨ Packer å°±è§£æ±ºäº† &lt;code>Image å»ºç«‹éç¨‹ä¸é€æ˜&lt;/code>ã€&lt;code>æ¯æ¬¡éƒ½è¦é–‹é—œæ©Ÿå™¨&lt;/code>çš„å›°æ“¾&lt;/p>
&lt;h2 id="å®‰è£">å®‰è£&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.packer.io/downloads.html" target="_blank" rel="noopener"
>Packer ä¸‹è¼‰é€£çµ&lt;/a>&lt;/p>
&lt;h2 id="æŒ‡å®šåŸºç¤-image">æŒ‡å®šåŸºç¤ Image&lt;/h2>
&lt;p>å¯ä»¥åœ¨ &lt;a class="link" href="https://aws.amazon.com/marketplace" target="_blank" rel="noopener"
>AWS Marketplace&lt;/a> ä¸Šæ‰¾æƒ³è¦æ¡ç”¨çš„ Imageï¼Œæˆ–ç›´æ¥æŒ‡å®š ami-idï¼Œä¾‹å¦‚æˆ‘åœ¨ us-east-1 ä½¿ç”¨ Ubuntu 18.04 LTS - Bionic çš„ ami-id æ˜¯ &lt;code>ami-0d03e44a2333dea65&lt;/code>ï¼Œè¦æ‰¾åˆ° ami-id å…¶å¯¦æœ‰é»å°éº»ç…©ï¼Œå¯ä»¥åƒè€ƒä¸‹åˆ—æ­¥é©Ÿ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200415/amiid.png"
loading="lazy"
>&lt;br>
å…ˆæ‰¾åˆ° Imageï¼Œé»é€²å»å¾ŒæŒ‰ &amp;ldquo;Continue to Subscribe&amp;rdquo; -&amp;gt; &amp;ldquo;Continue to Configuration&amp;rdquo; (æ²’æˆªåœ–)ï¼Œæ¥è‘—é¸å®šå€åŸŸå°±èƒ½çœ‹åˆ° ami-id äº†&lt;/p>
&lt;h2 id="packer-è¨­å®šæª”">Packer è¨­å®šæª”&lt;/h2>
&lt;p>Packer çš„è¨­å®šæª”æ˜¯ json æ ¼å¼ï¼Œå…§å®¹ç›¸ç•¶ç°¡å–®æ˜ç­ï¼Œä¸»è¦å››å¡Š&lt;/p>
&lt;ul>
&lt;li>&lt;code>variables&lt;/code>&lt;br>
æ–‡ä»¶æœ‰èªªç‚ºäº†è®Šæ•¸ç®¡ç†æ–¹ä¾¿ï¼Œå¾ŒçºŒè¨­å®šæª”çš„åƒæ•¸å…¨éƒ¨éƒ½è¦å®šç¾©åœ¨é€™è£¡&lt;/li>
&lt;li>&lt;code>builders&lt;/code>&lt;br>
æŒ‡å®šçš„å¹³å°èˆ‡å°æ‡‰çš„å»ºç«‹æ–¹å¼ï¼Œå¦‚ AWS è¦æŒ‡å®š credential / region / vpc ç­‰&lt;/li>
&lt;li>&lt;code>provisioners&lt;/code>&lt;br>
Image è¦åŸ·è¡Œçš„è¨­å®šï¼Œå¯ä»¥ç”¨ shell åŸ·è¡Œ / file ä¸Šå‚³æª”æ¡ˆï¼Œæˆ–æ˜¯å…¶ä»–çš„ provisioning å·¥å…·å¦‚ Ansible ç­‰&lt;/li>
&lt;li>&lt;code>post-processors&lt;/code>&lt;br>
ç”¢ç”Ÿ Image çš„å¾Œè™•ç†ï¼Œå¯ä»¥å£“ç¸®ä¸Šå‚³åˆ°æŒ‡å®šä½ç½®ç­‰ï¼Œé€™é‚Šå…ˆç•¥é&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸‹æª”æ¡ˆæ˜¯å»ºç«‹ API server imageï¼ŒåŸºæ–¼ ubuntu å®‰è£ Nodejs ä¸¦å°‡ Server æª”æ¡ˆä¸Šå‚³è‡³æŒ‡å®šè·¯å¾‘åŸ·è¡Œï¼Œæ‰€ä»¥çš„è¨­å®šæª”åœ¨github ä¸Š &lt;a class="link" href="https://github.com/sj82516/packer_get_started" target="_blank" rel="noopener"
>packer_get_started&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;variables&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;aws_access_key&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;{{env `AWS_ACCESS_KEY_ID`}}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;aws_secret_key&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;{{env `AWS_SECRET_ACCESS_KEY`}}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;region&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;us-east-1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;builders&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;amazon-ebs&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;access_key&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;{{user `aws_access_key`}}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;secret_key&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;{{user `aws_secret_key`}}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;region&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;us-east-1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;source_ami&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ami-0d03e44a2333dea65&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;instance_type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;t2.micro&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ssh_username&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ubuntu&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ami_name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;packer-example {{timestamp}}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;provisioners&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;shell&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;script&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;init.sh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;shell&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;inline&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ls&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;pwd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;source&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;destination&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;~/server&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;shell&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;script&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;start.sh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ json æª”ä¸­ï¼Œè®Šæ•¸å–ç”¨éƒ½æ˜¯ä»¥ &lt;code>{{}}&lt;/code> é›™æ‹¬è™Ÿæ‹¬ä½ï¼Œåªæœ‰åœ¨ &lt;code>variables&lt;/code> ä¸­å¯ä»¥ç”¨ &lt;code>env&lt;/code> æŒ‡å®šä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œä¹Ÿå¯ä»¥ç•™ç©ºåœ¨ command line åŸ·è¡Œæ™‚æŒ‡å®šï¼Œå¦‚ &lt;code>$ packer build -var 'aws_access_key=YOUR ACCESS KEY' ...&lt;/code> &lt;br>
ä¾†æºé‚„å¯ä»¥å¾ Consul / Vault ç­‰åœ°æ–¹ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶&lt;/p>
&lt;p>å¾ŒçºŒéšæ®µè¦è®€å–å°±è¦ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">{{&lt;/span>user &lt;span class="sb">`&lt;/span>aws_access_key/&lt;span class="sb">`&lt;/span>&lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çš„å½¢å¼è®€å– variables ä¸­çš„åƒæ•¸&lt;/p>
&lt;h4 id="builders">builders&lt;/h4>
&lt;p>å¯ä»¥çœ‹åˆ° &lt;code>builders&lt;/code> æ˜¯ä»¥é™£åˆ—å½¢å¼ï¼Œé€™é‚Šå¯ä»¥æŒ‡å®šå¤šå€‹å»ºç«‹çš„ç›®æ¨™ï¼Œä¾‹å¦‚å¢åŠ  vmware / virtualbox ç­‰ç­‰ï¼ŒPacker æœƒä½µç™¼å»ºç«‹ Image&lt;/p>
&lt;h4 id="provisioner">provisioner&lt;/h4>
&lt;p>å¸¸ç”¨æ­é… &lt;code>shell&lt;/code> / &lt;code>file&lt;/code> åŸ·è¡Œ shell script æˆ–æ˜¯ä¸Šå‚³æœ¬åœ°ç«¯è³‡æ–™åˆ° serverä¸Šï¼Œå¯ä»¥æŒ‡å®šåœ¨æŸäº›ç›®æ¨™ä¸‹æ‰è¤‡å¯«ï¼Œå¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;shell&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;script&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;script.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;override&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;vmware-iso&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;execute_command&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;echo &amp;#39;password&amp;#39; | sudo -S bash {{.Path}}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Packer å¤§æ¦‚å°±æ˜¯é€™éº¼ç°¡å–®! Do one thing and do it well. &lt;br>
åŸ·è¡Œçš„æ™‚å€™ç…§æ¨£ hashicorp å·¥å…·çš„æ“ä½œæ–¹å¼ï¼Œ&lt;code>$packer validate&lt;/code> å…ˆæª¢æŸ¥èªæ³•æ­£ç¢ºæ€§ï¼Œæ¥è‘— &lt;code>$packer build&lt;/code> å°±å®Œæˆå›‰&lt;/p>
&lt;p>æœ€å¾Œçœ‹ä¸€ä¸‹ Packer æ¯æ¬¡ Build æ‰€ç”¢ç”Ÿçš„ instance &lt;br>
&lt;img src="https://yuanchieh.page/post/img/20200415/packer-tm.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="ä½¿ç”¨ç¶“é©—è«‡">ä½¿ç”¨ç¶“é©—è«‡&lt;/h2>
&lt;p>ä»¥ä¸‹åˆ†äº«ä¸€äº›å¯¦éš›é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºè¾¦æ³•&lt;/p>
&lt;h3 id="ä½¿ç”¨-aws-build-image-å¶çˆ¾é‡åˆ°-package-å®‰è£å¤±æ•—çš„å•é¡Œ">ä½¿ç”¨ AWS build Image å¶çˆ¾é‡åˆ° package å®‰è£å¤±æ•—çš„å•é¡Œ&lt;/h3>
&lt;p>ç—‡ç‹€å¤§æ¦‚æ˜¯ Packer åœ¨åŸ·è¡Œ &lt;code>$sudo apt-get install&lt;/code> æ™‚å¶ç™¼èªª package not foundï¼Œä½†å¶çˆ¾å¯ä»¥ï¼Œä¸”é€²å»æ©Ÿå™¨å®‰è£ç¶²è·¯ç‹€æ³éƒ½æ˜¯æ²’å•é¡Œçš„&lt;/p>
&lt;p>å•é¡Œä¸»è¦å‡ºè‡ªæ–¼é–‹å•Ÿ AWS æ©Ÿå™¨æ™‚æœ‰å¯èƒ½ç¶²è·¯é‚„æ²’æœ‰å¥½ï¼Œæ‰€ä»¥æ‰æœƒæ˜¯å¶ç™¼æ€§ï¼Œè§£æ±ºè¾¦æ³•å°±æ˜¯ç¢ºèªç¶²è·¯å¥½æ‰é–‹å§‹åŸ·è¡Œ shell scriptï¼Œè©³ç´°è«‹åƒè€ƒ Packer Github Issue &lt;a class="link" href="https://github.com/hashicorp/packer/issues/2639" target="_blank" rel="noopener"
>Option for builder to wait on cloud-init to complete&lt;/a>&lt;/p>
&lt;p>åœ¨ provisions ç¬¬ä¸€æ­¥åŠ å…¥ä»¥ä¸‹ script (ç­”æ¡ˆæ‘˜éŒ„è‡ªä¸Šæ–¹ issue å›è¦†)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">provisions:&lt;span class="o">[{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;shell&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;inline&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/usr/bin/cloud-init status --wait&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å¸Œæœ›åœ¨-launch-æ©Ÿå™¨æ™‚å°±å•Ÿå‹•æœå‹™">å¸Œæœ›åœ¨ launch æ©Ÿå™¨æ™‚å°±å•Ÿå‹•æœå‹™&lt;/h3>
&lt;p>é€™æ¯”è¼ƒååŸæœ‰çš„ç³»çµ± service è¨­å®šï¼Œä½¿ç”¨ ubuntu çš„è©±å¯ä»¥è¨­å®š systemd serviceï¼Œä¸¦æŒ‡å®š target å°±å¯ä»¥åœ¨ launch æ©Ÿå™¨æ™‚å•Ÿå‹•ï¼Œè©³ç´°åƒè€ƒ
&lt;a class="link" href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" target="_blank" rel="noopener"
>How To Use Systemctl to Manage Systemd Services and Units&lt;/a> èˆ‡&lt;br>
&lt;a class="link" href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files" target="_blank" rel="noopener"
>Understanding Systemd Units and Unit Files&lt;/a> å…©ç¯‡ä¾†è‡ª DigitalOcean çš„å¥½æ–‡ï¼Œé è¨ˆé€™ç¯‡æœƒåœ¨ç”¢å‡ºä¸€ç¯‡æ–‡ç«  (æŒ–å‘)&lt;/p>
&lt;h3 id="å¸Œæœ›åœ¨-launch-æ©Ÿå™¨å¾Œå–å¾—æ©Ÿå™¨è³‡è¨Šèˆ‡-ip">å¸Œæœ›åœ¨ launch æ©Ÿå™¨å¾Œå–å¾—æ©Ÿå™¨è³‡è¨Šèˆ‡ IP&lt;/h3>
&lt;p>é€™æ‡‰è©²æ˜¯è »å¯¦ç”¨çš„éœ€æ±‚ï¼Œåƒæ˜¯ç¶å®šä¸€äº›ç¶²è·¯æœå‹™ï¼Œæœƒéœ€è¦åœ¨ config æª”æŒ‡å®šæ©Ÿå™¨çš„ IP ç­‰ï¼Œé ˆæ³¨æ„é€™é‚Šè¦ç­‰åˆ° launch å¾Œæ‰ç¶å®šï¼Œè€Œä¸æ˜¯åœ¨ Packer Build çš„æ©Ÿå™¨ç”¢ç”Ÿï¼Œæ‰€ä»¥æœƒçµåˆä¸Šä¸€é»ï¼ŒæŒ‡å®š script åœ¨æ©Ÿå™¨å•Ÿå‹•å¾Œæ‰åŸ·è¡Œ&lt;/p>
&lt;ol>
&lt;li>å–å¾— AWS æ©Ÿå™¨è³‡è¨Š&lt;/li>
&lt;li>å–å¾— IPv6&lt;/li>
&lt;li>ä¿®æ”¹æ–‡ä»¶&lt;/li>
&lt;/ol></description></item><item><title>Vagrant æ•™å­¸- å¾æœ¬åœ°ç«¯é–‹ç™¼åˆ° AWS éƒ¨ç½²</title><link>https://yuanchieh.page/posts/2020/2020-04-12-vagrant-%E6%95%99%E5%AD%B8-%E5%BE%9E%E6%9C%AC%E5%9C%B0%E7%AB%AF%E9%96%8B%E7%99%BC%E5%88%B0-aws-%E9%83%A8%E7%BD%B2/</link><pubDate>Sun, 12 Apr 2020 11:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-04-12-vagrant-%E6%95%99%E5%AD%B8-%E5%BE%9E%E6%9C%AC%E5%9C%B0%E7%AB%AF%E9%96%8B%E7%99%BC%E5%88%B0-aws-%E9%83%A8%E7%BD%B2/</guid><description>&lt;p>å¤§ç¶± &lt;a class="link" href="https://yuanchieh.page/posts/2020/2020-04-12-infrusture-as-code-%E6%8C%91%E6%88%B0%E8%B3%BD-hashicorp-%E5%B7%A5%E5%85%B7%E9%8F%88%E5%85%A8%E6%95%99%E5%AD%B8/" target="_blank" rel="noopener"
>Infrusture as Code æŒ‘æˆ°è³½ - Hashicorp å·¥å…·éˆå…¨æ•™å­¸&lt;/a>&lt;/p>
&lt;p>Vagrant ä¸»è¦æ˜¯å»ºç«‹èˆ‡ç®¡ç† VM çš„å·¥å…·ï¼Œä¸»è¦å¸Œæœ›åœ¨å·¥ä½œæµç¨‹ä¸­æä¾›ä¸€è‡´çš„ç’°å¢ƒï¼Œä¾‹å¦‚èªªæœ‰æ–°äººåŠ å…¥é–‹ç™¼ï¼Œéœ€è¦åœ¨æœ¬åœ°ç«¯è¨­å®š Runtime ç’°å¢ƒ / è³‡æ–™åº«ç­‰ï¼Œé€™æ™‚å€™å¦‚æœç”¨ Vagrant ä½¿ç”¨ &lt;code>$vagrant up&lt;/code> ä¸€éµå•Ÿå‹•æ‰€æœ‰éœ€è¦çš„ç’°å¢ƒï¼Œå°±éå¸¸çš„æ–¹ä¾¿ï¼Œä¹Ÿå¯ä»¥é¿å…ã€Œæ˜æ˜åœ¨æˆ‘çš„é›»è…¦å°±æ²’å•é¡Œã€çš„å°·å°¬&lt;/p>
&lt;p>Vagrant ä¸»è¦æ˜¯ VM-based çš„å·¥å…·ï¼Œé è¨­ä½¿ç”¨ Virtualboxï¼Œä¹Ÿå¯ä»¥ç”¨ VMWare / AWS ç­‰è™›æ“¬åŒ–å¹³å°&lt;/p>
&lt;p>æœ¬æ¬¡æ•™å­¸ç›®æ¨™ç‚ºéƒ¨ç½²ä¸€å€‹ nodejs api server + mongodb&lt;/p>
&lt;p>github repo åœ¨æ­¤ &lt;a class="link" href="https://github.com/sj82516/vagrant-getting-started" target="_blank" rel="noopener"
>vagrant-getting-started&lt;/a>&lt;/p>
&lt;h2 id="install">Install&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.vagrantup.com/downloads.html" target="_blank" rel="noopener"
>ä¸‹è¼‰ Vagrant&lt;/a>&lt;br>
&lt;a class="link" href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener"
>ä¸‹è¼‰ Virtualbox&lt;/a>&lt;/p>
&lt;h2 id="terminology">Terminology&lt;/h2>
&lt;p>åœ¨ Vagrant æœ‰å¹¾å€‹åè©å…ˆä»‹ç´¹&lt;/p>
&lt;ol>
&lt;li>&lt;code>provider&lt;/code>:&lt;br>
æä¾› Vagrant è™›æ“¬åŒ–çš„ç’°å¢ƒï¼Œé è¨­æ˜¯ virtualboxï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ç¬¬ä¸‰æ–¹ provider&lt;/li>
&lt;li>&lt;code>box&lt;/code>:&lt;br>
å°æ¯”æ˜¯ Docker çš„ Imageï¼Œä¹Ÿå°±æ˜¯ Vagrant è™›æ“¬åŒ–å•Ÿå‹•çš„ Imageï¼Œé€éé€™å€‹åŸºç¤å†å»å®¢è£½åŒ–ï¼Œä»¥ä¸‹ç”¨ ubuntu ç¤ºç¯„&lt;/li>
&lt;li>&lt;code>provision&lt;/code>:&lt;br>
å®¢è£½åŒ–ç’°å¢ƒçš„æ¯ä¸€å€‹æ­¥é©Ÿï¼Œå¯ä»¥ç”¨ &lt;code>shell&lt;/code>åŸ·è¡Œ shell scriptã€&lt;code>file&lt;/code> ä¸Šå‚³æª”æ¡ˆï¼Œæˆ–æ˜¯æ­é… &lt;code>chef/ansible&lt;/code> ç­‰ provisioning å·¥å…·&lt;/li>
&lt;/ol>
&lt;h2 id="get-started">Get Started!&lt;/h2>
&lt;p>é¦–å…ˆå»ºç«‹ä¸€å€‹æª”æ¡ˆå¤¾ &lt;code>vagrant-demo&lt;/code>ï¼Œå…ˆæ‹‰ä¸‹ç­‰ç­‰è¦ç”¨çš„ boxï¼Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">[Host]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vagrant box add ubuntu/trusty64
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥åœ¨é€™é‚Šæ‰¾åˆ°ä½ æƒ³è¦çš„ boxï¼Œ&lt;a class="link" href="https://app.vagrantup.com/boxes/search" target="_blank" rel="noopener"
>Discover Vagrant Boxes&lt;/a>&lt;/p>
&lt;p>æ¥è‘—å»ºç«‹ &lt;code>Vargrantfile&lt;/code> æ–‡ä»¶ï¼Œè£¡é ­å¯«å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="no">Vagrant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">box&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ubuntu/trusty64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¦–å…ˆçœ‹ä¸€ä¸‹èªæ³•ï¼ŒVagrant è¨­å®šæª”æ˜¯ç”¨ Ruby èªæ³•ï¼Œç•¶ç„¶ä¸æœƒ Ruby ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œ&lt;code>Vagrant.configure(&amp;quot;2&amp;quot;)&lt;/code> å®šç¾© Vagrant çš„èªæ³•ç‰ˆæœ¬ï¼Œæ¥è‘— &lt;code>do |config| ... end&lt;/code> å®šç¾© vm çš„è¨­å®šï¼Œconfig æ˜¯æˆ‘å€‘åœ¨é€™å€‹ block ä¸­çš„ vm åç¨±ï¼›&lt;br>
&lt;code>config.vm.box&lt;/code> å‰‡æ˜¯æŒ‡å®šæ¡ç”¨çš„ boxï¼Œconfig.vm åº•ä¸‹æœ‰å¾ˆå¤šåƒæ•¸å¯ä»¥æŒ‡å®šï¼Œè«‹&lt;a class="link" href="https://www.vagrantup.com/docs/vagrantfile/machine_settings.html" target="_blank" rel="noopener"
>åƒè€ƒæ–‡ä»¶&lt;/a>&lt;/p>
&lt;p>æ¥è‘—åŸ·è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Host&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vagrant up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœå®‰è£æ­£ç¢ºï¼Œvagrant æœƒç›´æ¥å•Ÿå‹•æ–°çš„ vmï¼Œå¦‚æœç›´æ¥é–‹ virtuabox æœƒçœ‹åˆ°ä¸€å€‹æ–°çš„ vm instance &lt;br>
&lt;code>$vagrant up&lt;/code> è¡¨ç¤ºä¾åºè·¯å¾‘è®€å– &lt;code>Vagrantfile&lt;/code>(ç•¶å‰è·¯å¾‘ &amp;ndash;æ²’æœ‰æ‰¾åˆ°å†å¾€&amp;ndash;&amp;gt; ../ç•¶å‰è·¯å¾‘ -&amp;gt; &amp;hellip;.)ï¼Œä¸¦å•Ÿå‹•æ–°çš„ vm instanceï¼Œå•Ÿå‹•å¾Œæœƒç™¼ç¾è·¯å¾‘ä¸‹å¤šäº† &lt;code>./.vagrant&lt;/code> çš„è³‡æ–™å¤¾ï¼Œé€™ä¸»è¦æ˜¯è¨˜éŒ„ vagrant åŸ·è¡Œç‹€æ…‹&lt;/p>
&lt;p>æ¥è‘—è®“æˆ‘å€‘ ssh é€²å…¥ vm çœ‹ä¸€ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Host&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vagrant ssh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ssh ç”¨çš„ key ç­‰ç­‰ vagrant éƒ½è™•ç†å¥½äº†ï¼Œssh é€²å…¥å¾Œï¼Œé è¨­æ“ä½œçš„ user æ˜¯ &lt;code>vagrant&lt;/code>ï¼Œå…ˆçœ‹ä¸€ä¸‹ &lt;code>/vagrant&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>VM&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls /vagrant
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½ æœƒæ„å¤–ç™¼ç¾ /vagrant è£¡é ­ç«Ÿç„¶æœ‰ Vagrantfileï¼Œä¸»è¦æ˜¯ vagrant é è¨­æœƒæŠŠæœ¬åœ°ç«¯ Vagrantfile åŒåœ¨çš„è³‡æ–™å¤¾ä¸€ä¸¦åŒæ­¥åˆ° vm åº•ä¸‹çš„ /vagrant ç•¶ä¸­&lt;br>
ä¾ç…§å…±äº«çš„ä¸åŒï¼Œå¯èƒ½æ˜¯ &lt;code>rsync&lt;/code> ä¸€æ¬¡æ€§è¤‡è£½ï¼Œä¹Ÿå¯ä»¥é€é SMB é›™å‘åŒæ­¥å…±äº«è³‡æ–™å¤¾&lt;/p>
&lt;h3 id="provisioning">provisioning&lt;/h3>
&lt;p>æ¥è‘—æˆ‘å€‘å®‰è£ä¸Š nodejsï¼Œè®“æˆ‘å€‘é€é shell script å®‰è£ nvmï¼Œä¸¦å»ºç«‹ server è³‡æ–™å¤¾æ”¾åˆ° vm ä¸­ï¼Œæ¥è‘—é€é pm2 å•Ÿå‹•&lt;br>
å°‡ Vagrantfile æ”¹æˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="no">Vagrant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">box&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ubuntu/trusty64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="ss">:shell&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;init.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="s2">&amp;#34;file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">source&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">destination&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/home/vagrant/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="ss">:shell&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;start.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">synced_folder&lt;/span> &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/vagrant&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">id&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sync&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;rsync&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">rsync__exclude&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;.git/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;server/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;start.sh&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯ä¸€å€‹ &lt;code>config.vm.provision&lt;/code> ä»£è¡¨ä¸€å€‹æ­¥é©Ÿï¼Œæˆ‘å€‘æŒ‡å®šäº†&lt;/p>
&lt;ol>
&lt;li>åŸ·è¡Œ init.shï¼šä¸»è¦æ˜¯å®‰è£ nvm èˆ‡ pm2&lt;/li>
&lt;li>&lt;code>file&lt;/code> æ˜¯ç”¨ä¾†è¤‡è£½æª”æ¡ˆï¼Œå°‡ server è·¯å¾‘è¤‡è£½åˆ° /home/vagrant/ åº•ä¸‹&lt;/li>
&lt;li>start.sh ä¸»è¦æ˜¯å•Ÿå‹• nodejs server&lt;/li>
&lt;/ol>
&lt;p>&lt;code>config.vm.synced_folder&lt;/code> å‰‡æ˜¯é¡¯ç¤ºæŒ‡å®šæˆ‘å€‘è¦åŒæ­¥åˆ° /vagrant åº•ä¸‹çš„è³‡æ–™ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šåˆ°å…¶ä»–è³‡æ–™å¤¾ä¸‹ï¼Œä¸éè¦å°å¿ƒè™•ç†æª”æ¡ˆè·¯å¾‘&lt;/p>
&lt;p>æ¥è‘—åŸ·è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Host&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vagrant provision
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„å¦‚æœé€™æ™‚å€™è·‘ $ vagrant up æ˜¯æ²’æœ‰ç”¨çš„ï¼Œå› ç‚º vm å·²ç¶“å•Ÿå‹•äº†ï¼Œå¦‚æœæ˜¯ Vagrantfile å¢åŠ  provisionï¼Œè¨˜å¾—ç”¨ &lt;code>$ vagrant provision&lt;/code>æˆ– &lt;code>$ vagrant reload --provision&lt;/code>ï¼Œå¦‚æœæ˜¯ Vagrantfile å…¶ä»–è¨­å®šæª”æœ‰æ›´å‹•ï¼Œè«‹ç”¨ &lt;code>$ vagrant reload&lt;/code>&lt;/p>
&lt;p>æ­¤æ™‚ ssh ç™»å…¥å¾Œå¯ä»¥çœ‹åˆ° nodejs server å·²ç¶“åœ¨åŸ·è¡Œäº†&lt;/p>
&lt;p>é€™æ™‚å€™å¥½å¥½èªªä¸€ä¸‹ shell éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">source&lt;/span> ~/.nvm/nvm.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nvm install &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm install -g pm2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æˆ‘åœ¨ init.sh / start.sh è¦å‘¼å« nvm/pm2 ä¹‹å‰éƒ½è¦ &lt;code>$source ~/.nvm/nvm.sh&lt;/code> è€Œé &lt;code>$source ~/.bash.sh&lt;/code>ï¼Œä¸»è¦æ˜¯å› ç‚ºé è¨­ vagrant çš„ .bashrc æœ‰é€™ä¸€æ®µ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If not running interactively, don&amp;#39;t do anything&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span> &lt;span class="nv">$-&lt;/span> in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> *i*&lt;span class="o">)&lt;/span> &lt;span class="p">;;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> *&lt;span class="o">)&lt;/span> &lt;span class="k">return&lt;/span>&lt;span class="p">;;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">esac&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œæˆ‘å€‘åˆå°‡ nvm çš„å•Ÿå‹• script æ”¾åœ¨é€™ä¸€æ®µä¹‹å¾Œæ‰æœƒå°è‡´ shell æ‰¾ä¸åˆ° nvm commandï¼Œæ‰€ä»¥è¦æ”¹æˆ&lt;code>$source ~/.nvm/nvm.sh&lt;/code>ï¼Œé€™éƒ¨åˆ†æ˜¯åƒè€ƒ stackoverflow &lt;a class="link" href="https://stackoverflow.com/questions/38555554/why-is-nvm-command-installed-as-root-and-also-not-found-during-vagrant-bootstrap" target="_blank" rel="noopener"
>Why is nvm command installed as root and also not found during vagrant bootstrap.sh?&lt;/a>&lt;/p>
&lt;p>å…¶ä»–çš„ provisioning å·¥å…·æ­é…è«‹&lt;a class="link" href="https://www.vagrantup.com/docs/provisioning/" target="_blank" rel="noopener"
>åƒè€ƒæ–‡ä»¶&lt;/a>&lt;/p>
&lt;h3 id="destroy">destroy&lt;/h3>
&lt;p>å¦‚æœé–‹ç™¼éç¨‹ä¸­æœ‰èª¤ï¼Œå»ºè­° Vagrantfile æ”¹å®Œç åˆ° vm é‡ä¾†ï¼Œä½¿ç”¨
&lt;code>$ vagrant destroy&lt;/code>ï¼Œä¸»è¦æ˜¯æ¯æ¬¡åŸ·è¡Œ $ vagrant provision æœƒä¸æ–·åœ¨åŸæœ¬çš„ vm instance æ“ä½œï¼Œé€™æ¨£æœƒå°è‡´æ¯æ¬¡ç–ŠåŠ çµæœè€Œé•å immutable&lt;/p>
&lt;h3 id="network">network&lt;/h3>
&lt;p>åœ¨ Vagrant ä¸­ï¼Œç¶²è·¯å¤§è‡´æœ‰ä¸‰ç¨®è¨­å®šæ–¹å¼&lt;/p>
&lt;ol>
&lt;li>&lt;code>Port Forward&lt;/code>&lt;br>
è®“ Host ç’°å¢ƒå¯ä»¥ç”¨æŒ‡å®š port å°æ‡‰ VM ä¸­çš„ port&lt;/li>
&lt;li>&lt;code>Private Network&lt;/code>&lt;br>
æŒ‡å®š private ip è®“å…§ç¶²çš„æ©Ÿå™¨éƒ½èƒ½é€é ip æºé€š&lt;/li>
&lt;li>&lt;code>Public Network&lt;/code>&lt;br>
Vagrant é è¨­æ•´åˆ Ngrokï¼Œå¯ä»¥ç”¨å…¬é–‹é€£çµé€£ç·š&lt;/li>
&lt;/ol>
&lt;p>æ­¤æ™‚ nodejs server åªèƒ½åœ¨ vm å…§éƒ¨ä½¿ç”¨ï¼Œæˆ‘å€‘ç”¨ Port Forward æ–¹å¼è®“ host ä¹Ÿå¯ä»¥å‘¼å« &lt;br>
ä¿®æ”¹ Vagrantfile&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="no">Vagrant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">network&lt;/span> &lt;span class="s2">&amp;#34;forwarded_port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">guest&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">host&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">8080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—ç”¨ &lt;code>$ vagrant reload&lt;/code>
é€™æ™‚å€™åœ¨ Host å°±å¯ä»¥ç™¼è«‹æ±‚åˆ° VM ä¸Šå›‰ &lt;code>$ curl localhost:8080&lt;/code>&lt;/p>
&lt;h2 id="å°çµ">å°çµ&lt;/h2>
&lt;p>åœ¨ Provisioning éƒ¨åˆ†ï¼Œå€‹äººè¦ºå¾—ç”¨ shell script æœ‰é»ä¸å¤ªæ–¹ä¾¿ï¼Œä¾‹å¦‚èªªåˆ‡æ› OS æ™‚ script å°±éœ€è¦ä¿®æ”¹ï¼Œè€Œä¸”å¾ˆæŒ‡ä»¤å¼è€Œéå®£å‘Šå¼ï¼Œå¦‚æœèƒ½ç”¨å…¶ä»–çš„ provisioning tool å»ç®¡ç†ï¼Œåˆæˆ–æ˜¯ä½¿ç”¨ image / container å»éš”é›¢å°åº•å±¤ OS çš„ç›¸ä¾ï¼Œé€™å‹¢å¿…æœƒæ–¹ä¾¿å¾ˆå¤š&lt;/p>
&lt;p>Vagrant æœ‰æä¾› AWS providerï¼Œä½†å› ç‚ºæ˜¯ç¤¾ç¾¤é–‹ç™¼å¥—ä»¶å°±æš«ä¸”ä¸è©¦ï¼Œå°ˆæ³¨åœ¨æ­å»ºæœ¬åœ°ç«¯çš„é–‹ç™¼ç’°å¢ƒ&lt;/p>
&lt;p>ç›®å‰æ˜¯åªæœ‰ä¸€å° api serverï¼Œæ¥è‘—è¦é…ç½® DB ä¸¦æ”¾åœ¨åŒä¸€å€‹ Vagrantfile ä¸­æ•´ç†&lt;/p>
&lt;h2 id="multi-machile">Multi machile&lt;/h2>
&lt;p>å¦‚æœè¦åœ¨ Vagrantfile ä¸­å®šç¾©å¤šå€‹ vm instanceï¼Œå¯ä»¥é€é &lt;code>config.vm.define&lt;/code> å€éš”ï¼Œé è¨­æœƒç¹¼æ‰¿å…¨åŸŸçš„æ‰€æœ‰ provisionï¼Œä½†æ˜¯å€‹åˆ¥å®šç¾©ä¸­å¯ä»¥è¤‡å¯«æˆ–æ˜¯å®¢è£½åŒ–ï¼Œå¦‚ä»¥ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="no">Vagrant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">box&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ubuntu/trusty64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">define&lt;/span> &lt;span class="s2">&amp;#34;api&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="ss">:shell&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;init.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="s2">&amp;#34;file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">source&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">destination&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/home/vagrant/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="ss">:shell&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;start.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">synced_folder&lt;/span> &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/vagrant&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">id&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sync&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;rsync&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">rsync__exclude&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;.git/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;server/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;start.sh&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">network&lt;/span> &lt;span class="s2">&amp;#34;forwarded_port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">guest&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">3000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">host&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">8080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">define&lt;/span> &lt;span class="s2">&amp;#34;db&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">provision&lt;/span> &lt;span class="ss">:shell&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;./mongodb/install.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæƒ³è¦æŒ‡å®šå…¶ä¸­ä¸€å°ä¸‹æŒ‡ä»¤ï¼Œé‡å°åç¨±å°±å¥½å¦‚ &lt;code>$vagrant ssh db&lt;/code>&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>å€‹äººè¦ºå¾—é–‹ç™¼&lt;code>ä¸æ¨è–¦&lt;/code>ç”¨ Vagrant (é‚£æ€éº¼èŠ±äº†ä¸€å€‹å‡æ—¥&amp;hellip;)ï¼Œä¸»è¦æ˜¯ç¤¾ç¾¤çœ‹èµ·ä¾†æ²’æœ‰å¾ˆæ´»èºï¼Œä¾‹å¦‚æœ€å¤šäººä¸‹è¼‰çš„ box ubuntu/trusty64 é‚„æ˜¯åœ¨ 14.04 çš„ç‰ˆæœ¬ï¼Œæƒ³è¦ç›´æ¥æ‰¾ Mongodb çš„ box ä¹Ÿæ²’æœ‰(å¤§å¤šçš„ db éƒ½æ²’æœ‰)ï¼Œä¸”æ•´å€‹é…ç½®ä¸Šæ²’æœ‰å¾ˆæ–¹ä¾¿ï¼Œä¾‹å¦‚ shell script åˆ‡æ› os å°±è¦é‡å¯«ï¼Œé‚„ä¸å¦‚ç”¨ docker + docker compose ä¾†å¾—å¿«é€Ÿ&lt;br>
ä½†å¦‚æœä½ æ˜¯ä¸€å®šè¦ç”¨ vm é‚£æˆ–è¨± Vagrant é‚„æ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡&lt;/p>
&lt;p>å¦‚æœä½ æœ‰å…¶ä»–å»ºè­°ï¼Œåˆæˆ–æ˜¯æœ‰è¦ºå¾— Vagrant æœ‰å²å®³ç¨ç‰¹çš„æ‡‰ç”¨å ´æ™¯å†éº»ç…©æŒ‡æ•™ï½&lt;/p></description></item><item><title>Infrusture as Code æŒ‘æˆ°è³½ - Hashicorp å·¥å…·éˆå…¨æ•™å­¸</title><link>https://yuanchieh.page/posts/2020/2020-04-12-infrusture-as-code-%E6%8C%91%E6%88%B0%E8%B3%BD-hashicorp-%E5%B7%A5%E5%85%B7%E9%8F%88%E5%85%A8%E6%95%99%E5%AD%B8/</link><pubDate>Sun, 12 Apr 2020 02:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-04-12-infrusture-as-code-%E6%8C%91%E6%88%B0%E8%B3%BD-hashicorp-%E5%B7%A5%E5%85%B7%E9%8F%88%E5%85%A8%E6%95%99%E5%AD%B8/</guid><description>&lt;p>æœ€è¿‘é–‹å§‹æ¥è§¸ DevOps èˆ‡ Infrasture as Code çš„æ¦‚å¿µï¼Œæ·±æ·±è¢«ç”¨ç¨‹å¼ç¢¼ç®¡ç†éƒ¨ç½²æµç¨‹èˆ‡æ¶æ§‹è¨­è¨ˆæ„Ÿåˆ°è‘—è¿·ï¼Œå°å·¥ç¨‹å¸«ä¾†èªªæœ€æ£’çš„æ–‡ä»¶è«éæ–¼çµæ§‹æ¸…æ™°ã€æ²’æœ‰é‡è¤‡å†—ä½™çš„ä¹¾æ·¨ç¨‹å¼ç¢¼ï¼Œå°¤å…¶æ˜¯æŠŠéå¾€é€éäººå·¥æ“ä½œçš„ä¸ç©©å®šæ€§ä¸€åˆ‡æ”¤é–‹åœ¨é™½å…‰ä¸‹ç”¨ Code Review æ–¹å¼æª¢è¦–æ¯ä¸€å€‹ç’°ç¯€ï¼Œè®“ç¨‹å¼ç¢¼å¾å‡ºç”Ÿåˆ°éƒ¨ç½²éƒ½å¯ä»¥å®Œæ•´åœ°è¢«æª¢è¦–ï¼›&lt;br>
å†è€…åœ¨ Cloud-Native æ™‚ä»£ï¼Œèƒ½å¤ è·¨å€åŸŸéƒ¨ç½²ã€ç”šè‡³æ··åˆé›²éƒ¨ç½²èƒ½å¤ è®“å…¬å¸çš„æ€§èƒ½èˆ‡æˆæœ¬ä¸Šç²å¾—æ›´å¤§çš„å½ˆæ€§&lt;/p>
&lt;p>åªæ˜¯åœ¨å­¸ç¿’éç¨‹ä¸­ï¼Œè¢«ä¸€å †æŠ€è¡“å·¥å…·è½Ÿç‚¸ï¼Œæ¯å€‹å·¥å…·ä¹‹é–“åˆæœ‰äº›é‡è¤‡åˆä¸æ€éº¼ç›¸åŒçš„åŠŸèƒ½ï¼Œåˆæˆ–æ˜¯æŠ½è±¡ç•«å±¤ç´šä¸åŒ (Container vs VM)ï¼Œåƒæ˜¯ Chef / Ansible / Terraform / Kubernetes / Docker ç­‰ç­‰ï¼Œæ¯æ¬¡æ±å­¸ä¸€äº›è¥¿å­¸ä¸€äº›ç¸½æ˜¯ä¸€å€‹é ­å…©å€‹å¤§ï¼Œæœ€è¿‘çœ‹äº†ä¾†è‡ª Hashicorp çš„ä»‹ç´¹å½±ç‰‡ä»¥åŠä¸€ç¯‡æ–‡ç« æ•´ç†ï¼Œè¦ºå¾—åœ¨è§€å¿µä¸Šæ›´åŠ çš„èæœƒè²«é€šï¼Œè‡³å°‘æ›´æ¸…æ¥šçŸ¥é“ &lt;code>éƒ¨ç½²çš„æµç¨‹&lt;/code> èˆ‡å°æ‡‰çš„å·¥å…·æ‡‰ç”¨&lt;/p>
&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/wyRtz_tdJes"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>&lt;a class="link" href="https://blog.gruntwork.io/why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation-7989dad2865c" target="_blank" rel="noopener"
>Why we use Terraform and not Chef, Puppet, Ansible, SaltStack, or CloudFormation&lt;/a>&lt;/p>
&lt;p>ç°¡å–®ç¸½çµä¸€ä¸‹ä¸Šé¢å…©å€‹åƒè€ƒè³‡æ–™çš„æƒ³æ³•&lt;/p>
&lt;h2 id="application-delivery-with-hashicorp">Application Delivery with HashiCorp&lt;/h2>
&lt;p>ç•¶åœ¨é–‹ç™¼æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œè¦æ­£ç¢ºåœ°äº¤ä»˜åˆ°ç”¨æˆ¶æ‰‹ä¸­æœ‰ä¸€æ®µè·¯è¦èµ°ï¼Œä¸»è¦åˆ†æˆå¹¾å€‹éšæ®µ&lt;/p>
&lt;h3 id="1-write-æœ¬åœ°é–‹ç™¼">1. Write æœ¬åœ°é–‹ç™¼&lt;/h3>
&lt;p>åœ¨æœ¬åœ°ç«¯é–‹ç™¼æ™‚ï¼Œé–‹ç™¼è€…æœƒéœ€è¦æœ‰è·Ÿæ­£å¼ç’°å¢ƒé¡ä¼¼çš„é…ç½®ï¼Œä¾‹å¦‚è³‡æ–™åº«ç­‰ï¼Œé€™æ™‚å€™å¯ä»¥ç”¨ &lt;code>Vagrant&lt;/code> å»ºåˆ¶é–‹ç™¼ç’°å¢ƒ&lt;/p>
&lt;h3 id="2-test-æ¸¬è©¦">2. Test æ¸¬è©¦&lt;/h3>
&lt;p>é€²è¡Œæ¸¬è©¦æ™‚ä¹Ÿéœ€è¦ä¸€å€‹ä¹¾æ·¨ã€ç¨ç«‹ã€èˆ‡æ­£å¼ç’°å¢ƒæ¥è¿‘çš„é…ç½®ï¼ŒåŒæ¨£èƒ½ç”¨ &lt;code>Vagrant&lt;/code>&lt;/p>
&lt;h3 id="3-package-æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼">3. Package æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼&lt;/h3>
&lt;p>ç•¶ç¨‹å¼ç¢¼æ¸¬è©¦å®Œï¼Œè¦æº–å‚™éƒ¨ç½²æ™‚ï¼Œé‚„éœ€è¦æŠŠè¨­å®šæª”ã€ç’°å¢ƒè®Šæ•¸ç­‰ä¸€ä½µæ‰“åŒ…è®Šæˆä¸€å€‹å¯éƒ¨ç½²çš„æœ€å°å–®å…ƒï¼Œæ­¤æ™‚èƒ½ç”¨ &lt;code>Packer&lt;/code> ä¾æ“šä¸åŒç’°å¢ƒ(AWS/GCP&amp;hellip;)æ‰“åŒ…å‡º Image&lt;/p>
&lt;h3 id="4-provision-day1day2-æ©Ÿå™¨çš„ç’°å¢ƒè¨­å®š">4. Provision (Day1/Day2+) æ©Ÿå™¨çš„ç’°å¢ƒè¨­å®š&lt;/h3>
&lt;p>æ‡‰ç”¨ç¨‹å¼éœ€è¦å®Œæ•´çš„æ¶æ§‹è¨­è¨ˆï¼Œä¾‹å¦‚èªª CDN / DNS / Networking / Firewall / Storage System ç­‰ç­‰ï¼Œé€™æ™‚å€™å¯ä»¥ç”¨ &lt;code>Terraform&lt;/code> é…ç½® dev/stage/prod ç’°å¢ƒ&lt;/p>
&lt;h3 id="5-deploy-éƒ¨ç½²æ–¹å¼-orchestration">5. Deploy éƒ¨ç½²æ–¹å¼ (Orchestration)&lt;/h3>
&lt;p>éƒ¨ç½²æ–¹å¼å¸¸è¦‹æœ‰ Canary / Blue-Green ç­‰ï¼Œåˆæˆ–æ˜¯é‡åˆ°æµé‡èµ·ä¼æ™‚çš„ Auto-Scalingï¼Œå¯ä»¥ç”¨ &lt;code>Nomand&lt;/code>ï¼Œå°‡ Dev è·Ÿ Ops ç¨ç«‹æ‹†åˆ†ï¼ŒDev åªéœ€è¦å°ˆæ³¨åœ¨éœ€è¦çš„é‹ç®—è³‡æºã€éƒ¨ç½²æµç¨‹çš„æŒæ¡ï¼ŒOps å‰‡è² è²¬åº•å±¤çš„æ©Ÿå™¨é…ç½®ã€æ•¸é‡ç®¡æ§ã€æ©Ÿå™¨çš„å®‰å…¨æ€§è£œä¸ç­‰&lt;/p>
&lt;h3 id="6-monitor-ç›£æ§">6. Monitor ç›£æ§&lt;/h3>
&lt;p>Hashicorp ç›®å‰æ²’æœ‰ç›´æ¥ç›¸é—œçš„ç”¢å“ï¼Œä½†æœ‰æä¾› &lt;code>Consul&lt;/code>ï¼Œå¦‚æœæ˜¯æ¡ç”¨ Microservice / SOA æ¶æ§‹ï¼Œå…§éƒ¨æœå‹™é–“å¦‚ä½•ç™¼ç¾å½¼æ­¤éœ€è¦å…§éƒ¨çš„ DNSè™•ç† / æ©Ÿå™¨è¦æ€éº¼ç®¡ç† config éƒ½æ˜¯å€‹å•é¡Œï¼ŒConsul é€é Key/Store å„²å­˜è§£æ±ºé€™é¡çš„å•é¡Œ&lt;/p>
&lt;h3 id="7-security">7. Security!&lt;/h3>
&lt;p>å¦ä¸€å€‹ä¸å†æµç¨‹ä¸­ä½†é–‹ç™¼è€…éœ€æ™‚æ™‚ç‰¢è¨˜åœ¨å¿ƒ &lt;code>Security&lt;/code>ï¼Œä¸€èˆ¬ä¾†èªª key æœƒåœ¨æ‰“åŒ…éšæ®µè¢«ä¸€ä¸¦æ”¾é€²ï¼Œä½†æ˜¯é€™æ¨£ç›¸å°ä¸å¤ªå®‰å…¨ï¼Œ&lt;code>Vault&lt;/code> æä¾›key è‡ªå‹• rotate / ä¸­å¿ƒåŒ–ç®¡ç† credential / ä¸­å¿ƒåŒ–è™•ç†åŠ è§£å¯†éç¨‹ï¼Œé™ä½æ©Ÿå™¨è¢«æ”»é™·å¾Œçš„å½±éŸ¿èˆ‡æ›´å¿«é€Ÿå½ˆæ€§çš„æ›¿æ› keyï¼Œå¢åŠ å®‰å…¨æ€§ä¿è­‰&lt;/p>
&lt;p>ä»¥ä¸Šå·¥å…·éƒ½èƒ½å¤ æ•´åˆ VM / Container based çš„ç’°å¢ƒï¼Œä¹Ÿæœ‰è¨±å¤šä¸åŒçš„æ›¿ä»£æ–¹æ¡ˆï¼›&lt;br>
ä¾‹å¦‚ Docker å¯ä»¥å–®ç¨åƒæ‰ Write/Test/Package çš„åŠŸèƒ½ï¼ŒK8S å‰‡è² è²¬ Deploy èˆ‡ Monitoringï¼Œå¦‚æœæ˜¯è¨—ç®¡æ–¼ Cloud å‰‡ç”± Cloud è² è²¬ éƒ¨åˆ†Provisionçš„åŠŸèƒ½(å¦‚ Load Balancerï¼Œä½†ä¸æœƒè‡ªå‹•è¨­å®š Public DNS æˆ– S3 é€™é¡æ¶æ§‹)&lt;/p>
&lt;p>å…¶ä¸­ &lt;code>Nomand&lt;/code> è·Ÿ K8S æ¯”è¼ƒæ˜¯äº’è£œçš„å·¥å…·ï¼ŒHashicorp æåˆ° K8s ä¸Šæ‰‹å­¸ç¿’æ›²ç·šå¤ªé«˜ï¼Œå¾ˆå¤šæ™‚å€™æˆ‘å€‘ä¸ä¸€å®šè¦é€™éº¼è¤‡é›œä½†å¼·å¤§çš„å·¥å…·ï¼Œå¦‚æœåŸæœ¬æ˜¯ VM based æ¶æ§‹é‚£ç”¨ Nomand ç®¡ç†éƒ¨ç½²æœƒè¼•é¬†ã€ç›´è§€å¾ˆå¤š&lt;/p>
&lt;h2 id="why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation">Why we use Terraform and not Chef, Puppet, Ansible, SaltStack, or CloudFormation&lt;/h2>
&lt;p>é€™ç¯‡çš„ä½œè€…éå¸¸å²å®³ï¼Œä¹‹å‰æ‹œè®€äº†å…¨éƒ¨çš„ Terraform æ•™å­¸å€‹äººè¦ºå¾—æ¯”å®˜ç¶²æ›´å¯¦åœ¨ï¼Œé€™ä¸€ç¯‡æ–‡ç« å«é‡‘é‡ä¸€æ¨£è¶…é«˜ï¼Œå¾æ›´é«˜å±¤ç´šçš„è§’åº¦çœ‹é€™é¡å‹çš„å·¥å…·ï¼Œ&lt;strong>Chef, Puppet, Ansible, SaltStack&lt;/strong> ä¸»è¦æ˜¯åš &lt;code>Configuration management&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä¸€å°ä¹¾æ·¨çš„æ©Ÿå™¨å•Ÿå‹•å¾Œè¦åšä»€éº¼é…ç½®ï¼Œä¾‹å¦‚ API Server éœ€è¦å®‰è£ program runtime ä¸¦éƒ¨ç½²ç¨‹å¼ç¢¼ / DB server è¦å®‰è£ DB ä¸¦æ­é…å®‰å…¨æ€§é…ç½®ç­‰ç­‰&lt;/p>
&lt;p>è€Œ Terraform / CloudFormation æ˜¯ &lt;code>Provision&lt;/code>ï¼Œæ˜¯é…ç½®æ•´å€‹æ¶æ§‹ï¼Œæ‰€ä»¥å…©è€…çš„è¨è«–é¢å‘ä¸åŒï¼Œé›–ç„¶åƒ Ansible ä¹Ÿèƒ½åšä¸€äº› Provision å·¥ä½œï¼Œä½†ç›¸è¼ƒå°±ä¸é©åˆ&lt;/p>
&lt;p>æ¥è‘—æ˜¯ &lt;code>Mutable / Immutable&lt;/code> çš„å•é¡Œï¼ŒChef/Ansible ç­‰å·¥å…·åœ¨ç”¢ç”Ÿé…ç½®è®ŠåŒ–æ™‚æœƒåœ¨åŒä¸€å°æ©Ÿå™¨ç™¼ç”Ÿï¼Œä¹Ÿå°±æ˜¯ Mutableï¼Œç•¶ç´¯ç©çš„è®ŠåŒ–è®Šå¤šæ™‚å¯èƒ½æœƒæœ‰é…ç½®è¡çªçš„å•é¡Œï¼›&lt;br>
å¦‚æœæ˜¯ç”¨ Terrform æ­é… Packer/Docker ç­‰ï¼Œæ¯æ¬¡éƒ½æœƒç”¢ç”Ÿæ–°çš„æ©Ÿå™¨ï¼Œæ‰€ä»¥æ˜¯ Immutableï¼Œè¡Œç‚ºç›¸å°æ¯”è¼ƒå–®ç´”ä¸”å¯é æ¸¬&lt;/p>
&lt;p>æ¥è‘—ä½œè€…é‚„å¾èªæ³•ä¸Šã€ç®¡ç†ä¸Šã€ç¤¾ç¾¤å¤§å°åšäº†æ¯”å°ã€‚&lt;/p>
&lt;p>æŠ€è¡“å±¤é¢ä¸Šå¯ä»¥åšä¸åŒæ··æ­ï¼Œä¾‹å¦‚ Terraform + Ansibleï¼Œé…ç½®å¥½æ¶æ§‹å¾Œç”¨ Ansible ç®¡ç†æ¯ä¸€å°æ©Ÿå™¨çš„è¨­å®šï¼›
åˆæˆ–æ˜¯ Terraform + Packer + Docker + Kubernetesï¼Œä¸€æ¨£æ¶æ§‹é…ç½®å¥½ä¸”æ©Ÿå™¨çš„ Image é è¨­éƒ½è£æœ‰ Docker èˆ‡ K8s agentï¼Œå¾ŒçºŒç”¨ K8s ç®¡ç†éƒ¨ç½²çš„æµç¨‹&lt;/p>
&lt;h2 id="å¯¦ä½œ">å¯¦ä½œ&lt;/h2>
&lt;p>çœ‹å®Œå°æ–¼æ•´å€‹éƒ¨ç½²æµç¨‹èˆ‡å·¥å…·æ›´åŠ çš„ç†è§£äº†ï¼Œæ­¤æ™‚ç•¶ç„¶è¦æŒ‘æˆ°è‡ªå·±å‹•æ‰‹æ­å»ºæ•´å€‹ç’°å¢ƒï¼Œä»¥ API Server + DB çš„æ¶æ§‹å»æŒ‘æˆ° Hashicorp å…¨å¥—å·¥å…·éŠï¼Œå¸Œæœ›ç”¨ä¸€å€‹æœˆå·¦å³æ™‚é–“å®Œæˆï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„æ•™å­¸è¨˜éŒ„ï¼Œå¸Œæœ›èƒ½å¤ å¹«åŠ©åˆ°å¤§å®¶&lt;/p>
&lt;p>&lt;a class="link" href="https://yuanchieh.page/post/2020-04-12_vagrant-%E6%95%99%E5%AD%B8-%E4%B8%80%E9%8D%B5%E5%95%9F%E5%8B%95%E9%85%8D%E7%BD%AE%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/" target="_blank" rel="noopener"
>Vagrant æ•™å­¸-ä¸€éµå•Ÿå‹•é…ç½®é–‹ç™¼ç’°å¢ƒ&lt;/a>&lt;br>
&lt;a class="link" href="https://yuanchieh.page/post/2020-04-15_packer-%E6%95%99%E5%AD%B8-%E6%89%93%E9%80%A0-image-copy/" target="_blank" rel="noopener"
>Packer æ•™å­¸- æ‰“é€  Image&lt;/a> &lt;br>
&lt;a class="link" href="https://yuanchieh.page/post/2020-04-20_vault-%E6%95%99%E5%AD%B8-%E9%9B%86%E4%B8%AD%E5%8C%96%E7%AE%A1%E7%90%86%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99-%E4%B8%8A/" target="_blank" rel="noopener"
>Vault æ•™å­¸-é›†ä¸­åŒ–ç®¡ç†æ©Ÿæ•è³‡æ–™ (ä¸Š)&lt;/a>
&amp;hellip;å¾…çºŒ&lt;/p></description></item><item><title>é–±è®€å¿ƒå¾—ã€ŠDesigning with Data å–„ç”¨æ•¸æ“šå¹«ä½ æ‰“é€ å¥½è¨­è¨ˆã€‹</title><link>https://yuanchieh.page/posts/2020/2020-04-05-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97designing-with-data-%E5%96%84%E7%94%A8%E6%95%B8%E6%93%9A%E5%B9%AB%E4%BD%A0%E6%89%93%E9%80%A0%E5%A5%BD%E8%A8%AD%E8%A8%88/</link><pubDate>Sun, 05 Apr 2020 11:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-04-05-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97designing-with-data-%E5%96%84%E7%94%A8%E6%95%B8%E6%93%9A%E5%B9%AB%E4%BD%A0%E6%89%93%E9%80%A0%E5%A5%BD%E8%A8%AD%E8%A8%88/</guid><description>&lt;p>å…¬å¸ä»Šå¹´åº¦é–‹å§‹å…¨é¢å°å…¥æ•¸æ“šé©…å‹•è¨­è¨ˆï¼Œæ¯å€‹éƒ¨é–€çš„æ‰€æœ‰å°ˆæ¡ˆéƒ½å¿…é ˆæœ‰æ˜ç¢ºçš„æ•¸æ“šè©•ä¼°æˆæ•ˆï¼Œèº«ç‚ºä¸€å€‹å·¥ç¨‹å¸«ï¼Œçœ‹åˆ°å…¬å¸å¾€æ›´æœ‰é‚è¼¯çš„æ–¹å¼çµ„ç¹”å°ˆæ¡ˆï¼Œç”¨æ›´å¤šçš„ç†æ€§æ•¸æ“šç•¶ä½œä¾æ“šä¾†å®‰æ’åšäº‹çš„å„ªå…ˆé †åºæ„Ÿåˆ°é–‹å¿ƒï¼Œé€™è®“æˆ‘å€‘æ“ºè„«çª®å¿™çš„å±€é¢ï¼Œå°ˆæ³¨åœ¨åŸ·å¾—æŠ•è³‡çš„é …ç›®ä¸Šï¼›&lt;/p>
&lt;p>ä½†å¦ä¸€æ–¹é¢ä¹Ÿæ„Ÿåˆ°æ†‚æ…®ï¼Œæ˜¯ä¸æ˜¯ä»»ä½•ç¾éšæ®µç„¡æ³•ä½¿ç”¨æ•¸æ“šè¡¡é‡çš„äº‹ç‰©å°±å®Œå…¨ä¸é‡è¦ï¼Ÿä¾‹å¦‚ç”¨æˆ¶é«”é©—ã€å·¥ç¨‹å“è³ªç­‰ç­‰ï¼Œæ˜¯ä¸æ˜¯æˆ‘å€‘èµ°å‘æ•¸æ“šçš„åŒæ™‚å°±æˆäº†å®Œå…¨ç™¾åˆ†ç™¾çš„è³ºéŒ¢æ©Ÿå™¨ï¼Ÿ&lt;/p>
&lt;p>åŸºæ–¼é€™æ¨£çš„è€ƒé‡ï¼ŒåŒäº‹æ¨è–¦äº†é€™æœ¬æ›¸ã€ŠDesigning with Data å–„ç”¨æ•¸æ“šå¹«ä½ æ‰“é€ å¥½è¨­è¨ˆã€‹&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20200405/bookcover.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>é€™æœ¬æ›¸ä»¥è¨­è¨ˆå¸«ç‚ºå‡ºç™¼ï¼Œé—¡è¿°æ•¸æ“šæ˜¯è¨­è¨ˆå¸«çš„å¥½æœ‹å‹ï¼Œè€Œä¸æ˜¯æ‰¼æ®ºå‰µæ„çš„ç‰¢ç± ï¼ŒåŒæ¨£çš„é€™å¥è©±æˆ‘è¦ºå¾—ä¹Ÿèƒ½å¥—ç”¨åˆ°å·¥ç¨‹å¸«èº«ä¸Š(&lt;code>å·¥ç¨‹å¸«ä¹Ÿæ˜¯æœ‰å°å“è³ªè¦æ±‚çš„æµªæ¼«&lt;/code>)&lt;/p>
&lt;p>å¦‚æœä½ è·Ÿæˆ‘æœ‰ä¸€æ¨£çš„æ“”æ†‚ï¼Œåˆæˆ–æ˜¯æƒ³çŸ¥é“è‰¯å¥½çš„æ•¸æ“šé©…å‹•è¨­è¨ˆæ˜¯æ€éº¼æ­£å‘çš„æ¨å‹•ï¼Œé€™æœ¬æ›¸ç„¡ç–‘æ˜¯å€‹å¾ˆæ£’çš„å…¥é–€æ›¸ (æˆ‘å€‘å…¬å¸çš„è³‡æ·± UX è¨­è¨ˆå¸« / PM éƒ½æ¨è–¦é–±è®€)&lt;/p>
&lt;h2 id="æ•¸æ“šæ€ç¶­">æ•¸æ“šæ€ç¶­&lt;/h2>
&lt;p>æ•¸æ“šçš„æœ¬èº«åªæ˜¯å€‹å–®ç´”çš„è¨ˆæ•¸ï¼Œä»–å¯ä»¥æ˜¯ç¶²é ä¸ŠæŒ‰éˆ•é»æ“Šçš„æ¬¡æ•¸ã€ç”¨æˆ¶åœç•™çš„æ™‚é–“é•·ï¼Œåˆæˆ–æ˜¯ app store çµ¦äºˆçš„è©•åƒ¹æ˜Ÿç­‰ï¼Œæ•¸æ“šæ˜¯å€‹ç†æ€§ä¸”æ²’æœ‰æ„ç¾©çš„å­˜åœ¨ï¼Œåªæœ‰ç•¶äººå€‘è§£è®€æ™‚æ‰è³¦äºˆäº†å«ç¾©&lt;/p>
&lt;p>ç•¶æˆ‘å€‘é–‹å§‹è§£è®€æ•¸æ“šï¼Œå¯ä»¥åˆ†æˆä¸‰å€‹å±¤æ¬¡çš„æ€ç¶­&lt;/p>
&lt;ol>
&lt;li>æ•¸æ“šé©…å‹•&lt;br>
æ•¸æ“šçš„è¡¨ç¾å¾ˆæ˜ç¢ºï¼Œå¯ä»¥ç›´æ¥å›ç­”åœ˜éšŠçš„å•é¡Œï¼Œä¸¦é©…å‹•çµè«–çš„ç”¢ç”Ÿ&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ä¾‹å¦‚èªªå¸Œæœ›é€éæ”¹å–„ä»˜è²»é é¢å¢åŠ è½‰æ›ç‡ï¼Œæ­¤æ™‚é€éå¯¦é©—è§€å¯Ÿåˆ°è½‰æ›ç‡çš„é«˜æˆ–ä½ï¼Œå°±èƒ½æœ‰æ˜ç¢ºçš„çµè«–çŸ¥é“æ”¹å–„æ˜¯å¦æœ‰æ•ˆ&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>æ•¸æ“šå•Ÿç¤º&lt;br>
ç•¶é¢å°ä¸€å€‹æ¨¡ç³Šä¸æ¸…çš„é ˜åŸŸï¼Œåœ˜éšŠéœ€è¦èŠ±ä¸€äº›æ™‚é–“ç ”ç©¶èˆ‡æ¢ç´¢æ‰èƒ½æ˜å®šç›®æ¨™ï¼Œæ­¤æ™‚æ•¸æ“šçš„ç”¨é€”ä¸æ˜¯çµ¦äºˆä¸€ç¿»å…©çªçœ¼çš„çµè«–ï¼Œè€Œæ˜¯å¾ä¸­çš„å·®ç•°å»è§£è®€å¯èƒ½æ€§&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>å¦å¦‚èªªä¹‹å‰å…¬å¸ç‚ºäº†ç­è§£ç”¨æˆ¶å°æ–¼ç™»å…¥æ–¹å¼çš„æƒ³æ³•ï¼Œå¢è¨­å¤šå€‹ç¬¬ä¸‰æ–¹ç™»å…¥çš„æ–¹å¼ï¼Œæˆ‘å€‘ä¸æœŸå¾…é€™æ¬¡å¯¦é©—å¾Œå°±æ‹æ¿è¦ä¸è¦å°å…¥ç¬¬ä¸‰æ–¹ç™»å…¥ï¼Œè€Œæ˜¯å–®ç´”æ¢ç´¢ç”¨æˆ¶çš„åæ‡‰ï¼Œä¸¦åˆ†æå¢åŠ ç™»å…¥é€šéç‡çš„å¯è¡Œæ–¹æ¡ˆ
å¾€å¾€æ˜¯å…ˆæœ‰äº†æ•¸æ“šå•Ÿç¤ºï¼Œç¶“éå¹¾æ¬¡çš„æ¢ç´¢æœ‰äº†æ›´æ˜ç¢ºçš„å‡è¨­èˆ‡ç›®æ¨™ï¼Œæ¥è‘—å°±æ‹†åˆ†æˆå¤šå€‹æ•¸æ“šé©…å‹•çš„å¯¦é©—&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>æ•¸æ“šæ„è­˜&lt;br>
ç•¶æˆ‘å€‘ç¿’æ…£æ•¸æ“šæ€è€ƒå¾Œï¼Œé–‹å§‹æ‰“é€ å®Œæ•´çš„æ•¸æ“šæ”¶é›†ç³»çµ±ï¼Œè®“æ•´å€‹ç”¢å“çš„æµç¨‹éƒ½èƒ½ç”¨æ•¸æ“šå»è§£é‡‹èˆ‡å‘ˆç¾&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ä¾‹å¦‚èªªå…¬å¸ä¹‹å‰æƒ³è¦è¡¡é‡æ–°ç”¨æˆ¶çš„é«”é©—ï¼Œé‡æ–°å®šç¾©æ•¸æ“šæ”¶é›†çš„å…§å®¹èˆ‡æ ¼å¼ï¼Œç”¨æ•¸æ“šç´€éŒ„æŠµé”ç¬¬ä¸€å€‹ã€Œa ha momentã€çš„ç”¨æˆ¶é«”é©—é‡Œç¨‹ï¼Œé€™æˆäº†å¾ŒçºŒè©•ä¼°å°ˆæ¡ˆæˆæ•ˆçš„é‡è¦æŒ‡æ¨™&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç‚ºä»€éº¼éœ€è¦æ•¸æ“š">ç‚ºä»€éº¼éœ€è¦æ•¸æ“š&lt;/h2>
&lt;p>ç•¶æˆ‘å€‘åœ¨æ‰“é€ ä¸€é …ç”¢å“ï¼Œæˆ‘å€‘éƒ½å¸Œæœ›æœ‰å¾ˆå¤šçš„ç”¨æˆ¶èƒ½å¤ ä½¿ç”¨è€Œå—æƒ ï¼Œé€²è€Œä»˜è²»è®“æ•´å€‹å•†æ¥­æ¨¡å¼å¯ä»¥é‹è½‰ï¼ŒæŒçºŒæ‰“é€ èƒ½å¤ è§£æ±ºç”¨æˆ¶ç—›é»çš„å¥½ç”¢å“&lt;br>
ä½†æ˜¯æˆ‘å€‘è¦å¦‚ä½•çŸ¥é“ã€Œç”¨æˆ¶æ˜¯ä¸æ˜¯çœŸçš„æ»¿æ„æˆ‘å€‘çš„ç”¢å“ï¼Ÿã€ã€Œæ¨å‡ºçš„æ–°åŠŸèƒ½æ˜¯ä¸æ˜¯ç”¨æˆ¶çœŸçš„è¦çš„ï¼Ÿã€ã€Œæ–°çš„ UI ä»‹é¢æˆæ•ˆæœ‰æ¯”èˆŠçš„ UI æ›´å—æ­¡è¿å—ï¼Ÿã€ã€Œæˆ‘å€‘è©²æ€éº¼åšæ‰èƒ½å¢åŠ ç‡Ÿæ”¶ï¼Ÿã€ç­‰å•é¡Œ&lt;/p>
&lt;blockquote>
&lt;p>æˆ‘å€‘è©²å¦‚ä½•çŸ¥é“ç”¨æˆ¶çš„ä½¿ç”¨æƒ…æ³èˆ‡åé¥‹ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>å°æ–¼ç¶²è·¯ç”¢æ¥­ä¾†èªªï¼Œæ¨å‡ºç”¢å“èˆ‡æ”¶åˆ°åé¥‹çš„æ™‚é–“éƒ½éå¸¸å¿«ï¼Œåœ¨æ›´è¿‘ä¸€æ­¥è¨è«–æ•¸æ“šä¹‹å‰ï¼Œå¿…é ˆå…ˆå›æ­¸åŸé»ï¼Œå…¬å¸å†ä¸åŒçš„éšæ®µæœƒæœ‰ä¸åŒçš„æˆ°ç•¥ç›®æ¨™ï¼Œå¯èƒ½æ˜¯ç‡Ÿæ”¶çš„æˆé•·ç‡æˆ–æ˜¯ç”¨æˆ¶çš„æˆé•·æ•¸ç­‰&lt;/p>
&lt;ol>
&lt;li>[æ¡ˆä¾‹ä¸€] Netflix çš„å•†æ¥­æ¨¡å¼æ˜¯è¨‚é–±åˆ¶ï¼Œåœ¨è¨‚é–±æ–¹æ¡ˆçš„é‡‘é¡å›ºå®šä¸‹ï¼Œç”¨æˆ¶çš„è¨‚é–±æ•¸å°±æ˜¯ä»–å€‘å¾ˆé‡è¦çš„&lt;code>é—œéµæŒ‡æ¨™&lt;/code>ï¼Œé—œéµæŒ‡æ¨™é€šå¸¸æ˜¯ç›´æ¥è·Ÿç‡Ÿæ”¶åšæ›é‰¤ï¼›æ¥è‘—é€éæ•¸æ“šè§€å¯Ÿåˆ°ç”¨æˆ¶çš„è¨‚é–±æ„é¡˜èˆ‡è§€çœ‹æ™‚é–“æˆæ­£æ¯”ï¼Œæ‰€ä»¥è§€çœ‹æ™‚é–“å°±æˆäº†&lt;code>æ¬¡è¦æŒ‡æ¨™&lt;/code>&lt;/li>
&lt;li>[æ¡ˆä¾‹äºŒ] Coursera çš„å•†æ¥­æ¨¡å¼æ˜¯é€éè²©å”®èª²ç¨‹å®Œæˆçš„çµæ¥­è­‰æ›¸ï¼Œä»–å€‘çš„æ¬¡è¦æŒ‡æ¨™æ˜¯ç”¨æˆ¶æ˜¯å¦é€šéç¬¬ä¸€æ¬¡è€ƒè©¦ã€ç”¨æˆ¶åœ¨ä¸€é€±å…§æ˜¯å¦æœ‰åè¦†å›ä¾†é€ è¨ªç¶²é &lt;/li>
&lt;/ol>
&lt;p>åœ¨è³‡æºæœ‰é™çš„æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘å¿…é ˆæŒçºŒä¸”å¿«é€Ÿçš„å˜—è©¦ï¼Œé—œéµæŒ‡æ¨™åæ‡‰å¯èƒ½æœƒæ¯”è¼ƒæ…¢ï¼Œæ‰€ä»¥æœƒéœ€è¦æœ‰å…¶ä»–çš„æ¬¡è¦æŒ‡æ¨™å»è§€å¯Ÿå˜—è©¦çš„çµæœï¼Œç”¨æ¯ä¸€æ¬¡çš„å­¸ç¿’å»å¾€æ¬¡è¦æŒ‡æ¨™èˆ‡é—œéµæŒ‡æ¨™é‚é€²ï¼Œå› æ­¤å¿«é€Ÿä¸”æ­£ç¢ºçš„è©•ä¼°ç”¨æˆ¶çš„åæ‡‰ï¼Œå°±æ˜¯ä»¶éå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå¸¸è¦‹çš„æ‰‹æ®µåˆ†æˆ&lt;code>é‡åŒ–ç ”ç©¶&lt;/code>èˆ‡&lt;code>è³ªåŒ–ç ”ç©¶&lt;/code>&lt;/p>
&lt;h4 id="é‡åŒ–ç ”ç©¶">é‡åŒ–ç ”ç©¶&lt;/h4>
&lt;p>ä¸»è¦æ˜¯é€éå®¢è§€çš„è§€å¯Ÿå¤§é‡ç”¨æˆ¶çš„è¡Œç‚ºï¼Œé€éçµ±è¨ˆåˆ†ææ¢è¨ã€Œç”¨æˆ¶æ˜¯å¦‚ä½•æ“ä½œç”¢å“ / ç”¨æˆ¶æ€éº¼æ“ä½œé€™é …åŠŸèƒ½ã€&lt;/p>
&lt;h4 id="è³ªåŒ–ç ”ç©¶">è³ªåŒ–ç ”ç©¶&lt;/h4>
&lt;p>é€éç”¨æˆ¶è¨ªè«‡æˆ–ä½¿ç”¨æ€§æ¸¬è©¦ï¼Œèˆ‡å°‘é‡çš„ç”¨æˆ¶é€²è¡Œæ·±åº¦çš„è¨ªè«‡ï¼Œè—‰æ­¤äº†è§£ç”¨æˆ¶çš„çœŸå¯¦æƒ…ç·’åæ‡‰ï¼Œæ›´æ³¨é‡æ–¼ã€Œç‚ºä»€éº¼ç”¨æˆ¶æœƒæ€æ¨£æ€è€ƒã€ç­‰å•é¡Œ&lt;/p>
&lt;p>é‡åŒ–ç ”ç©¶èˆ‡è³ªåŒ–ç ”ç©¶ç›¸è¼”ç›¸æˆï¼Œä¾‹å¦‚èªªå…¬å¸æ¨å‡ºäº†æ–°çš„ä»˜è²»æ–¹æ¡ˆï¼Œé€éé‡åŒ–ç ”ç©¶ç™¼ç¾æ•´é«”ç”¨æˆ¶çš„çºŒè¨‚ç‡ä¸‹é™äº†ï¼Œé€™æ™‚å€™å°±é€éè¨ªè«‡æ–¹å¼å»äº†è§£åˆ°ç”¨æˆ¶çœ‹åˆ°å¤šå€‹æ–¹æ¡ˆåè€Œä¸æ¸…æ¥šå…¶ä¸­çš„å·®ç•°ï¼Œå°è‡´è€ƒæ…®çš„æ™‚é–“æ‹‰é•·ç­‰ç•¶åˆè¨­è¨ˆæ–¹æ¡ˆæ™‚æ¬ ç¼ºè€ƒæ…®çš„æ–¹å‘&lt;/p>
&lt;p>é€™æœ¬æ›¸åè¦†å¼·èª¿ï¼Œæ˜¯&lt;code>æ•¸æ“šå„ªå…ˆè€Œéå–®ç´”æ•¸æ“š&lt;/code>ï¼Œæ„å³é‡åŒ–ç ”ç©¶æˆ–è¨±æ˜¯ä¸»è¦æ‰‹æ®µï¼Œä½†ä¹Ÿä¸èƒ½å®Œå…¨æ¨æ£„è³ªåŒ–ç ”ç©¶&lt;/p>
&lt;h2 id="ab-æ¸¬è©¦">A/B æ¸¬è©¦&lt;/h2>
&lt;p>ç•¶æˆ‘å€‘åŸ·è¡Œå°ˆæ¡ˆå¾Œï¼Œè¦æ€éº¼æ¸…æ¥šçš„çŸ¥é“é€™æ¨£çš„çµæœæ˜¯åŸºæ–¼æˆ‘å€‘åšå‡ºçš„æ”¹è®Šï¼Œè€Œä¸æ˜¯å¤–åœ¨å› ç´ å¹²æ“¾æˆ–æ˜¯çè²“ç¢°åˆ°æ­»è€—å­ï¼Œç°¡è¨€ä¹‹è¦é‡æ¸…&lt;code>é«˜ç›¸é—œæ€§èˆ‡å› æœæ€§&lt;/code>ï¼Œåœ¨æ­¤æ¨è–¦ä¸€ç¯‡ whoscall åœ˜éšŠéå¸¸æ£’çš„æ–‡ç« 
&lt;a class="link" href="https://medium.com/gogolook-design/%E6%95%B8%E6%93%9A%E5%88%86%E6%9E%90%E7%9A%84%E5%8A%9B%E9%87%8F-6e8c46b9fa24" target="_blank" rel="noopener"
>æ•¸æ“šåˆ†æçš„åŠ›é‡&lt;/a>&lt;/p>
&lt;p>ç‚ºäº†æ‰¾å‡ºå› æœæ€§ï¼Œå¯ä»¥å¥—ç”¨ç§‘å­¸å¯¦é©—çš„æ–¹æ³•ï¼Œ&lt;/p>
&lt;blockquote>
&lt;p>æ‹†åˆ†åŒè³ªçš„å°ç…§çµ„èˆ‡å¯¦é©—çµ„ï¼Œæ§åˆ¶ä¸€æ¬¡æ”¹è®Šä¸€å€‹è‡ªè®Šæ•¸çš„æƒ…æ³ä¸‹ï¼Œè§€å¯Ÿæ‡‰è®Šæ•¸çš„è®ŠåŒ–é—œä¿‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿç¨±ä½œç‚º A/B æ¸¬è©¦ï¼Œæ‹†åˆ†æˆ A,B å…©çµ„ï¼Œä¸€çµ„ç¶­æŒåŸæœ¬çš„è¨­è¨ˆï¼Œå¦ä¸€çµ„ä¾ç…§æˆ‘å€‘çš„å‡è¨­å¥—ç”¨æ–°çš„è¨­è¨ˆï¼Œè§€å¯Ÿå…©çµ„çš„æŒ‡æ¨™è®ŠåŒ–ï¼Œæ¨è«–å‡è¨­æ˜¯å¦æˆç«‹&lt;/p>
&lt;p>åŸºæ–¼æˆ‘å€‘çš„å•†æ¥­ç›®æ¨™èˆ‡ç¾æœ‰çš„æ•¸æ“šï¼Œæˆ‘å€‘æå‡ºå¤šçµ„å‡è¨­ï¼Œä¸¦ä¾æ“šå‡è¨­è¨­è¨ˆå¤šçµ„å¯¦é©—çµ„ï¼Œå¯¦éš›çš„æƒ…æ³å¤§æ¦‚æœƒé•·é€™æ¨£&lt;/p>
&lt;p>ä»¥ä¸‹æ‹†åˆ†æˆä¸‰å€‹éšæ®µ å®šç¾© -&amp;gt; åŸ·è¡Œ -&amp;gt; è©•ä¼°&lt;/p>
&lt;h2 id="å®šç¾©">å®šç¾©&lt;/h2>
&lt;p>æœ‰å¹¾å€‹å•é¡Œå¯ä»¥å¹«åŠ©æ€è€ƒç›®æ¨™&lt;/p>
&lt;ol>
&lt;li>ä½ æƒ³æŠŠæ™‚é–“è·Ÿç²¾åŠ›æ”¾åœ¨å“ªé‚Šç”¢ç”Ÿå½±éŸ¿åŠ›&lt;/li>
&lt;li>ä½ ç›¸ä¿¡ä»€éº¼å°ä½¿ç”¨è€…æ˜¯å¥½çš„&lt;/li>
&lt;li>æ€æ¨£çš„ä½¿ç”¨è€…é«”é©—æˆ–æ˜¯å•†æ¥­é—œéµè­°é¡Œå¯ä»¥è¢«è¦–ç‚ºæ©Ÿæœƒé»&lt;/li>
&lt;li>ä»€éº¼æ˜¯æ”¹é€²ä½¿ç”¨è€…é«”é©—çš„å¥½æ©Ÿæœƒ&lt;/li>
&lt;/ol>
&lt;p>å®šç¾©çš„ç›®æ¨™å¯ä»¥æ˜¯é‡åŒ–æŒ‡æ¨™ï¼Œä¹Ÿå¯ä»¥æ˜¯è³ªåŒ–æŒ‡æ¨™ï¼Œä¾‹å¦‚æ›¸ä¸­ä»¥è¾¦ç‡ŸéšŠç‚ºä¾‹ï¼Œã€Œå¢åŠ ç‡ŸéšŠå ±åäººæ•¸ã€å¯ä»¥æ˜¯å€‹ç›®æ¨™ï¼Œã€Œè®“ç‡ŸéšŠè®Šå¾—æ›´å¥½ç©ã€ä¹Ÿå¯ä»¥æ˜¯å€‹ç›®æ¨™ï¼›&lt;br>
ä½†ä¸è«–ç›®æ¨™æ˜¯é‡åŒ–é‚„æ˜¯è³ªåŒ–ï¼Œéƒ½&lt;code>å¿…é ˆæ‰¾åˆ°é‡æ¸¬çš„æŒ‡æ¨™ï¼Œç¢ºèªè‡ªå·±æœ‰åœ¨å¾€ç›®æ¨™é‚é€²&lt;/code>ï¼Œè³ªåŒ–ç›®æ¨™ä¹Ÿå¯ä»¥é€šéå•å·å›æ”¶ã€ç”°é‡èª¿æŸ¥ç­‰æ–¹å¼&lt;/p>
&lt;h3 id="æŒ‡æ¨™çš„è©•ä¼°">æŒ‡æ¨™çš„è©•ä¼°&lt;/h3>
&lt;p>å…ˆå‰æåˆ°é—œéµæŒ‡æ¨™èˆ‡æ¬¡è¦æŒ‡æ¨™ï¼Œè¨­å®šæ¬¡é©—æŒ‡æ¨™çš„ç›®çš„åœ¨æ–¼é—œéµæŒ‡æ¨™çš„åæ‡‰é€±æœŸå¯èƒ½å¾ˆé•·ï¼Œå¦å¦‚æœˆè¨‚é–±åˆ¶è¦ç­‰åˆ°ä¸€å€‹æœˆå¾Œæ‰çŸ¥é“çµæœå¤ªæ…¢äº†ï¼›&lt;br>
åˆæˆ–æ˜¯é—œéµæŒ‡æ¨™å¤ªä¸æ•æ„Ÿï¼Œåƒæ˜¯app store è©•åƒ¹ï¼Œå¦‚æœä»Šå¤©åšçš„æ˜¯å±€éƒ¨+è©•ä¼°é¡å‹çš„æ”¹å‹•ï¼Œåƒæ˜¯èª¿æ•´æŒ‰éˆ•å¤§å°èˆ‡é¡è‰²ï¼Œä¼°è¨ˆæ˜¯ä¸æœƒå¾ˆå¿«åæ˜ åœ¨è©•åƒ¹ä¸Šï¼Œæ‰€ä»¥éœ€è¦é¡å¤–çš„æŒ‡æ¨™è¡¡é‡&lt;/p>
&lt;h3 id="æŒ‡æ¨™ä¹‹é–“çš„è¡çª">æŒ‡æ¨™ä¹‹é–“çš„è¡çª&lt;/h3>
&lt;p>ç›®æ¨™çš„åˆ¶å®šæ˜¯ç§‘å­¸ä¹Ÿæ˜¯è—è¡“ï¼Œä¾‹å¦‚ eBay çš„äº¤æ˜“åª’åˆçš„æ–¹å¼æ˜¯è³£å®¶ä¸Šæ¶å•†å“ + è²·å®¶ä¸‹æ¨™å…©è€…å‹•ä½œçµåˆï¼Œä»–å€‘é€éæ•¸æ“šç™¼ç¾åœ¨æŸäº›æƒ…æ³ä¸‹è²·å®¶æ£„æ¨™çš„æ¯”ä¾‹å¾ˆé«˜ï¼Œç¶“éç ”ç©¶ç™¼ç¾æ˜¯ç›®å‰çš„ä¸Šæ¶æµç¨‹æŸäº›è³‡æ–™ä¸é€æ˜ï¼Œä¾‹å¦‚è²·å®¶ä¸‹æ¨™æ‰ç™¼ç¾å•†å“åœ¨æµ·å¤–éœ€è¦é¡å¤–çš„é‹è²»è·Ÿç¨…æ”¶ï¼Œæ‰€ä»¥ä»–å€‘å¸Œæœ›ç ”ç©¶&lt;code>å¢åŠ å•†å“è³‡è¨Šé‡æ˜¯å¦èƒ½å¤ æ¸›å°‘æ£„æ¨™é‡&lt;/code>ï¼Œä»–å€‘ç™¼ç¾å¢åŠ å•†å“è³‡è¨Šé‡ç¢ºå¯¦æ¸›å°‘æ£„æ¨™é‡ï¼Œä½†æ˜¯ä¹Ÿå› ç‚ºå¢åŠ è³¼è²·çš„é˜»åŠ›å°è‡´ä¸‹æ¨™æ•¸é‡ä¸‹æ»‘&lt;/p>
&lt;p>é€™æ™‚å€™&lt;code>æ¸›å°‘æ£„æ¨™é‡å¢åŠ äº¤æ˜“å“è³ª&lt;/code>è·Ÿ&lt;code>ä¸‹æ¨™æ•¸é‡ä¸‹æ»‘&lt;/code>é€™å…©å€‹æŒ‡æ¨™å­°è¼•å­°é‡ï¼Œå°±è€ƒé©—åœ˜éšŠçš„åƒ¹å€¼è§€ï¼Œæ­¤æ™‚ eBay é¸æ“‡å‰è€…ï¼Œå› ç‚ºèˆ‡å…¶å¢åŠ çŸ­æœŸçš„ä¸‹æ¨™é‡ï¼Œä»–å€‘æ›´é‡è¦–ç”¨æˆ¶çš„ä¸­ã€é•·æœŸé—œä¿‚&lt;/p>
&lt;p>åŒæ¨£çš„ Airbnb ä¹Ÿé¢è‡¨éç›¸åŒçš„æŠ‰æ“‡ï¼Œä»–å€‘ç™¼ç¾æŸäº›å±‹ä¸»çš„ç‰©ä»¶æ¢ä»¶æ˜æ˜ä¸éŒ¯å»å‡ºç§Ÿæ—¥å¾ˆå°‘ï¼Œå¾Œä¾†ç™¼ç¾æ˜¯ç…§ç‰‡æ‹å¾—ä¸å¤ å¥½ã€è³‡è¨Šä¸å¤ å……åˆ†ï¼Œç•¶æ™‚å…§éƒ¨ä¸€å€‹åœ˜éšŠç›®æ¨™æ˜¯ã€Œå¢åŠ å±‹ä¸»çš„ä¸Šå‚³ç‰©ä»¶æ•¸ã€å¦ä¸€å€‹åœ˜éšŠçš„ç›®æ¨™æ˜¯ã€Œå¢åŠ å±‹ä¸»å‡ºç§Ÿçš„æ©Ÿæœƒã€ï¼Œå…©è€…åŒæ™‚å¸Œæœ›æ›´æ”¹è¨»å†Šæµç¨‹ï¼Œä¸€å€‹å¸Œæœ›ç°¡åŒ–å¦ä¸€å€‹å¸Œæœ›å±‹ä¸»æ›´æ…é‡è¨»å†Šï¼Œå¯¦é©—çš„æ–¹å‘å‰›å¥½è¡çªï¼Œæœ€çµ‚ä»–å€‘é¸æ“‡èåˆå…©è€…ç›®æ¨™å»å¹³è¡¡ï¼Œé”åˆ°æœ€ä½³çš„æˆæ•ˆ&lt;/p>
&lt;blockquote>
&lt;p>é€™æ˜¯ä¸€å€‹ä¸æ–·åè¦†æ€ç´¢çš„éç¨‹ï¼Œå¾ç›®æ¨™åˆ°æŒ‡æ¨™çš„è¨­å®šéœ€è¦ä¾†å›çš„æª¢è¦–ï¼Œä¸¦èˆ‡å„å€‹åœ˜éšŠæºé€šä»¥å…å¯¦é©—äº’ç›¸è¡çª&lt;/p>
&lt;/blockquote>
&lt;h3 id="å‡èªª">å‡èªª&lt;/h3>
&lt;p>æœ‰äº†ç›®æ¨™å¾Œè¦é–‹å§‹ç™¼æƒ³å‡èªªï¼Œæˆ‘å€‘å¿…é ˆæ±ºå®šå°ˆæ¡ˆçš„è¦æ¨¡ä»¥åŠé è¨ˆå­¸ç¿’çš„äº‹ç‰©ï¼Œå¯ä»¥ç”¨å…©å€‹ç¶­åº¦å››å€‹è±¡é™æ‹†åˆ†ï¼š&lt;code>å±€éƒ¨/å…¨é¢&lt;/code>ã€&lt;code>æ¢ç´¢/è©•ä¼°&lt;/code>&lt;br>
æ”¹å‹•ç¯„åœå¦‚æœæ˜¯å±€éƒ¨ï¼Œé‚£ä»£è¡¨æˆ‘å€‘å¯ä»¥ç”¨è¼ƒæ¿€é€²çš„æ–¹å¼å»é‡æ¸¬ï¼Œå› ç‚ºæ½›åœ¨çš„é¢¨éšªæ¯”è¼ƒå°/&lt;br>
å°ˆæ¡ˆçš„ç›®çš„å¦‚æœæ˜¯è©•ä¼°ï¼Œé‚£ä»£è¡¨çµæœå¿…é ˆå¾ˆæ˜ç¢ºçš„å›ç­”æŸäº›å•é¡Œï¼Œåœ¨è¨­è¨ˆæ•¸æ“šæ”¶é›†æ–¹é¢å°±è¦å¾€é€™æ–¹é¢é‚é€²&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20200405/category.jpg"
loading="lazy"
>&lt;/p>
&lt;p>ä¾‹å¦‚èªªã€Œæ”¹å‹•ä»˜è²»é é¢å¸Œæœ›æå‡è½‰æ›ç‡ã€å°±æ˜¯å€‹&lt;code>å±€éƒ¨+è©•ä¼°&lt;/code>é¡å‹çš„éœ€æ±‚ï¼Œåªæ”¹å‹•ä¸€å€‹é é¢ä¸æœƒå½±éŸ¿åˆ°å…¶ä»–é—œéµé«”é©—ï¼ŒåŒæ™‚å°ˆæ¡ˆçš„çµæœæœƒç›´æ¥æ±ºå®šè¦ä¸è¦å¥—ç”¨æ–°çš„è¨­è¨ˆï¼›&lt;br>
è€Œã€Œä¿®æ”¹è¦–è¦ºç³»çµ±å¸Œæœ›æ›´æ¸…æ¥šè¡¨é”ç”¢å“åƒ¹å€¼èˆ‡å“ç‰Œæ„è­˜ã€å°±æ˜¯å€‹&lt;code>å…¨é¢+æ¢ç´¢&lt;/code>çš„éœ€æ±‚ï¼Œæ”¹å‹•ä¸Šç·šå¾Œç„¡æ³•ç›´æ¥å›ç­”è½‰æ›ç‡æ˜¯å¦ç›´æ¥å› æ­¤æå‡ï¼Œéœ€è¦å¾å…¶ä»–é¢å‘èˆ‡å¢åŠ é‡æ¸¬æ–¹å¼æ‰èƒ½å¾—çŸ¥å°ˆæ¡ˆçš„æˆæ•ˆ&lt;/p>
&lt;h4 id="åˆ¶å®šå‡èªª">åˆ¶å®šå‡èªª&lt;/h4>
&lt;p>æ¥è‘—ç”¨ä»¥ä¸‹çš„å¥å­å•è‡ªå·±&lt;/p>
&lt;blockquote>
&lt;p>å°æ–¼ [ä½¿ç”¨è€…é¡å‹]ï¼Œå¦‚æœ [æ”¹è®Š]ï¼Œå°±æœƒ [æ•ˆæ‡‰]ï¼Œé€™æ˜¯ç”±æ–¼ [ç†ç”±]ï¼Œä¸¦æœƒå½±éŸ¿ [é‡æ¸¬å€¼]&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>&lt;code>ä½¿ç”¨è€…é¡å‹&lt;/code>&lt;/strong> å¯ä»¥æ˜¯ä¸åŒçš„å­é›†ï¼Œä¾‹å¦‚èªªæ–°ç”¨æˆ¶è·ŸèˆŠç”¨æˆ¶å°±æ˜¯å¾ˆå¤§çš„å·®ç•°ï¼Œåˆæˆ–æ˜¯ä¸åŒåœ‹å®¶ã€ä¸åŒæ€§åˆ¥ç­‰ï¼Œé€™ä¾æ“šç”¢å“èª¿æ€§èˆ‡å¯¦é©—çš„æ€§è³ªä¸åŒè€Œå€éš”
ä»¥ä¸‹å•é¡Œå¯ä»¥å¹«åŠ©æ€è€ƒ&lt;/p>
&lt;ol>
&lt;li>ä½ å°æ–¼ä»–å€‘çš„äººå£çµæ§‹æœ‰ä»€éº¼äº†è§£ï¼Ÿä»–å€‘æœ‰ä»€éº¼ç¿’æ…£ï¼Ÿ&lt;/li>
&lt;li>ä»–å€‘å’Œå…¬å¸æœ‰ä»€éº¼é—œä¿‚ï¼Ÿ&lt;/li>
&lt;li>é€™æ˜¯ç¾æœ‰çš„ä½¿ç”¨è€…ï¼Ÿæ–°ç”¨æˆ¶ï¼Ÿå°ˆæ¥­ç”¨æˆ¶ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>&lt;code>æ”¹è®Š&lt;/code>&lt;/strong> æ˜¯æŒ‡å¸Œæœ›ç”¨ä¾†å½±éŸ¿ä½¿ç”¨è€…çš„äº‹ç‰©ï¼Œä¸€å€‹å‡èªªå¯ä»¥å¤šç¨®ä¸åŒçš„æ”¹è®Šè¨­è¨ˆ&lt;/p>
&lt;ol>
&lt;li>ä½ æ˜¯è¦å¢åŠ æ–°çš„è¨­è¨ˆï¼Ÿ&lt;/li>
&lt;li>é‚„æ˜¯è¦ç§»é™¤èˆŠçš„è¨­è¨ˆ&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>&lt;code>æ•ˆæ‡‰&lt;/code>&lt;/strong> æ˜¯é æœŸå¸¶ä¾†çš„æ”¹è®Š&lt;/p>
&lt;ol>
&lt;li>ä½ ç™¼ç¾çš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿä»€éº¼æ¨£çš„ç”¨æˆ¶å¯ä»¥è§£æ±ºæˆ–æ˜¯æ¸›å°‘é€™å€‹å•é¡Œï¼Ÿ&lt;/li>
&lt;li>ä½ ç™¼ç¾çš„æ©Ÿæœƒé ˜åŸŸæ˜¯ä»€éº¼ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>&lt;code>ç†ç”±&lt;/code>&lt;/strong> å‰‡æ˜¯æ”¯æŒå‡èªªçš„è­‰æ“š&lt;/p>
&lt;ol>
&lt;li>ä½ çš„ç†ç”±æ˜¯ä¾†è‡ªæ¶ˆè²»è€…å‹•æ©Ÿï¼Ÿé‚„æ˜¯ç”±æŸç¨®æˆ°è¡“èˆ‡æ©Ÿåˆ¶ä¾†é”æˆæ”¹è®Š&lt;/li>
&lt;li>æœ‰å“ªç­†è³‡æ–™æ”¯æŒé€™é …å‡èªªï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>&lt;code>é‡æ¸¬&lt;/code>&lt;/strong> æ˜¯æƒ³è¦å½±éŸ¿çš„çµ‚æ¥µæŒ‡æ¨™ï¼Œç”¨ä¸€å€‹å®¢è§€çš„æ–¹å¼æœ€å¤§åŒ–å­¸ç¿’&lt;/p>
&lt;ol>
&lt;li>ç‚ºäº†ç­è§£ä½ æ­£åœ¨å‰µé€ æ­£é¢ä¸”å¤ å¤§çš„å½±éŸ¿ï¼Œéœ€è¦è¡¡é‡ä»€éº¼æŒ‡æ¨™ï¼Ÿ&lt;/li>
&lt;li>ä½ æœƒé‡æ¸¬ç”¨æˆ¶çš„æƒ…ç·’å—ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>ä»¥ç…§ç‰‡åˆ†äº«å¹³å°ç‚ºä¾‹ï¼Œå‡èªªå¯ä»¥æ˜¯ã€Œæˆ‘å€‘é æ¸¬è—‰ç”±å¢åŠ æ¿¾é¡èˆ‡ç…§ç‰‡ç‰¹æ•ˆï¼Œæœƒæœ‰æ›´å¤šäººä½¿ç”¨æˆ‘å€‘çš„ç”¢å“ï¼Œå› ç‚ºé€™æœƒè®“ä»–å€‘çš„ç…§ç‰‡æ›´å¥½çœ‹ã€æ›´æœ‰è¶£ï¼Œè‹¥æˆ‘å€‘ç™¼ç¾ä½¿ç”¨è€…æŠ•å…¥å±¤åº¦å¢åŠ å°±çŸ¥é“å‡è¨­æ˜¯çœŸçš„ã€&lt;/p>
&lt;h3 id="æ¨£æœ¬èˆ‡ä¿¡å¿ƒç¨‹åº¦">æ¨£æœ¬èˆ‡ä¿¡å¿ƒç¨‹åº¦&lt;/h3>
&lt;p>åœ¨å®šç¾©éšæ®µï¼Œæˆ‘å€‘éœ€è¦æ˜ç¢ºæ¸¬è©¦çš„æ—ç¾¤æ˜¯å“ªäº›ï¼Œä¸¦ä¸”æ±ºå®šæ¸¬è©¦çš„æ™‚é–“é€±æœŸèˆ‡æ¨£æœ¬æ•¸ï¼Œä¾‹å¦‚èªªå‡æ—¥ä¸Šç·šçš„ç”¨æˆ¶è·Ÿå¹³æ—¥ä¸Šç·šçš„ç”¨æˆ¶å¯èƒ½ä¸åŒï¼Œå¦‚æœæ¸¬è©¦çš„é€±æœŸä¸å¤ å…¨é¢ï¼Œå®¹æ˜“å¾—åˆ°éŒ¯èª¤çš„çµè«–&lt;/p>
&lt;p>ç‚ºäº†é¿å…å‡é™½æ€§(å¯¦é©—åˆ¤æ–·æœ‰æ•ˆä½†å¯¦éš›ç„¡æ•ˆ)ã€å‡é™°æ€§(å¯¦é©—åˆ¤æ–·ç„¡æ•ˆä½†å¯¦éš›æœ‰æ•ˆ)ç­‰å¯¦é©—ä¸æº–ç¢ºçš„ç‹€æ³ï¼Œæˆ‘å€‘éœ€è¦å°æ¸¬è©¦çµæœæœ‰ä¸€å®šç¨‹åº¦çš„ä¿¡å¿ƒï¼Œä¾‹å¦‚èªªæœ‰äººé€šçŸ¥å··å£å¤±ç«äº†ï¼Œå¦‚æœåªæ˜¯ä¸€å€‹äººä½ å¯èƒ½è¦ºå¾—åœ¨é–‹ç©ç¬‘ï¼Œä½†æœ‰ä¸€ç™¾äººéƒ½é€™æ¨£èªªå‹¢å¿…å°±æœƒé–‹å§‹èµ·ç–‘å¿ƒï¼Œåœ¨çµ±è¨ˆä¸Šç¨±ç‚º&lt;code>ä¿¡è³´å€é–“&lt;/code>ï¼Œå¾æ¯é«”æ¡é›†æŸå€‹æ•¸é‡çš„å­æ¨£æœ¬ï¼Œå¥—ç”¨æ•¸æ“šå¾Œå¾—åˆ°ä¸€å®šçš„ä¿¡å¿ƒæ°´æº–&lt;/p>
&lt;p>é¢å°ä¸åŒç­‰ç´šçš„ä¿®æ”¹æœƒéœ€è¦ä¸åŒçš„ä¿¡å¿ƒæ°´æº–ï¼ŒåŒæ™‚ä¹Ÿæœƒæ±ºå®šçµæœæ”¾é‡çš„éç¨‹ï¼Œä¾‹å¦‚èªªè·Ÿç‡Ÿæ”¶ç›¸é—œçš„æ”¹å‹•å¯èƒ½è¦æ¯”è¼ƒé«˜çš„ä¿¡å¿ƒæ°´æº–ï¼Œä»¥åŠè¼ƒè¬¹æ…ç·©æ…¢çš„æ”¾é‡éç¨‹&lt;/p>
&lt;h3 id="å¿«é€Ÿé©—è­‰">å¿«é€Ÿé©—è­‰&lt;/h3>
&lt;p>å†é€²è¡Œç”¢å“åšå¯¦é«”æ¸¬è©¦å‰ï¼Œå¯ä»¥æ¨å‡ºä½æ“¬çœŸåº¦çš„ mockup é€²è¡Œä½¿ç”¨æ€§ç ”ç©¶ï¼Œä¾‹å¦‚ spotify å¸Œæœ›çµ±ä¸€è¦–è¦ºç³»çµ±ï¼Œä½†ä¸ç¢ºå®šè¦æ¡ç”¨æ·±è‰²é‚„æ˜¯æ·ºè‰²çš„æ–¹æ¡ˆï¼Œæ­¤æ™‚ä»–å€‘å°‡è¨­è¨ˆåŸå‹åšæˆå•å·èª¿æŸ¥å…ˆå¿«é€Ÿé©—è­‰ï¼Œæœ€çµ‚æ¡ç”¨äº†æ·±è‰²çš„æ–¹æ¡ˆï¼Œç”¨æ­¤æ¸›å°‘ä¸å¿…è¦çš„å˜—è©¦&lt;/p>
&lt;p>åœ¨å®šç¾©çš„éšæ®µï¼Œè©¦è‘—å›ç­”ä»¥ä¸‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>ä½ æƒ³è¦ç‚ºå…¬å¸é”åˆ°çš„ç›®æ¨™æœ‰å“ªäº›ï¼Ÿ&lt;/li>
&lt;li>åœ¨ä½ çš„è©¦é©—ä¸­ï¼Œæœ€é‡è¦å­¸ç¿’åˆ°çš„æœƒæ˜¯ä»€éº¼ï¼Ÿ&lt;/li>
&lt;li>åœ¨ç”Ÿæˆå‡èªªæ™‚ï¼Œé‹ç”¨äº†å“ªäº›æ•¸æ“šï¼Ÿ&lt;/li>
&lt;li>åœ¨æŒ‘é¸å‡èªªæ™‚ï¼Œæ˜¯å¦çœŸçš„ç”Ÿæˆäº†æ‰€æœ‰çš„å‡èªªï¼Ÿ&lt;/li>
&lt;/ol>
&lt;h2 id="åŸ·è¡Œ">åŸ·è¡Œ&lt;/h2>
&lt;p>é€™ä¸€å€‹éšæ®µæ˜¯å¦‚ä½•&lt;code>é€éè¨­è¨ˆå‘ˆç¾å‡èªª&lt;/code>ï¼Œä¾‹å¦‚ Netflix æƒ³è¦æ¸¬è©¦ ã€Œåœ¨é¦–é å¢åŠ é›»å½±çš„é¸æ“‡æ•¸ç›®æ˜¯å¦æœƒå¢åŠ éŠ·é‡ã€ï¼Œä½†æ˜¯å¢åŠ é¸æ“‡æ•¸ç›®æœ‰å¾ˆå¤šç¨®æ–¹å¼ï¼Œè¨­è¨ˆåœ˜éšŠæå‡º[å¢åŠ é›»å½±é¡åˆ¥æ•¸]æˆ–[é¡åˆ¥ä¸­é›»å½±çš„æ•¸é‡] (å»£åº¦èˆ‡æ·±åº¦)ï¼Œåˆ†åˆ¥æ¶‰åŠæˆä¸‰å€‹å¯¦é©—&lt;/p>
&lt;ul>
&lt;li>25 x 100&lt;/li>
&lt;li>50 x 75&lt;/li>
&lt;li>50 x 100
æœ€çµ‚ç™¼ç¾ä¸­é–“çš„å¯¦é©—æ•ˆæœæœ€å¥½&lt;/li>
&lt;/ul>
&lt;p>åœ¨ &lt;a class="link" href="https://www.facebook.com/notes/liou-shih-sie/ab-testing-%E4%BA%94%E5%A4%A7%E5%BF%85%E6%AE%BA%E6%8B%9B%E6%95%B8%E8%AE%93%E4%BD%A0%E8%BD%89%E6%8F%9B%E7%8E%87%E7%AB%8B%E9%A6%AC%E6%8F%90%E5%8D%87-200-day-12-200-everythingaboutgrowth/1662617627089462/" target="_blank" rel="noopener"
>A/B Testing äº”å¤§å¿…æ®ºæ‹›æ•¸ï¼Œè®“ä½ è½‰æ›ç‡ç«‹é¦¬æå‡ 200% - Day 12 / 200, #EverythingAboutGrowth&lt;/a> æ–‡ç« ä¸­åˆ†äº«ä¸€æ®µå¾ˆç²¾é—¢çš„è¦‹è§£&lt;/p>
&lt;blockquote>
&lt;p>å¥½çš„å¯¦é©—å‡è¨­ï¼Œéƒ½æ˜¯å¥ åŸºæ–¼ä½¿ç”¨è€…è¡Œç‚ºèˆ‡å¿ƒç†è„ˆçµ¡ç™¼å±•è€Œæˆ&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">ã€åŠŸèƒ½æ€§å‡è¨­ã€‘
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">-&lt;/span> æŒ‰éˆ•å¾è—è‰²è®Šç´…è‰²ï¼Œæœƒæå‡è½‰æ›ç‡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">-&lt;/span> æŠŠåœ–ç‰‡ç”±å°æ”¾å¤§ï¼Œæœƒæå‡è½‰æ›ç‡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ã€è¡Œç‚ºå¿ƒç†è„ˆçµ¡å‡è¨­ã€‘
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">-&lt;/span> æ—…å®¿é é¢åŠ å¼·æ€¥è¿«æ„Ÿï¼Œæœƒæé†’ä½¿ç”¨è€…æœ‰è¨‚ä¸åˆ°æˆ¿çš„å¯èƒ½æ€§èˆ‡å£“åŠ›ï¼Œé€²è€Œæå‡è½‰æ›ç‡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">-&lt;/span> æœå°‹åˆ—è¡¨é è®“æ›´å¤šå•†å“èƒ½ä¸€æ¬¡æ˜ å…¥çœ¼ç°¾ï¼Œèƒ½å¹«åŠ©ä½¿ç”¨è€…å®¹æ˜“æ¯”è¼ƒå¤šé–“æ°‘å®¿ä¸¦æ‰¾åˆ°å–œæ­¡æ°‘å®¿ï¼Œé€²è€Œæå‡è½‰æ›ç‡
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ‡è¨˜æ¯å€‹å°ˆæ¡ˆçš„é‡é»è¦æ”¾åœ¨å­¸ç¿’èˆ‡æª¢è¨ï¼Œè€Œä¸æ˜¯åšå®Œæ²’æœ‰æˆæ•ˆå°±ç®—äº†ï¼Œæ“ºæ­£å¿ƒæ…‹æ‰èƒ½ä¸æ–·çš„èª¿æ•´èˆ‡æ”¹å–„&lt;/p>
&lt;p>å¥½çš„å¯¦é©—ä¸¦éœ€æ˜å®šç›®æ¨™ï¼Œä¸¦å¹³è¡¡å­¸ç¿’çš„ç´°åº¦ä»¥åŠæ¸¬è©¦çš„é …ç›®ï¼Œåœ¨éç¨‹ä¸­å¯èƒ½æœƒåŒæ™‚æœ‰å¤šå€‹å‡èªªèˆ‡å¯¦é©—å†é€²è¡Œï¼Œé€éä¸æ–·åœ°æª¢è¦–èˆ‡å­¸ç¿’ï¼Œå¯ä»¥æ¨æ£„æˆ–æ˜¯å¢åŠ æ¸¬è©¦é …ç›®&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/20200405/test_structure.jpg"
loading="lazy"
>&lt;/p>
&lt;h3 id="å‡é–€æ¸¬è©¦-fake-door">å‡é–€æ¸¬è©¦ (Fake door)&lt;/h3>
&lt;p>å¯ä»¥å†æŠ•å…¥å®Œå…¨å·¥ç¨‹é–‹ç™¼è³‡æºå‰ï¼Œå…ˆåšå‡çš„ä»‹é¢å¯ä»¥äº’å‹•ä½†èƒŒå¾Œçš„å·¥ç¨‹é‚è¼¯å…ˆå¿½ç•¥ï¼Œæ¸¬è©¦ç”¨æˆ¶æ˜¯å¦çœŸçš„æœ‰éœ€æ±‚ï¼Œ&lt;code>å‡é–€æ¸¬è©¦ç›¸æ¯”å•å·å¯ä»¥çœŸå¯¦åæ‡‰ç”¨æˆ¶çš„éœ€æ±‚ï¼Œä½†è¦å°å¿ƒæœ‰å¯èƒ½æƒ¹æƒ±ç”¨æˆ¶&lt;/code>ï¼Œæ‰€ä»¥åœ¨æŠ•æ”¾çš„éç¨‹æ‡‰è©²è¦ä¿å®ˆ&lt;/p>
&lt;p>ä¾‹å¦‚æˆ‘å€‘å…¬å¸ç‚ºäº†æ¸¬è©¦ç”¨æˆ¶æ˜¯å¦éœ€è¦é¡å¤–çš„ç™»å…¥åŠŸèƒ½ï¼Œå°±å…ˆæ”¾å‡çš„ç™»å…¥æŒ‰éˆ•æ”¶é›†ç”¨æˆ¶éœ€æ±‚ï¼Œé»æ“Šå¾Œå½ˆçª—é¡¯ç¤ºåŠŸèƒ½é‚„åœ¨é–‹ç™¼ä¸­ï¼ŒåŸ·è¡Œå‡å€‘æ¸¬è©¦åƒ…å¥—ç”¨åˆ°æ¥µå°‘æ•¸çš„ç”¨æˆ¶ä¸Šï¼Œå–å¾—è¶³å¤ æ¨£æœ¬å¾Œå°±çµ‚æ­¢äº†&lt;/p>
&lt;h3 id="è©¦é©—é›¶">è©¦é©—é›¶&lt;/h3>
&lt;p>å†é–‹å§‹èšç„¦ç´°ç¯€ä¹‹å‰ï¼Œå¯ä»¥å…ˆé€€ä¸€æ­¥æ€è€ƒã€Œå¦‚æœåŠŸèƒ½ç§»é™¤æœƒæœ‰æ€æ¨£çš„å½±éŸ¿ã€ä¾†é¿å…éåº¦èšç„¦çš„å‰¯ä½œç”¨ï¼ŒSkyscanner ç™¼ç¾ç§»é™¤é é¢ä¸Šçš„ã€Œæœ€ä¾¿å®œæ©Ÿç¥¨ã€æŒ‰éˆ•ä¸å½±éŸ¿é—œéµæ•¸æ“šï¼Œä»–å€‘å°±çœä¸‹ç²¾åŠ›åœ¨å„ªåŒ–é€™å€‹é …ç›®ä¸Š&lt;/p>
&lt;p>é€™å€‹éšæ®µå¯ä»¥è©¦è‘—å•ä»¥ä¸‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>ä½ å¦‚ä½•æ‰“é€ æœ€ç¬¦åˆå‡èªªçš„é«”é©—èˆ‡è¨­è¨ˆï¼Ÿ&lt;/li>
&lt;li>åœ¨é€™å€‹éšæ®µä»€éº¼å…ƒç´ æ˜¯é—œéµè¨­è¨ˆï¼Ÿä»€éº¼æ˜¯å…¶ä»–å¯ä»¥ä¹‹å¾Œæ³¨æ„çš„ï¼Ÿ&lt;/li>
&lt;li>è·Ÿå…¶ä»–æ¸¬è©¦é …ç›®ç›¸æ¯”ï¼Œé€™å€‹é …ç›®èƒ½å¾ä¸­å­¸åˆ°çš„ç¨ç‰¹ä¹‹è™•åœ¨å“ªï¼Ÿ&lt;/li>
&lt;li>å¦‚æœéœ€è¦å­¸ç¿’åˆ°äº‹å‹™ï¼Œæœ€å¤šéœ€è¦å¹¾å€‹æ¸¬è©¦é …ç›®ï¼Ÿ&lt;/li>
&lt;li>ä½ èƒ½å¦èªªæ˜æ¯å€‹æ¸¬è©¦é …ç›®çš„å·®ç•°ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;h2 id="åˆ†æ">åˆ†æ&lt;/h2>
&lt;h3 id="ç™¼è¡Œ-ab-æ¸¬è©¦ä¹‹å‰">ç™¼è¡Œ AB æ¸¬è©¦ä¹‹å‰&lt;/h3>
&lt;p>ç•¶è¦ç™¼è¡Œæ¸¬è©¦æ™‚ï¼Œå¯ä»¥é€éä¸€äº›ä½¿ç”¨è€…ç ”ç©¶å»ç²¾ç·´æ¸¬è©¦é …ç›®ï¼Œç¢ºä¿å¯¦éš›ç™¼å‡ºçš„ AB æ¸¬è©¦é …ç›®æ˜¯æœ€æœ‰åƒ¹å€¼çš„ï¼Œå‘ spotify æ¯å…©åˆ°ä¸‰é€±æœƒæ‰¾çœŸå¯¦çš„ç”¨æˆ¶åˆ°è¾¦å…¬å®¤æ¥å—è²éŸ³æ¸¬è©¦ï¼Œå„åœ˜éšŠä¾æ“šéœ€æ±‚æå‡ºç”³è«‹ï¼Œåœ¨å¤§è¦æ¨¡ AB æ¸¬è©¦ä¹‹å‰èª¿æ•´æ–‡æ¡ˆèˆ‡è¨­è¨ˆ&lt;/p>
&lt;p>æ¥è‘—è¦ç¢ºä¿ &lt;strong>&lt;code>æœ€å°å¯æª¢æ¸¬æ•ˆæ‡‰&lt;/code>&lt;/strong>ï¼Œæ„å³è¶³ä»¥å®£å‘ŠæˆåŠŸçš„æœ€å°æ”¹è®Šé‡ï¼Œè¦è¨˜å¾—åšä»»ä½•çš„å¯¦é©—éƒ½æœ‰ä»£åƒ¹çš„ï¼Œä¸è«–æ˜¯æŠ•å…¥çš„è³‡æºï¼Œé‚„æ˜¯ç”¨æˆ¶çš„å­¸ç¿’æˆæœ¬éƒ½æ˜¯ï¼Œè¦äº‹å…ˆæ˜å®šæŒ‡æ¨™çš„è®Šå‹•é‡å¤§æ–¼æŸå€‹æ•¸å€¼æ‰èƒ½å¸¶ä¾†çœŸæ­£çš„å•†æ¥­åƒ¹å€¼ï¼Œåä¹‹å‰‡ä¸å€¼å¾—ç™¼è¡Œ&lt;/p>
&lt;p>æœ€å¾Œè¦åŸ·è¡Œå‰ï¼Œç¢ºèªæ¨£æœ¬çš„æª¢æ¨£æ–¹å¼æ˜¯å¦æ­£ç¢º / ç¢ºèªç™¼å¸ƒå¾Œè¦æŒçºŒå¤šä¹… / è€ƒé‡è½å¯¦çš„ç´°ç¯€ç­‰ï¼Œåƒæ˜¯ Facebook åœ¨æ¨å‡ºæ–°åŠŸèƒ½å‰éƒ½æœƒåœ¨ç´è¥¿è˜­å…ˆæ¸¬è©¦ï¼Œå› ç‚º Facebook æ¸¬è©¦æœƒéœ€è¦æœ‰å¯¦éš›çš„ç¤¾äº¤é—œä¿‚ï¼ŒåŒæ™‚åˆè¦èˆ‡å…¶ä»–åœ‹å®¶æœ‰é»éš”é–¡æ‰ä¸æœƒç”¨æˆ¶é«”é©—äº’ç›¸è¡çªç­‰&lt;/p>
&lt;p>é€™æ™‚å€™å¯ä»¥å•è‡ªå·±å¹¾å€‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>æˆ‘åœ¨å˜—è©¦å­¸ç¿’çš„æ±è¥¿æ˜¯ä»€éº¼ï¼Ÿæ˜¯å¦æˆ‘é‚„ç›¸ä¿¡æˆ‘çš„è¨­è¨ˆå¯ä»¥å‚³é”æƒ³è¦å­¸ç¿’çš„æ±è¥¿ï¼Ÿ&lt;/li>
&lt;li>å¦‚æœæˆ‘çš„è©¦é©—æˆåŠŸæˆ–å¤±æ•—ï¼Œæˆ‘è¦åšä»€éº¼ï¼Ÿ&lt;/li>
&lt;li>æˆ‘çš„æ¸¬è©¦æ¨£æœ¬æ˜¯å¦è¶³å¤ å¤§ï¼Ÿ&lt;/li>
&lt;li>æ˜¯å¦äº†è§£æ¸¬è©¦ä¸­çš„æ‰€æœ‰æŒ‡æ¨™ï¼Ÿ&lt;/li>
&lt;li>æ˜¯å¦æœ‰è‰¯å¥½çš„æ¬¡è¦æŒ‡æ¨™ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;h3 id="è©•ä¼°çµæœ">è©•ä¼°çµæœ&lt;/h3>
&lt;p>å¦‚æœçµæœæ˜¯æ­£é¢çš„ï¼Œä»£è¡¨å‡èªªæ˜¯æœ‰åƒ¹å€¼çš„ï¼Œä½†æ­¤æ™‚è¦ä»”ç´°è©•ä¼°èƒŒå¾Œçš„å­¸ç¿’ï¼Œè€Œä¸æ˜¯è²¿ç„¶çš„æ¨å‡ºæ–°åŠŸèƒ½&lt;/p>
&lt;p>ä¾‹å¦‚èªª Esty ç¶²ç«™æ¨å‡ºæ–°çš„å¾Œå°ç³»çµ±æµç¨‹ï¼Œé€éæ¸¬è©¦çµæœè‰¯å¥½ï¼Œä½†è²¿ç„¶æ¨å‡ºæ–°æµç¨‹å¢åŠ èˆŠç”¨æˆ¶çš„å­¸ç¿’æ›²ç·šï¼Œå¾Œä¾†ä»–å€‘åœ¨ä¸æœƒæ¨å‡ºèˆ‡é€æ­¥é‡‹å‡ºä¹‹é–“åšæŠ‰æ“‡&lt;/p>
&lt;p>å¦‚æœçµæœæ˜¯è² é¢çš„ï¼Œè¦åéä¾†æ€è€ƒ&lt;/p>
&lt;ol>
&lt;li>ç”¨æˆ¶æ˜¯å¦ä»¥ä½ æ‰€æƒ³åƒçš„æ–¹å¼ä½¿ç”¨ï¼Ÿ&lt;/li>
&lt;li>ç”¨æˆ¶æ˜¯å¦é—œå¿ƒä½ æ‰€æ²’æœ‰è€ƒæ…®çš„äº‹ç‰©ï¼Ÿ&lt;/li>
&lt;li>é€™åŠŸèƒ½æ˜¯å¦åªæ˜¯ç¾¤é«”çš„ç´°åˆ†æ—ç¾¤ä½¿ç”¨è€Œéå¤§çœ¾éœ€æ±‚ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>æ­¤å¤–æœ‰äº›æ±ºç­–æ˜¯ç‚ºäº†æ›´å¤§çš„å•†æ¥­è€ƒé‡ï¼Œå³ä½¿ç›®å‰çš„æ¸¬è©¦å°è‡´äº›è¨±çš„è² é¢çµæœï¼Œä½†æ¬Šè¡¡ä¹‹å¾Œé‚„æ˜¯å€¼å¾—æ¨å‡ºï¼Œåƒæ˜¯å…ˆå‰ ebay çš„æ¡ˆä¾‹&lt;/p>
&lt;p>å¦‚æœå°ç…§çµ„èˆ‡å¯¦é©—çµ„çš„çµæœå·®ä¸å¤šï¼Œé€™æ˜¯å¸¸è¦‹çš„äº‹æƒ…ï¼Œä¸å¿…å¤ªæ°£é¤’ï¼Œå¯ä»¥åéé ­ä¾†æª¢è¦–æ‰“é€ æ¸¬è©¦çš„éç¨‹æ˜¯å¦æœ‰æ‰€éºæ¼&lt;/p>
&lt;ol>
&lt;li>æ¨£æœ¬çš„é¸æ“‡æ˜¯å¦æ­£ç¢º&lt;/li>
&lt;li>æ˜¯å¦éœ€è¦æ›´å¤šçš„ç”¨æˆ¶æ‰èƒ½é‡æ¸¬&lt;/li>
&lt;li>æ˜¯å¦æœ‰å¤–éƒ¨å› å­å¹²æ“¾&lt;/li>
&lt;li>æŒ–æ˜å…¶ä»–æ¬¡è¦æŒ‡æ¨™èˆ‡é—œéµæŒ‡æ¨™&lt;/li>
&lt;/ol>
&lt;p>æ¥è‘—å¯ä»¥æ±ºå®šæ˜¯å¦é€²è¡Œä¸‹ä¸€è¼ªæ¸¬è©¦ï¼Œåˆæˆ–æ˜¯å°‡æˆæœé€æ­¥æ”¾é‡åˆ°å…¨éƒ¨ç”¨æˆ¶ä¸Š
&lt;img src="https://yuanchieh.page/post/img/20200405/analyze.jpg"
loading="lazy"
>&lt;/p>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>æœ€å¾Œå…©ç« è¬›å¾—æ˜¯å¦‚ä½•åœ¨å…¬å¸å…§å°å…¥ï¼Œä»¥åŠæ‹›è˜åˆé©çš„äººé¸ï¼Œé€™éƒ¨åˆ†å°±æš«ç•¥ï¼Œæ•´ä»½è®€æ›¸å¿ƒå¾—å…¶å¯¦æœ‰é»ç”Ÿç¡¬ï¼Œç•¢ç«Ÿæ˜¯ä¸å¸¸æ¥è§¸çš„é ˜åŸŸï¼Œå¾é–€å¤–æ¼¢èˆ‡å…¬å¸é‹ä½œè§’åº¦ä¸€ç¥æ•¸æ“šé©…å‹•èˆ‡ABæ¸¬è©¦çš„ç¾å¦™ï¼Œæ•´å¥—è¨­è¨ˆéå¸¸çš„ç†æ€§ç§‘å­¸ï¼Œå»ä¹Ÿåœ¨æŸäº›è¨­è¨ˆç’°ç¯€ä¾èˆŠä¿ç•™å‰µé€ èˆ‡å½ˆæ€§ï¼Œçµåˆå…©è€…æ‰èƒ½æŒçºŒæ‰“é€ ç”¨æˆ¶çœŸæ­£éœ€è¦çš„ç”¢å“&lt;/p></description></item><item><title>DNS over HTTPs åˆ†äº«</title><link>https://yuanchieh.page/posts/2020/2020-02-29-dns-over-https-%E5%88%86%E4%BA%AB/</link><pubDate>Sat, 29 Feb 2020 07:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-02-29-dns-over-https-%E5%88%86%E4%BA%AB/</guid><description>&lt;p>æœƒçœ‹åˆ° DNS over HTTPs(DoH) æ˜¯å› ç‚ºé–±è®€åˆ° &lt;a class="link" href="https://blog.mozilla.org/blog/2020/02/25/firefox-continues-push-to-bring-dns-over-https-by-default-for-us-users/" target="_blank" rel="noopener"
>Firefox åœ¨ 2/26 æ–¼ç¾åœ‹ç”¨æˆ¶æ¨å‡ºé è¨­æ¡ç”¨ DoH çš„æ–‡ç« &lt;/a>ï¼Œæ—©åœ¨ Firefox@62 æ™‚å°±å·²ç¶“å…§ç½®é€™é …è¨­å®šï¼Œå…¶é¤˜åœ°å€ç”¨æˆ¶å¯ä»¥é€éè¨­å®šé–‹å•Ÿï¼›&lt;br>
ç›®å‰ &lt;a class="link" href="https://www.ithome.com.tw/news/133004" target="_blank" rel="noopener"
>Chrome æ–¼ 78 ä¹‹å¾Œé è¨­é–‹å•Ÿ&lt;/a>ï¼Œ&lt;a class="link" href="https://www.ithome.com.tw/news/134278" target="_blank" rel="noopener"
>Windows 10 ä¹Ÿå®£å¸ƒå³å°‡æ•´åˆ DoH&lt;/a>ï¼Œå…¬é–‹ DNS è§£ææœå‹™å•†ä¹Ÿè¶Šä¾†è¶Šå¤šæ”¯æ´ DoHï¼Œæ—©å…ˆ Firefox èˆ‡ Cloudflare åˆä½œï¼Œå¾ŒçºŒ Google Public DNS / AdGuard ç­‰ä¹ŸåŠ å…¥æ”¯æ´&lt;/p>
&lt;p>DNS æ˜¯æ­·å²æ‚ ä¹…çš„ç¶²è·¯é€šè¨Šå”å®šï¼ŒåŸºæ–¼ UDP/TCP æŸ¥è©¢åŸŸåå°æ‡‰çš„ç´€éŒ„ï¼Œä½†é€™ä¸€åˆ‡åœ¨ç¶²è·¯å‚³è¼¸éƒ½æ˜¯æ˜æ–‡ï¼Œæ²’æœ‰ä»»ä½•çš„éš±å¯†æ€§èˆ‡å®‰å…¨æ€§ï¼Œå¾Œä¾†æœ‰äº† &lt;code>DNSSEC&lt;/code> å¯ä»¥ç¢ºä¿ DNS ç´€éŒ„æ²’æœ‰è¢«ç«„æ”¹ï¼Œä½†å¯æƒœåœ¨æ¨å»£ä¸Šéœ€è¦æ”¹ DNS Serverï¼Œå—åˆ°å¯¦ä½œé™åˆ¶ä¸¦æ²’æœ‰å…¨é¢å¯¦æ–½&lt;/p>
&lt;p>Mozilla èˆ‡ Google æ–¼å‰é™£å­æå‡º &lt;code>DNS over HTTPs&lt;/code>ï¼Œå°‡ DNS æŸ¥è©¢æ”¾åœ¨ HTTPs ç•¶ä¸­ï¼Œå¦‚æ­¤ä¸€ä¾†é™¤äº†å¯ä»¥é˜²æ­¢è¢«æƒ¡æ„ç«„æ”¹ç­‰ä¸­é–“äººæ”»æ“Šå¤–ï¼Œæ›´å¯ä»¥ä¿è­·ç”¨æˆ¶éš±ç§ï¼ŒISP ç­‰ä¸­é–“çš„ç¶²è·¯è¨­æ–½æä¾›å•†å°±&lt;code>æ¯”è¼ƒé›£è¿½è¹¤ç”¨æˆ¶çš„ç¶²è·¯ç€è¦½&lt;/code>&lt;/p>
&lt;p>é€™ä¸€ç¯‡æ–‡ç« æœƒå…ˆå¤§ç•¥æŠ€è¡“ä»‹ç´¹ï¼Œæ¥è‘—æ•´ç†ç¶²è·¯ä¸Šå°æ–¼ DNS over HTTPs çš„æ­£åå…©æ–¹è¨è«–ï¼Œå…ˆèªªçµè«–æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>æ²’æœ‰æ‰€è¬‚çš„ 100% å®‰å…¨ï¼Œä½†æˆ‘å€‘èƒ½ç›¡åŠ›åšåˆ°æœ€å¥½&lt;/p>
&lt;/blockquote>
&lt;h2 id="æŠ€è¡“å¯¦ä½œ">æŠ€è¡“å¯¦ä½œ&lt;/h2>
&lt;p>DoH å…¶å¯¦å°±æ˜¯é€é HTTPs æŸ¥è©¢ DNS ç´€éŒ„ï¼Œä¸€èˆ¬ DNS åœ¨æŸ¥è©¢è¨˜éŒ„æ™‚æœƒéœ€è¦åè¦†å¤šæ¬¡ï¼Œå¾é ‚ç´šåŸŸåé–‹å§‹ä¸€è·¯æŸ¥åˆ°å­åŸŸåï¼Œåœ¨é€™éç¨‹ä¸­å…¨éƒ¨çš„æœå‹™å•†èˆ‡ç¶²è·¯ä¸­ä»‹è¨­å‚™éƒ½çŸ¥é“ä½ åœ¨æŸ¥è©¢å“ªå€‹ç¶²ç«™&lt;/p>
&lt;p>DoH å¸Œæœ›æ”¹é€é Trusted Recursive Resolver(TRR) å»æŸ¥è©¢ï¼Œäº¤ç”± TRR åšåˆ°è§£æåŸŸåé€™ä»¶äº‹ï¼Œé€™æ¨£å°±ç„¡æ³•å›æº¯åˆ°ä½¿ç”¨è€…æœ¬èº«çš„ IPï¼Œé”åˆ°ä¿å¯†æ€§çš„æ•ˆæœï¼›&lt;br>
åŒæ™‚ç”± DNS åŸŸåå•†æä¾›çš„ TRR æœå‹™æ™‚ï¼Œæœƒåƒè€ƒç”¨æˆ¶çš„ IP ä½ç½®ï¼Œé¿å…ä¸€äº›é€é Geo DNS çš„æœå‹™é€ æˆå½±éŸ¿&lt;/p>
&lt;h2 id="spec-æ¦‚è¦½rfc-8484">Spec æ¦‚è¦½ï¼šRFC-8484&lt;/h2>
&lt;p>&lt;a class="link" href="https://tools.ietf.org/html/rfc8484" target="_blank" rel="noopener"
>RFC8484&lt;/a>ï¼Œç°¡å–®æŠ“å‡ºå¹¾å€‹æœ‰è¶£çš„åœ°æ–¹&lt;/p>
&lt;h3 id="mime-type">MIME Type&lt;/h3>
&lt;p>DoH Client å¯ä»¥ç”¨ &lt;code>application/dns-message&lt;/code>ï¼Œè¡¨æ˜æ˜¯è¦ç”¨ dns æ ¼å¼æŸ¥è©¢ï¼Œä¹Ÿå¯ä»¥ç”¨ json ç­‰æ–¹å¼ï¼Œçœ‹ DoH Server æä¾›ï¼Œå¦‚ &lt;a class="link" href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/wireformat/" target="_blank" rel="noopener"
>Cloudflare æœ‰æä¾› json æ ¼å¼&lt;/a>&lt;/p>
&lt;h3 id="http-method">HTTP Method&lt;/h3>
&lt;p>æ”¯æ´ GET / POST å…©ç¨®æ–¹å¼æŸ¥è©¢&lt;br>
ä¾‹å¦‚èªªè¦æŸ¥è©¢ &lt;a class="link" href="https://www.example.com" target="_blank" rel="noopener"
>www.example.com&lt;/a> é•·é€™æ¨£&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">:method = GET
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">:scheme = https
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">:authority = dnsserver.example.net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">:path = /dns-query?dns=AAABAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">accept = application/dns-message
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å»ºè­°-http2-ç‚ºæœ€ä½ç‰ˆæœ¬">å»ºè­° HTTP2 ç‚ºæœ€ä½ç‰ˆæœ¬&lt;/h3>
&lt;p>å°æ¯” DNS æ¡ç”¨çš„ UDP/TCP ä¾†èªªï¼ŒHTTP é–‹éŠ·å¤§å¾ˆå¤šï¼Œæ¡ç”¨ HTTP2 æœ‰ä¸€äº›æ€§èƒ½ä¸Šå„ªåŒ–çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚é‡ç”¨é€£çµã€é‡æ•´å°åŒ…é †åºã€Header å£“ç¸®ç­‰ï¼Œç›¸æ¯”æ›´èˆŠçš„ HTTP ç‰ˆæœ¬å·²å„˜å¯èƒ½æ¸›è¼•é€šè¨Šä¸Šçš„è² æ“”&lt;/p>
&lt;h2 id="å¯¦éš›ä½¿ç”¨èˆ‡æ¸¬è©¦">å¯¦éš›ä½¿ç”¨èˆ‡æ¸¬è©¦&lt;/h2>
&lt;p>è¦å¯¦éš›ä½¿ç”¨çš„æ–¹å¼æœ‰å¹¾ç¨®ï¼Œä¸€ç¨®æ˜¯åœ¨è‡ªå·±é›»è…¦è£ä¸Š DoH Clientï¼Œæ¥è‘—å°‡ DNS æŸ¥è©¢æŒ‡å‘ DoH Client ç¶“ç”±ä»–ä»£ç†æŸ¥è©¢ï¼Œå¥½è™•æ˜¯é€éä»£ç†ä¸ç”¨æ“”å¿ƒæ‡‰ç”¨ç¨‹å¼çš„æ”¯æ´å•é¡Œï¼Œé€™éƒ¨åˆ†å¯ä»¥å®‰è£ cloudflare æä¾›çš„ &lt;a class="link" href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy/" target="_blank" rel="noopener"
>cloudflared&lt;/a>&lt;/p>
&lt;p>ä½†é€™æ¬¡å¯¦é©—åªæ˜¯è¦å¿«é€Ÿæ¸¬è©¦åŠŸèƒ½ï¼Œèˆ‡åˆ©ç”¨ Wireshark å¯¦åœ°çœ‹å°åŒ…é‡é€çš„éç¨‹ï¼Œæ‰€ä»¥å®‰è£å¦ä¸€å€‹ command line å·¥å…· &lt;a class="link" href="https://www.knot-dns.cz/docs/2.6/html/installation.html" target="_blank" rel="noopener"
>kdig&lt;/a>ï¼Œkdig å¯ä»¥ç›´æ¥æŒ‡å®š DoH Client æŸ¥è©¢ dns ç´€éŒ„ï¼Œæ¯” dig åŠŸèƒ½å†å¤šä¸€äº›ï¼Œå®‰è£å®Œæˆå¾Œæ¯”è¼ƒå…©å€‹æŒ‡ä»¤&lt;/p>
&lt;blockquote>
&lt;p>$ kdig -d @1.1.1.1 +tls-ca +tls-host=cloudflare-dns.com yuanchieh.page
vs
kdig -d @1.1.1.1 yuanchieh.page&lt;/p>
&lt;/blockquote>
&lt;p>é€é Wireshark æ“·å–å°åŒ…çµæœ
&lt;img src="https://yuanchieh.page/post/img/20200229/dns_doh.jpeg"
loading="lazy"
alt="dns over DoH"
>
&lt;img src="https://yuanchieh.page/post/img/20200229/dns.jpeg"
loading="lazy"
alt="dns"
>
å‰è€…èµ°ä¸€èˆ¬ HTTPS æµç¨‹ï¼Œå¾Œè€…èµ° DNS æµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å‚³è¼¸é‡èˆ‡å‚³è¼¸é€Ÿåº¦çš„å·®ç•°&lt;/p>
&lt;h2 id="çˆ­è­°ä¹‹è™•">çˆ­è­°ä¹‹è™•&lt;/h2>
&lt;p>é€™ç¯‡æ–°èæ•´ç†äº†è¨±å¤šå°ˆå®¶å°æ–¼ DoH çš„åå°æ„è¦‹ï¼š&lt;a class="link" href="https://www.zdnet.com/article/dns-over-https-causes-more-problems-than-it-solves-experts-say/" target="_blank" rel="noopener"
>DNS-over-HTTPS causes more problems than it solves, experts say&lt;/a>ï¼Œå…¶ä¸­å¹¾é»è »å€¼å¾—æ›´æ·±å…¥æ¢è¨&lt;/p>
&lt;h3 id="doh-ä¸èƒ½é˜²æ­¢-isp-æ¥­è€…çªºè¦–ç”¨æˆ¶çš„ç€è¦½ç´€éŒ„å¯ä»¥è§£æ±º">DoH ä¸èƒ½é˜²æ­¢ ISP æ¥­è€…çªºè¦–ç”¨æˆ¶çš„ç€è¦½ç´€éŒ„(å¯ä»¥è§£æ±º)&lt;/h3>
&lt;p>DoH ç¢ºå¯¦èƒ½å¤ é˜²æ­¢ ISP æ¥­è€…çœ‹åˆ° DNS æŸ¥è©¢è¨˜éŒ„ï¼Œä½†å¦‚æœç”¨æˆ¶æ˜¯ç”¨ HTTPï¼Œé‚£èµ°ä¸èµ° DoH ä»–çš„ç¶²é ç€è¦½ç´€éŒ„é‚„æ˜¯æœƒè¢«ç™¼ç¾ï¼›&lt;br>
å³ä½¿ç”¨æˆ¶èµ° HTTPSï¼ŒåŸºæ–¼ç¾æœ‰çš„ HTTPS ç¼ºå¤±ï¼Œä¸æ˜¯æ¯å€‹ request éƒ½æ˜¯åŠ å¯†çš„ï¼Œä¾‹å¦‚ &lt;code>SNI&lt;/code> è·Ÿ &lt;code>OSCP&lt;/code>&lt;/p>
&lt;p>SNI æ˜¯ Client å…ˆè·Ÿ Server èª¬ä»–è¦é€£ç·šçš„ hostname æ˜¯å“ªå€‹ï¼Œå› ç‚ºåŒå€‹ IP ä¸Šå¯èƒ½æœ‰å¤šå€‹ Server (Virtual host) éœ€è¦å›å‚³å°æ‡‰çš„æ†‘è­‰ï¼›&lt;br>
OSCP æ˜¯ Client æ”¶åˆ° Server å›å‚³çš„æ†‘è­‰ï¼Œä¸¦éœ€å†å» CA é©—è­‰æ†‘è­‰çš„æœ‰æ•ˆæ€§ï¼›&lt;br>
é€™å…©å€‹ Request éƒ½æ˜¯æ˜æ–‡ï¼Œæ‰€ä»¥éƒ½æœƒè¢«è¨˜éŒ„åˆ°ã€‚&lt;/p>
&lt;p>å†è€…ï¼ŒISP æ¥­è€…é‚„æ˜¯æœƒçŸ¥é“ Client è¦é€å°åŒ…åˆ°å“ªå€‹ IPï¼ŒIP ä½ç½®ä¸æ˜¯å¾ˆæ™‚å¸¸æ›´å‹•ï¼Œé€éåæŸ¥å°±çŸ¥é“ Client æ˜¯åœ¨çœ‹ä»€éº¼ç¶²ç«™&lt;/p>
&lt;p>ä¸Šè¿°æ¢ä»¶ç„¡é—œä¹ DoH çš„å•é¡Œï¼Œä½†ç¢ºå¯¦è®“ DoH æ¯«ç„¡ç”¨æ­¦ä¹‹åœ°&lt;/p>
&lt;h3 id="å…¬å¸ç®¡ç†å›°æ“¾">å…¬å¸ç®¡ç†å›°æ“¾&lt;/h3>
&lt;p>å¦‚æœå…¬å¸é˜²ç«ç‰†é€éåœ¨ DNS éšæ®µéæ¿¾ï¼Œç¢°ä¸Š DoH å°±æœƒå¾ˆé ­ç–¼ï¼Œé€ æˆç®¡ç†ä¸Šçš„æ¼æ´&lt;/p>
&lt;h3 id="éåº¦é›†ä¸­æ–¼-dns-è§£æå•†">éåº¦é›†ä¸­æ–¼ DNS è§£æå•†&lt;/h3>
&lt;p>å†ç™¼èµ· DoH æ™‚ï¼Œæœƒéœ€è¦æŒ‡å®š HTTPs è¯ç¹«çš„å°è±¡ï¼Œé€™é€šå¸¸æ˜¯ç”± DNS è§£æå•†æ‰€æä¾›ï¼Œé€™å°è‡´æ¬Šåˆ©é›†ä¸­æ–¼å¹¾é–“å¤§å…¬å¸æ‰‹è£¡ï¼Œä¾‹å¦‚ Firefox ç€è¦½å™¨å…§é è¨­ä½¿ç”¨ Cloudflare / NextDNSï¼Œé›–ç„¶ä¹Ÿå¯ä»¥åŠ å…¥è‡ªå®šç¾©ï¼Œä½†å¦‚æœä¸€èˆ¬çš„ç”¨æˆ¶ä¸æ…ç†Ÿæ‚‰ï¼Œé€™æœƒå°è‡´ DNS è§£æå•†åè€Œæœ‰å¾ˆå¤§çš„å½±éŸ¿&lt;/p>
&lt;p>å°ˆå®¶å»ºè­°æ˜¯åŸºæ–¼ DNS æœ¬èº«æ©Ÿåˆ¶å¤–åŠ åŠ å¯†æ–¹å¼ï¼Œè€Œä¸æ˜¯æŠŠä½œæ³•ç¶åˆ°å¹¾é–“è§£æå•†æ‰‹ä¸Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>å…§æ–‡æœ‰æåˆ°ã€ŒæŸäº›å…¬å¸ç‚ºäº†è®“è‡ªå·±çœ‹èµ·ä¾†å¾ˆåœ¨æ„ç”¨æˆ¶éš±ç§ï¼Œæ‰æ¨å‡ºé€™ç¨®åŠæ®˜çš„å”å®šï¼Œæ˜¯éå¸¸ä¸è² è²¬ä»»çš„ã€&lt;/p>
&lt;/blockquote>
&lt;h2 id="çµè«–-not-the-end">çµè«–&amp;hellip; not the end!&lt;/h2>
&lt;p>DoH çœ‹ä¼¼è§£æ±ºäº†éƒ¨åˆ†å•é¡Œï¼Œåˆæœ‰ Firefox / Chrome / Windows / Google DNS / Cloudflare ç­‰å¤šå®¶ä¸–ç•Œç´šç”¢å“èˆ‡ DNS æœå‹™å•†çš„æ¨å»£èˆ‡èƒŒæ›¸ï¼Œä½†ç¢ºå¯¦åå°è€…æå‡ºçš„è³ªç–‘ä¹Ÿå¾ˆæœ‰èªªæœåŠ›ï¼Œåªèƒ½èªªå¦‚æœåœ¨æ„ DNS æœ‰æ²’æœ‰è¢«ç«„æ”¹ï¼Œä½¿ç”¨ DoH æˆ–è¨±å¯ä»¥ï¼Œä½†ä¸èƒ½æœŸæœ› DoH å®Œå…¨æŠ¹å»å€‹äººçš„ç¶²é ç€è¦½ç´€éŒ„&lt;/p>
&lt;h2 id="tls-13">TLS 1.3&lt;/h2>
&lt;p>TLS 1.3 æ”¹è®Šäº†åŠ å¯†æµç¨‹ï¼Œç”±æœ€ä¸€é–‹å§‹çš„ &lt;code>Client ç™¼å‡º ClientHello å°±åŠ å¯†äº†&lt;/code>ï¼Œæ­¤æ™‚åŠ å¯†çš„æ–¹å¼æ˜¯å¾ DNS ç´€éŒ„æ‹¿åˆ° Server çš„ Public Keyï¼Œä¸¦æ¡ç”¨ Diffie-Hellman äº¤æ›é‡‘é‘°æ–¹å¼ï¼Œç”¨ã€Œéå°ç¨±åŠ å¯†çš„å…¬é‘°ã€åŠ å¯†ã€Œå°ç¨±åŠ å¯†çš„é‡‘é‘°ã€ï¼Œç”¨ã€Œå°ç¨±åŠ å¯†çš„é‡‘é‘°ã€åŠ å¯†æŒ‡å®šçš„ Server name&lt;/p>
&lt;p>ç›®å‰åƒ…å‰©å”¯ä¸€å€‹å•é¡Œ IP ä½ç½®ï¼Œä½†å¦‚æœ Server æ˜¯åœ¨ CDN å¾Œé¢ï¼Œè®“ ISP åªèƒ½è¿½è¹¤åˆ° CDNï¼Œå¾Œé¢çš„å°±ç„¡æ³•è¿½è¹¤åˆ°&lt;/p>
&lt;p>æ­¤å¤– TLS 1.3 å°‡æ¡æ‰‹æ©Ÿåˆ¶æ¸›å°‘ä¸€å€‹ RTT è®Šæˆåªè¦ä¸€å€‹ RTT å°±èƒ½å®Œæˆäº¤æ¡ï¼Œæ•ˆç‡å¤§å¹…æå‡&lt;/p>
&lt;h2 id="çµè«–">çµè«–&lt;/h2>
&lt;p>TLS 1.3 éœ€è¦ DNS æ”¯æ´ï¼Œå°±å¯ä»¥å¾äº¤æ¡é–‹å§‹å°±å…¨ç¨‹åŠ å¯†ï¼›&lt;br>
è€Œç‚ºäº†é¿å… DNS è¢«æ”»æ“Šæˆ–æ˜¯ç«„æ”¹ç´€éŒ„ï¼Œè¨˜å¾—è¦ä½¿ç”¨ DNSSECï¼›&lt;br>
æœ€å¾ŒåŠ ä¸Š DoHï¼Œè®“ DNS ç´€éŒ„æŸ¥è©¢é€™ä¸€æ®µä¹Ÿä¸æœƒè¢« ISP è¿½è¹¤&lt;/p>
&lt;p>æ•´æ®µè£œä¸Šå¾Œï¼Œå°±èƒ½å¢åŠ ç”¨æˆ¶çš„éš±ç§èˆ‡å®‰å…¨æ€§ï¼Œå¯æƒœ AWS çš„ Route53 è·Ÿ Cloudfront ä¸æ”¯æ´&amp;hellip; :/&lt;br>
çœ‹äº†ä¸€äº›æ–‡ç« ï¼Œç›®å‰è¦ºå¾— Cloudflare åœ¨å®‰å…¨æ€§é€™éƒ¨åˆ†è‘—å¢¨å¾ˆå¤šï¼Œæ”¯æ´åº¦ä¹Ÿéƒ½å¾ˆå¤ ï¼Œæˆ–è¨±è©²è€ƒæ…®çœ‹çœ‹&lt;/p>
&lt;h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™&lt;/h2>
&lt;p>&lt;a class="link" href="https://hacks.mozilla.org/2018/05/a-cartoon-intro-to-dns-over-https/" target="_blank" rel="noopener"
>A cartoon intro to DNS over HTTPS&lt;/a>: éå¸¸ä»”ç´°è¬›è§£éç¨‹
&lt;a class="link" href="https://blog.sean-wright.com/dns-over-tls-dns-over-https-is-it-the-privacy-magic-bullet-2/" target="_blank" rel="noopener"
>DNS over TLS / DNS over HTTPS - Is it the privacy magic bullet?&lt;/a>&lt;/p></description></item><item><title>Expressjs Middleware å¦‚ä½•åœ¨ Response çµæŸè§¸ç™¼</title><link>https://yuanchieh.page/posts/2020/2020-02-06-expressjs-middleware-%E5%A6%82%E4%BD%95%E5%9C%A8-response-%E7%B5%90%E6%9D%9F%E8%A7%B8%E7%99%BC/</link><pubDate>Thu, 06 Feb 2020 22:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-02-06-expressjs-middleware-%E5%A6%82%E4%BD%95%E5%9C%A8-response-%E7%B5%90%E6%9D%9F%E8%A7%B8%E7%99%BC/</guid><description>&lt;p>åœ¨ä½¿ç”¨ express.js ç•¶ä½œ Nodejs server æ¡†æ¶æ™‚ï¼Œæ™‚å¸¸æœƒéœ€è¦å¯«ä¸€äº› Middleware è™•ç† Token é©—è­‰ã€ç”¨æˆ¶æ¬Šé™æª¢æŸ¥ç­‰ç­‰ï¼Œä¹Ÿæœƒå¥—ç”¨å¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ¨¡çµ„å»å»ºæ§‹ç¨‹å¼&lt;br>
ä½†çªç„¶æŸå¤©åœ¨æ€è€ƒ&lt;code>å¦‚ä½•è‡ªå·±å¯«ä¸€å€‹ç´€éŒ„response time&lt;/code>çš„ Middlewareï¼Œç™¼ç¾è‡ªå·±æ²’è¾¦æ³•ç”¨ä¸€å€‹ Middleware è¨»å†Šå°±å®Œæˆé€™ä»¶äº‹ï¼Œå› ç‚º express.js ä¸åƒæ˜¯ Koa çš„ middleware æ˜¯ç”¨ promise based å¯¦ä½œï¼Œæ‰€ä»¥ç•¶æŸå€‹ç’°ç¯€æ˜¯éåŒæ­¥ï¼ŒåŸ·è¡Œçš„é †åºå°±æœƒéŒ¯äº‚&lt;/p>
&lt;p>å¾Œä¾†æŸ¥çœ‹äº† &lt;code>morgan&lt;/code> è¢«å¤§é‡ä½¿ç”¨çš„ express log middlewareï¼Œæ‰ç™¼ç¾å…¶ä¸­è¨­è¨ˆçš„å°å·§æ€ï¼Œä»¥ä¸‹æ˜¯æ•´ç†çš„å…§å®¹&lt;/p>
&lt;h2 id="expressjs-middleware-è¨­è¨ˆ">Expressjs Middleware è¨­è¨ˆ&lt;/h2>
&lt;p>å…ˆä¾†çœ‹æœ€åŸºæœ¬çš„ Middleware è¨­è¨ˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">express&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;express&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">express&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;middleware 1 start&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;middleware 1 end&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;middleware 2 start&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;middleware 2 end&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;request started&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">delay&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;request finished&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">send&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">delay&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)=&amp;gt;{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()=&amp;gt;{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3000&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›®å‰çš„ log æœƒè®Šæˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">middleware 1 start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">middleware 2 start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">request started
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">middleware 2 end
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">middleware 1 end
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">request finished
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæˆ‘å€‘å¸Œæœ›åœ¨ Request é€²ä¾†å…ˆç´€éŒ„é–‹å§‹æ™‚é–“ï¼Œæ¥è‘—åœ¨ Response çµæŸæ™‚ç´€éŒ„çµæŸæ™‚é–“ï¼Œå°±å¿…é ˆä»°è³´å…¶ä»–çš„å¯¦ä½œæ–¹å¼&lt;/p>
&lt;h2 id="on-headers--on-finished">on-headers / on-finished&lt;/h2>
&lt;p>çˆ¬é &lt;code>morgan&lt;/code> ç¨‹å¼ç¢¼å¾Œï¼Œç™¼ç¾æ˜¯é€éé€™å…©å€‹æ¨¡çµ„å»å¯¦ä½œåŠŸèƒ½çš„&lt;br>
&lt;a class="link" href="https://github.com/jshttp/on-headers" target="_blank" rel="noopener"
>on-headers&lt;/a>ï¼šè¨»å†Šäº‹ä»¶ï¼Œç•¶ header è¢«å¯«å…¥æ™‚æœƒè§¸ç™¼&lt;br>
&lt;a class="link" href="https://github.com/jshttp/on-finished" target="_blank" rel="noopener"
>on-finished&lt;/a>ï¼šè¨»å†Šäº‹ä»¶ï¼Œç•¶ request/response çµæŸæ™‚è§¸ç™¼&lt;br>
é€™å…©å€‹æ¨¡çµ„å¯ä»¥é‡å° Nodejs åŸç”Ÿçš„ http server æ­é…ä½¿ç”¨ï¼Œexpress.js ä¹Ÿæ˜¯ç¹¼æ‰¿åŸç”Ÿçš„ http server&lt;/p>
&lt;p>åœ¨ &lt;code>morgan&lt;/code> module ä¸­ï¼Œåœ¨ middleware é€²å…¥ä¸€é–‹å§‹æ¨™è¨˜ request é–‹å§‹æ™‚é–“ï¼Œåœ¨ on-headers æ™‚ç´€éŒ„ request çµæŸæ™‚é–“ï¼Œåœ¨ on-finished å°‡è¨Šæ¯å°å‡ºï¼Œpseudo code å¤§è‡´å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_startTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Date&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">getTime&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">onHeader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_endTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Date&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">getTime&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">onFinished&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`req process time: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_endTime&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_startTime&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> ms`&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">next&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>log çµæœæ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">request started
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">request finished
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">req process time: 1010 ms
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="on-headers-å¯¦ä½œ">on-headers å¯¦ä½œ&lt;/h3>
&lt;p>å°‡åŸæœ¬çš„ response ä¸­çš„ writeHead è¤‡å¯«ï¼Œåªæ˜¯å¤šåŒ…ä¸€å±¤è§¸ç™¼äº‹ä»¶çš„æ©Ÿåˆ¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">createWriteHead&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">prevWriteHead&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">listener&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">fired&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// return function with core name and argument list
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">writeHead&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">statusCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// set headers from arguments
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">setWriteHeadHeaders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">arguments&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// fire listener
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nx">fired&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fired&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">listener&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">prevWriteHead&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">onHeaders&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">listener&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">TypeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;argument res is required&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">typeof&lt;/span> &lt;span class="nx">listener&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="s1">&amp;#39;function&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">TypeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;argument listener must be a function&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">writeHead&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">createWriteHead&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">writeHead&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">listener&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="on-finished-å¯¦ä½œ">on-finished å¯¦ä½œ&lt;/h3>
&lt;p>é€™é‚Šçš„å¯¦ä½œå°±æ¯”è¼ƒæœ‰è¶£ï¼Œå¦‚ä½•æ­£ç¢ºçš„åˆ¤è®€ http request/response çµæŸäº†å‘¢ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">isFinished&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">socket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">socket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">typeof&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">finished&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;boolean&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// OutgoingMessage
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nb">Boolean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">finished&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">socket&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">writable&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">typeof&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">complete&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;boolean&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// IncomingMessage
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nb">Boolean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">upgrade&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">socket&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readable&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">complete&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readable&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// don&amp;#39;t know
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kc">undefined&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ˜¯å¥—ç”¨åœ¨ responseï¼Œéœ€æ³¨æ„æ ¹æ“šå®˜æ–¹æ–‡ä»¶ &lt;a class="link" href="https://nodejs.org/api/http.html#http_request_finished" target="_blank" rel="noopener"
>response.finished&lt;/a> æ˜¯æŒ‡èªª &lt;code>res.end()&lt;/code> è¢«å‘¼å«å¾Œè¨­å®šç‚º trueï¼Œä¸ä»£è¡¨ response ä¸­çš„è³‡æ–™å®Œå…¨å‚³è¼¸åˆ°ç¶²è·¯ä¸Š&lt;/p>
&lt;p>é€™äº›è¨è«–å¯ä»¥çœ‹ PR &lt;a class="link" href="https://github.com/jshttp/on-finished/pull/31" target="_blank" rel="noopener"
>response is only finished if socket is detached #31&lt;/a>ï¼Œæäº¤è€…ä¿®æ”¹æˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">stream&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;boolean&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Http2ServerRequest
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// Http2ServerResponse
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">typeof&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">finished&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;boolean&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// OutgoingMessage
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">finished&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">outputSize&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nx">socket&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">socket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">writableLength&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">socket&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">writable&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¢åŠ  http2 çš„æª¢æŸ¥ï¼Œä»¥åŠç¢ºä¿ &lt;code>outputSize === 0&lt;/code> æ‰€æœ‰ queued ä½çš„è³‡æ–™éƒ½ç¢ºå¯¦é€å‡º socket&lt;/p>
&lt;p>çŸ¥é“å¦‚ä½•åˆ¤æ–· response æ˜¯å¦çµæŸï¼Œæœ€å¾Œçœ‹äº‹ä»¶çš„è¨»å†Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">attachFinishedListener&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">eeMsg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">eeSocket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">finished&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">function&lt;/span> &lt;span class="nx">onFinish&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eeMsg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eeSocket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">finished&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">callback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// finished on first message event
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">eeMsg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">eeSocket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">([[&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;end&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;finish&amp;#39;&lt;/span>&lt;span class="p">]],&lt;/span> &lt;span class="nx">onFinish&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">function&lt;/span> &lt;span class="nx">onSocket&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// remove listener
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">removeListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;socket&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">onSocket&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eeSocket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">([[&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;error&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;close&amp;#39;&lt;/span>&lt;span class="p">]],&lt;/span> &lt;span class="nx">onFinish&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// socket already assigned
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">onSocket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">socket&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// wait for socket to be assigned
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">on&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;socket&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">onSocket&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ response èˆ‡ response.socket åˆ†åˆ¥è¨»å†Šäº‹ä»¶ï¼Œç•¶çµæŸæˆ–éŒ¯èª¤äº‹ä»¶è§¸ç™¼å¾Œï¼Œæª¢æŸ¥ response æ˜¯å¦çœŸçš„çµæŸï¼Œæœ€å¾Œè§¸ç™¼ç”¨æˆ¶è¨»å†Šçš„äº‹ä»¶&lt;/p></description></item><item><title>MongoDB æ‰¹æ¬¡è™•ç†å¤§é‡æ•¸æ“š</title><link>https://yuanchieh.page/posts/2020/2020-02-06-mongodb-%E6%89%B9%E6%AC%A1%E8%99%95%E7%90%86%E5%A4%A7%E9%87%8F%E6%95%B8%E6%93%9A/</link><pubDate>Thu, 06 Feb 2020 22:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-02-06-mongodb-%E6%89%B9%E6%AC%A1%E8%99%95%E7%90%86%E5%A4%A7%E9%87%8F%E6%95%B8%E6%93%9A/</guid><description>&lt;p>æœ¬ç¯‡åˆ†äº« MongoDB åœ¨æ‰¹æ¬¡æŸ¥è¨Šå¤§é‡æ•¸æ“šæ™‚çš„å°æŠ€å·§&lt;/p>
&lt;p>åœ¨æŸ¥è©¢å°ç­†æ•¸æ“šæ™‚ï¼Œå¾€å¾€æˆ‘å€‘å°±æ˜¯ç”¨ &lt;code>find().toArray()&lt;/code> ç›´æ¥å›å‚³çµæœï¼Œéœ€è¦ç°¡å–®çš„åˆ†é å°±æ­é… &lt;code>limit() / skip()&lt;/code> å³å¯å®Œæˆ&lt;br>
ä½†å¦‚æœéœ€è¦åˆ†ææ•¸æ“šè·‘éæ•´å€‹ collectionï¼Œä¸å¯èƒ½ç”¨ find() ä¸€æ¬¡æ‹‰å›æ‰€æœ‰çš„è³‡æ–™ï¼Œé€é skip() æ‰¹æ¬¡è™•ç†ï¼Œå¦‚æœ collection è³‡æ–™ä¸å¤šé‚„å¥½ï¼Œå¦‚æœå¹¾åè¬ç­†ã€å¹¾ç™¾è¬ç­†è³‡æ–™æ•ˆèƒ½å›éå¸¸çš„ä½è½ï¼Œå› ç‚º skip çš„è©±æ¯æ¬¡æŸ¥è©¢ DB éƒ½å¿…é ˆè¦é‡é ­é–‹å§‹è·³éæŒ‡å®šç­†æ•¸è³‡æ–™ï¼Œæ‰èƒ½å›å‚³ï¼Œæ‰€ä»¥æŸ¥è©¢æ™‚é–“æœƒéš¨è‘—ç­†æ•¸å¢åŠ è€Œè¶¨è¿‘æ–¼æŒ‡æ•¸å€å¢é•·&lt;/p>
&lt;p>ç›®å‰å·²çŸ¥æœ‰å…©ç¨®åšæ³•ï¼Œå¯ä»¥æœ‰æ•ˆè¼ªè©¢æ•´å€‹ collection è€Œä¸æ‹–å® DB æ•ˆèƒ½&lt;br>
ä¸€ç¨®æ˜¯ &lt;code>Cursor&lt;/code>ï¼Œä½†æ˜¯åœ¨å¯¦å‹™ä¸Šæˆ‘å€‹äººä¸¦æ²’æœ‰æ¡ç”¨ï¼ŒåŸå› æ˜¯ Cursor æ¯æ¬¡åªèƒ½é€é &lt;code>.next()&lt;/code> å–å¾—ä¸€ç­†è³‡æ–™ï¼Œå¦‚æœå¸Œæœ›ä¸€æ¬¡æ‹‰å€‹ä¸Šåƒç­†è³‡æ–™è™•ç†å°±ç„¡æ³•åšåˆ°ï¼›&lt;br>
å¦ä¸€ç¨®æ˜¯æœ¬æ¬¡è¦åˆ†äº«çš„æ–¹å¼ï¼Œé€ééè¿´æŸ¥è©¢ï¼Œä¿æŒæ€§èƒ½æƒ…æ³ä¸‹è·‘å®Œæ•´å€‹ Collectionï¼Œå¯¦å‹™ä¸Šæ¯å¤©æ‡‰ç”¨åœ¨æœ‰åƒè¬ç­†è³‡æ–™çš„ Collection è€Œæ²’æœ‰å¤ªå¤§çš„å•é¡Œ&lt;/p>
&lt;h2 id="éå›æŸ¥è©¢">éå›æŸ¥è©¢&lt;/h2>
&lt;p>èªªç©¿äº†å…¶å¯¦å¾ˆç°¡å–®ï¼Œé€éæœ‰å»ºç«‹ index çš„ç´¢å¼•ï¼ŒæŒ‰ç…§éå¢æˆ–éæ¸›æ’åºï¼Œæ¯æ‰¹æ¬¡å–å‡ºéƒ¨åˆ†æ•¸æ“šå¾Œï¼Œä¸‹æ¬¡æŸ¥è©¢çš„æ¢ä»¶æ”¹ç‚ºå–å‡ºæ•¸æ“šçš„æœ€å¾Œä¸€ä½ï¼Œä¸€è·¯åˆ° Collection çµæŸ&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç¨‹å¼ç¢¼éƒ¨åˆ†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">MongoClient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;mongodb&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">MongoClient&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">dbUrl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;mongodb://127.0.0.1:27017&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">MongoClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">dbUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">testDB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">userCollection&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">testDB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">collection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;users&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">iterateCollection&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sourceCollection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">userCollection&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">query&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">age&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batchSize&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">order&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">close&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">iterateCollection&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sourceCollection&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batchSize&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">order&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">sort&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">_query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>&lt;span class="nx">query&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">order&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sort&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">queryResults&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">sourceCollection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">find&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_query&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">limit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">batchSize&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">toArray&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">queryResults&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">$lt&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">queryResults&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">queryResults&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">order&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">$gt&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">queryResults&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">queryResults&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// process data and push to result
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// result.push(queryResults.map(result =&amp;gt; result._id));
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Redis Lock (Redlock) åˆ†æ•£å¼ lock åŸç†åˆ†æèˆ‡å¯¦ä½œ</title><link>https://yuanchieh.page/posts/2020/2020-01-14_redis-lock-redlock-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E8%88%87%E5%AF%A6%E4%BD%9C/</link><pubDate>Tue, 14 Jan 2020 05:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-01-14_redis-lock-redlock-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E8%88%87%E5%AF%A6%E4%BD%9C/</guid><description>&lt;p>å…ˆå‰å…¬å¸é‡åˆ° Client åœ¨ä¸æ˜ç‹€æ³ä¸‹é€£çºŒå‘¼å«è¨»å†Šç”¨æˆ¶çš„ API å…©æ¬¡ï¼Œå°è‡´ç”¨æˆ¶è¢«é‡è¤‡å»ºç«‹ï¼Œå°è‡´å¾ŒçºŒçš„ API æ“ä½œèˆ‡è³‡æ–™åˆ†æç•°å¸¸ï¼Œæ‰€ä»¥æ±ºå®šåŠ ä¸Š Lock æ©Ÿåˆ¶é¿å…é‡è¤‡å»ºç«‹çš„å•é¡Œ&lt;/p>
&lt;p>å‰›å¥½åœ¨ Redis å®˜ç¶²çœ‹åˆ° Redlockï¼Œä¸€ç¨® Redis ä½œè€… antirez åŸºæ–¼ Redis è¨­è¨ˆçš„åˆ†æ•£å¼ lock æ©Ÿåˆ¶ï¼Œä¸¦ä¸”å·²ç¶“æœ‰äº† Nodejs ç‰ˆæœ¬çš„å¯¦ä½œï¼Œæ‰€ä»¥å°±æ±ºå®šæ¡ç”¨é€™å¥—æ–¹æ³•ï¼Œä¹Ÿç¢ºå¯¦è§£æ±ºäº†å•é¡Œ&lt;/p>
&lt;p>æœ¬æ¬¡éƒ¨è½æ ¼æœƒæ‘˜éŒ„å®˜æ–¹èªªæ˜ &lt;a class="link" href="https://redis.io/topics/distlock" target="_blank" rel="noopener"
>Distributed locks with Redis&lt;/a>ï¼Œä¸¦æ•´ç† Martin Kleppmann æå‡ºè³ªç–‘ &lt;a class="link" href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html" target="_blank" rel="noopener"
>How to do distributed locking&lt;/a>èˆ‡ä½œè€…å†æ¬¡å›å¾© &lt;a class="link" href="http://antirez.com/news/101" target="_blank" rel="noopener"
>Is Redlock safe?&lt;/a>&lt;/p>
&lt;p>é¡Œå¤–è©±ä»‹ç´¹ Martin Kleppmannï¼Œä»–å°±æ˜¯ã€ŠDesigning Data-Intensive Applicationsã€‹ä¸€æ›¸çš„ä½œè€…ï¼Œç›®å‰ä»æ˜¯æˆ‘æœ€æ¨è–¦çš„å·¥ç¨‹æ›¸ç±ï¼Œå¯ä»¥åƒè€ƒä¹‹å‰çš„ç­†è¨˜&lt;br>
&lt;a class="link" href="https://yuanchieh.page/post/2018-03-28_designing-data-intensive-applications-%E4%B8%8A/" target="_blank" rel="noopener"
>æŠ€è¡“ç­†è¨˜ Designing Data-Intensive Applications ä¸Š&lt;/a>&lt;br>
&lt;a class="link" href="https://yuanchieh.page/post/2018-04-19_designing-data-intensive-applications-%E4%B8%8B/" target="_blank" rel="noopener"
>æŠ€è¡“ç­†è¨˜ Designing Data-Intensive Applications ä¸‹&lt;/a>&lt;/p>
&lt;h1 id="redlock-ç°¡ä»‹">Redlock ç°¡ä»‹&lt;/h1>
&lt;p>ç•¶æˆ‘å€‘åœ¨è¨­è¨ˆåˆ†æ•£å¼ Lock æ©Ÿåˆ¶æ™‚ï¼Œæœ‰ä¸‰é»åŸå‰‡å¿…é ˆè€ƒé‡åˆ°&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Safety&lt;/strong> &lt;br>
ç•¶ Lock è¢«å–èµ°å¾Œï¼Œåœ¨é‡‹æ”¾ä¹‹å‰ä¸èƒ½æœ‰å¦ä¸€å€‹ Client å–å¾— Lockï¼Œä¹Ÿå°±æ˜¯ &lt;code>mutual exclusive&lt;/code>&lt;/li>
&lt;li>&lt;strong>DeadLock Free&lt;/strong>&lt;br>
Lock å¿…é ˆåœ¨ä¸€æ®µæ™‚é–“å¾Œ(TTL) è‡ªå‹•é‡‹æ”¾ï¼Œé¿å…æ¡ä½ Lock çš„ Client è·¨æ‰è€Œ Lock å¾æ­¤ä¸èƒ½è¢«é‡‹æ”¾&lt;/li>
&lt;li>&lt;strong>Fault Tolerance&lt;/strong>&lt;br>
æ•´é«”ç³»çµ±ä¸èƒ½æœ‰å–®ä¸€ç¯€é»å¤±æ•—çš„å¯èƒ½ï¼Œå¿…é ˆè€ƒé‡ç³»çµ±å®¹éŒ¯æ€§&lt;/li>
&lt;/ol>
&lt;p>å¾ŒçºŒè§£èªªæ¼”ç®—æ³•å¯¦ä½œæ™‚ï¼Œæœƒä¸æ–·å»æª¢è¦–é€™ä¸‰é»åŸå‰‡æ˜¯å¦è¢«æ»¿è¶³&lt;/p>
&lt;p>éœ€æ³¨æ„åˆ°&lt;code>å®¹éŒ¯æ©Ÿåˆ¶&lt;/code>å¯èƒ½æœƒè¯æƒ³åˆ° Master / Slave æ¶æ§‹ï¼Œä½†æ˜¯åœ¨ Redis ä¸­ Slave è³‡æ–™å‚™ä»½æ˜¯éåŒæ­¥çš„ï¼Œæ‰€ä»¥ç•¶ Master æ›æ‰åˆ° Slave æ¥æ‰‹ï¼Œä¸­é–“çš„æ™‚é–“å·® Client æœ‰æ©Ÿæœƒå–å¾—å¤šå€‹ç›¸åŒ Lockï¼Œé€™æœƒé•åç¬¬ä¸€é»åŸå‰‡ï¼ŒCluster æ¶æ§‹åŒç†&lt;/p>
&lt;p>æ‰€ä»¥é€™è£¡ä½œè€…æè­°çš„å®¹éŒ¯æ©Ÿåˆ¶ä¸»è¦åŸºæ–¼ &lt;code>Multi-Master&lt;/code> æ©Ÿåˆ¶ï¼Œå¾ŒçºŒæœƒæœ‰æ›´æ·±å…¥çš„è§£é‡‹&lt;/p>
&lt;h2 id="å–®æ©ŸåŸå‰‡">å–®æ©ŸåŸå‰‡&lt;/h2>
&lt;p>å†è€ƒé‡åˆ†æ•£å¼è¨­è¨ˆä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆæ€è€ƒå–®ä¸€å° Redis å¦‚ä½•å¯¦ä½œ Lock æ©Ÿåˆ¶&lt;/p>
&lt;h3 id="å–å¾—-lock">å–å¾— Lock&lt;/h3>
&lt;p>ç•¶è¦å–å¾— Lockï¼Œå¯ä»¥ç”¨ä»¥ä¸‹çš„æŒ‡ä»¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">SET resource_name my_random_value NX PX 30000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>NX&lt;/code> è¡¨ç¤ºåªæœ‰ç•¶ &lt;code>resource_name&lt;/code> ä¸å­˜åœ¨æ‰å‰µå»ºé€™å€‹ Keyï¼Œé¿å…é‡è¤‡å»ºç«‹ï¼Œç¬¦åˆç¬¬ä¸€é»åŸå‰‡ &lt;br>
&lt;code>Px 30000&lt;/code> è¡¨ç¤º Key çš„ TTL æ˜¯ 30ç§’ï¼Œç¬¦åˆç¬¬äºŒé»åŸå‰‡&lt;/p>
&lt;h3 id="é‡‹æ”¾-lock">é‡‹æ”¾ Lock&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;del&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨é‡‹æ”¾ Key æ™‚ï¼Œå¿…é ˆå…ˆæª¢æŸ¥ Key å°æ‡‰çš„ Valueæ˜¯ä¸æ˜¯æˆ‘å€‘ä¸€é–‹å§‹å¡é€²å»çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šå€‹æ­¥é©Ÿçš„ &lt;code>my_random_value&lt;/code>ï¼Œé€™æ˜¯è¦ç¢ºä¿ç§»é™¤çš„ Lock æ˜¯ç•¶åˆæˆ‘å€‘å–å¾—çš„ Lockï¼Œè©¦æƒ³ä¸€ä¸‹æƒ…æ³&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="k">1.&lt;/span> Client A å–å¾— Lock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">2.&lt;/span> Client A æ™‚é–“è¶…é TTLï¼ŒRedis ç§»é™¤ Lock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">3.&lt;/span> Client B å–å¾—ç›¸åŒ Lockï¼Œå› ç‚º Client A è¶…æ™‚æ‰€ä»¥ Client B å¯ä»¥å–å¾— Lock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">4.&lt;/span> Client A æ­¤æ™‚è¦é‡‹æ”¾ Lock
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¥é©Ÿå››å¦‚æœæ²’æœ‰æª¢æŸ¥ï¼ŒClient A ä¸å°å¿ƒç§»é™¤äº† Client B çš„ Lockï¼Œæ­¤æ™‚å°±æœƒç ´å£ç¬¬ä¸€é»åŸå‰‡&lt;/p>
&lt;h3 id="random-string">Random String&lt;/h3>
&lt;p>Random String çš„ç”¢ç”Ÿæ©Ÿåˆ¶ï¼Œå¯ä»¥å– &lt;code>/dev/urandom&lt;/code> çš„ 20 bytesï¼Œ/dev/urandom æ˜¯*unix ç³»çµ±ç”¢ç”Ÿå½äº‚æ•¸çš„æ–¹å¼ï¼Œä¾æ“šè¨­å®šçš„ä¸åŒå¯èƒ½æ˜¯å¾ç’°å¢ƒå™ªéŸ³ã€ç¶²è·¯æ•¸æ“šå°åŒ…ç­‰å¤–åœ¨ç‰©ç†ç¾è±¡ï¼Œé€™æ¨£çš„åšæ³•å¯ä»¥ä¿è­‰è¼ƒå¥½çš„éš¨æ©Ÿæ€§ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–ç°¡å–®çš„æ–¹å¼ï¼Œä¾‹å¦‚å–ç³»çµ±æ™‚é–“åŠ ä¸Š client_id ç­‰ç­‰ï¼Œå–æ±ºæ–¼å¯¦ä½œè€…çš„è¨­è¨ˆ&lt;/p>
&lt;h2 id="å¥—ç”¨è‡³åˆ†æ•£å¼ç³»çµ±">å¥—ç”¨è‡³åˆ†æ•£å¼ç³»çµ±&lt;/h2>
&lt;h3 id="å–å¾—-lock-1">å–å¾— Lock&lt;/h3>
&lt;p>å‡è¨­ç›®å‰æœ‰ N å° Redis masterï¼Œé€™ N å°éƒ½è·‘åœ¨ç¨ç«‹çš„ç’°å¢ƒä¸Šè€Œéä½¿ç”¨ Cluster æ¶æ§‹ï¼Œå‡è¨­ N=5ï¼Œä»¥ä¸‹æ˜¯å¯¦ä½œæ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>å–å¾—ç•¶å‰æ™‚é–“ T1&lt;/li>
&lt;li>ç”¨ç›¸åŒçš„ Key / Value ä¾åºå–å¾— N å°çš„ Lockï¼Œåœ¨å–å¾— Lock æ™‚è¦è¨­å®šé€£ç·šTimeoutï¼Œæ­¤ Timeout(ex. 5~50ms) æ‡‰è©²é å°æ–¼ Lock çš„ TTL (ex. 10s)ï¼Œé¿å… Client æµªè²»å¤ªå¤šæ™‚é–“åœ¨ç­‰æ­»æ‰çš„ Redis Serverï¼ŒClient å› å„˜é€Ÿå–å¾— Lock&lt;/li>
&lt;li>ç•¶å–å¾— Lock å¾Œï¼Œå‡è¨­æ­¤æ™‚æ™‚é–“ç‚º T2ï¼ŒClient æª¢æŸ¥ T2-T1 æ˜¯å¦å¤§æ–¼ Lock æœ‰æ•ˆæ™‚é–“ TTLï¼Œåªæœ‰ç•¶&lt;code>æ™‚é–“æœ‰æ•ˆä¸”å¤§å¤šæ•¸çš„ Redis Servre(éåŠæ•¸ï¼Œä¹Ÿå°±æ˜¯ &amp;gt;=3)&lt;/code> æ‰ç®—æ˜¯æœ‰æ•ˆå–å¾— Lock&lt;/li>
&lt;li>æ­¤æ™‚ Lock åƒ…å‰©æœ‰æ•ˆæ™‚é–“æ˜¯ T2 - T1&lt;/li>
&lt;li>å¦‚æœ Client å–å¾— Lock å¤±æ•— (ä¾‹å¦‚æœ‰æ•ˆæ™‚é–“æ˜¯è² æ•¸ã€ç„¡æ³•å–å¾—éåŠ Redis Master Lock)ï¼ŒClient å¿…é ˆå°æ¯ä¸€å° Redis Master ç™¼é€é‡‹æ”¾ Lock æŒ‡ä»¤ï¼Œå³ä½¿è©²å° Redis Master æ²’æœ‰çµ¦ä»– Lock&lt;/li>
&lt;/ol>
&lt;p>åˆ†æ•£å¼ä»£è¡¨å„å€‹ç¨‹åºæ²’æœ‰åŒæ­¥çš„æ™‚é–“ä¸Šï¼Œè€Œä¸”æ¯å°æ©Ÿå™¨å› ç‚ºè¨ˆæ™‚å™¨çš„ç‰©ç†æ€§è³ªï¼Œæœƒæœ‰æ™‚é–“åå·®çš„å•é¡Œ(Clock Drift å•é¡Œ) &lt;br>
æ™‚é–“è¨ˆç®—æœƒå½±éŸ¿ç¬¬ä¸‰æ­¥é©Ÿçš„æœ‰æ•ˆæ™‚é–“ï¼Œæ‰€ä»¥éœ€è¦æ¸›å»ä¸€é»åå·®ç•¶ä½œè£œå„Ÿï¼Œä½†ç¾å¯¦ä¸–ç•Œçš„æ™‚é–“è¨ˆç®—é ‚å¤šå°±å¹¾å€‹æ¯«ç§’çš„èª¤å·®&lt;/p>
&lt;p>æ‰€ä»¥å¯¦éš› Lock çš„æœ‰æ•ˆæ™‚é–“æœƒæ˜¯ &lt;code>TTL - (T2-T1) - CLOCK_DRIFT&lt;/code>&lt;/p>
&lt;h3 id="retry">Retry&lt;/h3>
&lt;p>å¦‚æœ Client å–å¾— Lock å¤±æ•—ï¼Œæ‡‰è©²åœ¨ä¸€å®šç§’æ•¸å¾Œéš¨æ©Ÿ delay ä¸€æ®µæ™‚é–“ï¼Œå†æ¬¡é‡æ–°å˜—è©¦ï¼Œéš¨æ©Ÿ delay æ˜¯ç‚ºäº†éŒ¯é–‹åŒæ™‚å¤šå€‹ Clientï¼Œè®“è¼ƒå¿«è€…å¯ä»¥å…ˆå–å¾— Lockï¼Œå¦‚æœ Client æ²’æœ‰å–å¾— Lockï¼Œæ‡‰è©²å„˜é€Ÿé‡‹æ”¾ Lock&lt;/p>
&lt;h3 id="é‡‹æ”¾-lock-1">é‡‹æ”¾ Lock&lt;/h3>
&lt;p>åŒæ™‚å‘æ‰€æœ‰çš„ Redis Master é‡‹æ”¾ Lock&lt;/p>
&lt;h2 id="æª¢é©—æ¼”ç®—æ³•">æª¢é©—æ¼”ç®—æ³•&lt;/h2>
&lt;p>å› ç‚ºå†ä¾åºå–å¾— Lock æœƒæœ‰æ™‚é–“å·®ï¼Œå‡è¨­ Client å¾ç¬¬ä¸€å€‹ Redis Master å–å¾— Lock æ™‚é–“ç‚º &lt;code>T1&lt;/code>ï¼Œæœ€å¾Œä¸€å€‹ Master å›å‚³æ™‚é–“ç‚º &lt;code>T2&lt;/code>ï¼Œé‚£éº¼ç¬¬ä¸€å€‹ Lock åƒ…å‰©çš„ç”Ÿå‘½æ™‚é–“æ˜¯ &lt;code>TTL - (T2 - T1) - Clock Drift&lt;/code>ï¼Œé€™ä¹Ÿå°±æ˜¯æœ€å°æœ‰æ•ˆæ™‚é–“ MIN_VALIDITYï¼›Clock Drift æ˜¯ä¸Šè¿°çš„æ™‚é–“èª¤å·®ï¼›(T2-T1) å‰‡æ˜¯å– Lock çš„ç­‰å¾…æ™‚é–“&lt;/p>
&lt;p>å‡è¨­ Client å– Lock æ™‚é–“ (T2-T1) &amp;gt; TTLï¼Œä¹Ÿå°±æ˜¯ Client å–åˆ°æœ€å¾Œä¸€å€‹ Lock æ™‚ç¬¬ä¸€å€‹ Lock å·²ç¶“å¤±æ•ˆäº†ï¼Œé‚£æ­¤æ™‚å°±æœƒå…¨éƒ¨é‡‹æ”¾ï¼Œä¸æœƒæœ‰éŒ¯èª¤ç”¢ç”Ÿ&lt;/p>
&lt;p>å‡è¨­ Client æˆåŠŸå–å¾— Lockï¼Œé‚£åœ¨å…ˆå‰çš„æ¢ä»¶ä¿è­‰ï¼Œæ²’æœ‰å…¶ä»–ç”¨æˆ¶å¯ä»¥åœ¨ MIN_VALIDITY å…§å–å¾—å¤§å¤šæ•¸ Master çš„ Lockï¼Œä¹Ÿå°±ä¸æœƒç ´å£ Lock çš„åŸå‰‡æ€§&lt;/p>
&lt;blockquote>
&lt;p>è¦ç¢ºä¿ MIN_VALIDITY çš„æ™‚é–“å…§é—œéµè³‡æºèƒ½å¤ é‹ä½œå®Œæˆï¼Œä¸ç„¶ TTL éå¾Œ Lock è¢«å…¶ä»–äººå–èµ°ï¼ŒLock å°±å¤±å»äº’æ–¥åŸå‰‡&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ€§èƒ½æ•…éšœå¾©åŸ">æ€§èƒ½ã€æ•…éšœå¾©åŸ&lt;/h2>
&lt;p>Redis å¸¸ç”¨æ–¼é«˜æ€§èƒ½éœ€æ±‚çš„å ´æ™¯ï¼Œæˆ‘å€‘æœƒå¸Œæœ› Lock å–å¾—/é‡‹æ”¾å¯ä»¥è¶Šå¿«ï¼Œå¢åŠ  throughput èˆ‡é™ä½å»¶é²ï¼Œåœ¨éç¨‹æœ€å¥½çš„æ–¹å¼æ˜¯ Client åŒæ™‚å‘å¤šå° Master å– Lock&lt;/p>
&lt;p>å¦å¤–è€ƒé‡åˆ°æ•…éšœå¾©åŸçš„éƒ¨åˆ†ï¼Œå‡è¨­ä»Šå¤©å–å¾— Lock å¾Œ Master æ•…éšœäº†ï¼Œå‡ä½¿æ²’æœ‰é–‹ &lt;code>AOF&lt;/code> å„²å­˜æ©Ÿåˆ¶ï¼Œé‚£å¯èƒ½ Lock æ²’æœ‰ä¿å­˜åˆ°ç£ç¢Ÿä¸Šï¼Œå¾©åŸæ™‚éºå¤±å°±æœ‰æ©Ÿæœƒé•åç¬¬ä¸€é»åŸå‰‡&lt;br>
å‡ä½¿æœ‰é–‹ &lt;code>AOF&lt;/code>ï¼Œä¹Ÿè¨˜å¾—è¦èª¿æ•´ &lt;code>fsync&lt;/code> é »ç‡ï¼Œæœ€ä¿éšªæ˜¯è¨­æˆ alwaysï¼Œä½†é€™æœƒå½±éŸ¿æ€§èƒ½&lt;/p>
&lt;p>ä½†é™¤äº†å³æ™‚è³‡æ–™å‚™ä»½åˆ°ç£ç¢Ÿä¸Šå¤–ï¼Œé‚„å¯ä»¥è€ƒæ…®å¦ä¸€ç¨®åšæ³•ï¼Œç•¶ Master æ•…éšœå¾©åŸå¾Œï¼Œ&lt;code>å»¶é²é‡å•Ÿçš„æ™‚é–“å¤§æ–¼ TTL&lt;/code>ï¼Œä¹Ÿå°±æ˜¯èªªè®“åŸå…ˆ Master ä¸Šçš„ Lock éƒ½é‡‹æ”¾æˆ–è‡ªå‹•å¤±æ•ˆï¼Œä¹‹å¾Œå†é‡æ–°åŠ å…¥å°±èƒ½é¿å…é•åå®‰å…¨åŸå‰‡ï¼Œä¸éè¦å°å¿ƒå¦‚æœè¶…éå¤šæ•¸çš„ Server æ•…éšœï¼Œéœ€è¦ç­‰ç›¸å°é•·çš„æ™‚é–“æ‰èƒ½é‡æ–°é‹ä½œï¼Œæ­¤éšæ®µ Lock éƒ½ç„¡æ³•å–å¾—&lt;/p>
&lt;p>æœ€å¾Œå¦‚æœæœ‰é¤˜è£•å¯ä»¥è¨­è¨ˆå»¶é•· Lockï¼Œè®“æ¡æœ‰ Lock çš„ Client å¯ä»¥å»¶é•·æ‰‹ä¸­çš„ Lock&lt;/p>
&lt;p>ä»¥ä¸Šæ˜¯æ‘˜éŒ„è‡ªå®˜ç¶²æ–‡ä»¶çš„æ•´ç†&lt;/p>
&lt;h2 id="nodejs-package---redlock-å¯¦ä½œ">Nodejs Package - Redlock å¯¦ä½œ&lt;/h2>
&lt;p>çœ‹å®Œæ¼”ç®—æ³•ï¼Œä¾†çœ‹ä¸€ä¸‹ Nodejs ç‰ˆæœ¬çš„å¯¦ä½œ &lt;a class="link" href="https://github.com/mike-marcacci/node-redlock" target="_blank" rel="noopener"
>mike-marcacci/node-redlock&lt;/a>&lt;/p>
&lt;p>ä»–åœ¨ &lt;code>Redlock.prototype._lock&lt;/code> éƒ¨åˆ†å¯¦ç¾ Lock æ©Ÿåˆ¶&lt;/p>
&lt;p>æˆªå¹¾å€‹é—œéµç‰‡æ®µï¼Œè¼ªè©¢æ‰€æœ‰çš„ server&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nx">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">forEach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">loop&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>request ä¸»è¦å°è£ lock çš„ scriptï¼Œæ”¯æ´å¦‚æœåŒæ™‚å¤šå€‹ resource è¦é–å¯ä»¥ä¸€èµ·é–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">request&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">loop&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">eval&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lockScript&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ttl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">loop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™ä¸€æ®µè€ƒé‡åˆ° drift å•é¡Œï¼Œæª¢æŸ¥ Lock çš„æœ‰æ•ˆæ™‚é–“ï¼Œä¸¦ä¸”åªæœ‰åœ¨å–å¾—å¤šæ•¸ Redis Server åŒæ„æ‰å¾€ä¸‹ç¹¼çºŒ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Add 2 milliseconds to the drift to account for Redis expires precision, which is 1 ms,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// plus the configured allowable drift factor
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">drift&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">driftFactor&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">ttl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resource&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">start&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">ttl&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">drift&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">attempts&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// SUCCESS: there is concensus and the lock is not expired
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">votes&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="nx">quorum&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">lock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">expiration&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nb">Date&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸»è¦é—œéµæ˜¯é€™å¹¾å€‹éƒ¨åˆ†ï¼Œå…¶é¤˜çš„å°±æ˜¯å°è£&lt;/p>
&lt;h2 id="martin-kleppmann-çš„è³ªç–‘">Martin Kleppmann çš„è³ªç–‘&lt;/h2>
&lt;h4 id="ä¸­æ–·å°è‡´-lock-æœ‰æ•ˆåˆ¤æ–·éŒ¯èª¤">ä¸­æ–·å°è‡´ Lock æœ‰æ•ˆåˆ¤æ–·éŒ¯èª¤&lt;/h4>
&lt;p>åœ¨åˆ†æ•£å¼ç³»çµ±è¨­è¨ˆä¸­ï¼Œæ™‚é–“æ˜¯ä¸€å€‹éå¸¸é›£ä»¥æŒæ¡çš„å› ç´ ï¼Œç¨‹åºå¯èƒ½å› ç‚ºå„ç¨®ç‹€æ³è€Œå°è‡´æ™‚é–“åºéŒ¯äº‚ï¼Œä¾‹å¦‚èªªç³»çµ±æ™‚é–“ä¸æº–ã€ç¶²è·¯å»¶é²ã€ç¨‹å¼é‹ä½œé‡åˆ°åƒåœ¾å›æ”¶ã€ä½œæ¥­ç³»çµ±åˆ‡æ› Process å°è‡´ä¸­æ–·ç­‰ï¼Œæ‰€ä»¥å„ç¨®æª¢æŸ¥æ©Ÿåˆ¶éƒ½æœ‰å¯èƒ½å› è€Œå‡ºç¾éŒ¯èª¤ï¼Œä¾‹å¦‚ä»¥ä¸‹çš„ä¾‹å­
&lt;img src="https://yuanchieh.page/post/img/unsafe-lock.png"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>Client1 å–å¾— Lock å¾Œ&lt;/li>
&lt;li>çµæœé‡åˆ° GC æš«åœé‹ä½œ&lt;/li>
&lt;li>Lock è¶…é TTL è‡ªå‹•é‡‹æ”¾ï¼Œæ­¤æ™‚&lt;/li>
&lt;li>Client2 æˆåŠŸå–å¾— Lockï¼Œä¸¦æ›´æ–° DB ç´€éŒ„&lt;/li>
&lt;li>æ¥è‘— Client å¾ GC ä¸­æ¢å¾©ï¼Œä»–ä»¥ç‚ºè‡ªå·±æ‰‹ä¸Šæœ‰ Lock å¯ä»¥å»æ›´æ–° DB&lt;/li>
&lt;/ol>
&lt;p>é€™æ¨£å°±é•åäº† Lock çš„å®‰å…¨æ€§åŸå‰‡&lt;/p>
&lt;p>ç›´è¦ºè§£æ³•æ˜¯åœ¨æ›´æ–° DB ä¹‹å‰ Client å†å»æª¢æŸ¥ Lock çš„æ™‚æ•ˆæ€§ï¼Œä½† GC å¯èƒ½å¡åœ¨æª¢æŸ¥å®Œä¹‹å¾Œçš„é‚£ä¸€å€‹é»ï¼Œæ‰€ä»¥è¨­å®šå†å¤šæª¢æŸ¥éƒ½æ˜¯æ²’ç”¨çš„&lt;/p>
&lt;p>å¯¦éš›è§£æ³•ä¹Ÿè »ç›´è¦ºçš„ï¼Œç³»çµ±å…¨åŸŸæœ‰å€‹ä¸æ–·éå¢çš„ç™¼è™Ÿæ©Ÿåˆ¶ï¼Œæ¯å–ä¸€æ¬¡ Lock å°±é…ä¸€å€‹æ•¸å­—ï¼Œåœ¨ DB æ›´æ–°çš„æ™‚å€™ï¼Œæª¢æŸ¥å°æ‡‰çš„æ•¸å­—æ˜¯ä¸æ˜¯æœ‰å¤§æ–¼ä¸Šæ¬¡æ›´æ–°çš„æ•¸å­—ï¼Œå°±å¯ä»¥é¿å…æ‰ä¸Šè¿°æåˆ°çš„å•é¡Œï¼Œå°±æ˜¯ &lt;code>Fencing æ©Ÿåˆ¶&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/fencing-tokens.jpeg"
loading="lazy"
>&lt;/p>
&lt;h3 id="å¤ªå¿«æ¨‚è§€é ä¼°æ™‚é–“çš„è¤‡é›œæ€§">å¤ªå¿«æ¨‚è§€é ä¼°æ™‚é–“çš„è¤‡é›œæ€§&lt;/h3>
&lt;p>TTL çš„ã€Œæ™‚é–“ã€è¨ˆç®—æœ‰å¯¦ä½œå•é¡Œï¼ŒRedis ç›®å‰ä½¿ç”¨ &lt;code>gettimeofday&lt;/code> è€Œé &lt;code>monotonic clock&lt;/code> çš„æ™‚é–“&lt;br>
å‰è€…æ˜¯ç³»çµ±æ™‚é–“ï¼Œé€™æ˜¯å¯ä»¥è¢«èª¿å‹•ï¼Œä¾‹å¦‚ NTP Server åŒæ­¥ / Admin æ‰‹å‹•èª¿æ•´ç­‰ï¼Œæ‰€ä»¥æ™‚é–“å¯èƒ½å¤§å¹…åº¦å‰å¾Œè·³å‹•&lt;br>
è€Œå¾Œè€…æ˜¯æ¯ç•¶ timmer ç™¼å‡º interrupt å°± &lt;code>æŒçºŒéå¢æ°¸ä¸å›é ­&lt;/code>ï¼Œæ‰€ä»¥åœ¨åˆ¤æ–·å…©å€‹é»çš„çµ•å°æ™‚é–“å·®ç”¨å¾Œè€…æœƒæ¯”è¼ƒç²¾æº–&lt;/p>
&lt;p>è©¦æƒ³å¦‚æœ Client1 å–å¾— Lock å¾Œ Redis æ™‚é–“è·³è½‰ç«‹åˆ» Lock å¤±æ•ˆï¼Œçµæœ Client2 åˆå¯ä»¥æ‹¿åˆ° Lockï¼Œå°±æœƒé•åå®‰å…¨æ€§åŸå‰‡&lt;/p>
&lt;p>æ­¤å¤– Martin Kleppmann èªç‚º Redlock &lt;code>é è¨­å¤ªå¤šæ™‚é–“å› ç´ æ˜¯å¯é æœŸçš„&lt;/code>ï¼Œåƒæ˜¯ç¶²è·¯å»¶é²ã€æ™‚é˜åç§»ç­‰å•é¡Œï¼Œä½†é€™ä¸æ˜¯åˆ†æ•£å¼æ¼”ç®—æ³•æ­£ç¢ºçš„è¨­è¨ˆæ–¹å¼ï¼Œæ‰€ä»¥ Redlock çš„å®‰å…¨æ€§æ˜¯å»ºç«‹åœ¨åŠåŒæ­¥ç³»çµ±ç•¶ä¸­(æ„å³å„ç¨®æ™‚é–“å› ç´ æ˜¯æœ‰ä¸Šé™ä¸”å¯ä»¥è¢«å‡è¨­çš„)ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„åˆ†æ•£å¼è¨­è¨ˆ&lt;/p>
&lt;h2 id="antirez-å†æ¬¡å›å¾©">antirez å†æ¬¡å›å¾©&lt;/h2>
&lt;p>ä»¥ä¸Šå…©é»ä¸»è¦æ˜¯è¢«è³ªç–‘çš„éƒ¨åˆ†ï¼Œæ¥è‘—çœ‹ antirez å›è¦†&lt;/p>
&lt;h3 id="ç•¶è‡ªå‹•é‡‹æ”¾æ©Ÿåˆ¶å°è‡´-lock-çš„-mutual-exlusive-æ©Ÿåˆ¶å¤±æ•ˆæ™‚">ç•¶è‡ªå‹•é‡‹æ”¾æ©Ÿåˆ¶å°è‡´ Lock çš„ Mutual Exlusive æ©Ÿåˆ¶å¤±æ•ˆæ™‚&lt;/h3>
&lt;p>åœ¨ Martin ç¬¬ä¸€é»è³ªç–‘ä¸­ï¼Œä»–è¦ºå¾—è¦åŠ ä¸Šéå¢çš„ Token ç•¶ä½œä¿è­·æ©Ÿåˆ¶ï¼Œé¿å… Client æ‰‹ä¸Š Token éæœŸé‚„å»æ›´æ–° Resourceï¼Œé”åˆ°&lt;code>å¼·ä¿è­‰æ€§&lt;/code>&lt;/p>
&lt;p>è®“æˆ‘å€‘å…ˆå›éé ­ä¾†æƒ³ç‚ºä»€éº¼æˆ‘å€‘æœƒéœ€è¦åˆ†æ•£å¼ Lockï¼Œæ­£æ˜¯å› ç‚ºæˆ‘å€‘çš„é—œéµè³‡æºæœ¬èº«æ²’è¾¦æ³•ä¸€æ¬¡åªæœå‹™ä¸€å€‹è«‹æ±‚ (&lt;code>linearizable&lt;/code>)ï¼Œå¦‚æˆ‘è‡ªèº«æ¡ˆä¾‹æ˜¯ API Server åŒæ™‚æœ‰å¤šå°&lt;/p>
&lt;p>è€Œ Martin æå‡ºçš„ç³»çµ±å…¨åŸŸæœ‰å€‹éå¢ Tokenï¼Œé—œéµè³‡æºåœ¨æ“ä½œæ™‚æœƒå…ˆå»æª¢æŸ¥ Tokenï¼Œé€™æœ¬èº«å°±æ˜¯å€‹ linearizable storeï¼Œè®“æ‰€ä»¥çš„æ“ä½œä¸å†ä½µç™¼è€Œè®Šæˆç·šæ€§é€ä¸€è™•ç†ï¼Œé€™æœ¬èº«å°±èˆ‡åˆ†æ•£å¼çš„ç¾æ³çŸ›ç›¾&lt;/p>
&lt;p>å†è€…å¦‚æœæœ‰å€‹éå¢ Token ç³»çµ±ï¼Œé‚£ Redlock åœ¨ç”¢ç”Ÿ Lock çš„ Value æ™‚ï¼Œç”¨é€™å€‹éå¢ Token å–ä»£åŸæœ¬çš„éš¨æ©Ÿå­—ä¸²ä¹Ÿæœ‰ä¸€æ¨£çš„æ•ˆæœ&lt;/p>
&lt;p>åˆæˆ–æ˜¯æ ¹æœ¬ä¸éœ€è¦éå¢å‡½æ•¸ï¼Œåªè¦æŠŠéš¨æ©Ÿå­—ä¸²ä¹Ÿè¨˜éŒ„åˆ°é—œéµè³‡æºä¸Šï¼Œåœ¨æ“ä½œæ™‚å»æ¯”å°å…ˆå¾Œå…©è€…æ˜¯å¦ç›¸åŒï¼ŒåŒæ¨£æœ‰ Fencing çš„æ•ˆæœ&lt;/p>
&lt;h3 id="åŸºæ–¼æ™‚é–“çš„éå¤šç†æƒ³åŒ–å‡è¨­">åŸºæ–¼æ™‚é–“çš„éå¤šç†æƒ³åŒ–å‡è¨­&lt;/h3>
&lt;p>ä½œè€…æ‰¿èª Redis æ‡‰è©²æ”¹ç”¨ monotonic timeï¼Œä½†æ˜¯çœ‹ä¾†é‚„æ²’æœ‰å€‹çµè«–æ˜¯å¦è¦ä¿®æ­£ &lt;a class="link" href="https://github.com/antirez/redis/issues/416" target="_blank" rel="noopener"
>Redis Repo - (#416) Use monotonic clock when available&lt;/a>ï¼Œä¸»è¦å•é¡Œåœ¨æ–¼ä¸¦éæ‰€æœ‰ç³»çµ±éƒ½æ”¯æ´ monotonic time API&lt;/p>
&lt;p>é—œæ–¼æ™‚é–“è·³å‹•çš„å•é¡Œï¼Œä½œè€…ä¸¦æ²’æœ‰çµ¦å‡ºå¾ˆæ˜ç¢ºçš„ç­”æ¡ˆï¼Œä½†çœ‹ä¾†åªèƒ½ç›¡é‡é¿å…(ä¾‹å¦‚ Admin ä¸è¦æ”¹å‹•ç³»çµ±æ™‚é–“)è€Œä¸æ˜¯å¾æ¼”ç®—æ³•çš„éƒ¨åˆ†æ”¹é€²ï¼Œå› ç‚ºç›®å‰ Redis é‚„ä¸æ˜¯ç”¨ monotonic time API&lt;/p>
&lt;p>æ¥è‘—è€ƒé‡ä¸€å€‹æƒ…æ³&lt;/p>
&lt;ol>
&lt;li>å–å¾—ç•¶å‰æ™‚é–“&lt;/li>
&lt;li>å–å¾— Lock&lt;/li>
&lt;li>è¨ˆç®—ç•¶å‰æ™‚é–“&lt;/li>
&lt;li>æª¢æŸ¥ Lock æ˜¯å¦é‚„åœ¨æœ‰æ•ˆæœŸé–“&lt;/li>
&lt;li>å¦‚æœæœ‰ Lockï¼Œå‰‡ç¹¼çºŒè™•ç†&lt;/li>
&lt;/ol>
&lt;p>åœ¨æ­¥é©Ÿä¸€åˆ°ä¸‰ï¼Œä¸è«–æ˜¯ç¶²è·¯å»¶é²ã€ç¨‹åºä¸­æ–·ç­‰æ™‚é–“å•é¡Œï¼Œéƒ½æ²’æœ‰é—œä¿‚ï¼Œå› ç‚ºæ­¥é©Ÿå››æœƒå†æ¬¡æª¢æŸ¥ Lock&lt;/p>
&lt;p>ä½†å¦‚æœæ˜¯åœ¨ç¬¬å››æ­¥åˆ°ç¬¬äº”æ­¥ä¹‹é–“ï¼Œé€™æ™‚å€™&lt;code>æ²’æœ‰ä»»ä½•æœ‰è‡ªå‹•é‡‹æ”¾æ©Ÿåˆ¶çš„åˆ†æ•£å¼ Lock&lt;/code> å¯ä»¥ä¿è­‰ Mutual Exclusiveï¼Œåªèƒ½é é—œéµè³‡æºæœ¬èº«çš„æ©Ÿåˆ¶ï¼Œé€™å°±å›åˆ°ä¸Šä¸€æ­¥èªªçš„ Fencing æ©Ÿåˆ¶ï¼Œä¾‹å¦‚èªª DB å°±å¯«å…¥éå¢ Token æˆ–éš¨æ©Ÿå­—ä¸²ï¼Œè®“å¾Œè€…ä¸èƒ½æ›´æ–°&lt;/p>
&lt;blockquote>
&lt;p>æ‰€ä»¥ Redlock å®‰å…¨å—ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>ç­”æ¡ˆå–æ±ºæ–¼å°æ–¼å®‰å…¨çš„è¦æ±‚æœ‰å¤šé«˜ï¼Œ&lt;/p>
&lt;ol>
&lt;li>é…ç½®å¤šå° Redis Server ä¸¦é–‹å•Ÿ fsync = always çš„ Redlock æ©Ÿåˆ¶&lt;/li>
&lt;li>åœ¨ç³»çµ±æ™‚é–“æ²’æœ‰å¤§å¹…åº¦è·³å‹•çš„æƒ…æ³ä¸‹&lt;/li>
&lt;li>Lock TTL ä¿è­‰å¤§æ–¼é—œéµè³‡æºçš„é‹è¡Œæ™‚é–“æˆ–æ˜¯åœ¨é—œéµè³‡æºè™•æœ‰ fencing æ©Ÿåˆ¶&lt;/li>
&lt;/ol>
&lt;p>ç¬¦åˆé€™ä¸‰é» Redlock å°±æ˜¯å®‰å…¨çš„&lt;br>
æ­£å› ç‚ºæˆ‘å€‘æ²’æœ‰å…¶ä»–æ–¹æ³•é¿å… Race Conditionï¼Œæ‰æœƒæ¡ç”¨ Redlock æˆ–æ˜¯å…¶ä»–æ¨‚è§€é–çš„è™•ç†æ©Ÿåˆ¶&lt;/p></description></item><item><title>Webassembly æ•™å­¸ - åŸºæœ¬é‹ç®—ã€é™£åˆ—è™•ç†èˆ‡æŒ‡é‡</title><link>https://yuanchieh.page/posts/2020/2020-01-01-webassembly-%E6%95%99%E5%AD%B8-%E5%9F%BA%E6%9C%AC%E9%81%8B%E7%AE%97%E9%99%A3%E5%88%97%E8%99%95%E7%90%86%E8%88%87%E6%8C%87%E9%87%9D/</link><pubDate>Wed, 01 Jan 2020 05:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2020/2020-01-01-webassembly-%E6%95%99%E5%AD%B8-%E5%9F%BA%E6%9C%AC%E9%81%8B%E7%AE%97%E9%99%A3%E5%88%97%E8%99%95%E7%90%86%E8%88%87%E6%8C%87%E9%87%9D/</guid><description>&lt;p>è¿‘æ—¥å› ç‚ºå…¬å¸å°ˆæ¡ˆï¼Œè¦æŠŠä¹‹å‰å¯«å¥½è™•ç†åœ–ç‰‡çš„ C++ code æ¬ç§»è‡³ç¶²é ä¸Šï¼Œè¶æ©Ÿæœƒæ¢ç´¢ Web Assemblyï¼Œæœªä¾†å¯ä»¥æŒçºŒç§»æ¤ç¾æœ‰çš„ C/C++ Libraryï¼Œå¢åŠ ç¨‹å¼çš„å¾©ç”¨æ€§èˆ‡å‰ç«¯çš„é–‹ç™¼è‡ªç”±åº¦&lt;/p>
&lt;p>Webassembly å…¶å¯¦ä¹Ÿä¸æ˜¯ä»€éº¼æ–°æŠ€è¡“äº†ï¼Œåœ¨ 2017 å¹´å·²ç¶“æ­£å¼æ¨å‡ºï¼Œä¸¦åœ¨&lt;code>å››å¤§ç€è¦½å™¨&lt;/code>éƒ½èƒ½å¤ ä½¿ç”¨ï¼ŒNodejs ä¹Ÿæ”¯æ´ï¼Œä½†ç¶²è·¯ä¸Šç›¸å°çš„ä¸­æ–‡è¼ƒå°‘ï¼Œä¾‹å¦‚è¨˜æ†¶é«”æ“ä½œã€pass by reference ç­‰ç­‰è¼ƒå°‘æåŠï¼Œé€™ä¹Ÿæ˜¯è®“æˆ‘é ­ç–¼è¨±ä¹…çš„åœ°æ–¹ï¼ŒèŠ±äº†å…©å¤©ä¸æ–·è©¦éŒ¯ï¼Œè¶è·¨å¹´å‡æœŸæ•´ç†ä¸¦åˆ†äº«&lt;/p>
&lt;p>ä»¥ä¸‹å…©å¤©æ˜¯ä¸»è¦åƒè€ƒçš„æ–‡ç« &lt;br>
&lt;a class="link" href="https://hacks.mozilla.org/2017/07/creating-a-webassembly-module-instance-with-javascript/" target="_blank" rel="noopener"
>Creating a WebAssembly module instance with JavaScript&lt;/a>&lt;br>
&lt;a class="link" href="https://developers.google.com/web/updates/2018/03/emscripting-a-c-library" target="_blank" rel="noopener"
>Emscripting a C library to Wasm
&lt;/a>&lt;br>
&lt;a class="link" href="https://becominghuman.ai/passing-and-returning-webassembly-array-parameters-a0f572c65d97" target="_blank" rel="noopener"
>Passing and returning WebAssembly array parameters
&lt;/a>&lt;/p>
&lt;p>Webassembly(Wasm) ä¸»è¦ç›®çš„æ˜¯å°‡å…¶ä»–èªè¨€é€éç·¨è­¯æ–¹å¼è¼¸å‡ºç€è¦½å™¨å¯ä»¥é‹ä½œçš„ bytecodeï¼Œç›®å‰é™¤äº† C/C++ å¤–ï¼ŒRust ä¹Ÿæ˜¯å€‹ç†±é–€çš„ Wasm é–‹ç™¼èªè¨€ï¼Œå‘¨åœçš„ç”Ÿæ…‹ç³»èˆ‡å·¥å…·éˆéƒ½ç›¸å°å®Œå–„ï¼›&lt;/p>
&lt;p>ä»¥ä¸‹çš„æ•™å­¸ä¸»è¦å°ˆæ³¨æ–¼ä½¿ç”¨ &lt;code>Emscripten&lt;/code>ï¼ŒEmscripten åŠŸç”¨æ˜¯å°‡ C/C++ ç·¨è­¯æˆ Wasmï¼Œé™¤æ­¤ä¹‹å¤–æä¾› JS å«æ¥åˆ° Wasm é€™ç«¯çš„è™•ç†(è† æ°´ç¨‹å¼)ï¼Œä¾‹å¦‚èªª malloc / free / printf / cout ç­‰ç­‰ C/C++ çš„æ¨™æº–å‡½å¼åº«æ”¯æ´çš„å‡½å¼ï¼Œ&lt;code>ç›®å‰ Wasm ä¸èƒ½ç›´æ¥ Accessï¼Œåªèƒ½é€é JS å»æ“ä½œ WebAPI&lt;/code>ï¼Œé€™äº›éƒ½å¿…é ˆåœ¨ç·¨è­¯æ™‚è¢«ç´å…¥å¯¦ä½œï¼Œæ­¤å¤– Wasm ç›®å‰é‚„ä¸èƒ½åƒä¸€èˆ¬çš„ JS Library ç›´æ¥ include å°±èƒ½ä½¿ç”¨ï¼Œè€Œæ˜¯è¦è™•ç† Memory Mapping ç­‰ï¼Œé€™äº› Emscripten éƒ½æœƒè™•ç†å¥½&lt;/p>
&lt;p>ä¸»è¦æ•™å­¸é …ç›®æœ‰&lt;/p>
&lt;ol>
&lt;li>ä½¿ç”¨ Emscripten ç”¢ç”Ÿç¯„ä¾‹ code&lt;/li>
&lt;li>ç§»æ¤ä¹˜æ³•é‹ç®— C++ Code&lt;/li>
&lt;li>è¨˜æ†¶é«”æ“ä½œï¼Œé—œæ–¼ Pointer &amp;amp; Array&lt;/li>
&lt;li>Wasm ç¸½çµ&lt;/li>
&lt;/ol>
&lt;h2 id="ä½¿ç”¨-emscripten-ç”¢ç”Ÿç¯„ä¾‹-code">ä½¿ç”¨ Emscripten ç”¢ç”Ÿç¯„ä¾‹ code&lt;/h2>
&lt;h3 id="å®‰è£-emscripten">å®‰è£ Emscripten&lt;/h3>
&lt;p>&lt;a class="link" href="https://emscripten.org/docs/getting_started/downloads.html" target="_blank" rel="noopener"
>Emscripten å®˜æ–¹å®‰è£æ­¥é©Ÿ&lt;/a>ï¼ŒæŒ‰ç…§æ­¥é©Ÿå®‰è£æœ€æ–°ç‰ˆçš„ Emscriptenï¼Œç¢ºèªå®‰è£å®Œæˆ&lt;/p>
&lt;blockquote>
&lt;p>emcc &amp;ndash;version&lt;/p>
&lt;/blockquote>
&lt;h3 id="å®˜æ–¹åŸºç¤æ•™å­¸-hello-world">å®˜æ–¹åŸºç¤æ•™å­¸ Hello World&lt;/h3>
&lt;p>ä»¥ä¸‹åƒè€ƒ &lt;a class="link" href="https://emscripten.org/docs/getting_started/Tutorial.html" target="_blank" rel="noopener"
>å®˜æ–¹åŸºç¤æ•™å­¸ Hello World&lt;/a>ï¼Œä¸¦ç¿»è­¯(è§£é‡‹)æ¯å€‹æ­¥é©Ÿ&lt;/p>
&lt;h4 id="ç”¢ç”Ÿ-hello_worldc">ç”¢ç”Ÿ hello_world.c&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Copyright 2011 The Emscripten Authors. All rights reserved.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Emscripten is available under two separate licenses, the MIT license and the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * University of Illinois/NCSA Open Source License. Both these licenses can be
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * found in the LICENSE file.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello, world!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸ·è¡Œ&lt;/p>
&lt;blockquote>
&lt;p>$ emcc build/hello_world.c -o hello_world.html&lt;/p>
&lt;/blockquote>
&lt;p>æ­¤æ™‚æœƒè¼¸å‡ºä¸‰å€‹æª”æ¡ˆï¼Œ&lt;code>hello_world.htmlã€hello_world.out.jsã€hello_world.wasm&lt;/code>&lt;/p>
&lt;p>&lt;code>-o&lt;/code> æŒ‡å®šè¼¸å‡ºçš„æª”æ¡ˆèˆ‡æª”åï¼Œå¦‚æœæ²’æœ‰æŒ‡å®šæœƒè¼¸å‡º &lt;code>a.out.jsã€a.wasm&lt;/code>ï¼›&lt;/p>
&lt;ul>
&lt;li>.html æª”æ˜¯ Emscripten æ–¹ä¾¿é–‹ç™¼è€…é™¤éŒ¯ç”¨çš„ç¶²é ï¼›&lt;/li>
&lt;li>.wasm æª”å³æ˜¯ binary æ ¼å¼çš„ assembly codeï¼Œäººé¡ç„¡æ³•é–±è®€ï¼›&lt;/li>
&lt;li>.js æª”æ˜¯å¾ŒçºŒèˆ‡ JS æ•´åˆæœƒéœ€è¦ç”¨åˆ°çš„æª”æ¡ˆï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ NodeJS åŸ·è¡Œ&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>$ node hell_world.out.js&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>-o&lt;/code> å¦‚æœæœ‰æŒ‡å®š &lt;code>{file_name}.html&lt;/code>ï¼Œå‰‡æœƒç”Ÿæˆé…åˆçš„å‰ç«¯é é¢ï¼Œé¡¯ç¤º main function çš„åŸ·è¡Œçµæœ&lt;/p>
&lt;p>æœ‰äº† html æª”ï¼Œå¯ä»¥ä½¿ç”¨ http server ç”¨ç€è¦½å™¨é–‹å•Ÿç¶²é ï¼Œä¾‹å¦‚ npm å¥—ä»¶ &lt;code>http-server&lt;/code>ï¼Œåœ¨æœ¬åœ°ç«¯é–‹å•Ÿé é¢æŸ¥çœ‹çµæœ&lt;/p>
&lt;p>C++ çš„ code é›·åŒ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;hello, world!&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ä¹˜æ³•é‹ç®—ä¸¦ç§»æ¤åˆ°ç¶²é ä¸Š">ä¹˜æ³•é‹ç®—ä¸¦ç§»æ¤åˆ°ç¶²é ä¸Š&lt;/h2>
&lt;p>ä¸Šè¿°çš„ hello_world ä¸»è¦æ˜¯æª¢æ¸¬ç’°å¢ƒèˆ‡å·¥å…·éŠæ˜¯å¦æ­£å¸¸ï¼Œæ¥è‘—é–‹å§‹æš–èº«ï¼Œç”¨ C++ å¯«ä¸€å€‹ç°¡å–®çš„æ•´æ•¸ä¹˜æ³•é‹ç®—ï¼Œè¼¸å…¥å…©å€‹æ•´æ•¸ï¼Œå›å‚³å…©æ•´æ•¸ç›¸ä¹˜çš„çµæœï¼Œ&lt;code>è‘—é‡æ–¼å¦‚ä½•å°‡ Wasm æ•´åˆé€²å‰ç«¯ä¸­&lt;/code>&lt;/p>
&lt;h3 id="ç”¢ç”Ÿ-multiplycpp">ç”¢ç”Ÿ multiply.cpp&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;emscripten/emscripten.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">extern&lt;/span> &lt;span class="s">&amp;#34;C&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">EMSCRIPTEN_KEEPALIVE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">multiply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">num1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">num2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">num1&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">num2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">multiply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é è¨­ Emscripten ç”¢ç”Ÿçš„ .js åªæœƒåŸ·è¡Œ main functionï¼Œå¦‚æœæƒ³è¦å‘¼å«å…¶ä»–éŸ“å¼å¿…é ˆåœ¨æ¬²è¼¸å‡º function å‰åŠ ä¸Š &lt;code>EMSCRIPTEN_KEEPALIVE&lt;/code>ï¼Œåœ¨ Comile æ™‚æŒ‡å®šåƒæ•¸ &lt;code>-s NO_EXIT_RUNTIME=1&lt;/code> é¿å… wasm åŸ·è¡Œ main function å¾Œç›´æ¥é€€å‡º&lt;/p>
&lt;p>å¦å¤–å¦‚æœæ˜¯ä½¿ç”¨ C++ è€Œä¸æ˜¯ Cï¼Œå»ºè­°åœ¨è¦è¼¸å‡ºçš„ function å‰åŠ ä¸Š &lt;code>extern &amp;quot;C&amp;quot;&lt;/code>ï¼Œä¸»è¦æ˜¯æŒ‡å®šé€™ä¸€æ®µç¨‹å¼ç¢¼ç”¨ C çš„æ–¹å¼ç·¨è­¯ï¼Œé€™æ¨£è¼¸å‡ºçš„ function åç¨±æœƒä¿æŒåŸç‹€ï¼Œå¯ä»¥è©¦è‘—æ‹¿æ‰çœ‹çœ‹&lt;/p>
&lt;blockquote>
&lt;p>$ emcc build/multiply.cpp -s NO_EXIT_RUNTIME=1 -o multiply.js&lt;/p>
&lt;/blockquote>
&lt;p>æ­¤æ™‚æœƒè¼¸å‡º &lt;code>multiply.js &amp;amp; multiply.wasm&lt;/code>&lt;/p>
&lt;p>å¦‚æœä¸ç¢ºå®š compiled å‡ºä¾†çš„æª”æ¡ˆèƒ½ä¸èƒ½é‹è¡Œï¼Œå»ºè­°å…ˆ &lt;code>-o {filename}.html&lt;/code> ç¢ºèªå¯ä»¥é‹ä½œï¼Œæ¥è‘—å†è€ƒæ…®ç§»æ¤&lt;/p>
&lt;h3 id="åœ¨ç¶²é ä½¿ç”¨-multiplyoutjs">åœ¨ç¶²é ä½¿ç”¨ multiply.out.js&lt;/h3>
&lt;p>ç¨ç«‹ç”¢ç”Ÿ index.html&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span> &lt;span class="na">lang&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;en&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">charset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;UTF-8&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;viewport&amp;#34;&lt;/span> &lt;span class="na">content&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;width=device-width, initial-scale=1.0&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">http-equiv&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;X-UA-Compatible&amp;#34;&lt;/span> &lt;span class="na">content&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;ie=edge&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Document&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;./multiply.js&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onRuntimeInitialized&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Module&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_main&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_multiply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> è«‹æ‰“é–‹ Console
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶æˆ‘å€‘æ‰“é–‹ Consoleï¼Œå¯ä»¥çœ‹åˆ° &lt;code>10&lt;/code>ï¼Œä»¥åŠ &lt;code>Module&lt;/code> é€™å€‹ç”± &lt;code>multiply.js&lt;/code> export çš„ Objectï¼Œç•¶æˆ‘å€‘æƒ³è¦ä½¿ç”¨ Module ç•¶ä¸­çš„åƒæ•¸ï¼Œéœ€è¦åŒ…åœ¨ &lt;code>onRuntimeInitialized&lt;/code> listener ç•¶ä¸­ï¼Œç­‰ Module åˆå§‹åŒ–å®Œæˆæ‰èƒ½èª¿ç”¨ï¼ŒModule è£¡é ­åŒ…å«éå¸¸å¤šçš„åƒæ•¸èˆ‡ functionï¼Œå¾ŒçºŒæœƒå†ä»‹ç´¹&lt;/p>
&lt;p>è€Œæˆ‘å€‘è¼¸å‡ºçš„ function æœƒä¸»å‹•è¢«åŠ ä¸Š &lt;code>_&lt;/code> å‰ç¶´ï¼Œå¦‚æœè¦å‚³å…¥ int ç›´æ¥ç”¨ JS çš„ number å°±å¯ä»¥äº†&lt;/p>
&lt;p>ç”šè‡³å¦‚æœç”¨ &lt;code>Module._multiply(2, &amp;quot;10&amp;quot;)&lt;/code> éƒ½æœƒæˆåŠŸè¼¸å‡º 20ï¼Œå‚³å…¥åƒæ•¸æ™‚æœƒè‡ªå‹•åšå‹åˆ¥è½‰æ›ï¼Œå¦‚æœè¼¸å…¥ç´”å­—ä¸²å‰‡æœƒå›å‚³ 0&lt;/p>
&lt;h2 id="è¨˜æ†¶é«”æ“ä½œé—œæ–¼-pointer--array">è¨˜æ†¶é«”æ“ä½œï¼Œé—œæ–¼ Pointer &amp;amp; Array&lt;/h2>
&lt;p>åœ¨ C/C++ ä¸­ï¼Œpointer å¾ˆå¸¸è¢«ç›´æ¥ç•¶ä½œåƒæ•¸å‚³éï¼Œè®“ sub function ç›´æ¥æ“ä½œ pointer æŒ‡å‘çš„è¨˜æ†¶é«”ä½ç½®ï¼Œfunction return å¾ŒåŸ function å¯ä»¥ç›´æ¥å–å€¼å‡ºä¾†ç”¨&lt;/p>
&lt;p>ç›®æ¨™æ˜¯å¯¦ä½œä¸€å€‹ filter function biggerThanï¼Œåªæœ‰å¤§æ–¼ target çš„ element æœƒè¢«å¡é€² array_pointer æŒ‡å‘çš„è¨˜æ†¶é«”ä½ç½®ï¼Œsize æŒ‡å‘æœ€å¾Œçš„ array length&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç›®æ¨™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">biggerThan&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">elements&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">array_pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;emscripten/emscripten.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">extern&lt;/span> &lt;span class="s">&amp;#34;C&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">EMSCRIPTEN_KEEPALIVE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="nf">biggerThan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">elementList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">elementListLength&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">elementListLength&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">result&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">elementListLength&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">elementList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">target&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">elementList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;size mem position:&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">result mem position:&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>$ emcc build/bigger_than.cpp -O1 -s NO_EXIT_RUNTIME=1 -o bigger_than.js&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>-O1&lt;/code> æ˜¯æŒ‡åè¦ compiler optimize è¼¸å‡ºçµæœï¼Œ-O1 æ˜¯åˆæ­¥å„ªåŒ–ï¼Œ-O2 / -O3 æ˜¯æ›´é€²éšè€—æ™‚çš„å„ªåŒ–ï¼Œä½†è¦å°å¿ƒå„ªåŒ–å¯èƒ½æœƒç§»é™¤éœ€è¦çš„åŠŸèƒ½&lt;/p>
&lt;p>æ¥è‘—æ˜¯ index.html&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span> &lt;span class="na">lang&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;en&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">charset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;UTF-8&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;viewport&amp;#34;&lt;/span> &lt;span class="na">content&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;width=device-width, initial-scale=1.0&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">http-equiv&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;X-UA-Compatible&amp;#34;&lt;/span> &lt;span class="na">content&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;ie=edge&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Document&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;./bigger_than.js&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onRuntimeInitialized&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">elementList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">elementListBuffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_malloc&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">elementList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">elementList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elementList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elementListBuffer&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">target&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">resultBuffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_malloc&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resultBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">sizeBuffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sizeBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="sb">`mem position:\nsizeBuffer: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">sizeBuffer&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> resultBuffer: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">resultBuffer&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_biggerThan&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">elementListBuffer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">elementList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">target&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resultBuffer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sizeBuffer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">sizeInMem&lt;/span> &lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">sizeBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">resultRef&lt;/span> &lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">resultBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">resultInMem&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sizeInMem&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resultBuffer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resultRef&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">resultRef&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">sizeInMem&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resultInMem&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">resultRef&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sizeInMem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resultInMem&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resultBuffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sizeBuffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elementListBuffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> è«‹æ‰“é–‹ Console
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="arraybuffer--typedarray">ArrayBuffer &amp;amp; TypedArray&lt;/h4>
&lt;p>åœ¨é–‹å§‹ä¹‹å‰ï¼Œå¿…é ˆå…ˆäº†è§£ JS å¦‚ä½•è™•ç† binary dataï¼Œåœ¨ JS ä¸­ binary data æ˜¯ä»¥ &lt;code>ArrayBuffer&lt;/code> è¡¨ç¤ºï¼ŒArrayBuffer åªèƒ½è®€ä¸èƒ½åšå…¶ä»–çš„æ“ä½œï¼Œåªèƒ½é€é &lt;code>TypedArray&lt;/code> èˆ‡ &lt;code>Dataview&lt;/code>è½‰æ›ï¼Œè€Œ Wasm ä¸­æœƒç”¨åˆ°çš„æ˜¯ TypedArray&lt;/p>
&lt;p>TypedArray æœ‰è¨±å¤šä¸åŒé•·åº¦çš„é¡å‹ï¼Œå¦‚ Int8Array / Int16Arrayï¼Œæ•¸å­—ä»£è¡¨æ¯å€‹ element çš„ bit é•·åº¦&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">ArrayBuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">i8&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int8Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">i8&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">i8&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">i16&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int16Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i16&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="c1">// 5220ï¼Œå› ç‚ºæ˜¯ 0x14 0x64
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœå…©å€‹ Type Array å¾åŒä¸€å€‹ ArrayBuffer ç”Ÿæˆï¼Œå‰‡å…©è€…æ”¹å‹•éƒ½æœƒäº’ç›¸å½±éŸ¿ï¼Œå¦‚æœé‡åˆ°ä¸åŒé¡å‹äº’è½‰ï¼Œå‰‡é«˜ä½åœ¨å¾Œä½ä½åœ¨å‰ï¼Œæ‰€ä»¥ &lt;code>i16[0] = i8[1] * 2^8 + i8[0]&lt;/code>
&lt;img src="https://media.prod.mdn.mozit.cloud/attachments/2014/09/16/8629/80522bcbdb9d77c4a4c72a289365ea63/typed_arrays.png"
loading="lazy"
>&lt;/p>
&lt;p>åœ¨ C/C++ä¸­ï¼Œæœ‰å¤šç¨®ä¸åŒé•·åº¦çš„å‹åˆ¥ï¼Œä¾‹å¦‚ char / int / float / double åŠ ä¸Š signed / unsigned ç­‰ï¼Œå°±æœƒä¸€ä¸€å°ç…§åˆ° JS çš„ Typed Array
&lt;img src="https://yuanchieh.page/post/img/typedarray.jpeg"
loading="lazy"
>&lt;/p>
&lt;h4 id="pass-array-by-pointer">Pass Array by pointer&lt;/h4>
&lt;p>ç•¶æˆ‘å€‘è¦è®“ C++ è®€å–é™£åˆ—ï¼Œæˆ‘å€‘ä¸èƒ½ç›´æ¥å‚³éé™£åˆ—ï¼Œè€Œæ˜¯å…ˆåœ¨ JS ä¸­æŠŠé™£åˆ—æ”¾é€² Memory &amp;ndash;&amp;gt; æ¥è‘—å‚³é Memory ä¸­çš„ä½å€ &amp;ndash;&amp;gt; å¾ Memory ä½å€è®€å–é™£åˆ—çš„å…ƒç´ &lt;/p>
&lt;p>åœ¨ Wasm ä¸­ï¼Œä¸€é–‹å§‹åˆå§‹åŒ–æœƒéœ€è¦ Memory Objectï¼Œè¡¨æ˜æ•´å€‹ Wasm èƒ½å¤ ä½¿ç”¨å¤šå¤§çš„è¨˜æ†¶é«”ï¼Œæ¥è‘—æŠŠè³‡æ–™æ”¾é€²è¨˜æ†¶é«”ç•¶ä¸­ï¼Œä¸¦å–å¾—å­˜æ”¾çš„ä½å€ï¼Œå°‡ä½å€å¾ JS å‚³éçµ¦ C++ï¼ŒC++ å»ç›¸å°æ‡‰çš„è¨˜æ†¶é«”ç©ºé–“å°‡å€¼å–å‡º&lt;/p>
&lt;p>Emscripten ç°¡åŒ–é€™å€‹éç¨‹ï¼Œæ”¹ç”¨ &lt;code>_malloc&lt;/code> å»å–å¾—è¨˜æ†¶é«”ç©ºé–“ï¼Œä¸¦ç”±å°æ‡‰é¡åˆ¥å¤§å°çš„ HEAP å¡å…¥ç©ºé–“ï¼Œæ­¤æ™‚æœƒæ‹¿åˆ°è¨˜æ†¶é«”ä½å€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">elementList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">elementListBuffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_malloc&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">elementList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">elementList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elementList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elementListBuffer&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ®µè©±çš„ç¿»è­¯æ˜¯&lt;/p>
&lt;ol>
&lt;li>ç”¢ç”Ÿ [1, 2, 3, 4, 5, 6] é™£åˆ—ï¼Œæ¯å€‹å…ƒç´ æ˜¯ 32 bits (4 bytes) å¤§ï¼Œå‰›å¥½å°æ‡‰ C++ çš„ int å¤§å°&lt;/li>
&lt;li>ç´¢å–è¨˜æ†¶é«”ç©ºé–“ï¼Œ_malloc éœ€æŒ‡å®šè¦å¤šå¤§çš„ bytes ç©ºé–“ï¼Œæ­¤ä¾‹éœ€è¦ 6 * 4 = 24 bytesï¼ŒelementListBuffer æ­¤æ™‚ä»£è¡¨é€™å¡Šè¨˜æ†¶é«”çš„èµ·å§‹ä½ç½®ï¼Œæ¯é–“éš” 4 å€‹ bytes å°±æ˜¯é™£åˆ—çš„ä¸‹ä¸€å€‹å…ƒç´ &lt;/li>
&lt;li>å› ç‚ºæ¯å€‹å…ƒç´ æ˜¯ 32 bitsï¼Œæ‰€ä»¥ç”¨ HEAP32 å¡è³‡æ–™ï¼Œé€™é‚Š elementListBuffer &amp;raquo; 2 æ˜¯å› ç‚ºæ¯å€‹å„²å­˜å–®ä½æ˜¯ 4 bytesï¼Œ &amp;raquo; 2 ä»£è¡¨ / 4&lt;br>
å¯ä»¥æƒ³åƒæ˜¯å¤§å°æŠ½å±œï¼ŒJS ä¸­æ“ä½œæœ€å°å–®ä½æ˜¯å–®ä¸€å€‹ byteï¼Œå¦‚æœæ˜¯ Int8Array å‰‡æ˜¯ä¸€å€‹æŠ½å±œå°æ‡‰ä¸€å€‹å–®ä½ï¼Œä½†å¦‚æœæ˜¯ Int32Arrayï¼Œå°±æ˜¯ä¸€å€‹æŠ½å±œå°æ‡‰å››å€‹å–®ä½ï¼Œæ‰€ä»¥ç·¨è™Ÿ(ä½å€)ä¹Ÿæœƒæ¯”å°æŠ½å±œå°‘å››åˆ†ä¹‹ä¸€&lt;/li>
&lt;/ol>
&lt;p>åœ¨ C++ ç•¶ä¸­ï¼Œè¦è¼ªè©¢ elementList é™£åˆ—çš„å€¼ï¼Œå°±åªè¦&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">elementListLength&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">elementList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="pointer">Pointer&lt;/h4>
&lt;p>åœ¨ Wasm ä¸­ï¼Œpointer æ˜¯ 32 bitsï¼Œæ‰€ä»¥é‡å° result / size éƒ½æ˜¯ç”¨ Int32Arrayï¼Œå³ä½¿ size æ˜¯æ•´æ•¸è€Œé&amp;quot;é™£åˆ—&amp;quot;ï¼Œä½†æ˜¯ä¸€æ¨£ç”¨ Int32Array å®£å‘Š&lt;/p>
&lt;p>å…ˆçœ‹ sizeï¼Œå®£å‘Šæ–¹å¼ç›¸åŒï¼Œæœ€å¾Œè¦å–å€¼æ™‚ï¼ŒåŒæ¨£æ˜¯å» Memory ä¸­çš„ä½ç½®æ‰¾ï¼Œè¨˜å¾—ä¸€æ¨£è¦åšä½å€åº§æ¨™çš„åˆ‡æ›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">sizeBuffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sizeBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å–å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">sizeInMem&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">sizeBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="pointer-of-pointer">Pointer of pointer&lt;/h5>
&lt;p>å†ä¾†æ˜¯æ¯”è¼ƒç‰¹åˆ¥çš„ resultï¼Œé€™å…¶å¯¦æ˜¯ä¸€å€‹ pointer of pointerï¼Œå…ˆçœ‹ C++ å¯¦ä½œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span>&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">elementListLength&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ JS å±¤æˆ‘ä¸¦æ²’æœ‰å…ˆå»ºç«‹æ•´å€‹é™£åˆ—ï¼Œè€Œæ˜¯åˆ°äº† C++ æ‰ç”¨ malloc æ–¹å¼å»ç´¢å–é™£åˆ—çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œæ­¤æ™‚æ–°å¢åŠ çš„è¨˜æ†¶é«”ç©ºé–“ JS ä¸¦ä¸çŸ¥é“åœ¨å“ªè£¡ï¼Œæ‰€ä»¥æˆ‘å¿…é ˆæƒ³è¾¦æ³•å›å‚³ï¼Œæ­¤æ™‚å¯ä»¥é€é return valueï¼Œæˆ‘é¸æ“‡ç›´æ¥ä¿®æ”¹ result çš„å€¼ï¼Œæš«å­˜è¨˜æ†¶é«”ä½å€ï¼Œå†ç”¨é€™å€‹ä½å€å»æ‰¾çœŸæ­£çš„é™£åˆ—æ‰€åœ¨è™•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">resultRef&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">resultBuffer&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">resultInMem&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sizeInMem&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">sizeInMem&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resultInMem&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HEAP32&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">resultRef&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">Int32Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BYTES_PER_ELEMENT&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å”¸èµ·ä¾†å¾ˆæ“¾å£ï¼Œä½†ä¹Ÿå°±æ˜¯å¤šä¸€æ¬¡çš„è¨˜æ†¶é«”ä½å€çš„è½‰æ›&lt;/p>
&lt;h4 id="free">free&lt;/h4>
&lt;p>æœ€å¾Œåˆ¥å¿˜äº†è¦é‡‹æ”¾ç´¢å–çš„è¨˜æ†¶é«”ï¼Œé¿å… Memory leak&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resultBuffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>WebAssembly è®“ç¶²é é–‹ç™¼çš„ã€Œéƒ¨åˆ†åŠŸèƒ½ã€å¯ä»¥å¤–åŒ…çµ¦çµ¦å…¶ä»–èªè¨€ï¼Œè®“ç¶²é é–‹ç™¼çš„ç–†åŸŸèˆ‡æŠ€è¡“æ›´åŠ çš„å½ˆæ€§èˆ‡å…¼å®¹ï¼Œç”šè‡³æœªä¾†å¯ä»¥æœ‰æ›´å¤šçš„è·¨èªè¨€å”ä½œçš„å¯èƒ½ï¼Œååˆ†ä»¤äººæœŸå¾…&lt;/p>
&lt;p>é€™ä¸€ç¯‡æ•™å­¸ä»‹ç´¹äº† Emscripten å·¥å…·ï¼Œèˆ‡ C/C++ ç·¨è­¯å‡ºçš„ Wasm å¦‚ä½•è·Ÿ JS äº’å‹•ï¼ŒåŒ…å«åŸºæœ¬çš„æ•´æ•¸é‹ç®—ã€é™£åˆ—æ“ä½œã€Pointer èˆ‡è¨˜æ†¶é«”å­˜å–&lt;/p>
&lt;p>ä¸‹ä¸€ç¯‡é è¨ˆä»‹ç´¹ä¸ä½¿ç”¨ Emscriptenï¼Œç›´æ¥ç”¨ Clang ç·¨è­¯ Wasmï¼Œé‚„åŸåˆ°æœ€ç°¡å–®åŸå§‹çš„ç‹€æ…‹å»èªè­˜ Wasm&lt;/p></description></item><item><title>[é–±è®€å¿ƒå¾—] ã€ŠåŸå­ç¿’æ…£ã€‹ç´°å¾®æ”¹è®Šå¸¶ä¾†å·¨å¤§æˆå°±çš„å¯¦è­‰æ³•å‰‡</title><link>https://yuanchieh.page/posts/2019/2019-12-14-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97-%E5%8E%9F%E5%AD%90%E7%BF%92%E6%85%A3%E7%B4%B0%E5%BE%AE%E6%94%B9%E8%AE%8A%E5%B8%B6%E4%BE%86%E5%B7%A8%E5%A4%A7%E6%88%90%E5%B0%B1%E7%9A%84%E5%AF%A6%E8%AD%89%E6%B3%95%E5%89%87/</link><pubDate>Sat, 14 Dec 2019 05:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-12-14-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97-%E5%8E%9F%E5%AD%90%E7%BF%92%E6%85%A3%E7%B4%B0%E5%BE%AE%E6%94%B9%E8%AE%8A%E5%B8%B6%E4%BE%86%E5%B7%A8%E5%A4%A7%E6%88%90%E5%B0%B1%E7%9A%84%E5%AF%A6%E8%AD%89%E6%B3%95%E5%89%87/</guid><description>&lt;p>&lt;img src="https://im1.book.com.tw/image/getImage?i=https://www.books.com.tw/img/001/082/25/0010822522.jpg&amp;amp;v=5cda990c&amp;amp;w=348&amp;amp;h=348"
loading="lazy"
>&lt;br>
&lt;a class="link" href="https://www.books.com.tw/products/0010822522" target="_blank" rel="noopener"
>åšå®¢ä¾†é€£çµ&lt;/a>&lt;/p>
&lt;h1 id="å‰è¨€">å‰è¨€&lt;/h1>
&lt;p>ã€ŠåŸå­ç¿’æ…£ã€‹æ˜¯æœ¬å¯¦è­‰çš„æ›¸ç±ï¼Œçœ‹å®Œè¦ºå¾—å¾ˆå—ç”¨ä¹Ÿæ„Ÿè§¸è‰¯å¤šï¼Œæ‰€ä»¥æœƒç”¨è¼ƒå¤šçš„è‡ªèº«ç¶“é©—å»æ‡‰è­‰èˆ‡å¯¦è¸æ›¸ä¸­å…§å®¹ï¼Œæ‰“å®Œå¿ƒå¾—å¾Œç™¼ç¾ç¯‡å¹…é æ¯”è‡ªå·±æƒ³åƒä¸­é•·ï¼Œä¹Ÿæ¯”è¼ƒå¤šå€‹äººçš„æ­·ç¨‹ (é˜²é›·å®£å‘Š)&lt;/p>
&lt;p>é€™å…©å€‹æœˆç”Ÿæ´»æœ‰äº›æ”¹è®Šï¼Œè·‘å®Œäººç”Ÿç¬¬ä¸€å ´å…¨é¦¬é¦¬æ‹‰æ¾(ä¹Ÿæ˜¯äººç”Ÿç¬¬ä¸€å ´é¦¬æ‹‰æ¾)ã€éƒ¨è½æ ¼å¾ Medium ç§»å‡ºè‡³ Hugo è‡ªå·± hostã€ç§Ÿå±‹å¾æ°¸å’Œæ¬è‡³ä¸‰é‡ï¼Œé€™ä¸‰ä»¶äº‹æƒ…ç®—æ˜¯ä¸‹åŠå¹´çš„äººç”Ÿé‡Œç¨‹ç¢‘ï¼Œåœ¨ç”Ÿæ´»ç¿’æ…£èˆ‡ç’°å¢ƒè½‰è®Šçš„éç¨‹ï¼Œå¯Ÿè¦ºè‡ªå·±åœ¨å¿ƒç†ç‹€æ…‹ä¸Šæœ‰äº›å¾®å¦™çš„æ¨¡å¼ï¼Œå¾Œä¾†çœ‹åˆ°é€™æœ¬æ›¸ã€ŠåŸå­ç¿’æ…£ã€‹ï¼Œä¸ç¦æƒ³èªªã€Œå°å•Š! å°±æ˜¯é€™æ¨£ã€&lt;/p>
&lt;p>è‡ªå·±ä¸€ç›´éå¸¸è‘—è¿·æ–¼è¡Œç‚ºç§‘å­¸çš„æ›¸ç±ï¼Œæˆ‘èªç‚ºå¤©ç”Ÿçš„åŸºå› æœƒå½±éŸ¿åœ¨ä¸åŒé ˜åŸŸæŠ•æ³¨çš„æ•ˆç‡ä»¥åŠæˆå°±å¤©èŠ±æ¿ï¼Œä½†å¾€å¾€å¸¸äººå¾ˆé›£å»é”åˆ°åŸºå› çš„æ¥µé™ï¼Œæˆ‘å€‘æ‡‰è©²æ›´å°ˆæ³¨æ–¼æˆ‘å€‘æ‰€èƒ½æ§åˆ¶çš„ - &lt;code>æ‰“é€ æ­£ç¢ºçš„å­¸ç¿’æ…‹åº¦èˆ‡ç©æ¥µæ­£å‘çš„å¿ƒæ…‹&lt;/code>&lt;/p>
&lt;p>é€™äº›å¹´é™¸çºŒçœ‹äº†ã€Šå¤§è…¦å–œæ­¡é€™æ¨£å­¸ã€‹ã€ã€Šåˆ»æ„ç·´ç¿’ã€‹åˆ°ç¾åœ¨æ¨è–¦çš„é€™æœ¬ã€ŠåŸå­ç¿’æ…£ã€‹ï¼Œå¾æœ€åŸºå±¤å¤§è…¦çš„ç”Ÿç†é‹ä½œæ–¹å¼ã€å„ç¨®è¡Œç‚ºç§‘å­¸å¯¦é©—åˆ°å„é ˜åŸŸçš„é ‚å°–äººæ‰ç ”ç©¶ï¼Œè®“æˆ‘æ›´ç›¸ä¿¡æ”¹è®Šæ²’æœ‰æƒ³åƒä¸­çš„å›°é›£ï¼Œåªè¦æ‰¾å°å­¸ç¿’çš„æ–¹æ³•&lt;/p>
&lt;p>åœ¨è‡ªå·±ç”Ÿæ´»ä¸­ä¹Ÿè©¦è‘—è½å¯¦æ›¸ä¸­çš„ç†å¿µï¼Œå»èª¿æ•´è‡ªå·±çš„å­¸ç¿’æ–¹å¼èˆ‡å¿ƒæ…‹ï¼Œé›–ç„¶æˆå°±æ–¹é¢é ä¸è¶³ä»¥èªªå˜´ï¼Œä½†è·Ÿå…©å¹´å‰çš„è‡ªå·±ç›¸æ¯”ï¼Œå»ä¹Ÿæˆé•·è¨±å¤š&lt;/p>
&lt;p>æœ€è¿‘é–‹å§‹å¯Ÿè¦ºåˆ°è‡ªå·±åœ¨æŸäº›æ–¹é¢æœ‰äº†é€€æ­¥ï¼Œä¾‹å¦‚éƒ¨è½æ ¼æ›´æ–°çš„é »ç‡ä¸‹é™éå¸¸å¤šï¼Œå¾ä»¥å‰ä¸€å€‹æœˆå››ç¯‡åˆ°ç¾åœ¨ä¸€å€‹æœˆä¸€ç¯‡ï¼Œä¸€æ–¹é¢æ˜¯æœ‰æ„å¸Œæœ›ä¸‹é™è‡ªå·±ç™¼æ–‡çš„é »ç‡ï¼Œå¸Œæœ›è®“è‡ªå·±æœ‰æ›´é•·çš„å­¸ç¿’é€±æœŸå»é‘½ç ”æ›´é›£çš„å•é¡Œè€Œéç‚ºäº†ç™¼æ–‡è€Œç™¼æ–‡ï¼Œä½†å»ä¹Ÿæ…¢æ…¢é–‹å§‹å‡ºç¾äº†æ€ æƒ°ï¼Œçœ‹åˆ°ã€ŠåŸå­ç¿’æ…£ã€‹æ‰é©šè¦ºâ€ç¿’æ…£â€œçš„æ¨£è²Œï¼Œç™¼æ–‡é »ç‡ä¸‹é™çš„åŸå› æ˜¯å¯ä»¥è¢«æ‹†è§£ï¼Œä¹Ÿæ‰æœ‰å¯ä»¥è¢«æ”¹å–„çš„å¯èƒ½&lt;/p>
&lt;blockquote>
&lt;p>æˆ‘å€‘éƒ½åœ¨ä¸æ–·çš„è¨­å®šç›®æ¨™ï¼Œå°è‡³è®€æ›¸è¨ˆç•«å¤§è‡³è²¡å¯Œè‡ªç”±ï¼Œå¸Œæœ›ç”¨è‡ªåˆ¶åŠ›å»èªªæœ(å¼·è¿«)è‡ªå·±åŸ¹é¤Šå‡ºæ­£ç¢ºçš„ç¿’æ…£ï¼Œä½†å¾€å¾€å …æŒä¸äº†å¤šä¹…å°±æ”¾æ£„äº†ï¼Œé€™æ˜¯å› ç‚ºæˆ‘å€‘å¿½ç•¥æ¢è¨ã€Œç¿’æ…£ã€çš„æœ¬è³ªï¼Œæ‰€ä»¥æ‰ç„¡æ³•ã€Œé¤Šæˆå¥½ç¿’æ…£èˆ‡æœçµ•å£ç¿’æ…£ã€&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœä½ è¦ºå¾—ã€Œæœƒæ”¾æ£„çš„äººå°±æ˜¯è‡ªå·±ä¸å¤ åŠªåŠ›ã€è‡ªåˆ¶åŠ›ä¸å¤ å¥½ã€ï¼Œåˆæˆ–æ˜¯ã€Œå…ƒæ—¦åˆ¶å®šäº†æ–°å¹´æ–°è¨ˆç•«å»æ¯æ¬¡æ’ä¸åˆ°è¾²æ›†å¹´å°±æ”¾æ£„çš„äººã€é€™æœ¬æ›¸å¯ä»¥å¸¶çµ¦ä½ ä¸åŒçš„æƒ³æ³•ï¼Œä¸¦æä¾›éå¸¸å¯¦ç”¨çš„æŠ€å·§&lt;/p>
&lt;h1 id="æ ¸å¿ƒç†å¿µ">æ ¸å¿ƒç†å¿µ&lt;/h1>
&lt;h3 id="è¤‡åˆ©çš„åŠ›é‡æ¯”åŸå­å½ˆé‚„å¯æ€•">è¤‡åˆ©çš„åŠ›é‡æ¯”åŸå­å½ˆé‚„å¯æ€•&lt;/h3>
&lt;p>&lt;code>æ¯å¤©é€²æ­¥ 1%ç´¯ç©ä¸€å¹´ä¹‹å¾Œå°±æ˜¯ 37å€çš„æˆé•·&lt;/code>ï¼Œå …æŒæ¯å€‹å¾®å°çš„æ”¹å–„ï¼Œç´¯ç©èµ·ä¾†å°±æ˜¯é©šäººçš„æˆé•·ï¼Œé€™ä¹Ÿæ˜¯&lt;code>&amp;quot;åŸå­ atomic&amp;quot;&lt;/code> åœ¨æ›¸åçš„å«ç¾©ï¼Œåœ¨ 2003 å¹´è‹±åœ‹è‡ªè¡Œè»Šå”æœƒé›‡ç”¨æ–°çš„æ•™ç·´ æˆ´å¤«ãƒ»å¸ƒèŠçˆ¾æ–¯ç¦å¾·ï¼Œåœ¨æ­¤å‰è‹±åœ‹è‡ªè¡Œè»ŠéšŠåœ¨éå¾€ä¸€ç™¾å¤šå¹´åªæ˜¯ä¸€éš»å¹³åº¸çš„è»ŠéšŠï¼Œå¸ƒèŠçˆ¾æ–¯ç¦å¾·æ±ºå®šåœ¨æ¯å€‹é¢å‘éƒ½å˜—è©¦åšå‡ºå¾®å¹…æ”¹å–„ï¼Œä¾‹å¦‚é‡æ–°è¨­è¨ˆåå¢Šè®“é¸æ‰‹æ›´å¥½åšã€è¨­æ³•å¢åŠ è¼ªèƒæ‘©æ“¦åŠ›ã€èª¿æ•´æ¯ä½é¸æ‰‹çš„è¨“ç·´æ¨¡å¼ç­‰ï¼Œç´¯ç©é€™äº›æ­£é¢çš„æ”¹è®Šå¾Œï¼Œè‹±åœ‹è»ŠéšŠåœ¨çŸ­çŸ­æ•¸å¹´å…§æ–¬ç²äº†ä¹é …å¥§é‹ç´€éŒ„èˆ‡å¤šé …ä¸–ç•Œç´€éŒ„&lt;/p>
&lt;p>å·²ç¶“æœ‰å¾ˆå¤šæˆåŠŸå­¸éƒ½åœ¨æ¢è¨è¤‡åˆ©çš„å¨åŠ›ï¼Œä½†é€™é‚Šæœ‰å€‹é‡é»æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>å¾®å°&lt;/p>
&lt;/blockquote>
&lt;h3 id="å°ˆæ³¨æ–¼ç³»çµ±è€Œéç›®æ¨™">å°ˆæ³¨æ–¼ç³»çµ±è€Œéç›®æ¨™&lt;/h3>
&lt;p>å¾€å¾€æˆ‘å€‘ç¿’æ…£åˆ¶å®šå¾ˆå¤šçš„ç›®æ¨™ï¼Œä¾‹å¦‚èªªå…¨é¦¬è¦å››å°æ™‚å…§è·‘å®Œ(ç ´å››)ï¼Œè¨­ç«‹é€™æ¨£çš„ç›®æ¨™æœƒå¸¶ä¾†ä¸€ç¨®å¿ƒç†æš—ç¤ºã€Œå¦‚æœæˆ‘ç ´å››äº†æ‰æœƒå¿«æ¨‚ï¼Œåä¹‹å‰‡ä¸å¿«æ¨‚ã€çš„å–®é¸é¡Œï¼Œå¦‚æœæ²’æœ‰é”æˆç›®æ¨™å°±æœƒå¾ˆæ²®å–ªï¼Œåä¹‹å³ä½¿é”æˆç›®æ¨™äº†ï¼Œä¹Ÿå°±æœƒå› æ­¤åœä¸‹è…³æ­¥ï¼›&lt;/p>
&lt;p>ä½œè€…æè­°æˆ‘å€‘æ‡‰è©²å°ˆæ³¨æ–¼&lt;code>ç³»çµ±&lt;/code>è€Œéç›®æ¨™&lt;/p>
&lt;blockquote>
&lt;p>ç›®æ¨™æ˜¯æƒ³è¦é”åˆ°çš„æˆæœã€ç³»çµ±æ˜¯è®“ä½ é”åˆ°æˆæœçš„éç¨‹ &lt;br>
ä¾‹å¦‚èªªä½ æ˜¯æ•™ç·´ï¼Œä½ çš„ç›®æ¨™æ˜¯æ‹¿ä¸‹å† è»ï¼Œä½ çš„ç³»çµ±æ˜¯æ‹›è˜çƒå“¡ã€å¸¶éšŠè¨“ç·´ã€åˆ¶å®šæ¯”è³½ç­–ç•¥ç­‰&lt;/p>
&lt;/blockquote>
&lt;p>é€™ä¸æ˜¯èªªç›®æ¨™ä¸é‡è¦ï¼Œæœ‰äº†å…·é«”çš„ç›®æ¨™æ‰æœ‰å¾ŒçºŒæ‰“é€ ç³»çµ±çš„å¯èƒ½ï¼Œä½†åªèšç„¦æ–¼ç›®æ¨™è€Œéç³»çµ±å®¹æ˜“éæ–¼çŸ­è¦–ï¼Œè€Œç¿’æ…£å°±æ˜¯å°ˆæ³¨æ–¼æ‰“é€ è‰¯å¥½çš„ç³»çµ±ï¼Œæ¯æ—¥æŠ•å…¥æ­£ç¢ºçš„äº‹æƒ…ï¼Œç´¯ç©èµ·ä¾†å°±ä¸å¤ªéœ€è¦æ“”å¿ƒæˆæœæœƒå¤ªå·® (æ­¤å¿ƒæ³•æˆ–è¨±åƒ…é™æ–¼å€‹äººè€Œéå…¬å¸ä½¿ç”¨)&lt;/p>
&lt;p>ä»¥æˆ‘è‡ªèº«çš„ç¶“é©—ä¸€é–‹å§‹é¦¬æ‹‰æ¾ç·´ç¿’ç¢ºå¯¦ä¹Ÿæƒ³è¦æ‹¼ç ´å››ï¼Œç¶²è·¯ä¸Šæ‰¾äº†èœå–®é–‹å§‹æŒ‰è¡¨æ“èª²ï¼Œæ¯æ—¥çš„ç·´ç¿’ç¢ºå¯¦å¸¶ä¾†é€²æ­¥ï¼Œè¶Šæ¥è¿‘æ¯”è³½è·‘å¾—ä¹Ÿè¶Šå¿«ï¼Œä½†å¿ƒæƒ…ä¹Ÿè¶Šä¾†è¶Šä½è½ï¼Œç”šè‡³ä¸å¤ªæƒ³è·‘æ­¥äº†ï¼›&lt;br>
å› ç‚ºä¸€æ–¹é¢ç›®æ¨™è¨­å®šçš„æœ‰é»é«˜ï¼Œæ²’æœ‰åƒåŠ éé•·è·‘ç¬¬ä¸€æ¬¡å°±æƒ³è¦æŒ‘æˆ°å…¨é¦¬é æ¯”æƒ³åƒä¸­å›°é›£ï¼Œå¦ä¸€æ–¹é¢ä¸€ç›´èšç„¦æ–¼ç›®æ¨™èˆ‡ç¾å¯¦çš„è½å·®å¯¦åœ¨è®“äººæ²®å–ªï¼Œå°è‡´å¾Œé¢åè€Œå€¦æ€ æˆç¸¾åˆæ›´å·®å¼·äººæ„&lt;/p>
&lt;h3 id="è‡ªæˆ‘èº«ä»½èªåŒ---ä½ æƒ³è¦æˆç‚ºæ€æ¨£çš„äºº">è‡ªæˆ‘èº«ä»½èªåŒ - ä½ æƒ³è¦æˆç‚ºæ€æ¨£çš„äºº&lt;/h3>
&lt;p>ç•¶æˆ‘å€‘åšä¸€ä»¶äº‹ä¸€å€‹æ±ºå®šï¼Œå¯ä»¥å†å¾€å›è¿½æº¯ã€Œæˆ‘å€‘è¦å¦‚ä½•åšã€ä»¥åŠã€Œç‚ºä»€éº¼æˆ‘å€‘è¦é€™æ¨£åšã€ï¼Œä¹Ÿå°±æ˜¯ Golden Circle æ‰€æè¿°çš„ &lt;code>What &amp;lt;-- How &amp;lt;-- Why&lt;/code>&lt;br>
åœ¨è¡Œç‚ºä¸Šä¹Ÿæ˜¯ï¼Œ&lt;code>æˆæœ &amp;lt;-- ç³»çµ±(æ”¹è®Šéç¨‹) &amp;lt;-- èº«ä»½èªåŒ&lt;/code>ï¼Œç¿’æ…£çš„é¤Šæˆè®“æˆ‘å€‘è‡ªç„¶è€Œç„¶å»åšæŸä»¶äº‹ï¼ŒæŒçºŒçš„åšï¼Œåœ¨åŸ·è¡Œçš„éç¨‹ä¸æ–·çš„åŠ å¼·ã€Œæˆ‘æ˜¯èª°ã€çš„æ„è±¡ï¼Œé€™åˆå›æ‡‰åˆ°ç‚ºä»€éº¼å°ˆæ³¨æ–¼ç³»çµ±æœ‰æ™‚æ¯”å°ˆæ³¨æ–¼ç›®æ¨™æ›´é‡è¦ï¼Œå› ç‚ºé€™é—œä¹åˆ°æˆ‘å€‘æœ€å¾Œæœƒæˆç‚ºæ€æ¨£çš„äººï¼›&lt;br>
è€Œæˆ‘å€‘è‡ªèº«çš„èº«ä»½èªåŒï¼Œä¹Ÿæ±ºå®šäº†æˆ‘å€‘æ±ºå®šå»æ‰“é€ å°æ‡‰çš„ç¿’æ…£ï¼Œå…©è€…æ˜¯äº’ç›¸å½±éŸ¿çš„&lt;/p>
&lt;p>ä½œè€…èˆ‰ä¸€å€‹æœ‰è¶£çš„ä¾‹å­ï¼Œæœ‰å€‹ç™®å›å­æ±ºå®šè¦æˆ’è¸äº†ï¼Œç•¶ä¸€å€‹äººéé¦™è¸çµ¦ä»–æ™‚ï¼Œå¦‚æœä»–å›ç­”ã€Œå°ä¸èµ·æˆ‘ä¸æŠ½ç…™ã€è·Ÿã€Œå°ä¸èµ·æˆ‘æ­£åœ¨æˆ’è¸ã€ï¼Œå‰è€…æˆ’è¸çš„æˆåŠŸæ©Ÿç‡æœƒé«˜å‡ºè¨±å¤šï¼Œå› ç‚º&lt;code>ä»–çš„èº«ä»½èªåŒå·²ç¶“æ˜¯ä¸æŠ½è¸çš„äºº&lt;/code>ï¼Œæ‰€ä»¥ä¸æŠ½è¸çš„èˆ‰å‹•å°ä»–ä¾†èªªæ˜¯å¾ˆæ­£å¸¸çš„å›æ‡‰(æˆ–è“„æ„å¡‘é€ è‡ªå·±)ï¼›&lt;br>
è€Œå¾Œè€…é‚„æ˜¯ä»¥æŠ½è¸è€…è‡ªå±…ï¼Œæ¯æ¬¡ä¸æŠ½è¸éƒ½æ˜¯ç¨®æ™æ‰ï¼Œå®¹æ˜“åˆå—åˆ°èª˜æƒ‘è€Œè¸ç™®å¾©ç™¼&lt;/p>
&lt;h1 id="ç¿’æ…£å½¢æˆ">ç¿’æ…£å½¢æˆ&lt;/h1>
&lt;p>ç¿’æ…£çš„é¤Šæˆä¸»è¦æ˜¯å› ç‚ºå¤§è…¦çš„å¿ƒåŠ›æ˜¯æœ‰é™çš„ï¼Œæ¯æ¬¡ä¹Ÿåªèƒ½å°ˆæ³¨åœ¨ä¸€ä»¶äº‹æƒ…ä¸Šï¼Œä½†ç”Ÿæ´»ä¸­å¤§å¤§å°å°æœ‰é€™éº¼å¤šçš„æ±ºå®šè¦åšï¼Œå°è‡³æ¯å¤©åƒä»€éº¼ç©¿ä»€éº¼åˆ°å·¥ä½œä¸Šçš„å•†æ¥­æ±ºç­–ï¼Œæ‰€ä»¥å¤§è…¦ç‚ºäº†ç¯€çœè³‡æºï¼Œæ¼¸æ¼¸çš„ä¸€äº›ç†Ÿæ‚‰çš„äº‹æƒ…å°±æœƒç”¨å›ºæœ‰çš„æ¨¡å¼è™•ç†ï¼Œé€™äº›æ¨¡å¼å°±æˆäº†æˆ‘å€‘çš„ç¿’æ…£&lt;/p>
&lt;p>ä½†ç¿’æ…£çš„é¤Šæˆæ˜¯æœ‰ä¸€å€‹è¿´è·¯&lt;/p>
&lt;blockquote>
&lt;p>æç¤º -&amp;gt; æ¸´æœ› -&amp;gt; å›æ‡‰ -&amp;gt; çå‹µ&lt;/p>
&lt;/blockquote>
&lt;p>å¿ƒç†å­¸å®¶åšäº†ä¸€é …å¯¦é©—ï¼Œå°‡è²“æ”¾åœ¨è¿·é¾çš„è¨­è¨ˆä¸­ï¼Œè¨­è¨ˆå¤šå€‹å‡ºå£ï¼Œå¿…é ˆæ‹‰ä¸‹å‡ºå£æ—çš„æ‹‰æ¡¿é–€æ‰æœƒé–‹ï¼ŒæˆåŠŸæ‰¾åˆ°å‡ºå£å¾Œæœƒæœ‰é£Ÿç‰©çš„çå‹µï¼Œå¿ƒç†å­¸å®¶è§€å¯Ÿåˆ°è²“å’ªéš¨è‘—ç·´ç¿’çš„æ¬¡æ•¸ï¼Œé–‹å§‹çŸ¥é“è¦æ‹‰æ‹‰æ¡¿ï¼Œèªå¾—æ­£ç¢ºå‡ºå£çš„é€Ÿåº¦ä¹Ÿè¶Šä¾†è¶Šå¿«&lt;/p>
&lt;p>æ‰€ä»¥å°‡ç¿’æ…£çš„è¿´è·¯æ‹†è§£å¥—ç”¨åœ¨äººçš„ç”Ÿæ´»ä¸Š&lt;/p>
&lt;blockquote>
&lt;p>æç¤ºï¼šæ‰‹æ©ŸéŸ¿äº†æœ‰æ–°è¨Šæ¯&lt;br>
æ¸´æœ›ï¼šæƒ³è¦çŸ¥é“è¨Šæ¯å…§å®¹&lt;br>
å›æ‡‰ï¼šæ‹¿èµ·æ‰‹æ©Ÿ&lt;br>
çå‹µï¼šæ»¿è¶³äº†çŸ¥é“è¨Šæ¯çš„æ¸´æœ›&lt;/p>
&lt;/blockquote>
&lt;p>ç•¶æˆ‘å€‘è¦å»ºç«‹å¥½ç¿’æ…£è·Ÿæˆ’é™¤å£ç¿’æ…£ï¼Œå°±è¦å¾é€™å››å€‹æ­¥é©Ÿä¸‹æ‰‹&lt;/p>
&lt;h1 id="æç¤º">æç¤º&lt;/h1>
&lt;p>äººé¡å—åˆ°ç’°å¢ƒçš„å½±éŸ¿é æ¯”æƒ³åƒä¸­çš„å¤§ï¼Œä¾‹å¦‚èªªå•†åº—è²¨æ¶ä¸Šï¼Œè·Ÿè¦–ç·šç­‰é«˜çš„å•†å“å€éŠ·å”®é¡æ›´å¥½ï¼›åˆæˆ–æ˜¯åœ¨é›¶é£Ÿå€é¡¯çœ¼è™•æ“ºæ”¾å¥åº·é£Ÿå“ï¼Œä¸åšå…¶ä»–æ”¹å–„äººå€‘ä¹Ÿæœƒå‚¾å‘æ‹¿å–å¥åº·é£Ÿå“&lt;/p>
&lt;p>æˆ‘å€‘åœ¨åšæ±ºå®šæ™‚å¾ˆå¤šæ™‚å€™éƒ½è™•æ–¼æ·ºå±¤æ„è­˜çš„ç‹€æ…‹ï¼Œé€™æ™‚å€™ç’°å¢ƒçš„æç¤ºå°±æœƒè‡ªç„¶è€Œç„¶å¼•å°æˆ‘å€‘ï¼Œæ‰€ä»¥æƒ³è¦&lt;code>å»ºç«‹å¥½ç¿’æ…£å°±è®“ä»–æ›´é¡¯è€Œæ˜“è¦‹ / æˆ’é™¤å£ç¿’æ…£å°±é€£çœ‹éƒ½ä¸è¦çœ‹åˆ°&lt;/code>&lt;/p>
&lt;p>åƒæ˜¯ç¾ä»£äººå®¹æ˜“å—åˆ° 3C ç”¢å“çš„èª˜æƒ‘ï¼Œå³ä½¿æƒ³è¦é›†ä¸­ç²¾ç¥é‚„æ˜¯æœƒä¸æ–·çš„è¢«å¹²æ“¾ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯é€£çœ‹åˆ°éƒ½ä¸è¦çœ‹åˆ°ï¼Œèˆ‰ä¾‹ä¾†èªªåœ¨æ›¸æˆ¿çœ‹æ›¸å°±æŠŠæ‰‹æ©Ÿéºç•™åœ¨å®¢å»³ï¼Œé€£çœ‹éƒ½çœ‹ä¸åˆ°ï¼›
å¦‚æœèªªæƒ³è¦åŸ¹é¤Šé‹å‹•ç¿’æ…£ï¼Œå°±åœ¨æ¯å¤©ç¡è¦ºå‰æŠŠé‹å‹•æœæ•´ç†å¥½ï¼Œæ”¾åœ¨ä¸€èµ·åºŠå°±æœƒçœ‹è¦‹çš„åœ°æ–¹ï¼Œéš”å¤©é†’ä¾†ä¸‹æ„è­˜å°±æœƒè¢«æç¤ºã€Œè©²é‹å‹•äº†ã€&lt;/p>
&lt;h3 id="ç’°å¢ƒ">ç’°å¢ƒ&lt;/h3>
&lt;p>ç’°å¢ƒå°äººä¹Ÿæœ‰æç¤ºçš„åŠŸèƒ½ï¼Œä¾‹å¦‚èªªç¿’æ…£åœ¨æ²™ç™¼ä¸Šæ»‘æ‰‹æ©Ÿåƒé›¶é£Ÿï¼Œåªè¦ä¸€ååˆ°æ²™ç™¼ä¸Šå°±æœƒä¸è‡ªè¦ºæƒ³è¦å»æ‹¿é›¶é£Ÿï¼Œä½œè€…å»ºè­°&lt;code>ä¸€å€‹åœ°æ–¹å°±åªåšä¸€ä»¶äº‹&lt;/code>ï¼Œæ›¸æ¡Œå°±åªç”¨ä¾†è¾¦å…¬è·Ÿè®€æ›¸ã€æ²™ç™¼å°±ç”¨ä¾†çœ‹é›»è¦–æ”¾é¬†ç­‰ç­‰ï¼Œä¸€å€‹ä½å­ä¸€ä»¶äº‹ï¼Œç•¶ä½ åˆ°äº†é‚£å€‹ç’°å¢ƒï¼Œè‡ªç„¶å°±æœƒåšåŸæœ¬ç†Ÿæ‚‰çš„äº‹æƒ…&lt;/p>
&lt;p>å¦‚æœæƒ³è¦å¾¹åº•æ”¹é ­æ›é¢ï¼Œæ›å€‹æ–°çš„ç’°å¢ƒæˆ–è¨±æ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡&lt;/p>
&lt;h1 id="æ¸´æœ›">æ¸´æœ›&lt;/h1>
&lt;p>ç•¶äººé¡æ”¶åˆ°çå‹µæ™‚ï¼Œè…¦ä¸­æœƒåˆ†æ³Œã€Œå¤šå·´èƒºã€ï¼Œä¹Ÿå°±æ˜¯è®“äººé¡æ„Ÿåˆ°æ”¾é¬†å¿«æ¨‚çš„æ¿€ç´ ï¼Œä½†æ ¹æ“šç ”ç©¶è­‰å¯¦ï¼Œ&lt;code>ç•¶æ¸´æœ›çå‹µæ™‚è€Œå°šæœªæ”¶åˆ°çå‹µæ™‚ï¼Œä¹Ÿæœƒåˆ†æ³Œå¤šå·´èƒº&lt;/code>ï¼Œè€Œæ¸´æœ›ä¹Ÿæœƒæ¯”å¯¦éš›æ”¶åˆ°çå‹µæ™‚çš„å¿«æ¨‚æ›´å¼·çƒˆ&lt;/p>
&lt;h3 id="ç¶‘ç¶çå‹µ">ç¶‘ç¶çå‹µ&lt;/h3>
&lt;p>æ‰€ä»¥æˆ‘å€‘å¯ä»¥é€é&lt;code>ç¶‘ç¶çå‹µ&lt;/code>ï¼Œå°‡ä¸€å€‹ä¸æ€éº¼æœ‰å¸å¼•åŠ›çš„å¥½ç¿’æ…£æ†ç¶åœ¨ä¸€å€‹å–œæ­¡çš„ç¿’æ…£ä¸Šï¼Œä¾‹å¦‚èªªæœ‰å€‹å·¥ç¨‹å¸«å¸Œæœ›åŸ¹é¤Šé¨è…³è¸è»Šçš„é‹å‹•ç¿’æ…£ï¼ŒåŒæ™‚ä»–ä¹Ÿå¾ˆæ„›çœ‹ Netflixï¼Œæ‰€ä»¥ä»–æ±ºå®šçµåˆå…©è€…ï¼Œç•¶è…³è¸è»Šæ©Ÿè¸©åˆ°ä¸€å®šæ™‚é€Ÿä¹‹å¾Œï¼ŒNetflix æ‰æœƒé–‹å§‹æ’­æ”¾ï¼Œåä¹‹å°±æœƒæš«åœæ’­æ”¾&lt;/p>
&lt;p>å…¬å¼æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>åšå®Œ [ç›®å‰ç¿’æ…£å¾Œ]ï¼Œæˆ‘å°‡åŸ·è¡Œ [æˆ‘éœ€è¦çš„ç¿’æ…£]&lt;br>
åšå®Œ [æˆ‘éœ€è¦çš„ç¿’æ…£] å¾Œï¼Œæˆ‘æœƒåŸ·è¡Œ [æˆ‘æƒ³è¦çš„ç¿’æ…£]&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚åˆä¼‘å›ä¾†å¾Œæ‰“é›»æœƒçµ¦ä¸‰å€‹å®¢æˆ¶ï¼Œæ‰“å®Œå¾Œå°±å¯ä»¥æ»‘æ‰‹æ©Ÿé€™æ¨£ï¼Œå°‡éœ€è¦è¢«åŸ¹é¤Šçš„ç¿’æ…£å®‰æ’åœ¨ä¸­é–“&lt;/p>
&lt;h3 id="å°‹æ±‚åœ˜é«”">å°‹æ±‚åœ˜é«”&lt;/h3>
&lt;p>äººå€‘éƒ½æœ‰å°‹æ±‚ &lt;code>æ­¸å±¬&lt;/code> çš„å¿ƒç†éœ€æ±‚ï¼Œæˆ‘å€‘ç¸½å¸Œæœ›æ‰¾åˆ°ä¸€å€‹èªåŒè‡ªæˆ‘çš„åœ˜é«”ï¼ŒåŒæ™‚æˆ‘å€‘ç‚ºäº†åŠ å¼·èªåŒä¹Ÿä¸çŸ¥ä¸è¦ºé–‹å§‹æ¨¡ä»¿åœ˜é«”ä¸­å¤§å¤šæ•¸äººçš„ç¿’æ…£ï¼Œå¸Œæœ›è—‰æ­¤ç²å¾—æŒè²ï¼Œæœ‰ç ”ç©¶ç™¼ç¾å¦‚æœèº«é‚Šæœ‰æœ‹å‹è®Šèƒ–äº†ï¼Œé‚£è‡ªå·±è®Šèƒ–çš„æ©Ÿç‡æœƒæé«˜ 1/3&lt;/p>
&lt;p>åŒæ¨£çš„æˆ‘å€‘å¯ä»¥é€éåŠ å…¥åœ˜é«”ä¾†åŸ¹é¤Šè‡ªå·±æ–°çš„ç¿’æ…£ï¼Œä½†éœ€è¦æ³¨æ„&lt;/p>
&lt;ol>
&lt;li>ä½ å¸Œæœ›çš„ç¿’æ…£æ˜¯å¸¸æ…‹&lt;/li>
&lt;li>ä½ è·Ÿé€™å€‹åœ˜é«”æœ¬èº«æœ‰å…±é€šé»&lt;/li>
&lt;/ol>
&lt;p>æœ‰å€‹å…±é€šé»æˆ‘è¦ºå¾—è »é‡è¦çš„ï¼Œå¦‚æœæ²’æœ‰ä¸€é–‹å§‹å¾ˆé›£èå…¥ï¼Œå¾ŒçºŒè¦åŸ¹é¤Šç¿’æ…£å°±æœƒå¾ˆå›°é›£&lt;br>
æˆ‘è‡ªå·±æ˜¯åŠ å…¥äº†é¾èˆŸéšŠä¹‹å¾Œï¼Œç™¼ç¾å¤§å®¶éƒ½åœ¨è·‘é¦¬æ‹‰æ¾ï¼Œä¸çŸ¥ä¸è¦ºä¹Ÿèˆˆèµ·åŸ¹é¤Šè·‘æ­¥èˆˆè¶£çš„å¿µé ­ï¼Œé›–ç„¶ä¸æ˜¯è·Ÿé¾èˆŸéšŠä¸€èµ·ç·´è·‘ï¼Œä½†åœ¨ç¤¾ç¾¤åª’é«”ä¸Šåˆ†äº«äº’ç›¸åŠ æ²¹ï¼Œä¹Ÿæ˜¯æˆ‘ä¸€ç›´å …æŒä¸‹å»çš„å‹•åŠ›ä¹‹ä¸€&lt;/p>
&lt;h1 id="å›æ‡‰">å›æ‡‰&lt;/h1>
&lt;p>ç•¶ä½ åœ¨æˆ¿é–“æ’é™¤é›œå¿µï¼ŒæŠŠå‰ç½®ä½œæ¥­éƒ½æº–å‚™å¥½äº†ï¼Œæœ€çµ‚é˜»æ“‹ä½ å®Œæˆä»»å‹™çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ&lt;/p>
&lt;p>æŸå¤§å­¸çš„æ•™æˆåšäº†ä¸€é …å¯¦é©—ï¼Œæƒ³è¦æ¢è¨å…©ç¨®æ¨¡å¼å°æ–¼æ‹ç…§æŠ€å·§çš„ç£¨ç·´&lt;br>
A çµ„æ˜¯é‡çµ„ï¼Œä»¥é‡çš„åšæˆç¸¾çš„è¨ˆç®—æ–¹å¼ï¼Œä¸Šäº¤ 100 å¼µæ‹¿åˆ° Aï¼Œ90 å¼µæ‹¿åˆ° B ç­‰ç­‰ï¼›&lt;br>
B çµ„æ˜¯è³ªçµ„ï¼Œå­¸æœŸæœ«ä¸Šäº¤ä¸€å¼µè‡ªèªç‚ºæœ€å®Œç¾çš„ç…§ç‰‡ï¼Œä»¥é€™å¼µä½œå“è©•åˆ†&lt;/p>
&lt;p>æœ€å¾Œå“è³ªæ¯”è¼ƒå¥½çš„æ˜¯å“ªä¸€çµ„å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ•™æˆç™¼ç¾æ˜¯ &lt;code>Açµ„&lt;/code>ï¼Œå› ç‚ºè¢«é¼“å‹µå¤§é‡æ‹æ”ï¼Œä¸€é–‹å§‹å¯èƒ½æ‹å‡ºä¸å¥½çš„ç…§ç‰‡ï¼Œä½†ä¸æ–·çš„è©¦éŒ¯éç¨‹ä¹Ÿæå‡äº†æ‹ç…§æŠ€å·§ï¼›&lt;br>
B çµ„æ²’æœ‰è¦å®šä¸èƒ½å¤§é‡æ‹æ”ï¼Œä½†å› ç‚ºè¢«æš—ç¤ºè¦ã€Œè¿½æ±‚å®Œç¾ã€ï¼Œæ‰€ä»¥åè€Œæœƒæƒ³å¤ªå¤šï¼Œåè€Œç·´ç¿’çš„æ¬¡æ•¸ä¸‹é™ï¼Œæœ€çµ‚æˆæœåè€Œä¸é€™éº¼å®Œç¾&lt;/p>
&lt;p>ç•¶ç„¶ç·´ç¿’ä¹Ÿä¸æ˜¯ç„¡è…¦çš„ä¸€ç›´åè¦†åš(è©³è¦‹ã€Šåˆ»æ„ç·´ç¿’ã€‹ä¸€æ›¸)ï¼Œä½†æ˜¯äººå€‘æœƒæœ‰å€‹å¤©æ€§æ˜¯&lt;code>è¿½æ±‚å®Œç¾ï¼Œå¦å‰‡å¯§é¡˜ä¸åš&lt;/code>çš„å¿ƒæ…‹ï¼Œæ›¸ä¸­å¼•ç”¨ä¼çˆ¾æ³°çš„ä¸€å¥è©± &lt;code>è‡³å–„è€…ï¼Œå–„ä¹‹æ•µ&lt;/code>ï¼Œå¯§å¯é–‹å§‹è¡Œå‹•ï¼Œæ…¢æ…¢ä¿®æ­£ï¼Œä¹Ÿä¸è¦ä¸€ç›´åŸ‹è‘—é ­è‹¦å¹¹ï¼Œå°±å¦‚åŒç²¾å¯¦å‰µæ¥­ï¼Œä½ æ‡‰è©²å…ˆå¾æœ€å°å¯è¡Œæ€§ç”¢å“é–‹å§‹ï¼Œå¾å¸‚å ´å¾—åˆ°åé¥‹ï¼Œåä¹‹äººçš„ç¿’æ…£é¤Šæˆä¹Ÿæ˜¯&lt;/p>
&lt;h3 id="å…©åˆ†é˜æ³•å‰‡">å…©åˆ†é˜æ³•å‰‡&lt;/h3>
&lt;p>ä½œè€…æå‡º å…©åˆ†é˜æ³•å‰‡ï¼Œä¸è¦æ€•ä¸å®Œç¾ï¼Œå‡è¨­ä½ æƒ³åŸ¹é¤Šåšä¼ç«‹æŒºèº«çš„ç¿’æ…£ï¼Œä¸éœ€è¦ä¸€é–‹å§‹å°±å¾ 3,50 ä¸‹é–‹å§‹ï¼Œå¾ 5 ä¸‹é–‹å§‹å°±å¥½ï¼Œç”šè‡³ 2 ä¸‹ä¹Ÿæ²’æœ‰é—œä¿‚ï¼Œé‡é»æ˜¯ &lt;code>é–‹å§‹è¡Œå‹•&lt;/code>ï¼›&lt;br>
æƒ³è¦åŸ¹é¤Šè·‘æ­¥ä¸å¦‚å¾æé†’è‡ªå·±è¦åˆ°æˆ¶å¤–èµ°èµ°ï¼Œç­‰ç¿’æ…£å¾Œå†æ…¢æ…¢å¢åŠ å¼·åº¦ï¼Œä¸è¦å¤ªå¥½é«˜é¨–é ï¼Œå¾&lt;code>å…©åˆ†é˜&lt;/code>é–‹å§‹å°±å¥½&lt;/p>
&lt;h3 id="èª¿æ•´åŸ·è¡Œç¿’æ…£çš„æˆæœ¬">èª¿æ•´åŸ·è¡Œç¿’æ…£çš„æˆæœ¬&lt;/h3>
&lt;p>å¦‚æœå¸Œæœ›å»ºç«‹ç¿’æ…£ï¼Œæˆ‘å€‘æ‡‰è©²è¦é™ä½åŸ·è¡Œçš„æˆæœ¬ï¼Œä¸Šé¢çš„å…©åˆ†é˜æ³•å‰‡æ˜¯ç‚ºäº†é™ä½å¿ƒç†æˆæœ¬ï¼Œåœ¨åŸ·è¡Œé¢ä¸Šå¯ä»¥å°‡æ±è¥¿æ­¸ä½å¥½ï¼Œç•¶è¦åŸ·è¡Œæ™‚å°±å¯ä»¥ç«‹é¦¬è¡Œå‹•ä¸ç”¨åœ¨æ‰¾æ±æ‰¾è¥¿ï¼›&lt;br>
åˆæˆ–æ˜¯åéä¾†ï¼Œè®“å£ç¿’æ…£çš„åŸ·è¡Œæˆæœ¬å¾ˆé«˜ï¼Œä½œè€…åˆ†äº«åˆ°ç‚ºäº†æˆ’é™¤ä¸æ–·æ»‘ç¤¾äº¤åª’é«”ï¼Œå¥¹èˆ‡å¦ä¸€å€‹å¥½å‹äº’ç›¸æ”¹å°æ–¹å¯†ç¢¼ï¼Œç­‰åˆ°é€±äº”æ‰å¯ä»¥è·Ÿå°æ–¹è¦æ–°çš„å¯†ç¢¼ç™»å…¥ï¼Œä»–ç™¼ç¾åˆ°é€™æ¨£çš„æ”¹è®Šå°±å¤§å¤§é™ä½ä»–å°ç¤¾äº¤åª’é«”çš„ä¾è³´&lt;/p>
&lt;h1 id="çå‹µ">çå‹µ&lt;/h1>
&lt;p>æœ‰äº›æ™‚å€™å¥½ç¿’æ…£çš„çå‹µæ˜¯æœ‰å»¶é²æ€§ï¼Œä¾‹å¦‚èªªå¥èº«è¦éå€‹æ•¸é€±æ‰æœ‰æˆæ•ˆï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¥½ç¿’æ…£ä¸å®¹æ˜“æŒçºŒçš„é—œä¿‚ï¼Œä½†æˆ‘å€‘é‚„æ˜¯èƒ½é€éä¸åŒçš„æ–¹å¼å»æ”¹è®Š&lt;/p>
&lt;h3 id="è¿´ç´‹é‡ç­–ç•¥">è¿´ç´‹é‡ç­–ç•¥&lt;/h3>
&lt;p>æœ‰å€‹æˆåŠŸçš„æ¥­å‹™åˆ†äº«åˆ°ï¼Œæ¯ç•¶ä»–æ‰“å®Œä¸€é€šé›»è©±çµ¦å®¢æˆ¶ï¼Œå°±æŠŠè¿´ç´‹é‡å¾ A æ¡¶æ¬ç§»åˆ° B æ¡¶ï¼Œé€éæŠ•å…¥è¿´ç´‹é‡ï¼Œä»–ä¸çŸ¥é“è¦æ‰“å¤šå°‘é€šé›»è©±æ‰æœƒæˆäº¤ä¸€é€šï¼Œä½†é€éæŠ•æ“²è¿´ç´‹é‡ï¼Œä»–çŸ¥é“è‡ªå·±æ¯æ¬¡çš„é›»è©±éƒ½æ˜¯æœ‰æˆæœçš„ï¼Œæ‰€ä»¥å°‡&lt;code>ç›®æ¨™å¯è¦–åŒ–&lt;/code>æ˜¯å€‹å¾ˆå¥½è¿½è¹¤çš„æ–¹å¼&lt;/p>
&lt;p>å°æ™‚å€™æ¯æ¬¡æ‹¿åˆ°å¥½å¯¶å¯¶æ¨™ç« ä¹Ÿæ˜¯ç›¸åŒçš„é“ç†ï¼Œç¾åœ¨æœ‰è¨±å¤šçš„ App å¯ä»¥å¹«å¿™è¿½è¹¤ï¼Œä¾‹å¦‚è·‘æ­¥ä¹Ÿæœ‰è·‘æ­¥çš„é‡Œç¨‹ï¼Œæ¯æ¬¡çœ‹åˆ°è‡ªå·±çš„ç´¯ç©ï¼Œçœ‹åˆ°è‡ªå·±çš„æˆç¸¾ç©©å®šé€²æ­¥ï¼Œç¢ºå¯¦æœ‰å¾ˆå¤§çš„æ»¿è¶³&lt;/p>
&lt;p>å¦‚æœå¯ä»¥çš„è©±è®“ç›®æ¨™è¿½è¹¤å¾ˆé¡¯çœ¼ï¼Œé€™å°±æœƒå†è½‰è®Šæˆä¸‹ä¸€å€‹è¿´åœˆçš„&lt;code>æç¤º&lt;/code>&lt;/p>
&lt;h3 id="å•è²¬å¤¥ä¼´">å•è²¬å¤¥ä¼´&lt;/h3>
&lt;p>ä¹Ÿå¯ä»¥æ‰¾å€‹å¤¥ä¼´ï¼Œå‘Šè¨´å°æ–¹è‡ªå·±çš„ç›®æ¨™å¾Œï¼Œç”±é›™æ–¹äº’ç›¸æé†’èˆ‡é¼“å‹µï¼Œé€éäººéš›é—œä¿‚çµ¦è‡ªå·±å£“åŠ›èˆ‡çè³ï¼Œæ˜¯å€‹ä¸éŒ¯çš„ä½œæ³•&lt;/p>
&lt;h1 id="çµèª">çµèª&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">è®“æç¤ºé¡¯è€Œæ˜“è¦‹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è®“ç¿’æ…£è®Šå¾—æœ‰å¸å¼•åŠ›
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è®“è¡Œå‹•è¼•è€Œæ˜“èˆ‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è®“çè³ä»¤äººæ»¿è¶³
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€çµ‚äººç”Ÿå°±æ˜¯ç”±ä¸€é€£ä¸²å¾®å°çš„è¡Œç‚ºæ‰€ä¸²é€£ï¼Œå¦‚æœæˆ‘å€‘å¯ä»¥æ›´æœ‰æ„è­˜åœ°å»æ‰“é€ è‡ªå·±çš„æ½›æ„è­˜ï¼Œé‚£æˆ–è¨±é€™æ¨£èƒ½æ›´è²¼è¿‘æˆ‘å€‘æƒ³è¦çš„ç”Ÿæ´»ï¼Œçœ‹å®Œã€ŠåŸå­ç¿’æ…£ã€‹è®“æˆ‘é‡æ–°æ€è€ƒè‡ªå·±çš„ç”Ÿæ´»ï¼Œå‰›å¥½é©é€¢æ¬å®¶ï¼Œä¹Ÿæ˜¯å¾¹åº•æ‰“é€ æ–°ç¿’æ…£çš„é–‹ç«¯&lt;/p></description></item><item><title>åˆè©¦ Terraform - åŸºæœ¬ä»‹ç´¹èˆ‡ç”¨ç¨‹å¼ç¢¼éƒ¨ç½² Lambda (ä¸‹)</title><link>https://yuanchieh.page/posts/2019/2019-11-04-%E5%88%9D%E8%A9%A6-terraform-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E8%88%87%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%83%A8%E7%BD%B2-lambda-%E4%B8%8B/</link><pubDate>Mon, 04 Nov 2019 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-11-04-%E5%88%9D%E8%A9%A6-terraform-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E8%88%87%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%83%A8%E7%BD%B2-lambda-%E4%B8%8B/</guid><description>&lt;h1 id="ä»‹ç´¹">ä»‹ç´¹&lt;/h1>
&lt;p>&lt;a class="link" href="https://yuanchieh.page/post/2019-10-31_try-terraform/" target="_blank" rel="noopener"
>ä¸Šä¸€ç¯‡&lt;/a>å®Œæˆäº†ç”¨ Terraform å¯¦ä½œå–®ä¸€å€åŸŸå®šæ™‚åŸ·è¡Œ Lambda çš„éƒ¨ç½²ï¼Œé€™ä¸€ç¯‡å°‡è½‰æˆ moduleï¼Œä¸¦ä½¿ç”¨ for loop / if conditionï¼Œä¸€æ¬¡éƒ¨ç½²åˆ°å¤šå€‹å€åŸŸï¼ŒåŒæ™‚æ¢ç´¢ Terraform æœ¬æ¬¡æ•™å­¸æ²’æœ‰ç”¨åˆ°å»ä¹Ÿå€¼å¾—ç•™æ„çš„åŠŸèƒ½&lt;/p>
&lt;h1 id="module---æ¨¡çµ„åŒ–">Module - æ¨¡çµ„åŒ–&lt;/h1>
&lt;p>å…ˆå‰æåˆ°ï¼Œåªè¦åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹ï¼Œä»»ä½•çš„ &lt;code>*.tf&lt;/code> æª”æ¡ˆéƒ½æ˜¯ root moduleï¼Œåœ¨ &lt;code>$terraform apply&lt;/code> æ™‚éƒ½æœƒè¢«åŸ·è¡Œï¼›&lt;br>
å¦‚æœè¦ç¨ç«‹å‡ºå€‹åˆ¥çš„æ¨¡çµ„ï¼Œå¯ä»¥æ”¾åœ¨ä¸åŒå°ˆæ¡ˆä¸‹ï¼Œé€éæ”¾åœ¨ githubã€s3 ç­‰ remote æ–¹å¼è¼‰å…¥ï¼Œåˆæˆ–æ˜¯å–®ç´”ç¨ç«‹å‡ºä¸€å€‹è³‡æ–™å¤¾æ”¾ç½®ï¼Œç”¨è·¯å¾‘çš„æ–¹å¼è¼‰å…¥ï¼Œå…ˆé‡æ•´åŸæœ¬çš„å°ˆæ¡ˆè³‡æ–™å¤¾æ¶æ§‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- main.tf // é€²å…¥é»
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- input.tf // å®šç¾©åƒæ•¸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- output.tf // å®šç¾©è¼¸å‡º
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- modules // å­˜æ”¾æ‰€æœ‰çš„è·¯å¾‘
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- lambda-api-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- main.tf // module çš„é€²å…¥é»
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- input.tf // module input
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- lambda-function.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ... ä¸Šä¸€ç¯‡æ‰€æœ‰çš„è³‡æ–™
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- global.tf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡æ–°æ€è€ƒä¹‹å¾Œè¦éƒ¨ç½²çš„æ¶æ§‹ï¼Œ&lt;code>global&lt;/code> ç”¨ä¾†å­˜æ”¾å…¨åŸŸçš„è³‡æºï¼Œä¾‹å¦‚èªª IAM Role / DNS ç­‰è³‡æºï¼Œé€™éƒ¨åˆ†æœƒéœ€è¦å…ˆè¢«å‰µç«‹ï¼Œæ–¹ä¾¿å¾ŒçºŒçš„è³‡æºç¶å®šï¼›&lt;/p>
&lt;p>æ¥è‘—æŠŠå„å€åŸŸç›¸åŒçš„æ¶æ§‹åŒ…æˆ module æ”¾ç½®åœ¨ modules åº•ä¸‹ï¼Œç¨‹å¼ç¢¼ç§»é™¤ IAM è³‡æºï¼Œå…¶é¤˜å¤§å¤šé›·åŒï¼Œåªæ˜¯è¦æ³¨æ„å¦‚æœæœ‰ç”¨åˆ° file ç›¸é—œçš„åƒæ•¸ï¼Œè¦æ”¹è®Šè·¯å¾‘ä½ç½®ç‚º &lt;code>${path.module}&lt;/code>ï¼Œå¦å‰‡æœƒæ‰¾ä¸åˆ°è³‡æºï¼›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_layer_version&amp;#34; &amp;#34;lambda-layer_fetch&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> filename&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${path.module}/lambda_layer_payload.zip&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> layer_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;lambda_layer_name&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> source_code_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${filebase64sha256(&amp;#34;${path.module}/lambda_layer_payload.zip&amp;#34;)}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> compatible_runtimes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;nodejs10.x&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¦å¼•ç”¨ moduleï¼Œä¹Ÿå°±æ˜¯ &lt;code>./main.tf&lt;/code> çš„å…§å®¹ç‚º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">locals&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> region&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;us-east-1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">provider&lt;/span> &lt;span class="s2">&amp;#34;aws&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> region&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${locals.region}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">module&lt;/span> &lt;span class="s2">&amp;#34;lambda-api-test_us-west-2&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> source&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;./modules/lambda-api-test&amp;#34;&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # depends_on = [&amp;#34;aws_iam_role.iam_for_lambda&amp;#34;]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> region&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${local.region}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> lambda_variables-SLACK_URL&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;slack url&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> iam_role_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">lambda_role_name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®£å‘Š module ä¸¦é€éç›¸å°è·¯å¾‘æŒ‡å®š sourceï¼Œå…¶é¤˜çš„åƒæ•¸å°æ‡‰ module çš„ inputï¼›&lt;br>
è¦æ³¨æ„ç›®å‰ v0.12 &lt;code>module ä¸æ”¯æ´ depends_on&lt;/code>ï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ IAM Role å‰µç«‹è¦ç¨ç«‹åˆ° global.tf å…ˆåŸ·è¡Œï¼Œä¸ç„¶ç›®å‰ç„¡æ³•å…ˆå»ºç«‹ IAM Role å†å»ºç«‹ module&lt;/p>
&lt;h3 id="locals">locals&lt;/h3>
&lt;p>locals ç”¨ä¾†å®£å‘Šå€åŸŸè®Šæ•¸ï¼Œå°±åƒæ˜¯å¯«ç¨‹å¼ä¸­åƒ…ç”¨æ–¼é™å®šç¯„åœå…§çš„è®Šæ•¸ï¼Œå¾ŒçºŒé€é &lt;code>local.{var}&lt;/code> å–ç”¨&lt;/p>
&lt;h1 id="data-source">data source&lt;/h1>
&lt;p>å¦‚æœæœ‰éœ€è¦è·¨æª”æ¡ˆè·¯å¾‘å­˜å–è³‡æºï¼Œåˆæˆ–æ˜¯è®€å–æŸäº›è³‡æ–™ä¾‹å¦‚ AWS æ‰€æœ‰çš„å¯éƒ¨ç½²å€åŸŸåˆ—è¡¨ï¼Œåˆæˆ–æ˜¯åŸ·è¡ŒæŸäº›æŒ‡ä»¤å¦‚å‘¼å« lambdaï¼Œå¯ä»¥å®£å‘Š data sourceï¼›&lt;br>
data source è·Ÿ resource æœ€å¤§å·®åˆ¥æ˜¯ data source æ˜¯&lt;code>å”¯è®€&lt;/code>ï¼Œä¸¦å¤§å¤šæ•¸åŸ·è¡Œæ–¼ apply éšæ®µä¹‹å‰ï¼Œå¾ŒçºŒçš„è³‡æºå»ºç«‹éƒ½å¯ä»¥ä½¿ç”¨ï¼›&lt;br>
è€Œ resource å‰‡æ˜¯æœƒè¢« &lt;code>$terraform&lt;/code> æŒ‡ä»¤å½±éŸ¿è€Œå¢åŠ ã€åˆªé™¤ã€ä¿®æ”¹è³‡æºã€‚&lt;/p>
&lt;p>çœ‹åˆ° data source è®“æˆ‘ååˆ†çš„èˆˆå¥®! å› ç‚ºé€™ä»£è¡¨æˆ‘å€‘æœ‰æ›´å¥½çš„æ–¹å¼èˆ‡&lt;code>æ—¢æœ‰çš„æ¶æ§‹å…±å­˜&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>å¦‚æœä½ æ“”å¿ƒå°å…¥ Terraform æœƒä¸å°å¿ƒç ´å£ç¾æœ‰çš„æ¶æ§‹ï¼Œå¯ä»¥é€é data source å»æ“·å–é‡è¦çš„è³‡æ–™åŒæ™‚ä¿è­‰ Terraform ä¸æœƒä¿®æ”¹æˆ–æ˜¯åˆªé™¤ï¼Œä¾‹å¦‚èªª DNSè¨­å®šã€IAM Role ç­‰ç­‰&lt;/p>
&lt;/blockquote>
&lt;p>data source å€‹åˆ¥å–ç”¨æ–¹å¼å¯ä»¥æŸ¥æ–‡ä»¶ï¼Œæœ€åŸºæœ¬å°±æ˜¯ç”¨ name ç•¶ä½œæœå°‹ä¾æ“šï¼Œä¾‹å¦‚èªªæˆ‘åœ¨ &lt;code>./module/lambda-api-test/main.tf&lt;/code> å¸Œæœ›å­˜å– &lt;code>./global/global.tf&lt;/code> æˆ–æ˜¯ä¸å­˜åœ¨æ–¼ terraform å°ˆæ¡ˆä¸‹çš„ IAM Roleï¼Œå¯ä»¥ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># data &amp;#34;è³‡æºé¡å‹&amp;#34; &amp;#34;è³‡æºåç¨±&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># { æœå°‹æ¢ä»¶èˆ‡åƒæ•¸ }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">data&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_role&amp;#34; &amp;#34;iam_for_lambda&amp;#34;&lt;/span>{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;iam_role_name&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å­˜å–ç¤ºç¯„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_function&amp;#34; &amp;#34;lambda_main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> role&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${data.aws_iam_role.iam_for_lambda.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>data source ä¹Ÿæ˜¯ç”¨ä¾†è·¨ module é–“å‚³éè³‡æºçš„æ–¹æ³•ï¼Œä½†è¦è‡ªå·±é‡æ¸… module çš„å…ˆå¾Œé †åº&lt;/p>
&lt;h1 id="æ¢ä»¶å¼---for--if">æ¢ä»¶å¼ - for / if&lt;/h1>
&lt;p>HCL æ˜¯å€‹å®£å‘Šå¼èªè¨€ï¼Œè®“æˆ‘å€‘å¯ä»¥ç”¨ high level æ–¹å¼å®£å‘Šæˆ‘å€‘çš„æ„åœ–ï¼Œè‡³æ–¼å¦‚ä½•å¯¦ä½œå°±ä¸ç”¨æˆ‘å€‘æ“å¿ƒï¼›&lt;br>
ä½†è·Ÿç¨‹åºå¼èªè¨€æ¯”èµ·ä¾†ï¼Œæ¢ä»¶åˆ¤æ–·èˆ‡è¿´åœˆç­‰é‚è¼¯åˆ¤æ–·èˆŠæ²’æœ‰å¦‚æ­¤çš„æ–¹ä¾¿ï¼Œä¸é HCL é‚„æ˜¯æ”¯æ´åŸºæœ¬çš„æ¢ä»¶åˆ¤æ–·èªæ³•ï¼Œé›–ç„¶æ²’é€™éº¼ç›´è§€ï¼Œä½†é‚„æ˜¯æœ‰è¾¦æ³•æ»¿è¶³å¤§å¤šæ•¸çš„æ‡‰ç”¨å ´æ™¯&lt;/p>
&lt;h1 id="count">count&lt;/h1>
&lt;p>count æ˜¯æœ€æ—©æ”¯æ´çš„èªæ³•ï¼Œä¸»è¦æ˜¯é‡è¤‡å‰µå»ºè³‡æºï¼Œé€é &lt;code>count.index&lt;/code> å–å¾—ç•¶ä¸‹ interation çš„ index&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_user&amp;#34; &amp;#34;example&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;neo.${count.index}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå¯ä»¥æ­é… listï¼Œå‹•æ…‹èª¿æ•´è®Šæ•¸&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">variable&lt;/span> &lt;span class="s2">&amp;#34;user_names&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Create IAM users with these names&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> default&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;neo&amp;#34;, &amp;#34;trinity&amp;#34;, &amp;#34;morpheus&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_user&amp;#34; &amp;#34;example&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">length&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">user_names&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">user_names&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">index&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæƒ³è¦ access è³‡æºçš„è¼¸å‡ºï¼Œå¯ä»¥é€é &lt;code>[index/*]&lt;/code> æ–¹å¼å–å¾—&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">output&lt;/span> &lt;span class="s2">&amp;#34;all_arns&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">aws_iam_user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">example&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">*&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="k">arn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;The ARNs for all users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>count æ­é…ä¸‰å…ƒé‹ç®—å¼ï¼Œå°±è®Šæˆäº†ç¾æˆçš„ if/else&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_user_policy_attachment&amp;#34; &amp;#34;neo_cloudwatch_full&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">give_neo_cloudwatch_full_access&lt;/span> &lt;span class="err">?&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="err">:&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="count-é™åˆ¶">count é™åˆ¶&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>ä¸èƒ½ç”¨æ–¼ inline block&lt;/strong>&lt;br>
æœ‰äº› resource æœ‰ inline blockï¼Œä¾‹å¦‚ auto scaling group å¯ä»¥æŒ‡å®š tagï¼Œæ­¤æ™‚çš„ tag ä¸èƒ½ä½¿ç”¨ count&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_autoscaling_group&amp;#34; &amp;#34;example&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">tag&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">ç„¡æ³•ä½¿ç”¨&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>&lt;strong>æ¡ç”¨ list æ™‚çš„å…ƒç´ å¢æ¸›&lt;/strong>&lt;br>
å¦‚æœå‰µå»ºè³‡æºæ™‚æ˜¯ç”¨ list æ­é… countï¼Œå¿…é ˆæ³¨æ„ Terraform åœ¨å¾ŒçºŒæ›´æ–°è³‡æºæ™‚æ˜¯èªå®š list index è€Œéå…ƒç´ æœ¬èº«&lt;/li>
&lt;/ol>
&lt;p>ä¾‹å¦‚åŸæœ¬æ˜¯ [&amp;rsquo;ele1&amp;rsquo;, &amp;rsquo;ele2&amp;rsquo;, &amp;rsquo;ele3&amp;rsquo;]ï¼Œæ­¤æ™‚å¸Œæœ›åˆªé™¤ ele2ï¼Œè®Šæˆ [&amp;rsquo;ele1&amp;rsquo;, &amp;rsquo;ele3&amp;rsquo;]&lt;br>
ä½†æ˜¯ Terraform æœƒè§£è®€æˆ &lt;code>åˆªé™¤ ele3ï¼Œä¸¦æ›´æ–° ele2 æˆ ele3&lt;/code>ï¼Œé€™ä¸€é»å¿…é ˆç‰¹åˆ¥æ³¨æ„ï¼Œä¸ç„¶å°±è¦ä½¿ç”¨å…¶ä»–çš„è¿´åœˆæ–¹å¼&lt;/p>
&lt;h1 id="for_each">for_each&lt;/h1>
&lt;p>for_each æ˜¯åœ¨ 0.12 åŠ å…¥ï¼Œå¯ä»¥è¼ªè©¢æŒ‡å®šçš„ collectionï¼Œä¸¦æ”¯æ´ inline block!&lt;br>
å¦‚æœ collection ç‚ºç©ºå€¼å‰‡æ•ˆæœç­‰åŒæ–¼ count = 0&lt;/p>
&lt;blockquote>
&lt;p>å¦‚æœå¤šå€‹ resource æœ¬èº«è¿‘ä¹ä¸€è‡´å¯ä»¥ç”¨ countï¼Œä½†å¤§å¤šæ•¸æƒ…æ³è«‹ç”¨ for_each&lt;/p>
&lt;/blockquote>
&lt;p>é…åˆ &lt;code>dynamic&lt;/code> å°±å¯ä»¥ç”¨æ–¼ inline blockï¼Œä»¥ä¸‹æ˜¯å»ºç«‹ security group æ™‚æŒ‡å®š ingress å¤šçµ„ port&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_security_group&amp;#34; &amp;#34;example&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;example&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">dynamic&lt;/span> &lt;span class="s2">&amp;#34;ingress&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> for_each&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">service_ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">content&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> from_port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">ingress&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> to_port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">ingress&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> protocol&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;tcp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>for_each ä¹Ÿå¯ä»¥æ­é… map ä½¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;azurerm_resource_group&amp;#34; &amp;#34;rg&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> for_each&lt;/span> &lt;span class="o">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> a_group&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;eastus&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> another_group&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;westus2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€é &lt;code>each åŠ ä¸Š key, value&lt;/code> å–å¾—éœ€è¦çš„å€¼&lt;/p>
&lt;h1 id="warning">Warning!&lt;/h1>
&lt;p>ç›®å‰ Terraform é‚„æœ‰å¹¾å€‹ä¸æ”¯æ´çš„åŠŸèƒ½ï¼Œä¾‹å¦‚èªª &lt;code>provider ä¸æ”¯æ´è®Šæ•¸&lt;/code>ã€&lt;code>module ä¸æ”¯æ´ depends_on&lt;/code>ã€&lt;code>module ä¸æ”¯æ´ for loop&lt;/code>&lt;/p>
&lt;p>é€™ä¸‰å€‹åŠŸèƒ½ä¸æ”¯æ´è®“ multiple region éƒ¨ç½²æ™‚ç›¸ç•¶ä¸æ–¹ä¾¿ï¼Œ&lt;code>module æ”¯æ´ for loop&lt;/code> æœ‰åœ¨æ¥ä¸‹ä¾†çš„ Terraform roadmap ä¸­ï¼Œä½†é‚„ä¸ç¢ºå®šä½•æ™‚æœƒæ”¯æ´&lt;/p>
&lt;p>å¦åœ¨ Refactor æ™‚å‹™å¿…æ³¨æ„ï¼Œä¾‹å¦‚èªª resource name æ›´æ–°ï¼ŒTerraform å¤§å¤šæ•¸æœƒåˆªé™¤èˆŠè³‡æ–™ä¸¦é‡å»ºæ–°è³‡æ–™ï¼Œå³ä½¿æ”¹å€‹åç¨±è€Œå·²ï¼Œæ‰€ä»¥å‹™å¿…è¦ä»”ç´°çœ‹ &lt;code>$ terraform plan&lt;/code> çš„çµæœï¼Œé¿å…é€ æˆä¸å¿…è¦çš„ downtime&lt;/p>
&lt;p>æˆ–æ˜¯æœ‰å¹¾å€‹æ–¹å¼å¯ä»¥é¿å… downtime&lt;/p>
&lt;ol>
&lt;li>&lt;strong>ä¿®æ”¹ lifecycle ç‚º create_before_destroy&lt;/strong> &lt;br>
æ¯å€‹ resource å¯ä»¥æŒ‡å®š lifecycleï¼Œ&lt;code>create_before_destroy&lt;/code> æœƒå…ˆå‰µå»ºæ–°è³‡æºå†åˆªé™¤èˆŠè³‡æºï¼Œé¿å… downtime&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;azurerm_resource_group&amp;#34; &amp;#34;example&amp;#34;&lt;/span> {&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">lifecycle&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> create_before_destroy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä»– lifecycle é‚„æœ‰ &lt;code>prevent_destroy&lt;/code> ä¸æœƒTerraform è¢«åˆªé™¤ ä»¥åŠ &lt;code>ignore_changes&lt;/code> æŒ‡å®šæŸäº›å±¬æ€§æ›´æ–°ä¸è§¸ç™¼ Terraform æ›´æ–°è³‡æº
2. &lt;strong>ä½¿ç”¨ Terraform CLI æ”¹è®Š state&lt;/strong> &lt;br>
åƒæ˜¯è¦ä¿®æ”¹ resource åç¨±ï¼Œå¯ä»¥é€éä¿®æ”¹ state è€Œéè³‡æºæœ¬èº«å³å¯ &lt;code>$ terraform state mv&lt;/code>ï¼Œç›¡é‡é€éæŒ‡ä»¤å»ä¿®æ”¹ stateï¼Œè€Œä¸æ˜¯æ‰‹å‹•ç›´æ¥æ”¹ tfstate&lt;/p>
&lt;h1 id="çµèª">çµèª&lt;/h1>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/terraform-investigation" target="_blank" rel="noopener"
>å®Œæ•´ç¨‹å¼ç¢¼&lt;/a>ï¼Œå¾Œä¾†æ±ºå®šå°‡ä¸Šä¸€ç¯‡çš„å…§å®¹æ•´ç†æˆ moduleï¼Œæ¥è‘— iam role éƒ¨åˆ†ç¨ç«‹å‡ºä¾†å‰µç«‹ï¼Œæ¥è‘—ç”¨ &lt;code>data source&lt;/code> æ–¹å¼å¼•å…¥ï¼›&lt;br>
å¤šå€åŸŸéƒ¨ç½²å¥—ç”¨ &lt;code>module&lt;/code> ç¨ç«‹å®£å‘Šï¼Œå¯æƒœ for_each å°šæœªæ”¯æ´ module&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ slack çš„ log ç•«é¢&lt;br>
&lt;img src="https://yuanchieh.page/post/img/20191104_slack_result.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å°æ–¼å°å…¥ Terraform è©•ä¼°è »æ­£é¢çš„ï¼Œä¸€ä¾†æœ‰ data source æˆ– import èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆï¼Œåˆå¯ä»¥ä¸æ“”å¿ƒæçˆ›æ•´å€‹æ¶æ§‹ï¼›&lt;br>
äºŒä¾†èªæ³•éƒ½æ…¢æ…¢å®Œæ•´ï¼Œå¯ä»¥æ‡‰ä»˜å¤§å¤šæ•¸çš„å ´æ™¯ï¼Œç¢ºå¯¦çœä¸‹å¾ˆå¤šçš„ç®¡ç†ä¸Šçš„å¿ƒåŠ›ï¼ŒæœŸå¾…ä¹‹å¾Œå¯ä»¥ç”¨ Terraform æ•´åˆ Kubernetesï¼Œä¸¦æ•´åˆ CI/CDï¼Œè®“é–‹ç™¼ã€æ•´åˆã€éƒ¨ç½²ã€ç¶­é‹å¯ä»¥æ›´é †æš¢&lt;/p>
&lt;p>æ¥ä¸‹ä¾†è¦ç¹¼çºŒç†Ÿç·´ Terraformï¼Œå¸Œæœ›æŒ‘æˆ°æ•´åˆ Docker çš„è·¨å€åŸŸè·¨ Provider éƒ¨ç½²&lt;/p></description></item><item><title>åˆè©¦ Terraform - åŸºæœ¬ä»‹ç´¹èˆ‡ç”¨ç¨‹å¼ç¢¼éƒ¨ç½² Lambda (ä¸Š)</title><link>https://yuanchieh.page/posts/2019/2019-10-30-%E5%88%9D%E8%A9%A6-terraform-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E8%88%87%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%83%A8%E7%BD%B2-lambda-%E4%B8%8A/</link><pubDate>Wed, 30 Oct 2019 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-10-30-%E5%88%9D%E8%A9%A6-terraform-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E8%88%87%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%83%A8%E7%BD%B2-lambda-%E4%B8%8A/</guid><description>&lt;h1 id="ä»‹ç´¹">ä»‹ç´¹&lt;/h1>
&lt;p>Terraform åœ¨ Github ä¸Šæœ‰ä¸€è¬ä¹åƒå¤šé¡†æ˜Ÿæ˜Ÿ(æˆªè‡ªç™¼æ–‡æ—¥)çš„é–‹æºå°ˆæ¡ˆï¼Œç”± HashiCorp é€™é–“å°ˆæ³¨æ–¼ DevOps å·¥å…·é–‹ç™¼çš„å…¬å¸æ‰€ç¶­è­·ï¼Œä¸»è¦é€é DSL ç·¨å¯«å®šç¾©æª”ï¼Œç®¡ç†è·¨é›²ç«¯æ¶æ§‹ï¼Œè®“æ¶æ§‹ä¹Ÿå¯ä»¥ç¨‹å¼ç¢¼åŒ–ï¼Œè¿‘ä¸€æ­¥æ›´å¥½çš„&lt;code>å”ä½œ&lt;/code>ã€&lt;code>ç‰ˆæœ¬æ§åˆ¶&lt;/code>ç­‰å¥½è™•ï¼Œé”åˆ° Infrastructure as code çš„ç›®æ¨™ã€‚&lt;/p>
&lt;p>Terraform å¯ä»¥é”åˆ°ä»¥ä¸‹å¹¾ä»¶äº‹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>æ¶æ§‹ä»£ç¢¼åŒ–&lt;/strong>&lt;br>
Terraform æ¡ç”¨å®£å‘Šå¼ç¨‹å¼èªè¨€(declarative language)çš„ DSLï¼Œä½†åŒæ¨£æä¾›åŸºç¤çš„ç¨‹å¼èªè¨€è©²æœ‰çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è®Šæ•¸ã€è¼¸å…¥è¼¸å‡ºã€æ¨¡çµ„åŒ–ç­‰ï¼Œå…¶ä¸­æ¨¡çµ„åŒ–ä¹Ÿæ”¯æ´åŠ è¼‰å¤–éƒ¨æ¨¡çµ„ï¼Œä¸ç”¨æ“”å¿ƒé•å DRYï¼Œå…§å»ºä¸€äº›å‡½ç¤ºä¹Ÿéƒ½å¾ˆå¥½ç”¨ï¼›
ç•¶ä½ æœ‰å¤šå€‹ç’°å¢ƒè¦éƒ¨ç½²æ™‚ï¼Œå¯ä»¥ç”¨åŒæ¨£çš„æ¶æ§‹ä½†æ˜¯ä¸åŒçš„æ©Ÿå™¨è¦æ ¼èˆ‡åƒæ•¸ï¼Œç®¡ç†ä¸Šå¾ˆæ–¹ä¾¿&lt;/li>
&lt;li>&lt;strong>è·¨å¹³å°æœå‹™&lt;/strong>&lt;br>
Azure / GCP / AWS / Heroku éƒ½å¯ä»¥ï¼Œå…¶ä»–çš„å·¥å…·åŒ…å±±åŒ…æµ·ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶ &lt;a class="link" href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener"
>Providers&lt;/a>&lt;/li>
&lt;li>&lt;strong>è‡ªå‹•ç®¡ç†æ¶æ§‹å‡ç´š&lt;/strong>&lt;br>
æ¶æ§‹ç•°å‹•æ™‚ï¼ŒTerraform æœƒè‡ªå‹•æ›´æ–°æˆ–æ›¿æ›æ­£ç¢ºçš„è³‡æºï¼ŒåŒæ™‚ä¹Ÿå¯ä»¥ä¸€éµåˆªé™¤&lt;/li>
&lt;li>&lt;strong>åœ˜éšŠå”ä½œ&lt;/strong>&lt;br>
æä¾›å¤šæ¨£çš„è§£æ±ºæ–¹æ¡ˆï¼Œå¯ä»¥ç”¨å®˜æ–¹çš„ Terraform Cloud æˆ– AWS S3 ç­‰ï¼Œåœ¨åœ˜éšŠå…§å…±åŒç®¡ç†&lt;/li>
&lt;li>&lt;strong>èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆ&lt;/strong>&lt;br>
Terraform æä¾›å…©ç¨®æ–¹å¼èˆ‡æ—¢æœ‰æ¶æ§‹æ•´åˆï¼Œä¸€æ˜¯ç¶­æŒå”¯è®€å‹æ…‹åªå­˜å–è³‡æº(ä¾‹å¦‚è®€ AWS arn ç¶å®šåˆ° Lambda ä¸Š)ã€äºŒæ˜¯ Import è³‡æºä¸€ä¸¦ç”± Terraform ç®¡ç†(å¢åŠ ã€åˆªé™¤ã€ä¿®æ”¹)&lt;/li>
&lt;li>&lt;strong>DX å¾ˆå¥½&lt;/strong>&lt;br>
Developer Experience é‚„ä¸è³´ï¼Œå®˜æ–¹çš„æ–‡ä»¶ã€æ•™å­¸ï¼Œä»¥åŠæ•´é«”çš„è¨­è¨ˆä¸Šéƒ½å¾ˆå‹å–„ï¼ŒéŒ¯èª¤ä¹Ÿæœƒå¾ˆç›´æ¥é¡¯ç¤ºå“ªä¸€è¡Œçš„å“ªä¸€éƒ¨åˆ†èªæ³•éŒ¯èª¤ï¼Œå­¸ç¿’ä¸Š Debug ä¸Šéƒ½å¾ˆå®¹æ˜“ï¼ŒHashiCorp å“¡å·¥æœ‰åˆ†äº«é€™æ˜¯ä»–å€‘åœ¨ 0.12 å¾ˆå¤§çš„ä¿®æ­£ï¼Œè®“ç”¨æˆ¶æ›´å¿«æ‰¾å‡ºéŒ¯èª¤æ˜¯ä»–å€‘é‡è¦–çš„ä¸€ç’°&lt;/li>
&lt;/ol>
&lt;p>é€™æ¬¡ç›®æ¨™è·Ÿä¸Šæ¬¡çš„ CDK ç ”ç©¶ä¸€æ¨£ï¼Œéƒ¨ç½²ä¸€å€‹æ¯äº”åˆ†é˜åŸ·è¡Œçš„ Lambdaï¼Œä¸¦åˆ†ä½ˆåˆ°å¤šå€‹å€åŸŸï¼ŒCDK æ•™å­¸é€£çµ &lt;a class="link" href="https://yuanchieh.page/post/2019-01-27_aws-cdk-infrastructore-as-code/" target="_blank" rel="noopener"
>AWS-CDKæ•™å­¸â€Šâ€”â€ŠInfrastructore As Code ç”¨ç¨‹å¼ç¢¼ç®¡ç†æ¶æ§‹&lt;/a>&lt;/p>
&lt;h1 id="äº‹å‰æº–å‚™">äº‹å‰æº–å‚™&lt;/h1>
&lt;p>è«‹å…ˆå®‰è£ Terraformï¼Œä¸¦è¨­å®šå¥½ AWS configurationï¼Œä¹Ÿå¯ä»¥å…ˆç©éå®˜æ–¹æ•™å­¸ &lt;a class="link" href="https://learn.hashicorp.com/terraform/getting-started/intro" target="_blank" rel="noopener"
>Terraform getting started&lt;/a>ï¼›
å¦ä¸€å€‹å¾ˆæ£’çš„åƒè€ƒè³‡æ–™ &lt;a class="link" href="https://blog.gruntwork.io/an-introduction-to-terraform-f17df9c6d180" target="_blank" rel="noopener"
>An Introduction to Terraform&lt;/a>ï¼Œç³»åˆ—æ–‡è¶…ä»”ç´°ä¹Ÿè¶…å¯¦ç”¨ï¼Œæ¯”å®˜æ–¹æ–‡ä»¶é‚„æ¨è–¦ï¼Œä½œè€…ä¹Ÿæœ‰å‡ºæ›¸ï¼Œæœ‰æ©Ÿæœƒæ‡‰è©²æœƒå…¥æ‰‹&lt;/p>
&lt;h1 id="éƒ¨ç½²å–®å€åŸŸçš„-lambda-èˆ‡-iam-role">éƒ¨ç½²å–®å€åŸŸçš„ Lambda èˆ‡ IAM Role&lt;/h1>
&lt;p>å‰µå»ºä¸€å€‹æª”æ¡ˆï¼Œå…ˆå‘½åç‚º &lt;code>main.tf&lt;/code> ï¼Œåœ¨ Terraform ä¸­æª”æ¡ˆåˆ†æˆ &lt;code>root module&lt;/code> èˆ‡ &lt;code>module&lt;/code>ï¼Œæ²’æœ‰ç‰¹åˆ¥å®£å‘Šæ˜¯ module å‰‡ç‚º root moduleï¼Œç›®éŒ„ä¸‹å¯ä»¥æœ‰å¤šå€‹ root moduleï¼Œæª”æ¡ˆåç¨±æ²’æœ‰é€²å…¥é»å•é¡Œï¼Œåªè¦çµå°¾æ˜¯ &lt;code>.tf&lt;/code> å³å¯&lt;/p>
&lt;p>é¦–å…ˆç¬¬ä¸€æ­¥ï¼Œå…ˆéƒ¨ç½²å–®ä¸€å€åŸŸçš„ Lambdaï¼Œèˆ‡å»ºç«‹å°æ‡‰éœ€è¦çš„ IAM Roleï¼Œä»¥ä¸‹ç¨‹å¼ç¢¼ä¸»è¦åšå¹¾ä»¶äº‹&lt;/p>
&lt;ol>
&lt;li>å®£å‘Š aws éƒ¨ç½²çš„å€åŸŸ&lt;/li>
&lt;li>å»ºç«‹æ–°çš„ IAM role å‘½åç‚º iam_for_lambdaï¼Œä¸¦çµ¦äºˆèª¿ç”¨ lambda çš„æ¬Šé™&lt;/li>
&lt;li>å»ºç«‹ IAM Policy å‘½åç‚º lambda_loggingï¼Œçµ¦äºˆ Cloudwatch log æ¬Šé™&lt;/li>
&lt;li>å°‡ IAM Policy è³¦äºˆ IAM roleï¼Œlambda_logging çµ¦ iam_for_lambda&lt;/li>
&lt;li>ç­‰ç­‰ Lambda æœƒç”¨åˆ°ä¸€äº› node_modulesï¼Œå»ºç«‹ Lambda layer å‘½åç‚º lambda-layer_fetch&lt;/li>
&lt;li>å»ºç«‹ Lambda function aws_lambda_functionï¼Œç¶å®š lambda-layer_fetch èˆ‡åŸ·è¡Œè§’è‰² iam_for_lambda&lt;/li>
&lt;/ol>
&lt;p>å¯«å®Œä»‹ç´¹ï¼Œå‰›å¥½ä¸€æ­¥å°ç…§ä¸€å¡Šç¨‹å¼ç¢¼ï¼Œå¦‚æœå° AWS æœ‰é»ç†Ÿæ‚‰çš„äººæ‡‰è©²å¯ä»¥å¾ˆå¿«ç†è§£èªæ³•ï¼Œå°¤å…¶æ˜¯è®Šæ•¸å‘½åè·Ÿå¾Œå°è¨­å®šå¾ˆé›·åŒï¼Œæ‰€ä»¥ä¸Šæ‰‹ç›¸ç•¶è¼•é¬†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æŒ‡å®šå¾ŒçºŒè³‡æºçš„æä¾›è€…æ˜¯å“ªå€‹å¹³å°çš„å“ªå€‹å€åŸŸ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># provider æ²’æœ‰æŒ‡å®š alias ä»£è¡¨ç‚ºé è¨­ provider
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">provider&lt;/span> &lt;span class="s2">&amp;#34;aws&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> region&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;us-east-1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å»ºç«‹ IAM roleï¼Œå–åç‚º iam_for_lambda
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_role&amp;#34; &amp;#34;iam_for_lambda&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;iam_for_lambda&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> assume_role_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Action&amp;#34;: &amp;#34;sts:AssumeRole&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Principal&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Service&amp;#34;: &amp;#34;lambda.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Sid&amp;#34;: &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å»ºç«‹ IAM Policyï¼Œä¸»è¦çµ¦ Cloudwatch Log æ¬Šé™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_policy&amp;#34; &amp;#34;lambda_logging&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;lambda_logging&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;IAM policy for logging from a lambda&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:CreateLogGroup&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:CreateLogStream&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:PutLogEvents&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:logs:*:*:*&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_role_policy_attachment&amp;#34; &amp;#34;lambda_logs&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> role&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_iam_role.iam_for_lambda.name}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> policy_arn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_iam_policy.lambda_logging.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_layer_version&amp;#34; &amp;#34;lambda-layer_fetch&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> filename&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;./lambda_layer_payload.zip&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> layer_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;lambda_layer_name&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> source_code_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${filebase64sha256(&amp;#34;lambda_layer_payload.zip&amp;#34;)}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> compatible_runtimes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;nodejs10.x&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_function&amp;#34; &amp;#34;lambda_main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> function_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;global-api-lantency-test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> filename&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;./lambda_payload.zip&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> handler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;index.handler&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> runtime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;nodejs10.x&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> role&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_iam_role.iam_for_lambda.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> source_code_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${filebase64sha256(&amp;#34;lambda_payload.zip&amp;#34;)}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> layers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;${aws_lambda_layer_version.lambda-layer_fetch.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> publish&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">environment&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> variables&lt;/span> &lt;span class="o">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> REGION&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;us-east-1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> SLACK_URL&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;https://hooks.slack.com/services/.....&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="provider">Provider&lt;/h3>
&lt;p>æŒ‡å®šè³‡æºæ˜¯å¥—ç”¨åœ¨å“ªå€‹å¹³å°ï¼Œç›®å‰æ˜¯æŒ‡å®šåœ¨ us-east-1 AWS ä¸Šï¼Œå¦‚æœæ²’æœ‰æŒ‡å®š &lt;code>alias&lt;/code> å‰‡ä»£è¡¨æ˜¯é è¨­çš„ provider&lt;/p>
&lt;h3 id="resource">Resource&lt;/h3>
&lt;p>å‘½åçš„æ–¹å¼æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="k">è³‡æºé¡å‹&lt;/span> &lt;span class="k">è³‡æºåç¨±&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">è³‡æºåƒæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è³‡æºåƒæ•¸å°æ‡‰è³‡æºé¡å‹ï¼Œå¯ä»¥å¾æ–‡ä»¶ä¸­æ‰¾ç¯„ä¾‹èˆ‡å®šç¾©çš„æ–¹å¼ï¼Œè³‡æºçš„å®šç¾©ä¾è³´æ–¼ Provider å¹³å°çš„ä¸åŒï¼Œå¯ä»¥æŒ‡å®š &lt;code>provider&lt;/code>ï¼Œä¸æŒ‡å®šå‰‡ç”¨é è¨­&lt;/p>
&lt;p>é™¤äº†å€‹åˆ¥çš„è³‡æºå®šç¾©å¤–ï¼Œåƒæœ‰äº›è³‡æºæœƒç›¸ä¾ï¼Œä¾‹å¦‚ Lambda è¦ç¶å®šç‰¹å®šçš„ IAM Roleï¼Œæ³¨æ„åˆ°é€™é‚Šçš„å¯«æ³•æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_function&amp;#34; &amp;#34;lambda_main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> role&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_iam_role.iam_for_lambda.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¦å¼•ç”¨å…¶ä»–è³‡æºçš„åƒæ•¸ï¼Œéœ€è¦ç”¨&lt;code>&amp;quot;${è³‡æºé¡å‹.è³‡æºåç¨±.arn}&amp;quot;&lt;/code>ï¼Œarn æ˜¯ AWS ç”¨ä¾†è­˜åˆ¥è³‡æºçš„å…¨åŸŸ IDï¼Œé€éé€™æ¨£çš„æ–¹å¼å°±èƒ½å¤ ç¶å®šè³‡æºï¼Œé€™é‚Šæˆ‘æŒ‡å®šè¦ç”¨ Lambda çš„ Execution Role æ˜¯ iam_for_lambda é€™å€‹ Roleã€‚&lt;br>
å¦å¤–ç‚ºäº†æ•ˆç‡ï¼Œå®šç¾©çš„è³‡æºæœƒä¸¦è¡Œå»ºç«‹ï¼Œä½†æœ‰äº›è³‡æºæœ‰ç›¸ä¾æ€§ï¼ŒTerraform æœƒè‡ªå‹•è™•ç†ç›¸ä¾æ€§ï¼Œæ‰€ä»¥ä¸Šè¿°çš„è³‡æºç†è«–ä¸Šè¦ Policy &amp;gt; Role &amp;gt; Lambda Layer &amp;gt; Lambdaï¼Œä½†æˆ‘å€‘ä¸ç”¨å®£å‘Š Terraform æœƒè‡ªè¡Œè™•ç†ï¼›
ä½†æœ‰æ™‚å€™ç›¸ä¾æ€§ä¸æ˜é¡¯æˆ–æ˜¯æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥é¡¯ç¤ºå®£å‘Š &lt;code>depends_on&lt;/code>ã€‚&lt;/p>
&lt;p>Lambda Function å»ºç«‹å®Œæˆå¾Œï¼Œå¦‚æœåªæ˜¯è¦å–®ç´”æ›´æ”¹ Lambda å…§å®¹è€Œä¸èª¿æ•´æ¶æ§‹ï¼Œå¯ä»¥å®£å‘Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_function&amp;#34; &amp;#34;lambda_main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> source_code_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${filebase64sha256(&amp;#34;lambda_payload.zip&amp;#34;)}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>source_code_hash&lt;/code> æ˜¯æŒ‡èªªå¦‚æœ hash å€¼æ”¹è®Šå°±æ›´æ–° Lambda å…§å®¹ï¼Œè€Œ &lt;code>filebase64sha256()&lt;/code> æ˜¯ Terraform çš„å…§å»ºå‡½ç¤ºï¼Œè‡ªå‹•ç”¨ sha 256 ç®—å‡ºæª”æ¡ˆ hash å€¼ä¸¦ç”¨ base64 ç·¨ç¢¼&lt;/p>
&lt;p>é¡Œå¤–è©±ï¼ŒLambda çš„ zip file è¨˜å¾—è§£å£“ç¸®å¾Œä¸è¦æœ‰é¡å¤–çš„è³‡æ–™å¤¾ï¼Œä¸ç„¶æœƒå¤±æ•—ï¼Œæ­£ç¢ºæ‡‰è©²è¦æ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">--- lambda.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--- index.js
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="éƒ¨ç½²æ¶æ§‹">éƒ¨ç½²æ¶æ§‹&lt;/h1>
&lt;p>ç·¨å¯«å¥½æ¶æ§‹ï¼Œæ­¤æ™‚è¦èª¿ç”¨ Terraform CLI ä¾†éƒ¨ç½²æ¶æ§‹
é¦–å…ˆåˆå§‹åŒ–ç’°å¢ƒèˆ‡è¼‰å…¥éœ€è¦çš„åŸ·è¡Œè³‡æº&lt;/p>
&lt;blockquote>
&lt;p>$ terraform init&lt;/p>
&lt;/blockquote>
&lt;p>ä¸€é–‹å§‹ Terraform ä¸¦ä¸çŸ¥é“å»ºç«‹çš„ Provider æ˜¯èª°ï¼Œç›´åˆ°åˆå§‹åŒ–æ‰æœƒä¸‹è¼‰å°æ‡‰çš„ Libraryï¼Œæ”¾åœ¨å°ˆæ¡ˆè·¯å¾‘åº•ä¸‹çš„ &lt;code>.terraform&lt;/code> è³‡æ–™å¤¾ä¸‹&lt;/p>
&lt;p>æˆåŠŸå¾Œï¼Œå°±å¯ä»¥éƒ¨ç½²æ¶æ§‹äº†&lt;/p>
&lt;blockquote>
&lt;p>$ terraform apply&lt;/p>
&lt;/blockquote>
&lt;p>æ­¤æ™‚ Terraform æœƒåˆ—å‡ºæ›´å‹•çš„è³‡æºï¼Œ&lt;code>+&lt;/code> ä»£è¡¨éœ€è¦æ–°å»ºçš„è³‡æºã€&lt;code>-&lt;/code>ä»£è¡¨æœƒè¢«åˆªé™¤çš„è³‡æºã€&lt;code>~&lt;/code>ä»£è¡¨æœƒè¢«æ›´æ–°çš„è³‡æºï¼Œæ³¨æ„è³‡æºæ›´æ–°å¯æ˜¯åˆªé™¤èˆŠçš„è³‡æºéƒ¨ç½²æ–°çš„è³‡æºï¼Œä¾ç…§å„å®¶ provider çš„ API è€Œæœ‰æ‰€ä¸åŒï¼Œéœ€è¦ç‰¹åˆ¥ç•™æ„
å¦‚æœç¢ºèªå°±è¼¸å…¥ &amp;ldquo;yes&amp;rdquo;ï¼Œç­‰ Terraform å¹«å¿™éƒ¨ç½²&lt;/p>
&lt;p>é€™æ¨£å°±å®Œæˆäº†ï¼Œå¾ŒçºŒæœ‰ä»€éº¼èª¿æ•´å°±é‡è¤‡ &lt;code>$ terraform apply&lt;/code> æ­¥é©Ÿï¼Œå¯ä»¥åˆ° AWS å¾Œå°ç¢ºèªè³‡æºçš„å»ºç«‹ç‹€æ³&lt;/p>
&lt;h1 id="åŠ ä¸Š-cloudwatch">åŠ ä¸Š Cloudwatch&lt;/h1>
&lt;p>é€™ä¸€æ®µé›·åŒï¼Œè£œä¸Š cloudwatch event rule / cloudwatch event targeï¼Œæœ€å¾Œåˆ¥å¿˜äº†è¦åŠ ç¶å®š lambda permission ä¸ç„¶è§¸ç™¼ Lambda æœƒå¤±æ•—&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># add cloudwatch event
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_cloudwatch_event_rule&amp;#34; &amp;#34;every_five_minutes&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;routine-api-request&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Routinely call global api lantency test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> schedule_expression&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;rate(5 minutes)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_cloudwatch_event_target&amp;#34; &amp;#34;api_request&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> rule&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_cloudwatch_event_rule.every_five_minutes.name}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> target_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;CallApiRequest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> arn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_lambda_function.lambda_main.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_lambda_permission&amp;#34; &amp;#34;allow_cloudwatch_to_call_check_api&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> statement_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;AllowExecutionFromCloudWatch&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> action&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;lambda:InvokeFunction&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> function_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_lambda_function.lambda_main.function_name}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> principal&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;events.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> source_arn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${aws_cloudwatch_event_rule.every_five_minutes.arn}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="import-ç¾æœ‰çš„-iam-role">Import ç¾æœ‰çš„ IAM Role&lt;/h1>
&lt;p>å›éé ­èªªä¸€ä¸‹ä¹‹å‰æ¡ç”¨ AWS CDK çš„æœ€å¤§å•é¡Œï¼Œç•¶åˆç ”ç©¶æ™‚æ²’æœ‰çœ‹åˆ° AWS CDK èˆ‡ç¾æœ‰æ¶æ§‹çš„æ•´åˆï¼Œé€™å°è‡´å…¬å¸è¦æ¡ç”¨éœ€è¦å¾ˆå¤§çš„æ±ºå¿ƒï¼Œæˆ–æ˜¯åªèƒ½ç”¨åœ¨æ¸¬è©¦æˆ–æ–°çš„ç’°å¢ƒå»ºè¨­ï¼Œæ²’æœ‰è¾¦æ³• graceful è½‰ç§»ï¼Œé€™é»æˆ‘è¦ºå¾—å°æ–¼è¦å°å…¥æ–°æŠ€è¡“ä¾†èªªï¼Œæœ‰é»éº»ç…©ï¼Œå°¤å…¶æ˜¯æ¶æ§‹é€™éº¼é‡è¦çš„åœ°æ–¹ï¼›&lt;/p>
&lt;p>å¦ä¸€é»æ˜¯è§’è‰²çš„æ¬Šé™ç®¡ç†ï¼Œå…¬å¸éƒ½æœƒæœ‰é‡å°ä¸åŒçš„è·ä½çµ¦äºˆä¸åŒçš„æ¬Šé™ï¼ŒAWS CDK é è¨­å°±è¦ CreateRole ç­‰æ¬Šé™ï¼ŒåŸºæœ¬ä¸Šå¾ˆé›£ç›´æ¥è¦åˆ°é€™éº¼é«˜çš„æ¬Šé™ï¼Œä¹Ÿæ˜¯ç•¶åˆè¦åœ¨å…¬å¸å°ˆæ¡ˆå˜—è©¦ AWS CDK æœ€å¤§å¤±æ•—çš„åŸå› &lt;/p>
&lt;p>Terraform ç¾è¡Œæ”¯æ´ &lt;code>import&lt;/code> æ—¢æœ‰çš„è³‡æºï¼Œä½†æ˜¯è³‡æºå…§å®¹è¦è‡ªå·±å¡«å¯«ï¼Œæœªä¾†å®£ç¨±æœƒæ”¯æ´è‡ªå‹•è¼‰å…¥å…§å®¹ï¼›&lt;br>
&lt;code>existed_role&lt;/code> æ˜¯æˆ‘é å…ˆåœ¨ AWS å‰µå»ºçš„ IAM Roleï¼Œæ¬Šé™è·Ÿä¸Šé¢çš„ &lt;code>iam_for_lambda&lt;/code> ä¸€æ¨£ï¼Œè¨˜å¾—è¦å…ˆåœ¨è¨­å®šæª”å®£å‘Šï¼Œæ¥è‘—åŸ·è¡ŒæŒ‡ä»¤å°±å®Œæˆäº†ï¼Œä¹‹å¾Œ &lt;code>terraform destroy&lt;/code> ä¹Ÿæœƒä¸€ä¸¦åˆªé™¤ (éœ€è¦ç•™æ„)&lt;/p>
&lt;blockquote>
&lt;p>$ terraform import aws_iam_role.existed_role existed_role&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># existed iam role
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_role&amp;#34; &amp;#34;existed_role&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;existed_role&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> assume_role_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Action&amp;#34;: &amp;#34;sts:AssumeRole&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Principal&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Service&amp;#34;: &amp;#34;lambda.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Sid&amp;#34;: &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="variables---æŠ½é›¢åƒæ•¸">Variables - æŠ½é›¢åƒæ•¸&lt;/h1>
&lt;p>ç›®å‰çš„åƒæ•¸éƒ½æ˜¯å¯«æ­»çš„ï¼Œä¾‹å¦‚èªªéƒ¨ç½²çš„å€åŸŸã€Lambda åç¨±ç­‰ï¼ŒTerraform æ”¯æ´ variable å®šç¾©ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹å¹¾ç¨®é¡å‹&lt;/p>
&lt;ol>
&lt;li>string&lt;/li>
&lt;li>boolean&lt;/li>
&lt;li>number&lt;/li>
&lt;li>set&lt;/li>
&lt;li>map&lt;/li>
&lt;li>object (ç­‰åŒæ–¼ mapï¼Œä½†æœƒè“‹é map)&lt;/li>
&lt;li>tuple&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœè¦åœ¨åƒæ•¸ä½¿ç”¨è®Šæ•¸çš„è©±ï¼Œå¿…é ˆè¦å…ˆåœ¨è³‡æºæª” &lt;code>.tf&lt;/code> å®£å‘Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">variable&lt;/span> &lt;span class="s2">&amp;#34;image_id&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> default&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;default å€¼&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;The id of the machine image (AMI) to use for the server.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>type å¿…å¡«ï¼Œä½†æ˜¯ default è·Ÿ description ä¸ç”¨ï¼Œç•¶æ²’æœ‰ default ä¸”å¾ŒçºŒè®Šæ•¸æ²’æœ‰è³¦å€¼çš„è©±ï¼Œåœ¨ &lt;code>&amp;gt;$terraform apply&lt;/code> æ™‚æœƒä¸­æ–·è¦æ±‚è¼¸å…¥&lt;/p>
&lt;p>åœ¨è³‡æºå®šç¾©æª”ä¸Šï¼Œå¯ä»¥æ¡ç”¨ &lt;code>var.è®Šæ•¸åç¨±&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">provider&lt;/span> &lt;span class="s2">&amp;#34;aws&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> region&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">image_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—ï¼Œé€éä»¥ä¸‹å¹¾ç¨®æ–¹å¼è³¦å€¼çµ¦ variable&lt;/p>
&lt;ol>
&lt;li>ç’°å¢ƒè®Šæ•¸
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="n">$export TF_VAR_image_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">ami&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">abc123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">$export TF_VAR_availability_zone_names&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;us-west-1b&amp;#34;,&amp;#34;us-west-1d&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>&lt;code>terraform.tfvars&lt;/code> æª”æ¡ˆä¸­
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="n">image_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ami-abc123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">availability_zone_names&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;us-west-1b&amp;#34;,&amp;#34;us-west-1d&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>&lt;code>terraform.tfvars.json&lt;/code> æª”æ¡ˆä¸­
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;image_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ami-abc123&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;availability_zone_names&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;us-west-1a&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;us-west-1c&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>&lt;code>*.auto.tfvars&lt;/code> æˆ–æ˜¯ &lt;code>*.auto.tfvars.json&lt;/code>ï¼Œé †åºæŒ‰ç…§æª”å&lt;/li>
&lt;li>åœ¨ CLI åŸ·è¡Œæ™‚æŒ‡å®š &lt;code>-var&lt;/code> &lt;code>-var-file&lt;/code>
&lt;blockquote>
&lt;p>$terraform apply -var=&amp;ldquo;image_id=ami-abc123&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæœ‰åŒæ¨£çš„è®Šæ•¸åç¨±ï¼ŒæŒ‰ç…§ä¸Šé¢çš„è¦å‰‡é †åºå¾Œè€…è“‹éå‰è€…ï¼Œä¾‹å¦‚ &lt;code>-var&lt;/code> æœƒè“‹éå…¶ä»–æª”æ¡ˆçš„å®£å‘Š&lt;/p>
&lt;h1 id="output---è¼¸å‡ºåƒæ•¸">Output - è¼¸å‡ºåƒæ•¸&lt;/h1>
&lt;p>å°æ–¼ root module ä¾†èªªï¼Œè¨­å®š output æœƒåœ¨ &lt;code>&amp;gt; $terraform apply&lt;/code> æ™‚æ‰“å°ï¼Œä¾‹å¦‚èªª EC2 Instance çš„ public DNSç­‰ï¼›
å° module ä¾†èªªï¼ŒOutput ç­‰åŒæ–¼ function çš„ return valueï¼Œæ±ºå®šå“ªäº›è³‡æºè®“å¤–éƒ¨è®€å–&lt;/p>
&lt;p>åœ¨ç¯„ä¾‹ç¨‹å¼çš„ç›®éŒ„ä¸‹æœ‰ç¨ç«‹çš„ &lt;code>output.tf&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">output&lt;/span> &lt;span class="s2">&amp;#34;lambda-arn&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">aws_lambda_function&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">lambda_main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">arn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">output&lt;/span> &lt;span class="k">è¼¸å‡ºåƒæ•¸åé¤&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">è³‡æºé¡åˆ¥&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">è³‡æºå‘½å&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">è³‡æºå±¬æ€§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœƒåœ¨ apply æˆåŠŸå¾Œæ‰“å°å‡ºä¾†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">Apply complete! Resources: 2 added, 0 changed, 0 destroyed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Outputs:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lambda-arn = arn:aws:lambda:us-east-1:.....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="state---terraform-å¦‚ä½•æŒç®¡æ¶æ§‹çš„æ›´å‹•">State - Terraform å¦‚ä½•æŒç®¡æ¶æ§‹çš„æ›´å‹•&lt;/h1>
&lt;p>ç•¶æ¶æ§‹ç•°å‹•çš„æ™‚å€™ï¼ŒTerraform å¦‚ä½•çŸ¥é“å‰å¾Œæ¶æ§‹çš„å·®ç•°å‘¢ï¼Ÿ
æ¯æ¬¡åœ¨åŸ·è¡Œ &lt;code>$ terraform plan&lt;/code> æ™‚ï¼Œå°ˆæ¡ˆç›®éŒ„åº•ä¸‹æœ‰ &lt;code>terraform.tfstate&lt;/code> æª”æ¡ˆï¼Œç”¨ JSON æè¿°æ¶æ§‹ä¸­çš„æ‰€æœ‰è³‡æºï¼Œæ¯ç•¶ä¸‹æ¬¡åŸ·è¡Œ &lt;code>$ terraform plan&lt;/code> æ™‚ï¼ŒTerraform æœƒæ ¹æ“š tfstate ä¸­çš„è³‡æº ID å–å¾—æœ€æ–°çš„è³‡è¨Šï¼Œæ¥è‘—èˆ‡æè¿°æª”åš diff æ±ºå®šå“ªéƒ¨åˆ†è³‡æºè¦æ›´æ–°&lt;/p>
&lt;p>ç•¶æˆ‘å€‘è¦è·¨åœ˜éšŠå”ä½œæ™‚ï¼Œå°±éœ€è¦æŠŠ terraform æè¿°æª” + terraform.tfstate èˆ‡åœ˜éšŠå…±äº«ï¼Œæ­¤æ™‚æœƒæœ‰æœ‰ä¸‰å€‹è¦ç´ &lt;/p>
&lt;ol>
&lt;li>&lt;strong>å…±äº«æª”æ¡ˆèˆ‡ç‰ˆæœ¬æ§åˆ¶&lt;/strong>&lt;br>
æª”æ¡ˆå…±äº«æ˜¯æœ€åŸºæœ¬çš„å”ä½œå¿…å‚™æ¢ä»¶ï¼ŒåŒæ™‚å°‡ç¨‹å¼ç¢¼åšç‰ˆæœ¬æ§åˆ¶ä¹Ÿæ˜¯å¾ˆå¿…è¦çš„åŠŸèƒ½&lt;/li>
&lt;li>&lt;strong>Lock æ©Ÿåˆ¶&lt;/strong>&lt;br>
ç•¶å…±äº«äº†ä¹‹å¾Œï¼ŒLock å°±è®Šæˆæ˜¯å¿…é ˆè€ƒé‡çš„å› ç´ ï¼Œé¿å…åœ˜éšŠåŒæ™‚å¤šäººåŒæ­¥ä¿®æ”¹ï¼Œé€ æˆå‰å¾Œè¡çªçš„ç‹€æ³&lt;/li>
&lt;li>&lt;strong>ç¨ç«‹ä¸åŒçš„ state ç‹€æ…‹&lt;/strong>&lt;br>
åœ¨å¯¦éš›æ‡‰ç”¨ä¸Šï¼Œå¯èƒ½æœƒæœ‰ development / staging / production ä¸åŒç’°å¢ƒï¼Œå¸Œæœ›å…±ç”¨ç¨‹å¼ç¢¼å»ºç«‹é›·åŒçš„æ¶æ§‹ï¼Œä½†åˆå› ç‚ºç’°å¢ƒä¸åŒå¸Œæœ›æœ‰ä¸åŒçš„é…ç½®ï¼Œä¾‹å¦‚æ©Ÿå™¨å¤§å°æˆ– VPC ç­‰ï¼Œæ­¤æ™‚å°±éœ€è¦è€ƒé‡å¦‚ä½•ç¨ç«‹ä¸åŒç’°å¢ƒ&lt;/li>
&lt;/ol>
&lt;p>åœ¨è·¨åŒåœ˜éšŠå”ä½œå¾ˆå®¹æ˜“æƒ³åˆ° &lt;code>git&lt;/code> ï¼Œä½†åš´æ ¼ä¾†èªª git åªèƒ½æ»¿è¶³ç¬¬ä¸€é»ï¼Œæ‰€ä»¥åœ¨ Terraform å¯ä»¥æŒ‡å®šä¸åŒçš„ state ç®¡ç†æ–¹å¼ï¼Œé™¤äº†å®˜æ–¹çš„ Terraform Cloudï¼Œå¯ä»¥æ¡ç”¨ &lt;code>AWS S3 + DynamoDB&lt;/code> é”åˆ°ä¸Šè¿°çš„æ¢ä»¶ï¼Œä¸¦é™„å¸¶ç‰ˆæœ¬æ§åˆ¶ï¼Œå†ä¹‹å¾Œæœƒæ›´è©³ç´°çš„æè¿°æ“ä½œæµç¨‹ï¼Œè©³æƒ…å¯ä»¥åƒè€ƒ &lt;a class="link" href="https://blog.gruntwork.io/how-to-manage-terraform-state-28f5697e68fa" target="_blank" rel="noopener"
>How to manage Terraform state&lt;/a>&lt;/p>
&lt;h1 id="çµèª">çµèª&lt;/h1>
&lt;p>å°±é€™æ¨£å®Œæˆäº†å–®å€åŸŸçš„ Lambda éƒ¨ç½²èˆ‡æœ€åŸºæœ¬çš„ Terraform å­¸ç¿’ï¼Œä»¥ä¸‹æ˜¯é€™æ¬¡æ•™å­¸çš„ç¨‹å¼ç¢¼
&lt;a class="link" href="https://github.com/sj82516/terraform-investigation/commit/9106731fcb895c4aa31a1b95670d627fa60e4a4a" target="_blank" rel="noopener"
>terraform-investigation&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://yuanchieh.page/post/2019-11-04_try-terraform-2/" target="_blank" rel="noopener"
>ä¸‹ä¸€ç¯‡&lt;/a>å°‡æ•´å€‹æ¶æ§‹æ¨¡çµ„åŒ–ï¼Œä¸¦ä¸€éµéƒ¨ç½²å¤šå€‹å€åŸŸ&lt;/p></description></item><item><title>ã€ŠHow Javascript Worksã€‹è®€å¾Œæ•´ç† ä¸Š</title><link>https://yuanchieh.page/posts/2019/2019-10-02-how-javascript-works%E8%AE%80%E5%BE%8C%E6%95%B4%E7%90%86-%E4%B8%8A/</link><pubDate>Wed, 02 Oct 2019 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-10-02-how-javascript-works%E8%AE%80%E5%BE%8C%E6%95%B4%E7%90%86-%E4%B8%8A/</guid><description>&lt;div class="video-wrapper">
&lt;iframe loading="lazy"
src="https://www.youtube.com/embed/8oGCyfautKo"
allowfullscreen
title="YouTube Video"
>
&lt;/iframe>
&lt;/div>
&lt;p>ç•¶åˆåœ¨ Youtube çœ‹åˆ° Douglas ç‚ºæ›¸ç±åšå°è®€çš„å½±ç‰‡ï¼Œé‡æ–°ä»‹ç´¹æ¯å€‹ JS æ—¥å¸¸é–‹ç™¼çš„éƒ¨åˆ†ï¼Œå¾å‹åˆ¥é–‹å§‹ Number / Date / Function / Object / String / Array / ï¼¤ã„ï¼›
å»¶ä¼¸åˆ° Promise / Exception / Generator / Async &amp;amp; Awaitï¼›
æœ€å¾Œå¯«ä¸€å€‹è‡ªå‰µçš„èªè¨€ Neo è§£é‡‹ Transpiler çš„å·¥ä½œï¼ŒTokenizing / Parsing / Runtimesï¼›&lt;/p>
&lt;p>Javascript æ˜¯å€‹ç¥å¥‡ä¸”çŸ›ç›¾çš„å­˜åœ¨ï¼Œå®ƒæœ‰è¨±å¤šéŒ¯èª¤èˆ‡ä¸å¥½çš„è¨­è¨ˆï¼Œä½†é¿é–‹é€™äº›å‘ä»–åˆæ˜¯ä¸€é–€å…·å‚™å½ˆæ€§ã€å—åˆ°å»£å¤§ç†±æ„›çš„ç¨‹å¼èªè¨€ï¼Œå†æˆ‘è®€ä¾†ï¼ŒDouglas è©¦è‘—å¾å‰ä½œã€ŠJavaScript: The Good Partsã€‹æè¿°å¦‚ä½•é¿é–‹ JSçš„å‘æ“æŠ±æ­£ç¢ºçš„ JSç·¨å¯«æŠ€å·§ï¼Œåˆ°é€™æœ¬ã€ŠHow JavaScript Worksã€‹ï¼Œé‡æ–°å¸¶è®€è€…èªè­˜ JSã€å¦‚ä½•è®“ JS è®Šå¾—æ›´å¥½ -&amp;gt; å¦‚ä½•å¯«å‡ºæ›´å¥½ JS Codeï¼Œä¸¦è©¦è‘—å‚³éå‡ºè‡ªå·±çš„&lt;code>å¼·çƒˆ&lt;/code>åƒ¹å€¼è§€&lt;/p>
&lt;blockquote>
&lt;p>ä¸‹å€‹ä¸–ä»£ç¨‹å¼èªè¨€çš„æ¨£è²Œ&lt;/p>
&lt;/blockquote>
&lt;p>æ˜¯çš„ï¼Œé€™æœ¬æ›¸é›·åŒæ–¼å‰ä½œï¼Œéƒ½è¡¨é”äº† Douglas å°æ–¼ JS ç·¨ç¨‹æŠ€è—çš„å¯©ç¾è§€èˆ‡åƒ¹å€¼è§€ï¼Œæ‰€ä»¥å…§å®¹æœ‰äº›å¯èƒ½æœƒèˆ‡ä¸»æµåƒ¹å€¼è§€è¡çªï¼Œå­°æ˜¯å­°éå°±è¦‹ä»è¦‹æ™ºäº†ï¼›
ä½†é€™æœ¬æ›¸å¸¶çµ¦æˆ‘çš„è¡æ“Šæ˜¯&lt;code>å¦‚ä½•å»æ€è€ƒä¸€é–€ç¨‹å¼èªè¨€çš„è¨­è¨ˆ&lt;/code>ï¼Œä»¥å¾€éƒ½åœ¨æ€è€ƒå¦‚ä½•å¯«å‡ºæ›´å¥½çš„èªæ³•è·Ÿæ¼”ç®—æ³•ï¼Œå¾æ²’æƒ³éç¨‹å¼èªè¨€çš„æœ¬èº«ä¹Ÿæ˜¯å·¥å…·ï¼Œè‡ªç„¶å°±æœ‰è¢«è¨è«–èˆ‡æ”¹é€²çš„ç©ºé–“ï¼Œè·Ÿå€‹ Douglas çš„è…³æ­¥å»æ€ç´¢ï¼Œè¦ºå¾—æ˜¯å€‹è »æ£’çš„æ€æƒ³è©¦ç…‰ï¼Œé€™æˆ–è¨±æ‰æ˜¯é€™æœ¬æ›¸æœ€æœ‰åƒ¹å€¼çš„åœ°æ–¹!&lt;/p>
&lt;blockquote>
&lt;p>é‚£ä½ å¿ƒä¸­çš„ç¨‹å¼èªè¨€åˆæ˜¯æ€æ¨£çš„æ¨£è²Œå‘¢ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>é€™æœ¬æ›¸é©åˆå° JS æœ‰ä¸€å®šèªè­˜çš„é–‹ç™¼è€…ï¼Œå¦‚æœæ˜¯æ–°æ‰‹å°±ä¸å»ºè­°é–±è®€ã€‚&lt;/p>
&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¸€èˆ¬çš„å·¥å…·æ›¸åœ¨å‰è¨€é€šå¸¸æ˜¯è¬›ä¸€äº› Terminology ã€å¯«ä½œç·£ç”±ã€é©åˆèª°é–±è®€ç­‰ï¼Œé€™æœ¬æ›¸ä¹Ÿä¸ä¾‹å¤–ï¼Œä½†æœ‰è¶£çš„æ˜¯ Douglas è£œå……äº†ä»–å°æŸäº›è‹±æ–‡å–®å­—é —æœ‰å¾®è©ï¼Œä¾‹å¦‚èªª
&lt;code>one&lt;/code>ï¼Œé€™å€‹å–®å­—é–‹é ­æ˜¯ Oï¼Œä½†ä¹Ÿå¾ˆåƒæ˜¯ 0ï¼Œä½†å…¶å¯¦ä»–è¡¨é”çš„æ˜¯ 1ï¼Œè€Œä¸”ç™¼éŸ³ /wÊŒn/ï¼Œæ–‡å­—å¤–åœ¨æ„è±¡è·Ÿå¯¦è³ªæ„ç¾©ä¸å»åˆï¼Œä¸”èˆ‡ç™¼éŸ³ä¹Ÿä¸ä¸€æ¨£ï¼Œå° Douglas ä¾†èªªé€™æ˜¯å€‹éå¸¸å·®çš„è¨­è¨ˆï¼Œæ‰€ä»¥ä»–ä¸»å¼µè¦æ”¹æˆ &lt;code>wun&lt;/code>ï¼Œè€Œæ•´æœ¬æ›¸çš„ one éƒ½ç”¨ wun å–ä»£ï¼ŒåŒ…å« wunceï¼›
å¦ä¸€å€‹å–®å­— &lt;code>through&lt;/code>ï¼Œé€™å€‹å­—æœ‰ä¸€åŠçš„å­—æ¯æ²’æœ‰ç™¼éŸ³ï¼Œæ‰€ä»¥ä»–çœç•¥ç‚º &lt;code>thru&lt;/code>ã€‚&lt;/p>
&lt;p>å¦ç™½èªªï¼Œä¸€é–‹å§‹çœ‹åˆ°è¦ºå¾—æœ‰é»ç„¡èŠï¼Œæƒ³èªªé€™æ˜¯æ²’äº‹æ‰¾ç¢´çš„æ¦‚å¿µå— XD
ä½†çœ‹å®Œæ•´æœ¬æ›¸å¾Œï¼Œè¦ºå¾—è‡ªå·±æœç„¶é“è¡Œå¤ªæ·ºï¼ŒDouglas æƒ³è¡¨é”çš„æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>æ­£ç¢ºå‘½åå°±æ˜¯å¯«å¥½ç¨‹å¼çš„ç¬¬ä¸€æ­¥ï¼Œä¸ç•™çµ¦è‡ªå·±ä»»ä½•æ€ç¶­ä¸Šçš„æ¨¡ç³Šåœ°å¸¶&lt;/p>
&lt;/blockquote>
&lt;p>ä»»ä½•æœ‰æ¨¡ç³Šè§£é‡‹ç©ºé–“çš„åœ°æ–¹ï¼Œå°±æœƒæœ‰èª¤è§£è·ŸéŒ¯èª¤çš„ç”¢ç”Ÿï¼Œæ‰€ä»¥å¾æºé ­çš„å‘½åé–‹å§‹å°±æœçµ•é€™ç¨®å£ç¿’æ…£ï¼Œæ‰æ˜¯æ ¹æœ¬å¯«å¥½ç¨‹å¼çš„æ–¹æ³•ï¼
é€™æ¨£çš„ç²¾ç¥è²«ç©¿æ•´æœ¬æ›¸ç±ï¼Œç”¨æœ€æŒ‘å‰”çš„æ–¹å¼é‡æ–°æª¢è¦– JS çš„èªæ³•èˆ‡å¯¦ä½œè¨­è¨ˆã€‚&lt;/p>
&lt;h3 id="how-names-work">How Names Work&lt;/h3>
&lt;p>åœ¨å‘½åä¸Šï¼ŒDouglas èªç‚ºç¨‹å¼èªè¨€æ‡‰è©²è¦æ”¯æ´&lt;code> &lt;/code>ç•¶ä½œè®Šæ•¸åç¨±çš„åˆæ³•å­—å…ƒï¼Œä½†ç›®å‰ JS æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥ä»–å»ºè­°ç”¨å°å¯«å­—æ¯é–‹é ­ä¸¦ç”¨ &lt;code>_&lt;/code> è›‡è¡Œå‘½åæ³•åˆ‡å‰²å¤šå€‹å–®å­—çš„è®Šæ•¸åç¨±ï¼›
è‡³æ–¼ &lt;code>$&lt;/code>ã€&lt;code>_&lt;/code> é–‹é ­å‰‡é¿å…ä½¿ç”¨ï¼Œé€™äº›æ‡‰è©²è¢«ä¿ç•™ç•¶ä½œ code generator ã€macro processor ä½¿ç”¨ã€‚&lt;/p>
&lt;p>åœ¨ JS ä¸­ï¼Œä¸€å¤§ä»¤äººå›°æƒ‘çš„åœ°æ–¹æ˜¯ function è·Ÿ constructor ç„¡æ³•å€åˆ†ï¼Œå¦‚æœ function ç”¨ &lt;code>new&lt;/code> å‘¼å«å°±è®Šæˆ constructorï¼Œæ‰€ä»¥ Douglas å»ºè­° contructor ç”¨å¤§å¯«é–‹é ­ä½œç‚ºå€åˆ†ï¼Œä½†å¯ä»¥çš„è©±é€£ &lt;code>new&lt;/code> éƒ½ä¸è¦ç”¨ï¼Œå¾ŒçºŒæœƒåœ¨è£œå……åšæ³•ã€‚&lt;/p>
&lt;h3 id="how-numbers-work">How Numbers Work&lt;/h3>
&lt;p>é€™ä¹Ÿæ˜¯ JS å¾ˆå¸¸è¢«è©¬ç—…çš„èª¤è§£ 0.1 + 0.2 !== 0.3ï¼Œä½†å…¶å¯¦ JS æ˜¯åƒç…§ IEEE 754 å…¶ä¸­çš„é›™ç²¾åº¦æµ®é»æ•¸è¦ç¯„ï¼Œå…¶é¤˜å¦‚ Java ç­‰æ¡ç”¨åŒæ¨£çš„è¦ç¯„ä¹Ÿéƒ½æœƒæœ‰ä¸€æ¨£çš„å•é¡Œï¼Œç•¢ç«Ÿç”¨æœ‰é™çš„ bits æ€éº¼å¯èƒ½å°æ‡‰åˆ°ç„¡çª®çš„æœ‰ç†æ•¸å‘¢ï¼Œæ‰€ä»¥åœ¨ç²¾åº¦ä¸Šçš„ç¼ºé™·æ‰æœƒå°è‡´é€™æ¨£çš„çµæœã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">è¦å°å¿ƒåˆ‡æ›å„²å­˜çš„æ•¸å€¼èˆ‡å¯¦éš›è¡¨ç¤ºçš„æ•¸å­—ï¼Œé€™å…©è€…æœƒæœ‰æ•¸å­¸å…¬å¼çš„å°æ‡‰é—œä¿‚ï¼Œä½†æ–‡å­—ä¸Šå®¹æ˜“ç”¢ç”Ÿèª¤è§£
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>JS åªæ”¯æ´å–®ä¸€ç¨®çš„æ•¸å­—å‹åˆ¥å°±æ˜¯ Numberï¼Œé€™æ˜¯å€‹è‰¯å¥½çš„è¨­è¨ˆï¼Œå› ç‚ºä¸éœ€è¦æ¶‰åŠæ•¸å­—å‹åˆ¥çš„è½‰æ›ï¼Œä¾‹å¦‚ int è½‰ float æˆ– double ç­‰ï¼Œåœ¨ç¾åœ¨æ©Ÿå™¨è¨˜æ†¶é«”éå¸¸å……è¶³çš„æƒ…æ³ä¸‹ï¼Œç¨‹å¼èªè¨€ä»¥é–‹ç™¼è€…å‹å–„çš„æ–¹å¼è¨­è¨ˆæœƒæ¯”è¼ƒé©åˆ&lt;/p>
&lt;p>Number ä»¥ 64 bits å„²å­˜ï¼Œæ‹†åˆ†æˆ3å€‹éƒ¨åˆ†å„²å­˜ï¼Œsignificand æ˜¯ä»‹æ–¼ 0.5 ~ 1.0 çš„æ•¸å€¼&lt;/p>
&lt;blockquote>
&lt;p>sign(1) + exponent(11) + significand(52)
è½‰æˆæ•¸å€¼ä»£è¡¨
(-1) ^ sign * 1.significand * 2^(exponent - 0x3ff)&lt;/p>
&lt;/blockquote>
&lt;p>sign æ˜¯ä¸€å€‹ä½å…ƒè¡¨ç¤ºæ­£è² ï¼›
exponent å‰‡æ˜¯ç”¨ 11å€‹ä½å…ƒè¡¨ç¤º 2çš„æ¬¡æ–¹å€ï¼Œç‚ºäº†è¡¨ç¤ºæ­£å€é–“åˆ°è² å€é–“æ‰€ä»¥é å®šæœ‰åå·®å€¼ (bias value 0x3ff)ï¼Œä¹Ÿå°±æ˜¯ exponent 0x000 ä»£è¡¨çš„å…¶å¯¦æ˜¯ (-1 * 0x3ff)ï¼›
significand ç”¨å‰©é¤˜ 52 bit è¡¨ç¤ºï¼Œä½†å› ç‚ºæµ®é»æ•¸è¡¨ç¤ºè¡¨é”ç‚º 1.X * 2^n æ¬¡æ–¹ï¼Œå› ç‚º&lt;code>1&lt;/code>å›ºå®šæœƒå­˜åœ¨ï¼Œæ‰€ä»¥å°±å¯ä»¥è¨˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œç®—æ˜¯é¡å¤–çš„ bonus bitï¼Œæ‰€ä»¥æœ€å¤§æ•¸å€¼è¡¨ç¤ºå¯ä»¥åˆ° 2^53 æ¬¡æ–¹&lt;/p>
&lt;p>å¹¾å€‹å¸¸è¦‹çš„æ•¸å­—å°æ‡‰ binary è¡¨ç¤º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">-0: 8000 0000 0000 0000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+0: 8000 0000 0000 0000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1ï¼š3ff0 0000 0000 0000 =&amp;gt; 2 ^ (0x3ff - 0x3ff) * 2^53 (åˆ¥å¿˜äº† bonus bit) = 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æœ€å¤§æ•¸ï¼š 7fef ffff ffff ffff =&amp;gt; (2^54 -1) &lt;span class="ge">* 2^971 = 2 ^ (0x7fe - 0x3ff) *&lt;/span> (2^54 - 1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ç‰¹æ®Šå­—
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ç„¡é™å¤§ï¼š0x7ff0 0000 0000 0000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NaNï¼š0x7ff + å¾Œé¢å‡ºç¾ä»»æ„é0çš„bitsï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ NaN !== NaN
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é ˆè¬¹è¨˜åªæœ‰åœ¨ Number.MAX_SAFE_INTEGER åˆ° Number.MIN_SAFE_INTEGER ä¹‹ä¸­çš„æ•´æ•¸æ‰æ˜¯ 1:1 mappingï¼Œä¹Ÿå°±æ˜¯ä¸€å€‹æ•¸å­—å°æ‡‰åˆ°ä¸€å€‹çœŸå¯¦çš„æ•¸å€¼ï¼Œåœ¨é€™å€‹å€é–“æ‰ä¿è­‰æ•¸å­¸é‹ç®—çš„æ­£ç¢ºæ€§ï¼Œè¶…éç¯„åœçš„æ•¸å€¼æœƒå–ªå¤±éƒ¨åˆ†ç²¾æº–æ€§ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Number&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MAX_SAFE_INTEGER&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nb">Number&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MAX_SAFE_INTEGER&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="c1">// true
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¦æª¢æŸ¥æ•¸å­—ï¼Œè«‹ç”¨ Number.{method}ï¼Œä¾‹å¦‚ Number.isNaNã€Number.isSafeInteger ç­‰&lt;/p>
&lt;h3 id="how-big-integersfloating-pointrationals-works">How Big Integers/Floating Point/Rationals Works&lt;/h3>
&lt;p>å—é™æ–¼ Numberçš„ç²¾åº¦ï¼Œå¦‚æœåƒéŠ€è¡Œç³»çµ±ç­‰ä¸å®¹è¨±åŠé»å¤±çœŸçš„æ•¸å­¸é‹ç®—ï¼Œå°±å¿…é ˆè‡ªå·±é¡å¤–è™•ç†ï¼Œé€™éƒ¨åˆ† Douglas åˆ†åˆ¥å¯«äº† Big Integers / Floating Point / Rationals çš„è™•ç†ï¼ŒRationals æ˜¯æŒ‡ç”¨å…©å€‹ Big Integer ç›¸é™¤è¡¨ç¤ºçš„æ•¸å€¼ï¼Œå¯ä»¥æ›´ç²¾ç¢ºè¡¨ç¤ºæŸäº› Floating Pointï¼Œè©³ç´°å¯ä»¥çœ‹åŸå§‹ç¢¼ &lt;a class="link" href="https://github.com/douglascrockford/howjavascriptworks" target="_blank" rel="noopener"
>howjavascriptworks&lt;/a>ï¼Œæ›¸ä¸­é€™ä¸‰ç¯€éƒ½æ˜¯æ‹†è§£ç¨‹å¼ç¢¼è¬›è§£ï¼Œä½†æ˜¯æ’ç‰ˆçœ‹èµ·ä¾†æœ‰é»éº»ç…©ï¼Œä¸å¦‚è¢å¹•æ‹–æ‹‰çœ‹ä¾†å¾—æ–¹ä¾¿ã€‚&lt;/p>
&lt;p>é€™é‚Š Douglas æ‹‹å‡ºä¸€å€‹è¨è«–ï¼Œä»–è¦ºå¾—å¤§æ•¸é‹ç®—ä¸æ‡‰è©²æ”¾é€²ç¨‹å¼èªè¨€çš„åŸç”Ÿæ”¯æ´ï¼Œè€Œæ˜¯è®“éœ€è¦çš„ç”¨æˆ¶è‡ªè¡Œå»æ¡ç”¨ Libraryï¼ŒJS ç”Ÿæ…‹åœˆå·²ç¶“æœ‰è‰¯å¥½ç¾è¡Œçš„è§£æ³•äº†ï¼Œå› ç‚ºç¨‹å¼èªè¨€æ‡‰è©²ç¶­æŒå°è€Œç¾ï¼Œæä¾›æœ€æ ¸å¿ƒçš„æ”¯æ´ï¼Œå…¶é¤˜çš„æ‡‰è©²æ˜¯é–‹æ”¾è®“ç”¨æˆ¶è‡ªè¡Œé¸æ“‡&lt;/p>
&lt;p>ä½† &lt;a class="link" href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/BigInt" target="_blank" rel="noopener"
>BigInt&lt;/a> å·²ç¶“åœ¨ Firefox/Chrome è©¦è¡Œäº† XD
æˆ‘è‡ªå·±ä¹Ÿæ˜¯åå‘ Douglas çš„æƒ³æ³•ï¼Œç‚ºäº†å°‘éƒ¨åˆ†ç”¨æˆ¶ï¼Œè€Œè®“ JS å¾åŸæœ¬åªæœ‰ Number å¤šåŠ ä¸€å€‹æ•¸å­—å‹åˆ¥ï¼Œè¦ºå¾—æ²’æœ‰é€™éº¼å¼·çƒˆçš„å¿…è¦&lt;/p>
&lt;h3 id="how-booleans-work">How Booleans Work&lt;/h3>
&lt;p>JS æ”¯æ´ Boolean å‹åˆ¥ï¼Œä¹Ÿå°±æ˜¯ &lt;code>typeof true / typeof false&lt;/code> æœƒå›å‚³ &lt;code>boolean&lt;/code>ï¼Œä½†åœ¨æ¢ä»¶è¡¨é”å¼(if/for/&amp;amp;&amp;amp;/||ç­‰)ä¸­ï¼ŒJS æ”¯æ´ boolishï¼Œä¹Ÿå°±æ˜¯å°‡å…¶ä»–å‹åˆ¥è½‰æ›æˆ boolean å‹åˆ¥ï¼Œå°¤å…¶æ˜¯ä¸€äº›å½†æ‰­çš„ falsy å€¼ï¼Œä¾‹å¦‚ 0 / &amp;quot;&amp;quot; / undefined / null / NaNç­‰&lt;/p>
&lt;p>è‰¯å¥½çš„ç¿’æ…£æ˜¯åœ¨æ¢ä»¶è¡¨é”å¼ä¸­åªè¦ Booleanï¼Œè€Œä¸”åˆ¤æ–·å¼ç”¨ &lt;code>===&lt;/code> è€Œé &lt;code>==&lt;/code>&lt;/p>
&lt;h3 id="how-arrayobject-work">How Array/Object Work&lt;/h3>
&lt;p>Array æ˜¯ç”¨ä¾†è¡¨é”ä¸€å€‹é€£çºŒçš„è¨˜æ†¶é«”å€é–“ï¼Œä¸¦ä»¥æŸ size åˆ‡åˆ†æˆè‹¥å¹²ç­‰ä»½çš„é›†åˆï¼ŒArray åœ¨ JS ä¸­åªæ˜¯ä¸€å€‹ç‰¹æ®Šçš„ Objectï¼Œæ‰€ä»¥ &lt;code>typeof array === 'object'&lt;/code>ï¼Œè¦ç¢ºå¯¦åˆ¤æ–·æ˜¯å¦ç‚ºé™£åˆ—è«‹ç”¨ &lt;code>Array.isArray&lt;/code>&lt;/p>
&lt;p>åŸç”Ÿçš„ Array æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œä½†è¦æ³¨æ„ sort/reverse æ˜¯ in place ç™¼ç”Ÿï¼Œä¹Ÿå°±æ˜¯ä»–æ˜¯æ”¹è®ŠåŸArrayï¼Œç†è«–ä¸Šé€™å…©å€‹æ‡‰è©²è¦æ˜¯ pure function æ‰æ˜¯ï¼Œä½†å¯æƒœ ECMAScript ä¸¦æ²’æœ‰è¦ç¯„&lt;/p>
&lt;p>é—œæ–¼ Object å¯ä»¥åˆ©ç”¨ Object Literal æ–¹å¼å‰µå»ºï¼ŒKey è¦æ¡ç”¨ Stringï¼ŒValue å¯ä»¥å…¶ä»–å‹åˆ¥åŒ…å« functionç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">my_obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦å¤– Douglas ä¸å»ºè­°åœ¨ Object ä¸­å„²å­˜ undefinedï¼Œå› ç‚ºé€™æ¨£ç„¡æ³•å€åˆ†åˆ°åº•æ˜¯ Object ä¸å­˜åœ¨é€™å€‹ Key é‚„æ˜¯ Keyå­˜åœ¨ä½†å„²å­˜ undefined&lt;/p>
&lt;p>å› ç‚º JS æ²’æœ‰ç¹¼æ‰¿çš„æ¦‚å¿µï¼Œæˆ–æ˜¯èªªé€é Prototype Chain æ¨¡æ“¬ç¹¼æ‰¿çš„æ–¹å¼ï¼Œåœ¨ä½¿ç”¨ä¸Š Douglas å»ºè­°ç”¨ &lt;code>let new_object = Object.create(null)&lt;/code>ï¼Œå› ç‚º &lt;code>null&lt;/code> æ²’æœ‰ prototypeï¼Œæ‰€ä»¥å‰µå»ºçš„æ–°ç‰©ä»¶æ²’æœ‰å¤šé¤˜çš„ prototype éœ€è¦è€ƒé‡ï¼Œæ•´é«”ä¸Šæ¯”è¼ƒä¹¾æ·¨ï¼Œé‹è¡Œä¸Šä¹Ÿæ¯”è¼ƒæœ‰æ•ˆç‡ï¼›
æœ€å¥½æ˜¯å†åŠ ä¸Š &lt;code>Object.freeze&lt;/code>ï¼Œè®“å…¶ä»–æ“ä½œè€…ç„¡æ³•ä»»æ„æ›´å‹• Object å±¬æ€§&lt;/p>
&lt;p>Weakmap æœ‰é»é¡ä¼¼æ–¼ Objectï¼Œä½†å¥½è™•æ˜¯å¯ä»¥ç”¨æ‹¿ Object reference ç•¶ä½œ Keyï¼Œå¦‚æœæœ‰äººè¦æ“ä½œå±¬æ€§å°±å¿…é ˆæœ‰ key è·Ÿ weakmapï¼Œå¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">sealer_factory&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">weakmap&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">WeakMap&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sealer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">box&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Object&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeze&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Object&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">weakmap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">box&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">object&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">box&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">unsealer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">box&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">weakmap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">box&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥å°‡ç‰©ä»¶å°è£è¼‰ weakmap ä¸­ï¼Œä¸¦å›å‚³ Key Object reference boxï¼Œåªæœ‰æ‹¿ weakmap è·Ÿ box æ‰èƒ½æ‹¿åˆ°ç•¶åˆå°è£çš„æ±è¥¿ã€‚&lt;/p>
&lt;h3 id="how-strings-work">How Strings Work&lt;/h3>
&lt;p>String åœ¨ JS ä¸­æ˜¯ä»¥ Immutable çš„é€£çºŒ 16 bit é™£åˆ—ï¼Œå¯ä»¥é€é String.fromCharCode ç”Ÿæˆ Stringï¼Œæ•¸å€¼ç¯„åœå¾ 0 ~ 65535ï¼›
å¯ä»¥ç”¨ Array çš„æ–¹æ³•å»æ“ä½œ Stringï¼Œä¾‹å¦‚ my_string.indexOf(), my_string[0] ç­‰&lt;/p>
&lt;p>ä½†ä¸–ç•Œèªè¨€ä½•å…¶å¤šç¨®ï¼Œéœ€è¦è¡¨ç¤ºçš„å­—é é ä¸æ­¢ 65536 ç¨®ï¼ŒUnicode ç·¨ç¢¼æ¨¡å¼ä¹Ÿå› æ­¤è€Œèª•ç”Ÿï¼Œç›®å‰ç¸½å…±è¦ç¯„äº†U+0000åˆ°U+10FFFF(20bits)ï¼Œå…±æœ‰1,112,064å€‹ç¢¼ä½ï¼ˆcode pointï¼‰ï¼Œç¢¼ä½ä»£è¡¨å„²å­˜çš„ä½å…ƒè¡¨ç¤ºæ–¹å¼ï¼Œå…¶ä¸€å°ä¸€è¡¨ç¤ºä¸€å€‹äººé¡é–±è®€çš„å­—å…ƒï¼›
æ¥è‘—ä»¥ 65,536 ç‚ºå–®ä½ï¼Œå°‡ 1,112,064 åˆ‡å‰²æˆ 16å€‹å¹³é¢ï¼Œæ¯å€‹å¹³é¢å« 65536 å€‹ç¢¼ä½ï¼›
å…¶ä¸­ç¬¬ 0 ç¢¼ä½ç¨±ç‚º BMPï¼Œä¹Ÿå°±æ˜¯åŸºç¤å¤šèªè¨€å¹³é¢ï¼Œå…¶ä»–ç¨±ç‚ºè¼”åŠ©å¹³é¢ã€‚&lt;/p>
&lt;p>UTF-16 ä»£è¡¨ç”¨ 16bits ç•¶ä½œå„²å­˜çš„æœ€å°å–®ä½ï¼Œç‚ºäº†è¦æ”¯æ´å…¨éƒ¨çš„ Unicode èªè¨€å¹³é¢ï¼ŒUTF-16æ”¹æ¡ç”¨ 2å€‹å–®ä½ä¾†å„²å­˜ä¸€å€‹ç¢¼ä½ï¼Œå°‡ 20bits åˆ‡å‰²ä¸Šä¸‹å…©å€‹ 10bitsï¼Œé«˜ä½å…ƒåŠ ä¸Š 0xD8ï¼Œä½ä½å…ƒåŠ ä¸Š 0xDC çµ„åˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">U+1F4A9 =&amp;gt; 0001 1111 0100 1010 0111
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">å‰10ä½å…ƒï¼š 0001 1111 01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">å¾Œ10ä½å…ƒï¼š 00 1010 0111
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è£œè¶³ 16 bits ä¸¦åŠ ä¸Šå°æ‡‰çš„é è¨­å€¼
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0001 1111 01 =&amp;gt; 0000 0000 0111 1101 + 0xD8 = 0xD83D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">00 1010 0111 =&amp;gt; 0000 0000 1010 0111 + 0xDC = 0xDCA9
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥ U+1F4A9 åœ¨ UTF-16 å„²å­˜æ–¹å¼ç‚º &lt;code>0xD83D 0xDCA9&lt;/code>
UTF-16 åªæ˜¯ Unicode å¯¦éš›å„²å­˜æ–¹å¼çš„ä¸€ç¨®å¯¦ä½œï¼ŒåŒ…å«å¸¸è¦‹çš„ UTF-8 ä¹Ÿæ˜¯æŒ‡å¯¦ä½œæ–¹å¼&lt;/p>
&lt;p>åœ¨ JS ä¸­ï¼Œè¦è¡¨é” Unicode å¯ä»¥ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;\uD83D\uDCA9&amp;#34;&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;\u{1F4A9}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æˆ–æ˜¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">formCharCode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">55357&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">56489&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nb">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fromCharCode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128169&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="how-generators-work">How Generators Work&lt;/h3>
&lt;p>Douglas èªç‚º Generator æ˜¯å€‹å¥½æ±è¥¿ï¼Œä½†æ˜¯ JS å¯¦ä½œçš„å¤ªç³Ÿäº†ï¼Œä»–èªç‚ºåŸæœ¬çš„ JS å°±å¯ä»¥ç”¨ Closure å¯¦ä½œ Generatorï¼Œä½¿ç”¨ä¸Šç”¨åŸæœ¬çš„ Function è¡¨é”å¯ä»¥æ›´æ¸…æ¥šï¼›
è€Œ JS å¾Œä¾†å°å…¥çš„ Generator åœ¨å‘½åä¸Šã€ç”¨æˆ¶æ“ä½œä¸Šéƒ½ä¸æ…ç†æƒ³ï¼Œå¯ä»¥å¾è¨€èªä¸­çœ‹å‡ºçš„ä»–ä¸å±‘èˆ‡æ†¤æ€’ XD&lt;/p>
&lt;p>é€™æ˜¯æˆ‘å°‘æ•¸å®Œå…¨èªåŒçš„ç« ç¯€ï¼Œç›´æ¥çœ‹ç¨‹å¼ç¢¼æ¯”è¼ƒå¿«
ä»¥ä¸‹æ˜¯ JS æ¨™æº–çš„ Generator&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="nx">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">gen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸‹æ˜¯ Douglas èªç‚ºä¸ç”¨ standard ç·¨å¯«çš„ Generator&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">counter_generator&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">gen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gen&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gen&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">gen&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¾å¹¾å€‹åœ°æ–¹å»çœ‹å‡ºç‚ºä»€éº¼ Standard Generator æ˜¯ç³Ÿç³•çš„èªè¨€è¨­è¨ˆ&lt;/p>
&lt;ol>
&lt;li>å½†æ‰­çš„å‘½å
åœ¨ JS ä¸­ï¼Œfunction æ˜¯ first class citizenï¼Œå¤§å®¶ä¹Ÿéƒ½éå¸¸ç†Ÿæ‚‰æ–¼ High order functionï¼Œå°‡ function ç•¶ä½œåƒæ•¸æˆ–å›å‚³å€¼ä½¿ç”¨ï¼›
ä»Šå¤© Standard Generator æ˜¯åœ¨ function å¾ŒåŠ å…¥ &lt;code>*&lt;/code> æ¨™è¨˜ï¼Œä½†å…¶è¡Œç‚ºåˆè·Ÿ function ä¸åŒï¼Œä¾‹å¦‚ function æ˜¯ç”¨ return å›å‚³å€¼ï¼Œä½†æ˜¯ Generator æ˜¯ç”¨ yeild&lt;/li>
&lt;li>åå‘ OOP è¨­è¨ˆè€Œé FP
ç•¶ç„¶è¦èµ° FP æˆ– OOP æ¯”è¼ƒåƒæ˜¯å€‹äººåå¥½ï¼Œä½†ä¾æ“š Standard Generatorï¼Œä½¿ç”¨ä¸Šå¿…é ˆå®£å‘Š while(true) ä¸¦æ­é… yeild å¯¦ä½œï¼ŒDouglas èªç‚ºæ‡‰è©²è¦ç›¡é‡æ¸›å°‘ Loop çš„ä½¿ç”¨&lt;/li>
&lt;li>å›å‚³å€¼çš„æ“ä½œ
ç”¨ Standard Generator åˆå§‹åŒ–å¾Œï¼Œè¦å‘¼å«ä¸‹ä¸€å€‹å€¼å¿…é ˆç”¨ &lt;code>gen.next().value&lt;/code>
å›åˆ°é¡ä¼¼ç¬¬ä¸€é»çš„è¨­è¨ˆéŒ¯èª¤ï¼Œä¸€å€‹ Generator Function æ²’æœ‰é¡¯ç¤º return çš„å€¼ï¼Œå±…ç„¶æ˜¯ä»¥ä¸€å€‹ç‰©ä»¶çš„å½¢å¼ï¼Œå‘¼å«å…¶ next functionï¼Œè€Œä¸”é‚„è¦åŠ ä¸Š .valueï¼Œé€™è¡¨é”çš„æ–¹å¼å¯¦åœ¨æ˜¯å¾ˆæ€ªç•°ï¼Œé é ä¸å¦‚ &lt;code>gen()&lt;/code> ä¾†å¾—ç›´æ¥æ˜ç­ã€‚&lt;/li>
&lt;/ol>
&lt;p>Standard Generator è¢«æ‰¹è©•çš„å¾ˆå¾¹åº•ï¼Œä½†ç¢ºå¯¦ Douglas è¬›å¾—ä¹Ÿå¾ˆæœ‰é“ç†ï¼Œå¦‚æœæœ‰äººçœ‹éè³‡æ–™æˆ–æœ‰ä¸åŒçš„æ„è¦‹ï¼Œæ­¡è¿äº¤æµï½ æˆ‘ä¹Ÿå¾ˆå¥½å¥‡å…¶ä»–äººæˆ–æ˜¯ç•¶åˆèªè¨€æ¨™æº–åˆ¶å®šæ™‚æ˜¯å¦‚ä½•è©•é‡çš„&lt;/p>
&lt;p>æ¥è‘— Douglas åˆ†äº«ä»–ä¸€å¥— Generator çš„çµ„åˆæŠ€ï¼Œé‚„è »å²å®³çš„ï¼Œæœ‰èˆˆè¶£å¯ä»¥å»æ›¸åº—ç¿»é–±ï¼Œé€™éƒ¨åˆ†ç¨‹å¼ç¢¼æ²’æœ‰è¢«æ”¾åˆ° Github ä¸Šã€‚&lt;/p>
&lt;h3 id="how-exceptions-work">How Exceptions Work&lt;/h3>
&lt;p>Exception æ¯”è¼ƒåå‘æŒ‡æ„å¤–ï¼Œä½†æ˜¯åœ¨ä¸€èˆ¬çš„ç³»çµ±è¨­è¨ˆå¸¸å¸¸æœƒæŠŠéŒ¯èª¤( Error )èˆ‡æ„å¤–æ··ç‚ºä¸€è«‡ï¼Œä¾‹å¦‚èªªæŸ¥è©¢æª”æ¡ˆæ™‚å¦‚æœæª”æ¡ˆä¸å­˜åœ¨ï¼Œé€™æ‡‰è©²æ˜¯å¯ä»¥è¢«é æœŸçš„éŒ¯èª¤ï¼Œæ‡‰è©²è¦ä¸€èˆ¬çš„æµç¨‹è™•ç†ï¼Œä½†æˆ‘å€‘é‚„æ˜¯æœƒç”¨ try catch ä¾†å‚³éé€™æ¨£å¯è¢«é æœŸçš„éŒ¯èª¤&lt;/p>
&lt;p>åœ¨ JS ä¸­ï¼ŒéŒ¯èª¤æ‹‹å‡ºä½¿ç”¨ &lt;code>throw&lt;/code>ï¼Œthrow å¯ä»¥æ­é…å„ç¨®å‹åˆ¥çš„å€¼ï¼Œä½¿ç”¨ä¸Šæœ€ç°¡å–®å°±ç”¨ Stringï¼Œæœ‰Error Object ä½†æ²’æœ‰å¤ªå¼·ä½¿ç”¨çš„å¿…è¦ï¼›
åœ¨ Compile éç¨‹ä¸­ï¼Œæ¯å€‹ function éƒ½æœ‰ä¸€å€‹ catchmapï¼Œå¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œæœƒä¾åºå¾å‘¼å«çš„ function é–‹å§‹æ‰¾ catch æ©Ÿåˆ¶ï¼Œå¦‚æœæ²’æœ‰å‰‡æŒçºŒå¾€ä¸Šæ‰¾ caller&lt;/p>
&lt;p>ä½¿ç”¨ try catch æœƒæœ‰å€‹å®‰å…¨é¢¨éšªæ˜¯å‡ä½¿ä½¿ç”¨å…©å€‹å¤–éƒ¨çš„ module A/Bï¼ŒA æœ‰ç¶²è·¯å­˜å–çš„åŠŸèƒ½ï¼Œè€Œ B ç”¨æ–¼å…§éƒ¨çš„åŠ è§£å¯†é‹ç®—ï¼Œå‡ä½¿æŸå¤©æˆ‘å€‘åœ¨èª¿ç”¨æ˜¯ç”¨ B è§£å¯†å¾Œå†å°‡å€¼å‚³çµ¦ A èµ°ç¶²è·¯å‚³è¼¸ï¼Œå‡ä½¿B æ‹‹å‡ºéŒ¯èª¤ &lt;code>throw private_key&lt;/code> è€Œ A æœ‰è¨»å†Š catch æ„å¤–æ•ç²é€™å€‹éŒ¯èª¤ï¼Œé‚£å°±æœƒæœ‰è³‡å®‰ç–‘æ…®çš„é¢¨éšªäº†&lt;/p></description></item><item><title>SDP Spec é–±è®€ç­†è¨˜</title><link>https://yuanchieh.page/posts/2019/2019-10-02-sdp-spec-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/</link><pubDate>Wed, 02 Oct 2019 00:21:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-10-02-sdp-spec-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/</guid><description>&lt;h1 id="ä»‹ç´¹">ä»‹ç´¹&lt;/h1>
&lt;p>SDP æ˜¯ä¸€ç¨®æ¨™æº–åŒ–çš„è³‡è¨Šå‚³é”æ–¹å¼ï¼Œç”¨ä¾†è¡¨é”å¤šåª’é«”çš„å…§å®¹ã€å‚³è¼¸çš„ä½å€åŠå…¶ä»–å‚³éæ‰€éœ€çš„ metadataï¼Œä¸»è¦æ‡‰ç”¨å ´æ™¯æ–¼å¤šåª’é«”å‚³è¼¸çš„å‰ç½®æºé€šï¼Œä¾‹å¦‚èªªè¦–è¨Šæœƒè­°ã€VoIP(Voice over IP) é€šè©±ã€å½±éŸ³ä¸²æµç­‰æœƒè©±(Session)
åœ¨è¦ç¯„ä¸­ä¸¦æ²’æœ‰å®šç¾© SDP è©²æ€éº¼è¢«å‚³è¼¸ï¼Œå¯ä»¥è‡ªç”±é¸ç”¨ HTTP / XMPP / RTSP / Email ç­‰å‚³è¼¸å”å®šç­‰&lt;/p>
&lt;p># åè©å®šç¾©&lt;/p>
&lt;ol>
&lt;li>Conference:
å…©å€‹ä»¥ä¸Šçš„ç”¨æˆ¶æ­£åœ¨ç›¸äº’é€šä¿¡çš„é›†åˆ&lt;/li>
&lt;li>Session:
æœ‰ä¸€å€‹ç™¼é€è€…ï¼Œä¸€å€‹æ¥æ”¶è€…ï¼Œå…©è€…é–“å»ºç«‹ä¸€æ¢å¤šåª’é«”ä¸²æµçš„é€šé“ï¼Œè³‡æ–™ç”±ç™¼é€è€…å¯„ç™¼åˆ°æ¥æ”¶è€…&lt;/li>
&lt;li>Session Descriptionï¼š
è®“å…¶ä»–äººå¯ä»¥æˆåŠŸåŠ å…¥ Conference çš„è³‡è¨Š&lt;/li>
&lt;/ol>
&lt;h1 id="è¦æ±‚èˆ‡å»ºè­°">è¦æ±‚èˆ‡å»ºè­°&lt;/h1>
&lt;p>SDP ä¸»è¦åŠŸç”¨ç‚ºå‚³éå¤šåª’é«”æœƒè©±ä¸­å¤šåª’é«”ä¸²æµçš„è³‡è¨Šï¼Œæºé€šæœƒè©±çš„å­˜åœ¨ / åŠè®“å…¶ä»–éåƒèˆ‡è€…çŸ¥é“å¦‚ä½•åŠ å…¥æ­¤æœƒè©±(ä¸»è¦ç”¨æ–¼å»£æ’­ multicast)ï¼Œå…§å®¹å¤§æ¦‚åˆ†æˆå¹¾å€‹&lt;/p>
&lt;ol>
&lt;li>åç¨±è·Ÿç›®çš„&lt;/li>
&lt;li>æœƒè©±æœ‰æ•ˆçš„æ™‚é–“&lt;/li>
&lt;li>æœƒè©±ä¸­æ¶µè“‹çš„å¤šåª’é«”&lt;/li>
&lt;li>è¦å¦‚ä½•æ¥æ”¶ä¸²æµçš„è³‡è¨Š (å¦‚ ä½å€ã€Portã€æ ¼å¼ç­‰)&lt;/li>
&lt;li>æœƒè©±éœ€è¦çš„å¸¶å¯¬è³‡è¨Š&lt;/li>
&lt;li>å€‹äººçš„è¯çµ¡è³‡æ–™&lt;/li>
&lt;/ol>
&lt;h2 id="åª’é«”èˆ‡å‚³è¼¸è³‡è¨Š">åª’é«”èˆ‡å‚³è¼¸è³‡è¨Š&lt;/h2>
&lt;p>é€™éƒ¨åˆ†åŒ…å«äº†&lt;/p>
&lt;ol>
&lt;li>åª’é«”å½¢å¼ (å½±ç‰‡ã€è²éŸ³ç­‰)&lt;/li>
&lt;li>å‚³è¼¸å”å®š (RTP/UDP/IPç­‰)&lt;/li>
&lt;li>åª’é«”æ ¼å¼ (H. 264/MPEGç­‰)&lt;/li>
&lt;/ol>
&lt;p>å¦å¤–é‚„æœƒåŒ…å«ä½å€èˆ‡åŸ å£çš„è³‡è¨Šï¼ŒSDP å‚³è¼¸å½¢å¼åŒ…å«å–®æ’­(unicast)è·Ÿå¤šæ’­(multicast)ï¼Œå¤šæ’­å‰‡åŒ…å«å¤šæ’­çš„ç¾¤çµ„ä½å€ï¼Œå–®æ’­å‰‡æ˜¯å–®ä¸€å°çš„ä½å€&lt;/p>
&lt;h2 id="æ™‚é–“è³‡è¨Š">æ™‚é–“è³‡è¨Š&lt;/h2>
&lt;ol>
&lt;li>ä»»æ„æ•¸é‡çš„é–‹å§‹èˆ‡çµæŸæ™‚é–“çµ„åˆ&lt;/li>
&lt;li>é€±æœŸæ€§è¡¨ç¤º (å¦‚æ¯é€±ä¸‰æ—©ä¸Šåé»ä¸€å°æ™‚)
æ™‚é–“è¡¨ç¤ºæ˜¯å…¨çƒçµ±ä¸€æ ¼å¼ï¼Œä¸åŒ…å«æ™‚å€æˆ–æ˜¯æ—¥å…‰ç¯€ç´„æ™‚é–“&lt;/li>
&lt;/ol>
&lt;h2 id="ç§äººæœƒè©±">ç§äººæœƒè©±&lt;/h2>
&lt;p>SDP æœ¬èº«ä¸æ¶‰åŠ public æˆ– private sessionï¼Œå¦‚æœéœ€è¦åŠ å¯†æˆ–æ˜¯é™å®šï¼Œå‰‡åœ¨å‚³è¼¸æ™‚è‡ªè¡Œæ±ºå®š&lt;/p>
&lt;h2 id="å…¶ä»–">å…¶ä»–&lt;/h2>
&lt;p>SDP æœ¬èº«å°±æ‡‰è©²å¤¾å¸¶è¶³å¤ çš„è³‡è¨Šè®“åƒèˆ‡è€…çŸ¥é“æ˜¯å¦è©²åŠ å…¥ sessionï¼Œä½†å¦‚æœæœ‰å…¶ä»–é¡å¤–è³‡è¨Šè¦å¤¾å¸¶ï¼Œå¯ä»¥æ”¾åœ¨å¦å¤–çš„ URI ä¸­ï¼›&lt;/p>
&lt;h1 id="sdp-spec">SDP Spec&lt;/h1>
&lt;p>æ–‡å­—ç·¨ç¢¼ä¸Šï¼ŒSDP æ¡ç”¨ ISO 10646 å­—ç¬¦é›†ä¸¦ç”¨ UTF-8 ç·¨ç¢¼æ–¹å¼ï¼Œä½†æ˜¯åœ¨å±¬æ€§/æ¬„ä½ä¸Šæ¡ç”¨ UTF-8 çš„å­é›†åˆ US-ASCIIï¼Œåªæœ‰åœ¨æ–‡å­—æ¬„ä½å¯ä»¥ä½¿ç”¨å®Œæ•´çš„ ISO 10646 å­—ç¬¦é›†&lt;/p>
&lt;p>SDP æ˜¯ç”±é€™æ¨£æ ¼å¼çš„æ–‡å­—çµ„æˆ&lt;/p>
&lt;blockquote>
&lt;p>&amp;lt;type&amp;gt;=&amp;lt;value&amp;gt;&lt;/p>
&lt;/blockquote>
&lt;p>type å¿…é ˆæ˜¯å–®ä¸€å€‹å¤§å°å¯«å€åˆ†çš„å­—å…ƒï¼›
value å‰‡æ˜¯ç›¸å°æ‡‰æœ‰çµæ§‹çš„æ–‡å­—ï¼Œå¤šå€‹å€¼å¯ä»¥ç”¨ç©ºç™½åˆ†éš”ï¼›
åˆ‡è¨˜åœ¨ = å…©å´ä¸å¯ä»¥æœ‰ç©ºç™½&lt;/p>
&lt;p>SDP ä¸­åŒ…å«äº† session-level å€æ®µèˆ‡å¤šå€‹ media-level å€æ®µï¼Œsession-level å€æ®µä»¥ &lt;code>v=&lt;/code> é–‹å§‹ï¼Œå…¶å±¬æ€§å¥—ç”¨åœ¨æ‰€æœ‰çš„ media å€æ®µä¸Šï¼Œä½†å¦‚æœ media å€æ®µæœ‰ç›¸åŒå±¬æ€§å‰‡æœƒè¢«è¦†è“‹ï¼›
è€Œ media-level å‰‡æ˜¯ &lt;code>m=&lt;/code>é–‹å§‹ç›´åˆ°ä¸‹ä¸€å€‹ media level å€æ®µé–‹å§‹&lt;/p>
&lt;p>åœ¨ SDP å®šç¾©çš„é †åºå¾ˆé‡è¦ï¼Œä¸»è¦æ˜¯å¹«åŠ©æ›´å¿«çš„éŒ¯èª¤åµæ¸¬èˆ‡å®¹æ˜“å¯¦ä½œ parser&lt;/p>
&lt;p>æœ‰äº›æ¬„ä½æ˜¯å¿…å¡«æœ‰äº›æ˜¯é¸æ“‡æ€§ï¼Œä½†é‡é»æ˜¯ä¸€å®šè¦æŒ‰ç…§é †åºï¼Œé¸æ“‡æ€§æ¬„ä½ä»¥ * è¨»è¨˜ï¼Œå±¬æ€§æ¬„ä½å¤§è‡´ä»‹ç´¹å«ç¾©ï¼Œä¸æœƒå®Œæ•´ä»‹ç´¹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">Session description
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> v= (protocol version)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> o= (originator and session identifier)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> s= (session name)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> i=* (session information)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> u=* (URI of description)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> e=* (email address)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> p=* (phone number)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> c=* (connection information -- not required if included in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> all media)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> b=* (zero or more bandwidth information lines)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> One or more time descriptions (&amp;#34;t=&amp;#34; and &amp;#34;r=&amp;#34; lines; see below)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> z=* (time zone adjustments)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k=* (encryption key)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> a=* (zero or more session attribute lines)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Zero or more media descriptions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Time description
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> t= (time the session is active)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> r=* (zero or more repeat times)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Media description, if present
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> m= (media name and transport address)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> i=* (media title)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> c=* (connection information -- optional if included at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> session level)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> b=* (zero or more bandwidth information lines)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k=* (encryption key)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> a=* (zero or more media attribute lines
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>a= å±¬æ€§æ©Ÿåˆ¶ä¸»è¦æ˜¯æ“´å±• SDPï¼Œç”±å„å€‹ä½¿ç”¨ SDP çš„å”å®šå»ä½¿ç”¨
æœ‰äº›å±¬æ€§æœ‰åˆ¶å¼çš„å«ç¾©ï¼Œæœ‰äº›å‰‡åŸºæ–¼æ‡‰ç”¨ç¨‹å¼çš„è§£è®€ï¼Œä¾‹å¦‚&lt;/p>
&lt;p>æœ‰äº›å®šç¾©åœ¨ Session-level çš„å±¬æ€§å¦‚ é€£ç·šç›¸é—œ c= æˆ–æ˜¯å±¬æ€§ç›¸é—œ a= æœƒå¥—ç”¨åœ¨ Session åº•ä¸‹æ‰€ä»¥çš„ Mediaï¼Œé™¤éè¢«ç‰¹åˆ¥æŒ‡å®šè¦†å¯«&lt;/p>
&lt;p>å¦‚ä»¥ä¸‹ç¯„ä¾‹ï¼Œæ‰€æœ‰çš„ media éƒ½æœƒè¢«å† ä¸Š recvonly çš„å±¬æ€§&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">v= 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">o=jdoe 2890844526 2890842807 IN IP4 10.47.16.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">s=SDP Seminar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">i=A Seminar on the session description protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">u=http://www.example.com/seminars/sdp.pdf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">e=j.doe@example.com (Jane Doe)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c=IN IP4 224.2.17.12/127
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">t=2873397496 2873404696
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=recvonly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">m=audio 49170 RTP/AVP 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">m=video 51372 RTP/AVP 99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=rtpmap:99 h263-1998/900000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ–‡å­—æ¬„ä½å¦‚ session åç¨±å’Œè³‡è¨Šç­‰å¯ä»¥æ˜¯åŒ…å«ä»»æ„ä½å…ƒçµ„çš„å­—ä¸²é™¤äº†ä»¥ä¸‹ 0x00 Nul ã€ 0x0a (new line) ã€ 0x0d (carriage return) ï¼›
å­—ä¸²ä»¥ CRLF(0x0d0a) ç•¶ä½œæ–·è¡Œï¼Œä½† parser ä¹Ÿæ‡‰è©²å°‡ newline è¦–ç‚ºæ–·è¡Œçš„æ¨™èªŒï¼›
å¦‚æœæ²’æœ‰ a=charset å±¬æ€§æŒ‡å®šå­—ç¬¦é›†ï¼Œå‰‡é è¨­ç‚º ISO-10646 å­—ç¬¦é›†æ­é… UTF-8 ç·¨ç¢¼æ–¹å¼&lt;/p>
&lt;p>å¦‚æœæ˜¯åŒ…å« domain nameï¼Œå‰‡å¿…é ˆç¢ºä¿ç¬¦åˆ ASCII Compatible Encoding (ACE)ï¼Œä¹Ÿå°±æ˜¯è¦ç¶“éç·¨ç¢¼è·³è„«å­—å…ƒï¼Œå› ç‚ºæœ‰äº› SDP ç›¸é—œå”å®šå®šç¾©æ—©æ–¼åœ‹éš›åŒ– domain nameï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ UTF-8 è¡¨ç¤º&lt;/p>
&lt;p>æ¬„ä½ä»‹ç´¹&lt;/p>
&lt;h3 id="å”å®šç‰ˆæœ¬-v">å”å®šç‰ˆæœ¬ (v=)&lt;/h3>
&lt;p>æ²’æœ‰å…¶ä»–ç‰ˆæœ¬è™Ÿï¼Œå°±æ˜¯ v=0&lt;/p>
&lt;h3 id="ä¾†æº-o">ä¾†æº (o=)&lt;/h3>
&lt;p>æè¿°Session çš„ç™¼èµ·è€…è³‡æ–™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">o=&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">sess-id&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">sess-version&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">nettype&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">addrtype&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;&lt;/span>&lt;span class="nt">unicast-address&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>sess-idï¼šæ•¸å­—çµ„æˆçš„å­—ä¸²ï¼Œç”±&lt;username> &lt;sess-id> &lt;sess-version> &lt;nettype> å››è€…çµ„æˆçš„å­—ä¸²å¿…é ˆæ˜¯å…¨åŸŸå”¯ä¸€çš„ (globally unique)ï¼Œsess-id çš„ç”¢ç”Ÿå¯è‡ªè¡Œå®šç¾©ï¼Œä½†å»ºè­°æ¡ç”¨ NTP æ ¼å¼çš„ timestamp ä¿è­‰å”¯ä¸€æ€§&lt;/li>
&lt;li>sess-versionï¼šæ­¤ Session æè¿°çš„ç‰ˆè™Ÿï¼Œåœ¨æ”¹è®Š SDP å…§å®¹æ™‚ç¢ºä¿ç‰ˆè™Ÿæ˜¯éå¢çš„ï¼ŒåŒæ¨£å»ºè­°ç”¨ NTP æ ¼å¼ timestamp&lt;/li>
&lt;li>nettypeï¼šæ¡ç”¨ç¶²è·¯é¡å‹&lt;/li>
&lt;li>addrtypeï¼šæŒ‡å®š address çš„é¡å‹ï¼Œä¾‹å¦‚ IP4 / IP6 ç­‰&lt;/li>
&lt;li>unicast-addressï¼š
å‰µå»º session æ©Ÿå™¨çš„ä½å€ï¼Œå¯ä»¥æ˜¯ domain name æˆ–æ˜¯ IP è¡¨ç¤ºæ³•ï¼Œä¸å¯ä½¿ç”¨ local ip å› ç‚ºä¸ç¢ºå®šå°æ–¹æ˜¯å¦åœ¨ local ç¯„åœå…§&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæœ‰éš±ç§å•é¡Œï¼Œ username / unicast-address å¯ä»¥è¢«æ··æ·†ï¼Œåªè¦ä¸å½±éŸ¿å…¨åŸŸå”¯ä¸€æ€§&lt;/p>
&lt;h3 id="session-åç¨±-s">Session åç¨± (s=)&lt;/h3>
&lt;p>æ–‡å­—æ¬„ä½ï¼Œè¡¨ç¤º Session åç¨±ï¼Œæ¯ä»½ Session description ä¸­åªèƒ½æœ‰ä¸€å€‹ï¼Œä¸èƒ½ç‚ºç©ºå€¼ä¸”å¿…é ˆæ¡ç”¨ ISO-10646 å­—å…ƒ (é™¤éæœ‰å¦å¤–æŒ‡å®šå­—ç¬¦é›†)ï¼Œå¦‚æœæ²’æœ‰è¦ç‰¹åˆ¥æŒ‡å®š Session åç¨±ï¼Œå¯ä»¥ç”¨ç©ºç™½ä»£æ›¿å¦‚ (s= )&lt;/p>
&lt;h3 id="session-è³‡è¨Š-i">Session è³‡è¨Š (i=)&lt;/h3>
&lt;p>æ–‡å­—æ¬„ä½ï¼Œæ¯ä»½ session description ä¸­æ¯å€‹ session æœ€å¤šåªèƒ½æœ‰ä¸€å€‹ï¼Œæ¯å€‹ media æœ€å¤šä¹Ÿåªèƒ½å®£å‘Šä¸€å€‹ï¼›
é€™è³‡è¨Šä¸»è¦æ˜¯å¯«çµ¦äººé¡é–±è®€çš„ï¼Œç”¨ä¾†è¡¨ç¤º session æˆ–æ˜¯ media stream çš„ç”¨è™•&lt;/p>
&lt;h3 id="uri-u">URI (u=)&lt;/h3>
&lt;p>é¸æ“‡æ€§æ¬„ä½ï¼Œç”¨ä¾†è¡¨ç¤ºé—œæ–¼Sessioné¡å¤–è³‡è¨Šçš„ä½å€é€£çµï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€å€‹ï¼Œå¿…é ˆæ”¾ç½®åœ¨ media æ¬„ä½ä¹‹å‰&lt;/p>
&lt;h3 id="email-åŠé›»è©±è™Ÿç¢¼-e--p">Email åŠé›»è©±è™Ÿç¢¼ (e= , p=)&lt;/h3>
&lt;p>è¯çµ¡äººçš„ email è·Ÿé›»è©±è™Ÿç¢¼&lt;/p>
&lt;h3 id="é€£ç·šè³‡è¨Š-c">é€£ç·šè³‡è¨Š (â€œc=â€œ)&lt;/h3>
&lt;p>&lt;code>c=&amp;lt;nettype&amp;gt; &amp;lt;addrtype&amp;gt; &amp;lt;connection-address&amp;gt;&lt;/code>
ä¸€ä»½ session description å¿…é ˆåŒ…å«ä¸€å€‹æˆ–æ˜¯ media description è‡³å°‘ä¸€å€‹&lt;/p>
&lt;ol>
&lt;li>nettypeï¼š
æ¡ç”¨ç¶²è·¯é¡å‹ï¼ŒIN è¡¨ç¤º internetï¼Œä½†æœªä¾†å¯èƒ½æœ‰å…¶ä»–çš„æ”¯æ´&lt;/li>
&lt;li>addrtypeï¼š
ä½å€é¡å‹ï¼Œå¯ä»¥æ˜¯é IP å®¶æ—çš„&lt;/li>
&lt;li>connection addressï¼š
ä¾æ“šä½å€é¡å‹ï¼Œé¡¯ç¤ºä¸åŒçš„æ ¼å¼&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæ˜¯æ‡‰ç”¨åœ¨å¤šæ’­çš„å ´æ™¯ä¸‹ï¼ŒIPv4 éœ€è¦åœ¨ç¶²å€å¾ŒåŠ ä¸Š TTLï¼Œè€Œ IPv6 æ²’æœ‰ TTL çš„æ¦‚å¿µ
åœ¨éšå±¤å¼çš„ç·¨ç¢¼ä¸‹ï¼Œè³‡æ–™ä¸²æµå¯èƒ½è¢«ä¾ç…§ä¸åŒé »å¯¬æ‹†åˆ†æˆä¸åŒçš„ä¾†æºï¼Œå¯ä»¥åœ¨ä½å€åŠ ä¸Šä¾†æºæ•¸é‡ï¼ŒIP ä½ç½®æœƒä»¥é€£çºŒçš„æ–¹å¼å‘ˆç¾
ä¾‹å¦‚èªª&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">c=IN IP4 224.2.1.1/127/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">é€™ç­‰åŒæ–¼åœ¨ media description ä¸­å¦‚æ­¤è¡¨ç¤º
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c=IN IP4 224.2.1.1/127
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c=IN IP4 224.2.1.2/127
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c=IN IP4 224.2.1.3/127
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="é »å¯¬-b">é »å¯¬ (b=)&lt;/h3>
&lt;p>é¡¯ç¤ºé è¨ˆä½¿ç”¨çš„é »å¯¬ï¼Œæ ¹æ“šä¸åŒçš„ bwtype æœ‰ä¸åŒå«æ„
&lt;code>b=&amp;lt;bwtype&amp;gt;:&amp;lt;bandwidth&amp;gt;&lt;/code>&lt;/p>
&lt;ol>
&lt;li>CTï¼šconference total
å…¨éƒ¨ Conference å¸¶å¯¬ä¸Šé™ï¼Œå¯èƒ½ä¸€å€‹ Conference åŒ…å«å¤šå€‹ sessionï¼Œå‰‡å»ºè­°æ‰€æœ‰ session ä½¿ç”¨çš„å¸¶å¯¬åŠ ç¸½åˆ&lt;/li>
&lt;li>ASï¼šapplication specifivc&lt;/li>
&lt;/ol>
&lt;h3 id="timing-t">Timing (t=)&lt;/h3>
&lt;p>&lt;code>t=&amp;lt;start-time&amp;gt; &amp;lt;stop-time&amp;gt;&lt;/code>
è¡¨ç¤º Session çš„é–‹å§‹çµæŸæ™‚é–“
å¦‚æœæ²’æœ‰æŒ‡å®š stop-timeï¼Œå‰‡ Session ç‚º unboundedï¼Œè¡¨ç¤ºåœ¨ start-time ä¹‹å¾Œ Session ä¸€ç›´ä¿æŒæ´»èº
å¦‚æœé€£ start-time ä¹Ÿæ²’æŒ‡å®šï¼Œå‰‡è¡¨ç¤º Session æ˜¯æ°¸ä¹…å­˜åœ¨&lt;/p>
&lt;p>å»ºè­°ä¸è¦æ¡ç”¨ unbounded Sessionï¼Œå› ç‚º client ä¸çŸ¥é“ Session ä½•æ™‚çµæŸï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•æ’ç¨‹&lt;/p>
&lt;h3 id="é‡è¤‡æ¬¡æ•¸-r">é‡è¤‡æ¬¡æ•¸ (r=)&lt;/h3>
&lt;p>&lt;code>r=&amp;lt;repeat interval&amp;gt; &amp;lt;active duration&amp;gt; &amp;lt;offsets from start-time&amp;gt;&lt;/code>
é€™æœƒæ­é… t åšä½¿ç”¨ï¼Œä¾‹å¦‚èªªä¸€å€‹ç¯€ç›®æ˜¯æ¯æ¬¡æ’­æ”¾ä¸€å°æ™‚ï¼Œæ–¼é€±ä¸€ 10am é–‹æ’­ï¼Œæ¥è‘—æ¯é€±äºŒ 11am æ¯é€±æ’­æ”¾æŒçºŒä¸‰å€‹æœˆï¼Œå‰‡è¡¨ç¤ºæ³•ç‚º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">t=3034423619 3042462419
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">r=604800 3600 0 90000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æˆ–é€™æ¨£è¡¨ç¤º
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">r=7d 1h 0 25h
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3034423619 æ˜¯é–‹å§‹æ™‚é–“ï¼Œä¹Ÿå°±æ˜¯æŸé€±ä¸€ 10am
3042462419 æ˜¯çµæŸæ™‚é–“ï¼Œä¹Ÿå°±æ˜¯é–‹æ’­ä¸‰å€‹æœˆå¾Œçš„é€±äºŒ 11am&lt;/p>
&lt;p>7d æ˜¯æ’­æ”¾é–“éš”ï¼Œæ‰€ä»¥æ˜¯ 7å¤©çš„ç§’æ•¸
1h æ˜¯æ’­æ”¾çš„æ™‚é•·
0 25h æ˜¯è·é›¢ start time çš„æ™‚é–“é–“éš”ï¼Œä¹Ÿå°±æ˜¯(é€±äºŒ 11am - é€±ä¸€ 10am)&lt;/p>
&lt;p>å¦‚æœæ˜¯ä»¥æœˆæˆ–å¹´é‡è¤‡çš„æ’­æ”¾ï¼Œå‰‡ä¸èƒ½ä½¿ç”¨ r è¡¨ç¤ºï¼Œéœ€è¦æ”¹ç”¨å¤šå€‹çš„ t è¡¨ç¤ºæ’­æ”¾æ™‚é–“&lt;/p>
&lt;h3 id="æ™‚å€-z">æ™‚å€ (z=)&lt;/h3>
&lt;p>é€™æ¬„ä½æœƒå½±éŸ¿ t è·Ÿ r
&lt;code>z=&amp;lt;adjustment time&amp;gt; &amp;lt;offset&amp;gt; &amp;lt;adjustment time&amp;gt; &amp;lt;offset&amp;gt; ....&lt;/code>
å¦‚æœæ˜¯ä¸€å€‹é‡è¤‡æ’­æ”¾çš„ Sessionï¼Œå¯èƒ½æœƒé‡åˆ°æ—¥å…‰ç¯€ç´„æ—¥ï¼Œæ‰€ä»¥è¦ä¸»å‹•æ¸›å»ä¸€å°æ™‚ï¼Œåˆå› ç‚ºä¸åŒçš„åœ‹å®¶èˆ‡åœ°å€å°æ–¼æ—¥å…‰ç¯€ç´„æ—¥çš„è¨ˆç®—ä¸åŒï¼Œæ‰€ä»¥ä¿ç•™è¡¨ç¤ºçš„å½ˆæ€§ï¼Œå¦‚
&lt;code>z=2882844526 -1h 2898848070 0&lt;/code>
åœ¨é‡è¤‡æ’­æ”¾æ™‚é–“æ˜¯ 2882844526 è¦æ¸›å»ä¸€å°æ™‚ï¼Œä½†æ˜¯åœ¨ 2898848070 å°±æ¢å¾©æ­£å¸¸&lt;/p>
&lt;h3 id="åŠ å¯†é‡‘é‘°-k">åŠ å¯†é‡‘é‘° (k=)&lt;/h3>
&lt;p>å¦‚æœ SDP æ˜¯åœ¨å·²å®‰å…¨ä»¥åŠå¯è¢«ä¿¡ä»»çš„æ–¹å¼å‚³éä¸‹ï¼Œå¯ä»¥è€ƒæ…®å‚³éåŠ å¯†çš„é‡‘é‘°(åŠ å¯† media stream è€Œé session description æœ¬èº«)ï¼Œé€™å€‹æ¬„ä½ä¸å‚³é”åŠ å¯†çš„æ¼”ç®—æ³•ã€é‡‘é‘°é¡å‹ç­‰ï¼Œé€™äº›å…¨ç•™çµ¦æ¡ç”¨ SDPçš„å”å®šå»è¦ç¯„&lt;/p>
&lt;p>ç›®å‰æ”¯æ´ä»¥ä¸‹å¹¾ç¨®å®šç¾©&lt;/p>
&lt;ol>
&lt;li>&lt;code>k=clear:&amp;lt;encryption key&amp;gt;&lt;/code>ï¼škey æ²’æœ‰æ”¹è®Šé&lt;/li>
&lt;li>&lt;code>k=base64:&amp;lt;encoded encryption key&amp;gt;&lt;/code>ï¼šç”¨ base64 å°‡ key ç·¨ç¢¼&lt;/li>
&lt;li>&lt;code>k=uri:&amp;lt;URI to obtain key&amp;gt;&lt;/code>ï¼šæŒ‡åå» URI æ‹¿ keyï¼Œé€šå¸¸ URI æœƒèµ°å®‰å…¨é€šé“ï¼Œä¾‹å¦‚ HTTPS ç­‰&lt;/li>
&lt;li>&lt;code>k=prompt&lt;/code>ï¼šé›–ç„¶ Session æœ‰åŠ å¯†ä½†æ˜¯ session description æ²’æœ‰æä¾› keyï¼Œç”¨æˆ¶è¦é¡å¤–å»ç´¢å–&lt;/li>
&lt;/ol>
&lt;p>å†æ¬¡å¼·èª¿ SDP æœ¬èº«è¦æ˜¯åœ¨å®‰å…¨çš„æƒ…æ³ä¸‹æ‰èƒ½åŠ  k æ¬„ä½&lt;/p>
&lt;h3 id="å±¬æ€§-a">å±¬æ€§ (a=)&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl"> a=&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">attribute&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> a=&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">attribute&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>:&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å±¬æ€§å€¼ä¸»è¦ç”¨ä¾†æ“´å±• SDPï¼Œå¯ä»¥ç”¨åœ¨ session level è£œå……å° conference çš„è³‡è¨Šï¼Œä¹Ÿå¯æ”¾åœ¨ media level å‚³é media stream çš„è³‡è¨Šï¼Œåœ¨ SDP æœƒæœ‰è‹¥å¹²çš„å±¬æ€§å€¼å®£å‘Š&lt;/p>
&lt;p>å±¬æ€§å€¼æœ‰å…©ç¨®å®£å‘Šæ–¹å¼&lt;/p>
&lt;ol>
&lt;li>Flagæ¦‚å¿µ (a=&lt;flag>)ï¼Œä¾‹å¦‚ a=recvonly&lt;/li>
&lt;li>éµå€¼ (a=&lt;attribute>:&lt;value>)ï¼Œå¦‚ a=orient:landscape&lt;/li>
&lt;/ol>
&lt;p>è‡³æ–¼å¦‚ä½•è™•ç†èˆ‡å®šç¾©å±¬æ€§å€¼ï¼Œæœ‰äº›å±¬æ€§æœ‰å®šç¾©çš„å«ç¾©ï¼Œå…¶é¤˜å‰‡æ‡‰ç”¨ç¨‹å¼å¯ä»¥å½ˆæ€§è™•ç†&lt;/p>
&lt;h3 id="media-description-m">media description (m=)&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl"> m=&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">media&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">proto&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">fmt&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> ...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸€ä»½ session description ä¸­å¯èƒ½å«æœ‰å¤šå€‹ media descriptionï¼Œæ¯ä¸€ä»½ media description å¾ &lt;code>m=&lt;/code> é–‹å§‹ç›´åˆ°ä¸‹ä¸€å€‹ &lt;code>m=&lt;/code>æˆ–æ˜¯ session description çµæŸ&lt;/p>
&lt;ol>
&lt;li>media
é¡åˆ¥ï¼Œå¯ä»¥æ˜¯ audio / video / text ç­‰&lt;/li>
&lt;li>port
ä¸²æµå¾å“ªå€‹ port ç™¼é€ï¼Œé€™æœƒæ ¹æ“š connection infomation (c=) è€Œæ±ºå®šï¼Œå°æ–¼æŸäº›å‚³è¼¸å”å®šï¼Œå¦‚ rtp æœƒä½¿ç”¨å…©å€‹ port (RTP+RTCP)ï¼Œæ‰€ä»¥å®£å‘Šæ™‚æœƒæ˜¯ &lt;code>m=video 49170/2 RTP/AVP 31&lt;/code>ï¼Œè¡¨ç¤º RTP ä½¿ç”¨ 49170 / RTCP ä½¿ç”¨ 49171ï¼›
å¦‚æœ c æŒ‡å®šå¤šå€‹ IP ä½ç½®ï¼Œå‰‡ port æˆä¸€å°ä¸€æ˜ å°„é—œä¿‚ï¼Œå¦‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">c=IN IP4 224.2.1.1/127/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">m=video 49170/2 RTP/AVP 31
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre>&lt;code>å‰‡å› ç‚º RTP ä¸€æ¬¡ä½¿ç”¨å…©å€‹ portï¼Œé€™è¡¨ç¤º 224.2.1.1 ä½¿ç”¨ 49170ã€49171ï¼Œ224.2.1.2 ä½¿ç”¨ 49172ã€49173
&lt;/code>&lt;/pre>
&lt;ol start="3">
&lt;li>proto
æŒ‡å®šå‚³è¼¸å”å®šï¼Œå¸¸ç”¨çš„æœ‰ udp ã€ RTP/AVPã€RTP/SAVP ç­‰&lt;/li>
&lt;li>fmt
åª’é«”æ ¼å¼ï¼Œæœƒè·Ÿè‘— &lt;proto> çš„å®šç¾©ï¼Œå¦‚æœ &lt;proto> æ˜¯ udp å‰‡ &lt;fmt> éœ€è¦æŒ‡å®š audio / video / text / application / message ä¸€è€…&lt;/li>
&lt;/ol>
&lt;h1 id="sdp-attributes">SDP Attributes&lt;/h1>
&lt;ol>
&lt;li>a=cat:&lt;category>
ç”¨é€—é»åˆ†éš”ï¼Œç”¨ä¾†éæ¿¾ category&lt;/li>
&lt;li>a=keywds:&lt;keywords>
é¡ä¼¼æ–¼ cat å±¬æ€§ï¼Œé€éé—œéµå­—ç¯©é¸æƒ³è¦çš„ session&lt;/li>
&lt;li>a=tool:&lt;name and version of tool>
è¡¨ç¤ºç”¨ä¾†å‰µå»º session å·¥å…·çš„åç¨±èˆ‡ç‰ˆè™Ÿ&lt;/li>
&lt;li>a=ptime:&lt;packet time>
ç”¨ ms è¡¨ç¤ºä¸€å€‹å°åŒ…ä¸­åª’é«”çš„ç¸½æ™‚é•·&lt;/li>
&lt;li>a=maxptime:&lt;maximum packet time>
ç”¨ ms è¡¨ç¤ºä¸€å€‹å°åŒ…ä¸­åª’é«”çš„ç¸½æ™‚é•·ä¸Šé™&lt;/li>
&lt;li>a=rtpmap:&lt;payload type> &lt;encoding name>/&lt;clock rate> [/&lt;encoding parameters>]
æ­é… media type(m=)å®£å‘Šï¼Œè£œå……RTPæ‰€æ¡ç”¨çš„ç·¨ç¢¼æ–¹å¼ï¼Œé›–ç„¶ RTP æª”æ¡ˆæœ¬èº«å°±æœƒåŒ…å« payload æ ¼å¼ï¼Œä½†æ˜¯å¸¸è¦‹åšæ³•æ˜¯é€éåƒæ•¸è¨­å®šå‹•æ…‹æ”¹è®Š
ä¾‹å¦‚èªª &lt;code>u-law PCM coded single-channel audio sampled at 8 kHz&lt;/code>ï¼Œä»–çš„ encode æ–¹å¼å›ºå®šåªæœ‰ä¸€ç¨®ï¼Œæ‰€ä»¥ä¸éœ€è¦å¦å¤–å®£å‘Šrtpmap&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">m=audio 49232 RTP/AVP 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">```bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ä½†å¦‚æœæ˜¯ &lt;span class="sb">`16-bit linear encoded stereo audio sampled at 16 kHz`&lt;/span>ï¼Œå¸Œæœ›ç”¨ RTP/AVP payload æ ¼å¼ 98 çš„è©±ï¼Œå°±å¿…é ˆå¦å¤–å®£å‘Šè§£ç¢¼æ–¹å¼
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>m=audio 49232 RTP/AVP 98
a=rtpmap:98 L16/16000/2&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> rtpmap å¯ä»¥é‡å° payload æ ¼å¼åšæ˜ å°„ï¼Œå¦‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">```md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">m=audio 49230 RTP/AVP 96 97 98
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=rtpmap:96 L8/8000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=rtpmap:97 L16/8000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a=rtpmap:98 L16/11025/2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre>&lt;code>åƒæ•¸å°æ‡‰çš„åƒæ•¸å¯ä»¥åƒè€ƒ [RTP Profile for Audio and Video Conferences with Minimal Control](https://tools.ietf.org/html/rfc3551)
&lt;/code>&lt;/pre>
&lt;ol start="7">
&lt;li>a=recvonly
è¡¨æ˜å–®ç´”æ¥æ”¶&lt;/li>
&lt;li>a=sendrecv
å¯ä»¥æ¥æ”¶èˆ‡ç™¼é€ï¼Œæ­¤ç‚ºé è¨­å€¼&lt;/li>
&lt;li>a=sendonly
å–®ç´”ç™¼é€&lt;/li>
&lt;li>a=inactive
ä¸æ¥æ”¶ä¹Ÿä¸ç™¼é€åª’é«”ï¼ŒåŸºæ–¼ RTP ç³»çµ±çš„å³ä½¿æ˜¯ inactive ä¹Ÿè¦æŒçºŒç™¼é€ RTCP&lt;/li>
&lt;li>a=orient:&lt;orientation>
ç”¨æ–¼ç™½æ¿æˆ–æ˜¯ä»‹ç´¹çš„å·¥å…·ï¼Œå¯ä»¥æŒ‡å®š portrait / landscape / seascape(ä¸Šä¸‹é¡›å€’çš„ landscape)&lt;/li>
&lt;li>a=framerate:&lt;frame rate>
video frame rate æœ€å¤§å€¼ï¼Œåªæœ‰ medial level çš„ video é¡å‹éœ€è¦&lt;/li>
&lt;li>a=sdplang:&lt;language tag>
SDP è³‡è¨Šæ¡ç”¨çš„èªè¨€ï¼Œå¦‚æœæœ‰å¤šç¨®èªè¨€å»ºè­°æ¯ç¨®èªè¨€éƒ½æ‹†æˆç¨ç«‹çš„ session description&lt;/li>
&lt;li>a=fmtp:&lt;format> &lt;format specific parameters>
ç”¨ä¾†å‚³é”æŸäº›ç‰¹å®šæ ¼å¼ï¼Œä¸”é€™äº›ç‰¹å®šæ ¼å¼ä¸éœ€è¦æ˜¯ SDP æ‰€èƒ½ç†è§£çš„&lt;/li>
&lt;/ol>
&lt;h2 id="å®‰å…¨è€ƒé‡">å®‰å…¨è€ƒé‡&lt;/h2>
&lt;p>SDP å¸¸ç”¨æ–¼ offer/answer æ¨¡å‹çš„ SIP ä¸­ï¼Œç”¨ä¾†æºé€šå–®æ’­çš„æœƒè©±æ©Ÿåˆ¶ï¼Œç•¶æ¡ç”¨é€™æ¨£çš„æ¨¡å¼æ™‚ï¼Œè¦è¨˜å¾—è€ƒé‡å”å®šæœ¬èº«çš„å®‰å…¨æ€§&lt;/p>
&lt;p>SDP åªæ˜¯ç”¨ä¾†æè¿°å¤šåª’é«”æœƒè©±çš„å…§å®¹ï¼Œæ¥æ”¶æ–¹è¦æ³¨æ„ session description æ˜¯å¦é€šéå¯ä¿¡ä»»çš„ç®¡é“èˆ‡ä¾†è‡ªå¯ä¿¡ä»»çš„ä¾†æºï¼Œå¦å‰‡ç¶²è·¯å‚³è¼¸éç¨‹å¯èƒ½é­é‡æ”»æ“Šï¼Œå¿…é ˆè¦è‡ªå·±æ‰¿æ“”å®‰å…¨ä¸Šçš„é¢¨éšª&lt;/p>
&lt;p>å¸¸ç”¨çš„å‚³è¼¸æ–¹å¼æ˜¯ SAPï¼ŒSAP æœ¬èº«æä¾›åŠ å¯†èˆ‡é©—è­‰æ©Ÿåˆ¶ï¼›
ä¸éæœ‰äº›æƒ…æ³ä¸‹ç„¡æ³•æ¡ç”¨ï¼Œä¾‹å¦‚æ¥æ”¶è€…äº‹å‰ä¸çŸ¥é“ç™¼é€è€…çš„æ™‚å€™ï¼Œæ­¤æ™‚å°±è¦ç‰¹åˆ¥å°å¿ƒ parseï¼Œä¸¦æ³¨æ„æ¬Šé™çš„ç®¡æ§(åƒ…é–‹æ”¾æœ‰é™çš„è»Ÿé«”å¯ä»¥æ“ä½œ)&lt;/p></description></item><item><title>å¦‚ä½•è¨­è¨ˆ REST API</title><link>https://yuanchieh.page/posts/2019/2019-09-18-%E5%A6%82%E4%BD%95%E8%A8%AD%E8%A8%88-rest-api/</link><pubDate>Wed, 18 Sep 2019 00:08:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-09-18-%E5%A6%82%E4%BD%95%E8%A8%AD%E8%A8%88-rest-api/</guid><description>&lt;p>å¾Œç«¯å·¥ç¨‹å¸«æœ€åŸºæœ¬çš„æŠ€èƒ½è¦æ±‚æ˜¯è¨­è¨ˆç¬¦åˆ HTTP-based REST çš„APIï¼Œå·¥ä½œå…©å¹´å¤šå¿«ä¸‰å¹´ï¼Œè‡ªå·±è…¦ä¸­ç¬¬ä¸€åæ‡‰å¤§æ¦‚æœƒæ˜¯&lt;/p>
&lt;blockquote>
&lt;p>æŠŠURLè¦–ç‚ºè³‡æºè·¯å¾‘çš„æè¿°ï¼ŒæŠŠå°æ‡‰çš„CRUD æ“ä½œå°æ‡‰è‡³ HTTP Methodï¼Œä¾‹å¦‚è¦ä¸‹ä¸€ç­†è¨‚å–®æ˜¯ &lt;code>POST /booking&lt;/code> ï¼Œå–å¾—å–®ç­†è¨‚å–®æ˜¯ &lt;code>GET /booking/1&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>ä½†ä¸–ç•Œæ²’æœ‰é€™éº¼å–®ç´”ï¼Œå¦‚æœæ˜¯é‡åˆ°è¤‡é›œçš„æ“ä½œæ™‚ï¼Œé›£ä»¥é‹ç”¨ HTTP çš„ Methodå‹•è© + URL åè©çš„æ–¹å¼æè¿°ï¼Œé‚£è©²æ€éº¼è¾¦å‘¢ï¼Ÿ&lt;/p>
&lt;p>ä¾‹å¦‚èªªæœ€è¿‘åœ¨å·¥ä½œä¸Šé‡åˆ°å¦‚ä½•è¨­è¨ˆä¸€æ¬¡åˆªé™¤å¤šç­†è³‡æ–™çš„APIè©²æ€éº¼è¾¦ï¼Ÿ&lt;/p>
&lt;p>å°‹æ‰¾ç­”æ¡ˆçš„éç¨‹ä¸­ï¼Œçœ‹åˆ° Google èˆ‡ Microsoft æœ‰å…¬é–‹ä»–å€‘çš„ API Design Guidelineï¼Œä¸¦åˆ†äº«å…¶ä¸­æ€è€ƒçš„çœ‰è§’ï¼Œå…¶ä¸­åŒ…å«äº†&lt;/p>
&lt;ol>
&lt;li>REST çš„åŸºç¤è§€å¿µ&lt;/li>
&lt;li>æ‡‰ä»˜è¤‡é›œå ´æ™¯çš„è€ƒé‡&lt;/li>
&lt;li>éŒ¯èª¤ç¢¼çš„è™•ç†&lt;/li>
&lt;li>åƒæ•¸åç¨±èˆ‡ç‰ˆæœ¬æ§åˆ¶&lt;/li>
&lt;/ol>
&lt;p>&lt;a class="link" href="https://cloud.google.com/apis/design/" target="_blank" rel="noopener"
>&lt;strong>API Design Guide | Cloud APIs | Google Cloud&lt;/strong>&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md" target="_blank" rel="noopener"
>&lt;strong>microsoft/api-guidelines&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ä»¥ Google æ–‡ä»¶ç‚ºä¸»ï¼ŒMicrosoft æ–‡ä»¶ç‚ºè¼”ï¼Œæ•´ç†éå¾Œåˆ†äº«å€‹äººç­†è¨˜&lt;/p>
&lt;h3 id="ä¸€é»-restä»‹ç´¹">ä¸€é» RESTÂ ä»‹ç´¹&lt;/h3>
&lt;p>Roy Fielding åœ¨è¥¿å…ƒ 2000å¹´æå‡ºäº† &lt;a class="link" href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm" target="_blank" rel="noopener"
>Representational State Transfer(REST ) ç¶²ç«™æ¶æ§‹è¨­è¨ˆè¦ç¯„&lt;/a>ï¼ŒåŒæ™‚ä»–ä¹Ÿæ˜¯ URL / Http 1.0 / Http 1.1 æ¨™æº–åˆ¶å®šçš„åƒèˆ‡è€…ï¼Œæ‰€ä»¥ REST çš„æ¦‚å¿µå¾ˆè‡ªç„¶çš„èˆ‡ HTTP ç›¸ç•¶å»åˆï¼Œä¸€é–‹å§‹ RESTè¢«èª¤ä»¥ç‚ºæ˜¯ &lt;code>HTTP object model&lt;/code>ä¸€ç¨® HTTPçš„å¯¦ä½œï¼Œä½†å¯¦éš›ä¸Š RESTæç¹ªçš„æ˜¯ä¸€å€‹æ­£ç¢ºæ¶æ§‹çš„ Web æ‡‰ç”¨ç¨‹å¼ï¼š&lt;code>ç”¨æˆ¶é¸æ“‡é€£çµ(state transition)ï¼Œé€²è€Œå¾—åˆ°ä¸‹ä¸€å€‹çµæœ(representing the next state of the application)&lt;/code> ï¼Œå…¶ä¸­æå‡ºäº† REST æ¶æ§‹éœ€è¦ç¬¦åˆä»¥ä¸‹å…­å¤§åŸå‰‡&lt;/p>
&lt;h3 id="client-server">Client /Â Server&lt;/h3>
&lt;p>ä¾æ“šé—œæ³¨é»åˆ†é›¢( Separation of Concern)ï¼Œå°‡ç”¨æˆ¶ä»‹é¢è·Ÿè³‡æ–™å„²å­˜åˆ‡å‰²ï¼Œæ–¹ä¾¿å…©è€…ç¨ç«‹é‹ä½œèˆ‡ç¶­è­·&lt;/p>
&lt;h3 id="stateless">Stateless&lt;/h3>
&lt;p>æ¯ä¸€æ¬¡çš„é€£ç·šæœ¬èº«éƒ½æ”œå¸¶è¶³å¤ çš„è³‡è¨Šï¼Œè€Œä¸ç”¨ä¾è³´æ–¼ä¸Šä¸€æ¬¡é€£ç·šçš„ç‹€æ…‹ï¼Œå¢åŠ æœå‹™çš„å¯é æ€§èˆ‡æ“´å±•æ€§&lt;/p>
&lt;h3 id="cache">Cache&lt;/h3>
&lt;p>æ ¹æ“š Requestï¼ŒResponse å¯ä»¥æ±ºå®šæ˜¯å¦èƒ½è¢«ç·©å­˜ï¼Œå¢åŠ ä½¿ç”¨æ•ˆç‡&lt;/p>
&lt;h3 id="uniform-interfaces">Uniform Interfaces&lt;/h3>
&lt;p>å¦‚åŒç¨‹å¼è¨­è¨ˆï¼Œå…ƒä»¶é–“ä¹Ÿéœ€è¦åˆ¶å®šä»‹é¢(interface)è§£è€¦åˆèˆ‡æºé€šï¼Œé›–ç„¶æœƒé™ä½ä¸€äº›æ•ˆç‡ï¼Œä¸éå¢åŠ å…ƒä»¶ç¨ç«‹çš„é‹ä½œèˆ‡ç¶­è­·ï¼Œå…¶ä¸­åŒ…å«å››å€‹è¦ç¯„&lt;/p>
&lt;ol>
&lt;li>&lt;strong>identification of resources&lt;/strong>ï¼šå®šä½åˆ°ç‰¹å®šè³‡æºä¸Šï¼Œè³‡æºå¯ä»¥æ˜¯åœ–ç‰‡ã€æ–‡å­—ã€ç‰¹å®šæœå‹™(å¦‚ä»Šå¤©åŠ å·å¤©æ°£)ã€ä¸€å€‹å¯¦é«”çš„äººç­‰ç­‰&lt;/li>
&lt;li>&lt;strong>manipulation of resources through representations&lt;/strong>ï¼šServer æä¾›å¯ä»¥æ“ä½œè³‡æºçš„æ–¹æ³•ï¼ŒåŒ…å«äº†æè¿°è³‡æºæœ¬èº«çš„meta-dataï¼Œä»¥åŠå¦‚ä½•æ“ä½œ dataçš„ Control data&lt;/li>
&lt;li>&lt;strong>self-descriptive messages&lt;/strong>ï¼šè¨Šæ¯æœ¬èº«è³‡è¨Šé‡æ˜¯è¶³å¤ çš„ï¼Œåœ¨è·¨å…ƒä»¶ä¹‹é–“å¯ä»¥ä¸æ–·çš„è¢«å‚³éè€Œä¸éœ€è¦æœ‰é¡å¤–çš„è™•ç†(Stateless)&lt;/li>
&lt;li>&lt;strong>hypermedia as the engine of application state(HATEOAS)&lt;/strong>ï¼š&lt;br>
æ¨¡æ“¬ç€è¦½ç¶²é ï¼ŒåŠ è¼‰å®Œé¦–é å¾Œï¼Œå¾ŒçºŒæ“ä½œéƒ½æ˜¯åˆ©ç”¨ç¶²é ä¸Šçš„è¶…é€£çµæ¢ç´¢ç¶²ç«™ï¼›&lt;br>
å¥—ç”¨åŒæ¨£çš„é‚è¼¯è‡³ REST Serverï¼ŒResponse åŒ…å«é‡å°æ­¤è³‡æºæ¢ç´¢çš„é€£çµèˆ‡æ“ä½œæ–¹å¼ï¼Œå¦‚è·Ÿé†«å¸«é ç´„å¾Œï¼Œå›å‚³çµæœï¼ŒåŒæ™‚åŒ…å«æŸ¥è©¢é ç´„ã€æŸ¥è©¢é†«ç”Ÿè³‡æ–™ã€æ›´æ”¹é ç´„ç­‰æ“ä½œéƒ½ä¸€ä½µå›å‚³&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;appointment&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;slot&lt;/span> &lt;span class="na">id =&lt;/span> &lt;span class="s">&amp;#34;1234&amp;#34;&lt;/span> &lt;span class="na">doctor =&lt;/span> &lt;span class="s">&amp;#34;mjones&amp;#34;&lt;/span> &lt;span class="na">start =&lt;/span> &lt;span class="s">&amp;#34;1400&amp;#34;&lt;/span> &lt;span class="na">end =&lt;/span> &lt;span class="s">&amp;#34;1450&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;patient&lt;/span> &lt;span class="na">id =&lt;/span> &lt;span class="s">&amp;#34;jsmith&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;link&lt;/span> &lt;span class="na">rel =&lt;/span> &lt;span class="s">&amp;#34;/linkrels/appointment/cancel&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">uri =&lt;/span> &lt;span class="s">&amp;#34;/slots/1234/appointment&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;link&lt;/span> &lt;span class="na">rel =&lt;/span> &lt;span class="s">&amp;#34;/linkrels/appointment/addTest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">uri =&lt;/span> &lt;span class="s">&amp;#34;/slots/1234/appointment/tests&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;link&lt;/span> &lt;span class="na">rel =&lt;/span> &lt;span class="s">&amp;#34;self&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">uri =&lt;/span> &lt;span class="s">&amp;#34;/slots/1234/appointment&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;link&lt;/span> &lt;span class="na">rel =&lt;/span> &lt;span class="s">&amp;#34;/linkrels/appointment/changeTime&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">uri =&lt;/span> &lt;span class="s">&amp;#34;/doctors/mjones/slots?date=20100104&amp;amp;status=open&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;link&lt;/span> &lt;span class="na">rel =&lt;/span> &lt;span class="s">&amp;#34;/linkrels/appointment/updateContactInfo&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">uri =&lt;/span> &lt;span class="s">&amp;#34;/patients/jsmith/contactInfo&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;link&lt;/span> &lt;span class="na">rel =&lt;/span> &lt;span class="s">&amp;#34;/linkrels/help&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">uri =&lt;/span> &lt;span class="s">&amp;#34;/help/appointment&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/appointment&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="layered-system">Layered System&lt;/h4>
&lt;p>ä¸€å€‹å®Œæ•´çš„ç³»çµ±å¯ä»¥ç”±å¤šå€‹å­å…ƒä»¶ç–ŠåŠ ï¼Œä¾‹å¦‚ Cache Server / Api Server / Proxy / Agent ç­‰ï¼Œæ¯å€‹å…ƒä»¶åƒ…å¯æ„è­˜åˆ°ç›¸é„°çš„å…ƒä»¶&lt;/p>
&lt;h4 id="code-ondemand">Code OnÂ Demand&lt;/h4>
&lt;p>Client å¯ä»¥ä¾ç…§éœ€æ±‚åŠ è¼‰æ–°çš„ script åŸ·è¡Œ&lt;/p>
&lt;p>é€™ä»£è¡¨ REST ä¸ä¸€å®šè¦ç¶å®š HTTPï¼Œåªæ˜¯ HTTPå¾ˆå·§å¦™çš„è·Ÿ RESTæ¦‚å¿µååˆ†è²¼è¿‘ï¼ŒRESTçš„æ¦‚å¿µä¹Ÿå¯ä»¥å°ç…§åˆ° HTTP å¯¦ä½œä¸Š(ç•¢ç«Ÿ Roy Fieldingéƒ½æœ‰åƒèˆ‡å…¶ä¸­&lt;/p>
&lt;p>å›éé ­ä¾†çœ‹å¸¸è¦‹çš„ RESTful APIå®šç¾©ï¼Œæ¯”è¼ƒåƒæ˜¯ REST + HTTP çš„æ··åˆç”¢ç‰©ï¼Œå¿«é€Ÿç¿»å®Œ Roy Fielding çš„ &lt;a class="link" href="https://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm" target="_blank" rel="noopener"
>Architectural Styles and the Design of Network-based Software Architectures&lt;/a>ï¼Œå…¶ä¸­çš„ 6.2 URI å®šç¾©æ˜¯&lt;code>ç‰¹å®šè³‡æºçš„è¡¨å¾µ (representation of the identified resource)&lt;/code>ï¼Œæœ€ä¸€é–‹å§‹çš„ Web æ˜¯åœ¨å‚³è¼¸æ–‡ä»¶æˆ–è¶…é€£çµ(hypertext)ï¼Œæ‰€ä»¥ Resource å¸¸ç›´æ¥å°æ‡‰åˆ°æª”æ¡ˆæ–‡ä»¶ï¼Œè€Œ URI å‰‡å°æ‡‰åˆ°å¯¦éš›æª”æ¡ˆçš„è·¯å¾‘ï¼›é€™æœƒå¸¶ä¾†å¹¾å€‹ä¸å¥½çš„å½±éŸ¿ï¼Œä¾‹å¦‚èªªæ–‡ä»¶è¢«ä¿®æ”¹äº†è©²å¦‚ä½•è¡¨ç¤º / å¦‚ä½•è¡¨é”æœå‹™( Service )è€Œéæ–‡ä»¶æœ¬èº« ç­‰ç­‰ï¼›&lt;br>
è‰¯å¥½çš„ Resource å®šç¾©æ‡‰è©²æ˜¯**&lt;em>ç›¡å¯èƒ½å›ºå®šä¸è®Š&lt;/em>** ä¸” &lt;strong>&lt;em>æŠ½è±¡æ–¼å¯¦éš›æª”æ¡ˆå„²å­˜æœ¬èº«&lt;/em>&lt;/strong>ï¼Œè€Œæ˜¯ä¸€ç¨®é«˜å±¤ç´šçš„æ˜ å°„æ¦‚å¿µï¼Œç•¶ Server æ”¶åˆ°å¾Œå»æ‰¾å‡ºå°æ‡‰çš„å¯¦ä½œå…§å®¹ï¼Œæ›´é‡è¦çš„æ˜¯å‚³é”ä½¿ç”¨è€…çš„æ„åœ–ï¼Œæ‰€ä»¥ä¸€å€‹ Resource æ¦‚å¿µå¯èƒ½æ©«è·¨å¤šçš„æª”æ¡ˆï¼Œä¹Ÿå¯ä»¥å¤šå€‹ Resource æè¿°åŒä¸€å€‹æª”æ¡ˆ&lt;/p>
&lt;p>ç”¨ URIæè¿°è³‡æºå¾Œï¼Œéœ€è¦å†åŠ ä¸Šç”¨æˆ¶å°æ–¼è³‡æºçš„æ“ä½œ(representation )ï¼Œå°±å¯ä»¥çµ„æˆèªæ„ (Semantic)ï¼Œå°æ‡‰å› HTTPï¼Œä¸åŒçš„æ“ä½œå°æ‡‰ä¸åŒçš„æ–¹æ³•( Method )ï¼Œå¦‚ GET è¡¨ç¤ºè¦å–å¾— URIæ‰€ä»£è¡¨è³‡æºçš„è³‡è¨Š / POST è¡¨ç¤ºå‰µå»º URIè³‡æºçš„å­è³‡æºç­‰ï¼Œå‰‡å®šç¾©åœ¨ HTTP 1.1 ç•¶ä¸­çš„ &lt;a class="link" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5" target="_blank" rel="noopener"
>Method Definitions&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>ä»¥å€‹äººæ·ºè¦‹ï¼Œè«‡åˆ° REST Architecture æŒ‡çš„æ‡‰è©²æ˜¯ç¬¦åˆ Roy Fielding è¦ç¯„çš„ 6å¤§åŸå‰‡çš„ç¶²ç«™æ¶æ§‹è¨­è¨ˆï¼›&lt;br>
è€Œç›®å‰å¸¸ç”¨çš„ RESTful API è¨­è¨ˆåŸå‰‡å‰‡æ˜¯ RESTä¸­çš„ Resource è§£é‡‹åŠ ä¸Š HTTP å°æ–¼ Method æ“ä½œçš„è£œå……ï¼Œå…©è€…æ··åˆçš„è¨­è¨ˆåŸå‰‡&lt;/p>
&lt;/blockquote>
&lt;h3 id="å›æ­¸-restful-api--restapi">å›æ­¸ RESTful API / RESTÂ API&lt;/h3>
&lt;p>æ ¹æ“š Google æ–‡ä»¶ï¼ŒRESTful API å®šç¾©ä¸»è¦æ˜¯ &lt;code>å¯å€‹åˆ¥å‘¼å«çš„ã€Œè³‡æºã€(API çš„ã€Œåè©ã€)ã€Œé›†åˆã€åšç‚ºæ¨¡å‹ã€‚ä¸åŒçš„è³‡æºæœ‰å„è‡ªçš„åƒç…§åç¨±ï¼Œä¹Ÿå°±æ˜¯æ‰€è¬‚çš„**[**è³‡æºåç¨±**](https://cloud.google.com/apis/design/resource_names?hl=zh-tw)**ï¼Œä¸¦ä¸”æ˜¯é€éä¸€å¥—ã€Œæ–¹æ³•ã€ä¾†æ“æ§&lt;/code>&lt;/p>
&lt;p>é€™æ¨£çš„ç†å¿µå¯ä»¥è¢«å¾ˆå¥½çš„å¥—ç”¨åœ¨ HTTP 1.1 ä¸Šï¼Œå› ç‚º URL å¯ä»¥ç”¨ä¾†æè¿°è³‡æºè·¯å¾‘ï¼ŒHTTP Method å¸¸ç”¨çš„ä¹Ÿå°±æ˜¯ GET / POST / PUT / PATCH / DELETEï¼Œæ­£å¥½å°æ‡‰è³‡æºçš„æ“ä½œï¼Œæ ¹æ“š Google æ–‡ä»¶ï¼Œæœ‰ 74%çš„å…¬é–‹ HTTP API éƒ½æ˜¯ä¾æ“š REST è¨­è¨ˆè¦ç¯„ï¼›&lt;br>
HTTPè¢«å»£æ³›æ‡‰ç”¨ï¼Œä½†ä¹Ÿä¸æ˜¯å”¯ä¸€çš„è·¨é€²ç¨‹æºé€šçš„è¦ç¯„ï¼Œå¦‚æœæ˜¯å…¬å¸å…§ç¶²æˆ–æ˜¯è¦æ±‚æ›´ä½æºé€šä¸Šçš„overheadï¼Œæœƒæ¡ç”¨ RPC ( Googleæ¨å»£è‡ªå®¶çš„ gRPC)ï¼ŒREST ä¹Ÿå¯ä»¥è¢«å¥—ç”¨åœ¨é€™ä¸Šé¢&lt;/p>
&lt;h3 id="è³‡æº-resource">è³‡æº Resource&lt;/h3>
&lt;p>é¢å‘è³‡æºå°å‘è¨­è¨ˆçš„ APIï¼Œéœ€è¦å…ˆè¦åŠƒè³‡æºçš„å±¤ç´šï¼Œæ¯å€‹è³‡æºçš„ç¯€é»å¯ä»¥æ˜¯å–®å€‹è³‡æº(Resource)æˆ–æ˜¯åŒä¸€é …è³‡æºçš„é›†åˆ(Collection)&lt;br>
æ¯å€‹è³‡æºæˆ–é›†åˆå¿…é ˆæœ‰ç¨ç‰¹çš„ id å»å€åˆ†ï¼Œåœ¨å‘½åæ™‚ç›¡å¯èƒ½è¡¨é”æ¸…æ¥šï¼Œé¿å…ä½¿ç”¨ä»¥ä¸‹çš„åè©å¦‚ resource / object / item ç­‰ï¼›&lt;br>
ä¸”å‘½åæ™‚å·²è¤‡æ•¸åè©è¡¨ç¤ºï¼Œä¾‹å¦‚ &lt;code>/users/123/events/456&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚ Gmail API æœƒæœ‰ä¸€ç¾¤ç”¨æˆ¶çš„é›†åˆï¼Œæ¯å€‹ç”¨æˆ¶åº•ä¸‹æœ‰è¨Šæ¯çš„é›†åˆ / æ¨™ç±¤çš„é›†åˆç­‰ç­‰&lt;/p>
&lt;p>-- user&lt;br>
|&amp;mdash; message&lt;br>
|&amp;mdash; label&lt;/p>
&lt;p>URL çš„é•·åº¦åœ¨Spec ä¸­æ²’æœ‰è¦ç¯„ï¼Œä½†åœ¨ç¾å¯¦ä¸­æœ‰äº›ç€è¦½å™¨æœƒæœ‰é•·åº¦é™åˆ¶ï¼Œå¯ä»¥çš„è©±é‚„æ˜¯ä¿æŒåœ¨ 2000 å­—å…ƒä»¥å…§æ¯”è¼ƒä¿éšª&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers/417184" target="_blank" rel="noopener"
>&lt;strong>What is the maximum length of a URL in different browsers?&lt;/strong>&lt;/a>&lt;/p>
&lt;p>Microsoft æ–‡ä»¶ä¹Ÿæ˜¯æ¨™æ¦œé¡ä¼¼çš„å¯«æ³•ï¼Œä½†é¡å¤–å»ºè­°ä¸è¦è®“è³‡æ–™çš„å±¤ç´šè¶…éä¸‰å±¤ &lt;code>/collection/item/collection&lt;/code> ï¼Œä¾‹å¦‚èªª &lt;code>/customers/1/orders/99/products&lt;/code> å¯ä»¥åˆ†æ‹†æˆ &lt;code>/customers/1/orders&lt;/code> + &lt;code>/orders/99/products&lt;/code>&lt;/p>
&lt;p>å¦å¤–åœ¨ APIçš„è³‡æºå±¤ç´šä¸è¦åº•å±¤çš„è³‡æ–™çµæ§‹æœ‰å¤ªç·Šå¯†çš„é—œä¿‚ï¼Œä¾‹å¦‚ä½¿ç”¨é—œè¯æ€§è³‡æ–™åº«ä¸ä¸€å®šè¦å‰›å¥½å°æº– Tableï¼ŒAPI æ‡‰è©²æ˜¯è¦æ›´é«˜å±¤åº¦çš„æŠ½è±¡åŒ–ï¼Œé¿å…ä¹‹å¾Œè³‡æ–™åº«çš„æ›´å‹•è€¦åˆäº† APIçš„è³‡æºè·¯å¾‘ã€‚&lt;/p>
&lt;h3 id="æ“ä½œ-methods">æ“ä½œ Methods&lt;/h3>
&lt;p>é¢å‘è³‡æºå°å‘è¨­è¨ˆçš„ API å´é‡æ–¼è³‡æºçš„æè¿°è€Œéæ“ä½œçš„æè¿°ï¼Œæ‰€ä»¥å¤§é‡è³‡æºçš„æè¿°åƒ…æœƒæ­é…æœ‰é™çš„æ“ä½œï¼Œæ¨™æº–çš„æ“ä½œæ˜¯ List / Get / Create / Update / Delete é€™äº”é …&lt;/p>
&lt;p>æ“ä½œæœ‰å¯èƒ½ä¸æœƒæ˜¯ç«‹å³ç™¼ç”Ÿï¼Œéœ€è¦ä¸€æ®µæ™‚é–“æ‰æœƒç”Ÿæ•ˆï¼Œæ­¤æ™‚å¯ä»¥å›ä¸€å€‹é•·æ™‚æ“ä½œçš„è³‡æºï¼Œç”¨ä»¥æŸ¥è©¢é€²åº¦æˆ–æ˜¯ç‹€æ…‹ç­‰çš„æ–¹å¼ï¼Œæœ‰é»åƒæ˜¯å«è™Ÿå–é¤çš„é™æ§å™¨&lt;/p>
&lt;h4 id="list">List&lt;/h4>
&lt;ul>
&lt;li>å¿…é ˆä½¿ç”¨ &lt;code>GET&lt;/code>&lt;/li>
&lt;li>Request ä¸èƒ½æœ‰ Body&lt;/li>
&lt;li>Response Body åŒ…å«ä»¥é™£åˆ—è¡¨ç¤ºçš„è³‡æºï¼Œèˆ‡å…¶é¤˜é¸æ“‡æ€§çš„æ“ä½œ(å¦‚åˆ†é æ“ä½œ)&lt;/li>
&lt;/ul>
&lt;h4 id="get">GET&lt;/h4>
&lt;ul>
&lt;li>å¿…é ˆä½¿ç”¨ &lt;code>GET&lt;/code>&lt;/li>
&lt;li>Request ä¸èƒ½æœ‰ Body&lt;/li>
&lt;li>Response Body å°æ‡‰åˆ°å®Œæ•´çš„è³‡æºæè¿°&lt;/li>
&lt;/ul>
&lt;h4 id="create">CREATE&lt;/h4>
&lt;ul>
&lt;li>å¿…é ˆä½¿ç”¨ &lt;code>POST&lt;/code>&lt;/li>
&lt;li>Request Body å¿…é ˆåŒ…å«æ–°å¢è³‡æºçš„å…§å®¹&lt;/li>
&lt;li>å¦‚æœæ”¯æ´ client side æŒ‡å®š &lt;resource>_idï¼Œå‰‡æä¾›è©²æ¬„ä½æ–¼ Request Bodyï¼Œä½†å¦‚æœç™¼ç”Ÿè¡çªéœ€å›å‚³ &lt;code>ALREADY_EXISTS&lt;/code>&lt;/li>
&lt;li>Response Body å¯ä»¥&lt;/li>
&lt;/ul>
&lt;h4 id="update">Update&lt;/h4>
&lt;ul>
&lt;li>å¦‚æœæ˜¯éƒ¨ä»½æ›´æ–°ä½¿ç”¨ &lt;code>PATCH&lt;/code>&lt;/li>
&lt;li>å¦‚æœæ˜¯å…¨éƒ¨æ›´æ–°(è¦†è“‹)ä½¿ç”¨ &lt;code>PUT&lt;/code>ï¼Œå¦‚æœ Request Body æ²’æœ‰å¤¾å¸¶çš„æ¬„ä½ï¼Œè¦–ç‚ºæ¸…é™¤è©²æ¬„ä½&lt;/li>
&lt;li>å¦‚æœ Patchæ›´æ–°ä¸å­˜åœ¨è³‡æºï¼ŒAPI å¯ä»¥é¸æ“‡æ˜¯å¦æ”¯æ´ Upsert&lt;code>æ›´æ–°ä¸åˆ°å°±å‰µå»º&lt;/code>çš„åŠŸèƒ½ï¼Œå¦‚æœå¦å‰‡å›å‚³ NOT_FOUND&lt;/li>
&lt;li>Response Body å¿…é ˆæ˜¯æ›´æ–°å¾Œçš„è³‡æºæœ¬èº«&lt;/li>
&lt;li>Update åƒ…ç”¨æ–¼æ›´æ–°ï¼Œå¦‚æœæ˜¯å…¶é¤˜è¤‡é›œæ“ä½œå¦‚é‡æ–°å‘½åè³‡æºã€æ”¹è®Šè³‡æºè·¯å¾‘ç­‰ï¼Œè«‹ä½¿ç”¨å®¢è£½åŒ–æ“ä½œ&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœä»¥ JSON ç‚ºè³‡æ–™äº¤æ›æ ¼å¼ï¼ŒPatch æœ‰å…©ç¨®æ–¹æ³• JSON patch / JSON merge patchï¼Œåœ¨è³‡æ–™å„²å­˜ä¸­ï¼Œ&lt;code>null&lt;/code> çš„å«ç¾©æœ‰äº›æ¨¡ç³Šåœ°å¸¶ï¼Œå¦‚æœ Request JSON æ¬„ä½å¤¾å¸¶ nullï¼Œé€™æ˜¯ä»£è¡¨&lt;code>ç§»é™¤è©²æ¬„ä½&lt;/code>é‚„æ˜¯&lt;code>æ›´æ–°æ¬„ä½æˆç‚º null&lt;/code> å‘¢ï¼Ÿ&lt;/p>
&lt;p>å¦‚æœ Header ä¸­çš„ Content-Type æ˜¯ &lt;code>application/merge-patch+json&lt;/code> å‰‡ä»£è¡¨ null ç§»é™¤è©²æ¬„ä½ï¼Œæ­¤æ™‚éœ€æ³¨æ„è³‡æ–™çµæ§‹å°±ä¸å»ºè­°æ¬„ä½å„²å­˜ nullé¿å…æ··æ·†ï¼Œæ›´å¤šåƒè€ƒ &lt;a class="link" href="https://tools.ietf.org/html/rfc7396" target="_blank" rel="noopener"
>RFC: JSON Merge Patch&lt;/a>ï¼›&lt;/p>
&lt;p>å¦‚æœå¸Œæœ›é‡å°æ¬„ä½æœ‰æ›´ç²¾ç¢ºçš„æ“ä½œæè¿°ï¼Œä¾‹å¦‚æ–°å¢ã€åˆªé™¤ã€å–ä»£ã€è¤‡è£½ã€æ¬ç§»ã€é©—è­‰(test)ç­‰ï¼Œå¯ä»¥åƒè€ƒ &lt;a class="link" href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener"
>JSON patch&lt;/a>ï¼ŒContent-Type ç‚º &lt;code>application/json-patch+json&lt;/code> ï¼Œç”¨é™£åˆ—è¡¨è¿°æ“ä½œçš„é›†åˆï¼Œæ“ä½œç¯„ä¾‹å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;remove&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/c&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;add&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;replace&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">42&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;move&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/d&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;copy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/a/b/e&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="delete">DELETE&lt;/h4>
&lt;ul>
&lt;li>å¿…é ˆä½¿ç”¨ &lt;code>DELETE&lt;/code>&lt;/li>
&lt;li>ä¸èƒ½æœ‰ Request Body&lt;/li>
&lt;li>å¦‚æœæ˜¯ç«‹å³åˆªé™¤ï¼Œå‰‡ Response Body ç‚ºç©ºå€¼&lt;/li>
&lt;li>å¦‚æœæ˜¯éœ€è¦é•·æ™‚é–“åŸ·è¡Œï¼Œå›å‚³ç›¸å°æ‡‰çš„é•·æ™‚æ“ä½œ&lt;/li>
&lt;li>å¦‚æœåªæ˜¯æŠŠè³‡æºæ¨™è¨˜åˆªé™¤è€Œéç¡¬åˆªé™¤ï¼Œå›å‚³æ›´æ–°çš„è³‡æº&lt;/li>
&lt;li>åˆªé™¤å¿…é ˆæ˜¯å†ªç­‰æ€§æ“ä½œï¼Œä¸è«–æ“ä½œå¹¾æ¬¡éƒ½å¿…æ˜¯æ˜¯åˆªé™¤è©²è³‡æºï¼Œä½†å›æ‡‰å…§å®¹å¯ä»¥æ”¹è®Šï¼Œç¬¬ä¸€æ¬¡ç¢ºå¯¦åˆªæ‰è³‡æºå›å¾©æˆåŠŸï¼Œå¾ŒçºŒåˆªé™¤å¯ä»¥å›è¦† NOT_FOUND&lt;/li>
&lt;/ul>
&lt;h4 id="custom-method">Custom Method&lt;/h4>
&lt;p>é™¤äº†ä¸Šè¿°äº”ç¨®æ“ä½œå¤–ï¼Œå¯èƒ½æœƒæœ‰äº›æ“ä½œä¸å†é€™äº”ç¨®ç¯„ç–‡ä¹‹ä¸­ï¼Œæ­¤æ™‚å°±å¯ä»¥è‡ªè¡Œå®šç¾©ï¼Œä¾‹å¦‚èªªå–æ¶ˆåˆªé™¤ã€å¤§é‡æ›´æ–°ç­‰&lt;/p>
&lt;p>è‡ªå®šç¾©çš„æ–¹æ³•é ˆä»¥Â &lt;code>:&lt;/code> æ”¾åœ¨ URLçš„æœ€å¾Œæ–¹ï¼Œä¸”å¸¸è¦‹çš„æ­é…æ˜¯ç”¨ &lt;code>POST&lt;/code>ï¼Œå› ç‚ºå¯ä»¥å¤¾å¸¶Bodyï¼›&lt;br>
ä½†ä¹Ÿå¯ä»¥è¦–æƒ…æ³ä½¿ç”¨å…¶ä»–çš„ HTTP Method (Patch ä¸å»ºè­°ä½¿ç”¨å¤–)ï¼Œä½†ä»é ˆéµå®ˆ HTTP Method ä½¿ç”¨çš„è¦ç¯„ï¼Œä¾‹å¦‚å†ªç­‰æ€§èˆ‡æ˜¯å¦èƒ½å¤¾å¸¶ Bodyç­‰&lt;/p>
&lt;p>Google æä¾›å¹¾ç¨®è‡ªå®šç¾©æ–¹æ³•çš„ç”¨é€”&lt;/p>
&lt;p>1. POST :cancel å–æ¶ˆæ“ä½œ&lt;br>
2. GET :batchGet ä¸€æ¬¡æ€§å–å¾—å¤šç­†è³‡æ–™&lt;br>
3. POST :move å°‡è³‡æºç§»åˆ°åˆ¥è™•&lt;/p>
&lt;p>batchGet ä¹Ÿå¯ä»¥ä½¿ç”¨ POSTï¼Œä¾‹å¦‚ POST &lt;a class="link" href="https://mybusiness.googleapis.com/v4/%7Bname=accounts/*%7D/locations:batchGet" target="_blank" rel="noopener"
>https://mybusiness.googleapis.com/v4/{name=accounts/*}/locations:batchGet&lt;/a>`
åœ¨ Body ä¸­æœ‰å°æŸ¥è©¢çš„å…§å®¹æœ‰æ›´è¿‘ä¸€æ­¥çš„æè¿°&lt;/p>
&lt;p>Microsoft æè­°å°±æŠŠéåè©æ”¾é€² URLä¸­ï¼Œä¾‹å¦‚ä¸€å€‹è¨ˆç®—æ©Ÿçš„åŠ æ³• APIå¯ä»¥è¨­è¨ˆç‚º &lt;code>GET /add?operand1=99&amp;amp;operand2=1&lt;/code> ï¼Œå…¶é¤˜çš„å°±éµå®ˆ HTTP Method æ“ä½œæ–¹å¼ã€‚&lt;/p>
&lt;p>åœ¨ AWS æ–‡ä»¶ä¸­ï¼ŒCustom Method æ˜¯ä»¥ Query String æ–¹å¼å­˜åœ¨ï¼Œå¦‚ &lt;a class="link" href="https://docs.aws.amazon.com/AmazonS3/latest/API/multiobjectdeleteapi.html" target="_blank" rel="noopener"
>åˆªé™¤å¤šç­†ç‰©ä»¶&lt;/a>&lt;code>/?delete&lt;/code> ï¼Œå€‹äººæ˜¯è¦ºå¾—å®¹æ˜“èˆ‡å…¶ä»–çš„ Query String æ··æ·†ï¼Œåœ¨ Parsingä¸Šä¹Ÿæ¯”è¼ƒéº»ç…©é»ï¼Œä¸æ˜¯å¾ˆå–œæ­¡é€™æ¨£çš„ä½œæ³•&lt;/p>
&lt;blockquote>
&lt;p>å€‹äººåå¥½ Googleçš„åšæ³•ï¼Œè®“ URLçµ„æˆå…¨éƒ¨éƒ½æ˜¯åè©ï¼Œä¹¾æ·¨çš„è¡¨ç¤ºè³‡æ–™å±¤ç´šï¼ŒCustom Method å°±ä»¥ä¸€å€‹ç‰¹æ®Šçš„æ–¹å¼å®£å‘Šï¼Œå¯ä»¥è‰¯å¥½èˆ‡ REST APIå…±å­˜&lt;/p>
&lt;/blockquote>
&lt;h4 id="http-media-type-èˆ‡header">HTTP Media Type èˆ‡Â Header&lt;/h4>
&lt;p>æœ€å¾Œåˆ¥å¿˜äº† Request èˆ‡ Response æ‡‰ç›¡é‡éµå®ˆ HTTPè¦ç¯„ï¼Œä½¿ç”¨æ­£ç¢ºçš„ Status Code èˆ‡ Headerï¼Œè®“ APIè¨­è¨ˆæ›´ç²¾ç¢ºï¼Œä¾‹å¦‚&lt;/p>
&lt;ol>
&lt;li>äº¤æ›çš„è³‡æ–™æ ¼å¼ç‚º json å°±è¦å®£å‘Š &lt;code>Content-Type: application/json;charset=utf-8&lt;/code>&lt;/li>
&lt;li>200&lt;br>
201(Created)Â : å»ºç«‹æ–°è³‡æº&lt;br>
202(Accepted)ï¼šæ¥å—è«‹æ±‚ï¼Œä½†ä¸æ˜¯ç«‹å³ç™¼ç”Ÿ&lt;br>
204 (No Content)ï¼šæ²’æœ‰è¦å›å‚³è³‡æ–™&lt;/li>
&lt;/ol>
&lt;h3 id="versioning">Versioning&lt;/h3>
&lt;p>åœ¨ç¶­è­· APIéç¨‹ï¼Œæœƒé‡åˆ°æ›´å‹•è³‡æ–™çµæ§‹æˆ–æ˜¯ä¿®æ”¹é‚è¼¯çš„åœ°æ–¹ï¼Œå¦‚æœå¯ä»¥çš„è©±åˆä¸å¸Œæœ›å½±éŸ¿åŸæœ‰ APIçš„æ“ä½œï¼Œæ­¤æ™‚å°±éœ€è¦åšç‰ˆæœ¬æ§åˆ¶ï¼Œç‰ˆè™Ÿçš„å‘½åå¯ä»¥åƒè€ƒ &lt;a class="link" href="https://semver.org/" target="_blank" rel="noopener"
>Semantic Version&lt;/a> X.Y.Z æ–¹å¼è¡¨ç¤º&lt;/p>
&lt;ol>
&lt;li>X å¤§ç‰ˆè™Ÿè¡¨ç¤ºæœ‰ breaking changeï¼Œå‘å‰ä¸ç›¸å®¹&lt;/li>
&lt;li>Y å°ç‰ˆè™Ÿè¡¨ç¤ºæœ‰æ–°å¢ functionï¼Œæˆ–æ˜¯æ›´å‹•æ˜¯å‘å‰ç›¸å®¹çš„&lt;/li>
&lt;li>Z è£œä¸ç‰ˆè™Ÿè¡¨ç¤º Bug ä¿®æ­£&lt;/li>
&lt;/ol>
&lt;p>ä¸€èˆ¬ä¾†èªª API å°å¤–ç”¨å¤§ç‰ˆè™Ÿè¡¨ç¤ºï¼Œå¦‚ v1 / v2ï¼Œå°ç‰ˆè™Ÿè·Ÿè£œä¸ç‰ˆè™Ÿå‡ºç¾åœ¨æ–‡ä»¶çš„ç‰ˆæœ¬è™Ÿä¸Š&lt;/p>
&lt;p>version å¸¸è¦‹å¯ä»¥æ”¾åœ¨å¹¾å€‹åœ°æ”¾&lt;/p>
&lt;ol>
&lt;li>URL ç•¶ä¸­ï¼Œæ”¾åœ¨ Domain å¾Œçš„ç¬¬ä¸€å±¤ï¼Œå¦‚ &lt;code>https://example.com/v1&lt;/code>&lt;/li>
&lt;li>å¤¾å¸¶åœ¨ Query Stringä¸­ï¼Œå¦‚ &lt;a class="link" href="https://example.com?version=v1" target="_blank" rel="noopener"
>https://example.com?version=v1&lt;/a>&lt;/li>
&lt;li>æ”¾åœ¨ Custom Headerç•¶ä¸­&lt;/li>
&lt;li>æ”¾åœ¨ Header Accept ä¸­ï¼Œå¦‚ &lt;code>application/vnd.adventure-works.v1+json&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>åœ¨æ¡ç”¨ versioning æ™‚ï¼Œè¦è€ƒé‡åˆ° web cache çš„æ©Ÿåˆ¶ï¼Œé€šå¸¸ cache æ˜¯é‡å° URLï¼Œæ‰€ä»¥å‰å…©è€…æ¯”è¼ƒæ¨è–¦&lt;/p>
&lt;h3 id="error">Error&lt;/h3>
&lt;p>å¸¸è¦‹ä½œæ³•æœƒå›å‚³éŒ¯èª¤ä»£ç¢¼ã€éŒ¯èª¤çš„ç°¡è¿°ã€éŒ¯èª¤çš„è©³ç´°å…§å®¹ï¼Œæ–¹ä¾¿é–‹ç™¼è€…åšéŒ¯èª¤è™•ç†ï¼Œä¾‹å¦‚ä»¥ä¸‹æ ¼å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;BadArgument&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Multiple errors in ContactInfo data&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;target&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ContactInfo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;details&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;NullValue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;target&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;PhoneNumber&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Phone number must not be null&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">....&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Code å¸¸è¦‹é‚„å¯ä»¥ç”¨æ•¸å­—è¡¨ç¤ºï¼Œæ–¹ä¾¿é–‹ç™¼è€…é€éæ–‡ä»¶å¿«é€ŸæŸ¥è©¢ï¼Œä½†ä¹Ÿä¸è¦å¿˜äº†å›å‚³è©²æ¬¡éŒ¯èª¤çš„å…§å®¹æè¿°&lt;/p>
&lt;p>åˆ¥å¿˜äº†è¦æ­é…æ­£ç¢ºçš„ HTTP éŒ¯èª¤ç¢¼ä½¿ç”¨&lt;br>
400(Bad Request)ï¼šServerç„¡æ³•ç†è§£ï¼Œä¾‹å¦‚åƒæ•¸ç¼ºå°‘æˆ–éŒ¯èª¤&lt;br>
401(Unauthorized)ï¼šæˆæ¬ŠéŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ Tokenå¤±æ•ˆç­‰&lt;br>
403(Forbidden)ï¼šç„¡è¨ªå•æ¬Šé™ï¼Œæƒ³å–å¾—è¶…éç”¨æˆ¶æˆæ¬Šçš„è³‡æº&lt;br>
404(Not Found)ï¼šæŸ¥ç„¡è³‡æº&lt;br>
â€¦..&lt;/p></description></item><item><title>è®“ Node.js è·‘å¾—æ›´å¿«! ES4X å°ˆæ¡ˆèˆ‡Graal VM ä»‹ç´¹</title><link>https://yuanchieh.page/posts/2019/2019-08-18-%E8%AE%93-node.js-%E8%B7%91%E5%BE%97%E6%9B%B4%E5%BF%AB-es4x-%E5%B0%88%E6%A1%88%E8%88%87graal-vm-%E4%BB%8B%E7%B4%B9/</link><pubDate>Sun, 18 Aug 2019 11:31:29 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-08-18-%E8%AE%93-node.js-%E8%B7%91%E5%BE%97%E6%9B%B4%E5%BF%AB-es4x-%E5%B0%88%E6%A1%88%E8%88%87graal-vm-%E4%BB%8B%E7%B4%B9/</guid><description>&lt;p>æ–‡å­—ç‰ˆï¼š&lt;a class="link" href="https://dev.to/pmlopes/javascript-on-graalvm-120f" target="_blank" rel="noopener"
>https://dev.to/pmlopes/javascript-on-graalvm-120f&lt;/a>&lt;/p>
&lt;p>èº«ç‚ºä¸€åå·¥ç¨‹å¸«ï¼Œæƒ³è¾¦æ³•è®“è‡ªå·±çš„ç¨‹å¼ç¢¼åŸ·è¡Œçš„æ›´å¿«ï¼Œä¼¼ä¹æ˜¯ä¸€ç¨®å¤©æ€§ï¼Œç•¶æˆ‘å€‘æƒ³è¦å„ªåŒ– Node.js Server çš„åŸ·è¡Œé€Ÿåº¦æ™‚ï¼Œç¬¬ä¸€å°è±¡æ‡‰è©²éƒ½æ˜¯å¦‚ä½•å¯«å‡ºæ›´å¥½çš„ç¨‹å¼ç¢¼ã€ç”¨æ›´å¿«çš„æ¼”ç®—æ³•ï¼Œé€™äº›ç•¶ç„¶éƒ½æ˜¯å„ªåŒ–çš„ä¸€ç’°ï¼Œä½†å¦‚æœæ‹‰é ä¸€é»æƒ³ï¼Œæœ‰æ²’æœ‰è¾¦æ³•å»&lt;code>å„ªåŒ– Node.js Runtimeæœ¬èº«&lt;/code>å‘¢Â ?!&lt;/p>
&lt;p>ä½œè€…æåˆ°åœ¨è‘—åçš„ framework benchmark ä¸­ï¼ŒJS çš„åŸ·è¡Œæ•ˆç‡æ’åå¾ˆå¾Œé¢ï¼Œå¦‚æœç”¨ FlameChart åˆ†æï¼Œæœƒç™¼ç¾çµ•å¤§å¤šæ•¸çš„æ™‚é–“æ˜¯åœ¨åº•å±¤ä¹Ÿå°±æ˜¯ V8 Engine èˆ‡ Libuv ä¸Š&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__8pUeUi9pzwXJ9tkz.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.zenika.com/2011/04/10/nodejs/"
loading="lazy"
>&lt;/p>
&lt;p>å·¦åœ–ï¼š&lt;a class="link" href="https://blog.zenika.com/2011/04/10/nodejs/" target="_blank" rel="noopener"
>https://blog.zenika.com/2011/04/10/nodejs/&lt;/a> å³åœ–ï¼šæˆªè‡ªå½±ç‰‡&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘å€‘å†æ€éº¼å„ªåŒ– JS codeï¼Œå°±å¦‚åŒå†°å±±ä¸€è§’èˆ¬ï¼Œæ˜¯å¾ˆé›£å–å¾—éå¸¸å¤§å¹…åº¦çš„æ•ˆèƒ½æå‡ï¼Œé‚£è©²æ€éº¼è¾¦å‘¢ï¼Ÿ&lt;/p>
&lt;p>Paulo Lopes è¨­è¨ˆäº†&lt;a class="link" href="https://github.com/reactiverse/es4x" target="_blank" rel="noopener"
>ES4X&lt;/a> å°ˆæ¡ˆï¼Œä¸»è¦æ˜¯ç”¨ &lt;code>GraalVM å–ä»£ V8&lt;/code> èˆ‡ &lt;code>Vert.x å–ä»£ Libuv&lt;/code> ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å°‡åº•å±¤å¾ C/C++ å·¥å…·éŠæ›æˆäº† JVM ç‚ºä¸»çš„å·¥å…·éŠï¼Œæ ¹æ“šä½œè€…çš„ benchmarkï¼Œåœ¨ä¸åŒæ‡‰ç”¨é¢å¯æå‡ 120% ~ 700% çš„æ•ˆèƒ½&lt;/p>
&lt;p>&lt;a class="link" href="https://www.jetdrone.xyz/2018/08/06/ES4X-JavaScript.html" target="_blank" rel="noopener"
>&lt;strong>Run your JavaScript server 700% faster!&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="vertx">Vert.x&lt;/h2>
&lt;p>Vertx é¡ä¼¼æ–¼ Libuv çš„åŠŸèƒ½ï¼Œæä¾› Event-Driven èˆ‡ Non-blocking çš„æ¡†æ¶ï¼Œæä¾›å¦‚ TCP / File æ“ä½œ / DNS / HTTP / Timerç­‰ APIæ”¯æ´ï¼Œå…¶æ ¸å¿ƒæ¦‚å¿µæ˜¯é€é Event Loop æ–¹å¼é”åˆ°äº‹ä»¶é©…å‹•çš„é–‹ç™¼æ–¹å¼ï¼Œå¤§æ¦‚ç„éå»è·Ÿ Javascript çš„é–‹ç™¼ç†å¿µéå¸¸å»åˆï¼Œåƒæ˜¯&lt;/p>
&lt;h3 id="callback-function">Callback Function&lt;/h3>
&lt;p>ç‚ºæ¯å€‹äº‹ä»¶è¨»å†Š Handlerï¼Œç­‰åˆ°äº‹ä»¶å®Œæˆå¾Œæ¨é€² Event Loop ç­‰å¾…åŸ·è¡Œï¼Œ &lt;code>Don't call us, we will call you.&lt;/code>&lt;/p>
&lt;h3 id="never-block-eventloop">Never block EventÂ Loop&lt;/h3>
&lt;p>é€™é»é›·åŒæ–¼ Node.jsï¼Œä½†æ˜¯æœ‰ä¸€é»ä¸åŒæ˜¯ Node.js æ¡ç”¨ Single Event Loopï¼Œä½†æ˜¯Vertx æ¡ç”¨ Multiple Event Loopï¼Œä¸»è¦æ˜¯æ›´æœ‰æ•ˆé‹ç”¨ multi-core çš„æ©Ÿå™¨ï¼›&lt;br>
é›–ç„¶æ¡ç”¨äº† Multiple Event Loopï¼Œä½†æ˜¯ç‚ºäº†é¿å… Context Switch èˆ‡å¢é€²æ€§èƒ½ï¼Œå¦‚æœ handler A åœ¨ Event Loop1 åŸ·è¡Œï¼Œå¾ŒçºŒçš„ Callback ä¹Ÿéƒ½ä½åœ¨ Event Loop1 åŸ·è¡Œ&lt;/p>
&lt;h3 id="how-to-run-blockingcode">How to run blockingÂ code&lt;/h3>
&lt;p>ç¾å¯¦ä¸Šä¸å¯é¿å…é‚„æ˜¯æœƒéœ€è¦åŸ·è¡Œè€—æ™‚çš„é‹ç®—æˆ–æ˜¯é‹è¡Œç”¨ sync è¨­è¨ˆçš„å‡½å¼åº«ï¼Œé€™æ™‚å¯ä»¥ç”¨ executeBlockingï¼Œé¡ä¼¼æ–¼ Promiseçš„è¨­è¨ˆï¼Œä½†æœƒé‹ä½œåˆ°å¾ Worker Thread Pool å–å¾—çš„ Thread ä¸Šï¼Œé¿å…å¡ä½ Event Loop&lt;/p>
&lt;p>ä½†æ–‡ä»¶æè¿°åˆ° executeBlocking é›–ç„¶æ˜¯ç”¨æ–¼ blocking code executionï¼Œä½†å»ºè­°è¶…é 10s çš„æ“ä½œé‚„æ˜¯å¦å¤–ç®¡ç† Thread&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">vertx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">executeBlocking&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">function&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">promise&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Call some blocking API that takes a significant amount of time to return_
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">var&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">someAPI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">blockingMethod&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;hello&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">promise&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">complete&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">},&lt;/span> &lt;span class="n">function&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">res_err&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">console&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">log&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;The result is: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="concurrent-composition">Concurrent composition&lt;/h3>
&lt;p>éåŒæ­¥æ“ä½œä¸€å¤§è¦è§£æ±ºçš„å•é¡Œå°±æ˜¯æ“ä½œé †åºï¼ŒVertx æä¾›åƒ &lt;code>CompositeFuture.allã€CompositeFuture.any&lt;/code> ç­‰ APIï¼Œå¾ JS è§’åº¦æ‡‰è©²éƒ½ä¸é™Œç”Ÿ&lt;/p>
&lt;p>ç›´æ¥ä½¿ç”¨ Vertx çš„ JS æ–¹æ¡ˆæœ‰ä¸€å€‹å¾ˆå¤§çš„å•é¡Œ&lt;/p>
&lt;blockquote>
&lt;p>ç›®å‰æ˜¯åŸºæ–¼ Nashorn é€™å¥— JS Engineï¼Œåƒ…æ”¯æ´åˆ° ES 5.1ä¸¦ä¸æ”¯æ´ ES6 ä»¥å¾Œçš„èªæ³•ï¼Œå¦‚æœ Library ç”¨ ES6 ä»¥å¾Œèªæ³•å¯«ä¹Ÿéƒ½ä¸æ”¯æ´&lt;/p>
&lt;/blockquote>
&lt;p>é€™ç®—æ˜¯è‡´å‘½å‚·äº†å§ï¼Œå¦‚æœä¸èƒ½æ•´åˆç¾åœ¨çš„ JS ç”Ÿæ…‹ç³»é‚£æ‡‰è©²å¾ˆå°‘äººæ•¢æ¡ç”¨é€™å¥—æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>æ‰€ä»¥ ES4X æ˜¯ä¸€å€‹å…¨æ–°åŸºæ–¼ Vertx é–‹ç™¼çš„ &lt;code>JS Runtime&lt;/code>ï¼ŒåŠ å…¥äº† ES6+ çš„æ”¯æ´æ›´å¥½èˆ‡ç¾åœ¨ JSç”Ÿæ…‹ç³»æ•´åˆï¼Œæ‰€ä»¥ Promise / async-await ç­‰ç­‰éƒ½å¯ä»¥æ¡ç”¨ï¼ŒåŒæ™‚ Vertx çš„èªæ³•ä¹ŸåŒæ™‚æ”¯æ´ï¼Œä½œè€…æåˆ°ä¸‹ä¸€ç‰ˆçš„ Vertx æœƒæ£„ç”¨ç¾æœ‰çš„ Vertx JS æ”¹ç”¨ ES4Xã€‚&lt;/p>
&lt;blockquote>
&lt;p>é¡Œå¤–è©±ï¼š&lt;br>
ä½œè€…äººå¾ˆå¥½ï¼Œåœ¨æ–‡ç« åº•ä¸‹æå•å¾ˆå¤šç–‘æƒ‘éƒ½åœ¨ 24 hr å…§å¾—åˆ°è§£ç­”ï¼ŒçœŸçš„æ˜¯å¾ˆæ„Ÿè¬&lt;/p>
&lt;/blockquote>
&lt;h2 id="graalvm">GraalVM&lt;/h2>
&lt;p>GraalVm æ˜¯ä¸€å€‹æä¾›å¤šèªè¨€çš„é‹è¡Œç’°å¢ƒï¼Œé€é Graal Compiler ç·¨è­¯æˆ Java Bytecode ä¸¦åŸ·è¡Œæ–¼ Java HotSpot VMä¸Šï¼Œæ‰€ä»¥å¯ä»¥å…¼å®¹æ–¼ JVM-based çš„èªè¨€å¦‚ Java/Scala/Kotlinç­‰ï¼›&lt;br>
é€é Truffer frameworkï¼Œå¯ä»¥å…¼å®¹å…¶ä»–çš„ç¨‹å¼èªè¨€ï¼Œå¦‚JS/Python/R/Rubyç­‰ç­‰&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__pH1347fH__vCQeKkD.jpg"
loading="lazy"
>&lt;/p>
&lt;p>è¨±å¤šç¨‹å¼èªè¨€éƒ½å¿…é ˆè¦æœ‰ä¸€å€‹è‰¯å¥½çš„é‹è¡Œç’°å¢ƒ Runtimeï¼Œä½†æ˜¯è¦æ‰“é€ ä¸€å€‹å®‰å…¨ã€é«˜æ•ˆçš„é‹è¡Œç’°å¢ƒæ˜¯éå¸¸å›°é›£ä¸”è€—æ™‚çš„ï¼Œä¾‹å¦‚èªª JSçš„ V8 Engine ä¹Ÿæ˜¯ Googleå¤šå¹´çš„æŠ•å…¥æ‰æœ‰é€™éº¼å¥½çš„æˆæœï¼Œå…¶ä»–èªè¨€ç›¸è¼ƒä¹‹ä¸‹æ²’æœ‰é€™éº¼å¤šè³‡æºï¼Œè‡ªç„¶é‹è¡Œçš„é€Ÿåº¦å°±å¾ˆæ…¢ï¼›&lt;br>
æ‰€ä»¥ GraalVMå¸Œæœ›é€éé€šç”¨åŒ–è™›æ“¬åŒ–æŠ€è¡“ï¼Œè®“ä¸åŒçš„ç¨‹å¼èªè¨€åªè¦ç”¨ Java é€é&lt;a class="link" href="https://github.com/oracle/graal/tree/master/truffle" target="_blank" rel="noopener"
>Truffle&lt;/a> Framework å¯¦ä½œè©²èªè¨€çš„ ASTï¼Œå¾ŒçºŒçš„é‹è¡Œå°±äº¤çµ¦ GraalVMï¼Œé™ä½æ–°èªè¨€é–‹ç™¼çš„å›°é›£&lt;/p>
&lt;p>é™¤äº†è®“åŸæœ¬çš„ç¨‹å¼èªè¨€åŸ·è¡Œå¾—æ›´å¿«ï¼Œæ¡ç”¨ GraalVMå¦ä¸€å¤§å¥½è™•æ˜¯å¯ä»¥æ··åˆèªè¨€(Polyglot)é–‹ç™¼ï¼Œä¾‹å¦‚ JSå…§ä½¿ç”¨ Rçš„å¥—ä»¶ï¼Œè®“ä¸åŒçš„èªè¨€ç™¼æ®å„è‡ªçš„é•·è™•ï¼Œè€Œä¸”&lt;code>æ•ˆèƒ½ä¸å—åˆ°è·¨èªè¨€çš„å½±éŸ¿&lt;/code>ï¼Œå› ç‚ºä¸åŒçš„èªè¨€æœ€å¾Œéƒ½æ˜¯é€šé Truffle Framework ç”Ÿæˆ Graal Compiler äº†è§£çš„ASTï¼Œæœ€å¾Œ Compile å‡ºä¾†çš„æ©Ÿå™¨ç¢¼ä¸æœƒå› ç‚ºä¸åŒèªè¨€è€Œæœ‰æ‰€å·®ç•°&lt;/p>
&lt;p>æ›´å¤šçš„ç´°ç¯€å¯ä»¥åƒè€ƒé€™æ”¯å½±ç‰‡&lt;/p>
&lt;h3 id="å¯¦ä½œç”¨ç¶²é é¡¯ç¤ºåœ–è¡¨-æ¡ç”¨-graalvm-èˆ‡es4x">å¯¦ä½œâ€Šâ€”â€Šç”¨ç¶²é é¡¯ç¤ºåœ–è¡¨ /æ¡ç”¨ GraalVM èˆ‡Â ES4X&lt;/h3>
&lt;p>ç°¡å–®æ•´åˆå…©è€…çš„ Example Codeï¼Œç”¨ ES4X åŸ·è¡Œä¸€å€‹ Web Serverï¼Œä¸¦ç”¨ GraalVm ç•¶ä½œé‹è¡Œç’°å¢ƒï¼Œæ¡ç”¨ Rç¹ªè£½åœ–è¡¨ã€‚&lt;/p>
&lt;h4 id="å®‰è£">å®‰è£&lt;/h4>
&lt;p>åˆ° &lt;a class="link" href="https://github.com/oracle/graal/releases/tag/vm-19.1.1" target="_blank" rel="noopener"
>https://github.com/oracle/graal/releases/tag/vm-19.1.1&lt;/a> ä¸‹è¼‰å®‰è£æª”ï¼Œè§£å£“ç¸®å¾ŒåŠ å…¥è·¯å¾‘&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&amp;lt;æª”æ¡ˆä½ç½®&amp;gt;/graalvm-ce-19.1.1/Contents/Home/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">JAVA_HOME&lt;/span>&lt;span class="o">=&lt;/span>&amp;lt;æª”æ¡ˆä½ç½®&amp;gt;/Contents/Home
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¨­å®šå¥½ä¹‹å¾Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å¹¾å€‹ commandï¼Œnode æ”¹æˆç”¨ GraalVMåŸ·è¡Œï¼Œé è¨­åƒ…æ”¯æ´ Java/Javascriptï¼Œå¦‚æœéœ€è¦å…¶ä»–èªè¨€å‰‡è¦ &lt;code>$gu install python&lt;/code> ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">runs a JavaScript console with GraalVM.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replacement &lt;span class="k">for&lt;/span> Node.js, using GraalVMâ€™s JavaScript engine.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ lli
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">is a high-performance LLVM bitcode interpreter integrated with GraalVM.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ gu &lt;span class="o">(&lt;/span>GraalVM Updater&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">can be used to install language packs &lt;span class="k">for&lt;/span> Python, R, and Ruby.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°¡å–®è©¦ä¸€ä¸‹è·¨èªè¨€çš„ç‰¹æ€§&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å„²å­˜æˆ test.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Polyglot&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;python&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;[1,2,42,4]&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">$&lt;/span> &lt;span class="nx">node&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="nx">polyglot&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="nx">jvm&lt;/span> &lt;span class="nx">test&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">js&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>Ployglot.eval&lt;/code> å¯ä»¥åŸ·è¡Œå…¶ä»–æŒ‡å®šèªè¨€çš„èªæ³•ï¼Œ&lt;/p>
&lt;p>å‰›åŸ·è¡Œæ™‚æœƒéœ€è¦èŠ±æ¯”è¼ƒå¤šçš„æ™‚é–“ warn upï¼Œæ‰€ä»¥å¦‚æœè¦ç•¶ä½œ Command line tool æˆ–å…¶ä»–ç”Ÿå‘½é€±æœŸçŸ­çš„æ‡‰ç”¨ç¨‹å¼ï¼Œå°±å»ºè­°ç¹¼çºŒä½¿ç”¨ Nodejs å³å¯ï¼›&lt;br>
é•·æ™‚é–“é‹è¡Œçš„è©±ï¼ŒGraalVM çš„æ•ˆèƒ½èˆ‡ V8 å…¶å¯¦æ˜¯å·®ä¸å¤šçš„ï¼Œä½†å¦‚æœå¤šè€ƒé‡è·¨èªè¨€çš„ç‰¹æ€§ï¼ŒGraalVM æœƒæ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡&lt;/p>
&lt;h2 id="es4x">ES4X&lt;/h2>
&lt;p>å…ˆå®‰è£åˆå§‹åŒ–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ npm install -g es4x-pm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mkdir &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ es4x init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// å®‰è£æ‰€éœ€å¥—ä»¶
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm install @vertx/unit --save-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm install @vertx/core --save-prod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm install @vertx/web --save-prod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>index.jsï¼Œæ¥è‘—ç”¨ &lt;code>$npm run start&lt;/code> åŸ·è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">/// &amp;lt;reference types=&amp;#34;@vertx/core/runtime&amp;#34; /&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// @ts-check
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">vertx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">createHttpServer&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">requestHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">response&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">end&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;hello world.&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8080&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€æ³¨æ„ï¼Œå¦‚æœè¦é”åˆ°æœ€ä½³æ€§èƒ½çš„æå‡éœ€è¦ä½¿ç”¨å®ƒæä¾›çš„ web framework &lt;code>@vertx/web&lt;/code>ï¼Œå¦‚æœæ˜¯ä½¿ç”¨åƒ Express.jsåº•å±¤çš„ System API Call å°±ä¸æœƒèµ° Vertxï¼Œè€Œæ˜¯ç”¨ç•¶ä¸‹ Runtime ç’°å¢ƒçš„è™•ç†æ–¹å¼ (Node.js or GraalVM)ï¼Œç´°ç¯€é‚„éœ€è¦æ›´è¿‘ä¸€æ­¥ç†è§£å°ˆæ¡ˆæ‰èƒ½è§£é‡‹ï¼Œä¸éå¾ä½œè€…çš„æè¿°ç¾æ³æ˜¯å¦‚æ­¤ï¼Œæ‰€ä»¥èˆŠå°ˆæ¡ˆè¦ç§»æ¤æœƒé‡å¯«çš„é–€æª»&lt;/p>
&lt;p>å¦å¤–ç›®å‰ä¸æ”¯æ´ GraalVMçš„ Polyglotï¼Œå·²å›å ±çµ¦ä½œè€…éœ€è¦ç­‰ä»–å¯¦ä½œã€‚&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>è·³è„«æ¡†æ¶ï¼Œä»¥å‰æ²’æƒ³éé€éæ›¿æ› JS Runtime å¯ä»¥æ›å–æ€§èƒ½çš„æå‡ï¼Œä¹Ÿä¸æ›¾æ¥è§¸éåƒ GraalVMé€™æ¨£å¤šèªè¨€æ”¯æ´çš„ Runtimeï¼Œç´°ç¯€æœ‰è »å¤šé—œæ–¼ Compiler ç›¸é—œçš„çŸ¥è­˜ï¼Œè‡ªå·±å¾ˆå¤šéƒ½å¿˜äº†ï¼Œéœ€è¦åœ¨åŠ å¼·æ‰è¡Œ&lt;/p>
&lt;p>ç¸½çµç›®å‰ä½¿ç”¨ GraalVMèˆ‡ ES4X&lt;/p>
&lt;ol>
&lt;li>GraalVM å¯ä»¥æ¸¬è©¦é€šé npm 90%çš„ packageï¼Œé™¤äº†ä¸€äº› native code ç·¨å¯«çš„ libraryï¼Œå…¶ä»–ä¸å¤ªéœ€è¦æ“”å¿ƒæ”¯æ´åº¦å•é¡Œï¼›&lt;/li>
&lt;li>GraalVM èªæ³•æ”¯æ´åˆ°æœ€æ–°çš„ ES2019/2020ï¼Œé€™é»é‚„è »ä¸éŒ¯çš„&lt;/li>
&lt;li>GraalVM æ€§èƒ½å°æ¯”èˆ‡ V8ä¸å·®å¤šå°‘ï¼Œåªæ˜¯è¦ä¸€æ®µ warm up çš„æ™‚é–“ï¼Œå¦‚æœæœ‰è·¨èªè¨€æ•´åˆéœ€æ±‚ï¼Œå¯ä»¥è€ƒæ…®çœ‹çœ‹&lt;/li>
&lt;li>ES4X å¯ä»¥çµåˆ Vert.x èˆ‡ GraalVMå„ªé»ï¼Œå¾—åˆ°å¤§é‡çš„æ€§èƒ½æå‡ï¼Œä½†æ˜¯å°ˆæ¡ˆé‚„æ²’ç©©å®šï¼Œéœ€è¦è€ƒé‡ï¼›&lt;br>
é–‹ç™¼ä¹Ÿå¿…é ˆç”¨ä»–çš„ Frameworkï¼Œä½¿ç”¨ Express.js / Koa.js ç­‰ç”¨æˆ¶ç„¡æ³•ç„¡ç—›è½‰ç§»&lt;/li>
&lt;/ol></description></item><item><title>V8 å…§çš„æ’åºæ¼”ç®—æ³•â€Šâ€”â€ŠTimsort</title><link>https://yuanchieh.page/posts/2019/2019-08-09-v8-%E5%85%A7%E7%9A%84%E6%8E%92%E5%BA%8F%E6%BC%94%E7%AE%97%E6%B3%95-timsort/</link><pubDate>Fri, 09 Aug 2019 05:41:03 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-08-09-v8-%E5%85%A7%E7%9A%84%E6%8E%92%E5%BA%8F%E6%BC%94%E7%AE%97%E6%B3%95-timsort/</guid><description>&lt;p>åœ¨æœ€æ–°çš„ä¸€æœŸ Javascript Weekly ä¸­çœ‹åˆ° V8 éƒ¨è½æ ¼ 2019/07/09 çš„æ–‡ç« ï¼Œè£¡é ­æåˆ° ECMAScript Spec å°‡ Sorting æ”¹æˆ &lt;code>Stable&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ’åºä¸Šå…©å€‹å…ƒç´ é †åºç›¸åŒï¼Œå‰‡æœ€çµ‚æ’åºå®Œæˆçš„é™£åˆ—ä¸­çš„ç›¸åŒé †åºå…ƒç´ ï¼Œæœƒä¾ç…§åŸæœ¬çš„é †åºæ’åˆ—ï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;b&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">}]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¾ç…§ value æ’åº ===&amp;gt;&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;b&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">}]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// a è·Ÿ b é †åºç›¸åŒï¼Œè€Œ a ç¶­æŒåœ¨ b ä¹‹å‰
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…ˆå‰çš„ Spec æ²’æœ‰ç‰¹åˆ¥å®šç¾©ï¼Œæ‰€ä»¥å„å¹³å°çš„å¯¦ä½œä¸åŒï¼Œä¹‹å¾ŒChrome 70+ èˆ‡ Nodejs 12+ é–‹å§‹æ”¯æ´ Stable Sortingï¼Œå…¶é¤˜çš„å¹³å°é‚„ä¸ç¢ºå®šã€‚&lt;/p>
&lt;h2 id="timsort">TimSort&lt;/h2>
&lt;p>&lt;a class="link" href="https://en.wikipedia.org/wiki/Timsort" target="_blank" rel="noopener"
>&lt;strong>Timsort&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ä½œè€…åŸæ–‡&lt;/p>
&lt;p>&lt;a class="link" href="http://svn.python.org/projects/python/trunk/Objects/listsort.txt" target="_blank" rel="noopener"
>http://svn.python.org/projects/python/trunk/Objects/listsort.txt&lt;/a>&lt;/p>
&lt;p>åƒè€ƒè‡ªç¶­åŸºï¼ŒTim Sort åŸç†æ˜¯ç”± Tim Peter åŸºæ–¼ Merge Sort èˆ‡ Insertion Sortæ‰€è¨­è¨ˆçš„æ’åºæ¼”ç®—æ³•ï¼ŒTim è§€å¯Ÿåˆ°å¯¦éš›ä¸–ç•Œçš„é™£åˆ—å¤šåŠæ˜¯&lt;code>ç”±å¤šå€‹éƒ¨åˆ†æ’åºçš„æ•¸åˆ—æ‰€çµ„æˆ&lt;/code>ï¼Œæ‰€ä»¥ Tim Sort æœƒå…ˆæ‰¾å‡ºé™£åˆ—ä¸­æ’åºå¥½çš„å­é™£åˆ—(ç¨±ç‚º run)ï¼Œä¸æ–·çš„åˆä½µ run ç›´åˆ°æ•´é«”æ’åºçµæŸï¼ŒåŸºæ–¼é€™æ¨£çš„åŸç†å¯ä»¥è¨­è¨ˆå‡ºæ›´å¥½çš„æ’åºæ¼”ç®—æ³•ã€‚&lt;/p>
&lt;p>ä½œè€…æåˆ°ï¼Œrandom array æœ€ä½³çš„æ’åºæ³•è¢« bound åœ¨ O(nlog n) (æ–‡ä¸­æ˜¯ç”¨ O(n!)ï¼Œå…©è€…ç­‰åƒ¹)ï¼Œä½†æ˜¯ä¸åŒçš„ O(nlog n)ç­‰ç´šçš„ sorting æ¼”ç®—æ³•é›¢ O(log n) çš„æ¥µé™å€¼é‚„æ˜¯æœ‰å·®è·ï¼ŒTimsort å¤§æ¦‚è·é›¢æ¥µé™å€¼ 1%ï¼Œè€Œä¸€èˆ¬çš„ quick sort å‰‡æ˜¯ 39% ä¹‹é ï¼›&lt;br>
èˆ‡åŸæœ¬ Python native çš„ sample sort ç›¸æ¯”å…©è€…å·®ç•°ä¸å¤§ï¼Œrandom array Timsort è¼ƒå·®ï¼Œä½†æ˜¯ Timsort é‡å°éƒ¨åˆ†æ’åºçš„é™£åˆ—è¡¨ç¾æ›´ä½³ã€‚&lt;/p>
&lt;p>ç›®å‰ Pythonã€Android SDKã€Java SDKã€Chrome ã€Swift å…§éƒ¨çš„ sort() éƒ½æ¡ç”¨ Tim Sortï¼Œæ‡‰ç”¨éå¸¸å»£æ³›ã€‚&lt;/p>
&lt;h3 id="åŸºæœ¬è§€å¿µ">åŸºæœ¬è§€å¿µ&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.drmaciver.com/2010/01/understanding-timsort-1adaptive-mergesort/" target="_blank" rel="noopener"
>&lt;strong>Understanding timsort, Part 1: Adaptive Mergesort&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ç›´æ¥æ­»ç£• Wikiæœ‰é»çœ‹ä¸æ‡‚ï¼Œæ¯å€‹è‹±æ–‡å¥å­éƒ½æ‡‚ä½†å°±æ˜¯ç„¡æ³•ç†è§£èƒŒå¾Œè¨­è¨ˆçš„å«ç¾©ï¼Œç¶²è·¯ä¸Šçœ‹åˆ°é€™ç¯‡æœ€æ·ºé¡¯æ˜“æ‡‚çš„è§£é‡‹ï¼Œä»¥ä¸‹ç°¡å–®æ‘˜éŒ„é‡é»å¹«åŠ©ç†è§£ã€‚&lt;/p>
&lt;p>Tim Sort è„«èƒæ–¼ Merge Sortï¼Œè©¦è‘—ç”¨é€™ä¸‰å€‹æ–¹å‘å»å„ªåŒ– Merge Sort&lt;/p>
&lt;ol>
&lt;li>è®“ merge éç¨‹æ›´å¿«&lt;/li>
&lt;li>è®“ merge æ¬¡æ•¸è®Šå°‘&lt;/li>
&lt;li>åœ¨ç‰¹æ®Šæ¢ä»¶ä¸‹ç”¨æ›´å¥½çš„æ–¹å¼å–ä»£ Merge Sort&lt;/li>
&lt;/ol>
&lt;p>è©¦æƒ³æœ‰å€‹é™£åˆ—&lt;/p>
&lt;p>{5, 6, 7, 8, 9, 10, 1, 2, 3}&lt;/p>
&lt;p>ç”¨æ€æ¨£çš„æ–¹å¼å¯ä»¥ç”¨æœ€å°‘çš„ merge å®Œæˆæ’åºï¼Ÿ&lt;/p>
&lt;p>ç›´è¦ºä¾†çœ‹ï¼ŒæŠŠé™£åˆ—æ‹†æˆå…©å€‹å·²ç¶“æŒ‰ç…§å‡åºæ’åºçš„é™£åˆ— &lt;code>{5,6,7,8,9,10}&lt;/code> èˆ‡ &lt;code>{1,2,3}&lt;/code> ç„¶å¾Œåˆä½µï¼Œåªéœ€è¦ä¸€æ¬¡ merge å°±å¯ä»¥å®Œæˆ&lt;/p>
&lt;p>å‡ä½¿æˆ‘å€‘å…ˆæå‡ºä¸€å€‹æ¼”ç®—æ³•ï¼šæ‰¾åˆ°é™£åˆ—é–‹é ­æœ€é•·çš„é€£çºŒå‡åºæ’åºçš„é™£åˆ—ï¼Œå…¶é¤˜ç•¶ä½œç¬¬äºŒå­é™£åˆ—ï¼Œä»¥éè¿´æ–¹å¼æŒçºŒè™•ç†&lt;/p>
&lt;p>é€™å€‹æ¼”ç®—æ³•åˆ©ç”¨äº†å·²æ’åºçš„é™£åˆ—å»æ¸›å°‘ merge çš„æ¬¡æ•¸ï¼Œä½†æœ‰å€‹å•é¡Œ å¦‚æœé™£åˆ—å‰›å¥½æ˜¯å€’åºï¼Œå°±æœƒè½å…¥ worst case O(nÂ²) ï¼Œç¨±ä¸ä¸Šæ˜¯å€‹ç†æƒ³çš„æ’åºæ¼”ç®—æ³•ï¼Œæ‰€ä»¥å¯¦ä½œæ™‚æœƒè£œä¸Šå¦‚æœç™¼ç¾é€£çºŒçš„å­é™£åˆ—æ˜¯é™åºï¼Œå‰‡ in memory ååºã€‚&lt;/p>
&lt;p>&lt;strong>å…ˆé€€å›æœ€åŸºæœ¬çš„ Merge Sort&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">{{1}, {2}, {3}, {4}}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{{1, 2}, {3, 4}}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{{1, 2, 3, 4}}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ˜¯ Merge Sort çš„æµç¨‹ï¼Œå°‡é™£åˆ—åˆ†æ‹†åˆ°ç‚ºä¸€ç„¶å¾Œåœ¨é€æ­¥ mergeï¼Œæˆ‘å€‘å°‡ç¬¬ä¸€æ­¥åˆ†æ‹†çš„éç¨‹æ”¹ç‚ºå·²æ’åºå¥½çš„å€é–“(ç¨±ç‚º Run)ï¼Œç„¶å¾Œé€²è¡Œ mergeã€‚&lt;/p>
&lt;p>Tim Sort åœ¨ merge æ™‚æœƒç›¡é‡ Balanceï¼Œæ‰€ä»¥æœƒè¨­å®š minrunï¼Œå¦‚æœé€™æ¬¡çš„ RUN é•·åº¦å°æ–¼ minrunï¼Œå‰‡æœƒè£œè¶³åˆ° minruné•·åº¦å¾Œï¼Œæ¥è‘—ä½¿ç”¨ binary insertion sortï¼Œå¦‚ä½•é¸æ“‡ minrun æ˜¯å€‹å­¸å•ï¼Œä½œè€…æåˆ°ä¸€å€‹å¯¦å‹™ä¸Šçš„è¨­å®šæ˜¯&lt;/p>
&lt;p>take the first 6 bits of N, and add 1 if any of the remaining bits are set&lt;/p>
&lt;p>N æ˜¯é™£åˆ—é•·åº¦ï¼Œæœ€ä¸»è¦æ˜¯å¸Œæœ›å¦‚æœé‡åˆ° random arrayï¼Œå‰‡N ç›¡å¯èƒ½è¢« minrun åˆ‡æˆ 2 æ¬¡æ–¹å€ RUNï¼Œåœ¨ merge æ™‚å¯ä»¥æœ€å¹³è¡¡ã€‚&lt;/p>
&lt;blockquote>
&lt;p>minRun æ˜¯å¸Œæœ›å‰©é¤˜çš„æ•¸å†åˆ†minrunçš„æ™‚å€™èƒ½ç›¡å¯èƒ½æ˜¯2çš„å†ªæ¬¡ï¼Œå¾ŒçºŒå†åšmergeçš„æ™‚å€™æ‰èƒ½å…©å…©åˆä½µæ•ˆç‡è¼ƒé«˜ï¼›&lt;br>
å¯¦ä½œä¸Šæœƒä¸æ–·å°‡né™¤ä»¥äºŒ ç›´åˆ°n&amp;lt;MIN_MERGEï¼Œè€Œä¸­é–“åªè¦æœ‰ä»»ä½•ä¸€æ¬¡ä¸èƒ½è¢«2æ•´é™¤ï¼Œæœ€çµ‚çµæœå°±åŠ ä¸€ï¼Œé€™æ¨£å–çš„minRunæœƒè®“åˆ†çµ„æœ€æ¥è¿‘2å†ª&lt;br>
(æ„Ÿè¬å…¬å¸åŒäº‹ Frank è£œå……)&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚ N = 2112ï¼Œminrun = 32 æœƒåˆ‡æˆ 66å€‹RUNï¼Œå‰‡åˆä½µæ™‚æœ€å¾Œæœƒè®Šæˆ 2048 + 64ï¼Œå…©è€…éå¸¸ä¸å¹³è¡¡ï¼›&lt;br>
ä½†å¦‚æœ minrun æ˜¯ 33ï¼Œå‰‡æœƒè¢«åˆ‡æˆ 64å€‹RUNï¼Œåˆ‡å‰²æˆ 2çš„ n æ¬¡æ–¹å€‹æ•¸åˆä½µèµ·ä¾†å°±å¾ˆå¹³è¡¡ (perfect balanced)ã€‚&lt;/p>
&lt;h3 id="æ±ºå®šä½•æ™‚-merge">&lt;strong>æ±ºå®šä½•æ™‚ merge?&lt;/strong>&lt;/h3>
&lt;p>Tim Sort æœƒç”¨ä¸€å€‹ Stack æš«å­˜ RUNï¼Œä¸¦ä¸æ˜¯ä¸€é–‹å§‹å°±è¼ªè©¢æ•´å€‹é™£åˆ—ç”¢ç”ŸRUNï¼Œè€Œæ˜¯é€æ­¥é€²è¡Œï¼Œé¿å…è¦ç”¨æ‰éå¤šçš„è¨˜æ†¶é«”ã€‚&lt;/p>
&lt;p>åŸºæ–¼é€™å…©å€‹åŸå‰‡ï¼ŒTim Sort å¯¦ä½œä¸Šæœ‰å€‹å‡½å¼ &lt;code>merge_collapse&lt;/code> ï¼Œé€™å€‹å‡½å¼ä¸»è¦åˆ¤æ–·ç›®å‰ Stack æœ€ä¸Šå±¤çš„ä¸‰å€‹ RUN æ˜¯å¦ç¬¦åˆä»¥ä¸‹è¦å‰‡&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">1\. A &amp;gt; B+C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2\. B &amp;gt; C
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœç¬¦åˆï¼Œå‰‡å°‡ä¸‹ä¸€å€‹ RUN push åˆ° Stackä¸Šï¼Œåä¹‹å‰‡æ¯”è¼ƒ Aè·Ÿï¼£ï¼Œè¼ƒå°è€…èˆ‡ B mergeï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">A:30 B:20 C:10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A &lt;span class="err">&amp;lt;&lt;/span>= B + C æ‰€ä»¥ä¸ç¬¦åˆ merge_collapseï¼Œåˆå› ç‚º C &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nt">A&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="na">æ‰€ä»¥&lt;/span> &lt;span class="na">C&lt;/span> &lt;span class="na">è·Ÿ&lt;/span> &lt;span class="na">B&lt;/span> &lt;span class="na">merge&lt;/span> &lt;span class="na">è®Šæˆ&lt;/span> &lt;span class="na">A:30&lt;/span> &lt;span class="na">BC:&lt;/span> &lt;span class="na">30&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€éé€™æ¨£çš„æ–¹å¼ï¼Œè®“ä¿ç•™åœ¨ Stack ä¸Šçš„ RUN é•·åº¦å¹³è¡¡ï¼Œå¦ä¸€å€‹é‡é»æ˜¯åˆä½µåªèƒ½æ˜¯ A+(B+C) æˆ–æ˜¯ (A+B)+Cï¼Œå› ç‚ºè¦ä¿æŒ Stableï¼Œæ‰€ä»¥ merge ä¸€å®šè¦ç›¸é„°å…©å€‹ RUNã€‚&lt;/p>
&lt;h4 id="å¦‚ä½•-merge">å¦‚ä½• merge&lt;/h4>
&lt;p>è¦å°‡å…©å€‹ç›¸é„°å­é™£åˆ—ï¼Œç”¨ in memory æ–¹å¼ merge åœ¨å¯¦ä½œä¸Šæœƒæœ‰å›°é›£ï¼Œå¯¦å‹™ä¸Šå› ç‚ºè¦é€ æˆå¤§é‡çš„ memory æ“ä½œå…¶å¯¦ä¹Ÿä¸æœƒæ¯”è¼ƒå¿«ï¼Œæ‰€ä»¥ Tim Sort ä½¿ç”¨ä¸€å¡Šæš«å­˜è¨˜æ†¶å€ï¼Œå¤§å°ç‚º (A,B) é™£åˆ—çš„æœ€å°é•·åº¦&lt;/p>
&lt;p>å¦‚æœ A &amp;lt; Bï¼Œå‰‡å…ˆå°‡ A æ”¾é€²æš«å­˜è¨˜æ†¶å€ï¼Œæœ€ç›´è¦ºçš„æ–¹å¼æ˜¯ A è·Ÿ B å¾é ­é–‹å§‹æ¯”å°ï¼Œå°çš„æ”¾é€² A çš„ä½ç½®ï¼Œç›´åˆ° A è·Ÿ B æ’åºå®Œæˆï¼Œå¦‚åŒä¸€èˆ¬ merge sort çš„åšæ³•ï¼Œåˆç¨±ç‚º &lt;code>one-pair-at-a-time&lt;/code>ã€‚&lt;/p>
&lt;p>ä½†å› ç‚º A è·Ÿ B éƒ½å·²ç¶“æ˜¯æ’åºå¥½çš„é™£åˆ—ï¼Œæ‰€ä»¥æœ‰å€‹å„ªåŒ–çš„æ–¹å¼æ˜¯æ‰¾å‡º B[0] åœ¨ Aé™£åˆ—æ’åºçš„ä½ç½®ï¼Œç„¶å¾ŒAè©²ä½ç½®ä¹‹å‰éƒ½æ˜¯å°æ–¼ B[0]ï¼Œæ‰€ä»¥å¯ä»¥æ•´æ®µæ”¾é€²å»ï¼Œæ¥è‘—æ‰¾å‰©é¤˜A[0]åœ¨ Bçš„ä½ç½®ï¼Œä¸æ–·è¼¾è½‰ç›´åˆ°æ’åˆ—çµæŸï¼Œä¹Ÿå°±æ˜¯ &lt;code>gollaping mode&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">A: [1,2,3,7,8,9] B: [4,5,6,8,9,10,11]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nt">B&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="na">æ‰€ä»¥&lt;/span> &lt;span class="na">A&lt;/span> &lt;span class="na">æ”¾å…¥æš«å­˜å€&lt;/span> &lt;span class="na">temp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">å…ˆæ‰¾&lt;/span> &lt;span class="na">B&lt;/span>&lt;span class="err">[&lt;/span>&lt;span class="na">0&lt;/span>&lt;span class="err">]&lt;/span> &lt;span class="na">åœ¨&lt;/span> &lt;span class="na">A&lt;/span> &lt;span class="na">çš„ä½ç½®&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="na">ä¹Ÿå°±æ˜¯åœ¨&lt;/span> &lt;span class="na">A&lt;/span>&lt;span class="err">[&lt;/span>&lt;span class="na">2&lt;/span>&lt;span class="err">]ã€&lt;/span>&lt;span class="na">A&lt;/span>&lt;span class="err">[&lt;/span>&lt;span class="na">3&lt;/span>&lt;span class="err">]&lt;/span>&lt;span class="na">ä¹‹é–“&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="na">å› ç‚º&lt;/span> &lt;span class="na">B&lt;/span>&lt;span class="err">[&lt;/span>&lt;span class="na">0&lt;/span>&lt;span class="err">]&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> A[2]ï¼Œä¹Ÿå°±æ˜¯ A[0]~A[2] å¯ä»¥ç›´æ¥æ”¾å›å»ï¼Œè®Šæˆ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A: [1,2,3] B: [4,5,6,8,9,10,11]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">temp: [7,8,9]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æ¥è‘—æ‰¾ temp[0] åœ¨ Bçš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ B[2]ã€B[3] ä¹‹é–“ï¼Œè®Šæˆ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A: [1,2,3,4,5,6] B: [9,10,1]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">temp: [7,8,9]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æ¥è‘—æ‰¾ B[0] åœ¨ temp çš„ä½ç½®ï¼ŒæŒçºŒåè¦†
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™å„ªåŒ–çš„æ–¹å¼å¤§å¤šæ•¸æ˜¯æœ‰æ­£å‘çš„æ•ˆæœï¼Œä½†å¦‚æœé‡åˆ° random arrayï¼Œå¯èƒ½æœƒæ¯”åŸæœ¬çš„ &lt;code>one-pair-at-a-time&lt;/code> é‚„è¦æ…¢ï¼Œä½†ä½œè€…æåŠ&lt;/p>
&lt;blockquote>
&lt;p>It&amp;rsquo;s generally true in this algorithm that we&amp;rsquo;re willing to gamble a little to win a lot, even though the net expectation is negative for random data&lt;/p>
&lt;/blockquote>
&lt;p>é¢¨éšªèˆ‡æ”¶ç›Šè©•ä¼°å¾Œï¼Œæ•´é«”é‚„æ˜¯æ­£å‘çš„ï¼Œæ‰€ä»¥å°±æ±ºå®šæ¡ç”¨ã€‚&lt;/p>
&lt;p>å¯¦å‹™ä¸Šæœ‰ä¸€å€‹å›ºå®šåƒæ•¸ MIN_GALLOP =7 èˆ‡è®Šå‹•åƒæ•¸ minGallopï¼Œä¸€é–‹å§‹æ¡ç”¨ &lt;code>one-pair-at-a-time mode&lt;/code>ï¼Œä¸€ç›´åˆ°æŸå€‹é™£åˆ—çš„é¦–ä½å…ƒç´ æŒçºŒå¤§æ–¼å¦ä¸€é™£åˆ—ï¼Œæ‰åˆ‡æ›åˆ° &lt;code>galloping mode&lt;/code>ï¼›&lt;br>
å¦‚æœ galloping search(çœ‹å¾ŒçºŒ)æ‰¾åˆ°çš„å…ƒç´ ä½ç½®å°æ–¼MIN_GALLOP å‰‡é€€å› &lt;code>one-pair-at-a-time mode&lt;/code>ï¼Œåä¹‹å‰‡æŒçºŒç”¨ &lt;code>galloping mode&lt;/code>ï¼›&lt;br>
å¦‚æœä¸€ç›´åœ¨ galloping searchï¼Œæœƒä¸‹ä¿® minGallopï¼Œä¹Ÿå°±æ˜¯æ›´å®¹æ˜“é€²å…¥ galloping mode çš„æ„æ€ã€‚&lt;/p>
&lt;p>åè¦†åŸ·è¡Œåˆ°å…©å€‹é™£åˆ—åˆä½µå®Œæˆ&lt;/p>
&lt;h4 id="æ‰¾å‡ºæŸæ•¸åœ¨å·²æ’åºé™£åˆ—ä¸­çš„ä½ç½®">æ‰¾å‡ºæŸæ•¸åœ¨å·²æ’åºé™£åˆ—ä¸­çš„ä½ç½®&lt;/h4>
&lt;p>é€²å…¥ galloping mode æ™‚ï¼Œæœƒéœ€è¦ä¸æ–·çš„æŸ¥æ‰¾æŸæ•¸åœ¨å·²æ’åºé™£åˆ—çš„ä½ç½®ï¼Œå‡è¨­ A æ˜¯è¼ƒçŸ­çš„é™£åˆ—ï¼Œä¸€é–‹å§‹æ‰¾ A[0] åœ¨ Bé™£åˆ—æ‡‰æ’åºçš„ä½ç½®ï¼Œæœ€ç›´è¦ºçš„æ–¹å¼æ˜¯ç”¨ binary searchï¼Œä½†é€™é‚Šä½œè€…æ”¹æ¡ç”¨å¦ä¸€å€‹æ¼”ç®—æ³• &lt;code>galloping search&lt;/code>(åˆç¨± expotential search)&lt;/p>
&lt;p>ç›¸è¼ƒæ–¼ binary search ä¸æ–·å°åŠåˆ‡æŸ¥æ‰¾ï¼Œgalloping search æ˜¯æ¯”å° &lt;code>(2^k)th&lt;/code> å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æ‰¾ 1, 3, 5, 7, 15 é€™æ¨£çš„æ–¹å¼ï¼Œç•¶æ‰¾åˆ° &lt;code>(2^(j-i)) &amp;lt; x &amp;lt; (2^j)&lt;/code> æ™‚ï¼Œåœ¨æ”¹ç”¨ binary searchã€‚&lt;/p>
&lt;p>æ¯”è¼ƒé€™å…©è€…ï¼Œ galloping search çš„æ™‚é–“è¤‡é›œåº¦æ˜¯ &lt;code>O(i)&lt;/code>ï¼Œi æŒ‡çš„æ˜¯ x åœ¨æŸ¥è©¢é™£åˆ—çš„ä½ç½®ï¼Œå¦‚æœ i å¾ˆå‰é¢é‚£æ•ˆç‡å°±æœƒå¾ˆé«˜ï¼›&lt;br>
binary search æ™‚é–“è¤‡é›œåº¦ç‚º &lt;code>O(n)&lt;/code>ï¼Œn æ˜¯æŸ¥è©¢é™£åˆ—çš„é•·åº¦ã€‚&lt;br>
è€Œ n â‰¥ i ï¼Œæ‰€ä»¥å¾æ™‚é–“è¤‡é›œåº¦ä¾†çœ‹ galloping search æœƒæ¯” binary search é‚„è¦å¿«ä¸€äº›ã€‚&lt;/p>
&lt;p>ä½†å¯¦éš›ä¸Šï¼Œå› ç‚ºé™£åˆ—æ˜¯éš¨æ©Ÿçš„ï¼Œæ¡ç”¨ galloping search å¯èƒ½æœƒæ¯” linear search æ…¢ï¼Œä½œè€…åˆ—å‡º galloping search å°æ¯” linear search çš„è¨ˆç®—èŠ±è²»ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ i=7 ä¹‹å‰ galloping search æœƒéœ€è¦æ›´å¤šçš„æ¯”è¼ƒæ¬¡æ•¸ï¼Œè€Œæ¯”è¼ƒæ˜¯å¾ˆèŠ±è¨ˆç®—è³‡æºçš„ï¼Œæ‰€ä»¥ MIN_GALLOPé è¨­æ˜¯ 7ã€‚&lt;/p>
&lt;h3 id="ç¸½çµæ¼”ç®—æ³•">ç¸½çµæ¼”ç®—æ³•&lt;/h3>
&lt;p>ç¨å¾®ç¸½çµä¸€ä¸‹ï¼ŒTimsort ç¶­è­·ä¸€å€‹ Stackï¼ŒStack ä¸Šæœƒ push å·²æ’åºçš„é€£çºŒå­é™£åˆ—ï¼Œä¸¦é€é &lt;code>merge_collapse&lt;/code> åˆ¤æ–·æ˜¯å¦å…ˆ merge Stack ä¸Šçš„é™£åˆ—ï¼Œç›¡é‡ä¿æŒå­é™£åˆ—çš„é•·åº¦æ¥è¿‘ï¼›&lt;/p>
&lt;p>merge éç¨‹ï¼Œå‰‡æ˜¯å‹•æ…‹åœ¨ one-pair-at-a-time èˆ‡ galloping mode ä¸­åˆ‡æ›ï¼Œç”¨æœ‰æ•ˆç‡çš„æ–¹å¼åˆä½µå…©å€‹å·²æ’åºå¥½çš„é™£åˆ—ï¼›&lt;/p>
&lt;h3 id="é€²å…¥ç¨‹å¼ç¢¼">é€²å…¥ç¨‹å¼ç¢¼&lt;/h3>
&lt;p>æœ€çµ‚é‚„æ˜¯è¦çœ‹ä¸€ä¸‹ä»£ç¢¼ï¼ŒåŸä½œè€…æ˜¯ç”¨ Cå¯«ï¼Œå› ç‚º java code æ¯”è¼ƒå¥½é–±è®€åƒè€ƒ android TimSort å¯¦ä½œ&lt;/p>
&lt;p>&lt;a class="link" href="https://android.googlesource.com/platform/libcore/&amp;#43;/jb-mr2-release/luni/src/main/java/java/util/TimSort.java" target="_blank" rel="noopener"
>&lt;strong>luni/src/main/java/java/util/TimSort.java - platform/libcore - Git at Google&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ä¹Ÿæœ‰ js ç‰ˆï¼Œä½†æ˜¯è¨»è§£è¼ƒå°‘&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/mziccard/node-timsort/blob/master/src/timsort.js" target="_blank" rel="noopener"
>&lt;strong>mziccard/node-timsort&lt;/strong>&lt;/a>&lt;/p>
&lt;p>&lt;code>minRunLength()&lt;/code> å®šç¾©å¦‚ä½•æ±ºå®š minrunçš„å€¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// Becomes 1 if any 1 bits are shifted off while (n &amp;gt;= MIN_MERGE) {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">n&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>gallopLeft()&lt;/code> ç”¨ galloping search æ‰¾å‡ºæœ€å·¦ â‰¤ element çš„ä½ç½®ï¼Œå› ç‚ºæ˜¯ pass æ•´å€‹ array çš„ referenceï¼Œæ‰€ä»¥æœƒæœ‰ base / hint å»å®šä½å…ƒç´ ï¼Œçœ‹èµ·ä¾†ç¨å¾®è¤‡é›œ&lt;/p>
&lt;p>&lt;code>mergeLo()ã€mergeHi()&lt;/code> åˆ†åˆ¥å°æ‡‰ (A+B)+C / A+(B+C) å…©ç¨®æƒ…æ³ï¼Œé‚è¼¯é¡ä¼¼ï¼Œ &lt;code>outer&lt;/code> æ®µè½å°±æ˜¯åœ¨ one-pair-at-a-time modeï¼Œåªæœ‰ä»»ä¸€é‚Šé™£åˆ—é€£çºŒå¤§æ–¼ minGallop æ‰æœƒåˆ‡åˆ° galloping modeï¼›&lt;br>
æ¥è‘—å† galloping modeï¼Œæ‰¾åˆ°çš„å…ƒç´ å¿…é ˆä½ç½®å¤§æ–¼ MIN_GALLOPï¼Œå¦å‰‡å°±æœƒè·³å‡º galloping modeï¼ŒåŒæ™‚ minGallopæœƒ +=2ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡å¾…åœ¨ one-pair-at-a-time mode æœƒæ›´ä¹…ã€‚&lt;/p>
&lt;p>é€é minGallop èˆ‡ MIN_GALLOPï¼Œç¢ºä¿ merge åœ¨å…©ç¨®æ¨¡å¼ä¸­å–å¾—è¼ƒä½³çš„æ•ˆç‡ã€‚&lt;/p>
&lt;h3 id="bug">BUG&lt;/h3>
&lt;p>å¦‚æœå†æŸ¥ TimSortï¼Œä½ å¯èƒ½æœƒæ‰¾åˆ°é€™ä¸€ç¯‡æ–‡ç« &lt;/p>
&lt;p>&lt;a class="link" href="http://www.envisage-project.eu/proving-android-java-and-python-sorting-algorithm-is-broken-and-how-to-fix-it/" target="_blank" rel="noopener"
>&lt;strong>Envisage: Engineering Virtualized Services&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ä¸»è¦åœ¨è¬› java ç‰ˆçš„å¯¦ä½œï¼Œå¯èƒ½æœƒå‡ºç¾ OutMemeroyBound çš„å•é¡Œï¼Œä¸»è¦æ˜¯å› ç‚ºåœ¨ allocate Stack çš„é•·åº¦æ™‚ï¼Œæœƒæœ‰ä»¥ä¸‹æ¥µç«¯ç‹€æ³å°è‡´ Stack é•·åº¦é è¨­éçŸ­è€Œè¨˜æ†¶é«”ä¸å¤ ç”¨&lt;/p>
&lt;p>å•é¡Œå‡ºåœ¨timsortæœ¬èº«çš„ç´„æŸæ¢ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">1\. runLen[i-2] &amp;gt; runLen[i-1] + runLen[i]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2\. runLen[i-1] &amp;gt; runLen[i]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨runLenç‚ºä»¥ä¸‹æƒ…æ³æ™‚ï¼Œ&lt;code>120, 80, 25, 20, 30&lt;/code>ï¼Œ&lt;code>25&amp;lt;20+30&lt;/code>æ‰€ä»¥é€²è¡Œrun[3]ï¼Œrun[4]åˆä½µï¼Œè®Šç‚ºï¼Œ&lt;code>120, 80, 45, 30&lt;/code>&lt;br>
é€™æ™‚å€™ç”±æ–¼ &lt;code>80&amp;gt;45+30, 45&amp;gt;30&lt;/code> æ¢ä»¶æ»¿è¶³äº†ï¼Œmergeå°±çµ‚æ­¢äº†&lt;/p>
&lt;p>ä½†æ­¤æ™‚&lt;code>120&amp;lt;80+45&lt;/code>æ˜¯ä¸æ»¿è¶³ç´„æŸæ¢ä»¶çš„ï¼Œä½†æˆ‘å€‘åªå°ä¸Šå±¤é€²è¡Œåˆ¤æ–·&lt;br>
å¦‚æœï¼ˆç²¾å¿ƒç­–åŠƒï¼‰ä¸€äº›ç‰¹æ®Šæ•¸çµ„é€ æˆå¤§é‡é€™æ¨£çš„æƒ…æ³ï¼Œè€Œåœ¨åŸå§‹ç¢¼ä¸­ ç©ºé–“æ˜¯é€™æ¨£ç”³è«‹çš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">int stackLen = (len &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nt">120&lt;/span> &lt;span class="err">?&lt;/span> &lt;span class="na">5&lt;/span> &lt;span class="na">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">len&lt;/span> &lt;span class="err">&amp;lt;&lt;/span> &lt;span class="na">1542&lt;/span> &lt;span class="err">?&lt;/span> &lt;span class="na">10&lt;/span> &lt;span class="na">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">len&lt;/span> &lt;span class="err">&amp;lt;&lt;/span> &lt;span class="na">119151&lt;/span> &lt;span class="err">?&lt;/span> &lt;span class="na">19&lt;/span> &lt;span class="na">:&lt;/span> &lt;span class="na">40&lt;/span>&lt;span class="err">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">runBase &lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="s">new&lt;/span> &lt;span class="na">int&lt;/span>&lt;span class="err">[&lt;/span>&lt;span class="na">stackLen&lt;/span>&lt;span class="err">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">runLen &lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="s">new&lt;/span> &lt;span class="na">int&lt;/span>&lt;span class="err">[&lt;/span>&lt;span class="na">stackLen&lt;/span>&lt;span class="err">];&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢stackLen,æ˜¯æ»¿è¶³ä¸Šé¢æåˆ°çš„ç´„æŸæ¢ä»¶è·ŸMIN_MERGEæƒ…æ³ä¸‹å»ä¼°è¨ˆçš„æœ€å¤§å¯èƒ½æ•¸é‡ï¼Œä½†å‰›ä¹Ÿèªªäº†ï¼Œåªå°ä¸Šå±¤é€²è¡Œåˆ¤æ–·ï¼Œæœƒæœ‰ä¾‹å¤–ç‹€æ³å°è‡´æ‰€éœ€è¦çš„å¤§å°å¯èƒ½è¶…å‡ºåŸæœ¬é æƒ³çš„ï¼Œè‡³æ–¼ä¿®å¾©çš„æ–¹å¼æ˜¯æŠŠæª¢æŸ¥æœ€å¾Œä¸‰å€‹runLenè®Šæˆæª¢æŸ¥æœ€å¾Œå››å€‹runLen&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">newMergeCollapse&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">stackSize&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stackSize&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">;**&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">1&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">])&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">2&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">]))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">])&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="o">--;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">runLen&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">])&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// Invariant is established
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mergeAt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Š Bug éƒ¨åˆ†ä¹Ÿæ˜¯ç”±å¼·è€…å…¬å¸åŒäº‹ Frank è£œå……ï¼Œæœ‰èˆˆè¶£è€…å¯ä»¥é»é€²å»çœ‹åŸæ–‡ï¼ŒåŸæ–‡åŒ…å«èªªæ˜äº†å¦‚ä½•ç”¨å·¥å…·èˆ‡æ–¹æ³•æ‰¾å‡ºå•é¡Œçš„ï¼Œä½†å› ç‚ºé‚„æ²’æœ‰åˆ°éå¸¸ç†è§£å°±ä¸å¤šåšèªªæ˜ã€‚&lt;/p>
&lt;p>é€™ Bug å·²ç¶“è¢«ä¿®å¾©ï¼Œåœ¨ Python çš„ Bugå›å ±è¨è«–ä¸­ï¼ŒTim Peter æåˆ°å…¶å¯¦ç¾æœ‰çš„æ©Ÿå™¨æ²’æœ‰è¶³å¤ çš„ Memory å»ç”¢ç”Ÿé€™æ¨£çš„å•é¡Œï¼ŒJava ç‰ˆå¯¦ä½œä¹Ÿæ˜¯æœ‰ä¸€äº›æ”¹å‹•æ‰æœ‰è¾¦æ³•å¾©ç¾ï¼Œä¸éæœ€çµ‚åŸºæ–¼é‚è¼¯çš„å®Œæ•´æ€§ï¼Œé‚„æ˜¯å…ˆä¿®å¾©äº†æ­¤å•é¡Œï¼Œé¿å…æœªä¾†æœ‰å•é¡Œã€‚&lt;/p>
&lt;h2 id="v8çš„å¯¦ä½œ">V8çš„å¯¦ä½œ&lt;/h2>
&lt;p>&lt;a class="link" href="https://v8.dev/blog/array-sort#timsort" target="_blank" rel="noopener"
>&lt;strong>Getting things sorted in V8&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>åœ¨è©•ä¼°æ’åºæ¼”ç®—æ³•ä¸Šï¼Œæœƒè€ƒé‡&lt;code>æ¯”å°æ¬¡æ•¸&lt;/code>è·Ÿ&lt;code>è¨˜æ†¶é«”ç”¨é‡&lt;/code>ï¼Œåœ¨å‹•æ…‹èªè¨€åŒ…å« JS ä¸­æ¯”å°æ¬¡æ•¸ç›¸å°é‡è¦ï¼Œå› ç‚ºåœ¨æ¯”å°çš„æ™‚å€™æœƒä½¿ç”¨åˆ°ç”¨æˆ¶å¯«çš„ç¨‹å¼ç¢¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">compare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// Arbitrary code goes here, e.g. `array.push(1);`.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// A â€œtypicalâ€ sort
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">compare&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯”å°å‡½å¼å›å‚³ &lt;code>0 ã€1(æˆ–å…¶ä»–æ­£å€¼)ã€-1(æˆ–å…¶ä»–è² å€¼)&lt;/code>åˆ†åˆ¥ä»£è¡¨ &lt;code>ç­‰æ–¼ã€å¤§æ–¼ã€å°æ–¼&lt;/code> ï¼Œåœ¨æ¯”å°å‡½å¼ä¸­ç”¨æˆ¶å¯èƒ½æœƒæœ‰ Side-Effect æ“ä½œç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">toString&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// Arbitrary code goes here, e.g. `array.push(1);`.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;42&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Sort without a comparison
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é è¨­çš„æ¯”å°å‡½å¼æœƒå…ˆå‘¼å« &lt;code>toString()&lt;/code> è½‰æˆå­—ä¸²æ¯”å°&lt;/p>
&lt;p>æ¥è‘—æŠŠ Spec å…ˆæ”¾åœ¨è…¦å¾Œï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯ &lt;code>Implementation-defined&lt;/code> ï¼Œåœ¨ä¸€äº› Spec ä¿ç•™å¯¦ä½œå½ˆæ€§çš„éƒ¨åˆ†ï¼Œå·¥ç¨‹å¸«æœ‰æ©Ÿæœƒå»è‡ªç”±ç™¼æ®ï¼Œåšå‡ºç†æƒ³ä¸­ç”¨æˆ¶æœƒå¸Œæœ›çœ‹åˆ°çš„è¡Œç‚ºï¼Œä½†é€™éƒ¨åˆ†å„å€‹ JS Engine è¡Œç‚ºå·®ç•°å¾ˆå¤§ï¼Œä¾‹å¦‚èªªé‡ä¸Šäº† &lt;code>accessors(getter/setter)&lt;/code> æˆ–&lt;code>prototype-chain&lt;/code> ï¼Œå¼·çƒˆå»ºè­°ä¸è¦é€™æ¨£å¯«ç¨‹å¼ï¼Œé€™è£¡åƒ…ä½œèªªæ˜&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Object&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">defineProperty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;get 0&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;set 0&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Object&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">defineProperty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">get&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;get 1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;set 1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">object&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;d1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">3&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;b1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">4&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">undefined&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">__proto__&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">length&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;e2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">10&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;a2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">100&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;b2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1000&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">2000&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">undefined&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">8000&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;d2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">12000&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;XX&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">__proto__&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;e3&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;d3&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c3&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">6&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">undefined&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">prototype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sort&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="v8-åœ¨æ’åºå‰å¾Œçš„è™•ç†">V8 åœ¨æ’åºå‰å¾Œçš„è™•ç†&lt;/h2>
&lt;p>åœ¨ Specä¸­ï¼Œå°‡æ’åºçš„å…ƒç´ åˆ†æˆä¸‰éƒ¨åˆ†&lt;/p>
&lt;ol>
&lt;li>non-undefined valueï¼Œé€™éƒ¨åˆ†æœƒå¥—ç”¨æ¯”å°å‡½å¼æ±ºå®šæ’åº&lt;/li>
&lt;li>undefined valueï¼Œæ”¾åœ¨æ’åºçš„æœ€å¾Œ&lt;/li>
&lt;li>holesï¼Œä¸å­˜åœ¨çš„å€¼&lt;/li>
&lt;/ol>
&lt;p>V8 åœ¨å¯¦ä½œä¸Šçš„æ­¥é©Ÿå¤§æ¦‚ç‚º&lt;/p>
&lt;ol>
&lt;li>æ‰¾å‡º Array æˆ–æ˜¯ Object çš„ &lt;code>length&lt;/code>&lt;/li>
&lt;li>è¨­è®Šæ•¸ &lt;code>numberOfUndefineds&lt;/code> ç‚º 0&lt;/li>
&lt;li>åœ¨ç¯„åœ &lt;code>[0, length)&lt;/code> ä¸­&lt;br>
- é‡åˆ° holes ä¸è™•ç†&lt;br>
- é‡åˆ° undefined å°‡ &lt;code>numberOfUndefineds++&lt;/code>- é‡åˆ° non-undefined valueï¼Œæ”¾åˆ°æš«å­˜é™£åˆ—ä¸Š&lt;/li>
&lt;/ol>
&lt;p>æ¥è‘—ç”¨ &lt;code>TimSort&lt;/code> å°æš«å­˜é™£åˆ—åšæ’åºï¼Œä¹‹å¾Œå°‡æš«å­˜æš«åˆ—å¯«å›åŸé™£åˆ—æˆ–ç‰©ä»¶ä¸­ï¼Œä¸¦åœ¨å¾Œé¢è£œè¶³ &lt;code>numberOfUndefineds&lt;/code> æ•¸é‡çš„ undefinedï¼Œåˆªé™¤å‰©é¤˜çš„é•·åº¦(ç§»é™¤ hole)ï¼Œé€™æ¨£å°±å®Œæˆæ’åºäº†ã€‚&lt;/p>
&lt;h3 id="éå»çš„å¯¦ä½œ">éå»çš„å¯¦ä½œ&lt;/h3>
&lt;p>éå» V8 æ˜¯å°é™£åˆ—(length &amp;lt; 10) ç”¨ Insertion Sort å…¶é¤˜æ¡ç”¨ Quick Sortï¼Œè€Œ Quick Sort ä¸­åˆ†å‰²çš„å°é™£åˆ—é•·åº¦å°æ–¼ 10 ä¹Ÿæ˜¯ç”¨ Insertion Sortï¼›&lt;br>
å› ç‚º Quick Sort æ˜¯æ¡ç”¨éè¿´çš„æ–¹å¼ï¼Œå°é™£åˆ—æ”¹ç”¨ Insertion Sort æ•ˆç‡è¼ƒå¥½ã€‚&lt;/p>
&lt;p>Quick Sort åœ¨é¸æ“‡ pivot çš„é»å¾ˆé‡è¦ï¼Œé¸ä¸å¥½å°±æœƒè·‘åˆ°æœ€å·®æƒ…æ³ O(nÂ²)ï¼ŒV8 æ¡ç”¨å…©ç¨®ç­–ç•¥ï¼š&lt;br>
1. é¸æ“‡å­é™£åˆ—ä¸­ç¬¬ä¸€å€‹ã€æœ€å¾Œä¸€å€‹ã€ç¬¬ä¸‰å€‹æ•¸çš„ä¸­ä½æ•¸&lt;br>
2. å°æ–¼å¤§çš„é™£åˆ—ï¼Œé¸æ“‡è¢«æ’åºéæ•¸åˆ—çš„ä¸­ä½æ•¸&lt;/p>
&lt;p>Quick Sort å„ªé»åœ¨æ–¼æ˜¯ In-Place æ’åºï¼Œä½†ç¼ºé»æœ‰å¯èƒ½æœƒè½åˆ° O(nÂ²)ã€‚&lt;/p>
&lt;p>ç¾è¡Œå°±æ”¹æˆ TimSort äº†ã€‚&lt;/p></description></item><item><title>é¾èˆŸç¬¬äºŒå¹´â€Šâ€”â€Šé—œæ–¼è‡ªä¿¡</title><link>https://yuanchieh.page/posts/2019/2019-06-10-%E9%BE%8D%E8%88%9F%E7%AC%AC%E4%BA%8C%E5%B9%B4-%E9%97%9C%E6%96%BC%E8%87%AA%E4%BF%A1/</link><pubDate>Mon, 10 Jun 2019 23:08:00 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-06-10-%E9%BE%8D%E8%88%9F%E7%AC%AC%E4%BA%8C%E5%B9%B4-%E9%97%9C%E6%96%BC%E8%87%AA%E4%BF%A1/</guid><description>&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__7e4fICGoUIVVydSZggCmLw.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>åˆ’é¾èˆŸé‚å…¥ç¬¬äºŒå¹´ï¼Œé–‹å§‹ç¿’æ…£ä¸‰æœˆåˆ°å…­æœˆä»¥åˆ’é¾èˆŸç•¶ä½œä¸€å¹´çš„é–‹ç«¯ï¼Œé‡æ–°èª¿æ•´è‡ªå·±çš„å¿ƒæ…‹èˆ‡é«”æ…‹ï¼›&lt;br>
é‚éç¬¬ä¸€å¹´ç—›è‹¦çš„å…¥é–€æœŸï¼Œç¬¬äºŒå¹´æ¼¸å…¥ä½³å¢ƒï¼Œé–‹å§‹å¯ä»¥äº«å—åˆ’èˆ¹çš„æ¨‚è¶£èˆ‡æ¯”è³½çš„åˆºæ¿€ï¼Œä¹Ÿé–‹å§‹åœ¨é€™éç¨‹é«”æœƒåˆ°ä¸€äº›å…¶ä»–å¿ƒå¢ƒä¸Šçš„æˆé•·ï¼Œé—œæ–¼è‡ªä¿¡èˆ‡åœ˜éšŠé€™ä»¶äº‹ã€‚&lt;/p>
&lt;h4 id="å‰æƒ…æè¦">å‰æƒ…æè¦&lt;/h4>
&lt;p>é¾èˆŸç«¶è³½åœ¨ç«¯åˆç¯€æ™‚æœƒæœ‰å¤šå€‹åœ°æ–¹æ”¿åºœç¨ç«‹èˆ‰è¾¦ï¼Œä¾‹å¦‚æˆ‘å€‘éšŠä¸ŠåŒæ™‚åƒåŠ å°åŒ—å¸‚èˆ‡æ–°åŒ—å¸‚ï¼Œå…¶ä»–å¦‚æ–°ç«¹ã€å°å—ä¹Ÿéƒ½æœ‰è³½äº‹ï¼›&lt;br>
æ–°åŒ—å¸‚åªæœ‰å¤§å‹é¾èˆŸï¼Œèˆ¹ä¸Šæœ‰å¥ªæ¨™æ‰‹ã€é¼“æ‰‹ã€8å°æ§³æ‰‹ã€èˆµæ‰‹ï¼Œä»Šå¹´è³½åˆ¶æ˜¯å¥ªæ¨™æ‰‹åœ¨æ±ºè³½æ‰ä¸Šå ´ï¼›&lt;br>
å°åŒ—å¸‚å‰‡éšŠä¼çœ¾å¤šï¼Œçµ„åˆ¥ä¹Ÿéå¸¸å¤šï¼Œé¡åˆ¥å†åˆ†æˆå¤§å‹é¾èˆŸè·Ÿå°å‹é¾èˆŸï¼Œå¤§å‹é¾èˆŸæœ‰ 10å°æ§³æ‰‹ï¼Œå°å‹å‰‡æœ‰ 5å°æ§³æ‰‹ï¼›&lt;br>
æ¯”è³½éƒ½æ˜¯åˆ’ 500å…¬å°ºï¼Œå¤§å‹é¾èˆŸæœ‰å¥ªæ¨™æ‰‹çœ‹å¥ªæ¨™æ™‚é–“ï¼Œä½†å¦‚æœå¥ªæ¨™å¤±æ•—å‰‡çœ‹èˆ¹å°¾é€šéçš„æ™‚é–“ï¼›&lt;br>
å°å‹é¾èˆŸæ²’æœ‰å¥ªæ¨™æ‰‹ï¼Œæ¯”çš„æ˜¯èˆ¹é ­é€šéæ™‚é–“ï¼Œä½†å¦‚æœç™¼ç”Ÿæ‰æ§³æˆ–æ˜¯å…¶ä»–å¤±èª¤ï¼Œå‰‡çœ‹èˆ¹å°¾é€šéæ™‚é–“ï¼Œé€šå¸¸æ¯”è³½æ™‚æˆ‘å€‘æœƒèˆ¹å°¾é€šéæ‰åœã€‚&lt;/p>
&lt;h3 id="é—œæ–¼è‡ªä¿¡">é—œæ–¼è‡ªä¿¡&lt;/h3>
&lt;p>é‚„è¨˜å¾—ç¬¬ä¸€å¤©åœ¨å°åŒ—å¸‚å¤§ä½³æ²³æ¿±å…¬åœ’é è³½çš„æ™‚å€™ï¼Œå°å‹é¾èˆŸç”·å­çµ„æ˜¯æ’åœ¨ 11 é»çš„è³½ç¨‹ï¼Œç•¶æ™‚æ­£è™•æ–¼é€†é¢¨é€†æµçš„ç‹€æ…‹ï¼Œå¤§æ¦‚æœƒæ˜¯é †é¢¨é †æµå…©å€çš„å®Œè³½æ™‚é–“ï¼ŒåŠ ä¸ŠåŸæœ¬å¤§ä½³çš„èˆ¹é‡æ§³ä¹Ÿé‡ï¼Œé›–ç„¶çŸ¥é“æ¯éš»éšŠä¼éƒ½é¢è‡¨ä¸€æ¨£çš„è™•å¢ƒï¼Œä½†æƒ³æƒ³ä¹Ÿæ˜¯è »å´©æ½°çš„ï¼Œå°æ¯å€‹äººä¾†èªªéƒ½æ˜¯é«”èƒ½ä¸Šèˆ‡ç²¾ç¥ä¸Šå¾ˆå¤§çš„æ¶ˆè€—ï¼›&lt;/p>
&lt;p>ä½†æ•™ç·´åœ¨é›†åˆçš„æ™‚å€™å°±èªªï¼šã€Œç­‰ç­‰é€†é¢¨é€†æµæ˜¯è€åŠ›è³½ï¼Œæœƒåˆ’å¾ˆä¹…ï¼Œä½†ä¸ç”¨æ€•ï¼Œæˆ‘å€‘å¹³å¸¸æœ€é éƒ½åˆ’é 5å…¬é‡Œï¼Œä¸€å®šæ’å¾—å®Œçš„ï¼ã€&lt;/p>
&lt;p>è½åˆ°é€™çœ‹è‘—éšŠå‹ç›¸è¦–è€Œç¬‘ï¼Œä»Šå¹´éšŠä¸Šçš„è¨“ç·´æ¨¡å¼æ¯”è¼ƒæ³¨é‡è€åŠ›ï¼Œé‚„è¨˜å¾—åœ¨å››äº”æœˆé€²å…¥å‚™è³½æœŸæ™‚ï¼Œæ¯å¤©æ—©ä¸Šå›ºå®šæœƒå…ˆæ‹‰é•·è·é›¢æš–èº«ï¼Œå¾ä¸€é–‹å§‹ 500å…¬å°ºæ…¢æ…¢æ‹‰åˆ° 800ã€1200 åˆ° 2000å…¬å°ºï¼›&lt;br>
æœ‰ä¸€å¤©æ—©ä¸Šä¾‹è¡Œæš–èº«ï¼Œå¾ç¢§æ½­ç¢¼é ­å‡ºç™¼ç¹åˆ°ä¸Šæ¸¸å†ä¸€è·¯æ‹‰åˆ°åŠæ©‹ä¸‹ï¼Œå®Œæˆ 2000å…¬å°ºçš„æš–èº«ï¼Œçœ‹åˆ°åŠæ©‹å¿ƒè£¡è¦ºå¾—å·®ä¸å¤šè©²åœäº†å§ï¼Œä½†å¥‡æ€ªçš„æ˜¯æ•™ç·´æ€éº¼æ²’æœ‰åœçš„æ„æ€ï¼Œåªæœ‰ä¸€ç›´å–Šã€Œä¸è¦æ”¾ï¼Œç¹¼çºŒæ‹‰é•·ã€å¾Œä¾†èˆµæ‰‹ç¹äº†ä¸€åœˆå›é ­å¾åŠæ©‹å†åº¦å¾€ä¸Šæ¸¸å‡ºç™¼ï¼Œå¤§å®¶å¿ƒè£¡éƒ½è¦ºå¾—ä¸å¦™äº†ï¼Œæ˜¯ä¸æ˜¯æ•™ç·´ç®—æ•¸ä¸å¥½å“©ç¨‹æ•¸ç®—éŒ¯äº†ï¼Œä½†æ•™ç·´åœ¨å¤§å®¶ä¹Ÿä¸æ•¢å·æ‡¶ï¼Œåªèƒ½å’¬è‘—ç‰™ç¹¼çºŒæ‹¼ï¼›&lt;br>
é‚£æ™‚å€™è‚Œè‚‰å·²ç¶“é–‹å§‹é…¸ç—›ï¼Œå°¤å…¶æ˜¯è‚©è†€è¦è² è²¬å›æ§³è·Ÿå£“æ§³å…¥æ°´ï¼Œæ•´å€‹ä¸‰è§’è‚Œç·Šç¹ƒï¼Œèº«é«”å¥½åƒè¢«çŒæ°´æ³¥ä¸€æ¨£çš„æ²ˆé‡ï¼Œä½†æ²’æœ‰äººæ•¢åœä¸‹å‹•ä½œæˆ–æ˜¯åˆ†ç¥ï¼Œå› ç‚ºæ•™ç·´åœ¨èˆ¹é ­è™è¦–çœˆçœˆçš„æ³¨è¦–è‘—ä½ ï¼›&lt;br>
å°±åƒåœ¨æ²™æ¼ è¡Œèµ°å¿«è¦å¤±æ°´è€Œæ­»çš„æ—…äººï¼Œæ¸´æœ›åœä¸‹ä¾†ä¼‘æ¯ï¼Œåœ¨é‚„æ²’åœä¸‹ä¾†çš„éç¨‹ï¼Œé–‹å§‹æœƒæ€è€ƒé€™æ¨£æœƒä¸æœƒå—å‚·ï¼Œé€ƒé¿æˆ–å·æ‡¶çš„å¿µé ­ç”¢ç”Ÿï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæœƒæƒ³è¦é€¼å‡ºæ›´å¥½è‡ªå·±å†å¤šæ’ä¸€ä¸‹ï¼Œå°±åœ¨å…©ç¨®å¿µé ­ä¸æ–·äº¤é›œçš„éç¨‹ï¼Œçµ‚æ–¼åˆ°äº†ï¼Œé‚„è¨˜å¾—é‚£å¤©åˆ’äº† 3200 å…¬å°ºï¼Œæ¯”ä¹‹å‰å¤šäº† 50%çš„é‡Œç¨‹ï¼›&lt;br>
å¾Œé¢æ•™ç·´å°±é€æ­¥çªç ´å¤§å®¶å¿å—çš„æ¥µé™ï¼Œæœ€é ä¸€è¶Ÿåˆ’äº† 5000å…¬å°ºã€‚&lt;/p>
&lt;p>å›æƒ³åˆ°æ•´å€‹è¨“ç·´çš„éç¨‹ï¼Œèˆ‡èº«é‚Šçš„éšŠå‹å€‘ä¸€èµ·ç¶“æ­·éçš„é€™äº›è¨“ç·´ï¼Œçªç„¶è¦ºå¾—å¿ƒä¸­çš„ä¸å®‰èˆ‡æƒ¶æéƒ½æ•£å»ï¼ŒåŠ›æ°£ä¹Ÿæ…¢æ…¢æ¹§ä¸Šï¼Œå°‡éå»çš„ç©ç´¯åŒ–æˆæœ€è¸å¯¦çš„ä¿¡å¿ƒï¼Œç›¸ä¿¡è‡ªå·±ç›¸ä¿¡éšŠå‹ï¼Œå¾Œä¾†é è³½ä¹Ÿé †åˆ©é€šéï¼Œä»Šå¹´é–‹å§‹æ¯ä¸€æ§³éƒ½å¾ˆç©©å®šçš„æŠ“æ°´åˆ°æœ€å¾Œï¼Œå¾ˆç´¯ä½†ä¹Ÿå¾ˆéç™®ï¼Œä¸€è·¯æŒºé€²åŠæ±ºè³½èˆ‡æœ€çµ‚æ±ºè³½ï¼Œæœ€å¾Œæ‹¿ä¸‹ç¬¬å››åçš„æˆç¸¾ã€‚&lt;/p>
&lt;p>æˆ‘ç›¸ä¿¡åœ¨ä»»ä½•é ˜åŸŸæƒ³è¦æˆåŠŸéƒ½å¿…é ˆè¦åŠ å€çš„ä»˜å‡ºï¼Œé€™äº›ä»˜å‡ºä¸å–®å–®å¸¶ä¾†å¯¦åŠ›çš„æå‡ï¼Œé‚„æœ‰å¿ƒæ…‹ä¸Šæ­£é¢çš„å½±éŸ¿ï¼›&lt;br>
é‹å‹•ç®—æ˜¯ç›¸å°å–®ç´”çš„é ˜åŸŸï¼ŒæŒçºŒçš„ç·´ç¿’ï¼Œå°±æœƒæŒçºŒçš„çœ‹è¦‹é€²æ­¥ï¼Œåˆ°äº†æ¯”è³½è¦ä¸Šå ´çš„é‚£ä¸€åˆ»ï¼Œæ‰‹ä¸Šç£¨å‡ºä¾†çš„ç¹­åŒ–æˆæ¡æ§³æœ€æœ‰åŠ›çš„è‡ªä¿¡ã€‚&lt;/p>
&lt;p>çœ‹è¦‹å…¶ä»–æ¯”æˆ‘å€‘å²å®³çš„éšŠä¼ï¼Œæœƒè‡ªçŸ¥å·®äº†ä¸€æˆªä½†ä¹Ÿä¸è‡´æ–¼æ°£é¤’ï¼Œåè€Œæœƒæ›´å°Šé‡ä»–å€‘çš„ä»˜å‡ºï¼Œå› ç‚ºä»–å€‘æ›´åŠ çš„åˆ»è‹¦èˆ‡åŠªåŠ›æ‰æœƒæœ‰äº†ä»Šå¤©çš„ä½³ç¸¾ï¼›&lt;br>
çœ‹åˆ°å…¶ä»–å¯¦åŠ›ç¨å¼±çš„éšŠä¼ä¹Ÿä¸æœƒè¼•è¦–ï¼Œå› ç‚ºå¯èƒ½ä»–å€‘çš„ç”Ÿæ´»é‡å¿ƒä¸åœ¨é¾èˆŸä¸Šï¼Œå°±çæƒœèƒ½å¤ ä¸€åŒç«¶æŠ€çš„ç·£åˆ†ã€‚&lt;/p>
&lt;p>é¾èˆŸæœ‰è¶£çš„åœ°æ–¹åœ¨æ–¼æ•´éš»éšŠä¼æ²’æœ‰è‹±é›„ï¼Œä¸åƒæ£’çƒæˆ–ç±ƒçƒï¼Œé›–èªªæ˜¯åœ˜éšŠç«¶è³½ä½†å­£å¾Œè³½é‚„æ˜¯æœƒéœ€è¦çƒæ˜Ÿçš„æŒºèº«è€Œå‡ºï¼›&lt;br>
ä½†é¾èˆŸå°±æ˜¯ä¸€æ¦®ä¿±æ¦®ï¼Œæ•´é½ŠåŠƒä¸€çš„æ§³æ³•èˆ‡å‡è¡¡çš„åŠ›é‡æ‰èƒ½è´å¾—æ¯”è³½ï¼Œè€Œä¸”ä¸€æ¹Šå°±è¦æ¹Šæ»¿10äººæˆ–æ˜¯20äººï¼Œç›¸å°ä¸å¤ªå®¹æ˜“ï¼Œä½†ä¹Ÿå› ç‚ºé€™æ¨£æ¯”è³½èµ·ä¾†å¾ˆç†±é¬§ï¼Œä¹Ÿå¾ˆéç™®ã€‚&lt;/p>
&lt;h3 id="å·¥å•†æ™‚é–“">å·¥å•†æ™‚é–“&lt;/h3>
&lt;p>æ–°åº—åŒå¿ƒæ•‘é›£éšŠé¾èˆŸéšŠæ­¡è¿å¤§å®¶çš„åŠ å…¥ï¼Œç›®å‰éƒ½æ˜¯ä¸‰æœˆä¸­æ—¬è¨“ç·´åˆ°ç«¯åˆç¯€ï¼Œå›ºå®šæ—©ä¸Š 5:20 ~ 6:30 æ–¼ç¢§æ½­ç·´ç¿’ï¼Œæœ‰èˆˆè¶£ç·´èº«é«”ç•¶é‹å‹•ï¼Œæˆ–æ˜¯æƒ³è¦äº«å—æ¯”è³½çš„äººéƒ½å¾ˆæ­¡è¿ï¼Œä¸éå°±æ˜å¹´è«‹æ—© XD&lt;br>
OS. è¨“ç·´å¼·åº¦å¦‚æœèº«é«”ä¸é©é‚„æ˜¯å¯ä»¥ä¼‘æ¯ï¼Œä¸ç”¨æ“”å¿ƒæœƒæ“åˆ°å—å‚·ï¼Œä½†å°±æ˜¯è¦è‡ªå·±è©•ä¼°è·Ÿè¡¡é‡ï¼›&lt;br>
éšŠä¸Šä¹Ÿæœ‰åˆ†è€æ‰‹æ‹¼æ¯”è³½ï¼Œäººæ•¸å¤ æ–°äººä¹Ÿæœƒæ¹Šä¸€è‰˜ç·´ç¿’&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>åˆæŒºéä¸€å¹´äº†ï¼Œä»Šå¹´éšŠä¸Šæ‹¿äº†ä¸å°‘åæ¬¡ï¼Œå¥³å­çµ„æˆç¸¾ä¾ç„¶äº®çœ¼ï¼Œå…¶ä»–çµ„åˆ¥ä¹Ÿç¨ç¨æœ‰æ‰€çªç ´äº†ã€‚&lt;/p>
&lt;p>åœ¨æ¯”è³½æœŸé–“å¾ˆæ„Ÿè¬æ‰€æœ‰çš„éšŠå“¡ï¼ŒåŒ…å«è¡Œæ”¿çš„å·¥ä½œäººå“¡èˆ‡è² è²¬é–‹è»Šæ¥é€çš„éšŠå‹ï¼Œé™¤äº†æ¯”è³½è¨“ç·´é‚„è¦å¹«å¿™å…¶ä»–é›œç‰©çœŸçš„å¾ˆè¾›è‹¦ï¼›&lt;br>
å¦å¤–é‚„æœ‰åˆ°å ´æ²’æœ‰ä¸Šå ´æ©Ÿæœƒçš„éšŠå‹ï¼Œæ„Ÿè¬å¤§å®¶çŠ§ç‰²é€£å‡ä¸€åŒåˆ°å ´å¹«å¿™åŠ æ²¹ï¼Œè¦æ’èµ·ä¸€éš»éšŠä¼éœ€è¦å¾ˆå¤šäººçš„åŠªåŠ›èˆ‡ä»˜å‡ºï¼Œæ„Ÿè¬å¤§å®¶ã€‚&lt;/p></description></item><item><title>é¾èˆŸèˆµæ‰‹ç ”ç¿’ç‡Ÿå¿ƒå¾—</title><link>https://yuanchieh.page/posts/2019/2019-05-25-%E9%BE%8D%E8%88%9F%E8%88%B5%E6%89%8B%E7%A0%94%E7%BF%92%E7%87%9F%E5%BF%83%E5%BE%97/</link><pubDate>Sat, 25 May 2019 03:13:32 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-05-25-%E9%BE%8D%E8%88%9F%E8%88%B5%E6%89%8B%E7%A0%94%E7%BF%92%E7%87%9F%E5%BF%83%E5%BE%97/</guid><description>&lt;p>åˆ’é¾èˆŸé‚å…¥æ§³æ‰‹äºŒå¹´ç´šç”Ÿï¼Œé«”èƒ½èˆ‡åˆ’æ§³ä¸Šæ…¢æ…¢å¯ä»¥è·Ÿä¸Šå¤§å®¶ï¼Œé›–ç„¶é‚„æœ‰å¾ˆå¤šéœ€è¦èª¿æ•´çš„ç´°ç¯€èˆ‡ç£¨ç·´ï¼Œæ¯æ¬¡ç·´ç¿’ä¹Ÿéƒ½æ˜¯ç´¯å¾—åŠæ­»ï¼Œä½†ç¢ºå¯¦æ¯”è¼ƒå¾—å¿ƒæ‡‰æ‰‹äº›ï¼Œæ…¢æ…¢äº«å—é¾èˆŸçš„æ¨‚è¶£ï¼›&lt;/p>
&lt;p>ä½†ä¸å¾—ä¸èªªä¸€é–‹å§‹ä»¥ç‚ºæ§³æ‰‹ï¼Œèº«ç‚ºèˆ¹ä¸Šçš„å‹•åŠ›è¼¸å‡ºæ˜¯æœ€ç´¯äººçš„ï¼Œå¹³å¸¸èˆµæ‰‹å¤§å“¥å€‘å²å®³åˆ°è®“æˆ‘åœ¨åˆ’æ§³æ™‚å®Œå…¨æ²’æ„Ÿå—åˆ°ä»–å€‘çš„å­˜åœ¨ï¼Œèª¤ä»¥ç‚ºèˆ¹æ¯”ä¾†å°±è©²ç›´ç›´çš„è·‘ï¼Œæ‰€ä»¥èˆµæ‰‹æ„Ÿè¦ºèµ·ä¾†å¾ˆè¼•é¬†ï¼Œä½†é€™ç¨®&lt;code>è§€å¿µéŒ¯å¾—é›¢è­œ!!&lt;/code>&lt;/p>
&lt;p>åŒ…å«ä¸Šèª²çš„è³‡æ·±æ•™ç·´ &lt;a class="link" href="https://www.facebook.com/profile.php?id=100003387052859" target="_blank" rel="noopener"
>é¦®å»ºå ‚æ•™ç·´&lt;/a>ä¹Ÿæåˆ°ï¼Œç¾åœ¨å¾ˆå¤šåƒè³½éšŠä¼çš„æ•™ç·´ä¹Ÿæœ‰äº›åå·®çš„è§€å¿µï¼Œéƒ½ä¸å¤ªé‡è¦–ï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•è¨“ç·´èˆµæ‰‹ï¼Œå°è‡´æ¯”è³½æ™‚é€£å‡ºç¢¼é ­ã€åˆ°æ¯”è³½å®šé»éƒ½æœ‰å•é¡Œï¼Œæ›´ç”šè€…ç¿»èˆ¹ã€æ“¦æ’ç­‰å®‰å…¨å±éšªï¼Œé€™ä¹Ÿæ˜¯å°åŒ—å¸‚é«”è‚²å±€è¦è¾¦èˆµæ‰‹ç ”ç¿’ç‡Ÿçš„åˆè¡·ã€‚&lt;/p>
&lt;p>å¾ˆæ„Ÿè¬å°åŒ—å¸‚é«”è‚²å±€èˆ‰è¾¦å’ŒéšŠä¸Šè®“æˆ‘æœ‰æ©ŸæœƒåƒåŠ èˆµæ‰‹ç ”ç¿’ç‡Ÿï¼Œå¾èˆµæ‰‹çš„è§’åº¦å­¸ç¿’ï¼Œå¾æ–°å°é¾èˆŸé€™é …é‹å‹•æœ‰ä¸åŒçš„èªçŸ¥èˆ‡é«”æœƒï¼Œä¹Ÿè®“æˆ‘æ›´åŠ å´‡æ‹œé»˜é»˜ä»˜å‡ºçš„èˆµæ‰‹å¤§å“¥äº†ï¼Œä»¥ä¸‹æ˜¯åƒåŠ  2019 å¹´åº¦çš„èˆµæ‰‹ç ”ç¿’ç‡Ÿçš„ç­†è¨˜ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__rce1CaAbmT2CrqE1B5Pyxg.jpeg"
loading="lazy"
alt="å‡ºè™•ï¼šé¦®å»ºå ‚æ•™ç·´çš„ FBÂ ç›¸ç°¿"
>
å‡ºè™•ï¼šé¦®å»ºå ‚æ•™ç·´çš„ FBÂ ç›¸ç°¿&lt;/p>
&lt;h3 id="èˆµæ‰‹çš„å·¥ä½œ">èˆµæ‰‹çš„å·¥ä½œ&lt;/h3>
&lt;p>èˆµæ‰‹ä¸»è¦æ“èˆµï¼Œåœ¨é¾å°¾æ§åˆ¶èˆ¹å‰é€²çš„æ–¹å‘ï¼Œèˆµåˆåˆ†æˆæ´»å‹•èˆµèˆ‡å›ºå®šèˆµï¼Œå›ºå®šèˆµåœ¨èˆ¹å°¾æœ‰å¤šä¸€å¡Šçµæ§‹è®“èˆµç©¿éï¼Œåœ¨èª¿æ•´æ–¹å‘æ™‚æœ‰å€‹æ”¯é»å¯ä»¥ç¨±ï¼›&lt;br>
è€Œæ´»å‹•èˆµå‰‡ç„¡ï¼Œå¿…é ˆé è‡ªèº«çš„åŠ›é‡æˆ–èˆ¹æ¿ç•¶ä½œæ”¯é»ã€‚&lt;/p>
&lt;p>åœ¨æœ‰äº›æ¯”è³½èˆµæ‰‹å¯ä»¥åŠ©åˆ’ï¼Œæ•™ç·´è¡¨ç¤ºèˆµæ‰‹åŠ©åˆ’å²å®³çš„å¯ä»¥æŠµä¸Š3ï½4 åæ§³æ‰‹ï¼Œååˆ†çš„é©šäººã€‚&lt;/p>
&lt;p>èˆµæ˜¯åˆ©ç”¨æ“‹æ°´çš„æ–¹å¼ï¼Œè®“èˆ¹å°¾å—åŠ›ï¼Œé€²è€Œæ”¹è®Šèˆ¹é‹è¡Œçš„æ–¹å‘ï¼Œç•¶èˆ¹å°¾å—åˆ°å¾€å·¦çš„åŠ›é‡ï¼Œèˆ¹é ­è‡ªç„¶å°±æœƒç›¸å°å¾€å³ï¼Œåä¹‹äº¦ç„¶ï¼›&lt;br>
å› ç‚ºä¸»è¦æ˜¯é€éæ°´çš„åä½œç”¨åŠ›ï¼Œæ‰€ä»¥èˆ¹åœ¨æœ‰å‹•åŠ›çš„æƒ…æ³ä¸‹æ‰èƒ½æ”¹è®Šæ–¹å‘ï¼Œæ‰€ä»¥åœ¨è½‰å½æ™‚ä¹Ÿæ˜¯è¦è«‹æ§³æ‰‹è¼•æ§³åˆ’ï¼›&lt;br>
å¦‚æœå†æ²’æœ‰å‹•åŠ›ä¸‹ï¼Œé èˆµæ‰‹ä¸€äººæŒ–æ°´æˆ–æ¨æ°´ï¼Œé‚£æœƒååˆ†çš„ç´¯è€Œä¸”æ²’æ•ˆç‡ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__5oJEAIh2b2B8C0FNIx8qFQ.jpeg"
loading="lazy"
alt="https://www.facebook.com/taipei2017/photos/pcb.1227131774129091/1227131447462457/?type=3&amp;theater"
>
&lt;a class="link" href="https://www.facebook.com/taipei2017/photos/pcb.1227131774129091/1227131447462457/?type=3&amp;amp;theater" target="_blank" rel="noopener"
>https://www.facebook.com/taipei2017/photos/pcb.1227131774129091/1227131447462457/?type=3&amp;amp;theater&lt;/a>&lt;/p>
&lt;p>ï¼ˆæ§³èˆ‡èˆµçš„å°æ¯”ï¼Œå‰›å¥½é€™ä½æ˜¯æˆ‘å¯¦éš›æ¼”ç·´çš„æŒ‡å°æ•™ç·´ï¼‰&lt;/p>
&lt;h3 id="åæ»‘-èˆ¹ç‚ºä»€éº¼ä¸æœƒä¹–ä¹–èµ°ç›´ç·š">åæ»‘-èˆ¹ç‚ºä»€éº¼ä¸æœƒä¹–ä¹–èµ°ç›´ç·š&lt;/h3>
&lt;p>åæ»‘åˆå¯åˆ†æˆäººåŠ›èˆ‡å¤©ç„¶å› ç´ &lt;/p>
&lt;p>äººåŠ›å› ç´ ä¸»è¦åƒæ˜¯æ§³æ‰‹å·¦å³é›™æ–¹çš„é«”åŠ›èˆ‡åˆ’æ§³åŠ›é‡ä¸å‡ï¼›&lt;br>
å¤©ç„¶å› ç´ çš„ç¨®é¡å°±å¾ˆå¤šï¼Œåƒæ˜¯é¢¨æµªã€æ½®æ±ã€æ°´åº•åœ°å½¢ç­‰éƒ½æœƒå—åˆ°å½±éŸ¿ã€‚&lt;/p>
&lt;p>åœ¨è¬›è§£çš„éç¨‹ä¸­ï¼Œæ•™ç·´æåˆ°æ°´æ˜¯æœ‰ç©ºé–“çš„ï¼Œç•¶æ§³æ‰‹æ’æ§³å…¥æ°´å¾€ä¸‹å¾€å¾Œæ¨æ™‚ï¼Œæ°´æœƒè¢«æ¨æ“ çš„ï¼Œä½†æ°´æ˜¯ä½”æ“šç©ºé–“çš„ï¼Œç•¶è§¸åº•æ™‚å°±æœƒå›å½ˆç”¢ç”Ÿæ¹§ï¼Œå¦‚æœæ°´æ·±ä¸å¤ å°±æœƒå‘ä¸Šæ¨æ“ ï¼Œå°è‡´èˆ¹çš„æ™ƒå‹•ï¼Œæœ‰ç¨®è¢«é»ä½çš„æ„Ÿè¦ºï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼åœ‹éš›è³½äº‹è¦å®š&lt;code>è³½é“æ°´æ·±ä¸€å®šè¦3ç±³æ·±ä»¥ä¸Š&lt;/code> ï¼›&lt;/p>
&lt;p>æ°´æµçš„éƒ¨åˆ†ï¼Œæ•™ç·´èˆ‰å¤§ä½³æ²³æ¿±å…¬åœ’ç‚ºä¾‹ï¼Œå¤§ä½³æ²³æ¿±å…¬åœ’ä½æ–¼åŸºéš†æ²³ä¸Šï¼Œæ°´æµæ˜¯å¾æ¾å±±å¾€åœ“å±±æ–¹å‘æµï¼Œå› ç‚ºæ²³é“å¤©ç„¶å½æ›²çš„ç·£æ•…ï¼Œæ°´æµåœ¨å¤–å´æœƒæ¯”è¼ƒæ¹æ€¥ï¼Œä¹Ÿå°±æ˜¯é è¿‘å¤§ç›´çš„æ–¹å‘ï¼Œæ‰€ä»¥3,4 æ°´é“çš„æ°´æµæœƒæ¯”è¼ƒå¿«ï¼Œèˆµæ‰‹å¦‚æœå¯ä»¥æ‰¾åˆ°é †æ°´æµçš„æ–¹å‘ï¼Œå°±å¯ä»¥è®“èˆ¹è·‘å¾—æ›´è¼•é¬†ï¼›&lt;br>
ä½†é™¤äº†æ°´æµå¤–ï¼Œæ½®æ±ä¹Ÿæœƒå½±éŸ¿ï¼Œå†æ¼²æ½®æ™‚å‰›å¥½èˆ‡æ°´æµæ–¹å‘ç›¸åï¼Œæœƒç”¢ç”Ÿå…©è‚¡åŠ›é‡çš„äº¤æœƒèˆ‡ç¢°æ’ï¼Œç¢ºåˆ‡çš„é»ä¸æ˜¯å¾ˆå›ºå®šï¼Œæ‰€ä»¥å°±å¾ˆé èˆµæ‰‹çš„ç¶“é©—ï¼Œæ•™ç·´è¡¨ç¤ºæœ‰äº›è³‡æ·±èˆµæ‰‹æ²’æœ‰æ³¨æ„ä¹Ÿæœƒæ ½åœ¨ä¸Šé ­ã€‚&lt;/p>
&lt;p>æ•™ç·´ä¹Ÿæœ‰æåˆ°å»é¦™æ¸¯æ¯”è³½ï¼Œåœ¨å‡ºæµ·å£é™„è¿‘æœƒæœ‰å´æµªï¼Œåˆæˆ–æ˜¯æœ‰çš„å ´åœ°æœƒæœ‰æ°´è‰ï¼Œæ¯”è¼ƒæ…˜çš„å°±æœƒè¢«æ°´è‰çµ†ä½å½±éŸ¿æˆç¸¾ï¼Œä¸åŒçš„æ¯”è³½å ´åœ°æœ‰ä¸åŒçš„æ°´æ–‡ï¼Œé€™éƒ½æ˜¯èˆµæ‰‹éœ€è¦ä»”ç´°å»ç ”ç©¶ï¼Œæ‰¾å‡ºè³½é“ä¸Šæœ€é©åˆçš„ä½ç½®ã€‚&lt;/p>
&lt;h3 id="å¯¦éš›ä¸‹æ°´">å¯¦éš›ä¸‹æ°´&lt;/h3>
&lt;p>è¨“ç·´æœŸé–“æœ‰ä¸‹æ°´ç·´ç¿’å…­æ¬¡ï¼Œæ¯æ¬¡æ¯äººå¤§æ¦‚ç·´10â€“15åˆ†é˜ï¼Œä¸€ä¸‹æ°´é€£èµ°ç›´ç·šéƒ½æ˜¯å€‹å›°é›£ï¼Œå¾Œä¾†æ¯”è¼ƒçŸ¥é“èªªè¦æŠŠèˆµæ’æ·±ï¼Œè®“èˆµå—åŠ›å»è®“èˆ¹æŠ“ç›´ï¼Œä¸Šæ‰‹è¦æ¡å¥½ä½†åˆè¦æœ‰é»æ”¾é¬†ï¼Œå»æ„Ÿå—æ°´æµçš„ä½œç”¨ï¼›ä¸‹æ‰‹æ‰£ç·Šèˆ¹ç‰ˆï¼Œè®“èˆµå¯ä»¥é åœ¨èˆ¹é‚Šï¼Œæ–¹ä¾¿ä½¿åŠ›ï¼›&lt;br>
ä¸€å€‹æ“æ§çš„é‡é»æ˜¯æå‰ä¿®æ­£ï¼Œç•¶ç™¼ç¾èˆ¹å¾®å¾®åå‘æ™‚ï¼Œå°±è¦é–‹å§‹ä¿®æ­£ï¼Œæ­¤æ™‚æœƒæ¯”è¼ƒè¼•é¬†ï¼Œä¹Ÿä¸æœƒæ“‹å¤ªå¤šæ°´æ‹–ç´¯èˆ¹é€Ÿï¼Œå¦‚æœç•¶çœŸçš„åç§»æ™‚ï¼Œè¦åœ¨ä¿®æ­£å°±éå¸¸çš„å›°é›£ï¼Œå°¤å…¶æ˜¯å› ç‚ºèˆ¹æœ‰æ…£æ€§ï¼Œæ²’æœ‰æ§åˆ¶å¥½å°±æœƒæš´èµ°ï¼Œåœ¨åŸåœ°æ‰“è½‰ï¼Œæˆ‘å°±æ‰“è½‰äº†å¹¾æ¬¡ï¼Œå› ç‚ºè½‰å½æ™‚ä¾†ä¸åŠä¿®æ­£ï¼›&lt;br>
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¥³æ€§èˆµæ‰‹ä¸è¦‹å¾—æœƒè¼¸ç”·æ€§èˆµæ‰‹ï¼Œæ°´æ„Ÿå¥½èƒ½å¤ æå‰ä¿®æ­£ï¼Œå…¶å¯¦ä¸éœ€è¦åˆ°éå¸¸å¤§çš„åŠ›é‡ï¼Œåè€Œæ˜¯ç¶“é©—èˆ‡è‡¨å ´åæ‡‰æ¯”è¼ƒé‡è¦ã€‚&lt;/p>
&lt;p>ä½†å¦‚æœæ²’æœ‰åŠæ™‚ä¿®æ­£ï¼Œæ•´è‰˜èˆ¹çš„åŠ›é‡ååˆ†å¯æ€•ï¼Œåœ¨å¤§è½‰å½æ™‚æˆ‘ç”¨å…¨èº«çš„åŠ›é‡æ‰æœ‰è¾¦æ³•å®šä½èˆ¹ï¼Œè½‰ä¸€å€‹å½10ç§’é˜å°±æ»¿èº«å¤§æ±—ï¼Œä¸‹æ‰‹æ‰£èˆ¹ç‰ˆçš„å¤§æ‹‡æŒ‡åˆ°ç¾åœ¨ä¸€é€±é‚„æœ‰é»é…¸ç·Šã€‚&lt;/p>
&lt;p>å¦å¤–å‰›å¥½åŸ¹è¨“é‚£å¹¾å¤©é¢¨æµªæ¯”è¼ƒå¤§ï¼Œæ‰€ä»¥åœ¨é€²å‡ºç¢¼é ­å°±ç›¸å°æ¯”è¼ƒå±éšªï¼Œå› ç‚ºèˆ¹åœ¨ä½é€Ÿå¾ˆå®¹æ˜“å—åˆ°è‡ªç„¶åæ»‘çš„å½±éŸ¿ï¼Œå‹•ä½œä¸å¤ ç²¾æº–å¾ˆå®¹æ˜“åˆè¢«æµªæ¨å›ç¢¼é ­å‡ºä¸ä¾†ï¼Œåˆæˆ–æ˜¯ç¬é–“è¢«æ‰“æ©«ç„¡æ³•æ“ä½œï¼Œä½†æ•™ç·´è¡¨ç¤ºå¾ˆæ…¶å¹¸åœ¨ç·´ç¿’æ™‚é‡åˆ°é¢¨æµªå¤§çš„ç‹€æ³ï¼Œæå‰ç·´ç¿’ç¸½æ¯”æ¯”è³½æ™‚æ‰‹å¿™è…³äº‚ä¾†çš„å¥½ã€‚&lt;/p>
&lt;h3 id="å…¶ä»–è¨Šæ¯">å…¶ä»–è¨Šæ¯&lt;/h3>
&lt;p>æ•™ç·´æœ‰åˆ†äº«ä¸€äº›é¾èˆŸçš„è³‡è¨Šå¾ˆæœ‰è¶£ï¼Œåƒæ˜¯ä»–æœ‰å¸¶éšŠåƒåŠ å†°ä¸Šé¾èˆŸ&lt;/p>
&lt;p>å¦å¤–é‚„æœ‰æµ·ä¸Šé¾èˆŸï¼Œä¹‹å¾Œé¾èˆŸæœ‰æ©Ÿæœƒåˆ—å…¥å¥§é‹çš„æ­£å¼é …ç›®ï¼Œååˆ†çš„æœŸå¾…ã€‚&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>èˆµèˆ¹çœŸçš„ä¸ç°¡å–®ï¼Œæ•´è‰˜èˆ¹çš„å‘½é‹èˆ‡æ–¹å‘å°±æ±ºå®šåœ¨èˆµæ‰‹ä¸­ï¼Œä¸å–®æ˜¯é«”èƒ½ä¸Šï¼Œæ›´æ˜¯å¿ƒéˆèˆ‡ç²¾ç¥ä¸Šçš„é›éŠã€‚&lt;/p></description></item><item><title>Route53 Latency-Based Routing æ©Ÿåˆ¶â€Šâ€”â€ŠDNS å¦‚ä½•è©•ä¼°å»¶é²</title><link>https://yuanchieh.page/posts/2019/2019-04-29-route53-latency-based-routing-%E6%A9%9F%E5%88%B6-dns-%E5%A6%82%E4%BD%95%E8%A9%95%E4%BC%B0%E5%BB%B6%E9%81%B2/</link><pubDate>Mon, 29 Apr 2019 00:18:14 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-04-29-route53-latency-based-routing-%E6%A9%9F%E5%88%B6-dns-%E5%A6%82%E4%BD%95%E8%A9%95%E4%BC%B0%E5%BB%B6%E9%81%B2/</guid><description>&lt;p>å‰é™£å­åšå…¨çƒä¸åŒåœ°å€ API Server çš„éƒ¨ç½²ï¼Œå¸Œæœ›ç”¨æˆ¶åŸºæ–¼å»¶é²æ€§é¸æ“‡æœ€é è¿‘çš„ API Serverï¼Œé€é &lt;a class="link" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-api-gateway.html" target="_blank" rel="noopener"
>Route53 + API Gateway&lt;/a> å¯¦ä½œéå¸¸ç°¡å–®ã€‚&lt;/p>
&lt;p>ä½†é‡æ¸¬å»¶é²æ€§ï¼Œç†è«–ä¸Šåªèƒ½ç”± Client å‘å¤šå€‹ Server ç™¼é€ï¼Œæœ€å¾Œè©•æ¯”æ•´æ®µ Http Request å®Œæˆçš„æ™‚é–“ï¼›&lt;br>
Route53 èº«ç‚º DNS Serverï¼Œå¦‚æœæ˜¯å¾ DNS Server å»æ‰“ Serverï¼Œé‚£é‡æ¸¬çš„çµæœæ‡‰ç•¶æ˜¯ Route53 åˆ° Server çš„å»¶é²ï¼Œè€Œä¸èƒ½ä»£è¡¨ Client åˆ° Serverï¼›&lt;/p>
&lt;p>å¥½æ¯”èªª User åœ¨å°ç£ï¼ŒRoute53 Server åœ¨ç¾åœ‹ï¼ŒServer1 åœ¨ç¾è¥¿ï¼ŒServer2 åœ¨æ±äº¬ï¼Œé‚£å¾ Route53 è§’åº¦ä¸€å®šæ˜¯ç¾è¥¿çš„ Server1 æ¯”è¼ƒè¿‘ï¼Œä½†å° User ä¾†èªªæœƒæ˜¯æ—¥æœ¬çš„ Server2 æ¯”è¼ƒè¿‘æ‰æ˜¯ï¼›&lt;br>
åˆå¦‚æœèªª Route53 æ˜¯å…¨çƒéƒ¨ç½²ï¼Œé‚£Route53 åˆå¦‚ä½•æ±ºå®š User è¦é€£åˆ°å“ªå€‹åœ°å€çš„ DNS ServerÂ ?Â &lt;br>
åˆä¾‹å¦‚èªª CDNï¼ŒåŒæ¨£æœƒé‡åˆ°è¦å»å“ªå€‹ Local CDN Server æ¯”è¼ƒå¿«çš„å•é¡Œï¼Ÿ&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç ”ç©¶é€™å€‹å•é¡Œçš„éç¨‹ã€‚&lt;/p>
&lt;h3 id="how-amazon-route-53-uses-edns0-to-estimate-the-location-of-auser">How Amazon Route 53 Uses EDNS0 to Estimate the Location of aÂ User&lt;/h3>
&lt;p>åƒè€ƒ&lt;a class="link" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy.html#routing-policy-edns0" target="_blank" rel="noopener"
>å®˜æ–¹æ–‡ä»¶&lt;/a>ï¼ŒRoute53 æ”¯æ´ DNS protocol é¡å¤–æ“´å…… EDNS0 ä¸­çš„edns-client-subnetã€‚&lt;/p>
&lt;p>DNS æŠ€è¡“ç™¼å±•æ–¼ 1980 å¹´ä»£ï¼Œç•¶æ™‚ protocol è¨­è¨ˆåªæœ‰ç•™ 512 bytes å¯ä»¥å¤¾å¸¶è³‡è¨Šï¼Œä½†éš¨è‘—æ™‚é–“æ¼”é€²ï¼Œäººå€‘å¸Œæœ›åŠ å…¥æ›´å¤šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚èªªæ›´å¤šçš„ IPv6ã€[DNSSEC](&lt;a class="link" href="https://medium.com" target="_blank" rel="noopener"
>https://medium.com&lt;/a>&lt;/p>
&lt;p>&lt;strong>edns-client-subnet&lt;/strong> ä¸»è¦æ˜¯è®“ client å†ç™¼èµ· DNS resolve æ™‚å¯ä»¥åœ¨ query ä¸­å¤¾å¸¶è‡ªå·± IP çš„ subnetï¼Œè®“ DNS Server å¯ä»¥çŸ¥é“ client ç¢ºåˆ‡çš„ IP ä¾†æºè€Œä¸æœƒå† Recursive è§£æéç¨‹ä¸­è¢«ç½®æ›ï¼Œæ›´è©³ç´°è§£é‡‹æ–¼ä¸‹ä¸€ç¯€ï¼›&lt;br>
å¦‚æœ client ä¸æ”¯æ´ edns-client-subnetï¼Œå‰‡ Route53 æœƒæ‹¿ IPç•¶ä½œä¾†æºä½ç½®åˆ¤æ–·ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Route53 æ˜¯é€é IP åˆ¤æ–·ç”¨æˆ¶çš„ä½ç½®ï¼Œä¸¦ç”¨æ­¤ä½ç½®ç•¶ä½œé‡æ¸¬çš„åŸºæº–ï¼ŒGeolocation / Latency based éƒ½æ˜¯å¦‚æ­¤ï¼›&lt;br>
è€Œ IP ä½ç½®ä¾†æºå„ªå…ˆä½¿ç”¨ edns-client-subnetï¼Œå…¶æ¬¡ç”¨ source IPã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="edns-client-subnet-ecs">edns-client-subnet (ECS)&lt;/h3>
&lt;p>æ‘˜è¦ä¸€äº› RFC å…§å®¹&lt;/p>
&lt;p>&lt;a class="link" href="https://tools.ietf.org/html/rfc7871" target="_blank" rel="noopener"
>&lt;strong>RFC 7871 - Client Subnet in DNS Queries&lt;/strong>&lt;/a>&lt;/p>
&lt;p>DNS æŸ¥è©¢çš„æ–¹å¼æ˜¯ä¸€å±¤ä¸€å±¤çš„ï¼Œå¾æœ€é ‚ç´šçš„åŸŸåä¸€è·¯å‘ä¸‹ï¼Œä¾‹å¦‚èªª hello.example.comï¼Œå°±æœƒå¾Â .com Nameserver â†’ example.com Nameserver é€æ­¥æŸ¥è©¢ã€‚&lt;/p>
&lt;p>Client æœƒé€é Stub Resolver (å¯ç†è§£ä¸€å€‹ DNS Agent)ï¼Œé€é Intermediate Nameserver å‘ Authoritative Nameserver (æ¡æœ‰ DNS zones åŸŸåå€åŸŸ) ç™¼èµ·è«‹æ±‚ã€‚&lt;/p>
&lt;p>å…¶ä¸­ Intermediate Nameserver æœ‰å…©ç¨®ï¼š&lt;/p>
&lt;ol>
&lt;li>Forwarding Resolverï¼šä¸æœƒéè¿´è§£æï¼Œåƒ…æœƒå‚³éçµ¦ä¸‹ä¸€å€‹ Recursive Resolverã€‚&lt;/li>
&lt;li>Recursive Resolverï¼šéè¿´ domain chain ç›´åˆ°åŸŸåè§£æå®Œæˆï¼Œæœƒé€é cache å¿«é€Ÿè¿”å›æŸ¥è©¢ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç›®å‰ä¾†èªªï¼ŒRecursive Resolver ä½¿ç”¨æ—¥ç›Šå¢åŠ ï¼Œå› ç‚ºé›†ä¸­åŒ–ç®¡ç†æœ‰å¹¾å€‹å„ªé» &lt;code>cache æ›´å¤šè³‡è¨Š&lt;/code> ã€&lt;code>å¯©æŸ¥ç”¨æˆ¶çš„ DNSæŸ¥è©¢&lt;/code> ï¼Œä½†æ˜¯å‚³çµ±çš„ Recursive Resolver åœ¨éè¿´æŸ¥è©¢æ™‚ï¼Œæœƒå°‡ Source IP æ”¹æˆè‡ªå·±çš„ IPè€Œä¸æ˜¯ Client çš„ IPï¼Œä½† Recursive Resolver è·Ÿ Client å¯èƒ½éš”å¾ˆé (ç¶²è·¯æ‹“å¢£ä¸Šçš„è·é›¢)ï¼›&lt;br>
å¦‚æœæ­¤æ™‚ Authoritative Nameserver å¸Œæœ›è§£æ Client IP æä¾›é‡èº«å®šåšçš„ DNS Answer (Tailored Response)ï¼Œå°±æ²’æœ‰è¾¦æ³•ï¼Œå› æ­¤åˆ¶å®š edns-subset-client è§£æ±ºæ­¤å•é¡Œã€‚&lt;/p>
&lt;h4 id="option-format">Option Format&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">+0 (MSB) +1 (LSB)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +---+---+---+---+---+---+---+---+---+---+---+---+---+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0: | OPTION-CODE |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +---+---+---+---+---+---+---+---+---+---+---+---+---+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2: | OPTION-LENGTH |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +---+---+---+---+---+---+---+---+---+---+---+---+---+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4: | FAMILY |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +---+---+---+---+---+---+---+---+---+---+---+---+---+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6: | SOURCE PREFIX-LENGTH | SCOPE PREFIX-LENGTH |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +---+---+---+---+---+---+---+---+---+---+---+---+---+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8: | ADDRESS... |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +---+---+---+---+---+---+---+---+---+---+---+---+---+
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>edns-subset-client protocol æ˜¯åŸºæ–¼ &lt;a class="link" href="https://tools.ietf.org/html/rfc6891" target="_blank" rel="noopener"
>EDNS0&lt;/a> åˆ¶å®šï¼Œä»¥ä¸‹æ˜¯ä»–çš„ package å…§å®¹ï¼š&lt;/p>
&lt;ol>
&lt;li>OPTION-CODE&lt;br>
å…©å€‹å…«ä½å…ƒçµ„ï¼Œå›ºå®šæ˜¯ &lt;code>0x00 0x08&lt;/code>&lt;/li>
&lt;li>OPTION-LENGTH&lt;br>
å…©å€‹å…«ä½å…ƒçµ„ï¼Œä»£è¡¨ payload é•·åº¦&lt;/li>
&lt;li>FAMILY&lt;br>
å…©å€‹å…«ä½å…ƒçµ„ï¼Œä»£è¡¨ address çš„ family (IANAæ¨™æº–)ï¼Œç›®å‰æ”¯æ´ IPv4è·Ÿ IPv6&lt;/li>
&lt;li>SOURCE PREFIX-LENGTH&lt;br>
Address é®ç½©ï¼ŒClient ç”¨ä¾†æŒ‡å®šæŸ¥è©¢çš„ IP é®ç½©&lt;/li>
&lt;li>SCOPE PREFIX-LENGTH&lt;br>
åŒæ¨£æ˜¯ Address é®ç½©ï¼Œä½†æ˜¯æ˜¯ç”± Response è¡¨ç¤º Address è¦†è“‹ç¯„åœã€‚&lt;/li>
&lt;/ol>
&lt;p>SOURCE PREFIX-LENGTH è·Ÿ SCOPE PREFIX-LENGTH é€™å…©å€‹åƒæ•¸ç›¸å°æ¯”è¼ƒé‡è¦&lt;/p>
&lt;ol>
&lt;li>ç•¶ Client æˆ– Stub Resolver ç™¼èµ· name resolve æ™‚ï¼ŒæœƒæŒ‡å®š &lt;code>Address&lt;/code> èˆ‡ &lt;code>SOURCE PREFIX-LENGTH&lt;/code>ï¼Œ&lt;code>SOURCE PREFIX-LENGTH&lt;/code> ç®—æ˜¯å¸Œæœ›&lt;code>ä¿ç•™ Client IP éƒ¨åˆ†éš±ç§ï¼Œä¸è¦‹å¾—è¦å…¨éƒ¨éƒ½é€å¾€ Nameserver&lt;/code>ï¼›&lt;br>
ä½† &lt;code>SCOPE PREFIX-LENGTH&lt;/code> å¿…é ˆè¨­ç‚º 0 å› ç‚ºé€™æ˜¯ç”¨åœ¨ Response ä¸Š&lt;/li>
&lt;li>ç•¶ Recursive Resolver æ”¶åˆ°æ™‚ï¼Œæœƒé€ &lt;code>SOURCE PREFIX-LENGTH&lt;/code> é®ç½©æŸ¥è©¢ Cacheï¼Œå¦‚æœæœ‰å‰‡è¿”å›ï¼›æ²’æœ‰å‰‡ç¹¼çºŒæŸ¥è©¢ï¼Œæ­¤æ™‚éè¿´æŸ¥è©¢çš„ &lt;code>SOURCE PREFIX-LENGTH&lt;/code> åƒ…å¯å°æ–¼ç­‰æ–¼ä¾†æºæŸ¥è©¢çš„ &lt;code>SOURCE PREFIX-LENGTH&lt;/code>&lt;/li>
&lt;li>Authoritative Nameserver å¦‚æœå›å‚³çš„ &lt;code>SCOPE PREFIX-LENGTH&lt;/code> å°æ–¼ &lt;code>SOURCE PREFIX-LENGTH&lt;/code>ï¼Œä»£è¡¨ä¸éœ€ç”¨æä¾›é€™éº¼å¤š bitsï¼›&lt;br>
åä¹‹ &lt;code>SCOPE PREFIX-LENGTH&lt;/code> &amp;gt; &lt;code>SOURCE PREFIX-LENGTH&lt;/code>ï¼Œå‰‡ä»£è¡¨éœ€è¦æä¾›æ›´å¤šå¾— bits æ‰èƒ½å¾—åˆ°æ›´ç²¾æº–çš„ Answerã€‚&lt;/li>
&lt;li>Authoritative Nameserver è™•ç† Cache æ™‚è¦å¤šåŠ æ³¨æ„ï¼Œä¸å¯ä»¥æœ‰ Prefix overlapping ï¼Œé¿å…åŒ¹é…åˆ°çŸ­çš„ prefix å›å‚³éŒ¯èª¤çš„ RRsetsï¼›&lt;br>
ä¾‹å¦‚èªªåŸæœ¬çš„ cache æ˜¯ 1.2.0/20 Aï¼Œä½†æ­¤æ™‚å¤šåŠ äº† 1.2.3/24 Bï¼Œå°±éœ€è¦æ‹†æˆ 1.2.0/23, 1.2.2/24, 1.2.4/22, 1.2.8/21 Aï¼Œ1.2.3/24 Bï¼Œé¿å…ç–Šåˆã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="è³‡å®‰é¢¨éšª">è³‡å®‰é¢¨éšª&lt;/h4>
&lt;ol>
&lt;li>ç”Ÿæ—¥æ”»æ“Š&lt;br>
å¦‚æœé§­å®¢å‘ Intermediate Nameserver ç™¼é€å¤§é‡çš„å‡ DNS Answerï¼Œå¦‚æœä¸å°å¿ƒè¢«å»åˆåˆ°ï¼ŒIntermediate Nameserver å°±æœƒå›å‚³è¢«é‡£é­šçš„IPï¼Œé€™å€‹å•é¡Œåœ¨åŸæœ¬çš„ DNS å°±æœƒå‡ºç¾ã€‚&lt;br>
Â â†’ Intermediate Nameserver å¿…é ˆå° DNS Answer åšæ¬„ä½æª¢æŸ¥ï¼Œæœ€å¥½æ”¯æ´ DNSSEC æ¸›è¼•å•é¡Œç™¼ç”Ÿæ©Ÿç‡&lt;/li>
&lt;li>Cache æ±¡æŸ“&lt;br>
æ”¯æ´ ECS å¾Œï¼ŒCache æ©Ÿåˆ¶è®Šå¾—æ›´åŠ è¤‡é›œï¼Œæœƒéœ€è¦åŸºæ–¼ FAMILY / SCOPE PREFIX-LENGTH / ADDRESS Cacheï¼Œé€ æˆ Memory ç”¨é‡å¤§å¢ï¼›&lt;br>
å¦‚æœé§­å®¢é‹ç”¨é€™ä¸€é»ï¼Œç”¨æ´ªæ°´æ”»æ“Šè£½é€ å¤§é‡ä¸å®¹æ˜“å‘½ä¸­ Cache çš„æŸ¥è©¢ï¼Œå° DNS Nameserver åš DDos æ”»æ“Šã€‚&lt;br>
Â â†’ Nameserver å¿…é ˆè‡ªè¡Œåšå¥½è©•ä¼°&lt;/li>
&lt;/ol>
&lt;h4 id="ç¤ºç¯„æ¡ˆä¾‹">ç¤ºç¯„æ¡ˆä¾‹&lt;/h4>
&lt;p>Spec ä¸­æœ‰å€‹ç¤ºç¯„æ¡ˆä¾‹&lt;/p>
&lt;p>1. Stub Resolver (SR)ï¼ŒIPä½ç½®æ˜¯ 2001:0db8:fd13:4231:2112:8a2e:c37b:7334ï¼Œæº–å‚™é€é Recursive Resolver (RNS) æŸ¥è©¢ &lt;a class="link" href="http://www.example.com" target="_blank" rel="noopener"
>www.example.com&lt;/a>&lt;/p>
&lt;p>2. RNS æ”¯æ´ ECSï¼ŒæŸ¥è©¢ &lt;a class="link" href="http://www.example.com" target="_blank" rel="noopener"
>www.example.com&lt;/a> æ˜¯å¦åœ¨ cacheä¸­ï¼Œæ²’æœ‰å‰‡é–‹å§‹æŸ¥è©¢&lt;/p>
&lt;p>3. RNS å‘ root Nameserver .com æŸ¥è©¢ï¼Œå‘ root Nameserver æŸ¥è©¢ä¸éœ€è¦å¤¾å¸¶ ECS é¸é …&lt;/p>
&lt;p>4. æ¥è‘— RNS æº–å‚™å»æ‰¾ .example.com Authoritative Nameserver (ANS)&lt;/p>
&lt;p>5. RNS è¦å‚³éçš„å°åŒ…ï¼Œå¿…é ˆåŠ å…¥ ECS é¸é …&lt;/p>
&lt;ul>
&lt;li>OPTION-CODE: 8&lt;/li>
&lt;li>OPTION-LENGTH: 0x0bï¼Œå›ºå®š 4 bytes + 7 bytes çš„ Address&lt;/li>
&lt;li>FAMILY: 0x00 0x02ï¼Œä»£è¡¨ IPv6&lt;/li>
&lt;li>SOURCE PREFIX-LENGTH: 0x38ï¼Œé®ç½©ä»£è¡¨ /56 bits&lt;/li>
&lt;li>SCOPE PREFIX-LENGTH: 0x00ï¼Œé€™æ˜¯ Answer ç”¨çš„&lt;/li>
&lt;li>ADDRESS: 0x20 0x01 0x0d 0xb8 0xfd 0x13 0x42ï¼Œä¹Ÿå°±æ˜¯å‰ 56 bits&lt;/li>
&lt;/ul>
&lt;p>6. ANS æ”¶åˆ°å¾Œï¼Œç”¢ç”Ÿçµæœ(Tailored Response)å›å‚³ï¼Œå…¶é¤˜å…§å®¹ç›¸åŒ&lt;/p>
&lt;ul>
&lt;li>SCOPE PREFIX-LENGTH: 0x30, ä»£è¡¨ /48&lt;/li>
&lt;/ul>
&lt;p>7. RNS æ”¶åˆ°å¾Œï¼Œæ¯”å° FAMILY, SOURCE PREFIX-LENGTH å’ŒADDRESSï¼Œå¦‚æœä¸å»åˆå‰‡æ‹‹æ£„&lt;/p>
&lt;p>8. RNS åŸºæ–¼ ADDRESS, SCOPE PREFIX-LENGTH å’Œ FAMILY åš cache&lt;/p>
&lt;p>9. RNS å›å‚³çµæœçµ¦ SRï¼Œæ­¤æ™‚ä¸éœ€è¦ ECS é¸é …&lt;/p>
&lt;h3 id="é€é-digæª¢é©—">é€é digÂ æª¢é©—&lt;/h3>
&lt;p>dig æ”¯æ´ edns-client-subnet åƒæ•¸ï¼Œè—‰æ­¤è§€å¯Ÿ dns å›å‚³çš„ A recordï¼ŒæŒ‡ä»¤ç‚º &lt;code>dig [@8](http://twitter.com/8 &amp;quot;Twitter profile for @8&amp;quot;).8.8.8 {æ¸¬è©¦ domain name} +subnet={æ¸¬è©¦çš„ ip}&lt;/code> ï¼Œç¶²è·¯ä¸Šå¾ˆå¤šè³‡æ–™æ˜¯ä½¿ç”¨ &lt;code>+client={æ¸¬è©¦ ip}&lt;/code> ï¼Œæˆ‘å¯¦æ¸¬æ˜¯ç”¨ &lt;code>+subnet&lt;/code> æ‰å¯ä»¥ã€‚&lt;/p>
&lt;p>å‰é¢æåˆ°çš„ &lt;code>SCOPE PREFIX-LENGTH&lt;/code> ï¼ŒRoute53 å›å‚³ 24ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šæä¾› 24 bits çš„ Address å°±å¯ä»¥å–å¾—æœ€ä½³è§£ã€‚&lt;/p>
&lt;p>æ¸¬è©¦çš„ domain æ˜¯å…¬å¸å…§éƒ¨é€é Route53 èˆ‡ API Gateway æ¶è¨­ï¼Œä¸æ–¹ä¾¿å…¬é–‹ï¼Œä½†é€é VPN å–å¾—ä¸åŒå€åŸŸçš„ ipï¼Œä¾‹å¦‚æ—¥æœ¬ã€å°åº¦ã€åŠ æ‹¿å¤§ã€é˜¿æ ¹å»·ç­‰åœ°ï¼Œæ”¾å…¥ subnet åƒæ•¸å¾Œï¼ŒDNS å›å‚³çš„ ANSWER ç¢ºå¯¦è·Ÿè‘—åœ°å€è€Œæ”¹å‹•ï¼›&lt;br>
æœ‰é»å¼”è©­çš„æ˜¯å·´è¥¿ä¸èµ°åœ‹å…§åè€Œæ˜¯åˆ°æ³•åœ‹ Frankfurtçš„ä¼ºæœå™¨ï¼Œè€Œé˜¿æ ¹å»·æ˜¯åˆ°å·´è¥¿ SÃ£o Pauloçš„ä¼ºæœå™¨ï¼›&lt;br>
GeoIP æŸ¥è©¢é€é &lt;a class="link" href="https://www.maxmind.com/en/geoip-demo" target="_blank" rel="noopener"
>Maxmind&lt;/a>ï¼Œä»–æœ‰æ¯æ—¥æŸ¥è©¢ä¸Šç·šï¼Œæ˜¯ç¶å®š IPé™åˆ¶ã€‚&lt;/p></description></item><item><title>Http persistent connection ç ”ç©¶èˆ‡ proxyâ€Šâ€”â€Šserver keep-alive timeout ä¸ä¸€è‡´çš„ 502 éŒ¯èª¤</title><link>https://yuanchieh.page/posts/2019/2019-04-08-http-persistent-connection-%E7%A0%94%E7%A9%B6%E8%88%87-proxy-server-keep-alive-timeout-%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84-502-%E9%8C%AF%E8%AA%A4/</link><pubDate>Mon, 08 Apr 2019 23:46:01 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-04-08-http-persistent-connection-%E7%A0%94%E7%A9%B6%E8%88%87-proxy-server-keep-alive-timeout-%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84-502-%E9%8C%AF%E8%AA%A4/</guid><description>&lt;p>æ¶æ§‹ä¸Šä½¿ç”¨ elb ç•¶ä½œ load balancer proxyï¼Œå¾Œç«¯æ¥ nodejs api serverï¼Œä½†æ˜¯å¶çˆ¾æ‹‹å‡º 502 éŒ¯èª¤ï¼Œelb log é¡¯ç¤ºè©²æ¬¡é€£ç·šæ²’æœ‰é€²åˆ° api serverï¼Œéº»ç…©çš„æ˜¯æ©Ÿå™¨ health check æ­£å¸¸ï¼Œçµ•å¤§å¤šæ•¸çš„ api æ¸¬è©¦ä¹Ÿéƒ½æ­£ç¢ºï¼ŒéŒ¯èª¤ä¸å¤ªå¥½å¾©ç¾ï¼Œç›´åˆ°å¾Œä¾†æ‰ç™¼ç¾æ˜¯ proxy èˆ‡ api server åœ¨ persistent connection çš„ time-out æ©Ÿåˆ¶æœ‰æ‰€ä¸åŒã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç ”ç©¶ http 1.0 / 1.1 keep-alive / persistent connection æ©Ÿåˆ¶ï¼Œä¸¦é‡æ–°å¾©ç¾èˆ‡è§£æ±ºå•é¡Œã€‚&lt;/p>
&lt;h3 id="persistent-connection-ç°¡ä»‹">persistent connection ç°¡ä»‹&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__TCGmEtiKtghxQ6yG28J2Sg.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;a class="link" href="https://en.wikipedia.org/wiki/HTTP_persistent_connection#/media/File:HTTP_persistent_connection.svg" target="_blank" rel="noopener"
>https://en.wikipedia.org/wiki/HTTP_persistent_connection#/media/File:HTTP_persistent_connection.svg&lt;/a>&lt;/p>
&lt;p>åƒè€ƒè‡ª&lt;a class="link" href="https://en.wikipedia.org/wiki/HTTP_persistent_connection" target="_blank" rel="noopener"
>ç¶­åŸºç™¾ç§‘&lt;/a>ï¼Œpersistent connection ä¸»è¦æ˜¯å¸Œæœ›åœ¨çŸ­æ™‚é–“å…§æœ‰å¤šå€‹ http request æ™‚ï¼Œå¯ä»¥é‡æ–°åˆ©ç”¨ tcp connectionï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡æ–°å»ºç«‹ tcpé€£ç·šï¼Œé™ä½ tcp handshaking æ™‚é–“ç­‰é–‹éŠ·ã€‚&lt;/p>
&lt;p>åœ¨ &lt;strong>http 1.0&lt;/strong> ä¸¦æ²’æœ‰æ­£å¼æ”¯æ´ä¸”é»˜èªé—œé–‰ï¼Œä½†æ˜¯è »å¤§å¤šæ•¸çš„ http agent éƒ½æœ‰æ”¯æ´ï¼Œåœ¨ header è¨»æ˜ &lt;code>Connection: keep-alive&lt;/code> ï¼Œå¦‚æœ server ä¹Ÿæ”¯æ´æœƒæŠŠ header Connection å†æ¬¡å›å‚³ï¼›&lt;br>
ç›´åˆ° client æˆ– server æ±ºå®šæ–·ç·šæ‰æœƒç™¼é€ &lt;code>Connection: close&lt;/code> æ–·é–‹é€£ç·šã€‚&lt;/p>
&lt;p>åœ¨ &lt;strong>http 1.1&lt;/strong> é»˜èªé–‹å•Ÿï¼Œå¦‚æœé—œé–‰ persistent connection å‰‡å¿…é ˆä¸»å‹•åœ¨ http request å¤¾å¸¶ &lt;code>Connection: close&lt;/code> ã€‚&lt;/p>
&lt;p>åœ¨ reverse proxy ä¸­æˆ–æ˜¯ application server éƒ½å¯ä»¥è¨­ç½® keep-alive timeoutï¼Œæ±ºå®š server åœ¨é–’ç½®å¤šå°‘ç§’æ•¸å¾Œæ²’æœ‰æ”¶åˆ°æ–°çš„ http request å°±ä¸»å‹•æ–·é–‹é€£ç·šï¼Œä»¥ä¸‹é€é wireshark å¯¦éš›è§€å¯Ÿ persistent connectionã€‚&lt;/p>
&lt;p>server.js çš„ç¨‹å¼ç¢¼å¾ˆç°¡å–®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createServer&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">end&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3000&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="http-10--client--server">http 1.0 ï¼š client â† â†’Â server&lt;/h3>
&lt;p>å¦‚æœç›´æ¥ä½¿ç”¨ nodejs http moduleæˆ–æ˜¯å…¶ä»–äºŒæ¬¡é–‹ç™¼çš„æ¨¡çµ„ï¼Œé è¨­æ˜¯æ¡ç”¨ http 1.1 ä¸”ä¸èƒ½ä¿®æ”¹ï¼Œæ­¤æ™‚å¿…é ˆä½¿ç”¨æ›´åº•å±¤çš„ net æ¨¡çµ„ç™¼é€ http 1.0 request&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1____VxpaLipngwfWOh74Ye__CA.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>Server å¾ˆæ˜ç¢ºçŸ¥é“æ­¤æ¬¡ connection æ²’æœ‰è¦å¾©ç”¨æ‰€ä»¥å°±å¯ä»¥ç›´æ¥æ–·é–‹é€£çµã€‚&lt;/p>
&lt;h3 id="http-11-client--server">http 1.1: client â† â†’Â server&lt;/h3>
&lt;p>http 1.1 request é è¨­æœƒä½¿ç”¨ persistent connectionï¼Œç¨‹å¼ç¢¼æŠŠä¸Šé¢çš„ &lt;code>Http/1.0&lt;/code> æ”¹æˆ &lt;code>Http/1.1&lt;/code> å³å¯ï¼Œè§€å¯Ÿ wireshark server çš„å›æ‡‰å°±æœ‰æ‰€ä¸åŒ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__4g8eFUFSBgKKQZjqSVsBkA.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>è§€å¯Ÿåˆ° http 1.1 é è¨­æ”¯æ´ persistent connectionï¼Œæ‰€ä»¥ server æœƒç­‰åˆ° keep-alive timeout (nodejs 8.0 å¾Œé è¨­ 5ç§’)æ‰æœƒæ–·é–‹é€£çµï¼Œå¾å°åŒ…é¡¯ç¤ºæ˜¯ç”± client æ–·é–‹é€£çµã€‚&lt;/p>
&lt;p>ç‚ºä»€éº¼ client æœƒä¸»å‹•é—œé–‰è€Œæ²’æœ‰èµ° persistent connection å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="http-11-keep-alive">http 1.1: keep-alive&lt;/h3>
&lt;p>åœ¨ nodejsä¸­ï¼Œhttp request å¦‚æœè¦ä½¿ç”¨ keep-aliveï¼Œ&lt;code>å¿…é ˆé€é http agent ç™¼é€&lt;/code>ï¼Œhttp agent æœƒç”Ÿæˆ socket pool ä¸¦æ§åˆ¶ socket çš„å¾©ç”¨èˆ‡é—œé–‰æ™‚æ©Ÿï¼›&lt;br>
å¦‚æœä¸ä½¿ç”¨ http agentï¼Œå³ä½¿ header æˆ–é è¨­æ”¯æ´ keep-aliveï¼Œæ¯å€‹ request çµæŸå¾Œclientéƒ½æœƒä¸»å‹•ç™¼é€ [FIN,ACK] æ–·é–‹é€£çµã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__HPu__O06NHGGpqpfwTg__pYg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>è§€å¯Ÿåˆ° tcp å°‘äº†ä¸€æ¬¡å®Œæ•´çš„äº¤æ¡ (å»ºç«‹èˆ‡çµæŸ)ï¼Œçœäº† 9 å€‹ tcp packets ä¾†å›çš„æ™‚é–“ã€‚&lt;/p>
&lt;h3 id="http-11-keep-alive-timeout">http 1.1: keep-alive timeout&lt;/h3>
&lt;p>é è¨­ server æ˜¯äº”ç§’ï¼Œé‚£å¦‚æœ client ç¬¬äºŒå€‹ request è¶…éäº”ç§’ç™¼é€æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__FcolIW8__fD4jCIwMu6oWyw.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>æ ¹æ“šè§€å¯Ÿçµæœï¼Œåœ¨ç¬¬ä¸€å€‹ request å®Œæˆå¾Œï¼Œæ¯éš”ä¸€ç§’(ç§’æ•¸å¯èª¿æ•´)æœƒå¾ client ç™¼é€ &lt;a class="link" href="http://www.tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/#whatis" target="_blank" rel="noopener"
>[ TCP Keep-Alive ]&lt;/a> å°åŒ…ï¼Œäº”ç§’åˆ° server ä¸»å‹•æ–·é–‹é€£ç·šï¼›&lt;br>
ä¸‹ä¸€å€‹ http request å°±å¿…é ˆé‡æ–°å»ºç«‹ tcp é€£ç·šã€‚&lt;/p>
&lt;blockquote>
&lt;p>å°çµï¼š&lt;br>
æ²’æœ‰èµ° persistent connectionï¼Œé€šå¸¸æ˜¯ç”± server close connectionï¼Œå› ç‚º server æ±ºå®š response çš„é•·åº¦ï¼›&lt;br>
ä½†æ˜¯ persistent connection ä¸‹ï¼Œå¯èƒ½ç”± client æˆ– server ä»»ä¸€è€… close connectionï¼Œä¸éæ–°çš„ request é‚„æ˜¯ç”± client ç™¼èµ·ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç¾åœ¨åŠ å…¥ Nginx Reverse Proxyï¼Œæ¨¡æ“¬å¹¾ç¨®æƒ…æ³&lt;/p>
&lt;h3 id="nginx-proxyä¸ä½¿ç”¨-keepalive">Nginx Proxyâ€Šâ€”â€Šä¸ä½¿ç”¨ KeepAlive&lt;/h3>
&lt;p>å¾æœ€åŸºæœ¬çš„è¨­å®šæª”é–‹å§‹ï¼Œæœ€å–®ç´”è½‰ç™¼çš„å‹•ä½œ&lt;/p>
&lt;p>æ¥è‘—ç”¨ docker åŸ·è¡Œ&lt;/p>
&lt;p>docker run -v /Users/zhengyuanjie/Desktop/Nodejs/persistent-connection/ka_nginx.conf:/etc/nginx/nginx.conf -it -p 8080:80 nginx&lt;/p>
&lt;p>ç›®å‰åˆ†æˆå…©æ®µ &lt;code>client &amp;lt;---&amp;gt; nginx &amp;lt;---&amp;gt; nodejs server&lt;/code>&lt;/p>
&lt;p>åˆ†åˆ¥æŸ¥çœ‹ wireshark å°åŒ…&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__fcMFyqRZQpyVIH3F2iBIQg.jpeg"
loading="lazy"
>
&lt;img src="https://yuanchieh.page/post/img/1__F9tpw9gqLudFmq65vjZ6zA.jpeg"
loading="lazy"
alt="å·¦åœ–ç‚º client â† â†’ nginx / å³åœ–ç‚º nginx â† â†’Â server"
>
å·¦åœ–ç‚º client â† â†’ nginx / å³åœ–ç‚º nginx â† â†’Â server&lt;/p>
&lt;p>å› ç‚º nginx keep-alive è¨­ç½® timeout ç‚º 65ç§’ï¼Œæ‰€ä»¥ &lt;code>client &amp;lt;---&amp;gt; nginx&lt;/code> è™•æ–¼ persistent connectionï¼›&lt;br>
ä½†æ˜¯ &lt;code>nginx &amp;lt;---&amp;gt; server&lt;/code> é€™æ®µæ˜¯æ¯æ¬¡ request éƒ½é‡æ–°å»ºç«‹ï¼Œé è¨­åˆ° server é€™æ®µ nginx ä¸æœƒå»ºç«‹ persistent connectionã€‚&lt;/p>
&lt;h3 id="nginx-proxyé–‹å•Ÿkeepalive-ä¸”-timeout-å¤§æ–¼-nodejsserver">Nginx Proxyâ€Šâ€”â€Šé–‹å•ŸKeepAlive ä¸” timeout å¤§æ–¼ nodejsÂ server&lt;/h3>
&lt;p>ç°¡å–®ä¿®æ”¹ä¸€ä¸‹ nginx confï¼Œè®“ &lt;code>nginx &amp;lt;---&amp;gt; server&lt;/code> é€™æ®µä¹Ÿèµ° persistent connection&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__BAM9__7LQjtNIRDSBLn0SOQ.jpeg"
loading="lazy"
>
&lt;img src="https://yuanchieh.page/post/img/1__8pTNIDN7hnuI6uFToEdVZg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>è§€å¯Ÿåˆ°ä¸€å€‹ç¾è±¡æ˜¯ client â† â†’ nginx å·²ç¶“ç”± client ä¸»å‹•æ–·é–‹é€£ç·šï¼Œä½†æ˜¯ nginx åˆ° server å»è¦ç­‰åˆ°å…¶ä¸­ä¸€è€… timeout æ‰æœƒæ–·é–‹é€£ç·šï¼Œé›™æ–¹éƒ½ä¸æœƒä¸»å‹•ç™¼é€ &lt;code>Connection:close&lt;/code>ï¼›&lt;/p>
&lt;p>å¤šå€‹ client ç™¼é€ï¼Œn å€‹ client æœƒå»ºç«‹ n å€‹åˆ° nginx connectionï¼Œä½†æ˜¯ nginx â† â†’ server æœƒç”¨åŒä¸€æ¢ connection ã€‚&lt;/p>
&lt;h3 id="å¶ç™¼çš„502-éŒ¯èª¤keep-alive-race-condition">å¶ç™¼çš„502 éŒ¯èª¤â€Šâ€”â€ŠKeep-Alive Race Condition&lt;/h3>
&lt;p>&lt;a class="link" href="https://blog.percy.io/tuning-nginx-behind-google-cloud-platform-http-s-load-balancer-305982ddb340" target="_blank" rel="noopener"
>&lt;strong>Tuning NGINX behind Google Cloud Platform HTTP(S) Load Balancer&lt;/strong>&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://theo.im/blog/2017/10/14/suspicious-502-error-from-elb/" target="_blank" rel="noopener"
>** è§£å†³ AWS ELB å¶å‘çš„ 502 Bad Gateway é”™è¯¯_ - Timon Wong**&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>The NGINX timeout might be reached &lt;em>at the same time&lt;/em> the load balancer tries to re-use the connection for another HTTP request, which breaks the connection and results in a &lt;strong>502 Bad Gateway&lt;/strong> response from the load balancer.&lt;/p>
&lt;/blockquote>
&lt;p>çœ‹åˆ°å¹¾ç¯‡ç›¸é—œçš„å•é¡Œï¼Œä¸»è¦éƒ½æ˜¯ç™¼ç”Ÿ race conditionï¼ŒæŸä¸€æ–¹åœ¨å‰›å¥½æ”¶åˆ° [FIN, ACK] å¾Œåˆæ”¶åˆ°ä¸‹ä¸€å€‹ requestï¼Œå°è‡´äº† tcp connection error å›å‚³ [RST]ï¼›&lt;br>
è§£æ±ºæ–¹æ³•é€šå¸¸æ˜¯æ‹‰é•· api server ç«¯çš„ keep-alive timeoutï¼Œè®“ load balancer è‡ªå·±æ–·é–‹ connectionã€‚&lt;/p>
&lt;h4 id="tcp-close-connection">TCP Close Connection&lt;/h4>
&lt;p>&lt;a class="link" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank" rel="noopener"
>&lt;strong>Transmission Control Protocol - Wikipedia&lt;/strong> &lt;/a>&lt;/p>
&lt;p>ç•¶ TCP æ±ºå®šè¦é—œé–‰é€£ç·šæ™‚ï¼Œéœ€è¦å››æ¬¡äº¤æ¡ï¼Œä¸»è¦æ˜¯ client â†’ server èˆ‡ server â† client å…©å€‹æ–¹å‘éƒ½æœ‰ä¸€çµ„çš„ FINÂ , ACK äº¤æ›ï¼Œæ‰èƒ½ç¢ºä¿èªªé—œé–‰é€£ç·šå¾Œå°æ–¹ä¸æœƒå†é€è³‡æ–™ï¼›&lt;/p>
&lt;p>å‡è¨­ç›®å‰æ˜¯ AÂ , B åœ¨é€šä¿¡&lt;/p>
&lt;ol>
&lt;li>A é€å‡ºäº† [FIN] è¡¨ç¤ºå³å°‡é—œé–‰ A â†’ B çš„ Connection&lt;/li>
&lt;li>B å› [ACK]ï¼Œè¡¨ç¤ºæ”¶åˆ°ï¼ŒA â†’ B å°±é—œé–‰äº†&lt;/li>
&lt;li>ä½†é€™æ™‚å€™ B â†’ A é‚„æ˜¯å¯ä»¥ç¹¼çºŒå‚³é€è³‡æ–™ï¼Œç›´åˆ° B é€å‡º [FIN] A å›å‚³ [ACK]ï¼Œtcp connection æ‰çœŸæ­£é—œé–‰ã€‚&lt;/li>
&lt;/ol>
&lt;p>é€™å€‹ç‹€æ…‹æ˜¯ &lt;code>half-open&lt;/code> ï¼ŒæŸä¸€å€‹æ–¹å‘é—œé–‰ä½†å¦ä¸€å‘é‚„æ˜¯é€šçš„ã€‚&lt;/p>
&lt;p>åœ¨æŸäº›ç³»çµ±(Linux)çš„å¯¦ä½œä¸Šåƒ…æ”¯æ´ &lt;code>half-duplex&lt;/code>ï¼Œç•¶è¦é—œé–‰æŸä¸€å‘çš„ connection æ™‚æœƒé€£è®€å–éƒ½ä¸€ä½µé—œé–‰ï¼Œå¦‚æœé‚„æ²’è™•ç†å®Œæ‰€æœ‰çš„è³‡æ–™ï¼Œæ­¤æ™‚ host æœƒå›å‚³ RSTï¼Œå¦ä¸€æ–¹è¦–æ­¤æ¬¡ request å¤±æ•—ã€‚&lt;/p>
&lt;h3 id="nginx-å„ªåŒ–">Nginx å„ªåŒ–&lt;/h3>
&lt;p>&lt;a class="link" href="https://lanjingling.github.io/2016/06/11/nginx-https-keepalived-youhua/" target="_blank" rel="noopener"
>&lt;strong>nginxä¼˜åŒ–&amp;ndash;åŒ…æ‹¬httpsã€keepaliveç­‰&lt;/strong>&lt;/a>&lt;/p>
&lt;p>keep-alive æœ‰å¹¾å€‹ç›¸é—œçš„åƒæ•¸ï¼Œå¯ä»¥ä¾æ“šæœå‹™å…§å®¹è€Œèª¿æ•´ï¼Œç°¡å–®ç­†è¨˜å¹¾å€‹é‡é»&lt;/p>
&lt;ol>
&lt;li>keepalive_requests&lt;br>
ä¸€å€‹ persistent connection æœ€å¤§çš„æœå‹™ request æ•¸é‡ï¼Œè¶…éå‰‡å¼·è¿«é—œé–‰&lt;/li>
&lt;li>keepalive_timeout&lt;br>
connection idle è¶…éæ™‚é–“å°±æœƒè¢«å¼·è¿«é—œé–‰&lt;/li>
&lt;li>keepalive&lt;br>
æœ€å¤§åŒæ™‚ connection idle æ•¸é‡ï¼Œå¦‚æœè¶…éå‰‡ idle connection æœƒè¢«å›æ”¶&lt;/li>
&lt;/ol>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>keep-alive å„ªé»åœ¨æ–¼é‡è¤‡åˆ©ç”¨ tcp connectionï¼Œä½†å¿…é ˆæ³¨æ„&lt;/p>
&lt;ol>
&lt;li>client library çš„å¯¦è¸ï¼Œç¢ºèªæ˜¯å¦æœ‰ä¸»å‹•ç™¼é€ connection: close æ©Ÿåˆ¶ï¼Œå¦å‰‡ server éƒ½æœƒç­‰åˆ° timeout æ‰æ–·é–‹é€£ç·šï¼Œæœƒé€ æˆå¤ªå¤šä¸å¿…è¦çš„ idleã€‚&lt;/li>
&lt;li>nginx â† â†’ server é€™æ®µçš„é•·é€£æ¥ timeout é›™æ–¹éƒ½å¯ä»¥æ‹‰é•·ï¼Œå¦‚æœ QPS (query per second) å¾ˆé«˜çš„è©±ï¼Œå¤šå€‹ client connection ä¹Ÿæœƒåˆ©ç”¨åŒä¸€æ¢ nginx â† â†’ server çš„ persistent connectionã€‚&lt;/li>
&lt;li>å¦‚æœæœ‰ä½¿ç”¨ GCP / AWS load balancer å¶ç™¼ 502éŒ¯èª¤ï¼Œä¸” api server ç«¯æ²’æœ‰æ”¶åˆ°ä»»ä½•é€£ç·šç´€éŒ„ï¼Œå¤šåŠæ˜¯ keep-alive timeout å•é¡Œã€‚&lt;/li>
&lt;li>è®“ client timeout å¤§æ–¼ server timeoutï¼Œå› ç‚º request æ˜¯ç”± client ç™¼èµ·ï¼Œå°±èƒ½æœ‰æ•ˆé¿å… keep-alive race conditionã€‚&lt;/li>
&lt;/ol></description></item><item><title>Linux Traffic Control (tc) ç ”ç©¶</title><link>https://yuanchieh.page/posts/2019/2019-04-05-linux-traffic-control-tc-%E7%A0%94%E7%A9%B6/</link><pubDate>Fri, 05 Apr 2019 12:20:15 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-04-05-linux-traffic-control-tc-%E7%A0%94%E7%A9%B6/</guid><description>&lt;p>ä»¥ä¸‹ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ Linux Kernel å…§å»ºçš„å·¥å…· &lt;code>tc&lt;/code> ï¼Œå®Œæˆ&lt;/p>
&lt;ol>
&lt;li>ç¶²è·¯æµé‡ç®¡åˆ¶ï¼Œç•¶ä¸€å°ä¸»æ©Ÿä¸Šæœ‰å¤šå€‹ç¶²è·¯æœå‹™ï¼Œå¸Œæœ›å¯ä»¥åˆ†é…ä¸åŒçš„ç¶²è·¯é »å¯¬ã€å°åŒ…å‚³é€çš„å„ªå…ˆåºç­‰&lt;/li>
&lt;li>æ¨¡æ“¬æƒ¡åŠ£ç¶²è·¯ç’°å¢ƒä¸‹çš„ç‹€æ…‹ï¼Œä¾‹å¦‚å°åŒ…å»¶é²ã€éš¨æ©Ÿæ€§æ‰å°åŒ…&lt;/li>
&lt;/ol>
&lt;p>ç’°å¢ƒå‰‡æ˜¯åœ¨ MacOS ç”¨ VMè·‘ Ubuntu 16.04ã€‚&lt;/p>
&lt;h2 id="èƒŒæ™¯çŸ¥è­˜ä»‹ç´¹-networklayer">èƒŒæ™¯çŸ¥è­˜ä»‹ç´¹ NetworkÂ Layer&lt;/h2>
&lt;p>tc æ˜¯åŸºæ–¼ç¶²è·¯åˆ†å±¤ä¸­çš„ Network Layer ç¶²è·¯å±¤é€²è¡Œå°åŒ…çš„æ§åˆ¶ï¼Œé‡å°å°åŒ…çš„ ip å…§å®¹é€²è¡Œç¯©é¸èˆ‡æ§åˆ¶ã€‚&lt;/p>
&lt;p>&lt;strong>ç¶²è·¯å±¤&lt;/strong>ï¼Œä¸»è¦é—œæ³¨æ–¼å¦‚ä½•å°‡æºç«¯çš„å°åŒ…é€éè·¯ç”±å™¨ï¼Œä¸€æ­¥æ­¥(hop)æ­£ç¢ºçš„å‚³é€åˆ°æ¥æ”¶ç«¯ï¼Œä¸­é–“çš„è·¯ç”±ç®—æ³•ç­‰ç•¥éä¸è«‡ï¼Œé€™é‚Šä¸»è¦é—œæ³¨æ–¼å£…å¡æ§åˆ¶èˆ‡æœå‹™è³ªé‡&lt;/p>
&lt;h3 id="å£…å¡æ§åˆ¶--congestion-control">å£…å¡æ§åˆ¶ ( Congestion ControlÂ )&lt;/h3>
&lt;p>Congestion å£…å¡æ˜¯æŒ‡ ç•¶ä¸»æ©Ÿæ¥æ”¶çš„å°åŒ…é‡å¢åŠ ï¼Œå¤§æ–¼ç™¼é€çš„é‡ï¼Œæ­¤æ™‚æœƒè¢«æš«å­˜æ–¼ Bufferç·©å­˜å€ç•¶ä¸­ï¼Œä½†å¦‚æœå°åŒ…é‡å¡«æ»¿äº†ç·©å­˜å€ï¼Œå°±æœƒéºå¤±éƒ¨åˆ†å°åŒ…ï¼Œç¶²è·¯ä¹Ÿé–‹å§‹å£…æ“ ã€‚&lt;/p>
&lt;p>é¿å…å£…å¡çš„æ–¹å¼æœ‰å¹¾ç¨®&lt;/p>
&lt;ol>
&lt;li>å¢åŠ ç¶²è·¯è™•ç†çš„èƒ½åŠ›&lt;/li>
&lt;li>æµé‡æ„ŸçŸ¥&lt;br>
ä¸»å‹•å°‡å°åŒ…ç¹é–‹å£…å¡å€åŸŸï¼Œèµ°å…¶ä»–åˆ©ç”¨ç‡è¼ƒä½çš„è·¯ç”±å™¨ï¼Œé€™æœƒéœ€è¦ä¿®æ”¹è·¯ç”±ç®—æ³•ï¼Œå°‡å¸¶å¯¬ã€å‚³é€å»¶é²ç­‰éƒ½ä¸€ä½µæ”¾å…¥ link state routing çš„æ¬Šé‡åˆ†é…ï¼Œæ±ºå®šå°åŒ…è©²é€å¾€å“ªå€‹è·¯ç”±å™¨&lt;/li>
&lt;li>å‡†å…¥æ§åˆ¶&lt;br>
å¦‚æœç™¼ç¾è² è¼‰éé«˜ï¼Œæ‹’çµ•æ–°çš„é€£ç·šå»ºç«‹&lt;/li>
&lt;li>æµé‡èª¿ç¯€&lt;br>
ç•¶è·¯ç”±å™¨ç™¼ç¾æœ‰å£…å¡çš„å¯èƒ½ï¼Œå¯ä»¥ä¸»å‹•ç™¼å‡ºè¨Šæ¯ï¼Œå†å°åŒ…ä¸Šæ¨™è¨˜ï¼Œåˆæˆ–æ˜¯å‚³é€ choke package ï¼Œå‘ŠçŸ¥ç™¼é€è€…æ‡‰è©²è¦é™ä½ç™¼é€çš„é€Ÿåº¦&lt;/li>
&lt;li>è² è¼‰è„«è½&lt;br>
å¦‚æœè·¯ç”±å™¨ä¾†ä¸åŠè™•ç†å°åŒ…ï¼Œç‚ºäº†é¿å…å£…å¡æœƒç›´æ¥ä¸Ÿæ£„å°åŒ…ï¼›&lt;br>
åšæ³•æœ‰ RED( Random Early Detection)ï¼Œç•¶æŸå€‹æš«å­˜å€è¶…éæŸå€‹é–¥å€¼ï¼Œå°±æœƒé–‹å§‹éš¨æ©Ÿä¸Ÿæ£„å°åŒ…ï¼Œæ­¤æ™‚ç™¼é€æ–¹å°±æœƒæ„è­˜åˆ°éœ€è¦æ”¾ç·©ç™¼é€é€Ÿåº¦ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="æœå‹™è³ªé‡-qosquality-ofservice">æœå‹™è³ªé‡ (QoSï¼ŒQuality ofÂ Service)&lt;/h3>
&lt;p>é™¤äº†å£…å¡æ§åˆ¶å¤–ï¼Œæ‡‰ç”¨ç¨‹å¼å°æ–¼ç¶²è·¯çš„è¦æ±‚ä¹Ÿæœƒæœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚èªªå¤§å‹æ–‡ä»¶éœ€è¦è¼ƒå¤§çš„å¸¶å¯¬ï¼Œä½†æ˜¯å»¶é²æ€§èˆ‡ç¶²è·¯æŠ–å‹•æ²’é€™å€‹æ•æ„Ÿï¼›&lt;br>
ä½†ç›¸å°çš„å½±éŸ³é »ç›´æ’­ï¼Œå°æ–¼ç¶²è·¯æŠ–å‹•å°±éå¸¸æ•æ„Ÿï¼Œæˆ–è¨±ä½ å¯ä»¥æ¥å—ä¸€å€‹å½±ç‰‡ç©©å®š delay 10ç§’é˜é–‹å§‹ï¼Œä½†ç„¡æ³•æ¥å—æ’­åˆ°ä¸€åŠå¡é “ã€‚&lt;/p>
&lt;p>æœå‹™è³ªé‡æœ‰å…©ç¨®é¡åˆ¥&lt;/p>
&lt;ol>
&lt;li>Integrated Service (ç¶œåˆæœå‹™)ï¼š&lt;br>
åœ¨å°åŒ…å‚³é€çš„è·¯å¾‘ä¸Šï¼Œæ‰€æœ‰çš„è·¯ç”±å™¨éƒ½ä¿ç•™ä¸€å®šé¡åº¦çš„è³‡æºï¼Œå½¢æˆå°ˆç”¨ç«¯åˆ°ç«¯çš„æ•¸æ“šæµï¼Œå°±å¥½æ¯”å…¬è»Šå°ˆç”¨é“å°±åªèƒ½ç”±å…¬è»Šè¡Œé§›ï¼›&lt;br>
å¥½è™•æ˜¯èƒ½å¤ å¾ˆç©©å®šçš„æœå‹™è³ªé‡ï¼Œä½†ç¼ºé»å°±æ˜¯éœ€è¦éå¸¸é¾å¤§çš„è³‡æºï¼Œä¸”æ•ˆç‡ä¸é«˜ï¼Œå…·é«”å”è­°å¯ä»¥åƒè€ƒ RSVPï¼Œä½†é€™å› ç‚ºé›£åº¦éé«˜å¹¾ä¹æ²’æœ‰å¯¦è¸ã€‚&lt;/li>
&lt;li>Differential Service (å€åˆ†æœå‹™)ï¼š&lt;br>
å°æ¯”æ–¼ç¶œåˆæœå‹™æä¾›æ•´æ®µç¶²è·¯çš„æœå‹™è³ªé‡ï¼Œå€åˆ†æœå‹™åƒ…æä¾›å–®å€‹è·¯ç”±å™¨çš„æœå‹™è³ªé‡ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯ä¸€æ¬¡çš„ hop é–“ç”±è©²è·¯ç”±å™¨ä¿ç•™è³‡æº(Per Hop Behavior)ï¼Œç­‰åˆ°ä¸‹ä¸€è·³å†ç”±ä¸‹ä¸€å€‹è·¯ç”±å™¨é ç•™è³‡æºï¼›&lt;br>
åœ¨ IPv4 çš„å°åŒ…ä¸­ï¼Œheader åŒ…å«ä¸€å€‹æ¬„ä½ ToS( Type of Service)ï¼Œå…± 8 bitsï¼Œå‰ 6 bits è¡¨ç¤ºæœå‹™é¡å‹ï¼Œå¾Œ 2 bits è¡¨ç¤ºå£…å¡è¨Šæ¯ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç‚ºäº†æä¾›æœå‹™è³ªé‡ï¼Œè·¯ç”±å™¨å¿…é ˆæ±ºå®šå°åŒ…ç™¼é€é †åº( &lt;code>Packet Scheduling&lt;/code> )ä»¥åŠæ§åˆ¶æµé‡(&lt;code>Traffic Shaping æµé‡æ•´å½¢&lt;/code>) çš„åŠŸèƒ½&lt;/p>
&lt;p>&lt;code>Traffic Shaping&lt;/code> ä¸»è¦æ˜¯é‡å°çªç™¼æ€§æµé‡æ‰€æ¡å–çš„æ”¤å¹³æµé‡æ–¹å¼ï¼Œé¿å…ä¸€æ¬¡æ€§å¡æ»¿ç·©å­˜å€å°è‡´å°åŒ…æ‰è½ï¼Œå¸¸è¦‹çš„æ–¹å¼æœ‰å…©ç¨®&lt;/p>
&lt;ol>
&lt;li>Leaky Bucket&lt;br>
æœ‰ä¸€å€‹æ¼æ´çš„æ¡¶ï¼Œæ¡¶çš„å°ºå¯¸èˆ‡å‡ºå£çš„æœ€å¤§æµé€Ÿå›ºå®šï¼›&lt;br>
åªè¦ä¸Šæ–¹æœ‰æ°´æ³¨å…¥ï¼Œæ¡¶å°±æœƒè‡ªå‹•å¾å‡ºå£å‡ºå»ï¼Œå¦‚æœæ³¨å…¥é€Ÿåº¦é«˜æ–¼å‡ºå£æµé€Ÿï¼Œå°±æœƒé–‹å§‹åœ¨æ¡¶ä¸­ç´¯ç©ï¼Œå¦‚æœæ»¿äº†å°±æº¢å‡ºã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__JPPMyAsWQM4A6v2ISToeDA.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.geeksforgeeks.org/leaky-bucket-algorithm/" target="_blank" rel="noopener"
>https://www.geeksforgeeks.org/leaky-bucket-algorithm/&lt;/a>&lt;/p>
&lt;p>2. Token Bucket&lt;br>
æ¡¶å­å…§æ”¹å­˜æ”¾ Tokenï¼Œå¦‚æœæ¡¶å­æ»¿äº†å°±ä¸å†æ”¾ Tokenï¼›&lt;br>
å¦‚æœæ­¤æ™‚æœ‰ packet è¦ç™¼é€ï¼Œå°±å¿…é ˆå¾æ¡¶å­ä¸­æ¶ˆè€—ä¸€å€‹ Tokenï¼Œå¦‚æœæ²’æœ‰ Token å‰‡ packet ä¸èƒ½ç™¼é€ã€‚&lt;br>
å°æ¯” Leaky Bucketå„ªé»åœ¨æ–¼Â &lt;br>
- Leaky Bucket æ¡¶å­æ»¿äº†æœƒé–‹å§‹ä¸Ÿå°åŒ…ï¼Œè€Œ Token Bucket å‰‡æ˜¯ä¸Ÿæ£„ Token&lt;br>
- ç•¶æµé‡ä½æ™‚ï¼ŒToken Bucket æœ‰æ©Ÿæœƒå¯ä»¥ç´¯ç© Tokenï¼Œç­‰åˆ°é«˜å³°æ™‚ä¸€æ¬¡æ€§ä½¿ç”¨æ‰ï¼Œè€Œ Leaky Bucket ç„¡æ³•åšè³‡æºçš„ä¿ç•™&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__ZgZl0hEi3WGl6dKiqtkL1Q.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>&lt;a class="link" href="https://gateoverflow.in/39720/gate2016-1-54" target="_blank" rel="noopener"
>https://gateoverflow.in/39720/gate2016-1-54&lt;/a>&lt;/p>
&lt;p>&lt;code>Packet Scheduling&lt;/code> ç•¶è·¯ç”±å™¨ä¸€æ¬¡æ”¶åˆ°å¤šå€‹æœå‹™è³ªé‡è«‹æ±‚çš„å°åŒ…æ™‚ï¼Œæœƒéœ€è¦ packet scheduling æ©Ÿåˆ¶è™•ç†ç™¼é€çš„å…ˆå¾Œé †åºï¼Œæœ€åŸºæœ¬çš„å°±æ˜¯ä¸€æ¢ FIFO çš„Queueï¼Œæ‰€ä»¥çš„å°åŒ…éƒ½æŒ‰é †åºæ’éšŠç™¼é€ï¼Œä½†æ˜¯é€™ç„¡æ³•æä¾›è‰¯å¥½çš„æœå‹™è³ªé‡ä¿è­‰ï¼›&lt;br>
å¦ä¸€å€‹æ˜¯ Fair Queueing (å…¬å¹³éšŠåˆ—)ï¼Œæ¯å€‹ data flow éƒ½ç¨ç«‹ä¸€å€‹ queueï¼Œè·¯ç”±å™¨ä»¥è¼ªæ’­çš„æ–¹å¼ï¼Œè¼ªæµç™¼é€å°åŒ…ï¼›&lt;br>
åœ¨æ­¤ä¹‹ä¸Šé‚„æœ‰ WFQ (åŠ æ¬Šå…¬å¹³éšŠåˆ—)ï¼Œæ¯å€‹ Queue æ¬Šé‡ä¸åŒï¼Œæ¬Šé‡é«˜çš„ç™¼é€é »ç‡æœƒé«˜æ–¼æ¬Šé‡ä½ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å°çµï¼šNetwork Layer æä¾›å£…å¡æ§åˆ¶èˆ‡æœå‹™è³ªé‡çš„æ§åˆ¶ï¼Œè€Œæœå‹™è³ªé‡ä¸‹æµé‡æ•´å½¢èˆ‡å°åŒ…èª¿åº¦æ©Ÿåˆ¶çš„å¯¦ä½œï¼Œä¹Ÿå°±æ˜¯å¾ŒçºŒè¦ç”¨ tc æ§åˆ¶çš„éƒ¨åˆ†&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¸¸ç”¨ç¶²è·¯æŒ‡ä»¤">å¸¸ç”¨ç¶²è·¯æŒ‡ä»¤&lt;/h2>
&lt;ol>
&lt;li>æ‰¾å‡ºè£ç½®ä¸Šç›®å‰çš„ network interfaceï¼š&lt;br>
Network Interface Card(ç¶²è·¯å¡) ä¸€ç«¯æ˜¯é€£æ¥é€šè¨Šä»‹è³ª(ä¹™å¤ªç¶²ã€Wifiç­‰)ï¼Œå¦ä¸€ç«¯å‰‡æ˜¯æä¾›ä¸»æ©Ÿçš„ç¶²è·¯æ“ä½œä»‹é¢(network interface)&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">// åœ¨ mac os ä¸Š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ networksetup -listallhardwareports
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// åœ¨ ubuntu ä¸Š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ip link show
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2. è§€å¯ŸæŸ network interface æµé‡&lt;br>
åƒè€ƒæ­¤ç¯‡æ–‡ç«  &lt;a class="link" href="https://www.binarytides.com/linux-commands-monitor-network/" target="_blank" rel="noopener"
>18 commands to monitor network bandwidth on Linux server&lt;/a>ï¼ŒæŒ‘é¸äº†å…©å€‹ä¸éŒ¯çš„å·¥å…· &lt;code>speedometer&lt;/code> ç”¨é•·æ¢åœ–å³æ™‚è¡¨ç¾å°åŒ…æµé‡ã€&lt;code>tcptrack&lt;/code> è§€å¯Ÿ tcp é€£ç·šç‹€æ…‹ï¼Œæ–¹ä¾¿å¾ŒçºŒå¯¦é©—é‡æ¸¬&lt;/p>
&lt;p>3. æ‰¾å‡º domain name å°æ‡‰çš„ ip&lt;br>
å› ç‚º tc æ˜¯ç¶²è·¯å±¤å·¥å…·ï¼Œæ‰€ä»¥è¦ç¯©é¸å°åŒ…éœ€è¦é€é ip ï¼Œé€é &lt;code>$host {domain}&lt;/code> æ‰¾å‡º ipã€‚&lt;/p>
&lt;h2 id="tc-åŸºæœ¬ä»‹ç´¹">tc åŸºæœ¬ä»‹ç´¹&lt;/h2>
&lt;p>&lt;a class="link" href="https://linux.die.net/man/8/tc" target="_blank" rel="noopener"
>tc&lt;/a> çš„æµé‡æ§åˆ¶ä¸»è¦ç”±å››å€‹æ¦‚å¿µçµ„æˆ&lt;/p>
&lt;ul>
&lt;li>Shaping ï¼šæ§åˆ¶å°åŒ…çš„å‚³è¼¸é€Ÿåº¦&lt;/li>
&lt;li>Schedulingï¼šæ§åˆ¶å°åŒ…çš„ç™¼é€é †åº&lt;/li>
&lt;li>Policingï¼šæ”¶åˆ°å°åŒ…å¾Œçš„è™•ç†æ©Ÿåˆ¶&lt;/li>
&lt;li>Droppingï¼šæµé‡è¶…éå¸¶å¯¬å¾Œçš„ä¸Ÿå°åŒ…æ©Ÿåˆ¶&lt;/li>
&lt;/ul>
&lt;p>å¯¦ä½œä¸Šæœ‰ä¸‰å€‹ç‰©ä»¶&lt;/p>
&lt;ol>
&lt;li>Qdisc (queueing discipline)ï¼š&lt;br>
ç•¶ kernel æƒ³è¦é€é network interface ç™¼é€ package æ™‚ï¼Œæœƒå…ˆå…¨éƒ¨è¢«æ”¾åœ¨ queue ä¸Šé¢ï¼Œé è¨­æ˜¯ pfifoï¼Œä¸åšä»»ä½•è™•ç†å–®ç´”çš„ First-In First-Outã€‚&lt;/li>
&lt;li>Class&lt;br>
æœ‰äº› qdisc å¯ä»¥å®šç¾© Classï¼ŒClass ä¸»è¦ç”¨æ–¼åšæµé‡çš„ç®¡åˆ¶ï¼Œæ”¯æ´ Class çš„ Qdisc åˆç¨±ç‚º &lt;code>classful qdisc&lt;/code>ï¼Œæ¯å€‹ Class åˆåŒ…å«è‡ªå·±å…§éƒ¨çš„ Queueï¼Œæ‰€ä»¥èƒ½çµ„æˆå±¤ç‹€çš„ç¶²è·¯æµé‡æ§åˆ¶&lt;/li>
&lt;li>Filter&lt;br>
æ±ºå®š package è¦é€å¾€å“ªå€‹ classï¼Œæ¯å€‹ filter æ˜¯ç¶å®šåœ¨ qdisc ä¸Šã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å¹¾ç¨®-qdiscä»‹ç´¹">å¹¾ç¨® QdiscÂ ä»‹ç´¹&lt;/h2>
&lt;p>qdisc æœ‰éå¸¸å¤šç¨®ï¼Œé€™è£æŒ‘å¹¾å€‹ç°¡å–®ä»‹ç´¹ï¼Œå±†æ™‚å¯ä¾ç…§å±¬æ€§é¸æ“‡ä½¿ç”¨&lt;/p>
&lt;h3 id="classless-qdisc">classless qdisc&lt;/h3>
&lt;ol>
&lt;li>&lt;a class="link" href="https://linux.die.net/man/8/tc-pfifo" target="_blank" rel="noopener"
>pfifo / bfifo&lt;/a>&lt;br>
é‡å° Packet / Byte Buffer å®¹é‡é™åˆ¶çš„ First-In First-Out Queueï¼Œé€™ç¨® queue ä¸¦ä¸æœƒå°å°åŒ…æœ‰é¡å¤–çš„æ“ä½œï¼Œæ”¶åˆ°å°±ä¾ç…§é †åºè½‰ç™¼ï¼Œè¶…é Buffer å°±ä¸Ÿæ‰ï¼Œé€™æ˜¯æœ€ç°¡å–®çš„ qdiscã€‚&lt;br>
ä½¿ç”¨ä¸Šå¦‚ &lt;code>sudo tc qdisc add dev enp0s5 root pfifo limit 1000&lt;/code>&lt;/li>
&lt;li>&lt;a class="link" href="https://linux.die.net/man/8/tc-pfifo_fast" target="_blank" rel="noopener"
>pfifo_fast&lt;/a>&lt;br>
é è¨­çš„ qdiscï¼Œå…§å»ºæ˜¯ä¸‰æ¢ pfifo(ç¨±ç‚º band)ï¼Œæœƒä¾æ“š IPV4 header ä¸­çš„ ToS è½‰ç™¼åˆ°å°æ‡‰çš„ bandï¼Œå¦‚æœ band ä¸­æœ‰å°åŒ…ï¼Œæœƒå¾ä½é †ä½çš„ band é–‹å§‹ç™¼é€ï¼Œç›´åˆ°æ¸…ç©ºå¾Œä¾åºæ›é«˜é †ä½çš„ band&lt;/li>
&lt;/ol>
&lt;h3 id="classful-qdisc">classful qdisc&lt;/h3>
&lt;ol>
&lt;li>&lt;a class="link" href="https://www.systutorials.com/docs/linux/man/8-tc-tbf/" target="_blank" rel="noopener"
>tbf&lt;/a>&lt;br>
ä¹Ÿå°±æ˜¯ Token Bucket å¯¦ä½œï¼Œä¸»è¦ç”¨æ–¼æµé‡æ•´æµå¢åŠ å¹³å‡æµé€Ÿ 0.5mbps é«˜å³° 1mbps+Bufferç©ºé–“ 5kb&lt;br>
&lt;code>tc qdisc add dev eth0 handle 10: root tbf rate 0.5mbit burst 5kb peakrate 1mbit&lt;/code>&lt;/li>
&lt;li>&lt;a class="link" href="https://linux.die.net/man/8/tc-prio" target="_blank" rel="noopener"
>prio&lt;/a>
éå¸¸é¡ä¼¼æ–¼ pfifo_fastï¼ŒåŒæ¨£é è¨­æœ‰ä¸‰æ¢ bandï¼Œä½†å„ªé»æ˜¯å¯ä»¥è‡ªè¨‚ priomapï¼Œæ±ºå®š ToS è¦å°æ‡‰åˆ°å“ªå€‹ band (pfifo_fast ç„¡æ³•è‡ªå®š)ï¼›&lt;br>
å¦å¤–ä¹Ÿæ”¯æ´ tc filterï¼Œç”¨å…¶ä»–çš„æ¢ä»¶æ±ºå®šå°åŒ…è½‰ç™¼åˆ°å“ªå€‹ bandã€‚&lt;/li>
&lt;li>&lt;a class="link" href="http://man7.org/linux/man-pages/man8/tc-htb.8.html" target="_blank" rel="noopener"
>htb&lt;/a>&lt;br>
ç”¨æ–¼æ§åˆ¶ outbound å¸¶å¯¬æµé‡ï¼ŒåŸºæ–¼ Token Bucket å¯¦ä½œ&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>* è£œï¼š working-conserving scheduler:&lt;br>
æ¯ç¨® qdisc å¯åˆ†ç‚º working-conserving æˆ–æ˜¯ non-working-conservingï¼Œworking-conserving è¡¨ç¤ºä¸æœƒè®“è³‡æº idleä¸‹ä¾†ï¼›&lt;br>
non-working-conserving å‰‡æ˜¯æœƒåœ¨æŸäº›æ¢ä»¶ä¸‹å»¶é²ï¼Œå¯ç”¨æ–¼æ¶ˆé²æŠ–å‹• (jittering )æˆ–æ˜¯éœ€è¦é æœŸæ€§çš„æ’ç¨‹ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ä¾‹å¦‚èªª pfifo æ”¶åˆ°å°åŒ…å¾Œï¼Œå°±æœƒç«‹å³é€å‡ºï¼›&lt;br>
å°æ‡‰çš„ tbf å°±æ˜¯ non-working-conservingï¼Œæ”¶åˆ°å°åŒ…å¾Œï¼Œæœƒçœ‹æ˜¯å¦æœ‰ token æ‰æœƒé€å‡ºå°åŒ…ï¼Œä¸¦ä¸ä¸€å®šæ˜¯ç«‹å³ç™¼ç”Ÿã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="tcå»¶é²å°åŒ…">tcâ€Šâ€”â€Šå»¶é²å°åŒ…&lt;/h2>
&lt;p>é€éåŸºæœ¬çš„ classless pfifo qdiscï¼Œå¯¦ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>é€éå°åŒ…å»¶é²ï¼Œæ”¾ç·© httpé€£ç·šåˆ° stackoverflow&lt;/li>
&lt;li>é€é bandwidth(å¸¶å¯¬)é™åˆ¶ï¼Œèª¿æ•´ aws s3 ä¸Šå‚³çš„é€Ÿåº¦&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸‹æŒ‡ä»¤åƒè€ƒ&lt;/p>
&lt;h3 id="1-åˆ—å‡ºç›®å‰æ‰€æœ‰çš„-network-interface-çš„è¨­å®š">1. åˆ—å‡ºç›®å‰æ‰€æœ‰çš„ network interface çš„è¨­å®š&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ tc qdisc ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qdisc noqueue 0: dev lo root refcnt &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qdisc pfifo_fast 0: dev enp0s5 root refcnt &lt;span class="m">2&lt;/span> bands &lt;span class="m">3&lt;/span> priomap &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a class="link" href="https://linux.die.net/man/8/tc-prio" target="_blank" rel="noopener"
>tc-prio&lt;/a> æ˜¯é è¨­çš„éšŠåˆ—è¦å‰‡ï¼Œå¦‚æœæœ‰ç¶å®šæ–°çš„éšŠåˆ—è¦å‰‡æœƒç›´æ¥è¦†è“‹éå»ã€‚&lt;br>
é è¨­ prio æœƒæœ‰ä¸‰å€‹ bandï¼Œè€Œ priomap å‰‡è¡¨ç¤ºå°æ‡‰ IP å°åŒ…ä¸­çš„ 4bits TOS æ¬„ä½ï¼Œå°‡å°åŒ…é€éè©² band ç™¼é€ã€‚&lt;/p>
&lt;p>éœ€æ³¨æ„ &lt;code>enp0s5&lt;/code> æ˜¯æˆ‘è‡ªå·±çš„ network interfaceï¼Œè¨˜å¾—æ›¿æ›æˆè‡ªå·±è£ç½®ä¸Šçš„ network interface&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__d566EGgUEX52WNdIpSf__AQ.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;a class="link" href="http://linux-ip.net/articles/Traffic-Control-HOWTO/classless-qdiscs.html" target="_blank" rel="noopener"
>http://linux-ip.net/articles/Traffic-Control-HOWTO/classless-qdiscs.html&lt;/a>&lt;/p>
&lt;h3 id="2-é è¨­å°‡æ‰€æœ‰çš„æµé‡å°å‘-band2">2. é è¨­å°‡æ‰€æœ‰çš„æµé‡å°å‘ bandÂ 2&lt;/h3>
&lt;p>ç‚ºäº†é¿å…å…¶ä»–å°åŒ…è¢«å½±éŸ¿ï¼Œå…ˆå°‡æ‰€æœ‰çš„å°åŒ…éƒ½èµ° band 2(æŒ‡ä»¤è¨ˆæ•¸å¾0é–‹å§‹)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo tc qdisc add dev enp0s5 root handle 1: prio bands &lt;span class="m">10&lt;/span> priomap &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>handle 1: æŒ‡çš„æ˜¯ç¶å®šåˆ° qdisc çš„ root&lt;br>
bands 10: å¯ä»¥å‰µå»º 10çµ„ band&lt;/p>
&lt;h3 id="3-è¨­å®šå°åŒ…å»¶é²">3. è¨­å®šå°åŒ…å»¶é²&lt;/h3>
&lt;p>$ sudo tc qdisc add dev enp0s5 parent 1:1 handle 10: netem delay 100ms 10ms&lt;/p>
&lt;ol>
&lt;li>&lt;a class="link" href="http://man7.org/linux/man-pages/man8/tc-netem.8.html" target="_blank" rel="noopener"
>netem&lt;/a> æ˜¯ tc çš„å·¥å…·ä¹‹ä¸€ï¼Œå¯ç”¨ä¾†å¢åŠ å»¶é²ã€æ‰å°åŒ…ã€é‡è¤‡å°åŒ…ç­‰æ¨¡æ“¬å·¥å…·ï¼Œ&lt;code>netem delay 100ms 10ms&lt;/code> è¡¨ç¤ºæ¯å€‹å°åŒ…å»¶é² 100ms(+- 10ms)&lt;/li>
&lt;li>parent 1:1 è¡¨ç¤ºåœ¨ class id 1 åº•ä¸‹ï¼Œå»ºç«‹ä¸€å€‹ id ç‚º 1çš„å­ç¯€é»ï¼Œå› ç‚ºç•¶å‰çš„éšŠåˆ—æ²’æœ‰å¤šå±¤æ¬¡çš„ classè¨­è¨ˆï¼Œæ‰€ä»¥ 1:1 å°±å°æ‡‰åˆ° band 0&lt;/li>
&lt;li>handle 10: è¡¨ç¤ºå‰µå»ºä¸€å€‹ class id ç‚º 10 çš„ç¯€é»&lt;/li>
&lt;/ol>
&lt;p>é›–ç„¶ç›®å‰æœ‰å¢åŠ äº† band0 çš„å»¶é²ï¼Œä½†å› ç‚ºæ‰€æœ‰å°åŒ…éƒ½æ˜¯èµ° band2ï¼Œé‚„ä¸æœƒå—åˆ°å»¶é²çš„å½±éŸ¿ï¼Œå…ˆç”¨å·¥å…·é‡æ¸¬ç›®å‰çš„ç¶²è·¯å»¶é²ï¼Œé€™é‚Šæˆ‘æ˜¯ç”¨ curl&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -o/dev/null -w &lt;span class="s2">&amp;#34;\\n%{time_connect}:%{time_starttransfer}:%{time_total}\\n&amp;#34;&lt;/span> -s &lt;span class="o">[&lt;/span>https://stackoverflow.com/&lt;span class="o">](&lt;/span>https://stackoverflow.com/&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¨­å®šå‰ä¸å°ˆæ¥­é‡æ¸¬ç´„ç‚º 1.5 sã€‚&lt;/p>
&lt;h3 id="4-åŠ å…¥éæ¿¾å™¨å°‡ç¬¦åˆæ¢ä»¶çš„å°åŒ…è½‰é€åˆ°-band0">4. åŠ å…¥éæ¿¾å™¨ï¼Œå°‡ç¬¦åˆæ¢ä»¶çš„å°åŒ…è½‰é€åˆ° bandÂ 0&lt;/h3>
&lt;p>$ sudo tc filter add dev enp0s5 protocol ip parent 1:0 prio 1 u32 match ip dst 151.101.0.0/16 match ip dport 443 0xffff flowid 1:1&lt;/p>
&lt;ol>
&lt;li>protocol å¯ä»¥æŒ‡å®š ipv4Â , ipv6Â , tcp æˆ–udp&lt;/li>
&lt;li>prio queue çš„ filter åªèƒ½ç¶å®šåœ¨ 1:0 åº•ä¸‹ï¼Œæ‰€ä»¥ parent 1:0 æ˜¯å›ºå®šçš„&lt;/li>
&lt;li>u32 æ˜¯ tc çš„å·¥å…·ï¼Œä¸»è¦æ˜¯é‡å° ip å…§æ–‡åšç¯©é¸ï¼Œä¾‹å¦‚ match ip dst è¡¨ç¤ºå°å°åŒ…çš„ç›®æ¨™ä½ç½®åç¯©é¸ï¼›&lt;br>
å¯ä»¥è¨­ç½®å¤šå€‹ match æ¢ä»¶&lt;/li>
&lt;li>flowid 1:1 è¡¨ç¤ºæ­¤ filter ç¶å®šåˆ° band 0 ä¸Š&lt;/li>
&lt;li>å¤šå€‹ filter å¯ä»¥ç¶å®šåˆ°åŒä¸€å€‹ band ä¸Š&lt;/li>
&lt;/ol>
&lt;p>è¨­å®šå®Œä¹‹å¾Œï¼Œ éŸ¿æ‡‰æ™‚é–“è®Šæˆ 12ç§’!&lt;/p>
&lt;blockquote>
&lt;p>å› ç‚º netem æ˜¯é‡å° package åš delayï¼Œä¸€å€‹ http(s) request æœƒä¾†å›å¤šæ¬¡ï¼Œæ¯æ¬¡å‚³é€ä¸ç­‰å¤šçš„ packageï¼Œæ‰€ä»¥ æ¯å€‹ request delay æ™‚é–“æœƒé æ¯” 1s é•·ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä½¿ç”¨ prio éå¸¸æ–¹ä¾¿çš„æ˜¯ï¼Œåº•ä¸‹çš„ band å¯ä»¥å†å¦å¤–æ›å…¶ä»–çš„ qdiscï¼Œä¾‹å¦‚èªªåŠ ä¸Š tbf å°±å¯ä»¥é™åˆ¶å¸¶å¯¬ï¼ŒåŠ ä¸Š netem å°±å¯ä»¥æµé‡æ•´å½¢ï¼Œè€Œä¸” band æ•¸é‡å¯ä»¥è‡ªè¡Œå®šç¾©ï¼Œç›¸ç•¶å¥½ç”¨ã€‚&lt;/p>
&lt;h2 id="tcå¸¶å¯¬é™åˆ¶">tcâ€Šâ€”â€Šå¸¶å¯¬é™åˆ¶&lt;/h2>
&lt;p>å‰›æ‰ä½¿ç”¨ pfifo qdiscï¼Œæ­é… netem åšåŸºæœ¬çš„æµé‡æ§åˆ¶ï¼Œä½†å¦‚æœéœ€è¦æ§åˆ¶å¸¶å¯¬ï¼Œå°±éœ€è¦ç”¨å…¶ä»–çš„ qdiscï¼Œé…ç½® Token Bucket æˆ–æ˜¯ Leaky Bucketã€‚&lt;/p>
&lt;p>ä»¥ä¸‹ä½¿ç”¨ classful qdisc HCBã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__yxleicti2yy9F2K0UrpmHA.png"
loading="lazy"
>&lt;/p>
&lt;p>æ¸¬è©¦é™åˆ¶ aws s3 ä¸Šå‚³çš„å¸¶å¯¬&lt;/p>
&lt;h3 id="1-åˆªé™¤èˆŠçš„-qdiscè¨­å®š">1. åˆªé™¤èˆŠçš„ qdiscÂ è¨­å®š&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo tc qdisc del dev enp0s5 root
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-å»ºç«‹htb">2. å»ºç«‹Â htb&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo tc qdisc add dev enp0s5 root handle 1:0 htb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-åŠ å…¥-bandwidth-é™åˆ¶">3. åŠ å…¥ bandwidth é™åˆ¶&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo tc class add dev enp0s5 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯”å° s3 ä¸Šå‚³çš„å‰å¾Œï¼Œç™¼ç¾ä¸Šå‚³é€Ÿåº¦ç¢ºå¯¦è¢«é™åˆ¶åœ¨ 100kbps&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__GZhxO8aeHFv0x3qS6lgaBg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å¦‚æœå–®ç´”æƒ³è¦é™åˆ¶ä¸Šå‚³é€Ÿåº¦ï¼Œä¹Ÿå¯ä»¥ç”¨ tc-tbfï¼Œä½† htb å„ªé»æ˜¯ç”¨å±¤ç‹€æ¶æ§‹é™é€Ÿï¼Œleaf æœƒå—åˆ° root çš„é™åˆ¶ï¼Œä¾‹å¦‚åˆ†é…ä¸€æ¢å¸¶å¯¬ 10 Mbpsï¼Œå¯ä»¥åœ¨ä¹‹ä¸‹åˆ†é… 4 Mbps çµ¦æŸç¶²åŸŸ 6 Mbps çµ¦å…¶ä»–ç¶²åŸŸç­‰ç­‰ã€‚&lt;/p>
&lt;p>ç­†è¨˜æœƒç”¨åˆ°çš„å…¶ä»–æŒ‡ä»¤&lt;/p>
&lt;ol>
&lt;li>ä½¿ç”¨ dd å‰µå»ºæŒ‡å®šå¤§å°çš„æª”æ¡ˆ&lt;br>
if: æª”æ¡ˆå…§å®¹ä¾†æºï¼Œ&lt;code>/dev/zero&lt;/code> æ˜¯ç‰¹æ®Šæª”æ¡ˆï¼Œè®€å–æ™‚æœƒæä¾›ç„¡é™çš„ç©ºå­—å…ƒ&lt;br>
of: æª”æ¡ˆå…§å®¹è¼¸å‡º&lt;br>
bs: æ¯æ¬¡å¯«å…¥çš„å€å¡Šå¤§å° (byte)&lt;br>
count: ç¸½å…±å¯«å¤šå°‘å€‹å€å¡Š&lt;br>
&lt;code>$dd if=/dev/zero of=file.txt count=1048576 bs=1024&lt;/code>&lt;br>
é€™æ¨£æœƒç”¢å‡º file.txt æ–¼ç•¶å‰ç›®éŒ„ä¸¦ä½” 102MB&lt;/li>
&lt;li>aws-cli ä¸Šå‚³æª”æ¡ˆ&lt;br>
&lt;code>$aws s3 cp file.txt s3://{bucket åç¨±}&lt;/code>Â &lt;br>
aws s3 åœ¨ä¸Šå‚³æª”æ¡ˆæœƒç”¨å¤šå€‹ thread èˆ‡ ipï¼Œæ‰€ä»¥è¦é™åˆ¶æ¯”è¼ƒå›°é›£ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™&lt;/h3>
&lt;p>ç¶²è·¯ç›¸é—œåƒè€ƒè‡ªã€Šè®¡ç®—æœºç½‘ç»œ(ç¬¬5ç‰ˆ)ã€‹ä¸€æ›¸ã€‚&lt;/p></description></item><item><title>CS50â€Šâ€”â€Šlecture 0</title><link>https://yuanchieh.page/posts/2019/2019-02-19-cs50-lecture-0/</link><pubDate>Tue, 19 Feb 2019 00:00:17 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-02-19-cs50-lecture-0/</guid><description>&lt;p>æœ€è¿‘åœ¨æ•™äººå¯«ç¨‹å¼ï¼Œç™¼ç¾è‡ªå·±é›–ç„¶æœ‰å¯«éƒ¨è½æ ¼çš„ç¿’æ…£ï¼Œä½†æ˜¯è¦å¦‚ä½•ç”¨å£èªè¡¨é”å»é‚„æœ‰å¾ˆå¤§ä¸€æ®µçš„è½å·®ï¼Œæ›´å›°é›£çš„æ˜¯ã€Œæˆ‘ä¸çŸ¥é“å¾ä½•æ•™èµ·ã€&lt;/p>
&lt;p>å…ˆå‰çœ‹åˆ°æœ‰äººåˆ†äº«åˆ° å¤§è…¦å…¶å¯¦æ˜¯å–„æ–¼è¨˜æ†¶ï¼Œå› ç‚ºæ€è€ƒå¤ªèŠ±èƒ½é‡ï¼Œæ‰€ä»¥å¤§è…¦ç¶“éåè¦†çš„ç·´ç¿’å°±æœƒå°‡æˆæœå…§åŒ–ç‚ºè¨˜æ†¶ï¼›&lt;br>
è€Œæ•™å­¸å°±æ˜¯åŠ é€Ÿé€™å€‹éç¨‹ï¼Œä¸¦æä¾›å­¸ç¿’æ–¹æ›´æœ‰å‹•åŠ›ï¼Œå¸Œæœ›å¯ä»¥è‡ªå·±ä¸Šå®Œèª²å¾Œå¯ä»¥æ›´æ‡‚å¾—å¦‚ä½•æ•™å…¶ä»–äººç”¨å¿«æ¨‚çš„æ–¹å¼å­¸å¯«ç¨‹å¼XD&lt;/p>
&lt;h3 id="é›»è…¦ç§‘å­¸-computer-scienceåœ¨åšä»€éº¼">é›»è…¦ç§‘å­¸ Computer ScienceÂ åœ¨åšä»€éº¼&lt;/h3>
&lt;p>æåˆ°é›»è…¦ç§‘å­¸ï¼Œå¤§å®¶çš„åˆ»æ¿å°è±¡é€šå¸¸æ˜¯ ä¸€å€‹å¸¶è‘—åç¤¾æœƒäººæ ¼çš„å¸½Tç”·ç˜‹ç‹‚æ•²è‘—é›»è…¦å¯«ç¨‹å¼ï¼Œä½†å…¶å¯¦é›»è…¦ç§‘å­¸å°ˆæ³¨æ–¼ &lt;strong>è§£æ±ºå•é¡Œ&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">input -&amp;gt; [ ] -&amp;gt; output
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å…¥æˆ‘å€‘æƒ³è¦è§£æ±ºçš„å•é¡Œï¼Œé€šéä¸­é–“é»‘ç›’å­çš„é‹ç®—ï¼Œæˆ‘å€‘å¾—åˆ°å•é¡Œçš„è§£æ³•ã€‚&lt;/p>
&lt;h2 id="æ•¸äººå•é¡Œ">æ•¸äººå•é¡Œ&lt;/h2>
&lt;p>ä»Šå¤©å‡è¨­è¦æ•¸å¹¾å€‹äººä¾†ä¸Šèª²ï¼Œæˆ‘å€‘å¯ä»¥åœ¨é»‘æ¿ä¸Šï¼Œç”¨ã€Œæ­£ã€å­—ç¬¦è™Ÿè¡¨é”ï¼Œä¸€å€‹äººé ­ä»£è¡¨ä¸€æ¯”ï¼Œæœ€å¾Œç´¯ç©èµ·ä¾†çœ‹æœ‰å¤šå°‘äººï¼›&lt;/p>
&lt;p>ä½†å¦‚æœæ²’æœ‰é»‘æ¿ï¼Œæˆ‘å€‘å¯ä»¥ç”¨æ‰‹æŒ‡é ­ä¾†æ•¸ï¼Œæ‰‹æŒ‡å‡èµ·ä»£è¡¨åŠ ä¸€ï¼Œä½†æ˜¯ä¸€éš»æ‰‹æŒ‡æœ‰äº”æ ¹æ‰‹æŒ‡é ­ï¼Œé€™æ¨£æˆ‘å€‘çš„ä¸Šé™åªèƒ½æ•¸åˆ°äº”ï¼Œé€™æ¨£ä¼¼ä¹æœ‰é»å°‘Â ?!&lt;/p>
&lt;p>å›éé ­ä¾†æ€è€ƒï¼Œåœ¨äººé¡ä¸–ç•Œå¸¸ç”¨ 10 é€²ä½åˆ¶ï¼Œä¸€å€‹ä½æ•¸åªèƒ½è¡¨é” 0â€“9ï¼Œä½†å¦‚æœæˆ‘å€‘åŠ å…¥é€²ä½çš„æ¦‚å¿µï¼Œä¾‹å¦‚ 123ï¼Œé€™ä»£è¡¨çš„æ˜¯&lt;/p>
&lt;p>123 =&amp;gt; 100 * 1 + 10 * 2 + 3 * 1 = 123&lt;/p>
&lt;p>åŒæ¨£çš„å¦‚æœæ•¸æ‰‹æŒ‡ç”¨ä¸åŒçš„ &lt;code>æ¨¡å¼&lt;/code> è¡¨é”ï¼Œä¾‹å¦‚èªªæ‰‹æŒ‡èˆ‰èµ·ä»£è¡¨ 1ï¼Œæ‰‹æŒ‡æ”¶ä¸‹ä»£è¡¨ 0ï¼Œä¸¦åŠ å…¥äº†é€²ä½çš„æ¦‚å¿µï¼Œé€™æ¨£çš„è©±æ•¸æ‰‹æŒ‡å¯ä»¥è¡¨é”çš„æ•¸å­—ç¯„åœè®Šå¾—æ›´å¤§äº†ï¼Œä¾‹å¦‚æˆ‘æƒ³è¦æ¯” 9å¯ä»¥ç”¨&lt;/p>
&lt;p>01001 =&amp;gt; 0*16 + 1*8 + 0*4 + 0*2 + 1*1 = 9(åé€²ä½)&lt;/p>
&lt;p>æ•¸æ‰‹æŒ‡çš„è¡¨é”ç¯„åœç¬é–“å¾ 0â€“5 è®Šæˆ 0â€“31ï¼Œé€™ä¹Ÿå°±æ˜¯äºŒé€²ä½çš„è¡¨ç¤ºæ³•ã€‚&lt;/p>
&lt;p>é™¤äº†ç”¨æ‰‹æŒ‡è¡¨ç¤ºï¼Œæˆ‘ä¹Ÿå¯ä»¥ç”¨æ‰‹æ©Ÿçš„æ‰‹é›»ç­’é–‹å…‰ä»£è¡¨ 0 / 1ï¼Œçœ¾æ‰€çš†çŸ¥ç›®å‰å¤§å¤šæ•¸é›»è…¦åªèƒ½åˆ†è¾¨ 0 / 1ï¼Œä¹Ÿå°±æ˜¯é›»æºçš„é–‹èˆ‡é—œï¼Œæˆ–æ›´ç²¾æº–çš„èªªæ˜¯é›»æ™¶é«”ç‹€æ…‹çš„è¡¨ç¤ºï¼›&lt;br>
è€Œä½†ä¸€ä¸€å€‹ä½æ•¸ 0/1 æˆ‘å€‘ç¨±ç‚º &lt;code>ä½å…ƒ(binary / bit)&lt;/code> ï¼Œäº”æ ¹æ‰‹æŒ‡é ­ä»£è¡¨æˆ‘å€‘ç”¨ 5å€‹ bitsä¾†é‹ç®—ï¼Œè€Œ 8 bits æœƒç¨±ç‚º &lt;code>ä½å…ƒçµ„(byte)&lt;/code>ã€‚&lt;/p>
&lt;p>ä½†å°äººé¡ä¾†èªªï¼Œå…©è€…æ•¸å­—æƒ³è¡¨é”çš„æ¦‚å¿µæ˜¯ä¸€æ¨£çš„ï¼Œä½† (äºŒé€²ä½)01001 é‚„æ˜¯ä¸å¤ªç›´è§€ï¼Œæ­¤æ™‚æˆ‘å€‘å¯é€éè½‰æ›å…¬å¼è®Šæˆæˆ‘å€‘å¥½ç†è§£çš„è¡¨ç¤ºæ³• (åé€²ä½) 9ã€‚&lt;/p>
&lt;h2 id="æ•¸å­—å¦‚ä½•è¡¨é”æ–‡å­—">æ•¸å­—å¦‚ä½•è¡¨é”æ–‡å­—&lt;/h2>
&lt;p>äººé¡é™¤äº†æ•¸å­—å¤–ï¼Œæˆ‘å€‘é‚„æƒ³è¦å‚³éæ–‡å­—è¨Šæ¯ï¼Œä¾‹å¦‚èªª ABCDâ€¦.ï¼Œå–®ç´”ç”¨å¤šå€‹0,1è©²å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ&lt;/p>
&lt;p>å‰›å‰›æåˆ°ï¼Œæˆ‘å€‘å¯ä»¥å°‡ 01001 è½‰æ›æˆ 9ï¼Œé‚£åŒæ¨£çš„æˆ‘å€‘ä¿®æ”¹è½‰æ›å…¬å¼ï¼Œå°±å¯ä»¥è¼¸å‡ºä¸åŒçš„çµæœã€‚&lt;/p>
&lt;p>åœ¨é›»è…¦ä¸–ç•Œä¸­ï¼Œæœ€åŸºç¤çš„ç·¨ç¢¼æ–¹å¼æ˜¯ ACIIï¼Œé€é 8 bits ç‚ºä¸€çµ„è¡¨ç¤ºï¼Œç¸½å…± å°æ‡‰128å€‹å¸¸ç”¨çš„ç¾åœ‹è¼¸å…¥å­—ï¼Œä¾‹å¦‚èªª A æ˜¯ç”¨ 65 è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯ 0100 0001ï¼Œç•¶é›»è…¦æ”¶åˆ°å¾Œæœƒè‡ªå‹•ä»¥ 8å€‹bitç‚ºå–®ä½åˆ‡å‰²ï¼Œé€éä¸€å¼µè½‰æ›è¡¨ï¼Œå°‡äºŒé€²ä½è½‰æ›æˆæ–‡å­—ã€‚&lt;/p>
&lt;p>73 72 33 =&amp;gt; æ”¶åˆ°é€™ä¸‰å€‹å­—ç”¨ ascii è½‰æ›æœƒè®Šæˆä»€éº¼å‘¢ ? =&amp;gt; HI!&lt;/p>
&lt;p>ä½†å¦‚æœæ˜¯ç¹é«”è¼¸å…¥ï¼Œä¸­æ–‡å­—é é è¶…é 128å€‹ï¼Œåˆæˆ–æ˜¯å…¶ä»–åœ‹å®¶ä¸åŒèªè¨€ï¼Œascii é¡¯ç„¶é é ä¸å¤ ç”¨ï¼Œå¾Œä¾†å‡ºç¾äº† unicode è¬åœ‹ç·¨ç¢¼ï¼Œç”¨æ›´å¤šçš„ bits è¡¨é”ä¸€å€‹å­—ï¼Œè§£æ±ºæ–‡å­—é¡¯ç¤ºçš„å•é¡Œã€‚&lt;/p>
&lt;h2 id="æ•¸å­—å¦‚ä½•è¡¨é”åœ–åƒ">æ•¸å­—å¦‚ä½•è¡¨é”åœ–åƒ&lt;/h2>
&lt;p>åŒæ¨£æ˜¯æ”¶åˆ°å¾ˆå¤šçš„ 0/1ï¼Œé€™æ™‚å€™æˆ‘å€‘éœ€è¦ä¸åŒçš„è½‰æ›æ–¹å¼ï¼Œå¸¸è¦‹çš„è‰²ç¢¼ç³»çµ±æ˜¯ RGBï¼Œç”¨ä¸‰å€‹æ•¸å­— è¡¨é”ç´…ã€ç¶ ã€è—çš„æ·±æ·ºç¨‹åº¦ï¼Œå¾0â€“255ï¼Œä¸‰è€…æ··åˆå°±è®Šæˆäº†è‰²å½©ï¼›&lt;br>
ç‚ºäº†è¡¨é” 0â€“255ï¼Œæˆ‘å€‘éœ€è¦ 8 bitsã€‚&lt;/p>
&lt;p>æ‰€ä»¥å‰›æ‰çš„ (73, 72, 33) åœ¨ ascii ä¸­ä»£è¡¨ HI!ï¼Œä½†æ˜¯åœ¨ RGBä¸­ä»£è¡¨çš„æ˜¯æ·ºé»ƒè‰²ã€‚&lt;/p>
&lt;p>åœ¨è¢å¹•ä¸Šï¼Œä¸€å¼µåœ–ç‰‡å…¶å¯¦è¿‘çœ‹æ˜¯ç”±è¨±å¤šè¨±å¤šçš„åƒç´  pixelçµ„æˆï¼Œä¸€å€‹pixelé¡¯ç¤ºä¸€å€‹é¡è‰²ï¼Œä¹Ÿå°±æ˜¯3å€‹ä¸€çµ„çš„8bitsã€‚&lt;/p>
&lt;p>è€Œå½±ç‰‡ï¼Œå‰‡æ˜¯ç”±ä¸€å¼µå¼µåœ–ç‰‡é€£çºŒå¿«é€Ÿæ’­æ”¾æ‰€æ§‹æˆã€‚&lt;/p>
&lt;h2 id="æŠ½è±¡åŒ–">æŠ½è±¡åŒ–&lt;/h2>
&lt;p>å‰›æ‰æåˆ°äº†é›»è…¦ç”¨äºŒé€²ä½ï¼Œä½†ç‚ºäº†äººé¡çš„éœ€æ±‚ï¼Œæˆ‘å€‘åˆæŠŠ 0/1 è½‰æ›æˆä¸åŒçš„è¡¨ç¤ºæ³•ï¼Œä¾‹å¦‚èªªæœ‰ åé€²ä½è½‰æ›æˆæ˜“è®€çš„æ•¸å­—ã€asciiè½‰æ›æˆæ–‡å­—ã€RGBè½‰æ›æˆé¡è‰²ï¼Œé€™å€‹è½‰æ›çš„éç¨‹æˆ‘å€‘ç¨±ç‚ºã€Œ&lt;code>æŠ½è±¡åŒ–&lt;/code>ã€&lt;/p>
&lt;p>æŠ½è±¡åŒ–çš„æ¦‚å¿µåœ¨é›»è…¦ç§‘å­¸éå¸¸çš„åŸºæœ¬èˆ‡é‡è¦ï¼ŒæŠ½è±¡åŒ–æ˜¯æŒ‡&lt;/p>
&lt;blockquote>
&lt;p>æˆ‘å€‘ä¸ç”¨ç®¡åº•å±¤çš„å¯¦ä½œæ–¹å¼ï¼Œæ³¨é‡æ–¼æ¦‚å¿µä¸Šçš„è¡¨é”&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚èªª ä¸€å€‹åƒç´ æ˜¯ç”± 3 byte çµ„æˆ -&amp;gt; å¤šå€‹åƒç´ å¯ä»¥çµ„åˆæˆä¸€å¼µåœ– -&amp;gt; å¤šå¼µåœ–å¿«é€Ÿæ’­æ”¾å¯ä»¥çµ„æˆä¸€éƒ¨å‹•ç•«ï¼Œé€éä¸€å±¤ä¸€å±¤çš„æŠ½è±¡åŒ–ï¼Œå¯ä»¥åšåˆ°æ›´å¤šçš„äº‹æƒ…ã€‚&lt;/p>
&lt;p>åŒæ¨£çš„ï¼Œå¹³å¸¸æˆ‘å€‘åœ¨ä½¿ç”¨è¨ˆç®—æ©Ÿç®—æ•¸å­¸ã€ä¸Šç¶²å‚³è¨Šæ¯ã€çœ‹åœ–ç‰‡çœ‹å½±ç‰‡ï¼Œæˆ‘å€‘å®Œå…¨ä¸ç”¨å»ç®¡èƒŒå¾Œæ˜¯ç”¨å¤šå°‘å€‹ 0/1 å»è¡¨ç¤ºï¼Œåªè¦é›»è…¦å¯ä»¥è‡ªå‹•å¹«æˆ‘å°‡ binary è½‰æ›æˆæˆ‘éœ€è¦çš„é¡¯ç¤ºå°±å¥½äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç¸½çµä»¥ä¸Šï¼Œé›»è…¦æœ€çµ‚åªçœ‹å¾—æ‡‚ 0/1 ï¼Œè€Œå°æ–¼äººé¡æœ‰æ„ç¾©çš„æ˜¯ æ•¸å­—ã€æ–‡å­—ã€åƒç´ ç­‰ï¼Œå¯ä»¥é€éä¸åŒçš„è½‰æ›æ–¹å¼æ§‹æˆä¸åŒçš„è¡¨é” Expressionï¼Œä¹Ÿå°±æ˜¯ Input / Output çš„æ ¼å¼ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ¼”ç®—æ³•">æ¼”ç®—æ³•&lt;/h2>
&lt;p>å‰›æ‰æåˆ°ï¼Œé›»è…¦ä¸»è¦åŠŸèƒ½æ˜¯åœ¨æ–¼è§£æ±ºå•é¡Œ&lt;/p>
&lt;p>input -&amp;gt; [ algorithm ] -&amp;gt; output&lt;/p>
&lt;p>ä¸­é–“çš„é‹ç®—éç¨‹ç¨±ä¹‹ç‚º &lt;code>æ¼”ç®—æ³• algorithm&lt;/code>&lt;/p>
&lt;h3 id="é›»è©±ç°¿æ‰¾äºº">é›»è©±ç°¿æ‰¾äºº&lt;/h3>
&lt;p>ä»Šå¤©æ¡Œä¸Šæœ‰ä¸€æœ¬é›»è©±ç°¿ï¼Œè£¡é¢æŒ‰ç…§è‹±æ–‡å­—æ¯é †åºæ’åˆ—ï¼Œå¸Œæœ›å¯ä»¥æ‰¾åˆ°ã€ŒMike Smithã€çš„é›»è©±è™Ÿç¢¼ï¼Œæ­¤æ™‚æˆ‘å€‘å¯ä»¥æ€éº¼åš?&lt;/p>
&lt;ol>
&lt;li>å¾ç¬¬ä¸€é ï¼Œä¸€å€‹ä¸€å€‹æŸ¥é–±ï¼Œä½†é€™æœƒéå¸¸èŠ±æ™‚é–“ï¼Œå°¤å…¶æ˜¯é›»è©±ç°¿å¦‚æ­¤å¤§ä¸€æœ¬&lt;/li>
&lt;li>å…©é å…©é ç¿»ï¼Œå¦‚æœç¿»åˆ°éé ­å°±åœ¨å¾€å›ç¿»ä¸€é ï¼Œé€™å€‹åšæ³•æœƒæ¯”ç¬¬ä¸€å€‹çœä¸‹ä¸€åŠçš„æ™‚é–“&lt;/li>
&lt;li>ç›´æ¥ç¿»åˆ°é›»è©±ç°¿çš„ä¸­é–“ï¼Œå¦‚æœç›®æ¨™çš„è‹±æ–‡å­—æ¯é †åºåœ¨å¾ŒåŠæ®µï¼Œæˆ‘åªè¦ç¿»å¾ŒåŠæ®µçš„é›»è©±ç°¿å°±å¥½ï¼Œå¦ä¸€åŠç›´æ¥ä¸Ÿæ‰ï¼Œåè¦†é€™å€‹éç¨‹ï¼Œå°±å¯ä»¥éå¸¸å¿«æ‰¾åˆ°ï¼›&lt;br>
é€™ä¹Ÿå°±æ˜¯ &lt;code>äºŒå…ƒæœå°‹æ³• Binary Search&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>åœ¨é›»è…¦ç§‘å­¸ä¸­ï¼Œé€šå¸¸æˆ‘å€‘æœƒèªªç¬¬ä¸€ç¨®æ˜¯æš´åŠ›è§£ï¼Œå°±æ˜¯ç”¨æœ€ç›´è§€æœ€åŸå§‹çš„æ–¹å¼è§£æ±ºå•é¡Œï¼›&lt;br>
ä½†é€šå¸¸é€™æ¨£æš´åŠ›è§£æ•ˆç‡éƒ½ä¸é«˜ï¼Œæœƒé–‹å§‹é€æ­¥å„ªåŒ–ï¼Œå„ªåŒ–æœ‰å¾ˆå¤§çš„æ–¹å‘æ˜¯ æ‹†åˆ†æ“Šç ´ devide and conquerï¼Œå°‡å¤§å•é¡Œæ‹†è§£æˆå°å•é¡Œï¼Œä¸¦é€éæŒçºŒè§£æ±ºå°å•é¡Œå°±å¯ä»¥å¾—åˆ°æœ€å¾Œçš„ç­”æ¡ˆï¼›&lt;br>
ä¾‹å¦‚èª¬ç¿»é›»è©±ç°¿ï¼Œæˆ‘å…ˆå¾ä¸­é–“å°åˆ‡ï¼Œå•é¡Œé‡(éœ€è¦æŸ¥é–±çš„é›»è©±æ•¸)å°±å‰©ä¸€åŠäº†ï¼Œå†æŒçºŒå°åˆ‡ï¼Œå•é¡Œè¶Šä¾†è¶Šå°ï¼Œç›´åˆ°æ‰¾å‡ºç­”æ¡ˆã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__81ZsjuMeugzMJ__FevljI6Q.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>æˆ‘å€‘å¯ä»¥ç”¨æ•¸å­¸å‡½å¼åœ–å½¢è¡¨é”æ¼”ç®—æ³•çš„æ•ˆç‡ï¼Œx è»¸ä»£è¡¨å•é¡Œéœ€è¦èŠ±è²»çš„æ­¥é©Ÿï¼Œè€Œyè»¸ä»£è¡¨å•é¡Œçš„æ•¸é‡&lt;/p>
&lt;p>ä»¥é›»è©±ç°¿æ‰¾äººç‚ºä¾‹ï¼Œyè»¸ä»£è¡¨çš„æ˜¯é›»è©±ç°¿çš„åšåº¦ï¼Œxè»¸çš„è©±èˆ‰ç¬¬ä¸€ç¨®æ¼”ç®—æ³•ä¾†èªªï¼Œä»£è¡¨èª¬é›»è©±ç°¿å¤šåšï¼Œæ¼”ç®—æ³•å°±éœ€è¦ç¿»é–±å¤šå°‘é æ‰èƒ½è§£æ±ºå•é¡Œã€‚&lt;/p>
&lt;p>é€™é‚Šåƒ…ç°¡ç•¥å¸¶å‡º &lt;code>æ¼”ç®—æ³•è¤‡é›œåº¦&lt;/code>çš„æ¦‚å¿µ&lt;/p>
&lt;h3 id="pseudocode">Pseudocode&lt;/h3>
&lt;p>å‰›æ‰ä¸‰ç¨®æ¼”ç®—æ³•éƒ½æœ‰ä¸€å€‹è§£æ±ºå•é¡Œçš„æµç¨‹ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ å½ä»£ç¢¼ pseudocode ï¼Œç”¨ä¸€ç¨®é¡ä¼¼æ–¼è‰ç¨¿çš„æ¦‚å¿µï¼Œè¡¨é”æˆ‘å€‘å¯¦éš›è§£æ±ºå•é¡Œæ­¥é©Ÿã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__jAr7t8OHeAlqCM50__nFGHQ.jpeg"
loading="lazy"
alt="åœ–ç‰‡å‡ºè‡ªæ–¼å½±ç‰‡å…§å®¹"
>
åœ–ç‰‡å‡ºè‡ªæ–¼å½±ç‰‡å…§å®¹&lt;/p>
&lt;p>é€™è£¡å¯ä»¥ç´°æ‹†æˆå››å€‹éƒ¨åˆ†&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Functionï¼š&lt;/strong>
ä»£è¡¨æŸç¨®å‹•ä½œ pick up / open / look / call / quit&lt;/li>
&lt;li>&lt;strong>Condition&lt;/strong>
åˆ¤æ–·æ©Ÿåˆ¶ if / else if&lt;/li>
&lt;li>&lt;strong>Boolean Expression&lt;/strong>
å¯¦éš›åˆ¤æ–·çš„æ¢ä»¶ if Smith is earlier in book&lt;/li>
&lt;li>&lt;strong>Loop&lt;/strong>
æŒçºŒçš„åšæŸä»¶äº‹ go back to step 2&lt;/li>
&lt;li>&lt;strong>Variable&lt;/strong>
æš«å­˜çµæœçš„è®Šæ•¸&lt;/li>
&lt;li>&lt;strong>Thread&lt;/strong> (é€²éš)
å¤šå·¥è™•ç†&lt;/li>
&lt;li>&lt;strong>Events&lt;/strong> (é€²éš)
äº‹ä»¶è§¸ç™¼&lt;/li>
&lt;/ol>
&lt;h3 id="lets-write-somescratch">Letâ€™s Write SomeÂ Scratch!&lt;/h3>
&lt;p>&lt;a class="link" href="https://scratch.mit.edu/" target="_blank" rel="noopener"
>&lt;strong>Scratch - Imagine, Program, Share&lt;/strong>&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://scratch.mit.edu/" target="_blank" rel="noopener"
>Scratch&lt;/a> æ˜¯ MIT é–‹æºçš„ä¸€å¥—ç”¨åœ–å½¢ä»‹é¢ç¨‹å¼èªè¨€ç·¨è¼¯å™¨ï¼Œé€éæ‹–æ‹‰çš„æ–¹å¼ï¼Œç”¨æœ€ç°¡å–®çš„æ–¹å¼å°±å¯ä»¥å¯«ç¨‹å¼ï¼Œçœ‹åˆ°æŸäº›ç¯„ä¾‹ï¼Œè¦ºå¾—åŠŸèƒ½å¾ˆå®Œæ•´ï¼Œèƒ½å¤ ç™¼æ®çš„ç©ºé–“ååˆ†çš„å¤§ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æŒ‘é¸å¹¾å€‹ç¯„ä¾‹åšèªªæ˜&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__kYKxqFpwUqp__wZv4PS5oSQ.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>Scratch è¨»å†Šå¾Œä¸»è¦æœ‰ä¸‰å€‹å€å¡Šï¼Œå³é‚Šçš„åŸ·è¡Œçµæœé ã€ä¸­é–“çš„ç¨‹å¼é‚è¼¯ã€å·¦é‚Šçš„ç¨‹å¼å…ƒä»¶ï¼Œè¨­è¨ˆçš„éƒ½ç›¸ç•¶ç›´è¦ºã€‚&lt;/p>
&lt;p>åœ¨é–‹å§‹ Scratch æ™‚ï¼Œéƒ½æœƒé€éç¶ è‰²çš„æ——å¹Ÿç¬¦è™Ÿé–‹å§‹ï¼Œæ‰€ä»¥ç¨‹å¼ç¢¼æœƒå…ˆæ”¾ä¸Šåœ–æ©˜è‰²å€å¡Šé–‹å§‹åŸ·è¡Œï¼Œå¾ŒçºŒä¾ç…§ç©æœ¨çš„é †åºï¼ŒåŸ·è¡Œä½ è¨­è¨ˆçš„æ¼”ç®—æ³•ï¼Œä¾‹å¦‚æœ€åŸºæœ¬çš„ã€Œ&lt;strong>Hello, World!&lt;/strong>ã€&lt;br>
&lt;strong>Hello, World!&lt;/strong> æ˜¯ç¨‹å¼ç•Œåœ¨å˜—è©¦æ–°äº‹ç‰©çš„ç¬¬ä¸€å€‹æ…£ä¾‹æ¸¬è©¦ï¼Œä¸»è¦æ˜¯å› ç‚ºæŸä½å¤§ç¥å¯«äº†ä¸€æœ¬éå¸¸çŸ¥åçš„æ›¸ï¼Œè£¡é ­çš„ç¬¬ä¸€å€‹ç¯„ä¾‹å°±æ˜¯ &lt;strong>Hello, World!&lt;/strong> ï¼Œå¾ŒçºŒå°±æ¼”è®Šæˆä¸€ç¨®æ–‡åŒ–ã€‚&lt;/p>
&lt;h3 id="loop">Loop&lt;/h3>
&lt;p>æˆ‘å¸Œæœ›ç™¼å‡ºå–µè²4æ¬¡ï¼Œä¸­é–“ç›¸éš”ä¸€ç§’é˜ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹æœ‰å…©ç¨®å¯«æ³•&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__p1aWvQIr6X837aoHFya9Ag.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å·¦é‚Šæ˜¯å¾ˆç›´è¦ºçš„å¯«æ³•ï¼Œæˆ‘è¦ Meow å››æ¬¡æˆ‘å°±è¤‡è£½è²¼ä¸Šå››æ¬¡ï¼Œä½†é€™æ¨£æœ€å¤§çš„ç¼ºé»æ˜¯å¦‚æœè¦åæ¬¡åŒæ¨£çš„äº‹æƒ…å°±è¦åšåæ¬¡â€¦. ï¼Œåˆæˆ–æ˜¯æˆ‘æƒ³è¦è®Šæˆ Woofï¼Œå°±éœ€è¦æ”¹åæ¬¡ï¼›&lt;br>
é‡åˆ°é‡è¤‡åšæŸä»¶äº‹æ•¸æ¬¡ï¼Œå¯ä»¥æ”¹ç”¨ Loop çš„æ¦‚å¿µï¼Œè®“ç¨‹å¼è‡ªå‹•é‡è¤‡è€Œä¸ç”¨ä¸€å€‹ä¸€å€‹çš„è‡ªå·±æ‰‹å‹•ä½œã€‚&lt;/p>
&lt;blockquote>
&lt;p>Donâ€™t Repeat Yourself (DIY)&lt;/p>
&lt;/blockquote>
&lt;p>æ˜¯å¯«ç¨‹å¼ä¸€å€‹å¾ˆé‡è¦çš„åŸå‰‡ã€‚&lt;/p>
&lt;h3 id="condition">Condition&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__xHuIqELRQGhnTYcPZNM2mA.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>é€™è£¡æˆ‘å¯«çš„é‚è¼¯æ˜¯&lt;br>
å®šç¾©ä¸€å€‹è®Šæ•¸ counterï¼Œåœ¨é–‹å§‹åŸ·è¡Œå¾Œå°‡ counter è¨­ç‚º 0ï¼Œæ¥è‘—ç•¶æ¯æ¬¡æŒ‰ä¸‹ Space å¾Œï¼Œé¡¯ç¤º counter æ•¸å€¼ï¼Œæ¥è‘—å°‡ counter æ¯æ¬¡éƒ½åŠ  1ï¼›&lt;br>
å¦‚æœç›®å‰ counter &amp;gt; 10ï¼Œå°±ä¸è¦ç™¼å‡ºè²éŸ³ï¼Œåä¹‹ Meow ä¸€è²ã€‚&lt;/p>
&lt;h3 id="function">Function&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__ZEo__nMMsGrlEQt8VJvD8wg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>é¡ä¼¼æ–¼ä¸Šé¢çš„äº‹æƒ…ï¼Œä½†æˆ‘é€™æ™‚å€™å¸Œæœ›å¯ä»¥ç›®å‰ counter å¤šå°‘å°± meow å¹¾æ¬¡ï¼Œæ­¤æ™‚æˆ‘å€‘éœ€è¦ Function çš„å¹«å¿™ï¼›&lt;br>
å…ˆå®šç¾©ä¸€å€‹è‡ªå·±å®¢è£½çš„ Blockï¼Œé€™å€‹ Function çš„å…§å®¹å°±æ˜¯ Repeat Meow æ•¸æ¬¡ï¼Œæ¬¡æ•¸ç”±åƒæ•¸ n æ±ºå®šã€‚&lt;/p>
&lt;p>ç•¶ç„¶ä¹Ÿå¯ä»¥ç›´æ¥æŠŠ repeat é‚£ä¸€æ•´æ®µç›´æ¥å¡åˆ° else ç•¶ä¸­ï¼Œä½†æ˜¯Function çš„å¥½è™•æ˜¯å¯ä»¥å°‡æŸäº›è¡Œç‚ºå¾ç¨‹å¼ç¢¼ä¸­æŠ½å–å‡ºä¾†ï¼Œé€™æ¨£å¯ä»¥è®“ç¨‹å¼ç¢¼æ›´å¥½ç†è§£ï¼Œé–±è®€åˆ° MeowManyTimes å¯ä»¥å¾å­—é¢ä¸Šçš„æ„æ€å¾ˆç›´è¦ºæƒ³åˆ°é€™æ˜¯è·Ÿç™¼å‡º Meow æœ‰é—œã€‚&lt;/p></description></item><item><title>AWS-CDKæ•™å­¸â€Šâ€”â€ŠInfrastructore As Code ç”¨ç¨‹å¼ç¢¼ç®¡ç†æ¶æ§‹</title><link>https://yuanchieh.page/posts/2019/2019-01-27-aws-cdk%E6%95%99%E5%AD%B8-infrastructore-as-code-%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E7%AE%A1%E7%90%86%E6%9E%B6%E6%A7%8B/</link><pubDate>Sun, 27 Jan 2019 03:29:50 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-01-27-aws-cdk%E6%95%99%E5%AD%B8-infrastructore-as-code-%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%A2%BC%E7%AE%A1%E7%90%86%E6%9E%B6%E6%A7%8B/</guid><description>&lt;p>æœ€è¿‘é™¸é™¸çºŒçºŒåœ¨çœ‹ AWS re:invent 2018 çš„å½±ç‰‡ï¼Œä¸»è¦å°ˆæ³¨æ–¼ CI/CDéƒ¨åˆ†ï¼Œä¸å¾—ä¸èªªçœ‹å®ŒçœŸçš„æ˜¯éå¸¸æŒ¯å¥®äººå¿ƒå•Šï¼&lt;/p>
&lt;p>ä»¥å¾€åœ¨åšæ¶æ§‹è¨­è¨ˆï¼Œå¯èƒ½æ˜¯å…ˆç•«å€‹æ¶æ§‹åœ–ï¼Œæ¥è‘—æ‰“é–‹ç¶²é ç™»å…¥ AWS Consoleï¼Œçœ‹è¦é–‹å¹¾å° EC2 ã€VPC æ¶æ§‹ã€ ALB è¨­å®šã€CDN è¨­å®šã€é–‹ S3 Bucket ç­‰ç­‰ï¼ŒåŸºæœ¬ä¸Šå¤§å¤šçš„äº‹æƒ…éƒ½æ˜¯é€éç¶²é å®Œæˆï¼Œæˆ–æ˜¯ä½¿ç”¨ Command Line Tool å®Œæˆï¼›&lt;br>
ä½†é€™æ¨£çš„ç¼ºé»æ˜¯å¦‚æœå…¬å¸çªç„¶æƒ³è¦é‡å»ºä¸€ä»½åŒæ¨£çš„æ¶æ§‹ç•¶ä½œ staging ç’°å¢ƒï¼Œåˆæˆ–æ˜¯å¾€å¾Œéœ€è¦æ”¹å‹•æ¶æ§‹ï¼Œæ­¤æ™‚å¿…é ˆè‡ªå·±åŒæ­¥æ–‡ä»¶ã€ä¿®æ”¹æ¶æ§‹åœ–ç­‰ç­‰ï¼Œåœ¨ç®¡ç†ä¸Šæœ‰ç›¸ç•¶å¤šä¸æ–¹ä¾¿çš„åœ°æ–¹ã€‚&lt;/p>
&lt;h2 id="ç‚ºä»€éº¼ä¸ç”¨ç¨‹å¼ç¢¼ä¾†ç®¡ç†">ç‚ºä»€éº¼ä¸ç”¨ç¨‹å¼ç¢¼ä¾†ç®¡ç†&lt;/h2>
&lt;p>é€™ä¹Ÿå°±æ˜¯é€™ç¯‡è¦åˆ†äº«çš„æ–¹æ³•ï¼Œä½¿ç”¨ AWS-CDKï¼ŒAWS-CDK æ˜¯ä¸€å€‹ nodejs çš„ packageï¼Œå®‰è£å¾Œç•¶ä½œ cli tool ä½¿ç”¨ï¼›&lt;br>
åœ¨ AWS-CDK ä¸‹æä¾›å„å€‹ AWS æ—¢æœ‰æœå‹™çš„å¥—ä»¶(å¦‚ lambda ã€ S3 ç­‰)ï¼Œç›®å‰æä¾› C#ã€Javascriptã€Typescriptã€Javaï¼Œé–‹ç™¼æ™‚å¼•å…¥é€™äº›å¥—ä»¶å°±å¯ä»¥ä½¿ç”¨äº†ã€‚&lt;/p>
&lt;p>é€éç¨‹å¼ç¢¼ç®¡ç†ï¼Œæˆ‘è¦ºå¾—æœ‰å¹¾å€‹å¥½è™•&lt;/p>
&lt;ol>
&lt;li>æ›´å¥½çš„å°è£èˆ‡çµæ§‹&lt;br>
å¦‚æœæ˜¯ç”¨ç¶²é åšè¨­å®šï¼ŒåŸºæœ¬ä¸Šè¡Œç‚ºåªèƒ½é€éæ–‡ä»¶ä¾†æºé€šï¼Œå¦‚æœæ˜¯ç”¨ shell script æˆ–è¨±ä¹Ÿå¯ä»¥åšåˆ°ä¸€éƒ¨åˆ†çš„è‡ªå‹•åŒ–ï¼Œä½†æ•´é«”ç†è§£ä¸Šé‚„æœ‰è »å¤šä¸æ–¹ä¾¿ä¹‹è™•ï¼Œæ›´åˆ¥èªªç¶­è­·çš„äººå¯«æ³•å¯èƒ½ä¸åŒï¼Œé€ æˆç¶­è­·çš„å›°é›£ï¼›&lt;br>
ä½¿ç”¨ AWS-CDKï¼Œä»–æœ¬èº«æ˜¯ç”¨ OO çš„æ¦‚å¿µå°è£æ—¢æœ‰çš„ AWS æœå‹™ï¼Œå®˜æ–¹ä¹Ÿæœ‰æä¾›å·¥å…·å¹«åŠ©åˆå§‹å°ˆæ¡ˆï¼Œä¹Ÿçµ¦äºˆä¸€å®šçš„ç¨‹å¼ç¢¼æ¶æ§‹å»ºè­°ï¼Œå¾Œäººæ¥æ‰‹ä¸€å®šæœƒå¥½ç†è§£éå¸¸å¤š&lt;/li>
&lt;li>ç‰ˆæœ¬æ§åˆ¶&lt;br>
éš¨è‘—å…¬å¸ç™¼å±•ï¼Œå¯èƒ½æœƒæ›´å‹•æ¶æ§‹ï¼Œé€éä»£ç¢¼ç®¡ç†å·¥å…·å¯ä»¥å”åŠ©è‰¯å¥½ç®¡ç†æ¶æ§‹çš„æ¼”é€²ï¼ŒRollback ä¹Ÿå¯ä»¥æœ‰ä¾æ“š (ä¾‹å¦‚è²»ç”¨çˆ†æ‰çš„æ™‚å€™â€¦)&lt;/li>
&lt;li>è·¨å€åŸŸéƒ¨ç½²&lt;br>
å¦‚æœä½ æƒ³è¦è·¨å€åŸŸéƒ¨ç½²åŒæ¨£çš„æ¶æ§‹ï¼Œç”¨ç¶²é æ“ä½œæ‡‰è©²æœƒéå¸¸é ­ç—›ï¼Œè€Œä¸”å®¹æ˜“å‡ºç¾äººå·¥éŒ¯èª¤ï¼›&lt;br>
ç”¨ç¨‹å¼ç¢¼å°±æ˜¯å¤šä¸€è¡ŒæŒ‡å®šå€åŸŸï¼Œ DONE!&lt;/li>
&lt;/ol>
&lt;p>AWS-CDK åº•å±¤å…¶å¯¦æ˜¯å°‡ç¨‹å¼ç¢¼è½‰æˆ Cloud Formationï¼ŒAWS è‡ªå®šç¾©çš„æœå‹™å®šç¾©èªæ³•ï¼Œå¯ä»¥ç†è§£æˆ AWSæœå‹™çš„ Assembly Codeã€‚&lt;/p>
&lt;blockquote>
&lt;p>ï¼ŠWARNINGï¼šç›®å‰ç™¼æ–‡æ™‚é–“ 2019/01/27 é‚„&lt;strong>ä¸å»ºè­°ä½¿ç”¨æ–¼æ­£å¼ç’°å¢ƒ&lt;/strong>ï¼Œä½†å› ç‚ºä»–åº•å±¤æ˜¯è½‰æˆ Cloud Formationï¼Œç†è«–ä¸Šè½‰æ›ä¸å‡ºéŒ¯æ‡‰è©²å°±è »ç©©çš„ï¼Œç›®å‰æ¸¬è©¦å°šæœªé‡åˆ° Bug&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨é–‹å§‹ Codingä¹‹å‰ï¼Œå»ºè­°ä½¿ç”¨ AWS-CDK ä¹‹å‰è¦å…ˆç†Ÿæ‚‰ AWS æœå‹™ï¼Œä¾‹å¦‚ä½ æƒ³ä¸² Lambda å»ºè­°å…ˆè‡³å°‘çœ‹éæ–‡ä»¶ã€ç”¨ç¶²é ç‰ˆå®Œæ•´æ“ä½œéä¸€æ¬¡ï¼Œå› ç‚ºæœ‰å¾ˆå¤šåƒæ•¸å¯¦éš›ç”¨éæ‰çŸ¥é“æ€éº¼å¡«å¯«ï¼Œç›®å‰å®˜æ–¹ç¶²ç«™æœ‰è‰¯å¥½çš„æ–‡ä»¶ï¼Œä½†é€™äº›æ–‡ä»¶åƒ…é™æ–¼åƒæ•¸èªªæ˜ï¼Œå¦‚æœæ²’å¯¦éš›ç”¨éä¸æœƒçŸ¥é“åƒæ•¸è¨­å®šå¾Œçš„å¯¦è³ªæ„ç¾©èˆ‡ç”¨é€”ï¼›&lt;br>
å¦å¤–ç›®å‰æˆ‘æŸ¥äº†ä¸€ä¸‹æ²’æœ‰å¤ªå¤šå¯¦æˆ°åˆ†äº«ï¼Œåªæœ‰ä¸€äº›åŸºæœ¬çš„ä¸²æ¥èˆ‡æ“ä½œï¼Œæ‰€ä»¥åœ¨æœå‹™é–“çš„ä¸²æ¥è »å¤šæ˜¯ Try-And-Error ç©å‡ºä¾†çš„ï¼Œä¹Ÿæ˜¯æˆ‘æƒ³å¯«é€™ç¯‡æ–‡ç« çš„ç›®çš„ï¼Œå¹«åŠ©å¤§å®¶ä¸Šæ‰‹ã€‚&lt;/p>
&lt;p>æœ¬ç¯‡æ¯”è¼ƒé©åˆå·²ç¶“åœ¨ä½¿ç”¨ AWS æœå‹™ä¸€æ®µæ™‚é–“ï¼Œå¸Œæœ›å¯ä»¥ç”¨æ›´å¥½æ–¹å¼ç®¡ç†æ¶æ§‹çš„å·¥ç¨‹å¸«ï¼›&lt;br>
å¾ŒçºŒæœƒä½¿ç”¨ Typescript ç•¶ä½œç¯„ä¾‹ï¼Œä¸éæ¦‚å¿µéƒ½æ˜¯ä¸€æ¨£çš„ã€‚&lt;/p>
&lt;p>æœ€å¾Œå†æ¬¡æé†’ï¼Œå› ç‚ºé‚„åœ¨ pre-release éšæ®µï¼Œå¦‚æœä½ ç™¼ç¾ä»¥ä¸‹ç¨‹å¼ç¢¼æœ‰èª¤æˆ–ç„¡æ³•åŸ·è¡Œï¼Œç…©è«‹ç•™è¨€ã€‚&lt;/p>
&lt;h3 id="å®‰è£-aws-cdkèˆ‡å°ˆæ¡ˆåˆå§‹åŒ–">å®‰è£ AWS-CDKÂ èˆ‡å°ˆæ¡ˆåˆå§‹åŒ–&lt;/h3>
&lt;p>&lt;a class="link" href="https://cdkworkshop.com/15-prerequisites.html" target="_blank" rel="noopener"
>&lt;strong>cdkworkshop.com&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹ç¢ºä¿å®Œæˆå®˜ç¶²çš„ prerequest æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>å®‰è£äº† aws-cli&lt;/li>
&lt;li>å®Œæˆ iam role è¨­å®šï¼Œå¯¦é©—æ€§è³ªå…ˆé–‹ admin æ¬Šé™æ¯”è¼ƒæ–¹ä¾¿&lt;/li>
&lt;li>å®Œæˆ aws configure&lt;/li>
&lt;li>å®‰è£ Nodejs v8.12 ä»¥ä¸Š&lt;/li>
&lt;li>å®‰è£ aws-cdkï¼Œ &lt;code>npm install -g aws-cdk@0.22.0&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>aws-cdk ä¸»è¦æä¾›å¹¾å€‹æŒ‡ä»¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">// ç”¨æ–¼åˆå§‹åŒ–å°ˆæ¡ˆï¼Œå¯ä»¥æŒ‡å®šèªè¨€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cdk init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„ stack &lt;span class="o">(&lt;/span>å¾ŒçºŒä»‹ç´¹ä»€éº¼æ˜¯ stack&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cdk ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æŸ¥çœ‹ç›®å‰ç¨‹å¼ç¢¼è½‰æ›çš„ cloud formation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cdk synth
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// æŸ¥çœ‹ç›®å‰æ¶æ§‹çš„è®Šå‹•
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cdk diff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// éƒ¨ç½²
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cdk deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// åˆå§‹åŒ–ç’°å¢ƒ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cdk bootstrap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›®å‰æˆ‘ç¿’æ…£ä½¿ç”¨ Typescript é–‹ç™¼ï¼Œæ­é… VSCode æœ‰é€£å¥½çš„è‡ªå‹•æç¤ºéå¸¸æ–¹ä¾¿ã€‚&lt;/p>
&lt;h3 id="å¯¦æˆ°éƒ¨ç½²-scheduled-event-è§¸ç™¼lambda">å¯¦æˆ°ï¼šéƒ¨ç½² Scheduled Event è§¸ç™¼Â Lambda&lt;/h3>
&lt;p>Letâ€™s write some code~Â &lt;br>
é€™æ¬¡åšä¸€å€‹éƒ¨ç½²åˆ°å¤šå€‹å€åŸŸï¼Œå®šæœŸ 2 åˆ†é˜å»æ‰“ &lt;a class="link" href="https://www.president.gov.tw/" target="_blank" rel="noopener"
>https://www.president.gov.tw/&lt;/a> çœ‹å°ç£ç¸½çµ±åºœé é¢åœ¨å…¨çƒçš„ç¶²é å›æ‡‰é€Ÿåº¦ï¼Œæ¥è‘—ç™¼è¨Šæ¯åˆ° slack é »é“ã€‚&lt;/p>
&lt;p>åˆ°å°ˆæ¡ˆç›®éŒ„ä¸‹ï¼ŒåŸ·è¡Œ &lt;code>&amp;gt; cdk init appâ€Šâ€”â€Šlanguage=typescript&lt;/code>&lt;/p>
&lt;p>æ¥è‘—åŒå€‹ç›®éŒ„ä¸‹ï¼Œæˆ‘å€‘éœ€è¦é–‹å…©å€‹ shellï¼Œä¸€å€‹ shell åŸ·è¡Œ &lt;code>&amp;gt; npm run watch&lt;/code> ï¼Œä¸»è¦æ˜¯ç‚ºäº†è‡ªå‹•è½‰è­¯ typescript æˆ javascript æ‰å¯ä»¥è®“ nodejs åŸ·è¡Œï¼›&lt;br>
å¦ä¸€å€‹ shell ç”¨ä¾†åŸ·è¡Œå¾ŒçºŒçš„ cmdã€‚&lt;/p>
&lt;p>åœ¨ç›®éŒ„ä¸‹æœƒæœ‰å¸¸è¦‹çš„ nodejs å°ˆæ¡ˆæª”æ¡ˆï¼Œæœ‰å…©å€‹è³‡æ–™å¤¾æ¯”è¼ƒé‡è¦ /bin ã€ /libï¼›&lt;/p>
&lt;p>&lt;code>/lib&lt;/code> ä¸»è¦æ˜¯æ”¾æ¶æ§‹å®šç¾©ï¼Œåˆå§‹åŒ–ä¹‹å¾Œæœƒæœ‰ä¸€å€‹ aws-cdk-stack.tsï¼Œåœ¨ AWS-CDKä¸­ï¼Œ &lt;code>stack&lt;/code> ä»£è¡¨çš„å°±æ˜¯ä¸€å€‹æ¶æ§‹çš„ classï¼Œä¾‹å¦‚èªªç›®å‰è¦è¨­è¨ˆçš„æ¶æ§‹å°±æ˜¯ (scheduled event + lambda)ï¼Œé€™å°±æ˜¯ä¸€å€‹å°å‹çš„æ¶æ§‹ï¼›&lt;br>
å¾ŒçºŒå¯ä»¥è®“å°æ¶æ§‹çµ„åˆæˆå¤§æ¶æ§‹ï¼Œå°±çœ‹éœ€æ±‚æ±ºå®šå¦‚ä½•å°è£ã€‚&lt;/p>
&lt;p>&lt;code>/bin&lt;/code> ä¸»è¦æ˜¯æ”¾ &lt;code>app&lt;/code>ï¼Œä¹Ÿå°±æ˜¯æœ€çµ‚æ¶æ§‹çš„æª”æ¡ˆï¼Œä¸»è¦æ˜¯æ•´åˆStack åˆå§‹åŒ–èˆ‡éƒ¨å±¬çš„æ–¹å¼ï¼Œå®šç¾©åœ¨ aws-cdk.ts ä¹‹ä¸­ã€‚&lt;/p>
&lt;h4 id="aws-cdk-stackts">aws-cdk-stack.ts&lt;/h4>
&lt;p>æ˜¯ä¸æ˜¯æ¯”æƒ³åƒä¸­çš„æ¸…æ™°ç°¡å–®å•Šï¼Œè¼‰å…¥å°æ‡‰æ¨¡çµ„å®£å‘Šå³å¯ï¼Œè€Œä¸” lambda å¯ä»¥åƒç…§æœ¬åœ°ç«¯çš„è³‡æ–™å¤¾ï¼Œè‡ªå‹•å¹«å¿™æ‰“åŒ…èˆ‡éƒ¨ç½²è¶…æ–¹ä¾¿çš„ï¼›&lt;br>
å¦å¤– aws-cdk æ–‡ä»¶ä¸€å€‹å¥½è™•æ˜¯éƒ½æœ‰æŠŠå°æ‡‰çš„åƒæ•¸æ–‡ä»¶å°ç…§å¥½ï¼Œæ‰€ä»¥æŸ¥èµ·ä¾†è »å¿«çš„ï¼Œä½†æ˜¯åƒæ•¸é‡éå¸¸å¤§Â â€¦..&lt;/p>
&lt;p>Stack åœ¨åˆå§‹åŒ–éœ€è¦ç¶å®šæ˜¯åœ¨å“ªå€‹ appä¸‹ï¼Œä»¥åŠç¨ç«‹çš„ IDï¼Œé€™å¾ŒçºŒæœƒå†ç¶²é ä¸­çœ‹åˆ°ã€‚&lt;/p>
&lt;h4 id="aws-cdkts">aws-cdk.ts&lt;/h4>
&lt;p>åŸºæœ¬ä¸Šå°±æ˜¯åˆå§‹åŒ– Stack ä¸¦å®šç¾©éƒ¨ç½²çš„å€åŸŸï¼Œå¦å¤–çš„ lambda èˆ‡ slack å°±çœ‹ git repo åƒè€ƒï¼Œä¸å†è´…è¿°ã€‚&lt;/p>
&lt;p>ç¨‹å¼ç¢¼å®Œæˆå¾Œï¼ŒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>æª¢æŸ¥&lt;br>
Â &lt;code>&amp;gt; cdk list&lt;/code> æŸ¥çœ‹Appä¸‹çš„æ‰€æœ‰ Stackï¼Œæ¥è‘—é‡å°å„å€‹ stack ä¸‹ &lt;code>&amp;gt; cdk synth AwsCdkStack2&lt;/code> ï¼Œå¤§æ¦‚æª¢æŸ¥æœ‰æ²’æœ‰ error èˆ‡ cloud formation å®šç¾©ã€‚&lt;/li>
&lt;li>éƒ¨ç½²&lt;br>
Â &lt;code>&amp;gt; cdk deploy&lt;/code>Â &lt;br>
å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œä»–å¯èƒ½æœƒè·³å‡ºéœ€è¦åŸ·è¡Œ &lt;code>&amp;gt;cdk bootstrap {å°ˆæ¡ˆid/region}&lt;/code> çš„éŒ¯èª¤ï¼Œå…¶ä»–çš„è©±å°±ç­‰ä»–æ…¢æ…¢éƒ¨ç½²ï¼›&lt;/li>
&lt;/ol>
&lt;p>cdk éƒ¨ç½²æ™‚æœ‰è‰¯å¥½çš„æ‰“å°è¨Šæ¯ï¼Œæœ€æ£’çš„æ˜¯ cdk æœƒè‡ªå‹•è™•ç† aws æœå‹™ iam role çš„æ¬Šé™ï¼Œå¦‚æœæœ‰è™•ç†éæ¬Šé™è¨­å®šå°±çŸ¥é“é€™éå¸¸çš„é ­ç—› XDÂ &lt;br>
å› ç‚º AWS æœå‹™åˆ‡å¤ªç´°äº†ï¼Œå¥½è™•æ˜¯å¯è¨­å®šçš„éå¸¸ç²¾æº–ï¼Œä½†ç¼ºé»å°±æ˜¯æŸ¥æ‰¾èµ·ä¾†å¾ˆé ­ç—›ï¼Œé€šå¸¸éƒ½è¦è·‘å€‹å¹¾æ¬¡çœ‹éŒ¯èª¤log è£œæ¬Šé™ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç¶²é èˆ‡ Slack å›æ‡‰çš„æˆªåœ–&lt;/p>
&lt;p>lambda&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__mn7RZtoPWTy33Xo9S1TdJg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>Slack è¨Šæ¯ï¼Œçœ‹ä¾†æ­æ´²å›æ‡‰æ™‚é–“æœ€é•·ï¼Œæ±åŒ—äºæœ€å¿«ï¼Œçµæœæ˜¯ä¹Ÿä¸å¤ªæ„å¤– XD&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__JQxsYZQ2OaTEoMSo3tbhMA.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>æœ€å¾Œé™„ä¸Šå®Œæ•´å°ˆæ¡ˆçš„ github&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/aws-cdk-demo" target="_blank" rel="noopener"
>&lt;strong>sj82516/aws-cdk-demo&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="åˆªé™¤-stack">åˆªé™¤ Stack&lt;/h2>
&lt;p>å‡è¨­æˆ‘æƒ³è¦ç§»é™¤ç¾è¥¿çš„éƒ¨ç½²ï¼Œ&lt;strong>&lt;em>ä¸è¦ç›´æ¥å¾ç¨‹å¼ç¢¼åˆªé™¤Stack é‡æ–° deploy&lt;/em>&lt;/strong> ï¼Œæˆ‘å¯¦æ¸¬çš„çµæœé€™æ¨£æ˜¯ä¸æœƒå¹«ä½ æŠŠæ±è¥¿åˆªæ‰çš„ï¼Œè¦æ”¹ç”¨ä»¥ä¸‹æ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>&lt;code>&amp;gt; cdk destroy AwsCdkStack&lt;/code>&lt;/li>
&lt;li>æ¥è‘—æ‰å¾ç¨‹å¼ç¢¼åˆªé™¤&lt;/li>
&lt;/ol>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>åœ¨é›²ç«¯æœå‹™ä¸­ï¼ŒAWS ä¸å¾—ä¸èªªæ˜¯é€™å€‹è¡Œæ¥­çš„é ˜é ­ç¾Šï¼Œè€Œä¸”å°±æŠ€è¡“ä¸Šå€‹äººè¦ºå¾—é ˜å…ˆ GCP ä¸å°‘ï¼ŒåŸºç¤æœå‹™ä¸å¥½èªªï¼Œä½†æ˜¯åœ¨è·¨æœå‹™çš„æ•´åˆä¸Šï¼ŒAWS åšå¾—éå¸¸è‰¯å¥½ï¼Œé€™æˆ–è¨±æ‰æ˜¯ä¼æ¥­ç”¨ä¹æ‰€åœ¨ä¹çš„æœªä¾†ï¼Œæ•´å¥— solution è€Œä¸æ˜¯å–®å€‹å–®å€‹æœå‹™é‚„è¦è‡ªå·±æ…¢æ…¢æ•´ã€‚&lt;/p>
&lt;p>æœ‰äº† AWS-CDK è¦åˆ†äº«ã€é‡ç”¨æ¶æ§‹å°±æ¥µåº¦æ–¹ä¾¿ï¼Œä¹‹å¾Œå†ä¾†åšä¸€ç³»åˆ—åŸºæ–¼ AWS-CDK çš„ AWS æ¶æ§‹ç ”ç©¶èˆ‡åˆ†äº«ã€‚&lt;/p></description></item><item><title>å¦‚ä½•ç”¨è§£é™¤æˆæ¬Šæ”»æ“Šå¼·è¿«è£ç½®æ–·ç·š Wifi é€£ç·š</title><link>https://yuanchieh.page/posts/2019/2019-01-20-%E5%A6%82%E4%BD%95%E7%94%A8%E8%A7%A3%E9%99%A4%E6%8E%88%E6%AC%8A%E6%94%BB%E6%93%8A%E5%BC%B7%E8%BF%AB%E8%A3%9D%E7%BD%AE%E6%96%B7%E7%B7%9A-wifi-%E9%80%A3%E7%B7%9A/</link><pubDate>Sun, 20 Jan 2019 01:12:22 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-01-20-%E5%A6%82%E4%BD%95%E7%94%A8%E8%A7%A3%E9%99%A4%E6%8E%88%E6%AC%8A%E6%94%BB%E6%93%8A%E5%BC%B7%E8%BF%AB%E8%A3%9D%E7%BD%AE%E6%96%B7%E7%B7%9A-wifi-%E9%80%A3%E7%B7%9A/</guid><description>&lt;p>&lt;a class="link" href="https://hackernoon.com/forcing-a-device-to-disconnect-from-wifi-using-a-deauthentication-attack-f664b9940142" target="_blank" rel="noopener"
>&lt;strong>Forcing a device to disconnect from WiFi using a deauthentication attack&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å…§å®¹åƒè€ƒ @&lt;a class="link" href="https://hackernoon.com/@brandonskerritt" target="_blank" rel="noopener"
>Brandon Skerritt&lt;/a> çš„å‰µä½œï¼Œä»¥ä¸‹åƒ…ç‚ºå€‹äººè½‰è­¯æˆä¸­æ–‡ï¼ŒåŸ·è¡Œå¹³å°å¾ä½œè€…çš„ Kali Linux æ”¹ç‚º Macï¼Œç´€éŒ„ä¸€äº›åŸ·è¡Œçš„ç´°ç¯€ã€‚&lt;/p>
&lt;h3 id="ç·£ç”±">ç·£ç”±&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.itcodemonkey.com/article/4742.html" target="_blank" rel="noopener"
>https://www.itcodemonkey.com/article/4742.html&lt;/a>&lt;/p>
&lt;p>ç•¶ Suppliant(çµ‚ç«¯è£ç½®) å¸Œæœ›èˆ‡ AP å»ºç«‹ Wifi é€£ç·šæ™‚ï¼Œéœ€è¦ç¶“éå››æ¬¡ Handshakeï¼Œè€Œåœ¨ç¬¬ä¸‰æ¬¡äº¤æ¡æ™‚ Suppliant æœƒè¼¸å…¥ Wifiå¯†ç¢¼ï¼Œé€™å€‹ Wifi å¯†ç¢¼æœƒç¶“éåŠ å¯†ï¼Œå¦‚æœå¯†ç¢¼æ­£ç¢ºå‰‡æˆåŠŸå»ºç«‹é€£ç·šï¼Œåä¹‹å‰‡æ–·é–‹é€£ç·šã€‚&lt;/p>
&lt;p>è€Œ deauthentication attack åˆ©ç”¨é€™æ¨£çš„äº¤æ¡ç‰¹æ€§ï¼Œåœ¨ç¬¬ä¸‰æ­¥å‡è£æ˜¯ AP å›è¦†çµ¦ Supplianté©—è­‰éŒ¯èª¤ï¼Œå› æ­¤å¼·è¿«è£ç½®æ–·é–‹ Wifi é€£ç·šï¼Œé€™ä¸¦ä¸æ˜¯é€éä»€éº¼æ¼æ´æ”»æ“Šï¼Œè€Œæ˜¯ Wifi å‚³è¼¸å”å®šåŸæœ‰çš„æ©Ÿåˆ¶ã€‚&lt;/p>
&lt;p>é€™æ¨£çš„æ©Ÿåˆ¶ä½¿å¾— Wifi éå¸¸çš„ä¸å®‰å…¨ï¼Œdeauthentication attack å¯ä»¥ä¸­æ–·ä»»æ„è£ç½®çš„ Wifié€£ç·šï¼Œé€™å¾€å¾€åªæ˜¯æ”»æ“Šçš„ç¬¬ä¸€æ­¥ï¼›&lt;br>
ä¸€èˆ¬è£ç½® Wifi æ–·ç·šå¾Œï¼Œæœƒç”¨åŒæ¨£çš„å¯†ç¢¼å†æ¬¡å˜—è©¦èˆ‡ APå»ºç«‹é€£ç·šï¼Œè€Œæ­¤æ™‚ Wifi ç„¡ç·šé€šè¨Šçš„æ©Ÿåˆ¶ï¼Œæœƒä½¿å¾—ç›¸é„°çš„ç”¨æˆ¶ä¹Ÿå¯ä»¥å·è½åˆ°é€™äº›å°åŒ…ï¼Œé€²è€Œæ‹†è§£å°åŒ…ï¼Œå¾ä¸­æš´åŠ›ç ´è§£ AP çš„å¯†ç¢¼ï¼›&lt;br>
åˆæœƒæ˜¯é‚ªæƒ¡çš„ç”¨æˆ¶å½é€ ä¸€å€‹å‡çš„ APï¼Œå…¶ä»–äººä¸æ˜æ‰€ä»¥å°±å‚»å‚»çš„é€£ç·šï¼Œé€éç°¡å–®çš„é‡£é­šï¼Œå°±å¯ä»¥å®Œæˆ Middle man attackã€‚&lt;/p>
&lt;p>çœ‹ä¼¼é‚ªæƒ¡çš„å·¥å…·ï¼Œä½†ä¸è¦ç”¨åœ¨ç ´å£ä¹Ÿèƒ½ç”¨åœ¨è‡ªä¿ä¸Šï¼Œåœ¨ 2015 å¹´çˆ†å‡ºå¤šèµ· Airbnb é€é Wifi Cam å·çªºä½æˆ¶ï¼Œä½œè€…å¯«äº†ä¸€å€‹ script å¯ä»¥è‡ªå‹•æ–·é–‹æ‰€æœ‰çš„ Wifi Cam&lt;/p>
&lt;p>&lt;a class="link" href="https://julianoliver.com/output/log_2015-12-18_14-39" target="_blank" rel="noopener"
>&lt;strong>Detect and disconnect WiFi cameras in that AirBnB you&amp;rsquo;re staying in&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åŒä½œè€…é‚„å¯«äº†å¯ä»¥è‡ªå‹•æ–·é–‹ Google Glass çš„ Script&lt;/p>
&lt;p>&lt;a class="link" href="https://julianoliver.com/output/log_2014-05-30_20-52" target="_blank" rel="noopener"
>&lt;strong>Find a Google Glass and kick it from the network&lt;/strong>&lt;/a>&lt;/p>
&lt;h4 id="è­¦å‘Š">*è­¦å‘Š&lt;/h4>
&lt;p>é€™é …æœ‰åŠ›çš„å·¥å…·å¯ä»¥ç”¨ä¾†ä¿è­·å€‹äººéš±ç§ï¼Œä½†ä½œè€…ä¸é¼“å‹µç”¨æ–¼éæ³•æˆ–æ˜¯æƒ¡æ„çš„æ”»æ“Š!&lt;/p>
&lt;h3 id="deauthentication-attack">Deauthentication Attack&lt;/h3>
&lt;p>é¦–å…ˆè¦ç¢ºèªå…©ä»¶äº‹&lt;/p>
&lt;ol>
&lt;li>æº–å‚™è¦æ–·é–‹çš„è£ç½®&lt;/li>
&lt;li>è©²è£ç½®é€£çµçš„ Router&lt;/li>
&lt;/ol>
&lt;p>åŸæœ¬æ˜¯å¸Œæœ›æ‰¾åˆ°å°æ‡‰çš„ Cmd Tool åœ¨ Mac å¹³å°ä¸Šï¼Œä½†å¾Œä¾†åƒè€ƒæ­¤æ–‡ç« &lt;/p>
&lt;p>&lt;a class="link" href="https://louisabraham.github.io/articles/WPA-wifi-cracking-MBP.html" target="_blank" rel="noopener"
>&lt;strong>WPA wifi cracking on a MacBook Pro with deauth&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å¯ä»¥ç›´æ¥ç”¨ &lt;a class="link" href="https://github.com/unixpickle/JamWiFi" target="_blank" rel="noopener"
>&lt;strong>JamWifi&lt;/strong>&lt;/a> GUI Toolï¼Œæ‰“é–‹å¾Œé–‹å§‹ Scanï¼ŒScan å¾Œå¯ä»¥æ‰¾åˆ° AP ä¸¦é€é MAC Address æŒ‡å®šè£ç½®æ–·ç·šï¼Œæˆ‘åœ¨å®¶è£¡å˜—è©¦éæ˜¯å¯è¡Œçš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__EugN6S__T4PU5Bd5__9eaJ2w.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>åœ¨åŒç¯‡æ–‡ç« ä¸­æœ‰æåˆ°å¾ŒçºŒç ´è§£ Wifi å¯†ç¢¼çš„æ–¹å¼ï¼Œé€é deauthentication attack æ–·é–‹è£ç½®ï¼Œæ¥è‘—é–‹ &lt;code>tcpdump&lt;/code> ç›£è½æ‰€æœ‰çš„å°åŒ…ï¼›&lt;br>
æ¥è‘—ç”¨ &lt;code>cap2hccapx&lt;/code>å°‡ tcpdump çš„è³‡æ–™è½‰æ›æ ¼å¼ï¼›&lt;br>
æœ€å¾Œç”¨ &lt;code>hashcat&lt;/code> é¡ä¼¼æš´åŠ›ç ´è§£çš„æ–¹å¼ï¼Œå˜—è©¦é‚„åŸè¢« hashed éçš„å¯†ç¢¼ï¼Œé€™è£¡ä»–çš„æ¼”ç®—æ³•å¯ä»¥è¼¸å…¥ wordlistï¼Œç¶²è·¯ä¸Šæœ‰äººæä¾›å¸¸è¦‹çš„ wifi å¯†ç¢¼ï¼Œé›–ç„¶èªª wifi å¯†ç¢¼çš„å®Œå…¨å­—å…ƒ(a-zA-Z0â€“9)å¯èƒ½æ€§æ˜¯ 62 ^ 8 ä»¥ä¸Šï¼Œä½†æ˜¯åˆ©ç”¨äººé¡çš„æƒ°æ€§ï¼Œå…¶å¯¦å¯èƒ½çš„çµ„åˆæ²’æœ‰é€™éº¼å¤šï¼Œé€™å¯ä»¥çœä¸‹éå¸¸å¤§é‡çš„è¨ˆç®—æ™‚é–“ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/berzerk0/Probable-Wordlists/tree/master/Real-Passwords/WPA-Length" title="https://github.com/berzerk0/Probable-Wordlists/tree/master/Real-Passwords/WPA-Length"
target="_blank" rel="noopener"
>&lt;strong>berzerk0/Probable-Wordlists&lt;/strong>&lt;br>
_Version 2 is live! Wordlists sorted by probability originally created for password generation and testing - make sureâ€¦_github.com&lt;/a>&lt;a class="link" href="https://github.com/berzerk0/Probable-Wordlists/tree/master/Real-Passwords/WPA-Length" target="_blank" rel="noopener"
>&lt;/a>&lt;/p>
&lt;p>å¯ä»¥çœ‹ä¸€ä¸‹è‡ªå·±çš„å¯†ç¢¼æœ‰æ²’æœ‰åœ¨ä¸Šé¢ XD&lt;/p>
&lt;blockquote>
&lt;p>è¨­å®šå¯†ç¢¼ä¸è¦ç”¨ 12345678 æˆ–æ˜¯ 0000000 ï¼Œå¦å¤–è¦è¨˜å¾—å¸¸æ›å¯†ç¢¼&lt;/p>
&lt;/blockquote></description></item><item><title>èœé³¥èŒ¶å®¢-å¾è·¯äººåˆ°å…¥é–€</title><link>https://yuanchieh.page/posts/2019/2019-01-05-%E8%8F%9C%E9%B3%A5%E8%8C%B6%E5%AE%A2-%E5%BE%9E%E8%B7%AF%E4%BA%BA%E5%88%B0%E5%85%A5%E9%96%80/</link><pubDate>Sat, 05 Jan 2019 14:35:28 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-01-05-%E8%8F%9C%E9%B3%A5%E8%8C%B6%E5%AE%A2-%E5%BE%9E%E8%B7%AF%E4%BA%BA%E5%88%B0%E5%85%A5%E9%96%80/</guid><description>&lt;p>é–‹å§‹å­¸æ³¡èŒ¶ä¹Ÿå­¸äº†ä¸‰å€‹æœˆï¼Œæƒ³èªªåŸ¹é¤Šèˆˆè¶£æœ€å›°é›£çš„å…¶å¯¦æ˜¯ç¬¬ä¸€æ­¥ï¼Œåœ¨å­¸èŒ¶çš„éç¨‹æœ‰äº›ç¶“æ­·è »æœ‰è¶£ï¼Œè¦ºå¾—åˆ†äº«å‡ºä¾†ä¾›å…¶ä»–äººå°èŒ¶è‘‰æ„Ÿåˆ°å¥½å¥‡çš„è·¯äººï¼Œè·Ÿæˆ‘ä¸€èµ·å…¥é–€é«”é©—å–èŒ¶çš„æ¨‚è¶£ã€‚&lt;/p>
&lt;p>é¦–å…ˆè¦æ¾„æ¸…ä¸€ä»¶äº‹ï¼Œå–èŒ¶åœ¨å°ç£çš„åˆ»æ¿å°è±¡å¯èƒ½æ˜¯è€äººçš„è¡Œç‚ºï¼Œä½†æˆ‘è‡ªå·±è¦ºå¾—å–èŒ¶æ˜¯ä¸€ç¨®é£²å“ï¼Œé‡é»å°±æ˜¯å–å¾—é–‹å¿ƒï¼Œæ¥è‘—æ‰æ˜¯è¿‘ä¸€æ­¥ç´°ç´°å“åšå…¶ä¸­æ»‹å‘³ï¼Œèˆ‡èƒŒå¾Œçš„å…¸æ•…èˆ‡æ–‡åŒ–ï¼›&lt;br>
å–èŒ¶è·Ÿå–å’–å•¡æ‡‰è©²éƒ½æ˜¯ä»¶å¾ˆæ£’çš„ä¼‘é–’ï¼Œä¸éç¢ºå¯¦å–èŒ¶é¢¨æ°£åœ¨å¹´è¼•ä¸€è¼©ä¼¼ä¹ä¸å¤ªç››è¡Œï¼Œç•¥æ„Ÿå¯æƒœ XD&lt;/p>
&lt;h3 id="å¦‚ä½•é–‹å§‹">å¦‚ä½•é–‹å§‹&lt;/h3>
&lt;p>æˆ‘æœ¬äººæ˜¯å®Œå…¨é›¶ç¶“é©—ï¼Œå°æ™‚å€™ä¹Ÿåªæ˜¯è€çˆ¸æœƒæ³¡çƒé¾èŒ¶ï¼Œé£¯å¾Œè·Ÿè¦ªæˆšåè‘—é–’èŠï¼Œä½†å…¶å¯¦å°±æ²’æœ‰å¾ˆè¬›ç©¶&lt;/p>
&lt;p>å¾Œä¾†éš»èº«åˆ°å°åŒ—å·¥ä½œï¼Œè¦ºå¾—åœ¨å·¥ä½œä¹‹é¤˜å¯ä»¥åŸ¹é¤Šä¸åŒçš„èˆˆè¶£ï¼Œæ‰€ä»¥è‡¨æ™‚èµ·æ„å°±ä¸Šç¶²æ‹œ Googleï¼Œä¸€å€‹äººå°±ç¡¬è‘—é ­çš®å ±åäº†å°åŒ—æ›¸é™¢çš„èŒ¶è—èª²ç¨‹&lt;/p>
&lt;p>&lt;a class="link" href="http://tplecturehall.tw/course-view/" target="_blank" rel="noopener"
>&lt;strong>èŒ¶è—èª²ç¨‹ - è‡ºåŒ—æ›¸é™¢&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ä¸€æœŸå…­å ‚èª² 3600å…ƒï¼Œç›®å‰æ˜¯ä¸Šæ—è‰æ›¸è€å¸«çš„èª²ç¨‹ï¼Œè€å¸«éå¸¸æœ‰è¶£ï¼Œä¸Šèª²æœƒå¾æœ€åŸºæœ¬çš„èŒ¶å¸­èˆ‡èŒ¶å…·ä»‹ç´¹èµ·ï¼Œé€™è£¡å°±ä¸ä¸€ä¸€ç´°è¬›ï¼Œæ¥è‘—å¾ŒçºŒä¸Šèª²è€å¸«æœƒä¾ç…§å­¸ç”Ÿé€²åº¦ï¼Œä¸Šä¸åŒçš„èŒ¶é¡ï¼Œæœ€åŸºæœ¬çš„å…­å¤§èŒ¶ ç¶ ã€ç™½ã€é»ƒã€é’ã€ç´…ã€é»‘ï¼Œç›®å‰æˆ‘ä¸Šåˆ°ç¬¬äºŒæœŸä¸Šäº†å‰é¢å››ç¨®ï¼Œåœ¨å­¸ç¿’èŒ¶é¡æ™‚è€å¸«æœƒæº–å‚™æ›¸é¢è³‡æ–™ä»‹ç´¹å…¸æ•…èˆ‡ç”¢åœ°ç­‰ï¼Œä»¥åŠè£½èŒ¶çš„éç¨‹ï¼Œè®“å­¸å“¡æœ‰æ›´å…¨é¢çš„äº†è§£ï¼›&lt;br>
æ¥è‘—æœƒè©¦èŒ¶ï¼Œä¸‰å…¬å…‹èŒ¶è‘‰ç”¨é‘‘å®šæ¯æ³¡å…©åˆ†é˜(ä»¿é–“æœ‰ä¸åŒçš„æ™‚é–“)ï¼Œæ¥è‘—ä¸€ä¸€å“èŒ¶ã€‚&lt;/p>
&lt;h4 id="èŒ¶è‘‰ä»‹ç´¹">èŒ¶è‘‰ä»‹ç´¹&lt;/h4>
&lt;p>å…ˆè·³å‡ºä¾†ä»‹ç´¹ä¸€ä¸‹èŒ¶è‘‰ï¼ŒèŒ¶è‘‰åŸºæœ¬å¯ä»¥åˆ† èŒ¶æ¨¹ç¨®èˆ‡è£½ç¨‹&lt;/p>
&lt;p>èŒ¶æ¨¹ç¨®æ˜¯åŸæ–™ï¼Œä¾‹å¦‚èªªå¸¸è½åˆ°çš„é‡‘è±(å°èŒ¶åäºŒè™Ÿ)ã€ç´…ç‰(å°èŒ¶åå…«è™Ÿ)ã€éµè§€éŸ³ã€é’å¿ƒå¤§å³ç­‰ï¼Œé€™äº›æ˜¯&lt;strong>èŒ¶æ¨¹ç¨®&lt;/strong>ï¼› &lt;br>
æ¥è‘—æ‰€è¬‚çš„ç¶ èŒ¶ã€ç´…èŒ¶ã€çƒé¾èŒ¶(é’èŒ¶)ã€éµè§€éŸ³ã€åŒ…ç¨®èŒ¶ä»£è¡¨çš„æ˜¯ä¸åŒçš„å·¥è—è£½ç¨‹ï¼Œå¤§æŠµä¸Šæ˜¯ç™¼é…µç¨‹åº¦çš„ä¸åŒï¼Œç¶ èŒ¶èµ°ç„¡ç™¼é…µç›´æ¥æ®ºé’ï¼Œæ‰€ä»¥å¼·èª¿çš„æ˜¯é¦™å‘³ï¼›å…¶é¤˜ä¸åŒçš„ç™¼é…µåº¦èˆ‡ç„™ç«æ±ºå®šèŒ¶çš„ä¸åŒé¢¨å‘³ï¼Œä¹‹å¾Œç­‰æˆ‘äº†è§£å¾Œå†ç´°èªªã€‚&lt;/p>
&lt;p>æ‰€ä»¥ä½ å¯èƒ½æœƒå–åˆ° é‡‘è±åšçš„ç¶ èŒ¶ã€ç´…èŒ¶æˆ–çƒé¾èŒ¶ï¼Œæ‰€ä»¥ä¸‹æ¬¡äººå®¶è«‹ä½ å–çƒé¾èŒ¶ä¹Ÿå¯ä»¥å•æ˜¯å“ªç¨®èŒ¶æ¨¹ç¨®ï¼Œé€™ä¹Ÿæœƒæ±ºå®šèŒ¶è‘‰çš„é¢¨å‘³&lt;/p>
&lt;p>èŒ¶è(ä¹Ÿå°±æ˜¯èŒ¶æ¨¹ä¸Šçš„èŠ½è‘‰)ï¼Œè£½èŒ¶çš„åŸæ–™æœƒå½±éŸ¿æˆèŒ¶çš„é¢¨å‘³ï¼Œè€ŒèŒ¶æ¨¹çš„ç”Ÿé•·å—åˆ°åœ°ç†æ°£å€™çš„å½±éŸ¿ï¼Œæ‰€ä»¥æœ‰äº›çŸ¥åçš„åœ°é»æœƒæ¨™è¨˜å¦‚æ¢¨å±±çƒé¾ã€é˜¿é‡Œå±±çƒé¾ï¼›&lt;br>
å¦å¤–æ¡èŒ¶çš„æ™‚æ©Ÿå¾ˆé‡è¦ï¼Œæ‰€è¬‚ã€Œæ˜¥èŒ¶åšé¦™ã€å†¬èŒ¶åšæ°´ã€ï¼Œæ˜¥å†¬å…©å­£çš„èŒ¶è‘‰å“è³ªé€šå¸¸æœ€å¥½ï¼Œåƒ¹æ ¼ç•¶ç„¶ä¹Ÿæœ€è²´ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ‰€ä»¥è²·èŒ¶è‘‰è¨˜å¾—å• ä»€éº¼è£½ç¨‹ã€ä»€éº¼èŒ¶æ¨¹ç¨®ã€ä»€éº¼æ™‚å€™æ¡æ”¶ã€å¹´ä»½å¤šä¹…ã€ç™¼é…µåº¦å¦‚ä½•ç¨®ç¨®ï¼Œç”šè‡³ç•¶å¤©æ¡æ”¶çš„æ™‚é–“è·Ÿæ°£å€™éƒ½æœƒå½±éŸ¿&lt;/p>
&lt;/blockquote>
&lt;p>ä¸Šèª²ä¸»è¦æ˜¯å­¸ä¸åŒçš„èŒ¶ï¼Œä¾‹å¦‚èªªç™½èŒ¶ï¼Œåˆå¯ç´°åˆ†ä¸åŒç­‰ç´š ç™½æ¯«éŠ€é‡ã€ç™½ç‰¡ä¸¹ã€è²¢çœ‰ç­‰ï¼Œè¦å­¸æœƒåˆ†è¾¨å°±éœ€è¦ä¸æ–·çš„æ¯”è¼ƒèˆ‡å­¸ç¿’ï¼Œä»”ç´°å»å“åšå…¥é¼»çš„é¦™æ°£èˆ‡å…¥å–‰çš„éŸ»å‘³ï¼Œé€™éƒ¨åˆ†æˆ‘çœŸçš„å°±å¾ˆå¼±ï¼Œè€å¸«å¸¸å¸¸èªªæˆ‘æ˜¯ä¸æ˜¯èˆŒé ­å£æ‰Â â€¦ XDÂ &lt;br>
ä½†æˆ‘é‚„æ˜¯æ¨‚åœ¨å…¶ä¸­é˜¿ï¼Œè‡³å°‘æ…¢æ…¢æœ‰åœ¨é€²æ­¥ï¼Œå¦å¤–æœ‰è¶£çš„æ˜¯æ¯å€‹åŒå­¸çš„é¦™å‘³è¨˜æ†¶éƒ½ä¸åŒï¼Œæœ‰äº›äººæœƒæè¿°èŠ±é¦™æœé¦™ï¼Œä½†å…¶å¯¦æˆ‘éƒ½è½ä¸æ‡‚ï¼Œå› ç‚ºæˆ‘å®Œå…¨æ²’æœ‰èéâ€¦&lt;/p>
&lt;p>æ³¡ä¸åŒçš„èŒ¶ï¼Œå†æ­é…ä¸åŒçš„èŒ¶å£ºã€èŒ¶æ¯ã€ä¸åŒçš„æ°´æº«ã€æ²–æ³¡æ™‚é–“ã€å›æ²–æ¬¡æ•¸ç­‰ï¼Œéƒ½æœ‰ä¸åŒçš„é¢¨å‘³ï¼Œä¸Šèª²çš„å¦ä¸€å€‹å¥½è™•æ˜¯è€å¸«æœ‰å¤šç¨®çš„èŒ¶å…·ï¼Œä»¥åŠåŒå­¸é–“å¯ä»¥å½¼æ­¤äº¤æµã€‚&lt;/p>
&lt;p>æ•´é«”ä¸Šå“èŒ¶å…¶å¯¦è »å€‹äººï¼Œå°±æ˜¯è¦å¤šçœ‹å¤šå–ï¼Œé€æ­¥æ‰¾å‡ºè‡ªå·±å–œæ„›çš„èŒ¶ã€‚&lt;/p>
&lt;h3 id="è²·èŒ¶å…·">è²·èŒ¶å…·ï¼&lt;/h3>
&lt;p>ä¸Šèª²ä¸Šäº†ä¸€æœŸæ±ºå®šå…¥å‘ï¼Œä½†æ˜¯èº«ç‚ºåˆå¿ƒè€…ï¼Œæœ€ç…©çš„å°±æ˜¯å®Œå…¨æ²’æœ‰ç¶“é©—ä¸çŸ¥é“æ€éº¼æŒ‘ï¼Œäº”èŠ±å…«é–€çš„å™¨å…·è©²æ€éº¼è²·ï¼Œå°¤å…¶æ˜¯çœ‹åˆ°åƒ¹ä½ä¹Ÿä¸çŸ¥é“æ˜¯é«˜æ˜¯ä½ï¼Œä¸æƒ³è²·å¤ªå·®ä½†åˆä¸æƒ³ç•¶ç›¤å­ï¼Œä¸€æ•´å€‹è¶…ç³¾çµçš„ XD&lt;/p>
&lt;p>é‚£å°±æˆ‘å€‹äººç¶“é©—ï¼Œçµ¦å¤§å®¶ä¸€äº›åƒè€ƒï¼Œæˆ‘æ˜¯åœ¨æ·˜å¯¶é›™åä¸€è²·çš„ï¼Œå°ç£ä¹Ÿæœ‰å¾ˆå¤šèŒ¶è¡Œæˆ–æ˜¯é¶¯æ­Œéƒ½æœ‰è³£ï¼Œä¹‹å‰å»å°å—è·¯éå¾ˆå¤šé–“ç¥ç§˜çš„æ›¸å±€ä¹Ÿæœ‰åœ¨è³£&lt;/p>
&lt;p>ç¬¬ä¸€æŠŠæœ±æ³¥å£ºè²· 1500 å°å¹£ï¼Œæˆ‘åœ¨è‡ºç£å• 2000 å·¦å³æ˜¯åŸºæœ¬æ¬¾ï¼Œé€™äº›æ˜¯æ‰‹ä½œå£ºçš„åƒ¹ç¢¼ï¼Œå¦‚æœæ˜¯æ©Ÿå™¨åšåœ¨é¶¯æ­Œé€›æ™‚å¤§æ¦‚å°±3ã€500ä¸€æ”¯ï¼›&lt;br>
èé¦™æ¯ã€å“èŒ—æ¯ã€å…¬é“æ¯æ˜¯ç“·å™¨ï¼Œå¤§æ¦‚ä¸€å€‹æ¯å­100å…ƒå·¦å³ï¼›&lt;br>
å…¶ä»–çš„èŒ¶é‡ã€èŒ¶å‰‡å°±çœ‹å€‹äººï¼Œä¹Ÿå¤§ç´„1ã€200è€Œå·²ã€‚&lt;br>
ç¸½å…±åŠ ç¸½å¤§æ¦‚2500~3000 æå®šåŸºæœ¬çš„èŒ¶å…·çµ„ï¼Œç•¶ç„¶åªæ˜¯å…¥é–€çš„é–‹å§‹Â â€¦â€¦&lt;/p>
&lt;blockquote>
&lt;p>æ›´ï¼šèŒ¶æµ·å–œæ­¡ç»ç’ƒè³ªæ„Ÿçš„è©±ï¼Œå»ºè­°è²·é›™å±¤éš”ç†±çš„ç»ç’ƒèŒ¶æµ·ï¼Œä¸ç„¶å¾ˆç‡™æ‰‹&lt;/p>
&lt;/blockquote>
&lt;p>æˆ‘æœ‰å•è€å¸«æ€éº¼æŒ‘å£ºï¼Œè€å¸«å°±æ˜¯èªªçœ‹å¾—é †æ‰‹èŠ±å¾—ä¸‹å»å°±è²·ï¼Œé€™çœŸçš„éƒ½è¦ä¸€ç›´è²·ä¸€ç›´è©¦æ‰çŸ¥é“ã€‚&lt;/p>
&lt;p>æ³¡èŒ¶çš„å™¨çš¿å¤§æ¦‚å…©ç¨®è“‹æ¯è·ŸèŒ¶å£ºï¼Œæè³ªå¯åˆ† ç“·å™¨ã€æœ±æ³¥ã€ç´«ç ‚ã€é™¶ï¼Œæè³ªå¤§è‡´ä¸Šå› ç‚ºå­”éš™çš„å¤§å°ï¼Œæœƒå°èŒ¶è‘‰æœ‰ä¸åŒçš„ä¿®é£¾ï¼›&lt;br>
åƒæ˜¯ç“·å™¨å­”éš™éå¸¸å°ï¼Œæ‰€ä»¥æœ€èƒ½é‚„åŸèŒ¶çš„åŸå‘³ï¼Œä¸åŠ åˆ†ä¸æ¸›åˆ†ï¼Œè©¦èŒ¶çš„æ™‚å€™æœ€å¥½ç”¨ç“·å™¨ï¼›&lt;br>
ä½†æœ‰äº›èŒ¶ç«å‘³å¤ªé‡ï¼Œæˆ–æ˜¯æœ‰äººåå¥½åœ“æ½¤å£æ„Ÿæœƒç”¨å…¶ä»–çš„èŒ¶å™¨ï¼Œå› ç‚ºå­”éš™æœƒå¸é™„èŒ¶å‘³ï¼Œæ‰€ä»¥å‘³é“ä¸æœƒå¤ªè¡ã€‚&lt;/p>
&lt;h3 id="è²·èŒ¶è‘‰">è²·èŒ¶è‘‰&lt;/h3>
&lt;p>è²·èŒ¶è‘‰ä¸€é–‹å§‹è¦å…¥é–€å¥½é›£å•Šï¼Œä¹‹å‰æœ‰å»æœ¨æŸµçš„èŒ¶åœ’èµ°èµ°ï¼Œå¯æ˜¯çœ‹åˆ°èŒ¶è¡Œå°±ä¸å¤ªæ•¢é€²å»ï¼Œå¯èƒ½è·Ÿä¸€èˆ¬çš„æ¶ˆè²»ç¿’æ…£å»é€›ç™¾è²¨å…¬å¸ã€å¤§è³£å ´ä¸åŒï¼Œåƒ¹æ ¼çœ‹èµ·ä¾†ä¸é€æ˜ä¸æ•¢é€²å»ï¼Œæœ¬ä¾†æœ‰æƒ³è¦ç¶²è³¼å°±å¥½ï¼ŒBUT&lt;/p>
&lt;blockquote>
&lt;p>èŒ¶è‘‰ä¸€å®šè¦è©¦å–ï¼Œä¸è¦éš¨ä¾¿è²·ï¼&lt;/p>
&lt;/blockquote>
&lt;p>è¦å¦‚ä½•è©•æ–·èŒ¶çš„å¥½å£èˆ‡å°æ‡‰çš„åƒ¹æ ¼å‘¢Â ?Â &lt;br>
æˆ‘åœ¨ä¸€æœ¬æ›¸ä¸Šé¢å¯«åˆ°&lt;/p>
&lt;blockquote>
&lt;p>ã€Œå°ç£èŒ¶è¾²æ¯å°æ–¤ç”Ÿç”¢çš„èŒ¶è‘‰æ‰€éœ€è¦è² æ“”çš„æˆæœ¬æ©Ÿå™¨æ¡æ”¶ç´„ 270å…ƒï¼Œæ‰‹å·¥å‰‡æ˜¯ 500~1000å…ƒã€&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœå†ç®—ä¸ŠåŠ å·¥ã€é€šè·¯ã€è¡ŒéŠ·ç­‰æˆæœ¬ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ˜ç¢ºåƒ¹æ ¼ä½†è‡³å°‘æœ‰å€‹åº•ï¼Œé€šå¸¸æ›ç®—ä¸€æ–¤ç´„ 2000 å…ƒä¸Šä¸‹ï¼Œä½†æ¯æ¬¡è²·å¤§ç´„éƒ½æ˜¯ 75g / 150g çš„ä»½é‡ï¼Œä¹Ÿå°±æ˜¯ 400~500 å…ƒä¸€ç½æˆ‘è¦ºå¾—æ˜¯åˆç†çš„åƒ¹æ ¼ï¼Œä¹Ÿéƒ½æ²’æœ‰è¸©é›·éï¼›&lt;br>
ä½æ–¼é€™å€‹æ¨™æº–å¯èƒ½æ˜¯æ··èŒ¶ï¼Œæ‘»å…¥ä¸åŒåœ‹å®¶å¦‚è¶Šå—çš„èŒ¶è‘‰ï¼Œé€™éƒ¨åˆ†å› ç‚ºèŒ¶è‘‰å±¬æ–¼åŠ å·¥é£Ÿå“ï¼Œæ‰€ä»¥ç•¶åŸæ–™ä½æ–¼æŸå€‹æ¯”ä¾‹å¯ä»¥ä¸å¯«ç”¢åœ°ä½•è™•ï¼Œå°å¿ƒä¸è¦å—é¨™ã€‚&lt;/p>
&lt;p>ä¸åŒèŒ¶é¡æœ‰ä¸åŒé¢¨å‘³ï¼Œä½†æ˜¯å¤§æŠµä¸Šå¥½èŒ¶å¿…é ˆè¦å…¥å–‰èˆ’æœã€æœƒç”Ÿæ´¥ä¸æœƒæ¾€ï¼Œåƒéµè§€éŸ³ç­‰æœ‰æ™‚ç„™ç«ä¸­æœƒæœ‰å¾ˆå¼·çƒˆçš„ç«å‘³(æ•æˆ‘è©çª®)ï¼Œé‚£ç¨®å‘³é“ä¸è¦‹å¾—å¤§å®¶èƒ½æ¥å—ï¼Œä½†å¥½èŒ¶å°±æ˜¯ä¸æœƒæ¾€ï¼Œå…¥å–‰å¾Œå£æ°´æœƒåˆ†æ³Œ(ç”Ÿæ´¥)ï¼Œéäº†å¹¾ç§’å”‡é½’ä¾ç„¶ç•™é¦™ï¼›&lt;br>
é€™ç®—æ˜¯æœ€åŸºæœ¬çš„æ¨™æº–ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯å°‘å…‹æ•¸é•·æ™‚é–“æ²–æ³¡ (ä¸‰å…‹äº”åˆ†é˜)ï¼Œç­‰èŒ¶æ³¡ä¹…äº†åˆæ”¾æ¶¼ï¼Œå¥½è™•å£è™•ä¸€è¦½ç„¡éºã€‚&lt;/p>
&lt;p>å–åˆ°ä¸å¥½çš„èŒ¶è‘‰å°èº«é«”ä¸å¥½ï¼Œä¾‹å¦‚æˆ‘ä¹‹å‰å°±å–åˆ°åˆ®èƒƒï¼Œä¸å¥½çš„é«”é©—å¯èƒ½ä¹Ÿæœƒä¸­æ–·èˆˆè¶£çš„åŸ¹é¤Šï¼Œå€‹äººå»ºè­°ä¸æ•¢å»èŒ¶è¡Œè²·çš„è©±å¯ä»¥å»èŒ¶é¤¨ï¼Œåœ¨å°åŒ—çš„æ°¸åº·è¡—æœ‰éå¸¸å¤šé–“ï¼Œå…§ç”¨ä¸€å£ºå¤§æ¦‚200ä¸Šä¸‹ï¼Œå–œæ­¡åœ¨è²·&lt;/p>
&lt;p>å€‹äººä¹‹å‰å»éå°å—çš„å£¹äºŒèŒ¶å ‚ï¼Œå‰›å¥½æ˜¯æœ‹å‹ä»‹ç´¹ï¼Œåº—ä¸»å¾ˆç´°å¿ƒä»‹ç´¹ï¼Œå¯ä»¥è©¦åˆ°ä¸åŒçš„å°ç£æœ‰æ©ŸèŒ¶ï¼Œå…ˆå»èµ°è¨ªæœƒæ˜¯ä¸éŒ¯çš„é«”é©—ã€‚&lt;/p>
&lt;p>å°åŒ—éƒ¨åˆ†å¤§å¤šä½æ–¼æ°¸åº·è¡—ï¼Œç­‰æˆ‘èµ°è¨ªéå¾Œå†ä¾†æ¨è–¦&lt;/p>
&lt;p>æ¥è‘—æ˜¯å»èŒ¶è—åšè¦½æœƒï¼Œæˆ‘é€™æ¬¡å‰›å¥½ 2019/1/4â€“7 åœ¨ä¸–è²¿æœ‰å±•è¦½ï¼Œå»èµ°è¨ªå°±ç¡¬è‘—é ­çš®åä¸‹ä¾†å–èŒ¶ï¼Œé–‹å§‹æœ‰ç¦®è²Œåœ°è«‹æ•™ï¼Œåº—å®¶é€šå¸¸éƒ½é¡˜æ„è·Ÿä½ ä»‹ç´¹ï¼Œç•¢ç«Ÿå±•è¦½å¤§å¤šæ˜¯æ¨å»£ç‚ºä¸»ï¼ŒéŠ·å”®æ˜¯å…¶æ¬¡ï¼Œé€™æœƒæ˜¯è²·èŒ¶è‘‰èˆ‡æ›´èªè­˜èŒ¶è‘‰çš„å¥½æ©Ÿæœƒï¼Œé€™æ¬¡å»å°±è©¦åˆ°æˆ‘å€‹äººéå¸¸å–œæ­¡çš„èŒ¶ï¼Œé †æ‰‹å°±è²·é»å›å®¶å–&lt;/p>
&lt;p>åˆ†äº«ä¸€ä¸‹æˆ‘å€‹äººå£å‘³ï¼Œå°ç£èŒ¶å¤§å¤šæ˜¯çƒé¾è·Ÿå°‘è¨±ç´…èŒ¶ï¼Œå…¶ä»–èŒ¶ç¨®ç½•è¦‹ï¼Œä½†æ˜¯ç›®å‰å¸‚å ´å°ç£çš„é«˜å±±çƒé¾éƒ½æ˜¯è¼•ç™¼é…µï¼Œå‘³é“ä¸å¤ªæ˜¯æˆ‘å–œæ­¡çš„ï¼Œè€Œä¸”æœ‰é»æœƒåˆ®èƒƒï¼Œä¸å¤ªèˆ’æœ&lt;/p>
&lt;p>å¾Œä¾†å–åˆ°ç”Ÿæ´»å±…èŒ¶è¡Œçš„è€æ¨¹ç¨®ç´…èŒ¶ï¼Œå–å¾—å°±è »å–œæ­¡çš„ï¼Œè€Œä¸”åé¤˜æ³¡å‘³é“ä¸æ¸›ï¼Œååˆ†åœ“æ½¤ç”˜ç”œï¼Œä¹Ÿæ˜¯é€™æ”¤çš„æ”¤ä¸»è·Ÿæˆ‘èªªæ…¢æ…¢å–ä¸è¦æ€¥è‘—èµ°ï¼Œå³ä½¿æˆ‘è²·çš„ä¸å¤šä»–ä¾ç„¶ç†±æƒ…çš„ä»‹ç´¹ï¼Œå¾ˆæ„Ÿè¬é€™ä½æ”¤ä¸»&lt;/p>
&lt;blockquote>
&lt;p>#æ›´ï¼šå¾Œä¾†è€å¸«æœ‰å¸¶æˆ‘å€‘å»æ¡ƒåœ’é¾œå±±çš„&lt;a class="link" href="https://www.facebook.com/yishou852/" target="_blank" rel="noopener"
>ç›Šå£½èŒ¶å» &lt;/a>åƒè¨ªï¼Œé«”é©—è£½ä½œæ±æ–¹ç¾äººèŒ¶ï¼Œæ•´å€‹éç¨‹ååˆ†æœ‰è¶£ï¼Œå¾ä¸€é–‹å§‹åƒè§€èŒ¶åœ’ï¼Œçœ‹çœ‹å‚³èªªä¸­çš„å°ç¶ è‘‰èŸ¬ï¼Œæ¥è‘—å°±åƒèˆ‡æ›¬è / æ‰æ»çš„éç¨‹ï¼Œçœ‹è‘—èŒ¶èå¾é®®ç¶ æ…¢æ…¢èå‡‹ï¼Œå¾æ¿ƒåšçš„è‰å‘³è½‰è®Šæˆé’è˜‹æœé¦™ï¼Œæ²’æœ‰å¯¦éš›è£½èŒ¶æ²’æœ‰æƒ³åƒåˆ°é€™æ¨£ç¾å¦™çš„é¢¨å‘³æµè½‰çš„éç¨‹ï¼Œå¾æ—©ä¸Šä¹é»ä¸€è·¯å¿™åˆ°æ™šä¸Šåä¸€é»ï¼Œå¾Œä¾†è¦è¶•è»Šæµªèã€æ®ºèã€æˆåœ˜çš„éç¨‹å°±æ²’æœ‰åƒèˆ‡ï¼Œå¹¾å¤©å¾Œæ”¶åˆ°è¦ªæ‰‹åšçš„æ±æ–¹ç¾äººèŒ¶æœ‰æ»¿æ»¿çš„å›æ†¶èˆ‡æ„Ÿå‹•ï¼&lt;br>
é€™é‚Šä¹Ÿæ¨è–¦ç›Šå£½èŒ¶å» çš„èŒ¶è‘‰å–”ï¼Œçœ‹è‡‰æ›¸ä¹Ÿæœ‰å¾ˆå¤šåƒè¨ªæ´»å‹•ï¼Œæœ‰èˆˆè¶£å¯ä»¥æŸ¥æŸ¥çœ‹ï½&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è­˜è£œçµ¦ç«™">çŸ¥è­˜è£œçµ¦ç«™&lt;/h3>
&lt;p>æˆ‘è »å–œæ­¡å¾æœ‰ç³»çµ±æ€§æ–¹å¼é–‹å§‹å­¸ç¿’ï¼Œæ‰¾è€å¸«æˆ–æ˜¯çœ‹æ›¸å°±éå¸¸çš„é©åˆï¼Œæ—è‰æ›¸è€å¸«æœ‰æ¨è–¦å…©æœ¬ä»‹ç´¹è‡ºç£çƒé¾èŒ¶çš„æ›¸ï¼Œå…¶ä¸­ä¹Ÿæœ‰èŒ¶è‘‰ä»‹ç´¹ï¼ŒåŒ…å«èŒ¶çš„è‹¦å‘³ã€é¦™å‘³ã€æ¾€å‘³æ˜¯æ€éº¼ä¾†çš„ï¼Œå¤§æŠµçš„è£½ç¨‹ä¹‹é¡çš„ï¼Œçœ‹å®Œå°±æœƒæœ‰å€‹åˆæ­¥å°è±¡&lt;/p>
&lt;p>&lt;a class="link" href="https://www.books.com.tw/products/0010630169" target="_blank" rel="noopener"
>&lt;strong>çƒé¾èŒ¶çš„ä¸–ç•Œï¼šå…¨æ–¹ä½èŒ¶è·äºº30é¤˜å¹´å¿ƒè¡€çµæ™¶ï¼Œå¾ç¨®èŒ¶ã€è£½èŒ¶ã€é£²èŒ¶ï¼Œå‘Šè¨´ä½ çƒé¾èŒ¶é¢¨å‘³çš„ç§˜å¯†&lt;/strong>&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.books.com.tw/products/0010418806" target="_blank" rel="noopener"
>&lt;strong>å°ç£èŒ¶ç¬¬ä¸€å ‚èª²ï¼šé ‚å°–èŒ¶äººæ•™ä½ å–èŒ¶ä¸€å®šè¦çŸ¥é“çš„äº‹ï¼&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å¦å¤–æ˜¯è½åˆ°èŒ¶å‹æ¨è–¦çš„å°ˆæ¥­èŒ¶è‘‰è«–å£‡&lt;/p>
&lt;p>&lt;a class="link" href="http://www.t4u.com.tw/chat2/index.php" target="_blank" rel="noopener"
>&lt;strong>è‡ºç£ T4U èŒ¶è—è«–å£‡ - Powered by Discuz!&lt;/strong>&lt;/a>&lt;/p>
&lt;p>è£¡é¢æœ‰å„å¼èŒ¶è‘‰çš„è¨è«–ï¼Œç›®å‰ä»åœ¨åŠªåŠ›çˆ¬æ–‡ä¸­&lt;/p>
&lt;p>æœ€å¾Œè£œå……ä¸€é»ï¼ŒèŒ¶è‘‰æœ‰è³å‘³æœŸä½†æ²’æœ‰ä¿å­˜æœŸï¼Œä¹Ÿå°±æ˜¯æœ‰äº›èŒ¶è‘‰åœ¨æŸäº›å¹´ä»½æœƒæ¯”è¼ƒå¥½å–ï¼Œé€šå¸¸æ¸…é¦™å‹ç•¶å¹´åº¦æœƒæ¯”è¼ƒå¥½ï¼Œå…¶é¤˜çš„æ”¾ä¹…äº†å‘³é“æœƒã€Œè½‰ã€ï¼Œä½†åªè¦ç”¨å¤¾éˆè¢‹é™°ä¹¾ä¿å­˜ï¼Œæ”¾å€‹å¹¾åå¹´éƒ½ä¸æˆå•é¡Œï¼Œå¦‚æœæ­¤æ™‚çš„å‘³é“ä¸å–œæ­¡ï¼Œå†çµ¦ä»–ä¸€é»æ™‚é–“ï¼Œéä¸€é™£å­èªªä¸å®šå°±åˆèƒƒå£äº†ã€‚&lt;/p>
&lt;p>ç¸½ä¹‹å°±æ˜¯é¼“èµ·å‹‡æ°£ï¼Œå¤šå–å¤šçœ‹å¤šå•ï¼Œå¯ä»¥å»ç¾ä»£çš„èŒ¶é¤¨è©¦è©¦ï¼Œä¹Ÿå¯ä»¥åœ¨æœ‰å±•è¦½å»ã€‚&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>å–èŒ¶å°±æ˜¯è¦æ‰¾å¾—é©åˆçš„èŒ¶ï¼Œç”¨é–‹å¿ƒçš„å¿ƒæƒ…å–èŒ¶ï¼Œè¬›ç©¶ä»€éº¼çš„å€’æ˜¯å…¶æ¬¡ (è½‰è¿°å‰è¼©æ‰€è¨€&lt;/p>
&lt;p>é€™ç¯‡ç®—æ˜¯å‰›å…¥é–€ä¸ä¹…çš„å¿ƒå¾—ï¼Œå¦‚æœ‰éŒ¯èª¤ç…©è«‹ç³¾æ­£ï¼Œé•·è·¯æ¼«æ¼«ï¼Œé¡˜èŒ¶é¦™ä¸€è·¯ç›¸éš¨&lt;/p></description></item><item><title>V8 Zero Stack Async Stack Trace ç ”ç©¶</title><link>https://yuanchieh.page/posts/2019/2019-01-01-v8-zero-stack-async-stack-trace-%E7%A0%94%E7%A9%B6/</link><pubDate>Tue, 01 Jan 2019 10:27:29 +0000</pubDate><guid>https://yuanchieh.page/posts/2019/2019-01-01-v8-zero-stack-async-stack-trace-%E7%A0%94%E7%A9%B6/</guid><description>&lt;p>é€™ä»½æ˜¯åœ¨ 2018/11/20 ç”± V8 Team é‡‹å‡ºçš„æ–‡ä»¶ï¼Œä¸»è¦æè¿°ç”¨ä¸€ç¨®æ–°çš„Async éŒ¯èª¤è¿½è¹¤æ©Ÿåˆ¶ï¼Œæ­¤æ–°æ©Ÿåˆ¶åƒ…é©ç”¨æ–¼ &lt;code>async await&lt;/code> ï¼Œpromise chainå‰‡æ²’æœ‰æ•ˆæœï¼Œç›®å‰éœ€è¦é€é &lt;code>--harmony-await-optimization&lt;/code> flag å•Ÿç”¨é€™é …åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹å…§å®¹èˆ‡åœ–ç‰‡æ‘˜éŒ„æ–¼è©²æ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="ç·£ç”±">ç·£ç”±&lt;/h3>
&lt;p>åƒè€ƒä¸‹åˆ—ç¨‹å¼ç¢¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Let&amp;#39;s have a look...&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stack&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœé‹è¡Œåœ¨ V8 7.1 ç‰ˆæœ¬ï¼Œæœƒç™¼ç¾ error.stack åƒ…æœƒå°å‡ºéƒ¨åˆ†éŒ¯èª¤è³‡è¨Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">Error: Let&amp;#39;s have a look...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at bar (&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">anonymous&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>:7:9)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œèª¿ç”¨è€… foo å‰‡æ¶ˆå¤±ç„¡è¹¤ï¼Œé€™æ˜¯å› ç‚ºå¾ JSVMè§’åº¦ï¼Œç•¶ bar å› ç‚º await x è€Œæš«åœåŸ·è¡Œï¼Œæ¥è‘—å¾ microtask queue æ¢å¾©åŸ·è¡Œå¾Œï¼Œåœ¨ stack ä¸Šå·²ç¶“æ²’æœ‰å…¶ä»– function äº†&lt;/p>
&lt;p>ç›®å‰å¯ä»¥é–‹ Chrome Dev Inspector ( &lt;code>&amp;gt; node --inspect&lt;/code>)ï¼ŒåŸ·è¡ŒåŒæ¨£çš„ç¨‹å¼ï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´çš„ error stackï¼Œä½†é€™æœƒæœ‰å¾ˆå¤§çš„æ€§èƒ½å½±éŸ¿ï¼Œæ‰€ä»¥åªå»ºè­°åœ¨é–‹ç™¼ä¸­ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__zUDoBxW4TG__IFqDF.jpg"
loading="lazy"
>&lt;/p>
&lt;h3 id="è§£æ³•">è§£æ³•&lt;/h3>
&lt;p>ç›®å‰çš„å›°å¢ƒæ˜¯ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå› ç‚ºéåŒæ­¥ç‰¹æ€§è¦è¿½è¹¤å®Œæ•´çš„éŒ¯èª¤æ£§ä¸å®¹æ˜“ã€‚&lt;/p>
&lt;p>æ­£å¥½ await æœƒåœæ­¢ç›®å‰çš„ function é‹ä½œï¼Œæ‰€ä»¥ä¸ä½†å¯ä»¥çŸ¥é“ç›®å‰åœåœ¨ä»€éº¼åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥çŸ¥é“æ˜¯å¾å“ªè£¡è¢«å‘¼å«ï¼›&lt;br>
é€™ç‰¹æ€§è·Ÿ promise chainç›¸åŒï¼Œå› ç‚º promise é€éÂ .then é€£çµï¼Œæ‰€ä»¥èƒ½å¤ è¼•é¬†ååºé‡å»ºå‡º function å‘¼å«ç›¸ä¾ã€‚&lt;/p>
&lt;h4 id="å…ˆè¡Œæ¢ä»¶">å…ˆè¡Œæ¢ä»¶&lt;/h4>
&lt;p>æˆ‘å€‘å¿…é ˆé‹ç”¨ promise chainï¼Œæ‰èƒ½æœ‰è¶³å¤ çš„æ¢ä»¶æ‰¾å‡ºå®Œæ•´ stack traceï¼›&lt;br>
ä½†å¦‚æœ promise æ˜¯è¢«å¦ä¸€å€‹ promise resolved (åœ¨ fulfill æ–¹æ³•ä¸­ return å¦ä¸€å€‹promise)ï¼Œé€™æ¨£ promise chain é–“å°±æ²’æœ‰ç›´æ¥çš„ä¾æ“šï¼Œå¿…é ˆç­‰åˆ°ä¸‹ä¸€å€‹ tick &lt;code>[PromiseResolveThenableJob](https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob)&lt;/code> åŸ·è¡Œæ™‚æ‰çŸ¥é“é€™å…©å€‹ promise æ˜¯æœ‰ç›¸ä¾çš„ã€‚&lt;/p>
&lt;p>é€™æ˜¯ç›®å‰ ES2017 çš„è¦ç¯„æ‰€å¸¶ä¾† await éº»ç…©ä¹‹è™•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">promise_&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="nx">createPromise&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">@&lt;/span>&lt;span class="nx">resolvePromise&lt;/span>&lt;span class="p">(.&lt;/span>&lt;span class="nx">promise&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">throwaway_&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="nx">createPromise&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">@&lt;/span>&lt;span class="nx">performPromiseThen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">promise_&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="nx">resume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">generator_object_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">generator_object_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">throwaway_&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">@&lt;/span>&lt;span class="k">yield&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">generator_object_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">outer_promise_&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›®å‰ await éƒ½å¿…é ˆç”¨å¦ä¸€å€‹ promiseÂ &lt;code>.promise&lt;/code> é‡æ–°åŒ…è£ï¼Œå³ä½¿ x æœ¬èº«å·²ç¶“æ˜¯promiseï¼Œå•é¡Œåœ¨æ–¼Â &lt;code>.generator_object&lt;/code> èˆ‡ &lt;code>x&lt;/code> æ²’æœ‰ç›´æ¥çš„é—œé€£ï¼›&lt;br>
è€Œæ˜¯å¿…é ˆç­‰åˆ°ä¸‹å€‹ tick &lt;a class="link" href="https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob" target="_blank" rel="noopener"
>PromiseResolveThenableJob&lt;/a> å°‡Â &lt;code>.promise â† â†’ x&lt;/code> èˆ‡Â &lt;code>.promise â† â†’Â .generator_object&lt;/code> æ‰èƒ½é—œè¯ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ç›®å‰éœ€è¦é¡å¤–å»ºç«‹ &lt;code>x â† â†’Â .promise çš„é—œè¯&lt;/code> æˆ–æ˜¯ æŸ¥è©¢ microtask queueï¼Œå…©è€…éƒ½éœ€è¦é–‹éŠ·ã€‚&lt;/p>
&lt;p>å¥½åœ¨æœ€è¿‘æœ‰ææ¡ˆè¦ä¿®æ”¹æ­¤éƒ¨åˆ†ï¼Œå°‡å¤šé¤˜Â .promise åˆªé™¤&lt;/p>
&lt;p>const &lt;em>.promise&lt;/em> = @promiseResolve(x);&lt;br>
const &lt;em>.throwaway&lt;/em> = @createPromise();&lt;br>
@performPromiseThen(&lt;em>.promise&lt;/em>,&lt;br>
res =&amp;gt; @resume(&lt;em>.generator_object&lt;/em>, res),&lt;br>
err =&amp;gt; @throw(&lt;em>.generator_object&lt;/em>, err),&lt;br>
&lt;em>.throwaway&lt;/em>);&lt;br>
@yield(&lt;em>.generator_object&lt;/em>, &lt;em>.outer_promise&lt;/em>);&lt;/p>
&lt;p>æœ€ä¸»è¦å·®åˆ¥åœ¨ &lt;code>constÂ _.promise_ = @promiseResolve(x);&lt;/code> ï¼Œä½¿ç”¨ &lt;code>promiseResolve&lt;/code> å¦‚æœ x æœ¬èº«æ˜¯ native promise å°±ä¸æœƒé¡å¤–å†åŒ…ä¸€å±¤ï¼Œå¯ä»¥åœ¨ V8 v7.2 &lt;code>--harmony-await-optimization&lt;/code> é–‹å•Ÿæ­¤åŠŸèƒ½ã€‚&lt;/p>
&lt;h4 id="æ¦‚è¦½">æ¦‚è¦½&lt;/h4>
&lt;p>æ¥ä¸‹ä¾†æ˜¯ V8 å…§éƒ¨çš„ await Promiseå¯¦è¸ï¼Œé€éä¸Šè¿°çš„ Spec ä¿®æ”¹å¾Œï¼Œé”åˆ° async stack trace ç›®æ¨™ã€‚&lt;/p>
&lt;p>é‡å°ä»¥ä¸‹çš„ç¨‹å¼ç¢¼ï¼Œç•«å‡ºå¯¦éš› V8 çš„ Call Stack&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Let&amp;#39;s have a look...&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stack&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__FZBjeD6zupannymv.jpg"
loading="lazy"
>&lt;/p>
&lt;p>å› ç‚º bar(x) ä¸­ await (1)ï¼Œè€Œ 1 ä¸æ˜¯ promise æ‰€ä»¥éœ€è¦é€é Promise().resolve(1) å¤šåŒ…ä¸€å±¤ï¼Œæ‰€ä»¥åœ¨ Call stack ä¸Š &lt;code>bar&lt;/code> è¢« &lt;code>await fulfilled&lt;/code> å‘¼å«ï¼›&lt;br>
ã€Œå¦‚æœ async stack åŠŸèƒ½é–‹å•Ÿã€ï¼Œæ­¤æ™‚æœƒå»æœå°‹ â€œcurrent microtaskâ€æ‰¾åˆ° &lt;code>åŒ…è£xçš„PromiseReactionJob&lt;/code> ï¼Œæ‰¾åˆ°çš„è©±å°±æœƒé †å‹¢æ‰¾åˆ° &lt;code>generator object&lt;/code> ï¼Œé€™å€‹ object ä¹Ÿå°±æ˜¯ async function æ‰€è½‰åŒ–è€Œä¾†çš„ï¼ŒåŒæ™‚åŒ…å« async function çš„ promise referenceã€‚&lt;/p>
&lt;h4 id="å¦ä¸€ç¨®åšæ³•">å¦ä¸€ç¨®åšæ³•&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__p4VtVwlDfBFbtUQq.jpg"
loading="lazy"
>&lt;/p>
&lt;p>å¦ä¸€ç¨®åšæ³•å‰‡æ˜¯ await ç”¢ç”Ÿçš„å…§éƒ¨ promise (Â &lt;code>.promise&lt;/code>)æœ‰è¾¦æ³•æ‰¾åˆ°å¤–éƒ¨ promise (ä¹Ÿå°±æ˜¯ async functionï¼Œ &lt;code>JSPromise&lt;/code>)ï¼Œå¦‚æœå…¨éƒ¨éƒ½æ˜¯ç”¨ async await ä¸²é€£ï¼Œå¯ä»¥æ‰¾åˆ° &lt;code>PromiseReaction&lt;/code> ï¼Œè£¡é ­åŒ…å«å…©å€‹ç‰¹æ®Šçš„é–‰åŒ… &lt;code>Await Rejected&lt;/code> è·Ÿ &lt;code>Await Fulfilled&lt;/code> ï¼Œå…©è€…å…±åŒåˆ†äº«ä¸€å€‹ Object &lt;code>AwaitContext&lt;/code> ï¼Œé€™å€‹AwaitContext æ˜¯å¦ä¸€å€‹å†ç­‰å¾… JSPromise çš„&lt;code>JSGenerator Object&lt;/code> ï¼Œä¹Ÿå°±æ˜¯ function fooã€‚&lt;/p>
&lt;p>é€™éƒ¨åˆ†å…§éƒ¨å¯¦è¸çœ‹å¾—æœ‰é»æšˆé ­è½‰å‘ï¼Œç›®å‰å°±æ˜¯å¤§è‡´æœ‰å€‹æ¨¡ç³Šæ¦‚å¿µã€‚&lt;/p>
&lt;h4 id="errorstack">Error.stack&lt;/h4>
&lt;p>ç›®å‰ Error.stack é‚„ä¸æ˜¯å®˜æ–¹æ¨™æº–ï¼Œç›®å‰å·²ç¶“ææ¡ˆè™•æ–¼ stage-1 çš„è‰æ¡ˆ&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/tc39/proposal-error-stacks" target="_blank" rel="noopener"
>&lt;strong>tc39/proposal-error-stacks&lt;/strong>&lt;/a>&lt;/p>
&lt;p>é€™éƒ¨å½±ç‰‡æ˜¯æ–‡ä»¶çš„é™„å±¬ referenceï¼Œä¸»è¦åˆ†äº« Nodejs ä¸­å¦‚ä½•ä½¿ç”¨async stack traceã€‚&lt;/p>
&lt;p>ä»¥ä¸‹ç‚ºæ¸¬è©¦ç¨‹å¼ç¢¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rej&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()=&amp;gt;&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">one&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">two&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">one&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">three&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">two&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">four&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">three&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">four&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">error&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">error&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stack&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ç›®å‰çš„ Nodejs v11.5.0 åŸ·è¡Œï¼Œæ‰“å°çš„çµæœæ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">Error: err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at one (/Users/.../Desktop/test.js:7:8)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ•´å€‹ call stack åªå‰© function one è€Œå·²ï¼Œé€™æ¨£è¦ debug ç›¸ç•¶å›°é›£ã€‚&lt;/p>
&lt;p>æ­¤æ™‚å¯ä»¥é–‹å•Ÿ inspectorï¼Œ &lt;code>&amp;gt; nodeâ€Šâ€”inspect-brk=0.0.0.0:9229 test.js&lt;/code>&lt;/p>
&lt;p>æ¥è‘—æ‰“é–‹ chrome dev toolï¼Œè¨˜å¾—æ‰“é–‹ Discover network targetsï¼Œé»æ“Šé€²å»æœƒè·³å‡ºä¸‹æ–¹çš„ debugè¦–çª—ï¼Œæ¥è‘—è¦æ‰“é–‹ Pause on caught rejection ä¸ç„¶å‡ºéŒ¯å°±æœƒçµæŸäº†&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__Z2ZYMsG__OSWF9QF1UWBn3Q.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å¦‚åŒä¸Šé¢æ‰€èªªï¼Œé€™ç¨®æ–¹æ³•åªé©ç”¨æ–¼é–‹ç™¼ã€‚&lt;/p>
&lt;h4 id="æ–°çš„-zero-cost-async-stacktrace">æ–°çš„ zero-cost async stackÂ trace&lt;/h4>
&lt;p>ç›®å‰éœ€è¦ V8 v7.2 ä¸¦é€é flag æ‰èƒ½é–‹å•Ÿæ­¤åŠŸèƒ½ï¼Œæ‰€ä»¥ç¾åœ¨è¦å…ˆä¸‹è¼‰ v8-canaryç‰ˆçš„ Nodejsï¼Œå¹³å¸¸éƒ½æ˜¯ç”¨ nvm ç®¡ç†å¤šå€‹ Nodejs ç‰ˆæœ¬ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼ä¸‹è¼‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">$ NVM_NODEJS_ORG_MIRROR=[https://nodejs.org/download/v8-canary](https://nodejs.org/download/v8-canary) nvm install node
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥é€é nodeçš„ REPL ç’°å¢ƒåŸ·è¡Œ &amp;gt; process.versions çœ‹ V8çš„ç‰ˆè™Ÿã€‚&lt;/p>
&lt;p>æ¥è‘—åŸ·è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">$ node --async-stack-traces test.js
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰“å°çµæœå°±æœƒæ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Error&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">at&lt;/span> &lt;span class="nx">one&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="err">/Users/zhengyuanjie/Desktop/test.js:7:8) &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">at&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="nx">two&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="err">/Users/zhengyuanjie/Desktop/test.js:11:2) &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">at&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="nx">three&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="err">/Users/zhengyuanjie/Desktop/test.js:15:9) &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">at&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="nx">four&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="err">/Users/zhengyuanjie/Desktop/test.js:19:9)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>ä¹‹å¾Œçœ‹ä¾†è¦èŠ±æ™‚é–“é‡æ–°å­¸ C/C++ï¼Œé€™æ¨£æ‰èƒ½çœ‹æ‡‚ V8 èˆ‡ JS Binding ç­‰åº•å±¤çš„ Nodejs å¯¦ä½œã€‚&lt;/p></description></item><item><title>æ„›ç”¨ async await è€Œé promise!</title><link>https://yuanchieh.page/posts/2018/2018-12-28-%E6%84%9B%E7%94%A8-async-await-%E8%80%8C%E9%9D%9E-promise/</link><pubDate>Fri, 28 Dec 2018 01:39:30 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-12-28-%E6%84%9B%E7%94%A8-async-await-%E8%80%8C%E9%9D%9E-promise/</guid><description>&lt;p>è¿‘æœŸçœ‹ä¸åˆ°å°‘é—œæ–¼ async / await çš„å¥½æ–‡ç« ï¼Œé€™è£¡ç‰¹åˆ¥æ‘˜éŒ„å…©ç¯‡ç¸½çµ&lt;/p>
&lt;p>&lt;a class="link" href="https://mathiasbynens.be/notes/async-stack-traces" target="_blank" rel="noopener"
>&lt;strong>Asynchronous stack traces: why await beats Promise#then()&lt;/strong> &lt;/a>&lt;/p>
&lt;p>å°æ¯”æ–¼ç›´æ¥ä½¿ç”¨ Promise Chainï¼Œä½¿ç”¨ async / await é™¤äº†èªæ³•ä¸Šæ›´åŠ å‹å–„ï¼Œæ›´é‡è¦çš„æ˜¯ JS Engine åº•å±¤æœ‰å„ªåŒ–ï¼Œå°¤å…¶æ˜¯åœ¨ stack traceçš„æ™‚å€™ã€‚&lt;/p>
&lt;p>&lt;code>await X()&lt;/code> è·Ÿ Promise æœ€å¤§å·®åˆ¥åœ¨æ–¼åŸ·è¡Œæ™‚æœƒç›´æ¥æš«åœ function é‹ä½œï¼Œç›´åˆ° await çš„ promise XçµæŸå¾Œæ‰ç¹¼çºŒåŸæœ¬çš„ functionï¼›&lt;br>
è‡³æ–¼ promise.then(X) å‰‡æ˜¯æŠŠ X æ”¾ä¸Š callback chainä¸Šï¼ŒåŸ function å°±çµæŸäº†ã€‚&lt;/p>
&lt;p>é€™é»å·®ç•°æœ‰è‘—é‡å¤§çš„æ”¹è®Šï¼Œè«‹çœ‹ä»¥ä¸‹ç¯„ä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">b&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>function a åŸ·è¡Œæ™‚ï¼Œæœƒç›´æ¥å‘¼å« function bï¼Œè€Œ b().then å‰‡æ˜¯å°‡ &lt;code>() =&amp;gt; c()&lt;/code> åŒ¿å function æ”¾ä¸Š callback chainï¼Œç„¶å¾Œ a å°±çµæŸäº†ï¼Œæ‰€ä»¥ function a çš„ context ä¹Ÿè·Ÿè‘—æ¶ˆå¤±ï¼›&lt;/p>
&lt;p>è©¦æƒ³å¦‚æœæ­¤æ™‚ b æˆ– c æ‹‹å‡ºéŒ¯èª¤ï¼Œç†è«–ä¸Šè¦é™¤éŒ¯æˆ‘å€‘æœƒå¸Œæœ›çœ‹åˆ°å®Œæ•´çš„ call stackï¼Œä½†æ˜¯ a æ—©å°±çµæŸæ‹‹æ£„äº† contextï¼Œæ‰€ä»¥ V8 è¦é¡å¤–å°‡ a çš„ context å‚³çµ¦ promise b è·Ÿ function cï¼Œé€™æ¨£å‡ºéŒ¯æ‰æœ‰è¾¦æ³•è¿½æœ¬æº¯æºï¼Œé€™äº›æ˜¯é¡å¤–çš„è² æ“”ã€‚&lt;/p>
&lt;p>æ”¹æˆ async / await å°±ä¸ä¸€æ¨£äº†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶ b æˆ– c å‡ºéŒ¯æ™‚ï¼Œå› ç‚ºé‚„åœ¨ function a çš„ contextæ‰€ä»¥å¯ä»¥å¾ˆå¿«é€Ÿè¿½è¹¤ï¼Œä¸éœ€è¦é¡å¤–çš„æˆæœ¬ã€‚&lt;/p>
&lt;h3 id="å°çµ">å°çµ&lt;/h3>
&lt;p>å¾ˆå¤š ES6èªæ³•éƒ½æ˜¯ syntax sugarï¼Œä½†æ˜¯ async / await å¸¶äº†æ›´ä¸ä¸€æ¨£çš„æ”¹è®Šï¼Œä½œè€…çµ¦å…©é»å»ºè­°&lt;/p>
&lt;ol>
&lt;li>ç›¡é‡ç”¨ async / await&lt;/li>
&lt;li>é¿å…ä¸å¿…è¦çš„ transpileï¼Œé€é &lt;code>babel-preset-env&lt;/code> ä¾†é¿å…&lt;/li>
&lt;/ol>
&lt;p>&lt;a class="link" href="https://philipwalton.com/articles/deploying-es2015-code-in-production-today/" target="_blank" rel="noopener"
>&lt;strong>Deploying ES2015+ Code in Production Today&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å»¶ä¼¸å‰›æ‰çš„å°çµç¬¬äºŒé»ï¼ŒJS Code å¦‚æœè¦è·‘åœ¨ç€è¦½å™¨ä¸Šä¸å¯é¿å…è¦ç”¨ babel transpile æˆ–æ˜¯åŠ ä¸Šå„ç¨® polifillï¼Œä½†ç¾åœ¨å·²ç¶“æ˜¯ 2018äº†ï¼&lt;br>
å¾ˆå¤šç€è¦½å™¨å·²ç¶“è‰¯å¥½æ”¯æ´ ES 2015 +ï¼Œæ‰€ä»¥ babel transpile é–‹å§‹è®Šå¾—ä¸æ˜¯é€™éº¼å¿…è¦ï¼Œé€™ç¯‡æ–‡ç« æ·±å…¥æ¢è¨ &lt;code>å¦‚ä½•å¹³è¡¡èˆŠæ™‚ä»£ babel transpileçš„ legacy js èˆ‡ modern js&lt;/code>ã€‚&lt;/p>
&lt;p>é€™å€‹è­°é¡Œçš„è§£æ³•æ˜¯ &lt;code>&amp;lt;script type=â€moduleâ€&amp;gt;&lt;/code> ï¼Œå¦‚æœç€è¦½å™¨æ”¯æ´ ESM Moduleï¼Œé‚£ä»–å°±å¯ä»¥æ”¯æ´ &lt;code>async / await&lt;/code> ã€ &lt;code>class&lt;/code>ã€ &lt;code>arrow function&lt;/code> ã€ &lt;code>fetch&lt;/code> ç­‰ç­‰&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ can i use çš„æ”¯æ´ç¨‹åº¦åˆ†ä½ˆ&lt;/p>
&lt;p>&lt;a class="link" href="https://caniuse.com/#feat=es6-module" target="_blank" rel="noopener"
>&lt;strong>Can I use&amp;hellip; Support tables for HTML5, CSS3, etc&lt;/strong>&lt;/a>&lt;/p>
&lt;p>Chrome / Safari / Firefox / Edge è¿‘å…©ã€ä¸‰å€‹ç‰ˆæœ¬éƒ½è‰¯å¥½æ”¯æ´ï¼ŒIEå°±ç®—äº†â€¦..&lt;/p>
&lt;h4 id="é–‹ç™¼é‡é»">é–‹ç™¼é‡é»&lt;/h4>
&lt;p>é–‹ç™¼æ™‚ä½¿ç”¨ ES 2015+ èªæ³•é–‹ç™¼ï¼Œé€éæ‰“åŒ…å·¥å…·(webpack ã€ gulpç­‰)ä¾†å‘¼å« babel ç”¢ç”Ÿå…©ä»½ç¨‹å¼ç¢¼ï¼š main.mjsã€ main.es5.js&lt;/p>
&lt;p>&lt;code>.mjs&lt;/code> æ˜¯æŒ‡æ”¯æ´ ES Module çš„ js file å‰¯æª”åï¼›è€Œå¦ä¸€å€‹å°±æ˜¯ transpile çµ¦éæ™‚ç€è¦½å™¨ä½¿ç”¨çš„ ES5 èªæ³•ã€‚&lt;/p>
&lt;p>babel config å¯ä»¥åƒè€ƒä½œè€…åœ¨å…§æ–‡æä¾›çš„ï¼Œä¸»è¦å°±æ˜¯æ”¹ target èˆ‡ output æª”å&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">**targets**:{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="gs">**browsers**&lt;/span>:[
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;&amp;gt; 1%&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;last 2 versions&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;Firefox ESR&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">**targets**:{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="gs">**browsers**&lt;/span>:[
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;Chrome &amp;gt;= 60&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;Safari &amp;gt;= 10.1&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;iOS &amp;gt;= 10.3&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;Firefox &amp;gt;= 54&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#39;Edge &amp;gt;= 15&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">},
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ html pageä¸­ï¼Œå¼•ç”¨ js æ”¹æˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!-- Browsers with ES module support load this file. --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;module&amp;#34;&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;main.mjs&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!-- Older browsers load this file (and module-supporting --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!-- browsers know \*not\* to load this file). --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">nomodule&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;main.es5.js&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>èˆŠç‰ˆç€è¦½å™¨çœ‹ä¸æ‡‚ type=â€moduleâ€ å°±æœƒå¿½ç•¥ï¼Œæ”¹æˆè¼‰å…¥å¦ä¸€å€‹ moduleï¼›&lt;br>
åä¹‹ç¾ä»£ç€è¦½å™¨å°±è¼‰å…¥ main.mjsã€‚&lt;/p>
&lt;h4 id="é™åˆ¶èˆ‡æ³¨æ„äº‹é …">é™åˆ¶èˆ‡æ³¨æ„äº‹é …&lt;/h4>
&lt;p>éœ€æ³¨æ„ä»¥ä¸‹å¹¾é»äº‹é …&lt;/p>
&lt;ol>
&lt;li>å¦‚æœç€è¦½å™¨è¦ä½¿ç”¨Â .mjsï¼Œè¨˜å¾— server response header è¦åŠ  &lt;code>content-type:text/javascript&lt;/code> ï¼Œå¦å‰‡ç„¡æ³•ä»”å…¥&lt;/li>
&lt;li>ES Module è¡Œç‚ºé¡ä¼¼æ–¼ &lt;code>&amp;lt;script defer&amp;gt;&lt;/code> ï¼Œä¹Ÿå°±æ˜¯æœƒç­‰åˆ° document parse å®Œæˆæ‰æœƒåŸ·è¡Œï¼Œå¦‚æœæœ‰éœ€è¦ç«‹å³åŸ·è¡Œçš„éœ€æ±‚ï¼Œå°±è¦æŠŠ code æ‹†å‡ºä¾†&lt;/li>
&lt;li>Module æ˜¯è·‘åœ¨ &lt;code>strict mode&lt;/code> ï¼Œæ‰€ä»¥è¦èªæ³•ç­‰æ”¯æ´åš´æ ¼æ¨¡å¼&lt;/li>
&lt;li>Module è¡Œç‚ºèˆ‡ä¸€èˆ¬ script ç•¥æœ‰ä¸åŒï¼Œä¾‹å¦‚è®Šæ•¸ä¸æœƒå…¨å±€æ±¡æŸ“&lt;br>
ä¾‹å¦‚èªª &lt;code>var a = 123&lt;/code> ï¼Œåœ¨ script ä¸­å¯ä»¥ç”¨ window.a ä¾†è®€å–ï¼Œä½†æ˜¯ Module ä¸æœƒã€‚&lt;/li>
&lt;li>æ³¨æ„ Safari 10 ä¸æ”¯æ´ nomoduleï¼Œæ‰€ä»¥è¦å¦å¤–è£ polyfill&lt;/li>
&lt;li>å¦‚æœ node_modules æœ‰ç”¨åˆ° ES2015+ moduleï¼Œè¨˜å¾— babel config éœ€è¦é¡å¤–è™•ç†&lt;/li>
&lt;/ol>
&lt;h3 id="è£œæ›´">è£œæ›´&lt;/h3>
&lt;p>æœ€è¿‘çœ‹åˆ°çš„å¥½æ–‡ç« ï¼Œä½ çœŸçš„çŸ¥é“ Babel Transpile éå¾Œçš„ç¨‹å¼ç¢¼é•·æ€æ¨£å—ï¼Ÿ&lt;/p>
&lt;p>&lt;a class="link" href="https://medium.com/@WebReflection/avoiding-babels-production-bloat-d53eea2e1cbf" target="_blank" rel="noopener"
>&lt;strong>Avoiding Babelâ€™s Production Bloat&lt;/strong>&lt;/a>&lt;/p>
&lt;p>é€™ç¯‡æ–‡ç« æäº†å¹¾å€‹åƒ class / destructure / generator ç­‰èªæ³•å¦‚ä½•è¢« Babel è½‰è­¯æˆ ES5çš„èªæ³•ï¼Œæ•´å€‹ç¨‹å¼ç¢¼çš„è¤‡é›œåº¦èˆ‡é«”ç©éƒ½é©šäººçš„æˆé•·ï¼›&lt;br>
å¦‚æœç¶²ç«™ä¸»è¦åœ¨èˆŠå‹ç€è¦½å™¨ï¼Œæœ€å¥½æ˜¯è€ƒæ…®ç”¨èˆŠçš„èªæ³•ã€‚&lt;/p>
&lt;h4 id="å¥½è™•">å¥½è™•&lt;/h4>
&lt;ol>
&lt;li>Module Size&lt;br>
ç¯€çœç´„ 50%!&lt;/li>
&lt;li>Parse TIme&lt;br>
ç¯€çœç´„ 55%!&lt;/li>
&lt;/ol></description></item><item><title>V8 å¦‚ä½•å„ªåŒ– async / await</title><link>https://yuanchieh.page/posts/2018/2018-12-25-v8-%E5%A6%82%E4%BD%95%E5%84%AA%E5%8C%96-async-/-await/</link><pubDate>Tue, 25 Dec 2018 13:06:04 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-12-25-v8-%E5%A6%82%E4%BD%95%E5%84%AA%E5%8C%96-async-/-await/</guid><description>&lt;p>JS åŸºæ–¼äº‹ä»¶é©…å‹•ï¼Œå¤§é‡çš„ Promise å……æ–¥åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œå…¶å¾Œåœ¨ ES2017 åŠ å…¥äº† async/ await èªæ³•ç³–å¾Œï¼Œè®“éåŒæ­¥ä»£ç¢¼æ›´åŠ ç°¡æ½”èˆ‡ç›´è¦ºï¼›&lt;/p>
&lt;p>ä½†æ˜¯ async / await ä¸å–®å–®æ˜¯èªæ³•ç³–ï¼Œå¾ä¸€é–‹å§‹æœƒæœ‰ä¸å°çš„ overheadï¼Œv8 team ä¸æ–·çš„å„ªåŒ–åˆ°ä»Šæ—¥èˆ‡åŸç”Ÿçš„ Promise chain æ•ˆèƒ½ä¸ç›¸ä¸Šä¸‹ï¼Œç”šè‡³ä½¿ç”¨ async / await æ•ˆèƒ½æ›´å„ªæ–¼ Promise chain äº†!&lt;/p>
&lt;p>ä»¥ä¸‹å…§å®¹æ•´ç†è‡ª&lt;/p>
&lt;p>&lt;a class="link" href="https://v8.dev/blog/fast-async#fn2" target="_blank" rel="noopener"
>https://v8.dev/blog/fast-async#fn2&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__YyZo6l5__VFtYWyILzqHCnQ.jpeg"
loading="lazy"
alt="åœ–ç‰‡ä¾†è‡ª v8Â å®˜ç¶²"
>
åœ–ç‰‡ä¾†è‡ª v8Â å®˜ç¶²&lt;/p>
&lt;p>V8 åœ¨åŸ·è¡Œ async awaitæ™‚ï¼Œæœƒé€šéä¸€å€‹è½‰æ›ï¼Œæµç¨‹å¤§æ¦‚æ˜¯&lt;/p>
&lt;ol>
&lt;li>å…ˆå°‡ await è½‰æˆ promise&lt;/li>
&lt;li>åŠ ä¸Š Handlers&lt;/li>
&lt;li>åœæ­¢ function é‹ä½œä¸¦å›å‚³ implicit_promise&lt;/li>
&lt;/ol>
&lt;p>å…¶ä¸­çš„åƒæ•¸ promise ç›®çš„æ˜¯ &lt;code>async function æœƒç­‰åˆ° await å®Œæˆæ‰æœƒä¸‹ä¸€æ­¥&lt;/code> ï¼›&lt;br>
è€Œ throwaway promise å‰‡å¦æœ‰ä»–ç”¨ï¼Œç¨å¾Œæœƒè§£é‡‹&lt;/p>
&lt;p>æ‰€ä»¥æ•´é«”ä¸Šä¸€å€‹ aysnc / await æœƒé€ æˆ &lt;code>2å€‹é¡å¤–çš„ JSPromise ä»¥åŠ 3å€‹é¡å¤–çš„ Mircorticks!&lt;/code>&lt;/p>
&lt;h3 id="å„ªåŒ–">å„ªåŒ–&lt;/h3>
&lt;h4 id="å–æ¶ˆå°-await-function-å¤šåŒ…ä¸€å±¤promise">å–æ¶ˆå° await function å¤šåŒ…ä¸€å±¤Â Promise&lt;/h4>
&lt;p>å¤§å¤šæ•¸ await å¾Œé¢æ¥çš„éƒ½æ˜¯ promiseï¼Œé‚£ç‚ºä»€éº¼è¦åœ¨å¤šæµªè²»ä¸€å€‹ Promise å‘¢ï¼Ÿ&lt;br>
ç›´æ¥æ”¹ç”¨ promiseResolve()ï¼Œå¦‚æœåŸæœ¬æ˜¯ Promise å°±ç›´æ¥å›å‚³ï¼Œå¦‚æœä¸æ˜¯åœ¨å¤šåŒ…ä¸€å±¤ Promiseï¼Œå¦‚æ­¤å°±å¯èƒ½å„ªåŒ–æ‰ä¸€å€‹ Promise é‚„å…©å€‹ MicroTasksï¼&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__VZ6rECQaskS2v__wQ3LEgKQ.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>ç›´æ¥å›å‚³Promise è·Ÿå¤šåŒ…ä¸€å±¤ Promise æœ‰ä»€éº¼å·®åˆ¥å‘¢ï¼Ÿ&lt;/p>
&lt;p>åƒè€ƒgithub issue è¨è«–çš„å…¶ä¸­ä¸€å€‹æ¡ˆä¾‹&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/tc39/ecma262/pull/1250" target="_blank" rel="noopener"
>**Normative: Reduce the number of ticks in async/await by MayaLekova&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">promise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(...&lt;/span>&lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;then called&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">prototype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">promise&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">f&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥è©¦è‘—åœ¨ Chrome 71 è·Ÿ 73(ç¾ç‚º Canaryç‰ˆ)åŸ·è¡Œï¼Œæœƒç™¼ç¾ 73 å„ªåŒ–éå¾Œä¸æœƒå†å° &lt;code>then called&lt;/code> ï¼Œå› ç‚ºå°‘äº†ç”¨ Promise å¤šåŒ…ä¸€å±¤ï¼Œå·²ç¶“ resolved çš„ promise å°±æœƒç›´æ¥å›å‚³è€Œä¸æœƒåœ¨ call ä¸€æ¬¡ then functionã€‚&lt;/p>
&lt;p>é€™éƒ¨åˆ†æœƒå½±éŸ¿å° Promise åš Monkey Patch çš„ç”¨æˆ¶ï¼Œæ‰€ä»¥åœ¨ github issue ä¸‹æœ‰ä¸åŒçš„è¨è«–ï¼Œå¯ä»¥çœ‹åˆ°ç¶­è­·è€…å°æ–¼èªè¨€åŠŸèƒ½ä¸Šèˆ‡ä¸€è‡´æ€§ä¸Šçš„å–æ¨ï¼Œå¤§è‡´ä¸Šå°±æ˜¯&lt;code>ä¸é¼“å‹µå° Promise.then åš Monkey Patchçš„æ“ä½œ&lt;/code>ã€‚&lt;/p>
&lt;h3 id="å»æ‰-internal-promise-throwaway">å»æ‰ internal promise ï¼šthrowaway&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__IvdP7Fh9NYfmsxIKu7V21A.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>åœ¨æ–‡ç« ä¸­æåˆ° throwaway ä¹‹æ‰€ä»¥å­˜åœ¨æ˜¯ç‚ºäº†æ»¿è¶³ Spec å°æ–¼performPromiseThen APIçš„æ“ä½œÂ &lt;br>
(only there to satisfy the API constraints of the internal &lt;code>performPromiseThen&lt;/code> operation in the spec.)&lt;/p>
&lt;p>å¾Œä¾†åˆ° Twitter ç™¼å•ï¼Œä½œè€…å›è¦†èªªã€ŒItâ€™s still there only when async hooks are enabled (in Node.js)â€Šâ€”â€Šthey attach some internal data on it.ã€&lt;/p>
&lt;p>æ‰€ä»¥åœ¨ Nodejsé‚„æœƒä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ Browser å°±ä¸æœƒäº†ï¼Œé€™éƒ¨åˆ†çœ‹ä¾†ä¸ç”¨å¤ªåœ¨æ„ã€‚&lt;/p>
&lt;h3 id="nodejs-v8çš„å°bug">Nodejs v8Â çš„å°Bug&lt;/h3>
&lt;p>Nodejs åœ¨ version 8 æœ‰å·åšå„ªåŒ–ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ­¥çœæ‰ï¼Œå¦‚æœç™¼ç¾æ˜¯ await æ¥promise å°±ä¸æœƒå¤šåŒ…ä¸€å±¤ï¼Œå¯ä»¥ç”¨ v8 / v10 å°æ¯”è·‘ä¸‹åˆ—ç¨‹å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;after:await&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;tick:a&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;tick:b&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœƒç™¼ç¾ version 8 çš„æ‰“å°çµæœæ˜¯ &lt;code>after:await -&amp;gt; tick:a -&amp;gt; tick:b&lt;/code> ï¼Œè€Œ version 10 å‰‡æ˜¯ç¬¦åˆç›®å‰ Specçš„ &lt;code>tick:a -&amp;gt; tick:b -&amp;gt; after:await&lt;/code> ã€‚&lt;/p>
&lt;p>version 8 å› ç‚º p å·²ç¶“æ˜¯ resolved promiseæœƒåŸ·è¡ŒåŸ·è¡Œï¼›version 10 å¤šåŒ…ä¸€å±¤ Promise å°±æœƒç­‰åˆ°ä¸‹ä¸€æ¬¡ microtask queue åŸ·è¡Œæ™‚æœŸæ‰æœƒåŸ·è¡Œã€‚&lt;/p>
&lt;h3 id="é–‹ç™¼é‡é»">é–‹ç™¼é‡é»&lt;/h3>
&lt;p>è«‹ä½¿ç”¨åŸç”Ÿ JS Engine æä¾›çš„ Promiseï¼Œè€Œä¸æ˜¯å…¶ä»– JS Library çš„ Promiseæˆ–é Promise é¡å‹çš„å‡½ç¤ºï¼Œé€™æ¨£åœ¨åº•å±¤æœƒæœ‰æ›´å¥½çš„æ•ˆèƒ½å„ªåŒ– ( çœäº†å…©å€‹ Microtaskèˆ‡ä¸€å€‹å¤šé¤˜çš„ Promise )&lt;/p></description></item><item><title>Stripe ä¸²é‡‘æµæ•™å­¸ (ä¸Š)</title><link>https://yuanchieh.page/posts/2018/2018-11-17-stripe-%E4%B8%B2%E9%87%91%E6%B5%81%E6%95%99%E5%AD%B8-%E4%B8%8A/</link><pubDate>Sat, 17 Nov 2018 07:53:08 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-11-17-stripe-%E4%B8%B2%E9%87%91%E6%B5%81%E6%95%99%E5%AD%B8-%E4%B8%8A/</guid><description>&lt;p>Stripe æ˜¯ä¸€é–“åœ‹éš›çš„é‡‘æµæ”¯ä»˜å…¬å¸ï¼Œæä¾› client (Web / Android / iOSç­‰)æ”¯ä»˜ä»‹é¢èˆ‡ server-side APIï¼Œç”¨æœ€çŸ­çš„æ™‚é–“å°±å¯ä»¥è®“æœå‹™æ¥ä¸Šé‡‘æµï¼›&lt;br>
æ”¯æ´æ”¯ä»˜æ–¹å¼æœ‰Visa/Master Cardç­‰å¤šé–“ä¿¡ç”¨å¡æ”¯ä»˜ã€Google Pay ã€Apple Payç­‰ç­‰ï¼›&lt;br>
å…¶ä¸­é‡‘æµäº¤æ˜“æœå‹™ï¼š&lt;/p>
&lt;ol>
&lt;li>å…¥é–€æœƒå“¡æœå‹™Payment(äº¤æ˜“)ã€Billing(é–‹ç«‹ç™¼ç¥¨)ã€Connect(ä¸­é–“å•†ï¼Œå‘Aæ”¶éŒ¢ä¸¦è½‰çµ¦Bå¤šå°‘éŒ¢)ï¼›&lt;/li>
&lt;li>å…¶ä»–éœ€è¦å¤šèŠ±éŒ¢çš„åŠ å€¼æœå‹™ï¼š&lt;br>
Sigma(æ”¯æ´SQLç”¢ç”Ÿå ±è¡¨)ã€Altas(ç¾åœ‹é–‹å…¬å¸)ã€Radar(é‡‘èè©é¨™åµæ¸¬ï¼Œé è¨­æœ‰æ”¯æ´ä½†ä»˜è²»æœ‰é€²éšåŠŸèƒ½)&lt;/li>
&lt;li>é‚€è«‹åˆ¶çš„åŠ å€¼æœå‹™ï¼š&lt;br>
Terminal(æ•´åˆç¡¬é«”Readerï¼Œé™å®šæŒæœ‰è©²ç¡¬é«”æ‰èƒ½äº¤æ˜“)ã€Issuing(å¯ä»¥è‡ªå·±ç™¼å¡ï¼ŒStripe æä¾›è™›æ“¬å¡èˆ‡å¯¦é«”å¡ç™¼é€)&lt;/li>
&lt;/ol>
&lt;p>é€™æ¬¡ä¸»è¦å˜—è©¦ Payment / Billing çš„ä¸²æ¥ï¼Œå…§å®¹åƒè€ƒè‡ª&lt;a class="link" href="https://stripe.com/docs" target="_blank" rel="noopener"
>å®˜æ–¹æ–‡ä»¶&lt;/a>ï¼ŒåŒ…å« client-side(æ¡ç”¨ React) èˆ‡ server-side(æ¡ç”¨ Nodejs SDK)ï¼Œä¸å¾—ä¸èªª Stripeå°æ–¼é–‹ç™¼è€…éå¸¸å‹å–„ï¼Œæ–‡ä»¶éå¸¸å¥½æ‡‚ä¸”å„å¼èªè¨€èˆ‡æ’ä»¶SDKéƒ½æ”¯æ´å®Œæ•´ï¼Œæ‰€ä»¥åªéœ€è¦å°‡SDKæ›æ‰æˆ‘æƒ³ä»¥ä¸‹çš„æ¦‚å¿µéƒ½æ˜¯ç›¸åŒçš„ã€‚&lt;/p>
&lt;p>2018/11: å…¨çƒåœ°å€éƒ½å¯ä»¥ä»˜æ¬¾ï¼Œåªæ˜¯è¦é–‹é€š stripeå¸³æˆ¶åªæœ‰26å€‹åœ‹å®¶ï¼Œç›®å‰ä¸æ”¯æ´å°ç£&lt;/p>
&lt;p>ä¸»è¦ä»‹ç´¹ Payment / Billing çš„æ¦‚å¿µï¼Œä»¥åŠè©¦åœ–ç†è§£ StripeèƒŒå¾Œçš„é‹è¡Œæ©Ÿåˆ¶&lt;/p>
&lt;h1 id="payment">Payment&lt;/h1>
&lt;p>åˆ†æˆå…©æ­¥é©Ÿï¼Œåœ¨client-side ç½®å…¥ stripe ä»˜è²»å…ƒä»¶(å¦‚ html form)ï¼Œç”¨æˆ¶è¼¸å…¥å¾Œæœƒç”¢ç”Ÿ tokenè½‰äº¤çµ¦ serverï¼Œæ¥è‘— server ç”¨æ­¤ tokené©—è­‰ä¸¦å¯¦éš›æ‰£æ¬¾&lt;/p>
&lt;p>åœ¨Stripe ä¸­ï¼Œå®ƒå®šç¾©å¾ˆå¤šç‰©ä»¶ï¼Œæ¯å€‹ç‰©ä»¶éƒ½æœ‰å„è‡ªåƒæ•¸èˆ‡å°è£çš„ç”¨æ³•ï¼Œæ‰€ä»¥æ–‡ä»¶éå¸¸çš„ OOPï¼Œæ‰€ä»¥å°é–‹ç™¼è€…ä¾†èªªå¾ˆå¥½ç†è§£èˆ‡ä¸Šæ‰‹&lt;/p>
&lt;h2 id="checkout">Checkout&lt;/h2>
&lt;p>Checkout æ˜¯ä¸€å€‹ Stripe æä¾›ç°¡åŒ–éå¾Œçš„ Paymentæ–¹å¼ï¼Œ é–‹ç™¼è€…åªè¦æ¥ä¸Š Stripe æä¾›çš„ Client SDKï¼Œç”¨æˆ¶çš„äº¤æ˜“ç´°ç¯€å°±æœƒç›´æ¥ä¸Ÿçµ¦ Stripe è™•ç†ä¸¦ä»¥ Tokenæ–¹å¼å›å‚³ï¼Œé–‹ç™¼è€…å†å» Server Side æ‹¿ Tokenåšå¾ŒçºŒçš„æ‡‰ç”¨ã€‚&lt;/p>
&lt;p>æ•´åˆ Stripe Client-sideæœ‰å…©ç¨®æ¨¡å¼ &lt;code>Simple&lt;/code>ã€&lt;code>Custom&lt;/code>&lt;/p>
&lt;h3 id="simple">Simple&lt;/h3>
&lt;p>ç”¨ä¸€å€‹ &lt;code>&amp;lt;form/&amp;gt;&lt;/code> å®šç¾©å¦‚ä½•è½‰äº¤çµ¦tokençµ¦ serverï¼Œæ¥è‘—å…§éƒ¨åµŒå…¥ stripe script ä¸¦å®šç¾©åƒæ•¸ï¼Œæœ€åŸºæœ¬çš„å¹¾å€‹åƒæ•¸&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">form&lt;/span> &lt;span class="na">action&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;your-server-side-code&amp;#34;&lt;/span> &lt;span class="na">method&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;https://checkout.stripe.com/checkout.js&amp;#34;&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;stripe-button&amp;#34;&lt;/span> &lt;span class="na">data-key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;YOUR_KEY&amp;#34;&lt;/span> &lt;span class="na">data-amount&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;999&amp;#34;&lt;/span> &lt;span class="na">data-name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;COMPANY&amp;#34;&lt;/span> &lt;span class="na">data-description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;Example charge&amp;#34;&lt;/span> &lt;span class="na">data-image&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;https://stripe.com/img/documentation/checkout/marketplace.png&amp;#34;&lt;/span> &lt;span class="na">data-locale&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;auto&amp;#34;&lt;/span> &lt;span class="na">data-currency&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;hkd&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">form&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°ï¼Œå°±é€™éº¼ç°¡å–®å°±å®Œæˆäº†ï¼Œæ¥è‘—å°±æ˜¯åˆ° formå®šç¾©çš„ server api æ”¶ tokenè³‡æ–™&lt;/p>
&lt;h3 id="custom">Custom&lt;/h3>
&lt;p>å¦‚æœå¸Œæœ›æœ‰æ›´ç´°ç·»çš„ç”¨æˆ¶é«”é©—ï¼Œä¾‹å¦‚å®¢è£½åŒ–è‡ªå·±çš„ä»˜è²»è¡¨å–®ã€é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ç­‰ï¼Œå°±éœ€è¦è‡ªå·±å®¢è£½åŒ–ï¼Œé€™éƒ¨åˆ†ä¹Ÿååˆ†çš„ç°¡å–®ï¼Œç”¨ vanilla js ä¹Ÿå¯ä»¥è¼•é¬†å®Œæˆ&lt;/p>
&lt;p>é€™éƒ¨åˆ†ç¨‹å¼ç¢¼å¯ä»¥åƒè€ƒ&lt;a class="link" href="https://stripe.com/docs/checkout#integration-custom" target="_blank" rel="noopener"
>æ–‡ä»¶&lt;/a>&lt;/p>
&lt;h4 id="åƒæ•¸è¨­å®š">åƒæ•¸è¨­å®š&lt;/h4>
&lt;p>ä»¥ä¸Šçš„ Simple/Custome å°±æ˜¯ä¸€å€‹åŸºæœ¬çš„ Elementï¼Œè£¡é ­å®šç¾©çš„ &lt;code>data-*&lt;/code> å±¬æ€§å‰‡æœƒæ±ºå®šç”¢ç”Ÿçš„ Checkout ç‰©ä»¶å±¬æ€§ï¼Œå¸¸è¦‹çš„å±¬æ€§æœ‰&lt;/p>
&lt;ol>
&lt;li>&lt;code>data-key [required] &lt;/code>ç•¶å¸³è™ŸæˆåŠŸæ¿€æ´»å¾Œï¼Œæœƒæœ‰å…©çµ„ key / secret çµ„åˆï¼Œåˆ†åˆ¥æ˜¯ &lt;code>live / test&lt;/code> ï¼Œå°æ‡‰å°±æ˜¯æ­£å¼æ©Ÿèˆ‡æ¸¬è©¦æ©Ÿçš„æ¦‚å¿µ&lt;/li>
&lt;li>&lt;code>token / source [required in custom mode]&lt;/code>&lt;br>
é€™å…©å€‹å°æ‡‰ callback functionï¼Œåˆ†åˆ¥å°æ‡‰æ”¶åˆ° Token / Sourceï¼ŒTokenä¸»è¦æ˜¯serverå¯ä»¥å–å¾—ç”¨æˆ¶çš„éƒ¨åˆ†ä¿¡ç”¨å¡è³‡æ–™ï¼ŒSourceå‰‡æ˜¯ä»£è¡¨ç”¨æˆ¶çš„å…¶ä»–ä»˜æ¬¾æ–¹å¼(é€™äº›è³‡æ–™çš„å–å¾—è¦é€éå¾ŒçºŒçš„åƒæ•¸è¨­å®š)&lt;/li>
&lt;li>&lt;code>data-name / data-description / data-image / data-locale / data-amount [highly recommend]&lt;/code>&lt;br>
å°æ‡‰æœƒé¡¯ç¤ºåœ¨ stripe ä»˜è²»é é¢çš„è³‡è¨Šï¼Œlocaleæ˜¯è¨­å®šè¡¨å–®èªè¨€&lt;/li>
&lt;li>&lt;code>data-zip-code / data-billing-address [highly recommend] &lt;/code>ç”¨æˆ¶çš„åœ°å€ç›¸é—œï¼ŒStripeæ¨è–¦å‘ç”¨æˆ¶ç´¢å– zip-codeï¼Œzip-codeå¯ä»¥åœ¨å¾Œå°è¨­å®šç•¶ä½œ Radarçš„é©—è­‰æ¢ä»¶ï¼Œç¦æ­¢å¯ç–‘çš„Payment&lt;/li>
&lt;li>&lt;code>data-email / open / close [optional]&lt;/code>Â &lt;br>
é‚„æœ‰ä¸€äº›æ¬„ä½å¯ä»¥å®šç¾©å°±ç¿»æ–‡ä»¶äº†ï¼Œopen / closeå‰‡æ˜¯ callback functionæœƒåœ¨è¡¨å–®é–‹å•Ÿèˆ‡é—œé–‰æ™‚å€™å‘¼å«ï¼ŒåŒæ¨£åªç”¨æ–¼ custom mode&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ç‰¹åˆ¥æ³¨æ„ï¼Œé–‹ç™¼è€…å®Œå…¨ä¸éœ€è¦æ¥è§¸åˆ°ç”¨æˆ¶çš„ä¿¡ç”¨å¡è³‡æ–™ï¼Œåœ¨æ²’æœ‰è¬¹æ…è©•ä¼°ä¹‹å‰ï¼Œä¸è¦å¦„æƒ³å„²å­˜ç”¨æˆ¶ä¿¡ç”¨å¡è³‡æ–™ï¼&lt;br>
å› ç‚ºå¦‚æœè¦ã€Œåˆæ ¼ã€å„²å­˜ç”¨æˆ¶ä¿¡ç”¨å¡è³‡æ–™ï¼Œå¿…é ˆé PCI-DSS åœ‹éš›ä¿¡ç”¨å¡çµ„ç¹”è¯åˆè¦ç¯„çš„æ”¯ä»˜å®‰å…¨èªè­‰ï¼Œä½†é€™éƒ¨åˆ†è¦ç¯„åš´æ ¼ï¼Œè€Œä¸”å¿…é ˆå®šæœŸåšæ¼æ´æƒæ&lt;br>
æ‰€ä»¥ Stripe ä¹Ÿæåˆ°ä»–å€‘ç‚ºäº†è®“é–‹ç™¼è€…ä¾¿åˆ©ï¼Œæ‰€ä»¥ä¿¡ç”¨å¡è³‡æ–™éƒ½é‚„æ˜¯é€šéä»–å€‘ï¼Œåƒ…å›å‚³ Tokenå½¢å¼ä¾›å¾ŒçºŒæ‰£æ¬¾ä½¿ç”¨ï¼Œä¸ç”¨å†å¤šç…©æƒ±é€™äº›è³‡å®‰ä¸Šçš„å•é¡Œ&lt;/p>
&lt;/blockquote>
&lt;h4 id="server-side">Server-side&lt;/h4>
&lt;p>å‰ç«¯å–å¾— Token å¾Œï¼Œå°±å¯ä»¥å¾€ server ä¸Ÿï¼Œé€™å€‹ Tokenæ˜¯&lt;code>ä¸€æ¬¡æ€§æ‰£æ¬¾ä½¿ç”¨&lt;/code>ï¼Œæ­¤å¤–å°±ç­‰åŒæ–¼ Sourceçš„æ•ˆåŠ›ï¼Œä¹Ÿå°±æ˜¯ç”¨æ–¼å¯¦éš›æ‰£æ¬¾çš„æ”¯ä»˜æ–¹å¼ï¼Œå¾ŒçºŒæœƒè©³ç´°ä»‹ç´¹ä»€éº¼æ˜¯ Source&lt;/p>
&lt;p>ä»¥ä¸Šæ˜¯æœ€åŸºæœ¬çš„ Checkout ä¿¡ç”¨å¡ä»˜æ¬¾ï¼Œå› ç‚ºä¿¡ç”¨å¡æ˜¯ç«‹å³æ‰£æ¬¾å°±èƒ½çŸ¥é“çµæœï¼Œä½†å¦‚æœéœ€è¦æ”¯æ´å¦‚éŠ€è¡Œè½‰å¸³ç­‰å…¶ä»–éœ€è¦ç”¨æˆ¶é¡å¤–æˆæ¬Šèˆ‡æ”¯ä»˜çš„æµç¨‹ï¼Œå°±éœ€è¦ä»¥ä¸‹æ›´è¤‡é›œçš„è¨­è¨ˆ&lt;/p>
&lt;h2 id="å¤šå…ƒæ”¯ä»˜æ–¹å¼">å¤šå…ƒæ”¯ä»˜æ–¹å¼&lt;/h2>
&lt;p>Stripeé€éç”¢ç”Ÿ &lt;strong>Source&lt;/strong> ç‰©ä»¶ä»£è¡¨ä¸åŒçš„æ”¯ä»˜æ–¹å¼ï¼Œæ”¯ä»˜æ¦‚å¿µä¸Šå¯ä»¥åˆ†æˆ&lt;br>
&lt;code>ä»˜æ¬¾æ˜¯åŒæ­¥èˆ‡éåŒæ­¥å®Œæˆ(async vs sync) éŒ¢å¦‚ä½•å¾ç”¨æˆ¶è½‰å‡º(push vs pull) æ˜¯å¦å¯é‡è¤‡ä½¿ç”¨(reusable)&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚èªªä¿¡ç”¨å¡å°±æ˜¯ &lt;code>sync + pull&lt;/code> ï¼Œç•¶ç”¨æˆ¶è¼¸å…¥ä¿¡ç”¨å¡å¾Œï¼Œå°±æœƒç«‹åˆ»åŸ·è¡Œæ‰£æ¬¾å‹•ä½œ(sync)ï¼Œå°±ç›´æ¥å¾ç”¨æˆ¶å¸³æˆ¶æ‰£æ¬¾æˆ–æ˜¯ç”¢ç”Ÿæ”¯ä»˜ç´€éŒ„(pull)&lt;/p>
&lt;p>è€ŒåƒéŠ€è¡Œç”¢ç”Ÿè™›æ“¬å¸³è™Ÿæä¾›ATMä»˜æ¬¾æ˜¯ &lt;code>async + push&lt;/code>ï¼Œç”¨æˆ¶å¯èƒ½åœ¨éå¹¾å¤©æ‰å»ä»˜æ¬¾(async)ï¼Œè€Œç”¨æˆ¶æœ¬èº«éœ€è¦ä¸»å‹•å»ç”¢ç”Ÿæ”¯ä»˜çš„å‹•ä½œ(èµ°åˆ°ATMå‰é¢ï¼Œä¹Ÿå°±æ˜¯ push)&lt;/p>
&lt;p>å…¶ä»–é‚„æœ‰å¤šç¨®åœ°åŸŸæ€§çš„æ”¯ä»˜æ–¹å¼ï¼Œå› ç‚ºä¸ç†Ÿæ‚‰å°±ä¸å†å¤šæ•˜è¿°ï¼Œå¯ä»¥åƒè€ƒ&lt;a class="link" href="https://stripe.com/docs/sources" target="_blank" rel="noopener"
>æ–‡ä»¶&lt;/a>&lt;/p>
&lt;p>Source ç‰©ä»¶å»ºç«‹åˆå§‹åŒ–ç‚º &lt;code>source.pending&lt;/code>ï¼Œæœ‰ webhook å¯ä»¥æ¥æ”¶ç‹€æ…‹çš„æ”¹è®Šï¼Œç•¶ç”¨æˆ¶æˆæ¬Šå¾Œæœƒè§¸ç™¼&lt;code>source.chargeable&lt;/code> ã€ç”¨æˆ¶æ‹’çµ•æˆæ¬Š&lt;code>source.failed&lt;/code> ã€éæœŸ&lt;code>source.canceled&lt;/code>&lt;/p>
&lt;p>Source æ­¤æ™‚åƒ…ä»£è¡¨æ”¯ä»˜æ–¹å¼ï¼Œå¯¦éš›çš„æ”¯ä»˜è¦é€é Source å»ºç«‹ &lt;strong>Charge&lt;/strong> ç‰©ä»¶ï¼ŒCharge ç‰©ä»¶åŒæ¨£æœ‰å¹¾å€‹ webhook å¯ä»¥ä¸²æ¥ï¼ŒéåŒæ­¥æ”¯ä»˜åˆå§‹åŒ–æœƒæ˜¯ç­‰å¾…ç”¨æˆ¶æ”¯ä»˜&lt;code>charge.pending&lt;/code> ã€æˆåŠŸæ”¶åˆ°ç”¨æˆ¶æ”¯ä»˜&lt;code>charge.succeeded&lt;/code> ã€èˆ‡æ”¯ä»˜å¤±æ•—&lt;code>charge.failed&lt;/code>&lt;/p>
&lt;p>webhook éƒ¨åˆ†å‰‡æ˜¯åœ¨å¾Œå°è¨­å®šã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ“·å–å®˜æ–¹æ¡ˆä¾‹ï¼Œåƒ…ä½œæ–¼ç†è§£ä½¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createSource&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;ach_credit_transfer&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currency&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;usd&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">owner&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">email&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;jenny.rosen@example.com&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">},}).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€™è£¡æœƒå›å‚³ SourceåŸºæœ¬è³‡æ–™å¦‚ idç­‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// é‚„æœ‰ç”¨æˆ¶éœ€è¦çŸ¥é“çš„è½‰å¸³è³‡è¨Šå¦‚éŠ€è¡Œå¸³è™Ÿ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ›webhookï¼ŒæŒ‡å®šsource.chargeable
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/webhook/to/source.chargable&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">body&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">read&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŸäº›æ”¯ä»˜æ–¹å¼æ˜¯å¯ä»¥å¤šæ¬¡æ‰£æ¬¾ï¼Œä¾‹å¦‚ä¿¡ç”¨å¡ï¼ŒStripe æä¾› Customer æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å‰µå»ºä¸€å€‹ Customer ä»£è¡¨ç”¨æˆ¶ï¼Œæ¥è‘—å°‡ Source ç¶å®šåˆ°è©²ç”¨æˆ¶ä¸Šï¼Œä¸€å€‹ç”¨æˆ¶å¯ä»¥ç¶å®šå¤šå€‹ Sourceï¼Œåˆ°æ™‚å€™å¦‚æœè¦æ‰£æ¬¾å¯ä»¥å¾ Sourceä¸­é¸æ“‡å…¶ä¸­ä¸€å€‹ï¼Œç›¸ç•¶çš„æ–¹ä¾¿&lt;br>
éœ€æ³¨æ„ Source å¿…é ˆæ˜¯ chargable æ‰å¯ä»¥æ‰£æ¬¾&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å»ºç«‹ customer
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">customers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">email&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;paying.user@example.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">source&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;src_18eYalAHEMiOZZp1l9ZTjSU0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">},&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">customer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// asynchronously called
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¦‚æœè¦æ‰£æ¬¾çš„è©±
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">charges&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">amount&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1099&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currency&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;eur&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">customer&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;cus_AFGbOSiITuJVDs&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">source&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;src_18eYalAHEMiOZZp1l9ZTjSU0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¯ä»¥ä¸æŒ‡å®š sourceï¼Œæœƒè‡ªå‹•æ‰¾ customer é è¨­çš„ source
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">charge&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// asynchronously called
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å°çµ">å°çµ!&lt;/h3>
&lt;p>çœ‹åˆ°æ˜¯ä¸æ˜¯æœ‰é»æšˆé ­è½‰å‘äº†å‘¢ï¼Œèªªå¥½çš„ Stripe å¾ˆç°¡å–®å‘¢ï¼ŸÂ &lt;br>
æˆ–è¨±é€™ä¹Ÿæ˜¯ç¨® &lt;code>simplicity but not simple&lt;/code>ï¼Œè¦æä¾›å¤šå…ƒçš„æ”¯ä»˜æ–¹å¼å‹¢å¿…å¸¶ä¾†é‚è¼¯çš„è¤‡é›œæ€§ï¼Œä½†æ˜¯æˆ‘è¦ºå¾— Stripe é€é OOPæ¢³ç†æ•´å€‹é‡‘èæ”¯ä»˜çš„éç¨‹ï¼Œå¸¶ä¾†æ¥µæ£’çš„ Developer Experienceèˆ‡ User Experienceï¼Œæ¥éå°ç£çš„ç´…è—ç¶ ä½ å°±æœƒçŸ¥é“Stripe æœ‰å¤šæ£’äº†&lt;/p>
&lt;p>å»¢è©±ä¸å¤šèªªï¼Œè®“æˆ‘ä¾†é‡æ–°æ•´ç†ä¸€ç¿»&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__BD5C6MvB8lXS5LBrrsFFdw.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>æœ€ä¸€é–‹å§‹æçš„ Checkout ä¿¡ç”¨å¡æ”¯ä»˜å–å¾—çš„Tokenï¼Œç®—æ˜¯ Sourceçš„ç°¡åŒ–ç‰ˆï¼Œæˆ‘çŒœç›®çš„æ˜¯ç‚ºäº†è®“æœ€å¿«é€Ÿæ¥ä¸²å¥½é‡‘æµçš„ä½œæ³•ï¼Œè€Œä¸”ä¿¡ç”¨å¡çš„æ”¯ä»˜è¡Œç‚ºç®—æ˜¯æœ€ç°¡å–®çš„ã€‚&lt;/p>
&lt;h2 id="billings">Billings&lt;/h2>
&lt;p>ç”¨æ–¼é‡è¤‡æ€§æ‰£æ¬¾èˆ‡é–‹ç«‹ç™¼ç¥¨&lt;/p>
&lt;h3 id="ç™¼ç¥¨ç‹€æ…‹æµç¨‹">ç™¼ç¥¨ç‹€æ…‹æµç¨‹&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__DelwxbDtN5ppfoxN.png"
loading="lazy"
alt="ç™¼ç¥¨æµç¨‹"
>&lt;/p>
&lt;p>Invoiceï¼Œä»£è¡¨ç™¼ç¥¨çš„ç‰©ä»¶ï¼Œä¸€å¼µç™¼ç¥¨å¯ä»¥å¤šç­†æ¬¾é … InvoiceItemsï¼Œå› ç‚ºä¸åŒçš„è²¡å‹™è¦åŠƒè€Œæœ‰æ¯”è¼ƒå¤šçš„ç‹€æ…‹å¯ä»¥è¨­&lt;/p>
&lt;ol>
&lt;li>åˆå§‹åŒ–ç‚º &lt;code>draft&lt;/code> ï¼Œæ­¤æ™‚ç™¼ç¥¨çš„è¨­å®šéƒ½é‚„å¯ä»¥åšèª¿æ•´ï¼Œç¢ºå®šå¾Œæˆ–æ˜¯é è¨­ä¸€å€‹å°æ™‚å¾Œæœƒè®Šæˆ &lt;code>open&lt;/code> ï¼›&lt;br>
åˆªé™¤å°±è®Šæˆ &lt;code>deleted&lt;/code>&lt;/li>
&lt;li>&lt;code>open&lt;/code> å‰‡ä»£è¡¨ç™¼ç¥¨ç¢ºèªäº†ï¼Œå¦‚æœç”¨æˆ¶ä»˜æ¬¾äº†å¯ä»¥èª¿æ•´ç‚º &lt;code>paid&lt;/code> ï¼Œå¯ä»¥é¸æ“‡è§¸ç™¼å¾ŒçºŒçš„ç™¼ç¥¨å¯„é€ç­‰æµç¨‹ï¼›&lt;br>
å¦‚æœç™¼ç¾ç”¨æˆ¶ç ´ç”¢ä¹‹é¡ç„¡æ³•æ”¯ä»˜ï¼Œå¯ä»¥åœ¨å¾Œå°å°‡æ­¤ç­†ç™¼ç¥¨è¨­å®šç‚º &lt;code>uncollectible&lt;/code> ï¼›&lt;br>
å¦‚æœç™¼ç¥¨æœ‰èª¤éœ€è¦ä½œå»¢ï¼Œå‰‡è¨­ç‚º &lt;code>Void&lt;/code>&lt;/li>
&lt;/ol>
&lt;h3 id="ä¸€æ¬¡æ€§é–‹ç«‹ç™¼ç¥¨-one-offinvoiceshttpsstripecomdocsbillinginvoicesone-off">ä¸€æ¬¡æ€§é–‹ç«‹ç™¼ç¥¨ &lt;a class="link" href="https://stripe.com/docs/billing/invoices/one-off" target="_blank" rel="noopener"
>one-offÂ invoices&lt;/a>&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">stripe&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;stripe&amp;#34;&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="s2">&amp;#34;sk_test_AyGgRZ5ZZkIETGtHDI3f1GAE&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å…ˆå»ºç«‹ç™¼ç¥¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">invoiceItems&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">customer&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;cus_DqZrTNCO4puf2p&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">amount&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2500&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currency&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;usd&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">description&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;One-time setup fee&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">},&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">invoiceItem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡å°æŸå€‹ç”¨æˆ¶åº•ä¸‹æ‰€æœ‰çš„InvoiceItemsé–‹ç«‹ç™¼ç¥¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">invoices&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">customer&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;cus_4fdAW5ftNQow1a&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">auto_advance&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// auto-finalize this draft after ~1 hour
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">invoice&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// asynchronously called
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>auto_advance ç®—æ˜¯å¾ˆé‡è¦çš„åƒæ•¸ï¼ŒStripe é è¨­åœ¨ Invoice å‰µå»ºä¹‹å¾Œæœƒæœ‰è‡ªå‹•åŒ–çš„å‹•ä½œï¼Œå¦‚ä¸€å°æ™‚å¾Œè‡ªå‹•è½‰æˆ open**ï¼Œä¸¦æœƒå‘ç”¨æˆ¶è‡ªå‹•æ‰£æ¬¾ (é è¨­ Source)æ¥è‘—è½‰æˆ** &lt;code>paid&lt;/code>ï¼Œä¸¦Email ç™¼é€ Receipt èˆ‡ Invoiceï¼›&lt;br>
å¦‚æœä¸æƒ³è¦è¨˜å¾—è¨­ç‚º false&lt;/p>
&lt;p>åœ¨é–‹ç«‹ç™¼ç¥¨ä¸Š Stripe éˆæ´»æ€§é —é«˜ï¼Œæ¯ä¸€ç­† InvoiceItem å¯ä»¥è¨­å®šè²»ç”¨/æŠ˜æ‰£/ç¨…ç‡ï¼ŒInvoiceItem å¯ä»¥æŒ‡å®šæ‰€å±¬çš„ Invoiceï¼Œæˆ–æ˜¯é è¨­æ­¸é¡åˆ°è©²ç”¨æˆ¶çš„ä¸‹ç­† open çš„Invoiceä¸­&lt;/p>
&lt;h3 id="è¨‚é–±åˆ¶æ‰£æ¬¾æœå‹™-subscription">è¨‚é–±åˆ¶æ‰£æ¬¾æœå‹™ subscription&lt;/h3>
&lt;p>æœ‰äº›é›²ç«¯æœå‹™éƒ½æ˜¯ä»¥å¹´æˆ–æ˜¯æœˆçš„è¨‚é–±æ”¶è²»åˆ¶åº¦ï¼ŒStripe ä¸­å¯ä»¥å®šç¾© Product èˆ‡ Planï¼Œä¾‹å¦‚èªªæœ‰ä¸€å€‹ Product æ˜¯ SaaSæœå‹™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">product&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">products&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;My SaaS Platform&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;service&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metadata&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// store anything you want
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡å°é€™å€‹ Productï¼Œå¯èƒ½æœƒæœ‰è¨±å¤šçš„æ”¶è²»æ–¹å¼ Planï¼Œå¯èƒ½æ˜¯æœˆç¹³/å­£ç¹³/å¹´ç¹³æˆ–æ˜¯æœ‰ä¸åŒçš„é©ç”¨æœŸé™ã€ä¹Ÿå¯èƒ½æœ‰å¤šç¨®åœ‹å®¶çš„ä¸åŒå®šåƒ¹ç­‰è¨­å®š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">plan&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">plans&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">product&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;prod_CbvTFuXWh7BPJH&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">nickname&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;SaaS Platform USD&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currency&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;usd&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">interval&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;month&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">amount&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Stripe æ”¯æ´åˆ†å±¤æ”¶è²»ï¼Œå¯ä»¥æŒ‡å®šå¤šç¨®æ¨¡å¼ï¼Œä¾‹å¦‚ ç•¶è¶…éä¸€å€‹é¡åº¦ï¼Œæ¯å€‹å•†å“è®Šå¤šå°‘éŒ¢ / åˆæˆ–æ˜¯åˆ†å¤šéšå±¤ï¼Œè¶…ééƒ¨åˆ†ç®—è©²åƒ¹æ ¼çš„éšæ¢¯å½¢æ”¶è²»&lt;/p>
&lt;p>ç•¶å…ˆå‰çš„ Customeæƒ³è¦è³¼è²·æ™‚ï¼Œæœƒå‰µå»ºä¸€å€‹è¨‚é–± Subscription çš„ç‰©ä»¶ï¼Œä¸¦æ±ºå®šè¦è¨‚é–±çš„ Planï¼Œå¦‚æœè¦ä¸€å€‹è¨‚é–±å¤šå€‹ Planï¼Œé€™äº› Planå¿…é ˆå¹£åˆ¥ç›¸åŒä¸”æ”¶è²»å€é–“ä¸€è‡´ï¼›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">subscription&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">subscriptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">customer&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;cus_4fdAW5ftNQow1a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">coupon&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;free-period&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tax_percent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mf">6.34&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">trial_end&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1542721841&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">items&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[{&lt;/span> &lt;span class="nx">plan&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;plan_CBXbz9i7AIOTzr&amp;#39;&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">plan&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;plan_IFuCu48Snc02bc&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">quantity&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">}],});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤å¤–ï¼Œé‚„æœ‰Coupon å¯ä»¥è¨­å®šï¼Œæ”¯æ´ä¸€æ¬¡æ€§ / æ°¸ä¹…æ€§ / æ¯æ¬¡æ‰£æ¬¾ç”¨ï¼Œé‚„æœ‰ %è·Ÿæ•¸é‡çš„è¨­å®šï¼Œç›¸ç•¶æœ‰å½ˆæ€§&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">coupon&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">coupons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">create&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">duration&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;once&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;free-period&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">percent_off&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»ºç«‹ subscription åœ¨æ²’æœ‰åœæ­¢ä¹‹å‰ï¼ŒStripe æœƒè‡ªå‹•ä¾ç…§æ™‚é–“å®šæœŸæ‰£æ¬¾ï¼Œä¸¦è‡ªå‹•é–‹ç«‹ç™¼ç¥¨(å¯é—œé–‰)ï¼Œç›¸ç•¶çš„æ–¹ä¾¿ã€‚&lt;/p>
&lt;h3 id="å‡ç´šæˆ–é™ç´š">å‡ç´šæˆ–é™ç´š&lt;/h3>
&lt;p>å¦‚æœç”¨æˆ¶è¨‚é–±äº†æ™®é€šç‰ˆï¼Œåœ¨æœˆä¸­æ™‚çªç„¶æƒ³å‡ç´šåˆ°å°ˆæ¥­ç‰ˆï¼Œè©²æ€éº¼è™•ç†å‘¢ï¼Ÿ&lt;br>
å¯ä»¥é¸æ“‡å°‡è©²ç”¨æˆ¶çš„ subscription ç‰©ä»¶ä¿®æ”¹ï¼Œæ›´æ–°è¨‚é–±çš„ Plan&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">stripe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">subscriptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sub_49ty4767H20z6a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cancel_at_period_end&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">items&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">subscription&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">items&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">plan&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;plan_CBb6IXqvTLXp3f&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">proration_date&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">proration_date&lt;/span> &lt;span class="c1">// Optionalï¼Œè©³çœ‹ä¸‹æ–¹æµç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ›´æ–°å®¹æ˜“ï¼Œä½†æ˜¯å¯¦éš›çš„æ‰£æ¬¾æµç¨‹å¿…é ˆå°æ‡‰æ¥­å‹™é‚è¼¯çš„è™•ç†ï¼Œä¹Ÿå°±æ˜¯æ”¶è²»çš„æ–¹å¼ï¼›&lt;/p>
&lt;p>ä¾‹å¦‚å¹¾ç¨®æ¡ˆä¾‹&lt;/p>
&lt;ol>
&lt;li>1/1é–‹å§‹è¨‚é–± PlanA $30/moï¼Œæ¥è‘—å† 1/15 å‡ç´šåˆ° PlanB $45/mo&lt;br>
å› ç‚ºéƒ½æ˜¯æ¯æœˆæ‰£æ¬¾ï¼Œæ‰€ä»¥ Stripe é è¨­æœƒåœ¨ 2/1 é–‹å§‹æ”¶ PlanB ä¹Ÿå°±æ˜¯ $45å…ƒï¼Œæ‰€ä»¥ç†è«–ä¸Šæ‡‰è©²åœ¨ 2/1æ‰å°‡ç”¨æˆ¶å‡ç´šåˆ° PlanBçš„æœå‹™&lt;/li>
&lt;li>åŒä¸Šï¼Œä½†æ˜¯ç”¨æˆ¶å¸Œæœ› 1/15å°±å‡ç´šåˆ°PlanB&lt;br>
é€™æ™‚å€™æœ‰å…©ç¨®åšæ³•&lt;br>
a. è‡ªå·±æ‰‹å‹•é–‹ç«‹ Invoiceï¼Œé–‹ç«‹Invoiceç•¶ä¸‹å°±æœƒæ‰£æ¬¾ä¸¦ç”¢ç”Ÿç™¼ç¥¨&lt;br>
b. è¨­ç«‹ Prorationï¼Œé€™æ˜¯ Stripe æä¾›çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨ update subscription æ™‚æŒ‡å®š &lt;code>proration_data&lt;/code> ï¼ŒStripe æœƒåœ¨ä¸‹ä¸€æ¬¡æ”¶è²»æ™‚é–“å¤šé–‹ç«‹é€™éƒ¨åˆ†çš„é‡‘é¡&lt;/li>
&lt;li>å¦‚æœç”¨æˆ¶å¾æœˆä»˜è²»æ”¹æˆå¹´ä»˜è²»ï¼Œæœƒç«‹å³æ‰£æ¬¾&lt;/li>
&lt;li>å¦‚æœ1/1å·²ç¶“æ‰£æ¬¾ PlanAçš„éŒ¢ï¼Œç”¨æˆ¶ 1/15å–æ¶ˆï¼ŒStripe é è¨­ä¸æœƒé€€æ¬¾ï¼›&lt;br>
ä¹Ÿå¯ä»¥è¨­å®š &lt;code>cancel_at_period_end&lt;/code>ï¼Œè®“ç”¨æˆ¶åœ¨æœˆåº•æ‰å–æ¶ˆè³‡æ ¼ï¼›&lt;br>
å¦‚æœæœ‰é¡å¤–ç”¢ç”Ÿçš„ä»£ä»˜æ¬¾é …æœï¼Œå¿…é ˆè¦æ‰‹å‹•æ¸…é™¤ Invoiceæ‰ä¸æœƒåœ¨æœˆåº•å¤šæ‰£æ¬¾ä¸€æ¬¡&lt;/li>
&lt;/ol>
&lt;h3 id="å°çµäºŒ">å°çµäºŒ&lt;/h3>
&lt;p>åŒæ•´ä¸€ä¸‹ Invoice / Invoice Item / Product / Plan / Subscription é—œä¿‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__1xDyQ3xWyQC7SLTMDY0srQ.jpeg"
loading="lazy"
>&lt;/p>
&lt;h3 id="ç¸½çµ">ç¸½çµ&lt;/h3>
&lt;p>å¦‚æœè¦ä¸€æ¬¡æ€§ä»˜è²»ï¼Œå‰‡å¯ä»¥ä½¿ç”¨ Paymentï¼Œä¸” Payment ä¸éœ€è¦ç¶å®š Customerï¼ŒåŒæ¨£æœƒé–‹ç«‹ç™¼ç¥¨ï¼›&lt;br>
ä»¥ä¸‹æ›´è¤‡é›œçš„æ‰£æ¬¾æ–¹å¼æ–¹å¼è¦å…ˆåœ¨ Stripe å»ºç«‹ Customerï¼Œå¯ä»¥åˆ©ç”¨ Invoiceï¼Œåˆ†æ¬¡å»ºç«‹ Invoice Itemï¼Œæœ€å¾Œå†ä¸€æ¬¡é–‹åœ¨ä¸€å¼µ Invoice ä¸‹å®Œæˆæ‰£æ¬¾ï¼›&lt;br>
åˆæˆ–æ˜¯å»ºç«‹ Product èˆ‡å°æ‡‰çš„ä»˜è²»æ©Ÿåˆ¶ Planï¼Œä¸¦ç”¨ Customer è§’è‰²è¨‚é–± Subscriptionï¼Œ Stripeæœƒè™•ç†å®šæœŸæ‰£æ¬¾ç­‰æ©Ÿåˆ¶ï¼›&lt;br>
çµåˆ Coupon å¯ä»¥æä¾›å½ˆæ€§çš„æŠ˜åƒ¹æ©Ÿåˆ¶ã€‚&lt;/p>
&lt;p>ç¸½é«”ä¸Š Stripe æœ€è®“æˆ‘è¦ºå¾—æ–¹ä¾¿çš„æ˜¯ Dashboard å¯ä»¥è¨­å®šï¼Œé€™æ¨£å°±å¯ä»¥å°‘è“‹ä¸€å€‹å¾Œå°è‡ªå·±éº»ç…©ï¼Œè€Œä¸”æŠŠCustomer / Payment / Billing ç­‰åˆ†é–€åˆ¥é¡ï¼Œä»¥åŠå€‹åˆ¥å­é …ç›®ï¼Œéå¸¸å¥½ç®¡ç†é‡‘æµæœå‹™ã€‚&lt;/p></description></item><item><title>MongoDB Isolation èˆ‡ Transaction</title><link>https://yuanchieh.page/posts/2018/2018-10-14-mongodb-isolation-%E8%88%87-transaction/</link><pubDate>Sun, 14 Oct 2018 01:39:58 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-10-14-mongodb-isolation-%E8%88%87-transaction/</guid><description>&lt;p>åœ¨ MongoDBä¸­ï¼Œå…¶ Isolation èˆ‡ SQLæ¨™æº–å®šç¾©çš„ Isolation Levelä¸åŒï¼Œç•¢ç«ŸNoSQLæ³¨é‡æ–¼æµ·é‡è®€å¯« ã€é›†ç¾¤å¼çš„æ‡‰ç”¨å ´æ™¯ï¼Œè‡ªç„¶æ‰€é¢å°çš„å•é¡Œä¹Ÿå°±å·®ç•°å¾ˆå¤šï¼Œä½†ä¹Ÿå› æ­¤åœ¨é¢è‡¨ Concurrency æ™‚çš„è®€å¯«ä¿è­‰å•é¡Œï¼Œä»¥ä¸‹æ˜¯é–±è®€å®˜æ–¹æ–‡ä»¶ä¸¦æ•´ç†çš„çµæœã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/" target="_blank" rel="noopener"
>&lt;strong>Read Isolation, Consistency, and Recency - MongoDB Manual&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="isolation-level">Isolation level&lt;/h2>
&lt;p>æ­£å¦‚åŒ SQL ä¸åŒçš„ Isolation è©¦åœ–åœ¨æ¯ä¸€å±¤è§£æ±ºä¸åŒçš„å•é¡Œ (dirty read/ unrepeatable read / phantom read) çš„å•é¡Œï¼ŒåŒæ¨£åœ¨ MongoDBä¸­ä¹Ÿæœ‰å¹¾ç¨®Isolation level&lt;/p>
&lt;h3 id="read-uncommitted">Read Uncommitted&lt;/h3>
&lt;p>Client å¯ä»¥è®€å–é‚£äº›å¯«å…¥ä½†å°šæœªæŒä¹…åŒ–çš„è³‡æ–™&lt;/p>
&lt;ol>
&lt;li>Client æœƒè®€å–åˆ°å°šæœª durable çš„è³‡æ–™ï¼Œä»¥åŠå¯«å…¥MongoDBå¾Œåœ¨è©²å¯«å…¥Client æ”¶åˆ°æˆåŠŸè¨Šæ¯ä¹‹å‰&lt;br>
( A writes â†’ MongoDB accept â†’ B read Aâ€™s write â†’ A accept success)&lt;/li>
&lt;li>å¦‚æœæ˜¯å¤šè¡Œå¯«å…¥çš„æ“ä½œ(å¦‚ updateMany)ï¼ŒClient å¯èƒ½æœƒè®€åˆ°æ›´æ–°æœªå®Œå…¨çš„æ–‡æª” (å¦‚æœä¸€æ¬¡æ›´æ–°äº”å€‹æ–‡æª”ï¼Œå¯èƒ½è®€åˆ°ä¸‰å€‹æ›´æ–°å¾Œæ–‡æª”ï¼Œä½†æ¯å€‹æ–‡æª”å¦‚æœæ›´æ–°å¤šå€‹æ¬„ä½ï¼ŒMongoDBä¿è­‰ä¸æœƒè®€å–åˆ°éƒ¨åˆ†æ›´æ–°æ¬„ä½çš„æ–‡æª”)&lt;/li>
&lt;li>Client å¯èƒ½è®€åˆ°ä¹‹å¾Œè¢«roll back çš„æ•¸æ“š&lt;/li>
&lt;/ol>
&lt;p>é€™æ˜¯é è¨­çš„ Isolation Level&lt;/p>
&lt;p>åœ¨ MongoDB 4.0ä¹‹å¾Œæ‰åŠ å…¥ å¤šæ–‡æª”çš„ transaction ä¿è­‰ï¼Œåœ¨æ²’æœ‰ transaction ä¿è­‰ä¸‹å¤šæ–‡æª”è®€å–æœƒæœ‰å¹¾å€‹å•é¡Œ&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Non-point-in-time read&lt;/strong>&lt;br>
&lt;code>A read d1 ~ d5 â†’ B update d3 â†’ A å¯èƒ½æœƒè®€åˆ°Bæ›´æ–°çš„ d3&lt;/code>&lt;br>
ä¹Ÿå°±æ˜¯åœ¨è®€å–ç™¼ç”Ÿçš„è©²æ™‚æ©Ÿé»æ²’æœ‰ç”¢ç”Ÿ snapshotï¼Œå¯ä»¥ç†è§£æˆ unrepeatable read&lt;/li>
&lt;li>&lt;strong>Non-serializable operations&lt;/strong>&lt;br>
&lt;code>A read d1 â†’ B write d2 â†’ B write d1 â†’ A read d2&lt;/code>Â &lt;br>
å°æ–¼ d1 ä¾†èªªï¼Œæ˜¯ A å…ˆè®€æ¥è‘—æ› B å¯« / å°æ–¼ d2 ä¾†èªªï¼Œæ˜¯ Bå¯«å†æ› Aè®€ï¼›&lt;br>
é€™å€‹æƒ…æ³å°è‡´å…©è€…çš„è®€å¯«ç›¸ä¾é †åºå‰›å¥½é¡›å€’ï¼Œæ‰€ä»¥æ²’è¾¦æ³•åºåˆ—åŒ–è®€å¯«é †åº&lt;/li>
&lt;li>&lt;strong>Miss match read&lt;/strong>&lt;br>
**åŒæ¨£æ˜¯è®€å–ä¸­æœ‰æ›´æ–°ç™¼ç”Ÿï¼Œå¯èƒ½æœƒå°è‡´æ›´æ–°çš„æ–‡æª”èˆ‡è®€å–çš„æ¢ä»¶ç™¼ç”ŸéŒ¯ç½®ï¼ŒåŸæœ¬ç¬¦åˆæ¢ä»¶çš„å¯èƒ½æ›´æ–°å¾Œä¸ç¬¦åˆç¨®ç¨®&lt;/li>
&lt;/ol>
&lt;h3 id="cursor-snapshot">Cursor Snapshot&lt;/h3>
&lt;p>ç”¨ cursor è®€å–åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½æœƒå°‡åŒä¸€å€‹æ–‡æª”è¿”å›å¤šæ¬¡ï¼Œå› ç‚ºåŒæœŸé–“æ–‡æª”å¯èƒ½å› ç‚ºæ›´æ–°ç­‰å› ç´ è€Œæ”¹è®Šäº†ä½ç½®&lt;/p>
&lt;p>ä½†å¦‚æœæ–‡æª”ä¸­æœ‰ unique keyï¼Œå‰‡åŒå€‹æ–‡æª”åƒ…æœƒè¿”å›ä¸€æ¬¡&lt;/p>
&lt;h3 id="real-timeorder">Real TimeÂ Order&lt;/h3>
&lt;p>å…è¨±åŒä¸€å€‹æ–‡æª”çš„å¤šçµ„ thread è®€å¯«å®›å¦‚å–®ä¸€ thread è®€å¯«ä¸€èˆ¬ï¼Œäº¦å³åœ¨åŒä¸€å€‹æ–‡æª”ä¸­æœƒä»¥åºåˆ—åŒ–æ–¹å¼åŸ·è¡Œè®€å¯«è«‹æ±‚&lt;/p>
&lt;h3 id="causal-consistency">Causal Consistency&lt;/h3>
&lt;p>å› æœä¸€è‡´æ€§ï¼Œä¾‹å¦‚åˆªé™¤ç¬¦åˆæŸç‰¹å®šæ¢ä»¶çš„æ–‡æª”ï¼Œæ¥è‘—è®€å–åŒæ¨£æ¢ä»¶ï¼Œå¾Œè€…ç‹€æ³ä¾è³´æ–¼å‰è€…ï¼Œæ–¼æ˜¯å‰å¾Œå…©è€…ä¾¿æœ‰äº†å› æœé—œä¿‚ï¼›&lt;br>
MongoDB 3.6+ æä¾› writeConcern:majority / readConcern:majory å¤–åŠ å› æœæ€§çš„ä¿è­‰&lt;/p>
&lt;ol>
&lt;li>Read your writes&lt;br>
å¯«å…¥å¾Œç·Šæ¥è‘—è®€å–å¯«å…¥çš„è³‡æ–™&lt;/li>
&lt;li>Monotonic reads&lt;br>
è®€å–è³‡æ–™çš„çµæœä¸å¯ä»¥æ˜¯æ¯”ä¸Šä¸€æ¬¡è®€å–çµæœæ›´æ—©çš„çµæœ&lt;br>
ä¾‹å¦‚ w1 â†’ w2 â†’ r1 â†’ r2ï¼Œw2 ç›¸ä¾æ–¼ w1ï¼Œr1 é€™è£ç›¸ä¾æ–¼ w2 ï¼Œé‚£éº¼ r2 ä¸å¯èƒ½è®€å–åˆ° w1 çš„çµæœ&lt;/li>
&lt;li>Monotonic writes&lt;br>
å› æœåºå…ˆæ–¼å…¶ä»–å¯«å…¥è€…å¿…ç„¶å…ˆç™¼ç”Ÿå¯«å…¥&lt;br>
ä¹Ÿå°±æ˜¯ w1 â†’ w2ï¼Œw1 / w2 ä¹‹é–“å¯èƒ½é‚„æœ‰å…¶ä»–çš„å¯«å…¥æ“ä½œï¼Œä½†æ˜¯ w1 å¿…ç„¶æ¯” w2 æ—©åŸ·è¡Œ&lt;/li>
&lt;li>Writes follow reads&lt;br>
è¦åœ¨è®€å–ä¹‹å¾Œå¯«å…¥çš„å¯«å…¥äº‹ä»¶å¿…ç„¶ç™¼ç”Ÿæ–¼è®€å–ä¹‹å¾Œ&lt;br>
ä¹Ÿå°±æ˜¯ r1 â†’ w1ï¼Œå‰‡r1 å¿…ç„¶ç™¼ç”Ÿæ–¼ w1 ä¹‹å‰&lt;/li>
&lt;/ol>
&lt;h2 id="write-concern-èˆ‡-readconcern">Write Concern èˆ‡ ReadÂ Concern&lt;/h2>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__F__a3X__box50qZOllKb__D1g.jpeg"
loading="lazy"
alt="æˆªè‡ª MongoDB å®˜æ–¹æ–‡ä»¶ https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/"
>
æˆªè‡ª MongoDB å®˜æ–¹æ–‡ä»¶&lt;/p>
&lt;p>&lt;a class="link" href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/" target="_blank" rel="noopener"
>https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/&lt;/a>&lt;/p>
&lt;p>MongoDB åœ¨è®€å¯«æœ‰ä¸åŒçš„ Isolation Levelå¯ä»¥è¨­å®šï¼Œä¹Ÿå°±æ˜¯ Read Concern / Write Concernï¼Œä¸åŒçš„Levelå°æ‡‰ä¸åŒçš„&lt;code>ä¸€è‡´æ€§èˆ‡å¯ç”¨æ€§çš„è€ƒé‡&lt;/code>ï¼Œäº¤éŒ¯å¾Œæœ‰å¤šç¨®çµ„åˆç‹€æ³ï¼ŒIsolation level å¯ä»¥å®šç¾©åœ¨&lt;code>é€£ç·š session&lt;/code>ã€&lt;code>Transaction&lt;/code>ã€&lt;code>å–®æ¬¡æ“ä½œ&lt;/code>&lt;/p>
&lt;h3 id="write-concern">Write Concern&lt;/h3>
&lt;p>Write Concern ä¸»è¦æ˜¯æŒ‡ &lt;code>ç•¶ Client é€å‡ºå¯«å…¥è«‹æ±‚å¾Œï¼ŒServeræœƒåœ¨ä»€éº¼æ¢ä»¶ä¸‹å›æ‡‰Client å·²ç¶“æˆåŠŸå¯«å…¥äº†&lt;/code>ï¼Œç¸½å…±æœ‰ä¸‰å€‹åƒæ•¸å¯ä»¥ä½¿ç”¨&lt;/p>
&lt;ol>
&lt;li>w:Â &lt;br>
å¯«å…¥ä¿è­‰æ¢ä»¶&lt;/li>
&lt;li>j:Â &lt;br>
Booleanï¼Œæ˜¯å¦å¯«å…¥ disk journal å¾Œæ‰è¿”å›&lt;/li>
&lt;li>wtimeout:Â &lt;br>
å¤šä¹…å¾Œç™¼ç”Ÿtimeouté¿å…é–æ­»ï¼Œ&lt;code>0&lt;/code> ä»£è¡¨ä¸éœ€è¦ timeout è¨­è¨ˆ&lt;/li>
&lt;/ol>
&lt;p>å…¶ä¸­ w åˆæœ‰å¹¾ç¨®é¸é …&lt;/p>
&lt;ol>
&lt;li>&lt;code>&amp;lt;number&amp;gt;&lt;/code>:
å°æ‡‰å¹¾å€‹ mongod server æ”¶åˆ°å¯«å…¥è«‹æ±‚æ‰æœƒå›æ‡‰æˆåŠŸè¨Šæ¯&lt;br>
&lt;code>0&lt;/code> ä»£è¡¨ä¸éœ€è¦å›æ‡‰ï¼Œä½†å¯èƒ½æœƒå›å‚³ network / socket ç›¸é—œéŒ¯èª¤&lt;br>
&lt;code>1&lt;/code> é è¨­å€¼ï¼Œå¯«å…¥è«‹æ±‚è¢« standalone mongod æˆ–æ˜¯ primary æ”¶åˆ°&lt;br>
&lt;code>è¶…é 1&lt;/code> åƒ…é©ç”¨æ–¼ replica setï¼Œä¹Ÿå°±æ˜¯ primary + secondary ç¸½å…±å¹¾å€‹æ”¶åˆ°æ‰æœƒå›æ‡‰æˆåŠŸ&lt;/li>
&lt;li>&lt;code>majority&lt;/code>&lt;br>
æ“æœ‰æŠ•ç¥¨æ¬Šçš„ç¯€é»*éåŠæ•¸éƒ½æ”¶åˆ°å¯«å…¥è«‹æ±‚ï¼Œå°æ‡‰çš„ j è®Šæ•¸å¦‚æœæ²’æœ‰å®£å‘Šå‰‡çœ‹ç³»çµ±çš„é è¨­å€¼ &lt;code>[writeConcernMajorityJournalDefault](https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.writeConcernMajorityJournalDefault &amp;quot;writeConcernMajorityJournalDefault&amp;quot;)&lt;/code>Â &lt;br>
Arbiter é›–ç„¶æœ‰æŠ•ç¥¨æ¬Šï¼Œä½†æ˜¯ä¸ç®—åœ¨å…¶ä¸­ï¼Œå› ç‚ºæ²’æœ‰å„²å­˜è³‡æ–™&lt;/li>
&lt;li>&lt;code>&amp;lt;tag&amp;gt;&lt;/code>&lt;br>
åœ¨è¨­å®š replica set å¯ä»¥æŒ‡å®š tagï¼Œæ­¤è™•çš„ tag è¡¨ç¤ºå¯«å…¥è«‹æ±‚è¢«é€å¾€ç¬¦åˆçš„ replica set&lt;/li>
&lt;/ol>
&lt;h3 id="read-concern">Read Concern&lt;/h3>
&lt;h4 id="local">local&lt;/h4>
&lt;p>æœ€ä½çš„è®€å–ä¿è­‰ï¼Œè®€åˆ°çš„è³‡æ–™ä¸ä¿è­‰å·²ç¶“è¢« majority å¯«å…¥ä¸”å¯èƒ½è³‡æ–™æœƒ rollback&lt;/p>
&lt;h4 id="available">available&lt;/h4>
&lt;p>åŸºæœ¬ä¸Šè·Ÿ localä¸€æ¨£ï¼Œåªæœ‰åœ¨ shard cluster çš„æ™‚å€™ available æ˜¯æœ€ä½å»¶é²çš„è®€å–è«‹æ±‚ï¼Œä¸¦ä¸æœƒæ›´æ–° shardingä¸­çš„ä¸­ç¹¼è³‡æ–™(does not contact the shardâ€™s primary nor the config servers for updated &lt;a class="link" href="https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/" target="_blank" rel="noopener"
>metadata&lt;/a>.)&lt;/p>
&lt;p>å› æ­¤å¯èƒ½æœƒè®€å–åˆ° &lt;strong>orphaned document&lt;/strong> (æŸäº›è³‡æ–™å·²ç¶“æ¬ç§»åˆ°å…¶ä»–chunkä½†æ˜¯åœ¨åŸå§‹ä½ç½®å› ç‚ºéŒ¯èª¤æˆ–æ˜¯æ„å¤–shutdownå°è‡´æ²’æœ‰æ¸…é™¤ï¼Œéœ€è¦é¡å¤–æ¸…é™¤ &lt;a class="link" href="https://docs.mongodb.com/manual/reference/command/cleanupOrphaned/#dbcmd.cleanupOrphaned" target="_blank" rel="noopener"
>cleanupOrphaned&lt;/a>&lt;/p>
&lt;h4 id="majority">majority&lt;/h4>
&lt;p>&lt;code>ä¿è­‰è®€å–åˆ°çš„è³‡æ–™æ˜¯è¢«replica set ä¸­çš„å¤šæ•¸ç¢ºèªéï¼Œä¸”ä¸æœƒ rollback&lt;/code>ï¼Œæ³¨æ„æ˜¯ acknowledge è€Œä¸ä¸€å®šæ˜¯ durableï¼Œè¦å°æ‡‰çœ‹writeConcern!&lt;/p>
&lt;p>å¦‚æœæ˜¯åœ¨å¤šæ–‡æª”transactionä¸­ï¼Œé™¤é writeConcern æ˜¯ majorityï¼Œå¦å‰‡ åŒåœ¨ transaction ä¸­çš„ readConcern ä¸èƒ½æä¾›ä¿è­‰ã€‚&lt;/p>
&lt;p>ä½†éœ€è¦æ³¨æ„ &lt;code>majority åƒ…èƒ½ç¢ºä¿è®€å–è³‡æ–™ä¸æœƒ rollbackï¼Œä½†æ˜¯ä¸ä¿è­‰èƒ½è®€åˆ°æœ€æ–°è³‡æ–™&lt;/code>&lt;/p>
&lt;p>å®˜æ–¹å»ºè­°åœ¨ primary-secondary-arbiter PSAæ¶æ§‹ä¸‹é—œé–‰ majorityï¼Œå› ç‚ºè¤‡è£½ä¸æœƒåˆ° arbiterï¼Œæ‰€ä»¥è¦é”åˆ° majorityæ¢ä»¶å°±æ˜¯ primary-secondary å…©å°éƒ½æˆåŠŸå¯«å…¥æ‰ç®—æˆåŠŸï¼Œæœƒçµ¦ç³»çµ±å¸¶ä¾†æ¯”è¼ƒå¤§çš„è² æ“”ï¼Œå®¹éŒ¯æ€§ä¹Ÿè®Šå·®*&lt;/p>
&lt;h4 id="linearizable">linearizable&lt;/h4>
&lt;p>åŸºæ–¼ majority æä¾›æ›´å¼·çš„ä¿è­‰ï¼Œ&lt;code>ä¿è­‰å¯«å…¥å¾Œçš„è®€å–éƒ½ä¸æœƒè®€åˆ°æ›´èˆŠçš„è³‡æ–™&lt;/code>ï¼Œé™¤äº†é¸æ“‡è®€å–çš„ç¯€é»å¤–ï¼Œé‚„æœƒå»è·Ÿå¤šæ•¸ç¯€é»ç¢ºèªï¼Œä¹‹å¾Œæ‰è¿”å›å€¼ï¼Œæ‰€ä»¥æ•ˆèƒ½éœ€æ±‚åˆé«˜å‡ºä¸€æˆªï¼›&lt;/p>
&lt;p>ç‚ºä»€éº¼é‚„éœ€è¦è·Ÿå¤šæ•¸ç¯€é»åœ¨ç¢ºèªå‘¢ï¼Ÿ&lt;br>
ä¸»è¦æ˜¯æ€• network partitioningï¼Œä¹Ÿå°±æ˜¯å› ç‚ºç¶²è·¯å»¶é²è€Œå°è‡´åŸæœ¬çš„ replica set è¢«åˆ†å‰²ï¼Œä¾‹å¦‚åŸæœ¬ 3å°è®Šæˆ 1 + 2ï¼Œè€Œ 2å°ä¸€çµ„çš„éƒ¨åˆ†å› ç‚ºé‚„ç¬¦åˆå¤šæ•¸å¯ä»¥ç”¢ç”Ÿæ–°çš„ primaryï¼Œæ­¤æ™‚å¦‚æœæœ‰äººå»è®€(majority) 1é‚£ä¸€å°å°±å¯èƒ½å–å¾—èˆŠè³‡æ–™ï¼Œå› ç‚º 1å¾¹åº•è·Ÿå…¶ä»–ç¯€é»åˆ†é›¢ï¼›&lt;br>
åŠ ä¸Š linearizableå¯ä»¥é¿å…æ‰æ­¤å•é¡Œï¼Œè©³ç´°å¯åƒè€ƒæ­¤å•ç­” &lt;a class="link" href="https://stackoverflow.com/questions/42615319/the-difference-between-majority-and-linearizable" target="_blank" rel="noopener"
>https://stackoverflow.com/questions/42615319/the-difference-between-majority-and-linearizable&lt;/a>&lt;/p>
&lt;h4 id="snapshot">snapshot&lt;/h4>
&lt;p>åªåœ¨å¤šæ–‡æª” transaction ä¸­ç”Ÿæ•ˆï¼Œæ–‡æª”æ²’æœ‰éå¤šæ•˜è¿°ï¼Œä½†æ¨æ•²æ‡‰è©²ä¹Ÿå°±æ˜¯ä¿è­‰åœ¨åŒä¸€å€‹ transaction ä¸­ä¸æœƒè®€å–åˆ° transaction ä¹‹å¾Œçš„æ›´å‹•ã€‚&lt;/p>
&lt;h3 id="è®€å–çš„å¯¦ä¾‹èªªæ˜">è®€å–çš„å¯¦ä¾‹èªªæ˜&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__YKPt3WxP__8WzvsmvFwZSKw.jpeg"
loading="lazy"
alt="æˆªè‡ª MongoDBÂ å®˜æ–¹æ–‡ä»¶"
>
æˆªè‡ª MongoDBÂ å®˜æ–¹æ–‡ä»¶&lt;/p>
&lt;h4 id="readconcern-majority">readConcern: majority&lt;/h4>
&lt;ol>
&lt;li>t0Â : primary æ”¶åˆ°å¯«å…¥è«‹æ±‚ï¼Œå› ç‚ºé€™æ™‚ primary å€¼é‚„æ˜¯ write_prev&lt;/li>
&lt;li>t1ï¼šsecondary1 æ”¶åˆ°å¯«å…¥åŒæ­¥è«‹æ±‚ï¼Œæ­¤æ™‚ primary / secondary é‚„æ˜¯ write_prev&lt;/li>
&lt;li>t2ï¼šsecondary2 æ”¶åˆ°å¯«å…¥åŒæ­¥è«‹æ±‚ï¼Œæ­¤æ™‚å€¼ä¹Ÿéƒ½é‚„æ˜¯ write_prev&lt;/li>
&lt;li>t3ï¼šå› ç‚ºwriteConcernæ˜¯ majorityï¼Œæ­¤æ™‚ primary æ”¶åˆ° secondary1çš„å›è¦†ï¼Œæ­¤æ™‚ primaryæ‰è®Šæˆ write_newï¼Œä¸¦ä¸”å›å¾© client å¯«å…¥æˆåŠŸï¼Œä½†æ˜¯ secondary1 é‚„æ˜¯åœç•™åœ¨ write_prev&lt;/li>
&lt;li>t4ï¼šprimary æ”¶åˆ° secondary2 å›è¦†&lt;/li>
&lt;li>t5ï¼šsecondary1æ”¶åˆ° primary1ï¼Œæ­¤æ™‚ snapshotæ‰æ›´æ–°ç‚º write_new&lt;/li>
&lt;li>t5ï¼šsecondary2 å‹•ä½œåŒä¸Š&lt;/li>
&lt;/ol>
&lt;h4 id="readconcern-local">readConcern: local&lt;/h4>
&lt;ol>
&lt;li>t0ï¼šprimary æ­¤æ™‚å€¼æ˜¯ write_new&lt;/li>
&lt;li>t1ï¼šsecondary1 æ­¤æ™‚å€¼æ˜¯ write_new&lt;/li>
&lt;li>t2ï¼šsecondary2 æ­¤æ™‚å€¼æ˜¯ write_new&lt;/li>
&lt;/ol>
&lt;p>readConcern: majority è®€å–æ™‚æ˜¯é€é snapshotï¼Œæ ¹æ“šæ­¤ç¯‡&lt;a class="link" href="https://yq.aliyun.com/articles/60553?spm=a2c4e.11155435.0.0.21623312JJZa8i" target="_blank" rel="noopener"
>æ–‡ç« MongoDB readConcern åŸç†è§£æ&lt;/a> æŒ‡å‡º&lt;/p>
&lt;blockquote>
&lt;p>MongoDB ä¼šèµ·ä¸€ä¸ªå•ç‹¬çš„snapshot çº¿ç¨‹ï¼Œä¼šå‘¨æœŸæ€§çš„å¯¹å½“å‰çš„æ•°æ®é›†è¿›è¡Œ snapshotï¼Œå¹¶è®°å½• snapshot æ—¶æœ€æ–° oplogçš„æ—¶é—´æˆ³ï¼Œå¾—åˆ°ä¸€ä¸ªæ˜ å°„è¡¨&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>åªæœ‰ç¡®ä¿ oplog å·²ç»åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹æ—¶ï¼Œå¯¹åº”çš„ snapshot æ‰ä¼šæ ‡è®°ä¸º commmitedï¼Œç”¨æˆ·è¯»å–æ—¶ï¼Œä»æœ€æ–°çš„ commited çŠ¶æ€çš„ snapshot è¯»å–æ•°æ®ï¼Œå°±èƒ½ä¿è¯è¯»åˆ°çš„æ•°æ®ä¸€å®šå·²ç»åŒæ­¥åˆ°çš„å¤§å¤šæ•°èŠ‚ç‚¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>é€™ç¯‡ä¸»è¦æ•´ç†èˆ‡ç†è§£ä¸€äº›å®˜æ–¹æ–‡ä»¶çš„è³‡æ–™èˆ‡è¨­å®šï¼Œä¸¦æ²’æœ‰ä»€éº¼å¤ªé‡å¤§çš„çµè«–ï¼Œæ›´é€²ä¸€æ­¥å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œæ¢åˆ—åœ¨ Causal Consistency ä¸‹çš„ä¸åŒè®€å¯«ä¿è­‰&lt;/p>
&lt;p>&lt;a class="link" href="https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/" target="_blank" rel="noopener"
>&lt;strong>Causal Consistency and Read and Write Concerns - MongoDB Manual&lt;/strong>&lt;/a>&lt;/p>
&lt;h3 id="è¨»è¨˜">è¨»è¨˜&lt;/h3>
&lt;h4 id="æ“æœ‰æŠ•ç¥¨æ¬Š">æ“æœ‰æŠ•ç¥¨æ¬Š&lt;/h4>
&lt;p>åœ¨MongoDBçš„ Replica setä¸­ï¼Œåªæœ‰ä»¥ä¸‹å¹¾ç¨®ç‹€æ…‹æœ‰æŠ•ç¥¨æ¬Š (voting node)&lt;/p>
&lt;ol>
&lt;li>primary&lt;/li>
&lt;li>secondary&lt;/li>
&lt;li>startup2ï¼šç¯€é»è¼‰å…¥æˆå“¡çš„è¨­å®šæª”æ­£å¼æˆç‚º replica setçš„ä¸€å“¡ä¸¦é–‹å§‹åˆå§‹åŒ–åŒæ­¥èˆ‡ç´¢å¼•å»ºç«‹&lt;/li>
&lt;li>recoveringï¼šç•¶ç¯€é»å°šæœªæº–å‚™è®€å–è«‹æ±‚æ™‚ï¼Œç­‰åˆ° client è¦ºå¾—okä¾¿æœƒè½‰ç‚º secondaryï¼Œé€™éƒ¨åˆ†æ²’æœ‰æ˜èªª recovering ä¸­åšäº†ä»€éº¼&lt;/li>
&lt;li>arbiter&lt;/li>
&lt;li>rollbackï¼šç•¶èˆŠçš„ primary å› ç‚ºæŸäº›å› ç´ è¢«å‰”é™¤ï¼Œä¹‹å¾Œé¸å‡ºäº†æ–°çš„ primaryï¼ŒèˆŠçš„ primary å¾Œä¾†æ¢å¾©åŒæ­¥ç™¼ç¾æœ‰äº›å¯«å…¥ç•¶åˆæ²’æœ‰åŒæ­¥ï¼Œæ­¤æ™‚èˆŠçš„ primaryæœƒé¸æ“‡ rollback é€™äº›æ²’æœ‰åŒæ­¥çš„è³‡æ–™&lt;/li>
&lt;/ol>
&lt;p>ç›®å‰ MongoDBçš„ replica setæœ€å¤šåªèƒ½æœ‰ 50å€‹æˆå“¡ï¼Œå…¶ä¸­æœ€å¤šåªèƒ½æœ‰ 7 åæˆå“¡æœ‰æŠ•ç¥¨æ¬Šï¼›å…¶ä»–æ²’æœ‰æŠ•ç¥¨æ¬Šçš„æˆå“¡å¯ä»¥ç•¶ä½œå‚™ä»½æˆ–æ˜¯è®€å–è«‹æ±‚çš„ç¯€é»ã€‚&lt;/p>
&lt;h4 id="replica-setå®¹éŒ¯æ€§å•é¡Œ">Replica SetÂ å®¹éŒ¯æ€§å•é¡Œ&lt;/h4>
&lt;p>replica set è¦å®šæ˜¯è¦åœ¨è¶…éå¤šæ•¸çš„å½¢æ³ä¸‹æ‰èƒ½é‹ä½œï¼Œæ‰€ä»¥æœ€ä½å¿…é ˆè¦æœ‰ä¸‰å€‹å¯æŠ•ç¥¨ç¯€é»æ‰èƒ½æˆç«‹ï¼Œè©¦æƒ³ä»¥ä¸‹ç‹€æ³&lt;/p>
&lt;ol>
&lt;li>3å°æ©Ÿå™¨ï¼Œå¯ä»¥å®¹éŒ¯ä¸€å°ï¼Œéœ€è¦ä¿è­‰ 67%çš„æ©Ÿå™¨é‹ä½œæ­£å¸¸&lt;/li>
&lt;li>4å°æ©Ÿå™¨ï¼Œä¹Ÿæ˜¯åƒ…å¯å®¹éŒ¯ä¸€å°ï¼Œéœ€è¦ä¿è­‰ 75%çš„æ©Ÿå™¨é‹ä½œæ­£å¸¸&lt;/li>
&lt;/ol>
&lt;p>é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼æœƒæ¨è–¦ä½¿ç”¨å¥‡æ•¸å°çš„æ©Ÿå™¨ï¼›&lt;/p>
&lt;p>åœ¨ PSAä¸‹ï¼ŒArbiter ä¸èƒ½åŒæ­¥è³‡æ–™ï¼Œæ‰€ä»¥ write: majority å¿…é ˆåŒæ­¥å¯«å…¥ primary + secondaryï¼Œæ‰€ä»¥ç³»çµ±å®¹éŒ¯å°±è®Šå·®ï¼ŒåŒæ™‚åŠ é‡æ©Ÿå™¨çš„è² æ“”ã€‚&lt;/p></description></item><item><title>[ç­†è¨˜] AWS s3 æ€§èƒ½æå‡å°æ’‡æ­¥ â€” Amazon S3 Performance Tips &amp; Tricks</title><link>https://yuanchieh.page/posts/2018/2018-09-25-%E7%AD%86%E8%A8%98-aws-s3-%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E5%B0%8F%E6%92%87%E6%AD%A5-amazon-s3-performance-tips-tricks/</link><pubDate>Tue, 25 Sep 2018 21:34:31 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-09-25-%E7%AD%86%E8%A8%98-aws-s3-%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E5%B0%8F%E6%92%87%E6%AD%A5-amazon-s3-performance-tips-tricks/</guid><description>&lt;p>&lt;a class="link" href="https://aws.amazon.com/tw/blogs/aws/amazon-s3-performance-tips-tricks-seattle-hiring-event/" target="_blank" rel="noopener"
>&lt;strong>Amazon S3 Performance Tips &amp;amp; Tricks + Seattle S3 Hiring Event | Amazon Web Services&lt;/strong>&lt;/a>&lt;/p>
&lt;p>AWS S3 ç”¨ä¾†åšéœæ…‹è³‡æºç®¡ç†ï¼Œå¯ä»¥ç”¨ä¾†å„²å­˜éå¸¸å¤§é‡çš„è³‡æ–™ä¸”æœ‰å¾ˆé«˜ä¿æŒæ€§(duribility:99.9999999%)çš„ä¿è­‰ï¼›&lt;br>
åœ¨é€™ç¯‡å®˜æ–¹çš„éƒ¨è½æ ¼ä¸­è¨˜è¼‰è‘—S3å…§éƒ¨çš„ä¸€äº›å„²å­˜æ©Ÿåˆ¶ä»¥åŠå„ªåŒ–çš„å°æŠ€å·§ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯æ¯ç§’ API Requestå°æ–¼ 50è€…ï¼Œå…¶å¯¦ä¸å¤ªæœƒæœ‰å½±éŸ¿ï¼ŒS3 æœ‰è‡ªå‹•çš„ç›£æ§ç¨‹åº(Agent)ï¼Œè©¦è‘—å»å¹³è¡¡è³‡æºèˆ‡å¢åŠ ç³»çµ±çš„å¹³å‡é™„è¼‰ã€‚&lt;/p>
&lt;p>S3åœ¨å…§éƒ¨ç¶­è­·äº†ä¸€å¼µ Mapï¼ŒMapå°æ‡‰çš„Key æ˜¯ Bucket ä¸­ç‰©ä»¶çš„åç¨±ï¼ŒS3æœƒç”¨ç‰©ä»¶çš„åˆå§‹åç¨±ç•¶ä½œ Keyï¼›&lt;br>
å¯¦éš›ç‰©ä»¶çš„å„²å­˜æœƒè¢«åˆ†æ•£åˆ°ä¸åŒçš„ paritionä¸­ï¼Œè€Œ S3ç‚ºäº†æä¾›ä¾ç…§æŒ‰å­—å…¸é †åºæ’åˆ—çš„APIï¼Œ åœ¨åš partitioning çš„ä¾æ“šåŒæ¨£æ˜¯é€é Bucketçš„ç‰©ä»¶åˆå§‹åç¨±ï¼›&lt;/p>
&lt;p>æ‰€ä»¥å¦‚ä½•å– &lt;code>Bucketçš„ç‰©ä»¶åç¨±&lt;/code>å°±æ˜¯å½±éŸ¿æ€§èƒ½çš„é—œéµï¼Œåœ¨S3å…§éƒ¨ Mapçš„key&lt;br>
&lt;code>bucketname/keyname&lt;/code> ï¼ŒS3æœƒè‡ªå‹•å–å‰ç¶´&lt;/p>
&lt;p>æœ‰äº›äººæœƒç¿’æ…£ç”¨ user ID / game ID/ æ—¥æœŸ / éå¢æ•¸å­—ç­‰ï¼Œé€™äº› Keyçš„å…±é€šç‰¹æ€§æ˜¯å‰ç¶´é¡ä¼¼ï¼Œé€™ç•¶ä½œS3 Keyæœƒå°è‡´å¹¾å€‹å•é¡Œ&lt;br>
1. å‚¾å‘å„²å­˜åœ¨åŒä¸€å€‹ partitionä¸­&lt;br>
2. æ‰€æœ‰çš„ partition æœƒæœ‰æ¼¸å†·çš„æ•ˆæœï¼Œä¾‹å¦‚ç”¨æ—¥æœŸå„²å­˜ï¼Œé€šå¸¸è¶Šè¿‘çš„æ—¥æœŸè³‡æ–™è¶Šå®¹æ˜“å­˜å–ï¼Œä¹Ÿå°±æ˜¯partition çš„ä½¿ç”¨é‡ä¸å¹³å‡&lt;/p>
&lt;p>ä»¥ä¸‹å°±æ˜¯ä¸å¥½çš„ç¤ºç¯„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">2134857/gamedata/start.png
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134857/gamedata/resource.rsrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134857/gamedata/results.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134858/gamedata/start.png
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134858/gamedata/resource.rsrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134858/gamedata/results.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134859/gamedata/start.png
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134859/gamedata/resource.rsrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2134859/gamedata/results.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ‰å€‹éå¸¸ç°¡å–®çš„æ–¹æ³•å¯ä»¥åšåˆ°ï¼Œä¹Ÿå°±æ˜¯åœ¨é–‹é ­åŠ  hashï¼Œæˆ–æ˜¯å°‡æ—¥æœŸå­—ä¸²åè½‰ï¼Œç¸½ä¹‹è¦ç¢ºä¿å‰å…©åˆ°ä¸‰ä½æ˜¯ä¸é‡è¤‡å­—ä¸²ä¸”å¯«å…¥çš„ç‰©ä»¶æ•¸é›·åŒ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">7584312/gamedata/start.png
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7584312/gamedata/resource.rsrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7584312/gamedata/results.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8584312/gamedata/start.png
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8584312/gamedata/resource.rsrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8584312/gamedata/results.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9584312/gamedata/start.png
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9584312/gamedata/resource.rsrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9584312/gamedata/results.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>S3æœƒè‡ªå‹•è­˜åˆ¥ prefixä¸¦åˆ†æ•£åˆ°ä¸åŒçš„ partition&lt;/p>
&lt;p>/7&lt;br>
/8&lt;br>
/9&lt;/p>
&lt;p>è‡³æ–¼ prefix çœŸæ­£åˆ°åº•å¦‚ä½•å–å€¼æ–‡ç« ä¸¦æ²’æœ‰èªªæ˜ï¼Œåƒ…æåˆ° prefix ç†è«–ä¸Šåªæœ‰å…©åˆ°ä¸‰ä½å³å¯ï¼Œæ ¹æ“šå¦ä¸€ç¯‡ AWSå®˜æ–¹æ–‡ç«  &lt;a class="link" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/request-rate-perf-considerations.html" target="_blank" rel="noopener"
>Request Rate and Performance Guidelines&lt;/a>ï¼Œæ‡‰ç”¨ç¨‹å¼å­˜å–S3çš„APIé™åˆ¶ç‚º&lt;/p>
&lt;blockquote>
&lt;p>3,500 PUT/POST/DELETE and 5,500 GET requests per second per &lt;code>prefix&lt;/code> in a bucket&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ hex hash ä¸‰ä½ï¼Œæœ€å¤§è®€å–å€¼å¯é” 16 * 16 * 16 * 5500 GET API Call /per secondï¼Œé€™ç†è«–ä¸Šå¯ä»¥æ»¿è¶³çµ•å¤§å¤šæ•¸çš„ç”¢å“éœ€æ±‚äº†ï¼›&lt;br>
ç”šè‡³å¤§å¤šæ•¸çš„ç”¢å“é‚„ä¸éœ€è¦ prefixçš„å‘½åå„ªåŒ–ã€‚&lt;/p></description></item><item><title>HLS æ•™å­¸ (ä¸Š) â€” å¾é–±è®€Spec é–‹å§‹</title><link>https://yuanchieh.page/posts/2018/2018-09-24-hls-%E6%95%99%E5%AD%B8-%E4%B8%8A-%E5%BE%9E%E9%96%B1%E8%AE%80spec-%E9%96%8B%E5%A7%8B/</link><pubDate>Mon, 24 Sep 2018 09:54:09 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-09-24-hls-%E6%95%99%E5%AD%B8-%E4%B8%8A-%E5%BE%9E%E9%96%B1%E8%AE%80spec-%E9%96%8B%E5%A7%8B/</guid><description>&lt;p>åœ¨æ•¸ä½å…§å®¹çš„æ™‚ä»£ï¼Œå½±éŸ³çš„é–±è®€æ¯”ä¾‹ä¹Ÿè¶Šä¾†è¶Šé«˜ï¼Œç›¸é—œçš„ç›´æ’­èˆ‡å½±éŸ³ä¸²æµæœå‹™è¶Šä¾†è¶Šå¤šï¼Œè€Œå…¶ä¸­æœ€å¸¸ä½¿ç”¨çš„ä¸²æµæŠ€è¡“è¦æ ¼ä¾¿æ˜¯HLSï¼›&lt;br>
è¿‘æ—¥å·¥ä½œä¸Šé–‹å§‹ä½¿ç”¨ä¸å°‘HLSæœå‹™ï¼Œæ±ºå®šè‡ªå·±ç¿»Specææ‡‚æ•´å€‹æŠ€è¡“æ¶æ§‹ï¼Œä¸¦æ•´ç†æˆç­†è¨˜åˆ†äº«ã€‚&lt;/p>
&lt;p>ç›®å‰é è¨ˆæœƒå¯«å€‹å…©ç¯‡ï¼š&lt;br>
ä¸Šç¯‡(æ­¤ç¯‡)ä»‹ç´¹ HLS Specå…§å®¹&lt;br>
ä¸‹ç¯‡ä»‹ç´¹å½±éŸ³è™•ç†ç›¸é—œçš„è¦ç¯„èˆ‡å·¥å…·ä½¿ç”¨&lt;br>
å…¨æ–‡å…§å®¹åŸºæ–¼æ–‡ä»¶ &lt;a class="link" href="https://www.rfc-editor.org/rfc/rfc8216.txt" target="_blank" rel="noopener"
>https://www.rfc-editor.org/rfc/rfc8216.txt&lt;/a> ï¼Œä½†å…§æ–‡ç‚ºè‡ªå·±é–±è®€å¾Œä¸¦é‡çµ„ï¼Œå¦‚æœæœ‰ä¸æ¸…æ¥šæˆ–æ˜¯ç­†èª¤ä¹‹è™•ï¼Œå†éº»ç…©ç•™è¨€å›‰&lt;/p>
&lt;h3 id="ç°¡ä»‹èˆ‡æ¦‚è«–">ç°¡ä»‹èˆ‡æ¦‚è«–&lt;/h3>
&lt;p>RFC 8216 ä¸»è¦æ˜¯ä»‹ç´¹ HTTP Live Streaming (HLS)ï¼Œä¸»è¦å®šç¾©&lt;code>è³‡æ–™çš„æª”æ¡ˆæ ¼å¼&lt;/code>èˆ‡&lt;code>Server/Clientæ‡‰è©²æœ‰çš„ç›¸å°æ‡‰è¡Œç‚º&lt;/code> ï¼Œç›®å‰çš„æœ€æ–°ç‰ˆæœ¬ç‚º 7ã€‚&lt;/p>
&lt;p>HLS æä¾›ç©©å®šã€çœèŠ±è²»çš„æ–¹å¼æ¨é€é€£çºŒæ€§æˆ–é•·æ™‚æ®µçš„å½±ç‰‡ï¼Œæœ‰å¹¾å€‹ç‰¹æ€§&lt;/p>
&lt;ol>
&lt;li>æ¥æ”¶æ–¹å¯ä»¥æ ¹æ“šç¶²è·¯ç‹€æ³èª¿æ•´ä¸åŒè§£æåº¦&lt;/li>
&lt;li>æ”¯æ´åŠ å¯†&lt;/li>
&lt;li>åŒå€‹å½±éŸ³å…§å®¹ä¸åŒçš„æ’­æ”¾æ¢ä»¶ï¼Œä¾‹å¦‚å­—å¹•åˆ‡æ›&lt;/li>
&lt;li>åŸºæ–¼HTTPï¼Œå¯ä»¥æœ‰è‰¯å¥½çš„Cacheæ©Ÿåˆ¶(çœèŠ±è²»çš„åŸå› )&lt;/li>
&lt;/ol>
&lt;p>HLS å¤§è‡´ä¸Šæ˜¯å°‡å½±ç‰‡åˆ‡æˆå°å¡Šç‹€ï¼Œä¸¦é€éæ’­æ”¾æ¸…å–®æ¨é€ï¼ŒClient æ”¶åˆ°åˆ‡æˆå¡Šç‹€çš„å½±ç‰‡ç‰‡æ®µå¾Œå°±å¯ä»¥ç›´æ¥æ’­æ”¾ï¼Œè€Œä¸éœ€ç­‰åˆ°æ•´å€‹å½±ç‰‡è¼‰å®Œæ‰å¯ä»¥æ’­ï¼›&lt;br>
è€Œæ¯å€‹ç‰‡æ®µéƒ½å¯ä»¥è¢«Cacheåœ¨CDNï¼Œæ–¹ä¾¿æ¨é€åˆ°å…¨ä¸–ç•Œã€‚&lt;/p>
&lt;p>å°å¡Šç‹€çš„å½±ç‰‡ç¨±ç‚º &lt;code>Media Segment&lt;/code>ï¼Œå¸¸ç”¨çš„æ ¼å¼ç‚º ts / fmp4&lt;br>
æ’­æ”¾æ¸…å–®å‰‡æ˜¯ Playlistï¼Œæ ¼å¼ç‚º m3u8&lt;/p>
&lt;p>HLS æœ‰å…©ç¨® Playlist æ ¼å¼: &lt;code>Master Playlist&lt;/code> èˆ‡ &lt;code>Media Playlist&lt;/code>&lt;br>
Master Playlist ä¸»è¦æ˜¯ç‚ºäº†æä¾›å¤šç¨®è§£æåº¦ã€ç¿»è­¯å­—å¹•çš„æ’­æ”¾æ¸…å–® (Media Playlist)ï¼Œç•¶ Client (å¦‚æ’­æ”¾å™¨)ä¾æ“šç¶²è·¯æ¢ä»¶èˆ‡ç”¨æˆ¶é¸æ“‡ç­‰ï¼Œå‰‡é¸æ“‡æ”¯æ´çš„æ’­æ”¾æ¸…å–®ä¸‹è¼‰å½±ç‰‡æª”&lt;/p>
&lt;h4 id="master-playlist">&lt;code>Master Playlist&lt;/code>&lt;/h4>
&lt;p>ä¸»è¦é‡å°ç›¸åŒå…§å®¹æä¾›ä¸åŒçš„ Streamingï¼Œä¾‹å¦‚ä¸åŒçš„è§£æåº¦ã€ä¸åŒçš„åœ‹å®¶æœ‰ä¸åŒçš„å­—å¹•ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTM3U
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=1280000,AVERAGE-BANDWIDTH=1000000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://example.com/low.m3u8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=2560000,AVERAGE-BANDWIDTH=2000000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://example.com/mid.m3u8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=7680000,AVERAGE-BANDWIDTH=6000000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://example.com/hi.m3u8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=&amp;#34;mp4a.40.5&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://example.com/audio-only.m3u8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¤§æ„æ˜¯åœ¨å¹³å‡æµé‡6000000æ™‚æ’­æ”¾ hi.m3u8ï¼Œåœ¨æ¯”è¼ƒä½é»çš„1000000æ’­æ”¾ low.m3u8ï¼Œå¦‚æœæ˜¯é‡å°éŸ³æª”è€Œå·²å‰‡æ’­ audio-only.m3u8ã€‚&lt;/p>
&lt;h4 id="media-playlist">&lt;code>Media Playlist&lt;/code>&lt;/h4>
&lt;p>å°±æ˜¯ Master Playlistä¸­ StreamingæŒ‡å®šçš„ä¸²æµæ’­æ”¾æ¸…å–®ï¼Œä¸»è¦èªªæ˜è¦æ’­æ”¾çš„ç‰‡æ®µURIã€æ’­æ”¾æ™‚é•·ã€å¦‚ä½•è§£ç¢¼å½±ç‰‡æˆ–æ˜¯è§£å¯†å…§å®¹ç­‰ç­‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTM3U
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-TARGETDURATION:10
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:9.009,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://media.example.com/first.ts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:9.009,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://media.example.com/second.ts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:3.003,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>http://media.example.com/third.ts
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™å€‹ Media Playlist èªªæ˜äº†å¤§ç´„æœ€å¤§å€‹Media Segmentsæ’­æ”¾æ™‚é•·ç‚º10ç§’ï¼›&lt;br>
ç¬¬ä¸€å€‹ç‰‡æ®µ URI æ˜¯ http:â€¦/first.ts é•·åº¦ç‚º 9ç§’ï¼›&lt;br>
ç¬¬ä¸€å€‹ç‰‡æ®µæ’­å®Œæ›ç¬¬äºŒå€‹ç‰‡æ®µï¼Œä»¥æ­¤é¡æ¨ã€‚&lt;/p>
&lt;h3 id="media-segments">Media Segments&lt;/h3>
&lt;p>Media Playlist æ˜¯ç”±å¤šå€‹ &lt;code>Media Segments&lt;/code> è€Œçµ„æˆï¼Œæ¯å€‹Media Segments éƒ½æ˜¯å¿…é ˆè¨»æ˜æª”æ¡ˆä¾†æº(URI)ï¼Œä¸”åŸºæœ¬ä¸Šéœ€è¦æ˜¯èˆ‡å‰ä¸€å€‹Media Segments ç›¸é€£çºŒçš„å…§å®¹ï¼Œä¹Ÿå°±æ˜¯ 1 æ’­å®Œæ› 2 ï¼Œ2 æ’­å®Œæ› 3 çš„æ¦‚å¿µï¼Œé™¤éæœ‰é¡¯ç¤ºå®£å‘Šå…©å€‹Media Segments æ˜¯ä¸é€£çºŒçš„ã€‚&lt;/p>
&lt;p>ä»»ä¸€å€‹Media Segments éƒ½å¿…é ˆå¸¶æœ‰è¶³å¤ çš„è³‡è¨Šè®“æ’­æ”¾å™¨å¯ä»¥è§£ç¢¼ï¼Œåœ¨ä¸åŒæ ¼å¼ä¸‹ï¼Œæœ‰äº›æ ¼å¼çš„åˆå§‹åŒ–ç‰‡æ®µ(Media Initialization Segments) æ˜¯ç›¸åŒçš„ï¼Œé€™æ™‚å€™å¯ä»¥å®£å‘Š &lt;code>EXT-X-MAP&lt;/code> æŒ‡å®šï¼Œå¾ŒçºŒçš„Media Segments å°±å¯ä»¥å…±ç”¨ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹å¸¸è¦‹çš„æ”¯æ´æ ¼å¼æœ‰&lt;/p>
&lt;ol>
&lt;li>MPEG-2 Transport Stream&lt;/li>
&lt;li>Fragmented MPEG-4&lt;/li>
&lt;li>Packed Audio(éŸ³è¨Š)&lt;/li>
&lt;li>WebVTT(å­—å¹•)&lt;/li>
&lt;/ol>
&lt;p>å‰å…©è€…æ˜¯ä¸åŒçš„å½±éŸ³ç·¨ç¢¼æ ¼å¼ï¼ŒMPEG-2è¢«å»£æ³›æ‡‰ç”¨æ–¼æœ‰ç·šé›»è¦–ã€DVDç­‰ï¼Œè€ŒMPEG-4 æ˜¯åŸºæ–¼ MPEG-2 æ”¹è‰¯ï¼Œå„è‡ªæœ‰ä¸åŒçš„æ ¼å¼èˆ‡ Media Initialization Segments çš„æ ¼å¼ã€‚&lt;/p>
&lt;p>WebVTTé€šå¸¸éœ€è¦é¡å¤–çš„ EXT-TIMESTAMP-MAP å»èˆ‡å½±éŸ³æ’­æ”¾æ ¡æ™‚ã€‚&lt;/p>
&lt;h3 id="playlist">Playlist&lt;/h3>
&lt;p>Playlist çš„æª”åå¿…é ˆæ˜¯Â &lt;code>.m3u8&lt;/code> /Â &lt;code>.m3u&lt;/code> ï¼Œä¸¦ä¸”å›å‚³çš„ HTTP Response Content-Typeå¿…é ˆç‚º &lt;code>application/vnd.apple.mpegur&lt;/code> æˆ–æ˜¯ &lt;code>audio/mpegurl&lt;/code> ï¼›&lt;br>
ç·¨ç¢¼å¿…é ˆæ¡ç”¨ &lt;code>utf-8&lt;/code> ï¼Œé™¤äº† CR / LF å¤–ä¸èƒ½æœ‰å…¶ä»– utf-8å®šç¾©çš„æ§åˆ¶ç¢¼ã€‚&lt;/p>
&lt;p>åœ¨Playlistä¸­ï¼Œæ¯ä¸€è¡Œå¯ä»¥æ˜¯ URI / ç©ºç™½æˆ–æ˜¯ç”± &lt;code>#&lt;/code> é–‹é ­çš„å­—ä¸²ï¼›&lt;br>
ç‰¹åˆ¥æ³¨æ„ # é–‹é ­çš„å­—ä¸²å¯ä»¥æ˜¯æ¨™ç±¤æˆ–æ˜¯è¨»è§£ï¼Œæ¨™ç±¤åƒæ˜¯ &lt;code>#EXT-X&lt;/code> é–‹é ­ï¼Œä¸”å€åˆ†å¤§å°å¯«(æ¨™ç±¤å…¨å¤§å¯«)&lt;/p>
&lt;p>URI éƒ¨åˆ†å¯ä»¥æ˜¯ç›¸å°è·¯å¾‘ï¼Œç›¸å°æ–¼ Playlist çš„URIã€‚&lt;/p>
&lt;p>æ¥è‘—ä»‹ç´¹Playlistçš„çµ„æˆæ¨™ç±¤ï¼Œé€™éƒ¨åˆ†ä¸»è¦æ˜¯ç¯€éŒ„ Specå…§å®¹ï¼Œå› ç‚ºæ˜¯åè©å®šç¾©æœ‰é»æ¯ç‡¥ï¼Œæœ‰èˆˆè¶£å¯ä»¥æ·±å…¥æŸ¥è©¢ï¼Œå¾ŒçºŒæœƒæœ‰å¯¦éš›ç¯„ä¾‹ã€‚&lt;/p>
&lt;h4 id="basic-tags">Basic Tags&lt;/h4>
&lt;p>Playlist å¯åˆ†æˆ Media Playlist èˆ‡ Master Playlistï¼Œä»¥ä¸‹ç‚ºå…©è€…å…±ç”¨çš„æ¨™ç±¤ã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;strong>EXTM3U&lt;/strong>&lt;br>
æŒ‡å®šæª”æ¡ˆç‚º Extented M3Uï¼Œå¿…é ˆæ˜¯æª”æ¡ˆçš„ç¬¬ä¸€è¡Œ(é›·åŒæ–¼htmlçš„ DOCTYPE)&lt;/li>
&lt;li>&lt;strong>EXT-X-VERSION&lt;/strong>&lt;br>
æŒ‡å®šç‰ˆè™Ÿï¼Œç›®å‰æœ€æ–°ç‰ˆç‚º 7ï¼Œæ•´ä»½ Playliståªæ‡‰è©²å‡ºç¾ä¸€æ¬¡ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="media-segmentstags">Media SegmentsÂ Tags&lt;/h4>
&lt;p>Media Segments Tag æœƒæ‡‰ç”¨æ–¼ä¸‹ä¸€å€‹ Media Segment æˆ–æ˜¯å¾ŒçºŒæ‰€æœ‰çš„Media Segment ä¸Šã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;strong>EXTINF&lt;/strong>&lt;br>
è¨»æ˜è©² Media Segmentçš„æ™‚é–“é•·åº¦ï¼Œé€™å€‹æ¨™ç±¤æ˜¯å¿…é ˆçš„ã€‚&lt;br>
æ ¼å¼ç‚º &lt;code>#EXTIF:&amp;lt;duration&amp;gt;,[&amp;lt;title&amp;gt;]&lt;/code>Â &lt;br>
duration å–®ä½ç‚ºç§’ï¼Œå»ºè­°ç”¨æµ®é»æ•¸è¡¨ç¤ºï¼Œå¦‚æœç‰ˆè™Ÿå°æ–¼ä¸‰æ‰ä½¿ç”¨æ•´æ•¸&lt;/li>
&lt;li>&lt;strong>EXT-X-BYTERANGE&lt;/strong>&lt;br>
è¨»è¨˜è©² Media Segmentåªæˆªå–æŸç¯„åœè€Œéæ•´å€‹å®Œæ•´æª”æ¡ˆ&lt;br>
æ ¼å¼ç‚º &lt;code>#EXT-X-BYTERANGE:&amp;lt;n&amp;gt;[@&amp;lt;o&amp;gt;]&lt;/code>Â &lt;br>
if( o ) {&lt;br>
Â o ä»£è¡¨ byte offsetï¼Œnè¡¨ç¤ºå¾oé–‹å§‹å–å¹¾å€‹ byte&lt;br>
} else {&lt;br>
Â o å–ä¸Šä¸€å€‹ Media Segmentçš„çµå°¾&lt;br>
}&lt;/li>
&lt;li>&lt;strong>EXT-X-DISCONTINUITY&lt;/strong>&lt;br>
å…ˆå‰èªªæ¯å€‹ Media Segment éƒ½å¿…é ˆæ˜¯é€£çºŒçš„ï¼Œä½†å¦‚æœæª”æ¡ˆæ ¼å¼ã€å½±éŸ³è»Œ(Track)çš„æ•¸å­—/å‹åˆ¥ç­‰ã€timestamp æœ‰æ”¹è®Šï¼Œå°±å¿…é ˆè¦é¡¯ç¤ºå®£å‘Š&lt;/li>
&lt;li>&lt;strong>EXT-X-KEY&lt;/strong>&lt;br>
Media Segment å¯ä»¥è¢«åŠ å¯†ï¼Œè€Œ&lt;code>#EXT-X-KEY&lt;/code>å‰‡æ˜¯å®£å‘Šè§£å¯†çš„æ–¹å¼&lt;/li>
&lt;li>&lt;strong>EXT-X-MAP&lt;/strong>&lt;br>
å®šæ‡‰ Media Initialization Segments ä¾†æºï¼Œæ•ˆåŠ›æ‡‰ç”¨æ–¼æ¯å€‹Media Segment ä¸Šï¼›&lt;br>
æ ¼å¼ç‚º &lt;code>#EXT-X-MAP:&amp;lt;Attribute-List&amp;gt;&lt;/code>&lt;/li>
&lt;li>&lt;strong>EXT-X-PROGRAM-DATE-TIME&lt;/strong>&lt;br>
å®£å‘Šç¬¬ä¸€å€‹Media Segment çš„çµ•å°æ™‚é–“ï¼Œæ ¼å¼ç‚º ISO-8601ï¼Œé ˆåŒ…å«æ™‚å€ï¼Œä¾‹å¦‚ &lt;code>#EXT-X-PROGRAM-DATE-TIME:2010â€“02â€“19T14:54:23.031+08:00&lt;/code>&lt;/li>
&lt;li>&lt;strong>EXT-X-DATERANGE&lt;/strong>&lt;br>
æŒ‡å®šè©²æ™‚é–“ç¯„åœå…§çš„å±¬æ€§å®šç¾©ï¼Œé€™éƒ¨åˆ†æˆ‘çœ‹ä¸æ‡‚åœ¨å¹¹å˜›OTZ&lt;/li>
&lt;/ol>
&lt;h4 id="media-playlisttags">Media PlaylistÂ Tags&lt;/h4>
&lt;ol>
&lt;li>&lt;strong>EXT-X-TARGETDURATION&lt;/strong>&lt;br>
å–®å€‹ Media Segments çš„ EXTINTæœ€å¤§å€¼ï¼Œå–®ä½ç‚ºç§’ï¼Œæ ¼å¼æ˜¯æ•´æ•¸ï¼Œæ­¤æ¨™ç±¤ç‚ºå¿…å¡«ã€‚&lt;/li>
&lt;li>&lt;strong>EXT-X-MEDIA-SEQUENCE&lt;/strong>&lt;br>
è¨»è¨˜ç¬¬ä¸€å€‹Media Segmentçš„åºè™Ÿï¼Œå¦‚æœä¸å­˜åœ¨å‰‡é è¨­ç‚º0ï¼›&lt;br>
æ­¤æ¨™ç±¤éœ€å‡ºç¾æ–¼æ‰€æœ‰Media Segments ä¹‹å‰&lt;/li>
&lt;li>&lt;strong>EXT-X-DISCONTINUITY-SEQUENCE&lt;/strong>&lt;br>
ç”¨æ–¼å¤šå€‹ä¸²æµåŒæ­¥çš„åºè™Ÿã€‚&lt;/li>
&lt;li>&lt;strong>EXT-X-ENDLIST&lt;/strong>&lt;br>
ä¸æœƒæœ‰æ›´å¤šçš„ Media Segmentè¢«åŠ å…¥ Playlistä¸­ï¼Œå¯ä»¥å‡ºç¾åœ¨æ¸…å–®çš„å„è™•&lt;/li>
&lt;li>&lt;strong>EXT-X-PLATLIST-TYPE&lt;/strong>&lt;br>
å¯ä»¥æ˜¯ EVENT æˆ–æ˜¯ VOD&lt;br>
EVENT è¡¨ç¤º Media Segment æœƒæŒçºŒåŠ åˆ° Playlistä¹‹å¾Œ&lt;br>
VODè¡¨ç¤º Playlist ä¸æœƒæ”¹è®Šäº†&lt;/li>
&lt;li>&lt;strong>EXT-X-I-FRAMES-ONLY&lt;/strong>&lt;br>
æ¯å€‹ Media Segmentéƒ½æ˜¯ç¨ç«‹çš„I-Frameï¼Œå½±ç‰‡çš„ç·¨ç¢¼èˆ‡å‰å¾Œæ²’æœ‰ç›¸ä¾æ€§ï¼Œå¯ç”¨æ–¼å¿«è½‰ã€å¿«é€Ÿå€’å¸¶ã€é—œéµå½±æ ¼ç­‰å ´æ™¯ï¼Š&lt;/li>
&lt;/ol>
&lt;h4 id="master-playlisttags">Master PlaylistÂ Tags&lt;/h4>
&lt;ol>
&lt;li>&lt;strong>EXT-X-MEDIA&lt;/strong>&lt;br>
è¨»æ˜åœ¨ä¸åŒçš„å ´æ™¯(ä¾‹å¦‚ç´”éŸ³æª”/è‹±æ–‡å­—å¹•/æ³•æ–‡å­—å¹•ç­‰)ä¸‹æ’­æ”¾ä¸åŒçš„ Media Playlistï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„Renditionï¼Œä½†é€™äº›Playlistéƒ½å¿…é ˆæ˜¯ç›¸åŒçš„å…§å®¹ï¼›&lt;br>
å…¶ä¸­æœ‰è¨±å¤šå±¬æ€§å¯ä»¥è¨­å®š&lt;br>
&lt;code>TYPE&lt;/code>:å¯ä»¥æ˜¯AUDIO/VIDEO/SUBTITLE/CLOSE-CAPTIONS(éš±è—å­—å¹•)&lt;br>
&lt;code>URI&lt;/code>:å°æ‡‰çš„Media Playlist è³‡æºä½ç½®&lt;br>
&lt;code>LANGUAGE&lt;/code>&lt;br>
&lt;code>ASSOC-LANGUAGE&lt;/code>ï¼šç”¨æ–¼å…¶ä»–åœ°æ–¹çš„èªè¨€æŒ‡å®šï¼Œå¦‚èªéŸ³ vs æ–‡å­—&lt;br>
&lt;code>DEFAULT&lt;/code>ï¼šé è¨­æ’­æ”¾æ­¤Playlist&lt;br>
&lt;code>GROUP-ID&lt;/code>ï¼šè‡ªå®šç¾©çš„åç¨±&lt;br>
ç­‰ç­‰&lt;/li>
&lt;li>&lt;strong>EXT-X-STREAM-INF&lt;/strong>&lt;br>
å®£å‘Š Variant Streamï¼Œå±¬æ€§æœ‰&lt;br>
&lt;code>BANDWITDH&lt;/code>ï¼šåŠ ç¸½Media Playlistçš„æœ€å¤§ Segment Bit rate&lt;br>
&lt;code>AVERAGE-BANDWITDH&lt;/code>ï¼šå¹³å‡æ¯ç§’å¹¾å€‹bits&lt;br>
&lt;code>CODES&lt;/code>ï¼šç·¨è§£ç¢¼æ ¼å¼&lt;br>
&lt;code>VIDEO&lt;/code>ï¼šå…¶å€¼éœ€å°æ‡‰&lt;code>#EXT-X-MEDIA&lt;/code> çš„&lt;code>GROUP-ID&lt;/code> ï¼Œä¸”è©²&lt;code>#EXT-X-MEDIA&lt;/code> çš„TYPEå¿…é ˆæ˜¯ VIDEO&lt;br>
&lt;code>AUDIO&lt;/code>ï¼šç‹€æ³é›·åŒ&lt;br>
&lt;code>#EXT-X-STREAM-INF&lt;/code>èˆ‡&lt;code>#EXT-X-MEDIA&lt;/code> ç›¸è¼”ç›¸æˆ&lt;/li>
&lt;li>EXT-X-I-FRAME-STREAM-INF&lt;/li>
&lt;li>&lt;strong>EXT-X-SESSION-DATA&lt;/strong>&lt;br>
ä»»æ„çš„ Sessionå€¼&lt;/li>
&lt;li>&lt;strong>EXT-X-SESSION-KEY&lt;/strong>&lt;br>
é å…ˆåŠ è¼‰åœ¨ Media Playlistå®£å‘Šçš„ EXT-X-KEYçš„å€¼&lt;/li>
&lt;/ol>
&lt;h4 id="media-or-master-playlisttags">Media or Master PlaylistÂ Tags&lt;/h4>
&lt;ol>
&lt;li>&lt;strong>EXT-X-INDEPENDENT_SEGMENTS&lt;/strong>&lt;br>
è¨»è¨˜æ¯å€‹Media Segments å¯ä»¥å–®ç¨decodeè€Œä¸éœ€è¦å…¶ä»– segmentçš„è³‡è¨Š&lt;br>
å¦‚æœå‡ºç¾åœ¨Master Playlistå°æ‰€æœ‰ Media Playlistéƒ½æœ‰æ•ˆ&lt;/li>
&lt;li>&lt;strong>EXT-X-START&lt;/strong>&lt;br>
å¾ä½•è™•é–‹å§‹æ’­æ”¾æ¸…å–®&lt;br>
éœ€æŒ‡å TIME-OFFSETå±¬æ€§ï¼Œæ­£å€¼ä»£è¡¨å¾å½±ç‰‡é–‹é ­é–‹å§‹ç®—ï¼Œè² å€¼å‰‡å¾å½±ç‰‡å°¾ç«¯é–‹å§‹ç®—&lt;br>
TIME-OFFSETå€¼ä¸å¯è¶…éå½±ç‰‡çš„é•·åº¦ï¼Œå¦‚æœè¶…éå‰‡æ­£å€¼å¾å°¾éƒ¨ç®—è€Œè² å€¼å¾é ­ç®—(ä¸€å€‹å¾ªç’°çš„æ¦‚å¿µ)&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šæ˜¯æ‰€æœ‰çš„æ¨™ç±¤ï¼Œä¹Ÿä¸æ˜¯æ¯å€‹æ„æ€éƒ½å¾ˆå¥½ç†è§£ï¼Œå¾ŒçºŒç›¡é‡ä»¥ç¯„ä¾‹èªªæ˜&lt;/p>
&lt;h3 id="key-files">Key files&lt;/h3>
&lt;p>EXT-X-KEYçš„URIå±¬æ€§æ¨™è¨˜Keyçš„æª”æ¡ˆä½ç½®ï¼Œç”¨æ–¼è§£å¯†Media Segmentsï¼›&lt;br>
ç›®å‰çš„åŠ å¯†æ–¹å¼å¯æ”¯æ´ AES-128ï¼Œå¦‚æœæ¡ç”¨æ­¤åŠ å¯†æ–¹å¼ï¼Œå‰‡éœ€è¦ IVå€¼ï¼Œç”¨æ–¼å¢å¼·AES-128åŠ å¯†çš„åˆå§‹å€¼ã€‚&lt;/p>
&lt;h3 id="client--server-responsibilities">Client / Server Responsibilities&lt;/h3>
&lt;p>ç¬¬å…­ç« ä¸»è¦å®šç¾©Server / Client é‡åˆ°ä¸åŒæ¨™ç±¤çš„è™•ç†è¡Œç‚ºï¼Œç®—æ˜¯ä¸Šé¢çš„å¤§çµ±æ•´ï¼Œä»¥åŠå¯¦åšä¸Šçš„å¼•å°èªªæ˜ã€‚&lt;/p>
&lt;h4 id="server">Server&lt;/h4>
&lt;p>è² è²¬ç”¢ç”ŸPlaylistèˆ‡æä¾›Media Segments&lt;/p>
&lt;p>å¯¦éš›å¦‚ä½•ç”¢ç”Ÿä¾†æºåª’é«”æª”ä¸å† Specç¯„ç–‡ä¸­ï¼Œè€ŒServerå¿…é ˆè² è²¬æŠŠä¾†æºåª’é«”æª”åˆ†å‰²æˆé€£çºŒä¸”æ™‚é•·å°æ–¼ç¸½ç›®æ¨™æ™‚é•·çš„Media Segmentsï¼Œéœ€æ³¨æ„ç•¶Serveråˆ†å‰²æª”æ¡ˆæ™‚éœ€è¦åˆ‡åœ¨ &lt;code>packet&lt;/code> / &lt;code>key frame&lt;/code> ä¸Šï¼›&lt;br>
æ¥è‘—é‡å°æ¯å€‹Media Segmentåˆ†é…ç‰¹å®šçš„URIï¼Œå¦‚æœServeræ”¯æ´ Byte-Range GETå‰‡å¯ä»¥åœ¨Playlistä¸­ä½¿ç”¨ EXT-X-BYTERANGE&lt;/p>
&lt;p>ç•¶Media Segment è¢«é‹ç”¨åœ¨ Playlistä¸­ï¼ŒServerå¿…é ˆç¢ºä¿è³‡æºå¯ä»¥è¢«å–å¾—ä¸”ä¸æœƒå‡ºéŒ¯ï¼Œä¸”ä¸‹è¼‰å¿…é ˆæ˜¯ç«‹å³ä¸‹è¼‰è€Œé Streaming&lt;/p>
&lt;p>å¦‚æœTYPEæ˜¯ VODï¼ŒServer ç”¢ç”Ÿå‡º Playlistå°±ä¸æ‡‰è©²ä¿®æ”¹ï¼›&lt;br>
å¦‚æœTYPE æ˜¯ EVENTï¼Œå·²ç¶“ç”¢ç”Ÿçš„Playlistä¹Ÿä¸èƒ½ä¿®æ”¹ï¼Œåªèƒ½åœ¨Playlistä¹‹å¾Œç¹¼çºŒå¢åŠ è¡Œæ•¸ã€‚&lt;/p>
&lt;p>å¦‚æœMedia Playlistæ²’æœ‰åŒ…å« EXT-X-ENDLISTï¼Œå‰‡Server å¿…é ˆæä¾›åŒ…å«æ–°çš„Media Segments ä¾†æ›´æ–°Playlistï¼Œè€Œæä¾›çš„æ™‚é–“å¿…é ˆç­‰ 0.5 ~ 1.5 ç›®æ¨™æ™‚é–“å…§ï¼Œå› ç‚ºé€™æ¨£æ‰èƒ½æœ€å¤§åŒ–åˆ©ç”¨ç¶²è·¯æ•ˆèƒ½ã€‚&lt;/p>
&lt;h4 id="client">Client&lt;/h4>
&lt;p>ç•¶Client æ”¶åˆ°Master Playlist ï¼Œå¯ä»¥é¸æ“‡ä¸€å€‹ Variant Stream æ’­æ”¾ï¼ŒClient å¿…é ˆæª¢æŸ¥ç‰ˆè™Ÿèˆ‡æ¨™ç±¤çš„èªæ³•ï¼Œå¦‚æœä¸åˆå‰‡åœæ­¢æ’­æ”¾ï¼Œä½†ç‚ºäº†æ›´å¥½çš„å‘å‰ç›¸å®¹ï¼Œé‡åˆ°ç„¡æ³•è­˜åˆ¥çš„æ¨™ç±¤æˆ–å±¬æ€§å€¼å°±è‡ªå‹•å¿½ç•¥ã€‚&lt;/p>
&lt;p>å¦‚æœ Media Playlist TYPE æ˜¯ Event ä¸”æ²’æœ‰ EXT-X-ENDLIST å‰‡å¿…é ˆå®šæœŸé‡è¼‰ Playlist ä»¥ä¾¿ç²å–æœ€æ–°çš„ Media Segmentsï¼Œä½†ç‚ºäº†ä¸å¸¶çµ¦Serveréå¤šè² æ“”ï¼Œé‡æ–°ç²å–çš„æ™‚é–“å·®å¿…é ˆåœ¨è‡³å°‘ä¸€å€çš„ target durationï¼Œå¦‚æœç¬¬ä¸€æ¬¡é‡è¼‰å¾Œæ²’æœ‰æ›´æ–°å‰‡è‡³å°‘ç­‰åŠå€‹target duration å†é‡è©¦ã€‚&lt;/p>
&lt;p>é€™éƒ¨åˆ†å…§å®¹å¾ˆå¤šï¼Œæœ‰èˆˆè¶£å¯ä»¥æ…¢æ…¢ç¿»ï¼Œä¸»è¦å°±æ˜¯è¬›å¦‚ä½•è¼‰å…¥è³‡æºèˆ‡é‡åˆ°æ¨™ç±¤è¦æ€éº¼è™•ç†ç­‰ç­‰&lt;/p>
&lt;h3 id="examples">Examples&lt;/h3>
&lt;p>&lt;a class="link" href="https://developer.apple.com/documentation/http_live_streaming/example_playlists_for_http_live_streaming" target="_blank" rel="noopener"
>&lt;strong>Example Playlists for HTTP Live Streaming | Apple Developer Documentation&lt;/strong>&lt;/a>&lt;/p>
&lt;p>Spec ä¸­ä¹Ÿæœ‰ç¯„ä¾‹ï¼Œä½†é€™é‚Šæˆ‘æ“·å–Apple Developer çš„ç¯„ä¾‹&lt;/p>
&lt;h4 id="å®‰æ’å»£å‘Š">å®‰æ’å»£å‘Š&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTM3U
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-TARGETDURATION:10
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-VERSION:4
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-MEDIA-SEQUENCE:0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:10.0,ad0.ts
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:8.0,ad1.ts
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-DISCONTINUITY
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:10.0,movieA.ts
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTINF:10.0,movieB.ts
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„åœ¨ ad1.ts èˆ‡ movieA.ts ä¸­æœ‰å€‹ &lt;code>#EXT-X-DISCONTINUITY&lt;/code> ï¼Œå› ç‚º Ad è·Ÿ Movie å‹¢å¿…æ˜¯å…©å€‹ä¸åŒçš„ç‰‡æ®µï¼Œæ‰€ä»¥å¿…é ˆåŠ å…¥æ‰ä¸æœƒå› ç‚º timestamp éŠœæ¥ä¸ä¸Šè€Œå°è‡´æ’­æ”¾éŒ¯èª¤ï¼&lt;/p>
&lt;h4 id="master-playlist-with-alternative-audio">Master Playlist with Alternative Audio&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXTM3U
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&amp;#34;aac&amp;#34;,NAME=&amp;#34;English&amp;#34;, \\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span> DEFAULT=YES,AUTOSELECT=YES,LANGUAGE=&amp;#34;en&amp;#34;, \\
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> URI=&amp;#34;main/english-audio.m3u8&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&amp;#34;aac&amp;#34;,NAME=&amp;#34;Deutsch&amp;#34;, \\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span> DEFAULT=NO,AUTOSELECT=YES,LANGUAGE=&amp;#34;de&amp;#34;, \\
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> URI=&amp;#34;main/german-audio.m3u8&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&amp;#34;aac&amp;#34;,NAME=&amp;#34;Commentary&amp;#34;, \\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span> DEFAULT=NO,AUTOSELECT=NO,LANGUAGE=&amp;#34;en&amp;#34;, \\
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> URI=&amp;#34;commentary/audio-only.m3u8&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=1280000,CODECS=&amp;#34;...&amp;#34;,AUDIO=&amp;#34;aac&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>low/video-only.m3u8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=2560000,CODECS=&amp;#34;...&amp;#34;,AUDIO=&amp;#34;aac&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>mid/video-only.m3u8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=7680000,CODECS=&amp;#34;...&amp;#34;,AUDIO=&amp;#34;aac&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>hi/video-only.m3u8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">#EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=&amp;#34;mp4a.40.5&amp;#34;,AUDIO=&amp;#34;aac&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>main/english-audio.m3u8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœå¸Œæœ›å¯ä»¥è®“Video ä¾æ“šä¸åŒçš„é »å¯¬åˆ‡æ›ï¼Œè€ŒéŸ³æª”æ ¹æ“šä¸åŒçš„èªè¨€é¸æ“‡åˆ‡æ›ï¼Œå°±å¯ä»¥åƒè€ƒé€™å€‹ç¯„ä¾‹&lt;/p>
&lt;p>&lt;code>#EXT-X-MEDIA&lt;/code> å®šç¾©äº†Renditionï¼Œé€éLANGUAGEæŒ‡å®šèªè¨€ï¼Œæ¥è‘—TYPEè¡¨æ˜ç‚ºAUDIOè²éŸ³æª”ï¼ŒGROUP-IDè‡ªå–ç‚º aacï¼›&lt;/p>
&lt;p>è€Œ&lt;code>#EXT-X-STREAM-INF&lt;/code> å®šç¾©çš„æ˜¯ Variant Streamï¼ŒAUDIOæŒ‡å®šç‚º aacï¼Œä¹Ÿå°±æ˜¯å°æ‡‰ &lt;code>#EXT-X-MEDIA&lt;/code> çš„GROUP-IDï¼Œå…¶URIå‰‡æŒ‡å®šæ’­æ”¾ videoã€‚&lt;/p>
&lt;p>å¯ä»¥çœ‹å‡ºå¸¸ç”¨çš„æ¨™ç±¤å°±é‚£å¹¾å€‹ï¼Œæœ‰äº›æ¨™ç±¤æˆ‘ä¾†å›çœ‹äº†å¹¾æ¬¡é‚„æ˜¯çœ‹ä¸æ‡‚ï¼Œåƒæ˜¯ EXT-X-DATERANGEå°±å¾ˆé›£æ‡‚ï¼Œç¯„ä¾‹ä¹Ÿéƒ½æ²’ç”¨ä¸Šï¼Œå¦‚æœæœ‰äººçŸ¥é“å¯¦éš›ä¸Šçš„æ‡‰ç”¨èˆ‡åŸç†å†éº»ç…©ç•™è¨€äº†OTZ&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>æ•´ä»½Spec æ­»å—‘å®Œå¾ˆå¤šéƒ¨ä»½ä¹Ÿé‚„æ˜¯æ‡µæ‡µæ‡‚æ‡‚ï¼Œä½†è‡³å°‘æœ‰å€‹å…¨å±€çš„èªçŸ¥èˆ‡ä»‹ç´¹ï¼Œä¸‹ä¸€ç« å¾å½±ç‰‡è™•ç†åˆ°Playlistä¿®æ”¹ï¼Œä¾†çœ‹å¯¦éš›æ‡‰ç”¨çš„è™•ç†ã€‚&lt;/p>
&lt;h3 id="è¨»è¨˜">è¨»è¨˜&lt;/h3>
&lt;h4 id="å½±ç‰‡ç·¨ç¢¼">å½±ç‰‡ç·¨ç¢¼&lt;/h4>
&lt;p>åƒè€ƒç¶­åŸºç™¾ç§‘&lt;/p>
&lt;p>&lt;a class="link" href="https://zh.wikipedia.org/wiki/%E8%A6%96%E8%A8%8A%E5%A3%93%E7%B8%AE%E5%9C%96%E5%83%8F%E9%A1%9E%E5%9E%8B" target="_blank" rel="noopener"
>&lt;strong>è¦–è¨Šå£“ç¸®åœ–åƒé¡å‹ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å½±åƒæ˜¯ä¸€å¹€ä¸€å¹€çš„åœ–ç‰‡é€£çºŒå¿«é€Ÿæ’­æ”¾ï¼Œä½†å¦‚æœå„²å­˜æ™‚æŠŠæ¯ä¸€å¹€éƒ½ç”¨åœ–ç‰‡æ–¹å¼å„²å­˜è³‡æ–™é‡æœƒéå¸¸å¤§ï¼Œä½†æ˜¯å½±ç‰‡å¾€å¾€ä¸€æ®µæ™‚é–“çš„å ´æ™¯é›·åŒï¼Œå¦‚æœæˆ‘å¯ä»¥å…ˆè¨˜ç¬¬ä¸€å¼µåœ–ï¼Œå…¶é¤˜å»è¨ˆç®—ç¬¬äºŒå¼µèˆ‡ç¬¬ä¸€å¼µå·®å¤šå°‘çš„æ¦‚å¿µå»å„²å­˜ï¼Œå°±å¯ä»¥é¿å…å„²å­˜éå¤šç›¸åŒå†—ä½™çš„æ•¸æ“š&lt;br>
ä½†å› ç‚ºè¦é¿å…æ‰äº†ä¸€é»è³‡æ–™å°±å…¨æ¯€ï¼Œä¿ç•™ä¸€äº›å½ˆæ€§æ‰€ä»¥æœƒåœ¨ä¸åŒæ™‚åˆ»å®‰æ’å–å…¨åœ–çš„æ™‚æ©Ÿã€‚&lt;/p>
&lt;p>å½±ç‰‡å£“ç¸®é€éå»ºç«‹ I-Frame / P-Frame / B-Frameæ–¹å¼&lt;br>
I-Frame é—œéµå½±æ ¼ï¼ŒåŸºæœ¬ä¸Šå°±å„²å­˜ä¸¦å£“ç¸®æ•´å¼µåœ–ï¼Œä½œç‚ºå…¶ä»–Frameè§£ç¢¼çš„ä¾æ“š&lt;br>
P-Frameå‰‡åƒ…å„²å­˜èˆ‡ä¸Šä¸€å€‹ I Frameå·®ç•°çš„åƒç´ &lt;br>
B-Frameå‰‡ç‚ºå‰å¾Œé æ¸¬åœ–åƒï¼Œæœƒåƒè€ƒå‰ä¸€å€‹ I-Frame èˆ‡å¾Œä¸€å€‹ P-Frame&lt;br>
æ‰€ä»¥å¤§è‡´æœƒé•·æˆ &lt;code>IBB..PIBB..P&lt;/code>ï¼Œå– I-Frame / B-Frame çš„é »ç‡å¯ä»¥åœæ•´&lt;/p>
&lt;p>å½±éŸ³æª”èˆ‡ FFMpeg æ•™å­¸ï¼š&lt;a class="link" href="https://github.com/leandromoreira/ffmpeg-libav-tutorial" target="_blank" rel="noopener"
>ffmpeg-libav-tutorial&lt;/a>&lt;/p></description></item><item><title>MongoDB Shard Cluster æ¶è¨­</title><link>https://yuanchieh.page/posts/2018/2018-09-08-mongodb-shard-cluster-%E6%9E%B6%E8%A8%AD/</link><pubDate>Sat, 08 Sep 2018 07:53:36 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-09-08-mongodb-shard-cluster-%E6%9E%B6%E8%A8%AD/</guid><description>&lt;p>åœ¨å¤§é‡è³‡æ–™éœ€è¦å„²å­˜ä¸‹ï¼Œå¯ä»¥å°‡ MongoDBåš Sharding èˆ‡ Replica Set è¨­ç½®ï¼Œå¢åŠ DBçš„ååé‡èˆ‡å¯ç”¨æ€§ã€‚&lt;/p>
&lt;p>åƒè€ƒ MongoDBçš„å®˜ç¶²ï¼Œå¯ä»¥å¾ˆç°¡å–®çš„å°±æ¶èµ· Shard Cluster æ¶æ§‹ï¼Œä»¥ä¸‹ç°¡å–®è¨˜éŒ„å¯¦ä½œéç¨‹ã€‚&lt;br>
ç›®å‰ä½¿ç”¨ v3.4ï¼Œä¸æ¡ç”¨æœ€æ–°ç‰ˆ 4.0 æ˜¯å› ç‚ºå…¬å¸ç’°å¢ƒç”¨ 3.4ï¼Œä½†çœ‹äº†æ–‡ä»¶å¥½åƒå·®ä¸å¤ªå¤šã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://www.mongodb.com/presentations/webinar-everything-you-need-know-about-sharding?jmp=docs" target="_blank" rel="noopener"
>&lt;strong>Webinar: Everything You Need to Know about Sharding&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å¼·çƒˆå»ºè­°çœ‹å®Œé€™éƒ¨ä¸€å°æ™‚çš„å½±ç‰‡ï¼Œæ•´å€‹è§€å¿µéå¸¸æ¸…æ¥šã€‚&lt;/p>
&lt;p>è³‡æ–™åº«è¨­å®šå¿…é ˆå¾æœ€ä¸€é–‹å§‹çš„&lt;br>
ã€Œæœƒæœ‰å¤šå°‘è³‡æ–™è¦å„²å­˜ï¼Ÿ çµæ§‹å¤§æ¦‚æ˜¯å¦‚ä½•ï¼Ÿ éœ€è¦ä¿å­˜å¤šä¹…æˆ–æ˜¯æœ‰ä»€éº¼æ¥­å‹™éœ€æ±‚ï¼Ÿå¯«å…¥æœƒå¤§æ¦‚æ˜¯æ€æ¨£æƒ…æ³ï¼Ÿè®€å–åˆæœƒæ˜¯å¦‚ä½•ï¼Ÿæœƒéœ€è¦é«˜ååé‡åˆæˆ–æ˜¯ä½å»¶é²å—ï¼Ÿã€&lt;br>
é€™äº›å› å­æœƒæ ¹æœ¬æ€§æ±ºå®šè³‡æ–™åº«çš„è¨­è¨ˆï¼ŒåŒ…å« æ˜¯å¦è¦ sharding / databaseã€collectionã€index å¦‚ä½•è¨­è¨ˆï¼Œç”šè‡³æ˜¯ä¸»æ©Ÿçš„è¦æ ¼èˆ‡åœ°é»é¸æ“‡ã€‚&lt;/p>
&lt;h3 id="æ¶æ§‹åœ–">æ¶æ§‹åœ–&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__HijPG3lhbfiPMS2sHD9mpg.jpeg"
loading="lazy"
alt="æˆªåœ–è‡ªå®˜ç¶²"
>
æˆªåœ–è‡ªå®˜ç¶²&lt;/p>
&lt;p>ä¸»è¦æœ‰ä¸‰å€‹éƒ¨åˆ†ï¼š&lt;/p>
&lt;ol>
&lt;li>Mongosï¼šå°å¤–é€£æ¥ DB Client æ¥æ”¶å°DBçš„è®€å¯«ï¼Œæ¥è‘—å†æ ¹æ“š Config Server æ±ºå®šåˆ°å“ªå€‹ Shard è®€å¯«(æœƒcacheä½æŸ¥è©¢çµæœ)&lt;/li>
&lt;li>Config Serverï¼šç´€éŒ„ metadataèˆ‡è³‡æ–™åœ¨å“ªå€‹ shard ä¸Šï¼Œ3.4ä¹‹å¾Œ&lt;code>å¿…é ˆæ˜¯replica set æ¶æ§‹&lt;/code>&lt;/li>
&lt;li>Shardï¼šåˆ†ç‰‡å„²å­˜è³‡æ–™è™•ï¼Œ&lt;code>å»ºè­°æ¡ç”¨ replica set æ¶æ§‹&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æœ€åŸºæœ¬è¦é–‹ 1å° Mongos / 3 å° Config Server / 2 çµ„Shard Replica Set å…± 11å°ï¼Œåˆ†äº«ä¸€ä¸‹æˆ‘åœ¨ AWS ä¸Šé–‹ 11å° t2.nano é… EBS ä¸€å¤©å¤§æ¦‚å…©ç¾é‡‘ã€‚&lt;br>
ä»¥ä¸‹é è¨­æ¯å°æ©Ÿå™¨éƒ½å®‰è£å¥½ &lt;a class="link" href="mailto:mongo@3.4" >mongo@3.4&lt;/a>&lt;/p>
&lt;h3 id="å¯¦ä½œ">å¯¦ä½œ&lt;/h3>
&lt;h4 id="config-server">Config server&lt;/h4>
&lt;p>å› ç‚ºæœ‰äº›è¨­å®šæª”å¯«æˆ config fileæ¯”è¼ƒæ–¹ä¾¿ï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„ mongo.conf&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-conf" data-lang="conf">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># mongod.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># for documentation of all options, see:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># [http://docs.mongodb.org/manual/reference/configuration-options/](http://docs.mongodb.org/manual/reference/configuration-options/)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># where to write logging data.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">systemLog&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">destination&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="nv">file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">logAppend&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">path&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="nv">var&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">log&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">mongodb&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">mongod.log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Where and how to store data.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">storage&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">dbPath&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="nv">home&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">ec2-user&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">fs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">journal&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">enabled&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># how the process runs
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">processManagement&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">fork&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="c"># fork and run in background
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="nv">pidFilePath&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="nv">var&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">run&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">mongodb&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="nv">mongod.pid&lt;/span> &lt;span class="c"># location of pidfile
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># network interfaces
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">net&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">port&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="nv">27017&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">bindIp&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">172.31.26.157&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">127.0.0.1&lt;/span> &lt;span class="c"># Listen to local interface only, comment to listen on all interfaces.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">sharding&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">clusterRole&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="nv">configsvr&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">replication&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">replSetName&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="nv">config_replica&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‰å€‹åƒæ•¸è¦æ³¨æ„ï¼Œå…¶ä»–éƒ½æ˜¯é è¨­å€¼&lt;/p>
&lt;ol>
&lt;li>shardingï¼š&lt;br>
é—œæ–¼shardingçš„è¨­å®šï¼Œè¨˜å¾—config server éƒ½å¿…é ˆè¨­æˆ&lt;code>clusterRole: configsvr&lt;/code>&lt;/li>
&lt;li>replicationï¼š&lt;br>
æ¯å€‹replica set éƒ½è¦ä¸€çµ„ nameåˆ†è¾¨&lt;/li>
&lt;li>netï¼š&lt;br>
æ³¨æ„ bindIp é™¤äº† 127.0.0.1 å¤–ï¼Œé‚„è¦åŠ ä¸€å€‹å…¶ä»–æ©Ÿå™¨å¯ä»¥æŸ¥æ‰¾çš„ipï¼Œå› ç‚ºreplica set æ©Ÿå™¨é–“å¿…é ˆè¦å¯ä»¥æºé€šï¼Œé€™é‚Šæˆ‘æ˜¯ç”¨å…§éƒ¨IP&lt;br>
å¦å¤– 127.0.0.1ä¹Ÿè¦ä¿ç•™ï¼Œæœ‰äº›æ¬Šé™æ“ä½œå¿…é ˆç”¨ localhost(å¦‚é—œé–‰Server)&lt;/li>
&lt;/ol>
&lt;p>å•Ÿå‹• server æŒ‡ä»¤æ˜¯&lt;/p>
&lt;p>sudo mongod &amp;ndash;config mongo.conf &amp;ndash;fork &amp;ndash;syslog&lt;/p>
&lt;p>åŠ  &lt;code>â€”-fork&lt;/code>æ˜¯ç‚ºäº†è·‘åœ¨èƒŒæ™¯ï¼Œä¸‰å° config server éƒ½ä¸€æ¨£ï¼Œæ¥è‘—é¸ä¸€å°ç•¶ä½œ Primaryï¼Œé€²å…¥å¾Œåš replica set è¨­å®š&lt;/p>
&lt;p>é€™éƒ¨åˆ†å› ç‚ºæˆ‘çœ‹ä¸€é–‹å§‹çš„config ä¸èƒ½å¯«åœ¨ä¸€èµ·ï¼Œå¿…é ˆè¦ &lt;code>mongodå•Ÿå‹•å¾Œå†åŸ·è¡Œ&lt;/code>ï¼Œæˆ‘æ˜¯å¦å¤–å¯«scriptï¼Œæ¥è‘—ç›´æ¥å–‚é€² mongo shell åŸ·è¡Œ&lt;/p>
&lt;p>replica.jsï¼Œ_idå°æ‡‰æ˜¯å‰›æ‰çš„ replicaSetNameï¼Œmemberså°±æ˜¯ä¸‰å° config serverï¼Œæ³¨æ„è¦æ˜¯å¯ä»¥é€£ç·šçš„ ipã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">rs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">initiate&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;config_replica&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">configsvr&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">members&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;172.31.26.157:27017&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;172.31.23.205:27017&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;172.31.16.98:27017&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŒ‡ä»¤æ˜¯&lt;/p>
&lt;p>&lt;code>mongo &amp;lt; replica.js&lt;/code>&lt;/p>
&lt;h4 id="sharding-cluster">Sharding Cluster&lt;/h4>
&lt;p>é€™éƒ¨åˆ†ä¹Ÿå·®ä¸å¤šï¼Œåªå·®åœ¨ mongo.confçš„sharding åƒæ•¸&lt;/p>
&lt;p>sharding:&lt;br>
clusterRole: shardsvr&lt;/p>
&lt;p>å‰©ä¸‹çš„ replica set è¨­å®šéƒ½è·Ÿ config server ä¸€æ¨£&lt;/p>
&lt;h4 id="mongos">Mongos&lt;/h4>
&lt;p>æ¥ä¸‹ä¾†æ˜¯Mongosï¼ŒåŒæ¨£ç”¨mongo.conf å•Ÿå‹• &lt;code>mongos&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// mongos.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">sharding&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">configDB&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">config_replica&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">172.31&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">26.157&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">27017&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">172.31&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">23.205&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">27017&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">172.31&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">16.98&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">27017&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸ·è¡ŒæŒ‡ä»¤&lt;/p>
&lt;blockquote>
&lt;p>sudo mongos &amp;ndash;config mongos.conf &amp;ndash;fork &amp;ndash;syslog&lt;/p>
&lt;/blockquote>
&lt;p>æ¥è‘—å°±æ˜¯è¨­å®š shardingï¼Œé€™é‚Šä¸€æ¨£å¯«å€‹ js script&lt;/p>
&lt;p>sh.addShard( &amp;ldquo;&lt;replSetName>/&lt;ip1>,&lt;ip2>,&lt;ip3>&amp;rdquo;)&lt;br>
&amp;hellip;. æœ‰å¹¾å€‹åŠ å¹¾å€‹&lt;/p>
&lt;p>é€™æ¨£å°±å®Œæˆäº†&lt;/p>
&lt;p>æ¥è‘—å¯ä»¥ç™»å…¥ mongo shell æª¢æŸ¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">sh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>å½±ç‰‡å»ºè­°å°‡ mongos èˆ‡ APP Server æ”¾åœ¨ä¸€èµ·&lt;/p>
&lt;/blockquote>
&lt;h3 id="è¨­å®š-sharding">è¨­å®š Sharding&lt;/h3>
&lt;p>æ¶è¨­å¥½äº†ä¹‹å¾Œï¼Œæ¥è‘—å°±æ˜¯è¦è¨­å®š sharding æ©Ÿåˆ¶ï¼Œç›®å‰å¯ä»¥é‡å°æŸå€‹DBçš„æŸå€‹Collection çš„ Key åš hash shard / range shardï¼Œ&lt;br>
range shard æ˜¯ç•¶ key åœ¨æŸå€‹ç¯„åœå…§å°±å¾€å“ªé‚Šå¡ï¼›&lt;br>
hash shard å‰‡æ˜¯æœƒæŠŠ key åš hash æ¯”è¼ƒå®¹æ˜“åˆ†æ•£ã€‚&lt;/p>
&lt;p>// ä»¥ä¸‹æŒ‡ä»¤åœ¨ mongo shell&lt;br>
// é¦–å…ˆå•Ÿå‹•sharding&lt;br>
sh.enableSharding(&amp;quot;&lt;database>&amp;quot;)&lt;/p>
&lt;p>// é‡å°æŸå€‹ collection è¨­å®š&lt;br>
sh.shardCollection(&amp;quot;&lt;database>.&lt;collection>&amp;quot;, { &lt;key> : &lt;direction>})&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// example
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">sh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">shardCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test.test2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;hashed&amp;#34;&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">sh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">shardCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test.test&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¿…é ˆæ³¨æ„åˆ°å¦‚æœåœ¨sharding å‰collectionè£¡é¢å°±æœ‰å€¼ï¼Œè¦å…ˆå»ºç«‹ index æ‰å¯ä»¥è¨­å®š shardã€‚&lt;/p>
&lt;p>æŸ¥çœ‹ç‹€æ…‹å¯ä»¥ç”¨ &lt;code>sh.status()&lt;/code>&lt;/p>
&lt;h4 id="æ³¨æ„äº‹é …">æ³¨æ„äº‹é …&lt;/h4>
&lt;p>æœ‰è »å¤šå°ç´°ç¯€èˆ‡é™åˆ¶è¦æ³¨æ„&lt;/p>
&lt;h4 id="chunk-size">Chunk Sizeï¼š&lt;/h4>
&lt;p>Chunk æ˜¯åˆ†ç‰‡å„²å­˜çš„ä¸€å€‹å–®ä½ï¼Œæ¯ç•¶æœ‰å¯«å…¥ç´€éŒ„æ™‚æœƒå¡åˆ°Chunkä¸­ï¼Œå¦‚æœè¶…éChunk Size ï¼ŒBalancer å¹³è¡¡å™¨å°±æœƒæŠŠChunk æ‹†æˆå…©åŠåˆ†æ•£åˆ°ä¸åŒçš„Shardå»&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœ Chunk size å¤ªå°æœƒé€ æˆéåº¦é »ç¹çš„æ‹†åˆ†èˆ‡æ¬é·ï¼Œå°è‡´æ€§èƒ½ä½è½ï¼›&lt;br>
å¦‚æœChunk size éå¤§å‰‡æœƒé€ æˆè³‡æ–™åˆ†æ•£ä¸å‡å‹»&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// in Mongos server -&amp;gt; mongo shell
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">use&lt;/span> &lt;span class="nx">config&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">settings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">save&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">_id&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="s2">&amp;#34;chunksize&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">sizeInMB&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>ç‰¹åˆ¥æ³¨æ„ï¼ŒMongoDBåˆå§‹åŒ–çš„ chunk size ç‚º 1ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„å¯«å…¥ä¸€é–‹å§‹éƒ½æœƒå¾€ä¸€å€‹ chunk å¡ï¼Œå°è‡´å¾ŒçºŒçš„å†å¹³è¡¡å¾ˆæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥å»ºè­°è¦èª¿æ•´ numInitialChunks æˆ–æ˜¯è‡ªè¡Œåˆå§‹åŒ– chunk sizeã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;a class="link" href="https://docs.mongodb.com/manual/reference/method/sh.shardCollection/" target="_blank" rel="noopener"
>https://docs.mongodb.com/manual/reference/method/sh.shardCollection/&lt;/a>&lt;br>
&lt;a class="link" href="https://docs.mongodb.com/manual/tutorial/create-chunks-in-sharded-cluster/" target="_blank" rel="noopener"
>https://docs.mongodb.com/manual/tutorial/create-chunks-in-sharded-cluster/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h4 id="sharding-key">sharding key:&lt;/h4>
&lt;p>å·²çŸ¥ chunk è¶…ésize æœƒç”± Balancer è² è²¬å¹³è¡¡ï¼Œå¦‚æœå¯ä»¥åœ¨ä¸€é–‹å§‹é¸å¥½ä¸€é»çš„ sharding key å°±èƒ½é¿å…å¤ªå¤šæ¬¡çš„æ‹†åˆ†èˆ‡å¹³è¡¡ï¼Œè®“è³‡æ–™å‡å‹»çš„æ•£ä½ˆã€‚&lt;/p>
&lt;p>é¸æ“‡ range shardï¼Œè¦&lt;code>é¿å…é¸æ“‡æœƒéå¢çš„Keyï¼Œä¾‹å¦‚é è¨­çš„_id&lt;/code> ï¼Œé è¨­_id æ˜¯æœƒéš¨è‘— timestamp è€Œéå¢ï¼Œé€™æœƒå°è‡´æ’å…¥æ–°è³‡æ–™éƒ½åªæœƒæ’åˆ°åŒä¸€å€‹ chunk ä¸­ï¼Œå‹¢å¿…è¦ä¸æ–·çš„æ‹†åˆ†ï¼&lt;/p>
&lt;p>å¦‚æœè¦ç”¨ _idï¼Œå°±å¾ˆé©åˆç”¨ hash shardï¼Œå› ç‚ºé€é hash function éå¢çš„keyä¹Ÿæ¯”è¼ƒæœƒè¢«å‡å‹»åˆ†æ•£ï¼›&lt;br>
åœ¨é…ç½® hash shardä¸Šï¼Œå¦‚æœä¸€é–‹å§‹ collection æ˜¯ç©ºçš„ï¼ŒMongoDBå¯ä»¥è¨­å®š &lt;code>numInitialChunks&lt;/code>è¦åˆå§‹åŒ–å¤šå°‘å€‹ chunkï¼›&lt;br>
ä½†è¦è¨˜å¾— &lt;code>key ä¸èƒ½æ˜¯ float&lt;/code> ï¼Œå› ç‚º hash function æœƒæŠŠ key å…ˆè½‰ä¹˜ 64 bit intï¼Œæ‰€ä»¥ 2.1 / 2.2 / 2.9 éƒ½æœƒè¢«åˆ†æ•£åˆ°åŒä¸€å€‹ chunk ä¸Šã€‚&lt;/p>
&lt;p>åƒè€ƒå½±ç‰‡çš„æ­¥é©Ÿï¼Œ&lt;/p>
&lt;ol>
&lt;li>å¦‚æœé¸å‰‡ data center id ä¸æ˜¯å¥½çš„idï¼Œå› ç‚ºå¯èƒ½é€ æˆè³‡æ–™ä¸å¹³å‡&lt;/li>
&lt;li>å¦‚æœé¸æ“‡ timestamp ä¸æ˜¯å¥½ id ï¼Œå› ç‚ºæ˜¯éå¢ï¼Œæ‰€ä»¥æ–°å¢æœƒæ’åˆ°åŒä¸€å€‹ chunk&lt;/li>
&lt;li>å¦‚æœé¸æ“‡ hash(timestamp) ä¸æ˜¯å¥½ idï¼Œå› ç‚ºè®€å–æ™‚æœƒéœ€è¦åˆ°å¤šå€‹ shard&lt;/li>
&lt;li>é¸æ“‡ device_id é…åˆ hash shard æ˜¯å€‹ä¸éŒ¯é¸æ“‡(å‡è¨­ device_id æ˜¯å›ºå®šçš„ä¸”æ¯å€‹ device ç”Ÿæˆå·®ä¸å¤šçš„è³‡æ–™)&lt;/li>
&lt;li>ä½†å¦‚æœè®€å–å¤§å¤šæ˜¯è¦è®€æŸå€‹è£ç½®è¿‘æœŸæŸå€‹æ™‚é–“çš„è³‡æ–™ï¼Œé‚£æ”¹ç”¨ (device_id, timestamp) çš„çµ„åˆ key æœ€ç†æƒ³ã€‚&lt;/li>
&lt;/ol>
&lt;p>1. Cardinality é«˜åº¦ç•°è³ªæ€§&lt;br>
2. Write distributed å¯«å…¥åˆ†å¸ƒå‡å‹»&lt;br>
3. Query isolation è®€å–å¯ä»¥é›†ä¸­æ–¼åŒä¸€å€‹ shard&lt;br>
4. reliability å¦‚æœæŸå€‹shardæ›äº†ï¼Œç›¡é‡ä¸è¦å½±éŸ¿åˆ°æ‰€æœ‰çš„æœå°‹&lt;br>
5. Index locality ç›¡é‡è®“è®€å–å¯ä»¥å¥—ç”¨æœ€å¤šçš„ç´¢å¼•&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼šshard key è¨­å®šäº†å°±ä¸èƒ½æ”¹è®Šï¼Œå¦‚æœè¦æ”¹å°±å¿…é ˆé‡æ–° shardingï¼Œå‹™å¿…è¬¹æ…ã€‚&lt;/p>
&lt;/blockquote>
&lt;h4 id="æŒ‡ä»¤é™åˆ¶">æŒ‡ä»¤é™åˆ¶&lt;/h4>
&lt;p>æ ¹æ“šæ–‡ä»¶ ï¼Œé‡å°å–®ä¸€æ–‡æª”æ“ä½œå¦‚ updateOne / deleteOneå¿…é ˆé™„å¸¶ shard keyï¼›&lt;/p>
&lt;p>$group ä¸èƒ½ä½¿ç”¨ï¼Œå¿…é ˆæ”¹ç”¨ mapReduce / aggregate æ–¹æ³•ã€‚&lt;/p>
&lt;p>æ¯å€‹ shard key éƒ½å¿…é ˆæ˜¯ indexæˆ–æ˜¯ compound indexçš„prefixï¼ŒåŒæ™‚å¯ä»¥è¨­å®šç‚º uniqueï¼Œä½†å¿…é ˆéµå®ˆ&lt;br>
1. å¦‚æœè©²æ–‡æª”å·²ç¶“ shardedï¼Œä¸èƒ½æŠŠå…¶ä»–æ¬„ä½è¨­ç‚º unique&lt;br>
2. å¦‚æœå…¶ä»–æ¬„ä½æ˜¯ uniqueï¼Œå‰‡ç„¡æ³•å°æ­¤æ–‡æª” shard&lt;br>
ç¸½ä¹‹ï¼Œè¦unique åªèƒ½æ˜¯ shard keyæ¬„ä½ã€‚&lt;/p>
&lt;h3 id="tag-aware-shard">Tag-Aware Shard&lt;/h3>
&lt;p>é™¤äº†range shard / hash shardä¹‹å¤–ï¼Œé‚„å¯ä»¥é‡å°å€‹åˆ¥ shard åšæ¨™è¨˜ï¼Œæ¥è‘—å°±å¯ä»¥é€éæ¢ä»¶è¨­å®šè®“æŸäº›è³‡æ–™å›ºå®šå„²å­˜åœ¨è©²shardä¸Šï¼Œé€™æ¨£æœ€å¤§çš„å¥½è™•æ˜¯å¯ä»¥åš&lt;code>åœ°ç†ä½ç½®å„ªåŒ–&lt;/code> ï¼Œä¾‹å¦‚ç¾åœ‹ç”¨æˆ¶å°±å¯ä»¥è®€å¯«åœ¨ç¾åœ‹å€çš„ shardä¸Šã€‚&lt;/p>
&lt;p>1. å…ˆå¢åŠ Tag&lt;br>
sh.addShardTag(&lt;shard name>, &amp;ldquo;EU&amp;rdquo;)&lt;/p>
&lt;p>2. æŒ‡å®š tag shard çš„æ¢ä»¶ï¼Œå¯ä»¥è¨­ç½®å¤šå€‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">sh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addTagRange&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;chat.messages&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;country&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;US&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;userid&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">MinKey&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;country&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;US&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;userid&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">MaxKey&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;NA&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">sh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addTagRange&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;chat.messages&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;country&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;DE&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;userid&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">MinKey&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;country&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;DE&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;userid&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">MaxKey&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;EU&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘— mongodb å°±æœƒè‡ªå‹•å¹³è¡¡&lt;/p>
&lt;h3 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™&lt;/h3>
&lt;p>éå¸¸è©³ç´°çš„ç°¡ä¸­æ–‡ç« ï¼š&lt;a class="link" href="http://www.cnblogs.com/zhoujinyi/p/4635444.html" target="_blank" rel="noopener"
>http://www.cnblogs.com/zhoujinyi/p/4635444.html&lt;/a>&lt;/p>
&lt;h3 id="å‚™è¨»">å‚™è¨»&lt;/h3>
&lt;p>æ ¹æ“šå®˜ç¶²ï¼Œæœ€å¥½è¦æœ‰å®‰å…¨è¨­å®šèˆ‡è§’è‰²é…ç½®ï¼Œå¯¦ä½œä¸Šå¿…é ˆè¦ç‰¹åˆ¥ç•™æ„ã€‚&lt;/p></description></item><item><title>Express èˆ‡ Koa å¦‚ä½•è™•ç†éŒ¯èª¤</title><link>https://yuanchieh.page/posts/2018/2018-08-27-express-%E8%88%87-koa-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E9%8C%AF%E8%AA%A4/</link><pubDate>Mon, 27 Aug 2018 07:20:36 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-08-27-express-%E8%88%87-koa-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E9%8C%AF%E8%AA%A4/</guid><description>&lt;p>ä»¥å‰åªæ³¨é‡æŠŠåŠŸèƒ½å¯«å‡ºä¾†è€Œå·²ï¼Œæ…¢æ…¢åœ°é–‹å§‹ç¶­è­·å¾Œç™¼ç¾ä¸€é–‹å§‹çš„ç³»çµ±è¦åŠƒå¾ˆé‡è¦ï¼ŒåŒ…å«åŸºæœ¬çš„ Loggin / Debugging / Error Handlingï¼Œä»¥åŠæ˜¯å¦èƒ½å°‡æ¯å€‹ç‰©ä»¶å‡½å¼ä¹¾æ·¨æ‹†åˆ†[é¿å…éå¤šå‰¯ä½œç”¨ç„¡æ³•ç·¨å¯«æ¸¬è©¦](&lt;a class="link" href="https://medium.com" target="_blank" rel="noopener"
>https://medium.com&lt;/a>&lt;/p>
&lt;p>æ­¤æ¬¡ä¸»è¦ç ”ç©¶ Express èˆ‡ Koa æ¡†æ¶ä¸‹ç·¨å¯«å¦‚ä½•åšéŒ¯èª¤è™•ç†ã€‚&lt;/p>
&lt;h3 id="åŸæœ¬çš„å¯«æ³•">åŸæœ¬çš„å¯«æ³•&lt;/h3>
&lt;p>åœ¨æœ€ä¸€é–‹å§‹ä½¿ç”¨Promiseæ™‚ï¼Œéƒ½ç¿’æ…£å€‹åˆ¥Promise.catch è™•ç†éŒ¯èª¤ï¼›&lt;br>
ä¹‹å¾Œç”¨ä¸Šäº† async / await ï¼Œä¹Ÿéƒ½ç¿’æ…£ç”¨ try{}catch(){} å€‹åˆ¥è™•ç†ï¼›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Promise1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">....).&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">handleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">Promise1&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hanleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£çš„å¯«æ³•ç¼ºé»åœ¨æ–¼æ¯å€‹å‡½å¼éƒ½å¿…é ˆé‡è¤‡ä¸€æ¨£çš„äº‹æƒ…(ä¸æ–· try catch)ï¼Œæ­¤å¤–å›å‚³ http status code / error message å¾ˆå¤šéƒ½æœƒé‡è¤‡ï¼Œä¹Ÿæ˜¯æ­¤æ¬¡æƒ³è¦æ”¹è®Šçš„å•é¡Œï¼Œå¸Œæœ›æ”¹ä»¥&lt;code>çµ±ä¸€æ‹‹å‡ºéŒ¯èª¤ä¸¦è¨»å†Šä¸€å€‹Middlewareå°ˆé–€è™•ç†éŒ¯èª¤&lt;/code>ã€‚&lt;/p>
&lt;h3 id="æ”¹å–„å¯«æ³•">æ”¹å–„å¯«æ³•&lt;/h3>
&lt;h4 id="koa">Koa&lt;/h4>
&lt;p>å…ˆä¾†çœ‹Koaå¦‚ä½•å¯¦ä½œï¼Œä»¥ä¸‹æ˜¯ä¸€èˆ¬ä½¿ç”¨æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">Koa&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;koa&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Koa&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">){...});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3000&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶æˆ‘å€‘å‰µå»ºä¸€å€‹ Koa çš„ instance appå¾Œï¼Œæ¥è‘—å°±æœƒç”¨ &lt;code>app.use&lt;/code> è¨»å†Šæ‰€æœ‰çš„ Middlewareï¼Œæœ€å¾Œå°±æ˜¯ &lt;code>app.listen&lt;/code> å•Ÿå‹•&lt;/p>
&lt;p>åœ¨ Koa åŸå§‹ç¢¼ç•¶ä¸­ï¼Œ new Koa()ä¸­é‡è¦çš„ä¸€æ®µåŸå§‹ç¢¼æ˜¯&lt;/p>
&lt;p>&lt;code>return fnMiddleware(ctx).then(handleResponse).catch(onerror);&lt;/code>&lt;/p>
&lt;p>Koa è™•ç†çš„é †åºæ˜¯ &lt;code>fnMiddlewareå°‡ app.use()è¨»å†Šçš„å…¨éƒ¨Middlewareè½‰æˆ Promise chain&lt;/code> -&amp;gt; &lt;code>hanldeResponse(å‘¼å« res.endé€å‡º http respond)&lt;/code> / &lt;code>onerror (è™•ç†éŒ¯èª¤)&lt;/code>&lt;/p>
&lt;p>Promise chain(è‡ªå®šç¾©çš„) æ˜¯æŒ‡ç•¶ Koa Middleware å‘¼å« next() æœƒéè¿´å‘¼å«ä¸‹ä¸€å€‹ Middlewareï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡æ–‡ç«  &lt;a class="link" href="http://sj82516-blog.logdown.com/post/4720279" target="_blank" rel="noopener"
>Koa2 æºç¢¼è§£æâ€Šâ€”â€Šç°¡æ½”ç¾éº—çš„æ¡†æ¶&lt;/a>&lt;/p>
&lt;p>é€™éƒ¨åˆ†çš„éŒ¯èª¤è™•ç†åˆå¯æ‹†æˆå…©å¡Šï¼Œä¸€å€‹æ˜¯ appå±¤ç´š ä¸€å€‹æ˜¯ ctx å±¤ç´šï¼›&lt;br>
åœ¨åŸå§‹ç¢¼ä¸­ /koa/application.jsï¼Œæœ‰é è¨­åŸºæœ¬çš„ onerrorçš„éŒ¯èª¤è™•ç†ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ‰“å°å‡ºä¾†ï¼Œé€™éƒ¨åˆ†æ˜¯é€é &lt;code>appæœ¬èº«ç¹¼æ‰¿ Event Emitterå±¬æ€§ä¸¦è¨»å†Š app.on(â€œerrorâ€) äº‹ä»¶å¾Œè™•ç†&lt;/code>&lt;/p>
&lt;p>å¦ä¸€æ–¹é¢ç•¶ Server ç™¼ç”ŸéŒ¯èª¤ Client éƒ½æœƒæ”¶åˆ° &lt;code>Internal Server Error&lt;/code> å›æ‡‰ï¼Œæ˜¯åœ¨ &lt;code>ctx.onerror è™•ç†&lt;/code>ï¼Œä¸¦ &lt;code>app.emit(â€œerrorâ€)&lt;/code>ï¼Œå®šç¾©æ–¼ /koa/context.js ä¸­ï¼›&lt;br>
å°æ‡‰ä¸åŒçš„Http Status Code æœ‰ä¸åŒçš„å›æ‡‰ï¼Œé€™æ˜¯åŸºæ–¼&lt;code>statuses&lt;/code> æ¨¡çµ„å®šç¾©çš„ã€‚&lt;/p>
&lt;p>é€™è£¡æ¯”è¼ƒæ··äº‚çš„æ˜¯ app.onerror èˆ‡ ctx.onerror å‘¼å«æ™‚é–“æ˜¯äº¤éŒ¯çš„&lt;/p>
&lt;ol>
&lt;li>&lt;code>fnMiddleware(ctx).then(handleResponse).catch(onerror);&lt;/code> çš„ onerror æ˜¯ &lt;code>(error) =&amp;gt; ctx.onerror(error)&lt;/code>&lt;/li>
&lt;li>&lt;code>ctx.onerror&lt;/code> æœƒ respond é è¨­çš„éŒ¯èª¤è™•ç†èˆ‡ &lt;code>app.emit(â€œerrorâ€)&lt;/code>&lt;/li>
&lt;li>&lt;code>app.emit(â€œerrorâ€)&lt;/code> æ˜¯ç”± &lt;code>app.onerror&lt;/code> å»æ¥æ”¶ï¼Œé€™éƒ¨åˆ†å¯ä»¥è‡ªè¨‚ &lt;code>app.on(â€œerrorâ€, ()=&amp;gt;{è‡ªè¡Œè™•ç†})&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__9GhLVsWnNyqmW__0yDv6wPg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å®˜æ–¹æ–‡ä»¶æœ‰å¯«åˆ°éŒ¯èª¤è™•ç†ï¼Œç”¨æˆ¶å¯è¨»å†Š error äº‹ä»¶å°±æœƒæ”¹ç”±ç”¨æˆ¶è‡ªå·±è™•ç†&lt;/p>
&lt;p>app.on(&amp;ldquo;error&amp;rdquo;, (err, ctx) =&amp;gt; {&amp;hellip;.})&lt;/p>
&lt;p>BUT!! é€™é‚Šçš„ ctx æ˜¯æ‹¿ä¾†çœ‹ context è³‡è¨Šï¼Œå¦‚æœæ˜¯å¸Œæœ›å®¢è£½åŒ–å›å‚³çš„éŒ¯èª¤æ˜¯æ²’è¾¦æ³•çš„å–”ï¼&lt;br>
å› ç‚ºéŒ¯èª¤çš„ç‹€æ…‹ç¢¼èˆ‡å…§æ–‡ Reponse æ˜¯åœ¨ ctx.onerror å°±è™•ç†æ‰ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœè¦è‡ªå·±è™•ç†æ•´å€‹éŒ¯èª¤ï¼Œå¿…é ˆæ”¹ç”¨ Middleware ï¼Œè¨˜å¾—&lt;code>ç¬¬ä¸€å€‹&lt;/code>å°±è¨»å†ŠéŒ¯èª¤è™•ç†æ‰å¯ä»¥æ•ç²æ‰€æœ‰çš„éŒ¯èª¤ï¼Œå¦‚ä»¥ä¸‹&lt;/p>
&lt;h4 id="express">Express&lt;/h4>
&lt;p>Express å°æ¯” Koa æ˜¯å€‹æ¯”è¼ƒå…¨é¢çš„æ¡†æ¶ï¼Œå…§å«äº†åŸºæœ¬çš„ Middleware / Routerï¼Œç™¼é€Response æ–¹å¼ä¹Ÿä¸åƒ Koa æ˜¯æœ€å¾Œæ¡†æ¶å¹«ä½ ç™¼é€ï¼›&lt;br>
è€Œæ˜¯å¿…é ˆè‡ªå·±ç”¨ &lt;code>res.send()&lt;/code> ä¹‹é¡çš„èªæ³•è‡ªè¡Œç™¼é€ã€‚&lt;/p>
&lt;h4 id="routing-æ©Ÿåˆ¶">Routing æ©Ÿåˆ¶&lt;/h4>
&lt;p>è©³è«‹è«‹åƒè€ƒ &lt;a class="link" href="https://cnodejs.org/topic/5746cdcf991011691ef17b88" target="_blank" rel="noopener"
>&lt;strong>expressæºç åˆ†æä¹‹Router&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åœ¨Express å¯¦ä¾‹åŒ–ä¹‹å¾Œæœ‰ä¸€å€‹ Router Instanceï¼Œæ¥è‘—æ¯å€‹è·¯ç”±æœƒå°æ˜ ä¸€å€‹ Routeï¼Œä¸€å€‹è·¯ç”±ä¸­å¯èƒ½æœ‰å¤šå€‹Middleware ç¨±ç‚º Layerï¼Œè³‡æ–™çµæ§‹å°±æ˜¯é™£åˆ—å„²å­˜ã€‚&lt;/p>
&lt;p>ç•¶ä¸€å€‹ Request è¿‘ä¾†æœƒæµéä¾ç…§ Route ä¸­çš„è¨»å†Šé †åºæµé Layer ï¼Œæ¯å€‹Layer åˆ¤æ–·æ˜¯å¦ Match URLï¼Œå¦‚æœ Match å‰‡è™•ç†ï¼Œç™¼ç”ŸéŒ¯èª¤å‰‡èµ°éŒ¯èª¤è™•ç†&lt;/p>
&lt;p>ç‰¹åˆ¥æ³¨æ„ æ­£å¸¸è™•ç†èˆ‡éŒ¯èª¤è™•ç†è·¯å¾‘æ˜¯åˆ†é–‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)=&amp;gt;{})&lt;/span> &lt;span class="nx">å°æ‡‰æ˜¯&lt;/span> &lt;span class="nx">Layer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">handle_error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)=&amp;gt;{})&lt;/span> &lt;span class="nx">å°æ‡‰æ˜¯&lt;/span> &lt;span class="nx">Layer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">handle_request&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶ç™¼ç¾æœ‰ Middleware å‘¼å«äº† next(err)å¾Œï¼Œå°±é–‹å§‹èµ°éŒ¯èª¤è™•ç†ï¼Œä¹Ÿå°±æ˜¯å¾Œé¢çš„ Layer éƒ½æ˜¯å‘¼å« Layer.handle_error !&lt;/p>
&lt;p>åœ¨éŒ¯èª¤è™•ç†Express æ¡ç”¨ &lt;code>next(err)&lt;/code> åœ¨Middleware é–“å‚³ééŒ¯èª¤ï¼Œæ‰€ä»¥ç•¶ Middleware æˆ–æ˜¯ Routing ä¸­æœ‰éŒ¯èª¤ä¸èƒ½ç›´æ¥æ‹‹å‡ºæˆ–ä¸è™•ç†ï¼Œå¿…é ˆè¦ç”¨ &lt;code>try{..}catch(error){next(error)}&lt;/code> è™•ç†ï¼›&lt;br>
ä½†é€™æ¨£å°±æœƒå¾ˆéº»ç…©ï¼Œå› ç‚ºéƒ½å¿…é ˆç”¨ try catch åŒ…èµ·ä¾†ï¼ŒåŒç†åƒæ˜¯åŸç”Ÿçš„ Nodejs module å¦‚ fs éƒ½æ²’æœ‰ Promiseç‰ˆï¼Œæ‰€ä»¥éƒ½è¦è‡ªå·±å† Promisify å¾Œå‘¼å«ä¸€æ¨£çš„é“ç†(éº»ç…©)ã€‚&lt;br>
(&lt;a class="link" href="https://medium.com/@Abazhenov/using-async-await-in-express-with-node-8-b8af872c0016" target="_blank" rel="noopener"
>Using Async Await in Express with Node 9&lt;/a> æœ‰æåŠ)&lt;/p>
&lt;p>å¾Œä¾†çœ‹åˆ°ä¸€å€‹è » Hacking çš„æ–¹å¼ï¼Œ&lt;a class="link" href="https://github.com/davidbanham/express-async-errors" target="_blank" rel="noopener"
>express-async-errors&lt;/a>ï¼Œä»–æœƒè¤‡å¯«Express/Layer.handle æ–¹æ³•ï¼ŒæŠŠæ¯å€‹ Routing Function çš„éŒ¯èª¤çµ±ä¸€ç”¨ &lt;code>next(error)&lt;/code> å‚³é&lt;/p>
&lt;p>ä»–è™•ç†çš„æ–¹å¼ä¹Ÿæ˜¯å¾ˆå¦™ï¼Œç°¡åŒ–å¾Œå¯ä»¥é€™æ¨£ç¤ºæ„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">pE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">pE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯å¦‚æœç™¼ç¾è¨»å†Šåœ¨Layerä¸­çš„Function æ˜¯ Async Functionï¼ŒAsync Function åŸ·è¡Œå¾Œæœƒå›å‚³ Promiseï¼Œæ¥è‘—å°±æ˜¯ç”¨ &lt;code>fn &amp;amp;&amp;amp; fn.catch&lt;/code> åˆ¤æ–·æ˜¯å¦ç‚º Promiseï¼Œå¦‚æœæ˜¯å‰‡å¹«å¿™è£œä¸ŠÂ &lt;code>.catch((err) =&amp;gt; next(err))&lt;/code> ï¼Œè »è°æ˜çš„ä½œæ³•ã€‚&lt;/p>
&lt;p>æ ¹æ“š Express Routing æ©Ÿåˆ¶ï¼ŒErrorHandling åœ¨ Express å¿…é ˆå®£å‘Šåœ¨æœ€å¾Œé¢&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>å°±å€‹äººè§€é»ï¼ŒKoa ç›¸æ¯” Express ç¢ºå¯¦æ˜¯å€‹æ›´é€²æ­¥çš„æ¡†æ¶ï¼Œæœ€ä¸»è¦æ˜¯åœ¨ Middleware æ§‹å»ºèˆ‡åŸ·è¡Œä¸Šï¼ŒKoa æ˜¯å…ˆè½‰æˆé¡ä¼¼ Promise Chainï¼Œä¸¦é è¨­æœ‰åš Error Handlingï¼›&lt;br>
é€™æ¯”è¼ƒç¬¦åˆç¾åœ¨ä»¥ Promise ç‚ºåŸºç¤æ§‹å»ºçš„æ‡‰ç”¨ç¨‹å¼ï¼Œä¹Ÿä½¿å¾— Middleware è¨­è¨ˆèˆ‡éŒ¯èª¤è™•ç†ç›´è§€å¾ˆå¤šã€‚&lt;/p>
&lt;p>è€ŒExpress å¿…é ˆå¾ˆå½†æ‰­çš„ä½¿ç”¨ next(err)å‚³éï¼Œå°æ¯”å°±æœ‰é»åƒ callback hell çš„ error æ”¾åœ¨ function ç¬¬ä¸€ä½çš„å‚³çµ±å¯«æ³•ï¼›&lt;br>
å¦å¤–æˆ‘ä¹Ÿæ˜¯ç¾åœ¨æ‰çŸ¥é“ &lt;code>app.use((err,req,res,next)=&amp;gt;{â€¦})&lt;/code> /&lt;code>app.use((req,res,next)=&amp;gt;{â€¦})&lt;/code> å·®ä¸€å€‹åƒæ•¸åœ¨ Express ä¸­å‘¼å«æ™‚æ©Ÿå®Œå…¨ä¸åŒï¼Œæ•´å€‹éŒ¯èª¤è™•ç†å¼„çš„æœ‰é»ä¸å¤ªç›´è§€ã€‚&lt;br>
çœ‹åˆ°Github Issue è¨è«–æœ‰æåˆ° Express@5 æœƒåŠ å…¥æ›´å¥½çš„ async /await æ”¯æ´ï¼Œåˆ°æ™‚å†ä¾†çœ‹çœ‹åŸå§‹ç¢¼çš„æ›´å‹•ã€‚&lt;/p></description></item><item><title>PostgreSQL json æ“ä½œ</title><link>https://yuanchieh.page/posts/2018/2018-08-23-postgresql-json-%E6%93%8D%E4%BD%9C/</link><pubDate>Thu, 23 Aug 2018 08:36:20 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-08-23-postgresql-json-%E6%93%8D%E4%BD%9C/</guid><description>&lt;p>Postgresql å¯ä»¥ç”¨æ¬„ä½ jsonb å‹åˆ¥å„²å­˜ json æ ¼å¼çš„è³‡æ–™ï¼Œä¸¦æä¾›ä¸å°‘å…§å»ºçš„å‡½å¼å¯ä»¥å”åŠ©æŸ¥è©¢ï¼Œä»¥ä¸‹ç¨å¾®æ•´ç†ä¸€äº›å¸¸ç”¨çš„æƒ…æ™¯ã€‚&lt;/p>
&lt;h3 id="ç¤ºç¯„è³‡æ–™åº«">ç¤ºç¯„è³‡æ–™åº«&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/vk8sCioCh1RstjSWXsZnWr/4" target="_blank" rel="noopener"
>&lt;strong>DB Fiddle - SQL Database Playground&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åŸºæœ¬å°±æ˜¯æ˜¯ Orders / Products å…©å¼µè¡¨ï¼ŒOrders ä¸­è³‡æ–™ç”¨ data jsonb æ ¼å¼å­˜å„²ï¼ŒProducts å‰‡æ˜¯å¸¸è¦çš„æ¬„ä½å®šç¾©ã€‚&lt;/p>
&lt;p>Orders è³‡æ–™å¤§ç´„é•·é€™æ¨£&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;cost&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;products&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>&lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;nums&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;nums&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">}],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;details&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;memo&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="æ“ä½œ-json">æ“ä½œ JSON&lt;/h4>
&lt;p>å¦‚æœæ˜¯è¦åš json çš„æ¬„ä½ç´¢å–ï¼Œå¯ä»¥ç”¨ &lt;code>-&amp;gt;&lt;/code> ï¼Œå¦‚æœè¦å›å‚³å­—ä¸²çµæœç”¨ &lt;code>-&amp;gt;&amp;gt;&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚èªª &lt;code>data-&amp;gt;â€™detailsâ€™-&amp;gt;&amp;gt;â€™titleâ€™&lt;/code> å°±æœƒå›å‚³ &lt;code>â€œmemoâ€&lt;/code>&lt;/p>
&lt;p>é™£åˆ—ä¹Ÿå¯ä»¥æŒ‡å®šå“ªå€‹ä½ç½®ï¼Œä¾‹å¦‚ &lt;code>data-&amp;gt;â€™productâ€™-&amp;gt;0-&amp;gt;â€™idâ€™&lt;/code>&lt;/p>
&lt;p>ä½¿ç”¨ä¸Šå¦‚æœæ˜¯ key ç”¨ &lt;code>`&lt;/code> å–®å¼•è™Ÿæ‹¬è‘—ï¼Œå¦‚æœæ˜¯é™£åˆ—ä½ç½®æ‰ä¸éœ€è¦ï¼Œä¸ç„¶æœƒä¸€ç›´å›å‚³ null&lt;/p>
&lt;p>å¦å¤–è¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯&lt;code>-&amp;gt;&amp;gt;&lt;/code> éƒ½æ˜¯å›å‚³å­—ä¸²ï¼Œæ‰€ä»¥å¦‚æœè¦è·Ÿå…¶ä»–é¡å‹åšæ¯”å°ï¼Œéœ€è¦è‡ªå·±åšæ ¼å¼è½‰æ›ï¼Œä¾‹å¦‚ &lt;code>Cast( data-&amp;gt;&amp;gt;â€idâ€ as int ) = id&lt;/code> æ‹¿ data.id è·Ÿ int å‹åˆ¥çš„è‡ªå¢ä¸»éµåšæ¯”å°&lt;/p>
&lt;h4 id="é™£åˆ—é•·åº¦">é™£åˆ—é•·åº¦&lt;/h4>
&lt;p>å¦‚æœæ˜¯æƒ³è¦çŸ¥é“é™£åˆ—çš„é•·åº¦æ˜¯å¤šå°‘ï¼Œå¯ä»¥ç”¨ jsonb_array_elements&lt;/p>
&lt;p>ä¾‹å¦‚ &lt;code>jsonb_array_length(data-&amp;gt;â€™productsâ€™) &amp;gt; 2&lt;/code> ï¼Œé€™æœƒç›´æ¥å›å‚³ int&lt;/p>
&lt;h4 id="key-æ˜¯å¦å­˜åœ¨">Key æ˜¯å¦å­˜åœ¨&lt;/h4>
&lt;p>æœ‰ä¸‰ç¨®ç”¨æ³•ï¼Œ&lt;code>?â€™æ¯”å°keyâ€™ ?|[â€™æ¯”å°key1â€™, â€™æ¯”å°key2â€™] ?&amp;amp;[â€™æ¯”å°key1â€™, â€™æ¯”å°key2â€™]&lt;/code> ï¼Œçµæœå›å‚³ boolean&lt;/p>
&lt;p>ä¾‹å¦‚æ‰¾å‡º data ä¸­åŒ…å«`detail`æ¬„ä½çš„è³‡æ–™&lt;br>
Â &lt;code>select * from Orders where data?â€™detailâ€™;&lt;/code>&lt;/p>
&lt;p>?| å‰‡æ˜¯å¾Œè€…é™£åˆ—ä¸­åªè¦å‘½ä¸­ä¸€å€‹å°±ç‚º trueï¼Œ?&amp;amp; å‰‡æ˜¯è¦é™£åˆ—ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½å­˜åœ¨æ‰æ˜¯ trueã€‚&lt;/p>
&lt;h4 id="æ”¤å¹³é™£åˆ—">æ”¤å¹³é™£åˆ—&lt;/h4>
&lt;p>ç®—æ˜¯åšç¬¬ä¸€æ­£è¦åŒ–ï¼Œæˆ‘å¸Œæœ›é€é Join Products è¨ˆç®—æ¯ç­†è¨‚å–®çš„ç¸½é¡ï¼Œä½†å› ç‚º Orders ä¸­çš„ data-&amp;gt;product æ˜¯é™£åˆ—ï¼Œæ‰€ä»¥éœ€è¦ &lt;code>jsonb_array_elements&lt;/code> ï¼Œ&lt;code>jsonb_array_elements&lt;/code> æœƒç›´æ¥å›å‚³ set&lt;/p>
&lt;p>&lt;code>select jsonb_array_elements(data-&amp;gt;â€™productsâ€™) as product_item from Orders;&lt;/code> é€™æ¨£å°±å¯ä»¥åšåˆ°ç¬¬ä¸€æ­£è¦åŒ–&lt;/p>
&lt;p>æ¥è‘—è »ç¥å¥‡çš„æ˜¯å¯ä»¥ç›´æ¥å°‡ Order èˆ‡ &lt;code>jsonb_array_elements&lt;/code> åš CROSS JOIN&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Orders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">Sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">Cast&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">product_item&lt;/span>&lt;span class="o">-&amp;gt;&amp;gt;&lt;/span>&lt;span class="s1">&amp;#39;nums&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Products&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Orders&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">jsonb_array_elements&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="s1">&amp;#39;products&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">product_item&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">left&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">join&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Products&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Cast&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">product_item&lt;/span>&lt;span class="o">-&amp;gt;&amp;gt;&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Products&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">group&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Orders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†çµæœç«Ÿç„¶ä¸æ˜¯é æœŸçš„ç¬›å¡çˆ¾ç© N*Mï¼Œè€Œæ˜¯æœƒè‡ªå‹•å¹«ä½ æŠŠå±¬æ–¼è©²è¨‚å–®çš„ product å°æ‡‰å¥½ï¼Œåˆ°ç¾åœ¨é‚„æƒ³ä¸é€æ€éº¼æœƒé€™æ¨£ã€‚&lt;/p>
&lt;h4 id="json-vsjsonb">json vsÂ jsonb&lt;/h4>
&lt;p>Postgresql æ”¯æ´å…©ç¨®åˆæ³• json å¯æ’å…¥çš„æ ¼å¼ &lt;code>json&lt;/code> &lt;code>jsonb&lt;/code> ï¼Œä½†å…©è€…æœ‰äº›å¾®çš„å·®ç•°&lt;/p>
&lt;ol>
&lt;li>json&lt;br>
ä»¥ç´”æ–‡å­—å‹æ…‹æ’å…¥ï¼ŒåŒ…å«ç©ºç™½ã€æ›è¡Œï¼ŒåŒæ™‚ä¿æŒåŸæœ¬çš„éµå€¼é †åº&lt;/li>
&lt;li>jsonb&lt;br>
ä»¥äºŒé€²åˆ¶æ–¹å¼å„²å­˜ï¼ŒæœƒæŠŠé‡è¤‡çš„éµå€¼å»é™¤(å¾Œè€…è¦†è“‹å‰è€…)&lt;/li>
&lt;/ol>
&lt;p>jsonb æ”¯æ´ indexï¼Œåœ¨æ’å…¥æ™‚éœ€è¦è¼ƒé•·çš„æ™‚é–“ï¼Œä½†æ˜¯æŸ¥è©¢é€Ÿåº¦è¼ƒå¿«ï¼Œæ˜¯æ¯”è¼ƒé€šç”¨çš„é¸æ“‡æ ¼å¼ã€‚&lt;/p>
&lt;p>ä½†å¦‚æœæœ‰éœ€è¦ä¿æŒåŸæœ¬éµå€¼é †åºã€æˆ–æ˜¯å–®ç´”æƒ³ä¿ç•™åŸæœ¬çš„ json æ ¼å¼æ‰ä½¿ç”¨ &lt;code>json&lt;/code> æ ¼å¼&lt;/p>
&lt;p>åƒè€ƒè³‡æ–™&lt;br>
&lt;a class="link" href="https://my.oschina.net/swingcoder/blog/489769" target="_blank" rel="noopener"
>https://my.oschina.net/swingcoder/blog/489769&lt;/a>ã€&lt;a class="link" href="https://stackoverflow.com/questions/22654170/explanation-of-jsonb-introduced-by-postgresql" target="_blank" rel="noopener"
>https://stackoverflow.com/questions/22654170/explanation-of-jsonb-introduced-by-postgresql&lt;/a>&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>æœ‰çœ‹åˆ°ä¸€äº›å¯¦é©—æ˜¯æŠŠ Postgresql ç•¶ä½œ NoSQL ä½¿ç”¨ï¼Œä½†å€‹äººè¦ºå¾—é‚„æ˜¯åç©ç¥¨æ€§è³ªï¼Œé—œè¯å¼è³‡æ–™åº«é‚„æ˜¯éµå®ˆæ­£è¦åŒ–è¨­è¨ˆï¼Œåƒ…æŠŠ json ç•¶ä½œé¡å¤–çš„å½ˆæ€§å°±å¥½&lt;/p></description></item><item><title>æ–°åº—åŒå¿ƒæ•‘é›£éšŠ 52æœŸæ•‘ç”Ÿå“¡è¨“ç·´å¿ƒå¾—</title><link>https://yuanchieh.page/posts/2018/2018-08-21-%E6%96%B0%E5%BA%97%E5%90%8C%E5%BF%83%E6%95%91%E9%9B%A3%E9%9A%8A-52%E6%9C%9F%E6%95%91%E7%94%9F%E5%93%A1%E8%A8%93%E7%B7%B4%E5%BF%83%E5%BE%97/</link><pubDate>Tue, 21 Aug 2018 12:28:19 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-08-21-%E6%96%B0%E5%BA%97%E5%90%8C%E5%BF%83%E6%95%91%E9%9B%A3%E9%9A%8A-52%E6%9C%9F%E6%95%91%E7%94%9F%E5%93%A1%E8%A8%93%E7%B7%B4%E5%BF%83%E5%BE%97/</guid><description>&lt;p>å¹³å¸¸å–œæ­¡æ°´ä¸Šæ´»å‹•ï¼Œä½†æ²’ç‰¹åˆ¥å–œæ­¡æ¸¸æ³³ï¼Œæ‰€ä»¥æ³³æŠ€ã€æ°´æ€§éƒ½å¾ˆå·®ï¼Œä¸€é–‹å§‹å…ˆå¾æ·å¼é‡æ–°å­¸èµ·ï¼Œå…©å€‹ç¦®æ‹œåŠ å¼·å¾Œå­¸æœƒæ›æ°£å‹‰å¼·å¯ä»¥éŠå®Œ50å…¬å°ºï¼Œæ¥è‘—å°±ç›´æ¥æŒ‘æˆ°æ•‘ç”Ÿå“¡è¨“ç·´ï¼ŒçœŸçš„æ˜¯ç”Ÿä¸å¦‚æ­»å•ŠXD&lt;/p>
&lt;h3 id="è¨“ç·´èœå–®">è¨“ç·´èœå–®&lt;/h3>
&lt;p>è¨“ç·´å¤§æ¦‚åˆ†æˆè‡ªæ•‘èˆ‡æ•‘äººï¼›&lt;/p>
&lt;h4 id="è‡ªæ•‘">è‡ªæ•‘&lt;/h4>
&lt;p>ä¸€é–‹å§‹æœ€åŸºæœ¬çš„&lt;code>æ¼‚æµ®&lt;/code>ï¼Œåˆå¯åˆ†æˆæ°´æ¯æ¼‚ã€ä¿¯è‡¥æ¼‚ã€ä»°æ¼‚ã€ç›´ç«‹å¼æ¼‚æµ®ï¼›&lt;br>
å…ˆç·´ç¿’å»ºç«‹è‡ªèº«æµ®åŠ›ï¼Œä»¥åŠæ›æ°£ï¼Œåœ¨æ›æ°£éç¨‹ä¸­å‹•ä½œè¦è¼•ï¼Œå·®ä¸å¤šå˜´å·´æµ®å‡ºæ°´é¢å¯ä»¥æ›æ°£å°±å¥½ï¼Œä¸è¦å¤ªç”¨åŠ›æ•´å€‹èƒ¸å£æµ®å‡ºï¼Œé¿å…åä½œç”¨åŠ›éå¤§åè€Œèº«é«”æœƒæ›´æ²‰&lt;/p>
&lt;p>æ¥è‘—æ˜¯&lt;code>è¸©æ°´&lt;/code> ï¼Œä¹Ÿå°±æ˜¯ç«‹æ³³ï¼Œè®“èº«é«”ä¿æŒåœ¨åŸåœ°é ­éœ²å‡ºæ°´é¢ï¼Œæœ‰å‰ªåˆ€å¼è¸©æ°´ã€è›™å¼è¸©æ°´ã€æ”ªè›‹å¼è¸©æ°´ï¼Œé€™æ™‚å€™åŸºæœ¬ä¸Šæ˜¯æ”¾é¬†ä¼‘æ¯çš„æ™‚å€™ï¼Œè€Œä¸”é ­æµ®å‡ºæ°´é¢æ‰å¯ä»¥è½åˆ°æ•™ç·´çš„æŒ‡ä»¤&lt;/p>
&lt;p>å†ä¾†æ˜¯å€Ÿç‰©å»ºç«‹æµ®åŠ›ï¼Œå¦‚æœæ˜¯ç©¿è‘—è¡£æœè½æ°´ï¼Œå¯ä»¥é‹ç”¨è¡£ç‰©åšç·Šæ€¥æ°£å›Šï¼Œå»ºç«‹è‡ªèº«æµ®åŠ›ç­‰å¾…æ•‘æ´&lt;/p>
&lt;h4 id="æ•‘äºº">æ•‘äºº&lt;/h4>
&lt;p>ç•¶æˆ‘å€‘è§€å¯Ÿåˆ°æœ‰æººè€…æ™‚ï¼Œå…ˆå‡è¨­æ²’æœ‰å¤šé¤˜çš„å·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œåªèƒ½ä¾é æˆ‘å€‘è‡ªèº«çš„èƒ½åŠ›å»æ•‘æ´æ™‚ï¼Œæ•´å€‹æƒ…å¢ƒæœƒæ˜¯&lt;/p>
&lt;p>å¾å²¸é‚Šæˆ–æ± é‚Šå…¥æ°´ï¼Œæ¥è‘—æ¸¸æ³³éå»æ¥è¿‘æººè€…ï¼Œè§€å¯Ÿæººè€…ä¸¦æ¥è¿‘ä»–ï¼Œæ¥è‘—æƒ³è¾¦æ³•å°‡ä»–å¸¶å›å²¸ä¸Šï¼Œå¦‚æœé‡åˆ°åæŠ—æˆ–æŠ“æŠ±è¦æƒ³è¾¦æ³•æ™è„«ï¼Œå¸¶ä¸Šå²¸å¾Œè¦åšæ€¥æ•‘ç­‰å¾ŒçºŒè™•ç½®ã€‚&lt;/p>
&lt;p>åŸºæœ¬ä¸Šæ•´å¥—SOPæ˜¯&lt;/p>
&lt;p>å…¥æ°´æ³• -&amp;gt; å¾é è™•æ¥è¿‘æººè€… -&amp;gt; æ¥è¿‘æ³• -&amp;gt; å¸¶äººæ³• -&amp;gt; (å¦‚æœæººè€…æ™æ‰)è§£è„«æ³•ã€é˜²è¡›æ³• -&amp;gt; èµ·å²¸æ³• -&amp;gt; æ•‘æººå…«å¤§æ­¥é©Ÿ -&amp;gt; å¾ŒçºŒæ€¥æ•‘è™•ç†&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯æˆ‘å€‘ä¸»è¦çš„è¨“ç·´èœå–®&lt;/p>
&lt;h4 id="å…¥æ°´æ³•">&lt;code>å…¥æ°´æ³•&lt;/code>&lt;/h4>
&lt;p>åˆåˆ†æˆéœå¼å…¥æ°´ï¼Œé©ç”¨æ–¼æ°´åŸŸä¸ç†Ÿæ‚‰æˆ–æ˜¯å‚·æ‚£æœ‰é ¸æ¤å—å‚·ä¹‹ç–‘æ…®æ™‚æ¡ç”¨ï¼Œå…¥æ°´æ™‚ä¸èƒ½æ¿€èµ·æ°´èŠ±ï¼›&lt;/p>
&lt;p>å¹³è·³å¼å…¥æ°´ï¼Œæœ‰é»åƒç«‹å®šè·³å¹³é£›å‡ºå»ï¼Œé›™æ‰‹äº¤ç–Šå¤§è‡‚è²¼ç·Šè€³æœµå£“é ­ï¼Œå…¥æ°´æ·ºå‡ºæ°´å¿«ï¼Œæœ‰å€‹åˆé€Ÿåº¦å¯ä»¥å¿«é€Ÿæ¥è¿‘æººè€…ï¼›&lt;/p>
&lt;p>è·¨æ­¥å¼å…¥æ°´ï¼Œé©ç”¨æ–¼æ°´æ·±è™•ï¼›æµ·é‚Šæœ‰æµªæ™‚ç”¨è·³èºå¼å…¥æ°´é™ä½æ°´é˜»ï¼›åœ¨æ•‘ç”Ÿè‰‡ä¸Šç”¨èƒŒæ»¾å¼å…¥æ°´ã€‚&lt;/p>
&lt;h4 id="æ¥è¿‘æººè€…">æ¥è¿‘æººè€…&lt;/h4>
&lt;p>ç•¶å¾å²¸é‚Šå…¥æ°´å¾Œï¼Œè·é›¢æººè€…æœ‰2ã€30å…¬å°ºä»¥ä¸Šï¼Œæ­¤æ™‚æœƒæ¡å–æŠ¬é ­æ·ã€æŠ¬é ­è›™ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ·ã€è›™å¼çš„æŠ¬é ­ç‰ˆï¼Œå› ç‚ºã€Œæ‰€æœ‰å‹•ä½œçœ¼ç›éƒ½ä¸èƒ½é›¢é–‹æººè€…ã€é¿å…æ°´æµæˆ–æ˜¯æ²ˆåˆ°æ°´åº•æ‰¾ä¸åˆ°&lt;/p>
&lt;p>æŠ¬é ­è›™åŸºæœ¬ä¸Šæ¯”è¼ƒç°¡å–®ï¼Œä½†æ˜¯æŠ¬é ­æ·å°±æ¯”æ·å¼ç´¯å¾—å¤šå¾ˆå¤šï¼Œå› ç‚ºé ­æŠ¬èµ·è…³ç›¸å°ä¸‹æ²‰ï¼Œä¸€é–‹å§‹åˆ’æ‰‹æŠ“æ°´éƒ½æœƒååˆ†è²»å‹&lt;/p>
&lt;h4 id="æ¥è¿‘æ³•">æ¥è¿‘æ³•&lt;/h4>
&lt;p>ç•¶é è¿‘æººè€… 2å…¬å°ºå·¦å³è¦å´èº«è§€å¯Ÿï¼Œç¢ºå®šå¥½è‡ªèº«å®‰å…¨ã€å‘¨åœç’°å¢ƒèˆ‡æººè€…ç‹€æ…‹å¾Œæ‰å¾ŒçºŒå‹•ä½œï¼Œé¿å…å±éšªç™¼ç”Ÿæˆ–æ˜¯è¢«æººè€…æŠ“æŠ±ã€‚&lt;/p>
&lt;p>å¦‚æœæººè€…ç„¡æ„è­˜å°±ç›´æ¥æŠ“æ‰‹è½‰å›ä»°é¢å¾€å›å¸¶ï¼Œç›¸å°æ–¼æººè€…çš„ç›¸å°ä½ç½®é‚„æœ‰æ­£é¢è¿‚è¿´æ¥è¿‘ã€èƒŒé¢æ¥è¿‘ã€æ°´ä¸­æ°´åº•æ¥è¿‘&lt;/p>
&lt;p>ä¸»è¦å°±æ˜¯å°‡æººè€…è½‰å›ä»°é¢ï¼Œç”¨åŸºæœ¬ä»°å¸¶å‹•ã€‚&lt;/p>
&lt;h4 id="è§£è„«æ³•">è§£è„«æ³•&lt;/h4>
&lt;p>æººè€…å› ç‚ºæ±‚ç”Ÿæ„å¿—è‡ªç„¶æœƒå››è™•æŠ“æŠ±ç‰©é«”ï¼Œä½†æ•‘æ´è·¯ä¸Šæœ€æ€•è¢«æŠ“æŠ±ï¼Œå› ç‚ºæœƒæ¶ˆè€—é›™æ–¹åŠ›æ°£ä¸”éå¸¸å±éšªï¼Œä¸€ä¸å°å¿ƒé€£è‡ªå·±çš„å‘½éƒ½è³ ä¸Šå»&lt;/p>
&lt;p>é‡åˆ°æŠ“æŠ±ï¼Œæœ‰åˆ†æˆè¢«æŠ“ä½æ‰‹è…•æ™‚çš„å–®æ‰‹è§£è„«ï¼Œè¢«æººè€…æ­£é¢ç’°æŠ±çš„æ­£é¢æ¨è‚˜è§£è„«èˆ‡èƒŒé¢ç’°æŠ±çš„èƒŒé¢æ¨è‚˜è§£è„«ï¼›&lt;br>
åŸºæœ¬ä¸Šéƒ½æ˜¯å…ˆå¾ªæ©Ÿå¸æ°£ï¼Œæ¥è‘—æ’¥æ°´ä¸‹æ²‰ï¼Œå› ç‚ºæººè€…æ˜¯ä¸‹æ„è­˜æƒ³è¦å»ºç«‹æµ®åŠ›ï¼Œæ‰€ä»¥ä½ åè€Œä¸‹æ²‰ä»–ä¸€æ€•å°±æœƒé¬†æ‰‹äº†ï¼Œå¦‚æœä¸è¡Œå‰‡æ”¶ä¸‹å·´é ä½æ‰‹è‚˜ä¸Šæ–¹ç”¨åŠ›æ¨å³å¯æ™è„«&lt;/p>
&lt;h4 id="é˜²è¡›æ³•">é˜²è¡›æ³•&lt;/h4>
&lt;p>é˜²è¡›æ³•æ¯”è¼ƒæ˜¯ç¢°åˆ°æººè€…æ’²ä¸Šä¾†ä½†é‚„æ²’æœ‰è¢«ç·ŠæŠ±ä½æ™‚ä½¿ç”¨ï¼Œé€£çºŒå‹•ä½œå¾å–®æ‰‹é˜»æ“‹-&amp;gt;é›™æ‰‹é˜»æ“‹-&amp;gt;é›™æ‰‹ä¸‹å£“-&amp;gt;å–®è…³è¹¬é›¢ï¼›&lt;br>
åŸºæœ¬ä¸Šå°±æ˜¯å°æ‡‰æººè€…çš„è‡ªç„¶åæ‡‰è€Œæœ‰çš„é…å¥—æªæ–½&lt;/p>
&lt;h4 id="å¸¶äººæ³•">å¸¶äººæ³•&lt;/h4>
&lt;p>æ¥è¿‘æ³•å°‡æººè€…è½‰æˆä»°é¢æ‹–å‹•å¾Œï¼Œç‚ºäº†æ›´å¥½æ§åˆ¶æººè€…ï¼Œé€šå¸¸æœƒç”¨æŠ±èƒ¸å¼å¸¶äººï¼Œé€™å¤§æ¦‚æ˜¯æ•´å€‹æ•‘æººç’°ç¯€æœ€ç‚ºç´¯äººçš„å‹•ä½œï¼Œæ•‘è€…æ¡ç”¨å´æ³³ç”¨è…°å°‡æººè€…é ‚è‘—ï¼Œæ¥è‘—ç”¨åå‰ªå¤¾æ°´å›åˆ°å²¸é‚Šï¼Œè€ƒè©¦å¤¾å®Œ25å…¬å°ºå®Œå…¨ç«™ä¸èµ·ä¾†â€¦.&lt;/p>
&lt;h4 id="èµ·å²¸æ³•">èµ·å²¸æ³•&lt;/h4>
&lt;p>åˆåˆ†æˆæ·±æ°´æ·ºæ°´ï¼Œæººè€…æœ‰ç„¡æ„è­˜ï¼Œä¸»è¦æœ‰é¦¬éå¼ã€èƒŒè² å¼ã€æ‹–æ‹‰å¼ã€æ·±æ°´èµ·å²¸æ³•ç­‰&lt;/p>
&lt;h4 id="æ•‘æººå…«å¤§æ­¥é©Ÿèˆ‡æ€¥æ•‘">æ•‘æººå…«å¤§æ­¥é©Ÿèˆ‡æ€¥æ•‘&lt;/h4>
&lt;p>èº«ç‚ºæ•‘ç”Ÿå“¡éƒ½è¦é€šé16å°æ™‚å—è¨“çš„åŸºç¤æ€¥æ•‘èª²ç¨‹ï¼Œä¸¦å­¸ç¿’æ•‘æººå…«å¤§æ­¥é©Ÿï¼›&lt;br>
é€šå¸¸æ•‘ç”Ÿå“¡ç¬¬ä¸€ç·šä¸»è¦é é˜²ä¼‘å…‹ï¼Œçµ¦äºˆä¿æš–ã€æ­¢è¡€åŒ…ç´®é€™äº›ï¼Œç‚ºäº†é¿å…äºŒåº¦èˆ‡é ¸æ¤å‚·å®³ï¼Œæœ‰å­¸ç¿’æ“ä½œé•·èƒŒæ¿ç­‰ä½¿ç”¨&lt;/p>
&lt;h3 id="å¦‚ä½•èº«ç‚ºä¸€å€‹è‰¯å¥½çš„æººè€…">å¦‚ä½•èº«ç‚ºä¸€å€‹è‰¯å¥½çš„æººè€…&lt;/h3>
&lt;p>ç•¶ç„¶æˆ‘å€‘éƒ½ä¸å¸Œæœ›æ„å¤–ç™¼ç”Ÿï¼Œä½†ç¸½æ˜¯å¯èƒ½æœƒæœ‰ç™¼ç”Ÿçš„é¢¨éšªï¼Œèˆ‡å…¶é€ƒé¿ä¸å¦‚èŠ±é»å¿ƒæ€æº–å‚™ï¼Œä»¥å‚™ä¸æ™‚ä¹‹éœ€ï¼›&lt;/p>
&lt;p>ä»¥ä¸€å€‹æ•‘ç”Ÿå“¡å—è¨“å®Œï¼Œç¨å¾®ç”¨ä¸åŒçš„è§’åº¦ä¾†åˆ†äº«å“ªäº›æººè€…æœ€å®¹æ˜“è¢«æ•‘ä¸Šä¾†ï¼Œé€™äº›æƒ³æ³•ä¸»è¦æ˜¯çµåˆè‡ªå·±å—è¨“çš„å¿ƒå¾—èˆ‡æ•™ç·´çš„æŒ‡å°ï¼Œå¦‚æœæœ‰éºæ¼æˆ–æ˜¯éŒ¯èª¤å†è«‹æŒ‡æ•™&lt;/p>
&lt;ol>
&lt;li>åœ¨äººå¤šä¸”æœ‰å–®ä½å”å‹¤çš„åœ°æ–¹ç©æ°´&lt;br>
åœ¨æ¸¸æ³³æ± ç©æ°´ç›¸å°è »å®‰å…¨ï¼Œå¦‚æœè¦åˆ°é‡å¤–æœ€å¥½æ˜¯æˆç¾¤çµä¼´ï¼Œä¸”åˆ°æœ‰æ•‘ç”Ÿå–®ä½å”å‹¤çš„åœ°æ–¹ï¼Œåƒæ˜¯çƒä¾†çš„ç´…æ²³è°·å°±æ˜¯æ–°åº—åŒå¿ƒæ•‘é›£éšŠå¤æ—¥å”å‹¤åœ°é»ï¼›&lt;br>
åœ¨é€™äº›åœ°æ–¹ç©æ°´çš„å¥½è™•é™¤äº†æœ‰åˆæ ¼çš„æ•‘ç”Ÿå“¡å¤–ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿç›¸å°æœƒæº–å‚™æ•‘ç”Ÿå™¨æï¼Œå¦‚æ•‘ç”Ÿåœˆã€æ‹‹ç¹©è¢‹ã€é­šé›·æµ®æ¨™ã€å……æ°£å¼æ±½è‰‡ã€æ•‘ç”Ÿæ¿ç­‰&lt;br>
å¦‚æœæ˜¯è‡ªå·±å‡ºå»ç©ï¼Œæ³³æŠ€ä¸å¤ªå¥½æˆ–æ˜¯æ°´åŸŸä¸ç†Ÿæ‚‰ã€Œ&lt;strong>å‹™å¿…æ”œå¸¶æµ®æ¨™ã€&lt;/strong>ï¼Œä¹‹å‰æºªè¨“åˆ°ç¢§æ½­ï¼Œæ•´å€‹æ°´æº«åˆ†æˆä¸‰å±¤ï¼Œæœ‰æ™‚é‡åˆ°åœ°ä¸‹æ°´æ¹§æ³‰åˆæœƒå¿½å†·å¿½ç†±ï¼Œçµæœæˆ‘å°±æ¸¸ä¸€æ¸¸æŠ½ç­‹äº†ï¼Œä¸€æ–¹é¢æœ‰æ•™ç·´åœ¨æ—é‚Šé —å®‰å¿ƒï¼Œå¦ä¸€æ–¹é¢å…ˆæŠ“åˆ°æµ®æ¨™å»ºç«‹æµ®åŠ›ï¼Œå°±å¯ä»¥æŠ½ç­‹è‡ªè§£ï¼›&lt;br>
æ‰€ä»¥å­¸æœƒ&lt;code>å»ºç«‹æµ®åŠ›&lt;/code>å¾ˆé‡è¦ï¼Œå¸¶æµ®æ¨™é å¤–ç‰©å¯ä»¥å¾ˆè¼•é¬†çš„æµ®èµ·ä¾†ï¼Œæˆ–æ˜¯å­¸æœƒåŸºæœ¬çš„æ°´æ¯æ¼‚æˆ–æŠ½ç­‹è‡ªè§£ä¹Ÿéƒ½å¾ˆé‡è¦&lt;/li>
&lt;li>å‘ˆä¸Šé‡é›£æ™‚ä¸è¦å¤ªç·Šå¼µï¼Œä¸è¦æŠ“æŠ±æ•‘ç”Ÿå“¡&lt;br>
åœ¨æœ€å¾Œè€ƒè©¦æ™‚æ•™ç·´æœ‰æ¨¡æ“¬æŠ“æŠ±ï¼ŒåŸæœ¬æŠ“æŠ±å‰é«”åŠ›å¤§æ¦‚é‚„æœ‰80%ï¼ŒæŠ“æŠ±ä¸€æ¬¡è§£è„«å¾Œç›´æ¥å‰©20%ï¼Œå¦‚æœä¸æ˜¯åœ¨è€ƒè©¦é€”ä¸­æˆ‘å¤§æ¦‚å°±ç›´æ¥è½è·‘äº†OTZÂ &lt;br>
ä¸€æ–¹é¢æ˜¯æˆ‘è‡ªèº«é«”åŠ›æ³³æŠ€é‚„ä¸å¤ å¥½ï¼Œå¦ä¸€æ–¹é¢çœŸçš„è¦å¸¶äººåˆè¦é˜²è¡›æººè€…çœŸçš„æœƒå¾ˆç´¯ï¼Œæ‰€ä»¥ç›¸å°çš„å¦‚æœæººè€…ç„¡æ„è­˜äº†åè€Œæ¯”è¼ƒé‚„å¥½ï¼Œæœ‰æ„è­˜çš„è©±å°±é…åˆï¼Œæ‰å¯ä»¥å¤§å¹…å¢åŠ è‡ªå·±çš„ç”Ÿå­˜æ©Ÿæœƒï¼›&lt;br>
å¦‚æœæ˜¯åœ¨æœ‰å”å‹¤å–®ä½çš„åœ°æ–¹æˆ²æ°´ï¼Œéƒ½æœƒè¢«æœ‰å¦¥ç•¶çš„æ•‘ç”Ÿç”¨å…·ï¼Œé€™äº›æ•‘ç”Ÿç”¨å…·å¯ä»¥ç¯€çœæ•‘ç”Ÿå“¡å¾ˆå¤§éƒ¨åˆ†çš„é«”åŠ›ï¼Œç›¸å°ä¹Ÿå¯ä»¥é™ä½å¤§å®¶æººæ°´çš„é¢¨éšª&lt;/li>
&lt;/ol>
&lt;p>ç¸½çµï¼š&lt;br>
æŒ‘é¸å®‰å…¨çš„åœ°æ–¹æˆ²æ°´ -&amp;gt; ä¸å¹¸å‡ºäº‹å¤§è²æ±‚æ•‘ -&amp;gt; å»ºç«‹è‡ªèº«æµ®åŠ› -&amp;gt; ä¿æŒå†·éœä¸è¦äº‚æŠ“æŠ±&lt;/p>
&lt;p>28å¤©çš„èª²ç¨‹ï¼Œä¸€åˆ°å…­æ—©ä¸Šäº”é»åˆ°ä¸ƒé»æ“ç·´ï¼Œç·´ç¿’å‹•ä½œèˆ‡é•·æ³³é›éŠé«”åŠ›ï¼Œé€±æ—¥å…¨å¤©å­¸ç¿’æ€¥æ•‘èˆ‡åˆ°é‡å¤–æºªè¨“èˆ‡æµ·è¨“&lt;/p>
&lt;h4 id="æºªè¨“æµ·è¨“">æºªè¨“æµ·è¨“&lt;/h4>
&lt;p>æºªè¨“æµ·è¨“çœŸçš„å¾ˆç‰¹åˆ¥ï¼Œä¹‹å‰æˆ‘æ²’æœ‰å¤ªå¤šåˆ°é‡å¤–æ¸¸æ³³çš„ç¶“é©—ï¼Œåˆ°äº†æºªè¨“æ•™ç·´ä¸€ä¸‹æ°´é•·æ³³å°±æ˜¯ä¸€å€‹å¤šå°æ™‚â€¦.Â &lt;br>
çœŸçš„æ˜¯è¶…ç´šç´¯ï¼Œè€Œä¸”è¦åœ¨è¸©ä¸åˆ°åº•ä¹Ÿçœ‹ä¸åˆ°åº•çš„åœ°æ–¹å°éŠå‹•ä½œï¼Œå¿ƒè£¡ç¸½æ˜¯ä¸è¸å¯¦ï¼Œæœ€å¾Œæºªè¨“å°±æŠ½ç­‹äº†&lt;br>
æµ·è¨“å‰‡æ˜¯å› ç‚ºæµ®åŠ›å¤§æ¯”è¼ƒè¼•é¬†é»ï¼Œé›–ç„¶æ°´å–åˆ°è¶…ç—›è‹¦ï¼Œåˆè‹¦åˆé¹¹å–‰åš¨è¶…ç—›ï¼Œä½†æ•´é«”è¼•é¬†ä¸€äº›ï¼Œä¹Ÿæ²’æœ‰æŠ½ç­‹ï¼Œä¸éå› ç‚ºæœ‰æµªæ‰€æœ‰åŒæœŸå­¸å“¡æœ‰äººå°±åäº†&lt;/p>
&lt;p>é™¤äº†æŠ˜ç£¨çš„é•·æ³³å¤–ï¼Œå¾ŒçºŒçš„èª²ç¨‹å°±æ˜¯æ“ä½œæ•‘ç”Ÿç”¨å…·ï¼Œç·´ç¿’æ‹‹æ•‘ç”Ÿåœˆã€å­¸ç¿’æ”¶ç¹©ï¼Œé‚„æœ‰å……æ°£å¼çš®è‰‡ä¹‹é¡çš„ï¼Œéå¸¸å¥½ç©&lt;br>
æœ€å¾Œä¸‹åˆéƒ½æœƒæµ®æ½›ä¸€å€‹å¤šå°æ™‚çµæŸæ•´å¤©çš„è¨“ç·´&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>åƒåŠ æ•‘ç”Ÿå“¡è¨“ç·´ä¸»è¦æ˜¯å¸Œæœ›çµ¦è‡ªå·±ä¸€å€‹ç£¨ç·´çš„æ©Ÿæœƒï¼Œåœ¨éç¨‹ä¸­å­¸ç¿’åˆ°å¾ˆå¤šæ•‘ç”Ÿçš„çŸ¥è­˜ï¼ŒçœŸçš„éå¸¸æ„Ÿè¬æ•™ç·´å€‘æ¯å¤©éƒ½é™ªæˆ‘å€‘æ—©èµ·ï¼Œé™¤äº†æˆèª²å¤–é‚„å¾ˆä»”ç´°çš„ç³¾æ­£æˆ‘å€‘çš„å§¿å‹¢ï¼Œåˆ°é‡å¤–å—è¨“å°±æœ‰ä¸€ç¾¤æ•™ç·´åŒ…åœè‘—å­¸å“¡ï¼Œä¸€é‚Šå®‰å…¨æˆ’è­·ä¸€é‚Šåš´å²çš„ç£ä¿ƒä¸¦æŒ‡å°æˆ‘å€‘&lt;/p>
&lt;p>åŸå‰‡ä¸ŠéšŠä¸Šæ¯å¹´ä¸ƒå…«æœˆé–‹å…©æœŸï¼Œæ‰€ä»¥æœ‰èˆˆè¶£ä¹Ÿè¦ç­‰åˆ°æ˜å¹´å›‰XDÂ &lt;br>
ä¹‹å¾Œæ˜å¹´è·Ÿè‘—éšŠä¸Šå»å”å‹¤ï¼Œå¸Œæœ›ä¹Ÿæœ‰ç‚ºç¤¾æœƒè²¢ç»çš„æ©Ÿæœƒã€‚&lt;/p></description></item><item><title>ä½¿ç”¨ Jest åšAPI å–®å…ƒæ¸¬è©¦çš„ç¯„ä¾‹èˆ‡ç´°ç¯€</title><link>https://yuanchieh.page/posts/2018/2018-08-06-%E4%BD%BF%E7%94%A8-jest-%E5%81%9Aapi-%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E7%9A%84%E7%AF%84%E4%BE%8B%E8%88%87%E7%B4%B0%E7%AF%80/</link><pubDate>Mon, 06 Aug 2018 10:42:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-08-06-%E4%BD%BF%E7%94%A8-jest-%E5%81%9Aapi-%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E7%9A%84%E7%AF%84%E4%BE%8B%E8%88%87%E7%B4%B0%E7%AF%80/</guid><description>&lt;p>Â &lt;br>
ä¹‹å‰å¯«æ¸¬è©¦å› ç‚ºæ²’æœ‰æ³¨æ„ç´°ç¯€ï¼Œå°è‡´éå¸¸é›£ç·¨å¯«å–®å…ƒæ¸¬è©¦ï¼›&lt;br>
æ”¹ä»¥ End-to-Endæ¸¬è©¦ï¼Œç›´æ¥ç”¨docker é–‹DBè¼¸å…¥å‡è³‡æ–™ï¼Œæ¥è‘—åŸ·è¡Œ Server App å°APIä¸€éš»ä¸€éš»æ¸¬è©¦ã€‚&lt;/p>
&lt;p>é€™æ¨£çš„å¥½è™•æ˜¯æ¸¬è©¦æ–¹æ³•èˆ‡æœ€çµ‚APIèª¿ç”¨çš„çµæœæ˜¯ä¸€æ¨£çš„ï¼Œä½†ç¼ºé»å°±æ˜¯è€—æ™‚è¼ƒä¹…ï¼Œä¸”é‚Šå¯«æ¸¬è©¦çš„æˆæœ¬å¾ˆé«˜ï¼Œè¦åšåˆ°TDDä¹‹é¡çš„é–‹ç™¼æ–¹å¼éå¸¸å›°é›£ã€‚&lt;/p>
&lt;p>å¦ä¸€æ–¹é¢ä¹‹å‰ç”¨ Mochaï¼Œä¹Ÿç®—æ˜¯ Nodejs æœ€å¤§å®—ä½¿ç”¨çš„æ¸¬è©¦æ¡†æ¶ï¼Œæä¾›æœ€åŸºæœ¬çš„æ¸¬è©¦ç’°å¢ƒèˆ‡èªæ³•å®šç¾©ï¼Œå…¶é¤˜çš„æ–·è¨€ã€Mockingéƒ½è¦è‡ªå·±å¦å¤–æƒ³è¾¦æ³•ï¼›&lt;br>
é€™æ¬¡æ”¹ç”¨jestï¼Œç”±FBé–‹æºå¯ä¾›å‰å¾Œç«¯çš„æ¸¬è©¦æ¡†æ¶ï¼Œæ­¤æ¬¡é †ä¾¿åˆ†äº«å¦‚ä½•å»ºæ§‹ç¨‹å¼ç¢¼æ‰æ–¹ä¾¿å¯«æ¸¬è©¦çš„å°å°å¿ƒå¾—ã€‚&lt;/p>
&lt;h3 id="jest-å¦‚ä½•ä½¿ç”¨">Jest å¦‚ä½•ä½¿ç”¨&lt;/h3>
&lt;p>Jest ä½¿ç”¨ä¸Šæœ‰é»åƒ Mocha + Chaiï¼Œé™¤äº†æ¸¬è©¦ç’°å¢ƒå¤–é‚„ä»¥è‡ªå®šç¾©çš„æ–·è¨€ï¼Œæä¾›å¤šç¨®ç·¨å¯«èªæ„åŒ–çš„æ¸¬è©¦æƒ…å¢ƒã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./sum.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="nx">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exports&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">sum&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./sum.test.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€˜&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">sum&lt;/span>&lt;span class="err">â€™&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€˜&lt;/span>&lt;span class="nx">adds&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="nx">to&lt;/span> &lt;span class="nx">equal&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="err">â€™&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)).&lt;/span>&lt;span class="nx">toBe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>// åŸ·è¡Œ&lt;br>
&amp;gt; jest&lt;/p>
&lt;p>å¦ä¸€é»æ–¹ä¾¿çš„æ˜¯ Jestå°æ–¼ Callbackã€Promiseã€Async/Awaitæ”¯æ´ç›¸ç•¶å¥½ï¼Œç•¶åˆåœ¨Mochaä¸­æäº†ä¸€é™£å­â€¦.&lt;/p>
&lt;h3 id="é‚Šå¯«æ¸¬è©¦çš„å°ç´°ç¯€">é‚Šå¯«æ¸¬è©¦çš„å°ç´°ç¯€&lt;/h3>
&lt;p>ä½¿ç”¨Mockï¼Œé€éé è¨­æƒ…æ™¯èˆ‡å‡è³‡æ–™ï¼Œä¸ç”¨æ¶è¨­è¤‡é›œçš„ç’°å¢ƒæˆ–æ˜¯çœŸçš„ç™¼å‡ºéåŒæ­¥è«‹æ±‚ï¼Œå°±å¯ä»¥é”åˆ°æ¸¬è©¦çš„æ•ˆæœï¼›&lt;br>
åœ¨ä½¿ç”¨Mockä¹‹å‰ï¼Œæœ‰ä¸€é»è¦æ³¨æ„ &lt;code>ç›¡é‡æŠŠAPIåŒ…æˆå‡½å¼æˆ–æ•´ç†æˆç‰©ä»¶æ–¹æ³•è€Œéç›´æ¥å‘¼å«&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚èªªåœ¨è¨­è¨ˆAPI: GET /user/:userId&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸è¦é€™æ¨£ç›´æ¥å‘¼å« mongoose æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="nx">getUserById&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">mongoose&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€¦&lt;/span>&lt;span class="p">.)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;span class="c1">// æ‹†é–‹æˆç¨ç«‹çš„å‡½å¼ï¼Œæ–¹ä¾¿å¾ŒçºŒåš Mock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="nx">getUserById&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">getUserByIdInModel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="nx">getUserByIdInModel&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">mongoose&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€¦&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°‡éåŒæ­¥è«‹æ±‚æ•´ç†åŒ…æˆå‡½å¼åœ¨èª¿ç”¨æœ‰å¹¾å€‹å¥½è™•&lt;br>
1. è§£è€¦ï¼Œå¤šä¸€å±¤æŠ½è±¡åŒ–&lt;br>
è©¦æƒ³ä»Šå¤©æ˜¯ç”¨MongoDBç•¶ä½œè³‡æ–™åº«ï¼Œä½†å¦‚æœæŸå¤©éœ€è¦æ›æˆ PostgreSQLï¼ŒæŠŠè³‡æ–™åº«èª¿ç”¨å¯«æ­»åœ¨ APIé‚è¼¯ä¸­æœƒå°è‡´æ•´ä»½ç¨‹å¼ç¢¼éœ€è¦é‡å¯«ï¼›&lt;br>
ä½†å¦‚æœæ‹†é–‹æˆç¨ç«‹å‡½å¼ï¼Œå°±åªè¦æ”¹å‡½å¼èª¿ç”¨çš„DB Clientèˆ‡å°æ‡‰åŸæœ¬çš„å›å‚³è³‡æ–™æ ¼å¼å³å¯(è¦ªèº«ç¶“é©—&lt;br>
2. æ–¹ä¾¿ç·¨å¯«æ¸¬è©¦&lt;br>
éåŒæ­¥è«‹æ±‚æœ¬èº«ä¹Ÿå¯ä»¥ç¨ç«‹å¯«æ¸¬è©¦ (å¦‚æœéœ€è¦çš„è©±&lt;/p>
&lt;p>æ¥è‘—çœ‹ Jestå¦‚ä½•ç”Ÿæˆå‡è³‡æ–™ã€‚&lt;/p>
&lt;h4 id="mock">Mock&lt;/h4>
&lt;p>ç”¢ç”Ÿå‡è³‡æ–™å¯ä»¥åˆ†ç‚º func&lt;br>
å‡è¨­æˆ‘å€‘åŸæœ¬çš„ç¨‹å¼ç¢¼ç‚º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// index.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">api&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€˜&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">apiWrapper&lt;/span>&lt;span class="err">â€™&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">Obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€˜&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">objectWrapper&lt;/span>&lt;span class="err">â€™&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callAPI&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">api&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callObject&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Obj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">jay&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sayHi&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./util/apiWrapper.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">fs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€˜&lt;/span>&lt;span class="nx">mz&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">fs&lt;/span>&lt;span class="err">â€™&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readFile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">params&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">fs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">test&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">txt&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./model/objWrapper.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exports&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">Test&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;span class="nx">sayHi&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="err">\&lt;/span>&lt;span class="sb">`hi from &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">\`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb">}
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸºæœ¬ä¸Šå°±æ˜¯index.jså°å¤–è¼¸å‡ºå…©å€‹å‡½å¼ï¼Œæ­¤å…©å€‹å‡½å¼å…§æœ‰éåŒæ­¥è«‹æ±‚èˆ‡å‰µå»ºç‰©ä»¶çš„æ–¹æ³•ï¼Œé€šå¸¸å€‹äººè³‡æ–™å¤¾ç›®éŒ„æ˜¯å…±ç”¨çš„éåŒæ­¥API Callæœƒå«åš utilï¼Œå¦‚æœæ˜¯è³‡æ–™åº«ç›¸é—œçš„ç‰©ä»¶å‰‡æ˜¯ modelã€‚&lt;/p>
&lt;p>æ¥è‘—çœ‹æ¸¬è©¦æª” index.test.js&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">util&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">apiWrapper&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">objectWrapper&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">mock&lt;/span> &lt;span class="nx">api&lt;/span> &lt;span class="nx">test&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="p">()=&amp;gt;{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callAPI&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">toBe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">jest&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">mock&lt;/span> &lt;span class="nx">api&lt;/span> &lt;span class="nx">test2&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="p">()=&amp;gt;{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callAPI&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">toBe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">jest2&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">mock&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="nx">test&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="p">()=&amp;gt;{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callObject&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">toBe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">hi&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="nx">jest&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™è£¡å…ˆå®šç¾©äº†ä¸‰å€‹æ¸¬è©¦æƒ…å¢ƒï¼Œä¸¦é€é jest.mock()é¡¯å¼å®£å‘Š Mockæª”æ¡ˆçš„ä½ç½®ï¼›&lt;br>
æ¥è‘—æ³¨æ„ mocké è¨­æœ‰å›ºå®šçš„è³‡æ–™è·¯å¾‘èˆ‡å‘½åè¦å‰‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">index.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">index.test.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â€” util
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | â€” â€” apiWrapper.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | â€” â€” &lt;span class="gs">__mocks__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | â€” â€” apiWrapper.js
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€æ³¨æ„mockè¦å®šç¾©åœ¨æª”æ¡ˆçš„åŒå±¤ &lt;strong>mocks&lt;/strong> è³‡æ–™å¤¾ä¸‹ï¼Œä¸¦ä¸”æª”åéœ€è¦ä¸€è‡´ä¸”è¼¸å‡ºåŒæ¨£çš„å‡½å¼åã€‚&lt;br>
å¦‚æœæ˜¯è¦ mock å¦‚ â€˜fsâ€™ç­‰åŸç”Ÿæ¨¡çµ„ï¼Œç›´æ¥å®šç¾©åœ¨å°ˆæ¡ˆæœ€ä¸Šå±¤çš„ __mocks__ä¸­å³å¯ã€‚&lt;/p>
&lt;p>åœ¨ jest.fn()ä¸­ï¼Œæœ‰éœ€å¤š mockè³‡æ–™çš„æ–¹å¼
1. mockImplementation(fn)ï¼Œå¯ä»¥å–å¾—å‡½å¼èª¿ç”¨çš„åƒæ•¸ï¼Œä¸¦æ±ºå®šå¦‚ä½•å›å‚³&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./util/__mocks__/apiWrapper.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readFile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">jest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fn&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">mockImplementation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">params&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">params&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="err">â€œ&lt;/span>&lt;span class="nx">jest&lt;/span>&lt;span class="err">â€&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="err">â€œ&lt;/span>&lt;span class="nx">jest2&lt;/span>&lt;span class="err">â€&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2. mockReturnValueOnce ä¸€æ¬¡æ€§çš„å›å‚³å€¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fn&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">mockReturnValueOnce&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">mockReturnValueOnce&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€˜&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="err">â€™&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3. mockReturnValue å›ºå®šçš„å›å‚³å€¼&lt;/p>
&lt;p>æœ‰å®šç¾©ä¸¦å®£å‘Šä½¿ç”¨ mockï¼Œjeståœ¨åŸ·è¡ŒåŸè…³æœ¬æ™‚æœƒæ”¹å‘¼å«è¢« mockè¦†å¯«å®šç¾©çš„å‡½å¼ jest.fn()ï¼Œé”åˆ°ç”¢ç”Ÿå‡è³‡æ–™çš„æ•ˆæœï¼ŒåŒæ™‚ç´€éŒ„ fn()å‘¼å«çš„æ¬¡æ•¸èˆ‡å‚³éçš„åƒæ•¸ï¼›&lt;br>
ç‰©ä»¶å‰‡åŒæ¨£ä¹Ÿæ˜¯é€éæ”¹å¯«ç‰©ä»¶çš„å‘¼å«æ–¹æ³•ã€‚&lt;/p>
&lt;p>å…¶é¤˜çš„åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œ&lt;a class="link" href="https://github.com/sj82516/very-simple-jest-example" target="_blank" rel="noopener"
>https://github.com/sj82516/very-simple-jest-example&lt;/a>&lt;/p></description></item><item><title>MySQL Explainåˆ†æèˆ‡Indexè¨­å®šæŸ¥è©¢å„ªåŒ–</title><link>https://yuanchieh.page/posts/2018/2018-07-30-mysql-explain%E5%88%86%E6%9E%90%E8%88%87index%E8%A8%AD%E5%AE%9A%E6%9F%A5%E8%A9%A2%E5%84%AA%E5%8C%96/</link><pubDate>Mon, 30 Jul 2018 10:14:40 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-07-30-mysql-explain%E5%88%86%E6%9E%90%E8%88%87index%E8%A8%AD%E5%AE%9A%E6%9F%A5%E8%A9%A2%E5%84%AA%E5%8C%96/</guid><description>&lt;p>è³‡æ–™åº«æ—¥ç©æœˆç´¯è³‡æ–™é‡é€æ­¥æ”€å‡ï¼ŒMySQLåœ¨ä¸€èˆ¬æŸ¥è©¢æ˜¯é€éå…¨è¡¨æœå°‹ï¼Œæ‰€ä»¥å¤§é‡çš„è³‡æ–™æœƒå°è‡´æŸ¥è©¢ç­‰æ–¹å¼è¶Šä¾†è¶Šæ…¢ï¼›&lt;br>
MySQLæä¾›ç´¢å¼•å»ºç½®ï¼Œä¸€èˆ¬çš„ç´¢å¼•é€é B+ Treeï¼Œåœ¨è¨˜æ†¶é«”ä¸­å¿«é€ŸæŸ¥æ‰¾è³‡æ–™æ‰€åœ¨ä½ç½®ï¼Œå°‡æœå°‹å¾ O(n) ç´„*é™è‡³O(log n)ï¼Œç´¢å¼•æ”¯æ´Where / Order by / Rangeä¸­çš„æ¢ä»¶åˆ¤æ–·ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹ç”¢ç”ŸUser / Orderå…©å¼µç™¾è¬ç­†è³‡æ–™çš„Table&lt;br>
1. ä¸¦è©¦è‘—ç”¨Explain åˆ†æSQLèªæ³•&lt;br>
2. é€éç´¢å¼•è¨­å®šæ¯”è¼ƒå‰å¾Œçš„æŸ¥è©¢é€Ÿåº¦å„ªåŒ–&lt;/p>
&lt;h3 id="table">Table&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;users&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;uuid&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">char&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">36&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;age&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;firstName&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;lastName&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;createdAt&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;updatedAt&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1000001&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;orders&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;uuid&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">char&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">36&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;cost&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;user_id&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;user_uuid&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tradeNo&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;createdAt&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;updatedAt&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">750001&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="explain">Explain&lt;/h3>
&lt;p>Explainå¯ä»¥ç”¨æ–¼åˆ†æ SELECT / DELETE / UPDATE / INSERT / REPLACE èªå¥ï¼Œæ¢åˆ—å‡ºåŸ·è¡ŒSQLèªå¥æ™‚æœƒä½¿ç”¨åˆ°çš„ Tableèˆ‡æ¬„ä½è³‡è¨Šï¼Œå¯¦éš›å›å‚³çš„æ¬„ä½æœ‰&lt;/p>
&lt;ol>
&lt;li>select_type:Â &lt;br>
SELECTæŸ¥è©¢çš„ç‹€æ…‹ï¼Œå¸¸è¦‹æœ‰å¹¾ç¨®å‹åˆ¥
&lt;ul>
&lt;li>SIMPLEï¼šç°¡å–®æŸ¥è©¢&lt;/li>
&lt;li>PRIMARYï¼šä¸»æŸ¥è©¢ï¼Œç›¸å°æ–¼å­æŸ¥è©¢Subquery&lt;/li>
&lt;li>UNIONï¼šåœ¨UNIONèªå¥ä¸­çš„éé¦–å€‹SELECT&lt;/li>
&lt;li>SUBQUERYï¼šå­æŸ¥è©¢&lt;br>
å¦‚æœéSELECTå‰‡ç‚ºå…¶ä»–å‹•è©å¦‚DELETE&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>table:Â &lt;br>
ä¹Ÿå°±æ˜¯ä½¿ç”¨çš„Tableåç¨±&lt;/li>
&lt;li>partitions:&lt;br>
å¦‚æœæœ‰ä½¿ç”¨ partitionåŠŸèƒ½æ‰æœƒé¡¯ç¤º&lt;/li>
&lt;li>type:Â &lt;br>
&lt;code>type&lt;/code> åƒæ•¸éå¸¸é‡è¦ï¼Œé€™æœƒæ±ºå®šæ­¤æ¬¡SQLèªå¥ä½¿ç”¨ç´¢å¼•ç‹€æ³ï¼Œç”±å„ªè‡³åŠ£é †åºä»‹ç´¹&lt;br>
&lt;strong>const / system&lt;/strong>&lt;br>
æŸ¥è©¢ç”¨ä¸Šprimary / unique keyï¼Œä¹Ÿå°±æ˜¯æ¢ä»¶å‰›å¥½åŒ¹é…ä¸€å€‹è¡Œï¼Œå› ç‚ºåªè®€å–ä¸€è¡Œæ‰€ä»¥é€Ÿåº¦æœ€å¿«ï¼›&lt;br>
systemæ˜¯ç‰¹æ®Šé¡çš„constï¼Œç”¨æ–¼æŸ¥è©¢ systemç›¸é—œçš„è¡¨ï¼Œå¦‚&lt;br>
&lt;code>explain select * from 'proxies_priv' where user=â€™rootâ€™&lt;/code>
&lt;strong>eq_ref&lt;/strong> :ç”¨æ–¼å¤šè¡¨ joinä¸‹ï¼Œå¦‚æœåœ¨æ¢ä»¶åˆ¤æ–· = ä¸Šç”¨äº†&lt;code>PRIMARY KEY&lt;/code> æˆ–&lt;code>UNIQUE NOT NULL&lt;/code>ä¹Ÿå°±æ˜¯æ¢ä»¶å‰›å¥½åŒ¹é…ä¸€å€‹è¡Œ&lt;br>
æ­¤ç¯„ä¾‹çš„ join selectå°±æ˜¯ç”¨ä¸Š&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html#jointype_eq_ref" target="_blank" rel="noopener"
>&lt;code>eq_ref&lt;/code>&lt;/a>å› ç‚º user.idæ˜¯ primary key&lt;br>
&lt;code>explain select * from orders left join users on users.id = orders.user_id where orders.cost &amp;gt; 100;&lt;/code>&lt;br>
&lt;strong>ref&lt;/strong>&lt;br>
ç”¨æ–¼å¤šè¡¨ joinä¸‹ï¼Œå¦‚æœæ˜¯ç”¨leftmost prefix keyæˆ–æ˜¯é &lt;code>[eq_ref](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html#jointype_eq_ref)&lt;/code> æ¢ä»¶ä¸­çš„keyï¼Œä¹Ÿå°±æ˜¯å¯èƒ½æœƒåŒ¹é…å¤šè¡ŒÂ 
&lt;ul>
&lt;li>index_mergeï¼š&lt;br>
å¦‚æœæŸ¥è©¢ç”¨ä¸Šå¤šå€‹keyï¼Œä¾‹å¦‚&lt;br>
&lt;code>explain select id from users where id = 2 or id=100 or uuid=â€™21d9dadb-038f-427d-8ef1-c2b3aa0994e6';&lt;/code>&lt;br>
(id / uuid éƒ½æ˜¯ index)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>range
å°‡keyç”¨æ–¼ç¯„åœæŸ¥è©¢ï¼Œå¦‚
&lt;ul>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_equal" target="_blank" rel="noopener"
>=&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_not-equal" target="_blank" rel="noopener"
>&amp;lt;&amp;gt;&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_greater-than" target="_blank" rel="noopener"
>&amp;gt;&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_greater-than-or-equal" target="_blank" rel="noopener"
>&amp;gt;=&lt;/a>`,&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_less-than" target="_blank" rel="noopener"
>&amp;lt;&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_less-than-or-equal" target="_blank" rel="noopener"
>&amp;lt;=&lt;/a>,&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_is-null" target="_blank" rel="noopener"
>IS NULL&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_equal-to" target="_blank" rel="noopener"
>&amp;lt;=&amp;gt;&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_between" target="_blank" rel="noopener"
>BETWEEN&lt;/a>,&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/string-comparison-functions.html#operator_like" target="_blank" rel="noopener"
>LIKE&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#function_in" target="_blank" rel="noopener"
>IN()&lt;/a>`Â &lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>indexï¼š&lt;br>
å…¨è¡¨ç´¢å¼•æª¢ç´¢ï¼Œå¸¸ç”¨æ–¼ç´¢å¼•å¯è¦†è“‹æŸ¥è©¢æ¬„ä½ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ°ç£ç¢Ÿè®€å–è³‡æ–™&lt;br>
ALLï¼š&lt;br>
æœ€å·®çš„æŸ¥è©¢æ–¹å¼ï¼Œå…¨è¡¨æœå°‹&lt;/li>
&lt;/ul>
&lt;ol start="6">
&lt;li>possible_keysï¼š&lt;br>
å¯èƒ½æœƒç”¨ä¸Šçš„key&lt;/li>
&lt;li>keyï¼š&lt;br>
å¯¦éš›ç”¨ä¸Šçš„key&lt;/li>
&lt;li>key_lenï¼š&lt;br>
å¯¦éš›keyä½¿ç”¨çš„æ¯”å°é•·åº¦&lt;/li>
&lt;li>refï¼š&lt;br>
ç”¨åœ¨èˆ‡ç´¢å¼•æ¯”å°çš„å¸¸æ•¸æˆ–æ¬„ä½ï¼Œå¦‚&lt;br>
&lt;code>explain delete from users where id=1;&lt;/code> refå€¼ç‚º constï¼Œå› ç‚ºæ˜¯1ï¼›&lt;br>
å¦‚æœæ¯”å°çš„æ˜¯æ¬„ä½å‰‡æœƒå‡ºç¾æ¬„ä½åï¼Œå¦‚ &lt;code>index_search.orders.user_id&lt;/code>&lt;/li>
&lt;li>rowsï¼š&lt;br>
MySQLé è¨ˆè¦è®€å–çš„è¡Œæ•¸&lt;/li>
&lt;li>filteredï¼š&lt;br>
MySQLæ ¹æ“šæ¢ä»¶é è¨ˆæœƒç¯©é¸æ‰çš„æ¯”ä¾‹ï¼Œä»¥ç™¾åˆ†æ¯”é¡¯ç¤ºï¼Œæ‰€ä»¥æœ€å¤§å€¼ç‚º100ï¼Œä¹Ÿå°±æ˜¯æ¯å€‹ rowséƒ½ç”¨ä¸Š&lt;/li>
&lt;li>Extraï¼š&lt;br>
é¡å¤–è£œå……ï¼Œæœ‰å¹¾å€‹å€¼éœ€è¦ç•™æ„&lt;br>
ï¼ŠUsing filesortï¼š&lt;br>
MySQLåœ¨æ’åºä¸Šéœ€è¦åšé¡å¤–çš„è™•ç†ï¼Œæœƒè€—è²»å¤§é‡çš„æ€§èƒ½ã€‚&lt;br>
* Using Whereï¼š&lt;br>
æœ‰åŠ å…¥æ¢ä»¶åˆ¤æ–·ï¼Œå¦‚æœä¸æ˜¯è¦åˆ»æ„æƒå…¨è¡¨ï¼Œç†è«–ä¸Šéƒ½æœƒå‡ºç¾é€™å€‹å€¼ï¼›&lt;br>
å¦‚æœExtraæ²’æœ‰å‡ºç¾Using Where ä¸” typeç‚º ALL/ indexï¼Œå°å¿ƒå°±è½å…¥äº†å…¨è¡¨æƒæã€‚&lt;br>
* Using indexï¼š&lt;br>
ç´¢å¼•æœå°‹ä¸”è¦†è“‹ç´¢å¼•ï¼Œå°±ä¸ç”¨å†é¡å¤–è®€å–å¯¦éš›çš„row è³‡æ–™ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="å¯¦éš›ä½¿ç”¨">å¯¦éš›ä½¿ç”¨&lt;/h3>
&lt;p>æˆ‘é€é nodejså¡å…¥ç™¾è¬ç­†å‡è³‡æ–™ï¼Œå¯ä»¥åƒè€ƒé€£çµå–å¾—&lt;/p>
&lt;h4 id="right-join-å’Œ-leftjoinå·®ç•°">RIGHT JOIN å’Œ LEFTÂ JOINå·®ç•°&lt;/h4>
&lt;p>users / orders Tableç›®å‰åªæœ‰ idæ˜¯ primary keyï¼Œæ¯”å°ä»¥ä¸‹å…©å€‹èªå¥ï¼Œå…©è€…åŸ·è¡Œé€Ÿåº¦å¤©å·®åœ°é &lt;/p>
&lt;p>&lt;code>explain select * from users left join orders on orders.user_id = users.id;&lt;/code>&lt;/p>
&lt;p>&lt;code>explain select * from users right join orders on orders.user_id = users.id;&lt;/code>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/outer-join-simplification.html" target="_blank" rel="noopener"
>MySQLå…§éƒ¨æœƒæŠŠRIGTH JOINè½‰æ›æˆLEFT JOIN&lt;/a>ï¼Œæ‰€ä»¥å…¶å¯¦å°±æ˜¯æ¯”è¼ƒå…ˆåŸ·è¡Œ users é‚„æ˜¯ ordersï¼Œåœ¨å…§éƒ¨ &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/nested-join-optimization.html" target="_blank" rel="noopener"
>JOINæ˜¯å¤šå±¤ for loopæŸ¥æ‰¾&lt;/a>ä¸¦æ¯”å° on çš„æ¢ä»¶åˆ¤æ–·ï¼›&lt;br>
åœ¨é€™å€‹æ¡ˆä¾‹ä¸­ï¼Œ å¾Œè€…çš„åŸ·è¡Œé€Ÿåº¦æœƒé å¿«æ–¼å‰è€…å› ç‚ºå¾Œè€…å…ˆloop ordersï¼Œæ¥è‘—æ‹¿ orders.user_idå» usersä¸­æ¯”å°users.idï¼Œè€Œ user.idæ˜¯ primary keyæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ï¼›&lt;br>
åä¹‹ orders.user_idæ²’æœ‰ç´¢å¼•ï¼Œåªèƒ½å…¨è¡¨æƒæã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__vXNThgMlQU72iv7kH3dXiw.png"
loading="lazy"
alt="explain select * from users right join orders on orders.user_id = users.id;"
>&lt;/p>
&lt;p>&lt;code>explain select * from users right join orders on orders.user_id = users.id;&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__fp99dWZ32mfR0yvRKL2Xfw.jpeg"
loading="lazy"
alt="explain select * from users right join orders on orders.user_id = users.id;"
>&lt;/p>
&lt;p>&lt;code>explain select * from users right join orders on orders.user_id = users.id;&lt;/code>&lt;/p>
&lt;h4 id="å­æŸ¥è©¢">å­æŸ¥è©¢&lt;/h4>
&lt;p>å¦‚æœæˆ‘æƒ³è¦æ¢åˆ—æ‰€æœ‰è¨‚å–®æ•¸è¶…éå…©ç­†çš„ç”¨æˆ¶ï¼Œä¸¦åŒæ™‚é¡¯ç¤º{ç”¨æˆ¶æ‰€æœ‰è³‡æ–™ï¼Œè¨‚å–®æ•¸}ï¼Œå¯èƒ½æœ‰å¹¾ç¨®åšæ³•&lt;/p>
&lt;ol>
&lt;li>å¾usersÂ , temp tableå–è³‡æ–™ï¼Œtemp table æ˜¯æš«å­˜ è¨‚å–®æ•¸è¶…é2çš„ tableï¼Œå…©è€…åš INNER JOINÂ &lt;br>
&lt;code>select users.*, temp.order_count from (select user_id, count(distinct orders.id) as order_count from orders group by orders.user_id having order_count &amp;gt; 2) temp INNER JOIN users on users.id = temp.user_id;&lt;/code>&lt;/li>
&lt;li>orders å…ˆINNER JOIN usersï¼Œæ¥è‘—æ‰è¨ˆç®—è¨‚å–®æ•¸&lt;br>
&lt;code>select users.*, count(distinct orders.id) as order_count from orders INNER JOIN users on users.id = orders.user_id group by orders.user_id having order_count &amp;gt; 2;&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>ç¬¬ä¸€é»çš„å•é¡Œæ˜¯åœ¨å­æŸ¥è©¢ &lt;code>(select user_id, count(distinct orders.id) as order_count&lt;/code> ä¸å¯é¿å…çš„è¦è·‘ä¸€æ¬¡å…¨è¡¨æœå°‹ï¼Œä½†æ˜¯æš«å­˜æˆ temp TableåšINNER JOIN åˆæœƒåœ¨è·‘ä¸€æ¬¡ï¼Œç­‰åŒæ–¼å…¨è¡¨æœå°‹ orderså…©æ¬¡&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__Jeto7u4zaq9XDJ3fwSppRw.jpeg"
loading="lazy"
alt="1"
>
1&lt;/p>
&lt;p>ç‚ºäº†é¿å…å¤šä¸€æ¬¡ç„¡è¬‚çš„å…¨è¡¨æœå°‹ï¼Œå…ˆJOINåœ¨ GROUP BY æ•ˆç‡å°±å¥½å¾ˆå¤šã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__yMDa4b2rpLrDLnY26N19ZQ.jpeg"
loading="lazy"
alt="2"
>
2&lt;/p></description></item><item><title>DNSSEC åŸºæœ¬åŸç†ä»‹ç´¹</title><link>https://yuanchieh.page/posts/2018/2018-07-30-dnssec-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%BB%8B%E7%B4%B9/</link><pubDate>Mon, 30 Jul 2018 10:14:21 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-07-30-dnssec-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%BB%8B%E7%B4%B9/</guid><description>&lt;p>å‰é™£å­åœ¨çœ‹ Cloudflareä¸€äº›ç›¸é—œè¨­å®šï¼Œå‰›å¥½çœ‹åˆ° DNSSECé€™å€‹æŠ€è¡“åè©ï¼Œä»¥ä¸‹æ˜¯èªè­˜å¾Œçš„ç­†è¨˜ã€‚&lt;/p>
&lt;p>åƒè€ƒè³‡æ–™ï¼š&lt;br>
&lt;a class="link" href="https://www.cloudflare.com/dns/dnssec/how-dnssec-works/" target="_blank" rel="noopener"
>https://www.cloudflare.com/dns/dnssec/how-dnssec-works/&lt;/a>Â &lt;br>
&lt;a class="link" href="http://www.cc.ntu.edu.tw/chinese/epaper/0022/20120920_2206.html" target="_blank" rel="noopener"
>http://www.cc.ntu.edu.tw/chinese/epaper/0022/20120920_2206.html&lt;/a>&lt;/p>
&lt;h3 id="dnsèˆ‡dnssec">DNSèˆ‡DNSSEC&lt;/h3>
&lt;p>DNSï¼ŒåŸŸåç³»çµ±ï¼Œç”¨ä¾†å°‡äººé¡å¥½è¨˜æ†¶çš„æ–‡å­—åŸŸåè½‰æ›ç‚º ipä½ç½®ï¼Œå°±å¥½åƒé›»è…¦ä¸–ç•Œçš„é›»è©±ç°¿ä¸€èˆ¬ï¼›&lt;br>
ä½†æ˜¯DNSæœ€å¤§å•é¡Œåœ¨æ–¼ï¼Œå–å¾—ç´€éŒ„å¾Œå»æ²’æœ‰é©—è­‰ç´€éŒ„æ˜¯å¦æ­£ç¢ºæˆ–æ˜¯è¢«ç«„æ”¹çš„æ–¹æ³•ï¼Œé€™ä¹Ÿæ˜¯ DNSSEC(Domain Name System Security Extensions) çš„å‡ºç¾ã€‚&lt;/p>
&lt;h3 id="æ•¸ä½ç°½ç« ">æ•¸ä½ç°½ç« &lt;/h3>
&lt;p>DNSSECæ˜¯é€éæ•¸ä½ç°½ç« çš„æ–¹å¼ï¼Œç¢ºä¿DNSæŸ¥è©¢çš„ç´€éŒ„æ²’æœ‰è¢«ç«„æ”¹ï¼Œæ‰€ä»¥å…ˆä¾†ç°¡å–®ä»‹ç´¹ä»€éº¼æ˜¯æ•¸ä½ç°½ç« ã€‚&lt;/p>
&lt;p>ç°½ç« ï¼Œæ˜¯ç‚ºäº†ç¢ºä¿æ¶ˆæ¯&lt;code>ä¸è¢«ç«„æ”¹æ€§&lt;/code>èˆ‡&lt;code>ä¸å¯èª£è³´æ€§&lt;/code> ï¼Œåƒæ˜¯å¥‘ç´„è¦ä¸€è©¦å…©ä»½ï¼Œé›™æ–¹ç¢ºèªå¥½å…§å®¹ï¼Œæœ€çµ‚ç°½å­—ç•«æŠ¼ï¼›&lt;br>
å‡è¨­æŸå¤©ç”²æ–¹ç«„æ”¹äº†å¥‘ç´„å…§å®¹ï¼Œä¹™æ–¹å¯ä»¥æ‹¿å‡ºç•¶åˆä¿ç•™çš„å¥‘ç´„åé§ï¼›&lt;br>
åˆæˆ–æ˜¯ä¹™æ–¹æƒ³è¦å¦èªå¥‘ç´„ï¼Œä½†æ˜¯ç”²æ–¹åŒæ¨£å¯ä»¥æ‹¿å‡ºå¥‘ç´„ä¸­çš„ä¹™æ–¹ç°½ç« è­‰æ˜ã€‚&lt;/p>
&lt;p>ç”² &amp;ndash;&amp;gt; è‡ªå·±ç”¢ç”Ÿå…¬é‘°èˆ‡ç§é‘°ï¼Œå…¬é‘°å¯ä»¥è®“æ‰€æœ‰äººå–å¾—ï¼Œç§é‘°è¦ä¿è­·å¥½&lt;br>
ä»Šå¤©ç”²è¦çµ¦ä¹™ä¸€ä»½æ–‡ä»¶ Docï¼Œç‚ºäº†æ¯”å°ç”¨ hashç”¢ç”Ÿé›œæ¹Šå€¼H&lt;br>
æ¥è‘—ç”²å°‡é›œæ¹Šå€¼Hç”¨ç§é‘°åŠ å¯†æˆ H_encryptedï¼ŒH_encrypted ä¹Ÿå°±æ˜¯æ•¸ä½ç°½ç« &lt;/p>
&lt;p>ç”²å°‡ {Doc,H_encrypted} äº¤ç”±ä¸™è½‰äº¤çµ¦ä¹™ï¼Œæ­¤æ™‚ä¸™å·æ”¹äº† Doc&lt;/p>
&lt;p>ä¹™æ”¶åˆ°å¾Œï¼Œå°‡ Docä¾ç…§ç´„å®šçš„hashç”¢ç”Ÿå‡ºé›œæ¹Šå€¼ H&amp;rsquo;&lt;br>
æ¥è‘—ç”¨ç”²çš„å…¬é‘°è§£é–‹ H_encrypted =&amp;gt; Hï¼Œç™¼ç¾H&amp;rsquo; != Hï¼Œç™¼ç¾å…§å®¹è¢«ç«„æ”¹äº†ï¼&lt;/p>
&lt;p>-&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;ndash;&lt;br>
å‡è¨­å‰›æ‰ Docæ²’æœ‰è¢«ç«„æ”¹ï¼Œä¹™æ–¹é©—è­‰ä¸¦ç¢ºèªæ”¶åˆ°ç”²å‚³éçš„è¨Šæ¯&lt;br>
ä½†æ˜¯æŸæ—¥ç”²æƒ³è¦åæ‚”èªªæ²’æœ‰ç°½ç½²éè©²ä»½åˆç´„&lt;/p>
&lt;p>æ­¤æ™‚ä¹™ä¸€æ¨£æ‹¿ç”²çš„å…¬é‘°è§£å¯†æ•¸ä½ç°½ç« ï¼Œæ¥è‘—æ¯”å° Docé€éhashçš„é›œæ¹Šå€¼ï¼Œç™¼ç¾æ˜¯ä¸€æ¨£çš„ï¼Œå› ç‚ºå…¬é‘°/ç§é‘°æ˜¯ç¨ä¸€ç„¡äºŒ(éå¸¸é›£ç¢°æ’)ï¼Œåªæœ‰å…¬é‘°å¯ä»¥è§£é–‹ç§é‘°åŠ å¯†çš„å…§å®¹(åä¹‹äº¦ç„¶)ï¼Œæ‰€ä»¥ç¯¤å®š Docæ˜¯ç”²ç°½ç½²çš„ã€‚&lt;/p>
&lt;h3 id="dnssec">DNSSEC&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__4__CbpPL7m9ELFi__qNmM7__w.jpeg"
loading="lazy"
alt="æˆªåœ–è‡ª cloudflare"
>&lt;/p>
&lt;p>1.DNSç´€éŒ„æœ‰å¤šç¨®å‹åˆ¥ï¼Œå‡è¨­æ˜¯å®£å‘ŠAAAAå‹åˆ¥ï¼Œä¹Ÿå°±æ˜¯å°‡åŸŸåå°æ‡‰IPv6çš„ç´€éŒ„ï¼Œæ¯ä¸€ç­†è¨˜éŒ„ç¸®å¯«ç‚ºRRï¼›&lt;br>
è€Œåœ¨ç°½ç½²éç¨‹ï¼ŒæœƒæŠŠåŒæ¨£å‹åˆ¥çš„ç´€éŒ„æ•´åˆç‚ºä¸€çµ„ï¼Œä¹Ÿå°±æ˜¯é€™é‚Šçœ‹åˆ°çš„&lt;code>RRset&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__j6z50ztbEl__PPZrUqsR9Jw.jpeg"
loading="lazy"
alt="æˆªåœ–è‡ª cloudflare"
>&lt;/p>
&lt;p>2. æ¥è‘—å°‡RRsetç”¢ç”Ÿæ•¸ä½ç°½ç« ï¼Œä¹Ÿå°±æ˜¯RRSIGï¼Œæ¥è‘—å›è¦†DNSç´€éŒ„æ™‚ï¼Œç¸½å…±è¦çµ¦ä¸‰æ¨£æ±è¥¿&lt;br>
&lt;code>{RRset / RRSIG / Public ZSK}&lt;/code>&lt;br>
Public ZSKä¹Ÿå°±æ˜¯DNS Serverçš„å…¬é‘°ã€‚&lt;/p>
&lt;p>ç”¨æˆ¶å°±å¯ä»¥æ‹¿ Public ZSKè§£é–‹ RRSIGï¼Œæ¯”å° RRsetï¼Œå°±å¯çŸ¥é“è©²RRsetæ˜¯å¦çœŸçš„ä¾†è‡ªDNS Server&lt;/p>
&lt;h4 id="å¦‚ä½•ç¢ºä¿-public-zskæ˜¯æ²’æœ‰è¢«ç«„æ”¹">å¦‚ä½•ç¢ºä¿ Public ZSKæ˜¯æ²’æœ‰è¢«ç«„æ”¹&lt;/h4>
&lt;p>é€™åˆå¯ä»¥å¥—ç”¨æ•¸ä½ç°½ç« äº†ï¼Œå­DNS Serveræœƒå‘çˆ¶ DNS Server æäº¤ä»–çš„ Public ZSKï¼›&lt;br>
çˆ¶DNS Serverå°±ç•¶ä½œ &lt;code>{å­DNS Server â†’ Public ZSK}&lt;/code> ç•¶ä½œæ˜¯ä¸€ç­† RRSet(åˆç¨±DSï¼ŒDelegation Signer)&lt;br>
æ¥è‘—ä¸€æ¨£ç”¨è‡ªå·±çš„å…¬é‘°(Public KSK)ç°½ç½²æ•¸ä½ç°½ç« &lt;/p>
&lt;p>ä½†å•é¡Œé‚„æ˜¯åœ¨ï¼Œè¦å¦‚ä½•åœ¨ç¢ºä¿ Public KSKæ˜¯æ­£ç¢ºçš„å‘¢ï¼Ÿ&lt;br>
é€™æœƒç„¡é™éè¿´æ•¸ä½ç°½ç« ç›´åˆ° DNS Root Serverï¼Œé€™ä¹Ÿæ˜¯ä¿¡ä»»éŠ(Chain of Trust)ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__iHfEalyeh8GUT__lt8uGfHw.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>æœ‰èˆˆè¶£çœ‹dnsè§£ææœƒèµ°éäº›è·¯å¾‘å¯ä»¥ç”¨ä¸‹åˆ—å·¥å…·ï¼Œåƒæ˜¯ google.comï¼Œæœƒå…ˆåˆ° root dns server -&amp;gt;Â .com dns server -&amp;gt; google.com dns server -&amp;gt; return AA record&lt;/p>
&lt;p>&lt;a class="link" href="https://simpledns.com/lookup-dg" target="_blank" rel="noopener"
>&lt;strong>Trace DNS Delegation&lt;/strong>&lt;/a>&lt;/p>
&lt;h4 id="é‚£æˆ‘å€‘å¯ä»¥å…¨ç›¤ç›¸ä¿¡-rootserverå—">é‚£æˆ‘å€‘å¯ä»¥å…¨ç›¤ç›¸ä¿¡ RootÂ Serverå—?&lt;/h4>
&lt;p>é€™ç¯‡æ–‡ç« èªªæ˜äº†æ•´å€‹Root Serveråœ¨ç™¼å¸ƒå…¬é‘°/ç§é‘°çš„åš´è¬¹æ€§ï¼Œé ‚ç´šåŸŸåå•†(.com,Â .edu,Â .orgÂ â€¦)ä»–å€‘çš„å°ˆæ¥­ç¶­è­·æ•´å€‹ç¶²è·¯å®‰å…¨çš„å¯é æ€§èˆ‡å¯ä¿¡åº¦ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cloudflare.com/dns/dnssec/root-signing-ceremony/" target="_blank" rel="noopener"
>&lt;strong>The DNSSEC Root Signing Ceremony | Cloudflare&lt;/strong>&lt;/a>&lt;/p></description></item><item><title>ç‚ºä»€éº¼è¦ç†è§£ Nodejs Event Loopï¼šDataloader æºç¢¼è§£è®€èˆ‡åˆ†æå¦‚ä½•è§£æ±º Graphql N+1å•é¡Œ</title><link>https://yuanchieh.page/posts/2018/2018-07-16-%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E7%90%86%E8%A7%A3-nodejs-event-loopdataloader-%E6%BA%90%E7%A2%BC%E8%A7%A3%E8%AE%80%E8%88%87%E5%88%86%E6%9E%90%E5%A6%82%E4%BD%95%E8%A7%A3%E6%B1%BA-graphql-n-1%E5%95%8F%E9%A1%8C/</link><pubDate>Mon, 16 Jul 2018 12:35:50 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-07-16-%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E7%90%86%E8%A7%A3-nodejs-event-loopdataloader-%E6%BA%90%E7%A2%BC%E8%A7%A3%E8%AE%80%E8%88%87%E5%88%86%E6%9E%90%E5%A6%82%E4%BD%95%E8%A7%A3%E6%B1%BA-graphql-n-1%E5%95%8F%E9%A1%8C/</guid><description>&lt;p>Nodejsåº•å±¤æ˜¯äº‹ä»¶é©…å‹•ï¼Œé€é Event Loopè™•ç†éåŒæ­¥(non-blocking)æ“ä½œï¼Œè®“è²»æ™‚çš„I/Oæ“ä½œå¯ä»¥äº¤ç”±libuvå»å‘¼å«ç³»çµ±äº‹ä»¶é©…å‹•çš„ system apiæˆ–æ˜¯ç”¨ multi threadæ–¹å¼è™•ç†ï¼Œè€ŒMain threadå‰‡æŒçºŒè™•ç†requestæˆ–å…¶ä»–é‹ç®—ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">// copy from nodejs å®˜ç¶² â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€&amp;gt;â”‚ timers â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚ pending callbacks â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚ idle, prepare â”‚ (internal use)â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ incoming: â”‚â”‚ â”‚ poll â”‚&lt;span class="err">&amp;lt;&lt;/span>â”€â”€â”€â”€â”€â”¤ connections, â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ data, etc. â”‚â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚ check â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â””â”€â”€â”¤ close callbacks â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°¡è€Œè¨€ä¹‹ï¼ŒEvent Loopæœ‰è¨±å¤šä¸åŒçš„éšæ®µ(phase)ï¼Œæ¯å€‹phase æ˜¯å€‹é™£åˆ—ï¼Œç•¶å®ŒæˆéåŒæ­¥æ“ä½œå¾Œï¼Œæœƒå°æ‡‰å°‡ callback task pushåˆ° phaseä¸­ï¼›&lt;br>
Nodejsæœƒä¸æ–·çš„è¼ªè©¢ Event Loopä¸¦&lt;code>åŒæ­¥åŸ·è¡Œcallback task&lt;/code>ï¼Œç›´åˆ° Event Loopä¸Šéƒ½æ²’æœ‰ taskä¸” Main threadä¹Ÿéƒ½åŸ·è¡Œå®Œæˆï¼Œå°±æœƒé€€å‡ºã€‚&lt;/p>
&lt;p>Nodejsä¸€äº›éåŒæ­¥æ“ä½œå°æ‡‰çš„ phaseå¦‚ä¸‹&lt;br>
1.&lt;code>setTimeout&lt;/code> å±¬æ–¼ timersÂ &lt;br>
2. &lt;code>pending callbacks&lt;/code>ä¸»è¦è™•ç†ç³»çµ±éŒ¯èª¤ callback&lt;br>
3. poll éšæ®µå‰‡æ˜¯å‘ç³»çµ±å–å¾— IOäº‹ä»¶&lt;br>
4.&lt;code>setImmediate&lt;/code> å±¬æ–¼ check&lt;br>
5.&lt;code>é—œé–‰äº‹ä»¶å¦‚ socket.on(â€˜closeâ€™,Â â€¦)&lt;/code> å‰‡å±¬æ–¼ close&lt;/p>
&lt;p>&lt;code>process.nextTick&lt;/code> æ˜¯åœ¨æ¯å€‹phaseçµæŸå‰åŸ·è¡Œï¼Œ &lt;code>Promise&lt;/code> å±¬æ–¼ microtaskï¼ŒåŒæ¨£åŸ·è¡Œæ–¼æ¯å€‹phaseçµæŸä¹‹å‰ï¼Œä¸”åœ¨ process.nextTickä¹‹å‰ï¼›&lt;br>
æ‰€ä»¥è¦å°å¿ƒï¼Œä¸èƒ½è¦éè¿´å‘¼å«process.nextTickï¼Œæœƒå°è‡´æ•´å€‹Event Loopå¡ä½ï¼Œå› ç‚ºæ¯å€‹process.nextTickéƒ½æœƒåœ¨phaseçµæŸå‰åŸ·è¡Œã€‚&lt;/p>
&lt;p>ä»¥ä¸Šå¤§è‡´ä»‹ç´¹ï¼Œå¯¦éš›é‹ä½œè¤‡é›œè¨±å¤šï¼Œé™„è¨»åƒè€ƒè³‡æ–™ï¼š&lt;br>
1. &lt;a class="link" href="https://www.eebreakdown.com/2016/09/nodejs-eventemitter.html" target="_blank" rel="noopener"
>https://www.eebreakdown.com/2016/09/nodejs-eventemitter.html&lt;/a>&lt;br>
2. &lt;a class="link" href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener"
>https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/&lt;/a>&lt;br>
3. &lt;a class="link" href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener"
>https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/&lt;/a>&lt;br>
4. åœ¨ç€è¦½å™¨ä¸­ç‹€æ³è·ŸNodejsåŸ·è¡Œç’°å¢ƒä¸å¤ªç›¸åŒ &lt;a class="link" href="https://github.com/kaola-fed/blog/issues/234#code-analysis-b-a" target="_blank" rel="noopener"
>https://github.com/kaola-fed/blog/issues/234#code-analysis-b-a&lt;/a>&lt;/p>
&lt;p>ä½†æˆ‘çœ‹é€™å€‹æœ‰ä»€éº¼ç”¨? åªè¦æˆ‘çŸ¥é“æ€éº¼å¯«éåŒæ­¥ç¨‹å¼ç¢¼ï¼Œäº†è§£åº•å±¤ Event LoopåŸ·è¡Œé †åºæœ‰ä»€éº¼æ„ç¾©å—?&lt;/p>
&lt;p>é›–ç„¶èªªå­¸ç¿’ä¸è©²å¸¶æœ‰å¤ªå¼·çƒˆçš„åŠŸåˆ©æ€§ï¼Œè¿½æ ¹ç©¶åº•æœ¬èº«å°±æ˜¯å€‹æ¨‚è¶£ï¼Œä½†é€™å€‹å•é¡Œè‘—å¯¦å›°æ“¾æˆ‘é —ä¹…ï¼Œåœ¨é€™å…©å¤©çœ‹åˆ°äº† &lt;code>dataloader&lt;/code> é©šç‚ºå¤©äººçš„ Libraryï¼Œä»¥ä¸‹æ­£æ–‡é–‹å§‹ã€‚&lt;/p>
&lt;h2 id="dataloaderçš„ç”¨é€”">dataloaderçš„ç”¨é€”&lt;/h2>
&lt;p>dataloaderä¸»è¦ç”¨æ–¼è§£æ±ºGraphqlçš„N+1å•é¡Œï¼Œç¨å¾®ç°¡å–®ä»‹ç´¹ä¸€ä¸‹&lt;br>
Graphqlæ˜¯ FBæå‡ºçš„æŠ€è¡“ï¼Œç”¨ä¾†ç•¶ä½œæ–°ä¸€ä»£çš„å‰å¾Œç«¯APIäº¤äº’ä»‹é¢ï¼Œä¸»è¦æ˜¯å°‡æœå°‹çš„èƒ½åŠ›äº¤é‚„çµ¦å‰ç«¯æ§åˆ¶ï¼Œå¾Œç«¯å°±è¢«å‹•é…åˆï¼›&lt;br>
æ”¹å–„ä»¥å¾€ RESTful APIåœ¨ GETä¸Šéº»ç…©çš„åœ°æ–¹ï¼Œä»¥ä¸‹ç‚ºç¤ºç¯„&lt;/p>
&lt;p>å‡è¨­æœ‰ User / Post / Commentï¼Œ&lt;br>
User 1 &amp;lt;-&amp;gt; m Postï¼ŒUserå¯ä»¥å‰µå»ºå¤šå€‹Post&lt;br>
User 1 &amp;lt;-&amp;gt; n Comment m &amp;lt;-&amp;gt; 1 Postï¼ŒUserå¯ä»¥åœ¨Postä¸‹ç™¼å¸ƒ Comment&lt;/p>
&lt;p>å‡è¨­ä»Šå¤©æˆ‘å€‘è¦é¡¯ç¤ºæŸç”¨æˆ¶çš„æ‰€æœ‰è²¼æ–‡ï¼Œä»¥RESTä¾†è¬›å¯èƒ½æ˜¯&lt;br>
/user/:userId/post&lt;br>
å¦‚æœè¦æŸç”¨æˆ¶ä¸‹æ‰€æœ‰è²¼æ–‡å¸¶è©•è«–&lt;br>
/user/:userId/post/comment&lt;br>
å¦‚æœæ˜¯æŸç”¨æˆ¶æŸè²¼æ–‡çš„æ‰€æœ‰è©•è«–&lt;br>
/user/:userId/post/:postId/comment&lt;br>
&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>æ‰€ä»¥åœ¨æŸ¥è©¢ä¸Šï¼Œå‰ç«¯å¤šä¸€å€‹éœ€æ±‚å¾Œç«¯å°±è¦å¤šä¸€éš»APIï¼Œæœ‰é»éº»ç…©&lt;br>
å¦‚æœè¦çœè‘—ç”¨åŒä¸€å€‹APIå¤–åŠ queryä¾†åˆ¤æ–·ï¼Œå°±è®Šæˆè³‡æ–™å±¤æˆ–é‚è¼¯å±¤ä¸€æ¨£è¦è™•ç†&lt;/p>
&lt;p>-&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-&lt;br>
è€ŒGraphql å‰‡æ¼‚äº®å¾ˆå¤šï¼Œå‰ç«¯å®šç¾©å¥½éœ€è¦çš„è³‡æ–™æ ¼å¼ï¼Œå¾Œç«¯å°±æœƒå°ç…§å›å‚³(å¥—ä»¶è¼”åŠ©)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-graphql" data-lang="graphql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">User&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">Post&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">title&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">Comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">content&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">User&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">......&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸è«–æ˜¯è¦å–å¾— Userï¼ŒUser -&amp;gt; Postï¼Œ User -&amp;gt; Post -&amp;gt; Commentç„¡é™éè¿´ï¼Œéƒ½æ˜¯éå¸¸ç°¡å–®çš„ä¸€ä»¶äº‹&lt;/p>
&lt;p>å¾Œç«¯å‰‡æ˜¯å°æ‡‰å¥½è³‡æ–™æ“·å–ï¼ŒGraphqlåœ¨å¾Œç«¯æœƒéæ¿¾æŠŠå‰ç«¯éœ€è¦çš„æ¬„ä½å›å‚³ï¼Œå¤§å¹…é™ä½ç¶²è·¯ payloadï¼Œéå¸¸çš„ç°¡æ½”æœ‰åŠ›ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯æœ‰å¤§é‡æŸ¥è©¢çš„æ‡‰ç”¨ç¨‹å¼ï¼Œæˆ–æ˜¯æœ‰è·¨è£ç½®æ‡‰ç”¨ï¼Œå¯ä»¥è€ƒæ…®å°å…¥ Graphqlï¼Œç¾åœ¨ä¾†èªªæ–¹æ¡ˆéƒ½å·²ç¶“éå¸¸æˆç†Ÿäº†ã€‚&lt;/p>
&lt;h3 id="graphql-n1å•é¡Œ">Graphql N+1å•é¡Œ&lt;/h3>
&lt;p>ä½†æ˜¯åœ¨è®€å–å·¢ç‹€è³‡æ–™çš„éç¨‹ä¸­ï¼ŒGraphqlæœƒç™¼ç”ŸN+1å•é¡Œï¼Œä¾‹å¦‚å–å¾—æ‰€æœ‰ç”¨æˆ¶ä¸‹çš„æ‰€æœ‰æ–‡ç« &lt;code>{User{Post}}&lt;/code> ï¼Œé€™æ™‚å€™å› ç‚ºæ¶æ§‹è¨­è¨ˆçš„é—œä¿‚ï¼ŒGraphqlæœƒå…ˆè®€å–æ‰€æœ‰çš„Userï¼Œæ¥è‘—å†é‡å°å€‹åˆ¥Userå»è®€å–Postï¼›&lt;br>
æ‰€ä»¥è³‡æ–™åº«è®€å–æœƒè®Šæˆ 1 æ¬¡è®€å–å…¨éƒ¨ User + Næ¬¡å€‹åˆ¥Userè®€å–Postï¼Œä¾‹å¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">SELECT \* FROM User; --&amp;gt; å›å‚³äº† [1,2,3,4]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT \* FROM Post WHERE user_id = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT \* FROM Post WHERE user_id = 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">\---&amp;gt; è¼ƒç‚ºç†æƒ³æƒ…æ³
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT \* FROM User; --&amp;gt; å›å‚³äº† [1,2,3,4]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT \* FROM Post WHERE user_id in (1,2,3,4);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">\---&amp;gt; æœ€ç†æƒ³
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT \* FROM User LEFT JOIN Post on Post.userId = User.id;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œdataloaderæä¾›çš„è§£æ³•ç›¸ç•¶ç¾å¦™ï¼Œåœ¨æ‡‰ç”¨å±¤ç¨ä½œæ”¹è®Šï¼Œä¸å½±éŸ¿åŸæœ¬graphql / ä¸å¹²æ¶‰è³‡æ–™åº«æ“ä½œï¼Œå°‡ N+1é€²åŒ–æˆç¬¬äºŒå„ªåŒ–çš„æŸ¥è©¢æ¢ä»¶ã€‚&lt;/p>
&lt;h3 id="dataloader-ä»‹ç´¹">dataloader ä»‹ç´¹&lt;/h3>
&lt;p>dataloaderä½œè€…&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/facebook/dataloader" target="_blank" rel="noopener"
>dataloader&lt;/a> ä¸»è¦åšå…©ä»¶äº‹ &lt;code>batch&lt;/code> &amp;amp; &lt;code>cache&lt;/code> ï¼Œå› ç‚ºåœ¨è™•ç† http requestä¸Šï¼Œç‚ºäº†ä¸Šè³‡æ–™ä¸éæœŸï¼Œå¤§å¤šä¸æœƒç”¨ä¸Š cacheï¼Œæ‰€ä»¥é€™è£¡åƒ…ä»‹ç´¹ batchã€‚&lt;br>
dataloaderæä¾›çš„è§£æ³•æ˜¯å°‡ç•°æ­¥æ“ä½œåˆä½µï¼Œä¸¦åœ¨Event Loopçš„ä¸€å€‹phaseçµæŸå¾Œç”¨ process.nextTick åŸ·è¡Œã€‚&lt;/p>
&lt;p>å…ˆçœ‹dataloaderèªªæ˜ç¯„ä¾‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">DataLoader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;dataloader&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">userLoader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">DataLoader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">myBatchGetUsers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">myBatchGetUsersæ˜¯è‡ªè¨‚çš„å‡½å¼ï¼Œæ¥æ”¶è¢«dataloader batchèµ·ä¾†çš„keysï¼Œå›å‚³ç­‰åŒkeysé•·åº¦çš„Promise
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">userLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">user&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">userLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">invitedByID&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">invitedBy&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`User 1 was invited by &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">invitedBy&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Elsewhere in your application
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">userLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">user&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">userLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lastInvitedID&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lastInvited&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> User 2 last invited $ {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> lastInvited
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> `&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">userLoader.load(1) ä»£è¡¨è¦è¼‰å…¥ï¼Œé€™æœƒè¢« dataloader batchèµ·ä¾†ï¼Œæœ€å¾Œå†keys =&amp;gt; myBatchGetUsers(keys)ä¸€ä½µè™•ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ¥è‘—ä¾†çœ‹ç¨‹å¼ç¢¼ï¼Œç¸½å…±324è¡Œï¼Œå¤§æ¦‚æœ‰100è¡Œæ˜¯è¨»è§£â€¦ éå¸¸ç²¾ç°¡å·§å¦™çš„è¨­è¨ˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">K&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nb">Promise&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">V&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">promise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reject&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Enqueue this Promise to be dispatched.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resolve&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reject&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åœ¨queue é‡æ–°å¡«è£æ™‚è§¸ç™¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">shouldBatch&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// If batching, schedule a task to dispatch the queue.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">enqueuePostPromiseJob&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">dispatchQueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Otherwise dispatch the (queue of one) immediately.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">dispatchQueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">promise&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>load()åŸ·è¡Œå¾Œæ˜¯å›å‚³ä¸€å€‹Promiseï¼Œæ³¨æ„é—œéµçš„ä¸€è¡Œ &lt;code>this._queue.push({...})&lt;/code> ï¼Œé€™å€‹å›å‚³çš„Promise resolveæ–¹æ³•æ˜¯è¢«pushåˆ° _queueä¸Šï¼Œè€Œ_queueæ˜¯ dataloaderä¸€é–‹å§‹å‰µå»ºæ™‚å»ºç«‹çš„ç©ºé™£åˆ—ã€‚&lt;/p>
&lt;h4 id="enqueuepostpromisejob">enqueuePostPromiseJob&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">enqueuePostPromiseJob&lt;/span> &lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">process&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;object&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">typeof&lt;/span> &lt;span class="nx">process&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nextTick&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;function&amp;#39;&lt;/span> &lt;span class="o">?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nx">resolvedPromise&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resolvedPromise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resolvedPromise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">process&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nextTick&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setImmediate&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Private: cached resolved Promise instance
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">resolvedPromise&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>resolvedPromiseå°±æ˜¯ç”¨ä¾†æš«å­˜çš„ Promise.resolve()ï¼Œç”¨ä¾†åŸ·è¡Œ&lt;code>resolvedPromise.then(() =&amp;gt; process.nextTick(fn))&lt;/code> ï¼Œfn æ˜¯å‰›æ‰çš„ &lt;code>() =&amp;gt; dispatchQueue(this)&lt;/code> ï¼›&lt;br>
å¦‚æœç’°å¢ƒæœ‰ process.nextTickå‰‡ç”¨ï¼Œä¸ç„¶ç”¨ setImmediate / setTimeout ä¹Ÿå¯ä»¥!&lt;/p>
&lt;p>é€™è£¡ä½œè€…æ‰“ä¸Šäº†25è¡Œçš„è¨»è§£ï¼Œå¤§æ„æ˜¯èªªï¼š&lt;br>
ECMAScript é‹ç”¨ Job / Job Queueæè¿°ç•¶ä¸‹åŸ·è¡ŒçµæŸå¾Œçš„å·¥ä½œé †åºå®‰æ’ï¼›&lt;br>
(å°ç…§Nodejsä¹Ÿå°±æ˜¯Event Loopçš„å¯¦ä½œ)ï¼ŒNodejsç”¨ process.nextTickå¯¦ä½œ Jobçš„æ¦‚å¿µï¼Œç•¶å‘¼å«äº† Promise.then å‰‡æœƒåœ¨ global Jobsqueueä¸­åŠ å…¥ PromiseJobsé€™æ¨£çš„ä¸€å€‹ Jobã€‚&lt;/p>
&lt;p>dataloaderæœƒæ‰“åŒ…åŒä¸€å€‹åŸ·è¡Œçš„å¹€(frame) ä¸­çš„æ“ä½œï¼ŒåŒ…å«åœ¨è™•ç†PromiseJobs queues ä¹‹é–“çš„ loadä¹Ÿæœƒè¢«ä¸€ä½µæ‰“åŒ…ã€‚&lt;br>
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼è¦ç”¨&lt;code>resolvedPromise.then(() =&amp;gt; process.nextTick(fn))&lt;/code> ï¼Œç¢ºä¿åœ¨æ‰€æœ‰çš„ PromiseJobsä¹‹å¾ŒåŸ·è¡Œ (*å‚™è¨»ä¸€)ï¼›&lt;/p>
&lt;p>é€™ä¸€æ®µä¸»è¦æ˜¯å› æ‡‰cacheè™•ç†ï¼Œå¦‚æœæœ‰é–‹å•Ÿcacheï¼ŒåŸ·è¡Œéå¾Œä¸€æ¬¡dataloaderæœƒä»¥ Promise.resolveå„²å­˜çµæœï¼Œä¹Ÿå°±æ˜¯å¾ŒçºŒä¸ç®¡èª¿ç”¨å¹¾æ¬¡éƒ½æ˜¯ç«‹åˆ»å›è¦†çµæœï¼›&lt;br>
æ‰€ä»¥ä¸‹åˆ—çµæœ 1 / 5 /6 æœƒè¢«batchåœ¨åŒä¸€å€‹phaseåŸ·è¡Œï¼Œè€Œ4æœƒåˆ°ä¸‹ä¸€å€‹loopå»&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">testLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;1 got &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">testLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">testLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">testLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œç€è¦½å™¨æ²’æœ‰å‘Nodejsä¸­æä¾› microtask(process.nextTick)ï¼Œåªèƒ½ç”¨ macrotask(setImmediate / setTimeout)å–ä»£ï¼Œä½†æœƒæœ‰æ€§èƒ½ä¸Šçš„å½±éŸ¿ã€‚&lt;/p>
&lt;h3 id="dispatchqueuebatch">dispatchQueueBatch&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">keys&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">(({&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="p">})&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">batchPromise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">batchLoadFn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">batchPromise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">values&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">forEach&lt;/span>&lt;span class="p">(({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resolve&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reject&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">values&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>dispatchQueue&lt;/code> å¤šåšä¸€äº›åˆ¤æ–·ï¼Œæœ€å¾Œå‘¼å«dispatchQueueBatchï¼›&lt;br>
åœ¨æ­¤è™•å–å‡ºæ‰€æœ‰ä½”å­˜åœ¨queueä¸Šçš„keysï¼Œä¸¦å‘¼å«batchLoadFnï¼Œä¹Ÿå°±æ˜¯åœ¨ new &lt;code>Dataloader((keys)=&amp;gt;{â€¦})&lt;/code> æ‰€å®šç¾©çš„ï¼ŒåŸ·è¡Œå¾Œå°±å°æ‡‰queueä¸Šçš„ resolveï¼Œä¹Ÿå°±æ˜¯æŠŠå€¼å›å‚³çµ¦ &lt;code>userLoader.load(k).then(value =&amp;gt;Â â€¦.)&lt;/code> åšå¾ŒçºŒçš„è™•ç†ã€‚&lt;/p>
&lt;p>ç¸½çµä¸€ä¸‹ï¼Œè¦ä½¿ç”¨æ™‚å…ˆå»ºç«‹ dataloaderï¼Œä¸¦æ±ºå®šå°æ‡‰çš„ batch loaderè©²å¦‚ä½•è™•ç†ï¼Œé€šå¸¸å°±æ˜¯æ”¾è³‡æ–™åº« batchè™•ç† &lt;code>new Dataloader((keys) =&amp;gt; customBatchLoader(keys))&lt;/code> ï¼›&lt;br>
æ¥è‘—å®šç¾©æ“ä½œï¼Œ &lt;code>loader.load(key).then(value =&amp;gt; {})&lt;/code> ï¼›&lt;br>
dataloaderå…§éƒ¨é€é &lt;code>enqueuePostPromiseJob&lt;/code> æ©Ÿåˆ¶ï¼Œå°‡ä¸€å€‹åŸ·è¡Œå¹€å…§å®šç¾©çš„æ“ä½œéƒ½åŒ¯é›†èµ·ä¾†ï¼Œä¸¦åœ¨ Event Loop phaseæœ€å¾ŒåŸ·è¡Œï¼›&lt;br>
æœ€å¾Œå…§éƒ¨å‘¼å« &lt;code>dispatchQueueBatch&lt;/code> ï¼Œä¹Ÿå°±æ˜¯å¯¦éš›èª¿ç”¨ &lt;code>customBatchLoader&lt;/code> çš„åœ°æ–¹ï¼Œæœ€å¾Œ resolve ç•¶åˆå®£å‘Šçš„ &lt;code>loader.load()&lt;/code> ã€‚&lt;/p>
&lt;h4 id="dataloaderç°¡å–®ç¯„ä¾‹">dataloaderç°¡å–®ç¯„ä¾‹&lt;/h4>
&lt;p>æ‰“å°çµæœï¼Œæ³¨æ„ setTimeoutæœƒåœ¨ä¸‹ä¸€å€‹loopåŸ·è¡Œï¼Œè€ŒPromise.resolve()å‰‡åœ¨åŒä¸€å€‹ phaseè¢«è™•ç†æ‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-md" data-lang="md">&lt;span class="line">&lt;span class="cl">batched by dataloader: [ 1, 2, 3, 5 ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">content: [ 1, 2, 3, 5 ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1 got 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[2,3] got [ 3, 4 ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">batched by dataloader: [ 4 ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">content: [ 4 ]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°æ‡‰æˆ‘å€‘è¦è§£æ±ºçš„N+1å•é¡Œï¼Œå› ç‚ºGraphqlæ€éº¼è™•ç†åº•å±¤å‘¼å«ç®—æ˜¯å€‹é»‘ç›’å­ï¼Œä»¥ä¸‹æ˜¯å¤§æ¦‚ç¤ºæ„&lt;/p>
&lt;p>1. åŸæœ¬Graphqlçš„ N + 1å•é¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">userList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getUsers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">post1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getPostByUserId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">post2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getPostByUserId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>2. å¦‚æœç”¨dataloaderè½‰æ›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">userList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getUsers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// postè«‹æ±‚é›†ä¸­æˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">postLoader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Dataloader&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getPostListByUserId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">all&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç…§èˆŠä¸€å€‹ä¸€å€‹å®šç¾©é‚„æ˜¯å¯ä»¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">post1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">postLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">post2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">postLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="çµèª">çµèª&lt;/h2>
&lt;p>åŸæœ¬ä»¥ç‚º N+1å•é¡Œè¦è§£æ±ºå¿…é ˆæ·±å…¥åˆ°æ”¹å¯«è³‡æ–™åº«çš„SQLï¼Œä¾‹å¦‚è½‰æˆ SELECT INï¼Œä½†æ²’æƒ³åˆ°æœ‰å€‹å¦‚æ­¤ç°¡æ½”åˆæ¼‚äº®çš„è§£æ³•ï¼Œè€Œä¸”ä¸é™å®šç”¨ä»€éº¼è³‡æ–™åº«ï¼ŒçœŸçš„æ˜¯å¤ªæ£’äº†ã€‚&lt;/p>
&lt;p>æ·±å…¥åº•å±¤ç†è§£åŸç†ï¼ŒæŠ½è±¡åˆè²»æ™‚ï¼Œä½†æˆ‘æƒ³é€™æ¨£çš„æŠ•è³‡æ˜¯å€¼å¾—çš„ï¼Œä¸ç¦å†æ¬¡æ„Ÿå˜†é€™å€‹Libraryçš„ç²¾å¦™ï¼ŒI dont know JS OTZã€‚&lt;/p>
&lt;h3 id="å‚™è¨»">å‚™è¨»&lt;/h3>
&lt;p>ç¯‡å¹…æœ‰é»é•·ï¼Œæ‰€ä»¥æŠŠä¸€äº›ç´°ç¯€æ”¾åœ¨é€™è£¡&lt;/p>
&lt;h4 id="ç¢ºä¿åœ¨æ‰€æœ‰çš„-promisejobsä¹‹å¾ŒåŸ·è¡Œ">ç¢ºä¿åœ¨æ‰€æœ‰çš„ PromiseJobsä¹‹å¾ŒåŸ·è¡Œ&lt;/h4>
&lt;p>é€™éƒ¨åˆ†è¦æ·±å…¥äº†è§£ Nodejs åŸ·è¡Œ microtaskèˆ‡macrotaskçš„é †åº&lt;/p>
&lt;p>Promise.resolve ().then (() =&amp;gt; {&lt;br>
console.log (2);&lt;br>
}).then (() =&amp;gt; {&lt;br>
console.log (9);&lt;br>
process.nextTick (() =&amp;gt; {&lt;br>
console.log (7);&lt;br>
});&lt;/p>
&lt;p>Promise.resolve ().then (() =&amp;gt; {&lt;br>
console.log (8);&lt;br>
});&lt;br>
});&lt;/p>
&lt;p>process.nextTick (() =&amp;gt; {&lt;br>
console.log (1);&lt;br>
});&lt;/p>
&lt;p>Promise.resolve ().then (() =&amp;gt; {&lt;br>
console.log (3);&lt;br>
}).then (() =&amp;gt; {&lt;br>
console.log (6);&lt;br>
});&lt;/p>
&lt;p>setImmediate (() =&amp;gt; {&lt;br>
console.log (5);&lt;br>
});&lt;/p>
&lt;p>setTimeout (() =&amp;gt; {&lt;br>
console.log (4);&lt;br>
});&lt;/p>
&lt;p>////// æ‰“å°çµæœ&lt;br>
1&lt;br>
2&lt;br>
3&lt;br>
9&lt;br>
6&lt;br>
8&lt;br>
7 &amp;ndash;&amp;gt; ç­‰åŒæ–¼ dataloader ç¬¬ä¸€æ¬¡ batchè§¸ç™¼çš„æ™‚æ©Ÿ&lt;br>
4&lt;br>
5&lt;/p>
&lt;p>é€™éƒ¨åˆ†è »æœ‰è¶£çš„ï¼Œä¸€é–‹å§‹Event Loopæœƒå…ˆå¾ nextTick queueé–‹å§‹ï¼Œæ‰€ä»¥1æœƒå…ˆæ‰“å°ï¼›&lt;br>
æ¥è‘—è™•ç† Promise.resolve()çš„ promise queueï¼Œä¹Ÿå°±æ˜¯2 3ï¼›&lt;br>
æ¥è‘— 2 3åˆ†åˆ¥åˆç¹¼çºŒå¾€å¾Œresolve 9 6ï¼›&lt;br>
8ä¹‹æ‰€ä»¥åœ¨7ä¹‹å‰æ˜¯å› ç‚º Nodejsæ­¤æ™‚å†è™•ç† promise queueï¼Œæ‰€ä»¥æœƒå„ªå…ˆè™•ç†promiseï¼Œè™•ç†å®Œæˆå¾Œæ‰æœƒå†è™•ç† nexttickï¼›&lt;br>
ç­‰ microtaskéƒ½è™•ç†å®Œï¼Œæ‰æœƒé€²åˆ°å…¶ä»–timer phaseèˆ‡å¾ŒçºŒçš„phaseè™•ç†ã€‚&lt;/p>
&lt;p>é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼&lt;code>enqueuePostPromiseJob&lt;/code> è¦ç”¨ &lt;code>promise.resolve(()=&amp;gt;process.nextTick(()=&amp;gt;dispatchQueue(this)))&lt;/code> ï¼Œå°æ‡‰å¦‚æœ Promise.resolve().then().then() ä¸­çš„ Promiseéƒ½æ˜¯ resolveäº†å°±æœƒè‡ªå‹•åœ¨åŒä¸€å€‹ batchè™•ç†ï¼Œå°å°ä¹Ÿå°±æ˜¯æ‰“å° &lt;code>7&lt;/code> çš„ä½ç½®ã€‚&lt;br>
å¦‚æœé–‹å•Ÿäº† dataloader cacheï¼Œdataloader æ˜¯ç›´æ¥å„²å­˜ resolved promiseï¼Œæ€§èƒ½æœƒæœ‰é¡¯è‘—çš„æå‡ã€‚&lt;/p></description></item><item><title>HTTPSä¸ä»£è¡¨å®‰å…¨ï¼šCloudflare SSL ç ”ç©¶å¾Serveråˆ°Cloudflare</title><link>https://yuanchieh.page/posts/2018/2018-07-11-https%E4%B8%8D%E4%BB%A3%E8%A1%A8%E5%AE%89%E5%85%A8cloudflare-ssl-%E7%A0%94%E7%A9%B6%E5%BE%9Eserver%E5%88%B0cloudflare/</link><pubDate>Wed, 11 Jul 2018 01:37:07 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-07-11-https%E4%B8%8D%E4%BB%A3%E8%A1%A8%E5%AE%89%E5%85%A8cloudflare-ssl-%E7%A0%94%E7%A9%B6%E5%BE%9Eserver%E5%88%B0cloudflare/</guid><description>&lt;p>ç¶²é ç€è¦½æ™‚å‡ºç¾HTTPSçš„ç¶ è‰²é–çœ‹äº†ä»¤äººæ”¾å¿ƒï¼Œé€™ä¼¼ä¹ä»£è¡¨è‘—æˆ‘å€‘åœ¨ç¶²ç«™ç€è¦½çš„è³‡æ–™æœ‰å—åˆ°ã€Œå®Œæ•´çš„åŠ å¯†ä¿è­·ã€ï¼Œä¸ç”¨æ“”å¿ƒè³‡æ–™è¢«å·çªºèˆ‡è¢«èª¿åŒ…ç­‰ç­‰MitMä¸­é–“äººæ”»æ“Šçš„é¢¨éšªï¼Œä½†äº‹å¯¦ç•¶ç„¶æ²’æœ‰é€™éº¼ç°¡å–®ã€‚&lt;/p>
&lt;p>åœ¨ç”³è«‹SSLæ†‘è­‰æ™‚æ˜¯ç¶å®šåŸŸåç”³è«‹ï¼Œç†è«–ä¸Š DNSè§£æåŸŸåå¾Œç›´æ¥æŒ‡å‘Serveræ‰€åœ¨IPï¼Œä¹Ÿå°±æ˜¯Clienté€éHTTPSåœ¨ç´¢å–æ†‘è­‰ã€é©—è­‰æ†‘è­‰ã€èˆ‡ Serverå…±åŒç”Ÿæˆå°ç¨±åŠ å¯†é‡‘é‘°å¾Œï¼Œå¯¦éš›å°‡è³‡æ–™åŠ å¯†å‚³è¼¸åˆ°Serverçš„æ•´æ®µç¶²è·¯éç¨‹æ˜¯å—åˆ°å®Œæ•´çš„ä¿è­·ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ç¾åœ¨å¾ˆå¤šç¶²ç«™ç‚ºäº†æ•ˆèƒ½ä¸Šèˆ‡å®‰å…¨æ€§ä¸Šçš„è€ƒé‡ï¼Œæ¡ç”¨äº†å‘ Cloudflareé€™æ¨£çš„ DNSä»£ç®¡ / CDNæœå‹™ï¼›&lt;br>
&lt;code>Client â† â†’ Cloudflare â† â†’ Server&lt;/code>&lt;/p>
&lt;p>Cloudflareåœ¨å…¨çƒå„å¤§æ´²éƒ¨ç½²å¤šå€‹è³‡æ–™ä¸­å¿ƒï¼Œæœƒè‡ªå‹•å°‡DNS / Cachedè³‡æ–™æ•£ä½ˆåˆ°å¤šç¯€é»ä¸Šï¼Œä¸¦æä¾›å¤šé …å„ªè³ªæœå‹™ï¼Œå¦‚&lt;/p>
&lt;ol>
&lt;li>å¾åœ°ç†ä½ç½®æœ€è¿‘çš„ç¯€é»å›è¦† Clientæ‰€éœ€è³‡æ–™ï¼Œä¹‹å‰æ›¾çœ‹éå¯¦æ¸¬å¤šå®¶DNS/CDNæœå‹™å•†çš„è³‡æ–™ï¼ŒCloudflareå›æ‡‰é€Ÿåº¦æ˜¯æœ€å¥½çš„ï¼›&lt;/li>
&lt;li>åœ¨Cloudflareå¾Œå°è§€å¯Ÿåˆ°ç¶²ç«™æœ‰è¿‘å…«æˆçš„æµé‡æ˜¯å‘½ä¸­Cacheå¾ Cloudflareç›´æ¥å›è¦† Clientï¼Œé™ä½Server è² æ“”èˆ‡æµé‡ï¼Œå†Serverä»¥æµé‡è¨ˆè²»çš„ä¸»æ©Ÿè¨—ç®¡ä¸‹ç¯€çœå¾ˆå¤§çš„æˆæœ¬ã€‚&lt;/li>
&lt;li>DDosé˜²è­·èˆ‡ç™½/é»‘ipåå–®å»ºç«‹&lt;/li>
&lt;/ol>
&lt;p>ä½†æ˜¯æ¡ç”¨ Cloudflareæœ‰äº›è³‡å®‰ä¸Šçš„ç–‘æ…®ï¼Œä¹Ÿæ˜¯æ­¤æ¬¡ç­†è¨˜çš„å…§å®¹&lt;br>
ä¸»è¦ç´€éŒ„&lt;br>
1. æ¡ç”¨Cloudflareé¢¨éšªåœ¨å“ª&lt;br>
2. ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬&lt;/p>
&lt;h3 id="æ¡ç”¨cloudflareé¢¨éšªåœ¨å“ª">æ¡ç”¨Cloudflareé¢¨éšªåœ¨å“ª&lt;/h3>
&lt;h4 id="client--cloudflare">Client â†â†’ Cloudflare&lt;/h4>
&lt;p>å…ˆå‰æåˆ°Cloudflareæœƒæ“‹åœ¨ Clientèˆ‡ Serverä¹‹é–“ï¼Œå¦‚æœ&lt;code>å•Ÿç”¨CDNæœå‹™ç‚ºäº†è§£æç·©å­˜è³‡æ–™&lt;/code>ï¼ŒCloudflare æœƒéœ€è¦åœ¨ä»–é€™å±¤ç›´æ¥è§£å¯†ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ç”¨å…è²»ç‰ˆ Cloudflareæœƒæä¾› Universal (shared)çš„æ†‘è­‰ï¼Œé€™æ˜¯ç°½ç™¼æ–¼ Cloudflareæ©Ÿæ§‹åº•ä¸‹ï¼›&lt;br>
å¦‚æœè¦ç”¨è‡ªå·±åŸŸåç°½ç™¼çš„æ†‘è­‰ï¼Œå¿…é ˆ&lt;code>é€éCloudflareè³¼è²·&lt;/code>æˆ–æ˜¯&lt;code>ä¸Šå‚³è‡ªå·±è³¼è²·çš„æ†‘è­‰èˆ‡ç§é‘°&lt;/code> ï¼Œé€™å…©é …éƒ½å¿…é ˆæ¡ç”¨ä»˜è²»æ–¹æ¡ˆï¼›&lt;/p>
&lt;p>ä½†é€™æ¨£çœ‹ä¾† Cloudflare å°±æ˜¯æ¸¾ç„¶å¤©æˆçš„ MitMä¸­çš„ä¸­é–“äººï¼Œä½†æ˜¯æˆ‘å€‘é¸æ“‡ç›¸ä¿¡ä»–ï¼Œæœ‰çœ‹åˆ°ä¸€äº›è¬ è¨€æ˜¯èªª CloudflareèƒŒå¾Œæœ‰ç¾åœ‹çš„ NSAåœ‹å®¶å®‰å…¨å±€æŠŠæŒï¼Œæ‰€ä»¥è³‡æ–™å¯èƒ½æœ‰æ´©æ¼çš„ç–‘æ…®ï¼Œç•¢ç«Ÿ Cloudflareå¯ä»¥çœ‹åˆ°æ‰€æœ‰è§£å¯†å¾Œçš„è³‡æ–™ã€‚&lt;br>
çœ‹åˆ°ä¸€äº›è¨è«–æ˜¯åŠä¿¡åŠç–‘ï¼ŒæŠ€è¡“æ€§ä¸Šä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æµé‡éƒ½æœƒå°å‘ç¾åœ‹çš„æœå‹™å™¨ï¼Œä½†é‚„æ˜¯æœ‰å¿…è¦ç•™å€‹å¿ƒçœ¼ï¼Œç•¢ç«Ÿå…ˆå‰ä¹Ÿæ˜¯æœ‰ FBIè¦æ±‚ Apple è§£é–Iphoneçš„ç¶“æ­·ï¼Œåœ‹å®¶æ©Ÿå™¨å†è™•ç†é€™ç¨®æ³•å¾‹ã€è³‡å®‰ã€å€‹è³‡ç­‰è­°é¡Œç¢ºå¯¦è »æ™æ‰çš„ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://www.theguardian.com/technology/2016/feb/22/tim-cook-apple-refusal-unlock-iphone-fbi-civil-liberties" target="_blank" rel="noopener"
>&lt;strong>Tim Cook says Apple&amp;rsquo;s refusal to unlock iPhone for FBI is a &amp;lsquo;civil liberties&amp;rsquo; issue&lt;/strong>&lt;/a>&lt;/p>
&lt;p>(é›–ç„¶Apple åœ¨ä¸­åœ‹ä¹Ÿæœè»Ÿäº†Â :/)&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœè¦æœ‰ç·©å­˜æ©Ÿåˆ¶ä¸”éå¸¸åœ¨æ„ Client â†’ Server å¿…é ˆå…¨ç¨‹èµ°HTTPSä¸”ä½¿ç”¨è‡ªå®¶æ†‘è­‰ä¸è¢«ä»»ä½•äººåœ¨ä¸­é€”è§£å¯†è³‡æ–™ï¼Œå°±é©åˆè‡ªå»ºCache Server ä¸é©åˆç”¨Cloudflareã€‚&lt;/p>
&lt;h4 id="cloudflare-server">Cloudflare â†â†’Â Server&lt;/h4>
&lt;p>å¾Cloudflareåˆ°Serveré€™æ®µæœ‰ä¸åŒå±¤ç´šçš„è¨­å®šï¼Œå¯ä»¥æ–¼å¾Œå°è¨­å®š&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__by4l7dHy5wi__pWEzz0cl9w.jpeg"
loading="lazy"
>&lt;/p>
&lt;ol>
&lt;li>Offï¼š&lt;br>
å…¨éƒ¨èµ°HTTP&lt;/li>
&lt;li>Flexibleï¼š&lt;br>
Client â†’ Cloudflare èµ°HTTPSï¼Œè€ŒCloudflare â†’ Server èµ°HTTP&lt;/li>
&lt;li>Fullï¼š&lt;br>
Cloudflare â†’ Server èµ°HTTPSï¼Œä½†æ˜¯ Cloudflareä¸æœƒé©—è­‰æ†‘è­‰ã€‚&lt;br>
Serveréœ€è¦é–‹å•Ÿ443 port æ‰èƒ½è™•ç†ã€‚&lt;/li>
&lt;li>Full(strict)ï¼š&lt;br>
å‘ˆä¸Šï¼Œä½†æ˜¯Cloudflareæœƒå‘CAé©—è­‰æ†‘è­‰çš„æ­£ç¢ºæ€§ï¼Œé€™éƒ¨åˆ†éœ€è¦æ­é…è¨­å®š &lt;code>Origin Certificates&lt;/code> ï¼Œå¯ä»¥ç”± Cloudflare ç”¢ç”Ÿæˆ–æ˜¯è‡ªå·±ç”¢ç”Ÿå¾Œä¸Šå‚³ã€‚&lt;br>
Cloudflareæœ¬èº«ä¹Ÿæ˜¯åˆæ ¼çš„CAï¼Œæ‰€ä»¥å¾€å¥½è™•æƒ³æ˜¯ä¸Šå‚³æ†‘è­‰æ˜¯å¯ä»¥è¢«ä¿¡ä»»çš„ï¼Œä½†åŒæ¨£çš„é›è›‹éƒ½åœ¨åŒä¸€å€‹ç±ƒå­è£¡æœ¬èº«å°±æ˜¯å€‹é¢¨éšªï¼Œç®—æ˜¯ä¸€é«”å…©é¢ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬">ä¿®æ­£å•é¡Œèˆ‡å¯¦æ¸¬&lt;/h3>
&lt;p>æ‰€ä»¥é™¤äº†Clientè¦æœ‰HTTPSä¿è­·ï¼Œåœ¨Serveré€™æ®µä¹Ÿå»ºè­°è¦é–‹å•Ÿ Fullä»¥ä¸Šçš„é˜²è­·æªæ–½ï¼ŒServeréƒ¨åˆ†ç”¨ Letâ€™s Encrypt å…è²»ç°½ç½²ï¼Œä¸¦åŒæ™‚é–‹å•Ÿ 80 / 443 portï¼Œä¾†èª¿æ•´å°æ‡‰Cloudflareçš„SSLä¿è­·æªæ–½ã€‚&lt;/p>
&lt;h4 id="1-åƒ…é–‹å•Ÿ-cloudflare-dns">1. åƒ…é–‹å•Ÿ Cloudflare DNSï¼š&lt;/h4>
&lt;p>é€™æ™‚å€™æ‰“ &lt;a class="link" href="https://domain.com" target="_blank" rel="noopener"
>https://domain.com&lt;/a> æœƒå‡ºç¾è‡ªå·±ç°½ç™¼çš„æ†‘è­‰ï¼Œåƒæˆ‘æ˜¯ç”¨ Letâ€™s Encrypt ç°½ç½²çš„æ†‘è­‰&lt;/p>
&lt;h4 id="2-é–‹å•Ÿ-cloudflare-cdnæœå‹™">2. é–‹å•Ÿ Cloudflare CDNæœå‹™ï¼š&lt;/h4>
&lt;p>é€™æ™‚å€™åŒæ¨£çš„ &lt;a class="link" href="https://domain.com" target="_blank" rel="noopener"
>https://domain.com&lt;/a> æœƒè‡ªå‹•è®Šæˆ Cloudflare Universal æ†‘è­‰&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__DhAfWG__CN45Me0tMhpyb9Q.png"
loading="lazy"
>&lt;/p>
&lt;p>ä»¥ä¸Šæ˜¯ Client &amp;lt;&amp;ndash;&amp;gt; Cloudflareé€™æ®µ&lt;/p>
&lt;p>ä»¥ä¸‹ç”¨ &lt;code>&amp;gt; sudo tcpdump -nn -i eth0 'tcp and (not port 22)'&lt;/code> æŸ¥çœ‹å°åŒ…ï¼Œæ’é™¤port 22 ä¸»è¦æ˜¯é¿å… ssh å°åŒ…å¹²æ“¾è§€å¯Ÿ&lt;/p>
&lt;h4 id="3-ssl-è¨­ç‚ºflexible">3. SSL è¨­ç‚ºÂ Flexible&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__Rg8Jz3FZZx8adrfbYt0heA.png"
loading="lazy"
>&lt;/p>
&lt;p>å¾ Cloudflare(ç”¨ whois 172.68.47.149æŸ¥è©¢å¾Œç¢ºèª) åˆ° Serveræ˜¯èµ° 80 port&lt;/p>
&lt;h4 id="4-ssl-è¨­ç‚º-full--fullstrict">4. SSL è¨­ç‚º Full / FullÂ (strict)&lt;/h4>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__5MvJS8IszULHOhDNeGlKbw.png"
loading="lazy"
>&lt;/p>
&lt;p>å¾Œå°è¨­å®šåˆ‡æ›å¾Œç­‰å€‹ä¸‰ã€äº”ç§’å°±ç«‹å³æ”¹èµ° port 443&lt;/p>
&lt;h4 id="5-æ¸¬è©¦æ†‘è­‰æª¢æŸ¥">5. æ¸¬è©¦æ†‘è­‰æª¢æŸ¥&lt;/h4>
&lt;p>Full (strict)å·®åˆ¥åœ¨æ–¼æœƒæª¢æŸ¥æ†‘è­‰æ˜¯å¦ç‚ºå…¬é–‹çš„ç¬¬ä¸‰æ–¹CAé ’å¸ƒçš„åˆæ³•æ†‘è­‰ï¼Œé‚£å°±ä¾†ç¢ºèªä¸€ä¸‹æª¢æŸ¥çš„æ©Ÿåˆ¶æ˜¯å¦OKã€‚&lt;/p>
&lt;p>a. åœ¨ Full ç‹€æ…‹ä¸‹æ”¹ç”¨å…¶ä»–ç¶²åŸŸçš„SSLæ†‘è­‰ =&amp;gt; å¯ä»¥!&lt;br>
b. åœ¨ Full (strict) ç‹€æ…‹ä¸‹æ”¹ç”¨å…¶ä»–ç¶²åŸŸçš„SSLæ†‘è­‰ =&amp;gt; ä¸è¡Œï¼Œæœƒæª¢æŸ¥&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__6JOG8bEc9kDeqexWERRBbA.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å¦‚æœæ˜¯è‡ªç°½æ†‘è­‰ï¼Œè¨˜å¾—è¦ä¸Šå‚³ CSRåˆ°Cloudflareï¼Œä¸ç„¶ä¸€æ¨£æœƒå‡ºéŒ¯ã€‚&lt;/p>
&lt;h3 id="çµè«–">çµè«–&lt;/h3>
&lt;ol>
&lt;li>åƒ…ä½¿ç”¨ Cloudflare DNSæœå‹™ï¼ŒClientæœƒçœ‹åˆ°è‡ªå®¶æä¾›çš„æ†‘è­‰&lt;/li>
&lt;li>é–‹å•Ÿ Cloudflare CDNæœå‹™ï¼Œå…è²»ç‰ˆè½‰ç‚º Cloudflare Universal SSLæ†‘è­‰ï¼›&lt;br>
å¦‚è¦æ›¿æ›ç‚ºè‡ªå·±Domainç°½ç½²çš„æ†‘è­‰ï¼Œéœ€è¦ä»˜è²»æ–¹æ¡ˆ&lt;/li>
&lt;li>é–‹å•Ÿ Cloudflare CDNï¼Œæœƒè®“ Cloudflareæˆç‚ºä¸­é–“äººï¼Œè³‡æ–™æœ‰è¢«å¤–éœ²çš„ç–‘æ…®&lt;/li>
&lt;li>è¨˜å¾—é–‹å•Ÿ SSL ç‚º Full(strict)ï¼Œä¿è­· Cloudflare åˆ° Serveré€™æ®µ&lt;/li>
&lt;/ol></description></item><item><title>Jonathan Martin: Async patterns to scale your multicore JavaScript elegantly ç¸½çµèˆ‡è©¦é©—</title><link>https://yuanchieh.page/posts/2018/2018-06-27-jonathan-martin-async-patterns-to-scale-your-multicore-javascript-elegantly-%E7%B8%BD%E7%B5%90%E8%88%87%E8%A9%A6%E9%A9%97/</link><pubDate>Wed, 27 Jun 2018 04:03:50 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-06-27-jonathan-martin-async-patterns-to-scale-your-multicore-javascript-elegantly-%E7%B8%BD%E7%B5%90%E8%88%87%E8%A9%A6%E9%A9%97/</guid><description>&lt;p>ä»Šå¤©çœ‹åˆ°ä¸€éƒ¨ä¸éŒ¯çš„å½±ç‰‡ï¼Œä¸»é¡Œæ˜¯ã€Œåˆ©ç”¨Async Pattern æå‡JSåœ¨å¤šæ ¸å¿ƒä¸Šçš„åŸ·è¡Œé€Ÿåº¦ã€ï¼Œç´°æ‹†å€‹ä¸‰å€‹å°ç¯€&lt;br>
1. ç”¨Async IIFE è§£æ±ºä»»å‹™é–“ç›¸ä¾èˆ‡ä¸¦è¡Œçš„å•é¡Œ&lt;br>
2. ç”¨High Order Functionæ¦‚å¿µè¨­è¨ˆ Semaphoreï¼Œæ§åˆ¶åŒæ™‚ä¸¦è¡Œçš„ä»»å‹™æ•¸&lt;br>
3. é€éWorker è®“ä»»å‹™è·‘åœ¨å€‹åˆ¥Threadä¸Šï¼Œå¢åŠ å¤šæ ¸å¿ƒçš„æ•ˆèƒ½åˆ©ç”¨ã€‚&lt;/p>
&lt;h2 id="concurrency-vs-parallelism">Concurrency vs Parallelism&lt;/h2>
&lt;p>Concurrency ä¸¦è¡Œæ˜¯æŒ‡ &lt;strong>å¤šå€‹TaskåŸ·è¡Œæ™‚é–“æœ‰é‡ç–Š&lt;/strong>ï¼Œä¹Ÿå°±æ˜¯èªªTask1åŸ·è¡Œä¸­æ™‚Task2ä¹Ÿé–‹å§‹åŸ·è¡Œï¼Œç®—æ˜¯ä¸€å€‹æ¦‚å¿µæ€§è³ªä¸Šçš„å®šç¾©ï¼Œå³ä½¿åªæœ‰å–®ä¸€æ ¸å¿ƒä¹Ÿå¯ä»¥é€éTime Sharing é”åˆ° Concurrencyã€‚&lt;/p>
&lt;p>Parallelism ä¸¦ç™¼ï¼Œå¼·èª¿çš„æ˜¯å¤šå€‹Taskè¢«åˆ†é…åˆ°å¤šå€‹å¯¦é«”CPUä¸Šï¼ŒåŒæ™‚ä¸”ç¨ç«‹åŸ·è¡Œã€‚&lt;/p>
&lt;h2 id="async-iife">Async IIFE&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.bignerdranch.com/blog/cross-stitching-elegant-concurrency-patterns-for-javascript/" target="_blank" rel="noopener"
>&lt;strong>Cross Stitching: Elegant Concurrency Patterns for JavaScript&lt;/strong>&lt;/a>&lt;/p>
&lt;p>æœ€åŸºæœ¬ä½¿ç”¨ async/await å°±æ˜¯ä¸€è¡Œä¸€è¡Œå¯«ï¼Œå¦‚&lt;/p>
&lt;blockquote>
&lt;p>await task1();&lt;br>
await task2();&lt;br>
await task3();â€¦&lt;/p>
&lt;/blockquote>
&lt;p>ä½†å¦‚æœä¸åŒ taskä¹‹é–“å¯èƒ½æœ‰ç›¸äº’ä¾è³´ï¼Œå¦‚ task2 ä¸¦é ˆç­‰åˆ° task1çµæŸæ‰èƒ½é€²è¡Œ/ ä½†ä¹Ÿæœ‰äº› taskäº’ç›¸ç¨ç«‹å¯ä»¥ä¸¦è¡Œï¼Œå¦‚æœå–®ç´”ä¸€è¡Œä¸€è¡Œ async/await æœƒæµªè²»ç­‰å¾…çš„æ™‚é–“ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å›°é›£çš„é»åœ¨æ–¼ä»»å‹™è¤‡é›œï¼Œå¦‚ä½•æ¼‚äº®åœ°è¡¨ç¤ºä»»å‹™é–“çš„å…ˆå¾Œé †åºç›¸ä¾ï¼Œä¸¦è®“ä¸¦è¡Œæœ€å¤§åŒ–&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ä½œè€…æåˆ°å¯ä»¥ç”¨ async iife ï¼Œä¹Ÿå°±æ˜¯ async function ç«‹å³åŸ·è¡Œå‡½å¼ï¼Œasync function ä¸è«–ä½•æ™‚éƒ½æœƒå›å‚³ Promiseï¼Œå³ä½¿å¤±æ•—ä¹Ÿæ˜¯å›å‚³ Promise.rejectï¼›&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æˆ‘åƒè€ƒä½œè€…ç¯„ä¾‹ç¨‹å¼ç¢¼æ”¹å¯«çš„ï¼Œä¸»è¦æ¯”å°åŸå…ˆçš„åšæ³•èˆ‡async iifeçš„å·®åˆ¥ï¼ŒæŒ‘æˆ°ä»»å‹™é–“ç›¸ä¾çš„ç‹€æ…‹å¦‚ä¸‹&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__v7aRZMMz__1__hTYVEGc4quQ.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>åŸæœ¬å°±æœ‰çš„å¯«æ³•æ˜¯æè¿°Taskæ©«å‘çš„ä¸¦è¡Œï¼Œæ‰€ä»¥æˆ‘å€‘æœƒç”¨ Promise.all([])å°‡ TaskB/TaskCä¸¦è¡Œè™•ç†ï¼Œä½†æ˜¯é€™ç¨®å¯«æ³•å¯è®€æ€§å·®ï¼Œè€Œä¸”æ¶æ§‹çš„æ–¹å‘ä¹Ÿæ˜¯ä¸å¥½çš„ï¼Œ&lt;code>å› ç‚º Taskç›¸ä¾æ‡‰è©²æ˜¯å‚ç›´&lt;/code> ï¼Œåƒæ˜¯ TaskDæ˜æ˜å°±åªè¦ç­‰ TaskCå®Œæˆå°±å¯ä»¥é–‹å§‹åŸ·è¡Œï¼Œä½†å› ç‚ºå¯«æ³•æ‰€ä»¥è¦ç­‰åˆ° TaskBä¹ŸåŸ·è¡Œå®Œæˆå¾Œï¼ŒTaskDèˆ‡TaskEæ‰ä¸¦è¡Œè™•ç†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ä½¿ç”¨ async iife æœ€å¤§å¥½è™•å³æ˜¯æ¯å€‹Taskçš„ç›¸ä¾æ€§éƒ½è¢«å°è£çš„å¾ˆç›´è§€ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ Promiseä¸€å®£å‘Šå°±åŸ·è¡Œçš„ç‰¹æ€§ï¼Œåƒæ˜¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">taskA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="p">()=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">timePromise&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">TaskA&lt;/span> &lt;span class="nx">done&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)})()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ™‚taskAå·²ç¶“é–‹å§‹åŸ·è¡Œäº†ï¼Œä½†æ˜¯å¾ŒçºŒçš„codeå› ç‚º &lt;code>await taskA&lt;/code>é‚„æ˜¯è¦ç­‰taskAçµæŸæ‰èƒ½ç¹¼çºŒï¼Œæ‰€ä»¥ä¸€æ¨£å¯ä»¥åšåˆ°æµç¨‹çš„æ§åˆ¶ï¼›&lt;br>
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ taskB/taskCé€™æ¨£å¯«å¯ä»¥ä¸¦è¡Œè™•ç†ï¼Œæ¥è‘—taskDå› ç‚ºåªç›¸ä¾taskCæ‰€ä»¥åœ¨ç¯„ä¾‹ä¸­æœƒæ¯”taskBæ›´æ—©çµæŸï¼Œéå¸¸æ¼‚äº®çš„å¯«æ³•ã€‚&lt;/p>
&lt;p>å¦å¤–åˆ†äº«ä¸€å€‹ç•¶åˆç–‘æƒ‘çš„é»ï¼štaskCåœ¨ taskD / taskEè¢«å‘¼å«å…©æ¬¡ï¼Œæœƒä¸æœƒå°±åŸ·è¡Œå…©æ¬¡?!Â &lt;br>
ç­”æ¡ˆæ˜¯ä¸æœƒï¼Œå› ç‚ºtaskCæœ¬èº«æ˜¯Promiseï¼ŒåŸ·è¡Œå®Œä¸€æ¬¡å¾Œå°±æœƒè½‰æˆ Promise.fufilled(or rejected) ï¼Œå¦‚æœå¾ŒçºŒè¦ç”¨ await taskCå–å€¼å°±æœƒç«‹å³å›å‚³çµæœã€‚&lt;/p>
&lt;h2 id="high-orderfunction">High OrderÂ Function&lt;/h2>
&lt;p>é«˜éšå‡½å¼ï¼Œå®šç¾©æ˜¯å¯æ¥å—å‡½å¼ç•¶ä½œåƒæ•¸çš„å‡½å¼æœ¬èº«ï¼Œå¦‚éå¾€åœ¨æ•¸å­¸ä¸Šå­¸åˆ°çš„ f(g(x))ï¼Œåœ¨JSä¸­çµåˆclosure å°±å¯ä»¥æœ‰éå¸¸å¤šçš„æ‡‰ç”¨ã€‚&lt;/p>
&lt;p>Semaphore ä¿¡è™Ÿæ©Ÿï¼Œç”¨ä¾†æ§åˆ¶æœ‰é™çš„è³‡æºé‡ï¼Œä½œè€…åˆ©ç”¨ä¿¡è™Ÿæ©Ÿï¼Œè¨­è¨ˆé™åˆ¶æœ€å¤§ä¸¦è¡Œæ•¸çš„æ©Ÿåˆ¶&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/nybblr/semaphorejs" target="_blank" rel="noopener"
>&lt;strong>nybblr/semaphorejs&lt;/strong>&lt;/a>&lt;/p>
&lt;p>ç¨‹å¼ç¢¼åªæœ‰40è¡Œå·¦å³ä½†è »ç²¾å¦™çš„ï¼Œä½¿ç”¨ä¸Š
ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Semaphore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">timePromise&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3000&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">done&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">timePromise&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3000&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">â€œ&lt;/span>&lt;span class="nx">done&lt;/span>&lt;span class="err">â€&lt;/span>&lt;span class="p">)})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.....&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°æ‡‰ç¨‹å¼ç¢¼ï¼ŒSemaphore(3) å°‡ taskä¸Šé™è¨­ç‚º 3ï¼Œæ¥è‘—å›å‚³ä¸€å€‹é«˜éšå‡½å¼ã€‚&lt;br>
ä»”ç´°çœ‹é€™å€‹é«˜éšå‡½å¼çš„ç¬¬ä¸€è¡Œ&lt;code>await acquire();&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">dispatch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">counter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">counter&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">shift&lt;/span>&lt;span class="p">()();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">acquire&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resolve&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setImmediate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">dispatch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€æœ‰è¶£çš„åœ°æ–¹è«éæ–¼ä½œè€…ç”¨ acquire / dispatch é”åˆ°æ•¸é‡ä¸Šçš„æ§åˆ¶ï¼Œacquire å°‡ Promise.resolve() æ¨ä¸Šäº† taské™£åˆ—ï¼Œæ¥è‘—è§¸ç™¼ dispatchï¼Œè€Œdispatchåªæœ‰åœ¨æœªé”ä¸Šé™å‰å¯ä»¥åŸ·è¡Œ task.shift()çš„ functionï¼Œé€™è£¡ä¹Ÿå°±æ˜¯Promise.resolve()ï¼Œé€éé€™å€‹æ©Ÿåˆ¶å°±å¯ä»¥å»å¡ &lt;code>await acquire()&lt;/code> ã€‚&lt;/p>
&lt;h2 id="web-worker-and-multithread">Web Worker and MultiÂ Thread&lt;/h2>
&lt;p>JSæœ¬èº«åŸ·è¡Œæ–¼ Main Threadä¸Šï¼Œå…¶é¤˜éåŒæ­¥APIæ˜¯ç”±åº•å±¤ç€è¦½å™¨çš„Web APIæˆ– Nodejs Libuvç­‰æ”¯æ´ï¼Œæœ€å¾Œé€é event loop å°‡ callback è¿”å› Main Thread åŸ·è¡Œï¼›&lt;/p>
&lt;p>ä½†å¦‚æœéœ€è¦ç”¨JSåŸ·è¡Œè²»æ™‚çš„æ“ä½œè€Œæ²’æœ‰åº•å±¤å‡½å¼çš„æ”¯æ´(å¦‚è‡ªå·±ç·¨å¯« Addon)ï¼Œç¾åœ¨å¯ä»¥é€é Web Workeråˆ†é–‹ Threadï¼Œé¿å…é˜»æ“‹ Main Threadã€‚&lt;/p>
&lt;p>ç¨‹å¼ç¢¼è«‹åƒè€ƒï¼š&lt;a class="link" href="http://jsfiddle.net/sj82516/uqcFM/350/" target="_blank" rel="noopener"
>http://jsfiddle.net/sj82516/uqcFM/350/&lt;/a>&lt;/p></description></item><item><title>é¾èˆŸæ¯”è³½åˆé«”é©— â€” ä¸€äº›é—œæ–¼è¨“ç·´ã€æ¯”è³½çš„å¿ƒè·¯æ­·ç¨‹</title><link>https://yuanchieh.page/posts/2018/2018-06-23-%E9%BE%8D%E8%88%9F%E6%AF%94%E8%B3%BD%E5%88%9D%E9%AB%94%E9%A9%97-%E4%B8%80%E4%BA%9B%E9%97%9C%E6%96%BC%E8%A8%93%E7%B7%B4%E6%AF%94%E8%B3%BD%E7%9A%84%E5%BF%83%E8%B7%AF%E6%AD%B7%E7%A8%8B/</link><pubDate>Sat, 23 Jun 2018 10:11:14 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-06-23-%E9%BE%8D%E8%88%9F%E6%AF%94%E8%B3%BD%E5%88%9D%E9%AB%94%E9%A9%97-%E4%B8%80%E4%BA%9B%E9%97%9C%E6%96%BC%E8%A8%93%E7%B7%B4%E6%AF%94%E8%B3%BD%E7%9A%84%E5%BF%83%E8%B7%AF%E6%AD%B7%E7%A8%8B/</guid><description>&lt;p>2018/03/13ï¼ŒåƒåŠ äº†æ–°åº—åŒå¿ƒæ•‘é›£éšŠçš„é¾èˆŸè¨“ç·´åœ˜ï¼Œæ¯å¤©æ¸…æ™¨ 05:30 ~ 06:30 åœ¨ç¢§æ½­æ“ç·´ï¼Œå‡æ—¥ä¸åœä¸€è·¯ç·´åˆ° 2018/06/15 ç¸½è¨ˆ99å¤©çš„è¨“ç·´ï¼Œå€‹äººå‡ºå¸­äº† 90å¤©ã€‚&lt;br>
æ¥è‘—æ˜¯ 2018/06/16~2018/06/18ç‚ºæœŸä¸‰å¤©çš„æ¯”è³½ï¼Œæœ€çµ‚æ‹¿ä¸‹äº† å°åŒ—å¸‚å…¬é–‹å°å‹ç”·å­çµ„ç¬¬å…­åçš„æˆç¸¾ã€‚&lt;/p>
&lt;p>äº‹éš”ä¸€é€±ï¼Œç¨å¾®èª¿æ•´ä¸€ä¸‹ä½œæ¯èˆ‡æ€ç·’ï¼Œè¨˜éŒ„ä¸€äº›é—œæ–¼åˆ’é¾èˆŸè¨“ç·´åˆ°æ¯”è³½çš„ä¸€äº›å¿ƒè·¯æ­·ç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__5ePtnDLzks7AqdOnp2umXg.jpeg"
loading="lazy"
>
&lt;img src="https://yuanchieh.page/post/img/1__qffX3oGgyrKki____mqZKoyg.jpeg"
loading="lazy"
alt="photo creditÂ : éšŠä¸Šçš„æ˜å¾·æ•™ç·´èˆ‡å—å»·å¤§å“¥ï¼Œæ„Ÿè¬ä»–å€‘ä¸æ™‚å¹«å¤§å®¶ç•™ä¸‹ç¾å¥½çš„å›æ†¶"
>
photo creditÂ : éšŠä¸Šçš„æ˜å¾·æ•™ç·´èˆ‡å—å»·å¤§å“¥ï¼Œæ„Ÿè¬ä»–å€‘ä¸æ™‚å¹«å¤§å®¶ç•™ä¸‹ç¾å¥½çš„å›æ†¶&lt;/p>
&lt;p>ç‚ºæœŸç´„ä¸‰å€‹æœˆçš„è¨“ç·´ï¼Œå¤§è‡´å¯ä»¥æ‹†æˆä¸‰å€‹éšæ®µï¼š&lt;br>
åŸºç¤é«”èƒ½æ“ç·´ / ä¸‹èˆ¹ç·´ç¿’ / è³½å‰æº–å‚™æœŸ&lt;/p>
&lt;h3 id="åŸºç¤é«”èƒ½æ“ç·´">åŸºç¤é«”èƒ½æ“ç·´&lt;/h3>
&lt;p>é¦–å…ˆè¦è²æ˜ä¸€ä»¶å¾ˆå¤šäººéƒ½æœƒå•çš„äº‹ï¼šã€Œåˆ’é¾èˆŸæ‰‹è‡‚æœƒä¸æœƒè®Šå¾ˆå£¯ï¼Ÿã€&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__yaiUatTM01qw0DzWZP3YDw.jpeg"
loading="lazy"
alt="éš¨æ‰‹ç•«ç•«ï¼Œä¸è¦å¤ªåœ¨æ„(PS. æ§³é¢æœƒèˆ‡èˆ¹ç·£å‚ç›´ï¼Œæ­¤ç‚ºç¤ºæ„)"
>
éš¨æ‰‹ç•«ç•«ï¼Œä¸è¦å¤ªåœ¨æ„(PS. æ§³é¢æœƒèˆ‡èˆ¹ç·£å‚ç›´ï¼Œæ­¤ç‚ºç¤ºæ„)&lt;/p>
&lt;p>ä½†å…¶å¯¦åˆ’é¾èˆŸä¸»è¦æ˜¯å…¨èº«æ€§çš„é‹å‹•ï¼Œä¸€èˆ¬é¾èˆŸåå®šä½å¾Œå‰æ–¹æœ‰å¡Šè…³è¸æ¿å¯ä»¥æ’è‘—(ä¸Šåœ–)&lt;br>
æ¥è‘—ç™¼åŠ›çš„éç¨‹æ˜¯èº«é«”ç›¡é‡å¾€å‰è¶´ï¼Œä¸‹æ‰‹(é èˆ¹çš„å¤–å´)æ‰“ç›´ï¼Œæ¥è‘—å¤§è…¿ç™¼åŠ›=&amp;gt;è½‰è…°ä¸¦å¾€å¾Œæ‹‰/ä¸Šæ‰‹ä¸‹å£“ï¼Œæ¥è‘—æ°´å°±æœƒè¢«å¾Œæ¨ï¼Œæ ¹æ“šåä½œç”¨åŠ›èˆ¹å°±æœƒå‰é€²ã€‚&lt;/p>
&lt;p>åˆ’é¾èˆŸé å¾—æ˜¯å…¨èº«åŠ›é‡å»å¸¶å‹•ï¼Œé‡é»æ˜¯æ§³å…¥æ°´å¾Œåˆ’è·è¦æ‹‰é•·ï¼Œä¹Ÿå°±æ˜¯&lt;code>èº«é«”è¦è¶´å¾—å¤ ä¸‹å» =&amp;gt; èº«é«”åå½ˆåŠ é€Ÿåº¦è¦èµ·ä¾†&lt;/code>ï¼Œé€™æ¨£åˆ’èµ·ä¾†æ‰å¤ åŠ›ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åˆ’é¾èˆŸæ¯”è¼ƒåƒ&lt;code>å¤§è…¿**ã€**èƒŒéƒ¨è‚Œç¾¤ã€æ ¸å¿ƒè‚Œç¾¤ã€è‚©è†€ã€æŸ”è»Ÿåº¦!&lt;/code> ï¼Œå¦å¤–å°±æ˜¯å¿ƒè‚ºè€åŠ›é€™å¹¾å€‹éƒ¨åˆ†ï¼Œåè€ŒäºŒé ­è‚Œ/èƒ¸è‚Œå°±ä¸å¤ªæœƒç”¨ä¸Šã€‚&lt;/p>
&lt;p>ç¬¬ä¸€å€‹æœˆè¨“ç·´ä¸»è¦æ˜¯åŸºç¤é«”èƒ½è¨“ç·´ï¼Œæš–èº«å®Œè·‘å€‹3kï¼Œæ¥è‘—å°±æ˜¯æ•™ç·´å¸¶æ ¸å¿ƒè¨“ç·´èˆ‡æ·±è¹²ï¼Œæ¥è‘—å°±æ˜¯åœ¨å²¸ä¸ŠåšåŸºæœ¬çš„å‹•ä½œç·´ç¿’ã€‚&lt;/p>
&lt;p>æœ‰ç©ºæª”æœƒåˆ°èˆ¹ä¸Šç·´ç¿’ï¼Œä¸å¾—ä¸èªªä¸‹èˆ¹å¾Œæ„Ÿè¦ºå®Œå…¨ä¸åŒï¼Œä¸‹èˆ¹ç¬¬ä¸€ä»¶äº‹æ•™ç·´è¦æˆ‘å€‘æ„Ÿå—ã€Œèˆ¹çš„å¾‹å‹•ã€èˆ‡ã€Œèº«é«”çš„å¾‹å‹•ã€&lt;br>
ä¸æ‹¿æ§³ï¼Œå–®ç´”çš„æŠŠèº«é«”å¾€å‰è¶´ç„¶å¾Œå‡ºåŠ›è¹¬ -&amp;gt; æŠŠèº«é«”æ‹‰ç›´ï¼Œä¹Ÿå°±æ˜¯æ‹†è§£å‹•ä½œåªåšä¸‹åŠéƒ¨ï¼Œæ•™ç·´åœ¨ç¤ºç¯„çš„æ™‚å€™ï¼Œä¸€è¹¬æ•´è‰˜èˆ¹å°±å¾€å‰æ»‘å‹•äº†ä¸€æ®µã€‚&lt;br>
æ•™ç·´è¡¨ç¤ºå…ˆå­¸æœƒåŸºæœ¬åŠŸå¾ˆé‡è¦ï¼Œå› ç‚ºåˆ’èˆ¹ä¸€é–‹å§‹éŒ¯èª¤å§¿å‹¢éƒ½æ˜¯é æ‰‹è‡‚å°è‚Œè‚‰ç¾¤æ‹‰ï¼Œå¿˜äº†èº«é«”çš„ç¯€å¥èˆ‡å¾‹å‹•ï¼Œå³ä½¿æ˜¯å¥èº«å£¯æ¼¢ä¹Ÿä¸å¯èƒ½å–®ç”¨æ‰‹è‡‚è‚Œè‚‰åˆ’å®Œå…¨ç¨‹ï¼Œ&lt;code>é‡é»æ˜¯ç”¨å¤§è…¿/èƒŒ/è…°é€™äº›å¤§è‚Œè‚‰ç¾¤å¸¶å‹•ï¼Œæ‰å¯ä»¥åˆ’å¾—é•·é &lt;/code>ã€‚&lt;/p>
&lt;p>é€™å¤§æ¦‚æ˜¯ç¬¬ä¸€éšæ®µè¨“ç·´ï¼Œä¸»è¦æ˜¯å¹«å¤§å®¶æš–èº«èª¿æ•´èº«é«”ç‹€æ³ï¼Œæˆ‘å€‹äººå¹³å¸¸æœ‰é‹å‹•å¥èº«çš„ç¿’æ…£ï¼Œæ˜¯æ²’æœ‰ç‰¹åˆ¥å¥å£¯ä½†é«”åŠ›é‚„ç®—è¡Œï¼Œå¯æ˜¯ä¹‹å‰é‹å‹•å®Œéƒ½æ²’æœ‰æ”¶æ“çš„ç¿’æ…£ï¼Œæ‰€ä»¥èº«é«”çš„æŸ”è»Ÿåº¦å¾ˆå·®ï¼Œåœ¨èˆ¹ä¸Šè¨“ç·´éç¨‹å°±æœƒä¸€ç›´è¢«æ•™ç·´å”¸ã€Œé‚£å€‹èª°æ€éº¼ä¸è¶´ä¸‹å»ä¸€é»ã€ å…§å¿ƒåªèƒ½OSæˆ‘çš„å¤§è…¿å…§å´éƒ½æ‹‰åˆ°å¿«æ’•è£‚äº†ï¼›&lt;br>
åŒè¡Œçš„å¥³ç”Ÿåè€Œè¡¨ç¾éƒ½å¾ˆå¥½ï¼Œè¦ºå¾—è‡ªå·±è¡¨ç¾æœ‰é»æ‰æ¼†&lt;br>
ä¸éæ¯æ—¥ç·´ç¿’å®Œï¼Œæ•™ç·´éƒ½æœƒå¸¶æ”¶æ“ï¼Œä¹–ä¹–è·Ÿè‘—ç·´ç¿’æŒçºŒäº†å…©å€‹æœˆçµ‚æ–¼ è¶´ ä¸‹ å» äº†ã€‚&lt;/p>
&lt;h3 id="ä¸‹èˆ¹ç·´ç¿’">ä¸‹èˆ¹ç·´ç¿’&lt;/h3>
&lt;p>é€™å€‹éšæ®µæ¯æ—¥å°±ç›´æ¥ä¸‹èˆ¹ç·´ç¿’äº†ï¼Œå…ˆç¨å¾®ä»‹ç´¹ä¸€äº›é¾èˆŸçš„åŸºæœ¬çŸ¥è­˜ã€‚&lt;/p>
&lt;p>é¾èˆŸåˆ†å¤§é¾/å°é¾ï¼Œå¤§é¾æ˜¯ 20äººåº§ï¼Œå°é¾å‰‡æ˜¯ 10äººåº§ï¼Œå¦å¤–å¤šä¸€å€‹èˆµæ‰‹ï¼Œæ¯”è³½æ™‚å°é¾é¾é ­æœƒå¤šä¸€ä½é¼“æ‰‹ï¼Œè€Œå¤§é¾å‰‡æ˜¯å†å¤šä¸€ä½å¥ªæ¨™æ‰‹ã€‚&lt;br>
å€‹äººéƒ¨åˆ†ï¼Œèˆ¹åˆ†å·¦å³æ§³ï¼Œæˆ‘å€‹äººæ˜¯è¢«æ•™ç·´å®‰æ’æ–¼å·¦æ§³ï¼Œä¹Ÿå°±æ˜¯é¢å°é¾é ­æ–¹å‘çš„å·¦å´ï¼Œæœ‰äº›åˆ’äº†æ•¸å¹´ä»¥ä¸Šçš„è€æ‰‹å¯ä»¥å·¦å³æ§³éƒ½åˆ’ã€‚&lt;/p>
&lt;p>æ¯”è³½è·é›¢æˆ‘å€‘æ˜¯åˆ’ &lt;strong>500å…¬å°º&lt;/strong>ï¼Œæ•´è¶Ÿä¸‹ä¾†ç´„éœ€è¦180æ§³å·¦å³ï¼Œæ™‚é–“å¤§æ¦‚åœ¨2~4åˆ†é˜ï¼Œæ™‚é–“ç¯„åœä¹‹æ‰€ä»¥æ‹‰é€™éº¼å¤§æ˜¯å› ç‚ºåˆ’èˆ¹æœƒå—åˆ°æ°´æµèˆ‡é¢¨å‘å½±éŸ¿ï¼Œé †æµè·Ÿé€†æµæ™‚é–“å¯ä»¥å·®åˆ°å…©å€ä¹‹å¤šã€‚&lt;/p>
&lt;p>å‰›å‰›èªªæ¯”è³½å®Œæ•´æ˜¯éœ€è¦åˆ’ 180æ§³ï¼Œä½†æˆ‘å€‘åœ¨ä¸€é–‹å§‹ç·´ç¿’åˆ’å€‹30æ§³å°±æ‰‹ç— è…°ç— ï¼Œä¸€é–‹å§‹æœ€é ä¹Ÿéƒ½åˆ’100å…¬å°ºè€Œå·²ï¼Œå¿ƒæƒ³ My God 500å…¬å°ºä¹Ÿå¤ªé™é äº†å§ã€‚&lt;br>
ç•¶æ™‚æ•™ç·´å°±æ˜¯å¾ˆæœ‰è€å¿ƒçš„æŒ‡å°ï¼Œä¸æ–·çš„ä¿®æ­£å§¿å‹¢ï¼Œèˆ¹ä¸Šè³‡æ·±çš„å¤§å“¥å¤§å§ä¹Ÿéƒ½å¾ˆç†±æƒ…çš„çµ¦äºˆæŒ‡é»ï¼Œä¸å¾—ä¸èªªåˆ’èˆ¹çš„å§¿å‹¢æ‹†è§£æ­¥é©Ÿå°±é ‚å¤šäº”å…­é …ï¼Œä½†æ˜¯è¦çœŸçš„ç†Ÿç·´éœ€è¦èŠ±éå¸¸å¤šçš„æ™‚é–“èˆ‡ç²¾åŠ›ï¼Œå°¤å…¶æ˜¯é¾èˆŸæ˜¯åœ˜é«”é‹å‹•ï¼Œéœ€è¦å¤§å®¶çš„å‹•ä½œ/ç¯€å¥ä¸€è‡´èˆ¹æ‰èƒ½é †é †çš„å‰è¡Œï¼Œé€Ÿåº¦æ‰æœƒå¿«ã€‚&lt;/p>
&lt;p>é€™æ™‚å€™æ…¢æ…¢çš„æœ‰é–‹å§‹æ„Ÿå—åˆ°èˆ¹èˆ‡èº«é«”çš„å¾‹å‹•ï¼Œç¨å¾®åˆ†äº«å€‹æ•™ç·´å¸¸ç”¨çš„è©&lt;code>ã€Œæ’èˆ¹ã€&lt;/code>ä¹Ÿå°±æ˜¯æ§³å¾€ä¸‹å£“ã€èº«é«”å¾Œæ‹‰é€™å€‹ç™¼åŠ›çš„å‹•ä½œï¼Œæ•™ç·´è¡¨ç¤ºé€™æ„Ÿè¦ºå¾ˆåƒæ˜¯æ’ç«¿è·³ï¼Œæ’åˆ°ä¸€å€‹é»èº«é«”å°±ç«‹åˆ»åšå‡ºåæ‡‰ã€‚&lt;br>
å¾Œä¾†æœƒæ„Ÿè¦ºåˆ°æ’çš„åŠ›é‡åœ¨æ–¼èº«é«”æ–œå´è¶´åˆ°æ¥µè‡´ï¼Œå¤§è…¿èˆ‡èƒ¸è…”å¹¾ä¹é åœ¨ä¸€å¡Šï¼Œé‚£æ™‚å€™å› ç‚ºå·²ç¶“æ²’æœ‰æ›´å¤šä¼¸å±•çš„ç©ºé–“æ‰€ä»¥æœ‰å€‹å¼µåŠ›æ”¯æ’ï¼Œæ„Ÿè¦ºçœŸçš„æ˜¯æŠŠèº«é«”æ’èµ·ä¾†ã€‚&lt;/p>
&lt;h3 id="è³½å‰æº–å‚™">è³½å‰æº–å‚™&lt;/h3>
&lt;p>åœ¨äº”æœˆå°±é–‹å§‹è¦å‚™è³½äº†ï¼Œç·´ç¿’é–‹å§‹æŒ‰ç…§æ¯”è³½åˆ†çµ„ç·´ç¿’ï¼Œæˆ‘å°±è¢«åˆ†é…åˆ°ç”·å­çµ„ä¸€åŒç·´ç¿’ï¼Œæ¯æ—¥è¨“ç·´çš„èœå–®åŠ é‡å¾ˆå¤š&lt;br>
1. 800 å…¬å°ºæš–èº«&lt;br>
2. 1200 å…¬å°ºè² é‡è¨“ç·´&lt;br>
3. 500 å…¬å°ºæ¨¡æ“¬æ¯”è³½&lt;br>
4. 5 30 æ§³æ³•ç·´ç¿’æ•¸çµ„&lt;/p>
&lt;p>åˆ†äº«ä¸€ä¸‹æˆ‘å€‘çš„æ§³æ³•&lt;/p>
&lt;ol>
&lt;li>èµ·æ­¥æ§³ï¼š&lt;br>
å› ç‚ºèˆ¹ä¸€é–‹å§‹æ˜¯éœæ­¢çš„ï¼Œæ‰€ä»¥é¦–è¦ä¹‹é‡å°±æ˜¯æŠŠèˆ¹é€Ÿæ‹‰èµ·ä¾†ï¼Œæ­¤æ™‚çš„èµ·æ­¥æ§³å¿…é ˆç”¨å…¨èº«çš„åŠ›é‡å¸¶ï¼Œç”¨å…¨åŠ›æŠŠè…°è½‰å´ã€‚&lt;/li>
&lt;li>åŠ åŠ›æ§³ï¼š&lt;br>
ä¸»è¦ä¹Ÿæ˜¯ç”¨å…¨èº«åŠ›é‡å¸¶ï¼ŒåŒ…å«æ‰‹è‡‚ä¹ŸæœƒåŠ åŠ›ï¼Œæ­¤æ™‚æ§³é€Ÿæœƒæ‹‰å¿«åˆ°ç´„1.4ç§’ä¸€æ§³ï¼Œä¸»è¦å°±æ˜¯ç”¨æ–¼è¡åˆºï¼ŒåŒå˜—è©¦èµ·æ­¥æ§³ä¹‹å¾Œèˆ‡æœ€å¾Œçµ‚é»å‰è¡åˆºã€‚&lt;/li>
&lt;li>é•·æ§³&lt;br>
æ‰£é™¤èµ·æ­¥èˆ‡åŠ åŠ›ï¼Œå‰©é¤˜å°±æ˜¯é•·æ§³ï¼Œä¸»è¦é èº«é«”å¸¶å‹•æ­¤æ™‚æ‰‹è‡‚æœƒæ”¾é¬†ï¼Œå„²å‚™æ¥ä¸‹ä¾†è¡åˆºçš„åŠ›é‡ï¼Œå¤§ç´„æ˜¯7åˆ†åŠ›å·¦å³ï¼Œå› ç‚ºæ¯”è³½500å…¬å°ºä¸å¯èƒ½å…¨ç¨‹è¡åˆºï¼Œæ‰€ä»¥é•·æ§³æ§³é€Ÿæœƒæ”¾åˆ°ç´„ 2ç§’ä¸€æ§³ï¼Œä½†æ­¤æ™‚å°±è¦é èº«é«”å®Œå…¨çš„ä¼¸å±•è®“æ§³è·è®Šé•·ï¼Œç¶­æŒèˆ¹é€Ÿã€‚&lt;/li>
&lt;/ol>
&lt;p>æˆ‘å€‘åˆ’æ˜¯5å€‹èµ·æ­¥æ§³ =&amp;gt; 30å€‹åŠ åŠ›æ§³ =&amp;gt; é•·æ§³ 100æ§³ =&amp;gt; 50å€‹åŠ åŠ›æ§³ã€‚&lt;/p>
&lt;p>æ¯”è³½å ´åœ°æˆ‘å€‘å ±äº†å…©çµ„ï¼Œåˆ†åˆ¥æ˜¯å°åŒ—å¸‚å¤§ä½³æ²³æ¿±å…¬åœ’èˆ‡æ–°åŒ—å¸‚å¾®é¢¨é‹æ²³ï¼Œå°åŒ—èˆ‡æ–°åŒ—çš„èˆ¹æ˜¯ä¸ä¸€æ¨£çš„ï¼Œå‰è€…æ˜¯æœ¨èˆ¹å¾ˆæ²‰ï¼Œå¾Œè€…æ˜¯å¡‘è† è£½å¾ˆè¼•ï¼Œä¹Ÿæ˜¯å¹³å¸¸ç·´ç¿’çš„èˆ¹ã€‚&lt;br>
æˆ‘å€‘çš„ä¸»è¦ç›®æ¨™æ“ºåœ¨å°åŒ—å¸‚ï¼Œæ‰€ä»¥å¹³å¸¸éƒ½æœƒè² é‡ç·´ç¿’ï¼Œåˆ’çš„é˜»åŠ›å¤§æ¦‚æ˜¯2~3å€ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__wXwcAQUrFuAC1CAkyslSLw.jpeg"
loading="lazy"
>
&lt;img src="https://yuanchieh.page/post/img/1__Er9jX__aCbCkH9jhd3AVMhA.jpeg"
loading="lazy"
alt="photo creditï¼šå·¦é‚Šå°åŒ—å¸‚ï¼Œå³é‚Šæ–°åŒ—å¸‚"
>
photo creditï¼šå·¦é‚Šå°åŒ—å¸‚ï¼Œå³é‚Šæ–°åŒ—å¸‚&lt;/p>
&lt;p>ä½†ä¸€é–‹å§‹ç·´ç¿’è¶…å´©æ½°ï¼Œå› ç‚ºå¼·åº¦æ‹‰å‡çš„å¾ˆå¤šï¼Œå¾å››æœˆä¸€é–‹å§‹åªèƒ½3/50æ§³åˆ’ï¼Œé€æ­¥çˆ¬å‡åˆ°æš–èº«å°±è¦æ»‘800å…¬å°ºç´„300æ§³ï¼Œå¼·åº¦æ”€å‡çš„å¾ˆå¯æ€•ï¼Œæœ‰æ™‚å€™ç·´ç¿’æ•™ç·´éƒ½æœƒèªªè·Ÿä¸ä¸Šå¯ä»¥æ”¶æ§³ä¼‘æ¯ï¼Œå…§å¿ƒé–‹å§‹æ™æ‰ï¼Œä½†æœ€å¾Œé‚„æ˜¯å’¬è‘—ç‰™åŠªåŠ›ç·Šè·Ÿï¼Œéš¨è‘—è‚Œè‚‰è·Ÿè‘—é©æ‡‰ï¼Œæ…¢æ…¢çš„ä¹Ÿé–‹å§‹è·Ÿä¸Šå¤§å¤¥çš„æ­¥èª¿ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å …æŒï¼Œæ˜¯æˆ‘å”¯ä¸€èƒ½åšåˆ°çš„äº‹ XD&lt;/p>
&lt;/blockquote>
&lt;p>ä½†åªèƒ½èªªå‹‰å¼·è·Ÿä¸Šç¯€å¥ï¼Œä½†æ˜¯æ•´é«”åˆ’èˆ¹çš„åŠ›é‡é‚„æ˜¯è¼¸å‰è¼©å¾ˆå¤šï¼Œå¾å¾Œå´è§€å¯Ÿåˆ’èˆ¹æ¨æ°´çš„åŠ›é‡ï¼Œå‰è¼©å€‘éƒ½æ˜¯ è½Ÿï½è½Ÿï½è½Ÿéå¸¸å¤§åŠ›ï¼Œæˆ‘å‰‡æ˜¯ å‘¼ï½å‘¼ï½å‘¼è€Œå·²ï¼Œå§¿å‹¢ä¹Ÿé‚„æœ‰ç´°ç¯€éœ€è¦å¾®èª¿ï¼Œä½†ä¹Ÿä¾†ä¸åŠäº†&lt;/p>
&lt;p>åˆ†äº«ä¸€äº›è¶£äº‹ï¼Œé€™æ®µæœŸé–“å¯ä»¥æ˜é¡¯æ„Ÿå—è‚Œè‚‰åœ¨é•·å¤§ï¼Œæ‰€ä»¥é£Ÿé‡ä¹Ÿè®Šæˆå…©å€ï¼Œæ—©é¤åƒå…©ä»½ã€ä¸‹åˆé–‹å§‹åƒé»å¿ƒï¼Œä¼™é£Ÿè²»ç˜‹ç‹‚çš„æ”€å‡ï¼›&lt;br>
å¦å¤–å› ç‚ºåˆ’èˆ¹å¤§è…¿è¹¬å±è‚¡æœƒç¨å¾®æŒªç§»ï¼Œå¾ˆå¤šäººéƒ½æœƒæº–å‚™è»Ÿå¢Šé¿å…ç£¨ç ´å±ï¼Œä¸€é–‹å§‹ä¸çŸ¥é“å°±æœ‰ç£¨ç ´ï¼Œçµæœå°±è«‹å‡ä¼‘é¤Šï¼Œä¹‹å¾Œå¶ç„¶ç™¼ç¾å››è§’è¤²å››åˆ†äº”è£‚ï¼Œçœ‹ä¾†æ˜¯å› ç‚ºå¤ªæ¿€çƒˆæ‰€ä»¥ç ´å¾—äº‚ä¸ƒå…«ç³ŸXDÂ &lt;br>
è·åŒ…è¡¨ç¤ºå¿ƒç–¼ã€‚&lt;/p>
&lt;h3 id="æ¯”è³½">æ¯”è³½!!&lt;/h3>
&lt;p>ç¶“éä¸‰å€‹æœˆçš„å‚™æˆ°ï¼Œçµ‚æ–¼è¦åœ¨ç«¯åˆé€£å‡ä¸‰å¤©é€²è¡Œæ¯”è³½ï¼Œæ ¹æ“šæ•™ç·´ç©ç¬‘è©±èªªã€ŒéšŠä¸Šæ˜¯é è€äººèˆ‡å¥³äººåƒé£¯ã€å› ç‚ºé•·é’çµ„è·Ÿå¥³å­çµ„å¾€å¹´æ¯”è³½è¡¨ç¾äº®çœ¼ï¼Œç”·å­çµ„å°±ç¨å¾®å·®å¼·äººæ„ï¼Œä»Šå¹´æ±ºå®šå´›èµ·åŠªåŠ›å¥®æˆ°ã€‚&lt;/p>
&lt;p>ä¸å¾—ä¸èªªç¬¬ä¸€æ¬¡ä¸Šå ´æ¯”è³½çœŸçš„è¶…ç·Šå¼µï¼Œä½†å¥½åœ¨å¹³å¸¸è¨“ç·´å¤ ï¼Œä¸€é³´æ§å°±ç…§è‘—ç·´ç¿’çš„æ­¥èª¿ä¸€æ§³ä¸€æ§³ä¾†ï¼Œä½†å› ç‚ºç·Šå¼µè®“å¿ƒè·³åŠ é€Ÿæ›´å¿«å‘¼å¸ä¹Ÿæ¯”è¼ƒçŸ­ä¿ƒï¼Œåˆ’åˆ°å¾Œä¾†æœ‰é»å–˜ä¸éæ°£ï¼Œä½†é‚„å¥½éƒ½æœ‰æ’éçµ‚é»æ‰æ–·æ°£OTZ&lt;/p>
&lt;p>æ¯”è³½çš„è©±ä¸€é–‹å§‹æ˜¯æ¯çµ„å–å‰äºŒæ™‰ç´šï¼Œç”·å­çµ„é †åˆ©é€²åˆ°å‰å…«å¼·ï¼Œä½†æ˜¯åœ¨æ¶å‰å››æ™‚è¼¸äº†0.5ç§’ç„¡ç·£å‰å››ï¼Œæœ€çµ‚æ¶5~8æ‹¿ä¸‹ç¬¬å…­åçš„æˆç¸¾ï¼Œæœ‰ä¸€å€‹å°çç›ƒèˆ‡çç‹€ä¸€ç´™ï¼Œä½†æ˜¯æ²’æœ‰çé‡‘ï¼›&lt;br>
è€Œå¥³å­çµ„åœ¨æ–°åŒ—å¸‚æ‹¿ä¸‹ç¬¬äºŒåä½³ç¸¾! æœ‰å¤§å¤§çš„çç›ƒèˆ‡12è¬çé‡‘å•Šï¼&lt;br>
ä»Šå¹´å»¶çºŒäº†éšŠä¸Šå„ªè‰¯å‚³çµ±XD&lt;/p>
&lt;p>åˆ†äº«ä¸€å€‹å°æ•…äº‹ï¼Œå› ç‚ºå¦ä¸€ä½è³‡æ·±çš„æ•™ç·´è‚©è†€æœ‰é»å—å‚·ï¼Œæ‰€ä»¥æˆ‘è·Ÿä»–æ˜¯è¼ªæµä¸Šå ´æ¯”ï¼Œåœ¨æ¶å‰å››é‚£å ´æ˜¯ç”±æˆ‘ä¸Šå ´æ¯”ï¼Œç†è«–ä¸Šåªè¦é€²äº†å‰å››éƒ½æœƒæœ‰çé‡‘ï¼Œä½†æ˜¯æœ€çµ‚ä»¥ 0.5ç§’å°è¼¸å°æ‰‹å°±è¦ºå¾—æŒºè‡ªè²¬ï¼Œä¸ç¦åœ¨æƒ³å¦‚æœæ˜¯æ•™ç·´ä¸Šå ´æ˜¯ä¸æ˜¯æˆ‘å€‘å°±æŒºé€²æ±ºè³½äº†?&lt;/p>
&lt;p>å¾Œä¾†æˆ‘ä¹Ÿä¸»å‹•è·Ÿæ•™ç·´è©¢å•é€™ä»¶äº‹ï¼Œä½†æ•™ç·´å®‰æ…°èªªç¸½æ˜¯è¦è¨“ç·´æ–°äººä¸Šå ´ï¼Œä¸ç„¶ç·´äº†ä¸‰å€‹æœˆéƒ½æ²’æœ‰ä¸Šå ´ä¹Ÿä¸è¡Œç­‰ç­‰ï¼Œå¾ˆæ„Ÿè¬æ•™ç·´çš„ä¿¡ä»»ä¸¦é¡˜æ„çµ¦æˆ‘æ©Ÿæœƒä¸Šå ´&lt;/p>
&lt;h3 id="å¿ƒå¾—">å¿ƒå¾—&lt;/h3>
&lt;p>æˆ‘éå¾€æ²’æœ‰åƒåŠ éé«”è‚²åœ˜éšŠç·´ç¿’ï¼Œå¾ˆæ„Ÿè¬æ–°åº—åŒå¿ƒæ•‘é›£éšŠçš„æ•™ç·´èˆ‡éšŠå“¡å€‘éƒ½å¾ˆç†±æƒ…ï¼Œé›–ç„¶å¹´é½¡å±¤å°ºåº¦å¾ˆå¤§(19~6X)ï¼Œä½†æ˜¯å¤§å®¶å› ç‚ºå°é¾èˆŸæœ‰èˆˆè¶£ä¸€åŒé›†çµç·´ç¿’ï¼Œç‚ºäº†çˆ­å–æ¦®è€€ä¸€èµ·åŠªåŠ›ï¼Œæœ€çµ‚ä¹Ÿå–å¾—ä¸éŒ¯çš„æˆç¸¾ã€‚&lt;/p>
&lt;p>æ•´å€‹è¨“ç·´éç¨‹æœ‰æ±—æ°´ä¹Ÿæœ‰æ­¡ç¬‘ï¼Œä¹Ÿæ„Ÿè¬æ•™ç·´ä¿¡ä»»æˆ‘ä¹Ÿé¡˜æ„æ´¾æˆ‘ä¸Šå ´ï¼Œå¿ƒä¸­ç•™ä¸‹çš„ä¸€é»éºæ†¾å°±çœ‹æ˜å¹´æœ‰æ²’æœ‰æ©Ÿæœƒä¾†åŠªåŠ›ã€‚&lt;/p>
&lt;p>æ•´è¶Ÿä¸‰å€‹æœˆçš„é‡Œç¨‹å°±å‘Šä¸€æ®µè½ï¼ŒçµæŸæ¯æ—¥4:30å‰èµ·åºŠçš„æ—¥å­ï¼Œé‚„åœ¨åŠªåŠ›èª¿æ•´ä½œæ¯ä¸­XD&lt;/p>
&lt;p>PS. ä»¥ä¸Šè¨€è«–åƒ…ä»£è¡¨å€‹äººé«”æ‚Ÿï¼Œå¦å¤–é¾èˆŸåˆ’æ³•ä¹Ÿæ˜¯æˆ‘ç¸½çµæ•™ç·´çš„è¨“ç·´ï¼Œå…¶ä¸­å¯èƒ½æœ‰äº›ç´°ç¯€æ¼è¬›å¦‚æœ‰éŒ¯èª¤æ­¡è¿å‘ŠçŸ¥ã€‚&lt;/p>
&lt;p>æœ€å¾Œå·¥å•†ä¸€ä¸‹éšŠä¸Šå…¶é¤˜æ´»å‹•ï¼Œé¾èˆŸå°±è¦æ˜å¹´ä¸‰æœˆè¦‹å›‰ï½&lt;br>
ä¸»è¦æœ‰æ¸¸æ³³ç­è·Ÿæ•‘ç”Ÿå“¡ç­å¯ä»¥åƒåŠ &lt;/p>
&lt;p>&lt;a class="link" href="https://www.beclass.com/rid=213ed605ab0c0446963c" target="_blank" rel="noopener"
>æ–°åº—åŒå¿ƒæ•‘é›£éšŠ&lt;/a>&lt;/p></description></item><item><title>MySQL é—œæ–¼åœ°ç†ä½ç½®çš„å„²å­˜èˆ‡é‹ç®—</title><link>https://yuanchieh.page/posts/2018/2018-06-21-mysql-%E9%97%9C%E6%96%BC%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E7%9A%84%E5%84%B2%E5%AD%98%E8%88%87%E9%81%8B%E7%AE%97/</link><pubDate>Thu, 21 Jun 2018 22:15:22 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-06-21-mysql-%E9%97%9C%E6%96%BC%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E7%9A%84%E5%84%B2%E5%AD%98%E8%88%87%E9%81%8B%E7%AE%97/</guid><description>&lt;p>æœ€è¿‘çªç„¶å¥½å¥‡å¦‚ä½•åšLBSæœå‹™ï¼Œæœ€åŸºæœ¬çš„æ‡‰ç”¨å ´æ™¯å°±æ˜¯æ‰¾å‡ºæŸç¶“ç·¯åº¦ä½ç½®å…§æ–¹åœ“è·é›¢å¤šå°‘å…§çš„æ‰€æœ‰è³‡æ–™ï¼Œæ‰€ä»¥å°±ä¾†ç ”ç©¶ä¸€ä¸‹MySQLå¦‚ä½•è™•ç†åœ°ç†ä½ç½®ã€‚&lt;/p>
&lt;h2 id="spatial-reference-systemssrss-ç©ºé–“åƒè€ƒç³»çµ±">Spatial Reference Systems(SRSs) ç©ºé–“åƒè€ƒç³»çµ±&lt;/h2>
&lt;p>&lt;a class="link" href="https://mysqlserverteam.com/spatial-reference-systems-in-mysql-8-0/" target="_blank" rel="noopener"
>&lt;strong>Spatial Reference Systems in MySQL 8.0&lt;/strong>&lt;/a>&lt;/p>
&lt;p>æ‰€æœ‰çš„å¹¾ä½•ç‰©ä»¶å¦‚é»/ç·š/é¢ï¼Œéƒ½å¿…é ˆå®šç¾©åœ¨åŒä¸€å€‹åº§æ¨™ç³»çµ±ï¼Œä¾‹å¦‚èªªåœ¨XYè»¸å¹³é¢ä¸Šæœ‰ä¸€é»(1,2)ï¼Œä½†æ˜¯åº§æ¨™ç³»çµ±å¯èƒ½æ˜¯ä¸€å€‹è¶³çƒå ´/æˆ–æ˜¯ä¸€å°ç­†é›»è¢å¹•ï¼Œè¶³çƒå ´ä¸Šçš„åº§æ¨™(1,2)è·Ÿè¢å¹•ä¸Šçš„åº§æ¨™(1,2)æ˜¯æˆªç„¶ä¸åŒä¸”ç„¡å¾æ¯”è¼ƒèµ·çš„ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åœ¨å®šç¾©å¹¾ä½•ç‰©ä»¶æ™‚ï¼Œå¿…é ˆè¦åŒæ™‚å®£å‘Šè©²ç‰©ä»¶æ‰€å±¬çš„åº§æ¨™ç³»çµ±ï¼Œä¹Ÿå°±æ˜¯ SRID(spatial reference system identifier)ï¼ŒMySQLå’Œå…¶ä»–çš„DBMSéƒ½å¿…é ˆåœ¨ç›¸åŒçš„SRIDä¸‹æ‰èƒ½å¤ é€²è¡Œå¹¾ä½•é‹ç®—ã€‚&lt;/p>
&lt;p>åœ¨MySQL 8.0ä¸­æ”¯æ´è¶…é5000ç¨®SRSsï¼Œå¸¸è¦‹çš„æœ‰å…©ç¨®ï¼š&lt;/p>
&lt;ol>
&lt;li>SRID 3857ï¼š&lt;br>
å°‡åœ°çƒè¡¨é¢æŠ•å½±è‡³å¹³é¢ä¸Šï¼Œå±¬æ–¼ç¬›å¡çˆ¾åº§æ¨™ç³»( &lt;a class="link" href="https://epsg.io/4499-cs" target="_blank" rel="noopener"
>Cartesian 2D CS&lt;/a>)ï¼Œä¹Ÿå°±æ˜¯XYè»¸ç›¸äº’å‚ç›´ä¸”å–®ä½é•·åº¦ä¸€è‡´ã€‚&lt;br>
å¸¸ç”¨æ–¼ç¶²é ä¸Šçš„åœ°åœ–ç³»çµ±ï¼Œå¦‚Google Map / Open Street Mapç­‰&lt;/li>
&lt;li>SRID 4326ï¼š&lt;br>
å±¬æ–¼çœŸå¯¦ç©ºé–“åº§æ¨™ç³»çµ±ï¼Œå°‡åœ°çƒè¦–ç‚ºæ©¢åœ“é«”ï¼Œä¹Ÿå°±æ˜¯è½‰æ›æˆç¶“ç·¯åº¦ï¼Œåº§æ¨™è»¸å½¼æ­¤ä¸æ˜¯å‚ç›´çš„ï¼Œç¶“åº¦æœ€å¾Œéƒ½åœ¨å—åŒ—æ¥µå½™æ•´ã€‚&lt;br>
å¸¸ç”¨æ–¼GPS&lt;/li>
&lt;/ol>
&lt;h2 id="èªæ³•ä½¿ç”¨">èªæ³•ä½¿ç”¨&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/bcr9MQnzYG9Acu9SUqyXRV/1" target="_blank" rel="noopener"
>&lt;strong>DB Fiddle - SQL Database Playground&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å‰µå»ºæ¬„ä½ä¸Šï¼Œå¯ä»¥å®šç¾© GEOMETRYå‹åˆ¥ï¼Œæ¬„ä½å¯ä»¥æŒ‡å®š SRIDï¼Œéœ€è¦ç´¢å¼•å¯åŠ ä¸Š SPATIAL INDEX(g)ï¼ŒInnoDB/MyISAMéƒ½æ”¯æ´ã€‚&lt;/p>
&lt;p>åœ¨æ’å…¥æ¬„ä½æœ‰å…©ç¨®åšæ³•ï¼Œä¸€ç¨®æ˜¯ç›´æ¥ä½¿ç”¨å¹¾ä½•å½¢åˆ¥ï¼Œä¸€ç¨®æ˜¯é€é ST_GeomFromText å¾å­—ä¸²è½‰æ›ï¼Œç›®å‰åªæœ‰çœ‹åˆ°å¾Œè€…å¯ä»¥æŒ‡å®š SRID&lt;br>
&lt;code>Insert into geom VALUES(Point(1,1), â€œwordâ€);&lt;/code>Â &lt;br>
&lt;code>Insert into geom2 VALUES(ST_GeomFromText(â€˜POINT(1 1)â€™, 4326), â€œhelloâ€);&lt;/code>
&lt;code>Insert into geom2 VALUES(ST_GeomFromText(â€˜POLYGON((0 0, 0 2, 2 2, 2 0, 0 0))â€™, 4326), â€œzipâ€); &lt;/code>&lt;/p>
&lt;p>MySQLæ”¯æ´å¤šç¨®å¹¾ä½•å½¢åˆ¥ï¼Œä¾‹å¦‚Point / Line / Polygonç­‰ã€‚&lt;/p>
&lt;p>é‹ç®—ä¸Š&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/spatial-relation-functions-object-shapes.html#function_st-contains" target="_blank" rel="noopener"
>MySQL 8.0æ”¯æ´å¤šç¨®å‡½å¼&lt;/a>ï¼Œå‡½å¼çš†å·² ST_é–‹é ­ï¼Œä¾‹å¦‚&lt;br>
ç®—å…©é»è·é›¢&lt;br>
&lt;code>SELECT ST_Distance((SELECT g from geom2 where name=â€™helloâ€™), ST_GeomFromText(â€˜POINT(0 0)â€™, 4326)) AS distance;&lt;/code>&lt;/p>
&lt;p>åˆ¤æ–·æ˜¯å¦åœ¨æŸç¯„åœå…§ (helloæ˜¯ point å‹åˆ¥ï¼Œzip æ˜¯ polygonå‹åˆ¥ï¼Œåˆ¤æ–·)&lt;br>
&lt;code>SELECT ST_Within((SELECT g from geom2 where name=â€™helloâ€™), (SELECT g from geom2 where name=â€™zipâ€™))&lt;/code>&lt;/p>
&lt;h3 id="è£œç¶“ç·¯åº¦è·é›¢æ›ç®—">è£œï¼šç¶“ç·¯åº¦è·é›¢æ›ç®—&lt;/h3>
&lt;p>åœ¨SRID 4326ä¸­ï¼Œåœ°çƒæ˜¯åæ©¢åœ“ç‹€ï¼Œäººå€‘ç‚ºäº†æ–¹ä¾¿é€éç¶“ç·¯åº¦ç”¨ç¶²æ ¼åšåŠƒåˆ†ï¼Œåˆ†è¾¨åœ°ç†ä½ç½®çš„åˆ¤åˆ¥ï¼Œæ‰€ä»¥è¦å°‡ç¶“ç·¯åº¦æ›ç®—å›å¯¦éš›çš„è·é›¢éœ€è¦æœ‰å…¬å¼çš„è½‰æ›ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://www.thoughtco.com/degree-of-latitude-and-longitude-distance-4070616" target="_blank" rel="noopener"
>&lt;strong>Learn How Far It Is From One Latitude Line to the Next&lt;/strong>&lt;/a>&lt;/p>
&lt;h3 id="ç¶“åº¦æ›ç®—">ç¶“åº¦æ›ç®—&lt;/h3>
&lt;p>ç¶“åº¦å·®æœƒéš¨è‘—å¾€å—åŒ—æ¥µè€Œéæ¸›è‡³é›¶ï¼Œåœ¨èµ¤é“å¤§ç´„æ˜¯ 111.321kmï¼Œè€Œå—åŒ—ç·¯ 40åº¦å‰‡ç‚º 85 kmã€‚&lt;/p>
&lt;h3 id="ç·¯åº¦æ›ç®—">ç·¯åº¦æ›ç®—&lt;/h3>
&lt;p>ç·¯åº¦é–“åŸºæœ¬ä¸Šæ˜¯å¹³è¡Œï¼Œæ‰€ä»¥æ¯å–®ä½ç·¯åº¦å·®ä¹‹é–“éƒ½æ˜¯ç›¸è¿‘çš„ï¼Œåªæ˜¯å› ç‚ºåœ°çƒåæ©¢åœ“æ‰€ä»¥é«˜ç·¯åº¦è·é›¢è¶Šé•·ã€‚&lt;br>
åƒæ˜¯åœ¨èµ¤é“æ¯ä¸€åº¦ç·¯åº¦å·®å¯¦éš›è·é›¢æ˜¯ 110.567 kmï¼Œåœ¨å›æ­¸ç·šé™„è¿‘å‰‡æ˜¯ 110.948kmï¼Œå¦‚æœæ˜¯åœ¨å—åŒ—æ¥µå‰‡æ˜¯ 111.169 kmï¼Œå¹³å‡å¤§ç´„å¯ä»¥å– 111 kmã€‚&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœè¦ç”¨ç¶“ç·¯åº¦å·®æ›ç®—å¯¦éš›è·é›¢ï¼Œå¯ä»¥ç”¨ haversine å…¬å¼ï¼Œè©³ç´°å…§å®¹å¯ä»¥åƒè€ƒ Wiki&lt;br>
ç›®å‰ä¹Ÿå­˜åœ¨å¤šç¨®æ›ç®—å…¬å¼ï¼Œä¸åŒçš„é‹ç®—è¤‡é›œåº¦å¸¶ä¾†ä¸åŒçš„é‹ç®—æº–ç¢ºåº¦ï¼Œå¯ä»¥å†å¤šåŠ ç ”ç©¶ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://en.wikipedia.org/wiki/Haversine_formula" target="_blank" rel="noopener"
>&lt;strong>Haversine formula - Wikipedia&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åœ¨MySQL 5.7ä¸­æ”¯æ´åº¦ä¸Šæ²’æœ‰é€™éº¼å¥½ï¼Œæ‰€ä»¥çƒå‹è·é›¢è½‰æ›å…¬å¼éœ€è¦è‡ªè¡Œæ›ç®—ï¼Œè©³ç´°å¯ä»¥åƒè€ƒæ­¤ç¯‡ &lt;a class="link" href="https://mysqlserverteam.com/mysql-5-7-and-gis-an-example/" target="_blank" rel="noopener"
>https://mysqlserverteam.com/mysql-5-7-and-gis-an-example/&lt;/a>&lt;/p></description></item><item><title>Google Sheet API èˆ‡Google OAuth2 APIæˆæ¬Šç ”ç©¶</title><link>https://yuanchieh.page/posts/2018/2018-06-01-google-sheet-api-%E8%88%87google-oauth2-api%E6%8E%88%E6%AC%8A%E7%A0%94%E7%A9%B6/</link><pubDate>Fri, 01 Jun 2018 13:03:55 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-06-01-google-sheet-api-%E8%88%87google-oauth2-api%E6%8E%88%E6%AC%8A%E7%A0%94%E7%A9%B6/</guid><description>&lt;p>æœ€è¿‘æœ‰å€‹éœ€æ±‚æ˜¯å¸Œæœ›å¯ä»¥å°‡å„ç¶²ç«™çš„é€€æ¬¾ç´€éŒ„åŒæ­¥åˆ°Google Sheetä¸Šï¼Œæ–¹ä¾¿PMèˆ‡è²¡å‹™éƒ¨é–€è¿½è¹¤ï¼Œç›¸æ¯”æ–¼è‡ªå»ºç¶²ç«™ï¼ŒGoogle Sheet æœ‰æ–¹ä¾¿çš„åŒæ­¥ç·¨è¼¯ / åŒ¯å‡ºåŒ¯å…¥ / ç™»å…¥æ¬Šé™ç®¡ç†ç­‰ï¼Œå°±ä¸å¿…è‡ªå·±é‡é€ è¼ªå­ï¼Œè€Œä¸”ä¹Ÿä¸è¦‹å¾—é€ å¾—å‡ºä¾†(æ±—&lt;/p>
&lt;p>æ•´ç¯‡åˆ†æˆå…©éƒ¨åˆ†ï¼Œç¬¬ä¸€æ˜¯ç ”ç©¶Google OAuth2 APIæˆæ¬Šéƒ¨åˆ†ï¼Œç¬¬äºŒæ˜¯Google Sheet APIã€‚&lt;/p>
&lt;h2 id="google-oauth2apiæˆæ¬Š">Google OAuth2Â APIæˆæ¬Š&lt;/h2>
&lt;p>&lt;a class="link" href="https://developers.google.com/identity/protocols/OAuth2" target="_blank" rel="noopener"
>Google APIæˆæ¬Š&lt;/a>æœ‰å…©ç¨®æ–¹å¼&lt;/p>
&lt;ol>
&lt;li>&lt;strong>OAuth 2.0ï¼š&lt;/strong>&lt;br>
å¦‚æœæ˜¯æ¶‰åŠç”¨æˆ¶éš±ç§è³‡æ–™ï¼Œå°±å¿…é ˆèµ°OAuth 2.0æˆæ¬Šæ–¹å¼å–å¾—ç”¨æˆ¶æˆæ¬Šï¼›&lt;br>
ä¾‹å¦‚èªª Drive / Sheet / Doc / Google+Â â€¦ ç­‰ç­‰ã€‚&lt;/li>
&lt;li>&lt;strong>API keysï¼š&lt;/strong>&lt;br>
å¦‚æœæ˜¯å–®ç´”ä½¿ç”¨Googleæä¾›çš„å°å¤–æœå‹™ï¼Œä¾‹å¦‚ Map / URL Shortener / Geocoding ç­‰ã€‚&lt;br>
API Keysä½¿ç”¨è »ç°¡å–®çš„ï¼Œä¹Ÿä¸æ˜¯é€™æ¬¡ä½¿ç”¨é‡é»ï¼Œå°±ä¸å¦å¤–è´…è¿°ã€‚&lt;/li>
&lt;/ol>
&lt;p>é€™æ¬¡è¦ä½¿ç”¨ Sheet API å°±éœ€èµ° OAuth 2.0æˆæ¬Šï¼ŒGoogle æ”¯æ´å¤šç¨®&lt;a class="link" href="https://developers.google.com/identity/protocols/OAuth2" target="_blank" rel="noopener"
>OAuth 2.0 æˆæ¬Šæ–¹å¼&lt;/a>ï¼š&lt;/p>
&lt;h3 id="server-side-webapp">Server-Side WebÂ App&lt;/h3>
&lt;p>APPä¸»å‹•è§¸ç™¼ï¼Œè®“ç”¨æˆ¶ç™»å…¥Googleå¸³è™Ÿä¸¦æˆæ¬Šï¼Œæ¥è‘—é€é redirect æˆ–å…¶ä»–æ–¹å¼å–å¾—codeï¼Œæœ€å¾Œç”¨codeå»æ›tokenã€‚&lt;br>
é€™ä¹Ÿæ˜¯å°çµ‚ç«¯ç”¨æˆ¶æœ€ç‚ºå¸¸è¦‹çš„æˆæ¬Šæ–¹å¼ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__kYLCVa75Nl6Fb3dt.png"
loading="lazy"
alt="From Google"
>
From Google&lt;/p>
&lt;h3 id="applications-on-limited-input-devices">Applications on limited-input devices&lt;/h3>
&lt;p>é©ç”¨æ–¼åœ¨æ²’æœ‰è¢å¹•æˆ–æ˜¯è¼¸å…¥çš„è£ç½®ï¼Œä¾‹å¦‚åˆ—å°æ©Ÿã€TVç­‰åµŒå…¥å¼è£ç½®&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__ueo8fqWlyUkudIPy.png"
loading="lazy"
alt="From Google"
>
From Google&lt;/p>
&lt;p>é€™è£¡åŒæ¨£æ˜¯ Appä¸»å‹•è§¸ç™¼ï¼Œä½†è®Šæˆå›å‚³ä¸€å€‹URLé€£çµï¼Œç”¨æˆ¶å¿…é ˆå¦å¤–æ‰¾æ”¯æ´ç€è¦½å™¨è£ç½®è¼¸å…¥URLä¸¦æˆæ¬Šï¼›&lt;br>
é€™è£¡å› ç‚º App(ex. TV)è·Ÿç”¨æˆ¶æˆæ¬Šçš„è£ç½®(ex. æ‰‹æ©Ÿ)ä¸åŒï¼Œå…©è€…è¾¨è­˜ç”¨æˆ¶æ–¹å¼é€é device code(â€œcodeâ€ &amp;amp; URL -&amp;gt; User)ï¼ŒAppé€épollingä¸æ–·é–“éš”è«‹æ±‚Googleæ‰èƒ½çŸ¥é“è©² device code çš„ç”¨æˆ¶æ˜¯å¦å·²ç¶“æˆæ¬Šï¼Œå¾ŒçºŒæµç¨‹å°±ç›¸åŒã€‚&lt;/p>
&lt;p>ä½†é ˆæ³¨æ„æ­¤æµç¨‹æˆæ¬Šçš„æ¬Šé™ä¸å¤šï¼Œéœ€è¦å…ˆè©•ä¼°ï¼Œå› ç‚ºæˆ‘å°ˆæ¡ˆéœ€è¦ Sheet APIæˆæ¬Šï¼Œé€™å€‹æˆæ¬Šæµç¨‹å°±ä¸æ”¯æ´ï¼Œæ‰€ä»¥ç„¡æ³•æ¡ç”¨ã€‚&lt;/p>
&lt;h3 id="server-to-server">Server-to-Server&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__013W__2kCyhYRycgb.png"
loading="lazy"
alt="From Google"
>
From Google&lt;/p>
&lt;p>åœ¨Google APIs Consoleä¸­çš„æ†‘è­‰æ¬„ä½ï¼Œé™¤äº†APIé‡‘é‘° / OAuth 2.0 ç”¨æˆ¶ç«¯ ID ï¼Œç¬¬ä¸‰å€‹èƒ½å¤ å‰µå»ºçš„å°±æ˜¯ &lt;code>æœå‹™å¸³æˆ¶é‡‘é‘°&lt;/code>ï¼Œæœå‹™å¸³è™Ÿåƒæ˜¯å‰µå»ºä¸€å€‹æ–°çš„ç”¨æˆ¶ï¼Œåªæ˜¯æ­¤ç”¨æˆ¶æ˜¯è¢«ç”¨æ–¼ Server ç«¯æˆæ¬Šï¼Œä¸¦é€é IAM ç®¡ç†æ¬Šé™ã€‚&lt;/p>
&lt;p>é€éæœå‹™å¸³è™Ÿæœ€å¤§å¥½è™•æ˜¯æ‡‰ç”¨ç¨‹å¼æ˜¯æˆæ¬Šæ–¼æœå‹™å¸³è™Ÿï¼Œè€Œéå€‹é«”ç”¨æˆ¶ï¼Œåƒæ˜¯é‡åˆ°äººå“¡æµå‹•å°±ä¸éœ€è¦æ‰‹å‹•åœ¨ç®¡ç†æˆæ¬Šï¼›&lt;br>
è€Œä¸”ä¹Ÿä¸éœ€è¦åœ¨ Clientåˆè¦è·³å‡ºç”¨æˆ¶æˆæ¬Šé é¢ï¼Œéå¸¸é©åˆç”¨æ–¼å°å…§çš„å°ˆæ¡ˆé–‹ç™¼(æ­¤æµç¨‹åˆç¨±ç‚º two-legged OAuth)ã€‚&lt;/p>
&lt;p>ä¹Ÿæ˜¯æˆ‘å€‘é€™æ¬¡æœƒå˜—è©¦çš„æµç¨‹ä¹‹ä¸€ã€‚&lt;/p>
&lt;h3 id="long-livetoken">Long LiveÂ Token&lt;/h3>
&lt;p>æˆæ¬Šå¾ŒGoogleæœƒå›å‚³tokenï¼Œä½†tokenéƒ½æ˜¯çŸ­æœŸçš„åªæœ‰ä¸€å°æ™‚çš„å£½å‘½ï¼ŒGoogleä¸¦ä¸åƒFBï¼Œ&lt;code>ä¸æœƒæ ¸ç™¼é•·æœŸç„¡é™æœŸçš„Token&lt;/code> ï¼Œåä¹‹Googleæ˜¯ä¸æ–·çš„é€é refresh tokenæ©Ÿåˆ¶ï¼Œä¸æ–·çš„æ ¸ç™¼çŸ­æœŸTokenï¼Œè€Œrefreshæ¬¡æ•¸æ˜¯æ²’æœ‰é™åˆ¶ï¼Œä¹Ÿä¸éœ€è¦ç”¨æˆ¶å†æ¬¡æˆæ¬Šï¼Œæ‰€ä»¥å¯ä»¥é•·æœŸå„²å­˜èµ·ä¾†ä½¿ç”¨ã€‚&lt;/p>
&lt;p>ä½†å¿…é ˆæ³¨æ„ï¼Œå¦‚æœç™¼ç”Ÿä»¥ä¸‹å¹¾é» refresh tokenæ©Ÿåˆ¶æœƒå¤±æ•ˆ&lt;br>
1. ç”¨æˆ¶å–æ¶ˆå°æ‡‰ç”¨ç¨‹å¼çš„æˆæ¬Š&lt;br>
2. refresh tokenè¶…é6å€‹æœˆæ²’æœ‰ä½¿ç”¨&lt;br>
3. ç”¨æˆ¶æ›´æ”¹å¸³è™Ÿå¯†ç¢¼ä¸”refresh tokenå«Gmailçš„æ¬Šé™&lt;br>
4. ç”¨æˆ¶æ“æœ‰å¤ªå¤šrefresh tokenï¼Œç›®å‰æ˜¯æ¯å€‹æ‡‰ç”¨ç¨‹å¼æ¯ç”¨æˆ¶ä¸Šé™50å€‹refresh tokenã€‚&lt;br>
5. ç”¨æˆ¶æœ¬èº«ä¹Ÿå­˜åœ¨è‘—refresh tokenç¸½æ•¸ä¸Šé™ï¼Œä½†æ–‡ä»¶åªå¯«åˆ°æ­£å¸¸ç‹€æ³ä¸æœƒç™¼ç”Ÿï¼Œæ²’æœ‰æ˜è¬›å¤šå°‘ã€‚&lt;/p>
&lt;h3 id="å¯¦ä½œ">å¯¦ä½œ&lt;/h3>
&lt;p>é€™ä¸€æ­¥ä¸»è¦æ˜¯å…ˆå–å¾— access tokenèˆ‡ refresh tokenã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://developers.google.com/sheets/api/quickstart/nodejs?authuser=1&amp;amp;hl=zh-cn" target="_blank" rel="noopener"
>&lt;strong>Node.js Quickstart | Sheets API | Google Developers&lt;/strong>&lt;/a>&lt;/p>
&lt;p>Google Sheet APIæœ‰å€‹ Node.js å¿«é€Ÿä¸Šæ‰‹èªªæ˜ï¼Œä¸¦ç”¨ &lt;a class="link" href="https://github.com/google/google-api-nodejs-client" target="_blank" rel="noopener"
>google-api-nodejs-client&lt;/a>ï¼Œé‹è¡Œå¾Œæœƒåœ¨çµ‚ç«¯æ©Ÿå‡ºç¾æˆæ¬ŠURLï¼Œé»æ“Šå¾Œå°±å¯ä»¥å–å¾—tokenã€‚&lt;/p>
&lt;p>ä½†æˆ‘å€‹äººä¸æ„›&lt;a class="link" href="https://github.com/google/google-api-nodejs-client" target="_blank" rel="noopener"
>google-api-nodejs-client&lt;/a> çš„å¯«æ³•ï¼Œå› ç‚ºæ˜¯æ¡ç”¨å±¤å±¤ Callbackçš„æ–¹å¼ï¼Œé‚„ä¸å¦‚è‡ªå·±æ¥REST APIä¾†å¾—æ¸…çˆ½ã€‚&lt;/p>
&lt;p>scopeéƒ¨åˆ†éœ€è¦å–å¾— &lt;code>[https://www.googleapis.com/auth/drive](https://www.googleapis.com/auth/drive) [https://www.googleapis.com/auth/spreadsheets](https://www.googleapis.com/auth/spreadsheets)&lt;/code>&lt;/p>
&lt;h3 id="oauth-20-for-web-server-applications-å–å¾—æˆæ¬Šæ–¹å¼">OAuth 2.0 for Web Server Applications å–å¾—æˆæ¬Šæ–¹å¼&lt;/h3>
&lt;p>é€™å€‹åšæ³•æœƒé€éç€è¦½å™¨å–å¾—ç”¨æˆ¶æˆæ¬Šï¼Œä¸¦å„²å­˜ refresh_tokenï¼Œæ–¹ä¾¿å¾ŒçºŒServerå‘¼å«APIä½¿ç”¨ã€‚&lt;/p>
&lt;p>éœ€æ³¨æ„Google OAuth2ç™»å…¥æ–‡ä»¶ä¸¦æ²’æœ‰æ˜è¬›å¦‚ä½•å–å¾—refresh_tokenï¼Œæ‰€ä»¥æŸ¥äº†ä¸€ä¸‹ä½œæ³•&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/10827920/not-receiving-google-oauth-refresh-token?utm_medium=organic&amp;amp;utm_source=google_rich_qa&amp;amp;utm_campaign=google_rich_qa" target="_blank" rel="noopener"
>&lt;strong>Not receiving Google OAuth refresh token&lt;/strong>&lt;/a>&lt;/p>
&lt;p>æ–‡ç« ä¸­çš„è§£ç­”èªªè¦ &lt;code>approval_prompt=force&amp;amp;access_type=offline&lt;/code> æˆ‘å˜—è©¦æ˜¯ä¸è¡Œçš„ï¼Œå¾Œä¾†é©—è­‰çµæœæ˜¯å¿…é ˆåœ¨ redirect URLä¸­åŒæ™‚åŠ å…¥&lt;code>prompt=consent&amp;amp;access_type=offline&lt;/code>&lt;/p>
&lt;p>é€™éƒ¨åˆ†æ¯”è¼ƒç°¡å–®å¸¸è¦‹ï¼Œå°±ä¸è´…è¿°ã€‚&lt;/p>
&lt;h3 id="server-to-server-å–å¾—æˆæ¬Š">Server-to-Server å–å¾—æˆæ¬Š&lt;/h3>
&lt;p>é€™éƒ¨åˆ†Googleæ–‡ä»¶å¼·çƒˆå»ºè­°ä½¿ç”¨sdkè€Œé REST APIï¼Œä¸»è¦æ˜¯å› ç‚ºServer-to-Serveræ˜¯é€éåŠ å¯†JSON Web Tokens (JWTs)å¯¦ä½œï¼Œå¦‚æœå‡ºéŒ¯å®¹æ˜“æœ‰è³‡å®‰é¢¨éšªï¼Œä½†ç¯„ä¾‹é‚„æ˜¯æ¡ç”¨æ¥ REST API&lt;/p>
&lt;ol>
&lt;li>é¦–å…ˆå…ˆåˆ° &lt;a class="link" href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener"
>Google APIs Console&lt;/a> åŠ å…¥æ†‘è­‰ï¼Œé€™æ¬¡è¦åŠ å…¥çš„æ˜¯æœå‹™å¸³è™Ÿé‡‘é‘°ï¼Œè¨˜å¾—è¦ä¸‹è¼‰ jsonæª”çš„é‡‘é‘°æª”æ¡ˆ&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__1M5Qa1SGllse7Oghqfwl7Q.png"
loading="lazy"
>&lt;/p>
&lt;p>2. æ¥è‘—åˆ° IAMç®¡ç†æ¬Šé™ï¼Œæ‰¾åˆ°å‰›æ‰çš„æœå‹™å¸³è™Ÿ Emailï¼Œé¡ä¼¼æ–¼Â &lt;code>â€¦.@â€¦.iam.gserviceaccount.com&lt;/code>ï¼Œä¸¦åŠ å…¥ã€ŒService Management ç®¡ç†å“¡ã€æ¬Šé™ï¼Œæ‰èƒ½æ“ä½œAPIã€‚&lt;/p>
&lt;p>3. è¨˜å¾—æ¯”å‰›æ‰çš„æœå‹™å¸³è™ŸåŠ å…¥è¡¨å–®çš„å…±åŒç·¨è¼¯è€…ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__uobyyholII4abCvitAC9fg.png"
loading="lazy"
>
&lt;img src="https://yuanchieh.page/post/img/1__W0O65uuktYNrJcugUzVXqg.png"
loading="lazy"
alt="å·¦åœ–ç‚ºIAMç®¡ç† / å³åœ–ç‚ºè¡¨å–®å…±ç”¨è¨­å®š"
>
å·¦åœ–ç‚ºIAMç®¡ç† / å³åœ–ç‚ºè¡¨å–®å…±ç”¨è¨­å®š&lt;/p>
&lt;p>éœ€æ³¨æ„ Server-to-Serverä¸æœƒæœ‰ refresh_tokenï¼ŒtokenéæœŸå°±å¿…é ˆé‡æ–°ç”¢ç”ŸJWTä¸¦å–å¾—æ–°çš„tokenã€‚&lt;/p>
&lt;p>æ–‡ä»¶ä¸­æœ‰æåˆ°ï¼Œéƒ¨åˆ†APIå¯ä»¥ç”¨JWTè€Œä¸ç”¨access tokenå°±å¯ä»¥å‘¼å«ï¼Œä½†åŒæ¨£åªæœ‰éƒ¨åˆ†æ”¯æ´ï¼Œæ‰€ä»¥é¿å…è¸©å‘é‚„æ˜¯çµ±ä¸€ç”¨ access tokenã€‚&lt;/p>
&lt;h3 id="sheet-apiä½¿ç”¨">Sheet APIÂ ä½¿ç”¨&lt;/h3>
&lt;p>&lt;a class="link" href="https://developers.google.com/sheets/api/guides/concepts?authuser=1&amp;amp;hl=zh-cn" target="_blank" rel="noopener"
>&lt;strong>Introduction to the Google Sheets API | Sheets API | Google Developers&lt;/strong>&lt;/a>&lt;/p>
&lt;p>Google Sheet APIæœ‰å…©å€‹éƒ¨åˆ†ï¼š&lt;br>
1. å–®ç´”è®€è·Ÿå¯«æ˜¯åœ¨ &lt;a class="link" href="https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values?authuser=1&amp;amp;hl=zh-cn" target="_blank" rel="noopener"
>spreadsheets.values&lt;/a>åº•ä¸‹&lt;br>
2. å…¶é¤˜è¡¨å–®çš„å±¬æ€§(åˆä½µæ¬„ä½ã€æ›´æ”¹æ¬„ä½é¡è‰²ç­‰)ç­‰åœ¨ &lt;a class="link" href="https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets?authuser=1&amp;amp;hl=zh-cn" target="_blank" rel="noopener"
>spreadsheets&lt;/a>åº•ä¸‹&lt;/p>
&lt;p>é€™æ¬¡åªæœ‰å–®ç´”çš„è®€å¯«ï¼Œæ‰€ä»¥å°±åªç ”ç©¶ä¸Šè€…ã€‚&lt;/p>
&lt;p>æ“ä½œè¡¨å–®APIï¼Œé¦–å…ˆéœ€è¦å…ˆå‰µå»ºä¸€å€‹ Googleè¡¨å–®ï¼Œé€£çµå¤§æ¦‚æœƒæ˜¯&lt;br>
&lt;a class="link" href="https://docs.google.com/spreadsheets/d/1dMJEsOayj7RxMJ4-dX7LnrDOxqNzi1WeV3ref6q2okY/edit#gid=0" target="_blank" rel="noopener"
>https://docs.google.com/spreadsheets/d/1dMJâ€¦../edit#gid=0&lt;/a>&lt;/p>
&lt;p>&lt;code>1dMJâ€¦.&lt;/code> ä»£è¡¨æ˜¯è¡¨å–®çš„IDï¼Œè€Œ &lt;code>gid={id}&lt;/code>å‰‡æ˜¯å…§é çš„IDï¼Œåœ¨APIç”¨å…§é åç¨±ç›´æ¥æè¿°å¦‚ sheet1(ä¹Ÿæ”¯æ´ä¸­æ–‡å¦‚ &lt;code>è¡¨å–®ä¸€&lt;/code>)ï¼›&lt;br>
æ•´é«”ä¸ŠAPIæ“ä½œå¯ä»¥ è®€/å¯«/å¯«å…¥æ–‡ä»¶æœ€å¾Œ(Append)/æ¸…é™¤ï¼Œæ¯ç­†APIéƒ½å¯ä»¥æŒ‡å®šç¯„åœå¦‚ &lt;code>A1:A5&lt;/code> ï¼Œå°±è·Ÿä¸€èˆ¬è¡¨å–®æ“ä½œé¡ä¼¼ã€‚&lt;/p>
&lt;p>ç¨‹å¼ç¢¼è«‹åƒè€ƒ&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/google-sheet-api-test" target="_blank" rel="noopener"
>&lt;strong>sj82516/google-sheet-api-test&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åœ¨æ’å…¥æ¬„ä½çš„éƒ¨åˆ†(APIå¦‚ append / update)ï¼Œæœ‰å€‹åƒæ•¸å¯ä»¥æŒ‡å®šGoogle Sheetå¦‚ä½•è™•ç†è¼¸å…¥çš„æ¬„ä½(valueInputOption)ï¼Œå¯ä»¥æŒ‡å®šç‚ºï¼š&lt;br>
1. RAWï¼Œä¸è™•ç†å®Œå…¨ä¾ç…§è¼¸å…¥&lt;br>
2. USER_ENTEREDï¼ŒæŒ‰ç…§ä¸€èˆ¬ Google Sheetè¼¸å…¥è™•ç†ï¼Œå¦‚ &lt;code>=MAX(A1:A2)&lt;/code> å°±æœƒè‡ªå‹•è½‰æˆå…¬å¼ï¼Œå­—ä¸²å¦‚æœç¬¦åˆæ ¼å¼æœƒè¢«è½‰è£½æˆæ•¸å­—ç­‰ã€‚&lt;br>
3. INPUT_VALUE_OPTION_UNSPECIFIEDï¼Œæœ‰è¶£çš„æ˜¯é€™å€‹&lt;code>é è¨­å€¼ä¸èƒ½ç”¨&lt;/code>ï¼ŒAPIæœƒå ±éŒ¯ã€‚&lt;/p>
&lt;p>å¦ä¸€å€‹åƒæ•¸æ˜¯è™•ç† Concurrency å•é¡Œï¼ŒInsertDataOptionå¯ä»¥æŒ‡å®šç•¶é‡åˆ°æ’å…¥æ–°æ¬„æ™‚é‡ä¸Šæ‰‹å‹•æ›´æ–°æ™‚ï¼Œé¸æ“‡è¦†è“‹ OVERWRITE æˆ–æ˜¯æ’å…¥åœ¨æ–°æ¬„ä½ INSERT_ROWSã€‚&lt;/p>
&lt;p>é€™æ¬¡åªæœ‰ç°¡å–®ç”¨åˆ° read / append é€™å…©å€‹APIï¼Œreadå¯ä»¥æŒ‡å®šç¯„åœï¼Œappendè »æœ‰è¶£çš„å¦‚æœæœ‰æ‰‹å‹•æ’å…¥æ–°æ¬„ï¼Œæˆ–æ˜¯æ‰‹å‹•Deleteæ•´å€‹è¡¨å–®ï¼Œä¸‹æ¬¡ appendæœƒè‡ªå‹•æ­£ç¢ºçš„ä½ç½®é–‹å§‹ï¼Œé€™é»å€’ä¸éœ€è¦æ“”å¿ƒã€‚&lt;br>
å…¶é¤˜çš„å¯«å…¥/æ›´æ–°/åˆªé™¤éƒ½æ²’ç”¨ä¸Šï¼Œä¸éåœ¨æ–‡ä»¶ä¸­çš„åƒè€ƒç¶²é æœ‰æä¾›æ¸¬è©¦å¾ˆæ–¹ä¾¿ã€‚&lt;/p>
&lt;h3 id="è£œæ›´æ’å…¥æ–°è¡Œæ–¼è¡¨å–®æœ€ä¸Šå±¤">è£œæ›´ï¼šæ’å…¥æ–°è¡Œæ–¼è¡¨å–®æœ€ä¸Šå±¤&lt;/h3>
&lt;p>é€éappendæ˜¯å°‡æ–°è¡Œæ’åœ¨è¡¨å–®æœ€ä¸‹å±¤ï¼Œä½†å¾ˆå¤šæ™‚å€™æˆ‘å€‘å¸Œæœ›å¾Œé¢çš„è³‡æ–™å‡ºç¾åœ¨æœ€ä¸Šå±¤ï¼ŒæŸ¥äº†ä¸€ä¸‹SOï¼Œæœ‰å€‹è§£æ³•æ˜¯å…ˆå‰µå»ºæ–°è¡Œå†å°‡å€¼æ›´æ–°é€²å»&lt;/p>
&lt;h3 id="push-notification">Push Notification&lt;/h3>
&lt;p>è©¦æƒ³å¦‚æœè¡¨å–®æœ‰æ–°å¢è³‡æ–™ï¼Œå¯ä»¥è‡ªå‹•é€šçŸ¥Serverå°±èƒ½è™•ç†ä¸€äº›æ›´é€²éšçš„éœ€æ±‚ï¼›Google Drive API æä¾› Push Notificationï¼Œè€Œè¡¨å–®èº«ç‚º Driveä¸‹çš„å…¶ä¸­ä¹‹ä¸€æª”æ¡ˆå‹æ…‹ï¼Œä¹Ÿæœ‰æ”¯æ´æ­¤åŠŸèƒ½ï¼Œé‚£å°±ä¾†ç ”ç©¶ä¸€ä¸‹å§ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://developers.google.com/drive/api/v3/push" target="_blank" rel="noopener"
>&lt;strong>Push Notifications | Drive REST API | Google Developers&lt;/strong>&lt;/a>&lt;/p>
&lt;p>åƒè€ƒ &lt;a class="link" href="https://developers.google.com/drive/api/v2/reference/files/watch" target="_blank" rel="noopener"
>Files: watch&lt;/a> æ–‡ä»¶èªªæ˜ï¼Œä»¥ä¸‹ç‚ºæ“ä½œæ­¥é©Ÿ&lt;/p>
&lt;ol>
&lt;li>å®šç¾©å¥½callback urlä¸¦é€šéç¶²åŸŸé©—è­‰ï¼š&lt;br>
å› ç‚ºæ˜¯webhooké—œä¿‚ï¼Œæ‰€ä»¥å¿…é ˆå®šç¾©å¥½ Googleå›å‘¼çš„ callback urlï¼Œé€™éƒ¨åˆ†éœ€è¦å† Google API Console &amp;gt; æ†‘è­‰ &amp;gt; ç¶²åŸŸé©—è­‰ç”³è«‹ï¼Œç¶²åŸŸé©—è­‰æœ‰å¤šç¨®æ–¹å¼ï¼Œæœ€ç°¡å–®æ˜¯Googleæœƒæä¾›ä¸€ä»½htmlä¸¦æŒ‡å®šè¦æ”¾åœ¨ç¶²åŸŸçš„å°æ‡‰è·¯å¾‘ä¸‹ï¼Œç”¨æ–¼é©—è­‰ç¶²åŸŸæ˜¯å±¬æ–¼æœ¬äººçš„ã€‚&lt;/li>
&lt;li>å‘¼å«API&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">axios&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="sb">`https://www.googleapis.com/drive/v2/files/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">spreadsheet_id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">/watch\`, {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> type: &amp;#39;web_hook&amp;#39;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> id: &amp;#39;channelIdAndShouldBeUnique&amp;#39;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb"> address: \`&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">/drive/webhook\`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb">});
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>address æ”¾ callback urlï¼Œidå‰‡æ˜¯è‡ªè¡Œå®šç¾©channelï¼Œåˆ°æ™‚å€™å›å‘¼ç”¨æ–¼é©—è­‰ï¼Œtypeå›ºå®šç‚º web_hookã€‚&lt;/p>
&lt;p>Googleå›å‘¼æ˜¯ç”¨POSTï¼Œä½†æ˜¯å…§å®¹æ˜¯æ”¾åœ¨headerï¼Œä»¥ &lt;code>x-goog-&lt;/code> é–‹é ­çš„æ¨™é ­ï¼Œåè€Œbodyä¸­æ²’æœ‰è³‡æ–™ã€‚&lt;/p>
&lt;p>ä½†ä¸å¾—ä¸èªªGoogleçš„Push Notificationæœ‰é»å¼±ï¼Œå› ç‚ºä»–åªæœƒå›å‚³å“ªå€‹æª”æ¡ˆæ”¹äº†ã€channel IDç­‰ï¼Œä½†ä¸æœƒæœ‰å¯¦è³ªçš„æ”¹è®Šå…§å®¹ï¼Œä¾‹å¦‚è¡¨å–®çš„å“ªä¸€è¡Œä¿®æ”¹ã€å“ªä¸€è¡Œæ–°å¢ç­‰ç­‰ï¼›&lt;br>
ä¸éä¹Ÿæ˜¯ï¼Œå› ç‚ºé€™æ˜¯å»£æ³›çš„Driveæª”æ¡ˆç•°å‹•é€šçŸ¥ï¼Œæ‰€ä»¥ä¸æœƒæœ‰å¤ªç´°ç·»çš„å…§å®¹å‘ˆç¾ã€‚&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;p>ä»¥ä¸Šæ˜¯Google OAuth2 æˆæ¬Šæ¨¡å¼ç ”ç©¶ï¼Œä»¥åŠç°¡å–®çš„Google Sheet APIç ”ç©¶ï¼Œè©•ä¼°å¾Œç¬¦åˆå°ˆæ¡ˆçš„éœ€æ±‚&lt;br>
1. Serverä¸»å‹•appendéå¢è³‡æ–™&lt;br>
2. ä¿ç•™Googleè¡¨å–®åŸå§‹åŠŸèƒ½&lt;br>
3. å–å¾—Googleè¡¨å–®ç•°å‹•è§¸ç™¼&lt;/p>
&lt;p>å› ç‚ºæ˜¯å°å…§å°ˆæ¡ˆï¼Œæ‰€ä»¥æ˜¯æ¡ç”¨ Server-to-Serveræˆæ¬Šæ–¹å¼ã€‚&lt;/p>
&lt;p>å¯æƒœä¸èƒ½å¾—çŸ¥æ›´é€²ä¸€æ­¥çš„ç•°å‹•ï¼Œåªèƒ½è‡ªå·±é‡æ–°æŠ“è³‡æ–™ï¼Œåœ¨Serverç«¯é‡æ–°æ¯”å°ã€‚&lt;/p>
&lt;p>å¦å¤–Google Sheeté‚„å¯ä»¥é€é App Scriptæ’å…¥è³‡æ–™ï¼Œå®¢è£½åŒ–å‰ç«¯ï¼Œä¹‹å¾Œæœ‰ç©ºå†ä¾†ç ”ç©¶ã€‚&lt;/p></description></item><item><title>è³‡æ–™åº« Isolation level èˆ‡å¯¦éš›æ‡‰ç”¨æƒ…å¢ƒè™•ç†</title><link>https://yuanchieh.page/posts/2018/2018-05-28-%E8%B3%87%E6%96%99%E5%BA%AB-isolation-level-%E8%88%87%E5%AF%A6%E9%9A%9B%E6%87%89%E7%94%A8%E6%83%85%E5%A2%83%E8%99%95%E7%90%86/</link><pubDate>Mon, 28 May 2018 09:29:27 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-05-28-%E8%B3%87%E6%96%99%E5%BA%AB-isolation-level-%E8%88%87%E5%AF%A6%E9%9A%9B%E6%87%89%E7%94%A8%E6%83%85%E5%A2%83%E8%99%95%E7%90%86/</guid><description>&lt;p>Transaction äº¤æ˜“æ©Ÿåˆ¶ï¼Œå¯ä»¥è®“å–®ä¸€æˆ–å¤šç­†æ“ä½œèšåˆç‚ºå–®ä¸€çš„åŸå­æ€§æ“ä½œï¼Œä¸€æ¬¡æ€§æˆåŠŸå¯«å…¥æˆ–å¤±æ•—å›æ»¾ï¼Œé¿å…è³‡æ–™åº«å‡ºç¾è³‡æ–™ä¸ä¸€è‡´çš„ç‹€æ³ã€‚&lt;/p>
&lt;p>Isolationï¼Œé—œè¯å¼è³‡æ–™åº«çš„åŸºæœ¬è¦ç´ ä¹‹ä¸€ï¼Œæè¿°ç•¶åŒæ™‚æœ‰å¤šç­†è«‹æ±‚è¦è®€å¯«åŒä¸€ç­†è³‡æ–™æ™‚çš„è™•ç†ç‹€æ³ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹åƒè€ƒ ã€ŠDesigning Data-Intensive Applicationã€‹ç¬¬ä¸ƒç« èˆ‡&lt;/p>
&lt;p>&lt;a class="link" href="https://medium.com/@mz026/%E9%80%8F%E9%81%8E-payment-service-%E8%88%87-db-isolation-level-%E6%88%90%E7%82%BA%E8%8E%AB%E9%80%86%E4%B9%8B%E4%BA%A4-a2d035049038" target="_blank" rel="noopener"
>&lt;strong>é€é Payment Service èˆ‡ DB Isolation Level æˆç‚ºè«é€†ä¹‹äº¤&lt;/strong>&lt;/a>&lt;/p>
&lt;p>è¶Šé«˜å±¤ç´šçš„Isolationæå‡è³‡æ–™çš„ä¸€è‡´æ€§ï¼Œä½†ä¹Ÿå¸¶ä¾†æ•ˆèƒ½ä¸Šçš„æè€—ï¼Œä»¥ä¸‹æ•´ç†å¯¦éš›æ‡‰ç”¨é‚è¼¯èˆ‡å°æ‡‰é©åˆçš„ Isolationè¨­è¨ˆã€‚&lt;/p>
&lt;h3 id="dirty-write">Dirty Write&lt;/h3>
&lt;p>è¤‡å¯«å…¶ä»–å°šæœªcommit çš„ transaction æ›´æ–°ã€‚&lt;/p>
&lt;h3 id="dirty-read">Dirty Read&lt;/h3>
&lt;p>è®€å–åˆ°å…¶ä»–Transaction æ›´æ–°ä½†å°šæœª commit çš„å€¼ã€‚&lt;/p>
&lt;h3 id="read-skew-non-repeatable-read">Read Skew (Non Repeatable Read)&lt;/h3>
&lt;p>åœ¨åŒä¸€å€‹ transactionä¸­ï¼Œè®€å–çš„å€¼æœƒå—åˆ°å…¶ä»–commitçš„ transaction æ›´æ–°å½±éŸ¿ã€‚&lt;/p>
&lt;h3 id="phantom-read">Phantom Read&lt;/h3>
&lt;p>ç•¶å…¶ä»–transaction æ’å…¥æˆ–åˆªé™¤è³‡æ–™ï¼Œæœƒå½±éŸ¿åŒä¸€ transactionä¸­å…ˆå¾Œçš„è®€å–ã€‚&lt;/p>
&lt;h3 id="lost-update">Lost Update&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__itWWv776OilCVdD0NghGUg.jpeg"
loading="lazy"
>&lt;/p>
&lt;p>å…©å€‹Transactionéƒ½æ˜¯èµ° &lt;code>å…ˆè®€å–æŸå€¼ -&amp;gt; åŸºæ–¼æŸå€¼é‹ç®— -&amp;gt; æ›´æ–°åŸè³‡æ–™&lt;/code> ï¼Œä¾‹å¦‚èªªè³¼ç¥¨æµç¨‹ï¼Œå¿…é ˆå…ˆæª¢æŸ¥ç¥¨ç¨®çš„å‰©é¤˜ç¥¨åˆ¸ï¼Œå¦‚æœæœ‰å‰©å°±å»ºç«‹è¨‚å–®ä¸¦æ‰£é™¤åé¡ã€‚&lt;/p>
&lt;p>é€™ç‹€æ³å¦‚åŒ ç¥¨åˆ¸å‰›å¥½å‰©ä¸€å¼µï¼ŒT1 / T2 åŒæ™‚è®€å–ç™¼ç¾ç¥¨åˆ¸å‰›å¥½ç‚ºä¸€ï¼Œå…©è€…éƒ½ä»¥ç‚ºå½¼æ­¤å¯ä»¥è²·ç¥¨ï¼Œæ¥è‘— T1 / T2 å…ˆå¾Œå°‡ç¥¨åˆ¸æ•¸é‡æ”¹ç‚ºé›¶ï¼Œé›–ç„¶æœ€å¾Œç¥¨åˆ¸ç‚ºé›¶ä½† T1/T2å»åˆ†åˆ¥æ¶ˆè€—äº†å…©æ¬¡ã€‚&lt;/p>
&lt;h4 id="è§£æ³•">è§£æ³•&lt;/h4>
&lt;ol>
&lt;li>å°‡èªæ³•æ”¹æˆ &lt;code>compare-and-set&lt;/code>ï¼Œå°‡åŸå…ˆè®€å–åˆ°çš„å€¼å¸¶å›æ›´æ–°æ™‚çš„åˆ¤æ–·å¼ä¸­åˆä½µæˆå–®ä¸€SQLï¼Œå¦‚ &lt;code>Update ticket where ticket.num = 1&lt;/code> ï¼Œé€™æ¨£è¼ƒæ™šæ›´æ–°çš„ transactionå°±æœƒæ›´æ–°ä¸åˆ°å¤±æ•— rollbackã€‚&lt;/li>
&lt;li>åœ¨MySQLä¸­ä½¿ç”¨ &lt;code>selectÂ â€¦ for update&lt;/code> ï¼Œé€™æ˜¯ exclusive row lockï¼Œç•¶å–å¾—é–å¾Œå…¶ä»– transaction å¦‚æœè¦ &lt;code>select lock in share mode&lt;/code> / &lt;code>selectÂ ... for update&lt;/code> / &lt;code>update&lt;/code> / &lt;code>delete&lt;/code>éƒ½ä¸èƒ½å–å¾—é–ï¼Œç›´åˆ° commitï¼›&lt;br>
å¾è€Œé¿å…ä¸¦è¡Œè®€å–çš„éŒ¯èª¤ã€‚&lt;br>
(å°æ¯”å¯ä»¥ä¸¦è¡Œè®€å–çš„æ˜¯ &lt;code>selectÂ â€¦ for share&lt;/code> ï¼Œä½†åŒæ¨£æœƒæ’æ–¥å¯«é–)&lt;/li>
&lt;/ol>
&lt;p>ä½¿ç”¨ &lt;code>select for update&lt;/code> å°±å¯ä»¥é¿å… t2 åœ¨ä¸çŸ¥é“ t1æ›´æ–°çš„æƒ…æ³ä¸‹æ›´æ–°ï¼Œå› ç‚º t2 çš„ &lt;code>select for update&lt;/code> å¿…é ˆç­‰åˆ° t1æ›´æ–°å¾Œæ‰èƒ½è®€å–ï¼Œè§£æ±º Lost update å•é¡Œ&lt;/p>
&lt;h3 id="write-skew-andphantom">Write Skew AndÂ Phantom&lt;/h3>
&lt;p>Write Skewæ˜¯ Lost Updateæ›´å»£æ³›åœ°é›†åˆï¼ŒåŒæ¨£æ˜¯è®€å–å¾Œä¿®æ”¹ï¼Œä½†Write Skewè®€å–èˆ‡ä¿®æ”¹çš„å°è±¡å¯ä»¥æ˜¯ä¸åŒçš„(è‹¥ç›¸åŒå‰‡ç‚º Lost Update)ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚èªªï¼š&lt;br>
æœ‰å¼µ æœƒè­°å®¤çš„è¡¨ï¼Œä¸Šé¢è¨˜éŒ„å“ªäº›æœƒè­°å®¤è¢«ä½”ç”¨çš„æ™‚é–“ç´€éŒ„å¦‚ (id1, from 12:00 to 13:00)ï¼Œç•¶ T1 / T2 åŒæ™‚æƒ³è¦é ç´„åŒä¸€é–“æœƒè­°å®¤åŒä¸€å€‹æ™‚æ®µï¼Œåœ¨æƒéå…©è€…éƒ½ä»¥ç‚ºæ²’æœ‰è¢«ä½”ç”¨å°±æ’å…¥æ–°ç´€éŒ„ï¼Œçµæœå°±ç™¼ç”Ÿå…©ç­†é ç´„è¡çªã€‚&lt;/p>
&lt;p>åˆæˆ–æ˜¯ éŠæˆ²æš±ç¨±ä¸å¯é‡è¤‡ï¼ŒT1/T2æƒéå…¨éƒ¨ç”¨æˆ¶åç¨±æ²’æœ‰ç™¼ç”Ÿé‡è¤‡ï¼Œæ’å…¥å¾Œæ‰ç™¼ç¾ T1/T2çš„å€¼æ˜¯é‡è¤‡çš„ã€‚&lt;/p>
&lt;p>ä¸Šé¢å…©å€‹ç¯„ä¾‹æ˜¯ç„¡æ³•é€é Lost Updateæä¾›çš„è§£æ³•ï¼Œå› ç‚ºæ²’æœ‰ä¸€å€‹ç‰¹å®šçš„ row å¯ä»¥å» lockã€‚&lt;/p>
&lt;p>æ•´é«”ä¸Šç™¼ç”ŸWrite Skewçš„æ¢ä»¶æ˜¯&lt;br>
1. Select æŸäº›è³‡æ–™&lt;br>
2. ä¾æ“šä¸Šä¸€æ­¥çš„è³‡æ–™åšåˆ¤æ–·&lt;br>
3. Update / Delete ä¸€äº›è³‡æ–™&lt;br>
Write Skew å°±æ˜¯ç™¼ç”Ÿæ–¼ 2,3 æ­¥ä¹‹é–“åœ¨é‡è¤‡ç¬¬ä¸€å‹•æœƒç™¼ç¾Selectçµæœæ˜¯ä¸ä¸€æ¨£çš„ï¼Œä¹Ÿå°±æ˜¯phantom read çš„å‡ºç¾ã€‚&lt;/p>
&lt;h4 id="è§£æ³•-1">è§£æ³•ï¼š&lt;/h4>
&lt;ol>
&lt;li>ä½¿ç”¨ serializable isolationã€‚&lt;br>
åœ¨MySQL Inno DB serializableä¸­ ï¼Œselectæ˜¯ç”¨è¡¨ç´šå…±äº«é–ï¼Œä¹Ÿå°±æ˜¯ select å¾Œå…¶ä»– selecté‚„æ˜¯å¯ä»¥ç”¨ï¼Œä½†æ˜¯å…¨è¡¨ä¸èƒ½æ’å…¥æ›´æ–°ç­‰&lt;/li>
&lt;li>Materializing conflicts å…·è±¡åŒ–è¡çª&lt;br>
Write Skewæ˜¯Lost Updateçš„è¶…é›†åˆï¼Œæ›è¨€ä¹‹å¦‚æœå¯ä»¥å°‡ Write Skew å•é¡Œé™ç¶­æˆ Lost Updateï¼Œå°±å¯ä»¥å¾ range lock é™ç‚º row lockæå‡æ€§èƒ½ã€‚&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>æœƒç”¢ç”Ÿ Write Skew åœ¨æ–¼æ’å…¥/åˆªé™¤æ™‚æ²’æœ‰ç‰¹å®šçš„é–å¯ä»¥é å…ˆé–ä½è©²è¡Œï¼Œæ›è¨€ä¹‹å¦‚æœå¯ä»¥é å…ˆé–åˆ°å°±å¯ä»¥é¿å…å•é¡Œã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¾‹å¦‚èªªæœƒè­°å®¤è³‡æ–™ï¼Œå‡è¨­æˆ‘å€‘å…ˆå°‡æ‰€æœ‰çš„æœƒè­°å®¤èˆ‡æ™‚é–“è¡¨å…¨éƒ¨æ’å…¥è³‡æ–™åº«ä¸­ï¼Œé€™æ¨£ç•¶æœ‰ transaction è¦é ç´„æœƒè­°å®¤ï¼Œå°±å¯ä»¥ç”¨ &lt;code>select for update&lt;/code> æŸè¡Œè³‡æ–™ï¼Œå°±ä¸æœƒæœ‰å…¶ä»–äººË‹ä¸¦è¡Œé ç´„åŒä¸€é–“åŒä¸€å€‹æ™‚æ®µçš„æœƒè­°å®¤ã€‚&lt;br>
ä½†é€™ä¸æ˜¯è¬ç”¨è§£ï¼Œæœ‰äº›ç‹€æ³ä¸èƒ½é å…ˆçª®èˆ‰æ‰€æœ‰å¯èƒ½ã€‚&lt;/p>
&lt;p>é€™é»åœ¨æ–‡ç« ä¸­ï¼Œæœ‰å€‹ç¯„ä¾‹æœ‰ç”¨ä¸ŠSerializableï¼Œ é€€è²»ä½¿ç”¨ChargeRefund ä¸€å¼µè¡¨ç´€éŒ„ï¼Œè€ŒOrderåœ¨å¦ä¸€å¼µè¡¨ï¼Œæ¯æ¬¡è¦ç”¢ç”Ÿé€€è²»æ™‚å°±å¿…é ˆå…ˆ è®€å–è¨‚å–®ç›¸é—œçš„æ‰€æœ‰Refundè¨ˆç®—é¡åº¦ï¼Œå¦‚æœè¨‚å–®é‚„æœ‰è¶³å¤ é¤˜é¡æ‰æœƒå‰µå»ºæ–°çš„ ChargeRefund é€™æ™‚å€™ç¬¦åˆWrite Skewç™¼ç”Ÿè¦ç´ ï¼Œæ‰€ä»¥ä»–å€‘æ˜¯ç”¨ Serializable å»è§£ï¼›&lt;/p>
&lt;p>æˆ‘å€‘ç¶²ç«™æ˜¯æœƒå°‡ç›®å‰è¨‚å–®é€€è²»é¤˜é¡ç´€éŒ„åœ¨Orderä¸Šï¼Œæ‰€ä»¥åªè¦é€éselect for udpate å»é–è©²ç­†è¨‚å–®å°±å¥½ï¼Œä¸éœ€è¦ç”¨åˆ° Serializableã€‚&lt;/p>
&lt;p>3. åŠ å…¥åˆ¤åˆ¥æ¢ä»¶&lt;br>
åˆ©ç”¨ Consistence ç‰¹æ€§ åŒæ¨£åœ¨æœƒè­°å®¤å•é¡Œï¼Œå¦‚æœå‰µå»ºå€‹ unique cluster index (room_id, startAt, endAt) æˆ–è¨±å°±å¯ä»¥ç”¨é—œé€£å¼è³‡æ–™åº«æœ¬èº«ç‰¹æ€§å»è§£æ±ºï¼Œä½†åŒæ¨£ä¸æ˜¯è¬ç”¨è§£&lt;/p>
&lt;p>æœ‰è¶£çš„æ˜¯ï¼ŒSerializable åœ¨ MySQLä¸­ä¸æ˜¯çœŸæ­£çš„åºåˆ—åŒ–åŸ·è¡Œ Transactionï¼Œä»–é‚„æ˜¯å¯ä»¥ä¸¦è¡Œè™•ç†çš„ï¼Œæ–‡ä»¶ä¸­æœ‰æåˆ°Â &lt;br>
ã€ŒThis level is like &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_repeatable-read" target="_blank" rel="noopener"
>REPEATABLE READ&lt;/a>, but InnoDB implicitly converts all plain &lt;a class="link" href="https://l.facebook.com/l.php?u=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Fselect.html&amp;amp;h=ATOC4ffs6BKSHXBCJcrGevajNQd1g1s7qYsAzfsfTGRFoGXhpjXyzEyFHF19205nddtzOVldg9awOjZll47FXPJlnfY7PURwsQuhbtePwESQX3OagGbirEKa8zgg8CavRkrBQ0g8N8w" target="_blank" rel="noopener"
>SELECT&lt;/a> statements to &lt;a class="link" href="https://l.facebook.com/l.php?u=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Fselect.html&amp;amp;h=ATNwi30GW1C8dJO6U-XEOj-Q557fHQWkGXKkDFZ6yWph7SMPBiVlJ0QKCFJ29k47XhsMI_UQyWDc9YPC-q95T1rMQEkMjkSA9EZnnTc6xuDMa1103rYbhLpEvN-_hGHDjL0735wh6luiAV2wdsIyY4kW" target="_blank" rel="noopener"
>SELECTÂ â€¦ FOR SHARE&lt;/a> if &lt;a class="link" href="https://l.facebook.com/l.php?u=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Fserver-system-variables.html%23sysvar_autocommit&amp;amp;h=ATMitbTaqVv4e7wb_690adrkhYA2FCc7KajjshqR_sU4mUUhp3xQ_Zwsxt8-cUaYdtUB-DW4y2HCSubCiiyJ-vSsiscL6D20NMmi3DmIfjWj_KijnMrUmkCJKRVHWId1NBHX7I81MIo" target="_blank" rel="noopener"
>autocommit&lt;/a> is disabled.ã€&lt;/p>
&lt;p>æ‰€ä»¥è¦é¿å… Write Skewï¼Œé‚„æ˜¯è¦å»æ€è€ƒè¦é–å¤šå°‘å€é–“ï¼Œæˆ–æ˜¯é–æ•´å¼µè¡¨ï¼Œå–®å–®æ”¹æˆ Serializableæ˜¯æ²’è¾¦æ³•è§£æ±ºå•é¡Œçš„&lt;/p>
&lt;p>åœ¨ MySQL InnoDBä¸­ï¼Œselect for update / select lock in share mode åœ¨ Repeatable Readä¸‹ï¼ŒæœƒåŠ ä¸Š Next Key Lockï¼ŒNext Key Lockç­‰åŒæ–¼ row lock åŠ ä¸Š gap lockï¼Œgapå‰‡æ˜¯æ ¹æ“š index æ‹†åˆ†å€æ®µï¼Œé€²è€Œå¯ä»¥åˆ†å€é–å®šï¼Œé˜»æ“‹å¹»è®€çš„ç™¼ç”Ÿï¼› è€Œselect for update åœ¨æ²’æœ‰ where æ¢ä»¶ä¸‹åŸºæœ¬ä¸Šå°±ç­‰åŒæ–¼table lockã€‚&lt;/p>
&lt;p>åœ¨ç ”ç©¶éç¨‹ä¸­ï¼Œæœ‰æ–‡ç« æåˆ° SQL Standard å°æ–¼ isolation levelå®šç¾©æ¨¡ç³Šï¼Œå„å®¶è³‡æ–™åº«çš„å¯¦ä½œä¹Ÿç•¥æœ‰å·®ç•°ï¼Œæ‰€ä»¥ç›¸å°æ–¼æ¡ç”¨é è¨­çš„ isolation levelï¼Œå¯¦éš›äº†è§£ locking æ©Ÿåˆ¶æ¯”è¼ƒå¯¦åœ¨ã€‚&lt;/p>
&lt;h3 id="ç¸½çµ">ç¸½çµï¼š&lt;/h3>
&lt;p>åœ¨æ›¸ä¸­æœ‰æåˆ° SQLæ¨™æº–å°æ–¼ isolation levelçš„å®šç¾©æ˜¯ä¸å¤ªæ˜ç¢ºçš„ï¼Œå°è‡´å„å€‹è³‡æ–™åº«éƒ½æœƒå®šç¾©å„è‡ªçš„isolation levelï¼Œè€Œä¸”éƒ½æœƒæœ‰äº›å¾®çš„å·®ç•°ï¼›&lt;/p>
&lt;p>æ‰€ä»¥èˆ‡å…¶ç›²ç›®çš„å»ä½¿ç”¨å¸¸è¦‹çš„å››ç¨® isolation levelï¼Œæ›´é‡è¦çš„äº‹é‡å°æ¥­å‹™é‚è¼¯å»åˆ†æåˆ°åº• concurrency ç™¼ç”Ÿçš„ç‹€æ³ä»¥åŠå¦‚ä½•é˜²æ­¢ race conditionã€‚&lt;/p></description></item><item><title>The Twelve-Factor App é–±è®€ç­†è¨˜</title><link>https://yuanchieh.page/posts/2018/2018-05-19-the-twelve-factor-app-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/</link><pubDate>Sat, 19 May 2018 07:02:08 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-05-19-the-twelve-factor-app-%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/</guid><description>&lt;p>&lt;a class="link" href="https://12factor.net" target="_blank" rel="noopener"
>&lt;strong>The Twelve-Factor App&lt;/strong>&lt;/a> æ˜¯ç”±ä¸€ç¾¤æœ‰è±å¯Œç¶“é©—çš„å·¥ç¨‹å¸«ï¼Œæ•´ç†é–‹ç™¼ä¸€å€‹Webæ‡‰ç”¨ç¨‹å¼(æˆ–æ˜¯æ‰€è¬‚çš„SAAS software-as-a-service)é–‹ç™¼æ–¹é‡ï¼ŒåŸºæ–¼ä»¥ä¸‹å¹¾å€‹æ–¹å‘&lt;/p>
&lt;ol>
&lt;li>è¨­å®šæ˜ç¢ºï¼Œé™ä½æ–°äººåŠ å…¥å°ˆæ¡ˆçš„ä¸Šæ‰‹æˆæœ¬&lt;/li>
&lt;li>æœ€å¤§åŒ–å¯ç§»æ¤æ€§&lt;/li>
&lt;li>é©åˆéƒ¨ç½²åˆ°é›²ç«¯å¹³å°&lt;/li>
&lt;li>é™ä½é–‹ç™¼èˆ‡éƒ¨ç½²çš„å·®ç•°æ€§ï¼Œå¢åŠ æŒçºŒéƒ¨ç½²çš„æ•æ·&lt;/li>
&lt;li>å®¹æ˜“æ“´å±•(scale up)&lt;/li>
&lt;/ol>
&lt;p>åŸºæ–¼ä¸Šè¿°å¹¾å€‹è¦é»ï¼Œæ•´ç†æˆ12é …è¦ç´ ï¼Œè€Œç¬¦åˆé€™ 12è¦ç´ çš„æ‡‰ç”¨ç¨‹å¼å‰‡ç¨±ç‚º&lt;strong>twelve-factor app (å¾Œæ–‡æœƒæ¡ç”¨æ­¤åè©)&lt;/strong>ï¼Œç€è¦½éå¾Œè »æœ‰è¶£çš„ï¼Œç¨å¾®æ‘˜è¦ä¸¦æå‡ºè‡ªå·±åœ¨å¯¦è¸ä¸Šçš„æƒ³æ³•(ä¸»è¦æ˜¯Nodejsï¼Œä½œè€…çœ‹ä¾†æ¯”è¼ƒæ„›ç”¨Pythonç•¶ç¯„ä¾‹)ã€‚&lt;/p>
&lt;p>ç‚ºé¿å…æ­§ç¾©æˆ–è‹±æ–‡æ°´æº–ä¸ä½³ï¼Œæœ‰äº›é—œéµå­—æœƒä¸­è‹±å¤¾é›œï¼Œæˆ–æ˜¯ç›´æ¥é¡¯ç¤ºè‹±æ–‡å–®å­—ã€‚&lt;/p>
&lt;h2 id="1-codebase">1. Codebase&lt;/h2>
&lt;h4 id="ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ä¸€ä»½codebaseä½†å¯ä»¥æœ‰å¤šä»½éƒ¨ç½²-one-codebase-tracked-in-revision-control-manydeploys">ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ä¸€ä»½Codebaseï¼Œä½†å¯ä»¥æœ‰å¤šä»½éƒ¨ç½² (One codebase tracked in revision control, manyÂ deploys)&lt;/h4>
&lt;p>åŸå§‹ç¢¼å¿…é ˆä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œå¦‚ &lt;a class="link" href="http://git-scm.com/" target="_blank" rel="noopener"
>Git&lt;/a> / &lt;a class="link" href="http://subversion.apache.org/" target="_blank" rel="noopener"
>Subversion&lt;/a> / &lt;a class="link" href="https://www.mercurial-scm.org/" target="_blank" rel="noopener"
>Mercurial&lt;/a>ï¼Œæ¯ä»½APPåªèƒ½æœ‰ä¸€å€‹Code Repoï¼Œä½†å¯ä»¥æœ‰ä¸€ä»½Code Repoå¯ä»¥åŸ·è¡Œå¤šä»½ä¸”ç‰ˆæœ¬ä¸ä¸€æ¨£çš„éƒ¨ç½² Deployï¼›&lt;/p>
&lt;h2 id="2-dependencies">2. Dependencies&lt;/h2>
&lt;h4 id="å‘½ç¢ºå®šç¾©èˆ‡éš”é›¢ç›¸ä¾explicitly-declare-and-isolate-dependencies">å‘½ç¢ºå®šç¾©èˆ‡éš”é›¢ç›¸ä¾(Explicitly declare and isolate dependencies)&lt;/h4>
&lt;p>è¨±å¤šèªè¨€ç¨‹å¼éƒ½æœ‰å°æ‡‰çš„å‡½å¼åº«(library)ç®¡ç†å·¥å…·ï¼Œä¾‹å¦‚Rubyæœ‰Rubygemsã€Perlæœ‰CPANã€NodeJSæœ‰NPM(æˆ–Yarn)ï¼Œåœ¨å®‰è£ä¸Šæœ‰ç³»çµ±å±¤ç´šæˆ–æ˜¯è¢«ä¾·é™æ–¼å°ˆæ¡ˆç›®éŒ„ä¸‹(åˆç¨± bundling / Vendoring)&lt;/p>
&lt;p>ä¸€å€‹æ­£ç¢ºçš„æ‡‰ç”¨ç¨‹å¼ã€Œä¸æ‡‰è©²ä¾è³´ç³»çµ±å±¤ç´šçš„å‡½å¼åº«ã€ï¼Œæ‡‰è©²è¦åœ¨å®£å‘Šæ–‡ä»¶æ˜ç¢ºçš„å®£å‘Šæ‰€æœ‰ä¾è³´çš„å‡½å¼åº«ï¼›&lt;br>
ä¸¦ç¢ºä¿å‡½å¼åº«ä¸æœƒå½±éŸ¿å…¨åŸŸç’°å¢ƒï¼Œä¸¦ç¶­æŒéš”é›¢ã€‚ä¾‹å¦‚NPMåœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ &lt;code>package.json&lt;/code> ï¼Œé è¨­å®‰è£ä¹Ÿæ˜¯åœ¨è©²å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ &lt;code>node_modules&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>æ˜ç¢ºå®šç¾©çš„å¥½è™•æ˜¯å°æ–°äººå‹å–„ï¼Œåªè¦ç€è¦½å®£å‘Šæ–‡ä»¶å°±å¯ä»¥å¾—çŸ¥æ‰€æœ‰ç›¸ä¾çš„å‡½å¼åº«ï¼Œè€Œä¸”é€šå¸¸å‡½å¼åº«ç®¡ç†å·¥å…·éƒ½æœ‰è‡ªå‹•å®‰è£çš„æŒ‡ä»¤ï¼Œå¦‚ &lt;code>npm install&lt;/code>&lt;/p>
&lt;p>å¦å¤–å°ˆæ¡ˆä¹Ÿä¸éš±å¼ä¾è³´ç³»çµ±å·¥å…·ï¼Œä¾‹å¦‚ &lt;code>curl&lt;/code> ã€&lt;code>ImageMagick&lt;/code> ç­‰ï¼Œå› çˆ²å³ä¾¿é€™äº›å·¥å…·åœ¨å¤§å¤šç³»çµ±éƒ½å­˜åœ¨ï¼Œä½†ä¸èƒ½ä¿è­‰æ‡‰ç”¨ç¨‹å¼é‹è¡Œçš„ç’°å¢ƒæœ‰å®‰è£ï¼›&lt;br>
å¦‚æœéœ€è¦ï¼Œå‰‡è€ƒæ…®å°‡ç³»çµ±å·¥å…·ä¹Ÿæ‰“åŒ…é€²æ‡‰ç”¨ç¨‹å¼ä¸­ã€‚&lt;/p>
&lt;h2 id="3-config">3. Config&lt;/h2>
&lt;h4 id="å°‡è¨­å®šå„²å­˜æ–¼ç’°å¢ƒä¸­store-config-in-the-environment">å°‡è¨­å®šå„²å­˜æ–¼ç’°å¢ƒä¸­(Store config in the environment)&lt;/h4>
&lt;p>configæ˜¯é‚£äº›æœƒä¾æ“šéƒ¨ç½²ç’°å¢ƒè€Œæœ‰æ‰€ä¸åŒçš„è³‡æ–™ï¼Œä¾‹å¦‚è³‡æ–™åº«é€£ç·šè³‡æ–™/ AmazonS3ç­‰å¤–éƒ¨æœå‹™çš„æ©Ÿæ•è³‡æ–™ / hostnameç­‰ï¼Œæ‰€ä»¥ä¹Ÿä¸æœƒæ”¾å…¥ç‰ˆæœ¬æ§åˆ¶å·¥å…·è¿½è¹¤ã€‚&lt;/p>
&lt;p>å¿…é ˆæ³¨æ„ï¼Œç¨‹å¼ç¢¼èˆ‡è¨­å®šæª”ã€Œ**å¿…é ˆåš´æ ¼åˆ†é›¢ã€ï¼Œ**ç¨‹å¼ç¢¼æ˜¯æ‰€æœ‰éƒ¨ç½²éƒ½åŒä¸€ä»½ï¼Œä¸¦ä¸”ä¸æ‡‰è©²åŒ…å«ä»»ä½•æ©Ÿæ•è³‡æ–™ã€‚&lt;/p>
&lt;p>è¨±å¤šç¨‹å¼èªè¨€æœ¬èº«æœ‰åå¥½çš„è¨­å®šæ–‡ä»¶æ ¼å¼ï¼Œå¦‚ xml / yml / json ç­‰ï¼Œç‚ºäº†æ–¹ä¾¿æœ€å¥½æ˜¯ä½¿ç”¨å„²å­˜æ–¼ç’°å¢ƒè®Šæ•¸ä¸­ã€‚&lt;/p>
&lt;p>æ­¤å¤–ï¼Œç’°å¢ƒè®Šæ•¸æ‡‰è©²æ˜¯æ¯å€‹ç’°å¢ƒç¨ç«‹æ–¼å½¼æ­¤ï¼Œæ‰€ä»¥ä¸éœ€è¦åƒ Railsç”¨ â€œproductionâ€ / â€œtestâ€/ â€œdevelopmentâ€ åœ¨ç´°æ‹†å®šç¾©ç’°å¢ƒè®Šæ•¸ã€‚&lt;/p>
&lt;p>&amp;gt;&amp;gt; ä½†é€™è£æ¯”è¼ƒtrickyçš„æ˜¯å…¬å¸å°ˆæ¡ˆ stage / prodéƒ½æ˜¯è·‘åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šï¼Œæ²’è¾¦æ³•ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œéƒ½æ˜¯æ¡ç”¨ config.js ç•¶ä½œè¨­å®šæ–‡ä»¶&lt;/p>
&lt;h2 id="4-backingservices">4. BackingÂ services&lt;/h2>
&lt;h4 id="å°‡æ”¯æ´æœå‹™ç•¶ä½œé™„åŠ çš„è³‡æºtreat-backing-services-as-attached-resources">å°‡æ”¯æ´æœå‹™ç•¶ä½œé™„åŠ çš„è³‡æº(Treat backing services as attached resources)&lt;/h4>
&lt;p>é€™è£¡çš„Backing servicesæ³›æŒ‡æ‡‰ç”¨ç¨‹å¼ç›¸ä¾çš„å¤–éƒ¨æœå‹™ï¼Œä¾‹å¦‚è³‡æ–™åº«ã€å¯„ä¿¡æœå‹™å•†ã€å¿«å–è³‡æ–™åº«ç­‰&lt;/p>
&lt;p>&lt;strong>twelve-factor app&lt;/strong> æ‡‰è©²æ˜¯å¯ä»¥åœ¨æŠ½æ›å¤–éƒ¨æ”¯æ´æœå‹™è€Œä¸éœ€è¦æ›´å‹•ç¨‹å¼ç¢¼ï¼Œåªéœ€è¦æ”¹è®Šè¨­å®šæª”ä¸¦é‡å•Ÿè€Œå·²ï¼›&lt;br>
ä¾‹å¦‚èªªå°‡è³‡æ–™åº«å¾æœ¬æ©Ÿç«¯çš„MySQLæ›¿æ›æˆé›²ç«¯ Amazon RDSã€‚&lt;/p>
&lt;h2 id="5-build-releaserun">5. Build, release,Â run&lt;/h2>
&lt;h4 id="åš´æ ¼å€åˆ†å»ºåˆ¶èˆ‡åŸ·è¡Œæ­¥é©Ÿstrictly-separate-build-and-runstages">åš´æ ¼å€åˆ†å»ºåˆ¶èˆ‡åŸ·è¡Œæ­¥é©Ÿ(Strictly separate build and runÂ stages)&lt;/h4>
&lt;p>ç•¶åŸå§‹ç¢¼è¦è½‰æ›æˆéƒ¨ç½²çš„ç¨‹åºæ™‚ï¼Œæœƒç¶“éä¸‰å€‹æ­¥é©Ÿ&lt;br>
1. å»ºç½® buildï¼š&lt;br>
Â å°‡ç¨‹å¼ç¢¼è½‰æ›æˆå¯åŸ·è¡Œçš„åŒ…è£¹(Bundle)ï¼Œé€™æ­¥é©ŸæœƒæŠ“å–å¤–éƒ¨ç›¸ä¾çš„å‡½å¼åº«ä¸¦ç·¨è­¯äºŒé€²åˆ¶æª”æ¡ˆç­‰ã€‚&lt;br>
2. ç™¼å¸ƒ releaseï¼š&lt;br>
å°‡buildå¥½çš„å¯åŸ·è¡ŒåŒ…è£¹ï¼Œä¸¦çµåˆè©²éƒ¨ç½²ç’°å¢ƒçš„è¨­å®šæª”&lt;br>
3. åŸ·è¡Œ runï¼š&lt;br>
åŸ·è¡Œreleaseéšæ®µæ‰“åŒ…å¥½çš„ç¨‹å¼ã€‚&lt;/p>
&lt;p>æ¯ä»½releaseéƒ½å¿…é ˆæœ‰ç‰¹å®šçš„ç·¨è™Ÿï¼Œä¸è«–æ˜¯æ—¥æœŸæ ¼å¼ &lt;code>2011â€“04â€“06â€“20:32:17&lt;/code> æŠ‘æˆ–æ˜¯éå¢ç‰ˆå¥½ &lt;code>v100&lt;/code> ï¼Œæ–¹ä¾¿å¾ŒçºŒæœ‰å•é¡Œå¯ä»¥å›æ»¾ã€‚&lt;br>
æ­¤å¤–ç•¶ç™¼å¸ƒreleaseå¾Œä¸èƒ½æœ‰ä»»ä½•æ›´å‹•ï¼Œåªèƒ½é€éç™¼å¸ƒæ–°çš„releaseã€‚&lt;/p>
&lt;p>&lt;code>å»ºç½®éšæ®µ&lt;/code>é€šå¸¸æ˜¯ç•¶å·¥ç¨‹å¸«è¦ºå¾—æœ‰æ–°çš„ç¨‹å¼ç¢¼æ›´å‹•éœ€è¦éƒ¨ç½²ï¼Œå‰‡ä¸»å‹•è§¸ç™¼çš„ï¼Œæ‰€ä»¥åœ¨å»ºç½®éšæ®µå¯ä»¥åŸ·è¡Œç›¸å°è¤‡é›œçš„æŒ‡ä»¤èˆ‡æ“ä½œï¼Œç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚é‚„å¯ä»¥æœ‰å·¥ç¨‹å¸«æ‰‹å‹•ä¿®å¾©ï¼›&lt;br>
ä½†ç›¸å°åœ¨&lt;code>åŸ·è¡Œéšæ®µ&lt;/code>ï¼Œå¯èƒ½æ˜¯è‡ªå‹•åŒ–åŸ·è¡Œå¦‚æ‡‰ç”¨å´©æ½°å¾Œè‡ªå‹•é‡å•Ÿï¼Œæ‰€ä»¥åœ¨åŸ·è¡Œéšæ®µæ‡‰è©²è¦è¶Šç°¡æ½”è¶Šå¥½ã€‚&lt;/p>
&lt;h2 id="6-processes">6. Processes&lt;/h2>
&lt;h4 id="åŸ·è¡Œç„¡ç‹€æ…‹çš„å–®åŸ·è¡Œç·’æˆ–å¤šåŸ·è¡Œç·’execute-the-app-as-one-or-more-stateless-processes">åŸ·è¡Œç„¡ç‹€æ…‹çš„å–®åŸ·è¡Œç·’æˆ–å¤šåŸ·è¡Œç·’(Execute the app as one or more stateless processes)&lt;/h4>
&lt;p>ä¸€å€‹æ‡‰ç”¨ç¨‹å¼å¯èƒ½æœ‰å–®å€‹æˆ–å¤šå€‹åŸ·è¡Œç·’ï¼Œ&lt;strong>twelve-factor app&lt;/strong> æ‡‰è©²æ˜¯&lt;code>stateless&lt;/code>ä¸” &lt;code>share-nothing&lt;/code> ï¼Œéœ€è¦é•·æœŸä¿å­˜çš„è³‡æ–™å¯ä»¥æ”¾åœ¨å¤–éƒ¨æœå‹™å¦‚è³‡æ–™åº«æˆ–CDNä¸­&lt;/p>
&lt;p>ç¨‹åºçš„è¨˜æ†¶é«”æˆ–æ˜¯æª”æ¡ˆç³»çµ±åªèƒ½ç•¶ä½œæš«æ™‚çš„æ“ä½œç©ºé–“ï¼Œä¾‹å¦‚ä¸‹è¼‰æª”æ¡ˆã€æ“ä½œã€æ¥è‘—å°‡çµæœå„²å­˜æ–¼è³‡æ–™åº«ä¸­ï¼Œæ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç¢ºä¿è¢«æš«å­˜åœ¨å¿«å–èˆ‡æª”æ¡ˆç³»çµ±çš„è³‡æ–™åœ¨æœªä¾†ä¸æœƒè¢«ç”¨ä¸Šï¼›&lt;br>
å› ç‚ºåœ¨å¤šåŸ·è¡Œç·’ä¸‹ï¼ŒæœªçŸ¥çš„è«‹æ±‚å¯èƒ½è¢«ä¸åŒçš„åŸ·è¡Œç·’æ‰€åŸ·è¡Œï¼Œå³ä½¿æ˜¯å–®åŸ·è¡Œç·’ç¨‹å¼ç•¶ç³»çµ±å´©æ½°æ™‚å¿«å–è·Ÿæª”æ¡ˆç³»çµ±çš„è³‡æ–™éƒ½å¯èƒ½æ¶ˆå¤±ã€‚&lt;/p>
&lt;p>æœ‰äº›æ‡‰ç”¨ç¨‹å¼æœƒæ¡ç”¨ &lt;code>sticky-session&lt;/code> ç¢ºä¿åŒä¸€å€‹ç”¨æˆ¶è¢«åŒä¸€å€‹åŸ·è¡Œç·’æ‰€æœå‹™ï¼Œé€™æ˜¯é•åè¦ç¯„çš„ã€‚&lt;br>
æœ‰æ™‚æ•ˆæ€§çš„æš«å­˜ç‹€æ…‹è³‡æ–™(å¦‚session)å¯ä»¥æ”¾åœ¨åƒRedis / Memcachedé€™é¡çš„è³‡æ–™åº«ä¸­ã€‚&lt;/p>
&lt;h2 id="7-portbinding">7. PortÂ binding&lt;/h2>
&lt;h4 id="é€éç¶å®šåŸ å£å°å¤–é–‹æ”¾æœå‹™export-services-via-portbinding">é€éç¶å®šåŸ å£å°å¤–é–‹æ”¾æœå‹™(Export services via portÂ binding)&lt;/h4>
&lt;p>æ‡‰ç”¨ç¨‹å¼æœ‰äº›æ™‚å€™è¢«åŸ·è¡Œåœ¨å…¶ä»–å®¹å™¨ä¸­ï¼Œä¾‹å¦‚ PHPæœå‹™å¯èƒ½åŸ·è¡Œæ–¼ &lt;a class="link" href="http://httpd.apache.org/" target="_blank" rel="noopener"
>Apache HTTPD&lt;/a> / Javaæœå‹™ åŸ·è¡Œæ–¼ &lt;a class="link" href="http://tomcat.apache.org/" target="_blank" rel="noopener"
>Tomcat&lt;/a>ä¸‹ï¼Œä½†æ˜¯ &lt;strong>twelve-factor app&lt;/strong> æ‡‰è©²æ˜¯æœå‹™ç›´æ¥ç¶å®šåŸ å£ä¸¦è™•ç†è«‹æ±‚ã€‚&lt;/p>
&lt;p>é€™é€šå¸¸éƒ½æœ‰å‡½ç¤ºåº«å¯ä»¥æ”¯æ´ï¼Œä¾‹å¦‚ pythonçš„ &lt;a class="link" href="http://www.tornadoweb.org/" target="_blank" rel="noopener"
>Tornado&lt;/a> / Ruby çš„ &lt;a class="link" href="http://code.macournoyer.com/thin/" target="_blank" rel="noopener"
>Thin&lt;/a> ç­‰ï¼Œé€™ä½¿å¾—æ•´ä»½æ‡‰ç”¨ç¨‹å¼éƒ½æ˜¯åœ¨ user-spaceåŸ·è¡Œï¼Œä¸”å…¨éƒ¨åŒ…å«åœ¨åŸå§‹ç¢¼ä¸­ã€‚&lt;/p>
&lt;p>HTTPåªæ˜¯å…¶ä¸­ä¸€å€‹å¯ä»¥ç¶å®šåŸ å£çš„å”å®šï¼Œå…¶ä»–åƒæ˜¯ XMPP / Redis Protocol ç­‰æœå‹™éƒ½éœ€åƒç…§æ­¤è¦ç¯„ã€‚&lt;/p>
&lt;h2 id="8-concurrency">8. Concurrency&lt;/h2>
&lt;h4 id="é€éåŸ·è¡Œç·’æ¨¡å‹æ“´å±•scale-out-via-the-processmodel">é€éåŸ·è¡Œç·’æ¨¡å‹æ“´å±•(Scale out via the processÂ model)&lt;/h4>
&lt;p>æ‡‰ç”¨ç¨‹å¼åœ¨åŸ·è¡Œç·’ç®¡ç†ä¸Šæœ‰å¤šç¨®æ–¹å¼ï¼Œä¾‹å¦‚ Apache æœƒåœ¨æ”¶åˆ°è«‹æ±‚æ™‚é–‹ä¸€éš»æ–°çš„å­åŸ·è¡Œç·’(Process)è·‘ phpæ‡‰ç”¨ï¼Œè€ŒJavaå‰‡æ˜¯é€éJVMå…ˆä¿ç•™ä¸€å¤§å¡ŠCPU/Memoryè³‡æºæ¥è‘—é€éå…§éƒ¨åˆ†é…ç·šç¨‹(Thread)é”åˆ°ä¸¦è¡Œæ•ˆæœã€‚&lt;/p>
&lt;p>åœ¨ &lt;strong>twelve-factor app&lt;/strong> ä¸­ï¼ŒåŸ·è¡Œç·’æ˜¯ç¬¬ä¸€å…¬æ°‘ï¼Œé–‹ç™¼è€…å¯ä»¥æ±ºå®šç”±å“ªä¸€å€‹åŸ·è¡Œç·’è·‘ä»»å‹™ï¼Œä¾‹å¦‚ HTTPè«‹æ±‚åŸ·è¡Œåœ¨ WebåŸ·è¡Œç·’ä¸Š / èƒŒæ™¯æœå‹™å‰‡è·‘åœ¨ WorkeråŸ·è¡Œç·’ä¸Š&lt;/p>
&lt;p>çœ‹èªªæ˜ä½œè€…èˆ‰ &lt;a class="link" href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html" target="_blank" rel="noopener"
>Foreman&lt;/a> ç•¶åšä¾‹å­(ä¸‹åœ–è¼”åŠ©èªªæ˜)ï¼Œé€™æ¨£çš„å¥½è™•æ˜¯é‡è¦çš„ä»»å‹™å¯ä»¥åˆ†é…è¼ƒå¤šçš„è³‡æº&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/0__jvIkj4Cf__DgPZRRt.png"
loading="lazy"
>&lt;/p>
&lt;p>ä½†é€™ä¸¦ä¸æ’é™¤åŸ·è¡Œç·’å…§éƒ¨å¤šå·¥è™•ç†ã€VMå…§éƒ¨è™•ç†ç·šç¨‹åˆ†é…ã€åˆæˆ–æ˜¯åƒ éåŒæ­¥/äº‹ä»¶è§¸ç™¼çš„NodeJSï¼Œä½†æ˜¯å–®ä¸€VMèƒ½å¤ å®¹é‡æœ‰é™ï¼Œæ‡‰ç”¨ç¨‹å¼é ˆå¯æ‹“å±•å¤šå€‹åŸ·è¡Œç·’åˆ°å¤šå°å¯¦é«”ä¸»æ©Ÿä¸Šã€‚&lt;/p>
&lt;p>é€™æ¨£çš„è¨­è¨ˆåœ¨éœ€è¦æ°´å¹³æ“´å±•æ™‚æœƒå¤§æ”¾ç•°å½©ï¼Œshare-nothing / å¯æ°´å¹³æ‹†åˆ†çš„åŸ·è¡Œç·’åœ¨å¢åŠ æ›´å¤šä¸¦è¡Œ(Concurrency)æ™‚ååˆ†åœ°ç°¡å–®ã€‚&lt;br>
åœ¨ &lt;code>pm2&lt;/code> åŒæ¨£å¯ä»¥åšåˆ°åŒæ¨£çš„äº‹æƒ…ã€‚&lt;/p>
&lt;p>æœ€å¾Œä¸€æ®µæåˆ°ï¼Œ&lt;strong>twelve-factor app&lt;/strong> &lt;a class="link" href="http://dustin.github.com/2010/02/28/running-processes.html" target="_blank" rel="noopener"
>should never daemonize&lt;/a> or write PID files. Instead, rely on the operating systemâ€™s process manager (such as &lt;a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/" target="_blank" rel="noopener"
>systemd&lt;/a>, a distributed process manager on a cloud platform, or a tool like &lt;a class="link" href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html" target="_blank" rel="noopener"
>Foreman&lt;/a> in development)&lt;/p>
&lt;p>æŠ€è¡“åè©å¤ªå¤šç›´æ¥è²¼åŸæ–‡ï¼Œè¿½è¹¤å®Œç›¸é—œå…§æ–‡é€£çµå¤§è‡´ä¸Šæƒ³è¦èªªæ˜ã€Œæ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç®¡å¥½é–‹ç™¼æ‡‰ç”¨ç¨‹å¼å°±å¥½ï¼Œå…¶é¤˜çš„åŸ·è¡Œäº¤çµ¦å·¥å…·å³å¯ã€&lt;br>
ä¹Ÿå°±æ˜¯ &lt;code>KISS(Keep it simple, stupid)&lt;/code> çš„è¨­è¨ˆç†å¿µã€‚&lt;/p>
&lt;p>daemonæ˜¯è™•æ–¼èƒŒæ™¯ã€ä¸äºˆç”¨æˆ¶äº’å‹•çš„åŸ·è¡Œç¨‹å¼ï¼Œå…¶çˆ¶é€²ç¨‹ç‚º init (åœ¨ linux ä¸­ç‚ºç³»çµ±å•Ÿå‹•å¾Œç¬¬ä¸€å€‹é€²ç¨‹ï¼ŒPIDç·¨è™Ÿç‚º1)ï¼Œinitæœƒä¸€ç›´å­˜åœ¨åˆ°é›»è…¦é—œæ©Ÿç‚ºæ­¢ï¼›&lt;br>
ç•¶æœ‰ä»»ä½•çˆ¶é€²ç¨‹å…ˆè¡Œé—œé–‰è€Œå­é€²ç¨‹ä»ç„¶åŸ·è¡Œæ™‚ï¼Œinitæœƒè½‰ç‚ºé€™äº›å­é€²ç¨‹çš„çˆ¶é€²ç¨‹ï¼Œæ‰€ä»¥å¸¸è¦‹å•Ÿå‹•daemonä½œæ³•ä¹Ÿéƒ½æ˜¯åœ¨çˆ¶é€²ç¨‹ forkå‡ºå­é€²ç¨‹å¾Œé€€å‡ºï¼Œæ­¤æ™‚å­é€²ç¨‹å°±æ˜¯daemon processäº†ã€‚&lt;/p>
&lt;p>åƒè€ƒ Nodejs Daemon å‡½å¼åº«å°±æ˜¯æ­¤ä½œæ³•ï¼Œç”¨ child_process.spawn é—œé–‰ stdin ä¸¦é‡å° stdout / stderr èˆ‡å…¶ä»–è¨­å®šï¼Œå¦é–‹æ–°çš„é€²ç¨‹ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/indexzero/daemon.node/blob/master/index.js" target="_blank" rel="noopener"
>&lt;strong>indexzero/daemon.node&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="9-disposability">9. Disposability&lt;/h2>
&lt;h4 id="å¿«é€Ÿå•Ÿå‹•å„ªé›…é—œé–‰å¢å¼·ç¨‹å¼å¯é æ€§-maximize-robustness-with-fast-startup-and-graceful-shutdown">å¿«é€Ÿå•Ÿå‹•+å„ªé›…é—œé–‰=&amp;gt;å¢å¼·ç¨‹å¼å¯é æ€§ (Maximize robustness with fast startup and graceful shutdown)&lt;/h4>
&lt;p>æ‡‰ç”¨ç¨‹å¼æ‡‰è©²ç›¡å¯èƒ½é™ä½å•Ÿå‹•æ™‚é–“ï¼Œé€™æ¨£æ‰å¯ä»¥åœ¨å¿«é€Ÿæ“´å±• / ä¿®æ”¹è¨­å®šæ™‚å¿«é€Ÿå•Ÿç”¨æœå‹™ï¼›&lt;br>
ç•¶æ‡‰ç”¨ç¨‹å¼æ”¶åˆ°&lt;a class="link" href="http://en.wikipedia.org/wiki/SIGTERM" target="_blank" rel="noopener"
>&lt;strong>SIGTERM&lt;/strong>&lt;/a>è¨Šè™Ÿæ™‚ï¼Œæ‡‰ç•¶å„ªé›…çš„é—œé–‰ï¼Œä¹Ÿå°±æ˜¯åœæ­¢è™•ç†æ–°çš„è«‹æ±‚ä¸¦å°‡ç¾æœ‰çš„è«‹æ±‚è™•ç†å®Œæˆæ‰é€€å‡ºã€‚&lt;/p>
&lt;p>æ‡‰ç”¨ç¨‹å¼éœ€è¦è™•ç†éé è­¦çš„é—œé–‰ï¼Œä¾‹å¦‚ç¡¬é«”å£æ‰ç­‰ï¼Œé€™æ™‚å€™æœ€å¥½æœ‰å¯é çš„queueing backend ä¾‹å¦‚Beanstalkdï¼Œç•¶æ‡‰ç”¨ç¨‹å¼çµ‚æ­¢æˆ–è¶…æ™‚å¯ä»¥è‡ªå‹•å°‡ä»»å‹™é‡æ–°è¿”å› queueä¸­ã€‚&lt;/p>
&lt;h2 id="10-devprodparity">10. Dev/prodÂ parity&lt;/h2>
&lt;h4 id="ç›¡å¯èƒ½ä¿æŒç’°å¢ƒä¸€è‡´-keep-development-staging-and-production-as-similar-as-possible">ç›¡å¯èƒ½ä¿æŒç’°å¢ƒä¸€è‡´ (Keep development, staging, and production as similar as possible)&lt;/h4>
&lt;p>å› ç‚ºä¸€äº›æ­·å²ç·£ç”±ï¼Œé–‹ç™¼ç’°å¢ƒèˆ‡æ­£å¼ç’°å¢ƒå¯èƒ½æœ‰å¹¾ç¨®å·®ç•°å­˜åœ¨&lt;br>
1. æ™‚é–“ï¼šé–‹ç™¼ç’°å¢ƒå¯èƒ½æŒçºŒé–‹ç™¼äº†æ•¸å¤©åˆ°æ•¸å€‹æœˆæ‰åŒæ­¥åˆ°æ­£å¼ç’°å¢ƒ&lt;br>
2. äººï¼šé–‹ç™¼å·¥ç¨‹å¸«è² è²¬é–‹ç™¼ï¼Œè€Œç¶­é‹å·¥ç¨‹å¸«éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ&lt;br>
3. å·¥å…·ï¼šæœ¬åœ°ç«¯å¯èƒ½ç”¨SQLite è€Œ æ­£å¼ç’°å¢ƒå‰‡ç”¨ MySQL&lt;/p>
&lt;p>&lt;strong>twelve-factor app&lt;/strong> å‰‡æ˜¯è¦ç¸®çŸ­ä¸Šé¢çš„å·®è·&lt;br>
1. ç¸®çŸ­æ™‚é–“ï¼šé–‹ç™¼åˆ°éƒ¨ç½²åœ¨æ•¸å°æ™‚ç”šè‡³æ•¸åˆ†é˜ä¹‹é–“&lt;br>
2. äººï¼šé–‹ç™¼è€…æ‡‰è©²ç·Šå¯†çš„åƒèˆ‡æ­£å¼ç’°å¢ƒéƒ¨ç½²&lt;br>
3. å·¥å…·ï¼šç›¡å¯èƒ½ç”¨åŒæ¨£çš„å·¥å…·éŠ&lt;/p>
&lt;p>ç’°å¢ƒå®£å‘Šå·¥å…·å¦‚ &lt;a class="link" href="http://www.opscode.com/chef/" target="_blank" rel="noopener"
>Chef&lt;/a> / &lt;a class="link" href="http://docs.puppetlabs.com/" target="_blank" rel="noopener"
>Puppet&lt;/a> çµåˆè¼•é‡çš„è™›æ“¬åŒ–ç’°å¢ƒå·¥å…·å¦‚ &lt;a class="link" href="https://www.docker.com/" target="_blank" rel="noopener"
>Docker&lt;/a> / &lt;a class="link" href="http://vagrantup.com/" target="_blank" rel="noopener"
>Vagrant&lt;/a> å¯ä»¥å¤§å¹…åŒæ­¥é–‹ç™¼èˆ‡æ­£å¼ç’°å¢ƒã€‚&lt;/p>
&lt;h2 id="11-logs">11. Logs&lt;/h2>
&lt;h4 id="ç”¨ä¸²æµè™•ç†log-treat-logs-as-eventstreams">ç”¨ä¸²æµè™•ç†Log( Treat logs as eventÂ streams)&lt;/h4>
&lt;p>&lt;strong>twelve-factor app&lt;/strong> æœ¬èº«ä¸æ‡‰è©²å»ç®¡ç†æˆ–ç…©æƒ± Logæ‡‰è©²è¦å„²å­˜åœ¨å“ªè£¡ï¼ŒåŸ·è¡Œä¸­çš„ç¨‹å¼æ‡‰ç•¶ç›´æ¥è¼¸å‡ºåˆ° &lt;code>stdout&lt;/code> ï¼Œåœ¨æœ¬åœ°é–‹ç™¼ä¸Šå·¥ç¨‹å¸«å¯ä»¥ç›´æ¥åœ¨çµ‚ç«¯æ©Ÿä»‹é¢çœ‹åˆ°æ‰€æœ‰çš„æ‰“å°è¨Šæ¯ï¼›&lt;br>
è€Œåœ¨æ­£å¼ç’°å¢ƒä¸Šï¼ŒLogæ‡‰è©²è¢«åŸ·è¡Œç’°å¢ƒè™•ç†ï¼Œå½™æ•´æ‰€æœ‰çš„Logåˆ°ä¸åŒçš„åœ°æ–¹å„²å­˜æˆ–æ˜¯åˆ°&lt;a class="link" href="http://hive.apache.org/" target="_blank" rel="noopener"
>Hadoop/Hive&lt;/a> åšæ›´é€²ä¸€æ­¥çš„è³‡æ–™è™•ç†ï¼Œæœ‰é–‹æºå·¥å…·å¯ä»¥ä½¿ç”¨å¦‚ &lt;a class="link" href="https://github.com/heroku/logplex" target="_blank" rel="noopener"
>Logplex&lt;/a> / &lt;a class="link" href="https://github.com/fluent/fluentd" target="_blank" rel="noopener"
>Fluentd&lt;/a>ï¼Œå€¼å¾—æ³¨æ„æ˜¯æ‡‰ç”¨ç¨‹å¼æœ¬èº«ä¸çŸ¥é“Logå…¶ä»–è¨­å®šã€‚&lt;/p>
&lt;p>åœ¨Nodejsé–‹ç™¼ä¸­ï¼Œ&lt;code>pm2&lt;/code> æœ‰æä¾›åŸºæœ¬çš„Logï¼Œä½†å¦‚æœè¦æ›´é€²éšçš„è™•ç†å°±é‚„æ˜¯è¦ç”¨ &lt;code>bunyan&lt;/code> / &lt;code>winston&lt;/code> Log å‡½å¼åº«ï¼Œä½†é€™å°±æœƒé•ååŸå‰‡ï¼Œå› ç‚ºè®Šæˆæ˜¯æ‡‰ç”¨ç¨‹å¼è¦è‡ªå·±è™•ç†Logçš„éƒ¨åˆ†ã€‚&lt;br>
é™¤éè‡ªå·±å¦å¤–é–‹ç™¼ä¸€å¥—ç›´æ¥æ¥ stdout / stderr çš„ä¸²æµå·¥å…·(å¥½åƒå¯ä»¥è©¦è©¦çœ‹?!)ã€‚&lt;/p>
&lt;h2 id="12-admin-processes">12. Admin processes&lt;/h2>
&lt;h4 id="åŸ·è¡Œä¸€æ¬¡æ€§ç®¡ç†ä»»å‹™-run-adminmanagement-tasks-as-one-off-processes">åŸ·è¡Œä¸€æ¬¡æ€§ç®¡ç†ä»»å‹™ (Run admin/management tasks as one-off processes)&lt;/h4>
&lt;p>ä¸€æ¬¡æ€§çš„ç®¡ç†ä»»å‹™å¦‚ è³‡æ–™åº«Schemaæ›´å‹• / ç‰¹å®šä»»å‹™è…³æœ¬ / ä½¿ç”¨REPLåŸ·è¡Œä»»æ„çš„ç¨‹å¼ç¢¼ç­‰ï¼Œé€™äº›ä¸€æ¬¡æ€§çš„ç®¡ç†ä»»å‹™æ‡‰ç•¶ä¸€åŒæ”¾å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸¦èˆ‡æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ç›¸åŒçš„å·¥å…·éŠèˆ‡è¨­å®šæª”ã€‚&lt;/p>
&lt;p>==========&lt;/p>
&lt;p>ä»¥ä¸Šåªæ˜¯å€‹äººçš„æ¿ƒç¸®ç¸½çµï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹åŸè³‡æ–™ç¶²ç«™ã€‚&lt;/p></description></item><item><title>Chrome extension é–‹ç™¼åˆ†äº«</title><link>https://yuanchieh.page/posts/2018/2018-05-15-chrome-extension-%E9%96%8B%E7%99%BC%E5%88%86%E4%BA%AB/</link><pubDate>Tue, 15 May 2018 09:56:14 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-05-15-chrome-extension-%E9%96%8B%E7%99%BC%E5%88%86%E4%BA%AB/</guid><description>&lt;p>æ˜¨å¤©åœ¨ Android æ‰‹æ©Ÿä¸Šç”¨ Youtube åˆ†äº«å½±ç‰‡åˆ° LINE èŠå¤©å®¤çµ¦æœ‹å‹ï¼Œçªç„¶éˆæ©Ÿä¸€å‹•è¦ºå¾— APP æœ‰é€™éº¼æ–¹ä¾¿çš„åˆ†äº«æ©Ÿåˆ¶ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥åœ¨ Chrome ç”¨ Extension æ–¹å¼æ•´åˆç¤¾ç¾¤åˆ†äº«ï¼ŒæŒ‰ä¸€å€‹æŒ‰éˆ•å°±å¯ä»¥æŠŠç•¶å‰é é¢çš„é€£çµæˆ–æ–‡å­—å¿«é€Ÿåˆ†äº«ï¼›&lt;br>
æ­£å¥½ä¹‹å‰ä¹Ÿæ²’æœ‰é–‹ç™¼é Chrome extensionï¼Œæ­£å¥½æ‹¿ä¾†ç·´ç·´æŠ€è¡“ï¼Œä½†æœä¸å…¶ç„¶åœ¨ Chrome extension shop æœ‰çœ‹åˆ°å¾ˆå¤§é‡çš„ç¤¾äº¤åˆ†äº«å·¥å…·äº† OTZÂ &lt;br>
ä½†é‚„æ˜¯ä¸æ­»å¿ƒæƒ³è¦è‡ªå·±å‹•æ‰‹ç©ç©çœ‹&lt;/p>
&lt;p>åƒè€ƒè³‡æ–™ï¼š&lt;/p>
&lt;p>Chrome team æœ¬èº«çš„å®˜æ–¹æ•™å­¸é‚„ä¸è³´&lt;/p>
&lt;p>&lt;a class="link" href="https://developer.chrome.com/extensions/getstarted" target="_blank" rel="noopener"
>&lt;strong>Getting Started Tutorialâ€Šâ€”â€ŠGoogle Chrome&lt;/strong>&lt;/a>&lt;/p>
&lt;p>å¼·è€… &lt;a class="link" href="https://ithelp.ithome.com.tw/users/20079450/ironman" target="_blank" rel="noopener"
>ç¾…æ‹‰æ‹‰&lt;/a>åœ¨ 2016 å¹´ IThome éµäººè³½çš„ç³»åˆ—æ–‡ï¼Œå‰åŠæ®µæŠŠå®˜æ–¹æ•™å­¸ç¿»è­¯ï¼Œå¾ŒçºŒåŠ ä¸Šä½œè€…å€‹äººé–‹ç™¼åˆ†äº«ï¼Œéå¸¸æ£’çš„æ•™å­¸ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://ithelp.ithome.com.tw/users/20079450/ironman/1149" target="_blank" rel="noopener"
>&lt;strong>Chrome Extension é–‹ç™¼èˆ‡å¯¦ä½œ ç³»åˆ—æ–‡ç« åˆ—è¡¨ â€Šâ€”â€ŠiT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©&lt;/strong> &lt;/a>&lt;/p>
&lt;p>ä»¥ä¸‹ç‚ºå€‹äººé–‹ç™¼ç°¡ç•¥èˆ‡ç°¡åŒ–éå¾Œçš„ç­†è¨˜ï¼Œæ‰€ä»¥è¦çœ‹è©³ç´°ç‰ˆé‚„æ˜¯çœ‹ä¸Šé™„å…©å€‹æ–‡ä»¶&lt;/p>
&lt;h2 id="åŸºæœ¬ä»‹ç´¹">åŸºæœ¬ä»‹ç´¹&lt;/h2>
&lt;p>åŸºæœ¬ä¸Šé–‹ç™¼ Chrome extension è·Ÿå¯«ç¶²é å¾ˆé¡ä¼¼ï¼Œåªæ˜¯æ”¹äº†æª”æ¡ˆçµæ§‹ã€ç™¼å¸ƒæ©Ÿåˆ¶ã€API èª¿ç”¨å¤šå¢åŠ äº† chrome.* å‡½å¼&lt;/p>
&lt;p>åœ¨ extension é–‹ç™¼ä¸­ï¼Œç›®éŒ„ä¸‹å¿…é ˆå…ˆå®£å‘Š manifest.jsonï¼Œè£¡é ­æœƒè¨»æ˜ extension çš„åç¨±/icon/æ‰€éœ€æ¬Šé™ç­‰è³‡æ–™ï¼Œé‚„æœ‰ä¸åŒæ™‚æ©Ÿå°æ‡‰åŸ·è¡Œçš„ä¸åŒè…³æœ¬&lt;/p>
&lt;p>åŸºæœ¬ä¸Šé–‹ç™¼æœƒæœ‰å¹¾å€‹é é¢å¯ä»¥é¸æ“‡&lt;/p>
&lt;ol>
&lt;li>background page èƒŒæ™¯é é¢ï¼š&lt;br>
åŸºæœ¬ä¸Šæ˜¯å¸¸é§ï¼Œå¾å®‰è£æ’ä»¶ä¹‹å¾Œå°±ä¸€ç›´åŸ·è¡Œåˆ°æ’ä»¶è¢«ç§»é™¤(ä¸å®Œå…¨æ­£ç¢ºçš„æè¿°ï¼Œä½†åŸºæœ¬ä¸Šå¯ä»¥é€™æ¨£ç†è§£)&lt;br>
æ‰€ä»¥æœƒåœ¨ background æŒ‡å®šçš„ script ä¸­åŸ·è¡Œå¥—ä»¶å®‰è£æˆ–æ›´æ–°ï¼Œåˆæˆ–æ˜¯åˆå§‹åŒ–çš„ä¸€äº›ç¨‹åº&lt;/li>
&lt;li>popup page å½ˆå‡ºé é¢ï¼š&lt;br>
ä¹Ÿå°±æ˜¯å³ä¸Šè§’çš„å°åœ–æ¨™ï¼Œé»æ“Šå¾Œç”¢ç”Ÿçš„é é¢ï¼Œåˆç´°åˆ†æˆ browser-action / page-actionï¼›&lt;br>
browser-action ä»£è¡¨ Extesion æ˜¯æ™®éæ€§åœ¨æ¯å€‹ç¶²ç«™éƒ½å¯ä»¥ç”¨ï¼Œè€Œ page-action å‰‡ä»£è¡¨åªé‡å°æŸäº›ç‰¹å®šç¶²ç«™ä½¿ç”¨ï¼Œå¹³å¸¸æœƒè‡ªå‹•å‘ˆç¾ç°æš—çš„ icon ç›´åˆ°é¡¯ç¤ºå®£å‘Š pageAction.show()ï¼Œåƒæ˜¯ vue-devtool åªæœ‰åœ¨ç¶²ç«™ä½¿ç”¨ vue.js æ‰èƒ½ä½¿ç”¨ã€‚&lt;/li>
&lt;li>option page é¸é …é é¢ï¼š&lt;br>
æ‡‰ç”¨ç¨‹å¼å¦‚æœå¤ªéæ–¼è¤‡é›œï¼Œå¸Œæœ›æœ‰å€‹é¸é …é å¯ä»¥ä¾›å®¢æˆ¶å®¢è£½åŒ–è¡Œç‚ºï¼Œå¯ä»¥æ¡ç”¨&lt;/li>
&lt;li>content scriptï¼š&lt;br>
åœ¨ Extension ä¸­ï¼Œåªè¦æœ‰ç´¢å–æ¬Šé™å°±å¯ä»¥å°æ¯å€‹é é¢æ³¨å…¥ content scriptï¼Œé€²è¡Œ DOM æ“ä½œç­‰ä¸€èˆ¬ js script æœƒåŸ·è¡Œçš„å‹•ä½œï¼Œå¯ä»¥çœ‹æˆåˆæ³•çš„ XSS æ³¨å…¥ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å¯¦æˆ°åˆ†äº«">å¯¦æˆ°åˆ†äº«&lt;/h2>
&lt;p>&lt;a class="link" href="https://github.com/sj82516/quick-share" target="_blank" rel="noopener"
>&lt;strong>sj82516/quick-share&lt;/strong>&lt;/a>&lt;/p>
&lt;h3 id="å®šç¾©èˆ‡è¼‰å…¥å…¶ä»–-script">å®šç¾©èˆ‡è¼‰å…¥å…¶ä»– script&lt;/h3>
&lt;p>å¯ä»¥åƒè€ƒ manifest.jsonï¼Œé€™è£¡æˆ‘ç”¨äº†&lt;br>
backgroundï¼ševent.jsï¼Œä¸»è¦è¨»å†Šèˆ‡å®šç¾©å³éµæŒ‰ä¸‹å‡ºç¾çš„é¸å–®è¡Œç‚º&lt;br>
popup pageï¼šåˆ†æˆ popup.html / popup.jsï¼Œä¸»è¦æ˜¯å®šç¾©ç€è¦½å™¨å³ä¸Šè§’çš„å·¥å…·åˆ—è·³å‡ºè¦–çª—è¡Œç‚ºï¼Œä¸¦å®šç¾©ç‚º browser-action&lt;/p>
&lt;p>å› ç‚ºå³éµè¡Œç‚ºè·Ÿ popup è¡Œç‚ºé¡ä¼¼ï¼Œæ‰€ä»¥æˆ‘å°‡è¡Œç‚ºæ”¶æ•´æˆ util/handleShare.jsï¼Œéœ€æ³¨æ„åœ¨ background ä¸­è¦ä½¿ç”¨å…¶ä»– script å¿…é ˆå®£å‘Šåœ¨ manifest.json ä¸­ï¼›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;background&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;scripts&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;util/handleShare.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;event.js&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;persistent&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œåœ¨ popup page å‰‡ä»¥ &lt;code>&amp;lt;script src=&amp;quot;util/handleShare&amp;quot;&amp;gt;&lt;/code>åŠ å…¥ html ä¸­å³å¯ã€‚&lt;/p>
&lt;h3 id="å¦é–‹æ–°é popup-script-èˆ‡-content-script-æºé€š">å¦é–‹æ–°é ã€Popup script èˆ‡ Content script æºé€š&lt;/h3>
&lt;p>ç¤¾ç¾¤åª’é«”åˆ†äº«å¿…é ˆå¦é–‹è©²ç¶²ç«™çš„æ–°é é¢ï¼ŒåŒæ™‚ç‚ºäº†å¯ä»¥è‡ªå‹•æŠŠåç™½é¸å–çš„æ–‡å­—è‡ªå‹•æ’å…¥ï¼Œåœ¨é–‹å•Ÿæ–°é ï¼Œé¦–å…ˆè¦è¨­æ³•å–å¾—æ–°é é¢çš„ Tabï¼Œä¹‹å¾Œè¦åŸ·è¡Œ content script&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å…ˆå–å¾—æ‰€æœ‰çš„åˆ†é è³‡æ–™ï¼Œå¯ä»¥é€é tab çš„ url / title æ‰¾åˆ°æŒ‡å®šé é¢
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">chrome&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tabs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">active&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">},&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tabs&lt;/span>&lt;span class="p">){})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¿…é ˆç¢ºä¿åˆ†é å·²ç¶“åŠ è¼‰å®Œæˆï¼Œé€™æ¨£ content script æ‰æœ‰ç”¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">chrome&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tabs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onUpdated&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tabId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">tabId&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">factoryTab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;complete&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åœ¨è©²åˆ†é æ³¨å…¥ content script
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">chrome&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tabs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">executeScript&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">factoryTab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">file&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;content/share.js&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">....&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢æœ‰å€‹å° tricky æ˜¯å¿…é ˆè¦ç­‰åˆ°æ–°åˆ†é åŠ è¼‰å®Œæˆæ‰å¯ä»¥åŸ·è¡Œ &lt;code>chrome.tabs.executeScript&lt;/code> ï¼Œå¦å‰‡æœƒå‡ºç¾ tab is closed ä¹‹é¡çš„éŒ¯èª¤è¨Šæ¯!&lt;/p>
&lt;p>åœ¨è·¨ script å‚³è¼¸è³‡æ–™ä¸€æ¬¡æ€§å¯ä»¥ä½¿ç”¨&lt;code>sendMessage(tabId, message)&lt;/code>/ &lt;code>chrome.runtime.onMessage.addListener((message, sender, sendResponse)=&amp;gt;{})&lt;/code>Â &lt;br>
å…¶é¤˜æ–¹å¼å¯ä»¥åœ¨æŸ¥è©¢æ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="çµèª">çµèª&lt;/h3>
&lt;p>é–‹ç™¼ä¸€å€‹ç°¡å–®çš„ Chrome Extension è »æœ‰è¶£çš„ï¼Œä½†ä¹Ÿæ„å¤–ç™¼ç¾ Extension çš„å¨åŠ›æ¥µç‚ºå¼·å¤§ï¼Œå°¤å…¶æ˜¯å¯ä»¥æ³¨å…¥ content script é€™å¡Šï¼Œæ‰€ä»¥æœå°‹ä¸€ä¸‹ chrome store å¯ä»¥æ‰¾åˆ°ä¾‹å¦‚å¯†ç¢¼ç®¡ç†å·¥å…·ç­‰æ‡‰ç”¨ï¼Œçªç„¶è¦ºå¾—ä¸€é™£å®³æ€•å› ç‚ºæ•´å€‹ DOM éƒ½è¢«æ‘¸å…‰äº†ï¼Œç”šè‡³ cookie å†ä¸å°å¿ƒæˆæ¬Šå‡ºå»å¾Œä¹Ÿéƒ½å¯ä»¥è¢«è®€å–ï¼Œåœ¨å®‰è£æ’ä»¶ä¸Šå‹™å¿…å°å¿ƒå•Šï¼ å°¤å…¶æ˜¯æ²’æœ‰é–‹æºã€éå®˜æ–¹çš„æ’ä»¶æ›´éœ€è¦å°å¿ƒã€‚&lt;/p>
&lt;p>ä¸éæˆ‘ä¸Šå‚³çš„æ’ä»¶è¢« Google èªå®šç‚º Spam ä¸çµ¦ä¸Šæ¶â€¦â€¦&lt;/p></description></item><item><title>[é–±è®€å¿ƒå¾—]ã€Šæˆ‘å€‘ã€‹ã€ã€Š1984ã€‹ã€ã€Šç¾éº—æ–°ä¸–ç•Œã€‹åçƒæ‰˜é‚¦ä¸‰éƒ¨æ›²</title><link>https://yuanchieh.page/posts/2018/2018-05-06-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97%E6%88%91%E5%80%911984%E7%BE%8E%E9%BA%97%E6%96%B0%E4%B8%96%E7%95%8C%E5%8F%8D%E7%83%8F%E6%89%98%E9%82%A6%E4%B8%89%E9%83%A8%E6%9B%B2/</link><pubDate>Sun, 06 May 2018 02:11:33 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-05-06-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97%E6%88%91%E5%80%911984%E7%BE%8E%E9%BA%97%E6%96%B0%E4%B8%96%E7%95%8C%E5%8F%8D%E7%83%8F%E6%89%98%E9%82%A6%E4%B8%89%E9%83%A8%E6%9B%B2/</guid><description>&lt;p>è‡³å¾çœ‹äº†ã€Šå¨›æ¨‚è‡³æ­»ã€‹é€™æœ¬æ›¸å¾Œï¼Œé–‹å§‹æ€è€ƒã€Œå¤–åœ¨ç’°å¢ƒèˆ‡å…§åœ¨åŸºå› å¦‚ä½•å½±éŸ¿äººé¡æ€ç¶­ã€é€™é¡å‹çš„è­°é¡Œ&lt;/p>
&lt;p>ã€Šå¨›æ¨‚è‡³æ­»ã€‹å¤§è‡´ä¸Šæ˜¯åœ¨æè¿°äººé¡æ€è€ƒæ–¹å¼å—åˆ°ä¸åŒåª’ä»‹ï¼Œå°åˆ·å¼ç´™æœ¬èˆ‡é›»è¦–çš„å½±éŸ¿ï¼Œè€Œæœ‰ä¸åŒçš„è½‰è®Šï¼›&lt;br>
é›»è¦–æ™‚ä»£å……æ–¥è‘—å¤§é‡çš„è¨Šæ¯ï¼Œè¿«ä½¿äººå€‘æ€è€ƒé–‹å§‹è®ŠçŸ­ä¿ƒï¼Œåœ¨ç¶²è·¯ã€ç¤¾ç¾¤æ™‚ä»£é€™å€‹å½±éŸ¿è¶Šç™¼åŠ‡çƒˆï¼Œæ‰€ä»¥æ‰æœ‰äº†é‡‘é­šè…¦ä¸€è©&lt;/p>
&lt;p>é †è‘—é€™å€‹è­°é¡Œï¼Œè¿‘ä¸‰é€±çœ‹äº†æ‰€è¬‚ åçƒæ‰˜é‚¦ç³»åˆ—ä¸‰éƒ¨æ›²&lt;br>
ã€Šæˆ‘å€‘ã€‹ã€Š1984ã€‹ã€Šç¾éº—æ–°ä¸–ç•Œã€‹ï¼Œæ‰€è¬‚åçƒæ‰˜é‚¦å³æ˜¯å°æ–¼å‚³çµ±çš„ç¾å¥½èˆ‡å¹¸ç¦æå‡ºå¼·çƒˆçš„è³ªç–‘ï¼Œä¸¦ä»¥è«·åˆºçš„æ–‡å­—ä¾†æ¢è¨äººå€‘è¿½æ±‚çš„å®Œç¾ç”Ÿæ´»ã€‚&lt;/p>
&lt;h4 id="æˆ‘å€‘">ã€Šæˆ‘å€‘ã€‹&lt;/h4>
&lt;p>é€™æœ¬ä»¥ç¬¬ä¸€äººç¨±è¦–è§’ï¼Œç”¨çŸ­ç¯‡æ—¥è¨˜çš„æ–¹å¼æ¨å‹•åŠ‡æƒ…ï¼Œå¤§é«”ä¸Šæè¿°ä¸€å€‹å¤§ä¸€çµ±å¸åœ‹ï¼Œäººå€‘åªè¿½æ±‚ç†æ€§ã€ç›´ç·šã€å…¬å¼åŒ–çš„ç”Ÿæ´»ï¼Œæ¯å€‹å…¬æ°‘éƒ½æ˜¯ç‚ºäº†å¤§ä¸€çµ±å¸åœ‹è€Œå­˜åœ¨ï¼Œæ²’æœ‰å¤ªå¤šå€‹äººçš„æ€ç¶­ï¼›&lt;br>
æ•´å€‹å¸åœ‹æ˜¯ä»¥ç§‘æŠ€ç‚ºå°å‘ï¼Œä¸¦ç”¨ä¸€å€‹ç»ç’ƒç½©é™åˆ¶å¸åœ‹å±…æ°‘çš„ç§»å‹•ï¼Œç»ç’ƒç½©ä¹‹å¤–ä¿ç•™é‡ç”Ÿçš„å¢æ—ä»¥åŠéè‘—åŸå§‹ç”Ÿæ´»çš„é‡äººã€‚&lt;/p>
&lt;p>ä¸»è§’æ˜¯å¸åœ‹ä¸­çš„é¦–å¸­é£›èˆ¹è¨­è¨ˆå¸«ï¼Œé£›èˆ¹è¨­è¨ˆç›®çš„æ˜¯ç‚ºäº†å°‡é€™ç¨®ç¾å¥½ç†æ€§çš„ç¤¾æœƒç†å¿µæ•£ä½ˆåˆ°å…¨å®‡å®™ï¼Œä¸»è§’ä¸€é–‹å§‹ä»¥æ­¤ç‚ºæ¦®ï¼Œæ·±ä¿¡äººæ´»è‘—å°±æ˜¯ç‚ºäº†å¤§ä¸€çµ±çš„å¸åœ‹è€Œå­˜åœ¨ï¼Œä¸è©²æœ‰å…¶ä»–å€‹äººçš„æƒ³æ³•ï¼›&lt;br>
ä½†å¾Œä¾†é‡ä¸Šäº†ä¸€ä½å¥³è§’ï¼Œå› ç‚ºæˆ€æ„›çš„è¡å‹•ï¼Œé–‹å§‹æœ‰äº†è‡ªå·±çš„æ€æƒ³ï¼Œè€Œæ€æƒ³æ˜¯ä¸€ç¨®ç½ªã€‚&lt;/p>
&lt;p>æ•´æœ¬æ›¸èªªå¯¦åœ¨æˆ‘çœ‹èµ·ä¾†ä¹Ÿç•¥é¡¯å†—é•·èˆ‡æ²ˆæ‚¶ï¼Œå› ç‚ºå…¶å¯¦æ•…äº‹ç·šä¸è¤‡é›œã€è¦é—¡è¿°çš„é“ç†ä¹Ÿè »ç›´è§€ï¼Œä½œè€…èŠ±è »å¤šç« ç¯€åè¦†çš„æè¿°é¡ä¼¼çš„äº‹ä»¶ï¼Œåƒæ˜¯æ„›æƒ…ã€å€‹äººå›é€†æ€æƒ³çš„èŒèŠ½ã€ç¤¾æœƒå¤–åœ¨ç’°å¢ƒå¤§ä¸€çµ±è¦ç¯„é–“çš„æ‹‰æ‰¯ã€‚&lt;/p>
&lt;h4 id="1984">ã€Š1984ã€‹&lt;/h4>
&lt;p>æç¹ªé«˜å£“çµ±æ²»çš„è»æ¬Šå¸åœ‹ï¼Œè€å¤§å“¥ç”¨å„ç¨®æ–¹å¼æ´—è…¦ã€æ”¹å¯«æ­·å²ï¼Œæ›¸ä¸­å¹¾å¥è©±æ·±åˆ»åˆ‡ä¸­è¦å®³&lt;br>
ã€Œèª°æ§åˆ¶éå»å°±æ§åˆ¶æœªä¾†ï¼Œèª°æ§åˆ¶ç¾åœ¨å°±æ§åˆ¶éå»ã€‚ã€&lt;br>
ä¸»è§’çš„å·¥ä½œä¾¿æ˜¯é…åˆé»¨çš„æ”¿ç­–ç«„æ”¹æ‰€æœ‰æ–‡æ›¸ç´€éŒ„ï¼Œä»Šå¹´ç”Ÿç”¢éƒ¨åªç”Ÿç”¢äº†å…©åƒé “ç³§é£Ÿæ²’æœ‰é”åˆ°æ”¿æ²»å£è™Ÿçš„å¢é‡50%ï¼Œæ²’é—œä¿‚æ”¹å»å¹´ç´€éŒ„å°±å¥½ï¼›&lt;br>
ç•¶æ‰€æœ‰æ–‡æ›¸ã€å ±ç´™éƒ½è¢«ç«„æ”¹ï¼Œå”¯ä¸€çš„çœŸç›¸åªç•™åœ¨ä½œè€…è…¦ä¸­ï¼Œä½†é€™çœŸç›¸å°±çœŸçš„æ˜¯ã€ŒçœŸç›¸ã€å—?!&lt;/p>
&lt;p>ä¸»è§’å¾Œä¾†æ„›ä¸Šäº†ä¸€ä½å›é€†çš„é’æ˜¥æœŸå°‘å¥³(è‡³å°‘è§’è‰²æç¹ªèµ·ä¾†å¾ˆåƒ)ï¼Œåˆ°æœ€å¾Œå› ç‚ºæ„›æƒ…è€Œä»˜å‡ºä»£åƒ¹ï¼Œä¸»è§’ä¸€é–‹å§‹ä»¥ç‚ºä¸è«–è‚‰é«”å¦‚ä½•æŠ˜ç£¨ï¼Œåªè¦å¤ å …æŒå°±å¯ä»¥ä¿è­·å¿ƒä¸­çš„ä¸€æ–¹æ·¨åœŸï¼›&lt;br>
ä½†æ˜¯ç›£æ§å–®ä½é–‹å§‹ç”¨å„ç¨®é…·åˆ‘æŠ˜ç£¨ä¸»è§’çš„æ€æƒ³ï¼Œæœ€å¾Œç‹ ç‹ åœ°æŠŠæ„›æƒ…ä¹Ÿé€£æ ¹æ‹”èµ·ï¼Œä½œè€…æè¿°çš„ååˆ†å¯«å¯¦ï¼Œéå¸¸çš„é»‘æš—â€¦.&lt;/p>
&lt;h4 id="ç¾éº—æ–°ä¸–ç•Œ">ã€Šç¾éº—æ–°ä¸–ç•Œã€‹&lt;/h4>
&lt;p>è·Ÿå‰å…©æœ¬æ›¸æè¿°æ–¹å¼æ°å¥½ç›¸åï¼Œä½†æ›´ä»¤äººæ¯›éª¨æ‚šç„¶ï¼›&lt;br>
æ›¸ä¸­æè¿°äººé¡ç”±åŸºå› åŸ¹é¤Šæ‰€æ‰¹æ¬¡è£½é€ ï¼Œåœ¨å‡ºç”Ÿæ™‚åŸºå› å°±å·²ç¶“æ±ºå®šå¥½ä½ çš„æ‰€æœ‰å¤–è§€ã€æ€æƒ³åŒ…å«ç¤¾ç¶“åœ°ä½ï¼Œå‡ºç”Ÿå¾Œæœ‰æ‰€è¬‚çš„ã€Œåˆ¶ç´„ã€ï¼Œé€éç¡çœ å­¸ç¿’æ³•ä¸æ–·æ´—è…¦ï¼Œä¾‹å¦‚èªª è¨å­ç´…è‰²ï¼Œåœ¨5â€“7æ­²æ¯å¤©æ™šä¸Šæ’­æ”¾5000æ¬¡ï¼Œè‡ªç„¶è€Œç„¶é•·å¤§å¾Œå·²ç¶“ç„¡æ³•æ–¹ä¾¿ç‚ºä»€éº¼æœƒè¨å­ç´…è‰²ï¼Œåªæœƒè¦ºå¾—ã€Œå¾ˆè‡ªç„¶å°±è©²è¨å­ç´…è‰²ã€&lt;br>
æ•´å€‹ä¸–ç•Œè¢«ç®¡æ²»è€…æ‰€è¦ç¯„ï¼Œæ•´é«”ç¤¾æœƒå®šæœŸæä¾›ã€Œç´¢éº»ã€ï¼Œä¸€ç¨®è¿·å¹»é¡ä¼¼æ–¼æ¯’å“ï¼Œå››è™•çš†æœ‰éŸ³æ¨‚ã€ä¸ç”¨ç…©æƒ±ç³§é£Ÿï¼Œæ²’æœ‰å‚·ç—›æ²’æœ‰è€åŒ–ï¼Œé€™ä¼¼ä¹å°±æ˜¯ã€Œç¾éº—çš„æ–°ä¸–ç•Œã€&lt;/p>
&lt;p>å¾Œä¾†æ•…äº‹æ¨æ¼”åˆ°é‡äººä¿ç•™å€ï¼Œé›™æ–¹çš„æ€æƒ³é–‹å§‹è¡çªï¼Œåˆ°åº•è¦ç—›è‹¦çš„è‹¦é›£é‚„æ˜¯ç¾å¥½çš„å’Œè«§?Â &lt;br>
é‡äººä¸æ–·ç”¨èå£«æ¯”äºåŠ‡æœ¬çš„å°è©ä¾†è¡¨é”å€‹äººæ€æƒ³å°æ–¼çœŸå–„ç¾ã€è‹¦é›£çš„å …æŒç­‰å‚³çµ±ç¾å¾·ï¼Œä¾†è«·åˆºèˆ‡å°æŠ—æ–°ä¸–ç•Œä¸­çš„æ”¾è•©ã€åŠæ™‚è¡Œæ¨‚ã€è¢«è¦ç¯„å¥½å—åˆ°åˆ¶ç´„çš„ç¤¾æœƒã€‚&lt;/p>
&lt;p>é€™å¹¾æœ¬æ›¸å»ºè­°åœ¨é¢¨å…‰æ˜åªšçš„æˆ¶å¤–çœ‹ï¼Œå› ç‚ºå¾ˆé»‘æš—XD&lt;/p>
&lt;p>é€™å¹¾æœ¬æ›¸æç¹ªçš„ç¤¾æœƒéƒ½å¾ˆä¸åŒï¼Œä½†éå¸¸é©šäººçš„ä¸€è‡´æ€§å°±æ˜¯&lt;br>
1. è¦–å€‹äººæ€æƒ³ç‚ºçŠ¯ç½ª&lt;br>
2. å‰å¥ªæ„›æƒ…ï¼Œä½†æœ‰è¶£çš„å°±æ˜¯ä¸»è§’éƒ½æ˜¯é€éæ„›æƒ…æ‰¾åˆ°è‡ªæˆ‘çš„æ€æƒ³&lt;br>
3. å»é™¤å®¶åº­ï¼Œå®Œå…¨å»é™¤è¦ªå­é–“çš„ç¾ˆçµ†&lt;br>
4. æ‹’çµ•å€‹äººç¨è™•ï¼Œå¼·èª¿ç¤¾æœƒçš„å’Œè«§èˆ‡ä¸€è‡´&lt;/p>
&lt;p>ä½†æˆ‘å–œæ­¡é€™ç¨®è«·åˆºçš„ç­†æ³•ï¼Œå› ç‚ºä»–å¯ä»¥æœ€å¤§ç¨‹åº¦çš„æ¿€ç™¼æˆ‘æƒ³æè¡›æ€æƒ³ã€è‡ªç”±ã€æ„›æƒ…ç­‰ï¼Œæ›¸ä¸­ç¤¾æœƒæ‰€æ’æ–¥æˆ–ç¦æ­¢çš„ä¸æ­£å¥½æ˜¯èº«è€Œç‚ºäººæœ€é‡è¦çš„å› å­å—?!&lt;br>
åªæ˜¯çœŸçš„å¾ˆé»‘æš—ï¼Œå°¤å…¶æ˜¯ã€Š1984ã€‹æœ€å¾Œä¸€éƒ¨åˆ†â€¦. å°å¿ƒæœç”¨&lt;/p>
&lt;p>ä¸‰æœ¬æ›¸çœ‹ä¾†ï¼Œæˆ‘å…¶å¯¦æœ€å–œæ­¡ã€Šç¾éº—æ–°ä¸–ç•Œã€‹ï¼Œå‰é™£å­æœ‰é‡åˆ°ä½ˆé“è€…åœ¨å‚³æ•™ï¼Œä»–å•æˆ‘ã€Œå¦‚æœå¯ä»¥åˆ°å¤©å ‚ç„¡æ†‚ç„¡æ…®ï¼Œæ²’æœ‰ç—›è‹¦ï¼Œä½ æ‡‰è©²ä¹Ÿæœƒæƒ³å»å§?ã€&lt;br>
é‚£æ™‚å€™æˆ‘æ„£ä½äº†å¿«30ç§’ï¼Œä»–åªå¥½è¨•è¨•åœ°èªªã€Œå°å˜›ï¼Œæ²’æœ‰äººå–œæ­¡åœ¨å‡¡é–“ç—›è‹¦çš„ç”Ÿæ´»â€¦. ã€&lt;/p>
&lt;p>ç•¶æ™‚æˆ‘çŒ¶è±«çš„é»å°±æ˜¯ ä»€éº¼æ˜¯æ°¸ç”Ÿ? ä»€éº¼æ˜¯å¤©å ‚?Â &lt;br>
ç„¡æ†‚ç„¡æ…®æ²’æœ‰è‹¦ç—›è½èµ·ä¾†å¾ˆå¥½ï¼Œä½†é€™æ¨£é‚„å­˜æ´»è‘—æ˜¯è¦å¹¹å˜›?! åˆæˆ–æ˜¯åœ¨é€™ç¨®ç‹€æ…‹ä¸‹æ€éº¼çŸ¥é“è‡ªå·±é‚„æ´»è‘—?!Â &lt;br>
æœƒä¸æœƒå°±è®Šæˆæ˜¯ä¸€å€‹ç¾éº—æ–°ä¸–ç•Œ?!&lt;/p>
&lt;p>é€™æˆ–è¨±å°±æ˜¯æˆ‘ç¾åœ¨æ²’æœ‰å®—æ•™ä¿¡ä»°çš„åŸå› ï¼Œåˆæˆ–æ˜¯ç¾åœ¨çš„è‡ªå·±æ²’æœ‰å¤ªå¤šè‹¦ç—›çš„ç¶“æ­·ï¼Œæ‰€ä»¥ä¸æœƒä¹Ÿä¸æƒ³å»æ€è€ƒé€™é¡çš„å•é¡Œï¼ŒåªçŸ¥é“ç¾åœ¨æ¯å¤©æ´»è‘—å¯ä»¥å·¥ä½œã€å¯ä»¥é‹å‹•ã€å¯ä»¥é–±è®€ã€å¯ä»¥æ€è€ƒå°±è »å……å¯¦çš„ï¼Œæˆ‘ä¹Ÿä¸æ˜¯æŠ–Mä¹Ÿä¸æƒ³ä¸€ç›´è™•æ–¼è‹¦ç—›çš„ç‹€æ…‹XD&lt;/p>
&lt;p>ä½†å°±æ˜¯ä¸æœƒå»æƒ³éè‘—ç„¡æ†‚ç„¡æ…®çš„ç”Ÿæ´»ï¼Œå°±è¦ºå¾—å¾ˆå½†æ‰­å§&lt;br>
æˆ‘é‚„æ˜¯æä¸æ‡‚ä¿¡ä»°å®—æ•™ï¼Œåˆæˆ–æ˜¯å„æ–¹æ•™ç¾©ä¸­çš„ã€Œå¤©å ‚ã€ã€Œè¥¿æ–¹æ¥µæ¨‚ä¸–ç•Œã€åˆ°åº•æ˜¯æ€æ¨£çš„åœ°æ–¹? éˆé­‚è™•æ–¼é‚£ç¨®ç‹€æ…‹ä¸‹åˆå¯ä»¥å¹¹å˜›å‘¢? æ°¸ç”Ÿåˆ°åº•æ˜¯æ€æ¨£çš„ç‹€æ…‹?&lt;/p>
&lt;p>æœ‰é»ä¸è§£ä½†ä¹Ÿæ²’æœ‰å¾ˆåœ¨æ„&lt;br>
ä¸Šå¤©çµ¦äº†ä¸€å‰¯ç‰Œï¼Œåä¸Šå°æ¡Œå°±ç›¡èˆˆçš„è³­åˆ°æœ€å¾Œå§&lt;/p>
&lt;p>* ä¹‹å¾Œæƒ³çœ‹ã€Šäººé¡å¤§æ­·å²ã€‹ã€Šäººé¡å¤§å‘½é‹ã€‹ã€Šæ§ç ²é‹¼éµèˆ‡ç´°èŒã€‹ï¼Œç”¨ä¸åŒçš„è§’åº¦ä¾†æ€è€ƒé€™å€‹è­°é¡Œ&lt;/p></description></item><item><title>MySQL FOREIGN KEY Constraints æ•´ç†</title><link>https://yuanchieh.page/posts/2018/2018-04-24-mysql-foreign-key-constraints-%E6%95%B4%E7%90%86/</link><pubDate>Tue, 24 Apr 2018 10:16:08 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-04-24-mysql-foreign-key-constraints-%E6%95%B4%E7%90%86/</guid><description>&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/create-table-foreign-keys.html#foreign-keys-adding" title="https://dev.mysql.com/doc/refman/5.7/en/create-table-foreign-keys.html#foreign-keys-adding"
target="_blank" rel="noopener"
>MySQLÂ :: MySQL 5.7 Reference ManualÂ :: 13.1.18.6 Using FOREIGN KEY Constraints&lt;/a>&lt;/p>
&lt;p>æ•´ç†é–±è®€MySQL v5.7çš„FOREIGN KEY Constraintsæ–‡ä»¶ï¼Œä¸¦é‡å°ç´°ç¯€åœ¨DB FiddleåŠ ä¸Šç¯„ä¾‹ï¼Œå¾ŒçºŒFOREIGN KEYç¸®å¯«FKã€‚&lt;/p>
&lt;p>FKé™åˆ¶å¯ä¿è­‰è³‡æ–™é—œè¯é–“çš„å®Œæ•´æ€§ï¼Œé—œä¿‚æ˜¯å»ºç«‹child TableæŒ‡å®šè¦èˆ‡ parent Tableçš„æŸæ¬„ä½å»ºç«‹é—œè¯ï¼Œ&lt;code>FOREIGN KEY&lt;/code> å¿…é ˆåœ¨ child Tableä¸­æŒ‡å®šï¼Œchild / parentéœ€ä½¿ç”¨ç›¸åŒçš„DBå¼•æ“ä¸”ä¸å¯ç‚º TEMPORARY Tableã€‚&lt;/p>
&lt;p>åœ¨å®£å‘Šèªæ³•ä¸Šï¼Œå¯ä»¥é€é [CONSTRAINT symbol ] æŒ‡å®šé€™ç­†é—œè¯é™åˆ¶çš„åç¨±ï¼Œä½†é ˆæ³¨æ„åç¨±ä¸å¯é‡è¤‡å¦å‰‡æœƒå‡ºéŒ¯ï¼›&lt;br>
å¦‚æœæ“”å¿ƒå°±ä¸è¦å®£å‘Š CONSTRAINTè®“ DB Engineè‡ªå‹•ç”¢ç”Ÿ&lt;/p>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/ocxrUaBoXDVM6i1xAmyZH1/1" title="https://www.db-fiddle.com/f/ocxrUaBoXDVM6i1xAmyZH1/1"
target="_blank" rel="noopener"
>DB Fiddle - SQL Database Playground&lt;/a>&lt;/p>
&lt;h2 id="foreign-keyè³‡æ–™å‹åˆ¥">FOREIGN KEYÂ è³‡æ–™å‹åˆ¥&lt;/h2>
&lt;p>æœ‰è¶£çš„æ˜¯ï¼ŒMySQLæ–‡ä»¶åªèªªparentä¸­çš„è³‡æ–™æ¬„ä½èˆ‡child FOREIGN KEYæ¬„ä½çš„è³‡æ–™å‹åˆ¥å¿…é ˆ&lt;strong>é¡ä¼¼&lt;/strong>è€Œéä¸€è‡´ï¼Œåˆå¯ç´°åˆ†æˆä¸‰é¡&lt;/p>
&lt;ol>
&lt;li>integerï¼š&lt;br>
_Size &amp;amp; Signå¿…é ˆç›¸åŒï¼Œä¾‹å¦‚èªª TINYINT / INT å°±æ˜¯ä¸ä¸€æ¨£çš„&lt;/li>
&lt;li>stringï¼š&lt;br>
é•·åº¦ä¸ä¸€å®šè¦ç›¸åŒï¼Œå› ç‚ºä¸è«–æ˜¯parenté•·æˆ–æ˜¯childé•·ï¼ŒFOREIGN KEYåœ¨æ’å…¥æ™‚å¿…é ˆparentå­˜åœ¨è©²ç­†è³‡æ–™ï¼›&lt;br>
æ‰€ä»¥åœ¨æ’å…¥ä¸å¯è¶…éæ¬„ä½é•·åº¦èˆ‡è³‡æ–™å¿…é ˆå­˜åœ¨çš„å…©å€‹æ¢ä»¶ä¸‹ï¼Œå­—ä¸²é•·åº¦çš„é™åˆ¶å°±ä¸æ˜¯é€™éº¼å¿…è¦&lt;/li>
&lt;li>å°æ–¼éä½å…ƒå‹åˆ¥çš„å­—ä¸²ï¼Œcharacter set å’Œ collationå¿…é ˆç›¸åŒ&lt;/li>
&lt;/ol>
&lt;h2 id="foreign-keyé™åˆ¶">FOREIGN KEYÂ é™åˆ¶&lt;/h2>
&lt;p>é™¤äº†ä¸Šè¿°çš„è³‡æ–™å‹åˆ¥é™åˆ¶å¤–ï¼ŒMySQLç‚ºäº†æœå°‹ä¸Šé¿å… full table scan&lt;/p>
&lt;ol>
&lt;li>parent çš„æ¬„ä½å¿…é ˆæ˜¯ã€ŒæŸIndexä¸­çš„ç¬¬ä¸€æ¬„ä½ã€ï¼Œä¾‹å¦‚ index(id) / index(id, uid,Â â€¦.)ï¼Œå› ç‚ºMySQLçš„Indexé †åºæ˜¯ç”±å·¦è‡³å³ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤šæ¬„ä½Indexåªè¦è©²æ¬„ä½æ˜¯åœ¨ç¬¬ä¸€é †ä½ä¹Ÿå¯ä»¥ç•¶ä½œå»ºç«‹ FKçš„æ¬„ä½ã€‚&lt;br>
å‡è¨­ä¸ç¬¦åˆæ¢ä»¶ï¼Œæœƒç›´æ¥å‡ºéŒ¯ç„¡æ³•å»ºç«‹child Tableã€‚&lt;/li>
&lt;li>child çš„FKæ¬„ä½å¿…é ˆæ˜¯ã€ŒæŸIndexä¸­çš„ç¬¬ä¸€æ¬„ä½ã€ï¼Œå¦‚æœæ²’æœ‰æœƒè‡ªå‹•å‰µå»ºã€‚&lt;/li>
&lt;li>FKå¯ä»¥æ˜¯å¤šæ¬„ä½ï¼Œä½†åŒæ¨£è¦ç¬¦åˆã€ŒæŸIndexä¸­çš„å‰é¢é †ä½ã€&lt;/li>
&lt;li>åˆå› ç‚ºFKå¿…é ˆå»ºç«‹Indexï¼Œæ‰€ä»¥åƒ TEXT / BLOB å°±ä¸å¯èƒ½æ˜¯ FKé¸é …ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="é—œè¯æ“ä½œ">é—œè¯æ“ä½œ&lt;/h2>
&lt;p>åœ¨å®šç¾©FKæ™‚å¯ä»¥æŒ‡å®šé—œè¯æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¦‚æœ parentçš„å°æ‡‰FKæ¬„ä½ç™¼ç”Ÿæ”¹è®Š(UPDATE / DELETE)æ™‚ child FKæ¬„ä½è©²æ€éº¼æ‡‰å°ï¼Œç¸½å…±æœ‰å¹¾ç¨®å®šç¾©ï¼š&lt;/p>
&lt;ol>
&lt;li>CASCADE:&lt;br>
å¦‚æœæ˜¯ parentç´€éŒ„è¢«åˆªé™¤äº†ï¼Œé‚£å°æ‡‰FKçš„chlidç´€éŒ„ä¹Ÿä¸€ä½µåˆªé™¤ï¼›&lt;br>
å¦‚æœæ˜¯ parent FKæ›´æ–°äº†æ–°å€¼ï¼Œå‰‡child å°æ‡‰çš„FKæœƒæ›´æ–°ã€‚&lt;/li>
&lt;li>SET NULL:&lt;br>
åˆªé™¤æ›´æ–° parentéƒ½æœƒå°è‡´ childçš„ FKç´€éŒ„è¨­ç‚º Nullï¼Œå¦‚æœè¨­å®šç‚º SET NULL è¨˜å¾— ã€Œchild FK æ¬„ä½ä¸è¦åŠ  NOT NULL æœƒè¡çªã€ã€‚&lt;/li>
&lt;li>RESTRICT:&lt;br>
åªè¦childä¸­æœ‰åŒ…å«è©² FKå€¼ï¼Œå®Œå…¨ä¸èƒ½åˆªé™¤è©²ç­†parentæˆ–æ›´æ–° parentçš„FKæ¬„ä½ã€‚&lt;/li>
&lt;li>NO ACTION:Â &lt;br>
åœ¨MySQLç­‰åŒæ–¼ &lt;code>RESTRICT&lt;/code>ã€‚&lt;/li>
&lt;li>SET DEFAULT:&lt;br>
åœ¨MySQL InnoDBä¸­ä¸æ”¯æ´ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;a class="link" href="https://www.db-fiddle.com/f/acgvjzoA4B5sfy1RJb6Yyj/0" target="_blank" rel="noopener"
>&lt;strong>DB Fiddle - SQL Database Playground&lt;/strong>&lt;/a>&lt;/p>
&lt;h2 id="å¢åŠ æˆ–åˆªé™¤fk">å¢åŠ æˆ–åˆªé™¤FK&lt;/h2>
&lt;p>å¯ä»¥é€é &lt;code>ALTER TABLE&lt;/code> ä¾†å¢åŠ FKï¼Œé€é &lt;code>DROP TABLE&lt;/code> æŒ‡å®šåˆªé™¤FKï¼Œä½†å¦‚æœç•¶åˆæ²’æœ‰ä½¿ç”¨ &lt;code>CONSTRAINT&lt;/code> å®£å‘ŠFKçš„åç¨±ï¼Œå¯ä»¥ç”¨ &lt;code>SHOW CREATE TABLE&lt;/code> å–å¾—Tableè³‡æ–™ï¼Œå³å¯å¾—çŸ¥ç³»çµ±è‡ªå‹•å‰µå»ºçš„FKåç¨±ã€‚&lt;/p>
&lt;h2 id="æš«æ™‚é—œé–‰-fk-constraits">æš«æ™‚é—œé–‰ FK CONSTRAITS&lt;/h2>
&lt;p>ç•¶ä½¿ç”¨ &lt;code>mysqldump&lt;/code> æ™‚ï¼Œç‚ºäº†æ–¹ä¾¿é‡å»ºè³‡æ–™MySQLæœƒè‡ªå‹•å…ˆé—œé–‰FK CONSTRAITSçš„é™åˆ¶&lt;/p>
&lt;p>mysql&amp;gt; SET foreign_key_checks = 0;&lt;br>
mysql&amp;gt; SOURCE &lt;em>dump_file_name&lt;/em>;&lt;br>
mysql&amp;gt; SET foreign_key_checks = 1;&lt;/p>
&lt;p>ä½†å¿…é ˆæ³¨æ„ï¼Œå³ä½¿é—œé–‰äº†åœ¨å‰µå»º FKæ™‚ä»ç„¶ä¸å¯ä»¥é•èƒŒ FKè³‡æ–™å‹åˆ¥çš„é©—è­‰ï¼Œä¸ç„¶ä¸€æ¨£æœƒå™´éŒ¯èª¤!&lt;/p>
&lt;p>é—œé–‰é™åˆ¶å¾Œåˆªé™¤/æ›´æ–°éƒ½ä¸æœƒæª¢æŸ¥ parentæ˜¯å¦å­˜åœ¨å°æ‡‰è³‡æ–™ï¼Œå³ä½¿é‡æ–°é–‹å•Ÿé™åˆ¶æª¢æŸ¥ä¹Ÿä¸æœƒå›æº¯ï¼Œæ‰€ä»¥å‹™å¿…å°å¿ƒã€‚&lt;/p></description></item><item><title>[æŠ€è¡“ç­†è¨˜] Designing Data-Intensive Applications ä¸‹</title><link>https://yuanchieh.page/posts/2018/2018-04-19-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8B/</link><pubDate>Thu, 19 Apr 2018 04:08:48 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-04-19-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8B/</guid><description>&lt;p>ä¸Šé›†:&lt;a class="link" href="https://yuanchieh.page/posts/2018/2018-03-28-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8A/" target="_blank" rel="noopener"
>Designing Data-Intensive Applications ä¸Š&lt;/a>&lt;/p>
&lt;p>éš¨è‘—è»Ÿé«”æ‡‰ç”¨ç¨‹å¼çš„ç™¼å±•ï¼Œæ‡‰ç”¨çš„ä¾·é™(bottleneck)å¾CPUç§»è½‰è‡³è³‡æ–™çš„è™•ç†ï¼Œè³‡æ–™çš„å·¨é‡ã€è¤‡é›œæ€§èˆ‡æ”¹è®Šçš„é€Ÿåº¦è®Šæˆæ£˜æ‰‹çš„å•é¡Œï¼Œä¹Ÿå°±æ˜¯ä½œè€…æ‰€å®šç¾©çš„ã€ŒData-Intensiveã€è³‡æ–™å¯†é›†çš„æ‡‰ç”¨ç¨‹å¼ã€‚&lt;/p>
&lt;p>ç¬¬äºŒéƒ¨åˆ†ä¸»è¦æ¢è¨åˆ†æ•£å¼å„²å­˜è³‡æ–™æœƒé‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•ï¼Œåˆ†æ•£å¼ç³»çµ±æœ‰å¹¾å¤§å„ªé»ï¼š&lt;/p>
&lt;ol>
&lt;li>Scalabilityï¼š&lt;br>
å¤§å¹…å¢åŠ ç³»çµ±çš„ä¹˜è¼‰èƒ½åŠ›&lt;/li>
&lt;li>Fault Tolerance / High Availability(HA)ï¼š&lt;br>
ç•¶å–®ä¸€ç¯€é»å¤±æ•ˆæ™‚ï¼Œä¸å½±éŸ¿ç³»çµ±çš„é‹ä½œ&lt;/li>
&lt;li>Latencyï¼š&lt;br>
å¦‚æœç”¨æˆ¶æ•£ä½ˆå…¨çƒï¼Œå¯ä»¥é€éå¤šç¯€é»éƒ¨ç½²ä½¿ç”¨æˆ¶åœ°ç†ä½ç½®æœ€è¿‘çš„è³‡æ–™ä¸­å¿ƒï¼Œé™ä½ç¶²è·¯å»¶é²&lt;/li>
&lt;/ol>
&lt;h2 id="ch5-replication">Ch5. Replication&lt;/h2>
&lt;p>Replication ä¹Ÿå°±æ˜¯å°‡ç›¸åŒçš„è³‡æ–™é€éç¶²è·¯è¤‡è£½åˆ°å¤šå°æ©Ÿå™¨ä¸Šï¼Œæœ‰å¹¾å€‹å¥½è™•&lt;br>
1. è®“ç”¨æˆ¶å¯ä»¥å–å¾—åœ°ç†ä½ç½®æœ€è¿‘çš„è³‡æ–™&lt;br>
2. å³ä½¿éƒ¨åˆ†æ©Ÿå™¨å¤±æ•ˆï¼Œç³»çµ±ä¹Ÿå¯ä»¥ç¹¼çºŒæ­£å¸¸é‹ä½œ&lt;br>
3. å¢åŠ æ©Ÿå™¨ &lt;strong>è®€&lt;/strong> çš„è² è¼‰èƒ½åŠ›&lt;/p>
&lt;p>åœ¨æ¶æ§‹ä¸Šæœ‰ä¸‰ç¨® Single-Master / Multi-Master / Leaderlessï¼ŒReplicationå¸¶ä¾†è¨±å¤šå¥½è™•ï¼Œä½†æ˜¯åœ¨ç³»çµ±å¯¦ä½œé¢æœƒæœ‰å–å¤šçš„è¡¡é‡ï¼Œä¾‹å¦‚èªªè¤‡æœ¬æ˜¯è¦åŒæ­¥é‚„æ˜¯éåŒæ­¥ã€å¦‚ä½•è™•ç†éŒ¯èª¤çš„è¤‡æœ¬ç¯€é»ã€æœ€çµ‚ä¸€è‡´æ€§çš„æ›²è§£ã€read-your-writesã€monotonic-readsä¿è­‰ç­‰å•é¡Œã€‚&lt;/p>
&lt;h3 id="leaders-and-followers">Leaders and Followers&lt;/h3>
&lt;p>æ¯å€‹æ“æœ‰è³‡æ–™åº«å‚™ä»½è³‡æ–™çš„ç¯€é»ç¨±ç‚º replicaï¼Œç‚ºäº†è®“æ¯ç­†å¯«å…¥éƒ½å¯ä»¥è¢«åŒæ­¥åˆ°replicaä¸Šï¼Œå¸¸ç”¨çš„æ¶æ§‹ç‚º leader-baseï¼Œä¹Ÿå°±æ˜¯Leader è² è²¬è³‡æ–™çš„å¯«å…¥ï¼Œä¸¦å°‡è³‡æ–™åŒæ­¥åˆ° Followerä¸­ä¿æŒåŒæ­¥ã€‚&lt;/p>
&lt;p>é€™ç¨®replicationæ¶æ§‹è¢«å»£æ³›ä½¿ç”¨ï¼ŒåŒ…å«Oracle / PostgreSQL / MySQL / Kafkaç­‰ã€‚&lt;/p>
&lt;h3 id="sync-andasync">Sync andÂ Async&lt;/h3>
&lt;p>ç•¶Leaderæ¥æ”¶åˆ°å¯«å…¥ï¼Œé€™æ™‚å€™è¦æ±ºå®šèªªæ˜¯å¦ç­‰åˆ°åŒæ­¥å®Œå…¨éƒ¨çš„ followeræ‰å›å‚³æˆåŠŸï¼Œå¦‚æœæ˜¯å…¨éƒ¨ followerèªªæˆåŠŸæ‰æˆåŠŸä¾¿æ˜¯ Syncï¼Œè‹¥éå‰‡ Asyncï¼Œä¹Ÿå¯ä»¥è¨­å®šè¶…éæŸæ•¸é‡ follower è®Šæˆ Semi-Asyncï¼›&lt;/p>
&lt;p>Syncå¥½è™•æ˜¯ç¢ºä¿followeréƒ½æ“æœ‰æœ€æ–°çš„è³‡æ–™ï¼Œé¿å…ç”¨æˆ¶åœ¨followerè®€å–åˆ°éæœŸè³‡æ–™ï¼Œä½†ç¼ºé»å°±æ˜¯å¦‚æœä¸€å€‹ followerå¡ä½äº†å°±æœƒé˜»æ“‹æ•´å€‹ç³»çµ±é‹ä½œï¼Œç³»çµ±å®¹éŒ¯èƒ½åŠ›å°±å¤§å¹…ä¸‹é™ï¼›&lt;br>
Asyncå¥½å£è™•å‰‡å‰›å¥½ç›¸æ³•ï¼Œå¯«å…¥å›æ‡‰é€Ÿåº¦å¿«ï¼Œç³»çµ±å®¹éŒ¯å¥½ä½†ç”¨æˆ¶å¯èƒ½æœƒè®€å–åˆ°éæœŸçš„è³‡æ–™ã€‚&lt;/p>
&lt;p>é€šå¸¸ä¾†èªªLeader-baseç³»çµ±éƒ½æ˜¯ä»¥Asyncç‚ºä¸»ï¼Œå› ç‚ºè®€å–éæœŸè³‡æ–™é€™é»å¾ŒçºŒæœ‰å…¶ä»–æ–¹å¼å¯ä»¥å½Œè£œã€‚&lt;/p>
&lt;h3 id="handle-nodeoutages">Handle NodeÂ Outages&lt;/h3>
&lt;p>ç•¶ç¯€é»å‡ºéŒ¯è¦é‡æ–°æ¢å¾©æ™‚ï¼Œæœƒæœ‰ä¸åŒçš„ç‹€æ³ï¼Œåˆå¯æ‹†æˆ Leader / Followerä¾†è™•ç†&lt;/p>
&lt;p>Followerå‡ºéŒ¯è¦æ¢å¾©æˆ–æ˜¯åŠ å…¥æ–°ç¯€é»æ¯”è¼ƒå®¹æ˜“ï¼Œåªè¦è³‡æ–™è¨˜éŒ„æœ‰è¿½ä¸ŠLeaderæœ€æ–°è³‡æ–™å³å¯&lt;/p>
&lt;p>ä½†æ˜¯Leaderå‡ºéŒ¯å°±éå¸¸éº»ç…©ï¼Œå¿…é ˆè¦å…ˆ åˆ¤å®šLeaderæ­»äº¡(é€šå¸¸é€éTimeout) -&amp;gt; é¸å‡ºæ–°çš„Leader -&amp;gt; æ•´å€‹ç³»çµ±æ‰¿èªæ–°çš„Leaderï¼Œä¸¦å°‡å¯«å…¥è«‹æ±‚è½‰å°åˆ°æ–°çš„Leaderä¸Šï¼Œé€™è£¡æœƒæœ‰å¹¾å€‹å®¹æ˜“å‡ºéŒ¯çš„åœ°æ–¹&lt;/p>
&lt;p>ä¾‹å¦‚èªª èˆŠçš„Leaderå¦‚æœæ˜¯æ¡ç”¨Asyncï¼Œæœ‰å¯èƒ½æœƒæœ‰éƒ¨åˆ†å¯«å…¥å°šæœªåŒæ­¥åˆ°å‚™ä»½ä¸­æ‰€ä»¥æœƒéºå¤±ï¼Œåœ¨Githubæ¡ç”¨MySQLæ¡ˆä¾‹ä¸­å°±ç™¼ç”Ÿéæ‰è³‡æ–™çµæœ Primary Keyé‡è¤‡çš„ç¾è±¡ï¼›&lt;br>
åˆæˆ–æ˜¯ç¨‹å¼æ²’è¨­è¨ˆå¥½ï¼Œæ„å¤–é¸å‡ºå¤šå€‹Leaderï¼Œç”¢ç”Ÿäººæ ¼åˆ†è£‚(Split brain)ï¼›&lt;br>
Timeoutè¨­å®šä¹Ÿå¾ˆé‡è¦ï¼Œå¤ªçŸ­æœƒå°è‡´ç¶²è·¯æ³¢å‹•å°±é€ æˆä¸å¿…è¦çš„Leaderåˆ‡æ›ï¼Œå¤ªé•·å‰‡éºå¤±çš„è³‡æ–™å¯èƒ½æœƒå¾ˆå¤šï¼Œé€™éƒ¨åˆ†å¾ˆéº»ç…©ï¼›&lt;/p>
&lt;p>åŸºæ–¼é€™äº›ç†ç”±ï¼Œä½œè€…æåˆ°ç¾åœ¨æœ‰è »å¤šå…¬å¸éƒ½æ¡ç”¨äººå·¥è™•ç†çš„æ–¹å¼ã€‚&lt;/p>
&lt;h3 id="implementation-of-replication-logs">Implementation of Replication Logs&lt;/h3>
&lt;ol>
&lt;li>Statement-based replication&lt;br>
æœ€ç°¡å–®çš„æ–¹å¼æ˜¯ç›´æ¥å°‡æ¯ç­†å¯«å…¥éƒ½passåˆ° replicaä¸Šï¼Œä½†é€™æœƒæœ‰å¹¾å€‹å£è™•ï¼Œå¦‚ NOW() / RAND()ç­‰å‡½å¼æœƒå› ç‚ºåŸ·è¡Œçš„æ™‚å€™å€¼è€Œæœ‰æ‰€ä¸åŒã€Auto-Incrementä¹Ÿæœƒæœ‰æ‰€å·®ç•°ï¼Œæ­¤å¤–é‚„å¿…é ˆä¿è­‰è¤‡è£½çš„éç¨‹å¯«å…¥è³‡æ–™é †åºå¿…é ˆç›¸åŒã€‚&lt;/li>
&lt;li>Write-ahead log (WAL) shipping&lt;br>
å°‡WALçš„è³‡æ–™ç›´æ¥è¤‡è£½åˆ°replicaå°±ä¸æœƒæœ‰ä¸Šè¿°çš„å•é¡Œï¼Œä½†ç¼ºé»æ˜¯logç›¸ç•¶åº•å±¤ï¼Œä¹Ÿå°±æ˜¯æœƒè·Ÿç³»çµ±çš„å„²å­˜å¼•æ“åµŒå¥—å¾ˆæ·±ï¼Œè·¨ç³»çµ±ä¸æ˜“ã€‚&lt;/li>
&lt;li>Logical (row-based) log replication&lt;/li>
&lt;/ol>
&lt;h3 id="problems-with-replication-lag">Problems with Replication Lag&lt;/h3>
&lt;ol>
&lt;li>Reading Your Own Writes&lt;br>
ç•¶ç”¨æˆ¶æ›´æ–°è³‡æ–™åˆ°Leaderä¸Šï¼Œå¦‚æœè©²ç”¨æˆ¶é¦¬ä¸Šéœ€è¦è®€å–è©²ç­†è³‡æ–™ï¼Œå¯èƒ½Followeré‚„æ²’æœ‰æ”¶åˆ°è¤‡è£½å›å‚³äº†éæœŸçš„è³‡æ–™ï¼›&lt;br>
è§£æ±ºæ–¹æ³•æœ‰Â &lt;br>
é€éæ‡‰ç”¨ç¨‹å¼è¿½è¹¤æ™‚é–“ï¼Œç•¶åœ¨æ›´æ–°å¾Œçš„ä¸€å®šæ™‚é–“å…§å¾Leaderè®€å–è³‡æ–™ã€&lt;br>
ç”¨æˆ¶ç´€éŒ„æ›´æ–°è³‡æ–™çš„æ™‚é–“ï¼Œç”±è³‡æ–™åº«ç¢ºä¿å¾replicaå–å‡ºæ­£ç¢ºçš„è³‡æ–™&lt;/li>
&lt;li>Monotonic Reads&lt;br>
ç•¶ç”¨æˆ¶å¾å¤šå€‹replicaè®€å–è³‡æ–™ï¼Œå¯èƒ½æŸäº›replicaåŒæ­¥æ¯”è¼ƒæ…¢å°è‡´ç”¨æˆ¶è®€å–å¤šæ¬¡è³‡æ–™å»ä¸åŒï¼›&lt;br>
å¯ä»¥ç¶å®šç”¨æˆ¶åœ¨åŒä¸€å€‹replicaè®€å–è³‡æ–™ï¼Œé¿å…ä¸ä¸€è‡´çš„è³‡æ–™ç‹€æ³å‡ºç¾ã€‚&lt;/li>
&lt;li>Consistent Prefix Reads&lt;br>
åŒæ¨£æ˜¯å› ç‚ºreplicaåŒæ­¥æœ‰æ™‚é–“å·®ï¼Œç”¨æˆ¶å¯èƒ½æœƒè®€åˆ°é †åºéŒ¯äº‚çš„è³‡æ–™ï¼Œä¾‹å¦‚å•é¡Œå‹¢å¿…åœ¨ç­”æ¡ˆä¹‹å‰å‡ºç¾(æœ‰å•é¡Œæ‰èƒ½æœ‰å›ç­”)&lt;/li>
&lt;/ol>
&lt;h3 id="multi-leader-replication">Multi-Leader Replication&lt;/h3>
&lt;p>å¤šLeaderçš„æ¶æ§‹ç³»çµ±å®¹éŒ¯æ€§æ›´å¥½ã€å¯«å…¥çš„æ€§èƒ½ä¹Ÿå¯ä»¥ææ˜‡ï¼Œä½†ç¼ºé»æ˜¯è³‡æ–™è¡çªçš„æƒ…æ³æœƒå¾ˆå¤šï¼Œç•¶ç™¼ç”Ÿè¡çªæ™‚å¾ˆå¤šæ™‚å€™å¿…é ˆç”±æ‡‰ç”¨ç¨‹å¼ä¾†è§£æ±ºã€‚&lt;/p>
&lt;h3 id="leaderless-replication">Leaderless Replication&lt;/h3>
&lt;p>å¯«å…¥å’Œè®€å–éƒ½ä¸€æ¬¡ä½¿ç”¨å¤šå€‹ç¯€é»ï¼Œé€éé‡ä¾†ä¿è­‰è³‡æ–™çš„æ­£ç¢ºæ€§èˆ‡ç³»çµ±å®¹éŒ¯æ€§ï¼Œä¾‹å¦‚ç¸½å…±æœ‰5å€‹node(n)ï¼Œåªè¦æˆ‘å€‘å¯ä»¥å¯«å…¥3å€‹ä»¥ä¸Šç¯€é»(w)èˆ‡è®€å–æ™‚è®€åˆ°3å€‹ç¯€é»ä»¥ä¸Š(r)ï¼Œåœ¨ç¬¦åˆ w + r &amp;gt; nçš„æƒ…æ³ä¸‹ï¼Œå°±å¯ä»¥ä¿è­‰æœƒè®€å–åˆ°æœ€æ–°çš„è³‡æ–™ï¼Œæ­¤æ™‚ç³»çµ±å¯ä»¥å®¹å¿ n-w å€‹ç¯€é»å¤±æ•ˆã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__ud8JMaGfu__JywzSmo0kLWw.png"
loading="lazy"
alt="https://tech.liuchao.me/2017/12/ddia-5/"
>
&lt;a class="link" href="https://tech.liuchao.me/2017/12/ddia-5/" target="_blank" rel="noopener"
>https://tech.liuchao.me/2017/12/ddia-5/&lt;/a>&lt;/p>
&lt;h2 id="ch6-partition">Ch6. Partition&lt;/h2>
&lt;p>Partitionåˆ†ç‰‡ä¸»è¦æ˜¯æå‡ç³»çµ±çš„Scalabilityï¼Œç•¶å¤§é‡çš„è³‡æ–™å¯ä»¥è¢«å¹³å‡åˆ†æ•£åˆ°ç¯€é»ä¸Šï¼Œå¯«å…¥å’Œè®€å–ã€Œç†è«–ä¸Šã€å°±å¯ä»¥éš¨è‘—ç¯€é»æ•¸æˆç·šæ€§æˆé•·ï¼›&lt;/p>
&lt;p>åœ¨å¯¦ä½œä¸Šï¼ŒPartitionå¸¸èˆ‡Replicationåšæ­é…ï¼Œå°‡è³‡æ–™åˆ†ç‰‡ä¸¦è¤‡è£½åˆ°å…¶ä»–ç¯€é»ä¸Šå¢åŠ å®¹éŒ¯ç©ºé–“&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__e5hRNbqh8dOc4lXntcu1ug.png"
loading="lazy"
alt="https://tech.liuchao.me/2017/12/ddia-6/"
>
&lt;a class="link" href="https://tech.liuchao.me/2017/12/ddia-6/" target="_blank" rel="noopener"
>https://tech.liuchao.me/2017/12/ddia-6/&lt;/a>&lt;/p>
&lt;p>æœ‰å€‹è‰¯å¥½çš„è³‡æ–™åˆ†ç‰‡æ©Ÿåˆ¶å¾ˆé‡è¦ï¼Œå¦‚æœåˆ†ç‰‡çš„æ–¹å¼ä¸å¤ è™Ÿï¼Œå¦‚é‡ä¸Š hot-keyç”¢ç”Ÿæ­ªæ–œskewedï¼Œå°è‡´è³‡æ–™ä¸å¹³å‡åˆ†æ•£åˆ°ç¯€é»ä¸Šï¼Œæœƒå°è‡´ç³»çµ±çš„æ€§èƒ½ç„¡æ³•å¾—åˆ°é¡¯è‘—çš„æå‡ï¼Œä»¥ä¸‹æœ‰å…©ç¨®å¸¸è¦‹çš„åˆ†ç‰‡æ©Ÿåˆ¶&lt;/p>
&lt;h3 id="partitioning-by-keyrange">Partitioning by KeyÂ Range&lt;/h3>
&lt;p>ä¸€ç¨®å¸¸è¦‹çš„åšæ³•æ˜¯å°‡ Keyæ’åºä¸¦å°‡æŸé€£çºŒæ®µçš„Keyåˆ†ç‰‡ï¼Œé€™ç¨®åšæ³•å¥½è™•æ˜¯ç°¡å–®å¯¦ä½œã€å¦‚æœè¦ç¯„åœæœå°‹è³‡æ–™å¾ˆæ–¹ä¾¿ï¼›&lt;br>
ç¼ºé»æ˜¯å®¹æ˜“æœƒæœ‰ hot-keyçš„å•é¡Œã€‚&lt;/p>
&lt;p>æ‰€ä»¥åœ¨å¥—ç”¨ä¸Šéœ€è¦ç‰¹åˆ¥æ³¨æ„æ‡‰ç”¨ç¨‹å¼æœ¬èº«çš„è³‡æ–™Keyç‰¹æ€§ï¼Œä¾‹å¦‚èªªæ„Ÿæ¸¬å™¨æ”¶é›†ç³»çµ±ï¼Œæ¡ç”¨ timestamp ç•¶ä½œkeyå¯ä»¥ä½¿å¾ŒçºŒæ—¥æœŸç¯„åœæŸ¥è©¢éå¸¸å®¹æ˜“ï¼Œä½†ç¼ºé»æ˜¯ç•¶å¤©çš„å¯«å…¥éƒ½æœƒé›†ä¸­åœ¨åŒä¸€å€‹partitionä¸Šï¼›&lt;br>
å¯ä»¥è€ƒæ…®æ”¹æˆç”¨ æ„Ÿæ¸¬å™¨ç·¨è™Ÿï¼Œé€™æ¨£å¯«å…¥å°±å¯ä»¥å¹³å‡åˆ†æ•£ï¼Œä½†ç›¸å°å°±è®Šæˆç¯„åœè®€å–æ¯”è¼ƒéº»ç…©ã€‚&lt;/p>
&lt;h3 id="partitioning-by-hash-ofkey">Partitioning by Hash ofÂ Key&lt;/h3>
&lt;p>å¯ä»¥é€é hash functionå°‡keyè½‰æˆå¯å¹³å‡åˆ†æ•£çš„é›œæ¹Šå€¼ï¼Œå¥½è™•æ˜¯å¯«å…¥å¯ä»¥æ›´å¹³å‡åˆ†æ•£ï¼Œä½†ç¼ºé»å°±æ˜¯å¤±å»äº†ç¯„åœæœå°‹ï¼›&lt;/p>
&lt;p>Cassandraå˜—è©¦é€éçµ„åˆKeyä¾†èåˆä¸Šé¢å…©ç¨®æ–¹å¼ï¼ŒKeyçš„å‰åŠæ®µç”¨Hashæ±ºå®špartitionä½ç½®ï¼Œpartitionä¸­å‰‡ä¾ç…§Keyçš„å¾ŒåŠæ®µæ’åºå¢å¼·ç¯„åœæœå°‹ï¼›&lt;br>
ä¾‹å¦‚èªª(user_id, update_timestamp)ï¼Œé€éuser_idåˆ†æ•£ç”¨æˆ¶çš„è³‡æ–™ï¼Œä½†å¦‚æœæœ‰éœ€è¦å–å¾—æŸç”¨æˆ¶çš„ç¯„åœè³‡æ–™æ›´æ–°å°±å¯ä»¥ç”¨update_timestampã€‚&lt;/p>
&lt;h3 id="partitioning-and-secondary-indexes">Partitioning and Secondary Indexes&lt;/h3>
&lt;p>å…ˆå‰æçš„æ˜¯é€é Primary Keyï¼Œä½†å¦‚æœè¦æŸ¥è©¢ Secondary Keyå°±æœƒé‡åˆ°ä¸åŒçš„å•é¡Œï¼Œä¾‹å¦‚èªª æ±½è»Šè³‡æ–™æ˜¯ {carIdÂ , nameÂ , color}ç­‰ï¼Œä¸»éµæ˜¯carIdä¸¦ä¾æ­¤ä¾†åˆ†ç‰‡ï¼Œä½†å¦‚æœç”¨æˆ¶è¦æŸ¥è©¢ color = â€˜redâ€™çš„è»Šå­å°±éœ€è¦å¦å¤–è™•ç†&lt;/p>
&lt;h3 id="partitioning-secondary-indexes-bydocument">Partitioning Secondary Indexes byÂ Document&lt;/h3>
&lt;p>åœ¨å€‹åˆ¥partitionä¸­è‡ªè¡Œç¶­è­·å„è‡ªè³‡æ–™çš„ Secondary index tableï¼Œæ‰€ä»¥ç”¨æˆ¶çš„è®€å–è«‹æ±‚éœ€è¦é€åˆ°æ¯å€‹partitionä¸­ä¸¦æ•´åˆï¼Œä¹Ÿå°±æ˜¯ scatter /gatherã€‚&lt;br>
ç¼ºé»å°±æ˜¯è®€å–æ•ˆç‡å¾ˆå·®ï¼Œå› ç‚ºå¯èƒ½æŸäº›partitionå›å¾©æ¯”è¼ƒæ…¢æ•´å€‹è«‹æ±‚å°±æœƒè¢«å¡ä½ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__3OY9Re3mGd__GuWpjogmvOA.png"
loading="lazy"
alt="https://tech.liuchao.me/2017/12/ddia-6/"
>
&lt;a class="link" href="https://tech.liuchao.me/2017/12/ddia-6/" target="_blank" rel="noopener"
>https://tech.liuchao.me/2017/12/ddia-6/&lt;/a>&lt;/p>
&lt;h3 id="partitioning-secondary-indexes-byterm">Partitioning Secondary Indexes byÂ Term&lt;/h3>
&lt;p>èˆ‡å…¶å€‹åˆ¥partitionåˆ†åˆ¥ç¶­è­·Secondary index(local)ï¼Œå¯ä»¥å°‡ç›¸åŒçš„Secondary indexç´€éŒ„çµ±ä¸€å„²å­˜åœ¨æŸç‰¹å®špartitionä¸­ï¼Œé€éè®€å–è©²ç´€éŒ„ï¼Œå†å»æ‰€æœ‰ç´€éŒ„æ‰€åœ¨çš„partitionè®€å–è³‡æ–™å³å¯ã€‚&lt;/p>
&lt;p>è‡³æ–¼è©²ç­† Secondary indexè¦è¨˜éŒ„åœ¨å“ªå¯ä»¥é€éå‰è¿°çš„å…©ç¨®æ–¹å¼åˆ†æ•£åˆ°ä¸åŒnodeä¸Šã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__yaaNNaAUaHSUFmodO0Dhtw.png"
loading="lazy"
alt="https://tech.liuchao.me/2017/12/ddia-6/"
>
&lt;a class="link" href="https://tech.liuchao.me/2017/12/ddia-6/" target="_blank" rel="noopener"
>https://tech.liuchao.me/2017/12/ddia-6/&lt;/a>&lt;/p>
&lt;p>é€™ç¨®æ–¹å¼æå‡è®€å–çš„æ•ˆèƒ½ï¼Œä½†ç¼ºé»æ˜¯å¯«å…¥è®Šå¾—ååˆ†è¤‡é›œï¼Œä¿®æ”¹å–®ä¸€ç­†è³‡æ–™éœ€è¦åŒæ­¥æ›´æ–°ä¸åŒpartitionä¸­çš„ Secondary Indexï¼Œé€™åœ¨åˆ†æ•£å¼ä¸­æœƒæœ‰å¾ˆå¤šéš±è—çš„å•é¡Œã€‚&lt;/p>
&lt;h3 id="rebalancing-partitions">Rebalancing Partitions&lt;/h3>
&lt;p>å¦‚æœç³»çµ±é™„è¼‰å¢åŠ ï¼Œå¯èƒ½æœƒéœ€è¦å¢åŠ  partitionçš„æ©Ÿå™¨æˆ–æ˜¯ç§»é™¤å‡ºéŒ¯çš„æ©Ÿå™¨ç­‰ï¼Œé€™æ™‚å€™æœƒéœ€è¦é‡æ–°èª¿æ•´partitionï¼Œå°‡è³‡æ–™é‡æ–°å¹³è¡¡åˆ°æ‰€æœ‰æ©Ÿå™¨ä¸Šã€‚&lt;/p>
&lt;p>å¹³è¡¡çš„æ–¹å¼æœ‰&lt;/p>
&lt;ol>
&lt;li>hash mod Nï¼š&lt;br>
ç›´æ¥æŠŠ hash key mod {æ‰€æœ‰æ©Ÿå™¨æ•¸}å³å¯ï¼Œä½†ç¼ºé»æ˜¯å¢åŠ ä¸€å°æ©Ÿå™¨å°±æœƒæœ‰å¤§é‡è³‡æ–™éœ€è¦æ¬ç§»ï¼Œé€ æˆä¸å¿…è¦çš„è² æ“”&lt;/li>
&lt;li>Fixed number of partitionsï¼š&lt;br>
å°‡æ‰€æœ‰è³‡æ–™åˆ‡æˆå¾ˆå¤šä»½ï¼Œä¸¦å¹³å‡åˆ†æ•£åˆ°æ©Ÿå™¨ä¸Šï¼Œä¾‹å¦‚èªª 10å°æ©Ÿå™¨å¯ä»¥å°‡è³‡æ–™åˆ†æˆ 1000ä»½ï¼Œå¹³å‡æ¯å°è² æ“” 100ä»½è³‡æ–™ï¼›&lt;br>
æ­¤æ™‚å¦‚æœæœ‰æ–°æ©Ÿå™¨åŠ å…¥ï¼Œé€™10å°æ©Ÿå™¨æ¯å°æŠ½9~10ä»½æ¬ç§»å³å¯ï¼Œå¦‚æœè¦ç§»é™¤èˆŠæ©Ÿå™¨åä¹‹ï¼›&lt;br>
é€™ç¨®æ–¹å¼æœ‰æ•ˆé™ä½ä¸å¿…è¦çš„è³‡æ–™æ¬ç§»ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="dynamic-partitioning">Dynamic partitioning&lt;/h3>
&lt;p>ä½¿ç”¨ Key-range partitionä¸å¤ªæ–¹ä¾¿ï¼Œå¦‚æœä¸€é–‹å§‹è¨­å®šéŒ¯èª¤ï¼Œæœƒå°è‡´è³‡æ–™å¤ªéé›†ä¸­æ–¼éƒ¨åˆ†ç¯€é»ï¼Œå¦‚æœè¦é‡æ–°è¨­å®šåˆæœƒå¾ˆéº»ç…©ï¼›&lt;br>
æ‰€ä»¥æŸäº›è³‡æ–™åº«(HBaseã€RethinkDB)å…§éƒ¨æä¾›å‹•æ…‹åˆ†å‰²çš„æ–¹æ³•ï¼Œç•¶ç™¼ç¾ partitionè³‡æ–™è¶…éæŸå€‹sizeï¼Œæœƒè‡ªå‹•åˆ†å‰²ä¸¦æŠŠè³‡æ–™åˆ†æˆå…©å€‹partitionï¼›&lt;br>
å¦‚æœè³‡æ–™å¤§é‡åˆªé™¤ï¼Œä¹Ÿæœƒè‡ªå‹•åˆä½µæˆå–®ä¸€å€‹partitionï¼›&lt;br>
æ¯å€‹partitionåˆ†æ•£åˆ°ä¸€å€‹ç¯€é»ä¸Šï¼Œè€Œä¸€å€‹ç¯€é»å¯èƒ½å„²å­˜å¤šå€‹partitionã€‚&lt;/p>
&lt;p>Dynamic partitionå¯æ”¯æ´ key-range partitionå’Œ hash-key partitionã€‚&lt;/p>
&lt;h3 id="request-routing">Request Routing&lt;/h3>
&lt;p>ç•¶ç”¨æˆ¶è¦ç™¼é€è«‹æ±‚ï¼Œå¦‚ä½•å¾—çŸ¥è©²å¾€å“ªå€‹ç¯€é»ç™¼é€å‘¢?Â &lt;br>
é€™å€‹å•é¡Œé€šç¨±ç‚º_service discovery_ ï¼Œä»»ä½•é€éç¶²è·¯çš„è»Ÿé«”éƒ½æœƒé‡ä¸Šæ­¤å•é¡Œï¼Œå°¤å…¶æ˜¯åˆ†æ•£å¼ç³»çµ±ã€‚&lt;/p>
&lt;p>ä¸»è¦è§£æ³•æœ‰ä¸‰ç¨®æ–¹å¼ï¼Œ&lt;br>
clientéš¨æ©Ÿç™¼é€è«‹æ±‚åˆ°æŸç¯€é»ï¼Œæ¯å€‹ç¯€é»éƒ½æœ‰åˆ†ç‰‡ä¾æ“šçš„ç´€éŒ„ï¼›&lt;br>
çµ±ä¸€ä¸€å€‹è² è²¬routingçš„ç¯€é»ï¼›&lt;br>
clientç«¯è‡ªè¡Œåˆ¤æ–·ç´€éŒ„åˆ†ç‰‡çš„ä¾æ“šã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__1HtoefsjWPhIJav0Zj__21g.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="ch8-the-trouble-with-distributed-systems">Ch8. The Trouble with Distributed Systems&lt;/h2>
&lt;h3 id="faults-and-partialfailures">Faults and PartialÂ Failures&lt;/h3>
&lt;p>åˆ†æ•£å¼ç³»çµ±å‚³éè³‡è¨Šéƒ½æ˜¯é ç¶²è·¯ï¼Œä½†ç¶²è·¯çš„æœ¬èº«æ˜¯ä¸å¯é çš„ï¼Œæ‰€ä»¥åˆ†æ•£å¼ç³»çµ±æœ€å¤§çš„ç–‘æ…®ä¾¿æ˜¯æœƒæœ‰&lt;strong>éƒ¨åˆ†éŒ¯èª¤&lt;/strong>çš„ç”¢ç”Ÿï¼Œåœ¨æŸäº›æ™‚åˆ»æˆ‘å€‘ç„¡æ³•å¾—çŸ¥æ“ä½œæ˜¯å¦å®Œå…¨æˆåŠŸï¼Œæ‰€ä»¥åœ¨è¨­è¨ˆä¸Šå¿…é ˆè€ƒé‡é€™ä¸€é»ï¼Œè¨­è¨ˆå‡ºå¯å®¹å¿éŒ¯èª¤(Fault-Tolerance)çš„ç³»çµ±ã€‚&lt;/p>
&lt;h3 id="unreliable-networks">Unreliable Networks&lt;/h3>
&lt;p>è«‡è«–ä¸€äº›ç¶²è·¯çš„ä¸å¯é æ€§ï¼Œå°æ¯”Telephone circuit ç”¨ç¡¬é«”èˆ‡å›ºå®šé »å¯¬çš„é€£ç·šæ–¹å¼å‚³è¼¸è³‡æ–™ï¼ŒTCPç‚ºäº†å¢é€²ç¸½é«”ä½¿ç”¨é‡æœƒæœ‰flow controlå°è‡´å‚³è¼¸é€Ÿåº¦ç„¡æ³•ä¼°æ¸¬ã€‚&lt;/p>
&lt;h3 id="unreliable-clocks">Unreliable Clocks&lt;/h3>
&lt;p>æ™‚é–“åœ¨é›»è…¦ç³»çµ±æ‰®æ¼”é‡è¦è§’è‰²ï¼Œå¤§è‡´æœ‰å…©å€‹æ™‚é–“å±¬æ€§ &lt;strong>å€é–“&lt;/strong>(Durationï¼Œå¦‚è¨ˆç®—requestæ™‚é–“)ã€&lt;strong>ç¢ºåˆ‡æ™‚é–“&lt;/strong>(points in timeï¼ŒéŒ¯èª¤çš„æ™‚é–“log)ï¼Œå†åˆ†æ•£å¼ç³»çµ±ä¸­æ™‚é–“å¾ˆtrickyï¼Œå› ç‚ºæºé€šä¸æ˜¯å³æ™‚çš„ï¼Œé€éç¶²è·¯å‚³éè¨Šæ¯æœƒç”¢ç”Ÿä¸å¯é æ¸¬çš„å»¶é²ï¼›&lt;br>
å†è€…æ¯å°é›»è…¦éƒ½æœ‰å„è‡ªçš„çŸ³è‹±éœ‡ç›ªå™¨è¨ˆç®—æ™‚é–“ï¼Œå› ç‚ºå„ç¨®ç‰©ç†æ€§è³ªä¸Šçš„å·®ç•°å°è‡´ç„¡æ³•å®Œå…¨ç²¾æº–åŒæ­¥æ¯å°é›»è…¦çš„æ™‚é–“ã€‚&lt;/p>
&lt;h3 id="monotonic-versus-time-of-day-clocks">Monotonic Versus Time-of-Day Clocks&lt;/h3>
&lt;ol>
&lt;li>Time-of-day clocks(åˆç¨± wall time)ï¼š&lt;br>
è¿”å›æ—¥æ›†æ™‚é–“ï¼Œé€šå¸¸æ˜¯é€éNTPåŒæ­¥æ™‚é–“ï¼Œä½†å¦‚æœé›»è…¦æ™‚é–“å¤ªå¿«æˆ–å¤ªæ…¢ï¼ŒåŒæ­¥ä¹‹å¾Œå¯èƒ½æœƒç”¢ç”Ÿæ™‚é–“è·³èºï¼Œç”¢ç”Ÿä¸€äº›å¾Œéºç—‡(å¦‚è³‡æ–™åº«å¯«ç´€éŒ„çš„è·³é‡å°è‡´è³‡æ–™ä¸ä¸€è‡´)&lt;/li>
&lt;li>Monotonic clocksï¼š&lt;br>
é©åˆç”¨ä¾†æ¸¬é‡æ™‚é–“å€é–“ï¼Œã€Œå¯¦éš›ä¸Šä»–æŒ‡çš„æ˜¯ç³»çµ±å•Ÿå‹•å¾Œæµé€çš„æ™‚é–“ï¼Œé€™æ˜¯ç”±è®Šæ•¸jiffiesä¾†ç´€éŒ„çš„ã€‚ç³»çµ±æ¯æ¬¡å•Ÿå‹•æ™‚jiffiesåˆå§‹åŒ–ç‚º0ï¼Œæ¯ä¾†ä¸€å€‹timer interruptï¼ŒjiffiesåŠ 1ï¼Œä¹Ÿå°±æ˜¯èªªä»–ä»£è¡¨ç³»çµ±å•Ÿå‹•ä¹‹å¾Œæµé€tickæ•¸**ã€&lt;br>
**(å‡ºè™•ï¼š&lt;a class="link" href="https://blog.csdn.net/peterlin666/article/details/32344355" target="_blank" rel="noopener"
>[Timerå­¦ä¹ ]wall timeå’Œmonotonic time&lt;/a>)ä½†ä¹Ÿå› ç‚ºå¦‚æ­¤ï¼Œæ‰€ä»¥è·¨ç³»çµ±é–“æ¯”è¼ƒMonotonic clocksæ˜¯æ²’æœ‰æ„ç¾©çš„ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="timestamps-for-orderingevents">Timestamps for orderingÂ events&lt;/h3>
&lt;p>å‡æƒ³ç³»çµ±æœ‰2å€‹Nodeï¼Œç•¶å…©å€‹å®¢æˆ¶Aã€BåŒæ™‚å°åŒä¸€ç­†è³‡æ–™åšæ”¹å¯«ï¼Œä½†æ˜¯Açš„Requestå…ˆåˆ°Node 1è€Œ Bå…ˆåˆ°Node 2ï¼Œå†è™•ç†ä½µç™¼æ™‚åˆ†æ•£å¼ç³»çµ±é€šå¸¸æ¡ç”¨LWW(Last-Write-Win)ï¼Œæ‰€ä»¥æ›´æ–°å¾ŒNode 1èˆ‡Node 2è³‡æ–™å°±æœƒä¸åŒæ­¥&lt;/p>
&lt;h3 id="process-pauses">Process Pauses&lt;/h3>
&lt;p>è©¦æƒ³ä¸€å€‹å±éšªçš„æƒ…æ³ï¼Œè³‡æ–™åº«æ¡ç”¨Single-Leaderæ¶æ§‹ï¼ŒLeaderéœ€è¦å›ºå®šä¸€æ®µæ™‚é–“é€šçŸ¥æ‰€æœ‰Follower Leaderé‚„æ´»è‘—ï¼Œä½†å¦‚æœLeaderçš„åŸ·è¡Œå¡ä½äº†éä¸€æ®µæ™‚é–“æ²’æœ‰é€šçŸ¥ï¼Œå…¶é¤˜Followeré¸å‡ºæ–°çš„Leaderå¾ŒåŒæ™‚èˆŠLeaderå¾©æ´»ï¼Œç”¢ç”Ÿäº†é›™Leaderçš„åˆ†æ­§å±€é¢&lt;/p>
&lt;p>åœ¨ä»¥ä¸‹æƒ…æ³æœƒç”¢ç”Ÿç¨‹å¼åŸ·è¡Œè¢«ç„¡é æœŸå¡ä½ï¼Œå¦‚åƒåœ¾å›æ”¶(GC)ï¼Œé€™æœƒå°è‡´ç¨‹å¼é‹ä½œç›´æ¥å¡æ­»ç›´åˆ°åƒåœ¾å›æ”¶çµæŸï¼›&lt;br>
åœ¨è™›æ“¬æ©Ÿä¸­VMä¹Ÿæœ‰å¯èƒ½è¢«æš«æ™‚çµ‚æ­¢åŸ·è¡Œã€åˆæˆ–æ˜¯åœ¨CPUåˆ‡æ›ä»»å‹™æ™‚ç³»çµ±è² è¼‰éå¤šè€Œå»¶é²ç­‰ç­‰å› ç´ &lt;/p>
&lt;h3 id="response-time-guarantees">Response time guarantees&lt;/h3>
&lt;p>ä¸Šè¿°å•é¡Œç”¢ç”Ÿæ–¼ æ‡‰ç”¨ç¨‹å¼ä¸çŸ¥é“åŸ·è¡Œæ™‚æœƒé‡åˆ°æ€æ¨£çš„çªç™¼çµ‚æ­¢ç‹€æ³ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥ä¿è­‰çªç™¼çµ‚æ­¢çš„æ™‚é–“æ˜¯å¯é æ¸¬çš„ï¼Œå°±å¯ä»¥é€éè¨­è¨ˆé¿å…å•é¡Œï¼Œä½†å•é¡Œå°±æ˜¯å¦‚ä½•ä¿è­‰å›æ‡‰æ™‚é–“?&lt;/p>
&lt;p>RTOS(real-time Operating System)ä¿è­‰CPUçš„æ™‚é–“åˆ‡å‰²æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å¯ä»¥å¾—çŸ¥æœ€ç³Ÿç‹€æ³æ‡‰ç”¨ç¨‹å¼æœƒè¢«çµ‚æ­¢å¤šä¹…ï¼›&lt;br>
ä½†RTOSé–‹ç™¼å¾ˆè²´ï¼Œé€šå¸¸ç”¨æ–¼é«˜åº¦å®‰å…¨çš„ç³»çµ±è¨­è¨ˆå¦‚é£›è¡Œç³»çµ±ï¼Œè€Œä¸”RTOSæœƒé™åˆ¶æ‡‰ç”¨ç¨‹å¼å¯ç”¨çš„Libraryã€å¯«æ³•ç­‰ï¼Œä¸é©ç”¨æ–¼ä¸€èˆ¬è³‡æ–™åº«ç³»çµ±ã€‚&lt;/p>
&lt;h3 id="the-truth-is-defined-by-themajority">The Truth Is Defined by theÂ Majority&lt;/h3>
&lt;p>åˆ†æ•£å¼ç³»çµ±ä¸­ï¼Œæ¯å€‹ç¯€é»åªèƒ½é€éç¶²è·¯æ”¶ç™¼è³‡æ–™ä¾†ç¢ºèªå½¼æ­¤çš„ç‹€æ…‹ï¼Œä½†æœ‰æ™‚å€™ç¯€é»é‹ä½œæ­£å¸¸ä½†åœ¨èˆ‡å…¶ä»–ç¯€é»çš„ç¶²è·¯æºé€šä¸Šå‡ºäº†å•é¡Œï¼Œæˆ–æ˜¯é‡ä¸ŠGCæ•´å€‹ç¯€é»å¡ä½ç­‰ï¼Œå°±æœ‰ä¸€æ¨£æœƒè¢«å…¶ä»–ç¯€é»èª¤èªç‚ºã€Œæ­»äº¡ã€&lt;/p>
&lt;p>æ­£å› ç‚ºåˆ†æ•£å¼ç³»çµ±è§£æ±ºäº†å–®ä¸€ç¯€é»å¤±æ•ˆçš„å•é¡Œï¼Œå¤±æ•ˆçš„æ±ºå®šå‰‡ä¾è³´å¤šæ•¸çš„ç¯€é»çš„æ±ºå®šã€‚&lt;/p>
&lt;h3 id="byzantine-faults">Byzantine Faults&lt;/h3>
&lt;p>å…ˆå‰æè¿°éƒ½æ˜¯ä»¥ç¯€é»å¤±æ•ˆç‚ºä¸»ï¼Œä½†å¦‚æœç¯€é»æœƒã€Œèªªè¬Šã€å‘¢? Byzantine Generals Problem æ‹œå åº­å°‡è»å•é¡Œå³æ˜¯æè¿°å¤šç¯€é»åœ¨ä¸çŸ¥é“å½¼æ­¤çš„æƒ…æ³ä¸‹å¦‚ä½•ç¢ºä¿å›å¾’ä¸æœƒå½±éŸ¿æ­£ç¢ºæ€§&lt;/p>
&lt;p>&lt;a class="link" href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98" title="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"
target="_blank" rel="noopener"
>æ‹œå åº­å°†å†›é—®é¢˜ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦&lt;/a>&lt;/p>
&lt;p>çµè«–å¤§è‡´æ˜¯åªè¦å‡ºéŒ¯çš„çµé»ä¸è¶…é 1/3å³å¯ä¿è­‰æ•´é«”çš„æ­£ç¢ºæ€§ã€‚&lt;/p></description></item><item><title>[æŠ€è¡“ç­†è¨˜] Designing Data-Intensive Applications ä¸Š</title><link>https://yuanchieh.page/posts/2018/2018-03-28-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8A/</link><pubDate>Wed, 28 Mar 2018 10:23:52 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-03-28-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8A/</guid><description>&lt;p>éš¨è‘—è»Ÿé«”æ‡‰ç”¨ç¨‹å¼çš„ç™¼å±•ï¼Œæ‡‰ç”¨çš„ä¾·é™(bottleneck)å¾CPUç§»è½‰è‡³è³‡æ–™çš„è™•ç†ï¼Œè³‡æ–™çš„å·¨é‡ã€è¤‡é›œæ€§èˆ‡æ”¹è®Šçš„é€Ÿåº¦è®Šæˆæ£˜æ‰‹çš„å•é¡Œï¼Œä¹Ÿå°±æ˜¯ä½œè€…æ‰€å®šç¾©çš„ã€ŒData-Intensiveã€è³‡æ–™å¯†é›†çš„æ‡‰ç”¨ç¨‹å¼ï¼›&lt;br>
ä½œè€…å‰è¨€æåŠ åœ¨ç¾ä»ŠBuzzwordæ»¿å¤©é£› Big Data / NoSQL / Web Scale blablablaï¼Œèº«ç‚ºæŠ€è¡“äººå“¡æ‡‰è©²æ›´é€å¾¹çš„äº†è§£è³‡æ–™å„²å­˜çš„åŸºæœ¬è§€å¿µï¼Œé€™äº›æ‰æ˜¯æ°¸æ†ä¸è®Šçš„åŸºçŸ³ï¼›&lt;br>
æœ‰äº†æ¸…æ¥šçš„æ¦‚å¿µï¼Œæ‰èƒ½åœ¨ä¸åŒçš„æ‡‰ç”¨å ´æ™¯å¥—ç”¨æœ€é©åˆçš„è§£æ³•ï¼Œè€è©±ä¸€å¥&lt;/p>
&lt;blockquote>
&lt;p>æ²’æœ‰éŠ€å½ˆ&lt;/p>
&lt;/blockquote>
&lt;p>æ­¤æ›¸åˆ‡æˆä¸‰å¤§éƒ¨åˆ†ï¼šè³‡æ–™ç³»çµ±çš„åŸºæœ¬çµ„æˆ(Foundation of Data Systems)ã€åˆ†æ•£å¼è³‡æ–™å„²å­˜(Distributed Data)ã€å–å¾—è³‡æ–™(Derived Data)ï¼›&lt;br>
ä½œè€…ç« ç¯€è¨­è¨ˆå¾ªåºæ¼¸é€²ï¼Œå…ˆå®šç¾©åŸºæœ¬ç”¨èªèˆ‡è³‡æ–™ç³»çµ±çš„è¨­è¨ˆç†å¿µèˆ‡å¯¦ä½œæ–¹å¼ï¼Œæ¥è‘—åŠ æ·±å…§å®¹ä¸”ä¸æ–·çš„å¼•ç”¨å‰é¢æ‰€è¿°èªªçš„è§€å¿µï¼›&lt;br>
ä»¥ä¸‹æ˜¯æˆ‘ç°¡å–®ç­†è¨˜æœ¬æ›¸2/3çš„å…§å®¹ï¼ŒDerived Dataç›®å‰æœ‰é»çœ‹ä¸æ‡‚æ‰€ä»¥å°±å…ˆæš«æ™‚è·³é OTZ&lt;/p>
&lt;h2 id="ch-1-reliable--scalable--maintainable">Ch 1. Reliable / Scalable / Maintainable&lt;/h2>
&lt;p>å†è¨è«–ç³»çµ±è¨­è¨ˆæ™‚ï¼Œå°±å¿…é ˆå…ˆåå•ã€Œæƒ³è¦è¨­è¨ˆå‡ºç¬¦åˆæ€æ¨£éœ€æ±‚çš„ç³»çµ±ã€&lt;br>
ä½œè€…æå‡ºä¸‰å¤§è»Ÿé«”è¨­è¨ˆçš„æ ¸å¿ƒ&lt;/p>
&lt;h3 id="reliable">Reliable&lt;/h3>
&lt;ol>
&lt;li>é‹ä½œéœ€èˆ‡ä½¿ç”¨è€…é æœŸçš„ç›¸åŒ&lt;/li>
&lt;li>å¯ä»¥å®¹å¿ç”¨æˆ¶ä»¥éé æœŸæ–¹å¼æ“ä½œç³»çµ±&lt;/li>
&lt;li>æ•ˆèƒ½éœ€å¥½åˆ°å¯ä»¥æ‡‰ä»˜ç”¨æˆ¶éœ€æ±‚&lt;/li>
&lt;li>é˜²æ­¢éæˆæ¬Šç™»å…¥èˆ‡æ¿«ç”¨&lt;/li>
&lt;/ol>
&lt;p>åŸºæœ¬ä¸Šå°±æ˜¯è¦èƒ½å¤ åœ¨ä¸€å®šçš„éŒ¯èª¤å®¹å¿ä¸‹é‹ä½œæ­£å¸¸ï¼Œå¸¸è¦‹çš„éŒ¯èª¤æœ‰&lt;/p>
&lt;ol>
&lt;li>ç¡¬é«”éŒ¯èª¤ï¼š&lt;br>
ä½œè€…æåŠåƒç¡¬ç¢Ÿçš„ MTTF(å¹³å‡æ™‚é–“å‡ºéŒ¯)æ˜¯10~50å¹´ï¼Œå¦‚æœä½ çš„è³‡æ–™ä¸­å¿ƒæœ‰10,000é¡†ç¡¬ç¢ŸåŸºæœ¬ä¸Šé æœŸæ˜¯æ¯å¤©éƒ½æœƒå£ä¸€é¡†!Â &lt;br>
=&amp;gt; å¸¸è¦‹è§£æ³•æ˜¯ï¼šå¢åŠ ç¡¬é«”å†—ä½™ã€ä½¿ç”¨RAIDã€é¡å¤–ä¾›é›»è¨­å‚™ã€ç•°åœ°å‚™ä»½ç­‰&lt;/li>
&lt;li>è»Ÿé«”éŒ¯èª¤&lt;/li>
&lt;li>äººç‚ºéŒ¯èª¤&lt;/li>
&lt;/ol>
&lt;h3 id="scalable">Scalable&lt;/h3>
&lt;p>éš¨è‘—ç”¨æˆ¶å¢åŠ ï¼Œç³»çµ±éœ€è¦è² æ“”çš„è³‡æ–™ä¹Ÿæˆå¹¾ä½•å¢é•·ï¼Œæ‰€ä»¥éœ€è¦ç³»çµ±çš„æ“´å……æ€§å»å›ç­”ã€Œæˆ‘å€‘å¦‚ä½•å¢åŠ é‹ç®—è³‡æºä¾†æ‡‰ä»˜å¢é•·çš„æµé‡?ã€&lt;br>
å†å›ç­”æ­¤å•é¡Œä¹‹å‰ï¼Œå¿…é ˆå…ˆçŸ¥é“å¦‚ä½•æè¿°ã€Œ&lt;strong>æ­¤åˆ»ç³»çµ±çš„è² è¼‰é‡&lt;/strong>ã€ï¼Œæ ¹æ“šä¸åŒçš„ç³»çµ±è¨­è¨ˆæœ‰ä¸åŒçš„è¡¡é‡æ–¹å¼ï¼Œä¾‹å¦‚å¸¸è¦‹çš„ request per seconds / è³‡æ–™åº«è®€å¯«æ¯” / æœ€å¤§åŒæ™‚ä¸Šç·šäººæ•¸ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾å‡ºä¸åŒçš„ã€Œ&lt;strong>é—œéµé™„è¼‰ä¿‚æ•¸(Key Load Parameters)ã€&lt;/strong>ï¼›&lt;/p>
&lt;p>è¡¡é‡æ€§èƒ½éƒ¨åˆ†å¯ä»¥é€é percentileè¿½è¹¤ï¼Œåˆ†æå›æ‡‰é€Ÿåº¦çš„ç™¾åˆ†æ¯”åœ–ï¼ŒAmazonæœ‰åšä¸€å€‹æœ‰è¶£çš„åˆ†ææŒ‡å‡º æœ€æ…¢çš„Requestæ„å¤–ç™¼ç¾æ˜¯æœ€æœ‰åƒ¹å€¼çš„å®¢æˆ¶ï¼Œå› ç‚ºå¾€å¾€ä»–å€‘çš„Requestå¤¾å¸¶æœ€å¤šçš„è³‡è¨Šï¼Œæ‰€ä»¥ä¹Ÿå°è‡´é€Ÿåº¦æœ€æ…¢ï¼›&lt;/p>
&lt;p>ä½œè€…èˆ‰ Twitteråœ¨2012å¹´åšç”¨æˆ¶ç™¼é€è¨Šæ¯ç‚ºä¾‹ï¼š&lt;br>
Twitter æœ‰å…©å€‹ä¸»è¦æ“ä½œ&lt;br>
1. ç™¼ tweetï¼š&lt;br>
ç”¨æˆ¶ç™¼é€æ–°è¨Šæ¯(4.6K req/secï¼Œé«˜å³°è¶…é 12K req / sec)&lt;br>
2. Home timelineï¼š&lt;br>
ç”¨æˆ¶æŸ¥çœ‹ä»–å€‘è¿½è¹¤çš„å°è±¡æ¶ˆæ¯åˆ— (300k req/sec)&lt;/p>
&lt;p>åœ¨è¨­è¨ˆä¸Šæœ‰å…©ç¨®æ–¹å¼ï¼š&lt;br>
1. ç™¼tweetæ™‚å°±æ˜¯å–®ç´”æ’å…¥æ–°çš„ä¸€ç­†ç´€éŒ„ï¼Œå¦‚æœæœ‰ç”¨æˆ¶è¦è®€home timelineå°±åš DB Joinå–å‡ºæ‰€æœ‰è¿½è¹¤å°è±¡çš„è¨Šæ¯&lt;br>
2. é‡å°æ¯ä½ç”¨æˆ¶éƒ½Cache home timelineï¼Œå¦‚æœæœ‰ç”¨æˆ¶æ–°å¢tweetå°±åŠ åˆ°å°æ‡‰è¿½è¹¤ç”¨æˆ¶çš„cacheä¸­&lt;/p>
&lt;p>Twitterå¾Œä¾†å¾æ–¹æ³•ä¸€è½‰è‡³æ–¹æ³•äºŒï¼ŒåŸå› æ˜¯å› ç‚ºæ–¹æ³•äºŒçš„è®€å–timelineé€Ÿåº¦å¿«äº†å…©å€‹ç´šåˆ¥ï¼Œæ‰€ä»¥å‚¾å‘æ–¼ &lt;strong>èŠ±å¤šé»æ™‚é–“åœ¨å¯«å…¥ä»¥ç¯€çœé¾å¤§çš„è®€å–æ™‚é–“ã€‚&lt;/strong>&lt;/p>
&lt;p>å°æ–¼Twitterä¾†èªªï¼Œç”¨æˆ¶çš„è¿½è¹¤æ•¸å°±æ˜¯é—œéµé™„è¼‰ä¿‚æ•¸ **ï¼Œ**ä½†æ¯ä½ç”¨æˆ¶çš„è¿½è¹¤æ•¸èˆ‡è¢«è¿½è¹¤æ•¸å·®ç•°ååˆ†çš„å¤§ï¼Œå°¤å…¶æ˜¯åäººï¼Œæ‰€ä»¥Twitterå¾Œä¾†æ¡ç”¨å…©ç¨®æ–¹æ³•æ··ç”¨ï¼Œä¸€èˆ¬ç”¨æˆ¶æ¡ç”¨æ–¹æ³•äºŒï¼Œè€Œåäººå‰‡å¦å¤–è™•ç†ã€‚&lt;/p>
&lt;h3 id="maintainable">Maintainable&lt;/h3>
&lt;p>è»Ÿé«”æœ€å¤§çš„èŠ±è²»ä¸åœ¨æ–¼å»ºç½®ï¼Œè€Œåœ¨æ–¼ç¶­è­·ï¼Œæ­¤è™•åˆæ‹†æˆä¸‰å€‹å­é …ç›®&lt;/p>
&lt;ol>
&lt;li>Operability&lt;br>
é€éä¸€äº›æ–¹å¼å¯ä»¥è®“è»Ÿé«”æ›´å¥½ç¶­é‹ï¼Œä¾‹å¦‚ ç›£æ§ç³»çµ±å¥åº·ã€éŒ¯èª¤è¿½è¹¤ç³»çµ±ã€å®šæœŸæ›´æ–°ç³»çµ±ã€éš”é›¢ä¸åŒç³»çµ±ç­‰&lt;/li>
&lt;li>Simpilicity&lt;br>
éš¨è‘—ç³»çµ±ç‡Ÿé‹ä¸å¯é¿å…åŠŸèƒ½ä¸€ç›´åŠ ï¼Œç³»çµ±ä¹Ÿç›¸å°è·Ÿè‘—è¤‡é›œï¼Œé€™è£¡çš„ç°¡æ˜“æ€§ä¸æ˜¯èªªè¦å»å‰Šæ¸›åŠŸèƒ½ï¼Œè€Œæ˜¯**é¿å…ä¸å¿…è¦çš„è¤‡é›œæ€§ï¼Œ**é€™è£è¤‡é›œæ€§çš„å®šç¾©æ˜¯ã€Œä¼åœ–åŠ å…¥å¯¦ä½œå±¤é¢çš„è§£æ³•è€Œè·Ÿè§£æ±ºå•é¡Œç„¡é—œã€ï¼Œè¦é¿å…è¤‡é›œæ€§å°±å¿…é ˆé€é **æŠ½è±¡åŒ–(Abstraction)ï¼Œ**ä¾‹å¦‚èªªé«˜éšèªè¨€ç†ç•¶ä¸éœ€è¦ç†æœƒCPUçš„æš«å­˜å™¨ç­‰æ“ä½œï¼Œå› ç‚ºèªè¨€æœ¬èº«å·²ç¶“é€éæŠ½è±¡åŒ–éš±è—äº†ä¸å¿…è¦çš„å¯¦ä½œè¤‡é›œæ€§ã€‚&lt;/li>
&lt;li>Evolvability&lt;br>
éœ€æ±‚æœƒåŠ ã€åŠŸèƒ½æœƒæ”¹ï¼Œæ‰€ä»¥ç³»çµ±å¿…é ˆä¿ç•™å½ˆæ€§é¢å°æ”¹è®Šã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="ch-2-data-models-and-query-languages">Ch 2. Data Models and Query Languages&lt;/h2>
&lt;p>é€™ä¸€ç« æ¢è¨è³‡æ–™å„²å­˜çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ Relation / Document / Graph Data Modelï¼Œè³‡æ–™å„²å­˜çš„å½¢å¼å¾ˆé‡è¦ï¼Œé€™æœƒæ±ºå®šæ€§å½±éŸ¿äº†æ‡‰ç”¨ç¨‹å¼çš„ç·¨å¯«ä»¥åŠåº•å±¤å„²å­˜æ–¹å¼çš„ä¸åŒï¼›&lt;/p>
&lt;p>Relation Data Modelæœ€ç‚ºå¸¸è¦‹ï¼Œå°‡è³‡æ–™çš„é—œè¯ä»¥tupleçš„é›†åˆå„²å­˜(ä¹Ÿå°±æ˜¯SQLçš„row)ï¼Œä½†æ˜¯ç¾ä»Šçš„ç¨‹å¼èªè¨€éƒ½æ˜¯ç‰©ä»¶å°å‘ï¼Œæ‰€ä»¥è¦åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­æ“ä½œè³‡æ–™å°±å¿…é ˆé€éORMå°‡è³‡æ–™è½‰æ›ç‚ºç‰©ä»¶å½¢å¼ï¼›&lt;br>
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼æœƒæœ‰ Document Data Modelï¼Œå› ç‚ºè³‡æ–™(åœ¨æ²’æœ‰è¤‡é›œé—œè¯ä¸‹)çš„æœ¬èº«å°±æ˜¯å€‹æ–‡æœ¬ç‰©ä»¶ï¼Œé€™è£¡çš„Documentåå‘æ–¼æè¿°å¯ä»¥ç”¨ JSON / XML çµæ§‹åŒ–èªè¨€æè¿°çš„è³‡æ–™æ ¼å¼ï¼Œä¾‹å¦‚ å±¥æ­· {name: â€œhelloâ€, age: 25,Â â€¦.}ã€‚&lt;/p>
&lt;p>ä½†ç¾å¯¦ä¸Šè³‡æ–™æœ¬èº«æœ‰ä¸åŒçš„é—œè¯æ€§ï¼Œæœ‰One to Many ä¹Ÿæœ‰ Many to Manyï¼ŒåŸºæœ¬ä¸Šæ¡ç”¨ä½•ç¨®Data Modelå¯ä»¥å¾è³‡æ–™é›†å¤šå°å¤šçš„é—œè¯æ€§è¤‡é›œåº¦ä¾†æ±ºå®šï¼›&lt;br>
å¦‚æœè³‡æ–™åƒ…æœ‰å°‘éƒ¨åˆ†å¤šå°å¤šé—œè¯ï¼Œå¯ä»¥é¸æ“‡æ¡ç”¨Document Data Modelï¼Œå› ç‚ºç›¸å°æ‡‰ç”¨ç¨‹å¼çš„ä»£ç¢¼æ¯”è¼ƒå¥½å¯«ï¼Œä¸éœ€å¤šä¸€å±¤ORMè½‰æ›ã€å°‘æœ‰çš„å¤šå°å¤šå¯ä»¥ç”¨æ‡‰ç”¨ç¨‹å¼ä»£ç¢¼è‡ªå·±å¯¦è¸JoinåŠŸèƒ½ï¼›&lt;br>
å¦‚æœæ³¨é‡ç‰©ä»¶çš„å¤šå°å¤šé—œè¯æ€§å‰‡å¯ç”¨ Relation Data Modelï¼›&lt;br>
å¦‚æœç‰©ä»¶çš„é—œè¯æ€§ç›¸ç•¶è¤‡é›œå¯ä»¥è€ƒæ…® Graph Data Modelï¼Œé€™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¸åˆ°æ­¤è§€å¿µï¼Œè³‡æ–™æ¨¡å‹æ”¹ä»¥åœ–å½¢åŒ–æ–¹å¼å‘ˆç¾ï¼Œè³‡æ–™å¯åˆ†æˆverticeèˆ‡edgeï¼Œverticeæ¯”è¼ƒåƒæ˜¯å„²å­˜å–®é«”çš„è³‡æ–™ï¼Œè€Œedgeå‰‡å„²å­˜verticeé–“çš„é—œä¿‚ï¼Œé€éåœ–å½¢åŒ–çš„ç‰¹æ€§å¯ä»¥è¡¨é”ç›¸ç•¶è¤‡é›œã€éè¿´çš„é—œä¿‚ï¼Œé€™éƒ¨åˆ†å¯ä»¥åƒè€ƒæˆ‘ä¹‹å‰å˜—è©¦ &lt;a class="link" href="http://sj82516-blog.logdown.com/post/5823130" target="_blank" rel="noopener"
>neo4jçš„ç­†è¨˜&lt;/a>ã€‚&lt;/p>
&lt;p>ç•¶ç„¶ä¸Šè¿°åªæ˜¯å–®ç´”ä»¥è³‡æ–™é—œè¯èˆ‡å°æ‡‰çš„æ¨¡å‹ä¾†è¡¡é‡ï¼Œç¾å¯¦çš„æŠ€è¡“æ¡ç´éœ€è¦æœ‰æ›´å…¨é¢é€šç›¤çš„è€ƒé‡ã€‚&lt;/p>
&lt;p>é€™ä¸€ç« æ¯”è¼ƒæ˜¯åœ¨è¬›å¤ï¼ŒæŠŠéå»æ›¾å‡ºç¾éçš„è³‡æ–™æ¨¡å‹èˆ‡å°æ‡‰çš„Queryèªè¨€éƒ½ç¨å¾®å¸¶åˆ°ã€‚&lt;/p>
&lt;p>æœ€å¾Œç­†è¨˜ä¸€é»è »æœ‰è¶£çš„è§€é»ï¼Œä½œè€…æåˆ° Document Databaseéƒ½æœƒè¢«èª¤ç¨±ç‚º schemalessï¼Œä½†å…¶å¯¦æ›´æº–ç¢ºèªªæ³•æ˜¯ schema-on-readï¼Œé›–ç„¶DBæ²’æœ‰é¡¯æ€§çš„è³‡æ–™æ¬„ä½ï¼Œä½†æ˜¯åœ¨æ‡‰ç”¨ç¨‹å¼è®€å–æ™‚ä¸€æ¨£æœƒæœ‰è³‡æ–™çš„æ¶æ§‹ï¼Œå°æ‡‰çš„æ˜¯Relation Databaseçš„schema-on-writeï¼›&lt;br>
schema-on-readæœ‰é»åƒæ˜¯å‹•æ…‹èªè¨€ï¼Œè³‡æ–™çš„æª¢æŸ¥åœ¨æ‡‰ç”¨ç¨‹å¼æœ¬èº«ï¼›è€Œschema-on-writeåƒéœæ…‹èªè¨€çš„å‹åˆ¥æª¢æŸ¥ï¼Œåœ¨å¯«å…¥æ™‚å°±å…ˆæª¢æŸ¥äº†ã€‚&lt;/p>
&lt;h2 id="ch-3-storage-and-retrieval">Ch 3. Storage and Retrieval&lt;/h2>
&lt;p>é€™ç« ç¯€ç®—æ˜¯æˆ‘è¦ºå¾—æœ€æœ‰è¶£çš„ä¸€ç« ï¼Œä¸»è¦è«‡åˆ°è³‡æ–™åº«åº•å±¤å¦‚ä½•å°‡è³‡æ–™å­˜å…¥ç¡¬ç¢Ÿä¸­ï¼Œä»¥åŠå¦‚ä½•å¿«é€Ÿçš„é€éç´¢å¼• Index å¾ç¡¬ç¢Ÿå–å‡ºè³‡æ–™ï¼›&lt;/p>
&lt;p>é¦–å…ˆä½œè€…ç”¨shell scriptç·¨å¯«æœ€ç°¡å–®çš„è³‡æ–™åº«&lt;/p>
&lt;blockquote>
&lt;p>db_set () { echo â€œ$1, $2â€ &amp;raquo; database}&lt;br>
db_get () { grep â€œ^$1,â€ database | sed -e â€œs/^$1,//â€ | tail -n 1}&lt;br>
$ db_set 123 â€˜{name: â€œ123â€}â€™&lt;br>
$ db_get 123&lt;/p>
&lt;/blockquote>
&lt;p>æ¡ç”¨é¡ä¼¼ CSVæ ¼å¼çš„ éµ-å€¼å„²å­˜ï¼Œå°‡æ–°çš„è³‡æ–™ä¸æ–·appendåˆ°æ–‡ä»¶ä¸Šï¼Œæœ€å¾Œæœå°‹æ™‚å¾æ–‡ä»¶æœ€æœ«çš„è³‡æ–™é–‹å§‹æ‰¾èµ·ï¼›&lt;br>
é€™æ¨£å¯«çš„æ•ˆèƒ½å¾ˆå¥½ï¼Œå› ç‚ºå–®ç´”appendè³‡æ–™é€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯è®€å–å‰‡éœ€è¦O(n)çš„æ™‚é–“ï¼›&lt;/p>
&lt;p>ç‚ºäº†å¢åŠ è®€å–çš„æ•ˆèƒ½ï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹ç´¢å¼•ï¼Œåœ¨è¨˜æ†¶é«”ä¸­ç”¨Hash Tableè³‡æ–™çµæ§‹ï¼Œå„²å­˜éµå°æ‡‰æ¬„ä½åœ¨ç¡¬ç¢Ÿçš„å„²å­˜ä½ç½®ï¼ŒåŠ é€Ÿè®€å–çš„æ•ˆèƒ½ã€‚&lt;/p>
&lt;p>é›–ç„¶é€™çœ‹èµ·ä¾†å¾ˆç°¡å–®ï¼Œä½†å¯¦éš›ä¸Šå»ä¹Ÿæœ‰è³‡æ–™åº«æ˜¯æ¡ç”¨æ­¤è¨­è¨ˆæ–¹å¼ï¼Œå¦‚ Bitcaskã€‚&lt;/p>
&lt;p>å…ˆå‰æåˆ°é€™ç¨®åšæ³•æ˜¯ä¸æ–·å°‡æ–°è³‡æ–™appendåˆ°ç¡¬ç¢Ÿæ–‡ä»¶ä¸Šï¼Œå³ä½¿åŒæ¨£çš„éµä¹Ÿæ˜¯ï¼Œä½†æ˜¯é€™æ¨£æ–‡ä»¶ç¸½ä¸èƒ½ç„¡æ­¢ç›¡çš„å¢åŠ ä¸‹å»ï¼Œæ‰€ä»¥æœƒæœ‰æ‰€è¬‚çš„ compact process å£“å¯¦ç¨‹åºï¼Œä¹Ÿå°±æ˜¯é‡æ•´èˆŠçš„æ–‡ä»¶ï¼Œå°‡å†—ä½™é‡è¤‡çš„éµå»é™¤åªä¿ç•™æœ€æ–°çš„ç´€éŒ„ï¼Œæ¸›å°‘ä¸å¿…è¦çš„éæ™‚è³‡æ–™å„²å­˜ç©ºé–“ã€‚&lt;/p>
&lt;p>ä½†ä¸Šè¿°æ–¹å¼æœ‰å…©å€‹ç¼ºé»Â &lt;/p>
&lt;ol>
&lt;li>ç´¢å¼•å¿…é ˆå°æ–¼è¨˜æ†¶é«”ç¸½é‡å¦å‰‡æ€§èƒ½æœƒå¾ˆå·®&lt;/li>
&lt;li>ä¸æ”¯æ´ç¯„åœè®€å–&lt;/li>
&lt;/ol>
&lt;h3 id="sorted-stringtable">Sorted StringÂ Table&lt;/h3>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__1AvQY5KBV2mRADK07aq4BA.png"
loading="lazy"
alt="åœ–ç‰‡ä¾†æºï¼šhttps://tech.liuchao.me/2017/11/ddia-3/"
>
åœ–ç‰‡ä¾†æºï¼š&lt;a class="link" href="https://tech.liuchao.me/2017/11/ddia-3/" target="_blank" rel="noopener"
>https://tech.liuchao.me/2017/11/ddia-3/&lt;/a>&lt;/p>
&lt;p>æ‰€ä»¥å¾Œä¾†æœ‰æå‡ºæ–°çš„ä½œæ³• Sorted String Table (ç°¡ç¨± SSTable)ï¼Œå·®åˆ¥åœ¨æ–¼ç´¢å¼•æ”¹é€é ä¾ç…§å­—ä¸²é †åºæ’åºå¾Œçš„è³‡æ–™çµæ§‹å„²å­˜ï¼Œé€™æœ‰é»åƒæ˜¯å­—å…¸ç´¢å¼•ï¼Œç•¶æˆ‘å€‘è¦æŸ¥ä¸€å€‹å–®å­— hello æˆ‘å€‘å¯ä»¥é€éå‰å¾Œçš„å­—å»æ‰¾åˆ°ç›¸è¿‘çš„ä½ç½®ï¼›&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœåœ¨è¨˜æ†¶é«”ä¸­æ‰€ä»¥åªæœ‰ he / holaï¼Œé‚£æˆ‘å€‘è‡³å°‘çŸ¥é“ hello å‹¢å¿…åœ¨æ­¤å…©å€‹ä½ç½®ä¸­é–“ï¼Œé€é é †åºè®€ sequential read å¯ä»¥éå¸¸å¿«çš„åœ¨ç¡¬ç¢Ÿä¸­æ‰¾åˆ°è³‡æ–™ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä½œè€…å¼·èª¿ é †åºè®€å¯«å°æ–¼ç¡¬ç¢Ÿçš„æ•ˆèƒ½æœ‰å¾ˆå¤§çš„å¹«åŠ©ï¼Œå³ä½¿æ˜¯SSD&lt;/p>
&lt;/blockquote>
&lt;h3 id="b-tree">B Tree&lt;/h3>
&lt;p>ä½†æ˜¯SSTableä¸¦ä¸æ˜¯æœ€å¸¸ç”¨çš„è³‡æ–™ç³»çµ±å„²å­˜çš„æ–¹å¼ï¼Œè€Œæ˜¯B Treeï¼ŒB Treeæ˜¯å€‹å¹³è¡¡äºŒå‰æ¨¹ï¼Œæ¯ç¯€é»ç´€éŒ„å¤šå€‹å€é–“å€¼èˆ‡å°æ‡‰çš„å­ç¯€é»ï¼Œæ¯å€‹å­ç¯€é»å‰‡ç´€éŒ„ä¸€æ®µé€£çºŒå€¼ã€‚&lt;/p>
&lt;p>&lt;img src="https://yuanchieh.page/post/img/1__sGWCREWf3auzlU2H1j6LEw.png"
loading="lazy"
alt="åœ–ç‰‡é€£çµï¼šhttps://tech.liuchao.me/2017/11/ddia-3/"
>
åœ–ç‰‡é€£çµï¼š&lt;a class="link" href="https://tech.liuchao.me/2017/11/ddia-3/" target="_blank" rel="noopener"
>https://tech.liuchao.me/2017/11/ddia-3/&lt;/a>&lt;/p>
&lt;p>åœ¨å„²å­˜æ–¹å¼ä¸Šä¸æ˜¯æ¡ç”¨append onlyï¼Œè€Œæ˜¯å°‡å„²å­˜ç©ºé–“åˆ‡å‰²å›ºå®šå¤§å°çš„ Pageï¼Œä¸¦æŠŠç¯€é»çš„è³‡æ–™æ”¾å…¥ï¼Œå¦‚æœæœ‰æ–°çš„è³‡æ–™ç”¢ç”Ÿæœƒè¦†å¯«èˆŠçš„Pageï¼Œé€™é»èˆ‡SSTableå¤§å¤§ä¸åŒã€‚&lt;/p>
&lt;p>åœ¨å¯¦ä½œä¸Šï¼ŒB Treeå› ç‚ºæœƒå…ˆå°‡Pageè³‡æ–™æš«å­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œç‚ºäº†é¿å…è³‡æ–™éºå¤±æœƒåœ¨è³‡æ–™å¯«å…¥æ™‚å…ˆå°‡è³‡æ–™ç´€éŒ„åˆ°append-only çš„WAL(Write-Ahead Log)ï¼Œæ‰€ä»¥ä¸€ç­†è³‡æ–™å¯«å…¥å…¶å¯¦æœƒæœ‰å…©æ¬¡å¯«å…¥ç¡¬ç¢Ÿå‹•ä½œã€‚&lt;/p>
&lt;p>B Tree å°æ¯” SSTable å¥½è™•åœ¨æ–¼&lt;/p>
&lt;ol>
&lt;li>è³‡æ–™å†—é¤˜å°‘&lt;/li>
&lt;li>æ‰¾å°‹ä¸å­˜åœ¨çš„éµå€¼æ¯”è¼ƒå¿«(SSTableå¿…é ˆæŸ¥å®Œæ‰€æœ‰èˆŠè³‡æ–™æ‰å¯ä»¥ç¢ºå®š)&lt;/li>
&lt;li>ä¸éœ€è¦ compact processå»é‡æ•´è³‡æ–™ï¼Œä½œè€…æåˆ°é›–ç„¶ compact processé€šå¸¸åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä½†ä½ æ°¸é ç„¡æ³•é æœŸä½•æ™‚ç³»çµ±æœƒçˆ†é‡ï¼Œä¹Ÿå°±æ˜¯èªªå¥½æ­»ä¸æ­»å¤§é‡è®€å¯«æ™‚å¡åˆ°ç³»çµ±åœ¨ compact processå°±æ¬²å“­ç„¡æ·šï¼Œç›¸å°ä¾†èªª B Treeçš„ç³»çµ±é™„è¼‰æ¯”è¼ƒå¯é æœŸï¼›&lt;br>
SSTableå¥½è™•åœ¨æ–¼ B Treeåˆ‡å‰²Pageå®¹æ˜“æœ‰ç©ºé–“çš„ç ´ç¢åŒ–èˆ‡æµªè²»ï¼Œä¸”éƒ¨åˆ†è³‡æ–™æ›´æ–°ä¹Ÿå¿…é ˆæ›´å‹•å°æ‡‰çš„Pageï¼›&lt;/li>
&lt;/ol>
&lt;h3 id="column-base">Column-Base&lt;/h3>
&lt;p>ä¸€èˆ¬è³‡æ–™åº«åœ¨OLTPä¸­éƒ½æ˜¯ä»¥row-basedç‚ºå°å‘çš„ï¼›&lt;br>
ä½†æ˜¯åœ¨OLAPä¸­ï¼Œæˆ‘å€‘å¸¸æœƒå°‡å¤šå€‹DBè³‡æ–™å½™æ•´åˆ°çµ±ä¸€çš„è³‡æ–™å€‰å„²ä¸­ï¼Œæ‰€ä»¥è³‡æ–™é‡éå¸¸é¾å¤§ï¼Œä¸”æ¯ç­†requestä¹Ÿéƒ½è¦é‹ç®—éå¸¸å¤§é‡çš„è³‡æ–™ï¼Œé€™æ™‚å€™æœ‰å€‹æ–°çš„åšæ³•ä»¥column-baseå„²å­˜è³‡æ–™ï¼Œé€™æ¨£æœ€å¤§å¥½è™•åœ¨æ–¼åŒä¸€å€‹columné€šå¸¸è³‡æ–™é‡è¤‡æ€§é«˜ï¼Œä¾‹å¦‚é¡è‰²å°±é‚£å¹¾ç¨®ã€ç”¢å“IDå¯èƒ½ä¹Ÿæœƒé‡è¤‡ï¼Œé€™ç¨®ç‰¹æ€§å¯ä»¥ä½¿ &lt;strong>è³‡æ–™å£“ç¸®&lt;/strong> å¾—åˆ°éå¸¸å¥½çš„æ•ˆæœï¼›&lt;br>
ä½†ç¼ºé»å°±æ˜¯å¯«å…¥å¾ˆéº»ç…©ã€‚&lt;/p>
&lt;p>åœ¨åº•å±¤ç´€éŒ„ä¸Šï¼ŒB Treeç„¡æ³•å¥—ç”¨åœ¨å£“ç¸®æ¬„ä½ä¸Šï¼Œå› ç‚ºç´¢å¼•æ˜¯ç´€éŒ„row-basedçš„éµï¼Œæ‰€ä»¥å¤šå€‹columnæ¬„ä½æ›´å‹•æœƒå°è‡´éå¤šçš„Pageéƒ½è¦ä¸€å¹¶åˆ·æ–°ï¼›&lt;br>
æ‰€ä»¥æœƒæ¡ç”¨ SSTableç•¶ä½œå¯«å…¥ç¡¬ç¢Ÿçš„è³‡æ–™å„²å­˜æ–¹å¼ï¼Œæ¯æ¬¡å¯«å…¥éƒ½ç”¢ç”Ÿæ–°æª”æ¡ˆã€‚&lt;/p>
&lt;h2 id="ch-4-encoding-and-evolution">Ch 4. Encoding and Evolution&lt;/h2>
&lt;p>åœ¨ç³»çµ±çš„æ¼”é€²ä¸Šï¼Œéœ€è¦æ³¨æ„ç›¸å®¹æ€§å•é¡Œï¼Œå¯åˆ†æˆ&lt;br>
ãƒ»å‘å¾Œç›¸å®¹ï¼šæ–°çš„codeå¯èƒ½è®€å–åˆ°èˆŠè³‡æ–™&lt;br>
ãƒ»å‘å‰ç›¸å®¹ï¼šèˆŠçš„codeå¯èƒ½è®€å–åˆ°æ–°è³‡æ–™&lt;/p>
&lt;p>ç¨‹å¼åœ¨è™•ç†è³‡æ–™ä¸Šæœƒæœ‰å…©ç¨®å½¢å¼&lt;br>
ä¸€ç¨®æ˜¯ in memoryï¼Œåƒæ˜¯ object / array / intç­‰ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿CPUåšé‹ç®—ï¼›&lt;br>
å¦ä¸€ç¨®åœ¨éœ€è¦å¯«å…¥æª”æ¡ˆæˆ–æ˜¯é€éç¶²è·¯å‚³è¼¸æ™‚ï¼Œéœ€è¦é‡æ•´æˆå­—ä¸²çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯encode&lt;/p>
&lt;p>å¸¸è¦‹çš„ encodeå½¢å¼æœ‰éå¸¸å¤šç¨®ï¼ŒåŒ…å«JSON / XML /CSVï¼Œç‚ºäº†è®“è³‡æ–™å¯ä»¥ç”¨æœ€å°å®¹é‡å‚³éï¼Œä½œè€…ä»‹ç´¹äº†æ•¸ç¨®åŸºæ–¼JSONçš„encode / decodeæŠ€è¡“ï¼Œåœ¨encodeçš„éç¨‹ä¸­è¦æ³¨æ„è³‡æ–™æ ¼å¼èˆ‡å‹åˆ¥éœ€è¦å¯ä»¥decodeã€‚&lt;/p>
&lt;p>åŸæœ¬JSONåŸå§‹è³‡æ–™ 66 bytesï¼Œé€éä¸åŒçš„binary encodeæŠ€è¡“æœ€çµ‚å¯ä»¥å£“ç¸®åˆ° 34 bytes!&lt;/p>
&lt;h3 id="ä¸‹é›†">ä¸‹é›†&lt;/h3>
&lt;p>&lt;a class="link" href="https://yuanchieh.page/posts/2018/2018-04-19-%E6%8A%80%E8%A1%93%E7%AD%86%E8%A8%98-designing-data-intensive-applications-%E4%B8%8B/" target="_blank" rel="noopener"
>æŠ€è¡“ç­†è¨˜ Designing Data-Intensive Applications ä¸‹&lt;/a>ï¼Œç¬¬äºŒéƒ¨åˆ†ä¸»è¦æ¢è¨åˆ†æ•£å¼å„²å­˜è³‡æ–™æœƒé‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•ï¼Œåˆ†æ•£å¼ç³»çµ±æœ‰å¹¾å¤§å„ªé»&lt;/p></description></item><item><title>[é–±è®€å¿ƒå¾—] å¨›æ¨‚è‡³æ­»</title><link>https://yuanchieh.page/posts/2018/2018-03-27-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97-%E5%A8%9B%E6%A8%82%E8%87%B3%E6%AD%BB/</link><pubDate>Tue, 27 Mar 2018 12:10:32 +0000</pubDate><guid>https://yuanchieh.page/posts/2018/2018-03-27-%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97-%E5%A8%9B%E6%A8%82%E8%87%B3%E6%AD%BB/</guid><description>&lt;p>ä¸€é–‹å§‹æœƒæƒ³è®€é€™æœ¬æ›¸æ˜¯å› ç‚ºçœ‹åˆ°å­¸é•·çš„å¿ƒå¾—æ–‡ï¼Œç°¡ç•¥æåˆ°å°åˆ·æ™‚ä»£çš„æ€æƒ³æ¯”è…³æ·±å±¤å®Œæ•´ï¼Œè€Œé›»è¦–(ç¶²è·¯)æ™‚ä»£å‰‡æ˜¯ç‰‡æ–·ç‘£ç¢ï¼›&lt;br>
ç•¶åˆçœ‹å®Œå¿ƒå¾—ä¸å¤ªèªåŒï¼Œå› ç‚ºæˆ‘æœƒç›´è¦ºåœ°èªç‚ºèªªã€Œåª’é«”åªæ˜¯è¼‰å…·ï¼Œé‡é»æ˜¯äººçš„æ€æƒ³ã€ï¼Œä¹Ÿå°±æ˜¯è†šæ·ºçš„äººä¸è«–åœ¨å“ªå€‹æ™‚ä»£éƒ½æ˜¯è†šæ·ºçš„ï¼›&lt;br>
å¾Œä¾†èˆ‡å­¸é•·ç•™è¨€è¨è«–ä¸€ä¸‹ï¼Œç™¼ç¾é€™æœ¬æ›¸çš„è«–è¿°é æ¯”æˆ‘æƒ³åƒçš„æ·±é ï¼Œä»Šæ—¥æ‹œè®€å¾Œæ·±æ„Ÿé«”æ‚Ÿè‡ªå·±çš„è†šæ·ºï¼Œæ‰€ä»¥ç‰¹æ­¤ç´€éŒ„è®€å¾Œæ„Ÿã€‚&lt;/p>
&lt;p>è‡ªæˆ‘èƒŒæ™¯ä¸¦éå‚³æ’­åª’é«”ç›¸é—œï¼Œéå»ä¹Ÿé®®å°‘æ¥è§¸æ­¤é¡å‹çš„æ›¸ï¼Œæ‰€ä»¥çœ‹èµ·ä¾†è »ç¡¬çš„ï¼Œå»åˆå¾ˆéç™®ï¼Œæ­£å› ç‚ºå°‘æ¥è§¸æ‰€ä»¥åœ¨æ¥æ”¶ä¸€äº›æ–°è§€é»æ™‚æœƒååˆ†çš„éœ‡æ’¼ã€‚&lt;/p>
&lt;h4 id="æ›¸ç±èƒŒæ™¯">æ›¸ç±èƒŒæ™¯&lt;/h4>
&lt;p>é€™æ¬¡æˆ‘è²·çš„æ˜¯20é€±å¹´å†ç‰ˆçš„ç‰ˆæœ¬ï¼Œæ­¤æ›¸å‡ºç‰ˆæ–¼1985å¹´ä»£ï¼Œè™•æ–¼é›»è¦–è“¬å‹ƒç™¼å±•çš„ä¸–ä»£ï¼Œä½œè€… æ³¢èŒ²æ›¼æ˜¯è‘—åçš„åª’é«”æ–‡åŒ–ç†è«–å®¶ï¼Œè«‡è«–åˆ°åª’é«”å—åˆ°è¼‰å…·ç§‘æŠ€çš„ä¸åŒï¼Œå°è‡´äººé¡æ–‡åŒ–ä¸Šèˆ‡æ€æƒ³ä¸Šçš„æƒ¡è¡Œè½‰è®Šï¼Œé›–ç„¶é€™æœ¬æ›¸æ˜¯è«–è¿°é›»è¦–æ™‚ä»£ï¼Œä½†æ˜¯å…¶è§€é»åœ¨ç¶²è·¯æ™‚ä»£æ›´å€¼å¾—å»çœæ€ã€‚&lt;/p>
&lt;p>é€™æœ¬æ›¸æˆ‘è‡ªå·±æ‹†æˆä¸‰å€‹éƒ¨åˆ†&lt;/p>
&lt;ol>
&lt;li>åª’é«”å‚³æ’­æ–¹å¼å°æ–¼æ€æƒ³çš„å½±éŸ¿ï¼š&lt;br>
å‰å…©å€‹ç« ç¯€ä½œè€…èˆ‰äº†ä¸€äº›æ¡ˆä¾‹èªªæ˜ï¼Œé †ä¾¿é‡é‡çš„æ‰“è‡‰æˆ‘å‰›æ‰çš„å‡è¨­&lt;/li>
&lt;li>å°åˆ·å¼æ€æƒ³&lt;/li>
&lt;li>é›»è¦–å¼æ€æƒ³&lt;/li>
&lt;/ol>
&lt;h4 id="åª’é«”å‚³æ’­æ–¹å¼å°æ–¼æ€æƒ³çš„å½±éŸ¿">åª’é«”å‚³æ’­æ–¹å¼å°æ–¼æ€æƒ³çš„å½±éŸ¿&lt;/h4>
&lt;p>ä¸åŒçš„åª’é«”åå¥½ç‰¹å®šçš„å…§å®¹ï¼Œå¾è€Œå¾—ä»¥æ”¯é…æ–‡åŒ–ï¼Œä½œè€…èˆ‰ä¾‹åˆ° åŸå§‹çš„ç…™éœ§è¨Šæ¯æŠ€è¡“æ˜¯æ²’è¾¦æ³•å‚³éå“²ç†ï¼Œå› ç‚ºé™£é™£çš„ç…™éœ§ä¸å¤ è¤‡é›œï¼Œæ‰€ä»¥ã€Œå½¢å¼æœƒæ’æ–¥å…§å®¹ã€&lt;br>
åŒæ¨£çš„åœ¨é›»è¦–è¢å…‰å¹•ä¸Šï¼Œå¦‚æœç¸½çµ±å€™é¸äººæ˜¯å€‹135å…¬æ–¤çš„è¶…é‡é«”é‡ï¼Œç†è«–ä¸Šå€‹äººæ€æƒ³å…§å®¹ä¸è©²ç”¨å…¶å¤–è¡¨ä¾†è¡¡é‡ï¼Œä½†æ˜¯é€éè¦–è¦ºå½±åƒå‚³é”å°±ä¸å…æœƒæŠ¹æ®ºå…¶è¨€è«–çš„ç²¾å¦™ï¼ŒåŒç†ã€Œå½¢å¼æœƒæ’æ–¥å…§å®¹ã€&lt;/p>
&lt;p>æ­¤å¤–ï¼Œã€ŒçœŸç†æ¦‚å¿µçš„è¡¨é”å’Œè¡¨é”å½¢å¼å”‡é½’ç›¸ä¾ã€ï¼Œä¾‹å¦‚èªªåœ¨åšç ”ç©¶å ±å‘Šæ™‚æ›¸é¢æ–‡ç»çš„å¯ä¿¡åº¦é æ¯”å£èªæ–‡ç»ä¾†å¾—é«˜ï¼Œå› ç‚ºæ›¸é¢æ–‡å­—æ¯”è¼ƒå®¹æ˜“é©—è­‰ã€é§æ–¥ä¸”å®¢è§€ï¼›&lt;br>
æ‰€ä»¥äº‹å¯¦é™³è¿°å½¢å¼çš„é‡è¦ç¨‹åº¦éƒ½è¦–å‚³åª’çš„å½±éŸ¿åŠ›é‡è€Œå®šã€‚&lt;/p>
&lt;h4 id="å°åˆ·å¼æ€æƒ³">å°åˆ·å¼æ€æƒ³&lt;/h4>
&lt;p>ä½œè€…å®šç¾©äº†ä¸€å€‹ã€Œé—¡é‡‹æ™‚ä»£ã€ï¼Œé—¡é‡‹æ˜¯ç¨®æ€ç¶­æ¨¡å¼ï¼Œä¸€ç¨®å­¸ç¿’æ–¹å¼èˆ‡è¡¨é”é€”å¾‘ï¼ŒåŒ…å«è‘—å„ªç•°çš„æ¦‚å¿µã€æ¨ç†å’Œæ¢ç†æ€è€ƒèƒ½åŠ›ã€å´‡å°šç†æ€§å’Œç§©åºã€å®¢è§€æ€ç¶­ç­‰ç­‰ï¼›&lt;/p>
&lt;p>ä½œè€…æè¿°æ—è‚¯å’Œé“æ ¼æ‹‰æ–¯çš„ä¸ƒå ´è‘—åè¾¯è«–ï¼Œæ•´å€‹é›„è¾¯çš„éç¨‹é”ä¸ƒå°æ™‚ä¹‹ä¹…!è¨è«–å…§å®¹æ¶µè“‹äº†æ­·å²äº‹ä»¶ã€æ”¿æ²»è­°é¡Œã€å»¢å¥´æ”¿ç¶±ç­‰ï¼Œè¬›è©å…§å®¹è™•è™•åæ‡‰å°åˆ·å¼æ€ç¶­ï¼ŒåŒ…å«è«–è­‰èˆ‡åè­‰ã€ä¸»å¼µèˆ‡å°ç«‹ä¸»å¼µã€åŸºæ–¼æ–‡æœ¬çš„æ‰¹è©•å’Œæª¢é©—å°æ‰‹çš„æªè¾­ï¼Œè½çœ¾ä¸å–®éœ€è¦æœ‰è±å¯Œçš„èƒŒæ™¯çŸ¥è­˜ï¼Œé‚„éœ€è¦æœ‰å°æ–¼å…¬çœ¾äº‹å‹™åƒèˆ‡çš„ç†±æƒ…èˆ‡ç†æ€§çš„æ‰¹åˆ¤æ€è€ƒï¼Œè€Œé€™ç¾¤è½çœ¾åœ¨ç•¶æ™‚ä¸æ˜¯å°‘æ•¸çš„è²´æ—èè‹±ï¼Œè€Œæ˜¯ä¸‹è‡³è²©å¤«èµ°å’éƒ½æœ‰é€™æ¨£çš„æ€ç¶­èƒ½åŠ›ã€‚&lt;/p>
&lt;p>æ­£å› ç‚ºä½¿ç”¨ç´”æ–‡å­—è¡¨é”ï¼Œé‡é»è‘—é‡åœ¨æ–‡å­—ä¹˜è¼‰çš„æ„å¿µï¼Œæ‰€ä»¥å…§å®¹å¾€å¾€æ›´åŠ åš´è‚…èˆ‡è±å¯Œï¼Œä¸è«–æ˜¯ä½œè€…æˆ–é–±çœ¾éƒ½ç¿’æ…£ç†æ€§æ€è€ƒå»ç†è§£å†·éœçš„æŠ½è±¡å…§å®¹ï¼Œä¸¦ç”¨åš´è‹›çš„æ…‹åº¦å»æª¢è¦–å…§å®¹å‰å¾Œçš„ä¸€è‡´æ€§èˆ‡åˆç†æ€§ã€‚&lt;/p>
&lt;h4 id="é›»è¦–å¼æ€æƒ³">é›»è¦–å¼æ€æƒ³&lt;/h4>
&lt;p>åä¹ä¸–ç´€ä¸­æœŸï¼Œé›»å ±æ”¹è®Šå‚³éè³‡è¨Šçš„æ–¹å¼ï¼Œä»¥æ¥µå¿«çš„é€Ÿåº¦è·¨è¶Šæµ©ç€šçš„è·é›¢ï¼Œé€™æ”¹è®Šäº†ä»¥å¾€å°åˆ·æ™‚ä»£è¿½æ±‚ç†æ€§çš„è¨´æ±‚ï¼Œè½‰è®Šæˆè¿½æ±‚æ™‚æ•ˆæ€§ã€èª‡é£¾æ€§çš„æ–°èï¼›&lt;/p>
&lt;p>ä½œè€…æå‡ºæ‰€è¬‚çš„è¡Œå‹•è³‡è¨Šæ¯”ï¼Œæ„å³æ”¶åˆ°çš„è³‡è¨Šæœƒæœ‰å¤šå¤§çš„æ¯”ä¾‹å°è‡´è¡Œå‹•çš„æ”¹è®Šï¼Œåœ¨å°åˆ·æ™‚ä»£é€™å…©è€…çš„æ¯”è¼ƒé›·åŒï¼›&lt;br>
ä½†æ˜¯åœ¨é›»å ±æ™‚ä»£ä¹‹å¾Œï¼Œå› ç‚ºè³‡è¨Šå¤§é‡ç”¢ç”Ÿèˆ‡ç ´ç¢åŒ–ï¼Œäººå€‘é¢å°è³‡è¨Šéå‰©ï¼Œå°è‡´é¢è‡¨ç¤¾æœƒèˆ‡æ”¿æ²»è¡Œç‚ºèƒ½åŠ›ä¹Ÿé€æ­¥è¡°å¼±ï¼Œä¾‹å¦‚èªª è¦æ€éº¼ä¿è­·ç’°å¢ƒã€å¦‚ä½•é™ä½æ ¸æˆ°é¢¨éšªã€é€šè²¨è†¨è„¹ç‡ã€å¤±æ¥­ç‡èˆ‡çŠ¯ç½ªç‡ç­‰å•é¡Œï¼Œé›–ç„¶ç¾ä»Šæ–°èè™Ÿç¨±åœ‹éš›åŒ–ï¼Œæˆ‘å€‘å¸¸å¸¸åœ¨é›»è¦–éƒ½å¯ä»¥çœ‹åˆ°å„åœ‹çš„æ–°èå ±å°ï¼Œä½†æ“æœ‰é€™äº›ç ´ç¢åŒ–çš„è³‡è¨Šé ‚å¤šæ˜¯èŒ¶é¤˜é£¯å¾Œçš„è©±é¡Œï¼Œä½†ä¸èƒ½ææ˜‡æˆ‘å€‘çš„æ€ç¶­é€²è€Œå»ç”¨è¡Œå‹•è§£æ±ºå•é¡Œã€‚&lt;/p>
&lt;p>**ã€Œçµ¦æˆ‘å¨›æ¨‚ï¼Œå…¶é¤˜å…è«‡ã€&lt;br>
**é€™æ˜¯æ›¸æœ¬çš„å…¶ä¸­ä¸€å€‹ç« ç¯€åï¼Œé—¡è¿°åœ¨é›»è¦–è«–è¿°ä¸­å¨›æ¨‚æ˜¯å”¯ä¸€çš„è¡¨ç¾æ„è­˜å½¢æ…‹ï¼Œä»¥è¾¯è«–ç¯€ç›®ç‚ºä¾‹ï¼Œè¾¯è«–çš„éç¨‹åœ¨æ–¼æ€è€ƒä¸¦åé§å°æ–¹è«–è¿°ï¼Œä½†æ˜¯é€™æ¨£ã€Œæ€è€ƒã€çš„éç¨‹åœ¨é›»è¦–ç¯€ç›®ä¸Šæ˜¯ä¸è¨å¥½çš„ï¼Œæ‰€ä»¥å¾ˆé›£åœ¨é›»è¦–è¾¯è«–ç¯€ç›®ä¸Šçœ‹åˆ°ã€Œè®“æˆ‘æƒ³æƒ³ã€ã€ã€Œä½ èªªçš„â€¦æ˜¯ä»€éº¼æ„æ€ã€ã€ã€Œä½ çš„è³‡æ–™æ˜¯å¼•è¿°å“ªäº›ä¾†æºã€ç­‰è«–è¿°ï¼Œå› ç‚ºé€™æœƒæ‹–æ…¢ç¯€ç›®é€Ÿåº¦ï¼Œä¹Ÿå®¹æ˜“è®“è§€çœ¾æ„Ÿåˆ°ç„¡èŠï¼Œä½†ååé€™äº›å»æ˜¯æ‰¹åˆ¤æ€è€ƒé‡è¦çš„éç¨‹ï¼›&lt;br>
å–è€Œä»£ä¹‹çš„æ˜¯è¡¨æ¼”è—è¡“ä¸”å¨›æ¨‚æ„Ÿåè¶³çš„æ¼”èªªï¼Œå°±å¥½æ¯” 1984å¹´çš„é›»è¦–ç¸½çµ±è¾¯è«–æœƒï¼Œæ¯å€‹å€™é¸äººå¯ç™¼è¨€äº”åˆ†é˜ä¸¦è³ªå•å°æ‰‹ä¸€åˆ†é˜ï¼Œè©¦å•é€™éº¼çŸ­çš„æ™‚é–“å¦‚ä½•é—¡è¿°ã€Œä½ å°ä¸­ç¾æ´²çš„å¤–äº¤æ”¿ç­–ç‚ºä½•ã€é€™æ¨£çš„å•é¡Œå‘¢?&lt;br>
æ‰€ä»¥å€™é¸äººæ³¨é‡çš„ä¸å†æ˜¯å¦‚ä½•è¡¨è¿°è‡ªå·±çš„ç†å¿µï¼Œæ›´é‡è¦çš„æ˜¯å¦‚ä½•åœ¨çŸ­çŸ­çš„æ•¸åˆ†é˜å…§å»ºç«‹ã€Œå°è±¡ã€&lt;/p>
&lt;p>æœ€å¾Œä½œè€…æåˆ° &lt;strong>æ•™è‚²å°±æ˜¯å¨›æ¨‚&lt;/strong>ï¼Œé€™æ˜¯å€‹åè«·çš„æ¨™é¡Œï¼Œåœ¨åæ€è²åé æ’­çš„é›»è¦–æ•™è‚²ç¯€ç›® èŠéº»è¡—ï¼Œä½œè€…æå‡ºé›»è¦–æ•™è‚²ç‚ºäº†è¿åˆé›»è¦–ç¯€ç›®çš„ç‰¹æ€§æœ‰å¹¾å¤§ç‰¹è‰²ï¼š&lt;br>
éš¨æ™‚å¯ä»¥åŠ å…¥ã€ä¸å¾—ä»¤äººå¿ƒç”Ÿç–‘æƒ‘ã€é é é¿é–‹é—¡é‡‹ï¼Œæ‰€ä»¥æˆ‘å€‘åªèƒ½åœ¨èŠéº»è¡—ä¸­å­¸åˆ°ç ´ç¢åŒ–çš„çŸ¥è­˜ï¼Œå¯èƒ½å¹¾å€‹å–®å­—ã€å¹¾å¥ç‰‡èªï¼Œä½†æˆ‘å€‘æ°¸é å­¸ä¸æœƒçœŸæ­£çš„&lt;strong>å­¸ç¿’æ–¹æ³•&lt;/strong>ï¼Œå› ç‚ºå­¸ç¿’æ–¹æ³•æœ€åŸºæœ¬çš„ä¾¿æ˜¯é•·æœŸæ€ç´¢æŸå€‹é›£é¡Œï¼Œä½†é›»è¦–ç¯€ç›®æœ¬èº«å°±æ˜¯ç‚ºäº†å¨›æ¨‚ï¼Œå¼·åŠ æ•™è‚²ç›®çš„æ–¼ä¸Šé ­æ ¹æœ¬é”ä¸åˆ°æ•ˆæœï¼Œåªèƒ½è‡ªæ¬ºæ¬ºäººã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç•¶ç„¶æœ‰ä¸€é»å¾ˆé‡è¦ï¼Œä½œè€…ä¸¦ä¸æ’æ–¥å¨›æ¨‚ï¼Œä½†æ˜¯ç•¶æ‰€æœ‰å½¢å¼éƒ½ä»¥å¨›æ¨‚å‘ˆç¾å°±éå¸¸å¯æ€•&lt;/p>
&lt;/blockquote>
&lt;h4 id="çµèª">çµèª&lt;/h4>
&lt;p>ä½œè€…åœ¨æ›¸ä¸­åè¦†æåˆ°å…©æœ¬æ›¸ ã€Š1984ã€‹ã€ã€Šç¾éº—æ–°ä¸–ç•Œã€‹ï¼Œå…©è€…éƒ½æ˜¯åœ¨è«‡è«–æ°‘çœ¾æœƒæœ‰å¢®è½çš„è¶¨å‹¢ï¼Œå‰è€…ç†å¿µæ˜¯é«˜å£“æ”¿åºœä½¿æ°‘çœ¾å±ˆæœï¼›å¾Œè€…æåŠæˆ‘å€‘ç„¡éœ€å¤–åŠ›çµ‚å°‡æ¯€æ–¼è‡ªèº«æ‰€æ„›ï¼Œåœ¨é€™é›»è¦–æ™‚ä»£ï¼Œä½œè€…èªåŒèµ«èƒ¥é» ã€Šç¾éº—æ–°ä¸–ç•Œã€‹çš„è§€é»ï¼Œç¾åœ¨æˆ‘å€‘ä¸ç”¨æ“”å¿ƒçœŸç›¸æœƒè¢«éš±è—ï¼ŒçœŸæ­£è©²æ“”å¿ƒçš„æ˜¯çœŸç›¸è¢«ç¹ç‘£çš„å°äº‹çµ¦æ·¹æ²’ã€‚&lt;/p></description></item><item><title>Search</title><link>https://yuanchieh.page/search/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://yuanchieh.page/search/</guid><description/></item></channel></rss>