<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="整理 MySQL 的 Lock 與 Index 關係，以及 Deadlock debug 過程"><meta name=keywords content="MySQL"><title>【MySQL】Lock 與 Index 關係和 Deadlock 分析</title><link rel=canonical href=https://yuanchieh.page/posts/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/><link rel=stylesheet href=/scss/style.min.ff300df33b80e2ac49809c825614392ed1c7b27591d65d3c4043602cd162e25f.css><meta property="og:title" content="【MySQL】Lock 與 Index 關係和 Deadlock 分析"><meta property="og:description" content="整理 MySQL 的 Lock 與 Index 關係，以及 Deadlock debug 過程"><meta property="og:url" content="https://yuanchieh.page/posts/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="Yuanchieh"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-04-25T01:21:40+00:00"><meta property="article:modified_time" content="2022-04-25T01:21:40+00:00"><meta name=twitter:title content="【MySQL】Lock 與 Index 關係和 Deadlock 分析"><meta name=twitter:description content="整理 MySQL 的 Lock 與 Index 關係，以及 Deadlock debug 過程"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-82837682-4","auto"),ga("send","pageview"))</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82837682-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-82837682-4")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars0.githubusercontent.com/u/6858460?s=460&amp;v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Yuanchieh</a></h1><h2 class=site-description>生命是長期而持續的累積</h2></div></header><ol class=social-menu><li><a href=https://github.com/sj82516 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#clustered-index>Clustered Index</a><ol><li><a href=#1-如何-debug-deadlock>1. 如何 Debug Deadlock</a><ol><li><a href=#11-實際閱讀-deadlock>1.1 實際閱讀 Deadlock</a></li></ol></li><li><a href=#2-取得-lock-的順序性>2. 取得 Lock 的順序性</a><ol><li><a href=#21-建立-index-時決定順序>2.1 建立 Index 時決定順序</a></li><li><a href=#22-恰巧兩個-index-順序相仿>2.2 恰巧兩個 Index 順序相仿</a></li></ol></li><li><a href=#3-查詢沒有命中--gap-lock>3. 查詢沒有命中 : Gap Lock</a></li><li><a href=#4-範圍查詢鎖定找過的每筆資料即使條件不合>4. 範圍查詢：鎖定找過的每筆資料即使條件不合</a></li></ol></li><li><a href=#non-unique-index>Non Unique Index</a><ol><li><a href=#1-查詢命中依然會-gap-lock>1. 查詢命中：依然會 Gap Lock</a></li></ol></li><li><a href=#foreign-key會有-share-lock>Foreign Key：會有 Share Lock</a></li><li><a href=#總結與建議>總結與建議</a></li><li><a href=#進階為什麼不要預設-read-committed->進階：為什麼不要預設 Read Committed ?</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E8%B3%87%E6%96%99%E5%BA%AB/>資料庫</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2022/2022-04-25-mysqllock-%E8%88%87-index-%E9%97%9C%E4%BF%82%E5%92%8C-deadlock-%E5%88%86%E6%9E%90/>【MySQL】Lock 與 Index 關係和 Deadlock 分析</a></h2><h3 class=article-subtitle>整理 MySQL 的 Lock 與 Index 關係，以及 Deadlock debug 過程</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Apr 25, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><p>關於 MySQL Lock 來來回回寫了也有幾篇，每次看都有不同的發現，這次為了準備公司內部分享，重新再翻閱一次又找到一些新的有趣發現，以下將盡可能完整的解析 MySQL Lock 與 Index 的關係，怎樣的查詢會拿到怎樣的鎖，以及怎樣的查詢又可能互相 Deadlock</p><p>文章主要受啟發於 <a class=link href=https://www.aneasystone.com/archives/2018/04/solving-dead-locks-four.html target=_blank rel=noopener>解决死锁之路（终结篇） - 再见死锁</a>，對應的實驗可以看程式碼 <a class=link href=https://github.com/sj82516/mysql-deadlock-test target=_blank rel=noopener>sj82516/mysql-deadlock-test</a>，先說結論，<code>在 DML (更新、刪除、插入)的操作中，Lock 會與套用的 Index 有關</code>，在 MySQL 中 Index 有幾種</p><ol><li>Clustered Index:<br>通常是 Primary Key</li><li>Unique Secondary Index:<br>如果沒有 Primary Key，則 Unique Secondary Index 會是 Clustered Index，行為與 Clustered Index 雷同，不額外贅述</li><li>Non Unique Secondary Index</li></ol><p>以下將重點分析 Clustered Index / Non Unique Secondary Index 對於 MySQL 操作有什麼不同的影響，在 Read Committed 簡稱 RC) 與 Repeatable Read (簡稱 RR) 下又有怎樣的不同行為，實驗預設是 5.7 + Repeatable Read (MySQL 預設)</p><h2 id=clustered-index>Clustered Index</h2><p>先來一題簡單的暖身題，以下兩個 Transaction 為什麼會 Deadlock
<img src=/post/2022/img/0425/01.png loading=lazy>
要滿足 Deadlock 需要有四個條件</p><ul><li>no preemption</li><li>hold and wait</li><li>mutual exclusion</li><li>circular waiting</li></ul><p>在上面的案例中，MySQL 在 RR 下要 update 會先取得 exclusive lock，兩個 Transaction 手上都拿了對方想要的資源卻也不都會先放開手上的鎖，導致 Deadlock
<img src=/post/2022/img/0425/01_2.png loading=lazy></p><p>直接從圖片很容易看出彼此 Deadlock，但正式環境中多筆 Transaction 交雜，該如何找出 Deadlock 呢？</p><h3 id=1-如何-debug-deadlock>1. 如何 Debug Deadlock</h3><p>MySQL 有幾個相關參數</p><ol><li><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_deadlock_detect target=_blank rel=noopener>innodb_deadlock_detect</a>: 是否偵測 deadlock，預設開啟</li><li><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_lock_wait_timeout target=_blank rel=noopener>innodb_lock_wait_timeout</a>: 如果沒有開啟 Deadlock detect，建議設定較短的 wait timeout 否則會一直等到</li><li><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_print_all_deadlocks target=_blank rel=noopener>innodb_print_all_deadlocks</a>: 將所有 Deadlock 錯誤輸出至 error log</li></ol><p>如果沒有輸出 Deadlock error，可以用 <code>> SHOW ENGINE INNODB STATUS</code> 輸出，其中有兩個區塊 deadlock 顯示最近一筆 deadlock 錯誤，transaction 則會顯示目前在等待 lock 的 transaction</p><h4 id=11-實際閱讀-deadlock>1.1 實際閱讀 Deadlock</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>LATEST DETECTED DEADLOCK
</span></span><span class=line><span class=cl>------------------------
</span></span><span class=line><span class=cl>2022-04-26 09:33:29 0x40de5bc700
</span></span><span class=line><span class=cl><span class=ge>**</span>* (1) TRANSACTION:
</span></span><span class=line><span class=cl>TRANSACTION 9597, ACTIVE 3 sec starting index read
</span></span><span class=line><span class=cl>mysql tables in use 1, locked 1
</span></span><span class=line><span class=cl>LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
</span></span><span class=line><span class=cl>MySQL thread id 1034, OS thread handle 278338676480, query id 14980 172.17.0.1 root updating
</span></span><span class=line><span class=cl><span class=sb>`UPDATE teachers SET teachers.age = 10 WHERE teachers.id = 5`</span>
</span></span><span class=line><span class=cl><span class=ge>**</span>* (1) WAITING FOR THIS LOCK TO BE GRANTED:
</span></span><span class=line><span class=cl>RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9597 lock_mode X locks rec but not gap waiting
</span></span><span class=line><span class=cl>Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000005; asc         ;;
</span></span><span class=line><span class=cl> 1: len 6; hex 00000000257c; asc     %|;;
</span></span><span class=line><span class=cl> 2: len 7; hex 23000001c017d1; asc #      ;;
</span></span><span class=line><span class=cl> 3: len 1; hex 62; asc b;;
</span></span><span class=line><span class=cl> 4: len 4; hex 80000010; asc     ;;
</span></span><span class=line><span class=cl> 5: SQL NULL;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=ge>**</span>* (2) TRANSACTION:
</span></span><span class=line><span class=cl>TRANSACTION 9596, ACTIVE 3 sec starting index read
</span></span><span class=line><span class=cl>mysql tables in use 1, locked 1
</span></span><span class=line><span class=cl>3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
</span></span><span class=line><span class=cl>MySQL thread id 1033, OS thread handle 278608463616, query id 14979 172.17.0.1 root updating
</span></span><span class=line><span class=cl><span class=sb>`UPDATE teachers SET teachers.age = 6 WHERE teachers.id = 1`</span>
</span></span><span class=line><span class=cl><span class=ge>**</span>* (2) HOLDS THE LOCK(S):
</span></span><span class=line><span class=cl>RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 lock_mode X locks rec but not gap
</span></span><span class=line><span class=cl>Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000005; asc         ;; -&gt; index，用 16 進位表示，這邊是指 id: 5
</span></span><span class=line><span class=cl> 1: len 6; hex 00000000257c; asc     %|;;
</span></span><span class=line><span class=cl> 2: len 7; hex 23000001c017d1; asc #      ;;
</span></span><span class=line><span class=cl> 3: len 1; hex 62; asc b;;
</span></span><span class=line><span class=cl> 4: len 4; hex 80000010; asc     ;;
</span></span><span class=line><span class=cl> 5: SQL NULL;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=ge>**</span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
</span></span><span class=line><span class=cl>RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 <span class=sb>`lock_mode X locks rec but not gap waiting`</span>  
</span></span><span class=line><span class=cl>Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex 8000000000000001; asc         ;;     
</span></span><span class=line><span class=cl> 1: len 6; hex 00000000257d; asc     %};;
</span></span><span class=line><span class=cl> 2: len 7; hex 22000001cc02e5; asc &#34;      ;;
</span></span><span class=line><span class=cl> 3: len 1; hex 61; asc a;;
</span></span><span class=line><span class=cl> 4: len 4; hex 8000000f; asc     ;;
</span></span><span class=line><span class=cl> 5: SQL NULL;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=ge>**</span>* WE ROLL BACK TRANSACTION (2)
</span></span><span class=line><span class=cl>------------
</span></span></code></pre></td></tr></table></div></div><p>這部分內容參考 <a class=link href=https://juejin.cn/post/6844903943516979213 target=_blank rel=noopener>MySQL死锁问题如何分析</a>，重點看這一段</p><blockquote><p>RECORD LOCKS space id 275 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9596 lock_mode X locks rec but not gap waiting <code>專指 row lock</code><br>Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
0: len 8; hex 8000000000000001; asc ;; <code>-> index，用 16 進位表示，這邊是指 id: 1</code></p></blockquote><p>，我們可以從 log 中看出操作 / 手上的 lock / 等待的 lock / <code>Lock 在哪一個 row</code></p><h3 id=2-取得-lock-的順序性>2. 取得 Lock 的順序性</h3><p>如果查詢的條件命中多筆，那 Lock 會怎麼取得呢？ 接著看以下案例
<img src=/post/2022/img/0425/02.png loading=lazy></p><p>根據 <a class=link href=https://dev.mysql.com/doc/refman/5.7/en/update.html target=_blank rel=noopener>MySQL 文件</a>，會根據 Order By 的指定條件與 Index 本身順序性一行一行鎖起來</p><blockquote><p>If an UPDATE statement includes an ORDER BY clause, the rows <code>are updated in the order specified by the clause</code>. This can be useful in certain situations that might otherwise result in an error. Suppose that a table t contains a column id that has a unique index. The following statement could fail with a duplicate-key error, depending on the order in which rows are updated</p></blockquote><p>從 Deadlock Log 可以清楚看到 id 2 / id 5 被互相鎖住</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
</span></span><span class=line><span class=cl>RECORD LOCKS space id 278 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9676 lock_mode X waiting
</span></span><span class=line><span class=cl>Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex <span class=sb>`8000000000000002`</span>; asc         ;;
</span></span><span class=line><span class=cl>------
</span></span><span class=line><span class=cl><span class=ge>**</span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
</span></span><span class=line><span class=cl>RECORD LOCKS space id 278 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9675 lock_mode X waiting  
</span></span><span class=line><span class=cl>Record lock, heap no 3 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex <span class=sb>`8000000000000005`</span>; asc         ;;
</span></span></code></pre></td></tr></table></div></div><h4 id=21-建立-index-時決定順序>2.1 建立 Index 時決定順序</h4><p>當<a class=link href=https://dev.mysql.com/doc/refman/5.7/en/create-index.html target=_blank rel=noopener>建立 MySQL Index</a> 也可以指定順序，但需要注意 MySQL 5.7 會忽視 (全部都是 asc) 只有在 MySQL 8.0 以上才支援，所以以下案例只發生在 MySQL 8.0</p><p>我們可以透過 <code>USE INDEX()</code> 指定執行時的 Index
<img src=/post/2022/img/0425/02_01.png loading=lazy></p><blockquote><p>(5.7 文件) A key_part specification can end with ASC or DESC. These keywords are permitted for future extensions for specifying ascending or descending index value storage. Currently, they <code>are parsed but ignored</code>; index values are always stored in ascending order.</p></blockquote><h4 id=22-恰巧兩個-index-順序相仿>2.2 恰巧兩個 Index 順序相仿</h4><p>2.1 案例中我們很刻意讓 Index 同一個欄位欄位但順序剛好相反，但如果是兩個不同 Index 而資料寫入時讓順序恰好相反呢？
在建立資料時，id 跟 name 的順序剛好相反，也就是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>id1 &gt; id2 <span class=err>&amp;&amp;</span> name1 <span class=p>&lt;</span> <span class=nt>name2</span><span class=err>，</span><span class=na>例如</span> <span class=err>(</span><span class=na>1</span><span class=err>,</span> <span class=err>&#34;</span><span class=na>zz</span><span class=err>&#34;)</span> <span class=err>(</span><span class=na>2</span><span class=err>,</span> <span class=err>&#34;</span><span class=na>zx</span><span class=err>&#34;)</span>
</span></span></code></pre></td></tr></table></div></div><p>這樣也會發生 Deadlock!</p><p><img src=/post/2022/img/0425/02_02.png loading=lazy></p><h3 id=3-查詢沒有命中--gap-lock>3. 查詢沒有命中 : Gap Lock</h3><p>如果查詢沒有命中，此時 MySQL 在 RR 情況下會取得 Gap Lock，所謂的 Gap 是在已存在欄位之間的縫隙，為了避免幻讀 MySQL 會鎖住 Gap 不讓其他 Transaction 插入資料</p><p>這邊特別介紹兩個鎖定區間的 Lock，分別是 Gap Lock / Insert Intention Lock</p><ol><li>Insert Intention Lock 故名思義是是插入前會鎖定該區間</li><li>這兩種 Lock 特別在於不會排擠自己人，例如 <code>Gap Lock 不會阻擋 Gap Lock</code> / <code>Insert Intention Lock 不會阻擋 Insert intention Lock</code>，但是 <code>Insert Intention Lock 跟 Gap Lock 互斥</code>，原因是區間可能很大，為了提升性能，在同一個區間可以同時插入新資料，如果真的有違反 Unique Key 則會有原本的重複性檢查阻擋，Update 也是</li></ol><p>有一個場景是「我們希望更新某一筆資料，發現資料不在則寫入」，如以下範例則會造成 Deadlock
<img src=/post/2022/img/0425/03.png loading=lazy></p><p>因為 id 6 / 10 在 update 時都取得了 Gap Lock，接著要 Insert 取得 Insert Intention Lock 卻因為雙方都還握有 Gap Lock 而無法寫入，讓我們看具體的 Deadlock 細節</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
</span></span><span class=line><span class=cl>RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9700 <span class=sb>`lock_mode X insert intention waiting`</span>
</span></span><span class=line><span class=cl>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex 73757072656d756d; asc <span class=sb>`supremum`</span>;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=ge>**</span>* (2) HOLDS THE LOCK(S):
</span></span><span class=line><span class=cl>RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9699 <span class=sb>`lock_mode X`</span>
</span></span><span class=line><span class=cl>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex 73757072656d756d; asc <span class=sb>`supremum`</span>;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=ge>**</span>* (2) WAITING FOR THIS LOCK TO BE GRANTED:
</span></span><span class=line><span class=cl>RECORD LOCKS space id 279 page no 3 n bits 72 index PRIMARY of table test.teachers trx id 9699 lock_mode X insert intention waiting
</span></span><span class=line><span class=cl>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
</span></span><span class=line><span class=cl> 0: len 8; hex 73757072656d756d; asc supremum;;
</span></span></code></pre></td></tr></table></div></div><p>可以看到雙方都在等 <code>lock_mode X insert intention waiting</code>，指定的 row 是 <code>supermum</code> 這是代表最後一個區間，區間大致長以下這般</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>(negative infinity, 第一筆]
</span></span><span class=line><span class=cl>(第一筆, 第二筆]
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl>(最後一筆, positive infinity)
</span></span></code></pre></td></tr></table></div></div><p>所以同樣的 query 只是原始資料改變落在不同區間，就不會有 Deadlock 如以下
<img src=/post/2022/img/0425/03_01.png loading=lazy></p><h3 id=4-範圍查詢鎖定找過的每筆資料即使條件不合>4. 範圍查詢：鎖定找過的每筆資料即使條件不合</h3><p>接下來看一個 RR 蠻嚇人的一個特性，參考文件 <a class=link href=https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html target=_blank rel=noopener>15.7.2.1 Transaction Isolation Levels</a></p><blockquote><p>&ldquo;When using the default REPEATABLE READ isolation level, the first UPDATE acquires an x-lock on each row that it reads and <code>does not release any of them</code></p></blockquote><p>也就是說 where condition 假使是範圍搜尋，RR 會把搜尋到的範圍全部鎖死，直到 transaction 結束!</p><p>讓我們看以下案例
<img src=/post/2022/img/0425/04.png loading=lazy></p><p>Update 的條件沒有命中但是<code>全部都被 Lock</code>，要 update / insert 都不行，相對的</p><blockquote><p>RC 在檢查不符合條件就會 release，在做大規模的 Update / Delete 記得要用 RC 會比較好</p></blockquote><h2 id=non-unique-index>Non Unique Index</h2><p>上面的範例都是 Clustered Index，MySQL 支援 Secondary Index，其中 Unique Secondary Index 與 Clustered Index 行為類似，就不另外贅述，但是 Non Unique Index 要稍微留意</p><h3 id=1-查詢命中依然會-gap-lock>1. 查詢命中：依然會 Gap Lock</h3><p>在一開始的範例，如果 Clustered Index 查詢有命中只會鎖那一行 (ex. update id = 1)，但如果 Non Unique Index 即使完全命中，也會連同 Gap 一起鎖起來 (Next Key Lock)</p><p><img src=/post/2022/img/0425/05.png loading=lazy>
這邊 Lock 比較多，需注意 Secondary Index 會被鎖之外，對應的 Clustered Index 也會被鎖，這邊 age 鎖定 10 以及前面的區間，所以要插入 age: 9 就會失敗；運用上面的技巧，age 切換到不同區間就可以成功插入</p><h2 id=foreign-key會有-share-lock>Foreign Key：會有 Share Lock</h2><blockquote><p>If a FOREIGN KEY constraint is defined on a table, any insert, update, or delete that requires the constraint condition to be checked sets shared record-level locks</p></blockquote><p>更新欄位時 Foreign Key 也會被鎖住，之前有紀錄就不贅述 <a class=link href=https://yuanchieh.page/posts/2020/2020-12-26-mysql-deadlock-%E5%95%8F%E9%A1%8C%E6%8E%92%E6%9F%A5%E8%88%87%E8%99%95%E7%90%86/ target=_blank rel=noopener>MySQL Deadlock 問題排查與處理</a></p><h2 id=總結與建議>總結與建議</h2><p>幾點建議</p><ol><li>增加 Index 要仔細評估，Secondary Index 會造成寫入效能下降，體現於 lock 的使用</li><li>如果是用 ORM，記得檢查 Query</li><li>如果需要用 Secondary Index 改變欄位，建議可以用批次 (RoR 就是 find_in_batch)</li><li>或是先篩選出 Primary Key (預設 select 不會有 lock)，再使用 Primary Key 當作修改條件避免 Gap Lock</li><li><code>沒事就用 Read Committed</code></li></ol><h2 id=進階為什麼不要預設-read-committed->進階：為什麼不要預設 Read Committed ?</h2><p>既然 Repeatable Read 會有這麼多效能疑慮，更新時連 where 條件不符合的行都會鎖、還會有不預期的 Gap Lock，那為什麼預設不要改成 Read Committed ?</p><p>在 PostgreSQL 確實如此，<a class=link href=https://www.postgresql.org/docs/7.2/xact-read-committed.html target=_blank rel=noopener>PQ 9.3. Read Committed Isolation Level</a>提到</p><blockquote><p>The partial transaction isolation provided by Read Committed level is adequate for many applications, and this level is fast and simple to use</p></blockquote><p>我在查閱 MySQL 相關資料，也有查到 Percona 一篇文章提及 MySQL 預設應該要改成 Read Committed 比較好 <a class=link href=https://www.percona.com/blog/2015/01/14/mysql-performance-implications-of-innodb-isolation-modes/ target=_blank rel=noopener>MySQL performance implications of InnoDB isolation modes</a></p><blockquote><p>In general I think good practice is to use READ COMITTED isolation mode as default and change to REPEATABLE READ for those applications or transactions which require it.</p></blockquote><p>那 MySQL 官方怎麼說，我找到一篇官方的 blog <a class=link href=https://dev.mysql.com/blog-archive/performance-impact-of-innodb-transaction-isolation-modes-in-mysql-5-7/ target=_blank rel=noopener>Performance Impact of InnoDB Transaction Isolation Modes in MySQL 5.7</a> 建議到</p><blockquote><ul><li>For short running queries and transactions, use the default level of REPEATABLE-READ.</li></ul></blockquote><ul><li>For long running queries and transactions, use the level of READ-COMMITTED</li></ul><p>裡面有另一篇文做了 Benchmark 非常有趣 <a class=link href=http://dimitrik.free.fr/blog/archives/2015/02/mysql-performance-impact-of-innodb-transaction-isolation-modes-in-mysql-57.html target=_blank rel=noopener>MySQL Performance : Impact of InnoDB Transaction Isolation Modes in MySQL 5.7</a>，從 MySQL 內部的 Lock 數量與操做 QPS 衡量不同 isolation level，我本來以為 Read Committed 在增刪查改會碾壓 Repeatable Read，但發現盡然沒有，反而因為 Read Committed 在每次 Read 都會產生新的 MVCC 版本而有更多的內部 Lock，非常有趣</p><p>所以總結官方部落格建議，預設還是保留 RR 普遍效能反而更好，只有在長時間的 Job 再改成 RC 即可</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/2023/2023-05-05-mongodb-clustered-collection-%E8%88%87-benchmark-%E5%AF%A6%E9%A9%97/><div class=article-details><h2 class=article-title>MongoDB Clustered Collection 與 Benchmark 實驗</h2></div></a></article><article><a href=/posts/2022/2022-04-02-ddia03-%E8%B3%87%E6%96%99%E5%BA%AB%E5%84%B2%E5%AD%98%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6/><div class=article-details><h2 class=article-title>【DDIA】03 - 資料庫儲存原理研究</h2></div></a></article><article><a href=/posts/2021/2021-11-14-effective-sql%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB/><div class=article-details><h2 class=article-title>《Effective SQL》讀後分享</h2></div></a></article><article><a href=/posts/2021/2021-10-10-mysql-replication-%E8%88%87-rds/><div class=article-details><h2 class=article-title>MySQL Replication 與 RDS</h2></div></a></article><article><a href=/posts/2021/2021-07-02-aws-aurora-%E6%9E%B6%E6%A7%8B%E7%A0%94%E7%A9%B6%E4%BB%A5%E5%8F%8A%E8%88%87%E8%87%AA%E9%A7%95-mysql-%E7%9A%84%E5%B7%AE%E7%95%B0/><div class=article-details><h2 class=article-title>AWS Aurora 架構研究以及與自駕 MySQL 的差異</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//yuanchieh.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Yuanchieh</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.17.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>