---
title: 'UUID åŸç†èˆ‡å¯¦ä½œåˆ†æ - è©²å¦‚ä½•æŒ‘é¸é©åˆçš„ UUID ç‰ˆæœ¬'
description: æ–¯æ–¯æœ‰å¥½å¹¾ç¨®ï¼ŒUUID ç¸½å…±æœ‰ v1~v5ï¼Œæœ¬ç¯‡å°‡å¾ RFC æ–‡ä»¶é–‹å§‹ï¼Œä¸¦ä»‹ç´¹ js ä¸­ uuid çš„å¯¦ä½œæ–¹å¼ï¼Œå¹«åŠ©å¤§å®¶æ‰¾åˆ°é©åˆçš„ UUID æ–¹æ¡ˆ
date: '2020-12-01T08:21:40.869Z'
categories: ['Algorithm']
---

UUID æ˜¯ä¸€å€‹è¢«å¤§é‡ä½¿ç”¨çš„æ¼”ç®—æ³•ï¼Œåˆ†æ•£å¼åœ°ç”¢ç”Ÿå¤§é‡`ä¸é‡è¤‡ä¸”å›ºå®šç‚º 128 bit`çš„ IDï¼Œåˆ†æ•£å¼æ˜¯æŒ‡èªªå¤šå°æ©Ÿå™¨æ¯ç§’åŒæ™‚ç”¢ç”Ÿå¤šç­† UUIDï¼Œæœ‰æ¥µå¤§æ¦‚ç‡é€™äº› UUID éƒ½ä¸æœƒç™¼ç”Ÿé‡è¤‡ï¼Œä¸éœ€è¦æœ‰ä¸€å°æ©Ÿå™¨å±…ä¸­è² è²¬ ID çš„ç®¡æ§èˆ‡ç™¼æ”¾ï¼Œåä¾‹åƒæ˜¯ MySQL è³‡æ–™åº«ä¸­çš„ auto increment id  

å…ˆæé‡é»ï¼Œå¦‚ä½•é¸æ“‡ UUID v1 ~ v5ï¼Œåƒè€ƒ [Which UUID version to use?](https://stackoverflow.com/questions/20342058/which-uuid-version-to-use)
1. **v4**: å®Œå…¨éš¨æ©Ÿï¼Œæ²’æœ‰ç‰¹æ®Šéœ€æ±‚é¸é€™å€‹ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ `77%` ç”¨æˆ¶é¸æ“‡é€™å€‹  
2. **v1**: çµ„æˆåŒ…å« timestamp èˆ‡æ©Ÿå™¨è­˜åˆ¥ç¢¼(MAC Address)ï¼Œå¦‚æœéœ€è¦è­˜åˆ¥ç”±å“ªä¸€å°æ©Ÿå™¨åœ¨ä»€éº¼æ™‚é–“é»ç”¢ç”Ÿå¯ä»¥é¸é€™å€‹ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ `21%` ç”¨æˆ¶é¸æ“‡é€™å€‹    
3. **v5 & v3**: å¯ä»¥æŒ‡å®š Namespace èˆ‡ Nameï¼Œç›¸åŒçš„ Namespace èˆ‡ Name æœƒç”¢ç”Ÿç›¸åŒçš„ UUIDï¼Œv3 é›·åŒ v5ï¼Œå·®åˆ¥åœ¨æ–¼ v5 æœƒæ¡ç”¨ SHA1 ç•¶ä½œ Hash function è€Œ v3 æ¡ç”¨ MD5ï¼Œé™¤äº†ç›¸å®¹æ€§ç­‰è€ƒé‡ï¼Œå¦å‰‡è«‹å„ªå…ˆæ¡ç”¨ v5ï¼Œæ ¹æ“š uuid.js çµ±è¨ˆæœ‰ `1%` ç”¨æˆ¶é¸æ“‡é€™å€‹  
4. **v2**: ä¸æ¡ç”¨ï¼Œé€£ RFC æ–‡ä»¶ä¹Ÿåªæœ‰å¸¶åˆ°å®šç¾©ï¼Œæ²’æœ‰å¯¦ä½œè¦ç¯„  

éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ [uuid.js](https://github.com/uuidjs/uuid) çš„ v1ï¼Œuuid å¯¦ä½œæ˜¯æ²’æœ‰æ¡ç”¨ MAC Addressï¼Œæ‰€ä»¥å¦‚æœæœ‰è­˜åˆ¥åŒä¸€å°æ©Ÿå™¨ç”¢ç”Ÿçš„ uuid çš„éœ€æ±‚ï¼Œéœ€è¦è‡ªå·±å¦å¤–å¯¦ä½œï¼Œå¾Œé¢æœ‰æ›´è©³ç›¡çš„è£œå……  

ä»¥ä¸‹å°‡æ‘˜è¦ [RFC 4122 - A Universally Unique IDentifier (UUID) URN Namespace ](https://tools.ietf.org/html/rfc4122)ï¼Œä¸¦æ¯”å°æ¯é€±æœ‰å°‡è¿‘å››ç™¾è¬ä¸‹è¼‰çš„ uuid.js å¯¦ä½œï¼Œæœ‰è©¢å•ä½œè€…ä¸€äº›ç´°ç¯€ï¼Œä»–ä¹Ÿéå¸¸ç†±å¿ƒè£œå……å¾ˆå¤šæœ‰æ£’çš„è³‡æ–™ï¼Œæœƒä¸€ä¸¦æ•´ç†åˆ†äº«

## RFC 4122  
UUID å…±æœ‰ 128 bitsï¼Œä»¥ä¸‹æ˜¯ v1 å¯¦ä½œè¦ç¯„
### 4.1.2.  Layout and Byte Order
![](/post/img/20201201/uuid.png)  
ä»¥ä¸‹å°‡ä»‹ç´¹æ¯å€‹æ¬„ä½çš„çµ„æˆ  

### 4.1.3.  Version
UUID ç‰ˆæœ¬å¤¾åœ¨ time_hi_and_version æœ€é«˜æ•ˆä½å…ƒ(most significant)ä¸­ 4~7 bitï¼Œæ‰€ä»¥å¾ UUID string å°±èƒ½çœ‹å‡ºç‰ˆè™Ÿ  

### 4.1.4.  Timestamp
Timestamp ç¸½å…±æ˜¯ 60 bitsï¼Œå°æ–¼ UUID v1 ä¾†èªªæ˜¯ UTC æ™‚é–“ä¸”è‡ª 1582/10/15 00:00:00 (the date of Gregorian reform to the Christian calendar) é–‹å§‹è¨ˆç®—ï¼Œå¦‚æœæ©Ÿå™¨æ²’æœ‰ UTC æ™‚é–“ï¼Œå¯ä»¥æ¡ç”¨ local timeï¼Œä½†æ˜¯è¦ç¢ºä¿ local time æ˜¯ç©©å®šçš„  

### 4.1.5.  Clock Sequence
å¦‚æœç³»çµ±æ™‚é–“ç™¼ç”Ÿå€’è½‰ï¼Œæˆ–æ˜¯ Node ID ç™¼ç”Ÿæ”¹è®Šï¼Œå‰‡æœƒå¢åŠ ç¢°æ’çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥é€é Clock Sequence ä¾†ç´€éŒ„ï¼Œå¦‚æœç™¼ç¾ç”¢ç”Ÿéçš„ UUID æ¡ç”¨çš„ Timestamp æ¯”ç•¶ä¸‹çš„æ™‚é–“é‚„è¦æ™šæ™‚ (æ„å³ Clock æ™‚é–“è¢«å€’è½‰)ï¼Œå‰‡ clock sequence éå¢ï¼Œåˆå§‹åŒ–å‰‡éš¨æ©Ÿç”¢ç”Ÿ  

å¦å¤–å¦‚æœ Node ID ç™¼ç”Ÿæ”¹è®Šï¼Œé‚£æœ€å¥½ä¹Ÿå°‡ clock sequence éš¨æ©Ÿé‡ç½®ï¼Œé™ä½ç¢°æ’çš„é¢¨éšª  

éœ€æ³¨æ„ clock sequence çš„è¨­å®šæœ€å¥½æ˜¯åœ¨ç³»çµ±å•Ÿå‹•å¾Œè¨­å®šä¸€æ¬¡å°±ä¸è¦å†æ”¹è®Šï¼Œé™ä½è·¨ç³»çµ±ç”¢ç”Ÿç¢°æ’çš„é¢¨éšª

### 4.1.6.  Node
Node ID æ¡ç”¨ `IEEE 802 MAC address`ï¼Œå¦‚æœæœ‰å¤šå€‹ MAC Address ä»»ä¸€æŒ‘ä¸€å€‹æœ‰ç”¨çš„å³å¯ï¼Œå¦‚æœæ²’æœ‰å‰‡éš¨æ©Ÿç”¢ç”Ÿ

ä»¥ä¸Šæ˜¯ v1 çš„æ¬„ä½æ„ç¾©ï¼Œv3ã€v5 å‰‡æ˜¯æŠŠ Name åŠ ä¸Š Namespace å–é›œæ¹Šï¼Œæ¥è‘—åˆ†é…è‡³ä¸Šè¿°çš„æ¬„ä½ä¸­ï¼Œv4 å‰‡å…¨éƒ¨éš¨æ©Ÿç”¢ç”Ÿ

### 4.2.1.  Basic Algorithm
æ¥è‘—çœ‹æœ€åŸºæœ¬çš„æ¼”ç®—æ³•å¯¦ä½œæµç¨‹
1. å–å¾—ç³»çµ±ç´šåˆ¥çš„å…¨åŸŸé–
2. è®€å–ç³»çµ±è¨­å®šæª”ï¼ŒåŒ…å« clock_seq / node id / timestamp
3. è¨ˆç®—å‡º timestamp
4. å–å¾— node id
5. å¦‚æœä¿å­˜ node id èˆ‡è®€å–çš„ node id ä¸åŒï¼Œé‡æ–°è¨­å®š clock_seq
6. ç•¶å‰ timestamp å°æ–¼ä¿å­˜çš„ timestampï¼Œclock_seq + 1
7. å°‡ç›®å‰è¨ˆç®—çš„å€¼ä¿å­˜å›å»
8. é‡‹æ”¾é–
9. å°‡ç›®å‰çš„ timestamp / clock_seq / node id çµ„åˆå‡º uuid

å¦‚æœè¦é«˜é »ç‡è£½é€  uuidï¼Œæœƒé‡åˆ°ä»¥ä¸‹å¹¾å€‹æ•ˆèƒ½è²§é ¸èˆ‡å°æ‡‰è§£æ³•
1. `æ¯æ¬¡å­˜ç³»çµ±è®€å–è³‡æ–™å¾ˆæ²’æ•ˆç‡`:  
   åƒ…éœ€è¦å†ç³»çµ±å•Ÿå‹•æ™‚è®€å–ä¸€æ¬¡é€² memory å³å¯ï¼Œå‡è¨­ç³»çµ±æ²’æœ‰ç©©å®šå„²å­˜ç©ºé–“ï¼Œå‰‡æ¯æ¬¡éƒ½è¦éš¨æ©Ÿç”¢ç”Ÿ clock_seqï¼Œé€™æœƒå°è‡´ç¢°æ’æ©Ÿç‡å¢åŠ ï¼Œæ‡‰è©²è¦ç›¡é‡é¿å…ï¼›å¦‚æœç¢ºå®š node id éƒ½ä¸æœƒè®Šï¼Œä¹Ÿå¯ä»¥ä¸ç”¨ä¿å­˜ç›´æ¥è¿”å›å³å¯
2. `system clock ç²’åº¦ä¸è¦‹å¾—æœ‰åˆ° 100-nanoseconds`:  
   System Clock Resolutionï¼šå¦‚æœç”¢ç”Ÿé »æ¬¡ä¸é«˜ï¼Œå‰‡ç›´æ¥å°‡ç³»çµ±æ™‚é–“æ”¾å¤§åˆ° 100-nano çš„ç²’åº¦å³å¯ï¼Œä½†å¦‚æœç³»çµ±å–®ä¸€æ™‚é–“ç”¢ç”Ÿéå¤š uuidï¼Œå¯¦ä½œå¿…é ˆè¿”å›éŒ¯èª¤ï¼Œæˆ–æ˜¯æš«åœç”¢ç”Ÿï¼Œç›´åˆ°ç³»çµ±æ™‚é–“æ­£å¸¸ï¼Œå¦‚æœè¦æé«˜ç²’åº¦ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨åŒä¸€å€‹ç³»çµ±æ™‚é–“å…§ç´¯è¨ˆç”¢ç”Ÿçš„ uuid å€‹æ•¸ï¼Œ
3. `æ¯æ¬¡è¦å›å¯«ç³»çµ±è³‡æ–™å¾ˆæ²’æ•ˆç‡`  
   åªéœ€è¦å®šæ™‚æ›´æ–°å„²å­˜è³‡æ–™å³å¯ï¼Œå°‡ timestamp è¨­å®šåœ¨æ¯”è‡³ä»Šç”¢ç”Ÿçš„ UUID ä½¿ç”¨çš„ timestamp å¤§ä¸€é»ï¼Œä½†åˆä¸è¦å¤§åˆ°è¶…é reboot æ™‚çš„æ‰€éœ€è¦çš„å•Ÿå‹•æ™‚é–“ï¼Œç›®çš„åœ¨æ–¼é™ä½ clock sequence é‡ç½®çš„æ©Ÿæœƒï¼Œåœ¨ä¸‹æ–¹çš„å»ºè­°å¯¦ä½œä¸­æ˜¯æ¯ 10 ç§’å¯«å…¥ä¸€æ¬¡
```c  
   if (timestamp >= next_save) {
      fp = fopen("state", "wb");
      fwrite(&st, sizeof st, 1, fp);
      fclose(fp);
      /* schedule next save for 10 seconds from now */
      next_save = timestamp + (10 * 10 * 1000 * 1000);
  }
```
4. `è·¨é€²ç¨‹åˆ†äº«ç‹€æ…‹å¾ˆæ²’æ•ˆç‡`  
   å¦‚æœè·¨é€²ç¨‹å…±äº«ç‹€æ…‹å¾ˆè€—è³‡æºï¼Œå¯ä»¥æ¯å€‹é€²ç¨‹åˆ‡å‰²ä¸€å¡Šæ™‚é–“å€æ®µå€‹åˆ¥ç”¢ç”Ÿ uuid ï¼Œç›´åˆ°æ™‚é–“å€æ®µç”¨å®Œæ‰å»è¦æ–°çš„  

### 4.3.  Algorithm for Creating a Name-Based UUID
v3 è·Ÿ v5 ä¸»è¦æ˜¯åœ¨æŸä¸€ç‰¹å®šçš„ Namespace ä¸‹é‡å° Name ç”¢ç”Ÿå°æ‡‰çš„ UUIDï¼Œæœ‰ä»¥ä¸‹ç‰¹æ€§  
1. ç›¸åŒçš„ namespace ç›¸åŒçš„ nameï¼Œä¸åŒç³»çµ±æ™‚é–“ä¸€æ¨£æœ‰ç›¸åŒçš„ uuid
2. ç›¸åŒ namespace ä¸‹ä¸åŒ nameï¼Œuuid ä¸åŒ
3. ç›¸åŒ name ä¸åŒ namespaceï¼Œuuid ä¸åŒ
4. å¦‚æœå…©å€‹ uuid ç›¸åŒï¼Œå‰‡ä»£è¡¨ namespace / name ç›¸åŒ  

UUID æ¬„ä½å‰‡æ˜¯é€é Name + Namespace é›œæ¹Šå¾Œçš„å€¼å»æ´¾ç™¼  

### 4.5.  Node IDs that Do Not Identify the Host
å¦‚æœ MAC Address ä¸èƒ½ä½¿ç”¨ï¼Œæœ‰å¹¾ç¨®åšæ³•èƒ½ä¿è­‰ Node ID çš„ç¨ä¸€æ€§
1. å»è·Ÿ IEEE è²è«‹ç¨ç«‹å€æ®µçš„ä½å€ï¼Œåœ¨æ–‡ä»¶ç·¨å¯«æ™‚æœŸåƒ¹æ ¼æ˜¯ US$550
2. ä½¿ç”¨å¯†ç¢¼å­¸å¼·åº¦çš„éš¨æ©Ÿç¢¼å–æœ€ä½ä½ 47 bitï¼Œæœ€é«˜ bit è¨­å®šç‚º 1ï¼Œä¸»è¦æ˜¯é¿é–‹ IEEE ä¸­ MAC Address çš„å€æ®µ  
   > å¸¸è¦‹åšæ³•æ˜¯åœ¨ buffer ä¸­éš¨æ©Ÿç´¯ç©ä¸€æ®µè³‡æ–™ï¼Œæ¥è‘—ç”¨ SHA1 æˆ– MD5 å– 48 bitsï¼Œç„¶å¾ŒæŠŠæœ€é«˜ bit è¨­å®šç‚º 1

### 6.  Security Considerations
UUID ä¸¦ä¸ä¿è­‰éš¨æ©Ÿæ€§ï¼Œæ‰€ä»¥ä¸æœƒå¾ˆé›£çŒœï¼Œæ‰€ä»¥ä¸èƒ½æ‹¿ä¾†åšè·Ÿå®‰å…¨æ€§æœ‰é—œçš„æ¥­å‹™
> Do not assume that UUIDs are hard to guess  

ä»¥ä¸Šå¤§æ¦‚æŒ‘å€‹é‡é»å¸¶é

## uuid.js å¯¦ä½œæ‹†è§£
ä»¥ä¸‹å°‡é–±è®€[uuid.js github repo](https://github.com/uuidjs/uuid)çš„åŸå§‹ç¢¼ï¼Œåœ¨é–‹å§‹çœ‹ v1~v5 çš„å¯¦ä½œå‰ï¼Œå…ˆçœ‹ä¸€å€‹ç”¨æ–¼ç”¢ç”Ÿéš¨æ©Ÿæ•¸çš„é‡è¦å‡½å¼  [rng.js](https://github.com/uuidjs/uuid/blob/master/src/rng.js)
```js
import crypto from 'crypto';
const rnds8Pool = new Uint8Array(256); // # of random values to pre-allocate
let poolPtr = rnds8Pool.length;
export default function rng() {
  if (poolPtr > rnds8Pool.length - 16) {
    crypto.randomFillSync(rnds8Pool);
    poolPtr = 0;
  }
  return rnds8Pool.slice(poolPtr, (poolPtr += 16));
}
```
ç¨‹å¼ç¢¼å¾ˆçŸ­ï¼Œä¸»è¦å°±æ˜¯ç”¢ç”Ÿä¸€å€‹ rnds8Pool é™£åˆ—ï¼Œéš¨æ©Ÿå¡å…¥æ•¸å€¼ï¼Œæœ€å¾Œæ¯æ¬¡å›å‚³ 16 bitï¼Œå¦‚æœé€™ä¸€æ®µ rnds8Pool éƒ½å›å‚³äº†ï¼Œå°±åœ¨ä¸€æ¬¡ç”¢ç”Ÿæ–°çš„éš¨æ©Ÿäº‚æ•¸

é€™å¯ä»¥ä¿è­‰ç”¢ç”Ÿ `Generates cryptographically strong pseudo-random data.`ï¼Œä¾†è‡ª Nodejs å®˜æ–¹æ–‡ä»¶çš„ä¿è­‰ï¼Œä¹Ÿæ˜¯ uuid ä¸æœƒæœ‰é«˜ç¢°æ’æ©Ÿç‡çš„ä¿è­‰ï¼Œåˆ‡è¨˜ Math.random ä¸è¶³å¤ éš¨æ©Ÿï¼Œæ‹¿ä¾†ä½¿ç”¨å•é¡Œæœƒå¾ˆå¤š

### UUID v1 å¯¦ä½œ
ä»¥ä¸‹æŒ‘é‡é»èªªï¼Œä¸å¾—ä¸èªªä½œè€…çš„ç¨‹å¼ç¢¼ä»¥åŠè¨»è§£å¯«å¾—å¾ˆä¹¾æ·¨ï¼Œç›´æ¥æ¨™æ˜å¯¦ä½œå°æ‡‰çš„ RFC æ®µè½  
```js
const seedBytes = options.random || (options.rng || rng)();
```
å…ˆç”¢ç”Ÿéš¨æ©Ÿæ•¸å‚™ç”¨ï¼Œåœ¨å‰é¢æ–‡ä»¶ä»‹ç´¹ä¸­ï¼Œæœ‰ç”¨åˆ°éš¨æ©Ÿç”¢ç”Ÿçš„éƒ½æœƒå¾ seedBytes ä¸­æå–

```js
if (node == null) {
  // Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)
  node = _nodeId = [
    seedBytes[0] | 0x01,
    seedBytes[1],
    seedBytes[2],
    seedBytes[3],
    seedBytes[4],
    seedBytes[5],
  ];
}
```
é€™è£¡å¯ä»¥çœ‹åˆ°ï¼Œå¯¦ä½œä¸­çš„ `node_idæ˜¯æ¯æ¬¡å•Ÿå‹•æ™‚éš¨æ©Ÿç”¢ç”Ÿ`ï¼Œé€™ç¬¦åˆæ–‡ä»¶ 4.1.6ï¼Œæ²’æœ‰æ¡ç”¨ MAC Address è‡ªå·±äº‚æ•¸ç”¢ç”Ÿä¹Ÿå¯ä»¥ï¼›  
åŒæ™‚é€™ä¸€æ®µæˆ‘æœ‰ç‰¹åˆ¥ç•™ä¸€å€‹ Issue è©¢å•ä½œè€…ï¼Œç‚ºä»€éº¼ä¸ç…§æ–‡ä»¶è¦ç¯„å»æ‹¿æ©Ÿå™¨çš„ MAC Addressï¼Œä»–å›ç­”åˆ°`åŸºæ–¼éš±ç§å•é¡Œ`ï¼Œè€Œä¸”å¦‚æœ Node ID è·Ÿ Clock Seq æ¯æ¬¡éƒ½éš¨æ©Ÿç”¢ç”Ÿä¹Ÿæ˜¯ç¬¦åˆæ–‡ä»¶è¦ç¯„çš„  
> I believe that this comes close to the idea of the spec while avoiding the privacy problems that come with trying to derive a stable node ID from hardware.

```js
if (clockseq == null) {
  // Per 4.2.2, randomize (14 bit) clockseq
  clockseq = _clockseq = ((seedBytes[6] << 8) | seedBytes[7]) & 0x3fff;
}
```
æ²’æœ‰ clockseq å°±äº‚æ•¸ç”¢ç”Ÿ

```js
// Per 4.2.1.2 Throw error if too many uuids are requested
if (nsecs >= 10000) {
  throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");
}
```
å¦‚æœå¯¦ä½œè€…ç™¼ç¾çŸ­æ™‚é–“å…§æœ‰å¤ªå¤§é‡çš„ uuid ç”¢ç”Ÿï¼Œéœ€è¦æ‹‹å‡ºéŒ¯èª¤æˆ–æ˜¯æš«åœ uuid ç”Ÿæˆé¿å…ç¢°æ’  

```js
// `time_low`
const tl = ((msecs & 0xfffffff) * 10000 + nsecs) % 0x100000000;
b[i++] = (tl >>> 24) & 0xff;
b[i++] = (tl >>> 16) & 0xff;
b[i++] = (tl >>> 8) & 0xff;
b[i++] = tl & 0xff;
// `time_mid`
const tmh = ((msecs / 0x100000000) * 10000) & 0xfffffff;
b[i++] = (tmh >>> 8) & 0xff;
b[i++] = tmh & 0xff;
// `time_high_and_version`
b[i++] = ((tmh >>> 24) & 0xf) | 0x10; // include version
b[i++] = (tmh >>> 16) & 0xff;
```
ç”¢ç”Ÿ time ç›¸é—œæ¬„ä½  

v4 å¯¦ä½œç›¸ç•¶ç°¡å–®ï¼Œå°±æ˜¯ä¿ç•™ versionï¼Œå…¶é¤˜å¡éš¨æ©Ÿæ•¸ï¼›
v3,v5 å¤§åŒå°ç•°ï¼Œæ‰€ä»¥ä½œè€…å¯«äº†ä¸€å€‹ v35.js ï¼Œé‡é»å¤§æ¦‚å°±é€™éº¼å¹¾è¡Œ
```js
// Compute hash of namespace and value, Per 4.3
// Future: Use spread syntax when supported on all platforms, e.g. `bytes =
// hashfunc([...namespace, ... value])`
let bytes = new Uint8Array(16 + value.length);
bytes.set(namespace);
bytes.set(value, namespace.length);
bytes = hashfunc(bytes);
```
æŠŠ namespace è·Ÿ value åˆèµ·ä¾†ç„¶å¾Œ hash éï¼Œæ¥è‘—å°±æŒ‰ç…§æ–‡ä»¶å¡åˆ°å°æ‡‰çš„ä½ç½®  

## å¾Œè¨˜ï¼šä½œè€…æäº¤ proposal çµ¦ tc39 
ä½œè€…åœ¨ PR ä¸­æœ‰èªªåˆ°ä»–æäº†ä¸€å€‹ proposal çµ¦ tc39 [proposal-uuid](https://github.com/tc39/proposal-uuid#arent-v1-uuids-better-because-they-are-guaranteed-to-be-unique)ï¼Œç›®å‰é‚„åœ¨ stage 0ï¼Œå¸Œæœ›æŠŠ uuid ç”¢ç”Ÿè®Šæˆ js çš„è¦ç¯„ï¼Œä¸»è¦æ˜¯æœ‰å¤ªå¤šéŒ¯èª¤ä¸”ç²—å¿ƒçš„å¯¦ä½œï¼Œä¾‹å¦‚ä½¿ç”¨ Math.random ç­‰ï¼Œé€™é‚Šå¼•ç”¨ä¸€ç¯‡éå¸¸æ£’çš„æ–‡ç« æŒ‡å‡ºç‚ºä»€éº¼ Math.random ä¸å¥½ [TIFU by using Math.random()](https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d)ï¼Œä»¥ä¸‹å°‡æ‘˜éŒ„é‡é»

### TIFU by using Math.random() æ–‡ç« é‡é»æ‘˜è¦
> TIFU => Today I Fucked Up  

ä½œè€…å…¬å¸æ¡ç”¨ microserviceï¼Œä½†ä»–å€‘å¸Œæœ›å¯ä»¥è¿½è¹¤æ¯å€‹ request åœ¨ service ä¸­äº¤äº’çµæœï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€å€‹å…¨åŸŸçš„ request idï¼Œéœ€è¦ä¸€å€‹éš¨æ©Ÿç”Ÿæˆæ¼”ç®—æ³•ç”¢ç”Ÿè¶³å¤ éš¨æ©Ÿçš„ id  

æ‰€è¬‚çš„è¶³å¤ éš¨æ©ŸåŒ…å«å…©é»
1. è¶³å¤ å¤§çš„ identifier spaceï¼šæœ‰è¶³å¤ å¤šçš„çµ„åˆèˆ‡å¯èƒ½æ€§
2. è¶³å¤ éš¨æ©Ÿçš„ identifier generationï¼šæœ‰äº†è¶³å¤ å¤šçš„ identifier spaceï¼Œé‚„éœ€è¦è¶³å¤ éš¨æ©Ÿçš„ç”Ÿæˆæ©Ÿåˆ¶  

ä½œè€…æ±ºå®šç”¨é•·åº¦ 22 çš„ base 64ï¼Œä¹Ÿå°±æ˜¯ space æœ‰ 64^22 é€™éº¼å¤§ï¼Œgeneration å‰‡æ˜¯ç”¨ decent pseudo-random number generator (PRNG) å¸¸è¦‹çš„æ¼”ç®—æ³•ï¼ŒV8 å³æ˜¯æ¡ç”¨é€™ä¸€å¥—ï¼Œå¦‚æœè¶³å¤ éš¨æ©Ÿï¼Œé‚£é€™æ¨£çš„ç©ºé–“è¶³ä»¥`é è¨ˆæ¯ç§’ç”¢ç”Ÿä¸€ç™¾è¬æ¬¡ä¹Ÿè¦ä¸‰ç™¾å¹´æ‰æœƒç¢°æ’`ï¼Œå¤šéº¼çš„ç¾å¥½  

æœ€å¾Œä½œè€…å…œå‡ºä¾†çš„ç¨‹å¼ç¢¼å¦‚ä¸‹
```js
var ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
random_base64 = function random_base64(length) {
    var str = "";
    for (var i=0; i < length; ++i) {
        var rand = Math.floor(Math.random() * ALPHABET.length);
        str += ALPHABET.substring(rand, rand+1);
    }
    return str;
}
```
çœ‹èµ·ä¾†ä¸€é»å•é¡Œéƒ½æ²’æœ‰ï¼Œä¹Ÿæ˜¯å¤§å®¶å¸¸è¦‹çš„éš¨æ©Ÿç”Ÿæˆåšæ³•   

ä½†æ˜¯åœ¨ä¸ä¹…å¾ŒåŒäº‹ç™¼ç¾ ID ç¢°æ’äº† ğŸ’¥

> â€œAnyone who considers arithmetical methods of producing random digits is, of course, in a state of sin.â€ From John von Neumann
æ„å³è¦é€éæ•¸å­¸æ–¹å¼ç”¢ç”ŸçœŸæ­£éš¨æ©Ÿæ ¹æœ¬æ˜¯ä¸å¯èƒ½  

#### PRNG å¯¦ä½œ 
ç°¡å–®çœ‹ä¸€ä¸‹å½éš¨æ©Ÿæ•¸çš„ç”Ÿæˆæ–¹å¼ä¹‹ä¸€ PRNG (pseudo random number generator)
![](https://miro.medium.com/max/700/1*_rpSUn6ekuZvXJnT5bWUbw.png)
ä¾†è‡ªåŸæ–‡çš„åœ–ç‰‡  

ç°¡å–®ä¾†èªªå°±æ˜¯æœƒæœ‰ä¸€å€‹åˆå§‹çš„ Seedï¼Œæ¥è‘—æŒ‰ç…§æ•¸å­¸å…¬å¼ç®—å‡ºä¸€å€‹å°æ‡‰çš„ä½ç½®ï¼Œæ‰€ä»¥åªæœ‰ç¶“éå¹¾æ¬¡è¼ªè½‰ï¼Œæ‰€ä»¥è¦ç”¨ finite state ç”¢ç”Ÿéš¨æ©Ÿæ•¸æ˜¯ä¸å¯èƒ½çš„ï¼Œåªè¦ PRNG æŒçºŒç”¢ç”Ÿï¼Œé‚£æœ€çµ‚è¼¸å‡ºæœƒé‡è¤‡å‡ºç¾ `Periodic`ï¼Œä½œè€…æ¯”é‡åˆ°ï¼Œ PRNG å°±åƒä¸€æœ¬å£“ç¸®çš„å¯†ç¢¼æœ¬æœ¬åŒ…å«è‘—ä¸€ä¸²æ•¸å­—ï¼ŒSeed åƒæ˜¯ä½ æŒ‘æŸä¸€é é–‹å§‹çœ‹ï¼Œæ¥è‘—ä¸€è·¯å¾€ä¸‹ç¿»ï¼Œåˆ°æ›¸å°¾å†å¾æ›¸é¦–é–‹å§‹çœ‹èµ·ï¼Œçµ‚å°‡è¼ªè¿´  

ä¸éåªè¦ Cycle çš„é•·åº¦é•·åˆ°åœ¨æœ‰é™æ™‚é–“å…§ä¸æœƒç™¼ç”Ÿå³å¯ï¼Œé€™ä¹Ÿæ±ºå®š PRNG æ¼”ç®—æ³•å“è³ªï¼Œç¨±ä¹‹ç‚º `full-cycle generator` 
> If a PRNGâ€™s state has a k-bit representation, the cycle length is less than or equal to 2áµ. A PRNG that actually achieves this maximum cycle length is called a full-cycle generator.  

è‰¯å¥½çš„ PRNG æœƒç›¡å¯èƒ½é”åˆ° 2áµ ä¸Šé™  

å¾Œé¢æœ‰ä¸€æ®µå†èªªæ˜ Chrome ç•¶æ™‚çš„ Math.random æ¼”ç®—æ³•éŒ¯èª¤ï¼Œæ‰€ä»¥å¯¦éš›ä¸Š 590 million å°±æœƒç™¼ç”Ÿå¾ªç’°ï¼Œæ›´ç³Ÿç³•çš„æ˜¯åŸºæ–¼ç”Ÿæ—¥æ‚–è«–ï¼Œç”¢ç”Ÿåƒ…åƒ… 3 è¬æ¬¡å°±æœƒæœ‰ 50% çš„ç¢°æ’æ©Ÿæœƒ (50% chance of collision after generating just 30,000 identifiers.)  

æœ€å¾Œçš„çµè«–æ˜¯å¦‚æœè¦`æ¡ç”¨å½éš¨æ©Ÿç”Ÿæˆæ•¸è«‹ç”¨ CSPRNG(cryptographically secure PRNG)`ï¼Œæˆ–æ˜¯æ¡ç”¨ç³»çµ±æ ¸å¿ƒåŸºæ–¼å¤–éƒ¨å™ªéŸ³ã€ç¶²è·¯å°åŒ…ç­‰ç”¢ç”Ÿçš„çœŸéš¨æ©Ÿæ•¸ `urandom`  

## å…¶ä»–
ä»Šå¤©è·¯éçœ‹åˆ°ä¸€ç¯‡é—œæ–¼ UUID çš„å¥½æ–‡ [é–’è«‡è»Ÿé«”æ¶æ§‹ï¼šUUID](https://medium.com/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B-uuid-2748df80aa7e)ï¼Œä¸»è¦æ›´æ·±å…¥æ¢è¨å¦‚æœæŠŠ UUID ç•¶ä½œè³‡æ–™åº«çš„ Key å°æ–¼æ•ˆèƒ½çš„å½±éŸ¿ï¼Œä¸»ç›®çš„æ˜¯å¸Œæœ›èƒ½é”åˆ° `åˆ†æ•£å¼ç”¢ç”Ÿéå¢çš„ Key`ï¼ŒUUID v1 ç®—æ˜¯æœ‰ç¬¦åˆé€™å€‹è¦æ±‚ï¼Œä½†å› ç‚ºæœ‰åšé timestamp çš„æ‹†åˆ†ï¼Œå°è‡´ Java å¯¦ä½œåœ¨æ¯”å°æ™‚æœƒæœ‰é»å•é¡Œ  
å¯ä»¥è‡ªå·±å®¢è£½åŒ– UUID çš„æ ¼å¼ï¼Œæˆ–ä¹¾è„†è‡ªå‰µï¼Œåƒè€ƒå…¶ä»–å¯¦ä½œå¦‚ Twitter Snowflake(å·² deprecated) æˆ–æ˜¯ [Firebase Push ID](https://firebase.googleblog.com/2015/02/the-2120-ways-to-ensure-unique_68.html)ï¼Œå¤§æŠµä¸Šéƒ½è„«é›¢ä¸äº† `timestamp åŠ ä¸Šäº‚æ•¸æˆ–æ˜¯åŠ ä¸Šæ©Ÿå™¨è­˜åˆ¥ç¢¼`çš„åšæ³•  

## çµè«–  
ID æ˜¯å¸¸ç”¨çš„å±¬æ€§ï¼Œç”¨ä¾†æŠ½è±¡åŒ–æŒ‡å‘æŸå€‹ç‰©ä»¶/äº‹ä»¶ï¼Œé¸æ“‡æ­£ç¢ºçš„æ–¹å¼ç”¢ç”Ÿ IDï¼Œæ‰ä¸æœƒå°æ–¼ç³»çµ±ç”¢ç”Ÿæ•ˆèƒ½è²§é ¸ï¼Œé€éå­¸ç¿’ UUID çš„å¯¦ä½œéç¨‹ï¼Œçœ‹åˆ°åˆ†æ•£å¼ç”¢ç”Ÿ ID çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯åœ¨å¤§æ•¸æ“šæ™‚ä»£ï¼Œå¿«é€Ÿç”¢ç”Ÿç¨ä¸€(ä¸”éå¢)çš„ ID å°¤ç‚ºåŸºç¤ä¸”é‡è¦ï¼Œè€Œåœ¨ä¹‹ä¸­`éš¨æ©Ÿæ€§`åœ¨æ•´å€‹éç¨‹æ‰®æ¼”è‘—å¾ˆé—œéµçš„è§’è‰²  