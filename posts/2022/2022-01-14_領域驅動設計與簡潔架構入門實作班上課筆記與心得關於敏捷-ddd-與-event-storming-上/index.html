<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="結論 - 要學 DDD 直接報名 Teddy 的課程絕對是投資報酬率最高的方式"><title>「領域驅動設計與簡潔架構入門實作班」上課筆記與心得：關於敏捷、 DDD 與 Event Storming - 上</title><link rel=canonical href=https://yuanchieh.page/posts/2022/2022-01-14-%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87%E7%B0%A1%E6%BD%94%E6%9E%B6%E6%A7%8B%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C%E7%8F%AD%E4%B8%8A%E8%AA%B2%E7%AD%86%E8%A8%98%E8%88%87%E5%BF%83%E5%BE%97%E9%97%9C%E6%96%BC%E6%95%8F%E6%8D%B7-ddd-%E8%88%87-event-storming-%E4%B8%8A/><link rel=stylesheet href=/scss/style.min.ff300df33b80e2ac49809c825614392ed1c7b27591d65d3c4043602cd162e25f.css><meta property="og:title" content="「領域驅動設計與簡潔架構入門實作班」上課筆記與心得：關於敏捷、 DDD 與 Event Storming - 上"><meta property="og:description" content="結論 - 要學 DDD 直接報名 Teddy 的課程絕對是投資報酬率最高的方式"><meta property="og:url" content="https://yuanchieh.page/posts/2022/2022-01-14-%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87%E7%B0%A1%E6%BD%94%E6%9E%B6%E6%A7%8B%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C%E7%8F%AD%E4%B8%8A%E8%AA%B2%E7%AD%86%E8%A8%98%E8%88%87%E5%BF%83%E5%BE%97%E9%97%9C%E6%96%BC%E6%95%8F%E6%8D%B7-ddd-%E8%88%87-event-storming-%E4%B8%8A/"><meta property="og:site_name" content="Yuanchieh"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-01-14T01:21:40+00:00"><meta property="article:modified_time" content="2022-01-14T01:21:40+00:00"><meta name=twitter:title content="「領域驅動設計與簡潔架構入門實作班」上課筆記與心得：關於敏捷、 DDD 與 Event Storming - 上"><meta name=twitter:description content="結論 - 要學 DDD 直接報名 Teddy 的課程絕對是投資報酬率最高的方式"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-82837682-4","auto"),ga("send","pageview"))</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82837682-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-82837682-4")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars0.githubusercontent.com/u/6858460?s=460&amp;v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Yuanchieh</a></h1><h2 class=site-description>生命是長期而持續的累積</h2></div></header><ol class=social-menu><li><a href=https://github.com/sj82516 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#domain-driven-design>Domain Driven Design</a><ol><li><a href=#ddd-基本介紹>DDD 基本介紹</a><ol><li><a href=#1-什麼是-domain>1. 什麼是 Domain</a></li><li><a href=#2-什麼是-domain-model>2. 什麼是 Domain Model</a></li><li><a href=#3-domain-model-要越真越好嗎>3. Domain Model 要越真越好嗎</a></li></ol></li></ol></li><li><a href=#event-storming>Event Storming</a><ol><li><a href=#1-big-picture-找出-domain-event>1. Big Picture: 找出 Domain Event</a><ol><li><a href=#a-時間軸順序性>a. 時間軸順序性</a></li><li><a href=#b-不要被-ui-綁架>b. 不要被 UI 綁架</a></li><li><a href=#c-不要被-db-綁架---任務驅動而非指令驅動>c. 不要被 DB 綁架 - 任務驅動而非指令驅動</a></li><li><a href=#d-用說故事的方式去釐清-model-表達力>d. 用說故事的方式去釐清 Model 表達力</a></li></ol></li><li><a href=#2-big-picture---劃分-bounded-context>2. Big Picture - 劃分 Bounded Context</a></li><li><a href=#3-big-picture---加入-role--externel-system>3. Big Picture - 加入 Role / Externel System</a></li><li><a href=#4-process-modeling---加入-command--read-model>4. Process Modeling - 加入 Command / Read Model</a><ol><li><a href=#a-建立事件是否要傳入-id>a. 建立事件是否要傳入 id</a></li></ol></li><li><a href=#5-process-modeling---加入policy>5. Process Modeling - 加入Policy</a></li><li><a href=#6-software-design---加入-model>6. Software Design - 加入 Model</a><ol><li><a href=#a-model-拆分很看商業邏輯>a. Model 拆分很看商業邏輯</a></li></ol></li><li><a href=#7-software-design---找出-aggregate>7. Software Design - 找出 Aggregate</a></li><li><a href=#延伸變體還是很想把讀取也放入-event-storming-可以嗎>延伸變體：還是很想把讀取也放入 Event Storming 可以嗎？</a></li><li><a href=#延伸問題開發只要這一份文件就好了嗎>延伸問題：開發只要這一份文件就好了嗎？</a></li></ol></li><li><a href=#ddd---tacticle-design--strategic-design>DDD - Tacticle Design & Strategic Design</a><ol><li><ol><li><a href=#1-entity-與-value-object-區分>1. Entity 與 Value Object 區分</a></li><li><a href=#2-如果有驗證需求可以考慮用-value-object>2. 如果有驗證需求，可以考慮用 Value Object</a></li></ol></li></ol></li><li><a href=#結語>結語</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%9E%B6%E6%A7%8B/>架構</a>
<a href=/categories/ddd/>DDD</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2022/2022-01-14-%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87%E7%B0%A1%E6%BD%94%E6%9E%B6%E6%A7%8B%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C%E7%8F%AD%E4%B8%8A%E8%AA%B2%E7%AD%86%E8%A8%98%E8%88%87%E5%BF%83%E5%BE%97%E9%97%9C%E6%96%BC%E6%95%8F%E6%8D%B7-ddd-%E8%88%87-event-storming-%E4%B8%8A/>「領域驅動設計與簡潔架構入門實作班」上課筆記與心得：關於敏捷、 DDD 與 Event Storming - 上</a></h2><h3 class=article-subtitle>結論 - 要學 DDD 直接報名 Teddy 的課程絕對是投資報酬率最高的方式</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 14, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>在 2022 年一開始就上到如此扎實、有收穫的課程真的是太讚了，之前在同事的介紹下認識了 Event Storming 並接觸到一些 DDD 的名詞，開始在網路上透過影音課程 <a class=link href=https://www.pluralsight.com/courses/fundamentals-domain-driven-design target=_blank rel=noopener>Domain-Driven Design Fundamentals</a>、鐵人賽系列文章學習，在上課前也大概翻了一下 DDD 藍皮書，以上的教材都很不錯，也把名詞解釋跟 DDD 流程大致梳理一遍，但是蓋上書本、關掉網頁，<code>我要怎麼導入？</code></p><p>例如說 DDD 提到開發人員要找領域專家一起找出 Domain Model，並將 Domain 劃分出適合的 Bounded Context，但什麼是適合？我該怎樣知道不適合？當我找到適合的"感覺" A-ha Moment 是怎樣會發生？</p><p>在翻閱《Clean Architecture》一書也有同感，文章寫得非常清楚，也透過 Uncle Bob 的文筆重新認識了軟體架構，但<code>然後呢？我該怎麼實作？</code></p><p>在 DDD 一書闡述了軟體的建立需要攜手 Domain Expert 定義 Domain Model，並確保程式實作要跟 Model 保持一致，在圖表中拆分了 Entity / Value Object 等，以及提供很多元件間溝通的 Patten，但沒有說實作起來會怎樣 (講白了書本中沒有太多的程式碼)<br>在 《Clean Architecture》 中描述的 SOLID / 分層原則 / 依賴性原則，但沒有說元件所謂的<code>職責怎麼劃分</code>，有很多實作的細節跟取捨並沒有太多案例</p><p>Teddy 將兩者結合，用自己設計的 Kanban 系統，帶著學員跑過一次 DDD 建模的過程，並透過《Clean Architecture》實作，他說他很接近理想的軟體</p><blockquote><p>改動的成本只跟需求範圍有關，跟系統存在的時間無關</p></blockquote><p>透過一個階段一個階段的討論與檢討，先試錯再回頭解釋名詞，這樣的學習方式我覺得比看書、看影片還要好很多，以下我將用時間軸分享 Teddy 上課的內容以及我們小組討論的演進，會有大量錯誤然後被糾正 ~打臉~ 的案例 XD<br>內容有點細，不會完整介紹 DDD 跟 Event Storming，只會分享在實作上錯誤與老師的糾正</p><p>推個課程頁面 <a class=link href=https://teddysoft.tw/courses/clean-architecture/ target=_blank rel=noopener>領域驅動設計與簡潔架構入門實作班</a>，實際參與小組討論會清晰很多</p><h2 id=domain-driven-design>Domain Driven Design</h2><h3 id=ddd-基本介紹>DDD 基本介紹</h3><h4 id=1-什麼是-domain>1. 什麼是 Domain</h4><p>Domain 可以被拆分為 <code>Problem Domain</code> 以及 <code>Solution Domain</code>，Problem Domain 是指實際發生在世界上的問題，也就是公司所面臨的商業問題，例如外出想要叫車、肚子餓想要點外賣等，但是世界上的問題太多了，不會每一個都關注，所以總合來說</p><blockquote><p>利害關係人所在乎的實際問題就是你的 Domain</p></blockquote><p>Uber 在乎用戶外出的通勤問題 / Food Panda 在乎用戶肚子餓想點外賣果腹的問題，各自有各自的 Problem Domain，並對此提出各自的解法 Solution Domain，之後討論將 Solution Domain 限縮在軟體設計上</p><p>回歸開發的根本，為什麼我們需要一直跟 PM / 利害關係人 (後續以<code>領域專家</code>代稱) 不斷釐清問題，因為問題才是驅動一切的本質，如果今天不用寫一行程式碼就能解決問題，那何必動手，<code>釐清問題是開發的第一步</code></p><h4 id=2-什麼是-domain-model>2. 什麼是 Domain Model</h4><p>有了 Problem Domain，過往的習慣是直接進入開發設計，也就是對應到 Solution Domain，但這兩個 Domain 間有一個很大的鴻溝 (附圖路徑 A)，開發人員以為自己聽懂了需求就開始實作，而領域專家也以為開發人員真的懂了，最後等系統驗收時才發現根本做錯了</p><p>DDD 提倡領域專家與開發人員應該要先達成共識，將 Domain 建立出對應的模型 Model，讓雙方將共識轉換為圖形，並在過程中建立 <code>Ubiquitous Language</code> 共同語言，等確認後開發人員才去實作 (附圖路徑 B)</p><p><img src=/post/2022/img/0114/domain-model.png loading=lazy></p><p>比對路徑 A 、B，看似 B 繞了點遠路，但先透過 Domain Model 闡述 Solution 的長相並抽離實作，才能用最小的成本，讓領域專家及早確認解法的方向正不正確</p><blockquote><p>Q: 是不是所有問題都要建 Domain Model?<br>A: 不是，只有當商業邏輯足夠複雜才需要，單純的 CRUD、報表系統是不需要的</p></blockquote><p>Event Storming 是一個建立 Domain Model 的方法，從 High Level 到 Low Level 持續演化的過程</p><h4 id=3-domain-model-要越真越好嗎>3. Domain Model 要越真越好嗎</h4><p>所謂的「真」是指實際世界的真實性，Teddy 上課舉例：「樣品屋是不是越像真的實體屋越好？」<br>答案是「不一定!」，重新思考 Domain Model 是 Solution Domain 的一環，所以真正的重點是源頭的 Problem Domain，今天建商蓋樣品屋是希望用戶購買實體屋，但如果今天建商蓋完就銷售一空，那根本連樣品屋都不用蓋</p><p>只要 Model 能夠剛好解決問題就好，over design 或 under design 都是不好的，這點在後續的實際操作會再補充</p><h2 id=event-storming>Event Storming</h2><p>以 Kanban 系統 <a class=link href=https://ssl-ezscrum.csie.ntut.edu.tw/ezKanban-stable target=_blank rel=noopener>ezKanban</a>，Teddy 擔任領域專家 (兼任開發人員XD) 帶大家跑過 Event Storming，以下介紹 Kanban 的核心商業邏輯</p><ul><li>Visualize：視覺化表達</li><li>Limit WIP：每一個工作階段的進行中工作 (WIP) 有數量限制</li><li>Manage Flow：管理工作流程
建模工具使用 <a class=link href=https://miro.com/app/dashboard/ target=_blank rel=noopener>Miro</a></li></ul><p>進行順序按照階層從 Big Picture 開始與領域專家討論核心的用戶行為，接著到 Process Modeling 補充更多的規則、行動，最後才是 Software Design
<img src=/post/2022/img/0114/event-storming-level.png loading=lazy></p><h3 id=1-big-picture-找出-domain-event>1. Big Picture: 找出 Domain Event</h3><p>先拉出一條箭頭表達時間軸，先後順序，將 User Story 中的關鍵事件 (Domain Event) 先條列出來，所謂的<code>事件是會改變系統狀態</code>，例如電商系統用戶加購物車、結帳等，反之<code>讀取不是事件，因為不會改變系統狀態</code>，不管 Data 讀取幾次都不會有變化</p><p>事件是代表發生過的事情，所以都會用過去式表達，例如看板系統中的</p><ul><li>Workflow Created</li><li>Workflow Deleted</li><li>Stage WIP set
等等</li></ul><p>在討論過程中，務必記得</p><ul><li>不要出現技術用語，例如資料庫怎麼儲存、實作要套什麼 Design Patten</li><li>不要被 UI 綁架了!
<img src=/post/2022/img/0114/domain-model-impl.png loading=lazy>
因為我們是看著 Teddy 已經實作好的 ezKanban，所以 Domain Event 很多，實務上看各自系統規模，而且 <code>Event Storming 是持續演進，不用求一步到位</code></li></ul><p>上圖是我們小組建立 Domain Event，其中有三點錯誤</p><h4 id=a-時間軸順序性>a. 時間軸順序性</h4><p>我們一開始把 User Created / User Logined 放在同一列上，同一列在 Event Storming 代表這兩個事件是在差不多時間點發生，但理論上 User Create 必然在 User Logined 之前，所以不該放在同一列上</p><h4 id=b-不要被-ui-綁架>b. 不要被 UI 綁架</h4><p>這是一個非常有趣的案例，在 ezKanban 中你必須在畫面上點擊「Layout Edit」才能編輯工作流程的框架，所以我們組內討論很直覺的想這個事件很重要，所以就補了一個 「Layout Mode Entered」，但老師說不對!! <code>被 UI 綁架了</code>，這只是一個實作細節，我今天可以換一個按鈕或 UI 流程做到同一件事，這屬於應用層面的邏輯</p><p>Domain Event 又可細分成兩種 Core Domain Event / Application Domain Event，前者是滿足核心商業邏輯的事件、後者是應用程式執行時需要的事件，今天以看板系統，用戶哪會關心什麼 Layout Mode，那是你<code>實作的事情</code>，所以不該把這個 Event 放在上面</p><p>我自己後來在反思這件事情，我嘗試用這樣的邏輯去釐清</p><blockquote><ul><li>我能不能用不同的 UI Flow 取代當前的事件？ 例如在 Board 頁面就區分出「版位調整」/「工作調整」，如果可以的話，那就是應用事件</li><li>今天我實作在多平台 Web / App / Server 都需要這個事件嗎？如果要那有可能是核心，如果只有 Web 要實作其他平台不用，那肯定是應用事件</li></ul></blockquote><p>這麼在意是不是 Core Domain Event 的用意是讓 Domain Model 保持簡潔，太多細節參雜會混淆討論</p><h4 id=c-不要被-db-綁架---任務驅動而非指令驅動>c. 不要被 DB 綁架 - 任務驅動而非指令驅動</h4><p>在條列 Domain Model 時，我與組員都有一個疑問 <code>「一個 Stage 有 10 個屬性都能夠 CRUD，那我要全部列出來嗎？例如 Stage 的標題、說明欄等，那我是要寫一個 Stage Updated 就好還是要寫 Stage Name Updated？」</code></p><p>除了不要被 UI 綁架外，也不要被資料庫綁架了! 今天用戶才不管你怎麼 CRUD，他真正在意是<code>能不能完成他手中的任務</code>，例如說今天我去 ATM 領錢，系統顯示</p><ol><li>說法 A: 您已提領 1000 元</li><li>說法 B: 已更新您的帳戶餘額為原餘額減去1000 元</li></ol><p>相信你提款後看到說法 B 應該會傻眼，請以「用戶想要完成什麼任務」的角度描述 Domain Event</p><h4 id=d-用說故事的方式去釐清-model-表達力>d. 用說故事的方式去釐清 Model 表達力</h4><p>我在操作 ezKanban 先跑了建立工作流程，最後才發現 ezKanban 有 Team 的概念，Team 可以邀請其他 User 當作 Member 共享 Project，因為我比較晚看到所以 Team 相關的事件放在時間軸後面</p><p>最後 Teddy 問說：「這樣的 Model 表達了什麼含意？」Model 的意義在於<code>圖形化我們想要解決的問題與發生順序</code>，也就是用戶的使用歷程與每一個使用案例，今天用說故事的方式會像</p><ol><li>故事 A:「用戶今天想要使用看板系統，他先註冊了帳號並登入，接著建立專案，並開始設定自己的工作流程&mldr;&mldr; 最後他邀請他的成員加入，大家一起操作看板」</li><li>故事 B: 「用戶今天想要使用看板系統，他先註冊了帳號並登入，接著建立團隊，邀請他的成員加入，大家一起操作看板，接著建立專案，並開始設定團隊的工作流程&mldr;&mldr;」</li></ol><p>兩個故事都說得通，但 Teddy 覺得故事 B 更符合他的使用場景，團隊的建立會在工作流程之前，所以調整後的 Domain Event 大致長這樣
<img src=/post/2022/img/0114/domain-model-impl-r.png loading=lazy></p><h3 id=2-big-picture---劃分-bounded-context>2. Big Picture - 劃分 Bounded Context</h3><p>洋洋灑灑列出 Domain Event 後，接下來要來分群，想像成是買房畫隔間，設計圖應該要能清楚辨識出這是一個商務辦公室還是一個小家庭自住用，透過隔間去表達系統的意圖
<img src=/post/2022/img/0114/room.png loading=lazy>
*附圖從 Google 搜尋，不用懂室內設計但也大致能看出左右兩張圖的不同</p><p>我們小組一開始思考方式是「不然就每個物件一間，Workflow 一間 / Board 一間等」，如圖示
<img src=/post/2022/img/0114/bound-wrong.png loading=lazy></p><p>Teddy 看到我們如此設計，他反問說「你們的隔間有反應出 &ldquo;看板系統&rdquo; 這個意圖嗎？如果從外部使用者的角度，他看到 Workflow / Board / Stage 這麼多細節對嗎？」</p><p>正確的隔間應該是
<img src=/post/2022/img/0114/bound-right.png loading=lazy>
區分成三塊：</p><ul><li>Core Domain：Kanban 是我們的核心領域，<code>千萬不要外包</code></li><li>Generic Domain：User / Team 屬於通用性功能</li><li>Support Domain：圖上沒有，如金流、外部通知系統，這種的找外包即可，不一定要自己開發</li></ul><p>如何知道自己的隔間是否正確？回到商業邏輯與說故事的方式，劃分 Bounded Context 後是否能正確拆解出公司的核心與非核心商業邏輯</p><blockquote><p>大家最關心的微服務，通常是一個 Bounded Context 一個部署的元件</p></blockquote><h3 id=3-big-picture---加入-role--externel-system>3. Big Picture - 加入 Role / Externel System</h3><p>加入觸發的角色 / 外部系統，這一步驟相對單純，角色是系統中動作的執行者
<img src=/post/2022/img/0114/role.png loading=lazy>
HotSpot 是當討論過程卡住、發生意見不同、命名不同時可以貼著註記，避免討論被卡住，最後可以看哪一個區塊是大家最沒有共識的</p><h3 id=4-process-modeling---加入-command--read-model>4. Process Modeling - 加入 Command / Read Model</h3><p>這一步相對單純</p><ul><li>Command 是觸發 Domain Event 的動作，基本上就是把完成式改成現在式表達</li><li>Read Model 則是完成 Command 所需的參數
<img src=/post/2022/img/0114/command.png loading=lazy></li></ul><h4 id=a-建立事件是否要傳入-id>a. 建立事件是否要傳入 id</h4><p>有趣的小細節是 Create Board 時我們把 board_id 也寫出來，小組討論時會覺得 DB 會自動產生 id 所以不用寫到 read model，但 Teddy 說 <code>「錯，我哪管你 id 是 DB 產生還是前端用 UUID 產生，這是實作細節，Board 就是需要 id 識別」</code>，再次強調，不要陷入 UI/DB 的細節</p><h3 id=5-process-modeling---加入policy>5. Process Modeling - 加入Policy</h3><p>Policy/Rule/Process 是指 <code>事件完成後觸發的流程</code>，千萬不要跟動作需要完成的驗證搞混，例如說</p><ul><li>輸入 Email 註冊時，Email 必須符合格式 => 這是驗證</li><li>密碼輸錯三次後，需要封鎖帳號 => 這是 Policy</li></ul><p>驗證是實作細節在 Event Storming 中不表達，Policy 才是我們現階段要關注的，以下是舉例「全家推出領取包裹後，可以八折買拿鐵」
<img src=/post/2022/img/0114/policy.png loading=lazy></p><p>這邊偷夾帶一張白色的便利貼，Teddy 說他確實也遇到有些驗證是重要的商業邏輯，他自己變形增加了白色便利貼，表示 Command 的驗證規則</p><blockquote><p>到這一步我們可以發現 Event Storming 很好的描述了一個故事
「User want receive package, we have to check his id card, after user have received package, he can purchase latte 20% off」<br>這就是 Event Storming 的魅力</p></blockquote><h3 id=6-software-design---加入-model>6. Software Design - 加入 Model</h3><p>接下來進入實作細節，Model 可以想做是物件，比對 Command 應該是哪一個物件負責，條列後最終把 Model 的大致關係也描繪，大致如下
<img src=/post/2022/img/0114/model-wrong.png loading=lazy>
因為 Stage / Swimlane 一者是橫向一者是直向，兩者可以互相包含，所以圖表有點複雜，圖表複雜代表程式碼實作一定也不好寫，該怎麼優化呢？</p><p><img src=/post/2022/img/0114/model-right.png loading=lazy></p><ul><li>抽一個 Lane 代表 Stage / Swimlane，這樣關係就單純很多</li><li>更精準表達商業邏輯，另外一個重點是 <code>Workflow 與 Stage 關聯而不是 Lane</code>，因為 Workflow 預設第一層必須是 Stage，透過圖表表示出核心的設計邏輯</li></ul><h4 id=a-model-拆分很看商業邏輯>a. Model 拆分很看商業邏輯</h4><p>同學在課堂上詢問：「如果我有多個支付，我是不是要把每個 CreditCardPay / ApplePay 都寫成一個 Model？」<br>Teddy 反問：「為什麼需要？如果 Pay 只是一個付款手段，如果沒有很大的差異，一個 Pay 表達實作時再拆分就好」<br>我接著提問：「那為什麼 Stage / Swimlane 要拆分？他們也只是一個橫的一個直的」</p><p>Teddy 表示 <code>因為在看板的 Domain 中，直的代表工作階段 / 橫的代表工作流程是截然不同的，這是非常核心的商業邏輯</code>，所以 Model 要拆到多細，要不要真的把每個實作的物件都表達，完全看領域專家與開發人員是否很重視每個元件的獨立性與表達性</p><h3 id=7-software-design---找出-aggregate>7. Software Design - 找出 Aggregate</h3><p>最後一步! 也是很抽象的一步，將 Model 分群，有些 Model 明顯是其他 Model 的附庸 ，例如說訂單細項 Order Item 是訂單 Order 的附庸，每次 Order Item 的改動會影響 Order 的計算，會進階影響例如折價券等計算，所以 Order Item 最好不要直接調整，由 Order 統一調整才能確保資料的<code>一致性</code></p><p>要不要把 Model Aggregate 成一塊有兩個作用力</p><ul><li>資料一致性</li><li>併發操作</li></ul><p>Teddy 帶我們思考的方式是</p><blockquote><p>今天我改動 Model A，那我可不可以同時改動 Model B ? 我在 Workflow name 的時候，可以同時操作 Board 嗎？</p></blockquote><p>切記不要用 Database Relation 思考，例如 User 刪除 Order 也要跟著被刪除，這樣 Aggregate 永遠切不開，更直觀地說 <code>要包 Transaction 操作的都就放在同一個 Aggregate</code><br><img src=/post/2022/img/0114/aggregate-right.png loading=lazy></p><p>找出 Aggregate 後，需要找一個 Model 當作 Root，往後 Aggregate 內的 Model 都由他來控制，<code>外人不可直接操作內部 Model</code>，任何跨 Aggregate 操作只能保證最終一致性</p><h3 id=延伸變體還是很想把讀取也放入-event-storming-可以嗎>延伸變體：還是很想把讀取也放入 Event Storming 可以嗎？</h3><p>Teddy 上課一直強調讀取隨便寫就好，怎麼髒都沒關係因為 Command 才會影響系統狀態 XD Query 效能問題等又是 DB 細節，本身也不是 Event Storming 該關注的層級</p><p>但協作上大家還是想把 UI 放到討論中 / Read Model 如果有前端可能也希望在寫得細一點，這些都可以自己延伸，Teddy 也分享有些流程 UI 可以幫助說明的話他也會放進去，例如 Command 後回傳另一張 Read Model / UI 圖示放在 Read Model 旁邊等
<img src=/post/2022/img/0114/ui.png loading=lazy></p><h3 id=延伸問題開發只要這一份文件就好了嗎>延伸問題：開發只要這一份文件就好了嗎？</h3><p>文件的維護也是我課前很想了解的部分，在 DDD 藍皮書中不斷強調 <code>Domain Model 跟程式碼實作要高度一致</code>並持續演進，但工作多年有良好維護文件習慣的人還真的是少數，尤其是文件越多份維護的成本就更高，所以我課後就問 Teddy 他們團隊開發是不是只有這一份文件，他說基本上是，資料庫部分因為他是走 Event Sourcing 所以不用另外的 Schema 設計文件，如果不是頂多再一份 DB Schema 文件就足夠了</p><h2 id=ddd---tacticle-design--strategic-design>DDD - Tacticle Design & Strategic Design</h2><p>跑過一次 Event Storming 再回來看 DDD 廣為人知的兩張圖就比較能理解了，這邊只額外補充兩件事</p><h4 id=1-entity-與-value-object-區分>1. Entity 與 Value Object 區分</h4><p>前者是具有 id 在 Conext 下有唯一識別性的物件，後者是內容重要但是不是同一個物件不太關心，例如說紙鈔，大多系統下我們只關心紙鈔的面額，甭管你是左邊的 100 元還是右邊的 100 元，所以是 Value Object / 但如果是印鈔系統，同樣是 100 元還是要用 id 區分不同的紙鈔，這時就是 Entity 了</p><h4 id=2-如果有驗證需求可以考慮用-value-object>2. 如果有驗證需求，可以考慮用 Value Object</h4><p>一個實作的小細節，如果以往都是用欄位儲存一個基礎型別，例如 string email，要增加驗證就會很瑣碎，封裝一個 Email 物件並在 constructor 統一驗證會比較簡潔</p><h2 id=結語>結語</h2><p>重點小整理：</p><ul><li>以商業核心為出發</li><li>用說故事的方式跑 Event Storming</li><li>不要落入實作細節</li><li>如果有需要，可以自己變體適應組織</li></ul><p>上完課自己重新覆盤，沒想到花這麼多時間才整理完，DDD 用靜態的學習方式真的很抽象，大腦一直轉不過去，上完 Teddy 的課才覺得那扇門被打開了一個縫，看到理想軟體開發的光明 XD</p><p>這一篇主要整理 DDD，下一篇預計整理 Clean Architecture 與如何跟 DDD 結合，希望這些紀錄對大家有幫助，最後在幫 Teddy 老師推廣一下他的<a class=link href=https://teddysoft.tw/courses/clean-architecture/ target=_blank rel=noopener>課程</a>，只有實際跑過一次Event Storming 才能真正學會，如果有什麼建議或糾錯再麻煩留言</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/2021/2021-12-05-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8B/><div class=article-details><h2 class=article-title>《單體式系統到微服務》讀後分享 - 下</h2></div></a></article><article><a href=/posts/2021/2021-12-03-%E5%96%AE%E9%AB%94%E5%BC%8F%E7%B3%BB%E7%B5%B1%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99%E8%AE%80%E5%BE%8C%E5%88%86%E4%BA%AB-%E4%B8%8A/><div class=article-details><h2 class=article-title>《單體式系統到微服務》讀後分享 - 上</h2></div></a></article><article><a href=/posts/2021/2021-07-02-aws-aurora-%E6%9E%B6%E6%A7%8B%E7%A0%94%E7%A9%B6%E4%BB%A5%E5%8F%8A%E8%88%87%E8%87%AA%E9%A7%95-mysql-%E7%9A%84%E5%B7%AE%E7%95%B0/><div class=article-details><h2 class=article-title>AWS Aurora 架構研究以及與自駕 MySQL 的差異</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//yuanchieh.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Yuanchieh</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.17.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>